<!-- index.html -->
<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RTQ – Maths Paper Solution Viewer (Stress Test Harness)</title>
  <style>
    :root {
      --bg: #f7f7f7;
      --paper: #ffffff;
      --ink: #111111;
      --muted: #555555;
      --line: #e6e6e6;
      --line-strong: #cfcfcf;
      --shadow: rgba(0, 0, 0, 0.08);
      --radius: 10px;
      --gap: 16px;
      --focus: #000000;

      --subtle: #fbfbfb;
      --subtle2: #f9f9f9;
    }

    * {
      box-sizing: border-box;
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--ink);
      background: var(--bg);
      line-height: 1.5;
    }

    :focus-visible {
      outline: 3px solid var(--focus);
      outline-offset: 2px;
    }

    /* Top controls */
    .topbar {
      position: sticky;
      top: 0;
      z-index: 50;
      background: #efefef;
      border-bottom: 1px solid var(--line-strong);
      padding: 10px 12px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .topbar .left {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 0;
      flex: 1 1 auto;
    }

    .topbar .title {
      font-weight: 800;
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      min-width: 0;
    }

    .control {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 0 0 auto;
    }

    label {
      font-size: 12px;
      font-weight: 800;
      color: var(--muted);
      white-space: nowrap;
    }

    select {
      appearance: none;
      border: 1px solid var(--line-strong);
      background: #ffffff;
      color: var(--ink);
      border-radius: 8px;
      padding: 8px 10px;
      font-weight: 700;
      cursor: pointer;
    }

    .iconbtn {
      appearance: none;
      border: 1px solid var(--line-strong);
      background: #ffffff;
      color: var(--ink);
      border-radius: 8px;
      padding: 8px 10px;
      font-weight: 700;
      cursor: pointer;
    }

    .iconbtn:active {
      transform: translateY(1px);
    }

    /* App layout */
    .app {
      display: block;
      padding: 14px 12px 60px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .layout {
      display: block;
    }

    /* Desktop rail */
    .rail {
      display: none;
    }

    /* Paper */
    .paper {
      background: var(--paper);
      border: 1px solid var(--line-strong);
      border-radius: var(--radius);
      box-shadow: 0 2px 10px var(--shadow);
      padding: 18px 18px 10px;
      overflow: visible;
      /* no nested scroll */
    }

    .paper-header {
      padding-bottom: 10px;
      margin-bottom: 6px;
      border-bottom: 1px solid var(--line);
    }

    .paper-header h1 {
      margin: 0;
      font-size: 18px;
      font-weight: 900;
    }

    .paper-header p {
      margin: 6px 0 0;
      color: var(--muted);
      font-size: 13px;
    }

    /* Section headings (only when part of the paper) */
    .section {
      margin: 18px 0 0;
      padding: 12px 0 0;
      border-top: 1px solid var(--line);
    }

    .section h2 {
      margin: 0 0 10px;
      font-size: 16px;
      font-weight: 900;
    }

    /* Questions (no cards/panels around whole question) */
    .q {
      margin: 18px 0 0;
      padding: 0;
      background: transparent;
    }

    .q+.q {
      margin-top: 22px;
      padding-top: 18px;
      border-top: 1px solid var(--line);
    }

    .qhead {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
      margin: 0 0 10px;
    }

    .qhead h3 {
      margin: 0;
      font-size: 16px;
      font-weight: 900;
    }

    .qmeta {
      color: var(--muted);
      font-size: 12px;
      white-space: nowrap;
      font-weight: 800;
    }

    /* Blocks (no borders) */
    .block {
      margin: 10px 0 0;
      padding: 0;
      background: transparent;
    }

    .block-title {
      margin: 0 0 6px;
      font-weight: 900;
      font-size: 13px;
      letter-spacing: 0.2px;
    }

    .block p {
      margin: 0 0 8px;
    }

    .block p:last-child {
      margin-bottom: 0;
    }

    /* Answer visible by default */
    .answer {
      margin-top: 12px;
      padding: 10px 12px;
      background: var(--subtle);
    }

    /* Working collapsed by default */
    .working {
      margin-top: 10px;
      padding: 10px 12px;
      background: var(--subtle2);
    }

    .toggle-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin: 0 0 6px;
    }

    .toggle-row .block-title {
      margin: 0;
    }

    .toggle {
      appearance: none;
      border: 1px solid var(--line-strong);
      background: #ffffff;
      color: var(--ink);
      border-radius: 999px;
      padding: 8px 12px;
      font-weight: 800;
      cursor: pointer;
      flex: 0 0 auto;
    }

    .working-content[hidden] {
      display: none;
    }

    .working-preview {
      color: var(--muted);
      font-size: 12.5px;
      margin: 0;
    }

    .katex-inline {
      font-weight: 800;
      background: #f1f1f1;
      border: 1px solid var(--line);
      border-radius: 6px;
      padding: 2px 6px;
      display: inline-block;
    }

    .katex-block {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 13px;
      border: 1px solid var(--line);
      border-radius: 8px;
      padding: 8px 10px;
      background: #f3f3f3;
      margin: 6px 0;
      overflow-wrap: anywhere;
    }

    /* Sub-questions: indentation + rhythm */
    .subq {
      margin: 14px 0 0;
      padding: 0 0 0 14px;
      border-left: 2px solid var(--line);
    }

    .subq h4 {
      margin: 0 0 8px;
      font-size: 14px;
      font-weight: 900;
    }

    /* Diagram wrapper inside question block */
    .diagram {
      margin: 10px 0 0;
      padding: 10px 10px;
      background: #f4f4f4;
      border: 1px solid var(--line);
      border-radius: 8px;
    }

    .diagram svg {
      width: 100%;
      height: auto;
      display: block;
    }

    /* Drawer (tablet/mobile nav) */
    .drawer-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.35);
      z-index: 60;
      display: none;
    }

    .drawer-backdrop.open {
      display: block;
    }

    .drawer {
      position: fixed;
      top: 0;
      left: 0;
      width: min(340px, 92vw);
      height: 100%;
      background: #ffffff;
      border-right: 1px solid var(--line-strong);
      box-shadow: 6px 0 18px var(--shadow);
      padding: 12px;
      overflow: visible;
      /* no inner scrolling */
    }

    .drawer h2 {
      margin: 6px 0 10px;
      font-size: 14px;
      font-weight: 900;
    }

    .drawer .row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    .drawer .close {
      appearance: none;
      border: 1px solid var(--line-strong);
      background: #ffffff;
      border-radius: 8px;
      padding: 7px 10px;
      font-weight: 800;
      cursor: pointer;
    }

    /* Nav list (no overflow scrolling) */
    nav ul {
      list-style: none;
      padding: 0;
      margin: 10px 0 0;
      display: grid;
      gap: 6px;
    }

    nav a {
      display: block;
      padding: 10px 10px;
      border: 1px solid var(--line);
      border-radius: 10px;
      text-decoration: none;
      color: var(--ink);
      background: #ffffff;
      font-weight: 900;
    }

    nav a small {
      display: block;
      color: var(--muted);
      font-weight: 700;
      font-size: 11.5px;
      margin-top: 2px;
    }

    /* Non-clickable nav section separators (Sectioned paper only) */
    .nav-sep {
      padding: 8px 10px;
      border: 1px dashed var(--line-strong);
      border-radius: 10px;
      background: #f6f6f6;
      font-weight: 900;
      color: var(--muted);
    }

    /* Desktop responsive */
    @media (min-width: 900px) {
      .layout {
        display: grid;
        grid-template-columns: 240px 1fr;
        gap: var(--gap);
        align-items: start;
      }

      .rail {
        display: block;
        position: sticky;
        top: 58px;
        /* below sticky topbar */
        align-self: start;
        background: #ffffff;
        border: 1px solid var(--line-strong);
        border-radius: var(--radius);
        box-shadow: 0 2px 10px var(--shadow);
        padding: 12px;
        overflow: visible;
        /* no inner scrolling */
      }

      .rail h2 {
        margin: 4px 0 10px;
        font-size: 14px;
        font-weight: 900;
      }

      .drawer-backdrop {
        display: none !important;
      }
    }
  </style>
</head>

<body>
  <!-- Sticky top controls (includes Paper Selector) -->
  <header class="topbar" aria-label="Top controls">
    <div class="left">
      <button class="iconbtn" id="navToggle" type="button" aria-haspopup="dialog" aria-controls="drawerBackdrop"
        aria-expanded="false">
        Menu
      </button>
      <div class="title">RTQ – Maths Paper (Continuous Scroll)</div>
    </div>

    <div class="control" aria-label="Paper selector control">
      <label for="paperSelect">Paper</label>
      <select id="paperSelect">
        <option value="short">Short paper</option>
        <option value="standard">Standard paper</option>
        <option value="diagram">Diagram-heavy paper</option>
        <option value="sectioned">Sectioned paper</option>
      </select>
    </div>
  </header>

  <!-- Drawer (tablet/mobile nav) -->
  <div class="drawer-backdrop" id="drawerBackdrop" aria-hidden="true">
    <div class="drawer" role="dialog" aria-modal="true" aria-label="Question navigation">
      <div class="row">
        <h2>Navigation</h2>
        <button class="close" id="drawerClose" type="button">Close</button>
      </div>
      <nav aria-label="Questions (drawer)">
        <ul id="navListDrawer"></ul>
      </nav>
    </div>
  </div>

  <main class="app">
    <div class="layout">
      <!-- Desktop rail -->
      <aside class="rail" aria-label="Question navigation (rail)">
        <h2>Navigation</h2>
        <nav aria-label="Questions (rail)">
          <ul id="navListRail"></ul>
        </nav>
      </aside>

      <!-- Paper container (single continuous document) -->
      <section class="paper" aria-label="Paper content">
        <div class="paper-header">
          <h1 id="paperTitle">RTQ – Maths Paper</h1>
          <p id="paperSubtitle">Answers visible by default. Workings collapsed by default. Questions always visible.</p>
        </div>
        <div id="paperRoot"></div>
      </section>
    </div>
  </main>

  <script>
    (function () {
      // ---------- Diagram SVGs (grayscale) ----------
      function svgGeometry() {
        return `
          <div class="diagram" aria-label="Diagram (geometry)">
            <svg viewBox="0 0 320 180" role="img" aria-label="Geometry diagram">
              <rect x="1" y="1" width="318" height="178" fill="#fff" stroke="#cfcfcf" />
              <polygon points="70,140 160,40 250,140" fill="#f2f2f2" stroke="#444" stroke-width="2"/>
              <circle cx="160" cy="40" r="4" fill="#444"/>
              <circle cx="70" cy="140" r="4" fill="#444"/>
              <circle cx="250" cy="140" r="4" fill="#444"/>
              <text x="155" y="28" font-size="12" fill="#111">A</text>
              <text x="54" y="156" font-size="12" fill="#111">B</text>
              <text x="258" y="156" font-size="12" fill="#111">C</text>
              <text x="150" y="118" font-size="12" fill="#111">[KaTeX inline]</text>
            </svg>
          </div>`;
      }

      function svgBars() {
        return `
          <div class="diagram" aria-label="Diagram (ratio bars)">
            <svg viewBox="0 0 320 180" role="img" aria-label="Ratio bars diagram">
              <rect x="1" y="1" width="318" height="178" fill="#fff" stroke="#cfcfcf" />
              <text x="14" y="22" font-size="12" fill="#111">Ratio bars</text>
              <rect x="20" y="45" width="260" height="22" fill="#f2f2f2" stroke="#444"/>
              <line x1="20" y1="45" x2="20" y2="67" stroke="#444" stroke-width="2"/>
              <line x1="85" y1="45" x2="85" y2="67" stroke="#444" stroke-width="2"/>
              <line x1="150" y1="45" x2="150" y2="67" stroke="#444" stroke-width="2"/>
              <line x1="215" y1="45" x2="215" y2="67" stroke="#444" stroke-width="2"/>
              <line x1="280" y1="45" x2="280" y2="67" stroke="#444" stroke-width="2"/>
              <text x="22" y="88" font-size="12" fill="#111">A</text>
              <text x="22" y="120" font-size="12" fill="#111">B</text>
              <rect x="20" y="98" width="180" height="22" fill="#eaeaea" stroke="#444"/>
              <rect x="20" y="130" width="240" height="22" fill="#f0f0f0" stroke="#444"/>
              <text x="210" y="114" font-size="12" fill="#111">[KaTeX inline]</text>
            </svg>
          </div>`;
      }

      function svgGrid() {
        return `
          <div class="diagram" aria-label="Diagram (coordinate grid)">
            <svg viewBox="0 0 320 180" role="img" aria-label="Coordinate grid diagram">
              <rect x="1" y="1" width="318" height="178" fill="#fff" stroke="#cfcfcf" />
              <g stroke="#dddddd">
                ${Array.from({ length: 15 }).map((_, i) => `<line x1="${20 + i * 20}" y1="20" x2="${20 + i * 20}" y2="160"/>`).join("")}
                ${Array.from({ length: 8 }).map((_, i) => `<line x1="20" y1="${20 + i * 20}" x2="300" y2="${20 + i * 20}"/>`).join("")}
              </g>
              <g stroke="#444" stroke-width="2">
                <line x1="20" y1="160" x2="300" y2="160"/>
                <line x1="20" y1="20" x2="20" y2="160"/>
              </g>
              <polyline points="40,140 120,100 200,80 280,40" fill="none" stroke="#444" stroke-width="2"/>
              <circle cx="120" cy="100" r="4" fill="#444"/>
              <circle cx="200" cy="80" r="4" fill="#444"/>
              <text x="205" y="72" font-size="12" fill="#111">P</text>
              <text x="24" y="18" font-size="12" fill="#111">[KaTeX inline]</text>
            </svg>
          </div>`;
      }

      function svgArray() {
        return `
          <div class="diagram" aria-label="Diagram (array/table)">
            <svg viewBox="0 0 320 180" role="img" aria-label="Array diagram">
              <rect x="1" y="1" width="318" height="178" fill="#fff" stroke="#cfcfcf" />
              <text x="14" y="22" font-size="12" fill="#111">Grid / array</text>
              <g stroke="#444" fill="#f2f2f2">
                ${Array.from({ length: 4 }).map((_, r) =>
          Array.from({ length: 6 }).map((_, c) => {
            const x = 30 + c * 40, y = 40 + r * 30;
            return `<rect x="${x}" y="${y}" width="36" height="26"/>`;
          }).join("")
        ).join("")}
              </g>
              <text x="30" y="160" font-size="12" fill="#111">[KaTeX inline]</text>
            </svg>
          </div>`;
      }

      const diagramTypes = {
        geometry: svgGeometry,
        bars: svgBars,
        grid: svgGrid,
        array: svgArray
      };

      // ---------- Helpers ----------
      function el(tag, attrs, children) {
        const node = document.createElement(tag);
        if (attrs) {
          Object.keys(attrs).forEach(k => {
            if (k === "class") node.className = attrs[k];
            else if (k === "html") node.innerHTML = attrs[k];
            else if (k.startsWith("aria-")) node.setAttribute(k, attrs[k]);
            else if (k === "id") node.id = attrs[k];
            else if (k === "href") node.setAttribute("href", attrs[k]);
            else if (k === "type") node.setAttribute("type", attrs[k]);
            else if (k === "role") node.setAttribute("role", attrs[k]);
            else node.setAttribute(k, attrs[k]);
          });
        }
        (children || []).forEach(ch => {
          if (typeof ch === "string") node.appendChild(document.createTextNode(ch));
          else if (ch) node.appendChild(ch);
        });
        return node;
      }

      function katexInline() {
        return `<span class="katex-inline">[KaTeX inline]</span>`;
      }
      function katexBlockLine(text) {
        return `<div class="katex-block">${text ? text : "[KaTeX block]"}</div>`;
      }

      function makeWorkingBlock(qid, workingHtmlLines) {
        const working = el("div", { class: "block working" }, []);
        const toggleRow = el("div", { class: "toggle-row" }, [
          el("p", { class: "block-title" }, ["Working"]),
          el("button", {
            class: "toggle js-working-toggle",
            type: "button",
            "aria-expanded": "false",
            "data-target": qid + "-working"
          }, ["Show working"])
        ]);
        const preview = el("p", { class: "working-preview" }, ["Working is hidden. Use “Show working” to expand inline."]);
        const content = el("div", { class: "working-content", id: qid + "-working" }, []);
        content.hidden = true;

        // Insert working html (multiple lines)
        content.innerHTML = workingHtmlLines.join("");

        working.appendChild(toggleRow);
        working.appendChild(preview);
        working.appendChild(content);
        return working;
      }

      function makeAnswerBlock(answerHtml) {
        return el("div", { class: "block answer", html: `<p class="block-title">Answer</p>${answerHtml}` }, []);
      }

      function makeQuestionBlock(questionHtml, diagramFn) {
        const parts = [`<p class="block-title">Question</p>${questionHtml}`];
        if (diagramFn) parts.push(diagramFn());
        return el("div", { class: "block question", html: parts.join("") }, []);
      }

      function makeTopQuestion(opts) {
        // opts: { id, label, meta, questionHtml, answerHtml, workingLines, subparts?, diagram? }
        const article = el("article", { class: "q", id: opts.id, "aria-label": opts.label }, []);
        const head = el("div", { class: "qhead" }, [
          el("h3", {}, [opts.label]),
          el("div", { class: "qmeta" }, [opts.meta || opts.label])
        ]);
        article.appendChild(head);

        // Parent prompt can exist or be empty in some datasets (still a question block)
        article.appendChild(makeQuestionBlock(opts.questionHtml || "<p>(No parent prompt.)</p>", opts.diagram ? diagramTypes[opts.diagram] : null));

        // If this top-level question has direct answer/working (single-part)
        if (opts.answerHtml) {
          article.appendChild(makeAnswerBlock(opts.answerHtml));
        }
        if (opts.workingLines) {
          article.appendChild(makeWorkingBlock(opts.id, opts.workingLines));
        }

        // Subparts
        if (opts.subparts && opts.subparts.length) {
          opts.subparts.forEach(sp => {
            const sub = el("section", { class: "subq", id: sp.id, "aria-label": sp.label }, []);
            sub.appendChild(el("h4", {}, [sp.label]));
            sub.appendChild(makeQuestionBlock(sp.questionHtml, sp.diagram ? diagramTypes[sp.diagram] : null));
            sub.appendChild(makeAnswerBlock(sp.answerHtml));
            sub.appendChild(makeWorkingBlock(sp.id, sp.workingLines));
            article.appendChild(sub);
          });
        }

        return article;
      }

      // ---------- Paper datasets ----------
      // Each dataset returns:
      // { id, title, subtitle, navItems: [ {type:'link', text, href, small?} | {type:'sep', text} ], nodes: [DOM nodes...] }
      function buildShortPaper() {
        // 6 questions total (mix of short arithmetic + one multi-part question)
        const nodes = [];
        const nav = [];

        // Q1-2 short
        const q1 = makeTopQuestion({
          id: "short-q1",
          label: "Question 1",
          meta: "1",
          questionHtml: `<p>A toy costs £3. How much do 4 toys cost?</p>`,
          answerHtml: `<p>£12</p>`,
          workingLines: [
            `<p>Multiply the number of toys by the cost of each toy.</p>`,
            katexBlockLine("[KaTeX block] 4 × 3"),
            katexBlockLine("[KaTeX block] = 12")
          ]
        });
        nav.push({ type: "link", text: "1", href: "#short-q1", small: "Question 1" });
        nodes.push(q1);

        const q2 = makeTopQuestion({
          id: "short-q2",
          label: "Question 2",
          meta: "2",
          questionHtml: `<p>Write the next two numbers in the sequence:</p>${katexBlockLine("5, 10, 15, 20, __, __")}`,
          answerHtml: `${katexBlockLine("25, 30")}`,
          workingLines: [
            `<p>The sequence increases by 5 each time.</p>`,
            katexBlockLine("[KaTeX block] 20 + 5 = 25"),
            katexBlockLine("[KaTeX block] 25 + 5 = 30")
          ]
        });
        nav.push({ type: "link", text: "2", href: "#short-q2", small: "Question 2" });
        nodes.push(q2);

        // Q3 multi-part
        const q3 = makeTopQuestion({
          id: "short-q3",
          label: "Question 3",
          meta: "3",
          questionHtml: `<p>Work with the expression:</p>${katexBlockLine("2x + 6")}`,
          subparts: [
            {
              id: "short-q3a",
              label: "Sub-question 3(a)",
              questionHtml: `<p>Find the value when ${katexInline()} shows x = 4.</p>`,
              answerHtml: `${katexBlockLine("14")}`,
              workingLines: [
                katexBlockLine("[KaTeX block] 2(4) + 6"),
                katexBlockLine("[KaTeX block] 8 + 6 = 14")
              ]
            },
            {
              id: "short-q3b",
              label: "Sub-question 3(b)",
              questionHtml: `<p>Simplify:</p>${katexBlockLine("3x + 2x + 6")}`,
              answerHtml: `${katexBlockLine("5x + 6")}`,
              workingLines: [
                `<p>Collect like terms:</p>`,
                katexBlockLine("[KaTeX block] 3x + 2x = 5x"),
                katexBlockLine("[KaTeX block] 5x + 6")
              ]
            }
          ]
        });
        nav.push({ type: "link", text: "3", href: "#short-q3", small: "Question 3" });
        nav.push({ type: "link", text: "3a", href: "#short-q3a", small: "Sub-question" });
        nav.push({ type: "link", text: "3b", href: "#short-q3b", small: "Sub-question" });
        nodes.push(q3);

        // Q4-6 short
        for (let i = 4; i <= 6; i++) {
          const id = "short-q" + i;
          const q = makeTopQuestion({
            id,
            label: "Question " + i,
            meta: String(i),
            questionHtml: `<p>Short arithmetic prompt ${katexInline()}.</p>${katexBlockLine("[KaTeX block] (prompt placeholder)")}`,
            answerHtml: `${katexBlockLine("[KaTeX block] (answer placeholder)")}`,
            workingLines: [
              `<p>One short step.</p>`,
              katexBlockLine("[KaTeX block] (working placeholder)")
            ]
          });
          nav.push({ type: "link", text: String(i), href: "#" + id, small: "Question " + i });
          nodes.push(q);
        }

        return {
          id: "short",
          title: "Short paper",
          subtitle: "6 questions total (mix of short arithmetic + one multi-part question).",
          navItems: nav,
          nodes
        };
      }

      function buildStandardPaper() {
        // 35 questions total; Q26–Q35 long algebra (workings collapsed by default)
        const nodes = [];
        const nav = [];

        for (let i = 1; i <= 35; i++) {
          const id = "std-q" + i;
          let questionHtml, answerHtml, workingLines;

          if (i <= 25) {
            questionHtml = `<p>Standard question prompt ${katexInline()}.</p>${katexBlockLine("[KaTeX block] (prompt placeholder)")}`;
            answerHtml = `${katexBlockLine("[KaTeX block] (answer placeholder)")}`;
            workingLines = [
              `<p>Short working steps.</p>`,
              katexBlockLine("[KaTeX block] Step 1"),
              katexBlockLine("[KaTeX block] Step 2")
            ];
          } else {
            // long algebra questions
            questionHtml = `<p>Long algebra prompt with multiple expressions.</p>` +
              katexBlockLine("[KaTeX block] (given expression)") +
              katexBlockLine("[KaTeX block] (target to simplify/solve)");
            answerHtml = `${katexBlockLine("[KaTeX block] (final simplified form / solution)")}`;

            // multiple KaTeX placeholder lines in Working
            workingLines = [
              `<p>Work through the algebra carefully.</p>`,
              katexBlockLine("[KaTeX block] Line 1"),
              katexBlockLine("[KaTeX block] Line 2"),
              katexBlockLine("[KaTeX block] Line 3"),
              katexBlockLine("[KaTeX block] Line 4"),
              katexBlockLine("[KaTeX block] Line 5"),
              katexBlockLine("[KaTeX block] Line 6"),
              katexBlockLine("[KaTeX block] Line 7"),
              katexBlockLine("[KaTeX block] Line 8"),
              katexBlockLine("[KaTeX block] Line 9"),
              katexBlockLine("[KaTeX block] Line 10")
            ];
          }

          const q = makeTopQuestion({
            id,
            label: "Question " + i,
            meta: String(i),
            questionHtml,
            answerHtml,
            workingLines
          });

          nav.push({ type: "link", text: String(i), href: "#" + id, small: "Question " + i });
          nodes.push(q);
        }

        return {
          id: "standard",
          title: "Standard paper",
          subtitle: "35 questions total. Q26–Q35 are long algebra questions (workings collapsed by default).",
          navItems: nav,
          nodes
        };
      }

      function buildDiagramPaper() {
        // 20 questions total; 8 contain diagrams
        const nodes = [];
        const nav = [];

        // choose 8 indices for diagrams
        const diagramQs = new Set([2, 4, 6, 9, 12, 14, 17, 20]);
        const diagramCycle = ["geometry", "bars", "grid", "array"];
        let dIdx = 0;

        for (let i = 1; i <= 20; i++) {
          const id = "dia-q" + i;
          const hasDiagram = diagramQs.has(i);
          const diag = hasDiagram ? diagramCycle[dIdx++ % diagramCycle.length] : null;

          const q = makeTopQuestion({
            id,
            label: "Question " + i,
            meta: String(i),
            questionHtml: `<p>Diagram-heavy prompt ${katexInline()}.</p>${katexBlockLine("[KaTeX block] (prompt placeholder)")}` +
              (hasDiagram ? `<p>Refer to the diagram below.</p>` : ``),
            diagram: diag,
            answerHtml: `${katexBlockLine("[KaTeX block] (answer placeholder)")}`,
            workingLines: [
              `<p>Show the steps.</p>`,
              katexBlockLine("[KaTeX block] (working placeholder line 1)"),
              katexBlockLine("[KaTeX block] (working placeholder line 2)")
            ]
          });

          nav.push({ type: "link", text: String(i), href: "#" + id, small: hasDiagram ? "Question (diagram)" : "Question" });
          nodes.push(q);
        }

        return {
          id: "diagram",
          title: "Diagram-heavy paper",
          subtitle: "20 questions total, with 8 questions containing diagrams (inline SVG placeholders).",
          navItems: nav,
          nodes
        };
      }

      function buildSectionedPaper() {
        // Sections A/B/C are part of the paper
        // Use numbering A1..A35, B1..B8, C1..C6 consistently
        const nodes = [];
        const nav = [];

        // Section A heading node (inline within document)
        const secA = el("div", { class: "section", id: "sec-a", "aria-label": "Section A" }, [
          el("h2", {}, ["Section A"])
        ]);
        nodes.push(secA);

        nav.push({ type: "sep", text: "A" });

        for (let i = 1; i <= 35; i++) {
          const id = "sec-a" + i;
          const q = makeTopQuestion({
            id,
            label: "Question A" + i,
            meta: "A" + i,
            questionHtml: `<p>Section A prompt ${katexInline()}.</p>${katexBlockLine("[KaTeX block] (prompt placeholder)")}`,
            answerHtml: `${katexBlockLine("[KaTeX block] (answer placeholder)")}`,
            workingLines: [
              `<p>Working steps.</p>`,
              katexBlockLine("[KaTeX block] (working line 1)"),
              katexBlockLine("[KaTeX block] (working line 2)")
            ]
          });
          nav.push({ type: "link", text: "A" + i, href: "#" + id, small: "Question" });
          nodes.push(q);
        }

        const secB = el("div", { class: "section", id: "sec-b", "aria-label": "Section B" }, [
          el("h2", {}, ["Section B"])
        ]);
        nodes.push(secB);

        nav.push({ type: "sep", text: "B" });

        for (let i = 1; i <= 8; i++) {
          const id = "sec-b" + i;
          const q = makeTopQuestion({
            id,
            label: "Question B" + i,
            meta: "B" + i,
            questionHtml: `<p>Section B prompt ${katexInline()}.</p>${katexBlockLine("[KaTeX block] (prompt placeholder)")}`,
            answerHtml: `${katexBlockLine("[KaTeX block] (answer placeholder)")}`,
            workingLines: [
              `<p>Working steps.</p>`,
              katexBlockLine("[KaTeX block] (working line 1)"),
              katexBlockLine("[KaTeX block] (working line 2)"),
              katexBlockLine("[KaTeX block] (working line 3)")
            ]
          });
          nav.push({ type: "link", text: "B" + i, href: "#" + id, small: "Question" });
          nodes.push(q);
        }

        const secC = el("div", { class: "section", id: "sec-c", "aria-label": "Section C" }, [
          el("h2", {}, ["Section C"])
        ]);
        nodes.push(secC);

        nav.push({ type: "sep", text: "C" });

        for (let i = 1; i <= 6; i++) {
          const id = "sec-c" + i;
          const q = makeTopQuestion({
            id,
            label: "Question C" + i,
            meta: "C" + i,
            questionHtml: `<p>Section C long prompt (very long working when expanded).</p>` +
              katexBlockLine("[KaTeX block] (given expression)") +
              katexBlockLine("[KaTeX block] (target to simplify/solve)"),
            answerHtml: `${katexBlockLine("[KaTeX block] (final answer placeholder)")}`,
            workingLines: [
              `<p>Long working (multiple screens when expanded).</p>`,
              katexBlockLine("[KaTeX block] Line 1"),
              katexBlockLine("[KaTeX block] Line 2"),
              katexBlockLine("[KaTeX block] Line 3"),
              katexBlockLine("[KaTeX block] Line 4"),
              katexBlockLine("[KaTeX block] Line 5"),
              katexBlockLine("[KaTeX block] Line 6"),
              katexBlockLine("[KaTeX block] Line 7"),
              katexBlockLine("[KaTeX block] Line 8"),
              katexBlockLine("[KaTeX block] Line 9"),
              katexBlockLine("[KaTeX block] Line 10"),
              katexBlockLine("[KaTeX block] Line 11"),
              katexBlockLine("[KaTeX block] Line 12"),
              katexBlockLine("[KaTeX block] Line 13"),
              katexBlockLine("[KaTeX block] Line 14"),
              katexBlockLine("[KaTeX block] Line 15")
            ]
          });
          nav.push({ type: "link", text: "C" + i, href: "#" + id, small: "Question (long)" });
          nodes.push(q);
        }

        return {
          id: "sectioned",
          title: "Sectioned paper",
          subtitle: "Paper contains Section A (35), Section B (8), Section C (6 long). Sections appear inline as headings.",
          navItems: nav,
          nodes
        };
      }

      const datasets = {
        short: buildShortPaper,
        standard: buildStandardPaper,
        diagram: buildDiagramPaper,
        sectioned: buildSectionedPaper
      };

      // ---------- Render + Nav ----------
      const paperRoot = document.getElementById("paperRoot");
      const paperTitle = document.getElementById("paperTitle");
      const paperSubtitle = document.getElementById("paperSubtitle");
      const navRail = document.getElementById("navListRail");
      const navDrawer = document.getElementById("navListDrawer");
      const paperSelect = document.getElementById("paperSelect");

      function clearNode(node) {
        while (node.firstChild) node.removeChild(node.firstChild);
      }

      function buildNavList(navItems, ul) {
        clearNode(ul);
        navItems.forEach(item => {
          const li = document.createElement("li");
          if (item.type === "sep") {
            li.appendChild(el("div", { class: "nav-sep" }, [item.text]));
          } else {
            const a = el("a", { href: item.href }, []);
            a.appendChild(document.createTextNode(item.text));
            if (item.small) {
              const sm = document.createElement("small");
              sm.textContent = item.small;
              a.appendChild(sm);
            }
            li.appendChild(a);
          }
          ul.appendChild(li);
        });
      }

      function wireWorkingToggles(scope) {
        // enforce defaults: answers visible (no action), workings collapsed
        const toggles = scope.querySelectorAll(".js-working-toggle");
        toggles.forEach(btn => {
          const targetId = btn.getAttribute("data-target");
          const panel = document.getElementById(targetId);
          if (!panel) return;

          btn.setAttribute("aria-expanded", "false");
          panel.hidden = true;
          btn.textContent = "Show working";

          btn.addEventListener("click", () => {
            const expanded = btn.getAttribute("aria-expanded") === "true";
            const next = !expanded;
            btn.setAttribute("aria-expanded", String(next));
            panel.hidden = !next;
            btn.textContent = next ? "Hide working" : "Show working";
          });
        });
      }

      function renderPaper(key) {
        const build = datasets[key];
        const data = build();

        // Update header
        paperTitle.textContent = data.title;
        paperSubtitle.textContent = data.subtitle + " Answers visible by default. Workings collapsed by default. Questions always visible.";

        // Replace content (switching papers hides/shows by rebuilding)
        clearNode(paperRoot);
        data.nodes.forEach(n => paperRoot.appendChild(n));

        // Update nav for current paper
        buildNavList(data.navItems, navRail);
        buildNavList(data.navItems, navDrawer);

        // Wire toggles for the new content
        wireWorkingToggles(document);

        // Do NOT auto change states beyond defaults (render enforces defaults only)
      }

      // ---------- Drawer behavior (tablet/mobile nav) ----------
      const navToggle = document.getElementById("navToggle");
      const backdrop = document.getElementById("drawerBackdrop");
      const closeBtn = document.getElementById("drawerClose");

      function openDrawer() {
        backdrop.classList.add("open");
        backdrop.setAttribute("aria-hidden", "false");
        navToggle.setAttribute("aria-expanded", "true");
        closeBtn.focus();
      }

      function closeDrawer() {
        backdrop.classList.remove("open");
        backdrop.setAttribute("aria-hidden", "true");
        navToggle.setAttribute("aria-expanded", "false");
        navToggle.focus();
      }

      navToggle.addEventListener("click", () => {
        const isOpen = backdrop.classList.contains("open");
        if (isOpen) closeDrawer(); else openDrawer();
      });

      closeBtn.addEventListener("click", closeDrawer);

      backdrop.addEventListener("click", (e) => {
        if (e.target === backdrop) closeDrawer();
      });

      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && backdrop.classList.contains("open")) closeDrawer();
      });

      // Close drawer on nav click (navigation is non-destructive)
      function wireDrawerNavClose() {
        navDrawer.addEventListener("click", (e) => {
          const a = e.target.closest && e.target.closest('a[href^="#"]');
          if (a) closeDrawer();
        });
      }

      // ---------- Paper selector ----------
      paperSelect.addEventListener("change", () => {
        renderPaper(paperSelect.value);
        // do not scroll or expand/collapse beyond defaults
      });

      // ---------- Init ----------
      renderPaper("short");
      wireDrawerNavClose();
    })();
  </script>
</body>

</html>