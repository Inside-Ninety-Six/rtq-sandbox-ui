<!doctype html>
<html lang="en-GB">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>RTQ – Maths Paper Solution Viewer (Stress Test)</title>

    <!-- Real KaTeX Rendering (CDN) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js" crossorigin="anonymous"></script>

    <style>
        :root {
            /* Soft-warm neutral base (subtle) */
            --page-bg: #f2efe8;
            --surface: #fbfaf6;
            --surface-ink: rgba(0, 0, 0, 0.06);
            --surface-ink-2: rgba(0, 0, 0, 0.085);

            --solution-bg: #f6f3ec;

            --text: #1f1f1f;
            --muted: #5c5c5c;
            --muted-2: #737373;

            --focus: rgba(0, 0, 0, 0.65);

            --frame-max: 1120px;
            --nav-w: 140px;

            --gutter: 18px;

            /* Rhythm */
            --q-gap: 28px;
            /* between top-level questions (largest) */
            --qa-gap: 10px;
            /* question → answer */
            --at-gap: 8px;
            /* answer → toggle */
            --sd-gap: 14px;
            /* between subsections inside Solution Details */
            --line-gap: 10px;
            /* within workings */

            --radius: 10px;
            /* mild rounding for surfaces (not card-like) */
            --shadow: none;
            /* explicitly no elevation */
        }

        * {
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
        }

        body {
            margin: 0;
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
            color: var(--text);
            background: var(--page-bg);
            overflow-x: hidden;
            /* page must never scroll horizontally */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Skip link (accessibility) */
        .skip {
            position: absolute;
            left: -9999px;
            top: 12px;
            padding: 10px 12px;
            background: var(--surface);
            border: 1px solid var(--surface-ink-2);
            border-radius: 8px;
            color: var(--text);
            z-index: 1000;
        }

        .skip:focus {
            left: 12px;
            outline: 2px solid var(--focus);
            outline-offset: 2px;
        }

        /* Top controls aligned with centered frame */
        .topbar {
            position: sticky;
            top: 0;
            z-index: 30;
            background: var(--page-bg);
            border-bottom: 1px solid var(--surface-ink);
        }

        .topbar-inner {
            max-width: var(--frame-max);
            margin: 0 auto;
            padding: 10px var(--gutter);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .controls {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            min-width: 0;
        }

        .control-label {
            font-size: 13px;
            color: var(--muted);
            white-space: nowrap;
        }

        .paper-select {
            font-size: 14px;
            line-height: 1.2;
            padding: 8px 10px;
            border: 1px solid var(--surface-ink-2);
            background: var(--surface);
            border-radius: 10px;
            color: var(--text);
            max-width: 100%;
        }

        .paper-select:focus {
            outline: 2px solid var(--focus);
            outline-offset: 2px;
        }

        .jump-btn {
            font-size: 13px;
            color: var(--muted);
            background: transparent;
            border: 1px solid transparent;
            padding: 8px 10px;
            border-radius: 10px;
            cursor: pointer;
            white-space: nowrap;
        }

        .jump-btn:hover {
            text-decoration: underline;
        }

        .jump-btn:focus {
            outline: 2px solid var(--focus);
            outline-offset: 2px;
        }

        /* Centered frame containing nav + paper on same surface */
        .frame {
            max-width: var(--frame-max);
            margin: 14px auto 36px;
            padding: 0 var(--gutter);
        }

        .surface {
            background: var(--surface);
            border: 1px solid var(--surface-ink);
            border-radius: var(--radius);
            padding: 16px;
        }

        .layout {
            display: grid;
            grid-template-columns: var(--nav-w) minmax(0, 1fr);
            gap: 18px;
            align-items: start;
        }

        /* Navigation: quiet, no background panel */
        nav[aria-label="Questions"] {
            min-width: 0;
        }

        .nav-sticky {
            position: sticky;
            top: 62px;
            /* below sticky topbar */
            max-height: calc(100vh - 78px);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .nav-title {
            font-size: 12px;
            color: var(--muted-2);
            letter-spacing: 0.02em;
            user-select: none;
        }

        .nav-list {
            overflow: auto;
            padding-right: 6px;
            scrollbar-width: none;
            /* Firefox */
            -ms-overflow-style: none;
            /* legacy */
            outline: none;
        }

        .nav-list::-webkit-scrollbar {
            display: none;
        }

        /* WebKit/Blink */
        .nav-list:focus {
            outline: 2px solid var(--focus);
            outline-offset: 2px;
            border-radius: 8px;
        }

        .nav-ul {
            list-style: none;
            margin: 0;
            padding: 0;
            display: grid;
            gap: 4px;
        }

        .nav-sep {
            font-size: 12px;
            color: var(--muted-2);
            padding: 6px 0 4px;
            user-select: none;
        }

        .nav-link {
            width: 100%;
            text-align: left;
            font-size: 13px;
            line-height: 1.25;
            color: var(--muted-2);
            background: transparent;
            border: 0;
            padding: 6px 6px 6px 10px;
            border-radius: 10px;
            cursor: pointer;
            position: relative;
        }

        .nav-link:hover {
            text-decoration: underline;
        }

        .nav-link:focus {
            outline: 2px solid var(--focus);
            outline-offset: 2px;
        }

        .nav-link[aria-current="true"] {
            color: var(--muted);
            font-weight: 600;
            /* bold allowed only for current nav item */
            text-decoration: none;
        }

        .nav-link[aria-current="true"]::before {
            content: "";
            position: absolute;
            left: 0;
            top: 7px;
            bottom: 7px;
            width: 2px;
            background: rgba(0, 0, 0, 0.35);
            border-radius: 999px;
        }

        /* Paper content */
        main {
            min-width: 0;
        }

        .paper {
            display: block;
        }

        .section-header {
            margin: 22px 0 12px;
            font-size: 14px;
            color: var(--muted);
            letter-spacing: 0.02em;
        }

        .section-header:first-child {
            margin-top: 0;
        }

        .question {
            margin: 0 0 var(--q-gap);
            scroll-margin-top: 88px;
            /* offset for sticky topbar */
        }

        .question:last-child {
            margin-bottom: 0;
        }

        .q-row {
            display: flex;
            gap: 10px;
            align-items: baseline;
        }

        .qid {
            flex: 0 0 auto;
            font-size: 13px;
            color: var(--muted);
            min-width: 48px;
            letter-spacing: 0.01em;
        }

        .q-body {
            flex: 1 1 auto;
            min-width: 0;
        }

        .q-prompt {
            font-size: 16px;
            line-height: 1.55;
            margin: 0;
            color: var(--text);
        }

        /* Nesting via indentation only */
        .depth-0 {
            padding-left: 0;
        }

        .depth-1 {
            padding-left: clamp(10px, 2vw, 18px);
        }

        .depth-2 {
            padding-left: clamp(18px, 3vw, 30px);
        }

        .depth-3 {
            padding-left: clamp(26px, 4vw, 42px);
        }

        .answer {
            margin-top: var(--qa-gap);
            display: grid;
            gap: 6px;
        }

        .answer-line {
            display: flex;
            gap: 10px;
            align-items: baseline;
            min-width: 0;
        }

        .label {
            font-size: 12px;
            color: var(--muted);
            font-weight: 600;
            letter-spacing: 0.02em;
            flex: 0 0 auto;
            min-width: 58px;
        }

        .answer-value {
            font-size: 15px;
            line-height: 1.45;
            color: var(--text);
            min-width: 0;
        }

        .answer-list {
            margin: 0 0 0 18px;
            padding: 0;
            color: var(--text);
            font-size: 15px;
            line-height: 1.45;
        }

        .toggle-row {
            margin-top: var(--at-gap);
        }

        .toggle {
            font-size: 13px;
            color: var(--muted);
            background: transparent;
            border: 0;
            padding: 6px 0;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .toggle:hover {
            text-decoration: underline;
        }

        .toggle:focus {
            outline: 2px solid var(--focus);
            outline-offset: 2px;
            border-radius: 8px;
        }

        .chev {
            width: 12px;
            height: 12px;
            flex: 0 0 auto;
            opacity: 0.75;
        }

        .toggle[aria-expanded="true"] .chev {
            transform: rotate(180deg);
        }

        /* Solution Details: light but clear separation, no card feel */
        .solution-wrap {
            margin-top: 10px;
            background: var(--solution-bg);
            border-top: 1px solid var(--surface-ink);
            padding: 12px 12px 14px;
            border-radius: 8px;
        }

        /* Inline expand/collapse without jumpy behaviour */
        .solution {
            overflow: hidden;
            max-height: 0;
            opacity: 0.98;
            will-change: max-height;
            transition: max-height 180ms ease;
        }

        @media (prefers-reduced-motion: reduce) {
            .solution {
                transition: none;
            }

            .toggle[aria-expanded="true"] .chev {
                transform: none;
            }
        }

        .solution.is-open {
            opacity: 1;
        }

        .sd-block {
            margin: 0 0 var(--sd-gap);
        }

        .sd-block:last-child {
            margin-bottom: 0;
        }

        .sd-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--muted);
            letter-spacing: 0.02em;
            margin: 0 0 8px;
        }

        .sd-text {
            font-size: 14px;
            line-height: 1.5;
            color: var(--muted);
            margin: 0;
        }

        .sd-ul {
            margin: 0;
            padding-left: 18px;
            color: var(--muted);
            font-size: 14px;
            line-height: 1.5;
            display: grid;
            gap: 6px;
        }

        .work {
            display: grid;
            gap: var(--line-gap);
        }

        /* Diagram placeholders */
        .diagram {
            margin-top: 10px;
            max-width: 100%;
        }

        .diagram svg {
            width: 100%;
            height: auto;
            display: block;
            pointer-events: none;
            /* must not trap touch */
        }

        .diagram-caption {
            font-size: 12px;
            color: var(--muted-2);
            margin-top: 6px;
        }

        /* KaTeX containment invariant */
        .math-inline,
        .math-block {
            max-width: 100%;
        }

        .math-inline {
            white-space: nowrap;
        }

        .math-block {
            overflow-x: auto;
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
            max-width: 100%;
            padding: 6px 0;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .math-block::-webkit-scrollbar {
            display: none;
        }

        /* Keep KaTeX display from widening page */
        .math-block .katex-display {
            margin: 0;
            max-width: 100%;
            overflow-x: auto;
            overflow-y: hidden;
        }

        .math-block .katex-display>.katex {
            max-width: 100%;
        }

        .katex {
            font-size: 1em;
        }

        /* Mobile / tablet */
        @media (max-width: 860px) {
            :root {
                --nav-w: 0px;
            }

            .layout {
                grid-template-columns: 1fr;
                gap: 0;
            }

            nav[aria-label="Questions"] {
                display: none;
            }

            .surface {
                padding: 14px;
            }

            .qid {
                min-width: 44px;
            }

            .q-prompt {
                font-size: 16px;
            }
        }

        /* Mobile overlay (drawer-like) */
        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.22);
            z-index: 60;
            display: none;
        }

        .overlay[aria-hidden="false"] {
            display: block;
        }

        .overlay-panel {
            position: absolute;
            inset: 10px;
            background: var(--surface);
            border: 1px solid var(--surface-ink);
            border-radius: 14px;
            display: grid;
            grid-template-rows: auto 1fr;
            overflow: hidden;
        }

        .overlay-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 12px 12px 10px;
            border-bottom: 1px solid var(--surface-ink);
            background: var(--surface);
        }

        .overlay-title {
            font-size: 13px;
            color: var(--muted);
            letter-spacing: 0.02em;
            margin: 0;
            user-select: none;
        }

        .overlay-close {
            font-size: 13px;
            color: var(--muted);
            background: transparent;
            border: 1px solid transparent;
            padding: 8px 10px;
            border-radius: 10px;
            cursor: pointer;
        }

        .overlay-close:hover {
            text-decoration: underline;
        }

        .overlay-close:focus {
            outline: 2px solid var(--focus);
            outline-offset: 2px;
        }

        .overlay-body {
            padding: 10px 10px 12px;
            overflow: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .overlay-body::-webkit-scrollbar {
            display: none;
        }

        /* Small helper: visibly quiet separators */
        .hairline {
            height: 1px;
            background: var(--surface-ink);
            margin: 14px 0;
        }
    </style>
</head>

<body>
    <a class="skip" href="#paper">Skip to paper</a>

    <header class="topbar" role="banner">
        <div class="topbar-inner">
            <div class="controls" aria-label="Paper controls">
                <span class="control-label">Paper</span>
                <select id="paperSelect" class="paper-select" aria-label="Paper selector"></select>
            </div>
            <button id="openNav" class="jump-btn" type="button" aria-haspopup="dialog" aria-controls="navOverlay">
                Jump to
            </button>
        </div>
    </header>

    <div class="frame">
        <div class="surface">
            <div class="layout">
                <nav aria-label="Questions">
                    <div class="nav-sticky">
                        <div class="nav-title">Questions</div>
                        <div class="nav-list" id="navListDesktop" tabindex="0" aria-label="Question navigation list">
                            <!-- injected -->
                        </div>
                    </div>
                </nav>

                <main id="paper" class="paper" aria-label="Paper content">
                    <!-- injected -->
                </main>
            </div>
        </div>
    </div>

    <!-- Mobile overlay navigation -->
    <div id="navOverlay" class="overlay" role="dialog" aria-modal="true" aria-hidden="true"
        aria-label="Jump to question">
        <div class="overlay-panel" role="document">
            <div class="overlay-head">
                <p class="overlay-title">Jump to</p>
                <button id="closeNav" class="overlay-close" type="button">Close</button>
            </div>
            <div class="overlay-body" id="navListMobile" tabindex="0" aria-label="Question navigation list">
                <!-- injected -->
            </div>
        </div>
    </div>

    <script>
        (() => {
            const prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;

            const el = (tag, attrs = {}, children = []) => {
                const node = document.createElement(tag);
                for (const [k, v] of Object.entries(attrs)) {
                    if (k === 'class') node.className = v;
                    else if (k === 'text') node.textContent = v;
                    else if (k === 'html') node.innerHTML = v;
                    else if (k.startsWith('aria-')) node.setAttribute(k, v);
                    else if (k === 'dataset') Object.assign(node.dataset, v);
                    else if (k === 'tabIndex') node.tabIndex = v;
                    else if (k === 'id') node.id = v;
                    else node.setAttribute(k, v);
                }
                for (const c of children) node.appendChild(c);
                return node;
            };

            const t = (s) => document.createTextNode(s);

            const seg = {
                text: (v) => ({ type: 'text', v }),
                mi: (latex) => ({ type: 'math-inline', latex }),
                mb: (latex) => ({ type: 'math-block', latex })
            };

            function renderSegments(container, segments) {
                for (const s of segments) {
                    if (s.type === 'text') container.appendChild(t(s.v));
                    if (s.type === 'math-inline') {
                        const span = el('span', { class: 'math-inline', dataset: { latex: s.latex } }, []);
                        span.textContent = `\\(${s.latex}\\)`;
                        container.appendChild(span);
                    }
                    if (s.type === 'math-block') {
                        const div = el('div', { class: 'math-block', dataset: { latex: s.latex } }, []);
                        div.textContent = `\\[${s.latex}\\]`;
                        container.appendChild(div);
                    }
                }
            }

            /* Inline SVG placeholder diagrams (grayscale only) */
            function diagramSVG(type) {
                const stroke = '#2a2a2a';
                const light = '#d8d5cf';
                const mid = '#bdb9b2';
                const text = '#2a2a2a';

                if (type === 'geometry') {
                    return `
            <svg viewBox="0 0 360 200" role="img" aria-label="Geometry diagram">
              <rect x="0" y="0" width="360" height="200" fill="transparent"/>
              <polygon points="70,160 290,160 210,40" fill="none" stroke="${stroke}" stroke-width="2"/>
              <circle cx="210" cy="40" r="3" fill="${stroke}"/>
              <circle cx="70" cy="160" r="3" fill="${stroke}"/>
              <circle cx="290" cy="160" r="3" fill="${stroke}"/>
              <text x="202" y="28" fill="${text}" font-size="14">A</text>
              <text x="52" y="178" fill="${text}" font-size="14">B</text>
              <text x="300" y="178" fill="${text}" font-size="14">C</text>
              <text x="168" y="110" fill="${text}" font-size="13">x°</text>
              <line x1="70" y1="160" x2="210" y2="40" stroke="${mid}" stroke-width="1.5" stroke-dasharray="4,4"/>
              <line x1="210" y1="40" x2="290" y2="160" stroke="${mid}" stroke-width="1.5" stroke-dasharray="4,4"/>
            </svg>`;
                }

                if (type === 'ratio') {
                    return `
            <svg viewBox="0 0 360 120" role="img" aria-label="Ratio bar diagram">
              <rect x="24" y="44" width="312" height="32" fill="none" stroke="${stroke}" stroke-width="2"/>
              <line x1="24" y1="44" x2="24" y2="76" stroke="${stroke}" stroke-width="2"/>
              <line x1="24" y1="44" x2="24" y2="76" stroke="${stroke}" stroke-width="2"/>
              <line x1="24" y1="44" x2="24" y2="76" stroke="${stroke}" stroke-width="2"/>
              <line x1="24" y1="44" x2="24" y2="76" stroke="${stroke}" stroke-width="2"/>
              <line x1="24" y1="44" x2="24" y2="76" stroke="${stroke}" stroke-width="2"/>
              <line x1="24" y1="44" x2="24" y2="76" stroke="${stroke}" stroke-width="2"/>
              ${[1, 2, 3, 4, 5, 6].map(i => `<line x1="${24 + i * 52}" y1="44" x2="${24 + i * 52}" y2="76" stroke="${mid}" stroke-width="2"/>`).join('')}
              <text x="24" y="30" fill="${text}" font-size="13">A</text>
              <text x="330" y="30" fill="${text}" font-size="13" text-anchor="end">B</text>
              <rect x="24" y="44" width="156" height="32" fill="${light}" opacity="0.65"/>
              <text x="102" y="66" fill="${text}" font-size="13" text-anchor="middle">3 parts</text>
              <text x="258" y="66" fill="${text}" font-size="13" text-anchor="middle">3 parts</text>
            </svg>`;
                }

                if (type === 'grid') {
                    return `
            <svg viewBox="0 0 360 220" role="img" aria-label="Coordinate grid diagram">
              <rect x="0" y="0" width="360" height="220" fill="transparent"/>
              <rect x="40" y="20" width="300" height="170" fill="none" stroke="${stroke}" stroke-width="1.5"/>
              ${Array.from({ length: 5 }).map((_, i) => `<line x1="${40 + i * 60}" y1="20" x2="${40 + i * 60}" y2="190" stroke="${light}" stroke-width="1"/>`).join('')}
              ${Array.from({ length: 6 }).map((_, i) => `<line x1="40" y1="${20 + i * 34}" x2="340" y2="${20 + i * 34}" stroke="${light}" stroke-width="1"/>`).join('')}
              <line x1="40" y1="190" x2="340" y2="190" stroke="${stroke}" stroke-width="2"/>
              <line x1="40" y1="190" x2="40" y2="20" stroke="${stroke}" stroke-width="2"/>
              <circle cx="160" cy="122" r="4" fill="${stroke}"/>
              <circle cx="280" cy="54" r="4" fill="${stroke}"/>
              <line x1="160" y1="122" x2="280" y2="54" stroke="${mid}" stroke-width="2"/>
              <text x="154" y="146" fill="${text}" font-size="12">(2,2)</text>
              <text x="272" y="42" fill="${text}" font-size="12">(4,4)</text>
            </svg>`;
                }

                if (type === 'table') {
                    return `
            <svg viewBox="0 0 360 190" role="img" aria-label="Table grid diagram">
              <rect x="40" y="30" width="280" height="120" fill="none" stroke="${stroke}" stroke-width="2"/>
              ${[1, 2].map(i => `<line x1="${40 + i * 93.33}" y1="30" x2="${40 + i * 93.33}" y2="150" stroke="${mid}" stroke-width="2"/>`).join('')}
              ${[1, 2].map(i => `<line x1="40" y1="${30 + i * 40}" x2="320" y2="${30 + i * 40}" stroke="${mid}" stroke-width="2"/>`).join('')}
              <text x="86" y="58" fill="${text}" font-size="13" text-anchor="middle">1</text>
              <text x="180" y="58" fill="${text}" font-size="13" text-anchor="middle">2</text>
              <text x="273" y="58" fill="${text}" font-size="13" text-anchor="middle">3</text>
              <text x="86" y="98" fill="${text}" font-size="13" text-anchor="middle">4</text>
              <text x="180" y="98" fill="${text}" font-size="13" text-anchor="middle">5</text>
              <text x="273" y="98" fill="${text}" font-size="13" text-anchor="middle">6</text>
              <text x="86" y="138" fill="${text}" font-size="13" text-anchor="middle">7</text>
              <text x="180" y="138" fill="${text}" font-size="13" text-anchor="middle">8</text>
              <text x="273" y="138" fill="${text}" font-size="13" text-anchor="middle">9</text>
            </svg>`;
                }

                return `<svg viewBox="0 0 360 120" role="img" aria-label="Diagram placeholder"><rect x="10" y="10" width="340" height="100" fill="none" stroke="#2a2a2a" stroke-width="2"/></svg>`;
            }

            function makeDiagram(type, caption) {
                const wrap = el('div', { class: 'diagram' }, []);
                wrap.innerHTML = diagramSVG(type);
                if (caption) wrap.appendChild(el('div', { class: 'diagram-caption', text: caption }, []));
                return wrap;
            }

            function workLineP(segments) {
                return { kind: 'p', segments };
            }
            function workLineMath(latex) {
                return { kind: 'math', latex };
            }

            function longWorkingLines(seedLabel) {
                // 55 lines of display math (extremely long workings stress test)
                const lines = [];
                for (let i = 1; i <= 55; i++) {
                    const a = i;
                    const b = i + 1;
                    const c = i + 2;
                    lines.push(workLineMath(String.raw`a_${a} = ${seedLabel} + ${a} \quad,\quad a_${b} = a_${a} + ${b} \quad,\quad a_${c} = a_${b} + ${c}`));
                }
                lines.push(workLineMath(String.raw`\text{So the pattern continues until the required step.}`));
                return lines;
            }

            /* --- Dataset builders (synthetic; exemplar-guided tone/structure) --- */

            function buildShortPaper() {
                return {
                    id: 'short',
                    title: 'Short paper',
                    sections: [{
                        label: null,
                        questions: [
                            {
                                qid: '1',
                                depth: 0,
                                prompt: [
                                    seg.text('Fill in the missing number: '),
                                    seg.mi('45 + \\Box = 83')
                                ],
                                diagrams: [],
                                answer: { type: 'single', value: [seg.mi('38')] },
                                solution: {
                                    guidance: null,
                                    formulae: null,
                                    working: [
                                        workLineP([seg.text('Let the missing number be '), seg.mi('a'), seg.text('.')]),
                                        workLineMath(String.raw`\begin{aligned}
45 + a &= 83\\
a &= 83 - 45\\
a &= 38
\end{aligned}`),
                                        workLineP([seg.text('Missing number = '), seg.mi('38'), seg.text('.')])
                                    ],
                                    alternative: null
                                }
                            },
                            {
                                qid: '2',
                                depth: 0,
                                prompt: [
                                    seg.text('Work out '),
                                    seg.mi('3\\dfrac{1}{2} + 1\\dfrac{3}{4}'),
                                    seg.text('.')
                                ],
                                diagrams: [],
                                answer: { type: 'single', value: [seg.mi('5\\dfrac{1}{4}')] },
                                solution: {
                                    guidance: [
                                        [seg.text('Convert mixed numbers to improper fractions before adding.')]
                                    ],
                                    formulae: null,
                                    working: [
                                        workLineMath(String.raw`\begin{aligned}
3\dfrac{1}{2} &= \dfrac{7}{2}\\
1\dfrac{3}{4} &= \dfrac{7}{4}\\
\dfrac{7}{2} + \dfrac{7}{4} &= \dfrac{14}{4} + \dfrac{7}{4} = \dfrac{21}{4}\\
\dfrac{21}{4} &= 5\dfrac{1}{4}
\end{aligned}`)
                                    ],
                                    alternative: null
                                }
                            },
                            {
                                qid: '3',
                                depth: 0,
                                prompt: [
                                    seg.text('A jug has '),
                                    seg.mi('120\\,\\text{ml}'),
                                    seg.text(' of squash. How much water is needed to make '),
                                    seg.mi('500\\,\\text{ml}'),
                                    seg.text(' of drink?')
                                ],
                                diagrams: [{ type: 'table', caption: 'A simple jug scale (not to scale).' }],
                                answer: { type: 'single', value: [seg.mi('380\\,\\text{ml}')] },
                                solution: {
                                    guidance: null,
                                    formulae: null,
                                    working: [
                                        workLineMath(String.raw`\begin{aligned}
\text{Water needed} &= 500 - 120\\
&= 380\ \text{ml}
\end{aligned}`)
                                    ],
                                    alternative: null
                                }
                            },
                            {
                                qid: '4',
                                depth: 0,
                                prompt: [
                                    seg.text('Solve: '),
                                    seg.mi('5x - 7 = 18')
                                ],
                                diagrams: [],
                                answer: { type: 'single', value: [seg.mi('x = 5')] },
                                solution: {
                                    guidance: [
                                        [seg.text('Do the same operation to both sides to isolate the variable.')]
                                    ],
                                    formulae: null,
                                    working: [
                                        workLineMath(String.raw`\begin{aligned}
5x - 7 &= 18\\
5x &= 25\\
x &= 5
\end{aligned}`)
                                    ],
                                    alternative: null
                                }
                            },
                            {
                                qid: '5',
                                depth: 0,
                                prompt: [
                                    seg.text('A packet costs '),
                                    seg.mi('\\pounds 2.40'),
                                    seg.text('. It is reduced by '),
                                    seg.mi('15\\%'),
                                    seg.text('. What is the new price?')
                                ],
                                diagrams: [{ type: 'ratio', caption: 'Think of the price split into equal parts.' }],
                                answer: { type: 'single', value: [seg.mi('\\pounds 2.04')] },
                                solution: {
                                    guidance: [
                                        [seg.text('Find the discount first, then subtract it from the original price.')]
                                    ],
                                    formulae: [
                                        [seg.mi('\\text{Discount} = \\dfrac{p}{100}\\times \\text{original}')],
                                        [seg.mi('\\text{New price} = \\text{original} - \\text{discount}')]
                                    ],
                                    working: [
                                        workLineMath(String.raw`\begin{aligned}
15\% \text{ of } 2.40 &= 0.15 \times 2.40 = 0.36\\
\text{New price} &= 2.40 - 0.36 = 2.04
\end{aligned}`)
                                    ],
                                    alternative: null
                                }
                            },

                            /* One multi-part question (top-level 6) */
                            {
                                qid: '6',
                                depth: 0,
                                prompt: [],
                                diagrams: [],
                                answer: { type: 'single', value: [seg.text('—')] },
                                solution: { guidance: null, formulae: null, working: [], alternative: null }
                            },
                            {
                                qid: '6(a)',
                                depth: 1,
                                prompt: [
                                    seg.text('Write down the largest of these decimals: '),
                                    seg.mi('0.62\\quad 0.8\\quad 0.75\\quad 0.706'),
                                    seg.text('.')
                                ],
                                diagrams: [],
                                answer: { type: 'single', value: [seg.mi('0.8')] },
                                solution: {
                                    guidance: null,
                                    formulae: null,
                                    working: [
                                        workLineP([seg.mi('0.8'), seg.text(' is the largest.')])
                                    ],
                                    alternative: null
                                }
                            },
                            {
                                qid: '6(b)',
                                depth: 1,
                                prompt: [
                                    seg.text('Find the difference between the largest and smallest. ')
                                ],
                                diagrams: [],
                                answer: { type: 'single', value: [seg.mi('0.18')] },
                                solution: {
                                    guidance: null,
                                    formulae: null,
                                    working: [
                                        workLineMath(String.raw`\begin{aligned}
0.8 - 0.62 &= 0.18
\end{aligned}`)
                                    ],
                                    alternative: null
                                }
                            }
                        ]
                    }]
                };
            }

            function buildStandardPaper(expandAll) {
                const qs = [];

                // 1–10: arithmetic + fractions + small word problems
                qs.push(
                    q('1', 0, [seg.text('Work out '), seg.mi('476 + 289'), seg.text('.')], ansSingle([seg.mi('765')]),
                        sol({ working: [workLineMath(String.raw`\begin{aligned}476 + 289 &= 765\end{aligned}`)] })
                    ),
                    q('2', 0, [seg.text('Work out '), seg.mi('9000 - 4387'), seg.text('.')], ansSingle([seg.mi('4613')]),
                        sol({ working: [workLineMath(String.raw`\begin{aligned}9000 - 4387 &= 4613\end{aligned}`)] })
                    ),
                    q('3', 0, [seg.text('Simplify '), seg.mi('\\dfrac{18}{24}'), seg.text('.')], ansSingle([seg.mi('\\dfrac{3}{4}')]),
                        sol({
                            guidance: [[seg.text('Divide the numerator and denominator by the same number.')]],
                            working: [
                                workLineMath(String.raw`\begin{aligned}
\dfrac{18}{24} &= \dfrac{18 \div 6}{24 \div 6} = \dfrac{3}{4}
\end{aligned}`)
                            ]
                        })
                    ),
                    q('4', 0, [seg.text('A coach travels '), seg.mi('72\\,\\text{km}'), seg.text(' in '), seg.mi('1.5\\,\\text{hours}'), seg.text('. What is the average speed?')],
                        ansSingle([seg.mi('48\\,\\text{km/hour}')]),
                        sol({
                            formulae: [[seg.mi('\\text{Speed} = \\dfrac{\\text{distance}}{\\text{time}}')]],
                            working: [
                                workLineMath(String.raw`\begin{aligned}
\text{Speed} &= \dfrac{72}{1.5} = \dfrac{72}{\tfrac{3}{2}} = 72 \times \dfrac{2}{3} = 48
\end{aligned}`)
                            ],
                            alternative: [
                                workLineP([seg.text('You can also use decimals: '), seg.mi('72 \\div 1.5 = 48'), seg.text('.')])
                            ]
                        })
                    ),
                    q('5', 0, [seg.text('Work out '), seg.mi('20\\%'), seg.text(' of '), seg.mi('360'), seg.text('.')], ansSingle([seg.mi('72')]),
                        sol({
                            guidance: [[seg.text('Convert the percentage to a fraction or decimal, then multiply.')]],
                            formulae: [[seg.mi('p\\% = \\dfrac{p}{100}')]],
                            working: [
                                workLineMath(String.raw`\begin{aligned}
20\% \text{ of } 360 &= 0.2 \times 360 = 72
\end{aligned}`)
                            ]
                        })
                    ),
                    q('6', 0, [seg.text('A rectangle has length '), seg.mi('12\\,\\text{cm}'), seg.text(' and width '), seg.mi('7\\,\\text{cm}'), seg.text('. Find its area.')],
                        ansSingle([seg.mi('84\\,\\text{cm}^2')]),
                        sol({
                            formulae: [[seg.mi('A = \\ell w')]],
                            working: [
                                workLineMath(String.raw`\begin{aligned}
A &= 12 \times 7 = 84\ \text{cm}^2
\end{aligned}`)
                            ]
                        })
                    ),
                    q('7', 0, [seg.text('The diagram shows a right triangle. Find the missing length.')],
                        ansSingle([seg.mi('13')]),
                        sol({
                            guidance: [[seg.text('Use Pythagoras’ theorem for right-angled triangles.')]],
                            formulae: [[seg.mi('a^2 + b^2 = c^2')]],
                            working: [
                                workLineMath(String.raw`\begin{aligned}
5^2 + 12^2 &= c^2\\
25 + 144 &= c^2\\
169 &= c^2\\
c &= 13
\end{aligned}`)
                            ]
                        }),
                        [{ type: 'geometry', caption: 'Right-angled triangle with sides 5 and 12.' }]
                    ),
                    q('8', 0, [seg.text('Work out '), seg.mi('(48 \\div 6) + 3\\times 4'), seg.text('.')], ansSingle([seg.mi('20')]),
                        sol({
                            guidance: [[seg.text('Use BIDMAS: division and multiplication before addition.')]],
                            working: [
                                workLineMath(String.raw`\begin{aligned}
(48 \div 6) + 3\times 4 &= 8 + 12 = 20
\end{aligned}`)
                            ]
                        })
                    ),
                    q('9', 0, [seg.text('A bag contains 3 red, 2 blue and 5 green counters. What fraction are blue?')],
                        ansSingle([seg.mi('\\dfrac{1}{5}')]),
                        sol({
                            working: [
                                workLineMath(String.raw`\begin{aligned}
\text{Total} &= 3 + 2 + 5 = 10\\
\text{Blue fraction} &= \dfrac{2}{10} = \dfrac{1}{5}
\end{aligned}`)
                            ]
                        })
                    ),
                    q('10', 0, [seg.text('Here is a coordinate grid. Write down the coordinates of point P.')],
                        ansSingle([seg.mi('(2,2)')]),
                        sol({
                            working: [workLineP([seg.text('Point P is at '), seg.mi('(2,2)'), seg.text('.')])]
                        }),
                        [{ type: 'grid', caption: 'Coordinate grid with a labelled point.' }]
                    )
                );

                // 11–17: mixed; include multiple answers + alternative
                qs.push(
                    q('11', 0, [seg.text('A number is multiplied by 4 and then 9 is added. The result is 41. Find the number.')],
                        ansSingle([seg.mi('8')]),
                        sol({
                            working: [
                                workLineMath(String.raw`\begin{aligned}
4x + 9 &= 41\\
4x &= 32\\
x &= 8
\end{aligned}`)
                            ]
                        })
                    ),
                    q('12', 0, [seg.text('Write two different fractions that are equal to '), seg.mi('\\dfrac{2}{3}'), seg.text('.')],
                        ansMulti([
                            [seg.mi('\\dfrac{4}{6}')],
                            [seg.mi('\\dfrac{6}{9}')]
                        ]),
                        sol({
                            guidance: [[seg.text('Multiply the numerator and denominator by the same number.')]],
                            working: [
                                workLineMath(String.raw`\begin{aligned}
\dfrac{2}{3} &= \dfrac{2\times 2}{3\times 2} = \dfrac{4}{6}\\
\dfrac{2}{3} &= \dfrac{2\times 3}{3\times 3} = \dfrac{6}{9}
\end{aligned}`)
                            ]
                        })
                    ),
                    q('13', 0, [seg.text('The perimeter of a square is '), seg.mi('64\\,\\text{cm}'), seg.text('. Find the area.')],
                        ansSingle([seg.mi('256\\,\\text{cm}^2')]),
                        sol({
                            formulae: [[seg.mi('P = 4s')], [seg.mi('A = s^2')]],
                            working: [
                                workLineMath(String.raw`\begin{aligned}
4s &= 64 \Rightarrow s = 16\\
A &= 16^2 = 256\ \text{cm}^2
\end{aligned}`)
                            ],
                            alternative: [
                                workLineP([seg.text('Find the side first from the perimeter, then square it.')])
                            ]
                        })
                    ),
                    q('14', 0, [seg.text('A shop reduces a '), seg.mi('\\pounds 30'), seg.text(' coat by '), seg.mi('20\\%'), seg.text('. What is the sale price?')],
                        ansSingle([seg.mi('\\pounds 24')]),
                        sol({
                            guidance: [[seg.text('A 20% reduction means you pay 80% of the original.')]],
                            formulae: [[seg.mi('\\text{New} = (1 - p)\\times \\text{original}')]],
                            working: [
                                workLineMath(String.raw`\begin{aligned}
\text{Sale price} &= 0.8 \times 30 = 24
\end{aligned}`),
                            ],
                            alternative: [
                                workLineMath(String.raw`\begin{aligned}
20\% \text{ of } 30 &= 6\\
30 - 6 &= 24
\end{aligned}`)
                            ]
                        })
                    ),
                    q('15', 0, [seg.text('The table shows how 25 pupils travel to school. What percentage walk?')],
                        ansSingle([seg.mi('28\\%')]),
                        sol({
                            formulae: [[seg.mi('\\text{Percentage} = \\dfrac{\\text{part}}{\\text{whole}}\\times 100\\%')]],
                            working: [
                                workLineMath(String.raw`\begin{aligned}
\text{Walk} &= 7\\
\text{Percentage} &= \dfrac{7}{25}\times 100 = 28\%
\end{aligned}`)
                            ]
                        }),
                        [{ type: 'table', caption: 'A small frequency table (numbers shown in the grid).' }]
                    ),
                    q('16', 0, [seg.text('Solve: '), seg.mi('\\dfrac{x}{3} + 5 = 11')],
                        ansSingle([seg.mi('x = 18')]),
                        sol({
                            guidance: [[seg.text('Undo the +5 first, then multiply by 3.')]],
                            working: [
                                workLineMath(String.raw`\begin{aligned}
\dfrac{x}{3} + 5 &= 11\\
\dfrac{x}{3} &= 6\\
x &= 18
\end{aligned}`)
                            ]
                        })
                    ),
                    q('17', 0, [seg.text('A recipe uses flour and sugar in the ratio '), seg.mi('3:2'), seg.text('. If it uses '), seg.mi('450\\,\\text{g}'), seg.text(' of flour, how much sugar is used?')],
                        ansSingle([seg.mi('300\\,\\text{g}')]),
                        sol({
                            guidance: [[seg.text('Find the value of one part, then scale up.')]],
                            working: [
                                workLineMath(String.raw`\begin{aligned}
3\ \text{parts} &= 450\\
1\ \text{part} &= 150\\
2\ \text{parts} &= 300
\end{aligned}`)
                            ]
                        }),
                        [{ type: 'ratio', caption: 'Ratio bar for 3 parts to 2 parts.' }]
                    )
                );

                // Deep question nesting (Q18)
                qs.push(
                    q('18', 0, [], ansSingle([seg.text('—')]), sol({ working: [] })),
                    q('18(a)', 1, [seg.text('Work out '), seg.mi('2\\dfrac{1}{3} \\div \\dfrac{1}{6}'), seg.text('.')], ansSingle([seg.mi('14')]),
                        sol({
                            guidance: [[seg.text('Dividing by a fraction means multiplying by its reciprocal.')]],
                            formulae: [[seg.mi('a \\div \\dfrac{b}{c} = a \\times \\dfrac{c}{b}')]],
                            working: [
                                workLineMath(String.raw`\begin{aligned}
2\dfrac{1}{3} &= \dfrac{7}{3}\\
\dfrac{7}{3} \div \dfrac{1}{6} &= \dfrac{7}{3}\times 6 = \dfrac{7\times 6}{3} = 14
\end{aligned}`)
                            ]
                        })
                    ),
                    q('18(a)(i)', 2, [seg.text('Now find '), seg.mi('14\\%'), seg.text(' of '), seg.mi('250'), seg.text('.')], ansSingle([seg.mi('35')]),
                        sol({
                            guidance: [[seg.text('Convert the percentage to a decimal, then multiply.')]],
                            working: [
                                workLineMath(String.raw`\begin{aligned}
14\% \text{ of } 250 &= 0.14 \times 250 = 35
\end{aligned}`)
                            ]
                        })
                    ),
                    q('18(a)(ii)', 2, [seg.text('Write '), seg.mi('0.375'), seg.text(' as a fraction in its simplest form.')], ansSingle([seg.mi('\\dfrac{3}{8}')]),
                        sol({
                            working: [
                                workLineMath(String.raw`\begin{aligned}
0.375 &= \dfrac{375}{1000} = \dfrac{3}{8}
\end{aligned}`)
                            ]
                        })
                    ),
                    q('18(b)', 1, [seg.text('A number line has ticks every '), seg.mi('\\dfrac{1}{4}'), seg.text('. What number is halfway between '), seg.mi('2'), seg.text(' and '), seg.mi('3'), seg.text('?')],
                        ansSingle([seg.mi('2.5')]),
                        sol({
                            working: [
                                workLineMath(String.raw`\begin{aligned}
\text{Halfway} &= \dfrac{2 + 3}{2} = 2.5
\end{aligned}`)
                            ]
                        })
                    )
                );

                // 19–25: medium; include at least one with Guidance + Formulae + Alternative
                qs.push(
                    q('19', 0, [seg.text('A train leaves at 13:20 and arrives at 15:05. How long is the journey?')],
                        ansSingle([seg.text('1 hour 45 minutes')]),
                        sol({
                            guidance: [[seg.text('Find the difference between the times using minutes if helpful.')]],
                            working: [
                                workLineMath(String.raw`\begin{aligned}
13{:}20 \to 14{:}20 &= 1\ \text{hour}\\
14{:}20 \to 15{:}05 &= 45\ \text{minutes}\\
\text{Total} &= 1\ \text{hour } 45\ \text{minutes}
\end{aligned}`)
                            ]
                        })
                    ),
                    q('20', 0, [seg.text('The sum of two numbers is '), seg.mi('47'), seg.text(' and their difference is '), seg.mi('9'), seg.text('. Find the two numbers.')],
                        ansMulti([[seg.mi('28')], [seg.mi('19')]]),
                        sol({
                            guidance: [[seg.text('Let the smaller number be x, then the larger is x + 9.')]],
                            working: [
                                workLineMath(String.raw`\begin{aligned}
x + (x + 9) &= 47\\
2x &= 38\\
x &= 19\\
x + 9 &= 28
\end{aligned}`)
                            ]
                        })
                    ),
                    q('21', 0, [seg.text('A book is '), seg.mi('\\pounds 12'), seg.text(' plus '), seg.mi('5\\%'), seg.text(' postage. What is the total cost?')],
                        ansSingle([seg.mi('\\pounds 12.60')]),
                        sol({
                            guidance: [[seg.text('Work out 5% of £12, then add it on.')]],
                            formulae: [[seg.mi('\\text{Percentage} = \\dfrac{\\text{part}}{\\text{whole}}\\times 100\\%')]],
                            working: [
                                workLineMath(String.raw`\begin{aligned}
5\% \text{ of } 12 &= 0.05 \times 12 = 0.6\\
\text{Total} &= 12 + 0.6 = 12.60
\end{aligned}`)
                            ],
                            alternative: [
                                workLineP([seg.text('You can also do '), seg.mi('105\\%'), seg.text(' of '), seg.mi('12'), seg.text(': '), seg.mi('1.05\\times 12 = 12.60'), seg.text('.')])
                            ]
                        })
                    ),
                    q('22', 0, [seg.text('The diagram shows a shape made from equal squares. Which labelled square can be removed without changing the perimeter?')],
                        ansSingle([seg.text('Square E')]),
                        sol({
                            guidance: [[seg.text('Removing an “inside” square does not change the outside edge length.')]],
                            working: [
                                workLineP([seg.text('Square E is inside the outline, so removing it keeps the perimeter the same.')])
                            ]
                        }),
                        [{ type: 'table', caption: 'A tiled shape with labelled squares (placeholder grid).' }]
                    ),
                    q('23', 0, [seg.text('Work out '), seg.mi('(7^2 - 5^2)'), seg.text('.')], ansSingle([seg.mi('24')]),
                        sol({
                            working: [
                                workLineMath(String.raw`\begin{aligned}
7^2 - 5^2 &= 49 - 25 = 24
\end{aligned}`)
                            ]
                        })
                    ),
                    q('24', 0, [seg.text('A rectangle has area '), seg.mi('96\\,\\text{cm}^2'), seg.text(' and one side is '), seg.mi('12\\,\\text{cm}'), seg.text('. Find the other side.')],
                        ansSingle([seg.mi('8\\,\\text{cm}')]),
                        sol({
                            formulae: [[seg.mi('A = \\ell w')]],
                            working: [
                                workLineMath(String.raw`\begin{aligned}
96 &= 12 \times w\\
w &= \dfrac{96}{12} = 8
\end{aligned}`)
                            ]
                        })
                    ),
                    q('25', 0, [seg.text('Write the next term in the sequence: '), seg.mi('4, 9, 16, 25, \\ldots')],
                        ansSingle([seg.mi('36')]),
                        sol({
                            guidance: [[seg.text('These are square numbers.')]],
                            working: [
                                workLineMath(String.raw`\begin{aligned}
4 &= 2^2,\ 9 = 3^2,\ 16 = 4^2,\ 25 = 5^2\\
\text{Next} &= 6^2 = 36
\end{aligned}`)
                            ]
                        })
                    )
                );

                // 26–35 long algebra; include multiple KaTeX blocks and long workings
                for (let n = 26; n <= 35; n++) {
                    const qid = String(n);
                    if (n === 30) {
                        // Deep nesting inside a long question
                        qs.push(
                            q('30', 0, [], ansSingle([seg.text('—')]), sol({ working: [] }))
                        );
                        qs.push(
                            q('30(a)', 1, [seg.text('Solve the simultaneous equations: '), seg.mi('2x + y = 11'), seg.text(' and '), seg.mi('x - y = 1'), seg.text('.')], ansSingle([seg.mi('x=4,\\ y=3')]),
                                sol({
                                    guidance: [[seg.text('Add or subtract the equations to eliminate one variable.')]],
                                    working: [
                                        workLineMath(String.raw`\begin{aligned}
2x + y &= 11\\
x - y &= 1\\[4pt]
(2x + y) + (x - y) &= 11 + 1\\
3x &= 12\\
x &= 4\\
4 - y &= 1\\
y &= 3
\end{aligned}`),
                                    ]
                                })
                            )
                        );
                        qs.push(
                            q('30(a)(i)', 2, [seg.text('Now work out '), seg.mi('3x^2 + y'), seg.text(' using your values of '), seg.mi('x'), seg.text(' and '), seg.mi('y'), seg.text('.')], ansSingle([seg.mi('51')]),
                                sol({
                                    working: [
                                        workLineMath(String.raw`\begin{aligned}
3x^2 + y &= 3(4^2) + 3 = 3(16) + 3 = 51
\end{aligned}`)
                                    ]
                                })
                            )
                        );
                        qs.push(
                            q('30(a)(ii)', 2, [seg.text('Find the value of '), seg.mi('\\dfrac{x}{y}'), seg.text('.')], ansSingle([seg.mi('\\dfrac{4}{3}')]),
                                sol({
                                    working: [
                                        workLineMath(String.raw`\begin{aligned}
\dfrac{x}{y} &= \dfrac{4}{3}
\end{aligned}`)
                                    ]
                                })
                            )
                        );
                        qs.push(
                            q('30(b)', 1, [seg.text('Solve '), seg.mi('x^2 - 7x + 10 = 0'), seg.text('.')], ansMulti([[seg.mi('x=2')], [seg.mi('x=5')]]),
                                sol({
                                    guidance: [[seg.text('Factorise, then set each bracket to zero.')]],
                                    working: [
                                        workLineMath(String.raw`\begin{aligned}
x^2 - 7x + 10 &= (x - 5)(x - 2)\\
x - 5 &= 0 \Rightarrow x = 5\\
x - 2 &= 0 \Rightarrow x = 2
\end{aligned}`)
                                    ],
                                    alternative: [
                                        workLineP([seg.text('You could also use the quadratic formula, but factorising is quickest here.')])
                                    ]
                                })
                            )
                        );
                        continue;
                    }

                    if (n === 33) {
                        qs.push(
                            q(qid, 0,
                                [seg.text('A sequence is defined by '), seg.mi('u_1 = 2'), seg.text(' and '), seg.mi('u_{n+1} = u_n + 3'), seg.text('. Find '), seg.mi('u_{20}'), seg.text(' and show your method.')],
                                ansSingle([seg.mi('u_{20} = 59')]),
                                sol({
                                    guidance: [[seg.text('This is an arithmetic sequence with common difference 3.')]],
                                    formulae: [[seg.mi('u_n = u_1 + (n-1)d')]],
                                    working: [
                                        workLineMath(String.raw`\begin{aligned}
u_{20} &= 2 + (20-1)\cdot 3\\
&= 2 + 57\\
&= 59
\end{aligned}`),
                                        ...longWorkingLines('2') // extremely long workings (55 lines)
                                    ],
                                    alternative: [
                                        workLineP([seg.text('You can also list terms, but the formula is faster for larger '), seg.mi('n'), seg.text('.')])
                                    ]
                                })
                            )
                        );
                        continue;
                    }

                    if (n === 35) {
                        qs.push(
                            q(qid, 0,
                                [seg.text('Solve the inequality '), seg.mi('3(2x - 5) \\le 4x + 7'), seg.text(', and write your answer as a range.')],
                                ansSingle([seg.mi('x \\le 11')]),
                                sol({
                                    guidance: [[seg.text('Expand brackets first, then collect the x terms on one side.')]],
                                    working: [
                                        workLineMath(String.raw`\begin{aligned}
3(2x - 5) &\le 4x + 7\\
6x - 15 &\le 4x + 7\\
2x &\le 22\\
x &\le 11
\end{aligned}`),
                                        workLineMath(String.raw`\text{Range: } (-\infty,\,11]`)
                                    ],
                                    alternative: null
                                })
                            )
                        );
                        continue;
                    }

                    // Generic long algebra questions
                    const longPrompts = {
                        26: [seg.text('Solve: '), seg.mi('\\dfrac{2}{5}x + 3 = 11')],
                        27: [seg.text('A rectangle has perimeter '), seg.mi('54\\,\\text{cm}'), seg.text('. Its length is '), seg.mi('3'), seg.text(' cm more than its width. Find both dimensions.')],
                        28: [seg.text('Expand and simplify: '), seg.mi('(x - 4)(x + 9)')],
                        29: [seg.text('Rearrange to make '), seg.mi('x'), seg.text(' the subject: '), seg.mi('y = 5x - 2')],
                        31: [seg.text('A pattern follows: '), seg.mi('n^2 = (n-2)^2 + 4(n-1)'), seg.text('. Use it to find '), seg.mi('251^2'), seg.text(' given that '), seg.mi('249^2 = 62001'), seg.text('.')],
                        32: [seg.text('How many square numbers are there from '), seg.mi('1'), seg.text(' to '), seg.mi('10000'), seg.text(' inclusive?')],
                        34: [seg.text('A number is split into two parts in the ratio '), seg.mi('5:3'), seg.text('. The total is '), seg.mi('64'), seg.text('. Find the two parts.')]
                    };

                    const longAnswers = {
                        26: ansSingle([seg.mi('x = 20')]),
                        27: ansMulti([[seg.mi('\\text{width }= 12')], [seg.mi('\\text{length }= 15')]]),
                        28: ansSingle([seg.mi('x^2 + 5x - 36')]),
                        29: ansSingle([seg.mi('x = \\dfrac{y+2}{5}')]),
                        31: ansSingle([seg.mi('251^2 = 63001')]),
                        32: ansSingle([seg.mi('100')]),
                        34: ansMulti([[seg.mi('40')], [seg.mi('24')]])
                    };

                    const longSolutions = {
                        26: sol({
                            working: [
                                workLineMath(String.raw`\begin{aligned}
\dfrac{2}{5}x + 3 &= 11\\
\dfrac{2}{5}x &= 8\\
x &= 8 \times \dfrac{5}{2} = 20
\end{aligned}`)
                            ]
                        }),
                        27: sol({
                            guidance: [[seg.text('Let the width be w, then the length is w + 3.')]],
                            formulae: [[seg.mi('P = 2\\ell + 2w')]],
                            working: [
                                workLineMath(String.raw`\begin{aligned}
2(w+3) + 2w &= 54\\
4w + 6 &= 54\\
4w &= 48\\
w &= 12\\
\ell &= 12 + 3 = 15
\end{aligned}`)
                            ]
                        }),
                        28: sol({
                            working: [
                                workLineMath(String.raw`\begin{aligned}
(x - 4)(x + 9) &= x(x+9) - 4(x+9)\\
&= x^2 + 9x - 4x - 36\\
&= x^2 + 5x - 36
\end{aligned}`)
                            ]
                        }),
                        29: sol({
                            guidance: [[seg.text('Undo the -2, then divide by 5.')]],
                            working: [
                                workLineMath(String.raw`\begin{aligned}
y &= 5x - 2\\
y + 2 &= 5x\\
x &= \dfrac{y+2}{5}
\end{aligned}`)
                            ]
                        }),
                        31: sol({
                            guidance: [[seg.text('Use the pattern to move from '), seg.mi('249'), seg.text(' to '), seg.mi('251'), seg.text('.')]],
                            working: [
                                workLineMath(String.raw`\begin{aligned}
251^2 &= (251-2)^2 + 4(251-1)\\
&= 249^2 + 4\cdot 250\\
&= 62001 + 1000\\
&= 63001
\end{aligned}`)
                            ]
                        }),
                        32: sol({
                            working: [
                                workLineMath(String.raw`\begin{aligned}
\sqrt{10000} &= 100
\end{aligned}`),
                                workLineP([seg.text('So there are '), seg.mi('100'), seg.text(' square numbers from 1 to 10000 inclusive.')])
                            ]
                        }),
                        34: sol({
                            guidance: [[seg.text('Add the ratio parts to find the whole number of parts.')]],
                            working: [
                                workLineMath(String.raw`\begin{aligned}
5 + 3 &= 8\ \text{parts}\\
1\ \text{part} &= \dfrac{64}{8} = 8\\
5\ \text{parts} &= 5\times 8 = 40\\
3\ \text{parts} &= 3\times 8 = 24
\end{aligned}`)
                            ],
                            alternative: [
                                workLineP([seg.text('Check: '), seg.mi('40 + 24 = 64'), seg.text('.')])
                            ]
                        })
                    };

                    qs.push(q(qid, 0, longPrompts[n] || [seg.text('Long algebra question.')], longAnswers[n] || ansSingle([seg.text('—')]), longSolutions[n] || sol({ working: [] })));
                }

                // Add a few extra diagrams in the mid-range (not required, but helps stress)
                // Attach diagrams to existing question objects where appropriate.
                attachDiagram(qs, '22', { type: 'table', caption: 'Tiled outline (grid placeholder).' });
                attachDiagram(qs, '24', { type: 'geometry', caption: 'Rectangle dimensions (placeholder).' });

                // Enforce default expansion
                for (const item of qs) item.defaultExpanded = !!expandAll;

                // Ensure Q26–Q35 contain long algebra questions (already)
                return {
                    id: expandAll ? 'standard_expanded' : 'standard',
                    title: expandAll ? 'Standard (Workings Expanded)' : 'Standard paper',
                    sections: [{ label: null, questions: qs }]
                };
            }

            function buildDiagramHeavyPaper() {
                const qs = [];
                const diagMap = {
                    1: 'geometry', 2: 'ratio', 3: 'grid', 4: 'table',
                    6: 'geometry', 8: 'ratio', 11: 'grid', 15: 'table'
                };

                for (let i = 1; i <= 20; i++) {
                    const qid = String(i);
                    const hasDiagram = Object.prototype.hasOwnProperty.call(diagMap, i);
                    const type = diagMap[i];

                    const prompt = (i % 5 === 0)
                        ? [seg.text('Work out '), seg.mi(`(${i + 12})^2 - (${i + 10})^2`), seg.text('.')]
                        : [seg.text('Use the diagram to answer the question.')];

                    const answer = (i % 5 === 0)
                        ? ansSingle([seg.mi(String((i + 12) * (i + 12) - (i + 10) * (i + 10)))])
                        : ansSingle([seg.text('See working.')]);

                    const solution = (i % 5 === 0)
                        ? sol({
                            working: [
                                workLineMath(String.raw`\begin{aligned}
(a^2 - b^2) &= (a-b)(a+b)\\
(${i + 12})^2 - (${i + 10})^2 &= (2)\,(${2 * i + 22}) = ${4 * i + 44}
\end{aligned}`)
                            ],
                            alternative: [
                                workLineMath(String.raw`\begin{aligned}
(${i + 12})^2 &= ${(i + 12) * (i + 12)}\\
(${i + 10})^2 &= ${(i + 10) * (i + 10)}\\
\text{Difference} &= ${((i + 12) * (i + 12)) - ((i + 10) * (i + 10))}
\end{aligned}`)
                            ]
                        })
                        : sol({
                            guidance: [[seg.text('Read values directly from the diagram, then apply one clear step.')]],
                            working: [
                                workLineP([seg.text('Take the required measurement from the diagram, then calculate the result.')]),
                                workLineMath(String.raw`\begin{aligned}
\text{Example step} &= 12 + 8 = 20
\end{aligned}`)
                            ]
                        });

                    const qObj = q(qid, 0, prompt, answer, solution, hasDiagram ? [{ type, caption: 'Diagram placeholder (responsive, grayscale).' }] : []);
                    qs.push(qObj);
                }

                for (const item of qs) item.defaultExpanded = false;

                return {
                    id: 'diagram',
                    title: 'Diagram-heavy paper',
                    sections: [{ label: null, questions: qs }]
                };
            }

            function buildSectionedPaper() {
                const makeSmall = (n) => q(String(n), 0,
                    [seg.text('Work out '), seg.mi(`${n * 7} \\div ${n}`), seg.text('.')],
                    ansSingle([seg.mi(String(7))]),
                    sol({ working: [workLineMath(String.raw`\begin{aligned}${n * 7} \div ${n} &= 7\end{aligned}`)] })
                );

                const sectionA = [];
                for (let i = 1; i <= 35; i++) {
                    if (i === 7) {
                        sectionA.push(
                            q('7', 0, [], ansSingle([seg.text('—')]), sol({ working: [] })),
                            q('7(a)', 1, [seg.text('Multiply '), seg.mi('345'), seg.text(' by '), seg.mi('67'), seg.text('.')], ansSingle([seg.mi('23115')]),
                                sol({
                                    guidance: [[seg.text('Use a written method or split into parts.')]],
                                    working: [
                                        workLineMath(String.raw`\begin{aligned}
345\times 67 &= 345\times (60+7)\\
&= 345\times 60 + 345\times 7\\
&= 20700 + 2415\\
&= 23115
\end{aligned}`)
                                    ]
                                })
                            ),
                            q('7(b)', 1, [seg.text('A number line is marked in quarters. What are the two missing numbers?')], ansMulti([[seg.mi('1.5')], [seg.mi('2.5')]]),
                                sol({
                                    working: [
                                        workLineMath(String.raw`\begin{aligned}
2 - \dfrac{1}{4} - \dfrac{1}{4} &= 1.5\\
2 + \dfrac{1}{4} + \dfrac{1}{4} &= 2.5
\end{aligned}`)
                                    ]
                                }),
                                [{ type: 'grid', caption: 'Number line / grid placeholder.' }]
                            )
                        );
                    } else {
                        sectionA.push(makeSmall(i));
                    }
                }

                const sectionB = [];
                for (let i = 1; i <= 8; i++) {
                    const qid = String(i);
                    sectionB.push(
                        q(qid, 0,
                            [seg.text('A rectangle has area '), seg.mi(`${i * 24}\\,\\text{cm}^2`), seg.text(' and width '), seg.mi(`${i + 3}\\,\\text{cm}`), seg.text('. Find the length.')],
                            ansSingle([seg.mi(`${(i * 24) / (i + 3)}\\,\\text{cm}`)]),
                            sol({
                                formulae: [[seg.mi('A = \\ell w')]],
                                working: [
                                    workLineMath(String.raw`\begin{aligned}
\ell &= \dfrac{${i * 24}}{${i + 3}} = ${(i * 24) / (i + 3)}
\end{aligned}`)
                                ]
                            })
                        )
                    );
                }

                const sectionC = [];
                for (let i = 1; i <= 6; i++) {
                    const qid = String(i);
                    sectionC.push(
                        q(qid, 0,
                            [seg.text('A sequence is defined by '), seg.mi('a_1 = 5'), seg.text(' and '), seg.mi('a_{n+1} = 2a_n + 1'), seg.text('. Find '), seg.mi(`a_${i + 10}`), seg.text(' and show clear steps.')],
                            ansSingle([seg.text('See working.')]),
                            sol({
                                guidance: [[seg.text('Work forwards from the first term, keeping steps clear.')]],
                                formulae: [[seg.mi('a_{n+1} = 2a_n + 1')]],
                                working: [
                                    workLineMath(String.raw`\begin{aligned}
a_1 &= 5\\
a_2 &= 2(5) + 1 = 11\\
a_3 &= 2(11) + 1 = 23\\
a_4 &= 2(23) + 1 = 47\\
\text{Continue the same way...}
\end{aligned}`),
                                    ...longWorkingLines('5')
                                ],
                                alternative: [
                                    workLineP([seg.text('You can also use a calculator to check each step, but keep the written chain clear.')])
                                ]
                            })
                        )
                    );
                }

                // Defaults: all collapsed (per brief), Section C long (still collapsed)
                [...sectionA, ...sectionB, ...sectionC].forEach(q => q.defaultExpanded = false);

                return {
                    id: 'sectioned',
                    title: 'Sectioned paper',
                    sections: [
                        { label: 'A', questions: sectionA },
                        { label: 'B', questions: sectionB },
                        { label: 'C', questions: sectionC }
                    ]
                };
            }

            function q(qid, depth, promptSegments, answerObj, solutionObj, diagrams = []) {
                const o = {
                    qid,
                    depth,
                    prompt: promptSegments,
                    diagrams,
                    answer: answerObj,
                    solution: solutionObj,
                    defaultExpanded: false
                };
                return o;
            }

            function sol({ guidance = null, formulae = null, working = [], alternative = null }) {
                return { guidance, formulae, working, alternative };
            }

            function ansSingle(valueSegments) {
                return { type: 'single', value: valueSegments };
            }

            function ansMulti(itemsSegmentsArray) {
                return { type: 'multi', items: itemsSegmentsArray };
            }

            function attachDiagram(list, qid, diagram) {
                const found = list.find(x => x.qid === qid);
                if (found) found.diagrams = [...(found.diagrams || []), diagram];
            }

            const DATASETS = [
                { id: 'short', label: 'Short paper', build: buildShortPaper },
                { id: 'standard', label: 'Standard paper', build: () => buildStandardPaper(false) },
                { id: 'standard_expanded', label: 'Standard (Workings Expanded)', build: () => buildStandardPaper(true) },
                { id: 'diagram', label: 'Diagram-heavy paper', build: buildDiagramHeavyPaper },
                { id: 'sectioned', label: 'Sectioned paper', build: buildSectionedPaper }
            ];

            const paperSelect = document.getElementById('paperSelect');
            const navDesktop = document.getElementById('navListDesktop');
            const navMobile = document.getElementById('navListMobile');
            const paperMain = document.getElementById('paper');

            const openNavBtn = document.getElementById('openNav');
            const overlay = document.getElementById('navOverlay');
            const closeNavBtn = document.getElementById('closeNav');

            let currentPaper = null;
            let observer = null;
            let activeQid = null;

            function buildSelect() {
                for (const d of DATASETS) {
                    paperSelect.appendChild(el('option', { value: d.id, text: d.label }, []));
                }
                paperSelect.value = 'short';
            }

            function flattenNavItems(paper) {
                // Navigation labels are identifiers only; sections may appear as non-clickable separators.
                const items = [];
                for (const sec of paper.sections) {
                    if (sec.label) items.push({ type: 'sep', label: sec.label });
                    for (const q of sec.questions) {
                        items.push({ type: 'item', qid: q.qid });
                    }
                }
                return items;
            }

            function clearNode(node) {
                while (node.firstChild) node.removeChild(node.firstChild);
            }

            function renderNavigation(items, host, onPick) {
                clearNode(host);

                const ul = el('ul', { class: 'nav-ul' }, []);
                for (const it of items) {
                    if (it.type === 'sep') {
                        ul.appendChild(el('li', { class: 'nav-sep', text: `Section ${it.label}` }, []));
                        continue;
                    }
                    const btn = el('button', {
                        class: 'nav-link',
                        type: 'button',
                        'aria-current': 'false',
                        dataset: { target: it.qid }
                    }, []);
                    btn.appendChild(t(it.qid));
                    btn.addEventListener('click', () => onPick(it.qid));
                    ul.appendChild(el('li', {}, [btn]));
                }
                host.appendChild(ul);
            }

            function renderPaper(paper) {
                clearNode(paperMain);

                for (const sec of paper.sections) {
                    if (sec.label) {
                        paperMain.appendChild(el('div', { class: 'section-header', text: `Section ${sec.label}` }, []));
                    }

                    for (const q of sec.questions) {
                        paperMain.appendChild(renderQuestion(q));
                    }
                }
            }

            function renderQuestion(qObj) {
                const qIdAttr = qObj.qid.replace(/[^\w()\-]/g, '_');
                const wrap = el('article', { class: `question depth-${Math.min(qObj.depth, 3)}`, id: `q-${qIdAttr}`, dataset: { qid: qObj.qid } }, []);

                const row = el('div', { class: 'q-row' }, []);
                const qid = el('div', { class: 'qid', text: qObj.qid }, []);
                const body = el('div', { class: 'q-body' }, []);

                const prompt = el('p', { class: 'q-prompt' }, []);
                if (qObj.prompt && qObj.prompt.length) {
                    renderSegments(prompt, qObj.prompt);
                } else {
                    // No parent-level prompt (stress case): keep structure without adding meaning.
                    // (Empty prompt is allowed per brief.)
                }

                body.appendChild(prompt);

                if (qObj.diagrams && qObj.diagrams.length) {
                    for (const d of qObj.diagrams) {
                        body.appendChild(makeDiagram(d.type, d.caption || null));
                    }
                }

                // Answer
                const ans = el('div', { class: 'answer' }, []);
                if (qObj.answer.type === 'single') {
                    const line = el('div', { class: 'answer-line' }, []);
                    line.appendChild(el('div', { class: 'label', text: 'Answer' }, []));
                    const val = el('div', { class: 'answer-value' }, []);
                    renderSegments(val, qObj.answer.value);
                    line.appendChild(val);
                    ans.appendChild(line);
                } else {
                    const line = el('div', { class: 'answer-line' }, []);
                    line.appendChild(el('div', { class: 'label', text: 'Answer' }, []));
                    const ul = el('ul', { class: 'answer-list' }, []);
                    for (const item of qObj.answer.items) {
                        const li = el('li', {}, []);
                        renderSegments(li, item);
                        ul.appendChild(li);
                    }
                    line.appendChild(ul);
                    ans.appendChild(line);
                }
                body.appendChild(ans);

                // Toggle
                const toggleRow = el('div', { class: 'toggle-row' }, []);
                const toggle = el('button', {
                    class: 'toggle',
                    type: 'button',
                    'aria-expanded': 'false'
                }, []);
                toggle.appendChild(chevron());
                toggle.appendChild(el('span', { text: 'Show working' }, []));
                toggleRow.appendChild(toggle);
                body.appendChild(toggleRow);

                // Solution (collapsed by default, unless dataset variant expands)
                const solWrap = el('div', { class: 'solution-wrap' }, []);
                const sol = el('div', { class: 'solution', 'aria-hidden': 'true' }, []);
                solWrap.appendChild(sol);
                body.appendChild(solWrap);

                // Populate solution blocks in fixed order: Guidance → Formulae used → Working → Alternative working
                const s = qObj.solution || {};
                if (s.guidance && s.guidance.length) {
                    sol.appendChild(renderGuidance(s.guidance));
                }
                if (s.formulae && s.formulae.length) {
                    sol.appendChild(renderFormulae(s.formulae));
                }
                if (s.working && s.working.length) {
                    sol.appendChild(renderWorking('Working', s.working));
                }
                if (s.alternative && s.alternative.length) {
                    sol.appendChild(renderWorking('Alternative working', s.alternative));
                }

                // If there is no solution content, keep it empty but still governed by the toggle (stress case)
                const startExpanded = !!qObj.defaultExpanded;
                setExpanded(toggle, sol, startExpanded);

                toggle.addEventListener('click', () => {
                    const isOpen = toggle.getAttribute('aria-expanded') === 'true';
                    setExpanded(toggle, sol, !isOpen);
                });

                row.appendChild(qid);
                row.appendChild(body);
                wrap.appendChild(row);

                return wrap;
            }

            function chevron() {
                const svg = el('svg', { class: 'chev', viewBox: '0 0 20 20', 'aria-hidden': 'true', focusable: 'false' }, []);
                svg.innerHTML = `<path d="M5.5 7.5L10 12l4.5-4.5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>`;
                return svg;
            }

            function renderGuidance(items) {
                const block = el('section', { class: 'sd-block' }, []);
                block.appendChild(el('h3', { class: 'sd-title', text: 'Guidance' }, []));
                const ul = el('ul', { class: 'sd-ul' }, []);
                for (const liSegs of items) {
                    const li = el('li', {}, []);
                    renderSegments(li, liSegs);
                    ul.appendChild(li);
                }
                block.appendChild(ul);
                return block;
            }

            function renderFormulae(items) {
                const block = el('section', { class: 'sd-block' }, []);
                block.appendChild(el('h3', { class: 'sd-title', text: 'Formulae used' }, []));
                const ul = el('ul', { class: 'sd-ul' }, []);
                for (const liSegs of items) {
                    const li = el('li', {}, []);
                    renderSegments(li, liSegs);
                    ul.appendChild(li);
                }
                block.appendChild(ul);
                return block;
            }

            function renderWorking(title, lines) {
                const block = el('section', { class: 'sd-block' }, []);
                block.appendChild(el('h3', { class: 'sd-title', text: title }, []));
                const work = el('div', { class: 'work' }, []);
                for (const ln of lines) {
                    if (ln.kind === 'p') {
                        const p = el('p', { class: 'sd-text' }, []);
                        renderSegments(p, ln.segments);
                        work.appendChild(p);
                    } else {
                        const div = el('div', { class: 'math-block', dataset: { latex: ln.latex } }, []);
                        div.textContent = `\\[${ln.latex}\\]`;
                        work.appendChild(div);
                    }
                }
                block.appendChild(work);
                return block;
            }

            function setExpanded(btn, panel, expanded) {
                btn.setAttribute('aria-expanded', expanded ? 'true' : 'false');
                btn.lastElementChild.textContent = expanded ? 'Hide working' : 'Show working';

                if (expanded) {
                    panel.classList.add('is-open');
                    panel.setAttribute('aria-hidden', 'false');

                    // animate max-height; keep inline; no forced scrolling
                    panel.style.maxHeight = panel.scrollHeight + 'px';
                    // update after rendering to accommodate KaTeX size changes
                    requestAnimationFrame(() => {
                        panel.style.maxHeight = panel.scrollHeight + 'px';
                    });
                } else {
                    panel.setAttribute('aria-hidden', 'true');
                    panel.style.maxHeight = '0px';
                    panel.classList.remove('is-open');
                }
            }

            function scrollToQid(qid) {
                const id = `q-${qid.replace(/[^\w()\-]/g, '_')}`;
                const elQ = document.getElementById(id);
                if (!elQ) return;

                // Close overlay on mobile when navigating
                if (overlay.getAttribute('aria-hidden') === 'false') closeOverlay();

                elQ.scrollIntoView({ behavior: prefersReduced ? 'auto' : 'smooth', block: 'start' });
            }

            function updateNavCurrent(qid) {
                if (qid === activeQid) return;
                activeQid = qid;

                const updateHost = (host) => {
                    host.querySelectorAll('.nav-link[aria-current="true"]').forEach(b => b.setAttribute('aria-current', 'false'));
                    const btn = host.querySelector(`.nav-link[data-target="${CSS.escape(qid)}"]`);
                    if (btn) btn.setAttribute('aria-current', 'true');
                };

                updateHost(navDesktop);
                updateHost(navMobile);
            }

            function setupObserver() {
                if (observer) observer.disconnect();

                const nodes = Array.from(document.querySelectorAll('[data-qid]'));
                if (!nodes.length) return;

                observer = new IntersectionObserver((entries) => {
                    // Choose the top-most visible question in the viewport
                    const visible = entries.filter(e => e.isIntersecting)
                        .sort((a, b) => a.boundingClientRect.top - b.boundingClientRect.top);
                    if (visible.length) updateNavCurrent(visible[0].target.dataset.qid);
                }, {
                    root: null,
                    threshold: 0.15,
                    rootMargin: '-10% 0px -70% 0px'
                });

                nodes.forEach(n => observer.observe(n));
            }

            function renderMath() {
                const katexLoaded = typeof window.katex !== 'undefined' && window.katex && typeof window.katex.render === 'function';

                const renderOne = (node, displayMode) => {
                    const latex = node.dataset.latex || '';
                    if (!latex) return;
                    if (katexLoaded) {
                        try {
                            window.katex.render(latex, node, {
                                throwOnError: false,
                                displayMode: displayMode
                            });
                        } catch (e) {
                            // graceful fallback: keep the placeholder text
                        }
                    } else {
                        // Keep placeholder text already present
                    }
                };

                document.querySelectorAll('.math-inline[data-latex]').forEach(n => renderOne(n, false));
                document.querySelectorAll('.math-block[data-latex]').forEach(n => renderOne(n, true));

                // If any open solution panels exist, re-measure max-height to avoid clipping after KaTeX renders
                document.querySelectorAll('.solution.is-open').forEach(panel => {
                    panel.style.maxHeight = panel.scrollHeight + 'px';
                });
            }

            function openOverlay() {
                overlay.setAttribute('aria-hidden', 'false');
                document.body.style.overflow = 'hidden';
                closeNavBtn.focus({ preventScroll: true });

                // Basic focus trap
                overlay.addEventListener('keydown', trapTab);
                overlay.addEventListener('click', onOverlayClick);
            }

            function closeOverlay() {
                overlay.setAttribute('aria-hidden', 'true');
                document.body.style.overflow = '';
                overlay.removeEventListener('keydown', trapTab);
                overlay.removeEventListener('click', onOverlayClick);
                openNavBtn.focus({ preventScroll: true });
            }

            function onOverlayClick(e) {
                if (e.target === overlay) closeOverlay();
            }

            function trapTab(e) {
                if (e.key !== 'Tab') return;
                const focusables = overlay.querySelectorAll('button, [href], [tabindex]:not([tabindex="-1"])');
                const list = Array.from(focusables).filter(x => !x.disabled && x.offsetParent !== null);
                if (!list.length) return;
                const first = list[0];
                const last = list[list.length - 1];
                if (e.shiftKey && document.activeElement === first) {
                    e.preventDefault();
                    last.focus();
                } else if (!e.shiftKey && document.activeElement === last) {
                    e.preventDefault();
                    first.focus();
                }
            }

            function applyPaper(datasetId) {
                const ds = DATASETS.find(d => d.id === datasetId) || DATASETS[0];
                currentPaper = ds.build();

                const items = flattenNavItems(currentPaper);

                renderNavigation(items, navDesktop, scrollToQid);
                renderNavigation(items, navMobile, scrollToQid);
                renderPaper(currentPaper);

                // Default active state: first question item
                const firstItem = items.find(i => i.type === 'item');
                if (firstItem) updateNavCurrent(firstItem.qid);

                setupObserver();
                renderMath();
            }

            // Mobile "Jump to" only matters on small screens, but is allowed everywhere.
            openNavBtn.addEventListener('click', () => openOverlay());
            closeNavBtn.addEventListener('click', () => closeOverlay());
            window.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && overlay.getAttribute('aria-hidden') === 'false') closeOverlay();
            });

            paperSelect.addEventListener('change', () => {
                applyPaper(paperSelect.value);
            });

            // Build helpers used above
            function ansSingle(value) { return { type: 'single', value }; }
            function ansMulti(items) { return { type: 'multi', items }; }
            function sol({ guidance = null, formulae = null, working = [], alternative = null }) { return { guidance, formulae, working, alternative }; }

            // Patch: q constructor used in short builder relies on these
            function q(qid, depth, prompt, answer, solution, diagrams = []) {
                return { qid, depth, prompt, answer, solution, diagrams, defaultExpanded: false };
            }

            function attachDiagram(list, qid, diagram) {
                const found = list.find(x => x.qid === qid);
                if (found) found.diagrams = [...(found.diagrams || []), diagram];
            }

            // Populate selector + initial render
            buildSelect();
            applyPaper(paperSelect.value);

            // Render KaTeX again after it loads (if it loads after initial paint)
            window.addEventListener('load', () => {
                renderMath();
            });
        })();
    </script>
</body>

</html>