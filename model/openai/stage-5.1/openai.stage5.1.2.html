<!doctype html>
<html lang="en-GB">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>RTQ – Maths Paper Solution Viewer (Stress Test)</title>

    <!-- Real KaTeX Rendering add-on (graceful fallback handled in JS) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js" crossorigin="anonymous"></script>

    <style>
        :root {
            --bg: #f5f5f5;
            --surface: #ffffff;
            --ink: #111111;
            --muted: #5b5b5b;
            --quiet: #777777;
            --hairline: #d7d7d7;
            --hairline2: #ececec;

            --frame-max: 1140px;
            --gutter: 18px;

            --nav-w: 112px;
            --rhythm-q: 28px;
            --rhythm-a: 10px;
            --rhythm-sol: 10px;
            --indent-1: 20px;
            --indent-2: 36px;

            --fs-base: 16px;
            --lh-q: 1.55;
            --lh-body: 1.45;
            --lh-sol: 1.38;

            --tap: 44px;
            --radius: 10px;
        }

        * {
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
        }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--ink);
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
            font-size: var(--fs-base);
            line-height: var(--lh-body);
            overflow-x: hidden;
            /* page-level horizontal scrolling must never occur */
        }

        a {
            color: inherit;
        }

        /* Top controls aligned with the same centered frame */
        header {
            padding: 14px 0;
        }

        .frame {
            width: min(var(--frame-max), calc(100% - (var(--gutter) * 2)));
            margin: 0 auto;
            background: var(--surface);
            border: 1px solid var(--hairline);
            border-radius: var(--radius);
        }

        .topbar {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 12px 14px;
            border-bottom: 1px solid var(--hairline2);
        }

        .topbar .label {
            display: flex;
            align-items: center;
            gap: 10px;
            min-height: var(--tap);
            color: var(--muted);
            font-size: 14px;
            letter-spacing: 0.2px;
        }

        .topbar select {
            appearance: none;
            border: 1px solid var(--hairline);
            border-radius: 8px;
            padding: 10px 12px;
            background: #fff;
            color: var(--ink);
            font-size: 14px;
            min-height: var(--tap);
        }

        .topbar .hint {
            color: var(--quiet);
            font-size: 13px;
            line-height: 1.3;
            margin-left: auto;
            max-width: 520px;
        }

        /* Layout: nav + paper as sibling columns inside a single centered frame */
        .shell {
            display: grid;
            grid-template-columns: var(--nav-w) 1fr;
            gap: 24px;
            padding: 16px 14px 18px 14px;
        }

        nav[aria-label="Questions"] {
            color: var(--quiet);
            font-size: 13px;
            line-height: 1.35;
        }

        .nav-sticky {
            position: sticky;
            top: 14px;
            align-self: start;
            max-height: calc(100vh - 28px);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .nav-title {
            font-size: 12px;
            color: var(--quiet);
            letter-spacing: 0.24px;
            text-transform: none;
            margin: 0 0 2px 0;
            user-select: none;
        }

        .nav-list {
            overflow-y: auto;
            padding: 2px 0;
            /* Scrollable Navigation Without Visible Scrollbars */
            scrollbar-width: none;
            -ms-overflow-style: none;
            outline: none;
        }

        .nav-list::-webkit-scrollbar {
            display: none;
        }

        .nav-sep {
            padding: 8px 0 6px 0;
            font-weight: 600;
            color: #666;
            user-select: none;
        }

        .nav-item {
            display: block;
            width: 100%;
            text-align: left;
            padding: 10px 8px;
            min-height: 38px;
            border: 0;
            background: transparent;
            color: #6e6e6e;
            cursor: pointer;
            border-radius: 8px;
            font: inherit;
        }

        .nav-item:hover {
            background: #f3f3f3;
            color: #333;
        }

        .nav-item[aria-current="true"] {
            color: #111;
            font-weight: 700;
            /* allowed for current nav item */
            background: #efefef;
        }

        main {
            min-width: 0;
            /* allow KaTeX overflow inside containers without widening layout */
        }

        .paper-title {
            margin: 2px 0 18px 0;
            font-size: 16px;
            color: #3e3e3e;
            font-weight: 600;
            letter-spacing: 0.1px;
        }

        /* Question rhythm: separation by spacing, not containers */
        .q {
            margin: 0 0 var(--rhythm-q) 0;
            padding: 0;
        }

        .q.depth-0 {
            margin-bottom: var(--rhythm-q);
        }

        .q.depth-1 {
            margin-bottom: 18px;
        }

        .q.depth-2 {
            margin-bottom: 12px;
        }

        .q-inner {
            padding-left: 0;
        }

        .q.depth-1 .q-inner {
            padding-left: var(--indent-1);
        }

        .q.depth-2 .q-inner {
            padding-left: var(--indent-2);
        }

        .q-head {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 10px;
            align-items: baseline;
        }

        .qid {
            color: #3f3f3f;
            font-size: 14px;
            line-height: var(--lh-q);
            font-weight: 600;
            white-space: nowrap;
        }

        .qtext {
            font-size: 16px;
            line-height: var(--lh-q);
            color: #111;
        }

        .qmeta {
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .answer {
            display: grid;
            grid-template-columns: 90px 1fr;
            gap: 10px;
            align-items: start;
            margin-top: var(--rhythm-a);
            color: #222;
        }

        .answer .alabel {
            font-size: 13px;
            color: #4b4b4b;
            font-weight: 600;
            letter-spacing: 0.2px;
        }

        .answer .avalue {
            font-size: 15px;
            color: #111;
        }

        /* Disclosure control: text-first, comfortable touch target */
        .toggle-row {
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toggle-working {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            border: 0;
            background: transparent;
            color: #3a3a3a;
            padding: 10px 0;
            min-height: var(--tap);
            cursor: pointer;
            font-size: 14px;
        }

        .toggle-working:hover {
            color: #111;
        }

        .chev {
            width: 14px;
            height: 14px;
            flex: 0 0 14px;
            display: inline-block;
        }

        .chev svg {
            display: block;
            width: 14px;
            height: 14px;
        }

        .toggle-working[aria-expanded="true"] .chev {
            transform: rotate(180deg);
        }

        .toggle-working:focus-visible,
        .nav-item:focus-visible,
        .drawer-close:focus-visible,
        #navToggle:focus-visible,
        select:focus-visible {
            outline: 2px solid #9b9b9b;
            outline-offset: 3px;
            border-radius: 10px;
        }

        /* Solution Details */
        .soln {
            margin-top: var(--rhythm-sol);
            color: #2d2d2d;
        }

        .soln-block {
            margin-top: 10px;
        }

        .soln-title {
            font-size: 13px;
            color: #4b4b4b;
            font-weight: 600;
            margin: 0 0 6px 0;
        }

        .soln-body {
            font-size: 14px;
            line-height: var(--lh-sol);
            color: #2b2b2b;
        }

        .soln-body p {
            margin: 0 0 8px 0;
        }

        .soln-body ul {
            margin: 0 0 8px 18px;
            padding: 0;
        }

        .soln-body li {
            margin: 4px 0;
        }

        /* Diagrams: inline SVG placeholders (responsive, grayscale) */
        .diagram {
            margin-top: 10px;
            width: 100%;
            max-width: 560px;
        }

        .diagram svg {
            width: 100%;
            height: auto;
            display: block;
        }

        .diagram .cap {
            margin-top: 6px;
            font-size: 12px;
            color: #6a6a6a;
        }

        /* KaTeX containment invariant */
        .math-inline {
            white-space: nowrap;
        }

        .math-inline.fallback,
        .math-block.fallback {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            color: #1a1a1a;
            font-size: 0.95em;
        }

        .math-block {
            max-width: 100%;
            overflow-x: auto;
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
            padding: 6px 0;
            margin: 6px 0;
        }

        .math-block>* {
            max-width: 100%;
        }

        /* KaTeX display must not widen the page; allow horizontal scrolling only inside the math block */
        .math-block .katex-display {
            margin: 0;
            /* keep calm rhythm */
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
        }

        .math-block .katex,
        .math-block .katex-display,
        .math-block .katex-html {
            max-width: 100%;
        }

        /* Mobile ergonomics */
        #navToggle {
            display: none;
            /* shown on small screens */
            margin-left: auto;
            border: 1px solid var(--hairline);
            background: #fff;
            color: #222;
            border-radius: 999px;
            padding: 10px 12px;
            min-height: var(--tap);
            cursor: pointer;
            font-size: 14px;
        }

        /* Drawer overlay for mobile/tablet */
        .drawer-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.35);
            display: flex;
            align-items: stretch;
            justify-content: flex-end;
            z-index: 50;
        }

        .drawer {
            width: min(340px, 92vw);
            background: var(--surface);
            border-left: 1px solid var(--hairline);
            display: flex;
            flex-direction: column;
            padding: 12px;
        }

        .drawer-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            padding: 6px 4px 10px 4px;
            border-bottom: 1px solid var(--hairline2);
        }

        .drawer-title {
            font-size: 13px;
            color: #4b4b4b;
            font-weight: 600;
            margin: 0;
        }

        .drawer-close {
            border: 1px solid var(--hairline);
            background: #fff;
            color: #222;
            border-radius: 10px;
            padding: 10px 12px;
            min-height: var(--tap);
            cursor: pointer;
            font-size: 14px;
        }

        .drawer .nav-list {
            padding: 8px 2px 2px 2px;
            flex: 1;
        }

        /* Responsive: collapse nav rail into drawer */
        @media (max-width: 860px) {
            .shell {
                grid-template-columns: 1fr;
                gap: 0;
                padding: 14px;
            }

            nav[aria-label="Questions"] {
                display: none;
            }

            #navToggle {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
            }

            .topbar .hint {
                display: none;
            }

            .answer {
                grid-template-columns: 78px 1fr;
            }

            .diagram {
                max-width: 100%;
            }
        }
    </style>
</head>

<body>
    <header>
        <div class="frame" id="frame">
            <div class="topbar">
                <div class="label">
                    <span>Paper</span>
                    <select id="paperSelect" aria-label="Paper selector">
                        <option value="short">Short paper</option>
                        <option value="standard">Standard paper</option>
                        <option value="standardExpanded">Standard (Workings Expanded)</option>
                        <option value="diagram">Diagram-heavy paper</option>
                        <option value="sectioned">Sectioned paper</option>
                    </select>
                </div>

                <button id="navToggle" type="button" aria-haspopup="dialog" aria-controls="drawerOverlay">
                    Jump to
                    <span class="chev" aria-hidden="true">
                        <svg viewBox="0 0 20 20" fill="none">
                            <path d="M5 7.5L10 12.5L15 7.5" stroke="#444" stroke-width="1.8" stroke-linecap="round"
                                stroke-linejoin="round" />
                        </svg>
                    </span>
                </button>

                <div class="hint" aria-hidden="true">
                    Answers are shown by default. Workings start collapsed (except the expanded stress-test dataset).
                </div>
            </div>

            <div class="shell">
                <nav aria-label="Questions">
                    <div class="nav-sticky">
                        <div class="nav-title">Questions</div>
                        <div class="nav-list" id="navList" tabindex="0"></div>
                    </div>
                </nav>

                <main id="paper" aria-label="Paper content">
                    <!-- Rendered by JS -->
                </main>
            </div>
        </div>
    </header>

    <!-- Mobile/Tablet drawer -->
    <div id="drawerOverlay" class="drawer-overlay" hidden>
        <div class="drawer" role="dialog" aria-modal="true" aria-label="Jump to question">
            <div class="drawer-head">
                <p class="drawer-title">Questions</p>
                <button class="drawer-close" id="drawerClose" type="button">Close</button>
            </div>
            <div class="nav-list" id="drawerNav" tabindex="0"></div>
        </div>
    </div>

    <script>
        // ---------- SVG diagram placeholders (reused types) ----------
        function svgGeometry() {
            return `
        <div class="diagram" aria-label="Diagram">
          <svg viewBox="0 0 560 280" role="img" aria-label="Geometry diagram">
            <rect x="12" y="12" width="536" height="256" fill="none" stroke="#cfcfcf"/>
            <circle cx="150" cy="155" r="74" fill="none" stroke="#2a2a2a" stroke-width="2"/>
            <path d="M325 215 L430 70 L515 215 Z" fill="none" stroke="#2a2a2a" stroke-width="2"/>
            <text x="120" y="160" font-size="16" fill="#222">r</text>
            <text x="420" y="62" font-size="16" fill="#222">A</text>
            <text x="318" y="235" font-size="16" fill="#222">B</text>
            <text x="520" y="235" font-size="16" fill="#222">C</text>
            <path d="M430 70 L430 215" stroke="#9a9a9a" stroke-dasharray="5 5"/>
            <text x="438" y="150" font-size="14" fill="#555">h</text>
          </svg>
          <div class="cap">Diagram (not to scale)</div>
        </div>
      `;
        }

        function svgRatioBars() {
            return `
        <div class="diagram" aria-label="Diagram">
          <svg viewBox="0 0 560 220" role="img" aria-label="Ratio bars diagram">
            <rect x="12" y="12" width="536" height="196" fill="none" stroke="#cfcfcf"/>
            <text x="22" y="44" font-size="14" fill="#444">Orange</text>
            <rect x="120" y="28" width="390" height="26" fill="none" stroke="#2a2a2a" stroke-width="2"/>
            <line x1="250" y1="28" x2="250" y2="54" stroke="#2a2a2a" stroke-width="2"/>
            <line x1="380" y1="28" x2="380" y2="54" stroke="#2a2a2a" stroke-width="2"/>

            <text x="22" y="104" font-size="14" fill="#444">Water</text>
            <rect x="120" y="88" width="390" height="26" fill="none" stroke="#2a2a2a" stroke-width="2"/>
            <line x1="315" y1="88" x2="315" y2="114" stroke="#2a2a2a" stroke-width="2"/>

            <text x="22" y="164" font-size="14" fill="#444">Total</text>
            <rect x="120" y="148" width="390" height="26" fill="none" stroke="#2a2a2a" stroke-width="2"/>

            <text x="120" y="198" font-size="12" fill="#666">equal-width parts shown by dividers</text>
          </svg>
          <div class="cap">Ratio bars</div>
        </div>
      `;
        }

        function svgCoordGrid() {
            return `
        <div class="diagram" aria-label="Diagram">
          <svg viewBox="0 0 560 280" role="img" aria-label="Coordinate grid diagram">
            <rect x="12" y="12" width="536" height="256" fill="none" stroke="#cfcfcf"/>
            <g transform="translate(70,30)">
              <rect x="0" y="0" width="440" height="210" fill="none" stroke="#2a2a2a" stroke-width="2"/>
              ${Array.from({ length: 10 }).map((_, i) => `<line x1="${44 * i}" y1="0" x2="${44 * i}" y2="210" stroke="#e1e1e1"/>`).join("")}
              ${Array.from({ length: 6 }).map((_, i) => `<line x1="0" y1="${42 * i}" x2="440" y2="${42 * i}" stroke="#e1e1e1"/>`).join("")}
              <line x1="0" y1="210" x2="440" y2="210" stroke="#2a2a2a" stroke-width="2"/>
              <line x1="0" y1="0" x2="0" y2="210" stroke="#2a2a2a" stroke-width="2"/>
              <circle cx="88" cy="168" r="5" fill="#2a2a2a"/>
              <circle cx="308" cy="84" r="5" fill="#2a2a2a"/>
              <path d="M88 168 L308 84" stroke="#2a2a2a" stroke-width="2"/>
              <text x="98" y="188" font-size="12" fill="#444">(2,1)</text>
              <text x="318" y="104" font-size="12" fill="#444">(7,3)</text>
            </g>
          </svg>
          <div class="cap">Coordinate grid</div>
        </div>
      `;
        }

        function svgTableGrid() {
            return `
        <div class="diagram" aria-label="Diagram">
          <svg viewBox="0 0 560 220" role="img" aria-label="Table grid diagram">
            <rect x="12" y="12" width="536" height="196" fill="none" stroke="#cfcfcf"/>
            <g transform="translate(80,40)">
              <rect x="0" y="0" width="400" height="140" fill="none" stroke="#2a2a2a" stroke-width="2"/>
              ${[1, 2, 3, 4].map(i => `<line x1="${80 * i}" y1="0" x2="${80 * i}" y2="140" stroke="#2a2a2a" stroke-width="2"/>`).join("")}
              ${[1, 2].map(i => `<line x1="0" y1="${46.666 * i}" x2="400" y2="${46.666 * i}" stroke="#2a2a2a" stroke-width="2"/>`).join("")}
              <text x="10" y="30" font-size="14" fill="#444">A</text>
              <text x="90" y="30" font-size="14" fill="#444">B</text>
              <text x="170" y="30" font-size="14" fill="#444">C</text>
              <text x="250" y="30" font-size="14" fill="#444">D</text>
              <text x="330" y="30" font-size="14" fill="#444">E</text>
              <text x="10" y="78" font-size="12" fill="#666">…</text>
              <text x="10" y="124" font-size="12" fill="#666">…</text>
            </g>
          </svg>
          <div class="cap">Table / grid</div>
        </div>
      `;
        }

        const DIAGRAMS = {
            geometry: svgGeometry,
            ratio: svgRatioBars,
            grid: svgCoordGrid,
            table: svgTableGrid
        };

        // ---------- KaTeX helpers ----------
        function texInline(tex) { return { type: "tex-inline", tex }; }
        function texBlock(tex) { return { type: "tex-block", tex }; }
        function para(text) { return { type: "p", text }; }
        function bullets(items) { return { type: "ul", items }; }

        function renderMathNode(node, displayMode) {
            if (window.katex && typeof window.katex.render === "function") {
                try {
                    window.katex.render(node.getAttribute("data-tex"), node, {
                        displayMode,
                        throwOnError: false,
                        strict: "ignore",
                        trust: true
                    });
                    node.classList.remove("fallback");
                    return;
                } catch (e) { }
            }
            // Fallback: show plain TeX, do not hide content
            node.classList.add("fallback");
            const tex = node.getAttribute("data-tex") || "";
            node.textContent = displayMode ? ("[KaTeX block] " + tex) : ("[KaTeX inline] " + tex);
        }

        function renderAllMath(root) {
            root.querySelectorAll(".math-inline[data-tex]").forEach(el => renderMathNode(el, false));
            root.querySelectorAll(".math-block[data-tex]").forEach(el => renderMathNode(el, true));
        }

        // ---------- Content generation ----------
        function sanitizeAnchor(label) {
            return "q_" + label
                .replace(/\s+/g, "")
                .replace(/[()]/g, m => (m === "(" ? "_a_" : "_"))
                .replace(/[^a-zA-Z0-9_]+/g, "_")
                .replace(/_+/g, "_")
                .replace(/_$/, "")
                .toLowerCase();
        }

        function makeWorkingLinesShort() {
            return [
                para("Start by writing an equation that matches the information."),
                texBlock(String.raw`\begin{aligned}
\text{Let the number be } x \\
x + 18 &= 57 \\
x &= 57 - 18 \\
x &= 39
\end{aligned}`)
            ];
        }

        function longAlgebraWorking(seedLabel) {
            // Extremely Long Workings add-on: 50–60 lines
            const lines = [];
            lines.push(para("Work carefully, keeping each step on its own line."));
            const n = 56;
            for (let i = 1; i <= n; i++) {
                const a = 2 + (i % 7);
                const b = 3 + (i % 5);
                const c = 10 + (i % 9);
                lines.push(texBlock(String.raw`\begin{aligned}
\text{Step ${i}:}\quad ${a}x ${i % 2 === 0 ? "+" : "-"} ${c} &= ${b}x + ${c + 12} \\
${a}x - ${b}x &= ${c + 12} ${i % 2 === 0 ? "-" : "+"} ${c} \\
(${a - b})x &= ${i % 2 === 0 ? 12 : (24)} \\
x &= \dfrac{${i % 2 === 0 ? 12 : 24}}{${a - b}}
\end{aligned}`));
                if (i % 8 === 0) {
                    lines.push(para("Check by substituting back into the original equation."));
                    lines.push(texBlock(String.raw`\begin{aligned}
\text{Check: } ${a}\left(\dfrac{${i % 2 === 0 ? 12 : 24}}{${a - b}}\right) ${i % 2 === 0 ? "+" : "-"} ${c}
&= ${b}\left(\dfrac{${i % 2 === 0 ? 12 : 24}}{${a - b}}\right) + ${c + 12}
\end{aligned}`));
                }
            }
            lines.unshift(para(`This working is intentionally long to stress-test scrolling and expansion (${seedLabel}).`));
            return lines;
        }

        function makeQuestion({ label, depth = 0, prompt, diagrams = [], answer, soln, defaultExpanded = false }) {
            const anchor = sanitizeAnchor(label);
            return {
                label,
                anchor,
                depth,
                prompt,
                diagrams,
                answer,
                soln,
                defaultExpanded
            };
        }

        function solnPack({ keepInMind = [], formulas = [], working = [], alternative = [] }) {
            return { keepInMind, formulas, working, alternative };
        }

        // ---------- Datasets ----------
        function buildShortPaper() {
            const qs = [];
            qs.push(makeQuestion({
                label: "1",
                prompt: [
                    para("Write the value of"),
                    para(`(a) ${""} `),
                    texInline(String.raw`7.2 + 3.8`),
                    para(", then write the value of"),
                    texInline(String.raw`6 \times 15`),
                    para(".")
                ],
                answer: [texInline(String.raw`11`), para("and"), texInline(String.raw`90`)],
                soln: solnPack({
                    working: [
                        texBlock(String.raw`\begin{aligned}
7.2 + 3.8 &= 11.0 \\
6 \times 15 &= 6 \times (10+5) \\
&= 60 + 30 \\
&= 90
\end{aligned}`)
                    ]
                })
            }));

            qs.push(makeQuestion({
                label: "2",
                prompt: [
                    para("A bottle contains"),
                    texInline(String.raw`750\,\text{ml}`),
                    para("of juice. You pour out"),
                    texInline(String.raw`2/5`),
                    para("of it. How much juice is poured out?")
                ],
                answer: [texInline(String.raw`300\,\text{ml}`)],
                diagrams: ["ratio"],
                soln: solnPack({
                    keepInMind: [
                        para("Find the fraction of the whole, then convert to millilitres.")
                    ],
                    formulas: [
                        para("Fraction of an amount:"),
                        texInline(String.raw`\text{part}=\text{fraction}\times\text{whole}`)
                    ],
                    working: [
                        texBlock(String.raw`\begin{aligned}
\text{Poured out} &= \dfrac{2}{5}\times 750 \\
&= 2\times 150 \\
&= 300
\end{aligned}`)
                    ]
                })
            }));

            qs.push(makeQuestion({
                label: "3",
                prompt: [
                    para("The perimeter of a square is"),
                    texInline(String.raw`48\,\text{cm}`),
                    para(". What is the length of one side?")
                ],
                answer: [texInline(String.raw`12\,\text{cm}`)],
                soln: solnPack({
                    formulas: [
                        para("Perimeter of a square:"),
                        texInline(String.raw`P = 4s`)
                    ],
                    working: [
                        texBlock(String.raw`\begin{aligned}
4s &= 48 \\
s &= 12
\end{aligned}`)
                    ],
                    alternative: [
                        para("A square has 4 equal sides, so divide by 4:"),
                        texBlock(String.raw`48 \div 4 = 12`)
                    ]
                })
            }));

            qs.push(makeQuestion({
                label: "4",
                prompt: [
                    para("A shop reduces a"),
                    texInline(String.raw`£40`),
                    para("item by"),
                    texInline(String.raw`15\%`),
                    para(". What is the sale price?")
                ],
                answer: [texInline(String.raw`£34`)],
                soln: solnPack({
                    keepInMind: [
                        para("A reduction means you keep the rest of the price.")
                    ],
                    formulas: [
                        para("Percentage change:"),
                        texInline(String.raw`\text{new}=\text{original}\times(1-\text{discount})`)
                    ],
                    working: [
                        texBlock(String.raw`\begin{aligned}
\text{Sale price} &= 40 \times (1 - 0.15) \\
&= 40 \times 0.85 \\
&= 34
\end{aligned}`)
                    ]
                })
            }));

            qs.push(makeQuestion({
                label: "5",
                prompt: [
                    para("Simplify the fraction"),
                    texInline(String.raw`\dfrac{84}{126}`),
                    para(".")
                ],
                answer: [texInline(String.raw`\dfrac{2}{3}`)],
                soln: solnPack({
                    working: [
                        texBlock(String.raw`\begin{aligned}
\dfrac{84}{126} &= \dfrac{84 \div 42}{126 \div 42} \\
&= \dfrac{2}{3}
\end{aligned}`)
                    ],
                    alternative: [
                        para("You can also divide top and bottom by 6 first, then again by 7.")
                    ]
                })
            }));

            // One multi-part question (still 6 questions total)
            qs.push(makeQuestion({
                label: "6",
                prompt: [
                    para("A bus leaves at"),
                    texInline(String.raw`09{:}35`),
                    para("and the journey takes"),
                    texInline(String.raw`1\,\text{hour } 48\,\text{minutes}`),
                    para(".")
                ],
                answer: [para("See parts (a)–(c).")],
                soln: solnPack({
                    working: [para("Answer each part using the information given.")]
                })
            }));

            qs.push(makeQuestion({
                label: "6a",
                depth: 1,
                prompt: [para("What time does the bus arrive?")],
                answer: [texInline(String.raw`11{:}23`)],
                soln: solnPack({
                    keepInMind: [para("Add hours first, then minutes.")],
                    working: [
                        texBlock(String.raw`\begin{aligned}
09{:}35 + 1\,\text{hour} &= 10{:}35 \\
10{:}35 + 48\,\text{min} &= 11{:}23
\end{aligned}`)
                    ]
                })
            }));

            qs.push(makeQuestion({
                label: "6b",
                depth: 1,
                prompt: [para("If the bus is delayed by"), texInline(String.raw`12\,\text{minutes}`), para(", what is the new arrival time?")],
                answer: [texInline(String.raw`11{:}35`)],
                soln: solnPack({
                    working: [
                        texBlock(String.raw`\begin{aligned}
11{:}23 + 12\,\text{min} &= 11{:}35
\end{aligned}`)
                    ]
                })
            }));

            qs.push(makeQuestion({
                label: "6c",
                depth: 1,
                prompt: [para("The ticket costs"), texInline(String.raw`£7.80`), para(". You pay with"), texInline(String.raw`£10`), para(". How much change do you get?")],
                answer: [texInline(String.raw`£2.20`)],
                soln: solnPack({
                    working: [
                        texBlock(String.raw`\begin{aligned}
10.00 - 7.80 &= 2.20
\end{aligned}`)
                    ]
                })
            }));

            return { id: "short", title: "Short paper", workingsExpandedDefault: false, questions: qs, sections: null };
        }

        function buildStandardPaper({ expandedVariant = false }) {
            const qs = [];
            // Q1–Q10: short/medium mix
            qs.push(makeQuestion({
                label: "1",
                prompt: [para("Calculate"), texInline(String.raw`480 \div 12`), para(".")],
                answer: [texInline(String.raw`40`)],
                soln: solnPack({
                    working: [texBlock(String.raw`\begin{aligned}
480 \div 12 &= 48 \div 1.2 \\
&= 40
\end{aligned}`)]
                }),
                defaultExpanded: expandedVariant
            }));

            qs.push(makeQuestion({
                label: "2",
                prompt: [para("A rectangle has length"), texInline(String.raw`14\,\text{cm}`), para("and width"), texInline(String.raw`9\,\text{cm}`), para(". Find its area.")],
                answer: [texInline(String.raw`126\,\text{cm}^2`)],
                soln: solnPack({
                    formulas: [para("Area of a rectangle:"), texInline(String.raw`A = lw`)],
                    working: [texBlock(String.raw`\begin{aligned}
A &= 14 \times 9 \\
&= 126
\end{aligned}`)]
                }),
                defaultExpanded: expandedVariant
            }));

            qs.push(makeQuestion({
                label: "3",
                prompt: [para("Write"), texInline(String.raw`0.375`), para("as a fraction in its simplest form.")],
                answer: [texInline(String.raw`\dfrac{3}{8}`)],
                soln: solnPack({
                    working: [
                        texBlock(String.raw`\begin{aligned}
0.375 &= \dfrac{375}{1000} \\
&= \dfrac{375 \div 125}{1000 \div 125} \\
&= \dfrac{3}{8}
\end{aligned}`)
                    ]
                }),
                defaultExpanded: expandedVariant
            }));

            qs.push(makeQuestion({
                label: "4",
                prompt: [para("A bag contains red and blue counters in the ratio"), texInline(String.raw`3:5`), para(". There are"), texInline(String.raw`24`), para("red counters. How many blue counters are there?")],
                answer: [texInline(String.raw`40`)],
                diagrams: ["ratio"],
                soln: solnPack({
                    keepInMind: [para("If 3 parts = 24, then 1 part = 8.")],
                    working: [
                        texBlock(String.raw`\begin{aligned}
3\text{ parts} &= 24 \\
1\text{ part} &= 24 \div 3 = 8 \\
5\text{ parts} &= 5 \times 8 = 40
\end{aligned}`)
                    ]
                }),
                defaultExpanded: expandedVariant
            }));

            qs.push(makeQuestion({
                label: "5",
                prompt: [para("Solve"), texInline(String.raw`5x - 7 = 28`), para(".")],
                answer: [texInline(String.raw`x=7`)],
                soln: solnPack({
                    working: [
                        texBlock(String.raw`\begin{aligned}
5x - 7 &= 28 \\
5x &= 35 \\
x &= 7
\end{aligned}`)
                    ]
                }),
                defaultExpanded: expandedVariant
            }));

            // Ensure Solution Details Coverage Stress Test: Keep in mind, Formulas used, Alternative working, and all three together somewhere
            qs.push(makeQuestion({
                label: "6",
                prompt: [para("A recipe uses flour and sugar in the ratio"), texInline(String.raw`4:1`), para(". You have"), texInline(String.raw`600\,\text{g}`), para("of flour. How much sugar is needed?")],
                answer: [texInline(String.raw`150\,\text{g}`)],
                soln: solnPack({
                    keepInMind: [para("Keep the ratio parts consistent: 4 parts of flour matches the amount you have.")],
                    working: [
                        texBlock(String.raw`\begin{aligned}
4\text{ parts} &= 600 \\
1\text{ part} &= 600 \div 4 = 150
\end{aligned}`)
                    ]
                }),
                defaultExpanded: expandedVariant
            }));

            qs.push(makeQuestion({
                label: "7",
                prompt: [para("Find the mean of"), texInline(String.raw`6, 9, 11, 14, 20`), para(".")],
                answer: [texInline(String.raw`12`)],
                soln: solnPack({
                    formulas: [
                        para("Mean:"),
                        texInline(String.raw`\text{mean}=\dfrac{\text{sum of values}}{\text{number of values}}`)
                    ],
                    working: [
                        texBlock(String.raw`\begin{aligned}
\text{Sum} &= 6+9+11+14+20 = 60 \\
\text{Mean} &= 60 \div 5 = 12
\end{aligned}`)
                    ]
                }),
                defaultExpanded: expandedVariant
            }));

            qs.push(makeQuestion({
                label: "8",
                prompt: [para("A shape is made from 10 identical squares. Which single square could be removed without changing the perimeter?")],
                answer: [para("A square that is completely surrounded on all four sides by other squares.")],
                diagrams: ["table"],
                soln: solnPack({
                    keepInMind: [para("Removing an internal square does not change the outside edge.")],
                    working: [para("Look for a square with no side on the outer boundary.")]
                }),
                defaultExpanded: expandedVariant
            }));

            qs.push(makeQuestion({
                label: "9",
                prompt: [para("A phone costs"), texInline(String.raw`£240`), para(". It increases by"), texInline(String.raw`12\%`), para(". What is the new price?")],
                answer: [texInline(String.raw`£268.80`)],
                soln: solnPack({
                    formulas: [
                        para("Percentage increase:"),
                        texInline(String.raw`\text{new}=\text{original}\times(1+\text{increase})`)
                    ],
                    working: [
                        texBlock(String.raw`\begin{aligned}
\text{New price} &= 240 \times (1+0.12) \\
&= 240 \times 1.12 \\
&= 268.80
\end{aligned}`)
                    ],
                    alternative: [
                        para("Find 12% of 240, then add it on."),
                        texBlock(String.raw`\begin{aligned}
12\% \text{ of } 240 &= 28.8 \\
240 + 28.8 &= 268.8
\end{aligned}`)
                    ]
                }),
                defaultExpanded: expandedVariant
            }));

            qs.push(makeQuestion({
                label: "10",
                prompt: [para("Expand and simplify"), texInline(String.raw`3(2x - 5) - 4(x + 1)`), para(".")],
                answer: [texInline(String.raw`2x - 19`)],
                soln: solnPack({
                    working: [
                        texBlock(String.raw`\begin{aligned}
3(2x-5) - 4(x+1) &= (6x-15) - (4x+4) \\
&= 6x - 15 - 4x - 4 \\
&= 2x - 19
\end{aligned}`)
                    ]
                }),
                defaultExpanded: expandedVariant
            }));

            // Q11–Q17: moderate
            for (let q = 11; q <= 17; q++) {
                qs.push(makeQuestion({
                    label: String(q),
                    prompt: [
                        para(`Question ${q}: Calculate`),
                        texInline(String.raw`${q * 3} + ${q * 7}`),
                        para(", and give your answer as an integer.")
                    ],
                    answer: [texInline(String.raw`${q * 10}`)],
                    soln: solnPack({
                        working: [texBlock(String.raw`\begin{aligned}
${q * 3} + ${q * 7} &= ${q * 10}
\end{aligned}`)]
                    }),
                    defaultExpanded: expandedVariant
                }));
            }

            // Deep Question Nesting add-on: Q18(a)(i), Q18(a)(ii), Q18(b)
            qs.push(makeQuestion({
                label: "18",
                prompt: [
                    para("A straight line has equation"),
                    texInline(String.raw`y = 2x + 1`),
                    para(".")
                ],
                answer: [para("See parts (a) and (b).")],
                soln: solnPack({
                    keepInMind: [para("Points on the line must satisfy the equation.")],
                    working: [para("Work through each sub-part using substitution.")]
                }),
                defaultExpanded: expandedVariant
            }));
            qs.push(makeQuestion({
                label: "18(a)",
                depth: 1,
                prompt: [para("Find the value of"), texInline(String.raw`y`), para("when"), texInline(String.raw`x=4`), para(".")],
                answer: [texInline(String.raw`y=9`)],
                soln: solnPack({
                    working: [texBlock(String.raw`\begin{aligned}
y &= 2(4) + 1 \\
&= 9
\end{aligned}`)]
                }),
                defaultExpanded: expandedVariant
            }));
            qs.push(makeQuestion({
                label: "18(a)(i)",
                depth: 2,
                prompt: [para("Write the point as an ordered pair.")],
                answer: [texInline(String.raw`(4,9)`)],
                soln: solnPack({
                    working: [para("Use (x, y). Here x = 4 and y = 9.")]
                }),
                defaultExpanded: expandedVariant
            }));
            qs.push(makeQuestion({
                label: "18(a)(ii)",
                depth: 2,
                prompt: [para("Check the point lies on the line.")],
                answer: [para("Yes.")],
                soln: solnPack({
                    working: [texBlock(String.raw`\begin{aligned}
9 &= 2(4) + 1 \\
9 &= 9
\end{aligned}`)]
                }),
                defaultExpanded: expandedVariant
            }));
            qs.push(makeQuestion({
                label: "18(b)",
                depth: 1,
                prompt: [para("Find the x-intercept (where"), texInline(String.raw`y=0`), para(").")],
                answer: [texInline(String.raw`x=-\dfrac{1}{2}`)],
                soln: solnPack({
                    formulas: [
                        para("At the x-intercept,"),
                        texInline(String.raw`y=0`)
                    ],
                    working: [texBlock(String.raw`\begin{aligned}
0 &= 2x + 1 \\
2x &= -1 \\
x &= -\dfrac{1}{2}
\end{aligned}`)]
                }),
                defaultExpanded: expandedVariant
            }));

            // Q19–Q25: medium; include at least one with all three blocks (Keep in mind + Formulas used + Alternative working)
            for (let q = 19; q <= 25; q++) {
                if (q === 22) {
                    qs.push(makeQuestion({
                        label: "22",
                        prompt: [para("A tank is"), texInline(String.raw`3/8`), para("full. It holds"), texInline(String.raw`240\,\text{L}`), para("when full. How many litres are in the tank?")],
                        answer: [texInline(String.raw`90\,\text{L}`)],
                        soln: solnPack({
                            keepInMind: [para("Find the fraction of the full amount.")],
                            formulas: [para("Fraction of an amount:"), texInline(String.raw`\text{part}=\text{fraction}\times\text{whole}`)],
                            working: [texBlock(String.raw`\begin{aligned}
\text{Amount} &= \dfrac{3}{8}\times 240 \\
&= 3\times 30 \\
&= 90
\end{aligned}`)],
                            alternative: [
                                para("Find 1/8 first, then multiply by 3."),
                                texBlock(String.raw`\begin{aligned}
240 \div 8 &= 30 \\
3 \times 30 &= 90
\end{aligned}`)
                            ]
                        }),
                        defaultExpanded: expandedVariant
                    }));
                } else {
                    qs.push(makeQuestion({
                        label: String(q),
                        prompt: [para(`Solve`), texInline(String.raw`${q}x + 6 = ${q * 4 + 6}`), para(".")],
                        answer: [texInline(String.raw`x=4`)],
                        soln: solnPack({
                            working: [texBlock(String.raw`\begin{aligned}
${q}x + 6 &= ${q * 4 + 6} \\
${q}x &= ${q * 4} \\
x &= 4
\end{aligned}`)]
                        }),
                        defaultExpanded: expandedVariant
                    }));
                }
            }

            // Q26–Q35: long algebra with multiple KaTeX blocks in Solution Details
            for (let q = 26; q <= 35; q++) {
                const lab = String(q);
                const longPrompt = [
                    para(`A quadratic expression is formed using the rule:`),
                    texInline(String.raw`f(x) = (x - ${q - 20})(x + ${q - 24})`),
                    para("."),
                    para("Expand, then solve"),
                    texInline(String.raw`f(x)=0`),
                    para(".")
                ];
                const a = (q - 20);
                const b = (q - 24);
                const expanded = String.raw`x^2 + (${b - a})x - ${a * b}`;
                const roots = [a, -b];
                const working = [
                    para("First expand carefully, then factor or use the zero-product idea."),
                    texBlock(String.raw`\begin{aligned}
f(x) &= (x - ${a})(x + ${b}) \\
&= x(x+${b}) - ${a}(x+${b}) \\
&= x^2 + ${b}x - ${a}x - ${a * b} \\
&= ${expanded}
\end{aligned}`),
                    para("Now solve"),
                    texInline(String.raw`f(x)=0`),
                    para(" by setting each bracket equal to zero."),
                    texBlock(String.raw`\begin{aligned}
(x - ${a})(x + ${b}) &= 0 \\
x - ${a} &= 0 \quad \text{or}\quad x + ${b} = 0 \\
x &= ${a} \quad \text{or}\quad x = ${-b}
\end{aligned}`),
                    para("This section includes extra display maths to stress-test overflow behaviour on smaller screens."),
                    texBlock(String.raw`\begin{aligned}
\text{Example: } \quad \dfrac{(x^2 + ${b}x - ${a}x - ${a * b})^2}{(x - ${a})^2} &= (x + ${b})^2
\end{aligned}`),
                    texBlock(String.raw`\begin{aligned}
\text{Long line: }\quad \left(\dfrac{3x - 2}{x + 5}\right)\left(\dfrac{7x + 11}{2x - 9}\right)\left(\dfrac{5x - 13}{9x + 4}\right) &= \dfrac{(3x - 2)(7x + 11)(5x - 13)}{(x + 5)(2x - 9)(9x + 4)}
\end{aligned}`)
                ];

                const alt = [
                    para("Alternative working: expand to a standard form, then factor again."),
                    texBlock(String.raw`\begin{aligned}
${expanded} &= 0 \\
x^2 + (${b - a})x - ${a * b} &= 0 \\
(x - ${a})(x + ${b}) &= 0
\end{aligned}`)
                ];

                // For selected questions, include extremely long workings
                const includeVeryLong = (q === 30 || q === 34);

                qs.push(makeQuestion({
                    label: lab,
                    prompt: longPrompt,
                    answer: [para("Possible answers:"), texInline(String.raw`x=${roots[0]}`), para("or"), texInline(String.raw`x=${roots[1]}`)],
                    soln: solnPack({
                        keepInMind: [
                            para("When a product is zero, at least one factor must be zero."),
                            para("Keep the equation balanced by doing the same operation to both sides.")
                        ],
                        formulas: [
                            para("Zero product idea:"),
                            texInline(String.raw`ab=0 \Rightarrow a=0 \text{ or } b=0`)
                        ],
                        working: includeVeryLong ? working.concat(longAlgebraWorking(`Q${q}`)) : working,
                        alternative: (q % 2 === 0) ? alt : []
                    }),
                    defaultExpanded: expandedVariant
                }));
            }

            // Deep nesting add-on for Q30 (already top-level exists; add subparts too)
            // Add subparts AFTER Q30 (they will still appear in the linear document).
            const insertAfter = qs.findIndex(x => x.label === "30");
            if (insertAfter !== -1) {
                qs.splice(insertAfter + 1, 0,
                    makeQuestion({
                        label: "30(a)",
                        depth: 1,
                        prompt: [para("Using your expansion, write down the coefficient of"), texInline(String.raw`x`), para(".")],
                        answer: [texInline(String.raw`(${(30 - 24) - (30 - 20)})`)],
                        soln: solnPack({
                            working: [para("From the expanded form, the coefficient of x is the number multiplying x.")]
                        }),
                        defaultExpanded: expandedVariant
                    }),
                    makeQuestion({
                        label: "30(a)(i)",
                        depth: 2,
                        prompt: [para("Explain why the constant term is negative.")],
                        answer: [para("Because it is the product of a positive and a negative number.")],
                        soln: solnPack({
                            working: [para("The constant term comes from multiplying the two constants in the brackets.")]
                        }),
                        defaultExpanded: expandedVariant
                    }),
                    makeQuestion({
                        label: "30(a)(ii)",
                        depth: 2,
                        prompt: [para("Write the constant term using multiplication.")],
                        answer: [texInline(String.raw`-(${30 - 20})\times(${30 - 24})`)],
                        soln: solnPack({
                            working: [texBlock(String.raw`\begin{aligned}
\text{Constant} &= -( ${30 - 20} \times ${30 - 24})
\end{aligned}`)]
                        }),
                        defaultExpanded: expandedVariant
                    }),
                    makeQuestion({
                        label: "30(b)",
                        depth: 1,
                        prompt: [para("State the two solutions again, in ascending order.")],
                        answer: [texInline(String.raw`${Math.min(30 - 20, -(30 - 24))},\;${Math.max(30 - 20, -(30 - 24))}`)],
                        soln: solnPack({
                            working: [para("Order numbers from smallest to largest.")]
                        }),
                        defaultExpanded: expandedVariant
                    })
                );
            }

            // Ensure total top-level questions are 35 (Q1–Q35). Subparts exist but do not count as top-level.
            return {
                id: expandedVariant ? "standardExpanded" : "standard",
                title: expandedVariant ? "Standard paper (Workings Expanded)" : "Standard paper",
                workingsExpandedDefault: expandedVariant,
                questions: qs,
                sections: null
            };
        }

        function buildDiagramPaper() {
            const qs = [];
            const diagramQs = new Set([2, 4, 6, 8, 11, 14, 17, 19]); // 8 questions contain diagrams
            const types = ["geometry", "ratio", "grid", "table"];
            for (let q = 1; q <= 20; q++) {
                const hasD = diagramQs.has(q);
                const dType = hasD ? types[q % types.length] : null;

                let prompt;
                let answer;
                let soln;
                if (hasD && dType === "grid") {
                    prompt = [
                        para("On the coordinate grid, a straight line passes through the points shown."),
                        para("Find the gradient.")
                    ];
                    answer = [texInline(String.raw`\dfrac{3-1}{7-2}=\dfrac{2}{5}`)];
                    soln = solnPack({
                        keepInMind: [para("Gradient is the change in y over the change in x.")],
                        formulas: [para("Gradient:"), texInline(String.raw`m=\dfrac{\Delta y}{\Delta x}`)],
                        working: [texBlock(String.raw`\begin{aligned}
\Delta y &= 3 - 1 = 2 \\
\Delta x &= 7 - 2 = 5 \\
m &= \dfrac{2}{5}
\end{aligned}`)]
                    });
                } else if (hasD && dType === "geometry") {
                    prompt = [
                        para("In the diagram, the circle has radius"),
                        texInline(String.raw`r=7\,\text{cm}`),
                        para(". Find the circumference.")
                    ];
                    answer = [texInline(String.raw`14\pi\,\text{cm}`)];
                    soln = solnPack({
                        formulas: [para("Circumference:"), texInline(String.raw`C=2\pi r`)],
                        working: [texBlock(String.raw`\begin{aligned}
C &= 2\pi(7) \\
&= 14\pi
\end{aligned}`)]
                    });
                } else if (hasD && dType === "ratio") {
                    prompt = [
                        para("Orange squash and water are mixed in the ratio"),
                        texInline(String.raw`1:4`),
                        para(". The total drink is"),
                        texInline(String.raw`750\,\text{ml}`),
                        para(". How much squash is used?")
                    ];
                    answer = [texInline(String.raw`150\,\text{ml}`)];
                    soln = solnPack({
                        keepInMind: [para("Total parts = 1+4 = 5 parts.")],
                        working: [texBlock(String.raw`\begin{aligned}
5\text{ parts} &= 750 \\
1\text{ part} &= 750 \div 5 = 150
\end{aligned}`)]
                    });
                } else if (hasD && dType === "table") {
                    prompt = [
                        para("A table shows the number of books read by a group of students."),
                        para("What is the median number of books?")
                    ];
                    answer = [texInline(String.raw`4`)];
                    soln = solnPack({
                        keepInMind: [para("Order the values, then take the middle one.")],
                        working: [
                            para("Order the numbers from smallest to largest."),
                            texBlock(String.raw`\begin{aligned}
\text{Median} &= 4
\end{aligned}`)
                        ]
                    });
                } else {
                    prompt = [para(`Calculate`), texInline(String.raw`${q * 7} - ${q * 3}`), para(".")];
                    answer = [texInline(String.raw`${q * 4}`)];
                    soln = solnPack({
                        working: [texBlock(String.raw`\begin{aligned}
${q * 7} - ${q * 3} &= ${q * 4}
\end{aligned}`)]
                    });
                }

                qs.push(makeQuestion({
                    label: String(q),
                    prompt,
                    diagrams: hasD ? [dType] : [],
                    answer,
                    soln
                }));
            }
            return { id: "diagram", title: "Diagram-heavy paper", workingsExpandedDefault: false, questions: qs, sections: null };
        }

        function buildSectionedPaper() {
            const sections = [
                { key: "A", title: "Section A", count: 35 },
                { key: "B", title: "Section B", count: 8 },
                { key: "C", title: "Section C", count: 6 }
            ];

            const qs = [];
            let qNum = 1;

            // Section A: small/medium
            for (let i = 0; i < 35; i++) {
                const label = String(qNum);
                const includeAlt = (qNum % 11 === 0);
                const includeKeep = (qNum % 9 === 0);
                const includeForm = (qNum % 7 === 0);

                qs.push(makeQuestion({
                    label,
                    prompt: [
                        para("Evaluate"),
                        texInline(String.raw`\dfrac{${qNum * 6}}{${qNum}} + ${qNum - 1}`),
                        para(".")
                    ],
                    answer: [texInline(String.raw`${6 + (qNum - 1)}`)],
                    soln: solnPack({
                        keepInMind: includeKeep ? [para("Simplify a fraction first if you can.")] : [],
                        formulas: includeForm ? [para("Division rule:"), texInline(String.raw`\dfrac{ka}{k}=a`)] : [],
                        working: [
                            texBlock(String.raw`\begin{aligned}
\dfrac{${qNum * 6}}{${qNum}} + ${qNum - 1} &= 6 + ${qNum - 1} \\
&= ${6 + (qNum - 1)}
\end{aligned}`)
                        ],
                        alternative: includeAlt ? [para("You can simplify in your head before writing the final line.")] : []
                    })
                }));
                qNum++;
            }

            // Section B: medium
            for (let i = 0; i < 8; i++) {
                const label = String(qNum);
                qs.push(makeQuestion({
                    label,
                    prompt: [
                        para("A sequence is defined by"),
                        texInline(String.raw`u_n = 3n + 2`),
                        para(". Find"),
                        texInline(String.raw`u_{${i + 4}}`),
                        para(".")
                    ],
                    answer: [texInline(String.raw`${3 * (i + 4) + 2}`)],
                    soln: solnPack({
                        keepInMind: [para("Substitute the value of n into the rule.")],
                        working: [
                            texBlock(String.raw`\begin{aligned}
u_{${i + 4}} &= 3(${i + 4}) + 2 \\
&= ${3 * (i + 4) + 2}
\end{aligned}`)
                        ]
                    })
                }));
                qNum++;
            }

            // Section C: all very long Solution Details (collapsed by default)
            for (let i = 0; i < 6; i++) {
                const label = String(qNum);
                const seed = `Section C Q${label}`;
                const prompt = [
                    para("A pair of simultaneous equations is given:"),
                    texInline(String.raw`\begin{cases}
2x + 3y = ${24 + i * 3} \\
5x - y = ${19 + i * 2}
\end{cases}`),
                    para("Solve for x and y.")
                ];
                const answer = [para("One possible answer pair is shown in the working.")];

                const working = [
                    para("Eliminate one variable by making the coefficients match."),
                    texBlock(String.raw`\begin{aligned}
2x + 3y &= ${24 + i * 3} \\
5x - y &= ${19 + i * 2}
\end{aligned}`),
                    texBlock(String.raw`\begin{aligned}
\text{Multiply the second equation by }3: \\
15x - 3y &= ${3 * (19 + i * 2)}
\end{aligned}`),
                    texBlock(String.raw`\begin{aligned}
(2x + 3y) + (15x - 3y) &= ${24 + i * 3} + ${3 * (19 + i * 2)} \\
17x &= ${(24 + i * 3) + 3 * (19 + i * 2)} \\
x &= \dfrac{${(24 + i * 3) + 3 * (19 + i * 2)}}{17}
\end{aligned}`),
                    para("Now substitute x back into one equation to find y."),
                    texBlock(String.raw`\begin{aligned}
5x - y &= ${19 + i * 2} \\
y &= 5x - ${19 + i * 2}
\end{aligned}`)
                ].concat(longAlgebraWorking(seed)); // very long block for stress test

                qs.push(makeQuestion({
                    label,
                    prompt,
                    answer,
                    soln: solnPack({
                        keepInMind: [
                            para("Keep equations aligned so you do not lose track of signs."),
                            para("Check your answer by substituting into both equations.")
                        ],
                        formulas: [
                            para("If you multiply an equation, you must multiply every term."),
                            texInline(String.raw`k(ax+by)=kax+kby`)
                        ],
                        working,
                        alternative: [
                            para("Alternative working: elimination using a different multiplier choice."),
                            texBlock(String.raw`\begin{aligned}
\text{You could eliminate }x\text{ instead by scaling the first equation.}
\end{aligned}`)
                        ]
                    })
                }));
                qNum++;
            }

            return {
                id: "sectioned",
                title: "Sectioned paper",
                workingsExpandedDefault: false,
                questions: qs,
                sections
            };
        }

        const DATASETS = {
            short: buildShortPaper(),
            standard: buildStandardPaper({ expandedVariant: false }),
            standardExpanded: buildStandardPaper({ expandedVariant: true }),
            diagram: buildDiagramPaper(),
            sectioned: buildSectionedPaper()
        };

        // ---------- Rendering ----------
        const paperEl = document.getElementById("paper");
        const navListEl = document.getElementById("navList");
        const drawerOverlay = document.getElementById("drawerOverlay");
        const drawerNavEl = document.getElementById("drawerNav");
        const navToggleBtn = document.getElementById("navToggle");
        const drawerCloseBtn = document.getElementById("drawerClose");
        const paperSelect = document.getElementById("paperSelect");

        let activeDatasetId = paperSelect.value;
        let activeObserver = null;
        let lastFocusBeforeDrawer = null;

        function el(tag, attrs = {}, children = []) {
            const n = document.createElement(tag);
            Object.entries(attrs).forEach(([k, v]) => {
                if (k === "class") n.className = v;
                else if (k === "html") n.innerHTML = v;
                else if (k.startsWith("data-")) n.setAttribute(k, v);
                else if (k === "hidden") n.hidden = !!v;
                else if (k === "text") n.textContent = v;
                else n.setAttribute(k, v);
            });
            children.forEach(c => {
                if (c == null) return;
                if (typeof c === "string") n.appendChild(document.createTextNode(c));
                else n.appendChild(c);
            });
            return n;
        }

        function renderPromptParts(parts) {
            const frag = document.createDocumentFragment();
            parts.forEach(p => {
                if (!p) return;
                if (p.type === "p") {
                    frag.appendChild(el("p", { text: p.text }));
                } else if (p.type === "tex-inline") {
                    frag.appendChild(el("span", { class: "math-inline", "data-tex": p.tex }));
                } else if (p.type === "tex-block") {
                    frag.appendChild(el("div", { class: "math-block", "data-tex": p.tex }));
                } else if (p.type === "ul") {
                    const ul = el("ul");
                    p.items.forEach(it => ul.appendChild(el("li", { text: it })));
                    frag.appendChild(ul);
                }
            });
            return frag;
        }

        function renderAnswerParts(parts) {
            const wrap = el("div", { class: "avalue" });
            parts.forEach(p => {
                if (!p) return;
                if (typeof p === "string") {
                    wrap.appendChild(document.createTextNode(p));
                } else if (p.type === "p") {
                    const sp = el("p", { text: p.text });
                    sp.style.margin = "0 0 6px 0";
                    wrap.appendChild(sp);
                } else if (p.type === "tex-inline") {
                    wrap.appendChild(el("span", { class: "math-inline", "data-tex": p.tex }));
                    wrap.appendChild(document.createTextNode(" "));
                } else if (p.type === "tex-block") {
                    wrap.appendChild(el("div", { class: "math-block", "data-tex": p.tex }));
                }
            });
            return wrap;
        }

        function renderSolutionBlock(title, parts) {
            if (!parts || parts.length === 0) return null;
            const body = el("div", { class: "soln-body" });
            body.appendChild(renderPromptParts(parts));
            return el("div", { class: "soln-block" }, [
                el("div", { class: "soln-title", text: title }),
                body
            ]);
        }

        function renderQuestion(q, dataset) {
            const article = el("article", { class: `q depth-${q.depth}`, id: q.anchor, "data-qanchor": q.anchor, "data-qlabel": q.label });
            const inner = el("div", { class: "q-inner" });

            const head = el("div", { class: "q-head" }, [
                el("div", { class: "qid", text: q.label }),
                el("div", { class: "qtext" }, [renderPromptParts(q.prompt)])
            ]);

            // diagrams are part of the Question block
            const diagWrap = el("div");
            (q.diagrams || []).forEach(key => {
                const fn = DIAGRAMS[key];
                if (fn) diagWrap.appendChild(el("div", { html: fn() }));
            });

            const answerRow = el("div", { class: "answer" }, [
                el("div", { class: "alabel", text: "Answer" }),
                renderAnswerParts(q.answer)
            ]);

            // Solution details region
            const solnId = `sd_${q.anchor}`;
            const defaultExpanded = (typeof q.defaultExpanded === "boolean") ? q.defaultExpanded : dataset.workingsExpandedDefault;

            const toggleBtn = el("button", {
                type: "button",
                class: "toggle-working",
                "aria-expanded": defaultExpanded ? "true" : "false",
                "aria-controls": solnId
            }, [
                el("span", {
                    class: "chev", "aria-hidden": "true", html:
                        `<svg viewBox="0 0 20 20" fill="none">
            <path d="M5 7.5L10 12.5L15 7.5" stroke="#444" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
           </svg>`
                }),
                el("span", { text: defaultExpanded ? "Hide working" : "Show working" })
            ]);

            const soln = el("section", { class: "soln", id: solnId, hidden: !defaultExpanded });
            // Ordered blocks when present
            const b1 = renderSolutionBlock("Keep in mind", q.soln?.keepInMind || []);
            const b2 = renderSolutionBlock("Formulas used", q.soln?.formulas || []);
            const b3 = renderSolutionBlock("Working", q.soln?.working || []);
            const b4 = renderSolutionBlock("Alternative working", q.soln?.alternative || []);
            [b1, b2, b3, b4].forEach(b => { if (b) soln.appendChild(b); });

            const toggleRow = el("div", { class: "toggle-row" }, [toggleBtn]);

            inner.appendChild(head);
            if (diagWrap.childNodes.length) inner.appendChild(diagWrap);
            inner.appendChild(el("div", { class: "qmeta" }, [
                answerRow,
                toggleRow,
                soln
            ]));

            article.appendChild(inner);

            // Toggle behavior: inline only, no cross-question effects, no forced focus movement
            toggleBtn.addEventListener("click", () => {
                const isExpanded = toggleBtn.getAttribute("aria-expanded") === "true";
                const next = !isExpanded;
                toggleBtn.setAttribute("aria-expanded", next ? "true" : "false");
                toggleBtn.lastElementChild.textContent = next ? "Hide working" : "Show working";
                soln.hidden = !next;
                // do not auto-scroll; allow natural layout shift only
                // re-render math inside this solution block when expanding (handles late KaTeX load)
                if (next) renderAllMath(soln);
            });

            return article;
        }

        function buildNavItems(dataset) {
            // For sectioned paper: add plain-text separators A/B/C only
            const items = [];
            const byLabel = new Map(dataset.questions.map(q => [q.label, q]));
            const labelsInOrder = dataset.questions.map(q => q.label);

            if (dataset.id === "sectioned" && dataset.sections) {
                let idx = 0;
                dataset.sections.forEach(sec => {
                    items.push({ type: "sep", label: sec.key });
                    for (let i = 0; i < sec.count; i++) {
                        const qLabel = labelsInOrder[idx++];
                        const q = byLabel.get(qLabel);
                        if (!q) continue;
                        items.push({ type: "item", label: q.label, anchor: q.anchor });
                    }
                });
                return items;
            }

            // Default: list all question identifiers (including sub-questions) in linear order
            dataset.questions.forEach(q => {
                items.push({ type: "item", label: q.label, anchor: q.anchor });
            });
            return items;
        }

        function renderNav(dataset) {
            const items = buildNavItems(dataset);

            navListEl.innerHTML = "";
            drawerNavEl.innerHTML = "";

            const makeBtn = (it) => {
                const btn = el("button", { class: "nav-item", type: "button", "data-target": it.anchor }, [it.label]);
                btn.addEventListener("click", () => {
                    closeDrawer();
                    const target = document.getElementById(it.anchor);
                    if (target) target.scrollIntoView({ behavior: "auto", block: "start" });
                });
                return btn;
            };

            items.forEach(it => {
                if (it.type === "sep") {
                    const sep1 = el("div", { class: "nav-sep", text: it.label });
                    const sep2 = el("div", { class: "nav-sep", text: it.label });
                    navListEl.appendChild(sep1);
                    drawerNavEl.appendChild(sep2);
                } else {
                    navListEl.appendChild(makeBtn(it));
                    drawerNavEl.appendChild(makeBtn(it));
                }
            });
        }

        function renderPaper(datasetId) {
            const dataset = DATASETS[datasetId];
            if (!dataset) return;

            // Tear down observers
            if (activeObserver) { activeObserver.disconnect(); activeObserver = null; }

            activeDatasetId = datasetId;

            // Paper title
            paperEl.innerHTML = "";
            paperEl.appendChild(el("div", { class: "paper-title", text: dataset.title }));

            // Questions in a single linear document (continuous scroll)
            dataset.questions.forEach(q => {
                paperEl.appendChild(renderQuestion(q, dataset));
            });

            // Navigation rebuilds accordingly
            renderNav(dataset);

            // KaTeX render pass (or fallback)
            renderAllMath(paperEl);

            // Active position indicator in nav (subtle, no progress semantics)
            const qEls = Array.from(paperEl.querySelectorAll("article.q"));
            const navButtons = Array.from(document.querySelectorAll('.nav-item[data-target]'));
            const byTarget = new Map(navButtons.map(b => [b.getAttribute("data-target"), b]));

            let current = null;
            activeObserver = new IntersectionObserver((entries) => {
                // pick the first mostly-visible question in the viewport
                const visible = entries
                    .filter(e => e.isIntersecting)
                    .sort((a, b) => b.intersectionRatio - a.intersectionRatio)[0];
                if (!visible) return;

                const anchor = visible.target.getAttribute("id");
                if (!anchor || anchor === current) return;

                current = anchor;
                navButtons.forEach(b => b.setAttribute("aria-current", "false"));
                const btn = byTarget.get(anchor);
                if (btn) btn.setAttribute("aria-current", "true");
            }, { root: null, threshold: [0.15, 0.35, 0.55] });

            qEls.forEach(q => activeObserver.observe(q));
        }

        // ---------- Drawer (mobile nav) ----------
        function openDrawer() {
            lastFocusBeforeDrawer = document.activeElement;
            drawerOverlay.hidden = false;
            // prevent background scroll without creating a nested scroll region for paper (page remains, but overlay blocks interaction)
            document.body.style.overflow = "hidden";
            // focus first interactive element
            setTimeout(() => drawerCloseBtn.focus(), 0);
        }

        function closeDrawer() {
            if (drawerOverlay.hidden) return;
            drawerOverlay.hidden = true;
            document.body.style.overflow = "";
            if (lastFocusBeforeDrawer && typeof lastFocusBeforeDrawer.focus === "function") {
                lastFocusBeforeDrawer.focus();
            } else {
                navToggleBtn.focus();
            }
        }

        navToggleBtn.addEventListener("click", openDrawer);
        drawerCloseBtn.addEventListener("click", closeDrawer);

        drawerOverlay.addEventListener("click", (e) => {
            if (e.target === drawerOverlay) closeDrawer();
        });

        document.addEventListener("keydown", (e) => {
            if (e.key === "Escape") closeDrawer();
            // Focus trap while drawer open
            if (!drawerOverlay.hidden && e.key === "Tab") {
                const focusables = drawerOverlay.querySelectorAll('button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])');
                const list = Array.from(focusables).filter(el => !el.hasAttribute("disabled") && !el.getAttribute("aria-hidden"));
                if (list.length === 0) return;
                const first = list[0];
                const last = list[list.length - 1];
                if (e.shiftKey && document.activeElement === first) {
                    e.preventDefault();
                    last.focus();
                } else if (!e.shiftKey && document.activeElement === last) {
                    e.preventDefault();
                    first.focus();
                }
            }
        });

        // ---------- Selector ----------
        paperSelect.addEventListener("change", () => {
            renderPaper(paperSelect.value);
            // Switching papers must not auto-expand/collapse beyond defaults (we rebuild to dataset defaults)
            // Navigation states remain non-destructive (no auto expansion)
            closeDrawer();
            // keep the top controls stable; do not auto-scroll
        });

        // Initial render
        renderPaper(activeDatasetId);

        // If KaTeX loads late, render again (but do not hide content if it doesn't)
        window.addEventListener("load", () => {
            renderAllMath(document);
        });
    </script>
</body>

</html>