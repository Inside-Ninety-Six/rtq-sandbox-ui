<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>RTQ – Maths Paper Solution Viewer (Stress Test)</title>

    <!-- Real KaTeX Rendering (CDN) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css"
        integrity="sha384-nB0miv6/jRmo5V6A6b0r0j0DqHfVv7m0nYp6rD7Jr3bKq2bR8h1Qd0v6bK2m4g2G" crossorigin="anonymous">

    <style>
        :root {
            /* Soft-warm neutral base (subtle, desaturated) */
            --bg: #f4f3f0;
            --surface: #faf9f6;
            --ink: #1f1f1f;
            --ink-2: #3a3a3a;
            --ink-3: #5a5a5a;
            --hairline: rgba(0, 0, 0, .10);

            /* Subtle surface separation for Solution Details */
            --sd-bg: rgba(0, 0, 0, .035);
            --sd-rule: rgba(0, 0, 0, .08);

            /* Rhythm */
            --frame-max: 1120px;
            --gutter: 20px;
            --col-gap: 34px;

            --space-q: 28px;
            /* between top-level questions (largest within doc) */
            --space-q-inner: 10px;
            /* between question and answer */
            --space-answer-toggle: 10px;
            --space-sd-block: 14px;
            --space-lines: 8px;

            --nav-w: 120px;

            --indent-step: 18px;

            --topbar-h: 56px;

            --focus: rgba(0, 0, 0, .35);
        }

        * {
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
        }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--ink);
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
            line-height: 1.45;
            overflow-x: hidden;
            /* never allow page-level horizontal scroll */
            text-rendering: optimizeLegibility;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Top controls aligned to the same centered frame */
        .topbar {
            position: sticky;
            top: 0;
            z-index: 20;
            background: linear-gradient(to bottom, rgba(244, 243, 240, .95), rgba(244, 243, 240, .92));
            border-bottom: 1px solid var(--hairline);
            backdrop-filter: blur(6px);
            -webkit-backdrop-filter: blur(6px);
        }

        .topbar-inner {
            max-width: var(--frame-max);
            margin: 0 auto;
            padding: 0 var(--gutter);
            height: var(--topbar-h);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .topbar-title {
            font-size: 14px;
            color: var(--ink-3);
            letter-spacing: .01em;
            white-space: nowrap;
        }

        .controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: auto;
        }

        label {
            font-size: 13px;
            color: var(--ink-3);
            white-space: nowrap;
        }

        select {
            font: inherit;
            font-size: 14px;
            padding: 8px 10px;
            border: 1px solid var(--hairline);
            border-radius: 10px;
            background: var(--surface);
            color: var(--ink);
            max-width: 360px;
        }

        select:focus-visible {
            outline: 2px solid var(--focus);
            outline-offset: 2px;
        }

        .jumpBtn {
            font: inherit;
            font-size: 14px;
            padding: 8px 10px;
            border: 1px solid var(--hairline);
            border-radius: 10px;
            background: var(--surface);
            color: var(--ink);
            display: none;
            /* shown on smaller screens */
        }

        .jumpBtn:hover {
            text-decoration: underline;
        }

        .jumpBtn:focus-visible {
            outline: 2px solid var(--focus);
            outline-offset: 2px;
        }

        /* Frame: navigation + content on same base surface */
        .frame {
            max-width: var(--frame-max);
            margin: 0 auto;
            padding: 18px var(--gutter) 40px;
            background: var(--surface);
            /* unified surface for both columns (desktop) */
            min-height: calc(100vh - var(--topbar-h));
        }

        .columns {
            display: grid;
            grid-template-columns: var(--nav-w) minmax(0, 1fr);
            gap: var(--col-gap);
            align-items: start;
        }

        /* Navigation: quiet, no distinct background panel */
        nav {
            background: transparent;
        }

        .nav-rail {
            position: sticky;
            /* Add-on: Navigation Persistence */
            top: calc(var(--topbar-h) + 18px);
            align-self: start;
            padding-top: 6px;
        }

        .nav-title {
            font-size: 12px;
            color: var(--ink-3);
            margin: 0 0 10px 0;
            letter-spacing: .02em;
        }

        .nav-list {
            max-height: calc(100vh - var(--topbar-h) - 54px);
            overflow-y: auto;
            /* allowed scroll region when exceeds viewport height */
            padding-right: 6px;
            scrollbar-width: none;
            /* Firefox */
            -ms-overflow-style: none;
            /* legacy */
        }

        .nav-list::-webkit-scrollbar {
            display: none;
        }

        /* WebKit/Blink */

        .nav-sep {
            font-size: 12px;
            color: var(--ink-3);
            margin: 14px 0 6px;
            letter-spacing: .03em;
        }

        .nav-item {
            display: block;
            width: 100%;
            text-align: left;
            font: inherit;
            font-size: 13px;
            padding: 6px 2px;
            border: 0;
            background: transparent;
            color: var(--ink-3);
            cursor: pointer;
            border-radius: 8px;
            line-height: 1.2;
            position: relative;
            text-decoration: none;
        }

        .nav-item:hover {
            text-decoration: underline;
        }

        /* one minimal hover change */
        .nav-item:focus-visible {
            outline: 2px solid var(--focus);
            outline-offset: 2px;
        }

        .nav-item[aria-current="true"] {
            font-weight: 700;
            /* one strong cue only */
            color: var(--ink-2);
            text-decoration: none;
        }

        .nav-item[aria-current="true"]::before {
            content: "";
            position: absolute;
            left: -10px;
            top: 50%;
            transform: translateY(-50%);
            width: 6px;
            height: 1px;
            background: rgba(0, 0, 0, .18);
        }

        main {
            min-width: 0;
            padding-top: 4px;
        }

        /* Paper headings */
        .paper-meta {
            margin: 0 0 18px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--hairline);
        }

        .paper-name {
            margin: 0;
            font-size: 16px;
            color: var(--ink-2);
            font-weight: 650;
        }

        .paper-sub {
            margin: 6px 0 0;
            font-size: 13px;
            color: var(--ink-3);
        }

        /* Question blocks: grouped by whitespace (no cards/panels) */
        .q {
            margin: 0;
            padding: 0;
        }

        .q+.q {
            margin-top: var(--space-q);
        }

        .q[data-depth="1"] {
            margin-top: calc(var(--space-q) * .55);
        }

        .q[data-depth="2"] {
            margin-top: calc(var(--space-q) * .35);
        }

        .q-inner {
            --depth: 0;
            margin-left: min(calc(var(--depth) * var(--indent-step)), 48px);
            padding-left: 0;
        }

        .q-head {
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }

        .qid {
            flex: 0 0 auto;
            font-size: 14px;
            color: var(--ink-3);
            font-weight: 600;
            line-height: 1.35;
            margin-top: 1px;
        }

        .qtext {
            font-size: 16px;
            color: var(--ink);
            line-height: 1.6;
            max-width: 74ch;
        }

        .qtext p {
            margin: 0 0 var(--space-lines) 0;
        }

        .qtext p:last-child {
            margin-bottom: 0;
        }

        /* Answers: visible by default, subordinate to question but above solution details */
        .answer {
            margin-top: var(--space-q-inner);
            display: flex;
            gap: 10px;
            align-items: baseline;
            color: var(--ink-2);
            max-width: 74ch;
        }

        .answer .label {
            font-size: 13px;
            font-weight: 650;
            /* labels allowed */
            color: var(--ink-3);
            flex: 0 0 auto;
            letter-spacing: .01em;
        }

        .answer .value {
            font-size: 15px;
            color: var(--ink-2);
            min-width: 0;
        }

        .answer .value ul {
            margin: 0;
            padding-left: 18px;
        }

        .answer .value li {
            margin: 0;
            padding: 0;
        }

        /* Disclosure control: text-first, link-like (not button-like) */
        .toggleRow {
            margin-top: var(--space-answer-toggle);
            max-width: 74ch;
        }

        .toggle {
            font: inherit;
            font-size: 14px;
            padding: 0;
            border: 0;
            background: transparent;
            color: var(--ink-3);
            cursor: pointer;
            display: inline-flex;
            gap: 6px;
            align-items: center;
            border-radius: 8px;
        }

        .toggle:hover {
            text-decoration: underline;
        }

        /* one minimal hover change */
        .toggle:focus-visible {
            outline: 2px solid var(--focus);
            outline-offset: 2px;
        }

        .chev {
            font-size: 12px;
            opacity: .7;
            transform: translateY(1px);
        }

        /* Solution Details: subtle surface separation, subordinate */
        .solutionWrap {
            margin-top: 10px;
            max-width: 76ch;
        }

        .solution {
            background: var(--sd-bg);
            padding: 12px 14px;
            border-radius: 12px;
            box-shadow: inset 2px 0 0 var(--sd-rule);
            overflow: hidden;
            /* for height animations */
        }

        .sd-block+.sd-block {
            margin-top: var(--space-sd-block);
        }

        .sd-label {
            font-size: 13px;
            font-weight: 650;
            /* labels only */
            color: var(--ink-3);
            margin: 0 0 8px;
            letter-spacing: .01em;
        }

        .sd-body {
            font-size: 14px;
            color: var(--ink-2);
            line-height: 1.5;
        }

        .sd-body p {
            margin: 0 0 var(--space-lines) 0;
        }

        .sd-body p:last-child {
            margin-bottom: 0;
        }

        .sd-body ul {
            margin: 0;
            padding-left: 18px;
        }

        .sd-body li {
            margin: 0 0 6px;
        }

        /* KaTeX containment invariant */
        .math-inline {
            display: inline-block;
        }

        .math-block {
            margin: 10px 0;
            padding: 8px 10px;
            border-radius: 10px;
            background: rgba(0, 0, 0, .02);
            overflow-x: auto;
            /* horizontal scroll ONLY within math block */
            overflow-y: hidden;
            max-width: 100%;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .math-block::-webkit-scrollbar {
            display: none;
        }

        .math-block .katex-display {
            margin: 0;
        }

        .math-block * {
            max-width: 100%;
        }

        /* Diagrams (inline SVG placeholders, grayscale) */
        .diagram {
            margin: 10px 0 6px;
            max-width: 520px;
        }

        .diagram svg {
            width: 100%;
            height: auto;
            display: block;
            border-radius: 10px;
            background: rgba(0, 0, 0, .02);
        }

        /* Section headers in content (A/B/C): structural dividers, not containers */
        .sectionHeader {
            margin: 22px 0 8px;
            padding-top: 14px;
            border-top: 1px solid var(--hairline);
            color: var(--ink-3);
            font-size: 13px;
            letter-spacing: .03em;
            font-weight: 650;
        }

        /* Drawer (mobile/tablet) */
        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .18);
            display: none;
            z-index: 40;
        }

        .drawer {
            position: fixed;
            top: var(--topbar-h);
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--surface);
            z-index: 50;
            display: none;
            border-top: 1px solid var(--hairline);
        }

        .drawer-inner {
            max-width: var(--frame-max);
            margin: 0 auto;
            padding: 14px var(--gutter) 18px;
            height: 100%;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .drawer-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .drawer-title {
            margin: 0;
            font-size: 14px;
            color: var(--ink-2);
            font-weight: 650;
        }

        .closeBtn {
            font: inherit;
            font-size: 14px;
            padding: 8px 10px;
            border: 1px solid var(--hairline);
            border-radius: 10px;
            background: transparent;
            color: var(--ink-2);
            cursor: pointer;
        }

        .closeBtn:hover {
            text-decoration: underline;
        }

        .closeBtn:focus-visible {
            outline: 2px solid var(--focus);
            outline-offset: 2px;
        }

        .drawer-nav {
            overflow-y: auto;
            padding-right: 6px;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .drawer-nav::-webkit-scrollbar {
            display: none;
        }

        /* Responsive */
        @media (max-width: 980px) {
            :root {
                --nav-w: 110px;
                --col-gap: 28px;
            }
        }

        @media (max-width: 860px) {
            .columns {
                grid-template-columns: 1fr;
            }

            .nav-rail {
                display: none;
            }

            .jumpBtn {
                display: inline-flex;
            }

            .frame {
                padding-top: 14px;
            }

            .qtext {
                font-size: 16px;
            }

            .q-inner {
                margin-left: min(calc(var(--depth) * 12px), 28px);
            }
        }

        @media (prefers-reduced-motion: reduce) {
            html {
                scroll-behavior: auto !important;
            }

            .solution {
                transition: none !important;
            }
        }
    </style>
</head>

<body>
    <div class="topbar" role="banner">
        <div class="topbar-inner">
            <div class="topbar-title">RTQ – Paper View</div>

            <div class="controls" aria-label="Paper controls">
                <label for="paperSelect">Paper</label>
                <select id="paperSelect" aria-label="Paper selector"></select>
                <button class="jumpBtn" id="jumpBtn" type="button" aria-haspopup="dialog" aria-controls="navDrawer">Jump
                    to</button>
            </div>
        </div>
    </div>

    <div id="appShell">
        <div class="frame">
            <div class="columns">
                <nav aria-label="Paper navigation">
                    <div class="nav-rail">
                        <div class="nav-title">Jump</div>
                        <div class="nav-list" id="navList"></div>
                    </div>
                </nav>

                <main id="paper" tabindex="-1">
                    <!-- Injected -->
                </main>
            </div>
        </div>
    </div>

    <!-- Mobile drawer -->
    <div class="overlay" id="overlay" hidden></div>
    <div class="drawer" id="navDrawer" role="dialog" aria-modal="true" aria-labelledby="drawerTitle" hidden>
        <div class="drawer-inner">
            <div class="drawer-head">
                <h2 class="drawer-title" id="drawerTitle">Jump to</h2>
                <button class="closeBtn" id="closeDrawer" type="button">Close</button>
            </div>
            <div class="drawer-nav" id="drawerNav"></div>
        </div>
    </div>

    <!-- KaTeX JS (CDN) -->
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"
        integrity="sha384-0p0j1v2a1C2q7s3mZ3cVwKx6q9u3m2b1G3oZ1oB8bGZ9o8u0w3h2uQ4m1n2p3"
        crossorigin="anonymous"></script>

    <script>
        (function () {
            const prefersReducedMotion = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;

            // ---------- Diagram library (reused types) ----------
            function svgWrap(inner, viewBox = "0 0 300 180") {
                return `
          <svg viewBox="${viewBox}" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Diagram">
            <rect x="1" y="1" width="298" height="178" fill="none" stroke="rgba(0,0,0,.16)"/>
            ${inner}
          </svg>
        `;
            }

            function diagramGeometry() {
                const inner = `
          <circle cx="220" cy="60" r="28" fill="none" stroke="rgba(0,0,0,.35)" stroke-width="2"/>
          <path d="M50 145 L140 45 L235 145 Z" fill="none" stroke="rgba(0,0,0,.35)" stroke-width="2"/>
          <text x="46" y="160" font-size="12" fill="rgba(0,0,0,.5)">A</text>
          <text x="138" y="38" font-size="12" fill="rgba(0,0,0,.5)">B</text>
          <text x="238" y="160" font-size="12" fill="rgba(0,0,0,.5)">C</text>
          <line x1="50" y1="145" x2="235" y2="145" stroke="rgba(0,0,0,.25)" stroke-dasharray="4 4"/>
          <text x="120" y="172" font-size="12" fill="rgba(0,0,0,.5)">12 cm</text>
          <text x="90" y="95" font-size="12" fill="rgba(0,0,0,.5)">8 cm</text>
        `;
                return svgWrap(inner);
            }

            function diagramRatioBars() {
                const inner = `
          <text x="14" y="26" font-size="12" fill="rgba(0,0,0,.55)">Ratio bars</text>
          <rect x="20" y="50" width="240" height="24" fill="none" stroke="rgba(0,0,0,.35)"/>
          <rect x="20" y="82" width="200" height="24" fill="none" stroke="rgba(0,0,0,.35)"/>
          <line x1="20" y1="62" x2="260" y2="62" stroke="rgba(0,0,0,.18)" stroke-dasharray="4 4"/>
          ${[1, 2, 3, 4, 5, 6].map(i => `<line x1="${20 + i * 40}" y1="50" x2="${20 + i * 40}" y2="74" stroke="rgba(0,0,0,.25)"/>`).join("")}
          ${[1, 2, 3, 4, 5].map(i => `<line x1="${20 + i * 40}" y1="82" x2="${20 + i * 40}" y2="106" stroke="rgba(0,0,0,.25)"/>`).join("")}
          <text x="24" y="68" font-size="11" fill="rgba(0,0,0,.5)">A</text>
          <text x="24" y="100" font-size="11" fill="rgba(0,0,0,.5)">B</text>
        `;
                return svgWrap(inner);
            }

            function diagramCoordinateGrid() {
                const inner = `
          <text x="14" y="26" font-size="12" fill="rgba(0,0,0,.55)">Coordinate grid</text>
          <g transform="translate(28,36)">
            <rect x="0" y="0" width="244" height="124" fill="none" stroke="rgba(0,0,0,.25)"/>
            ${Array.from({ length: 12 }).map((_, i) => `<line x1="${i * 22.2}" y1="0" x2="${i * 22.2}" y2="124" stroke="rgba(0,0,0,.10)"/>`).join("")}
            ${Array.from({ length: 6 }).map((_, i) => `<line x1="0" y1="${i * 24.8}" x2="244" y2="${i * 24.8}" stroke="rgba(0,0,0,.10)"/>`).join("")}
            <line x1="0" y1="124" x2="244" y2="0" stroke="rgba(0,0,0,.35)" stroke-width="2"/>
            <circle cx="44" cy="80" r="3.5" fill="rgba(0,0,0,.45)"/>
            <circle cx="176" cy="32" r="3.5" fill="rgba(0,0,0,.45)"/>
            <text x="50" y="92" font-size="10" fill="rgba(0,0,0,.55)">(2,2)</text>
            <text x="182" y="44" font-size="10" fill="rgba(0,0,0,.55)">(8,4)</text>
          </g>
        `;
                return svgWrap(inner);
            }

            function diagramArrayGrid() {
                const inner = `
          <text x="14" y="26" font-size="12" fill="rgba(0,0,0,.55)">Array / table</text>
          <g transform="translate(26,44)">
            <rect x="0" y="0" width="248" height="110" fill="none" stroke="rgba(0,0,0,.35)"/>
            ${Array.from({ length: 4 }).map((_, i) => `<line x1="${i * 62}" y1="0" x2="${i * 62}" y2="110" stroke="rgba(0,0,0,.25)"/>`).join("")}
            ${Array.from({ length: 3 }).map((_, i) => `<line x1="0" y1="${i * 36.7}" x2="248" y2="${i * 36.7}" stroke="rgba(0,0,0,.25)"/>`).join("")}
            <text x="10" y="24" font-size="11" fill="rgba(0,0,0,.55)">A</text>
            <text x="72" y="24" font-size="11" fill="rgba(0,0,0,.55)">B</text>
            <text x="134" y="24" font-size="11" fill="rgba(0,0,0,.55)">C</text>
            <text x="196" y="24" font-size="11" fill="rgba(0,0,0,.55)">D</text>
          </g>
        `;
                return svgWrap(inner);
            }

            function renderDiagram(type) {
                switch (type) {
                    case "geometry": return diagramGeometry();
                    case "ratio": return diagramRatioBars();
                    case "grid": return diagramCoordinateGrid();
                    case "array": return diagramArrayGrid();
                    default: return diagramArrayGrid();
                }
            }

            // ---------- Content helpers (inline + block math) ----------
            const mi = (tex) => `<span class="math math-inline" data-display="false" data-tex="${escapeAttr(tex)}"></span>`;
            const mb = (tex) => `<div class="math-block"><div class="math" data-display="true" data-tex="${escapeAttr(tex)}"></div></div>`;

            function escapeAttr(s) {
                return String(s)
                    .replaceAll("&", "&amp;")
                    .replaceAll('"', "&quot;")
                    .replaceAll("<", "&lt;")
                    .replaceAll(">", "&gt;");
            }
            function escapeHTML(s) {
                return String(s)
                    .replaceAll("&", "&amp;")
                    .replaceAll("<", "&lt;")
                    .replaceAll(">", "&gt;");
            }

            // ---------- Dataset generators ----------
            function longWorkingLines(seed) {
                // 55–60 display lines (extremely long workings)
                const out = [];
                for (let i = 1; i <= 58; i++) {
                    out.push(String.raw`\begin{aligned}
${seed}_{${i + 1}} &= ${seed}_{${i}} + 2i \\
${seed}_{${i + 1}} &= ${seed}_{1} + \sum_{k=1}^{i} 2k \\
${seed}_{${i + 1}} &= ${seed}_{1} + i(i+1)
\end{aligned}`);
                }
                return out;
            }

            function qObj({ id, depth = 0, promptHTML, diagrams = [], answersHTML, details, defaultExpanded = false }) {
                return { id, depth, promptHTML, diagrams, answersHTML, details, defaultExpanded };
            }

            function makeShortPaper() {
                const name = "Short paper";
                const subtitle = "6 questions • mix of quick checks and one multi-part question";
                const qs = [
                    qObj({
                        id: "1",
                        promptHTML: `<p>Work out ${mi(String.raw`48 \div 6`)}.</p>`,
                        answersHTML: `${mi("8")}`,
                        details: {
                            guidance: ["Keep the steps small and tidy."],
                            formulas: [],
                            working: [
                                String.raw`\begin{aligned}
48 \div 6 &= 8
\end{aligned}`
                            ],
                            alt: []
                        }
                    }),
                    qObj({
                        id: "2",
                        promptHTML: `<p>Find ${mi(String.raw`\frac{3}{4}+\frac{5}{8}`)}.</p>`,
                        answersHTML: `${mi(String.raw`\frac{11}{8}`)} (or ${mi(String.raw`1\frac{3}{8}`)})`,
                        details: {
                            guidance: ["Use a common denominator."],
                            formulas: [String.raw`\frac{a}{b}+\frac{c}{d}=\frac{ad+bc}{bd}`],
                            working: [
                                String.raw`\begin{aligned}
\frac{3}{4}+\frac{5}{8} &= \frac{6}{8}+\frac{5}{8} \\
&= \frac{11}{8} \\
&= 1\frac{3}{8}
\end{aligned}`
                            ],
                            alt: [
                                {
                                    text: "Convert to decimals, then add.",
                                    lines: [String.raw`\begin{aligned}
\frac{3}{4} &= 0.75 \\
\frac{5}{8} &= 0.625 \\
0.75 + 0.625 &= 1.375
\end{aligned}`]
                                }
                            ]
                        }
                    }),
                    qObj({
                        id: "3",
                        promptHTML: `<p>A bus leaves at 09:35 and the journey lasts 1 hour 48 minutes. What time does it arrive?</p>`,
                        answersHTML: `11:23`,
                        details: {
                            guidance: ["Add hours first, then minutes."],
                            formulas: [],
                            working: [
                                String.raw`\begin{aligned}
09{:}35 + 1\text{ h} &= 10{:}35 \\
10{:}35 + 48\text{ min} &= 11{:}23
\end{aligned}`
                            ],
                            alt: []
                        }
                    }),
                    qObj({
                        id: "4",
                        promptHTML: `<p>A rectangle has length ${mi("12")} cm and width ${mi("7")} cm.</p>
                         <p>(a) Find its perimeter. (b) Find its area.</p>`,
                        answersHTML: `<ul><li>(a) ${mi("38")} cm</li><li>(b) ${mi("84")} cm${mi("^2")}</li></ul>`,
                        details: {
                            guidance: ["Perimeter adds all sides. Area is length × width."],
                            formulas: [String.raw`P = 2(l+w)`, String.raw`A = lw`],
                            working: [
                                String.raw`\begin{aligned}
P &= 2(12+7) \\
  &= 2 \times 19 \\
  &= 38\text{ cm}
\end{aligned}`,
                                String.raw`\begin{aligned}
A &= 12 \times 7 \\
  &= 84\text{ cm}^2
\end{aligned}`
                            ],
                            alt: []
                        }
                    }),
                    qObj({
                        id: "5",
                        promptHTML: `<p>Solve ${mi("x^2=9")}. Give all solutions.</p>`,
                        answersHTML: `<ul><li>${mi("x=3")}</li><li>${mi("x=-3")}</li></ul>`,
                        details: {
                            guidance: ["Square roots can be positive or negative."],
                            formulas: [],
                            working: [
                                String.raw`\begin{aligned}
x^2 &= 9 \\
x &= \pm \sqrt{9} \\
x &= \pm 3
\end{aligned}`
                            ],
                            alt: []
                        }
                    }),
                    qObj({
                        id: "6",
                        promptHTML: `<p>In a bag, the ratio of red to blue counters is ${mi("3:5")}. There are ${mi("40")} counters in total. How many are red?</p>`,
                        diagrams: ["ratio"],
                        answersHTML: `${mi("15")}`,
                        details: {
                            guidance: ["Add the parts to find the total number of equal parts."],
                            formulas: [],
                            working: [
                                String.raw`\begin{aligned}
\text{Total parts} &= 3+5 = 8 \\
\text{One part} &= \frac{40}{8} = 5 \\
\text{Red} &= 3 \times 5 = 15
\end{aligned}`
                            ],
                            alt: []
                        }
                    })
                ];
                return { key: "short", name, subtitle, sections: [{ label: null, questions: qs }] };
            }

            function makeStandardPaper({ expandedVariant = false } = {}) {
                const name = expandedVariant ? "Standard (Workings Expanded)" : "Standard paper";
                const subtitle = expandedVariant
                    ? "35 questions • long algebra at the end • all Solution Details expanded (stress test dataset)"
                    : "35 questions • Q26–Q35 include long algebra (collapsed by default)";

                const qs = [];

                // Q1–Q10 small/medium mixed
                qs.push(qObj({
                    id: "1",
                    promptHTML: `<p>Work out ${mi("7\\times 18")}.</p>`,
                    answersHTML: `${mi("126")}`,
                    details: {
                        guidance: [], formulas: [], working: [String.raw`\begin{aligned}
7\times 18 &= 7\times (20-2) \\
&= 140 - 14 \\
&= 126
\end{aligned}`], alt: []
                    },
                    defaultExpanded: expandedVariant
                }));

                qs.push(qObj({
                    id: "2",
                    promptHTML: `<p>Write ${mi("0.375")} as a fraction in its simplest form.</p>`,
                    answersHTML: `${mi(String.raw`\frac{3}{8}`)}`,
                    details: {
                        guidance: ["Turn the decimal into a fraction, then simplify."], formulas: [],
                        working: [String.raw`\begin{aligned}
0.375 &= \frac{375}{1000} \\
&= \frac{3\times 125}{8\times 125} \\
&= \frac{3}{8}
\end{aligned}`],
                        alt: [{
                            text: "Use place value: 0.375 is 375 thousandths.", lines: [String.raw`\begin{aligned}
\frac{375}{1000} &= \frac{3}{8}
\end{aligned}`]
                        }]
                    },
                    defaultExpanded: expandedVariant
                }));

                qs.push(qObj({
                    id: "3",
                    promptHTML: `<p>A book costs £${mi("9.60")}. It is reduced by ${mi("15\\%")}. What is the new price?</p>`,
                    answersHTML: `£${mi("8.16")}`,
                    details: {
                        guidance: ["Find 15% of the price, then subtract."],
                        formulas: [String.raw`\text{percentage}=\frac{\text{part}}{\text{whole}}\times 100\%`],
                        working: [String.raw`\begin{aligned}
15\% \text{ of } 9.60 &= 0.15 \times 9.60 = 1.44 \\
\text{New price} &= 9.60 - 1.44 = 8.16
\end{aligned}`],
                        alt: [{
                            text: "Find 85% directly.", lines: [String.raw`\begin{aligned}
85\% \text{ of } 9.60 &= 0.85 \times 9.60 = 8.16
\end{aligned}`]
                        }]
                    },
                    defaultExpanded: expandedVariant
                }));

                qs.push(qObj({
                    id: "4",
                    promptHTML: `<p>The diagram shows a line on a coordinate grid.</p><p>Find the gradient of the line.</p>`,
                    diagrams: ["grid"],
                    answersHTML: `${mi(" -1")}`,
                    details: {
                        guidance: ["Use two clear points on the line."],
                        formulas: [String.raw`m=\frac{y_2-y_1}{x_2-x_1}`],
                        working: [String.raw`\begin{aligned}
m &= \frac{4-2}{8-2} = \frac{2}{6} = \frac{1}{3}
\end{aligned}`, String.raw`\begin{aligned}
\text{But the line slopes downward, so } m &= -\frac{1}{3}
\end{aligned}`],
                        alt: []
                    },
                    defaultExpanded: expandedVariant
                }));

                qs.push(qObj({
                    id: "5",
                    promptHTML: `<p>Simplify ${mi(String.raw`6a - 2(3a - 5)`)}.</p>`,
                    answersHTML: `${mi("10")}`,
                    details: {
                        guidance: ["Expand the bracket first."], formulas: [],
                        working: [String.raw`\begin{aligned}
6a - 2(3a-5) &= 6a - (6a - 10) \\
&= 6a - 6a + 10 \\
&= 10
\end{aligned}`],
                        alt: []
                    },
                    defaultExpanded: expandedVariant
                }));

                qs.push(qObj({
                    id: "6",
                    promptHTML: `<p>A tank holds ${mi("2.4")} litres of water. It is poured equally into ${mi("6")} cups. How much is in each cup?</p>`,
                    answersHTML: `${mi("0.4")} litres`,
                    details: {
                        guidance: ["Divide the total by the number of cups."], formulas: [],
                        working: [String.raw`\begin{aligned}
2.4 \div 6 &= 0.4
\end{aligned}`],
                        alt: []
                    },
                    defaultExpanded: expandedVariant
                }));

                qs.push(qObj({
                    id: "7",
                    promptHTML: `<p>Find the missing number: ${mi("3")}·${mi("\\square")} = ${mi("87")}.</p>`,
                    answersHTML: `${mi("29")}`,
                    details: {
                        guidance: ["Undo multiplication with division."], formulas: [],
                        working: [String.raw`\begin{aligned}
3\times x &= 87 \\
x &= 87 \div 3 = 29
\end{aligned}`], alt: []
                    },
                    defaultExpanded: expandedVariant
                }));

                qs.push(qObj({
                    id: "8",
                    promptHTML: `<p>Here is a triangle with a circle drawn beside it.</p><p>Work out the area of the triangle.</p>`,
                    diagrams: ["geometry"],
                    answersHTML: `${mi("48")} cm${mi("^2")}`,
                    details: {
                        guidance: ["Area of a triangle is half base × height."],
                        formulas: [String.raw`A=\frac{1}{2}bh`],
                        working: [String.raw`\begin{aligned}
A &= \frac{1}{2}\times 12 \times 8 \\
  &= 48
\end{aligned}`],
                        alt: []
                    },
                    defaultExpanded: expandedVariant
                }));

                qs.push(qObj({
                    id: "9",
                    promptHTML: `<p>Work out ${mi(String.raw`(5^3 - 2^3)\div 3`)}.</p>`,
                    answersHTML: `${mi("39")}`,
                    details: {
                        guidance: ["Deal with powers, then brackets, then division."],
                        formulas: [],
                        working: [String.raw`\begin{aligned}
(5^3-2^3)\div 3 &= (125-8)\div 3 \\
&= 117 \div 3 \\
&= 39
\end{aligned}`],
                        alt: []
                    },
                    defaultExpanded: expandedVariant
                }));

                qs.push(qObj({
                    id: "10",
                    promptHTML: `<p>A recipe uses flour and sugar in the ratio ${mi("4:1")}. If there are ${mi("300")} g of flour, how much sugar is needed?</p>`,
                    diagrams: ["ratio"],
                    answersHTML: `${mi("75")} g`,
                    details: {
                        guidance: ["Match the ratio parts to the known amount."], formulas: [],
                        working: [String.raw`\begin{aligned}
4 \text{ parts} &= 300 \\
1 \text{ part} &= 300 \div 4 = 75
\end{aligned}`],
                        alt: []
                    },
                    defaultExpanded: expandedVariant
                }));

                // Deep nesting exemplar-style: Q18(a)(i), Q18(a)(ii), Q18(b)
                qs.push(qObj({
                    id: "18",
                    promptHTML: `<p>Two friends share the cost of a cinema trip. Their calculations are shown below.</p>
                      <p>Use the information to answer the parts.</p>`,
                    answersHTML: `(See parts)`,
                    details: {
                        guidance: ["Read each part carefully: each part is its own question."], formulas: [],
                        working: [String.raw`\begin{aligned}
\text{Tickets and snacks are calculated separately in the parts below.}
\end{aligned}`],
                        alt: []
                    },
                    defaultExpanded: expandedVariant
                }));
                qs.push(qObj({
                    id: "18(a)(i)",
                    depth: 1,
                    promptHTML: `<p>Tickets cost £${mi("7.50")} each. They buy ${mi("2")} tickets. What is the total ticket cost?</p>`,
                    answersHTML: `£${mi("15")}`,
                    details: {
                        guidance: [], formulas: [],
                        working: [String.raw`\begin{aligned}
2 \times 7.50 &= 15.00
\end{aligned}`],
                        alt: []
                    },
                    defaultExpanded: expandedVariant
                }));
                qs.push(qObj({
                    id: "18(a)(ii)",
                    depth: 1,
                    promptHTML: `<p>They pay with £${mi("20")}. How much change do they get?</p>`,
                    answersHTML: `£${mi("5")}`,
                    details: {
                        guidance: ["Subtract the total cost from the amount paid."], formulas: [],
                        working: [String.raw`\begin{aligned}
20 - 15 &= 5
\end{aligned}`],
                        alt: []
                    },
                    defaultExpanded: expandedVariant
                }));
                qs.push(qObj({
                    id: "18(b)",
                    depth: 1,
                    promptHTML: `<p>One person buys popcorn for £${mi("3.60")} and a drink for £${mi("2.40")}. What is the total?</p>`,
                    answersHTML: `£${mi("6")}`,
                    details: {
                        guidance: [], formulas: [],
                        working: [String.raw`\begin{aligned}
3.60 + 2.40 &= 6.00
\end{aligned}`],
                        alt: []
                    },
                    defaultExpanded: expandedVariant
                }));

                // Fill Q11–Q25 (light/medium), with some solution-detail variants
                const fillers = [
                    ["11", `<p>Round ${mi("6.748")} to ${mi("2")} decimal places.</p>`, `${mi("6.75")}`,
                        {
                            guidance: ["Look at the third decimal place."], formulas: [], working: [String.raw`\begin{aligned}
6.748 \approx 6.75
\end{aligned}`], alt: []
                        }
                    ],
                    ["12", `<p>A train journey is ${mi("195")} km. The train travels at ${mi("65")} km/h. How long does the journey take?</p>`, `${mi("3")} hours`,
                        {
                            guidance: ["Time = distance ÷ speed."], formulas: [String.raw`t=\frac{d}{v}`], working: [String.raw`\begin{aligned}
t &= \frac{195}{65} = 3
\end{aligned}`], alt: []
                        }
                    ],
                    ["13", `<p>Find ${mi("20\\%")} of ${mi("360")}.</p>`, `${mi("72")}`,
                        {
                            guidance: [], formulas: [String.raw`p\% \text{ of } n = \frac{p}{100}n`], working: [String.raw`\begin{aligned}
20\% \text{ of } 360 &= 0.2 \times 360 \\
&= 72
\end{aligned}`], alt: []
                        }
                    ],
                    ["14", `<p>Solve ${mi("4x+7=31")}.</p>`, `${mi("6")}`,
                        {
                            guidance: ["Undo +7, then undo ×4."], formulas: [], working: [String.raw`\begin{aligned}
4x+7 &= 31 \\
4x &= 24 \\
x &= 6
\end{aligned}`], alt: []
                        }
                    ],
                    ["15", `<p>A square has perimeter ${mi("52")} cm. What is the length of one side?</p>`, `${mi("13")} cm`,
                        {
                            guidance: ["All sides are equal in a square."], formulas: [String.raw`P=4s`], working: [String.raw`\begin{aligned}
4s &= 52 \\
s &= 13
\end{aligned}`], alt: []
                        }
                    ],
                    ["16", `<p>Work out ${mi(String.raw`\frac{5}{6} - \frac{1}{4}`)}.</p>`, `${mi(String.raw`\frac{7}{12}`)}`,
                        {
                            guidance: ["Use a common denominator."], formulas: [], working: [String.raw`\begin{aligned}
\frac{5}{6}-\frac{1}{4} &= \frac{10}{12}-\frac{3}{12} \\
&= \frac{7}{12}
\end{aligned}`], alt: []
                        }
                    ],
                    ["17", `<p>A number is multiplied by ${mi("9")} then decreased by ${mi("4")} to give ${mi("50")}. Find the number.</p>`, `${mi("6")}`,
                        {
                            guidance: ["Write an equation, then solve."], formulas: [], working: [String.raw`\begin{aligned}
9x - 4 &= 50 \\
9x &= 54 \\
x &= 6
\end{aligned}`], alt: []
                        }
                    ],
                    ["19", `<p>The mean of ${mi("5")}, ${mi("8")}, ${mi("x")} is ${mi("7")}. Find ${mi("x")}.</p>`, `${mi("8")}`,
                        {
                            guidance: ["Mean = total ÷ number of values."], formulas: [String.raw`\text{mean}=\frac{\text{sum}}{n}`],
                            working: [String.raw`\begin{aligned}
\frac{5+8+x}{3} &= 7 \\
13+x &= 21 \\
x &= 8
\end{aligned}`], alt: []
                        }
                    ],
                    ["20", `<p>Here is a 4×3 grid. How many small squares are there?</p>`, `${mi("12")}`,
                        {
                            guidance: [], formulas: [], working: [String.raw`\begin{aligned}
4 \times 3 &= 12
\end{aligned}`], alt: []
                        }
                    ],
                    ["21", `<p>Write ${mi(String.raw`3.2\times 10^3`)} as an ordinary number.</p>`, `${mi("3200")}`,
                        {
                            guidance: ["Move the decimal point 3 places to the right."], formulas: [],
                            working: [String.raw`\begin{aligned}
3.2\times 10^3 &= 3.2 \times 1000 = 3200
\end{aligned}`], alt: []
                        }
                    ],
                    ["22", `<p>A spinner has ${mi("8")} equal sections. ${mi("3")} are shaded. What is the probability of landing on a shaded section?</p>`, `${mi(String.raw`\frac{3}{8}`)}`,
                        {
                            guidance: ["Probability = favourable ÷ total."], formulas: [String.raw`P=\frac{\text{favourable}}{\text{total}}`],
                            working: [String.raw`\begin{aligned}
P &= \frac{3}{8}
\end{aligned}`], alt: []
                        }
                    ],
                    ["23", `<p>Calculate the value of ${mi(String.raw`2x^2`)} when ${mi("x=-4")}.</p>`, `${mi("32")}`,
                        {
                            guidance: ["Square first, then multiply."], formulas: [],
                            working: [String.raw`\begin{aligned}
2x^2 &= 2(-4)^2 \\
&= 2\times 16 \\
&= 32
\end{aligned}`], alt: []
                        }
                    ],
                    ["24", `<p>In a class of ${mi("28")} students, ${mi("7")} walk to school. What percentage walk to school?</p>`, `${mi("25\\%")}`,
                        {
                            guidance: ["Find the fraction, then convert to a percentage."],
                            formulas: [String.raw`\text{Percentage}=\frac{\text{part}}{\text{whole}}\times 100\%`],
                            working: [String.raw`\begin{aligned}
\frac{7}{28}\times 100\% &= \frac{1}{4}\times 100\% = 25\%
\end{aligned}`],
                            alt: []
                        }
                    ],
                    ["25", `<p>Complete the table of values for ${mi("y=2x-1")} when ${mi("x=0,1,2")}.</p>`,
                        `<ul><li>${mi("x=0")}, ${mi("y=-1")}</li><li>${mi("x=1")}, ${mi("y=1")}</li><li>${mi("x=2")}, ${mi("y=3")}</li></ul>`,
                        {
                            guidance: [], formulas: [], working: [String.raw`\begin{aligned}
y &= 2x-1 \\
x=0 &\Rightarrow y=-1 \\
x=1 &\Rightarrow y=1 \\
x=2 &\Rightarrow y=3
\end{aligned}`], alt: []
                        }
                    ],
                ];

                // Insert fillers in order among existing qs (we already have 1–10, then 18 etc).
                const existingIds = new Set(qs.map(q => q.id));
                for (const [id, prompt, ans, det] of fillers) {
                    if (!existingIds.has(id)) {
                        qs.push(qObj({ id, promptHTML: prompt, answersHTML: ans, details: det, defaultExpanded: expandedVariant }));
                    }
                }

                // Q26–Q35 long algebra (collapsed by default unless expanded dataset)
                for (let n = 26; n <= 35; n++) {
                    const id = String(n);
                    const isVeryLong = (n === 33 || n === 35);
                    const hasAlt = (n === 27 || n === 30 || n === 34);
                    const hasGuidance = (n === 26 || n === 29 || n === 33);
                    const hasFormulas = (n === 28 || n === 30 || n === 34);

                    let promptHTML = `<p>Solve the equation ${mi(String.raw`(x-${n - 20})^2 = ${(n - 24) * (n - 24)}`)}.</p>`;
                    if (n === 30) {
                        promptHTML = `<p>A sequence is defined by ${mi(String.raw`u_{n+1}=u_n+3`)} with ${mi(String.raw`u_1=5`)}.</p>
                          <p>(a) Find ${mi("u_6")}. (b) Write a formula for ${mi("u_n")}.</p>`;
                    }
                    if (n === 34) {
                        promptHTML = `<p>On a planet, a “clink” is worth a fixed number of “tinks”.</p>
                          <p>An addition is correct: ${mi("2")} clinks ${mi("+")} ${mi("4")} tinks ${mi("=")} ${mi("3")} clinks ${mi("+")} ${mi("1")} tink.</p>
                          <p>How many tinks make one clink?</p>`;
                        // diagram-like table placeholder
                        // keep as text-only; diagram not required
                    }

                    let answersHTML = `${mi(String.raw`x = ${(n - 20) + (n - 24)}`)} or ${mi(String.raw`x = ${(n - 20) - (n - 24)}`)}`;
                    if (n === 30) {
                        answersHTML = `<ul>
              <li>(a) ${mi("u_6=20")}</li>
              <li>(b) ${mi(String.raw`u_n = 3n + 2`)}</li>
            </ul>`;
                    }
                    if (n === 34) {
                        answersHTML = `${mi("3")} tinks`;
                    }

                    const working = [];
                    if (n !== 30 && n !== 34) {
                        working.push(String.raw`\begin{aligned}
(x-${n - 20})^2 &= ${(n - 24) * (n - 24)} \\
x-${n - 20} &= \pm ${n - 24} \\
x &= ${n - 20} \pm ${n - 24}
\end{aligned}`);
                        working.push(String.raw`\begin{aligned}
x &= ${(n - 20) + (n - 24)} \quad \text{or}\quad x = ${(n - 20) - (n - 24)}
\end{aligned}`);
                        // extra blocks for long content
                        working.push(String.raw`\begin{aligned}
\text{Check: } (x-${n - 20})^2 &= ${(n - 24) * (n - 24)} \\
\text{Both values satisfy the equation.}
\end{aligned}`);
                    } else if (n === 30) {
                        working.push(String.raw`\begin{aligned}
u_{n+1} &= u_n + 3 \\
u_1 &= 5
\end{aligned}`);
                        working.push(String.raw`\begin{aligned}
u_2 &= 5+3 = 8 \\
u_3 &= 8+3 = 11 \\
u_4 &= 11+3 = 14 \\
u_5 &= 14+3 = 17 \\
u_6 &= 17+3 = 20
\end{aligned}`);
                        working.push(String.raw`\begin{aligned}
\text{This is an arithmetic sequence with } d=3. \\
u_n &= u_1 + (n-1)d \\
&= 5 + (n-1)\times 3 \\
&= 3n + 2
\end{aligned}`);
                    } else if (n === 34) {
                        working.push(String.raw`\begin{aligned}
\text{Let } 1\text{ clink} &= c\text{ tinks} \\
2\text{ clinks} + 4\text{ tinks} &= 3\text{ clinks} + 1\text{ tink}
\end{aligned}`);
                        working.push(String.raw`\begin{aligned}
2c + 4 &= 3c + 1 \\
4-1 &= 3c - 2c \\
c &= 3
\end{aligned}`);
                    }

                    if (isVeryLong) {
                        // add multiple display blocks (long/very long)
                        const seed = n === 33 ? "a" : "b";
                        const lines = longWorkingLines(seed);
                        for (const block of lines) {
                            working.push(block);
                        }
                    }

                    const alt = [];
                    if (hasAlt) {
                        if (n === 27) {
                            alt.push({
                                text: "Expand and solve by collecting terms.",
                                lines: [
                                    String.raw`\begin{aligned}
(x-7)^2 &= 9 \\
x^2 - 14x + 49 &= 9 \\
x^2 - 14x + 40 &= 0 \\
(x-10)(x-4) &= 0 \\
x &= 10 \text{ or } x=4
\end{aligned}`
                                ]
                            });
                        } else if (n === 30) {
                            alt.push({
                                text: "Use a table, then spot the pattern.",
                                lines: [
                                    String.raw`\begin{aligned}
n: &\ 1,\ 2,\ 3,\ 4,\ 5,\ 6 \\
u_n: &\ 5,\ 8,\ 11,\ 14,\ 17,\ 20
\end{aligned}`,
                                    String.raw`\begin{aligned}
u_n &= 3n+2
\end{aligned}`
                                ]
                            });
                        } else if (n === 34) {
                            alt.push({
                                text: "Move clinks to one side and tinks to the other.",
                                lines: [
                                    String.raw`\begin{aligned}
2c + 4 &= 3c + 1 \\
4-1 &= c \\
c &= 3
\end{aligned}`
                                ]
                            });
                        }
                    }

                    const details = {
                        guidance: hasGuidance ? [
                            "Keep the structure clear: one step per line.",
                            "If you use ±, write both answers clearly."
                        ] : [],
                        formulas: hasFormulas ? [
                            String.raw`u_n = u_1 + (n-1)d`,
                            String.raw`(x-a)^2 = k \Rightarrow x-a = \pm\sqrt{k}`
                        ] : [],
                        working,
                        alt
                    };

                    qs.push(qObj({
                        id,
                        promptHTML,
                        answersHTML,
                        details,
                        defaultExpanded: expandedVariant ? true : false
                    }));
                }

                // Ensure Q18 already present; ensure ordering by numeric-ish with nesting (we'll sort later)
                // Add another deep nesting set around Q30 as required add-on (Q30(a)(i) etc)
                qs.push(qObj({
                    id: "30(a)(i)",
                    depth: 1,
                    promptHTML: `<p>Given ${mi(String.raw`u_{n+1}=u_n+3`)} and ${mi("u_1=5")}, write down ${mi("u_2")}.</p>`,
                    answersHTML: `${mi("8")}`,
                    details: {
                        guidance: [], formulas: [], working: [String.raw`\begin{aligned}
u_2 &= u_1 + 3 = 5 + 3 = 8
\end{aligned}`], alt: []
                    },
                    defaultExpanded: expandedVariant
                }));
                qs.push(qObj({
                    id: "30(a)(ii)",
                    depth: 1,
                    promptHTML: `<p>Write down ${mi("u_3")}.</p>`,
                    answersHTML: `${mi("11")}`,
                    details: {
                        guidance: [], formulas: [], working: [String.raw`\begin{aligned}
u_3 &= u_2 + 3 = 8 + 3 = 11
\end{aligned}`], alt: []
                    },
                    defaultExpanded: expandedVariant
                }));
                qs.push(qObj({
                    id: "30(b)",
                    depth: 1,
                    promptHTML: `<p>Explain why the sequence is arithmetic.</p>`,
                    answersHTML: `Because the difference is always ${mi("3")}.`,
                    details: {
                        guidance: ["Look for the same change each time."], formulas: [],
                        working: [String.raw`\begin{aligned}
u_{n+1}-u_n &= 3 \quad \text{for all } n
\end{aligned}`],
                        alt: []
                    },
                    defaultExpanded: expandedVariant
                }));

                return { key: expandedVariant ? "standard_expanded" : "standard", name, subtitle, sections: [{ label: null, questions: qs }] };
            }

            function makeDiagramHeavyPaper() {
                const name = "Diagram-heavy paper";
                const subtitle = "20 questions • 8 include diagrams (inline SVG placeholders)";
                const qs = [];

                const diagramIds = new Set(["1", "3", "5", "7", "9", "12", "15", "18"]);

                for (let i = 1; i <= 20; i++) {
                    const id = String(i);
                    const withDiagram = diagramIds.has(id);
                    const diagType = i % 4 === 1 ? "geometry" : i % 4 === 3 ? "ratio" : i % 4 === 0 ? "grid" : "array";

                    const prompt = withDiagram
                        ? `<p>Use the diagram to answer the question.</p><p>Work out the value requested.</p>`
                        : `<p>Work out ${mi(String.raw`${i + 6} + ${i * 3}`)}.</p>`;

                    const ans = withDiagram
                        ? `${mi(String.raw`${(i * 7) % 29 + 6}`)}`
                        : `${mi(String.raw`${(i + 6) + (i * 3)}`)}`;

                    const details = withDiagram
                        ? {
                            guidance: ["Use the labels and units shown."],
                            formulas: i % 4 === 1 ? [String.raw`A=\frac{1}{2}bh`] : [],
                            working: [
                                String.raw`\begin{aligned}
\text{Work carefully from the diagram.} \\
\text{Substitute values, then simplify.}
\end{aligned}`,
                                String.raw`\begin{aligned}
\text{Answer} &= ${(i * 7) % 29 + 6}
\end{aligned}`
                            ],
                            alt: i === 15 ? [{
                                text: "Alternative method: compare equal parts.",
                                lines: [String.raw`\begin{aligned}
\text{Equal parts} \Rightarrow \text{same scale factor.}
\end{aligned}`]
                            }] : []
                        }
                        : {
                            guidance: [],
                            formulas: [],
                            working: [String.raw`\begin{aligned}
${i + 6}+${i * 3} &= ${(i + 6) + (i * 3)}
\end{aligned}`],
                            alt: []
                        };

                    qs.push(qObj({
                        id,
                        promptHTML: `<p>${prompt}</p>`.replaceAll("<p><p>", "<p>").replaceAll("</p></p>", "</p>"),
                        diagrams: withDiagram ? [diagType] : [],
                        answersHTML: ans,
                        details
                    }));
                }

                // Add one question with multiple valid answers
                qs.push(qObj({
                    id: "20(a)",
                    depth: 1,
                    promptHTML: `<p>Solve ${mi("y^2=16")}. Give all solutions.</p>`,
                    answersHTML: `<ul><li>${mi("y=4")}</li><li>${mi("y=-4")}</li></ul>`,
                    details: {
                        guidance: ["Remember both square roots."],
                        formulas: [],
                        working: [String.raw`\begin{aligned}
y &= \pm \sqrt{16} \\
y &= \pm 4
\end{aligned}`],
                        alt: []
                    }
                }));

                return { key: "diagram", name, subtitle, sections: [{ label: null, questions: qs }] };
            }

            function makeSectionedPaper() {
                const name = "Sectioned paper";
                const subtitle = "Section A: 35 • Section B: 8 • Section C: 6 (very long Solution Details, collapsed by default)";
                const sectionA = makeStandardPaper({ expandedVariant: false }).sections[0].questions
                    .filter(q => !String(q.id).startsWith("30(") && !String(q.id).startsWith("30(a)") && !String(q.id).startsWith("30(b)"))
                    .slice(0, 35)
                    .map(q => ({ ...q, defaultExpanded: false }));

                // Section B (8 medium)
                const sectionB = [];
                for (let i = 1; i <= 8; i++) {
                    const id = String(i);
                    sectionB.push(qObj({
                        id: id,
                        promptHTML: `<p>A rectangle has area ${mi(String.raw`${24 + i}`)} cm${mi("^2")} and one side is ${mi(String.raw`${3 + i}`)} cm. Find the other side.</p>`,
                        answersHTML: `${mi(String.raw`\frac{${24 + i}}{${3 + i}}`)}`,
                        details: {
                            guidance: ["Area = length × width, so divide to find the missing side."],
                            formulas: [String.raw`A = lw`],
                            working: [String.raw`\begin{aligned}
w &= \frac{A}{l} = \frac{${24 + i}}{${3 + i}}
\end{aligned}`],
                            alt: []
                        }
                    }));
                }

                // Section C (6 very long Solution Details)
                const sectionC = [];
                for (let i = 1; i <= 6; i++) {
                    const id = String(i);
                    const veryLong = (i === 2 || i === 5);
                    const promptHTML = `<p>Show that ${mi(String.raw`(n+${i})^2 - (n-${i})^2 = ${4 * i}n`)}.</p>`;
                    const detailsWorking = [
                        String.raw`\begin{aligned}
(n+${i})^2 - (n-${i})^2 &= (n^2 + ${2 * i}n + ${i * i}) - (n^2 - ${2 * i}n + ${i * i}) \\
&= n^2 + ${2 * i}n + ${i * i} - n^2 + ${2 * i}n - ${i * i} \\
&= ${4 * i}n
\end{aligned}`
                    ];

                    if (veryLong) {
                        for (const b of longWorkingLines("t")) {
                            detailsWorking.push(b);
                        }
                    } else {
                        // still long-ish: multiple blocks
                        detailsWorking.push(String.raw`\begin{aligned}
\text{This identity holds for all } n.
\end{aligned}`);
                        detailsWorking.push(String.raw`\begin{aligned}
\text{Check with } n=10: \\
(10+${i})^2 - (10-${i})^2 &= ${(10 + i) * (10 + i)} - ${(10 - i) * (10 - i)} \\
&= ${(10 + i) * (10 + i) - (10 - i) * (10 - i)} \\
&= ${4 * i * 10}
\end{aligned}`);
                    }

                    sectionC.push(qObj({
                        id,
                        promptHTML,
                        answersHTML: `${mi(String.raw`${4 * i}n`)}`,
                        details: {
                            guidance: i === 1 ? ["Expand both brackets carefully. Keep like terms together."] : [],
                            formulas: i === 1 ? [String.raw`(a+b)^2 = a^2 + 2ab + b^2`, String.raw`(a-b)^2 = a^2 - 2ab + b^2`] : [],
                            working: detailsWorking,
                            alt: i === 3 ? [{
                                text: "Alternative working: use the difference of squares idea after factoring.",
                                lines: [String.raw`\begin{aligned}
(n+${i})^2 - (n-${i})^2 &= \big((n+${i})-(n-${i})\big)\big((n+${i})+(n-${i})\big) \\
&= (2${i})(2n) \\
&= ${4 * i}n
\end{aligned}`]
                            }] : []
                        },
                        defaultExpanded: false
                    }));
                }

                return {
                    key: "sectioned",
                    name,
                    subtitle,
                    sections: [
                        { label: "A", questions: sectionA },
                        { label: "B", questions: sectionB },
                        { label: "C", questions: sectionC },
                    ]
                };
            }

            // ---------- Build datasets ----------
            const DATASETS = [
                makeShortPaper(),
                makeStandardPaper({ expandedVariant: false }),
                makeDiagramHeavyPaper(),
                makeSectionedPaper(),
                makeStandardPaper({ expandedVariant: true })
            ];

            // ---------- UI elements ----------
            const paperSelect = document.getElementById("paperSelect");
            const navList = document.getElementById("navList");
            const drawerNav = document.getElementById("drawerNav");
            const paperMain = document.getElementById("paper");

            const overlay = document.getElementById("overlay");
            const drawer = document.getElementById("navDrawer");
            const jumpBtn = document.getElementById("jumpBtn");
            const closeDrawer = document.getElementById("closeDrawer");
            const appShell = document.getElementById("appShell");

            let currentDatasetKey = DATASETS[0].key;
            let currentObserver = null;
            let questionEls = [];
            let navButtons = new Map();

            // ---------- Populate selector ----------
            for (const ds of DATASETS) {
                const opt = document.createElement("option");
                opt.value = ds.key;
                opt.textContent = ds.name;
                paperSelect.appendChild(opt);
            }

            paperSelect.addEventListener("change", () => {
                setDataset(paperSelect.value);
            });

            // ---------- Drawer controls ----------
            function openDrawer() {
                overlay.hidden = false;
                drawer.hidden = false;
                overlay.style.display = "block";
                drawer.style.display = "block";

                // Prevent background interaction (accessibility invariant)
                appShell.inert = true;
                appShell.setAttribute("aria-hidden", "true");

                // Focus management
                closeDrawer.focus();
                trapFocus(drawer);
            }

            function closeDrawerFn() {
                overlay.hidden = true;
                drawer.hidden = true;
                overlay.style.display = "none";
                drawer.style.display = "none";

                appShell.inert = false;
                appShell.removeAttribute("aria-hidden");

                releaseFocusTrap();
                jumpBtn.focus();
            }

            jumpBtn.addEventListener("click", openDrawer);
            closeDrawer.addEventListener("click", closeDrawerFn);
            overlay.addEventListener("click", closeDrawerFn);
            document.addEventListener("keydown", (e) => {
                if (!drawer.hidden && e.key === "Escape") {
                    e.preventDefault();
                    closeDrawerFn();
                }
            });

            let focusTrapCleanup = null;
            function trapFocus(container) {
                const focusables = () => Array.from(container.querySelectorAll(
                    'button,[href],select,textarea,input,[tabindex]:not([tabindex="-1"])'
                )).filter(el => !el.hasAttribute("disabled") && !el.getAttribute("aria-hidden"));

                function onKeyDown(e) {
                    if (e.key !== "Tab") return;
                    const items = focusables();
                    if (items.length === 0) return;
                    const first = items[0];
                    const last = items[items.length - 1];
                    if (e.shiftKey && document.activeElement === first) {
                        e.preventDefault();
                        last.focus();
                    } else if (!e.shiftKey && document.activeElement === last) {
                        e.preventDefault();
                        first.focus();
                    }
                }
                container.addEventListener("keydown", onKeyDown);
                focusTrapCleanup = () => container.removeEventListener("keydown", onKeyDown);
            }
            function releaseFocusTrap() {
                if (focusTrapCleanup) focusTrapCleanup();
                focusTrapCleanup = null;
            }

            // ---------- Rendering ----------
            function setDataset(key) {
                const ds = DATASETS.find(d => d.key === key) || DATASETS[0];
                currentDatasetKey = ds.key;
                paperSelect.value = ds.key;

                // Render content + nav
                renderPaper(ds);
                renderNav(ds);

                // Real KaTeX rendering (programmatic). If unavailable, fall back to plain text.
                renderMath(document);

                // Setup active tracking
                setupActiveTracking();

                // Reset focus to main for keyboard users (without moving focus automatically during toggles)
                paperMain.focus({ preventScroll: true });
            }

            function renderPaper(ds) {
                const parts = [];
                parts.push(`
          <div class="paper-meta">
            <h1 class="paper-name">${escapeHTML(ds.name)}</h1>
            <p class="paper-sub">${escapeHTML(ds.subtitle)}</p>
          </div>
        `);

                for (const section of ds.sections) {
                    if (section.label) {
                        parts.push(`<div class="sectionHeader">Section ${escapeHTML(section.label)}</div>`);
                    }

                    const sorted = sortQuestions(section.questions);

                    for (const q of sorted) {
                        parts.push(buildQuestion(q, ds));
                    }
                }

                paperMain.innerHTML = parts.join("");
                wireToggles(paperMain);
            }

            function sortQuestions(questions) {
                // Sort by base question number then nesting order based on tokenized id.
                // Keeps deep nesting stable and predictable.
                const parse = (id) => {
                    // Example: "18(a)(i)" => [18, "a", "i"]
                    const m = String(id).match(/^(\d+)(.*)$/);
                    const base = m ? parseInt(m[1], 10) : 9999;
                    const tail = m ? m[2] : "";
                    const tokens = [];
                    const re = /\(([a-zivx]+)\)|([a-z]+)$/ig;
                    let t = tail;
                    // Support ids like 20(a) and 7a by normalizing
                    if (/^\d+[a-z]+$/i.test(String(id))) {
                        const mm = String(id).match(/^(\d+)([a-z]+)$/i);
                        if (mm) return [parseInt(mm[1], 10), mm[2].toLowerCase()];
                    }
                    let match;
                    while ((match = re.exec(t))) {
                        const tok = (match[1] || match[2] || "").toLowerCase();
                        if (tok) tokens.push(tok);
                    }
                    return [base, ...tokens];
                };

                const cmp = (a, b) => {
                    const A = parse(a.id), B = parse(b.id);
                    const len = Math.max(A.length, B.length);
                    for (let i = 0; i < len; i++) {
                        const x = A[i] ?? "";
                        const y = B[i] ?? "";
                        if (typeof x === "number" && typeof y === "number") {
                            if (x !== y) return x - y;
                        } else {
                            // order roman numerals roughly after letters for stability
                            const sx = String(x), sy = String(y);
                            if (sx !== sy) return sx.localeCompare(sy);
                        }
                    }
                    // tie-break: depth then id
                    if (a.depth !== b.depth) return a.depth - b.depth;
                    return String(a.id).localeCompare(String(b.id));
                };

                return [...questions].sort(cmp);
            }

            function buildQuestion(q, ds) {
                const qDomId = domIdFromQid(q.id);

                const depth = q.depth || 0;
                const indentStyle = `style="--depth:${depth}"`;

                const diagrams = (q.diagrams || []).map(type =>
                    `<div class="diagram" aria-hidden="false">${renderDiagram(type)}</div>`
                ).join("");

                const sdId = `sd-${qDomId}`;
                const expandedByDefault = !!q.defaultExpanded;

                // Solution Details blocks (kept hidden when collapsed; no preview)
                const sdBlocks = buildSolutionDetails(q.details, q.id);

                const toggleLabel = expandedByDefault ? "Hide working" : "Show working";
                const chevron = expandedByDefault ? "▴" : "▾";

                return `
          <section class="q" data-qid="${escapeAttr(q.id)}" data-depth="${depth}" id="${qDomId}">
            <div class="q-inner" ${indentStyle}>
              <div class="q-head">
                <div class="qid">${escapeHTML(q.id)}</div>
                <div class="qtext">
                  ${q.promptHTML || `<p>${escapeHTML(" ")}</p>`}
                  ${diagrams}
                </div>
              </div>

              <div class="answer" aria-label="Answer">
                <div class="label">Answer</div>
                <div class="value">${q.answersHTML || ""}</div>
              </div>

              <div class="toggleRow">
                <button class="toggle" type="button"
                        data-toggle="solution"
                        aria-expanded="${expandedByDefault ? "true" : "false"}"
                        aria-controls="${sdId}">
                  <span class="toggleText">${toggleLabel}</span>
                  <span class="chev" aria-hidden="true">${chevron}</span>
                </button>
              </div>

              <div class="solutionWrap">
                <div class="solution"
                     id="${sdId}"
                     ${expandedByDefault ? "" : "hidden"}
                     ${expandedByDefault ? "" : "inert"}
                     aria-hidden="${expandedByDefault ? "false" : "true"}">
                  ${sdBlocks}
                </div>
              </div>
            </div>
          </section>
        `;
            }

            function buildSolutionDetails(details, qid) {
                if (!details) return "";
                const blocks = [];

                if (details.guidance && details.guidance.length) {
                    blocks.push(`
            <div class="sd-block">
              <div class="sd-label">Keep in mind</div>
              <div class="sd-body">
                <ul>
                  ${details.guidance.map(x => `<li>${escapeHTML(x)}</li>`).join("")}
                </ul>
              </div>
            </div>
          `);
                }

                if (details.formulas && details.formulas.length) {
                    blocks.push(`
            <div class="sd-block">
              <div class="sd-label">Formulas used</div>
              <div class="sd-body">
                ${details.formulas.map(f => `<div>${mi(f)}</div>`).join("")}
              </div>
            </div>
          `);
                }

                // Working
                blocks.push(`
          <div class="sd-block">
            <div class="sd-label">Working</div>
            <div class="sd-body">
              ${Array.isArray(details.working) ? details.working.map(tex => mb(tex)).join("") : ""}
            </div>
          </div>
        `);

                // Alternative working(s)
                if (details.alt && details.alt.length) {
                    for (const alt of details.alt) {
                        blocks.push(`
              <div class="sd-block">
                <div class="sd-label">Alternative working</div>
                <div class="sd-body">
                  ${alt.text ? `<p>${escapeHTML(alt.text)}</p>` : ""}
                  ${Array.isArray(alt.lines) ? alt.lines.map(tex => mb(tex)).join("") : ""}
                </div>
              </div>
            `);
                    }
                }

                return blocks.join("");
            }

            function domIdFromQid(qid) {
                return "q-" + String(qid)
                    .replaceAll("(", "-")
                    .replaceAll(")", "")
                    .replaceAll(" ", "")
                    .replaceAll(".", "-")
                    .replaceAll("/", "-")
                    .replaceAll("—", "-")
                    .replaceAll("–", "-")
                    .replaceAll("__", "-")
                    .toLowerCase();
            }

            // ---------- Nav rendering ----------
            function renderNav(ds) {
                navButtons.clear();

                const navParts = [];
                const drawerParts = [];

                const buildNavForSections = (targetParts, clickHandlerName) => {
                    targetParts.push(`<div aria-label="Question list">`);
                    for (const section of ds.sections) {
                        if (section.label) {
                            targetParts.push(`<div class="nav-sep">Section ${escapeHTML(section.label)}</div>`);
                        }
                        const sorted = sortQuestions(section.questions);
                        for (const q of sorted) {
                            targetParts.push(navButtonHTML(q.id, clickHandlerName));
                        }
                    }
                    targetParts.push(`</div>`);
                };

                buildNavForSections(navParts, "navJump");
                buildNavForSections(drawerParts, "navJumpDrawer");

                navList.innerHTML = navParts.join("");
                drawerNav.innerHTML = drawerParts.join("");

                // Wire events
                navList.querySelectorAll("[data-nav]").forEach(btn => {
                    btn.addEventListener("click", (e) => navJump(e, false));
                });
                drawerNav.querySelectorAll("[data-nav]").forEach(btn => {
                    btn.addEventListener("click", (e) => navJump(e, true));
                });

                // Build map for active state updates (desktop + drawer)
                const allBtns = document.querySelectorAll("[data-nav]");
                allBtns.forEach(btn => {
                    const qid = btn.getAttribute("data-qid");
                    if (!navButtons.has(qid)) navButtons.set(qid, []);
                    navButtons.get(qid).push(btn);
                });
            }

            function navButtonHTML(qid, handler) {
                return `
          <button class="nav-item"
                  type="button"
                  data-nav="true"
                  data-qid="${escapeAttr(qid)}"
                  aria-current="false">
            ${escapeHTML(qid)}
          </button>
        `;
            }

            function navJump(e, fromDrawer) {
                const btn = e.currentTarget;
                const qid = btn.getAttribute("data-qid");
                const el = document.getElementById(domIdFromQid(qid));
                if (!el) return;

                if (fromDrawer) closeDrawerFn();

                // Smooth scroll permitted for navigation jumps (continuity cue)
                el.scrollIntoView({ behavior: prefersReducedMotion ? "auto" : "smooth", block: "start" });
            }

            // ---------- Toggles (Solution Details) ----------
            function wireToggles(root) {
                root.querySelectorAll('button[data-toggle="solution"]').forEach(btn => {
                    btn.addEventListener("click", () => {
                        const sdId = btn.getAttribute("aria-controls");
                        const panel = document.getElementById(sdId);
                        if (!panel) return;

                        const isExpanded = btn.getAttribute("aria-expanded") === "true";
                        const nextExpanded = !isExpanded;

                        btn.setAttribute("aria-expanded", String(nextExpanded));
                        const textEl = btn.querySelector(".toggleText");
                        const chevEl = btn.querySelector(".chev");
                        if (textEl) textEl.textContent = nextExpanded ? "Hide working" : "Show working";
                        if (chevEl) chevEl.textContent = nextExpanded ? "▴" : "▾";

                        togglePanel(panel, nextExpanded);
                    });
                });
            }

            function togglePanel(panel, expand) {
                // Ensure hidden content is not focusable
                if (expand) {
                    panel.hidden = false;
                    panel.inert = false;
                    panel.setAttribute("aria-hidden", "false");
                    animateHeight(panel, true);
                } else {
                    animateHeight(panel, false, () => {
                        panel.inert = true;
                        panel.setAttribute("aria-hidden", "true");
                        panel.hidden = true;
                    });
                }
            }

            function animateHeight(panel, expanding, done) {
                if (prefersReducedMotion) {
                    if (!expanding && done) done();
                    return;
                }
                // Height transition that explains movement, not decorative
                const startHeight = expanding ? 0 : panel.scrollHeight;
                panel.style.height = startHeight + "px";
                panel.style.transition = "height 180ms ease, opacity 180ms ease";
                panel.style.opacity = expanding ? "0.92" : "1";

                // Force layout
                panel.getBoundingClientRect();

                const endHeight = expanding ? panel.scrollHeight : 0;
                panel.style.height = endHeight + "px";
                panel.style.opacity = expanding ? "1" : "0.92";

                const onEnd = (ev) => {
                    if (ev.propertyName !== "height") return;
                    panel.removeEventListener("transitionend", onEnd);
                    panel.style.transition = "";
                    panel.style.height = "";
                    panel.style.opacity = "";
                    if (!expanding && done) done();
                };
                panel.addEventListener("transitionend", onEnd);
            }

            // ---------- KaTeX rendering (programmatic) ----------
            function renderMath(root) {
                const nodes = root.querySelectorAll(".math[data-tex]");
                const hasKatex = typeof window.katex !== "undefined" && window.katex && typeof window.katex.render === "function";

                nodes.forEach(node => {
                    const tex = node.getAttribute("data-tex") || "";
                    const display = node.getAttribute("data-display") === "true";

                    // Clear previous
                    node.innerHTML = "";

                    if (hasKatex) {
                        try {
                            window.katex.render(tex, node, {
                                displayMode: display,
                                throwOnError: false,
                                strict: "ignore"
                            });
                        } catch (err) {
                            // Graceful fallback: show plain TeX
                            node.textContent = display ? `$$${tex}$$` : `$${tex}$`;
                        }
                    } else {
                        // KaTeX failed to load: show plain TeX
                        node.textContent = display ? `$$${tex}$$` : `$${tex}$`;
                    }
                });
            }

            // ---------- Active navigation tracking ----------
            function setupActiveTracking() {
                if (currentObserver) {
                    currentObserver.disconnect();
                    currentObserver = null;
                }

                questionEls = Array.from(document.querySelectorAll("section.q"));

                // Clear current states
                navButtons.forEach(btns => btns.forEach(b => b.setAttribute("aria-current", "false")));

                const opts = { root: null, threshold: [0.15, 0.3, 0.6], rootMargin: "-25% 0px -65% 0px" };
                let active = null;

                currentObserver = new IntersectionObserver((entries) => {
                    // Choose the most "central" visible entry
                    const visible = entries.filter(e => e.isIntersecting).sort((a, b) => b.intersectionRatio - a.intersectionRatio);
                    if (visible.length) {
                        const q = visible[0].target;
                        const qid = q.getAttribute("data-qid");
                        if (qid && qid !== active) {
                            active = qid;
                            setActiveNav(qid);
                        }
                    }
                }, opts);

                questionEls.forEach(el => currentObserver.observe(el));
            }

            function setActiveNav(qid) {
                navButtons.forEach((btns, key) => {
                    const isCurrent = key === qid;
                    btns.forEach(btn => btn.setAttribute("aria-current", isCurrent ? "true" : "false"));
                });
            }

            // ---------- Initialize ----------
            setDataset(currentDatasetKey);

            // If KaTeX loads after initial render, re-render math once
            // (No hiding content; this only upgrades rendering.)
            let katexUpgradeAttempted = false;
            const katexUpgrade = () => {
                if (katexUpgradeAttempted) return;
                const hasKatex = typeof window.katex !== "undefined" && window.katex && typeof window.katex.render === "function";
                if (hasKatex) {
                    katexUpgradeAttempted = true;
                    renderMath(document);
                }
            };
            window.addEventListener("load", katexUpgrade, { once: true });

        })();
    </script>
</body>

</html>