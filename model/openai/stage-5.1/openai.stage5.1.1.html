<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>RTQ – Maths Paper Solution Viewer (Stress Test)</title>

    <!-- Real KaTeX Rendering add-on -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js" crossorigin="anonymous"></script>

    <style>
        :root {
            /* Stage 5: soft-warm neutral base (no brand/accents) */
            --bg: #f5f1ea;
            --surface: #fbf8f3;
            --ink: #1f1f1f;
            --ink-2: #3a3a3a;
            --ink-3: #5a5a5a;
            --line: #ded8cf;
            --line-2: #e9e3da;

            --frame-max: 1120px;
            --nav-w: 120px;

            --fs-1: 16px;
            /* question text */
            --fs-2: 13px;
            /* answer */
            --fs-3: 12px;
            /* nav + labels */
            --lh-1: 1.55;
            /* question */
            --lh-2: 1.45;
            /* solution */
            --lh-3: 1.35;
            /* nav */
        }

        * {
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
        }

        body {
            margin: 0;
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
            color: var(--ink);
            background: var(--bg);
            overflow-x: hidden;
            /* never allow page-level horizontal scroll */
        }

        /* Top controls (aligned with centered frame) */
        .topbar {
            position: sticky;
            top: 0;
            z-index: 10;
            background: var(--bg);
            border-bottom: 1px solid var(--line-2);
        }

        .topbar-inner {
            max-width: var(--frame-max);
            margin: 0 auto;
            padding: 12px 14px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .brand {
            font-size: 13px;
            color: var(--ink-3);
            letter-spacing: 0.2px;
            white-space: nowrap;
            user-select: none;
        }

        .controls {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            min-width: 0;
        }

        label {
            font-size: 12px;
            color: var(--ink-3);
            white-space: nowrap;
        }

        select {
            font-size: 13px;
            padding: 6px 8px;
            border-radius: 8px;
            border: 1px solid var(--line);
            background: var(--surface);
            color: var(--ink);
            max-width: 100%;
        }

        .jump-btn {
            margin-left: auto;
            font-size: 13px;
            padding: 6px 10px;
            border-radius: 10px;
            border: 1px solid var(--line);
            background: var(--surface);
            color: var(--ink);
            cursor: pointer;
        }

        .jump-btn:focus-visible {
            outline: 2px solid var(--ink-3);
            outline-offset: 2px;
            border-color: transparent;
        }

        /* Centered frame containing nav + paper on same surface */
        .frame-wrap {
            max-width: var(--frame-max);
            margin: 0 auto;
            padding: 14px;
        }

        .frame {
            background: var(--surface);
            border: 1px solid var(--line-2);
            border-radius: 14px;
            padding: 16px 14px;
            display: grid;
            grid-template-columns: var(--nav-w) 1fr;
            gap: 18px;
            overflow: hidden;
            /* keep inside surface */
        }

        nav[aria-label="Paper navigation"] {
            align-self: start;
        }

        /* Sticky navigation rail (add-on: persistence). No panel background; shares surface. */
        .nav-sticky {
            position: sticky;
            top: 64px;
            /* below topbar */
        }

        .nav-list {
            max-height: calc(100vh - 90px);
            overflow: auto;
            padding-right: 4px;
            scrollbar-width: none;
            /* Firefox */
            -ms-overflow-style: none;
            /* legacy */
        }

        .nav-list::-webkit-scrollbar {
            display: none;
        }

        .nav-section {
            font-size: var(--fs-3);
            line-height: var(--lh-3);
            color: var(--ink-3);
            margin: 10px 0 6px;
            user-select: none;
        }

        .nav-item {
            display: block;
            font-size: var(--fs-3);
            line-height: 1.8;
            color: var(--ink-3);
            text-decoration: none;
            padding: 2px 2px;
            border-radius: 8px;
            outline: none;
        }

        .nav-item:hover {
            text-decoration: underline;
            /* quiet hover */
        }

        .nav-item:focus-visible {
            outline: 2px solid var(--ink-3);
            outline-offset: 2px;
            border-radius: 8px;
        }

        .nav-item[aria-current="true"] {
            color: var(--ink-2);
            font-weight: 600;
            /* bold reserved for current item */
            text-decoration: none;
        }

        main {
            min-width: 0;
            /* allow content to wrap properly */
        }

        /* Section headers (A/B/C) */
        .section-header {
            font-size: 12px;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--ink-3);
            margin: 18px 0 8px;
            padding-top: 10px;
            border-top: 1px solid var(--line-2);
        }

        /* Question rhythm: whitespace (no cards) */
        .q {
            padding: 0;
            margin: 0 0 26px 0;
            /* largest unit between top-level questions */
        }

        .q.depth-0 {
            margin-bottom: 28px;
        }

        .q.depth-1 {
            margin-bottom: 18px;
        }

        .q.depth-2 {
            margin-bottom: 12px;
        }

        .q-line {
            display: flex;
            gap: 10px;
            align-items: flex-start;
            min-width: 0;
        }

        .qid {
            flex: 0 0 auto;
            font-size: 12px;
            line-height: 1.6;
            color: var(--ink-3);
            padding-top: 1px;
            user-select: none;
        }

        .q-prompt {
            font-size: var(--fs-1);
            line-height: var(--lh-1);
            color: var(--ink);
            min-width: 0;
        }

        .q-prompt p {
            margin: 0 0 8px 0;
        }

        /* Indentation for nesting (no borders) */
        .depth-1 {
            padding-left: 18px;
        }

        .depth-2 {
            padding-left: 32px;
        }

        @media (max-width: 520px) {
            .depth-1 {
                padding-left: 12px;
            }

            .depth-2 {
                padding-left: 20px;
            }

            :root {
                --nav-w: 0px;
            }
        }

        /* Answer: visible by default, subordinate to question but above solution details */
        .answer {
            margin-top: 10px;
            /* tighter than between questions */
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }

        .answer .label {
            font-size: var(--fs-3);
            color: var(--ink-3);
            font-weight: 600;
            /* short label ok */
            min-width: 52px;
            user-select: none;
        }

        .answer .value {
            font-size: var(--fs-2);
            line-height: 1.5;
            color: var(--ink-2);
            min-width: 0;
        }

        .answer ul {
            margin: 0;
            padding-left: 16px;
        }

        /* Disclosure control: text-first, not button-like */
        .disclosure {
            margin-top: 8px;
            padding: 0;
            background: transparent;
            border: 0;
            font-size: 13px;
            color: var(--ink-3);
            cursor: pointer;
            text-decoration: underline;
            text-underline-offset: 2px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .disclosure:hover {
            color: var(--ink-2);
        }

        .disclosure:focus-visible {
            outline: 2px solid var(--ink-3);
            outline-offset: 3px;
            border-radius: 8px;
            text-decoration: none;
        }

        .chev {
            width: 12px;
            height: 12px;
            flex: 0 0 auto;
            opacity: 0.85;
        }

        .disclosure[aria-expanded="true"] .chev {
            transform: rotate(180deg);
        }

        /* Solution details: subtle surface separation, subordinate; no heavy framing */
        .solution {
            margin-top: 10px;
            padding: 10px 12px;
            background: #f8f4ee;
            /* slightly different warm neutral */
            border: 1px solid var(--line-2);
            border-radius: 12px;
            color: var(--ink-2);
            font-size: 13px;
            line-height: var(--lh-2);
            overflow: hidden;
            /* for height transitions */
        }

        .solution[hidden] {
            display: none;
        }

        .sd-block {
            margin: 0 0 10px 0;
        }

        .sd-block:last-child {
            margin-bottom: 0;
        }

        .sd-label {
            font-size: 12px;
            color: var(--ink-3);
            font-weight: 600;
            /* labels only */
            margin: 0 0 6px 0;
            user-select: none;
        }

        .sd-body p {
            margin: 0 0 6px 0;
            font-weight: 400;
        }

        .sd-body ul {
            margin: 0;
            padding-left: 18px;
        }

        /* KaTeX containment invariant */
        .math-inline {
            white-space: nowrap;
        }

        .math-block {
            margin: 8px 0;
            max-width: 100%;
            overflow-x: auto;
            /* horizontal scroll only here when needed */
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
            padding: 6px 8px;
            border-radius: 10px;
            border: 1px solid var(--line-2);
            background: #fbf8f3;
            scrollbar-width: none;
            -ms-overflow-style: none;
            contain: content;
            /* prevent layout side-effects */
        }

        .math-block::-webkit-scrollbar {
            display: none;
        }

        .math-block .katex-display {
            margin: 0;
            /* no extra vertical spacing */
        }

        .math-block-inner {
            display: block;
            max-width: 100%;
        }

        /* Diagrams (inline SVG placeholders only; grayscale) */
        .diagram {
            margin: 10px 0 6px;
            border: 1px solid var(--line-2);
            border-radius: 12px;
            padding: 10px;
            background: #fbf8f3;
            max-width: 520px;
        }

        .diagram svg {
            width: 100%;
            height: auto;
            display: block;
        }

        .diagram-caption {
            font-size: 12px;
            color: var(--ink-3);
            margin-top: 6px;
        }

        /* Simple tables inside prompts/solutions (not boxed like cards) */
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 10px 0;
            font-size: 13px;
            color: var(--ink-2);
        }

        th,
        td {
            border: 1px solid var(--line-2);
            padding: 6px 8px;
            text-align: left;
            vertical-align: top;
        }

        th {
            font-size: 12px;
            color: var(--ink-3);
            font-weight: 600;
            background: #fbf8f3;
        }

        /* Drawer navigation (mobile/tablet) */
        .drawer-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.28);
            display: none;
            z-index: 30;
        }

        .drawer {
            position: fixed;
            top: 0;
            right: 0;
            height: 100%;
            width: min(320px, 88vw);
            background: var(--surface);
            border-left: 1px solid var(--line-2);
            padding: 12px;
            transform: translateX(100%);
            transition: transform 160ms ease;
            z-index: 31;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .drawer-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .drawer-title {
            font-size: 13px;
            color: var(--ink-2);
            user-select: none;
        }

        .drawer-close {
            border: 1px solid var(--line);
            background: var(--surface);
            border-radius: 10px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 13px;
        }

        .drawer-close:focus-visible {
            outline: 2px solid var(--ink-3);
            outline-offset: 2px;
            border-color: transparent;
        }

        .drawer .nav-list {
            max-height: none;
            flex: 1;
        }

        body.drawer-open {
            overflow: hidden;
            /* prevent background scroll while open */
        }

        body.drawer-open .drawer-overlay {
            display: block;
        }

        body.drawer-open .drawer {
            transform: translateX(0);
        }

        /* Responsive layout: hide desktop nav on small screens */
        @media (max-width: 820px) {
            :root {
                --nav-w: 0px;
            }

            .frame {
                grid-template-columns: 1fr;
            }

            nav[aria-label="Paper navigation"] {
                display: none;
            }

            .jump-btn {
                display: inline-block;
            }
        }

        @media (min-width: 821px) {
            .jump-btn {
                display: none;
            }
        }

        /* Motion respect */
        @media (prefers-reduced-motion: reduce) {
            .drawer {
                transition: none;
            }
        }
    </style>
</head>

<body>
    <header class="topbar">
        <div class="topbar-inner">
            <div class="brand">RTQ – Maths Paper Solution Viewer</div>
            <div class="controls">
                <label for="paperSelect">Paper</label>
                <select id="paperSelect" aria-label="Paper selector"></select>
                <button class="jump-btn" id="jumpBtn" type="button" aria-haspopup="dialog"
                    aria-controls="navDrawer">Jump to</button>
            </div>
        </div>
    </header>

    <div class="frame-wrap">
        <div class="frame" role="presentation">
            <nav aria-label="Paper navigation">
                <div class="nav-sticky">
                    <div class="nav-list" id="navList"></div>
                </div>
            </nav>

            <main id="paper" aria-label="Paper content"></main>
        </div>
    </div>

    <!-- Mobile drawer -->
    <div class="drawer-overlay" id="drawerOverlay" hidden></div>
    <aside class="drawer" id="navDrawer" role="dialog" aria-modal="true" aria-label="Jump to question">
        <div class="drawer-head">
            <div class="drawer-title">Jump to</div>
            <button class="drawer-close" id="drawerClose" type="button">Close</button>
        </div>
        <div class="nav-list" id="drawerNavList"></div>
    </aside>

    <script>
        /***********************
         * Minimal content DSL *
         ***********************/
        function partsFromText(str) {
            // Split on $...$ (inline math). Simple, adequate for synthetic stress content.
            const out = [];
            let i = 0;
            while (i < str.length) {
                const a = str.indexOf("$", i);
                if (a === -1) {
                    out.push({ t: "text", v: str.slice(i) });
                    break;
                }
                const b = str.indexOf("$", a + 1);
                if (b === -1) {
                    out.push({ t: "text", v: str.slice(i) });
                    break;
                }
                if (a > i) out.push({ t: "text", v: str.slice(i, a) });
                out.push({ t: "mi", v: str.slice(a + 1, b) });
                i = b + 1;
            }
            return out.filter(p => p.v !== "");
        }
        function P(text) { return { kind: "p", parts: partsFromText(text) }; }
        function MB(expr) { return { kind: "mb", expr }; }
        function DIAG(type, caption) { return { kind: "diagram", type, caption }; }
        function TABLE(headers, rows) {
            // headers: [string]; rows: [[string|{parts}]]
            return { kind: "table", headers, rows };
        }

        function Q({ id, depth = 0, prompt = [], answer = [], details = null, sectionLabel = null }) {
            return { id, depth, prompt, answer, details, sectionLabel };
        }
        function SD({ guidance = null, formulae = null, working = [], alt = null }) {
            return { guidance, formulae, working, alt };
        }

        /****************
         * SVG diagrams *
         ****************/
        function svgGeometry() {
            return `
      <svg viewBox="0 0 360 220" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <rect x="0" y="0" width="360" height="220" fill="none"/>
        <polygon points="70,170 180,40 290,170" fill="none" stroke="#3a3a3a" stroke-width="2"/>
        <circle cx="180" cy="40" r="4" fill="#3a3a3a"/>
        <circle cx="70" cy="170" r="4" fill="#3a3a3a"/>
        <circle cx="290" cy="170" r="4" fill="#3a3a3a"/>
        <text x="170" y="30" font-size="12" fill="#3a3a3a">A</text>
        <text x="55" y="190" font-size="12" fill="#3a3a3a">B</text>
        <text x="300" y="190" font-size="12" fill="#3a3a3a">C</text>
        <line x1="70" y1="170" x2="290" y2="170" stroke="#5a5a5a" stroke-width="2" stroke-dasharray="5 5"/>
        <text x="165" y="188" font-size="12" fill="#5a5a5a">base</text>
        <path d="M 165 152 A 20 20 0 0 1 195 152" fill="none" stroke="#5a5a5a" stroke-width="2"/>
        <text x="200" y="152" font-size="12" fill="#5a5a5a">θ</text>
      </svg>`;
        }
        function svgRatioBars() {
            return `
      <svg viewBox="0 0 360 140" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <rect x="20" y="30" width="320" height="26" fill="none" stroke="#3a3a3a" stroke-width="2"/>
        <line x1="20" y1="56" x2="340" y2="56" stroke="#3a3a3a" stroke-width="2"/>
        <line x1="20" y1="30" x2="20" y2="56" stroke="#3a3a3a" stroke-width="2"/>
        <line x1="340" y1="30" x2="340" y2="56" stroke="#3a3a3a" stroke-width="2"/>
        <line x1="148" y1="30" x2="148" y2="56" stroke="#5a5a5a" stroke-width="2"/>
        <line x1="244" y1="30" x2="244" y2="56" stroke="#5a5a5a" stroke-width="2"/>
        <text x="68" y="88" font-size="12" fill="#5a5a5a">2 parts</text>
        <text x="170" y="88" font-size="12" fill="#5a5a5a">2 parts</text>
        <text x="270" y="88" font-size="12" fill="#5a5a5a">1 part</text>

        <rect x="20" y="96" width="320" height="26" fill="none" stroke="#3a3a3a" stroke-width="2"/>
        <line x1="84" y1="96" x2="84" y2="122" stroke="#5a5a5a" stroke-width="2"/>
        <line x1="148" y1="96" x2="148" y2="122" stroke="#5a5a5a" stroke-width="2"/>
        <line x1="212" y1="96" x2="212" y2="122" stroke="#5a5a5a" stroke-width="2"/>
        <line x1="276" y1="96" x2="276" y2="122" stroke="#5a5a5a" stroke-width="2"/>
      </svg>`;
        }
        function svgCoordGrid() {
            return `
      <svg viewBox="0 0 360 220" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <rect x="0" y="0" width="360" height="220" fill="none"/>
        <g stroke="#e0dbd3" stroke-width="1">
          ${Array.from({ length: 13 }, (_, i) => `<line x1="${40 + i * 24}" y1="20" x2="${40 + i * 24}" y2="200"/>`).join("")}
          ${Array.from({ length: 9 }, (_, i) => `<line x1="40" y1="${20 + i * 22}" x2="328" y2="${20 + i * 22}"/>`).join("")}
        </g>
        <g stroke="#3a3a3a" stroke-width="2">
          <line x1="40" y1="110" x2="328" y2="110"/>
          <line x1="184" y1="20" x2="184" y2="200"/>
        </g>
        <circle cx="232" cy="66" r="4" fill="#3a3a3a"/>
        <circle cx="136" cy="154" r="4" fill="#3a3a3a"/>
        <line x1="136" y1="154" x2="232" y2="66" stroke="#5a5a5a" stroke-width="2"/>
        <text x="240" y="62" font-size="12" fill="#5a5a5a">(2,2)</text>
        <text x="88" y="170" font-size="12" fill="#5a5a5a">(-2,-2)</text>
      </svg>`;
        }
        function svgArrayGrid() {
            return `
      <svg viewBox="0 0 360 160" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <rect x="40" y="30" width="280" height="100" fill="none" stroke="#3a3a3a" stroke-width="2"/>
        ${Array.from({ length: 4 }, (_, i) => `<line x1="${40 + (i + 1) * 70}" y1="30" x2="${40 + (i + 1) * 70}" y2="130" stroke="#5a5a5a" stroke-width="2"/>`).join("")}
        ${Array.from({ length: 2 }, (_, i) => `<line x1="40" y1="${30 + (i + 1) * 50}" x2="320" y2="${30 + (i + 1) * 50}" stroke="#5a5a5a" stroke-width="2"/>`).join("")}
        <text x="54" y="62" font-size="12" fill="#5a5a5a">A</text>
        <text x="124" y="62" font-size="12" fill="#5a5a5a">B</text>
        <text x="194" y="62" font-size="12" fill="#5a5a5a">C</text>
        <text x="264" y="62" font-size="12" fill="#5a5a5a">D</text>

        <text x="54" y="112" font-size="12" fill="#5a5a5a">1</text>
        <text x="124" y="112" font-size="12" fill="#5a5a5a">2</text>
        <text x="194" y="112" font-size="12" fill="#5a5a5a">3</text>
        <text x="264" y="112" font-size="12" fill="#5a5a5a">4</text>
      </svg>`;
        }
        function svgNumberLine() {
            return `
      <svg viewBox="0 0 360 120" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <line x1="40" y1="60" x2="320" y2="60" stroke="#3a3a3a" stroke-width="2"/>
        ${Array.from({ length: 7 }, (_, i) => `<line x1="${60 + i * 40}" y1="52" x2="${60 + i * 40}" y2="68" stroke="#3a3a3a" stroke-width="2"/>`).join("")}
        <text x="56" y="88" font-size="12" fill="#5a5a5a">1</text>
        <text x="96" y="88" font-size="12" fill="#5a5a5a">1.5</text>
        <text x="136" y="88" font-size="12" fill="#5a5a5a">2</text>
        <text x="176" y="88" font-size="12" fill="#5a5a5a">2.5</text>
        <text x="216" y="88" font-size="12" fill="#5a5a5a">3</text>
        <rect x="88" y="30" width="44" height="20" fill="none" stroke="#5a5a5a" stroke-width="2"/>
        <rect x="168" y="30" width="44" height="20" fill="none" stroke="#5a5a5a" stroke-width="2"/>
      </svg>`;
        }

        function diagramSVG(type) {
            switch (type) {
                case "geometry": return svgGeometry();
                case "ratio": return svgRatioBars();
                case "grid": return svgCoordGrid();
                case "array": return svgArrayGrid();
                case "numberline": return svgNumberLine();
                default: return svgArrayGrid();
            }
        }

        /********************
         * Dataset builders *
         ********************/
        function buildShort() {
            const qs = [];
            qs.push(Q({
                id: "1",
                prompt: [P("Calculate $48 + 37$.")],
                answer: [P("$85$")],
                details: SD({
                    working: [
                        P("Add the tens, then the ones."),
                        MB(String.raw`\begin{aligned}48+37 &= (40+30)+(8+7)\\ &= 70+15\\ &= 85\end{aligned}`)
                    ]
                })
            }));
            qs.push(Q({
                id: "2",
                prompt: [P("Work out $900 - 275$.")],
                answer: [P("$625$")],
                details: SD({
                    guidance: ["Use column subtraction, borrowing if needed."],
                    working: [MB(String.raw`\begin{aligned}900-275 &= (900-200)-75\\ &= 700-75\\ &= 625\end{aligned}`)]
                })
            }));
            qs.push(Q({
                id: "3",
                prompt: [P("Write $0.36$ as a fraction in its simplest form.")],
                answer: [P("$\u2009\\dfrac{9}{25}\u2009$")],
                details: SD({
                    formulae: ["$\\text{decimal} = \\dfrac{\\text{whole number}}{10^n}$"],
                    working: [
                        MB(String.raw`\begin{aligned}0.36 &= \dfrac{36}{100}\\ &= \dfrac{36\div 4}{100\div 4}\\ &= \dfrac{9}{25}\end{aligned}`)
                    ]
                })
            }));

            // Multi-part with nesting
            qs.push(Q({
                id: "4",
                prompt: [P("A shop sells pencils for $12\\text{p}$ each, or a pack of $5$ for $50\\text{p}$.")],
                answer: [P("$\u2014$")],
                details: null
            }));
            qs.push(Q({
                id: "4(a)",
                depth: 1,
                prompt: [P("How much do you save if you buy $5$ pencils as a pack instead of separately?")],
                answer: [P("$10\\text{p}$")],
                details: SD({
                    guidance: ["Compare the two costs like-for-like."],
                    working: [
                        MB(String.raw`\begin{aligned}\text{Separately} &= 5\times 12\text{p} = 60\text{p}\\ \text{Pack price} &= 50\text{p}\\ \text{Saving} &= 60\text{p}-50\text{p}=10\text{p}\end{aligned}`)
                    ]
                })
            }));
            qs.push(Q({
                id: "4(b)",
                depth: 1,
                prompt: [P("You have $\\pounds 2$. What is the greatest number of pencils you can buy?")],
                answer: [P("$19$")],
                details: SD({
                    guidance: ["Use as many packs as possible, then use the remaining money."],
                    working: [
                        P("Try $3$ packs: $3\\times 50\\text{p}=150\\text{p}$, leaving $50\\text{p}$."),
                        P("With $50\\text{p}$ you can buy another pack of $5$. That makes $20$ pencils for $200\\text{p}$."),
                        P("But check if $4$ packs is allowed: yes, exactly $\\pounds 2$."),
                        P("Now compare with mixing: $3$ packs ($15$ pencils) leaves $50\\text{p}$ which can buy $4$ pencils ($48\\text{p}$) leaving $2\\text{p}$."),
                        MB(String.raw`\begin{aligned}\text{Best mix} &= 3\text{ packs }(15) + 4\text{ singles }(4)\\ &= 19\end{aligned}`),
                        P("So the maximum is $19$ pencils.")
                    ],
                    alt: [
                        {
                            blocks: [
                                P("Use a quick check: packs are better value per pencil, so start with packs and adjust."),
                                MB(String.raw`\begin{aligned}200\text{p} &= 3\times 50\text{p} + 50\text{p}\\ &= 150\text{p} + 50\text{p}\\ 50\text{p} &= 4\times 12\text{p} + 2\text{p}\end{aligned}`)
                            ]
                        }
                    ]
                })
            }));

            // One diagram question
            qs.push(Q({
                id: "5",
                prompt: [
                    P("Here is a number line. Write the two missing numbers in the boxes."),
                    DIAG("numberline", "Number line with two missing values")
                ],
                answer: [P("$1.5$ and $2.5$")],
                details: SD({
                    guidance: ["Count in equal steps along the line."],
                    working: [
                        MB(String.raw`\begin{aligned}2 - \dfrac14 - \dfrac14 &= 2 - \dfrac12 = 1.5\\ 2 + \dfrac14 + \dfrac14 &= 2 + \dfrac12 = 2.5\end{aligned}`)
                    ]
                })
            }));

            qs.push(Q({
                id: "6",
                prompt: [P("Find $20\\%$ of $360$.")],
                answer: [P("$72$")],
                details: SD({
                    guidance: ["Convert the percentage to a fraction or decimal."],
                    formulae: ["$\\text{Percentage} = \\dfrac{\\text{part}}{\\text{whole}}\\times 100\\%$"],
                    working: [
                        MB(String.raw`\begin{aligned}20\% \text{ of } 360 &= \dfrac{20}{100}\times 360\\ &= \dfrac{1}{5}\times 360\\ &= 72\end{aligned}`)
                    ]
                })
            }));

            return {
                key: "short",
                title: "Short paper",
                sections: [{ label: null, questions: qs }]
            };
        }

        // Long algebra block Q26–Q35 (collapsed by default, plus deep nesting and extremely long workings)
        function longAligned(lines) {
            return String.raw`\begin{aligned}` + lines.map(s => s.replace(/\n/g, " ")).join(String.raw`\\`) + String.raw`\end{aligned}`;
        }

        function buildStandard({ expanded = false } = {}) {
            const qs = [];
            // Q1–Q10: short/medium
            const quick = [
                ["1", "Work out $7\\times 8$.", "$56$", SD({ working: [MB(String.raw`\begin{aligned}7\times 8=56\end{aligned}`)] })],
                ["2", "Find $3.2 + 0.75$.", "$3.95$", SD({ working: [MB(String.raw`\begin{aligned}3.2+0.75=3.95\end{aligned}`)] })],
                ["3", "Write $4500$ in standard form.", "$4.5\\times 10^{3}$", SD({ guidance: ["Move the decimal point so there is one non-zero digit before it."], working: [MB(String.raw`\begin{aligned}4500 &= 4.5\times 10^{3}\end{aligned}`)] })],
                ["4", "A rectangle has length $9\\text{ cm}$ and width $4\\text{ cm}$. Find its area.", "$36\\text{ cm}^2$", SD({ formulae: ["$A=lw$"], working: [MB(String.raw`\begin{aligned}A &= 9\times 4 = 36\text{ cm}^2\end{aligned}`)] })],
                ["5", "Simplify $\\dfrac{18}{24}$.", "$\\dfrac{3}{4}$", SD({ guidance: ["Divide top and bottom by the same number."], working: [MB(String.raw`\begin{aligned}\dfrac{18}{24} &= \dfrac{18\div 6}{24\div 6} = \dfrac{3}{4}\end{aligned}`)] })],
                ["6", "Work out $\\dfrac{5}{6}+\\dfrac{1}{3}$.", "$\\dfrac{7}{6}$", SD({ guidance: ["Use a common denominator."], working: [MB(String.raw`\begin{aligned}\dfrac{5}{6}+\dfrac{1}{3} &= \dfrac{5}{6}+\dfrac{2}{6}=\dfrac{7}{6}\end{aligned}`)] })],
                ["7", "A bag has $3$ red and $5$ blue counters. What fraction are red?", "$\\dfrac{3}{8}$", SD({ working: [MB(String.raw`\begin{aligned}\text{Fraction red}=\dfrac{3}{3+5}=\dfrac{3}{8}\end{aligned}`)] })],
                ["8", "Solve $x+19=52$.", "$x=33$", SD({ guidance: ["Do the same operation to both sides."], working: [MB(String.raw`\begin{aligned}x+19&=52\\ x&=52-19\\ x&=33\end{aligned}`)] })],
                ["9", "Convert $2.4\\text{ m}$ to centimetres.", "$240\\text{ cm}$", SD({ formulae: ["$1\\text{ m}=100\\text{ cm}$"], working: [MB(String.raw`\begin{aligned}2.4\text{ m} &= 2.4\times 100\text{ cm}=240\text{ cm}\end{aligned}`)] })],
                ["10", "Work out $15\\%$ of $80$.", "$12$", SD({ guidance: ["A quick method is $10\\%$ plus $5\\%$."], formulae: ["$\\% = \\dfrac{\\text{part}}{\\text{whole}}\times 100\\%$"], working: [MB(String.raw`\begin{aligned}10\%\text{ of }80 &= 8\\ 5\%\text{ of }80 &= 4\\ 15\% \text{ of }80 &= 8+4=12\end{aligned}`)] })]
            ];
            quick.forEach(([id, q, a, d]) => {
                qs.push(Q({ id, prompt: [P(q)], answer: [P(a)], details: d }));
            });

            // Q11–Q17: mix (include some tables/diagrams)
            qs.push(Q({
                id: "11",
                prompt: [
                    P("A train leaves at $13{:}25$ and the journey takes $2$ hours $45$ minutes. What time does it arrive?"),
                ],
                answer: [P("$16{:}10$")],
                details: SD({
                    guidance: ["Convert all values to the same unit before combining."],
                    working: [MB(String.raw`\begin{aligned}13{:}25 + 2{:}45 &= 16{:}10\end{aligned}`)]
                })
            }));

            qs.push(Q({
                id: "12",
                prompt: [
                    P("At a school, $18$ teachers travel by car, $7$ by bus and $5$ walk. What percentage travel by car?"),
                    TABLE(["Car", "Bus", "Walk"], [["$18$", "$7$", "$5$"]])
                ],
                answer: [P("$60\\%$")],
                details: SD({
                    guidance: ["Find the fraction, then convert to a percentage."],
                    formulae: ["$\\text{Percentage} = \\dfrac{\\text{part}}{\\text{whole}}\\times 100\\%$"],
                    working: [MB(String.raw`\begin{aligned}\text{Total} &= 18+7+5 = 30\\ \text{Car fraction} &= \dfrac{18}{30}=\dfrac{3}{5}\\ \text{Percentage} &= \dfrac{3}{5}\times 100\% = 60\%\end{aligned}`)]
                })
            }));

            qs.push(Q({
                id: "13",
                prompt: [P("Multiply $347$ by $6$.")],
                answer: [P("$2082$")],
                details: SD({
                    guidance: ["Use column multiplication or partitioning."],
                    working: [MB(String.raw`\begin{aligned}347\times 6 &= (300\times 6)+(40\times 6)+(7\times 6)\\ &= 1800+240+42\\ &= 2082\end{aligned}`)]
                })
            }));

            qs.push(Q({
                id: "14",
                prompt: [
                    P("A right-angled triangle has base $12\\text{ cm}$ and height $7\\text{ cm}$. Find its area."),
                    DIAG("geometry", "Right-angled triangle (not to scale)")
                ],
                answer: [P("$42\\text{ cm}^2$")],
                details: SD({
                    formulae: ["$A=\\dfrac12 bh$"],
                    working: [MB(String.raw`\begin{aligned}A &= \dfrac12\times 12\times 7\\ &= 6\times 7\\ &= 42\text{ cm}^2\end{aligned}`)]
                })
            }));

            qs.push(Q({
                id: "15",
                prompt: [P("Simplify $3(2x-5)+4x$.")],
                answer: [P("$10x-15$")],
                details: SD({
                    guidance: ["Expand brackets, then collect like terms."],
                    working: [MB(String.raw`\begin{aligned}3(2x-5)+4x &= 6x-15+4x\\ &= 10x-15\end{aligned}`)]
                })
            }));

            qs.push(Q({
                id: "16",
                prompt: [
                    P("The diagram shows ratio bars for flour and sugar in a recipe."),
                    DIAG("ratio", "Ratio bars")
                ],
                answer: [P("$\u2014$")],
                details: null
            }));

            qs.push(Q({
                id: "17",
                prompt: [P("A recipe uses flour:sugar in the ratio $5:3$. If flour is $250\\text{ g}$, how much sugar is used?")],
                answer: [P("$150\\text{ g}$")],
                details: SD({
                    guidance: ["Find the value of 1 part, then scale."],
                    working: [MB(String.raw`\begin{aligned}5\text{ parts} &= 250\text{ g}\\ 1\text{ part} &= 50\text{ g}\\ 3\text{ parts} &= 3\times 50 = 150\text{ g}\end{aligned}`)]
                })
            }));

            // Deep question nesting add-on: Q18(a)(i),(ii),(b)
            qs.push(Q({
                id: "18",
                prompt: [P("A point moves on a coordinate grid. Answer the questions below.")],
                answer: [P("$\u2014$")],
                details: null
            }));

            qs.push(Q({
                id: "18(a)",
                depth: 1,
                prompt: [P("Here is a coordinate grid with two points shown."), DIAG("grid", "Coordinate grid with two points")],
                answer: [P("$\u2014$")],
                details: null
            }));

            qs.push(Q({
                id: "18(a)(i)",
                depth: 2,
                prompt: [P("Write down the coordinates of the point $P$.")],
                answer: [P("$P(2,2)$")],
                details: SD({
                    working: [MB(String.raw`\begin{aligned}P &= (2,2)\end{aligned}`)]
                })
            }));

            qs.push(Q({
                id: "18(a)(ii)",
                depth: 2,
                prompt: [P("Find the gradient of the line joining the two points.")],
                answer: [P("$-1$")],
                details: SD({
                    guidance: ["Use $\\dfrac{\\Delta y}{\\Delta x}$."],
                    formulae: ["$m = \\dfrac{y_2-y_1}{x_2-x_1}$"],
                    working: [MB(String.raw`\begin{aligned}m &= \dfrac{2-(-2)}{2-(-2)}\times(-1)\\ &= -1\end{aligned}`)],
                    alt: [
                        {
                            blocks: [
                                P("From the diagram, moving right $4$ goes down $4$."),
                                MB(String.raw`\begin{aligned}m &= \dfrac{-4}{4}=-1\end{aligned}`)
                            ]
                        }
                    ]
                })
            }));

            qs.push(Q({
                id: "18(b)",
                depth: 1,
                prompt: [P("The point moves $3$ units right and $5$ units up from $(-1,-2)$. What are the new coordinates?")],
                answer: [P("$(2,3)$")],
                details: SD({
                    working: [MB(String.raw`\begin{aligned}x &: -1+3=2\\ y &: -2+5=3\\ \Rightarrow (2,3)\end{aligned}`)]
                })
            }));

            // Q19–Q25 medium mix (ensure Solution Details coverage)
            for (let n = 19; n <= 25; n++) {
                const id = String(n);
                let prompt, answer, details;

                if (n === 20) {
                    prompt = [P("Two numbers have a sum of $39$ and a difference of $7$. Find the two numbers.")];
                    answer = [P("$16$ and $23$")];
                    details = SD({
                        working: [
                            P("Let the smaller number be $a$. Then the larger is $a+7$."),
                            MB(String.raw`\begin{aligned}a+(a+7) &= 39\\ 2a+7 &= 39\\ 2a &= 32\\ a &= 16\\ a+7 &= 23\end{aligned}`)
                        ],
                        alt: [
                            {
                                blocks: [
                                    P("Use the average: $39\\div 2=19.5$, then adjust by half the difference."),
                                    MB(String.raw`\begin{aligned}\dfrac{7}{2} &= 3.5\\ 19.5-3.5 &= 16\\ 19.5+3.5 &= 23\end{aligned}`)
                                ]
                            }
                        ]
                    });
                } else if (n === 22) {
                    prompt = [P("A cube has total edge length $360\\text{ cm}$. Find the length of one edge.")];
                    answer = [P("$30\\text{ cm}$")];
                    details = SD({
                        guidance: ["A cube has $12$ equal edges."],
                        formulae: ["$\\text{Total edge length} = 12s$"],
                        working: [MB(String.raw`\begin{aligned}12s &= 360\\ s &= \dfrac{360}{12} = 30\text{ cm}\end{aligned}`)]
                    });
                } else if (n === 24) {
                    prompt = [P("Calculate $(9990 - 990 + 99 - 9)\\div 9$.")];
                    answer = [P("$1010$")];
                    details = SD({
                        guidance: ["Deal with brackets first (BIDMAS)."],
                        working: [
                            MB(String.raw`\begin{aligned}(9990 - 990 + 99 - 9) &= 9090\\ 9090\div 9 &= 1010\end{aligned}`)
                        ]
                    });
                } else if (n === 25) {
                    prompt = [P("Write down the next term in the sequence: $5, 9, 13, 17, \\ldots$")];
                    answer = [P("$21$")];
                    details = SD({
                        working: [MB(String.raw`\begin{aligned}\text{The sequence increases by }4, \text{ so } 17+4=21.\end{aligned}`)]
                    });
                } else {
                    prompt = [P(`Work out $${n * 3}+${n + 7}$.`)];
                    answer = [P(`$${n * 3 + (n + 7)}$`)];
                    details = SD({
                        working: [MB(String.raw`\begin{aligned}${n * 3}+${n + 7} &= ${n * 3 + (n + 7)}\end{aligned}`)]
                    });
                }
                qs.push(Q({ id, prompt, answer, details }));
            }


            // Q26
            qs.push(Q({
                id: "26",
                prompt: [P("Solve $3(2x-1)=5x+7$.")],
                answer: [P("$x=10$")],
                details: SD({
                    guidance: ["Expand brackets and collect $x$ terms on one side."],
                    working: [
                        MB(String.raw`\begin{aligned}3(2x-1) &= 5x+7\\ 6x-3 &= 5x+7\\ 6x-5x &= 7+3\\ x &= 10\end{aligned}`),
                        MB(String.raw`\begin{aligned}\text{Check: }3(2\cdot 10-1) &= 3(19)=57\\ 5\cdot 10+7 &= 57\end{aligned}`)
                    ]
                })
            }));

            // Q27 (simultaneous)
            qs.push(Q({
                id: "27",
                prompt: [P("Two cards show totals of symbols. Each $\\clubsuit$ has the same value and each $\\spadesuit$ has the same value. Find $\\clubsuit$.")],
                answer: [P("$\\clubsuit = 4$")],
                details: SD({
                    working: [
                        MB(String.raw`\begin{aligned}2c+2s &= 18\\ 2c+3s &= 23\end{aligned}`),
                        P("Subtract the first equation from the second."),
                        MB(String.raw`\begin{aligned}(2c+3s)-(2c+2s) &= 23-18\\ s &= 5\end{aligned}`),
                        P("Substitute $s=5$ into $2c+2s=18$."),
                        MB(String.raw`\begin{aligned}2c+10 &= 18\\ 2c &= 8\\ c &= 4\end{aligned}`)
                    ]
                })
            }));

            // Q28 (algebraic fraction + overflow stress in block)
            qs.push(Q({
                id: "28",
                prompt: [P("Simplify $\\dfrac{x^2-9}{x-3}$.")],
                answer: [P("$x+3$ (for $x\\ne 3$)")],
                details: SD({
                    guidance: ["Factorise the numerator first."],
                    working: [
                        MB(String.raw`\begin{aligned}\dfrac{x^2-9}{x-3} &= \dfrac{(x-3)(x+3)}{x-3}\\ &= x+3\quad (x\ne 3)\end{aligned}`),
                        MB(String.raw`\begin{aligned}\text{Overflow check: } \dfrac{(123456789012345+987654321098765)(x+3)}{x-3}\end{aligned}`)
                    ]
                })
            }));

            // Q29 (sequence)
            qs.push(Q({
                id: "29",
                prompt: [P("The $n$th term of a sequence is $4n+1$. Find the $20$th term.")],
                answer: [P("$81$")],
                details: SD({
                    working: [MB(String.raw`\begin{aligned}4n+1 &= 4(20)+1 = 81\end{aligned}`)]
                })
            }));

            // Deep nesting add-on: Q30(a)(i),(ii),(b) with extremely long working in (a)(ii)
            qs.push(Q({
                id: "30",
                prompt: [P("A number trick is described below. Answer parts (a) and (b).")],
                answer: [P("$\u2014$")],
                details: null
            }));

            qs.push(Q({
                id: "30(a)",
                depth: 1,
                prompt: [P("Start with a number $x$. Multiply by $3$, subtract $8$, then divide by $3$.")],
                answer: [P("$\u2014$")],
                details: null
            }));

            qs.push(Q({
                id: "30(a)(i)",
                depth: 2,
                prompt: [P("Write an expression for the final result in terms of $x$.")],
                answer: [P("$x-\\dfrac{8}{3}$")],
                details: SD({
                    working: [MB(String.raw`\begin{aligned}\text{Result} &= \dfrac{3x-8}{3}=x-\dfrac{8}{3}\end{aligned}`)]
                })
            }));

            // Extremely long working (50–60 lines) — Working only
            const longLines = [];
            longLines.push(String.raw`\dfrac{3x-8}{3} = x-\dfrac{8}{3}`);
            for (let i = 1; i <= 55; i++) {
                const a = 3 * i + 2;
                const b = 3 * i + 5;
                longLines.push(String.raw`x-\dfrac{8}{3} = \dfrac{3x}{3}-\dfrac{8}{3} = \dfrac{3x-8}{3}\quad\text{(step ` + i + String.raw` )}`);
                if (i % 7 === 0) {
                    longLines.push(String.raw`\dfrac{` + a + String.raw`x-8}{` + b + String.raw`} \text{ is another equivalent form used to stress overflow }`);
                }
            }

            qs.push(Q({
                id: "30(a)(ii)",
                depth: 2,
                prompt: [P("Show the algebra carefully, keeping everything as fractions.")],
                answer: [P("$x-\\dfrac{8}{3}$")],
                details: SD({
                    guidance: ["Keep the denominator the same and simplify step by step."],
                    working: [
                        MB(longAligned(longLines))
                    ]
                })
            }));

            qs.push(Q({
                id: "30(b)",
                depth: 1,
                prompt: [P("If the final result is $11$, find $x$.")],
                answer: [P("$x=\\dfrac{41}{3}$")],
                details: SD({
                    working: [
                        MB(String.raw`\begin{aligned}x-\dfrac{8}{3} &= 11\\ x &= 11+\dfrac{8}{3}\\ x &= \dfrac{33}{3}+\dfrac{8}{3}=\dfrac{41}{3}\end{aligned}`),
                    ],
                    alt: [
                        {
                            blocks: [
                                P("Use a common denominator straight away."),
                                MB(String.raw`\begin{aligned}x &= \dfrac{33+8}{3}=\dfrac{41}{3}\end{aligned}`)
                            ]
                        }
                    ]
                })
            }));

            // Q31–Q33: long but not huge
            qs.push(Q({
                id: "31",
                prompt: [P("Solve $2x^2-18=0$.")],
                answer: [P("$x=\\pm 3$")],
                details: SD({
                    guidance: ["Factor out the common factor first."],
                    working: [
                        MB(String.raw`\begin{aligned}2x^2-18 &= 0\\ 2(x^2-9) &= 0\\ x^2-9 &= 0\\ (x-3)(x+3)&=0\\ x&=3 \text{ or } x=-3\end{aligned}`)
                    ]
                })
            }));

            qs.push(Q({
                id: "32",
                prompt: [P("Expand and simplify $(x+5)^2 - (x-5)^2$.")],
                answer: [P("$20x$")],
                details: SD({
                    guidance: ["Either expand both or use a difference of squares idea."],
                    working: [
                        MB(String.raw`\begin{aligned}(x+5)^2-(x-5)^2 &= (x^2+10x+25)-(x^2-10x+25)\\ &= 20x\end{aligned}`)
                    ],
                    alt: [
                        {
                            blocks: [
                                P("Use $(A^2-B^2)=(A-B)(A+B)$ with $A=x+5$, $B=x-5$."),
                                MB(String.raw`\begin{aligned}(A^2-B^2) &= (A-B)(A+B)\\ &= ((x+5)-(x-5))((x+5)+(x-5))\\ &= (10)(2x)=20x\end{aligned}`)
                            ]
                        }
                    ]
                })
            }));

            qs.push(Q({
                id: "33",
                prompt: [P("A circle has radius $7\\text{ cm}$. Find its circumference in terms of $\\pi$.")],
                answer: [P("$14\\pi\\text{ cm}$")],
                details: SD({
                    formulae: ["$C=2\\pi r$"],
                    working: [MB(String.raw`\begin{aligned}C &= 2\pi(7) = 14\pi\text{ cm}\end{aligned}`)]
                })
            }));

            // Q34: another long working + alt (and includes Guidance + Formulae Used + Alternative working to satisfy coverage)
            const longOverflowExpr = String.raw`\dfrac{(x^2+12x+36)(x^2-12x+36)(x^2+36)^2}{(x+6)^2(x-6)^2\,(x^4+1296)} = 1`;
            const q34Lines = [
                String.raw`\dfrac{(x^2+12x+36)(x^2-12x+36)(x^2+36)^2}{(x+6)^2(x-6)^2\,(x^4+1296)}`,
                String.raw`= \dfrac{(x+6)^2(x-6)^2(x^2+36)^2}{(x+6)^2(x-6)^2\,(x^4+1296)}`,
                String.raw`= \dfrac{(x^2+36)^2}{x^4+1296}`,
                String.raw`= \dfrac{x^4+72x^2+1296}{x^4+1296}`,
                String.raw`= 1 + \dfrac{72x^2}{x^4+1296}`,
                String.raw`\text{(expression simplified; note the extra term)}`
            ];
            qs.push(Q({
                id: "34",
                prompt: [P("Simplify the expression below as far as possible."), MB(longOverflowExpr)],
                answer: [P("$1 + \\dfrac{72x^2}{x^4+1296}$")],
                details: SD({
                    guidance: ["Factorise where you can, then cancel carefully."],
                    formulae: ["$(x^2+a^2)(x^2-a^2) = x^4-a^4$"],
                    working: [MB(longAligned(q34Lines))],
                    alt: [
                        {
                            blocks: [
                                P("Recognise perfect squares: $x^2\\pm 12x+36=(x\\pm 6)^2$."),
                                MB(String.raw`\begin{aligned}(x^2+12x+36)&=(x+6)^2\\ (x^2-12x+36)&=(x-6)^2\end{aligned}`)
                            ]
                        }
                    ]
                })
            }));

            // Q35: long conclusion
            qs.push(Q({
                id: "35",
                prompt: [P("A farmer mixes oats and barley in the ratio $7:5$. She has $84\\text{ kg}$ of oats. How many kilograms of barley does she need?")],
                answer: [P("$60\\text{ kg}$")],
                details: SD({
                    guidance: ["Convert the ratio parts into real amounts."],
                    working: [MB(String.raw`\begin{aligned}7\text{ parts} &= 84\\ 1\text{ part} &= 12\\ 5\text{ parts} &= 5\times 12 = 60\end{aligned}`)]
                })
            }));

            // Mark default expanded state on dataset (add-on: Standard (Workings Expanded))
            return {
                key: expanded ? "standardExpanded" : "standard",
                title: expanded ? "Standard (Workings Expanded)" : "Standard paper",
                defaultExpanded: expanded,
                sections: [{ label: null, questions: qs }]
            };
        }

        function buildDiagramHeavy() {
            const qs = [];
            const diagramQs = new Set([2, 4, 6, 9, 12, 14, 17, 20]);
            for (let i = 1; i <= 20; i++) {
                const id = String(i);
                const has = diagramQs.has(i);
                const type = (i % 4 === 0) ? "array" : (i % 4 === 1) ? "geometry" : (i % 4 === 2) ? "ratio" : "grid";
                const prompt = [];
                if (has) {
                    if (type === "geometry") prompt.push(P("A shape is shown. Use the diagram to answer the question."));
                    if (type === "ratio") prompt.push(P("A bar model is shown. Use it to compare quantities."));
                    if (type === "grid") prompt.push(P("A coordinate grid is shown. Use it to read points or distances."));
                    if (type === "array") prompt.push(P("A grid/array is shown. Use it to spot a pattern."));
                    prompt.push(DIAG(type, "Diagram for question " + id));
                } else {
                    prompt.push(P(`Work out $${i * 11} \\div ${i % 6 + 2}$.`));
                }

                let answerStr = has ? (type === "geometry" ? "$42$" : type === "ratio" ? "$12$" : type === "grid" ? "$5$" : "$16$") : `$${Math.floor((i * 11) / (i % 6 + 2))}$`;
                const details = SD({
                    guidance: (i % 5 === 0) ? ["Use BIDMAS to apply the correct order of operations."] : null,
                    formulae: (has && type === "geometry") ? ["$A=\\dfrac12 bh$"] : null,
                    working: has
                        ? [
                            P("Read the information directly from the diagram, then do one clear calculation."),
                            MB(String.raw`\begin{aligned}\text{(sample working)}\quad 7\times 6 &= 42\end{aligned}`)
                        ]
                        : [MB(String.raw`\begin{aligned}${i * 11}\div ${i % 6 + 2} &= ${Math.floor((i * 11) / (i % 6 + 2))}\end{aligned}`)]
                });

                qs.push(Q({
                    id,
                    prompt,
                    answer: [P(answerStr)],
                    details
                }));
            }

            return {
                key: "diagram",
                title: "Diagram-heavy paper",
                sections: [{ label: null, questions: qs }]
            };
        }

        function buildSectioned() {
            const sections = [];

            // Section A: 35 small/medium
            const A = [];
            for (let i = 1; i <= 35; i++) {
                const id = String(i);
                const prompt = [P(`Section A: Work out $${i * 7} + ${i * 4}$.`)];
                const ans = i * 7 + i * 4;
                const details = SD({
                    working: [MB(String.raw`\begin{aligned}${i * 7}+${i * 4} &= ${ans}\end{aligned}`)],
                    guidance: (i === 6 || i === 14 || i === 21) ? ["Use BIDMAS to apply the correct order of operations."] : null,
                    formulae: (i === 9 || i === 18 || i === 27) ? ["$\\text{Percentage} = \\dfrac{\\text{part}}{\\text{whole}}\\times 100\\%$"] : null,
                    alt: (i === 10 || i === 22 || i === 30) ? [{ blocks: [P("Use a different regrouping of terms."), MB(String.raw`\begin{aligned}(${i * 7}+${i * 4}) &= ${i}(7+4) = ${i * 11}\end{aligned}`)] }] : null
                });
                A.push(Q({ id, prompt, answer: [P(`$${ans}$`)], details }));
            }
            sections.push({ label: "A", questions: A });

            // Section B: 8 medium
            const B = [];
            for (let i = 1; i <= 8; i++) {
                const id = String(35 + i);
                const prompt = [
                    P(`Section B: Solve $2x+${i * 3}= ${i * 10 + 26}$.`)
                ];
                const x = ((i * 10 + 26) - (i * 3)) / 2;
                const details = SD({
                    guidance: ["Do the same operation to both sides and isolate the variable."],
                    working: [MB(String.raw`\begin{aligned}2x+${i * 3} &= ${i * 10 + 26}\\ 2x &= ${i * 10 + 26}-${i * 3}\\ 2x &= ${i * 7 + 26}\\ x &= ${x}\end{aligned}`)]
                });
                B.push(Q({ id, prompt, answer: [P(`$x=${x}$`)], details }));
            }
            sections.push({ label: "B", questions: B });

            // Section C: 6 very long solution details (collapsed by default)
            const C = [];
            const start = 43;
            for (let j = 0; j < 6; j++) {
                const id = String(start + j);
                const prompt = [
                    P("Section C: A long algebra question with many steps. Simplify and solve carefully."),
                    MB(String.raw`\text{Given}\quad (x+` + (j + 4) + String.raw`)^2 - (x-` + (j + 4) + String.raw`)^2 = ` + (j + 1) * 16)
                ];
                const x = ((j + 1) * 16) / (4 * (j + 4)); // from (A^2-B^2) = (2a)(2x) = 4ax
                const lines = [];
                lines.push(String.raw`(x+a)^2-(x-a)^2 = ((x+a)-(x-a))((x+a)+(x-a))`);
                lines.push(String.raw`= (2a)(2x) = 4ax`);
                lines.push(String.raw`4ax = ` + (j + 1) * 16);
                lines.push(String.raw`x = \dfrac{` + (j + 1) * 16 + String.raw`}{4a}`);
                lines.push(String.raw`a = ` + (j + 4));
                lines.push(String.raw`x = \dfrac{` + (j + 1) * 16 + String.raw`}{4\times ` + (j + 4) + String.raw`} = ` + (x));
                // add a lot more lines to stress-test
                for (let k = 1; k <= 52; k++) {
                    lines.push(String.raw`\text{extra step ` + k + String.raw`: }\quad x = \dfrac{` + (j + 1) * 16 + String.raw`}{4(` + (j + 4) + String.raw`)} \ \text{(re-stated for clarity)}`);
                    if (k % 10 === 0) {
                        lines.push(String.raw`\dfrac{(12345678901234567890x+` + (k * 7) + String.raw`)}{(x+` + (k * 3) + String.raw`)} \ \text{(overflow stress line)}`);
                    }
                }
                const details = SD({
                    guidance: ["Keep the working in a clear chain of equalities. Don’t skip the algebra step that cancels."],
                    formulae: ["$(A^2-B^2)=(A-B)(A+B)$"],
                    working: [MB(longAligned(lines))],
                    alt: [{
                        blocks: [
                            P("Alternative approach: expand both brackets, then subtract."),
                            MB(String.raw`\begin{aligned}(x+a)^2-(x-a)^2 &= (x^2+2ax+a^2)-(x^2-2ax+a^2)\\ &= 4ax\end{aligned}`)
                        ]
                    }]
                });
                C.push(Q({ id, prompt, answer: [P(`$x=${x}$`)], details }));
            }
            sections.push({ label: "C", questions: C });

            return { key: "sectioned", title: "Sectioned paper", sections };
        }

        /*****************
         * Render engine *
         *****************/
        const elPaper = document.getElementById("paper");
        const elNav = document.getElementById("navList");
        const elDrawerNav = document.getElementById("drawerNavList");

        function renderParts(parts, parent) {
            parts.forEach(part => {
                if (part.t === "text") {
                    parent.appendChild(document.createTextNode(part.v));
                } else if (part.t === "mi") {
                    const span = document.createElement("span");
                    span.className = "math-inline";
                    span.setAttribute("data-math", part.v);
                    span.textContent = part.v; // fallback
                    parent.appendChild(span);
                }
            });
        }

        function renderBlock(block, parent) {
            if (block.kind === "p") {
                const p = document.createElement("p");
                renderParts(block.parts, p);
                parent.appendChild(p);
            } else if (block.kind === "mb") {
                const wrap = document.createElement("div");
                wrap.className = "math-block";
                const inner = document.createElement("div");
                inner.className = "math-block-inner";
                inner.setAttribute("data-math", block.expr);
                inner.textContent = block.expr; // fallback
                wrap.appendChild(inner);
                parent.appendChild(wrap);
            } else if (block.kind === "diagram") {
                const d = document.createElement("div");
                d.className = "diagram";
                d.innerHTML = diagramSVG(block.type);
                if (block.caption) {
                    const cap = document.createElement("div");
                    cap.className = "diagram-caption";
                    cap.textContent = block.caption;
                    d.appendChild(cap);
                }
                parent.appendChild(d);
            } else if (block.kind === "table") {
                const t = document.createElement("table");
                const thead = document.createElement("thead");
                const trh = document.createElement("tr");
                block.headers.forEach(h => {
                    const th = document.createElement("th");
                    renderParts(partsFromText(h), th);
                    trh.appendChild(th);
                });
                thead.appendChild(trh);
                t.appendChild(thead);

                const tb = document.createElement("tbody");
                block.rows.forEach(row => {
                    const tr = document.createElement("tr");
                    row.forEach(cell => {
                        const td = document.createElement("td");
                        renderParts(partsFromText(String(cell)), td);
                        tr.appendChild(td);
                    });
                    tb.appendChild(tr);
                });
                t.appendChild(tb);
                parent.appendChild(t);
            }
        }

        function makeChevron() {
            const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            svg.setAttribute("viewBox", "0 0 20 20");
            svg.classList.add("chev");
            const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
            path.setAttribute("d", "M5 7.5l5 5 5-5");
            path.setAttribute("fill", "none");
            path.setAttribute("stroke", "currentColor");
            path.setAttribute("stroke-width", "2");
            path.setAttribute("stroke-linecap", "round");
            path.setAttribute("stroke-linejoin", "round");
            svg.appendChild(path);
            return svg;
        }

        function renderSolutionDetails(details, expandedByDefault) {
            const sol = document.createElement("div");
            sol.className = "solution";
            sol.hidden = !expandedByDefault;

            function addBlock(label, bodyNode) {
                const wrap = document.createElement("div");
                wrap.className = "sd-block";
                const lab = document.createElement("div");
                lab.className = "sd-label";
                lab.textContent = label;
                wrap.appendChild(lab);

                const body = document.createElement("div");
                body.className = "sd-body";
                body.appendChild(bodyNode);
                wrap.appendChild(body);

                sol.appendChild(wrap);
            }

            // Ordering (add-on): Guidance, Formulae Used, Working, Alternative working
            if (details.guidance && details.guidance.length) {
                const ul = document.createElement("ul");
                details.guidance.forEach(line => {
                    const li = document.createElement("li");
                    renderParts(partsFromText(line), li);
                    ul.appendChild(li);
                });
                addBlock("Guidance", ul);
            }

            if (details.formulae && details.formulae.length) {
                const ul = document.createElement("ul");
                details.formulae.forEach(line => {
                    const li = document.createElement("li");
                    renderParts(partsFromText(line), li);
                    ul.appendChild(li);
                });
                addBlock("Formulae Used", ul);
            }

            if (details.working && details.working.length) {
                const box = document.createElement("div");
                details.working.forEach(b => renderBlock(b, box));
                addBlock("Working", box);
            }

            if (details.alt && details.alt.length) {
                details.alt.forEach((altObj) => {
                    const box = document.createElement("div");
                    (altObj.blocks || []).forEach(b => renderBlock(b, box));
                    addBlock("Alternative working", box);
                });
            }

            return sol;
        }

        function animateToggle(solutionEl, expanded) {
            const reduce = window.matchMedia("(prefers-reduced-motion: reduce)").matches;
            if (reduce) {
                solutionEl.hidden = !expanded;
                solutionEl.style.height = "";
                return;
            }

            if (expanded) {
                solutionEl.hidden = false;
                solutionEl.style.height = "0px";
                solutionEl.style.transition = "height 160ms ease";
                requestAnimationFrame(() => {
                    const h = solutionEl.scrollHeight;
                    solutionEl.style.height = h + "px";
                });
                const done = () => {
                    solutionEl.style.transition = "";
                    solutionEl.style.height = "";
                    solutionEl.removeEventListener("transitionend", done);
                };
                solutionEl.addEventListener("transitionend", done);
            } else {
                const h = solutionEl.scrollHeight;
                solutionEl.style.height = h + "px";
                solutionEl.style.transition = "height 160ms ease";
                requestAnimationFrame(() => {
                    solutionEl.style.height = "0px";
                });
                const done = () => {
                    solutionEl.hidden = true;
                    solutionEl.style.transition = "";
                    solutionEl.style.height = "";
                    solutionEl.removeEventListener("transitionend", done);
                };
                solutionEl.addEventListener("transitionend", done);
            }
        }

        function stableIdFromQid(qid) {
            return "q-" + qid
                .replaceAll("(", "-")
                .replaceAll(")", "")
                .replaceAll(".", "-")
                .replaceAll(" ", "")
                .replaceAll(":", "")
                .replaceAll("/", "-");
        }

        function renderDataset(ds) {
            // Paper
            elPaper.innerHTML = "";
            // Nav
            elNav.innerHTML = "";
            elDrawerNav.innerHTML = "";

            const defaultExpanded = !!ds.defaultExpanded;

            const allQuestionEls = [];
            const navItems = [];

            ds.sections.forEach(section => {
                if (section.label) {
                    const sh = document.createElement("div");
                    sh.className = "section-header";
                    sh.textContent = section.label;
                    elPaper.appendChild(sh);
                }

                section.questions.forEach(q => {
                    if (q.sectionLabel) {
                        // not used, but reserved
                    }

                    // Question wrapper
                    const sec = document.createElement("section");
                    sec.className = `q depth-${q.depth || 0}`;
                    const domId = stableIdFromQid(q.id);
                    sec.id = domId;
                    sec.setAttribute("data-qid", q.id);

                    // Question line
                    const line = document.createElement("div");
                    line.className = "q-line";

                    const qid = document.createElement("div");
                    qid.className = "qid";
                    qid.textContent = q.id;

                    const prompt = document.createElement("div");
                    prompt.className = "q-prompt";
                    q.prompt.forEach(b => renderBlock(b, prompt));

                    line.appendChild(qid);
                    line.appendChild(prompt);
                    sec.appendChild(line);

                    // Answer
                    const ans = document.createElement("div");
                    ans.className = "answer";
                    const lab = document.createElement("div");
                    lab.className = "label";
                    lab.textContent = "Answer";
                    const val = document.createElement("div");
                    val.className = "value";

                    if (q.answer.length === 1) {
                        renderBlock(q.answer[0], val);
                    } else {
                        const ul = document.createElement("ul");
                        q.answer.forEach(a => {
                            const li = document.createElement("li");
                            if (a.kind === "p") {
                                renderParts(a.parts, li);
                            } else {
                                // fallback
                                li.textContent = (a.expr || "");
                            }
                            ul.appendChild(li);
                        });
                        val.appendChild(ul);
                    }

                    ans.appendChild(lab);
                    ans.appendChild(val);
                    sec.appendChild(ans);

                    // Solution toggle + details (if present)
                    if (q.details) {
                        const btn = document.createElement("button");
                        btn.type = "button";
                        btn.className = "disclosure";
                        btn.setAttribute("aria-expanded", defaultExpanded ? "true" : "false");
                        btn.appendChild(makeChevron());
                        const txt = document.createElement("span");
                        txt.textContent = defaultExpanded ? "Hide working" : "Show working";
                        btn.appendChild(txt);

                        const sol = renderSolutionDetails(q.details, defaultExpanded);

                        btn.addEventListener("click", () => {
                            const isOpen = btn.getAttribute("aria-expanded") === "true";
                            const next = !isOpen;
                            btn.setAttribute("aria-expanded", next ? "true" : "false");
                            txt.textContent = next ? "Hide working" : "Show working";
                            animateToggle(sol, next);
                            // KaTeX might need re-rendering if newly shown
                            if (next) requestAnimationFrame(() => renderKaTeXWithin(sol));
                        });

                        sec.appendChild(btn);
                        sec.appendChild(sol);
                    }

                    elPaper.appendChild(sec);
                    allQuestionEls.push(sec);

                    // Navigation item (question identifiers only)
                    navItems.push({
                        id: q.id,
                        domId,
                        sectionLabel: section.label || null
                    });
                });
            });

            // Build nav (desktop + drawer), with section separators for Sectioned paper
            function buildNav(container, isDrawer) {
                let lastSection = null;
                navItems.forEach(item => {
                    if (ds.sections.some(s => s.label) && item.sectionLabel !== lastSection) {
                        lastSection = item.sectionLabel;
                        if (lastSection) {
                            const sep = document.createElement("div");
                            sep.className = "nav-section";
                            sep.textContent = lastSection;
                            container.appendChild(sep);
                        }
                    }
                    const a = document.createElement("a");
                    a.className = "nav-item";
                    a.href = "#" + item.domId;
                    a.textContent = item.id;
                    a.setAttribute("data-target", item.domId);
                    a.addEventListener("click", (e) => {
                        e.preventDefault();
                        const target = document.getElementById(item.domId);
                        if (!target) return;

                        const reduce = window.matchMedia("(prefers-reduced-motion: reduce)").matches;
                        target.scrollIntoView({ behavior: reduce ? "auto" : "smooth", block: "start" });

                        if (isDrawer) closeDrawer();
                    });
                    container.appendChild(a);
                });
            }
            buildNav(elNav, false);
            buildNav(elDrawerNav, true);

            // Observe current question (quiet active state)
            setupActiveTracking(allQuestionEls);

            // Render KaTeX for initial view
            renderKaTeX();

            // Ensure focusable content hidden in collapsed solution details
            // (handled via hidden and display:none)
        }

        /********************
         * KaTeX rendering  *
         ********************/
        function safeRenderKaTeX(el, displayMode) {
            if (!window.katex || typeof window.katex.render !== "function") return;
            const expr = el.getAttribute("data-math");
            if (!expr) return;
            try {
                window.katex.render(expr, el, {
                    displayMode,
                    throwOnError: false,
                    strict: false,
                    trust: true
                });
            } catch (e) {
                // keep fallback text; do not hide content
            }
        }
        function renderKaTeX() {
            // Inline
            document.querySelectorAll(".math-inline[data-math]").forEach(el => safeRenderKaTeX(el, false));
            // Block
            document.querySelectorAll(".math-block-inner[data-math]").forEach(el => safeRenderKaTeX(el, true));
        }
        function renderKaTeXWithin(root) {
            if (!root) return;
            root.querySelectorAll(".math-inline[data-math]").forEach(el => safeRenderKaTeX(el, false));
            root.querySelectorAll(".math-block-inner[data-math]").forEach(el => safeRenderKaTeX(el, true));
        }

        // Re-render once KaTeX script loads (in case defer order)
        window.addEventListener("load", () => { renderKaTeX(); });

        /*******************************
         * Active nav item (observer)  *
         *******************************/
        let observer = null;
        function setupActiveTracking(questionEls) {
            if (observer) observer.disconnect();

            const navLinks = Array.from(document.querySelectorAll(".nav-item[data-target]"));
            const byId = new Map(navLinks.map(a => [a.getAttribute("data-target"), a]));

            function setCurrent(domId) {
                navLinks.forEach(a => {
                    a.setAttribute("aria-current", a.getAttribute("data-target") === domId ? "true" : "false");
                });
                // Mirror in drawer list
                const drawerLinks = Array.from(document.querySelectorAll("#drawerNavList .nav-item[data-target]"));
                drawerLinks.forEach(a => {
                    a.setAttribute("aria-current", a.getAttribute("data-target") === domId ? "true" : "false");
                });
            }

            const reduce = window.matchMedia("(prefers-reduced-motion: reduce)").matches;
            observer = new IntersectionObserver((entries) => {
                // Choose the entry closest to top and intersecting
                const visible = entries.filter(e => e.isIntersecting);
                if (!visible.length) return;

                visible.sort((a, b) => Math.abs(a.boundingClientRect.top) - Math.abs(b.boundingClientRect.top));
                const best = visible[0];
                const domId = best.target.id;

                setCurrent(domId);

                // For long nav lists, keep current item in view without forcing big scroll jumps (quiet)
                const link = byId.get(domId);
                if (link) {
                    const navList = document.getElementById("navList");
                    const r = link.getBoundingClientRect();
                    const nr = navList.getBoundingClientRect();
                    const outTop = r.top < nr.top + 10;
                    const outBot = r.bottom > nr.bottom - 10;
                    if ((outTop || outBot) && !reduce) {
                        link.scrollIntoView({ block: "nearest" });
                    }
                }
            }, { root: null, threshold: [0.15], rootMargin: "-20% 0px -70% 0px" });

            questionEls.forEach(el => observer.observe(el));
        }

        /********************
         * Drawer behaviour *
         ********************/
        const jumpBtn = document.getElementById("jumpBtn");
        const drawerOverlay = document.getElementById("drawerOverlay");
        const drawer = document.getElementById("navDrawer");
        const drawerClose = document.getElementById("drawerClose");

        let lastFocus = null;

        function openDrawer() {
            lastFocus = document.activeElement;
            document.body.classList.add("drawer-open");
            drawerOverlay.hidden = false;
            drawerOverlay.style.display = "block";
            // basic focus management (no background interaction while open)
            setTimeout(() => drawerClose.focus(), 0);
        }
        function closeDrawer() {
            document.body.classList.remove("drawer-open");
            drawerOverlay.hidden = true;
            drawerOverlay.style.display = "none";
            if (lastFocus && typeof lastFocus.focus === "function") lastFocus.focus();
        }

        jumpBtn.addEventListener("click", openDrawer);
        drawerClose.addEventListener("click", closeDrawer);
        drawerOverlay.addEventListener("click", closeDrawer);

        // simple focus trap
        drawer.addEventListener("keydown", (e) => {
            if (e.key === "Escape") {
                e.preventDefault();
                closeDrawer();
                return;
            }
            if (e.key !== "Tab") return;

            const focusables = drawer.querySelectorAll("button, a[href], [tabindex]:not([tabindex='-1'])");
            const list = Array.from(focusables).filter(el => !el.hasAttribute("disabled"));
            if (!list.length) return;

            const first = list[0];
            const last = list[list.length - 1];

            if (e.shiftKey && document.activeElement === first) {
                e.preventDefault(); last.focus();
            } else if (!e.shiftKey && document.activeElement === last) {
                e.preventDefault(); first.focus();
            }
        });

        /**********************
         * Paper selector UI  *
         **********************/
        const datasets = {
            short: buildShort(),
            standard: buildStandard({ expanded: false }),
            standardExpanded: buildStandard({ expanded: true }),
            diagram: buildDiagramHeavy(),
            sectioned: buildSectioned()
        };

        const select = document.getElementById("paperSelect");
        const options = [
            ["short", datasets.short.title],
            ["standard", datasets.standard.title],
            ["standardExpanded", datasets.standardExpanded.title],
            ["diagram", datasets.diagram.title],
            ["sectioned", datasets.sectioned.title]
        ];

        options.forEach(([k, label]) => {
            const opt = document.createElement("option");
            opt.value = k;
            opt.textContent = label;
            select.appendChild(opt);
        });

        select.addEventListener("change", () => {
            const key = select.value;
            renderDataset(datasets[key]);
            // Keep focus stable: do not auto-move it.
        });

        // Initial render
        select.value = "standard";
        renderDataset(datasets.standard);
    </script>
</body>

</html>