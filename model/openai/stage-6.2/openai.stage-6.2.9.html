<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>RTQ â€“ Maths Paper Solution Viewer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- KaTeX -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Markdown-it -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@13.0.1/dist/markdown-it.min.js"></script>

    <style>
        :root {
            --bg-page: #f6f5f3;
            --bg-surface: #ffffff;
            --bg-solution: #f9f8f6;
            --text-main: #1f1f1f;
            --text-subtle: #5f5f5f;
            --hairline: #dddddd;
            --accent: #6a6a6a;
            --math-underlay: #f1f0ee;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            background: var(--bg-page);
            color: var(--text-main);
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            line-height: 1.5;
        }

        /* Top controls */
        header {
            padding: 16px;
            border-bottom: 1px solid var(--hairline);
        }

        .frame {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 16px;
        }

        header .frame {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        select {
            font-size: 14px;
            padding: 4px 6px;
        }

        /* Main layout */
        main.frame {
            display: grid;
            grid-template-columns: 160px 1fr;
            gap: 32px;
            padding: 24px 16px 64px;
            background: var(--bg-surface);
        }

        nav {
            position: sticky;
            top: 24px;
            align-self: start;
            max-height: calc(100vh - 48px);
            overflow-y: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        nav::-webkit-scrollbar {
            display: none;
        }

        nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
            font-size: 13px;
            color: var(--text-subtle);
        }

        nav li {
            margin: 4px 0;
        }

        nav button {
            all: unset;
            cursor: pointer;
            padding: 2px 0;
        }

        nav button:hover,
        nav button:focus {
            text-decoration: underline;
            outline: none;
        }

        nav button.active {
            font-weight: 600;
        }

        .section-label {
            margin: 12px 0 4px;
            font-size: 12px;
            color: var(--text-subtle);
        }

        /* Paper content */
        .paper {
            max-width: 720px;
        }

        .question-block {
            margin-bottom: 48px;
        }

        .question-header {
            font-size: 18px;
            margin-bottom: 12px;
        }

        .question-id {
            margin-right: 6px;
            color: var(--text-subtle);
        }

        .answer {
            margin: 8px 0 4px;
            font-size: 15px;
        }

        .answer-label {
            font-weight: 600;
            margin-right: 6px;
        }

        .toggle {
            margin-top: 6px;
            font-size: 14px;
            color: var(--accent);
            background: none;
            border: none;
            padding: 0;
            cursor: pointer;
        }

        .toggle:hover,
        .toggle:focus {
            text-decoration: underline;
            outline: none;
        }

        .solution {
            margin-top: 16px;
            padding-top: 12px;
            background: var(--bg-solution);
        }

        .solution[hidden] {
            display: none;
        }

        .solution-section {
            margin-bottom: 16px;
        }

        .solution-section h4 {
            margin: 0 0 6px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-main);
        }

        .solution-section .body {
            font-size: 14px;
            color: var(--text-subtle);
        }

        /* Markdown content */
        .body p {
            margin: 0 0 8px;
        }

        .body ul {
            margin: 0 0 8px 20px;
        }

        .body table {
            border-collapse: collapse;
            margin: 8px 0;
            font-size: 13px;
        }

        .body td,
        .body th {
            border: 1px solid var(--hairline);
            padding: 4px 6px;
        }

        /* KaTeX containment */
        .katex-display {
            overflow-x: auto;
            background: var(--math-underlay);
            padding: 6px 8px;
            margin: 8px 0;
        }

        .katex {
            font-size: 1em;
        }

        @media (max-width: 768px) {
            main.frame {
                grid-template-columns: 1fr;
            }

            nav {
                position: static;
                max-height: none;
                margin-bottom: 24px;
            }
        }
    </style>
</head>

<body>
    <header>
        <div class="frame">
            <label for="paperSelect">Paper:</label>
            <select id="paperSelect"></select>
        </div>
    </header>

    <main class="frame">
        <nav aria-label="Question navigation">
            <ul id="navList"></ul>
        </nav>

        <article class="paper" id="paperContent" aria-live="polite"></article>
    </main>

    <script>
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.json";

        const md = window.markdownit({ html: true });
        md.inline.ruler.disable(['escape']);

        const paperSelect = document.getElementById('paperSelect');
        const navList = document.getElementById('navList');
        const paperContent = document.getElementById('paperContent');

        let payload = null;

        fetch(RTQ_PAPERS_PAYLOAD_PATH)
            .then(r => r.json())
            .then(data => {
                payload = data;
                initSelector();
                renderPaper(0);
            })
            .catch(() => {
                paperContent.textContent = "PAPERS PAYLOAD MISSING";
            });

        function initSelector() {
            payload.papers.forEach((p, i) => {
                const opt = document.createElement('option');
                opt.value = i;
                opt.textContent = p.label;
                paperSelect.appendChild(opt);
            });
            paperSelect.addEventListener('change', e => {
                renderPaper(parseInt(e.target.value, 10));
            });
        }

        function renderPaper(index) {
            const paper = payload.papers[index];
            navList.innerHTML = '';
            paperContent.innerHTML = '';

            const navItems = [];

            function renderQuestion(q, depth = 0) {
                const block = document.createElement('section');
                block.className = 'question-block';
                block.id = 'q-' + q.id;

                const header = document.createElement('div');
                header.className = 'question-header';
                header.innerHTML =
                    '<span class="question-id">' + q.id + '</span>' +
                    md.renderInline(q.question || '');
                block.appendChild(header);

                if (q.answer) {
                    const ans = document.createElement('div');
                    ans.className = 'answer';
                    ans.innerHTML =
                        '<span class="answer-label">Answer</span>' +
                        md.renderInline(q.answer);
                    block.appendChild(ans);
                }

                let solutionEl = null;
                if (q.solutionDetails) {
                    const toggle = document.createElement('button');
                    toggle.className = 'toggle';
                    toggle.textContent = 'Show working';
                    toggle.addEventListener('click', () => {
                        const expanded = !solutionEl.hasAttribute('hidden');
                        solutionEl.toggleAttribute('hidden');
                        toggle.textContent = expanded ? 'Show working' : 'Hide working';
                    });
                    block.appendChild(toggle);

                    solutionEl = document.createElement('div');
                    solutionEl.className = 'solution';
                    if (!(paper.defaults && paper.defaults.expandedAll)) {
                        solutionEl.setAttribute('hidden', '');
                    } else {
                        toggle.textContent = 'Hide working';
                    }

                    addSolutionSection(solutionEl, 'Keep in mind', q.solutionDetails.keepInMind);
                    addSolutionSection(solutionEl, 'Formulas used', q.solutionDetails.formulasUsed);
                    addSolutionSection(solutionEl, 'Working', q.solutionDetails.working);
                    addSolutionSection(solutionEl, 'Alternative working', q.solutionDetails.alternativeWorking);

                    block.appendChild(solutionEl);
                }

                paperContent.appendChild(block);
                navItems.push(q.id);

                if (q.children) {
                    q.children.forEach(c => renderQuestion(c, depth + 1));
                }
            }

            function addSolutionSection(container, title, content) {
                if (!content) return;
                const sec = document.createElement('div');
                sec.className = 'solution-section';
                const h = document.createElement('h4');
                h.textContent = title;
                const body = document.createElement('div');
                body.className = 'body';
                body.innerHTML = md.render(content);
                sec.appendChild(h);
                sec.appendChild(body);
                container.appendChild(sec);
            }

            if (paper.questions) {
                paper.questions.forEach(q => renderQuestion(q));
            } else if (paper.sections) {
                paper.sections.forEach(sec => {
                    const label = document.createElement('div');
                    label.className = 'section-label';
                    label.textContent = sec.label;
                    paperContent.appendChild(label);
                    sec.questions.forEach(q => renderQuestion(q));
                });
            }

            navItems.forEach(id => {
                const li = document.createElement('li');
                const btn = document.createElement('button');
                btn.textContent = id;
                btn.addEventListener('click', () => {
                    document.getElementById('q-' + id).scrollIntoView({ behavior: 'smooth' });
                });
                li.appendChild(btn);
                navList.appendChild(li);
            });

            renderMathInElement(paperContent, {
                delimiters: [
                    { left: "$$", right: "$$", display: true },
                    { left: "$", right: "$", display: false }
                ]
            });
        }
    </script>
</body>

</html>