<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RTQ – Maths Paper Solution Viewer (Stress Test)</title>

  <!-- KaTeX (CDN) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"
    integrity="sha384-n8MVd4RsNIU0vJm8dQGQqkOKQqjzHkz8e7e3oCw8b1QmO5vS8XJk8m3o4mZgY8Jr" crossorigin="anonymous">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"
    integrity="sha384-+KpWv9xjvC3mG5wqJ8J8o7u9o2nqkz9u3jCkq9l0y1xv3V1qvOq2j7cS0qH3rQxS"
    crossorigin="anonymous"></script>

  <style>
    :root {
      --bg: #ffffff;
      --text: #111111;
      --muted: #4b4b4b;
      --faint: #7a7a7a;
      --line: #e2e2e2;
      --line2: #f0f0f0;

      --frame-max: 1200px;
      --gutter: clamp(14px, 3vw, 26px);
      --nav-w: 140px;

      --radius: 10px;

      --q-gap: 26px;
      /* between top-level questions (largest) */
      --unit-gap: 10px;
      /* within a question */
      --sub-gap: 16px;
      --subsub-gap: 12px;

      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      height: 100%;
    }

    body {
      margin: 0;
      font-family: var(--font);
      color: var(--text);
      background: var(--bg);
      line-height: 1.5;
      overflow-x: hidden;
      /* main document never scrolls horizontally */
    }

    /* Top controls */
    header {
      position: sticky;
      top: 0;
      z-index: 30;
      background: var(--bg);
      border-bottom: 1px solid var(--line2);
    }

    .topbar {
      max-width: var(--frame-max);
      margin: 0 auto;
      padding: 12px var(--gutter);
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
    }

    .controls {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      min-width: 0;
    }

    .label {
      font-size: 13px;
      color: var(--muted);
    }

    select {
      font: inherit;
      font-size: 14px;
      padding: 8px 10px;
      border: 1px solid var(--line);
      border-radius: 8px;
      background: #fff;
      color: var(--text);
    }

    .jumpBtn {
      font: inherit;
      font-size: 14px;
      padding: 8px 10px;
      border: 1px solid var(--line);
      border-radius: 8px;
      background: #fff;
      color: var(--text);
      cursor: pointer;
    }

    .jumpBtn:focus,
    select:focus,
    button:focus,
    a:focus {
      outline: 2px solid #000;
      outline-offset: 2px;
    }

    .frame {
      max-width: var(--frame-max);
      margin: 0 auto;
      padding: 16px var(--gutter) 48px;
      display: grid;
      grid-template-columns: var(--nav-w) minmax(0, 1fr);
      gap: 18px;
      align-items: start;
    }

    /* Navigation rail (desktop/tablet) */
    nav[aria-label="Paper navigation"] {
      position: sticky;
      top: 64px;
      /* below top bar */
      align-self: start;
      max-height: calc(100vh - 80px);
      padding-right: 6px;
    }

    .navTitle {
      font-size: 12px;
      color: var(--faint);
      margin: 0 0 8px 0;
      letter-spacing: 0.01em;
    }

    .navList {
      display: flex;
      flex-direction: column;
      gap: 2px;
      overflow: auto;
      padding-right: 6px;
      max-height: calc(100vh - 110px);

      /* Hide scrollbar visually but keep functional */
      scrollbar-width: none;
      /* Firefox */
      -ms-overflow-style: none;
      /* legacy */
    }

    .navList::-webkit-scrollbar {
      display: none;
    }

    .navSep {
      font-size: 12px;
      color: var(--faint);
      margin: 10px 0 4px;
      padding-top: 8px;
      border-top: 1px solid var(--line2);
    }

    .navItem {
      display: block;
      width: 100%;
      text-decoration: none;
      color: var(--muted);
      padding: 4px 6px;
      border-radius: 8px;
      font-size: 14px;
      line-height: 1.25;
    }

    .navItem:hover {
      color: var(--text);
    }

    .navItem[aria-current="true"] {
      color: var(--text);
      font-weight: 700;
      /* allowed: current nav item */
      background: #f7f7f7;
    }

    /* Paper content */
    main {
      min-width: 0;
    }

    .paperMeta {
      font-size: 12px;
      color: var(--faint);
      margin: 0 0 14px 0;
    }

    .paper {
      display: flex;
      flex-direction: column;
      gap: var(--q-gap);
    }

    .q {
      scroll-margin-top: 90px;
      /* ensure anchors land below sticky header */
    }

    /* spacing-only separation: no cards, no heavy boxes */
    .qInner {
      padding: 0;
      border: none;
      background: transparent;
    }

    .qHead {
      display: flex;
      gap: 10px;
      align-items: baseline;
    }

    .qid {
      font-size: 16px;
      color: var(--muted);
      min-width: 40px;
      flex: 0 0 auto;
    }

    .qPrompt {
      font-size: 18px;
      line-height: 1.6;
      flex: 1 1 auto;
      min-width: 0;
    }

    .qBody {
      margin-top: var(--unit-gap);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .answerRow {
      display: flex;
      gap: 10px;
      align-items: baseline;
      flex-wrap: wrap;
    }

    .answerLabel {
      font-size: 13px;
      color: var(--muted);
      font-weight: 700;
      letter-spacing: 0.01em;
    }

    .answerValue {
      font-size: 15px;
      color: var(--text);
    }

    .toggleRow {
      display: flex;
      align-items: baseline;
      gap: 10px;
      flex-wrap: wrap;
    }

    .toggleBtn {
      font: inherit;
      border: none;
      background: transparent;
      padding: 0;
      color: var(--muted);
      cursor: pointer;
      text-decoration: underline;
      font-size: 14px;
    }

    .toggleBtn:hover {
      color: var(--text);
    }

    .toggleBtn .chev {
      display: inline-block;
      width: 1em;
      text-align: center;
      margin-left: 6px;
      color: var(--faint);
    }

    .collapsedPreview {
      font-size: 13px;
      color: var(--faint);
      margin-top: 2px;
      max-width: 72ch;
    }

    .soln {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      color: var(--text);
    }

    .solnBlockTitle {
      font-size: 13px;
      font-weight: 700;
      color: var(--muted);
      margin: 0;
    }

    .solnBlockBody {
      font-size: 14px;
      color: var(--text);
      line-height: 1.5;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .solnBlockBody p {
      margin: 0;
    }

    /* KaTeX + overflow handling: allowed only inside math blocks */
    .math-inline {
      display: inline;
      vertical-align: baseline;
    }

    .math-block {
      overflow-x: auto;
      overflow-y: hidden;
      max-width: 100%;
      padding: 2px 0;
      scrollbar-width: thin;
      /* keep usable */
    }

    .math-block:focus {
      outline: 2px solid #000;
      outline-offset: 2px;
    }

    /* Diagrams inside question block (SVG placeholders) */
    .diagram {
      max-width: 520px;
      width: 100%;
    }

    .diagram svg {
      width: 100%;
      height: auto;
      display: block;
    }

    /* Nesting via indentation only */
    .depth-0 {
      margin-left: 0;
    }

    .depth-1 {
      margin-left: 18px;
    }

    .depth-2 {
      margin-left: 34px;
    }

    .depth-3 {
      margin-left: 50px;
    }

    .depth-0+.depth-0 {
      margin-top: var(--q-gap);
    }

    .depth-1 {
      margin-top: var(--sub-gap);
    }

    .depth-2 {
      margin-top: var(--subsub-gap);
    }

    .depth-3 {
      margin-top: 10px;
    }

    /* Section headers (for sectioned paper): structural dividers, not containers */
    .sectionHdr {
      margin: 22px 0 0;
      padding-top: 12px;
      border-top: 1px solid var(--line);
      color: var(--muted);
      font-weight: 700;
      letter-spacing: 0.01em;
    }

    /* Mobile navigation drawer */
    .drawerBackdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.25);
      z-index: 40;
      display: none;
    }

    .drawer {
      position: fixed;
      top: 0;
      right: 0;
      height: 100%;
      width: min(360px, 86vw);
      background: var(--bg);
      border-left: 1px solid var(--line);
      z-index: 50;
      transform: translateX(105%);
      transition: transform 160ms linear;
      display: flex;
      flex-direction: column;
    }

    .drawerHeader {
      padding: 12px 12px 10px;
      border-bottom: 1px solid var(--line2);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .drawerHeader .title {
      font-size: 14px;
      color: var(--muted);
      font-weight: 700;
      margin: 0;
    }

    .drawerClose {
      font: inherit;
      font-size: 14px;
      padding: 6px 10px;
      border: 1px solid var(--line);
      border-radius: 8px;
      background: #fff;
      color: var(--text);
      cursor: pointer;
    }

    .drawerNav {
      padding: 10px 10px 18px;
      overflow: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .drawerNav::-webkit-scrollbar {
      display: none;
    }

    /* Responsive */
    @media (max-width: 920px) {
      :root {
        --nav-w: 120px;
      }

      .qid {
        min-width: 34px;
      }

      .qPrompt {
        font-size: 17px;
      }
    }

    @media (max-width: 780px) {
      .frame {
        grid-template-columns: 1fr;
      }

      nav[aria-label="Paper navigation"] {
        display: none;
      }

      :root {
        --q-gap: 22px;
      }

      .qPrompt {
        font-size: 16px;
      }

      .qid {
        font-size: 15px;
      }
    }

    /* Utility: visually hidden (keep for accessibility) */
    .srOnly {
      position: absolute !important;
      width: 1px !important;
      height: 1px !important;
      padding: 0 !important;
      margin: -1px !important;
      overflow: hidden !important;
      clip: rect(0, 0, 0, 0) !important;
      white-space: nowrap !important;
      border: 0 !important;
    }
  </style>
</head>

<body>
  <header>
    <div class="topbar" role="banner">
      <div class="controls">
        <span class="label">Paper</span>
        <select id="paperSelect" aria-label="Paper selector"></select>
      </div>
      <button id="jumpBtn" class="jumpBtn" type="button" aria-haspopup="dialog" aria-controls="drawer"
        aria-expanded="false">
        Jump to
      </button>
    </div>
  </header>

  <div class="frame" role="presentation">
    <nav aria-label="Paper navigation">
      <p class="navTitle">Jump</p>
      <div id="navList" class="navList" role="list"></div>
    </nav>

    <main id="main" tabindex="-1">
      <p id="paperMeta" class="paperMeta"></p>
      <div id="paper" class="paper"></div>
    </main>
  </div>

  <!-- Mobile drawer -->
  <div id="backdrop" class="drawerBackdrop" aria-hidden="true"></div>
  <div id="drawer" class="drawer" role="dialog" aria-modal="true" aria-label="Paper navigation" aria-hidden="true">
    <div class="drawerHeader">
      <p class="title">Jump</p>
      <button id="drawerClose" class="drawerClose" type="button">Close</button>
    </div>
    <div id="drawerNav" class="drawerNav"></div>
  </div>

  <script>
    (function () {
      "use strict";

      // ---------- Data model helpers ----------
      function latexInline(s) { return { type: "math", display: false, latex: s }; }
      function latexBlock(s) { return { type: "math", display: true, latex: s }; }
      function txt(s) { return { type: "text", text: s }; }

      function makeDiagram(type) {
        return { type: "diagram", diagramType: type };
      }

      function qIdToDomId(qid) {
        return "q-" + qid.replace(/\s+/g, '').replace(/[^\w()-]+/g, '').replace(/[()]/g, m => m === '(' ? '-' : '');
      }

      function depthFromId(qid) {
        // heuristic: nesting depth based on presence of parentheses / letters
        // depth 0: "12"
        // depth 1: "18(a)" or "7a"
        // depth 2: "18(a)(i)"
        // depth 3: "18(a)(i)(A)" etc
        const parens = (qid.match(/\(/g) || []).length;
        if (parens >= 3) return 3;
        if (parens === 2) return 2;
        if (parens === 1) return 1;
        // handle 7a / 7b
        if (/^\d+[a-z]$/i.test(qid)) return 1;
        return 0;
      }

      // ---------- Diagram SVGs (placeholders, grayscale only) ----------
      function diagramSVG(diagramType) {
        if (diagramType === "geometry") {
          return `
            <svg viewBox="0 0 520 260" role="img" aria-label="Diagram: geometry" xmlns="http://www.w3.org/2000/svg">
              <rect x="1" y="1" width="518" height="258" fill="#fff" stroke="#d8d8d8"/>
              <polygon points="120,200 400,200 290,60" fill="none" stroke="#111" stroke-width="2"/>
              <circle cx="290" cy="120" r="48" fill="none" stroke="#111" stroke-width="2" opacity="0.65"/>
              <text x="115" y="220" font-size="14" fill="#444">A</text>
              <text x="395" y="220" font-size="14" fill="#444">B</text>
              <text x="290" y="52" font-size="14" fill="#444" text-anchor="middle">C</text>
              <text x="305" y="124" font-size="12" fill="#666">r</text>
              <line x1="120" y1="200" x2="400" y2="200" stroke="#888" stroke-width="2" stroke-dasharray="6 6"/>
              <text x="260" y="238" font-size="12" fill="#666" text-anchor="middle">base</text>
            </svg>
          `;
        }
        if (diagramType === "ratioBars") {
          return `
            <svg viewBox="0 0 520 260" role="img" aria-label="Diagram: ratio bars" xmlns="http://www.w3.org/2000/svg">
              <rect x="1" y="1" width="518" height="258" fill="#fff" stroke="#d8d8d8"/>
              <text x="20" y="48" font-size="14" fill="#444">A</text>
              <rect x="60" y="30" width="410" height="28" fill="none" stroke="#111" stroke-width="2"/>
              <line x1="60" y1="30" x2="60" y2="58" stroke="#111" stroke-width="2"/>
              <line x1="178" y1="30" x2="178" y2="58" stroke="#111" stroke-width="2"/>
              <line x1="296" y1="30" x2="296" y2="58" stroke="#111" stroke-width="2"/>
              <line x1="414" y1="30" x2="414" y2="58" stroke="#111" stroke-width="2"/>
              <text x="20" y="112" font-size="14" fill="#444">B</text>
              <rect x="60" y="94" width="410" height="28" fill="none" stroke="#111" stroke-width="2" opacity="0.85"/>
              <line x1="60" y1="94" x2="60" y2="122" stroke="#111" stroke-width="2"/>
              <line x1="240" y1="94" x2="240" y2="122" stroke="#111" stroke-width="2"/>
              <line x1="420" y1="94" x2="420" y2="122" stroke="#111" stroke-width="2"/>
              <text x="60" y="170" font-size="12" fill="#666">equal parts</text>
            </svg>
          `;
        }
        if (diagramType === "grid") {
          return `
            <svg viewBox="0 0 520 260" role="img" aria-label="Diagram: coordinate grid" xmlns="http://www.w3.org/2000/svg">
              <rect x="1" y="1" width="518" height="258" fill="#fff" stroke="#d8d8d8"/>
              <g stroke="#e0e0e0" stroke-width="1">
                ${Array.from({ length: 11 }).map((_, i) => `<line x1="${60 + i * 40}" y1="30" x2="${60 + i * 40}" y2="230"/>`).join('')}
                ${Array.from({ length: 6 }).map((_, i) => `<line x1="60" y1="${30 + i * 40}" x2="460" y2="${30 + i * 40}"/>`).join('')}
              </g>
              <g stroke="#111" stroke-width="2">
                <line x1="60" y1="230" x2="460" y2="230"/>
                <line x1="60" y1="30" x2="60" y2="230"/>
              </g>
              <circle cx="220" cy="150" r="5" fill="#111"/>
              <circle cx="380" cy="90" r="5" fill="#111"/>
              <line x1="220" y1="150" x2="380" y2="90" stroke="#111" stroke-width="2"/>
              <text x="210" y="168" font-size="12" fill="#666">(2,2)</text>
              <text x="370" y="78" font-size="12" fill="#666">(4,4)</text>
            </svg>
          `;
        }
        // table-like grid / array
        return `
          <svg viewBox="0 0 520 260" role="img" aria-label="Diagram: table" xmlns="http://www.w3.org/2000/svg">
            <rect x="1" y="1" width="518" height="258" fill="#fff" stroke="#d8d8d8"/>
            <rect x="80" y="50" width="360" height="160" fill="none" stroke="#111" stroke-width="2"/>
            ${Array.from({ length: 3 }).map((_, i) => `<line x1="${80 + (i + 1) * 90}" y1="50" x2="${80 + (i + 1) * 90}" y2="210" stroke="#111" stroke-width="2" opacity="0.85"/>`).join('')}
            ${Array.from({ length: 3 }).map((_, i) => `<line x1="80" y1="${50 + (i + 1) * 40}" x2="440" y2="${50 + (i + 1) * 40}" stroke="#111" stroke-width="2" opacity="0.85"/>`).join('')}
            <text x="92" y="78" font-size="12" fill="#666">A</text>
            <text x="182" y="78" font-size="12" fill="#666">B</text>
            <text x="272" y="78" font-size="12" fill="#666">C</text>
            <text x="362" y="78" font-size="12" fill="#666">D</text>
          </svg>
        `;
      }

      // ---------- Build paper datasets ----------
      function buildPapers() {
        const papers = [];

        // Short paper (6 questions)
        papers.push({
          key: "short",
          name: "Short paper",
          meta: "6 questions • mix of short arithmetic and one multi-part question",
          sections: null,
          questions: (function () {
            const qs = [];
            qs.push({
              id: "1",
              prompt: [txt("Calculate "), latexInline("37 + 58"), txt(".")],
              answer: "95",
              solution: {
                keep: null,
                formulas: null,
                working: [
                  txt("Add the tens and ones separately."),
                  latexBlock("37 + 58 = (30+7) + (50+8) = 80 + 15 = 95")
                ],
                alt: null
              }
            });
            qs.push({
              id: "2",
              prompt: [txt("Work out "), latexInline("6\\times 14"), txt(".")],
              answer: "84",
              solution: {
                keep: "Check you have multiplied both parts of 14.",
                formulas: null,
                working: [
                  latexBlock("6\\times 14 = 6\\times(10+4)=60+24=84")
                ],
                alt: [
                  txt("You can also double and triple:"),
                  latexBlock("14\\times 6 = 14\\times 3\\times 2 = 42\\times 2 = 84")
                ]
              }
            });
            qs.push({
              id: "3",
              prompt: [txt("A rectangle has length 9 cm and width 4 cm. Find the area.")],
              answer: "36 cm²",
              solution: {
                keep: null,
                formulas: "Area of rectangle = length × width",
                working: [
                  latexBlock("A = 9\\times 4 = 36\\text{ cm}^2")
                ],
                alt: null
              }
            });

            // Multi-part with sub-questions (each sub-question is a semantic unit)
            qs.push({
              id: "4",
              prompt: [txt("A shop sells pencils. 3 pencils cost £1.20.")],
              answer: "See parts",
              solution: {
                keep: null,
                formulas: null,
                working: [
                  txt("Use unit cost and scale up.")
                ],
                alt: null
              }
            });

            qs.push({
              id: "4a",
              prompt: [txt("Find the cost of 1 pencil.")],
              answer: "£0.40",
              solution: {
                keep: "Divide the total cost by the number of pencils.",
                formulas: null,
                working: [
                  latexBlock("\\frac{£1.20}{3} = £0.40")
                ],
                alt: null
              }
            });

            qs.push({
              id: "4b",
              prompt: [txt("Find the cost of 10 pencils.")],
              answer: "£4.00",
              solution: {
                keep: null,
                formulas: null,
                working: [
                  latexBlock("10\\times £0.40 = £4.00")
                ],
                alt: null
              }
            });

            qs.push({
              id: "5",
              prompt: [txt("Simplify "), latexInline("12/18"), txt(".")],
              answer: "2/3",
              solution: {
                keep: null,
                formulas: "Divide top and bottom by a common factor.",
                working: [
                  latexBlock("\\frac{12}{18} = \\frac{12\\div 6}{18\\div 6} = \\frac{2}{3}")
                ],
                alt: null
              }
            });

            qs.push({
              id: "6",
              prompt: [txt("Solve "), latexInline("x+7=19"), txt(".")],
              answer: "x = 12",
              solution: {
                keep: null,
                formulas: null,
                working: [
                  latexBlock("x+7=19\\Rightarrow x=19-7=12")
                ],
                alt: null
              }
            });

            return qs;
          })()
        });

        // Standard paper (35 questions, long algebra Q26–Q35)
        const standardQuestions = (function () {
          const qs = [];

          // 1–17: small/medium
          for (let i = 1; i <= 17; i++) {
            qs.push({
              id: String(i),
              prompt: [txt("Work out "), latexInline(`${i}+${i + 9}`), txt(".")],
              answer: String((i) + (i + 9)),
              solution: {
                keep: null,
                formulas: null,
                working: [
                  latexBlock(`${i}+${i + 9} = ${2 * i + 9}`)
                ],
                alt: null
              }
            });
          }

          // Deep nesting block around 18
          qs.push({
            id: "18",
            prompt: [txt("A number sequence is defined by "), latexInline("u_{n+1}=u_n+3"), txt(" and "), latexInline("u_1=2"), txt(".")],
            answer: "See parts",
            solution: {
              keep: null,
              formulas: null,
              working: [
                txt("This is an arithmetic sequence with difference 3.")
              ],
              alt: null
            }
          });
          qs.push({
            id: "18(a)",
            prompt: [txt("Find "), latexInline("u_2"), txt(" and "), latexInline("u_3"), txt(".")],
            answer: "u₂ = 5, u₃ = 8",
            solution: {
              keep: "Add 3 each time.",
              formulas: null,
              working: [
                latexBlock("u_2 = 2+3=5"),
                latexBlock("u_3 = 5+3=8")
              ],
              alt: null
            }
          });
          qs.push({
            id: "18(a)(i)",
            prompt: [txt("Write a formula for "), latexInline("u_n"), txt(".")],
            answer: "uₙ = 3n − 1",
            solution: {
              keep: null,
              formulas: "Arithmetic sequence: uₙ = a + (n−1)d",
              working: [
                latexBlock("u_n = 2 + (n-1)\\cdot 3 = 3n-1")
              ],
              alt: null
            }
          });
          qs.push({
            id: "18(a)(ii)",
            prompt: [txt("Find "), latexInline("u_{10}"), txt(".")],
            answer: "29",
            solution: {
              keep: null,
              formulas: null,
              working: [
                latexBlock("u_{10}=3\\cdot 10 - 1 = 29")
              ],
              alt: null
            }
          });
          qs.push({
            id: "18(b)",
            prompt: [txt("Find the smallest "), latexInline("n"), txt(" such that "), latexInline("u_n>50"), txt(".")],
            answer: "n = 18",
            solution: {
              keep: "Be careful with “greater than”, not “greater than or equal”.",
              formulas: null,
              working: [
                latexBlock("3n-1>50\\Rightarrow 3n>51\\Rightarrow n>17"),
                txt("So the smallest whole number is 18.")
              ],
              alt: null
            }
          });

          // 19–25: medium, include solution detail variants for coverage stress test
          qs.push({
            id: "19",
            prompt: [txt("A bag has 5 red and 3 blue counters. A counter is chosen at random. Find "), latexInline("P(\\text{blue})"), txt(".")],
            answer: "3/8",
            solution: {
              keep: null,
              formulas: "Probability = favourable outcomes / total outcomes",
              working: [
                latexBlock("P(\\text{blue})=\\frac{3}{5+3}=\\frac{3}{8}")
              ],
              alt: null
            }
          });

          qs.push({
            id: "20",
            prompt: [txt("Simplify "), latexInline("3(2x-5)+4x"), txt(".")],
            answer: "10x − 15",
            solution: {
              keep: "Distribute the 3 across the bracket first.",
              formulas: null,
              working: [
                latexBlock("3(2x-5)+4x = 6x-15+4x = 10x-15")
              ],
              alt: [
                txt("Check by substituting a value for x (e.g. x=1) in both forms.")
              ]
            }
          });

          qs.push({
            id: "21",
            prompt: [txt("Convert 0.375 to a fraction in simplest form.")],
            answer: "3/8",
            solution: {
              keep: null,
              formulas: null,
              working: [
                latexBlock("0.375 = \\frac{375}{1000} = \\frac{375\\div 125}{1000\\div 125} = \\frac{3}{8}")
              ],
              alt: null
            }
          });

          qs.push({
            id: "22",
            prompt: [txt("Solve "), latexInline("4y-7=2y+9"), txt(".")],
            answer: "y = 8",
            solution: {
              keep: "Keep the variable terms together.",
              formulas: null,
              working: [
                latexBlock("4y-7=2y+9\\Rightarrow 2y=16\\Rightarrow y=8")
              ],
              alt: null
            }
          });

          qs.push({
            id: "23",
            prompt: [txt("A triangle has base 12 cm and height 7 cm. Find the area.")],
            answer: "42 cm²",
            solution: {
              keep: null,
              formulas: "Area of triangle = 1/2 × base × height",
              working: [
                latexBlock("A=\\tfrac12\\cdot 12\\cdot 7 = 42\\text{ cm}^2")
              ],
              alt: null
            }
          });

          qs.push({
            id: "24",
            prompt: [txt("Find the mean of 4, 9, 10, 13.")],
            answer: "9",
            solution: {
              keep: "Mean is the total divided by how many numbers there are.",
              formulas: null,
              working: [
                latexBlock("\\text{Mean} = \\frac{4+9+10+13}{4} = \\frac{36}{4} = 9")
              ],
              alt: null
            }
          });

          qs.push({
            id: "25",
            prompt: [txt("Expand and simplify "), latexInline("(x+3)(x-5)"), txt(".")],
            answer: "x² − 2x − 15",
            solution: {
              keep: null,
              formulas: "FOIL / distributive law",
              working: [
                latexBlock("(x+3)(x-5)=x^2-5x+3x-15=x^2-2x-15")
              ],
              alt: [
                txt("Grid method gives the same result.")
              ]
            }
          });

          // 26–35: long algebra (collapsed by default in standard)
          function longAlgebraWorking(qn, variant) {
            const lines = [];
            lines.push(txt("Work step-by-step and keep the equals signs aligned."));
            lines.push(latexBlock(`\\text{Start with the expression for question ${qn}.}`));
            lines.push(latexBlock(`(2x-${qn - 20})(x+${qn - 24})`));
            lines.push(latexBlock(`=2x\\cdot x + 2x\\cdot ${qn - 24} - (${qn - 20})\\cdot x - (${qn - 20})\\cdot ${qn - 24}`));
            lines.push(latexBlock(`=2x^2 + ${2 * (qn - 24)}x - ${qn - 20}x - ${(qn - 20) * (qn - 24)}`));
            lines.push(latexBlock(`=2x^2 + ${(2 * (qn - 24) - (qn - 20))}x - ${(qn - 20) * (qn - 24)}`));
            lines.push(txt("Now solve a related equation by rearranging:"));
            lines.push(latexBlock(`2x^2 + ${(2 * (qn - 24) - (qn - 20))}x - ${(qn - 20) * (qn - 24)} = 0`));
            lines.push(txt("Factorise or use the quadratic formula if needed."));
            lines.push(latexBlock(`x = \\frac{-b \\pm \\sqrt{b^2-4ac}}{2a}`));
            lines.push(latexBlock(`\\text{(Here } a=2,\\; b=${(2 * (qn - 24) - (qn - 20))},\\; c=-${(qn - 20) * (qn - 24)}\\text{.)}`));
            // stress: multiple blocks
            lines.push(latexBlock(`b^2-4ac = ${(2 * (qn - 24) - (qn - 20))}^2 -4\\cdot 2\\cdot(-${(qn - 20) * (qn - 24)})`));
            lines.push(latexBlock(`= ${(2 * (qn - 24) - (qn - 20)) ** 2} + ${8 * (qn - 20) * (qn - 24)}`));
            lines.push(txt("Simplify the discriminant carefully."));
            lines.push(latexBlock(`\\sqrt{b^2-4ac} = \\sqrt{ ${(2 * (qn - 24) - (qn - 20)) ** 2 + 8 * (qn - 20) * (qn - 24)} }`));
            lines.push(txt("Substitute back to get the solutions."));
            lines.push(latexBlock(`x = \\frac{-${(2 * (qn - 24) - (qn - 20))} \\pm \\sqrt{ ${(2 * (qn - 24) - (qn - 20)) ** 2 + 8 * (qn - 20) * (qn - 24)} }}{4}`));
            if (variant === "extreme") {
              lines.push(txt("Extra working (stress test):"));
              for (let k = 1; k <= 56; k++) {
                // 50–60 lines of working: varied but repetitive algebra steps
                const a = (k % 9) + 2;
                const b = (k % 7) + 1;
                lines.push(latexBlock(`${a}x + ${b} = ${a}x + ${b} \\;\\Rightarrow\\; \\text{(rewrite step ${k})}`));
              }
            }
            return lines;
          }

          for (let q = 26; q <= 35; q++) {
            const isExtreme = (q === 33 || q === 35);
            qs.push({
              id: String(q),
              prompt: [
                txt("Simplify and solve: "),
                latexInline(`(2x-${q - 20})(x+${q - 24}) = 0`),
                txt(".")
              ],
              answer: "Two solutions (see working)",
              solution: {
                keep: (q === 26 || q === 34) ? "If you use the quadratic formula, copy it carefully." : null,
                formulas: (q === 27 || q === 31) ? "Quadratic formula: x = (−b ± √(b²−4ac)) / (2a)" : null,
                working: longAlgebraWorking(q, isExtreme ? "extreme" : "long"),
                alt: (q === 30 || q === 32) ? [
                  txt("Alternative method (when factorisable):"),
                  latexBlock("\\text{Try to factorise the quadratic into }(px+q)(rx+s)=0.")
                ] : null
              }
            });

            // Deep nesting around Q30 (requested)
            if (q === 30) {
              qs.push({
                id: "30(a)(i)",
                prompt: [txt("Show that the coefficient of "), latexInline("x"), txt(" simplifies to "), latexInline(String(2 * (30 - 24) - (30 - 20))), txt(".")],
                answer: String(2 * (30 - 24) - (30 - 20)),
                solution: {
                  keep: null,
                  formulas: null,
                  working: [
                    latexBlock(`2\\cdot(${30 - 24}) - (${30 - 20}) = ${2 * (30 - 24)} - ${30 - 20} = ${2 * (30 - 24) - (30 - 20)}`)
                  ],
                  alt: null
                }
              });
              qs.push({
                id: "30(a)(ii)",
                prompt: [txt("Compute the constant term in the expansion.")],
                answer: String((30 - 20) * (30 - 24)),
                solution: {
                  keep: "Multiply the two numbers carefully.",
                  formulas: null,
                  working: [
                    latexBlock(`(${30 - 20})\\cdot(${30 - 24}) = ${(30 - 20) * (30 - 24)}`)
                  ],
                  alt: null
                }
              });
              qs.push({
                id: "30(b)",
                prompt: [txt("Explain why the equation can have two solutions.")],
                answer: "It is quadratic (degree 2)",
                solution: {
                  keep: null,
                  formulas: null,
                  working: [
                    txt("A quadratic equation can cross the x-axis up to two times."),
                    latexBlock("\\text{Degree 2 }\\Rightarrow\\text{ up to 2 real roots.}")
                  ],
                  alt: null
                }
              });
            }
          }

          // Ensure at least one question contains Keep in mind + Formulas used + Alternative working (stress test)
          qs.push({
            id: "36",
            prompt: [txt("Solve "), latexInline("x^2-5x+6=0"), txt(".")],
            answer: "x = 2 or x = 3",
            solution: {
              keep: "Look for two numbers that multiply to 6 and add to 5.",
              formulas: "If a quadratic factorises: (x−a)(x−b)=0 ⇒ x=a or x=b",
              working: [
                latexBlock("x^2-5x+6=(x-2)(x-3)")
              ],
              alt: [
                txt("Alternative working (quadratic formula):"),
                latexBlock("x=\\frac{5\\pm\\sqrt{25-24}}{2}=\\frac{5\\pm 1}{2}\\Rightarrow x=2,3")
              ]
            }
          });

          return qs;
        })();

        // Standard paper (exactly 35 questions requested). We'll display Q1–Q35; keep Q36 present but excluded here.
        // We will include the stress-test combo question within Standard by swapping it into Q17's solution details variant.
        // Instead: move the combo into Q17 by modifying Q17 entry.
        const standard35 = standardQuestions.filter(q => {
          const n = parseInt(q.id, 10);
          return Number.isFinite(n) && n >= 1 && n <= 35 || /^18\(/.test(q.id) || /^30\(/.test(q.id) || q.id === "18" || q.id === "18(a)" || q.id === "18(b)" || q.id === "30(a)(i)" || q.id === "30(a)(ii)" || q.id === "30(b)";
        });

        // Inject combo coverage into Q17 by attaching Keep+Formulas+Alt
        const q17 = standard35.find(q => q.id === "17");
        if (q17) {
          q17.solution.keep = "Check your arithmetic carefully and write one clear line per step.";
          q17.solution.formulas = "General check: (a+b) = (b+a) (commutativity) can help verify.";
          q17.solution.alt = [
            txt("Alternative working:"),
            latexBlock(`(${17 + 9})+${17} = 26+17 = 43`)
          ];
        }

        // Also ensure at least 3 keep, 3 formulas, 3 alt across paper:
        // Already present: keep in Q18(a), Q18(b), Q20, Q22, Q24, Q26/34, Q30(a)(ii) etc.
        // Formulas present: Q18(a)(i), Q19, Q23, Q25, Q27/31.
        // Alt present: Q20, Q25, Q30/32, Q17.
        papers.push({
          key: "standard",
          name: "Standard paper",
          meta: "35 questions • Q26–Q35 include long algebra (workings collapsed by default)",
          sections: null,
          questions: standard35
        });

        // Standard (Workings Expanded) dataset variant (same as Standard, but expanded by default)
        papers.push({
          key: "standardExpanded",
          name: "Standard (Workings Expanded)",
          meta: "35 questions • same as Standard, but all workings start expanded (dataset variant only)",
          sections: null,
          questions: standard35.map(q => JSON.parse(JSON.stringify(q))) // deep copy
        });

        // Diagram-heavy paper (20 questions, 8 with diagrams)
        papers.push({
          key: "diagram",
          name: "Diagram-heavy paper",
          meta: "20 questions • 8 questions include diagrams (SVG placeholders)",
          sections: null,
          questions: (function () {
            const qs = [];
            const diagramIds = new Set([2, 4, 6, 9, 12, 14, 17, 20]);
            for (let i = 1; i <= 20; i++) {
              const hasD = diagramIds.has(i);
              const diagType = (i % 4 === 1) ? "geometry" : (i % 4 === 2) ? "ratioBars" : (i % 4 === 3) ? "grid" : "table";
              qs.push({
                id: String(i),
                prompt: [
                  txt(hasD ? "Use the diagram to answer the question. " : "Answer the question. "),
                  txt("Work out "),
                  latexInline(`${i * 3}+${i}`),
                  txt(".")
                ],
                diagram: hasD ? makeDiagram(diagType) : null,
                answer: String(i * 3 + i),
                solution: {
                  keep: hasD ? "Use the labels on the diagram carefully." : null,
                  formulas: (hasD && (i === 6 || i === 12 || i === 20)) ? "Use the relationships shown in the diagram." : null,
                  working: [
                    latexBlock(`${i * 3}+${i} = ${i * 4}`)
                  ],
                  alt: (hasD && (i === 14 || i === 17)) ? [
                    txt("Alternative working:"),
                    latexBlock(`${i}(${3}+${1}) = ${i * 4}`)
                  ] : null
                }
              });
            }
            return qs;
          })()
        });

        // Sectioned paper (A/B/C)
        papers.push({
          key: "sectioned",
          name: "Sectioned paper",
          meta: "Sections A/B/C • A: 35 • B: 8 • C: 6 (C has very long workings, collapsed by default)",
          sections: [
            { label: "A", count: 35 },
            { label: "B", count: 8 },
            { label: "C", count: 6 }
          ],
          questions: (function () {
            const qs = [];
            // Section A: 35 small/medium
            for (let i = 1; i <= 35; i++) {
              qs.push({
                section: "A",
                id: String(i),
                prompt: [txt("Work out "), latexInline(`${i}+${i + 5}`), txt(".")],
                answer: String(i + i + 5),
                solution: {
                  keep: (i % 13 === 0) ? "Line up your place values." : null,
                  formulas: (i % 17 === 0) ? "Addition: combine like place values." : null,
                  working: [latexBlock(`${i}+${i + 5}=${2 * i + 5}`)],
                  alt: (i === 21) ? [txt("Alternative working:"), latexBlock(`${i + 5}+${i}=${2 * i + 5}`)] : null
                }
              });
            }
            // Section B: 8 medium
            for (let j = 1; j <= 8; j++) {
              const qn = 35 + j;
              qs.push({
                section: "B",
                id: String(qn),
                prompt: [txt("Solve "), latexInline(`3x+${j}= ${2 * j + 9}`), txt(".")],
                answer: `x = ${(2 * j + 9 - j) / 3}`,
                solution: {
                  keep: (j === 3 || j === 7) ? "Do the same operation to both sides." : null,
                  formulas: null,
                  working: [
                    latexBlock(`3x+${j}=${2 * j + 9}`),
                    latexBlock(`3x=${2 * j + 9 - j}`),
                    latexBlock(`x=${(2 * j + 9 - j) / 3}`)
                  ],
                  alt: null
                }
              });
            }
            // Section C: 6 very long workings (collapsed by default)
            for (let k = 1; k <= 6; k++) {
              const qn = 43 + k; // 44–49
              const working = [];
              working.push(txt("This working is intentionally long (stress test)."));
              working.push(latexBlock(`\\text{Question ${qn}: simplify and solve}`));
              working.push(latexBlock(`x^2 + ${k + 3}x + ${k + 2} = 0`));
              working.push(latexBlock(`\\text{Try factorising: }(x+1)(x+${k + 2}) = x^2 + (${k + 3})x + ${k + 2}`));
              working.push(txt("So the solutions are the values that make each bracket zero."));
              working.push(latexBlock(`x=-1 \\quad \\text{or} \\quad x=-${k + 2}`));
              working.push(txt("Extra lines (stress):"));
              for (let t = 1; t <= 55; t++) {
                working.push(latexBlock(`\\text{Step ${t}: }\\; (x+1)(x+${k + 2})=0 \\Rightarrow x\\in\\{-1,-${k + 2}\\}`));
              }
              qs.push({
                section: "C",
                id: String(qn),
                prompt: [txt("Solve "), latexInline(`x^2 + ${k + 3}x + ${k + 2} = 0`), txt(".")],
                answer: `x = -1 or x = -${k + 2}`,
                solution: {
                  keep: (k === 2) ? "Check your signs when factorising." : null,
                  formulas: (k === 4) ? "If (x+a)(x+b)=0 then x=−a or x=−b." : null,
                  working,
                  alt: (k === 6) ? [
                    txt("Alternative working (quadratic formula):"),
                    latexBlock(`x=\\frac{-(${k + 3})\\pm\\sqrt{(${k + 3})^2-4\\cdot 1\\cdot ${k + 2}}}{2}`)
                  ] : null
                }
              });
            }
            return qs;
          })()
        });

        return papers;
      }

      const PAPERS = buildPapers();

      // ---------- DOM refs ----------
      const paperSelect = document.getElementById("paperSelect");
      const navList = document.getElementById("navList");
      const paperEl = document.getElementById("paper");
      const paperMeta = document.getElementById("paperMeta");
      const main = document.getElementById("main");

      const jumpBtn = document.getElementById("jumpBtn");
      const drawer = document.getElementById("drawer");
      const drawerNav = document.getElementById("drawerNav");
      const drawerClose = document.getElementById("drawerClose");
      const backdrop = document.getElementById("backdrop");

      let activeObserver = null;
      let activePaperKey = null;
      let lastFocusedBeforeDrawer = null;

      // ---------- Populate selector ----------
      function initSelector() {
        const opts = PAPERS.map(p => ({ key: p.key, name: p.name }));
        for (const o of opts) {
          const opt = document.createElement("option");
          opt.value = o.key;
          opt.textContent = o.name;
          paperSelect.appendChild(opt);
        }
      }

      // ---------- Rendering helpers ----------
      function renderContentLine(container, item) {
        if (item.type === "text") {
          const p = document.createElement("p");
          p.textContent = item.text;
          container.appendChild(p);
          return;
        }
        if (item.type === "math") {
          const span = document.createElement("span");
          span.className = item.display ? "math-block" : "math-inline";
          span.setAttribute("data-math", item.latex);
          span.setAttribute("data-display", item.display ? "true" : "false");
          if (item.display) {
            // allow keyboard focus for scrolling within block
            span.tabIndex = 0;
          }
          // fallback text if KaTeX missing
          span.textContent = item.latex;
          container.appendChild(span);
          return;
        }
      }

      function renderPrompt(promptArr, diagramObj) {
        const wrap = document.createElement("div");
        wrap.className = "qPrompt";
        // prompt may contain inline math items; render as text nodes/spans inside a single paragraph-like flow
        const p = document.createElement("div");
        p.style.display = "block";
        p.style.maxWidth = "72ch";
        p.style.wordBreak = "break-word";

        for (const it of promptArr) {
          if (it.type === "text") {
            p.appendChild(document.createTextNode(it.text));
          } else if (it.type === "math") {
            const span = document.createElement("span");
            span.className = "math-inline";
            span.setAttribute("data-math", it.latex);
            span.setAttribute("data-display", "false");
            span.textContent = it.latex;
            p.appendChild(span);
          }
        }
        wrap.appendChild(p);

        if (diagramObj && diagramObj.type === "diagram") {
          const d = document.createElement("div");
          d.className = "diagram";
          d.innerHTML = diagramSVG(diagramObj.diagramType);
          wrap.appendChild(d);
        }

        return wrap;
      }

      function makeSolutionBlock(title, contentItems) {
        const block = document.createElement("div");
        const h = document.createElement("p");
        h.className = "solnBlockTitle";
        h.textContent = title;
        const body = document.createElement("div");
        body.className = "solnBlockBody";

        for (const it of contentItems) {
          renderContentLine(body, it);
        }
        block.appendChild(h);
        block.appendChild(body);
        return block;
      }

      function buildCollapsedPreview(solution) {
        // Show at most 2 lines worth: choose first 2 items from working, but compress to plain text if blocks.
        // Keep minimal and non-intimidating.
        const preview = document.createElement("div");
        preview.className = "collapsedPreview";

        const picks = (solution && solution.working) ? solution.working.slice(0, 2) : [];
        if (!picks.length) {
          preview.textContent = "Working available.";
          return preview;
        }

        const parts = picks.map(it => {
          if (it.type === "text") return it.text;
          if (it.type === "math") return it.latex;
          return "";
        }).filter(Boolean);

        preview.textContent = parts.join("  ");
        return preview;
      }

      function renderPaper(paper) {
        // clear
        paperEl.innerHTML = "";
        navList.innerHTML = "";
        drawerNav.innerHTML = "";

        paperMeta.textContent = paper.meta || "";

        // For sectioned paper: add section headers in content + non-clickable separators in nav
        const navFrag = document.createDocumentFragment();
        const drawerFrag = document.createDocumentFragment();

        // Create a list of question identifiers only, preserving existing structure order.
        let currentSection = null;

        const expandedByDefault = (paper.key === "standardExpanded");

        const questionEls = [];
        for (const q of paper.questions) {
          const section = q.section || null;

          // Section header in content (only when changed)
          if (paper.sections && section && section !== currentSection) {
            currentSection = section;
            const sh = document.createElement("div");
            sh.className = "sectionHdr";
            sh.textContent = "Section " + section;
            paperEl.appendChild(sh);
          }

          const domId = qIdToDomId(q.id);

          const depth = depthFromId(q.id);
          const qWrap = document.createElement("section");
          qWrap.className = `q depth-${Math.min(depth, 3)}`;
          qWrap.id = domId;
          qWrap.setAttribute("data-qid", q.id);

          const inner = document.createElement("div");
          inner.className = "qInner";

          const head = document.createElement("div");
          head.className = "qHead";

          const qid = document.createElement("div");
          qid.className = "qid";
          qid.textContent = q.id; // identifiers only; no "Q"
          head.appendChild(qid);

          head.appendChild(renderPrompt(q.prompt, q.diagram || null));
          inner.appendChild(head);

          const body = document.createElement("div");
          body.className = "qBody";

          // Answer (visible by default)
          const answerRow = document.createElement("div");
          answerRow.className = "answerRow";
          const al = document.createElement("span");
          al.className = "answerLabel";
          al.textContent = "Answer";
          const av = document.createElement("span");
          av.className = "answerValue";
          av.textContent = q.answer;
          answerRow.appendChild(al);
          answerRow.appendChild(av);
          body.appendChild(answerRow);

          // Toggle + collapsed preview
          const toggleRow = document.createElement("div");
          toggleRow.className = "toggleRow";

          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "toggleBtn";
          const solnId = domId + "-soln";
          btn.setAttribute("aria-controls", solnId);

          // state
          const startExpanded = !!expandedByDefault;
          btn.setAttribute("aria-expanded", startExpanded ? "true" : "false");
          btn.innerHTML = startExpanded
            ? `Hide working <span class="chev" aria-hidden="true">▾</span>`
            : `Show working <span class="chev" aria-hidden="true">▸</span>`;

          toggleRow.appendChild(btn);
          body.appendChild(toggleRow);

          const preview = buildCollapsedPreview(q.solution || null);
          preview.id = domId + "-preview";
          preview.style.display = startExpanded ? "none" : "block";
          body.appendChild(preview);

          // Solution Details region (all reveal/hide together)
          const soln = document.createElement("div");
          soln.className = "soln";
          soln.id = solnId;
          soln.hidden = !startExpanded;

          const s = q.solution || { keep: null, formulas: null, working: [], alt: null };

          if (s.keep) {
            soln.appendChild(makeSolutionBlock("Keep in mind", [txt(s.keep)]));
          }
          if (s.formulas) {
            soln.appendChild(makeSolutionBlock("Formulas used", [txt(s.formulas)]));
          }

          // Working (primary)
          soln.appendChild(makeSolutionBlock("Working", Array.isArray(s.working) ? s.working : [txt(String(s.working || ""))]));

          // Alternative working (0+)
          if (s.alt && Array.isArray(s.alt) && s.alt.length) {
            soln.appendChild(makeSolutionBlock("Alternative working", s.alt));
          }

          body.appendChild(soln);

          // Toggle behaviour
          btn.addEventListener("click", function () {
            const expanded = btn.getAttribute("aria-expanded") === "true";
            const next = !expanded;
            btn.setAttribute("aria-expanded", next ? "true" : "false");
            btn.innerHTML = next
              ? `Hide working <span class="chev" aria-hidden="true">▾</span>`
              : `Show working <span class="chev" aria-hidden="true">▸</span>`;
            soln.hidden = !next;
            preview.style.display = next ? "none" : "block";

            // Render KaTeX in newly revealed area
            if (next) renderKaTeX(soln);
          });

          inner.appendChild(body);
          qWrap.appendChild(inner);
          paperEl.appendChild(qWrap);
          questionEls.push(qWrap);

          // Nav separators (section labels as non-clickable, plain-text)
          if (paper.sections && section && section !== (q.__navSectionSeen || null)) {
            // We'll add separator when transitioning; detect transitions by tracking last appended in nav
          }
        }

        // Build nav list (separators for sections)
        function appendNavSeparator(label) {
          const sep = document.createElement("div");
          sep.className = "navSep";
          sep.textContent = label;
          navFrag.appendChild(sep);

          const sep2 = document.createElement("div");
          sep2.className = "navSep";
          sep2.textContent = label;
          drawerFrag.appendChild(sep2);
        }

        const seenSection = new Set();
        for (const q of paper.questions) {
          if (paper.sections && q.section && !seenSection.has(q.section)) {
            seenSection.add(q.section);
            appendNavSeparator(q.section);
          }

          const domId = qIdToDomId(q.id);
          const a = document.createElement("a");
          a.className = "navItem";
          a.href = "#" + domId;
          a.textContent = q.id;
          a.setAttribute("role", "listitem");

          const a2 = a.cloneNode(true);

          function goToQuestion(evt) {
            evt.preventDefault();
            const target = document.getElementById(domId);
            if (target) {
              // Instant, user-initiated jump (no smooth scrolling / motion effects)
              target.scrollIntoView({ block: "start" });
              closeDrawer();
            }
          }

          a.addEventListener("click", goToQuestion);
          a2.addEventListener("click", goToQuestion);

          navFrag.appendChild(a);
          drawerFrag.appendChild(a2);
        }

        navList.appendChild(navFrag);
        drawerNav.appendChild(drawerFrag);

        // Initial KaTeX render (visible content)
        renderKaTeX(document.body);

        // Setup scroll spy (subtle current position indicator)
        setupScrollSpy(questionEls);

        // Ensure main focus remains stable; no forced focus movement.
      }

      // ---------- KaTeX rendering ----------
      function renderKaTeX(root) {
        const nodes = root.querySelectorAll("[data-math]");
        const hasKaTeX = !!(window.katex && typeof window.katex.render === "function");

        for (const el of nodes) {
          // Avoid re-render
          if (el.getAttribute("data-rendered") === "true") continue;

          const latex = el.getAttribute("data-math") || "";
          const display = (el.getAttribute("data-display") === "true");

          if (!hasKaTeX) {
            // Keep plain text fallback; do not hide.
            el.setAttribute("data-rendered", "true");
            continue;
          }

          try {
            el.textContent = "";
            window.katex.render(latex, el, {
              displayMode: display,
              throwOnError: false
            });
            el.setAttribute("data-rendered", "true");
          } catch (err) {
            // graceful fallback: show raw latex
            el.textContent = latex;
            el.setAttribute("data-rendered", "true");
          }
        }
      }

      // ---------- Scroll spy ----------
      function setupScrollSpy(questionEls) {
        // Clean up old observer
        if (activeObserver) {
          activeObserver.disconnect();
          activeObserver = null;
        }

        const navLinks = new Map();
        for (const a of navList.querySelectorAll(".navItem")) {
          const href = a.getAttribute("href") || "";
          const id = href.startsWith("#") ? href.slice(1) : href;
          navLinks.set(id, a);
        }
        const drawerLinks = new Map();
        for (const a of drawerNav.querySelectorAll(".navItem")) {
          const href = a.getAttribute("href") || "";
          const id = href.startsWith("#") ? href.slice(1) : href;
          drawerLinks.set(id, a);
        }

        function setCurrent(id) {
          for (const [k, a] of navLinks) {
            a.setAttribute("aria-current", k === id ? "true" : "false");
          }
          for (const [k, a] of drawerLinks) {
            a.setAttribute("aria-current", k === id ? "true" : "false");
          }
        }

        // Use IntersectionObserver for stability; choose the first visible question near the top.
        const obs = new IntersectionObserver((entries) => {
          // Find entries that are intersecting; choose the one closest to top.
          const visible = entries.filter(e => e.isIntersecting).sort((a, b) => a.boundingClientRect.top - b.boundingClientRect.top);
          if (visible.length) {
            setCurrent(visible[0].target.id);
          }
        }, {
          root: null,
          rootMargin: "-80px 0px -70% 0px",
          threshold: [0.01, 0.1]
        });

        for (const q of questionEls) {
          obs.observe(q);
        }
        activeObserver = obs;

        // Initialize
        if (questionEls.length) {
          setCurrent(questionEls[0].id);
        }
      }

      // ---------- Drawer controls (mobile) ----------
      function isSmallScreen() {
        return window.matchMedia("(max-width: 780px)").matches;
      }

      function openDrawer() {
        // Only meaningful on small screens, but safe everywhere.
        lastFocusedBeforeDrawer = document.activeElement;
        drawer.setAttribute("aria-hidden", "false");
        backdrop.style.display = "block";
        backdrop.setAttribute("aria-hidden", "false");
        drawer.style.transform = "translateX(0)";
        jumpBtn.setAttribute("aria-expanded", "true");

        // Trap focus: simple trap within drawer
        const focusables = drawer.querySelectorAll("button, a, [tabindex]:not([tabindex='-1'])");
        const first = focusables[0];
        if (first) first.focus();

        document.addEventListener("keydown", onDrawerKeydown, true);
      }

      function closeDrawer() {
        if (drawer.getAttribute("aria-hidden") === "true") return;
        drawer.setAttribute("aria-hidden", "true");
        backdrop.style.display = "none";
        backdrop.setAttribute("aria-hidden", "true");
        drawer.style.transform = "translateX(105%)";
        jumpBtn.setAttribute("aria-expanded", "false");

        document.removeEventListener("keydown", onDrawerKeydown, true);

        // Return focus to prior element without forced scrolling
        if (lastFocusedBeforeDrawer && typeof lastFocusedBeforeDrawer.focus === "function") {
          lastFocusedBeforeDrawer.focus();
        } else {
          jumpBtn.focus();
        }
      }

      function onDrawerKeydown(e) {
        if (e.key === "Escape") {
          e.preventDefault();
          closeDrawer();
          return;
        }
        if (e.key !== "Tab") return;

        const focusables = Array.from(drawer.querySelectorAll("button, a, [tabindex]:not([tabindex='-1'])"))
          .filter(el => !el.hasAttribute("disabled"));
        if (!focusables.length) return;

        const first = focusables[0];
        const last = focusables[focusables.length - 1];
        const active = document.activeElement;

        if (e.shiftKey) {
          if (active === first) {
            e.preventDefault();
            last.focus();
          }
        } else {
          if (active === last) {
            e.preventDefault();
            first.focus();
          }
        }
      }

      jumpBtn.addEventListener("click", function () {
        // On desktop, still works, but drawer is mainly for mobile/tablet
        openDrawer();
      });
      drawerClose.addEventListener("click", closeDrawer);
      backdrop.addEventListener("click", closeDrawer);

      // ---------- Paper switching ----------
      function getPaperByKey(key) {
        return PAPERS.find(p => p.key === key) || PAPERS[0];
      }

      function setPaper(key) {
        const paper = getPaperByKey(key);
        activePaperKey = paper.key;

        // Switching papers must rebuild navigation accordingly; no auto-expand beyond defaults.
        renderPaper(paper);

        // If drawer open, keep it open but updated; no auto-close required.
      }

      paperSelect.addEventListener("change", function () {
        setPaper(paperSelect.value);
      });

      // ---------- Init ----------
      initSelector();

      // Default selection: Standard
      paperSelect.value = "standard";
      setPaper("standard");

      // Re-render KaTeX if it loads after initial paint
      // (KaTeX script is defer; this ensures we render once available.)
      window.addEventListener("load", function () {
        renderKaTeX(document.body);
      });

      // Keep nav sticky offsets stable on resize; no layout recomposition.
      window.addEventListener("resize", function () {
        // No-op; drawer remains functional.
      });

    })();
  </script>
</body>

</html>