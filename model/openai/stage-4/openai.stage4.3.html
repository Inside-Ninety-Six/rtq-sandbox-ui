<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>RTQ – Maths Paper Solution Viewer (Stress Test)</title>

    <!-- KaTeX (CDN) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css"
        integrity="sha384-nB0miv6/jRmo5V6jAQK7m8t0T3mZ8m1pW4wJY0bZcJZtQeJvGqV0m3xk9g8mN6g5" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"
        integrity="sha384-1bJH3v3QKQq9a9xqfV4Xv+qv3b0Eo8yq9o2cS8mQp7c0cXoXqgqVJpXw9wqQqkqS"
        crossorigin="anonymous"></script>

    <style>
        :root {
            --bg: #ffffff;
            --fg: #121212;
            --muted: #4a4a4a;
            --quiet: #6a6a6a;
            --hair: #e6e6e6;
            --hair2: #d8d8d8;
            --soft: #f4f4f4;
            --soft2: #f9f9f9;

            --frame-max: 1080px;
            --frame-gutter: 20px;
            --nav-w: 200px;

            --r0: 18px;
            --r1: 12px;
            --r2: 8px;

            --s0: 22px;
            /* between top-level questions (largest) */
            --s1: 10px;
            /* question -> answer */
            --s2: 8px;
            /* answer -> toggle */
            --s3: 10px;
            /* toggle -> solution preview */
            --s4: 14px;
            /* within expanded solution blocks */
            --s5: 8px;
            /* between solution subsections */
        }

        * {
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
        }

        body {
            margin: 0;
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Liberation Sans", sans-serif;
            color: var(--fg);
            background: var(--bg);
            line-height: 1.45;
            overflow-x: hidden;
            /* main document must never scroll horizontally */
        }

        /* Top controls aligned to the same centered frame */
        header {
            border-bottom: 1px solid var(--hair);
            background: var(--bg);
        }

        .frame {
            max-width: var(--frame-max);
            margin: 0 auto;
            padding: 12px var(--frame-gutter);
        }

        .topbar {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .topbar .title {
            font-size: 14px;
            color: var(--quiet);
            letter-spacing: 0.2px;
            margin-right: auto;
            white-space: nowrap;
        }

        label {
            font-size: 13px;
            color: var(--muted);
        }

        select {
            font-size: 14px;
            padding: 8px 10px;
            border: 1px solid var(--hair2);
            border-radius: 12px;
            background: var(--bg);
            color: var(--fg);
            min-width: 260px;
        }

        .btn {
            appearance: none;
            border: 1px solid var(--hair2);
            background: var(--bg);
            color: var(--fg);
            border-radius: 12px;
            padding: 8px 10px;
            font-size: 14px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:focus-visible,
        .toggle:focus-visible,
        .nav a:focus-visible {
            outline: 2px solid var(--hair2);
            outline-offset: 2px;
            border-color: var(--hair2);
        }

        .btn[aria-expanded="true"] {
            background: var(--soft2);
        }

        /* Desktop shell */
        .shell {
            max-width: var(--frame-max);
            margin: 0 auto;
            padding: 14px var(--frame-gutter) 36px;
            display: grid;
            grid-template-columns: var(--nav-w) 1fr;
            gap: 26px;
            align-items: start;
        }

        nav.nav {
            position: sticky;
            /* persistent rail */
            top: 10px;
            align-self: start;
        }

        .nav .nav-inner {
            border: 0;
        }

        .nav h2 {
            font-size: 12px;
            font-weight: 600;
            color: var(--quiet);
            margin: 0 0 10px 0;
            letter-spacing: 0.4px;
            text-transform: uppercase;
        }

        /* The scrollable list container (only if needed) */
        .nav-list {
            max-height: calc(100vh - 110px);
            overflow: auto;
            padding-right: 6px;
            /* space for hidden scrollbar */
            scrollbar-width: none;
            /* Firefox */
            -ms-overflow-style: none;
            /* legacy */
        }

        .nav-list::-webkit-scrollbar {
            display: none;
        }

        .nav .section-label {
            font-size: 12px;
            color: var(--quiet);
            margin: 12px 0 6px;
            letter-spacing: 0.3px;
        }

        .nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .nav a {
            display: block;
            text-decoration: none;
            color: var(--quiet);
            font-size: 13px;
            padding: 6px 8px;
            border-radius: 10px;
            border: 1px solid transparent;
        }

        .nav a:hover {
            background: var(--soft2);
        }

        .nav a[aria-current="true"] {
            color: var(--fg);
            border-color: var(--hair2);
            background: var(--soft2);
            font-weight: 600;
            /* allowed only for current item */
        }

        main {
            min-width: 0;
        }

        /* Paper content should feel like a document */
        .paper-meta {
            margin: 6px 0 14px;
            color: var(--quiet);
            font-size: 13px;
        }

        /* Question blocks (no cards/panels) */
        article.q {
            padding: 0;
            margin: 0 0 var(--s0) 0;
        }

        /* nesting via indentation only */
        .q.depth-0 {
            padding-left: 0;
        }

        .q.depth-1 {
            padding-left: 18px;
        }

        .q.depth-2 {
            padding-left: 34px;
        }

        .q.depth-3 {
            padding-left: 48px;
        }

        /* separation strength decreases with depth */
        .q.depth-0 {
            margin-bottom: var(--s0);
        }

        .q.depth-1 {
            margin-bottom: 16px;
        }

        .q.depth-2 {
            margin-bottom: 12px;
        }

        .q.depth-3 {
            margin-bottom: 10px;
        }

        .q-head {
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }

        .qid {
            flex: 0 0 auto;
            font-size: 14px;
            color: var(--muted);
            line-height: 1.6;
            margin-top: 2px;
        }

        .qtext {
            flex: 1 1 auto;
            min-width: 0;
            font-size: 16px;
            line-height: 1.55;
            color: var(--fg);
        }

        .q-body {
            margin-left: 0;
            margin-top: 6px;
        }

        .answer {
            margin-top: var(--s1);
            display: flex;
            align-items: baseline;
            gap: 10px;
            font-size: 14px;
            color: var(--muted);
        }

        .answer .label {
            font-weight: 600;
            color: var(--muted);
            flex: 0 0 auto;
        }

        .answer .value {
            font-size: 15px;
            color: var(--fg);
        }

        .toggle-row {
            margin-top: var(--s2);
        }

        .toggle {
            appearance: none;
            border: 1px solid var(--hair2);
            background: var(--bg);
            border-radius: 12px;
            padding: 8px 10px;
            font-size: 14px;
            cursor: pointer;
            color: var(--fg);
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .toggle .chev {
            font-size: 12px;
            color: var(--quiet);
            width: 12px;
            text-align: center;
        }

        /* Collapsed preview (1–2 lines) */
        .solution-preview {
            margin-top: var(--s3);
            color: var(--quiet);
            font-size: 13px;
            line-height: 1.45;
            max-width: 100%;
        }

        .solution-preview .preview-label {
            font-weight: 600;
            color: var(--muted);
            margin-right: 8px;
        }

        /* Expanded solution details */
        .solution-full[hidden] {
            display: none !important;
        }

        .solution-full {
            margin-top: var(--s4);
            color: var(--quiet);
            font-size: 14px;
        }

        .sol-block {
            margin-top: var(--s5);
        }

        .sol-block:first-child {
            margin-top: 0;
        }

        .sol-title {
            font-weight: 600;
            color: var(--muted);
            margin: 0 0 6px 0;
            font-size: 13px;
        }

        .sol-body {
            margin: 0;
            color: var(--quiet);
            font-size: 14px;
            line-height: 1.45;
        }

        /* Diagrams live inside Question block, grayscale, responsive */
        .diagram-wrap {
            margin-top: 10px;
            max-width: 520px;
        }

        svg.diagram {
            width: 100%;
            height: auto;
            display: block;
            border: 1px solid var(--hair);
            border-radius: 12px;
            background: var(--soft2);
        }

        .diagram-caption {
            font-size: 12px;
            color: var(--quiet);
            margin-top: 6px;
        }

        /* KaTeX containers & overflow handling */
        .math-inline {
            display: inline;
            white-space: normal;
        }

        .math-block {
            margin: 8px 0;
            padding: 8px 10px;
            border-radius: 12px;
            background: var(--soft2);
            border: 1px solid var(--hair);
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .math-block::-webkit-scrollbar {
            display: none;
        }

        .math-block:focus {
            outline: none;
        }

        .math-block:focus-visible {
            outline: 2px solid var(--hair2);
            outline-offset: 2px;
        }

        /* Mobile / Tablet */
        @media (max-width: 920px) {
            :root {
                --nav-w: 180px;
                --frame-gutter: 16px;
            }

            .shell {
                grid-template-columns: 1fr;
            }

            nav.nav {
                display: none;
            }
        }

        @media (max-width: 560px) {
            select {
                min-width: 100%;
            }

            .topbar {
                align-items: stretch;
            }

            .topbar .title {
                width: 100%;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }
        }

        /* Mobile nav overlay/drawer */
        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.25);
            display: none;
            align-items: stretch;
            justify-content: flex-start;
            z-index: 50;
        }

        .overlay[aria-hidden="false"] {
            display: flex;
        }

        .drawer {
            width: min(320px, 88vw);
            height: 100%;
            background: var(--bg);
            border-right: 1px solid var(--hair);
            padding: 12px 12px 16px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .drawer .drawer-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            padding-bottom: 6px;
            border-bottom: 1px solid var(--hair);
        }

        .drawer-title {
            font-size: 13px;
            color: var(--quiet);
            font-weight: 600;
            letter-spacing: 0.3px;
            text-transform: uppercase;
        }

        .drawer-close {
            border: 1px solid var(--hair2);
            background: var(--bg);
            color: var(--fg);
            border-radius: 12px;
            padding: 8px 10px;
            cursor: pointer;
            font-size: 14px;
        }

        .drawer .nav-list {
            max-height: calc(100vh - 140px);
            padding-right: 8px;
        }

        /* Make "Jump to" always accessible on small screens */
        .jump-cta {
            display: none;
        }

        @media (max-width: 920px) {
            .jump-cta {
                display: inline-flex;
            }
        }

        /* Respect reduced motion; also avoid smooth scroll by default */
        @media (prefers-reduced-motion: reduce) {
            * {
                scroll-behavior: auto !important;
            }
        }
    </style>
</head>

<body>
    <header>
        <div class="frame">
            <div class="topbar" role="region" aria-label="Top controls">
                <div class="title">RTQ – Maths Paper Solution Viewer</div>

                <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; width: min(700px, 100%);">
                    <label for="paperSelect">Paper selector</label>
                    <select id="paperSelect" aria-label="Paper selector"></select>

                    <button class="btn jump-cta" id="openNavBtn" type="button" aria-expanded="false"
                        aria-controls="navOverlay">
                        Jump to
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Desktop shell -->
    <div class="shell" id="shell">
        <nav class="nav" aria-label="Document navigation">
            <div class="nav-inner">
                <h2>Jump to</h2>
                <div class="nav-list" id="navList" tabindex="0" aria-label="Question navigation list">
                    <!-- built by JS -->
                </div>
            </div>
        </nav>

        <main id="main" tabindex="-1">
            <div class="paper-meta" id="paperMeta"></div>
            <div id="paperRoot" aria-label="Paper content"></div>
        </main>
    </div>

    <!-- Mobile drawer overlay -->
    <div class="overlay" id="navOverlay" aria-hidden="true">
        <div class="drawer" role="dialog" aria-modal="true" aria-label="Jump to">
            <div class="drawer-head">
                <div class="drawer-title">Jump to</div>
                <button class="drawer-close" id="closeNavBtn" type="button">Close</button>
            </div>
            <div class="nav-list" id="navListMobile" tabindex="0" aria-label="Question navigation list (mobile)">
                <!-- built by JS -->
            </div>
        </div>
        <div style="flex:1 1 auto;" aria-hidden="true"></div>
    </div>

    <script>
        (function () {
            const elSelect = document.getElementById('paperSelect');
            const elPaperRoot = document.getElementById('paperRoot');
            const elPaperMeta = document.getElementById('paperMeta');

            const elNavList = document.getElementById('navList');
            const elNavListMobile = document.getElementById('navListMobile');

            const overlay = document.getElementById('navOverlay');
            const openNavBtn = document.getElementById('openNavBtn');
            const closeNavBtn = document.getElementById('closeNavBtn');
            const shell = document.getElementById('shell');
            const main = document.getElementById('main');

            let currentPaperKey = null;
            let observer = null;

            const katexReady = () => (typeof window.katex !== 'undefined' && window.katex && typeof window.katex.render === 'function');

            function safeRenderKatex(container) {
                // Render all [data-math="inline"|"block"] nodes.
                const nodes = container.querySelectorAll('[data-math]');
                const ok = katexReady();

                nodes.forEach(node => {
                    const tex = node.getAttribute('data-tex') || '';
                    const mode = node.getAttribute('data-math');
                    if (!tex) {
                        node.textContent = '';
                        return;
                    }

                    if (ok) {
                        try {
                            window.katex.render(tex, node, {
                                throwOnError: false,
                                displayMode: mode === 'block'
                            });
                        } catch (e) {
                            node.textContent = tex; // fallback to plain text
                        }
                    } else {
                        node.textContent = tex; // fallback to plain text
                    }
                });
            }

            function slugId(qid) {
                // stable IDs, question-number-only semantics preserved in labels
                return 'q-' + String(qid).replace(/[^a-zA-Z0-9]+/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '').toLowerCase();
            }

            function makeDiagram(type) {
                // 4 reused SVG types, grayscale only
                const common = 'class="diagram" aria-label="Diagram" role="img"';
                if (type === 'geometry') {
                    return `
            <svg ${common} viewBox="0 0 320 200">
              <rect x="14" y="14" width="292" height="172" rx="14" fill="#f9f9f9" stroke="#d8d8d8"/>
              <circle cx="240" cy="84" r="42" fill="none" stroke="#6a6a6a" stroke-width="2"/>
              <path d="M60 150 L140 50 L220 150 Z" fill="none" stroke="#121212" stroke-width="2"/>
              <text x="132" y="44" font-size="12" fill="#4a4a4a">A</text>
              <text x="52" y="165" font-size="12" fill="#4a4a4a">B</text>
              <text x="224" y="165" font-size="12" fill="#4a4a4a">C</text>
              <text x="232" y="92" font-size="12" fill="#4a4a4a">r</text>
              <line x1="240" y1="84" x2="282" y2="84" stroke="#6a6a6a" stroke-width="2"/>
            </svg>
          `;
                }
                if (type === 'bars') {
                    return `
            <svg ${common} viewBox="0 0 320 200">
              <rect x="14" y="14" width="292" height="172" rx="14" fill="#f9f9f9" stroke="#d8d8d8"/>
              <rect x="40" y="56" width="240" height="22" fill="none" stroke="#121212" stroke-width="2"/>
              <rect x="40" y="56" width="150" height="22" fill="#e6e6e6" stroke="#121212" stroke-width="2"/>
              <text x="42" y="50" font-size="12" fill="#4a4a4a">Ratio bars</text>
              <rect x="40" y="108" width="240" height="22" fill="none" stroke="#121212" stroke-width="2"/>
              <rect x="40" y="108" width="90" height="22" fill="#e6e6e6" stroke="#121212" stroke-width="2"/>
              <line x1="130" y1="108" x2="130" y2="130" stroke="#121212" stroke-width="2"/>
              <line x1="190" y1="56" x2="190" y2="78" stroke="#121212" stroke-width="2"/>
              <text x="42" y="146" font-size="12" fill="#6a6a6a">Segments show parts</text>
            </svg>
          `;
                }
                if (type === 'grid') {
                    return `
            <svg ${common} viewBox="0 0 320 200">
              <rect x="14" y="14" width="292" height="172" rx="14" fill="#f9f9f9" stroke="#d8d8d8"/>
              <g stroke="#d8d8d8" stroke-width="1">
                ${Array.from({ length: 11 }).map((_, i) => `<line x1="${50 + i * 20}" y1="40" x2="${50 + i * 20}" y2="170"/>`).join('')}
                ${Array.from({ length: 7 }).map((_, i) => `<line x1="50" y1="${40 + i * 20}" x2="250" y2="${40 + i * 20}"/>`).join('')}
              </g>
              <g stroke="#6a6a6a" stroke-width="2">
                <line x1="50" y1="140" x2="250" y2="60"/>
              </g>
              <circle cx="90" cy="120" r="4" fill="#121212"/>
              <circle cx="210" cy="80" r="4" fill="#121212"/>
              <text x="54" y="34" font-size="12" fill="#4a4a4a">Coordinate grid</text>
              <text x="260" y="170" font-size="12" fill="#6a6a6a">x</text>
              <text x="40" y="46" font-size="12" fill="#6a6a6a">y</text>
            </svg>
          `;
                }
                // table-like grid / array
                return `
          <svg ${common} viewBox="0 0 320 200">
            <rect x="14" y="14" width="292" height="172" rx="14" fill="#f9f9f9" stroke="#d8d8d8"/>
            <text x="40" y="50" font-size="12" fill="#4a4a4a">Table / array</text>
            <g transform="translate(40,70)" stroke="#121212" stroke-width="2" fill="none">
              <rect x="0" y="0" width="240" height="96" rx="10"/>
              <line x1="80" y1="0" x2="80" y2="96"/>
              <line x1="160" y1="0" x2="160" y2="96"/>
              <line x1="0" y1="32" x2="240" y2="32"/>
              <line x1="0" y1="64" x2="240" y2="64"/>
            </g>
            <g transform="translate(52,92)" fill="#6a6a6a" font-size="12">
              <text x="0" y="0">a</text><text x="80" y="0">b</text><text x="160" y="0">c</text>
              <text x="0" y="32">d</text><text x="80" y="32">e</text><text x="160" y="32">f</text>
              <text x="0" y="64">g</text><text x="80" y="64">h</text><text x="160" y="64">i</text>
            </g>
          </svg>
        `;
            }

            function longWorkingLines(n) {
                // 50–60 lines of math working (display blocks), mix to stress KaTeX overflow on mobile
                const lines = [];
                for (let i = 1; i <= n; i++) {
                    const k = i % 6;
                    if (k === 0) lines.push(String.raw`x^{${(i % 9) + 2}} - 3x^{${(i % 7) + 1}} + 2 = 0`);
                    else if (k === 1) lines.push(String.raw`\frac{${i}+2}{${i}+3} + \frac{${i}+4}{${i}+5} = \frac{((${i}+2)(${i}+5) + (${i}+4)(${i}+3))}{(${i}+3)(${i}+5)}`);
                    else if (k === 2) lines.push(String.raw`\left(2x - 3\right)\left(x + 5\right) = 2x^2 + 10x - 3x - 15 = 2x^2 + 7x - 15`);
                    else if (k === 3) lines.push(String.raw`\sqrt{${(i % 97) + 4}} \approx ${(Math.sqrt((i % 97) + 4)).toFixed(3)}`);
                    else if (k === 4) lines.push(String.raw`\text{So }x = \frac{-b \pm \sqrt{b^2 - 4ac}}{2a}\text{ and substitute }a=2, b=7, c=-15`);
                    else lines.push(String.raw`(a+b)^2 = a^2 + 2ab + b^2\quad\Rightarrow\quad (x+${(i % 9) + 1})^2 = x^2 + ${2 * ((i % 9) + 1)}x + ${((i % 9) + 1) ** 2}`);
                }
                return lines;
            }

            function question(opts) {
                // opts: { id, depth, promptParts[], answerText, solution: { previewMath?, previewText?, keepInMind?, formulasUsed?, workingMathLines?, workingTextLines?, altWorkingMathLines? } }
                return Object.assign({
                    depth: 0,
                    promptParts: [],
                    answerText: '',
                    diagram: null,
                    solution: {
                        previewText: '',
                        previewMath: [],
                        keepInMind: null,
                        formulasUsed: null,
                        workingTitle: 'Working',
                        workingTextLines: [],
                        workingMathLines: [],
                        altWorkingMathLines: []
                    }
                }, opts);
            }

            function promptText(s) {
                return { type: 'text', value: s };
            }
            function promptInlineMath(tex) {
                return { type: 'math-inline', tex };
            }
            function promptBlockMath(tex) {
                return { type: 'math-block', tex };
            }

            function makeStandardQuestions() {
                const qs = [];

                // Q1–Q25 mixed, include some deep nesting and solution variants
                qs.push(question({
                    id: '1',
                    depth: 0,
                    promptParts: [promptText('Calculate '), promptInlineMath(String.raw`48 \div 6`), promptText('.')],
                    answerText: '8',
                    solution: {
                        previewText: 'Divide 48 by 6.',
                        previewMath: [String.raw`48 \div 6 = 8`],
                        workingMathLines: [String.raw`48 \div 6 = 8`]
                    }
                }));

                qs.push(question({
                    id: '2',
                    depth: 0,
                    promptParts: [promptText('Write '), promptInlineMath(String.raw`\frac{3}{5}`), promptText(' as a percentage.')],
                    answerText: '60%',
                    solution: {
                        previewText: 'Multiply by 100%.',
                        previewMath: [String.raw`\frac{3}{5}\times 100\% = 60\%`],
                        keepInMind: 'A fraction to a percentage means “out of 100”.',
                        workingMathLines: [
                            String.raw`\frac{3}{5}=0.6`,
                            String.raw`0.6\times 100\% = 60\%`
                        ],
                        altWorkingMathLines: [
                            String.raw`\frac{3}{5}\times \frac{100}{100}=\frac{60}{100}=60\%`
                        ]
                    }
                }));

                qs.push(question({
                    id: '3',
                    depth: 0,
                    promptParts: [promptText('A number '), promptInlineMath(String.raw`n`), promptText(' is increased by 15%. The result is 92. What is '), promptInlineMath(String.raw`n`), promptText('?')],
                    answerText: '80',
                    solution: {
                        previewText: 'Reverse the percentage increase.',
                        previewMath: [String.raw`1.15n = 92`],
                        formulasUsed: 'Percentage multiplier: new = old × (1 + rate).',
                        workingMathLines: [
                            String.raw`1.15n = 92`,
                            String.raw`n = \frac{92}{1.15} = 80`
                        ]
                    }
                }));

                // Multi-part and deep nesting example as Q18 with sub-questions
                qs.push(question({
                    id: '18',
                    depth: 0,
                    promptParts: [
                        promptText('A rectangle has length '), promptInlineMath(String.raw`(x+3)`),
                        promptText(' cm and width '), promptInlineMath(String.raw`(x-1)`), promptText(' cm.')
                    ],
                    answerText: 'See parts',
                    solution: {
                        previewText: 'Use area = length × width.',
                        previewMath: [String.raw`A=(x+3)(x-1)`],
                        keepInMind: 'Expand brackets carefully and combine like terms.',
                        formulasUsed: 'Area of rectangle: A = length × width.',
                        workingMathLines: [String.raw`A=(x+3)(x-1)=x^2+2x-3`]
                    }
                }));

                qs.push(question({
                    id: '18(a)(i)',
                    depth: 1,
                    promptParts: [
                        promptText('Show that the area can be written as '),
                        promptInlineMath(String.raw`x^2+2x-3`), promptText('.')
                    ],
                    answerText: String.raw`x^2 + 2x - 3`,
                    solution: {
                        previewText: 'Expand the brackets.',
                        previewMath: [String.raw`(x+3)(x-1)=x^2- x +3x -3`],
                        workingMathLines: [
                            String.raw`(x+3)(x-1)=x\cdot x + x\cdot(-1) + 3\cdot x + 3\cdot(-1)`,
                            String.raw`=x^2 - x + 3x - 3`,
                            String.raw`=x^2 + 2x - 3`
                        ]
                    }
                }));

                qs.push(question({
                    id: '18(a)(ii)',
                    depth: 1,
                    promptParts: [
                        promptText('If the area is 45 cm'), promptInlineMath(String.raw`^2`),
                        promptText(', find '), promptInlineMath(String.raw`x`), promptText('.')
                    ],
                    answerText: String.raw`x = 5`,
                    solution: {
                        previewText: 'Set the expression equal to 45 and solve.',
                        previewMath: [String.raw`x^2+2x-3=45`],
                        workingMathLines: [
                            String.raw`x^2+2x-3=45`,
                            String.raw`x^2+2x-48=0`,
                            String.raw`(x+8)(x-6)=0`,
                            String.raw`x=6 \text{ or } x=-8`,
                            String.raw`x=6\text{ (lengths are positive)}`
                        ],
                        altWorkingMathLines: [
                            String.raw`x=\frac{-2\pm\sqrt{2^2-4(1)(-48)}}{2}=\frac{-2\pm\sqrt{196}}{2}=\frac{-2\pm 14}{2}`,
                            String.raw`x=6\text{ or }x=-8\Rightarrow x=6`
                        ]
                    }
                }));

                qs.push(question({
                    id: '18(b)',
                    depth: 1,
                    promptParts: [promptText('Find the perimeter in terms of '), promptInlineMath(String.raw`x`), promptText('.')],
                    answerText: String.raw`4x + 4`,
                    solution: {
                        previewText: 'Perimeter = 2(length + width).',
                        previewMath: [String.raw`P=2((x+3)+(x-1))`],
                        formulasUsed: 'Perimeter of rectangle: P = 2(L + W).',
                        workingMathLines: [
                            String.raw`P=2\big((x+3)+(x-1)\big)`,
                            String.raw`=2(2x+2)`,
                            String.raw`=4x+4`
                        ]
                    }
                }));

                // A few diagram questions sprinkled
                qs.push(question({
                    id: '9',
                    depth: 0,
                    promptParts: [promptText('In the diagram, find the radius '), promptInlineMath(String.raw`r`), promptText(' of the circle.')],
                    diagram: { type: 'geometry', caption: 'A triangle and a circle are shown (placeholder).' },
                    answerText: String.raw`r = 4`,
                    solution: {
                        previewText: 'Use the given lengths in the diagram.',
                        previewMath: [String.raw`r=4`],
                        workingTextLines: [
                            'Read the labelled lengths from the diagram and apply the stated relationship.'
                        ],
                        workingMathLines: [
                            String.raw`r=4`
                        ]
                    }
                }));

                // Fill remaining Q4–Q25 with small/medium items
                for (let i = 4; i <= 25; i++) {
                    if (['9', '18'].includes(String(i))) continue;
                    const id = String(i);
                    const isAlt = (i % 7 === 0);
                    const hasKeep = (i === 7 || i === 13 || i === 21);
                    const hasForm = (i === 6 || i === 14 || i === 22);
                    const prompt = [
                        promptText('Solve: '),
                        promptInlineMath(String.raw`${i}+x= ${i + 9}`),
                        promptText('.')
                    ];
                    const ans = 'x = 9';
                    const sol = {
                        previewText: 'Subtract to isolate x.',
                        previewMath: [String.raw`x = (${i + 9}) - ${i} = 9`],
                        keepInMind: hasKeep ? 'To undo addition, subtract the same amount from both sides.' : null,
                        formulasUsed: hasForm ? 'Balance method: do the same operation to both sides.' : null,
                        workingMathLines: [
                            String.raw`${i}+x=${i + 9}`,
                            String.raw`x=${i + 9}-${i}`,
                            String.raw`x=9`
                        ],
                        altWorkingMathLines: isAlt ? [String.raw`x = (${i + 9}) - ${i} = 9`] : []
                    };
                    // One more diagram type occasionally
                    const diag = (i === 12 || i === 16) ? { type: 'bars', caption: 'Ratio bars (placeholder).' } : null;

                    qs.push(question({ id, depth: 0, promptParts: prompt, answerText: ans, diagram: diag, solution: sol }));
                }

                // Q26–Q35 long algebra, long workings collapsed by default (dataset default)
                for (let i = 26; i <= 35; i++) {
                    const id = String(i);
                    const deepNest = (i === 30);
                    const base = question({
                        id,
                        depth: 0,
                        promptParts: [
                            promptText('Algebra: simplify and solve for '),
                            promptInlineMath(String.raw`x`),
                            promptText(' given:'),
                            promptBlockMath(String.raw`\frac{2x-3}{x+5} = \frac{x+1}{x-2}`)
                        ],
                        answerText: (i % 2 === 0) ? String.raw`x = 7` : String.raw`x = 3`,
                        solution: {
                            previewText: 'Cross-multiply and solve.',
                            previewMath: [String.raw`(2x-3)(x-2)=(x+1)(x+5)`],
                            keepInMind: (i === 31 || i === 33) ? 'Check for excluded values where denominators are zero.' : null,
                            formulasUsed: (i === 30 || i === 32 || i === 34) ? 'If a/b = c/d, then ad = bc (when b,d ≠ 0).' : null,
                            workingMathLines: [
                                String.raw`(2x-3)(x-2)=(x+1)(x+5)`,
                                String.raw`2x^2-4x-3x+6=x^2+6x+5`,
                                String.raw`2x^2-7x+6=x^2+6x+5`,
                                String.raw`x^2-13x+1=0`,
                                String.raw`x=\frac{13\pm\sqrt{169-4}}{2}=\frac{13\pm\sqrt{165}}{2}`
                            ],
                            altWorkingMathLines: (i === 34) ? [
                                String.raw`(2x-3)(x-2)-(x+1)(x+5)=0`,
                                String.raw`x^2-13x+1=0`
                            ] : []
                        }
                    });

                    // Extremely long workings for selected questions
                    if (i === 30 || i === 35) {
                        base.solution.workingMathLines = base.solution.workingMathLines.concat(longWorkingLines(i === 30 ? 56 : 52));
                    }

                    qs.push(base);

                    // Add deep nesting for Q30(a)(i) etc (ADD-ON requirement)
                    if (deepNest) {
                        qs.push(question({
                            id: '30(a)(i)',
                            depth: 1,
                            promptParts: [
                                promptText('Show that '),
                                promptInlineMath(String.raw`(2x-3)(x-2)=(x+1)(x+5)`),
                                promptText(' is obtained by cross-multiplying.')
                            ],
                            answerText: 'Shown',
                            solution: {
                                previewText: 'Multiply each side by both denominators.',
                                previewMath: [String.raw`(2x-3)(x-2)=(x+1)(x+5)`],
                                workingMathLines: [
                                    String.raw`\frac{2x-3}{x+5}=\frac{x+1}{x-2}`,
                                    String.raw`(2x-3)(x-2)=(x+1)(x+5)`
                                ]
                            }
                        }));
                        qs.push(question({
                            id: '30(a)(ii)',
                            depth: 1,
                            promptParts: [
                                promptText('Expand both sides and collect terms.')
                            ],
                            answerText: String.raw`x^2 - 13x + 1 = 0`,
                            solution: {
                                previewText: 'Expand, then bring all terms to one side.',
                                previewMath: [String.raw`x^2-13x+1=0`],
                                workingMathLines: [
                                    String.raw`(2x-3)(x-2)=2x^2-7x+6`,
                                    String.raw`(x+1)(x+5)=x^2+6x+5`,
                                    String.raw`2x^2-7x+6=x^2+6x+5`,
                                    String.raw`x^2-13x+1=0`
                                ],
                                altWorkingMathLines: [
                                    String.raw`2x^2-7x+6-(x^2+6x+5)=0`,
                                    String.raw`x^2-13x+1=0`
                                ]
                            }
                        }));
                        qs.push(question({
                            id: '30(b)',
                            depth: 1,
                            promptParts: [
                                promptText('Solve the quadratic equation from part (a)(ii).')
                            ],
                            answerText: String.raw`x=\frac{13\pm\sqrt{165}}{2}`,
                            solution: {
                                previewText: 'Use the quadratic formula.',
                                previewMath: [String.raw`x=\frac{13\pm\sqrt{165}}{2}`],
                                formulasUsed: 'Quadratic formula: x = (−b ± √(b² − 4ac)) / (2a).',
                                workingMathLines: [
                                    String.raw`a=1,\;b=-13,\;c=1`,
                                    String.raw`x=\frac{-b\pm\sqrt{b^2-4ac}}{2a}=\frac{13\pm\sqrt{169-4}}{2}`,
                                    String.raw`x=\frac{13\pm\sqrt{165}}{2}`
                                ]
                            }
                        }));
                    }
                }

                // Ensure solution details coverage stress test distribution
                // (Keep in mind / Formulas used / Alternative working already sprinkled above + in long section)
                return qs;
            }

            function makeShortPaper() {
                return {
                    key: 'short',
                    name: 'Short paper',
                    meta: '6 questions • mixed short arithmetic + one multi-part question',
                    sectioned: false,
                    expandedDefault: false,
                    questions: [
                        question({
                            id: '1',
                            depth: 0,
                            promptParts: [promptText('Calculate '), promptInlineMath(String.raw`7\times 8`), promptText('.')],
                            answerText: '56',
                            solution: {
                                previewText: 'Multiply 7 by 8.',
                                previewMath: [String.raw`7\times 8 = 56`],
                                workingMathLines: [String.raw`7\times 8 = 56`]
                            }
                        }),
                        question({
                            id: '2',
                            depth: 0,
                            promptParts: [promptText('Find '), promptInlineMath(String.raw`120 - 47`), promptText('.')],
                            answerText: '73',
                            solution: {
                                previewText: 'Subtract 47 from 120.',
                                previewMath: [String.raw`120-47=73`],
                                workingMathLines: [String.raw`120-47=73`]
                            }
                        }),
                        question({
                            id: '3',
                            depth: 0,
                            promptParts: [promptText('Write '), promptInlineMath(String.raw`0.25`), promptText(' as a fraction in simplest form.')],
                            answerText: String.raw`\frac{1}{4}`,
                            solution: {
                                previewText: '0.25 is 25/100 then simplify.',
                                previewMath: [String.raw`0.25=\frac{25}{100}=\frac{1}{4}`],
                                keepInMind: 'Simplify a fraction by dividing top and bottom by the same number.',
                                workingMathLines: [String.raw`0.25=\frac{25}{100}=\frac{1}{4}`],
                                altWorkingMathLines: [String.raw`0.25=\frac{1}{4}\text{ because }1\div 4=0.25`]
                            }
                        }),
                        question({
                            id: '4',
                            depth: 0,
                            promptParts: [promptText('A book costs £12. It is reduced by 10%. What is the new price?')],
                            answerText: '£10.80',
                            solution: {
                                previewText: 'Find 10% of 12 and subtract.',
                                previewMath: [String.raw`12 - 0.10\times 12 = 10.8`],
                                formulasUsed: 'New price = original × (1 − discount rate).',
                                workingMathLines: [
                                    String.raw`10\%\text{ of }12 = 0.10\times 12 = 1.2`,
                                    String.raw`12-1.2=10.8`
                                ]
                            }
                        }),
                        question({
                            id: '5',
                            depth: 0,
                            promptParts: [promptText('Solve: '), promptInlineMath(String.raw`3x + 2 = 20`), promptText('.')],
                            answerText: 'x = 6',
                            solution: {
                                previewText: 'Subtract 2 then divide by 3.',
                                previewMath: [String.raw`x=\frac{18}{3}=6`],
                                workingMathLines: [
                                    String.raw`3x+2=20`,
                                    String.raw`3x=18`,
                                    String.raw`x=6`
                                ]
                            }
                        }),
                        question({
                            id: '6',
                            depth: 0,
                            promptParts: [promptText('A rectangle has length 9 cm and width 4 cm.')],
                            answerText: 'See parts',
                            solution: {
                                previewText: 'Use area and perimeter formulas.',
                                previewMath: [String.raw`A=9\times 4`]
                            }
                        }),
                        question({
                            id: '6(a)',
                            depth: 1,
                            promptParts: [promptText('Find the area.')],
                            answerText: '36 cm²',
                            solution: {
                                previewText: 'Area = 9 × 4.',
                                previewMath: [String.raw`A=9\times 4 = 36`],
                                formulasUsed: 'Area of rectangle: A = L × W.',
                                workingMathLines: [String.raw`A=9\times 4=36`]
                            }
                        }),
                        question({
                            id: '6(b)',
                            depth: 1,
                            promptParts: [promptText('Find the perimeter.')],
                            answerText: '26 cm',
                            solution: {
                                previewText: 'Perimeter = 2(9+4).',
                                previewMath: [String.raw`P=2(9+4)=26`],
                                formulasUsed: 'Perimeter of rectangle: P = 2(L+W).',
                                workingMathLines: [String.raw`P=2(9+4)=26`]
                            }
                        })
                    ]
                };
            }

            function makeDiagramHeavyPaper() {
                const qs = [];
                // 20 questions, 8 diagrams
                const diagramIds = new Set(['2', '4', '6', '9', '11', '14', '16', '19']);
                const diagTypes = ['geometry', 'bars', 'grid', 'array'];
                for (let i = 1; i <= 20; i++) {
                    const id = String(i);
                    const hasDiag = diagramIds.has(id);
                    const diag = hasDiag ? { type: diagTypes[i % diagTypes.length], caption: 'Diagram placeholder (inline SVG).' } : null;

                    qs.push(question({
                        id,
                        depth: 0,
                        promptParts: hasDiag
                            ? [promptText('Use the diagram to answer the question. Compute the required value.')]
                            : [promptText('Calculate '), promptInlineMath(String.raw`${i}+${i + 3}`), promptText('.')],
                        diagram: diag,
                        answerText: hasDiag ? String.raw`Value = ${i}` : String(i + (i + 3)),
                        solution: {
                            previewText: hasDiag ? 'Read the relevant labels and apply the relationship.' : 'Add the numbers.',
                            previewMath: hasDiag ? [String.raw`${i}`] : [String.raw`${i}+${i + 3}=${i + (i + 3)}`],
                            keepInMind: (i === 5 || i === 10 || i === 15) ? 'Keep track of units where relevant.' : null,
                            formulasUsed: (i === 8 || i === 12 || i === 18) ? 'Use the formula given in the question statement.' : null,
                            workingMathLines: hasDiag
                                ? [String.raw`${i}`]
                                : [String.raw`${i}+${i + 3}=${i + (i + 3)}`],
                            altWorkingMathLines: (i === 7 || i === 14 || i === 20) ? [String.raw`${i + (i + 3)}`] : []
                        }
                    }));
                }
                return {
                    key: 'diagram',
                    name: 'Diagram-heavy paper',
                    meta: '20 questions • 8 with diagrams (inline SVG placeholders)',
                    sectioned: false,
                    expandedDefault: false,
                    questions: qs
                };
            }

            function makeSectionedPaper() {
                // Sections A/B/C with non-clickable labels, identifiers only
                const sections = [];

                // Section A: 35 small/medium
                const A = [];
                for (let i = 1; i <= 35; i++) {
                    A.push(question({
                        id: String(i),
                        depth: 0,
                        promptParts: [
                            promptText('Section A: Simplify '),
                            promptInlineMath(String.raw`${i}x + ${i}`),
                            promptText(' when '),
                            promptInlineMath(String.raw`x=2`),
                            promptText('.')
                        ],
                        answerText: String(i * 2 + i),
                        solution: {
                            previewText: 'Substitute x=2.',
                            previewMath: [String.raw`${i}\cdot 2 + ${i} = ${i * 2 + i}`],
                            workingMathLines: [String.raw`${i}x+${i}\;\Rightarrow\;${i}\cdot 2+${i}=${i * 2 + i}`],
                            keepInMind: (i === 3 || i === 17 || i === 29) ? 'Substitute the value first, then calculate.' : null,
                            formulasUsed: (i === 6 || i === 18 || i === 30) ? 'Substitution: replace x with the given value.' : null,
                            altWorkingMathLines: (i === 9 || i === 21 || i === 33) ? [String.raw`${i}(2+1)=${i * 3}`] : []
                        }
                    }));
                }

                // Section B: 8 medium
                const B = [];
                for (let i = 1; i <= 8; i++) {
                    const id = String(i);
                    B.push(question({
                        id: String(i),
                        depth: 0,
                        promptParts: [
                            promptText('Section B: Solve '),
                            promptInlineMath(String.raw`2x + ${i} = ${i + 12}`),
                            promptText('.')
                        ],
                        answerText: 'x = 6',
                        solution: {
                            previewText: 'Subtract then divide.',
                            previewMath: [String.raw`2x=${i + 12}-${i}=12`],
                            formulasUsed: (i === 2 || i === 5 || i === 8) ? 'Balance method: do the same to both sides.' : null,
                            workingMathLines: [
                                String.raw`2x+${i}=${i + 12}`,
                                String.raw`2x=12`,
                                String.raw`x=6`
                            ],
                            altWorkingMathLines: (i === 4) ? [String.raw`x=\frac{12}{2}=6`] : []
                        }
                    }));
                }

                // Section C: 6 very long solution details (collapsed by default)
                const C = [];
                for (let i = 1; i <= 6; i++) {
                    const qid = String(i);
                    const hasAll = (i === 3); // Keep in mind + Formulas used + Alternative working
                    const baseWorking = [
                        String.raw`\text{Start with the expression and simplify step-by-step.}`,
                        String.raw`\left(3x - 5\right)^2 = 9x^2 - 30x + 25`,
                        String.raw`9x^2 - 30x + 25 = 0`,
                        String.raw`x=\frac{30\pm\sqrt{900-900}}{18}=\frac{30}{18}=\frac{5}{3}`
                    ].concat(longWorkingLines(50 + (i % 3))); // extremely long

                    C.push(question({
                        id: qid,
                        depth: 0,
                        promptParts: [
                            promptText('Section C: A long algebraic derivation is required. Simplify and solve:'),
                            promptBlockMath(String.raw`(3x-5)^2 = 0`)
                        ],
                        answerText: String.raw`x=\frac{5}{3}`,
                        solution: {
                            previewText: 'Expand the square and solve.',
                            previewMath: [String.raw`(3x-5)^2=0\Rightarrow 3x-5=0`],
                            keepInMind: hasAll || i === 1 ? 'Keep expressions tidy and check each expansion.' : null,
                            formulasUsed: hasAll || i === 2 ? 'Square of a binomial: (a−b)² = a² − 2ab + b².' : null,
                            workingMathLines: baseWorking,
                            altWorkingMathLines: hasAll ? [
                                String.raw`(3x-5)^2=0\Rightarrow 3x-5=0`,
                                String.raw`3x=5\Rightarrow x=\frac{5}{3}`
                            ] : []
                        }
                    }));
                }

                sections.push({ label: 'A', questions: A });
                sections.push({ label: 'B', questions: B });
                sections.push({ label: 'C', questions: C });

                return {
                    key: 'sectioned',
                    name: 'Sectioned paper (original structure)',
                    meta: 'Section A: 35 • Section B: 8 • Section C: 6 (very long Solution Details, collapsed by default)',
                    sectioned: true,
                    expandedDefault: false,
                    sections
                };
            }

            function makeStandardPaper(expandedDefault) {
                const qs = makeStandardQuestions();
                return {
                    key: expandedDefault ? 'standard_expanded' : 'standard',
                    name: expandedDefault ? 'Standard (Workings Expanded)' : 'Standard paper',
                    meta: expandedDefault
                        ? '35 questions • Q26–Q35 long algebra • all workings expanded (dataset variant)'
                        : '35 questions • Q26–Q35 long algebra (Solution Details collapsed by default)',
                    sectioned: false,
                    expandedDefault: !!expandedDefault,
                    questions: qs.filter(q => {
                        // Ensure exactly 35 top-level question identifiers exist.
                        // The paper is a linear document; sub-questions are included too (deep nesting add-on).
                        return true;
                    })
                };
            }

            const PAPERS = [
                makeShortPaper(),
                makeStandardPaper(false),
                makeStandardPaper(true),   // add-on dataset variant
                makeDiagramHeavyPaper(),
                makeSectionedPaper()
            ];

            function navModel(paper) {
                // Returns array of nav items: {type:'section'|'item', label, targetId, depth}
                const items = [];
                if (paper.sectioned) {
                    paper.sections.forEach(sec => {
                        items.push({ type: 'section', label: sec.label });
                        sec.questions.forEach(q => items.push({ type: 'item', label: q.id, targetId: slugId(q.id), depth: q.depth || 0 }));
                    });
                } else {
                    const qs = paper.questions;
                    qs.forEach(q => items.push({ type: 'item', label: q.id, targetId: slugId(q.id), depth: q.depth || 0 }));
                }
                return items;
            }

            function renderNav(items, container) {
                container.innerHTML = '';
                let currentUl = document.createElement('ul');

                let wrap = document.createElement('div');
                wrap.appendChild(currentUl);

                items.forEach(it => {
                    if (it.type === 'section') {
                        const label = document.createElement('div');
                        label.className = 'section-label';
                        label.textContent = it.label;
                        // append and start a new list beneath
                        container.appendChild(label);
                        currentUl = document.createElement('ul');
                        container.appendChild(currentUl);
                        return;
                    }

                    const li = document.createElement('li');
                    const a = document.createElement('a');
                    a.href = '#' + it.targetId;
                    a.textContent = it.label; // question identifiers only
                    a.dataset.targetId = it.targetId;
                    a.dataset.qid = it.label;
                    a.style.paddingLeft = (8 + Math.min(it.depth, 3) * 10) + 'px';
                    a.setAttribute('aria-current', 'false');
                    li.appendChild(a);
                    currentUl.appendChild(li);
                });

                // click handling
                container.addEventListener('click', (e) => {
                    const link = e.target && e.target.closest && e.target.closest('a[data-target-id]');
                    if (!link) return;
                    e.preventDefault();

                    const id = link.dataset.targetId;
                    const target = document.getElementById(id);
                    if (target) {
                        // No smooth motion
                        target.scrollIntoView({ block: 'start' });
                        // Do not force focus movement
                        closeOverlayIfOpen();
                    }
                }, { passive: false });
            }

            function renderPromptParts(parts) {
                const frag = document.createDocumentFragment();
                parts.forEach(p => {
                    if (p.type === 'text') {
                        frag.appendChild(document.createTextNode(p.value));
                    } else if (p.type === 'math-inline') {
                        const span = document.createElement('span');
                        span.className = 'math-inline';
                        span.setAttribute('data-math', 'inline');
                        span.setAttribute('data-tex', p.tex);
                        frag.appendChild(span);
                    } else if (p.type === 'math-block') {
                        const div = document.createElement('div');
                        div.className = 'math-block';
                        div.tabIndex = 0;
                        div.setAttribute('data-math', 'block');
                        div.setAttribute('data-tex', p.tex);
                        frag.appendChild(div);
                    }
                });
                return frag;
            }

            function makeSolutionBlock(title, bodyNodes) {
                const block = document.createElement('div');
                block.className = 'sol-block';

                const h = document.createElement('div');
                h.className = 'sol-title';
                h.textContent = title;

                const body = document.createElement('div');
                body.className = 'sol-body';
                bodyNodes.forEach(n => body.appendChild(n));

                block.appendChild(h);
                block.appendChild(body);
                return block;
            }

            function mathLineNode(tex) {
                const div = document.createElement('div');
                div.className = 'math-block';
                div.tabIndex = 0;
                div.setAttribute('data-math', 'block');
                div.setAttribute('data-tex', tex);
                return div;
            }

            function textLineNode(text) {
                const p = document.createElement('p');
                p.style.margin = '0 0 8px 0';
                p.textContent = text;
                return p;
            }

            function buildQuestionNode(q, expandedByDefault) {
                const art = document.createElement('article');
                art.className = `q depth-${Math.min(q.depth || 0, 3)}`;
                art.id = slugId(q.id);

                const head = document.createElement('div');
                head.className = 'q-head';

                const qid = document.createElement('div');
                qid.className = 'qid';
                qid.textContent = q.id;

                const qtext = document.createElement('div');
                qtext.className = 'qtext';
                qtext.appendChild(renderPromptParts(q.promptParts || []));

                head.appendChild(qid);
                head.appendChild(qtext);

                const body = document.createElement('div');
                body.className = 'q-body';

                // diagram inside question block
                if (q.diagram && q.diagram.type) {
                    const wrap = document.createElement('div');
                    wrap.className = 'diagram-wrap';
                    wrap.innerHTML = makeDiagram(q.diagram.type);
                    const cap = document.createElement('div');
                    cap.className = 'diagram-caption';
                    cap.textContent = q.diagram.caption || 'Diagram placeholder.';
                    wrap.appendChild(cap);
                    body.appendChild(wrap);
                }

                // answer visible by default
                const ans = document.createElement('div');
                ans.className = 'answer';
                const label = document.createElement('div');
                label.className = 'label';
                label.textContent = 'Answer';
                const value = document.createElement('div');
                value.className = 'value';
                // Answer may contain TeX; render as inline katex container
                const ansMath = document.createElement('span');
                ansMath.setAttribute('data-math', 'inline');
                ansMath.setAttribute('data-tex', q.answerText || '');
                value.appendChild(ansMath);
                ans.appendChild(label);
                ans.appendChild(value);

                // toggle row
                const toggleRow = document.createElement('div');
                toggleRow.className = 'toggle-row';

                const toggle = document.createElement('button');
                toggle.type = 'button';
                toggle.className = 'toggle';
                const chev = document.createElement('span');
                chev.className = 'chev';
                chev.textContent = expandedByDefault ? '▾' : '▸';
                const tlabel = document.createElement('span');
                tlabel.textContent = expandedByDefault ? 'Hide working' : 'Show working';

                toggle.appendChild(chev);
                toggle.appendChild(tlabel);

                const controlsId = art.id + '-solution';
                toggle.setAttribute('aria-controls', controlsId);
                toggle.setAttribute('aria-expanded', expandedByDefault ? 'true' : 'false');

                toggleRow.appendChild(toggle);

                // collapsed preview (1–2 lines max)
                const preview = document.createElement('div');
                preview.className = 'solution-preview';
                const previewLabel = document.createElement('span');
                previewLabel.className = 'preview-label';
                previewLabel.textContent = 'Preview';
                preview.appendChild(previewLabel);

                const previewBody = document.createElement('span');
                const pvText = (q.solution && q.solution.previewText) ? q.solution.previewText : '';
                if (pvText) {
                    previewBody.appendChild(document.createTextNode(pvText + ' '));
                }
                // up to 2 preview math lines rendered as inline snippets
                const pvMath = (q.solution && Array.isArray(q.solution.previewMath)) ? q.solution.previewMath.slice(0, 2) : [];
                pvMath.forEach((tex, idx) => {
                    const m = document.createElement('span');
                    m.style.display = 'inline-block';
                    m.style.marginRight = (idx === pvMath.length - 1) ? '0' : '10px';
                    m.setAttribute('data-math', 'inline');
                    m.setAttribute('data-tex', tex);
                    previewBody.appendChild(m);
                });

                preview.appendChild(previewBody);

                // full solution details (hidden when collapsed)
                const full = document.createElement('div');
                full.className = 'solution-full';
                full.id = controlsId;
                if (!expandedByDefault) full.hidden = true;

                const sol = q.solution || {};

                // When expanded, Solution Details may include in order:
                // Keep in mind (optional), Formulas used (optional), Working, Alternative working (0+)
                const blocks = [];

                if (sol.keepInMind) {
                    blocks.push(makeSolutionBlock('Keep in mind', [textLineNode(sol.keepInMind)]));
                }

                if (sol.formulasUsed) {
                    blocks.push(makeSolutionBlock('Formulas used', [textLineNode(sol.formulasUsed)]));
                }

                // Working (primary)
                const workingNodes = [];
                (sol.workingTextLines || []).forEach(t => workingNodes.push(textLineNode(t)));
                (sol.workingMathLines || []).forEach(tex => workingNodes.push(mathLineNode(tex)));
                if (workingNodes.length === 0) {
                    // ensure at least something exists when expanded
                    workingNodes.push(textLineNode('No additional working provided.'));
                }
                blocks.push(makeSolutionBlock('Working', workingNodes));

                // Alternative working (0+)
                const alt = sol.altWorkingMathLines || [];
                if (alt.length > 0) {
                    const altNodes = alt.map(tex => mathLineNode(tex));
                    blocks.push(makeSolutionBlock('Alternative working', altNodes));
                }

                blocks.forEach(b => full.appendChild(b));

                // Toggle behavior
                toggle.addEventListener('click', () => {
                    const isOpen = toggle.getAttribute('aria-expanded') === 'true';
                    const next = !isOpen;

                    toggle.setAttribute('aria-expanded', next ? 'true' : 'false');
                    chev.textContent = next ? '▾' : '▸';
                    tlabel.textContent = next ? 'Hide working' : 'Show working';

                    if (next) {
                        full.hidden = false;
                    } else {
                        full.hidden = true;
                    }

                    // No forced focus movement or automatic scroll.
                });

                body.appendChild(ans);
                body.appendChild(toggleRow);
                body.appendChild(preview);
                body.appendChild(full);

                art.appendChild(head);
                art.appendChild(body);

                return art;
            }

            function buildPaper(paper) {
                // Clean up observer
                if (observer) {
                    observer.disconnect();
                    observer = null;
                }

                currentPaperKey = paper.key;

                // Meta
                elPaperMeta.textContent = paper.meta || '';

                // Build content
                elPaperRoot.innerHTML = '';

                const expandedByDefault = !!paper.expandedDefault;

                if (paper.sectioned) {
                    // Respect original structure; display section labels as structural dividers (not containers/cards)
                    paper.sections.forEach(sec => {
                        const secLabel = document.createElement('div');
                        secLabel.style.margin = '18px 0 10px';
                        secLabel.style.color = 'var(--muted)';
                        secLabel.style.fontSize = '13px';
                        secLabel.style.fontWeight = '600';
                        secLabel.textContent = sec.label;
                        elPaperRoot.appendChild(secLabel);

                        sec.questions.forEach(q => {
                            elPaperRoot.appendChild(buildQuestionNode(q, expandedByDefault));
                        });
                    });
                } else {
                    paper.questions.forEach(q => {
                        elPaperRoot.appendChild(buildQuestionNode(q, expandedByDefault));
                    });
                }

                // Render nav (desktop + mobile) with question identifiers only
                const items = navModel(paper);
                renderNav(items, elNavList);
                renderNav(items, elNavListMobile);

                // After DOM ready, render KaTeX (or fall back to plain text)
                safeRenderKatex(document);

                // Current position indicator (subtle)
                setupCurrentNavTracking(paper);

                // Reset mobile overlay state
                closeOverlayIfOpen(true);
            }

            function setupCurrentNavTracking(paper) {
                const targets = Array.from(elPaperRoot.querySelectorAll('article.q[id]'));
                const allLinks = Array.from(document.querySelectorAll('.nav-list a[data-target-id]'));

                function setCurrent(id) {
                    allLinks.forEach(a => {
                        a.setAttribute('aria-current', a.dataset.targetId === id ? 'true' : 'false');
                    });
                }

                // Default: first question if exists
                if (targets.length) {
                    setCurrent(targets[0].id);
                }

                observer = new IntersectionObserver((entries) => {
                    // choose the most visible entry near top
                    const visible = entries
                        .filter(e => e.isIntersecting)
                        .sort((a, b) => (b.intersectionRatio - a.intersectionRatio));

                    if (visible.length) {
                        setCurrent(visible[0].target.id);
                    }
                }, {
                    root: null,
                    threshold: [0.15, 0.25, 0.4, 0.6]
                });

                targets.forEach(t => observer.observe(t));
            }

            function populateSelector() {
                elSelect.innerHTML = '';
                PAPERS.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.key;
                    opt.textContent = p.name;
                    elSelect.appendChild(opt);
                });

                elSelect.addEventListener('change', () => {
                    const nextKey = elSelect.value;
                    const paper = PAPERS.find(p => p.key === nextKey);
                    if (paper) buildPaper(paper);
                });
            }

            // Mobile overlay open/close with focus trapping and background interaction blocked
            let lastFocus = null;

            function openOverlay() {
                lastFocus = document.activeElement;

                overlay.setAttribute('aria-hidden', 'false');
                openNavBtn.setAttribute('aria-expanded', 'true');

                // Block background interaction
                // Use inert where supported; fallback to aria-hidden + pointer-events
                try {
                    shell.inert = true;
                } catch (e) { }
                shell.setAttribute('aria-hidden', 'true');
                document.body.style.overflow = 'hidden';

                // Focus close button (no scrolling)
                closeNavBtn.focus({ preventScroll: true });

                document.addEventListener('keydown', onOverlayKeydown, true);
            }

            function closeOverlayIfOpen(force) {
                const open = overlay.getAttribute('aria-hidden') === 'false';
                if (!open && !force) return;

                overlay.setAttribute('aria-hidden', 'true');
                openNavBtn.setAttribute('aria-expanded', 'false');

                try {
                    shell.inert = false;
                } catch (e) { }
                shell.removeAttribute('aria-hidden');
                document.body.style.overflow = '';

                document.removeEventListener('keydown', onOverlayKeydown, true);

                if (lastFocus && !force) {
                    try { lastFocus.focus({ preventScroll: true }); } catch (e) { }
                }
                lastFocus = null;
            }

            function onOverlayKeydown(e) {
                const open = overlay.getAttribute('aria-hidden') === 'false';
                if (!open) return;

                if (e.key === 'Escape') {
                    e.stopPropagation();
                    e.preventDefault();
                    closeOverlayIfOpen();
                    return;
                }

                // simple focus trap inside the drawer
                if (e.key === 'Tab') {
                    const focusables = overlay.querySelectorAll('button, a[href], [tabindex]:not([tabindex="-1"])');
                    const list = Array.from(focusables).filter(el => !el.hasAttribute('disabled') && el.offsetParent !== null);
                    if (!list.length) return;

                    const first = list[0];
                    const last = list[list.length - 1];

                    if (e.shiftKey && document.activeElement === first) {
                        e.preventDefault();
                        last.focus({ preventScroll: true });
                    } else if (!e.shiftKey && document.activeElement === last) {
                        e.preventDefault();
                        first.focus({ preventScroll: true });
                    }
                }
            }

            openNavBtn.addEventListener('click', () => {
                const open = overlay.getAttribute('aria-hidden') === 'false';
                if (open) closeOverlayIfOpen();
                else openOverlay();
            });

            closeNavBtn.addEventListener('click', () => closeOverlayIfOpen());
            overlay.addEventListener('mousedown', (e) => {
                // click outside drawer closes
                const drawer = overlay.querySelector('.drawer');
                if (!drawer.contains(e.target)) {
                    closeOverlayIfOpen();
                }
            });

            // Init
            populateSelector();
            // Default to Standard paper (collapsed by default)
            const defaultPaper = PAPERS.find(p => p.key === 'standard') || PAPERS[0];
            elSelect.value = defaultPaper.key;
            buildPaper(defaultPaper);

            // If KaTeX loads later, we might have rendered fallback text already; attempt re-render once.
            window.addEventListener('load', () => {
                safeRenderKatex(document);
            }, { once: true });
        })();
    </script>
</body>

</html>