<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>RTQ – Maths Paper Solution Viewer (Stress Test Harness)</title>

    <!-- KaTeX (CDN) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"
        integrity="sha384-Juol1mGtlFQjQ0F7z0yDkQk1qfM9P7FZV2c1fWQ1m6wQ4QmZ3o0WlVQm2kQb7+9a" crossorigin="anonymous">

    <style>
        :root {
            /* Stage 4: Surface system (grayscale, layered; no brand colors) */
            --page-bg: #f4f4f4;
            /* Page background */
            --content-surface: #ffffff;
            /* Content surface */
            --solution-surface: #f1f1f1;
            /* Solution details surface */
            --nav-surface: #fafafa;
            /* Navigation surface */

            --text: #1b1b1b;
            --muted: #5a5a5a;
            --quiet: #767676;

            --hairline: rgba(0, 0, 0, 0.10);
            --hairline2: rgba(0, 0, 0, 0.06);

            --frame-max: 1120px;
            --nav-w: 150px;
            --gap: 28px;

            --r-sm: 10px;
            --r-md: 14px;

            --header-h: 64px;
            /* set precisely by JS after layout */
            --focus: rgba(0, 0, 0, 0.65);
        }

        * {
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
        }

        body {
            margin: 0;
            background: var(--page-bg);
            color: var(--text);
            overflow-x: hidden;
            /* prevent page-level horizontal scrolling */
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
            line-height: 1.45;
        }

        /* Basic focus styling (baseline accessibility) */
        :focus-visible {
            outline: 2px solid var(--focus);
            outline-offset: 2px;
            border-radius: 6px;
        }

        /* Top control area aligned with centered frame */
        header {
            position: sticky;
            top: 0;
            z-index: 20;
            background: var(--page-bg);
            border-bottom: 1px solid var(--hairline2);
        }

        .header-inner {
            max-width: var(--frame-max);
            margin: 0 auto;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .brandless-title {
            font-size: 14px;
            color: var(--quiet);
            letter-spacing: 0.2px;
            white-space: nowrap;
        }

        .controls {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: flex-end;
            min-width: 0;
        }

        label {
            font-size: 13px;
            color: var(--muted);
        }

        select {
            appearance: none;
            border: 1px solid var(--hairline);
            background: #fff;
            padding: 9px 12px;
            border-radius: 10px;
            font-size: 14px;
            color: var(--text);
            min-width: 240px;
        }

        .jump-btn {
            border: 1px solid var(--hairline);
            background: #fff;
            padding: 9px 12px;
            border-radius: 10px;
            font-size: 14px;
            color: var(--text);
            cursor: pointer;
        }

        .jump-btn:active {
            transform: translateY(1px);
        }

        /* Centered content frame on desktop */
        .frame {
            max-width: var(--frame-max);
            margin: 0 auto;
            padding: 0 16px 48px 16px;
        }

        .cols {
            display: grid;
            grid-template-columns: var(--nav-w) 1fr;
            gap: var(--gap);
            align-items: start;
            padding-top: 18px;
        }

        /* Navigation rail: quiet, secondary, documentation-like */
        nav[aria-label="Paper navigation"] {
            background: var(--nav-surface);
            border-radius: var(--r-md);
            border: 1px solid var(--hairline2);
            padding: 10px 8px;
            position: sticky;
            top: calc(var(--header-h) + 14px);
            max-height: calc(100vh - var(--header-h) - 28px);
            overflow-y: auto;
            overscroll-behavior: contain;

            /* Hide scrollbar visually, keep scrolling functional */
            scrollbar-width: none;
            /* Firefox */
            -ms-overflow-style: none;
            /* legacy */
        }

        nav[aria-label="Paper navigation"]::-webkit-scrollbar {
            display: none;
        }

        /* WebKit/Blink */

        .nav-section-label {
            font-size: 12px;
            color: var(--quiet);
            padding: 10px 8px 6px 8px;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            user-select: none;
        }

        .nav-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .nav-item {
            margin: 0;
            padding: 0;
        }

        .nav-link {
            width: 100%;
            text-align: left;
            border: 0;
            background: transparent;
            color: var(--quiet);
            font-size: 13px;
            padding: 7px 8px;
            border-radius: 10px;
            cursor: pointer;
        }

        .nav-link:hover {
            background: rgba(0, 0, 0, 0.04);
            color: var(--text);
        }

        .nav-link[aria-current="true"] {
            background: rgba(0, 0, 0, 0.06);
            color: var(--text);
            font-weight: 700;
            /* bold allowed only for current nav item */
        }

        /* Paper content surface */
        main {
            background: var(--content-surface);
            border-radius: var(--r-md);
            border: 1px solid var(--hairline2);
            padding: 22px 22px 10px 22px;
            min-width: 0;
        }

        /* Question hierarchy: spacing/rhythm > containers */
        .question {
            padding: 0;
            margin: 0 0 30px 0;
            /* largest separation between top-level questions */
        }

        .q-row {
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .qid {
            font-size: 14px;
            /* secondary */
            color: var(--quiet);
            flex: 0 0 auto;
            min-width: 46px;
            padding-top: 2px;
        }

        .q-body {
            min-width: 0;
            flex: 1 1 auto;
        }

        .q-text {
            font-size: 16px;
            /* primary */
            color: var(--text);
            line-height: 1.55;
            /* generous for importance */
            margin: 0;
        }

        .answer {
            margin-top: 10px;
            /* tighter than between questions */
            display: flex;
            gap: 10px;
            align-items: baseline;
            flex-wrap: wrap;
        }

        .answer .label {
            font-size: 12px;
            color: var(--muted);
            font-weight: 700;
            /* labels allowed */
            letter-spacing: 0.02em;
        }

        .answer .value {
            font-size: 15px;
            color: var(--text);
        }

        /* Disclosure control: text-first */
        .disclosure {
            margin-top: 12px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .toggle {
            align-self: flex-start;
            border: 1px solid var(--hairline);
            background: #fff;
            padding: 8px 10px;
            border-radius: 10px;
            font-size: 14px;
            cursor: pointer;
            color: var(--text);
            display: inline-flex;
            gap: 8px;
            align-items: center;
        }

        .toggle .chev {
            font-size: 12px;
            color: var(--quiet);
        }

        .toggle:active {
            transform: translateY(1px);
        }

        .preview {
            font-size: 13px;
            color: var(--quiet);
            max-width: 72ch;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Solution details surface: subordinate */
        .details {
            margin-top: 10px;
            background: var(--solution-surface);
            border-radius: var(--r-md);
            padding: 14px 14px 12px 14px;
            border: 1px solid var(--hairline2);
        }

        .details h4 {
            margin: 0 0 6px 0;
            font-size: 12px;
            color: var(--muted);
            letter-spacing: 0.02em;
            font-weight: 700;
            /* label */
        }

        .details .block {
            margin: 0 0 12px 0;
        }

        .details .block:last-child {
            margin-bottom: 0;
        }

        .details p {
            margin: 0 0 8px 0;
            font-size: 14px;
            /* subordinate body */
            color: var(--text);
            line-height: 1.42;
            /* slightly tighter density */
        }

        .details p:last-child {
            margin-bottom: 0;
        }

        /* KaTeX containers */
        .math-inline {
            display: inline;
            white-space: nowrap;
        }

        .math-block {
            margin: 10px 0;
            padding: 8px 10px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.65);
            overflow-x: auto;
            /* allowed only for block math */
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
            max-width: 100%;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .math-block::-webkit-scrollbar {
            display: none;
        }

        /* Ensure KaTeX doesn't cause page-level overflow */
        .math-block .katex {
            max-width: 100%;
        }

        /* Diagrams are inline SVG placeholders, inside question block */
        .diagram {
            margin-top: 10px;
            max-width: 520px;
        }

        .diagram svg {
            width: 100%;
            height: auto;
            display: block;
            border: 1px solid var(--hairline2);
            border-radius: 12px;
            background: #fff;
        }

        /* Nesting via indentation only (no borders/containers) */
        .depth-1 {
            margin-left: 18px;
        }

        .depth-2 {
            margin-left: 34px;
        }

        .depth-3 {
            margin-left: 48px;
        }

        /* Separation strength decreases with nesting depth */
        .question.depth-1 {
            margin-bottom: 22px;
        }

        .question.depth-2 {
            margin-bottom: 18px;
        }

        .question.depth-3 {
            margin-bottom: 14px;
        }

        /* Mobile / tablet */
        @media (max-width: 900px) {
            :root {
                --nav-w: 0px;
                --gap: 0px;
            }

            .cols {
                grid-template-columns: 1fr;
                gap: 0;
            }

            nav[aria-label="Paper navigation"] {
                display: none;
                /* use drawer */
            }

            main {
                padding: 18px 16px 10px 16px;
            }

            select {
                min-width: 220px;
            }
        }

        @media (max-width: 460px) {
            .brandless-title {
                display: none;
            }

            select {
                min-width: 200px;
            }

            .qid {
                min-width: 38px;
            }

            .q-text {
                font-size: 15px;
            }

            .depth-1 {
                margin-left: 12px;
            }

            .depth-2 {
                margin-left: 22px;
            }

            .depth-3 {
                margin-left: 30px;
            }
        }

        /* Drawer (mobile navigation) */
        .drawer-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.22);
            display: none;
            align-items: stretch;
            justify-content: flex-end;
            z-index: 60;
        }

        .drawer-backdrop[aria-hidden="false"] {
            display: flex;
        }

        .drawer {
            width: min(86vw, 360px);
            background: var(--nav-surface);
            border-left: 1px solid var(--hairline2);
            padding: 12px 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .drawer-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            padding: 4px 6px;
        }

        .drawer-title {
            font-size: 14px;
            color: var(--muted);
            font-weight: 700;
            letter-spacing: 0.02em;
        }

        .drawer-close {
            border: 1px solid var(--hairline);
            background: #fff;
            padding: 7px 10px;
            border-radius: 10px;
            font-size: 14px;
            cursor: pointer;
        }

        .drawer-nav {
            border: 1px solid var(--hairline2);
            border-radius: var(--r-md);
            background: #fff;
            padding: 8px 6px;
            overflow-y: auto;
            max-height: calc(100vh - 120px);
            overscroll-behavior: contain;

            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .drawer-nav::-webkit-scrollbar {
            display: none;
        }

        /* Utility: visually-hidden (for accessible labels) */
        .sr-only {
            position: absolute !important;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
    </style>
</head>

<body>
    <header>
        <div class="header-inner" id="headerInner">
            <div class="brandless-title">Maths paper • solutions view</div>

            <div class="controls">
                <label for="paperSelect">Paper</label>
                <select id="paperSelect" aria-label="Paper selector"></select>

                <!-- Always accessible on small screens; hidden on desktop via JS -->
                <button class="jump-btn" id="jumpBtn" type="button">Jump to</button>
            </div>
        </div>
    </header>

    <div class="frame" id="appShell">
        <div class="cols">
            <nav aria-label="Paper navigation" id="navRail"></nav>
            <main id="paperMain" tabindex="-1">
                <!-- Paper content injected here -->
            </main>
        </div>
    </div>

    <!-- Mobile drawer (overlay) -->
    <div class="drawer-backdrop" id="drawerBackdrop" aria-hidden="true">
        <div class="drawer" role="dialog" aria-modal="true" aria-label="Navigation drawer" id="drawer">
            <div class="drawer-head">
                <div class="drawer-title">Jump to</div>
                <button class="drawer-close" id="drawerClose" type="button">Close</button>
            </div>
            <div class="drawer-nav" id="drawerNav" tabindex="0"></div>
        </div>
    </div>

    <!-- KaTeX scripts (loaded before main script; if they fail, we fall back to text) -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"
        integrity="sha384-wp3w4E6q3s8u8kzqJYj7bqg4tqQkzv0tXo6oQy7t3m9cH0zX6H+Yp+Gq0p0h4rX5"
        crossorigin="anonymous"></script>

    <script>
        (function () {
            "use strict";

            /* ---------------------------
               Dataset definitions
               --------------------------- */

            function repeatLongWorkingLines(count) {
                const lines = [];
                for (let i = 1; i <= count; i++) {
                    // Varied, math-ish lines (block LaTeX)
                    const n = i;
                    if (n % 6 === 0) {
                        lines.push(String.raw`\text{Check: } 3(2x-5)=6x-15 \Rightarrow \text{ok}`);
                    } else if (n % 6 === 1) {
                        lines.push(String.raw`2x + 7 = 31 \Rightarrow 2x = 24 \Rightarrow x = 12`);
                    } else if (n % 6 === 2) {
                        lines.push(String.raw`\frac{a}{b}=\frac{3}{5}\ \Rightarrow\ 5a=3b`);
                    } else if (n % 6 === 3) {
                        lines.push(String.raw`(x+4)^2 = x^2 + 8x + 16`);
                    } else if (n % 6 === 4) {
                        lines.push(String.raw`y = mx + c,\ \ m=\frac{y_2-y_1}{x_2-x_1}`);
                    } else {
                        lines.push(String.raw`\sqrt{144}=12,\ \ \sqrt{169}=13`);
                    }
                }
                return lines;
            }

            function diagSVG(type) {
                // Inline SVG placeholders (4 reused types)
                if (type === "geometry") {
                    return `
            <svg viewBox="0 0 420 240" role="img" aria-label="Geometry diagram">
              <rect x="10" y="10" width="400" height="220" fill="none" stroke="rgba(0,0,0,0.20)"/>
              <polygon points="90,180 210,60 330,180" fill="none" stroke="rgba(0,0,0,0.70)" stroke-width="2"/>
              <circle cx="210" cy="120" r="62" fill="none" stroke="rgba(0,0,0,0.45)" stroke-width="2"/>
              <text x="205" y="52" font-size="14" fill="rgba(0,0,0,0.70)">A</text>
              <text x="78" y="195" font-size="14" fill="rgba(0,0,0,0.70)">B</text>
              <text x="336" y="195" font-size="14" fill="rgba(0,0,0,0.70)">C</text>
              <text x="252" y="120" font-size="13" fill="rgba(0,0,0,0.60)">r</text>
              <line x1="210" y1="120" x2="272" y2="120" stroke="rgba(0,0,0,0.40)" stroke-dasharray="4,4"/>
            </svg>
          `;
                }
                if (type === "bars") {
                    return `
            <svg viewBox="0 0 420 240" role="img" aria-label="Ratio bar diagram">
              <rect x="10" y="10" width="400" height="220" fill="none" stroke="rgba(0,0,0,0.20)"/>
              <text x="22" y="44" font-size="14" fill="rgba(0,0,0,0.70)">A</text>
              <rect x="55" y="28" width="310" height="30" fill="none" stroke="rgba(0,0,0,0.70)"/>
              <line x1="155" y1="28" x2="155" y2="58" stroke="rgba(0,0,0,0.50)"/>
              <line x1="255" y1="28" x2="255" y2="58" stroke="rgba(0,0,0,0.50)"/>
              <text x="22" y="104" font-size="14" fill="rgba(0,0,0,0.70)">B</text>
              <rect x="55" y="88" width="240" height="30" fill="none" stroke="rgba(0,0,0,0.70)"/>
              <line x1="175" y1="88" x2="175" y2="118" stroke="rgba(0,0,0,0.50)"/>
              <text x="55" y="170" font-size="13" fill="rgba(0,0,0,0.55)">Each segment is 1 unit</text>
            </svg>
          `;
                }
                if (type === "grid") {
                    return `
            <svg viewBox="0 0 420 240" role="img" aria-label="Coordinate grid diagram">
              <rect x="10" y="10" width="400" height="220" fill="none" stroke="rgba(0,0,0,0.20)"/>
              <g stroke="rgba(0,0,0,0.12)">
                ${Array.from({ length: 17 }).map((_, i) => `<line x1="${40 + i * 20}" y1="30" x2="${40 + i * 20}" y2="210"/>`).join("")}
                ${Array.from({ length: 10 }).map((_, i) => `<line x1="40" y1="${30 + i * 20}" x2="380" y2="${30 + i * 20}"/>`).join("")}
              </g>
              <g stroke="rgba(0,0,0,0.55)" stroke-width="2">
                <line x1="40" y1="210" x2="380" y2="210"/>
                <line x1="40" y1="210" x2="40" y2="30"/>
              </g>
              <circle cx="140" cy="150" r="4" fill="rgba(0,0,0,0.75)"/>
              <circle cx="260" cy="110" r="4" fill="rgba(0,0,0,0.75)"/>
              <line x1="140" y1="150" x2="260" y2="110" stroke="rgba(0,0,0,0.65)" stroke-width="2"/>
              <text x="128" y="168" font-size="12" fill="rgba(0,0,0,0.65)">(2,3)</text>
              <text x="248" y="98" font-size="12" fill="rgba(0,0,0,0.65)">(5,5)</text>
            </svg>
          `;
                }
                // table-like grid / array
                return `
          <svg viewBox="0 0 420 240" role="img" aria-label="Table diagram">
            <rect x="10" y="10" width="400" height="220" fill="none" stroke="rgba(0,0,0,0.20)"/>
            <rect x="70" y="50" width="280" height="140" fill="none" stroke="rgba(0,0,0,0.70)" stroke-width="2"/>
            <g stroke="rgba(0,0,0,0.45)">
              <line x1="70" y1="96" x2="350" y2="96"/>
              <line x1="70" y1="142" x2="350" y2="142"/>
              <line x1="163" y1="50" x2="163" y2="190"/>
              <line x1="256" y1="50" x2="256" y2="190"/>
            </g>
            <text x="84" y="78" font-size="13" fill="rgba(0,0,0,0.65)">2</text>
            <text x="177" y="78" font-size="13" fill="rgba(0,0,0,0.65)">4</text>
            <text x="270" y="78" font-size="13" fill="rgba(0,0,0,0.65)">6</text>
            <text x="84" y="124" font-size="13" fill="rgba(0,0,0,0.65)">3</text>
            <text x="177" y="124" font-size="13" fill="rgba(0,0,0,0.65)">6</text>
            <text x="270" y="124" font-size="13" fill="rgba(0,0,0,0.65)">9</text>
            <text x="84" y="170" font-size="13" fill="rgba(0,0,0,0.65)">5</text>
            <text x="177" y="170" font-size="13" fill="rgba(0,0,0,0.65)">10</text>
            <text x="270" y="170" font-size="13" fill="rgba(0,0,0,0.65)">15</text>
          </svg>
        `;
            }

            function question(id, depth, promptParts, answerParts, details) {
                return { id, depth, promptParts, answerParts, details };
            }

            function detailsBlock(opts) {
                // opts: { keepInMind: [parts], formulas: [parts], working: [latex], alt: [latex[]...] }
                return {
                    keepInMind: opts.keepInMind || null,
                    formulas: opts.formulas || null,
                    working: opts.working || [],
                    alternative: opts.alternative || [] // array of arrays
                };
            }

            // Text parts format:
            // {t:"plain text"} or {i:"latex inline"} or {b:"latex block"} or {br:true}
            function t(s) { return { t: s }; }
            function i(latex) { return { i: latex }; }
            function b(latex) { return { b: latex }; }
            function br() { return { br: true }; }

            function makeShortPaper() {
                const qs = [
                    question("1", 0,
                        [t("Calculate "), i("17+8"), t(".")],
                        [i("25")],
                        detailsBlock({
                            working: [
                                String.raw`17+8 = (17+3)+5 = 20+5 = 25`
                            ]
                        })
                    ),
                    question("2", 0,
                        [t("A bag has 24 sweets. You share them equally between 6 children. How many sweets does each child get?")],
                        [i("4")],
                        detailsBlock({
                            keepInMind: [[t("“Equally” means the same amount each.")]],
                            working: [String.raw`\frac{24}{6}=4`]
                        })
                    ),
                    question("3", 0,
                        [t("Round "), i("3.468"), t(" to 2 decimal places.")],
                        [i("3.47")],
                        detailsBlock({
                            working: [
                                String.raw`3.468 \to 3.47 \text{ (third decimal is } 8 \text{ so round up)}`
                            ],
                            alternative: [
                                [String.raw`\text{Keep } 3.46 \text{ then add } 0.01 = 3.47`]
                            ]
                        })
                    ),
                    // Multi-part question
                    question("4", 0,
                        [t("A rectangle has length "), i("12\\text{ cm}"), t(" and width "), i("5\\text{ cm}"), t(".")],
                        [t("See parts (a) and (b).")],
                        detailsBlock({
                            keepInMind: [[t("Area uses "), i("A=lw"), t(". Perimeter uses "), i("P=2(l+w)"), t(".")]],
                            formulas: [[i("A=lw"), t(", "), i("P=2(l+w)")]],
                            working: [String.raw`\text{Use the given length and width for each part.}`]
                        })
                    ),
                    question("4(a)", 1,
                        [t("Find the area of the rectangle.")],
                        [i("60\\text{ cm}^2")],
                        detailsBlock({
                            working: [String.raw`A = 12\times 5 = 60`]
                        })
                    ),
                    question("4(b)", 1,
                        [t("Find the perimeter of the rectangle.")],
                        [i("34\\text{ cm}")],
                        detailsBlock({
                            working: [String.raw`P = 2(12+5)=2\times 17=34`]
                        })
                    )
                ];
                return { kind: "plain", label: "Short paper", sections: null, questions: qs, expandedByDefault: false };
            }

            function makeStandardQuestions() {
                const qs = [];

                // Q1–Q10 (small/medium)
                for (let n = 1; n <= 10; n++) {
                    qs.push(question(String(n), 0,
                        [t("Calculate "), i(`${n * 3}+${n + 7}`), t(".")],
                        [i(String(n * 3 + n + 7))],
                        detailsBlock({
                            working: [String.raw`${n * 3}+${n + 7}=${n * 3 + n + 7}`]
                        })
                    ));
                }

                // Q11–Q17 (mix)
                qs.push(question("11", 0,
                    [t("A train leaves at 09:25 and arrives at 11:05. How long is the journey?")],
                    [t("1 hour 40 minutes")],
                    detailsBlock({
                        working: [String.raw`11{:}05 - 09{:}25 = 1\text{h }40\text{m}`]
                    })
                ));

                qs.push(question("12", 0,
                    [t("Simplify "), i("4x+3x-2"), t(".")],
                    [i("7x-2")],
                    detailsBlock({
                        keepInMind: [[t("Only like terms can be combined.")]],
                        working: [String.raw`4x+3x=7x \Rightarrow 7x-2`]
                    })
                ));

                qs.push(question("13", 0,
                    [t("A recipe uses flour and sugar in the ratio "), i("3:2"), t(". If flour is 450g, how much sugar is needed?")],
                    [i("300\\text{ g}")],
                    detailsBlock({
                        formulas: [[t("Ratio scale factor:"), t(" total parts = "), i("3+2")]],
                        working: [
                            String.raw`\text{If }3\text{ parts}=450,\ \ 1\text{ part}=150`,
                            String.raw`\text{Sugar is }2\text{ parts}=2\times 150=300`
                        ],
                        alternative: [
                            [String.raw`\frac{\text{sugar}}{\text{flour}}=\frac{2}{3} \Rightarrow \text{sugar}=\frac{2}{3}\cdot 450=300`]
                        ]
                    })
                ));

                qs.push(question("14", 0,
                    [t("Solve "), i("5y-9=26"), t(".")],
                    [i("y=7")],
                    detailsBlock({
                        working: [
                            String.raw`5y=35 \Rightarrow y=7`
                        ]
                    })
                ));

                qs.push(question("15", 0,
                    [t("Write "), i("0.375"), t(" as a fraction in simplest form.")],
                    [i("\\frac{3}{8}")],
                    detailsBlock({
                        working: [
                            String.raw`0.375=\frac{375}{1000}=\frac{3}{8}`
                        ],
                        alternative: [
                            [String.raw`0.375=\frac{375\div 125}{1000\div 125}=\frac{3}{8}`]
                        ]
                    })
                ));

                qs.push(question("16", 0,
                    [t("A square has perimeter "), i("48\\text{ cm}"), t(". Find the side length.")],
                    [i("12\\text{ cm}")],
                    detailsBlock({
                        keepInMind: [[t("A square has 4 equal sides.")]],
                        working: [String.raw`\text{Side}=\frac{48}{4}=12`]
                    })
                ));

                // Deep nesting question 18 with (a)(i)(ii)(b)
                qs.push(question("18", 0,
                    [t("A straight line passes through two points "), i("(2,3)"), t(" and "), i("(5,5)"), t(".")],
                    [t("See parts (a) and (b).")],
                    detailsBlock({
                        keepInMind: [[t("Slope uses the change in "), i("y"), t(" over the change in "), i("x"), t(".")]],
                        formulas: [[i("m=\\frac{y_2-y_1}{x_2-x_1}")]],
                        working: [String.raw`\text{Use the two points to find slope and equation.}`]
                    })
                ));

                qs.push(question("18(a)", 1,
                    [t("Find the slope of the line.")],
                    [i("m=\\frac{2}{3}")],
                    detailsBlock({
                        working: [String.raw`m=\frac{5-3}{5-2}=\frac{2}{3}`]
                    })
                ));

                qs.push(question("18(a)(i)", 2,
                    [t("Use "), i("y=mx+c"), t(" to find "), i("c"), t(".")],
                    [i("c=\\frac{5}{3}")],
                    detailsBlock({
                        working: [
                            String.raw`3 = \frac{2}{3}\cdot 2 + c \Rightarrow 3 = \frac{4}{3}+c \Rightarrow c=\frac{5}{3}`
                        ]
                    })
                ));

                qs.push(question("18(a)(ii)", 2,
                    [t("Write the equation of the line.")],
                    [i("y=\\frac{2}{3}x+\\frac{5}{3}")],
                    detailsBlock({
                        working: [String.raw`y=\frac{2}{3}x+\frac{5}{3}`]
                    })
                ));

                qs.push(question("18(b)", 1,
                    [t("Find "), i("y"), t(" when "), i("x=11"), t(".")],
                    [i("y=9")],
                    detailsBlock({
                        working: [
                            String.raw`y=\frac{2}{3}\cdot 11+\frac{5}{3}=\frac{22}{3}+\frac{5}{3}=\frac{27}{3}=9`
                        ],
                        alternative: [
                            [String.raw`\text{Multiply by }3:\ 3y=2x+5.\ x=11 \Rightarrow 3y=27 \Rightarrow y=9`]
                        ]
                    })
                ));

                // Q19–Q25 (mix)
                qs.push(question("19", 0,
                    [t("A box contains red and blue counters. Red:Blue = "), i("4:7"), t(". There are 28 red counters. How many blue counters?")],
                    [i("49")],
                    detailsBlock({
                        working: [
                            String.raw`4\text{ parts}=28 \Rightarrow 1\text{ part}=7`,
                            String.raw`7\text{ parts}=7\times 7=49`
                        ]
                    })
                ));

                qs.push(question("20", 0,
                    [t("Find the mean of "), i("6, 9, 11, 14"), t(".")],
                    [i("10")],
                    detailsBlock({
                        working: [String.raw`\frac{6+9+11+14}{4}=\frac{40}{4}=10`]
                    })
                ));

                qs.push(question("21", 0,
                    [t("Simplify "), i("\\frac{12}{18}"), t(".")],
                    [i("\\frac{2}{3}")],
                    detailsBlock({
                        keepInMind: [[t("Divide top and bottom by the same number.")]],
                        working: [String.raw`\frac{12}{18}=\frac{12\div 6}{18\div 6}=\frac{2}{3}`]
                    })
                ));

                qs.push(question("22", 0,
                    [t("A number is increased by "), i("15\\%"), t(" to get 92. What was the original number?")],
                    [i("80")],
                    detailsBlock({
                        formulas: [[t("New = Original × "), i("1.15")]],
                        working: [
                            String.raw`\text{Original}=\frac{92}{1.15}=80`
                        ],
                        alternative: [
                            [String.raw`\text{15% of original} = 92- \text{original} \Rightarrow 0.15x = 12 \Rightarrow x=80`]
                        ]
                    })
                ));

                qs.push(question("23", 0,
                    [t("Convert "), i("3.2\\text{ km}"), t(" to metres.")],
                    [i("3200\\text{ m}")],
                    detailsBlock({
                        working: [String.raw`3.2\times 1000=3200`]
                    })
                ));

                qs.push(question("24", 0,
                    [t("A triangle has base "), i("10\\text{ cm}"), t(" and height "), i("7\\text{ cm}"), t(". Find its area.")],
                    [i("35\\text{ cm}^2")],
                    detailsBlock({
                        formulas: [[i("A=\\frac{1}{2}bh")]],
                        working: [String.raw`A=\frac{1}{2}\cdot 10 \cdot 7=35`]
                    })
                ));

                qs.push(question("25", 0,
                    [t("Solve "), i("x^2=81"), t(". Give all solutions.")],
                    [i("x=9\\text{ or }x=-9")],
                    detailsBlock({
                        keepInMind: [[t("A square can be positive even if the number is negative.")]],
                        working: [String.raw`x=\pm\sqrt{81}=\pm 9`]
                    })
                ));

                // Q26–Q35: long algebra; multiple block math; selected extremely long workings
                for (let n = 26; n <= 35; n++) {
                    const isVeryLong = (n === 30 || n === 33 || n === 35);
                    const baseWorking = [
                        String.raw`\text{Start with: } 3(2x-5) = 4x + 9`,
                        String.raw`6x-15 = 4x + 9`,
                        String.raw`2x = 24`,
                        String.raw`x = 12`
                    ];

                    const extraBlocks = [
                        String.raw`\text{Expand and collect like terms carefully.}`,
                        String.raw`3(2x-5) = 6x-15`,
                        String.raw`6x-15-4x = 9`,
                        String.raw`2x-15 = 9`,
                        String.raw`2x = 24`
                    ];

                    const workingLines = isVeryLong
                        ? baseWorking.concat(extraBlocks).concat(repeatLongWorkingLines(54)) // 50–60+ lines stress
                        : baseWorking.concat(extraBlocks);

                    const alt = (n % 2 === 0)
                        ? [[
                            String.raw`\text{Alternative: move all terms to one side}`,
                            String.raw`3(2x-5) - (4x+9)=0`,
                            String.raw`6x-15-4x-9=0`,
                            String.raw`2x-24=0 \Rightarrow x=12`
                        ]]
                        : [];

                    const keep = (n === 26 || n === 29 || n === 34)
                        ? [[t("Watch out for distributing the 3 correctly across the bracket.")]]
                        : null;

                    const formulas = (n === 28 || n === 31 || n === 35)
                        ? [[t("Use the distributive law: "), i("a(b+c)=ab+ac")]]
                        : null;

                    qs.push(question(String(n), 0,
                        [t("Solve the equation and show your working: "), i("3(2x-5)=4x+9"), t(".")],
                        [i("x=12")],
                        detailsBlock({
                            keepInMind: keep,
                            formulas: formulas,
                            working: workingLines,
                            alternative: alt
                        })
                    ));
                }

                return qs;
            }

            function makeStandardPaper(expanded) {
                return {
                    kind: "plain",
                    label: expanded ? "Standard (Workings Expanded)" : "Standard paper",
                    sections: null,
                    questions: makeStandardQuestions(),
                    expandedByDefault: !!expanded
                };
            }

            function makeDiagramHeavyPaper() {
                const qs = [];
                // 20 total; 8 with diagrams
                const diagramQs = new Set(["2", "4", "6", "8", "11", "13", "16", "19"]);
                const types = ["geometry", "bars", "grid", "table"];
                for (let n = 1; n <= 20; n++) {
                    const hasDiag = diagramQs.has(String(n));
                    const diagType = types[n % types.length];

                    const prompt = hasDiag
                        ? [t("Use the diagram to answer the question. "), t("Find the value shown.")]
                        : [t("Calculate "), i(`${n + 12}\\times 3`), t(".")];

                    const ans = hasDiag
                        ? [i(String((n * 7) % 13 + 4))]
                        : [i(String((n + 12) * 3))];

                    const keep = (n === 3 || n === 12 || n === 18)
                        ? [[t("Write units clearly if the question uses them.")]]
                        : null;

                    const formulas = (n === 4 || n === 11 || n === 16)
                        ? [[t("Helpful formula: "), i("A=\\frac{1}{2}bh"), t(" (if a triangle is involved).")]]
                        : null;

                    const alt = (n === 6 || n === 13 || n === 19)
                        ? [[String.raw`\text{Alternative working shown as a second method.}`, String.raw`(n)\Rightarrow \text{same answer}`]]
                        : [];

                    const working = hasDiag
                        ? [
                            String.raw`\text{Read labels from the diagram carefully.}`,
                            String.raw`\text{Set up the relationship, then calculate.}`,
                            String.raw`\text{Final check: does the answer fit the diagram?}`
                        ]
                        : [String.raw`${n + 12}\times 3 = ${(n + 12) * 3}`];

                    qs.push(question(String(n), 0,
                        prompt,
                        ans,
                        detailsBlock({ keepInMind: keep, formulas: formulas, working, alternative: alt })
                    ));

                    if (hasDiag) {
                        // attach diagram marker via promptParts special token
                        qs[qs.length - 1].diagram = diagType;
                    }
                }
                return { kind: "plain", label: "Diagram-heavy paper", sections: null, questions: qs, expandedByDefault: false };
            }

            function makeSectionedPaper() {
                // A: 35 small/medium, B: 8 medium, C: 6 very long (collapsed by default)
                const sections = [
                    { label: "A", questions: [] },
                    { label: "B", questions: [] },
                    { label: "C", questions: [] }
                ];

                // Section A (1–35)
                for (let n = 1; n <= 35; n++) {
                    const keep = (n === 5 || n === 17 || n === 28) ? [[t("Be careful with place value and signs.")]] : null;
                    const formulas = (n === 9 || n === 21 || n === 33) ? [[t("Useful: "), i("p\\%=\\frac{p}{100}")]] : null;
                    const alt = (n === 12 || n === 24 || n === 30) ? [[String.raw`\text{Alternative: estimate first, then compute exactly.}`]] : [];
                    const working = [
                        String.raw`\text{Work step-by-step.}`,
                        String.raw`${n}+${n * 2}=${n + n * 2}`
                    ];
                    sections[0].questions.push(question(String(n), 0,
                        [t("Calculate "), i(`${n}+${n * 2}`), t(".")],
                        [i(String(n + n * 2))],
                        detailsBlock({ keepInMind: keep, formulas: formulas, working, alternative: alt })
                    ));
                }

                // Section B (36–43)
                for (let n = 36; n <= 43; n++) {
                    const id = String(n);
                    sections[1].questions.push(question(id, 0,
                        [t("Solve for "), i("x"), t(": "), i("2x+5=39"), t(".")],
                        [i("x=17")],
                        detailsBlock({
                            keepInMind: [[t("Undo operations in reverse order.")]],
                            formulas: [[t("If "), i("ax+b=c"), t(", then "), i("x=\\frac{c-b}{a}")]],
                            working: [
                                String.raw`2x=34 \Rightarrow x=17`,
                                String.raw`\text{Check: }2\cdot 17+5=39`
                            ],
                            alternative: [
                                [String.raw`2x+5=39 \Rightarrow 2x=39-5 \Rightarrow x=\frac{34}{2}=17`]
                            ]
                        })
                    ));
                }

                // Section C (44–49): very long details (collapsed by default)
                for (let n = 44; n <= 49; n++) {
                    const id = String(n);
                    const working = [
                        String.raw`\text{Start: } (x+4)^2 = 3x + 40`,
                        String.raw`x^2+8x+16 = 3x+40`,
                        String.raw`x^2+5x-24 = 0`,
                        String.raw`(x+8)(x-3)=0`,
                        String.raw`x=-8 \text{ or } x=3`
                    ].concat(repeatLongWorkingLines(56));

                    sections[2].questions.push(question(id, 0,
                        [t("Solve the equation and give all solutions: "), i("(x+4)^2 = 3x+40"), t(".")],
                        [i("x=3\\text{ or }x=-8")],
                        detailsBlock({
                            keepInMind: [[t("When solving quadratics, check both solutions in the original equation.")]],
                            formulas: [[t("Expand: "), i("(x+a)^2=x^2+2ax+a^2")]],
                            working,
                            alternative: [[
                                String.raw`\text{Alternative: use the quadratic formula.}`,
                                String.raw`x=\frac{-5\pm \sqrt{25+96}}{2}=\frac{-5\pm 11}{2}\Rightarrow x=3\text{ or }-8`
                            ]]
                        })
                    ));
                }

                return { kind: "sectioned", label: "Sectioned paper", sections, questions: null, expandedByDefault: false };
            }

            const DATASETS = [
                { key: "short", build: makeShortPaper },
                { key: "standard", build: function () { return makeStandardPaper(false); } },
                { key: "standard_expanded", build: function () { return makeStandardPaper(true); } },
                { key: "diagram", build: makeDiagramHeavyPaper },
                { key: "sectioned", build: makeSectionedPaper }
            ];

            /* ---------------------------
               Rendering helpers
               --------------------------- */

            const el = (tag, attrs, ...children) => {
                const node = document.createElement(tag);
                if (attrs) {
                    for (const [k, v] of Object.entries(attrs)) {
                        if (k === "class") node.className = v;
                        else if (k === "html") node.innerHTML = v;
                        else if (k.startsWith("aria-")) node.setAttribute(k, v);
                        else if (k === "role") node.setAttribute("role", v);
                        else if (k === "dataset") Object.assign(node.dataset, v);
                        else if (k in node) node[k] = v;
                        else node.setAttribute(k, v);
                    }
                }
                for (const ch of children) {
                    if (ch === null || ch === undefined) continue;
                    if (Array.isArray(ch)) ch.forEach(c => append(node, c));
                    else append(node, ch);
                }
                return node;
            };

            function append(parent, child) {
                if (typeof child === "string") parent.appendChild(document.createTextNode(child));
                else parent.appendChild(child);
            }

            function katexAvailable() {
                return !!(window.katex && typeof window.katex.renderToString === "function");
            }

            function renderInlineLatex(latex) {
                const span = el("span", { class: "math-inline" });
                if (katexAvailable()) {
                    try {
                        span.innerHTML = window.katex.renderToString(latex, { throwOnError: false, displayMode: false });
                    } catch (_e) {
                        span.textContent = latex;
                    }
                } else {
                    span.textContent = latex;
                }
                return span;
            }

            function renderBlockLatex(latex) {
                const box = el("div", { class: "math-block" });
                if (katexAvailable()) {
                    try {
                        box.innerHTML = window.katex.renderToString(latex, { throwOnError: false, displayMode: true });
                    } catch (_e) {
                        box.textContent = latex;
                    }
                } else {
                    box.textContent = latex;
                }
                return box;
            }

            function renderParts(parts) {
                // parts are text + inline math + block math + line breaks
                const frag = document.createDocumentFragment();
                for (const p of parts) {
                    if (p.t !== undefined) {
                        frag.appendChild(document.createTextNode(p.t));
                    } else if (p.i !== undefined) {
                        frag.appendChild(renderInlineLatex(p.i));
                    } else if (p.b !== undefined) {
                        frag.appendChild(renderBlockLatex(p.b));
                    } else if (p.br) {
                        frag.appendChild(el("br"));
                    }
                }
                return frag;
            }

            function renderMiniPreview(details) {
                // At most 1–2 lines preview; use first working line (as text) if present
                const first = (details && details.working && details.working.length) ? details.working[0] : null;
                if (!first) return "";
                // If it's LaTeX, keep it short as plain text preview
                return first.length > 90 ? (first.slice(0, 90) + "…") : first;
            }

            /* ---------------------------
               App state and build
               --------------------------- */

            const paperSelect = document.getElementById("paperSelect");
            const navRail = document.getElementById("navRail");
            const paperMain = document.getElementById("paperMain");
            const jumpBtn = document.getElementById("jumpBtn");

            const drawerBackdrop = document.getElementById("drawerBackdrop");
            const drawer = document.getElementById("drawer");
            const drawerNav = document.getElementById("drawerNav");
            const drawerClose = document.getElementById("drawerClose");
            const appShell = document.getElementById("appShell");
            const headerInner = document.getElementById("headerInner");

            let currentDataset = null;
            let io = null;

            function setHeaderHeightVar() {
                const h = headerInner.getBoundingClientRect().height + headerInner.parentElement.getBoundingClientRect().top;
                // Use actual header element height (safe)
                const headerH = document.querySelector("header").getBoundingClientRect().height;
                document.documentElement.style.setProperty("--header-h", Math.round(headerH) + "px");
            }

            function isMobileNav() {
                return window.matchMedia("(max-width: 900px)").matches;
            }

            function syncJumpBtnVisibility() {
                // Always accessible on mobile/tablet; hidden on desktop
                jumpBtn.style.display = isMobileNav() ? "inline-flex" : "none";
            }

            function flattenSectioned(sections) {
                const all = [];
                for (const s of sections) {
                    for (const q of s.questions) {
                        all.push({ ...q, _section: s.label });
                    }
                }
                return all;
            }

            function buildNavItems(dataset) {
                // Must be question identifiers only; section labels only as separators (non-clickable)
                navRail.innerHTML = "";
                drawerNav.innerHTML = "";

                const makeNav = (container, withSections) => {
                    if (withSections) {
                        for (const s of dataset.sections) {
                            container.appendChild(el("div", { class: "nav-section-label" }, s.label));
                            const ul = el("ul", { class: "nav-list" });
                            for (const q of s.questions) {
                                ul.appendChild(navButton(q.id));
                            }
                            container.appendChild(ul);
                        }
                    } else {
                        const ul = el("ul", { class: "nav-list" });
                        for (const q of dataset.questions) {
                            ul.appendChild(navButton(q.id));
                        }
                        container.appendChild(ul);
                    }
                };

                function navButton(qid) {
                    const li = el("li", { class: "nav-item" });
                    const btn = el("button", {
                        class: "nav-link",
                        type: "button",
                        "data-target": qid
                    }, qid);
                    btn.addEventListener("click", () => {
                        closeDrawer(); // safe if not open
                        jumpTo(qid);
                    });
                    li.appendChild(btn);
                    return li;
                }

                // desktop rail
                makeNav(navRail, dataset.kind === "sectioned");
                // mobile drawer
                makeNav(drawerNav, dataset.kind === "sectioned");
            }

            function buildPaperContent(dataset) {
                paperMain.innerHTML = "";

                const questions = dataset.kind === "sectioned" ? flattenSectioned(dataset.sections) : dataset.questions;

                for (const q of questions) {
                    const qEl = renderQuestion(q, dataset.expandedByDefault);
                    paperMain.appendChild(qEl);
                }

                // Setup observer for current nav item indicator
                if (io) io.disconnect();
                io = new IntersectionObserver((entries) => {
                    // choose the top-most intersecting question
                    const visible = entries
                        .filter(e => e.isIntersecting)
                        .sort((a, b) => a.boundingClientRect.top - b.boundingClientRect.top);
                    if (visible.length) {
                        const id = visible[0].target.getAttribute("data-qid");
                        setCurrentNav(id);
                    }
                }, {
                    root: null,
                    threshold: 0.18
                });

                const qNodes = paperMain.querySelectorAll("[data-qid]");
                qNodes.forEach(n => io.observe(n));
            }

            function renderQuestion(q, expandedByDefault) {
                const depthClass = `depth-${Math.min(Math.max(q.depth || 0, 0), 3)}`;
                const wrapper = el("section", {
                    class: `question ${depthClass}`,
                    dataset: { qid: q.id }
                });
                wrapper.setAttribute("data-qid", q.id);

                const row = el("div", { class: "q-row" });
                const id = el("div", { class: "qid" }, q.id);

                const body = el("div", { class: "q-body" });
                const p = el("p", { class: "q-text" });
                p.appendChild(renderParts(q.promptParts || [t("")]));
                body.appendChild(p);

                if (q.diagram) {
                    body.appendChild(el("div", { class: "diagram", html: diagSVG(q.diagram) }));
                }

                const ans = el("div", { class: "answer" },
                    el("div", { class: "label" }, "Answer"),
                    el("div", { class: "value" })
                );
                ans.querySelector(".value").appendChild(renderParts(q.answerParts || [t("")]));
                body.appendChild(ans);

                // Disclosure + details
                const disclosure = el("div", { class: "disclosure" });

                const detailsId = `details-${cssSafeId(q.id)}`;
                const isExpanded = !!expandedByDefault;

                const toggle = el("button", {
                    class: "toggle",
                    type: "button",
                    "aria-controls": detailsId,
                    "aria-expanded": isExpanded ? "true" : "false"
                });
                const labelSpan = el("span", { class: "label-text" }, isExpanded ? "Hide working" : "Show working");
                const chev = el("span", { class: "chev", "aria-hidden": "true" }, isExpanded ? "▾" : "▸");
                toggle.appendChild(chev);
                toggle.appendChild(labelSpan);

                const preview = el("div", { class: "preview" }, renderMiniPreview(q.details));
                if (isExpanded) preview.style.display = "none";

                const details = renderDetails(q.details || detailsBlock({}), detailsId);
                if (!isExpanded) {
                    details.hidden = true;
                    details.setAttribute("aria-hidden", "true");
                } else {
                    details.hidden = false;
                    details.setAttribute("aria-hidden", "false");
                }

                toggle.addEventListener("click", () => {
                    const expanded = toggle.getAttribute("aria-expanded") === "true";
                    const next = !expanded;
                    toggle.setAttribute("aria-expanded", next ? "true" : "false");
                    labelSpan.textContent = next ? "Hide working" : "Show working";
                    chev.textContent = next ? "▾" : "▸";

                    details.hidden = !next;
                    details.setAttribute("aria-hidden", next ? "false" : "true");
                    preview.style.display = next ? "none" : "block";
                });

                disclosure.appendChild(toggle);
                disclosure.appendChild(preview);
                disclosure.appendChild(details);

                body.appendChild(disclosure);

                row.appendChild(id);
                row.appendChild(body);
                wrapper.appendChild(row);

                return wrapper;
            }

            function renderDetails(details, id) {
                const box = el("div", { class: "details" });
                box.id = id;

                // Order must be: Keep in mind, Formulas used, Working, Alternative working
                if (details.keepInMind) {
                    box.appendChild(renderTextBlock("Keep in mind", details.keepInMind));
                }
                if (details.formulas) {
                    box.appendChild(renderTextBlock("Formulas used", details.formulas));
                }
                box.appendChild(renderWorkingBlock("Working", details.working || []));

                const alts = details.alternative || [];
                for (const alt of alts) {
                    box.appendChild(renderWorkingBlock("Alternative working", alt));
                }
                return box;
            }

            function renderTextBlock(title, paragraphsParts) {
                // paragraphsParts: array of parts arrays
                const block = el("div", { class: "block" });
                block.appendChild(el("h4", null, title));
                for (const parts of paragraphsParts) {
                    const p = el("p", null);
                    p.appendChild(renderParts(parts));
                    block.appendChild(p);
                }
                return block;
            }

            function renderWorkingBlock(title, latexLines) {
                const block = el("div", { class: "block" });
                block.appendChild(el("h4", null, title));

                // Render each maths line programmatically (block math containers)
                // If KaTeX fails to load, fall back to plain text strings
                if (!latexLines || latexLines.length === 0) {
                    const p = el("p", null, "—");
                    block.appendChild(p);
                    return block;
                }

                for (const line of latexLines) {
                    // Use block-level container for each line to stress overflow rules
                    block.appendChild(renderBlockLatex(line));
                }
                return block;
            }

            function cssSafeId(s) {
                return String(s).replace(/[^a-zA-Z0-9\-_]/g, "_");
            }

            function jumpTo(qid) {
                const node = paperMain.querySelector(`[data-qid="${CSS.escape(qid)}"]`);
                if (!node) return;
                // user-initiated navigation; no smooth motion
                node.scrollIntoView({ behavior: "auto", block: "start" });
                setCurrentNav(qid);
            }

            function setCurrentNav(qid) {
                // update both nav rail + drawer nav
                const all = document.querySelectorAll(`button.nav-link`);
                all.forEach(btn => {
                    const isCurrent = btn.getAttribute("data-target") === qid;
                    if (isCurrent) btn.setAttribute("aria-current", "true");
                    else btn.removeAttribute("aria-current");
                });
            }

            function populateSelector() {
                paperSelect.innerHTML = "";
                for (const d of DATASETS) {
                    const ds = d.build();
                    const opt = document.createElement("option");
                    opt.value = d.key;
                    opt.textContent = ds.label;
                    paperSelect.appendChild(opt);
                }
            }

            function loadDataset(key) {
                const entry = DATASETS.find(d => d.key === key) || DATASETS[0];
                currentDataset = entry.build();

                buildNavItems(currentDataset);
                buildPaperContent(currentDataset);

                // Default current nav to first question id
                const firstId = (currentDataset.kind === "sectioned")
                    ? currentDataset.sections[0].questions[0].id
                    : currentDataset.questions[0].id;
                setCurrentNav(firstId);
            }

            /* ---------------------------
               Drawer behavior (accessibility baseline)
               --------------------------- */

            let lastFocus = null;

            function openDrawer() {
                if (!isMobileNav()) return;
                if (drawerBackdrop.getAttribute("aria-hidden") === "false") return;

                lastFocus = document.activeElement;

                drawerBackdrop.setAttribute("aria-hidden", "false");
                // Prevent background interaction
                document.body.style.overflow = "hidden";
                try {
                    appShell.inert = true;
                } catch (_e) {
                    appShell.setAttribute("aria-hidden", "true");
                }

                // Focus the drawer nav region
                drawerNav.focus({ preventScroll: true });
            }

            function closeDrawer() {
                if (drawerBackdrop.getAttribute("aria-hidden") === "true") return;

                drawerBackdrop.setAttribute("aria-hidden", "true");
                document.body.style.overflow = "";
                try {
                    appShell.inert = false;
                } catch (_e) {
                    appShell.removeAttribute("aria-hidden");
                }

                if (lastFocus && typeof lastFocus.focus === "function") {
                    lastFocus.focus({ preventScroll: true });
                }
            }

            function focusTrap(e) {
                if (drawerBackdrop.getAttribute("aria-hidden") === "true") return;
                if (e.key !== "Tab") return;

                const focusables = drawer.querySelectorAll(
                    'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
                );
                const list = Array.from(focusables).filter(n => !n.hasAttribute("disabled"));
                if (!list.length) return;

                const first = list[0];
                const last = list[list.length - 1];

                if (e.shiftKey && document.activeElement === first) {
                    e.preventDefault();
                    last.focus();
                } else if (!e.shiftKey && document.activeElement === last) {
                    e.preventDefault();
                    first.focus();
                }
            }

            /* ---------------------------
               Init
               --------------------------- */

            populateSelector();
            paperSelect.value = DATASETS[0].key;
            loadDataset(paperSelect.value);

            paperSelect.addEventListener("change", () => {
                // switching papers must rebuild navigation and content, without extra semantics
                loadDataset(paperSelect.value);
            });

            jumpBtn.addEventListener("click", openDrawer);
            drawerClose.addEventListener("click", closeDrawer);

            drawerBackdrop.addEventListener("click", (e) => {
                if (e.target === drawerBackdrop) closeDrawer();
            });

            window.addEventListener("keydown", (e) => {
                if (e.key === "Escape") closeDrawer();
                focusTrap(e);
            });

            window.addEventListener("resize", () => {
                setHeaderHeightVar();
                syncJumpBtnVisibility();
                // If switching to desktop while drawer open, close it
                if (!isMobileNav()) closeDrawer();
            });

            setHeaderHeightVar();
            syncJumpBtnVisibility();
        })();
    </script>
</body>

</html>