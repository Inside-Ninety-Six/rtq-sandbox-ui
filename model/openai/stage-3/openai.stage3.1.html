<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RTQ – Maths Paper Solution Viewer (Stress Test Harness)</title>

  <!-- KaTeX (CDN) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css"
    integrity="sha384-nB0miv6/jRmo5UMMR1wu3Gz6NLsoTkbqJghGIsx//Rlm+ZU03BU6SQNC66uf4l5+" crossorigin="anonymous">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"
    integrity="sha384-7zkQWkzuo3B5mTepMUcHkMB5jZaolc2xDwL6VFqjFALcbeS9Ggm/Yr2r3Dy4lfFg"
    crossorigin="anonymous"></script>

  <style>
    :root {
      --frame-max: 1200px;
      --gutter: 16px;
      --gap: 24px;
      --nav-w: 120px;

      --ink: #111;
      --muted: #666;
      --quiet: #888;

      --space-1: 6px;
      --space-2: 10px;
      --space-3: 14px;
      --space-4: 18px;
      --space-5: 26px;
      --space-6: 34px;
      --space-7: 46px;
    }

    html,
    body {
      height: 100%;
    }

    body {
      margin: 0;
      color: var(--ink);
      background: #fff;
      overflow-x: hidden;
      /* never page-level horizontal scroll */
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      line-height: 1.35;
    }

    /* top controls area aligned to same centered frame */
    header {
      padding: var(--space-4) 0;
    }

    .frame {
      max-width: var(--frame-max);
      margin: 0 auto;
      padding: 0 var(--gutter);
      box-sizing: border-box;
    }

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--gap);
    }

    .control {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      white-space: nowrap;
    }

    label {
      font-size: 14px;
      color: var(--muted);
    }

    select {
      font-size: 14px;
      padding: 8px 10px;
      border: 1px solid #bbb;
      border-radius: 6px;
      background: #fff;
      color: var(--ink);
    }

    .hint {
      font-size: 12px;
      color: var(--quiet);
      margin-left: 10px;
    }

    /* main layout: two sibling columns within centered frame */
    .layout {
      display: grid;
      grid-template-columns: var(--nav-w) 1fr;
      gap: var(--gap);
      align-items: start;
      padding-bottom: 80px;
    }

    /* navigation rail */
    nav[aria-label="Questions"] {
      position: sticky;
      top: var(--space-4);
      align-self: start;
    }

    .nav-inner {
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
    }

    .nav-title {
      font-size: 12px;
      letter-spacing: .04em;
      text-transform: uppercase;
      color: var(--muted);
    }

    /* nav list may scroll independently if it exceeds viewport height */
    .nav-list {
      max-height: calc(100vh - 120px);
      overflow-y: auto;
      padding-right: 4px;
      scrollbar-width: none;
      /* Firefox */
      -ms-overflow-style: none;
      /* legacy */
    }

    .nav-list::-webkit-scrollbar {
      display: none;
    }

    /* WebKit/Blink */

    .nav-item,
    .nav-sep {
      display: block;
      font-size: 13px;
      color: var(--muted);
      text-decoration: none;
      padding: 5px 4px;
      border-radius: 4px;
      outline-offset: 2px;
    }

    .nav-item:hover {
      color: var(--ink);
      text-decoration: underline;
      text-underline-offset: 3px;
    }

    .nav-item:focus-visible {
      outline: 2px solid #000;
    }

    .nav-item[aria-current="true"] {
      color: var(--ink);
    }

    .nav-sep {
      color: var(--quiet);
      padding: 8px 4px 4px;
      font-size: 12px;
      letter-spacing: .02em;
    }

    /* paper content */
    main {
      min-width: 0;
      /* allow KaTeX blocks to overflow only inside their containers */
    }

    .paper-title {
      font-size: 14px;
      color: var(--muted);
      margin: 0 0 var(--space-6) 0;
    }

    /* rhythm and spacing: whitespace-based grouping, no cards */
    .q {
      margin: 0 0 var(--space-7) 0;
      /* largest spacing unit between top-level questions */
    }

    .q:last-child {
      margin-bottom: 0;
    }

    .q-head {
      display: flex;
      gap: var(--space-3);
      align-items: flex-start;
    }

    .q-number {
      width: 44px;
      flex: 0 0 44px;
      font-size: 14px;
      color: var(--muted);
    }

    .q-body {
      min-width: 0;
      flex: 1 1 auto;
    }

    /* nesting: indentation only */
    .depth-0 .q-number {
      opacity: 1;
    }

    .depth-1 {
      padding-left: 18px;
    }

    .depth-2 {
      padding-left: 36px;
    }

    .depth-3 {
      padding-left: 54px;
    }

    .prompt {
      font-size: 16px;
      margin: 0 0 var(--space-2) 0;
    }

    .prompt .small {
      font-size: 14px;
      color: var(--muted);
    }

    .answer {
      margin: 0 0 var(--space-2) 0;
      font-size: 14px;
      color: var(--ink);
    }

    .answer .label {
      display: inline-block;
      font-size: 12px;
      color: var(--muted);
      margin-right: 8px;
    }

    .working {
      margin: 0;
      font-size: 14px;
      color: var(--muted);
    }

    .toggle {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 8px;
      font-size: 13px;
      color: var(--ink);
      background: #fff;
      border: 1px solid #bbb;
      border-radius: 6px;
      cursor: pointer;
    }

    .toggle:hover {
      border-color: #999;
    }

    .toggle:focus-visible {
      outline: 2px solid #000;
      outline-offset: 2px;
    }

    .working-preview {
      margin: var(--space-2) 0 0 0;
      color: var(--quiet);
      font-size: 13px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      max-width: 70ch;
    }

    .working-content {
      margin: var(--space-2) 0 0 0;
      color: var(--muted);
      max-width: 80ch;
    }

    /* math styling */
    .math-inline {
      display: inline;
      white-space: normal;
    }

    .math-block {
      margin: 10px 0;
      overflow-x: auto;
      /* horizontal scrolling ONLY inside block math */
      overflow-y: hidden;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .math-block::-webkit-scrollbar {
      display: none;
    }

    .math-block .katex-display {
      margin: 0;
    }

    /* diagrams */
    .diagram {
      margin: var(--space-2) 0 var(--space-2) 0;
      max-width: 560px;
    }

    .diagram svg {
      width: 100%;
      height: auto;
      display: block;
    }

    .diagram .cap {
      font-size: 12px;
      color: var(--quiet);
      margin-top: 6px;
    }

    /* section labels within paper */
    .section-label {
      margin: var(--space-6) 0 var(--space-5) 0;
      font-size: 14px;
      color: var(--muted);
      letter-spacing: .03em;
      text-transform: uppercase;
    }

    /* mobile: nav becomes drawer; "Jump to" always accessible */
    .jump-btn {
      padding: 10px 12px;
      border: 1px solid #bbb;
      background: #fff;
      border-radius: 999px;
      font-size: 14px;
      cursor: pointer;
    }

    .jump-btn:focus-visible {
      outline: 2px solid #000;
      outline-offset: 2px;
    }

    .mobile-only {
      display: none;
    }

    .drawer-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .35);
    }

    .drawer-panel {
      position: fixed;
      top: 0;
      right: 0;
      height: 100%;
      width: min(320px, 86vw);
      background: #fff;
      box-sizing: border-box;
      padding: 18px 16px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .drawer-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .drawer-title {
      font-size: 12px;
      letter-spacing: .04em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .close-btn {
      border: 1px solid #bbb;
      background: #fff;
      padding: 8px 10px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
    }

    .close-btn:focus-visible {
      outline: 2px solid #000;
      outline-offset: 2px;
    }

    .drawer-list {
      overflow-y: auto;
      padding-right: 4px;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .drawer-list::-webkit-scrollbar {
      display: none;
    }

    /* responsive layout */
    @media (max-width: 980px) {
      :root {
        --nav-w: 108px;
      }

      .prompt {
        font-size: 15px;
      }
    }

    @media (max-width: 860px) {
      .layout {
        grid-template-columns: 1fr;
      }

      nav[aria-label="Questions"] {
        display: none;
      }

      .mobile-only {
        display: inline-flex;
      }
    }

    /* keep the Jump button always reachable on mobile */
    .floating-jump {
      position: fixed;
      right: 14px;
      bottom: 14px;
      z-index: 30;
      display: none;
    }

    @media (max-width: 860px) {
      .floating-jump {
        display: block;
      }
    }

    /* reduce accidental toggles while scrolling: keep toggle compact, but not too close to edges */
    .working-controls {
      margin-top: var(--space-2);
    }
  </style>
</head>

<body>
  <header>
    <div class="frame topbar">
      <div class="control">
        <label for="paperSelect">Paper</label>
        <select id="paperSelect" aria-label="Paper selector">
          <option value="short">Short paper</option>
          <option value="standard">Standard paper</option>
          <option value="standardExpanded">Standard (Workings Expanded)</option>
          <option value="diagram">Diagram-heavy paper</option>
          <option value="sectioned">Sectioned paper</option>
        </select>
        <span class="hint">Answers visible · Workings collapsed (except Expanded dataset)</span>
      </div>

      <button id="openNavBtnTop" class="jump-btn mobile-only" type="button">Jump to</button>
    </div>
  </header>

  <div class="frame layout" id="appFrame">
    <nav aria-label="Questions">
      <div class="nav-inner">
        <div class="nav-title">Jump</div>
        <div id="navList" class="nav-list" tabindex="0" aria-label="Question list"></div>
      </div>
    </nav>

    <main id="paper" aria-label="Paper content">
      <p class="paper-title" id="paperTitle"></p>
      <div id="paperBody"></div>
    </main>
  </div>

  <!-- Floating mobile control -->
  <div class="floating-jump">
    <button id="openNavBtnFloat" class="jump-btn" type="button">Jump to</button>
  </div>

  <!-- Drawer (mobile/tablet) -->
  <div id="drawer" hidden>
    <div class="drawer-backdrop" data-close="true"></div>
    <div class="drawer-panel" role="dialog" aria-modal="true" aria-label="Jump to question">
      <div class="drawer-header">
        <div class="drawer-title">Jump</div>
        <button id="closeDrawer" class="close-btn" type="button">Close</button>
      </div>
      <div id="drawerList" class="drawer-list" tabindex="0" aria-label="Question list (drawer)"></div>
    </div>
  </div>

  <script>
    (function () {
      const elSelect = document.getElementById('paperSelect');
      const elPaperTitle = document.getElementById('paperTitle');
      const elPaperBody = document.getElementById('paperBody');
      const elNavList = document.getElementById('navList');
      const elDrawer = document.getElementById('drawer');
      const elDrawerList = document.getElementById('drawerList');
      const btnOpenTop = document.getElementById('openNavBtnTop');
      const btnOpenFloat = document.getElementById('openNavBtnFloat');
      const btnClose = document.getElementById('closeDrawer');
      const appFrame = document.getElementById('appFrame');

      // ---------- Diagrams (inline SVG placeholders, reused types) ----------
      function svgGeometry() {
        return `
          <div class="diagram" aria-label="Diagram: geometry">
            <svg viewBox="0 0 320 180" role="img" aria-label="Triangle and circle">
              <rect x="1" y="1" width="318" height="178" fill="none" stroke="#000" stroke-width="1"/>
              <circle cx="240" cy="80" r="45" fill="none" stroke="#000" stroke-width="2"/>
              <polygon points="40,140 140,40 200,140" fill="none" stroke="#000" stroke-width="2"/>
              <text x="52" y="148" font-size="12" fill="#000">A</text>
              <text x="134" y="36" font-size="12" fill="#000">B</text>
              <text x="206" y="148" font-size="12" fill="#000">C</text>
              <text x="238" y="84" font-size="12" fill="#000">r</text>
              <line x1="140" y1="40" x2="200" y2="140" stroke="#000" stroke-width="1" stroke-dasharray="4 4"/>
            </svg>
            <div class="cap">Use the diagram above.</div>
          </div>
        `;
      }

      function svgRatioBars() {
        return `
          <div class="diagram" aria-label="Diagram: ratio bars">
            <svg viewBox="0 0 320 140" role="img" aria-label="Ratio bars">
              <rect x="1" y="1" width="318" height="138" fill="none" stroke="#000" stroke-width="1"/>
              <rect x="24" y="34" width="260" height="22" fill="none" stroke="#000" stroke-width="2"/>
              <line x1="24" y1="34" x2="84" y2="56" stroke="#000" stroke-width="2"/>
              <line x1="84" y1="34" x2="144" y2="56" stroke="#000" stroke-width="2"/>
              <line x1="144" y1="34" x2="204" y2="56" stroke="#000" stroke-width="2"/>
              <line x1="204" y1="34" x2="284" y2="56" stroke="#000" stroke-width="2"/>
              <text x="24" y="28" font-size="12" fill="#000">A</text>
              <text x="24" y="84" font-size="12" fill="#000">B</text>
              <rect x="24" y="90" width="260" height="22" fill="none" stroke="#000" stroke-width="2"/>
              <line x1="24" y1="90" x2="154" y2="112" stroke="#000" stroke-width="2"/>
              <line x1="154" y1="90" x2="284" y2="112" stroke="#000" stroke-width="2"/>
            </svg>
            <div class="cap">Bars show a ratio.</div>
          </div>
        `;
      }

      function svgCoordinateGrid() {
        return `
          <div class="diagram" aria-label="Diagram: coordinate grid">
            <svg viewBox="0 0 320 200" role="img" aria-label="Coordinate grid">
              <rect x="1" y="1" width="318" height="198" fill="none" stroke="#000" stroke-width="1"/>
              <g stroke="#000" stroke-width="1" opacity="0.3">
                ${Array.from({ length: 11 }, (_, i) => `<line x1="${30 + i * 25}" y1="20" x2="${30 + i * 25}" y2="180"/>`).join('')}
                ${Array.from({ length: 7 }, (_, i) => `<line x1="30" y1="${20 + i * 25}" x2="280" y2="${20 + i * 25}"/>`).join('')}
              </g>
              <g stroke="#000" stroke-width="2">
                <line x1="30" y1="180" x2="280" y2="180"/>
                <line x1="30" y1="180" x2="30" y2="20"/>
              </g>
              <circle cx="105" cy="130" r="4" fill="#000"/>
              <circle cx="230" cy="80" r="4" fill="#000"/>
              <line x1="105" y1="130" x2="230" y2="80" stroke="#000" stroke-width="2"/>
              <text x="92" y="146" font-size="12" fill="#000">(3,2)</text>
              <text x="236" y="78" font-size="12" fill="#000">(8,4)</text>
            </svg>
            <div class="cap">Read coordinates from the grid.</div>
          </div>
        `;
      }

      function svgTableGrid() {
        return `
          <div class="diagram" aria-label="Diagram: table grid">
            <svg viewBox="0 0 320 170" role="img" aria-label="Table grid">
              <rect x="1" y="1" width="318" height="168" fill="none" stroke="#000" stroke-width="1"/>
              <rect x="40" y="30" width="240" height="110" fill="none" stroke="#000" stroke-width="2"/>
              <g stroke="#000" stroke-width="1.5">
                <line x1="40" y1="66" x2="280" y2="66"/>
                <line x1="40" y1="102" x2="280" y2="102"/>
                <line x1="120" y1="30" x2="120" y2="140"/>
                <line x1="200" y1="30" x2="200" y2="140"/>
              </g>
              <text x="58" y="24" font-size="12" fill="#000">x</text>
              <text x="138" y="24" font-size="12" fill="#000">y</text>
              <text x="218" y="24" font-size="12" fill="#000">z</text>
              <text x="58" y="56" font-size="12" fill="#000">2</text>
              <text x="138" y="56" font-size="12" fill="#000">5</text>
              <text x="218" y="56" font-size="12" fill="#000">?</text>
              <text x="58" y="92" font-size="12" fill="#000">3</text>
              <text x="138" y="92" font-size="12" fill="#000">7</text>
              <text x="218" y="92" font-size="12" fill="#000">?</text>
            </svg>
            <div class="cap">Complete the missing values.</div>
          </div>
        `;
      }

      const diagramTypes = [svgGeometry, svgRatioBars, svgCoordinateGrid, svgTableGrid];

      // ---------- Math helpers ----------
      function inlineMath(tex) {
        return `<span class="math-inline" data-tex="${escapeAttr(tex)}">${escapeHtml(tex)}</span>`;
      }
      function blockMath(tex) {
        // overflow safety-net only here
        return `<div class="math-block" data-tex="${escapeAttr(tex)}">${escapeHtml(tex)}</div>`;
      }

      function escapeHtml(s) {
        return String(s)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }
      function escapeAttr(s) {
        return escapeHtml(s).replaceAll("\n", "&#10;");
      }

      // ---------- Working line generators ----------
      function workingPreviewFromLines(lines) {
        const plain = lines
          .slice(0, 2)
          .map(l => l.type === 'math' ? l.tex : l.text)
          .join(' · ');
        return plain || 'Working steps…';
      }

      function genShortWorking(seed) {
        const a = seed % 9 + 2;
        const b = (seed * 3) % 7 + 1;
        return [
          { type: 'text', text: `Rewrite the expression and simplify.` },
          { type: 'math', tex: `${a}x + ${b}x = ${(a + b)}x` },
          { type: 'math', tex: `${(a + b)}x = 24 \\Rightarrow x = ${Math.max(1, Math.floor(24 / (a + b)))} ` }
        ];
      }

      function genMediumWorking(seed) {
        const n = (seed % 7) + 3;
        const m = (seed % 5) + 2;
        return [
          { type: 'text', text: `Let the unknown be ${inlineMath('x')}.` },
          { type: 'math', tex: `${n}x + ${m} = 2x + 14` },
          { type: 'math', tex: `${(n - 2)}x = ${14 - m}` },
          { type: 'math', tex: `x = \\dfrac{${14 - m}}{${n - 2}}` }
        ];
      }

      function genLongAlgebraWorking(seed, linesCount) {
        const lines = [];
        const k = (seed % 8) + 2;
        const c = (seed % 11) + 3;

        lines.push({ type: 'text', text: `Start from the given equation and collect like terms.` });
        lines.push({ type: 'math', tex: `(${k}x - ${c})^2 = ${k * k}x^2 - ${2 * k * c}x + ${c * c}` });
        lines.push({ type: 'math', tex: `${k * k}x^2 - ${2 * k * c}x + ${c * c} = 0` });

        const extra = Math.max(8, linesCount - 3);
        for (let i = 0; i < extra; i++) {
          const a = k * k;
          const b = 2 * k * c + i;
          const d = c * c + (i % 3);
          lines.push({ type: 'math', tex: `${a}x^2 - ${b}x + ${d} = 0` });
          if (i % 4 === 0) {
            lines.push({ type: 'math', tex: `x = \\dfrac{${b} \\pm \\sqrt{${b * b} - 4\\cdot ${a}\\cdot ${d}}}{2\\cdot ${a}}` });
          }
        }
        return lines;
      }

      function genExtremelyLongWorking(seed, totalLines) {
        const lines = [];
        const a0 = (seed % 9) + 2;
        const b0 = (seed % 7) + 1;

        lines.push({ type: 'text', text: `Work carefully line-by-line. Keep the layout calm and continuous.` });

        for (let i = 1; i <= totalLines; i++) {
          const a = a0 + (i % 5);
          const b = b0 + (i % 3);
          if (i % 6 === 0) {
            lines.push({ type: 'math', tex: `\\text{Check: } ${a}(${i}) + ${b} = ${a * i + b}` });
          } else if (i % 5 === 0) {
            lines.push({ type: 'math', tex: `\\dfrac{${a}x + ${b}}{${a}} = x + \\dfrac{${b}}{${a}}` });
          } else if (i % 4 === 0) {
            lines.push({ type: 'math', tex: `\\sum_{t=1}^{${Math.min(12, (i % 12) + 1)}} (t + ${b}) = \\dfrac{n(n+1)}{2} + ${b}n` });
          } else if (i % 3 === 0) {
            lines.push({ type: 'math', tex: `${a}x - ${b} = 0 \\Rightarrow x = \\dfrac{${b}}{${a}}` });
          } else {
            lines.push({ type: 'math', tex: `${a}x + ${b} = ${a}(x + \\dfrac{${b}}{${a}})` });
          }
        }
        return lines;
      }

      // ---------- Dataset builders ----------
      function makeQuestion({ id, label, depth, promptHtml, answerHtml, workingLines, workingDefaultExpanded = false }) {
        return {
          type: 'question',
          id, label, depth,
          promptHtml,
          answerHtml,
          workingLines,
          workingDefaultExpanded
        };
      }
      function makeSection(label) {
        return { type: 'section', label };
      }

      function buildShortPaper() {
        const items = [];
        items.push(makeQuestion({
          id: 'q1', label: '1', depth: 0,
          promptHtml: `Calculate ${inlineMath('7\\times 8')}.`,
          answerHtml: `${inlineMath('56')}`,
          workingLines: [
            { type: 'text', text: `Use a known fact or repeated addition.` },
            { type: 'math', tex: `7\\times 8 = 7\\times (10-2) = 70 - 14` },
            { type: 'math', tex: `= 56` }
          ],
          workingDefaultExpanded: false
        }));

        items.push(makeQuestion({
          id: 'q2', label: '2', depth: 0,
          promptHtml: `Write ${inlineMath('\\frac{3}{4}')} as a decimal.`,
          answerHtml: `${inlineMath('0.75')}`,
          workingLines: [
            { type: 'text', text: `Divide numerator by denominator.` },
            { type: 'math', tex: `3 \\div 4 = 0.75` }
          ],
          workingDefaultExpanded: false
        }));

        items.push(makeQuestion({
          id: 'q3', label: '3', depth: 0,
          promptHtml: `A number ${inlineMath('x')} satisfies ${inlineMath('x+9=21')}. Find ${inlineMath('x')}.`,
          answerHtml: `${inlineMath('12')}`,
          workingLines: genMediumWorking(3),
          workingDefaultExpanded: false
        }));

        // Multi-part question (one question with sub-parts)
        items.push(makeQuestion({
          id: 'q4', label: '4', depth: 0,
          promptHtml: `A shop sells pencils and erasers.`,
          answerHtml: `<span class="small">See parts (a)–(c).</span>`,
          workingLines: [
            { type: 'text', text: `This question has sub-parts below.` }
          ],
          workingDefaultExpanded: false
        }));

        items.push(makeQuestion({
          id: 'q4a', label: '4a', depth: 1,
          promptHtml: `(a) One pencil costs 15p. What is the cost of 6 pencils?`,
          answerHtml: `${inlineMath('90\\text{p}')}`,
          workingLines: [
            { type: 'math', tex: `6\\times 15 = 6\\times (10+5) = 60+30 = 90` },
            { type: 'text', text: `So the cost is 90p.` }
          ],
          workingDefaultExpanded: false
        }));

        items.push(makeQuestion({
          id: 'q4b', label: '4b', depth: 1,
          promptHtml: `(b) An eraser costs 25p. What is the total cost of 2 pencils and 3 erasers?`,
          answerHtml: `${inlineMath('2\\cdot 15 + 3\\cdot 25 = 105\\text{p}')}`,
          workingLines: [
            { type: 'math', tex: `2\\cdot 15 = 30` },
            { type: 'math', tex: `3\\cdot 25 = 75` },
            { type: 'math', tex: `30 + 75 = 105` }
          ],
          workingDefaultExpanded: false
        }));

        items.push(makeQuestion({
          id: 'q4c', label: '4c', depth: 1,
          promptHtml: `(c) A customer pays £2. How much change do they receive for the total in (b)?`,
          answerHtml: `${inlineMath('£0.95')}`,
          workingLines: [
            { type: 'math', tex: `£2.00 = 200\\text{p}` },
            { type: 'math', tex: `200 - 105 = 95\\text{p}` },
            { type: 'text', text: `So the change is £0.95.` }
          ],
          workingDefaultExpanded: false
        }));

        items.push(makeQuestion({
          id: 'q5', label: '5', depth: 0,
          promptHtml: `Find the perimeter of a rectangle with length 9 cm and width 4 cm.`,
          answerHtml: `${inlineMath('26\\text{ cm}')}`,
          workingLines: [
            { type: 'math', tex: `P = 2(9+4) = 2\\cdot 13 = 26` }
          ],
          workingDefaultExpanded: false
        }));

        items.push(makeQuestion({
          id: 'q6', label: '6', depth: 0,
          promptHtml: `Simplify ${inlineMath('3a + 5a - 2a')}.`,
          answerHtml: `${inlineMath('6a')}`,
          workingLines: [
            { type: 'math', tex: `3a + 5a - 2a = (3+5-2)a = 6a` }
          ],
          workingDefaultExpanded: false
        }));

        return {
          key: 'short',
          title: 'Short paper (6 questions)',
          items
        };
      }

      function buildStandardPaper(allWorkingsExpanded) {
        const items = [];

        // Q1–Q17: mixed short/medium
        for (let q = 1; q <= 17; q++) {
          const seed = q * 13;
          const isMathy = q % 3 === 0;
          const prompt = isMathy
            ? `Calculate ${inlineMath(`${q}+${(q * 7) % 19}`)} and write the answer as an integer.`
            : `A number line goes from 0 to 100. Mark the position of ${inlineMath(String((q * 6) % 101))}.`;
          const ans = isMathy ? inlineMath(String(q + ((q * 7) % 19))) : inlineMath(String((q * 6) % 101));
          items.push(makeQuestion({
            id: `q${q}`,
            label: String(q),
            depth: 0,
            promptHtml: prompt,
            answerHtml: ans,
            workingLines: (q % 4 === 0) ? genMediumWorking(seed) : genShortWorking(seed),
            workingDefaultExpanded: !!allWorkingsExpanded
          }));
        }

        // Deep nesting exemplar: Q18 with sub-questions and sub-sub-questions
        items.push(makeQuestion({
          id: 'q18',
          label: '18',
          depth: 0,
          promptHtml: `A sequence is defined by ${inlineMath('u_1=2')} and ${inlineMath('u_{n+1}=2u_n+1')}.`,
          answerHtml: `<span class="small">See parts (a)–(b).</span>`,
          workingLines: [
            { type: 'text', text: `Use the recurrence and substitute step-by-step.` }
          ],
          workingDefaultExpanded: !!allWorkingsExpanded
        }));
        items.push(makeQuestion({
          id: 'q18a',
          label: '18a',
          depth: 1,
          promptHtml: `(a) Find ${inlineMath('u_2')} and ${inlineMath('u_3')}.`,
          answerHtml: `${inlineMath('u_2=5,\\;u_3=11')}`,
          workingLines: [
            { type: 'math', tex: `u_2 = 2u_1 + 1 = 2\\cdot 2 + 1 = 5` },
            { type: 'math', tex: `u_3 = 2u_2 + 1 = 2\\cdot 5 + 1 = 11` }
          ],
          workingDefaultExpanded: !!allWorkingsExpanded
        }));
        items.push(makeQuestion({
          id: 'q18a_i',
          label: '18(a)(i)',
          depth: 2,
          promptHtml: `(i) Write ${inlineMath('u_4')} in terms of ${inlineMath('u_3')}.`,
          answerHtml: `${inlineMath('u_4=2u_3+1')}`,
          workingLines: [
            { type: 'math', tex: `u_{n+1} = 2u_n + 1 \\Rightarrow u_4 = 2u_3 + 1` }
          ],
          workingDefaultExpanded: !!allWorkingsExpanded
        }));
        items.push(makeQuestion({
          id: 'q18a_ii',
          label: '18(a)(ii)',
          depth: 2,
          promptHtml: `(ii) Find ${inlineMath('u_4')}.`,
          answerHtml: `${inlineMath('23')}`,
          workingLines: [
            { type: 'math', tex: `u_4 = 2\\cdot 11 + 1 = 23` }
          ],
          workingDefaultExpanded: !!allWorkingsExpanded
        }));
        items.push(makeQuestion({
          id: 'q18b',
          label: '18b',
          depth: 1,
          promptHtml: `(b) Show that ${inlineMath('u_n')} is always odd.`,
          answerHtml: `${inlineMath('\\text{Always odd}')}`,
          workingLines: [
            { type: 'text', text: `Assume u_n is odd, then write u_{n+1}.` },
            { type: 'math', tex: `\\text{If }u_n=2k+1,\\;u_{n+1}=2(2k+1)+1=4k+3=2(2k+1)+1` },
            { type: 'text', text: `So u_{n+1} is also odd. With u_1=2 (even), from u_2 onward terms are odd; the recurrence keeps oddness once it begins.` }
          ],
          workingDefaultExpanded: !!allWorkingsExpanded
        }));

        // Q19–Q25: include a few with diagrams and mixed structures
        for (let q = 19; q <= 25; q++) {
          const seed = q * 17;
          const withDiagram = (q === 20 || q === 22 || q === 25);
          const diag = withDiagram ? diagramTypes[(q % diagramTypes.length)]() : '';
          items.push(makeQuestion({
            id: `q${q}`,
            label: String(q),
            depth: 0,
            promptHtml: `${withDiagram ? diag : ''}Solve ${inlineMath(`${(q % 9) + 2}x + ${(q % 5) + 1} = 19`)} for ${inlineMath('x')}.`,
            answerHtml: inlineMath(String(Math.max(1, Math.floor((19 - ((q % 5) + 1)) / ((q % 9) + 2))))),
            workingLines: genMediumWorking(seed),
            workingDefaultExpanded: !!allWorkingsExpanded
          }));
        }

        // Q26–Q35: long algebra; workings collapsed by default (unless expanded dataset)
        for (let q = 26; q <= 35; q++) {
          const seed = q * 29;
          const veryLong = (q === 33 || q === 35); // extremely long workings stress test
          const lines = veryLong ? genExtremelyLongWorking(seed, 58) : genLongAlgebraWorking(seed, 22);

          const promptHtml = `Expand and simplify: ${inlineMath(`(${(q % 7) + 2}x - ${(q % 9) + 3})^2`)}. Then solve for ${inlineMath('x')} when it equals 0.`;
          const answerHtml = `<span class="small">${inlineMath('x = \\dfrac{b\\pm\\sqrt{b^2-4ac}}{2a}')}</span>`;

          items.push(makeQuestion({
            id: `q${q}`,
            label: String(q),
            depth: 0,
            promptHtml,
            answerHtml,
            workingLines: lines.map(l => {
              // Convert many items into block math lines for KaTeX stress test
              if (l.type === 'math') {
                return { type: 'blockmath', tex: l.tex };
              }
              return l;
            }),
            workingDefaultExpanded: !!allWorkingsExpanded
          }));

          // Deep nesting exemplar around Q30: include (a)(i)(ii)(b)
          if (q === 30) {
            items.push(makeQuestion({
              id: 'q30a',
              label: '30a',
              depth: 1,
              promptHtml: `(a) Let ${inlineMath('f(x)=x^2-6x+5')}. Find ${inlineMath('f(2)')}.`,
              answerHtml: `${inlineMath('f(2) = -3')}`,
              workingLines: [
                { type: 'math', tex: `f(2)=2^2-6\\cdot 2 + 5 = 4 - 12 + 5 = -3` },
              ],
              workingDefaultExpanded: !!allWorkingsExpanded
            }));
            items.push(makeQuestion({
              id: 'q30a_i',
              label: '30(a)(i)',
              depth: 2,
              promptHtml: `(i) Factorise ${inlineMath('x^2-6x+5')}.`,
              answerHtml: `${inlineMath('(x-1)(x-5)')}`,
              workingLines: [
                { type: 'math', tex: `x^2-6x+5 = (x-1)(x-5)` },
              ],
              workingDefaultExpanded: !!allWorkingsExpanded
            }));
            items.push(makeQuestion({
              id: 'q30a_ii',
              label: '30(a)(ii)',
              depth: 2,
              promptHtml: `(ii) Hence solve ${inlineMath('x^2-6x+5=0')}.`,
              answerHtml: `${inlineMath('x=1\\text{ or }x=5')}`,
              workingLines: [
                { type: 'math', tex: `(x-1)(x-5)=0` },
                { type: 'math', tex: `x=1\\;\\text{or}\\;x=5` }
              ],
              workingDefaultExpanded: !!allWorkingsExpanded
            }));
            items.push(makeQuestion({
              id: 'q30b',
              label: '30b',
              depth: 1,
              promptHtml: `(b) Sketch the graph of ${inlineMath('y=x^2-6x+5')}.`,
              answerHtml: `<span class="small">Roots at 1 and 5; vertex at ${inlineMath('(3,-4)')}.</span>`,
              workingLines: [
                { type: 'math', tex: `y = x^2-6x+5 = (x-3)^2-4` },
                { type: 'math', tex: `\\text{Vertex: }(3,-4)` }
              ],
              workingDefaultExpanded: !!allWorkingsExpanded
            }));
          }
        }

        return {
          key: allWorkingsExpanded ? 'standardExpanded' : 'standard',
          title: allWorkingsExpanded
            ? 'Standard (Workings Expanded) – 35 questions'
            : 'Standard paper – 35 questions',
          items
        };
      }

      function buildDiagramHeavyPaper() {
        const items = [];
        const diagramQs = new Set([2, 4, 6, 8, 10, 12, 15, 18]);

        for (let q = 1; q <= 20; q++) {
          const seed = q * 23;
          const withDiagram = diagramQs.has(q);
          const diag = withDiagram ? diagramTypes[(q * 2) % diagramTypes.length]() : '';
          const promptHtml = withDiagram
            ? `${diag}Use the diagram to answer. Evaluate ${inlineMath(`${(q % 8) + 2} + ${(q % 7) + 3}`)}.`
            : `Simplify ${inlineMath(`${(q % 9) + 2}y + ${(q % 5) + 1}y`)}.`;

          const answerHtml = withDiagram
            ? inlineMath(String(((q % 8) + 2) + ((q % 7) + 3)))
            : inlineMath(String(((q % 9) + 2) + ((q % 5) + 1)) + 'y');

          items.push(makeQuestion({
            id: `dq${q}`,
            label: String(q),
            depth: 0,
            promptHtml,
            answerHtml,
            workingLines: withDiagram ? genShortWorking(seed) : genMediumWorking(seed),
            workingDefaultExpanded: false
          }));
        }

        return { key: 'diagram', title: 'Diagram-heavy paper – 20 questions (8 with diagrams)', items };
      }

      function buildSectionedPaper() {
        const items = [];

        items.push(makeSection('Section A'));
        for (let q = 1; q <= 35; q++) {
          const seed = q * 31;
          const prompt = (q % 5 === 0)
            ? `Calculate ${inlineMath(`${q}\\times 3 + 7`)}.`
            : `Solve ${inlineMath(`${(q % 8) + 2}x + ${(q % 6) + 1} = 25`)} for ${inlineMath('x')}.`;
          const ans = (q % 5 === 0)
            ? inlineMath(String(q * 3 + 7))
            : inlineMath('x = \\dfrac{25-b}{a}');
          items.push(makeQuestion({
            id: `sa${q}`,
            label: String(q),
            depth: 0,
            promptHtml: prompt,
            answerHtml: ans,
            workingLines: (q % 5 === 0) ? genShortWorking(seed) : genMediumWorking(seed),
            workingDefaultExpanded: false
          }));

          // include a deep nesting exemplar inside section A
          if (q === 18) {
            items.push(makeQuestion({
              id: 'sa18a',
              label: '18a',
              depth: 1,
              promptHtml: `(a) Find ${inlineMath('2u+5')} when ${inlineMath('u=7')}.`,
              answerHtml: `${inlineMath('19')}`,
              workingLines: [
                { type: 'math', tex: `2\\cdot 7 + 5 = 14 + 5 = 19` }
              ],
              workingDefaultExpanded: false
            }));
            items.push(makeQuestion({
              id: 'sa18a_i',
              label: '18(a)(i)',
              depth: 2,
              promptHtml: `(i) Simplify ${inlineMath('3(2u+5)')}.`,
              answerHtml: `${inlineMath('6u+15')}`,
              workingLines: [
                { type: 'math', tex: `3(2u+5)=6u+15` }
              ],
              workingDefaultExpanded: false
            }));
            items.push(makeQuestion({
              id: 'sa18a_ii',
              label: '18(a)(ii)',
              depth: 2,
              promptHtml: `(ii) Evaluate your expression when ${inlineMath('u=7')}.`,
              answerHtml: `${inlineMath('57')}`,
              workingLines: [
                { type: 'math', tex: `6\\cdot 7 + 15 = 42 + 15 = 57` }
              ],
              workingDefaultExpanded: false
            }));
            items.push(makeQuestion({
              id: 'sa18b',
              label: '18b',
              depth: 1,
              promptHtml: `(b) State one check you could do to confirm your answer.`,
              answerHtml: `<span class="small">Substitute back into the original expression.</span>`,
              workingLines: [
                { type: 'text', text: `Check by substituting u=7 into the original form and compare.` }
              ],
              workingDefaultExpanded: false
            }));
          }
        }

        items.push(makeSection('Section B'));
        for (let q = 1; q <= 8; q++) {
          const seed = (100 + q) * 37;
          const withDiagram = (q % 2 === 0);
          const diag = withDiagram ? diagramTypes[q % diagramTypes.length]() : '';
          items.push(makeQuestion({
            id: `sb${q}`,
            label: String(q),
            depth: 0,
            promptHtml: `${withDiagram ? diag : ''}Find the mean of ${inlineMath(`${q},\\;${q + 2},\\;${q + 4}`)}.`,
            answerHtml: inlineMath(String(q + 2)),
            workingLines: [
              { type: 'math', tex: `\\text{Mean} = \\dfrac{${q}+${q + 2}+${q + 4}}{3} = \\dfrac{${3 * q + 6}}{3} = ${q + 2}` }
            ],
            workingDefaultExpanded: false
          }));
        }

        items.push(makeSection('Section C'));
        for (let q = 1; q <= 6; q++) {
          const seed = (200 + q) * 41;
          const longLines = genExtremelyLongWorking(seed, 60).map(l => {
            if (l.type === 'math') {
              return { type: 'blockmath', tex: l.tex };
            }
            return l;
          });
          items.push(makeQuestion({
            id: `sc${q}`,
            label: String(q),
            depth: 0,
            promptHtml: `A long derivation question. Simplify the expression and justify each step. Include KaTeX blocks as needed.`,
            answerHtml: `<span class="small">${inlineMath('Final\\;answer\\;shown\\;here')}</span>`,
            workingLines: [
              { type: 'text', text: `Workings are long by design (50–60 lines).` },
              { type: 'blockmath', tex: `\\text{Given: } (x+1)^2 = x^2 + 2x + 1` },
              ...longLines
            ],
            workingDefaultExpanded: false
          }));
        }

        return { key: 'sectioned', title: 'Sectioned paper – Sections A/B/C', items };
      }

      const DATASETS = {
        short: buildShortPaper(),
        standard: buildStandardPaper(false),
        standardExpanded: buildStandardPaper(true),
        diagram: buildDiagramHeavyPaper(),
        sectioned: buildSectionedPaper()
      };

      // ---------- Render ----------
      function renderDataset(key) {
        const dataset = DATASETS[key] || DATASETS.short;

        // clear
        elPaperTitle.textContent = dataset.title;
        elPaperBody.innerHTML = '';
        elNavList.innerHTML = '';
        elDrawerList.innerHTML = '';

        // Build paper content
        const frag = document.createDocumentFragment();

        dataset.items.forEach(item => {
          if (item.type === 'section') {
            const s = document.createElement('div');
            s.className = 'section-label';
            s.textContent = item.label;
            frag.appendChild(s);
            return;
          }

          const qEl = document.createElement('section');
          qEl.className = `q depth-${item.depth || 0}`;
          qEl.id = item.id;

          const head = document.createElement('div');
          head.className = 'q-head';

          const num = document.createElement('div');
          num.className = 'q-number';
          num.textContent = item.label;

          const body = document.createElement('div');
          body.className = 'q-body';

          const prompt = document.createElement('p');
          prompt.className = 'prompt';
          prompt.innerHTML = item.promptHtml;

          const answer = document.createElement('p');
          answer.className = 'answer';
          answer.innerHTML = `<span class="label">Answer</span>${item.answerHtml}`;

          const working = document.createElement('div');
          working.className = 'working';

          const controls = document.createElement('div');
          controls.className = 'working-controls';

          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'toggle';

          const workingId = `${item.id}__working`;
          const isExpanded = !!item.workingDefaultExpanded;

          btn.setAttribute('aria-controls', workingId);
          btn.setAttribute('aria-expanded', String(isExpanded));
          btn.textContent = isExpanded ? 'Hide working' : 'Show working';

          const preview = document.createElement('div');
          preview.className = 'working-preview';
          preview.textContent = workingPreviewFromLines(item.workingLines || []);

          const content = document.createElement('div');
          content.className = 'working-content';
          content.id = workingId;
          if (!isExpanded) content.hidden = true;

          // fill working lines
          (item.workingLines || []).forEach(line => {
            if (line.type === 'text') {
              const p = document.createElement('p');
              p.style.margin = '8px 0';
              p.innerHTML = escapeHtml(line.text); // keep text plain
              content.appendChild(p);
            } else if (line.type === 'math') {
              const p = document.createElement('p');
              p.style.margin = '8px 0';
              p.innerHTML = `= ${inlineMath(line.tex)}`;
              content.appendChild(p);
            } else if (line.type === 'blockmath') {
              const div = document.createElement('div');
              div.style.margin = '8px 0';
              div.innerHTML = blockMath(line.tex);
              content.appendChild(div);
            } else {
              const p = document.createElement('p');
              p.style.margin = '8px 0';
              p.textContent = String(line);
              content.appendChild(p);
            }
          });

          // toggle logic (inline only; no cross-question effects)
          btn.addEventListener('click', () => {
            const nowExpanded = btn.getAttribute('aria-expanded') !== 'true';
            btn.setAttribute('aria-expanded', String(nowExpanded));
            btn.textContent = nowExpanded ? 'Hide working' : 'Show working';
            content.hidden = !nowExpanded;

            // preview is visible only when collapsed
            preview.style.display = nowExpanded ? 'none' : 'block';
          });

          // initial preview visibility
          preview.style.display = isExpanded ? 'none' : 'block';

          controls.appendChild(btn);
          working.appendChild(controls);
          working.appendChild(preview);
          working.appendChild(content);

          body.appendChild(prompt);
          body.appendChild(answer);
          body.appendChild(working);

          head.appendChild(num);
          head.appendChild(body);
          qEl.appendChild(head);

          frag.appendChild(qEl);
        });

        elPaperBody.appendChild(frag);

        // Build navigation (question-number-only; section separators are plain text)
        const navFrag = document.createDocumentFragment();
        const drawerFrag = document.createDocumentFragment();

        dataset.items.forEach(item => {
          if (item.type === 'section') {
            const sep = document.createElement('div');
            sep.className = 'nav-sep';
            sep.textContent = item.label;
            navFrag.appendChild(sep);

            const sep2 = document.createElement('div');
            sep2.className = 'nav-sep';
            sep2.textContent = item.label;
            drawerFrag.appendChild(sep2);
            return;
          }

          const a = document.createElement('a');
          a.className = 'nav-item';
          a.href = `#${item.id}`;
          a.textContent = item.label;

          const a2 = document.createElement('a');
          a2.className = 'nav-item';
          a2.href = `#${item.id}`;
          a2.textContent = item.label;

          // click closes drawer (does not change expand/collapse states)
          a2.addEventListener('click', () => {
            closeDrawer();
          });

          navFrag.appendChild(a);
          drawerFrag.appendChild(a2);
        });

        elNavList.appendChild(navFrag);
        elDrawerList.appendChild(drawerFrag);

        // Keyboard scrolling support for nav regions
        attachKeyboardScroll(elNavList);
        attachKeyboardScroll(elDrawerList);

        // Render KaTeX programmatically (with graceful fallback)
        renderKatexIn(document.getElementById('paper'));

        // set up a lightweight "current" highlight based on scroll (subtle)
        setupActiveNav(dataset);
      }

      function attachKeyboardScroll(container) {
        container.addEventListener('keydown', (e) => {
          const key = e.key;
          const delta = (key === 'ArrowDown') ? 40
            : (key === 'ArrowUp') ? -40
              : (key === 'PageDown') ? 240
                : (key === 'PageUp') ? -240
                  : 0;
          if (delta !== 0) {
            e.preventDefault();
            container.scrollTop += delta;
          }
        });
      }

      function renderKatexIn(root) {
        // inline math
        const inlineEls = root.querySelectorAll('.math-inline[data-tex]');
        const blockEls = root.querySelectorAll('.math-block[data-tex]');

        const hasKatex = (typeof window.katex !== 'undefined');

        if (!hasKatex) {
          // leave plain text; do not hide content
          return;
        }

        inlineEls.forEach(el => {
          const tex = el.getAttribute('data-tex') || el.textContent || '';
          try {
            window.katex.render(tex, el, { throwOnError: false, displayMode: false });
          } catch (_e) {
            // fallback: keep existing text
          }
        });

        blockEls.forEach(el => {
          const tex = el.getAttribute('data-tex') || el.textContent || '';
          try {
            window.katex.render(tex, el, { throwOnError: false, displayMode: true });
          } catch (_e) {
            // fallback: keep existing text
          }
        });
      }

      // ---------- Drawer (mobile navigation) ----------
      let lastFocus = null;

      function openDrawer() {
        lastFocus = document.activeElement;
        elDrawer.hidden = false;

        // prevent background interaction while open
        appFrame.setAttribute('aria-hidden', 'true');
        if ('inert' in appFrame) appFrame.inert = true;

        // focus close button (no auto-scrolling)
        btnClose.focus();
        trapFocus(elDrawer.querySelector('.drawer-panel'));
      }

      function closeDrawer() {
        elDrawer.hidden = true;

        appFrame.removeAttribute('aria-hidden');
        if ('inert' in appFrame) appFrame.inert = false;

        releaseFocusTrap();
        if (lastFocus && typeof lastFocus.focus === 'function') lastFocus.focus();
      }

      btnOpenTop.addEventListener('click', openDrawer);
      btnOpenFloat.addEventListener('click', openDrawer);
      btnClose.addEventListener('click', closeDrawer);
      elDrawer.addEventListener('click', (e) => {
        if (e.target && e.target.getAttribute && e.target.getAttribute('data-close') === 'true') {
          closeDrawer();
        }
      });
      window.addEventListener('keydown', (e) => {
        if (!elDrawer.hidden && e.key === 'Escape') {
          e.preventDefault();
          closeDrawer();
        }
      });

      // Focus trap for drawer
      let focusTrapHandler = null;
      function trapFocus(panel) {
        const focusables = () => Array.from(panel.querySelectorAll(
          'a[href], button:not([disabled]), [tabindex]:not([tabindex="-1"])'
        )).filter(el => el.offsetParent !== null);

        focusTrapHandler = (e) => {
          if (e.key !== 'Tab') return;
          const list = focusables();
          if (list.length === 0) return;

          const first = list[0];
          const last = list[list.length - 1];
          if (e.shiftKey && document.activeElement === first) {
            e.preventDefault();
            last.focus();
          } else if (!e.shiftKey && document.activeElement === last) {
            e.preventDefault();
            first.focus();
          }
        };
        panel.addEventListener('keydown', focusTrapHandler);
      }
      function releaseFocusTrap() {
        const panel = elDrawer.querySelector('.drawer-panel');
        if (panel && focusTrapHandler) {
          panel.removeEventListener('keydown', focusTrapHandler);
        }
        focusTrapHandler = null;
      }

      // ---------- Active nav highlight (subtle) ----------
      let activeObserver = null;

      function setupActiveNav(dataset) {
        // clear current
        elNavList.querySelectorAll('.nav-item[aria-current="true"]').forEach(a => a.removeAttribute('aria-current'));
        elDrawerList.querySelectorAll('.nav-item[aria-current="true"]').forEach(a => a.removeAttribute('aria-current'));

        if (activeObserver) {
          activeObserver.disconnect();
          activeObserver = null;
        }

        const ids = dataset.items.filter(it => it.type === 'question').map(it => it.id);
        const targets = ids.map(id => document.getElementById(id)).filter(Boolean);

        activeObserver = new IntersectionObserver((entries) => {
          // find the top-most visible question
          const visible = entries
            .filter(en => en.isIntersecting)
            .sort((a, b) => a.boundingClientRect.top - b.boundingClientRect.top);
          if (visible.length === 0) return;
          const id = visible[0].target.id;

          // update aria-current
          markCurrent(elNavList, id);
          markCurrent(elDrawerList, id);
        }, { root: null, threshold: 0.2 });

        targets.forEach(t => activeObserver.observe(t));
      }

      function markCurrent(container, id) {
        container.querySelectorAll('.nav-item').forEach(a => {
          const is = (a.getAttribute('href') === `#${id}`);
          if (is) a.setAttribute('aria-current', 'true');
          else a.removeAttribute('aria-current');
        });
      }

      // ---------- init ----------
      elSelect.addEventListener('change', () => {
        renderDataset(elSelect.value);
      });

      // initial
      renderDataset(elSelect.value);
    })();
  </script>
</body>

</html>