<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>RTQ – Maths Paper Solution Viewer (Prototype)</title>

    <!-- KaTeX (Real KaTeX Rendering add-on) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" crossorigin="anonymous">

    <style>
        :root {
            /* Soft-warm neutral base (subtle) */
            --page: #f6f4ef;
            --surface: #fbfaf7;
            --ink: #1e1e1e;
            --muted: #4a4a4a;
            --quiet: #6a6a6a;
            --hairline: rgba(0, 0, 0, .10);
            --hairline2: rgba(0, 0, 0, .08);
            --accent: #2a5aa6;
            /* restrained, non-semantic */
            --focus: rgba(42, 90, 166, .55);

            --frameMax: 1040px;
            --gutter: 18px;

            --navW: 148px;

            /* Rhythm */
            --qGap: 26px;
            --withinQ: 10px;
            --tight: 8px;
            --micro: 6px;

            --lh: 1.55;
            --lhTight: 1.42;

            --indentStep: 18px;
        }

        * {
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
        }

        body {
            margin: 0;
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
            background: var(--page);
            color: var(--ink);
            line-height: var(--lh);
            overflow-x: hidden;
            /* page-level horizontal scroll must never happen */
        }

        /* Top control area aligned with frame */
        header {
            position: sticky;
            top: 0;
            z-index: 10;
            background: var(--page);
            border-bottom: 1px solid var(--hairline2);
        }

        .topbar {
            max-width: var(--frameMax);
            margin: 0 auto;
            padding: 10px var(--gutter);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .topbar label {
            font-size: 13px;
            color: var(--quiet);
            white-space: nowrap;
        }

        select {
            font-size: 14px;
            padding: 7px 10px;
            border: 1px solid var(--hairline);
            border-radius: 8px;
            background: var(--surface);
            color: var(--ink);
            min-width: 220px;
            max-width: 100%;
        }

        select:focus {
            outline: 2px solid var(--focus);
            outline-offset: 2px;
        }

        .jumpBtn {
            margin-left: auto;
            font-size: 14px;
            padding: 7px 10px;
            border: 1px solid transparent;
            background: transparent;
            color: var(--accent);
            text-decoration: underline;
            text-underline-offset: 3px;
            cursor: pointer;
            border-radius: 10px;
        }

        .jumpBtn:hover {
            color: var(--accent);
        }

        .jumpBtn:focus {
            outline: 2px solid var(--focus);
            outline-offset: 2px;
            text-decoration: none;
        }

        /* Frame: nav + content on same base surface (unified) */
        .frame {
            max-width: var(--frameMax);
            margin: 0 auto;
            padding: 14px var(--gutter) 36px var(--gutter);
        }

        .surface {
            background: var(--surface);
            border: 1px solid var(--hairline2);
            border-radius: 14px;
            padding: 16px;
        }

        .layout {
            display: flex;
            gap: 20px;
            align-items: flex-start;
            min-width: 0;
        }

        nav {
            width: var(--navW);
            flex: 0 0 var(--navW);
            color: var(--quiet);
            font-size: 13px;
            line-height: 1.4;
        }

        /* Sticky nav rail (Navigation Persistence add-on) */
        .navSticky {
            position: sticky;
            top: 58px;
            /* below sticky header */
            max-height: calc(100vh - 58px - 22px);
        }

        .navList {
            margin: 0;
            padding: 0;
            list-style: none;
            overflow-y: auto;
            /* only if exceeds viewport */
            max-height: inherit;
            scrollbar-width: none;
            /* Firefox */
            -ms-overflow-style: none;
            /* legacy */
        }

        .navList::-webkit-scrollbar {
            display: none;
        }

        /* WebKit/Blink */

        .navSection {
            margin: 10px 0 6px 0;
            padding-top: 6px;
            border-top: 1px solid var(--hairline2);
            font-size: 12px;
            letter-spacing: .04em;
            text-transform: none;
            color: var(--quiet);
            user-select: none;
        }

        .navItem {
            display: block;
            width: 100%;
            text-align: left;
            border: 0;
            padding: 6px 0;
            margin: 0;
            background: transparent;
            color: var(--quiet);
            cursor: pointer;
            border-radius: 10px;
            font: inherit;
            text-decoration: none;
        }

        .navItem:hover {
            text-decoration: underline;
            text-underline-offset: 3px;
        }

        .navItem:focus {
            outline: 2px solid var(--focus);
            outline-offset: 2px;
            text-decoration: none;
        }

        .navItem[aria-current="true"] {
            font-weight: 600;
            color: var(--ink);
        }

        .navItem[aria-current="true"]::before {
            content: "•";
            color: var(--accent);
            margin-right: 6px;
        }

        main {
            flex: 1 1 auto;
            min-width: 0;
        }

        /* Paper content typography + hierarchy */
        .paperTitle {
            margin: 0 0 16px 0;
            font-size: 15px;
            font-weight: 600;
            color: var(--muted);
        }

        .paper {
            display: block;
            min-width: 0;
        }

        .sectionLabel {
            margin: 22px 0 12px 0;
            padding-top: 14px;
            border-top: 1px solid var(--hairline);
            font-size: 13px;
            font-weight: 600;
            color: var(--muted);
        }

        .q {
            margin-top: var(--qGap);
            padding-top: 0;
        }

        .q:first-child {
            margin-top: 0;
        }

        /* NESTING via indentation + subtle spacing, no containers */
        .q[data-depth="0"] {
            margin-left: 0;
        }

        .q[data-depth="1"] {
            margin-left: calc(var(--indentStep) * 1);
            margin-top: 18px;
        }

        .q[data-depth="2"] {
            margin-left: calc(var(--indentStep) * 2);
            margin-top: 14px;
        }

        .q[data-depth="3"] {
            margin-left: calc(var(--indentStep) * 3);
            margin-top: 12px;
        }

        .q[data-depth="4"] {
            margin-left: calc(var(--indentStep) * 4);
            margin-top: 10px;
        }

        .qHead {
            display: flex;
            gap: 10px;
            align-items: flex-start;
            min-width: 0;
        }

        .qid {
            flex: 0 0 auto;
            font-size: 13px;
            color: var(--muted);
            padding-top: 2px;
            user-select: none;
        }

        .qPrompt {
            flex: 1 1 auto;
            min-width: 0;
            font-size: 16px;
            color: var(--ink);
            line-height: 1.6;
        }

        /* Markdown content baseline */
        .md p {
            margin: 0 0 10px 0;
        }

        .md p:last-child {
            margin-bottom: 0;
        }

        .md ul,
        .md ol {
            margin: 0 0 10px 22px;
            padding: 0;
        }

        .md li {
            margin: 4px 0;
        }

        .md table {
            border-collapse: collapse;
            width: 100%;
            margin: 10px 0;
            font-size: 14px;
            color: var(--muted);
        }

        .md th,
        .md td {
            border: 1px solid var(--hairline2);
            padding: 8px 10px;
            vertical-align: top;
        }

        .md th {
            font-weight: 600;
            color: var(--muted);
            background: transparent;
        }

        /* Inline SVG diagrams as-authored, keep grayscale feel */
        .md svg {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 10px 0;
        }

        .answerRow {
            margin-top: var(--withinQ);
            display: flex;
            gap: 10px;
            align-items: baseline;
            min-width: 0;
        }

        .answerLabel {
            flex: 0 0 auto;
            font-size: 13px;
            font-weight: 600;
            color: var(--muted);
        }

        .answerVal {
            flex: 1 1 auto;
            min-width: 0;
            font-size: 15px;
            color: var(--muted);
            line-height: 1.5;
        }

        .toggleRow {
            margin-top: var(--tight);
        }

        .toggleBtn {
            font-size: 14px;
            border: 0;
            padding: 4px 0;
            background: transparent;
            color: var(--accent);
            cursor: pointer;
            text-decoration: underline;
            text-underline-offset: 3px;
            border-radius: 10px;
        }

        .toggleBtn:hover {
            text-decoration-thickness: 2px;
        }

        .toggleBtn:focus {
            outline: 2px solid var(--focus);
            outline-offset: 2px;
            text-decoration: none;
        }

        .toggleBtn .chev {
            display: inline-block;
            width: 1em;
            margin-right: 4px;
            color: var(--accent);
        }

        /* Solution details: subtle surface separation (quiet) */
        .details {
            margin-top: var(--tight);
            padding-top: 10px;
            border-top: 1px solid var(--hairline2);
            background: rgba(0, 0, 0, .02);
            padding-left: 12px;
            padding-right: 12px;
            padding-bottom: 12px;
            /* no border/radius/shadow to avoid panels; this is a gentle continuation */
        }

        .details[hidden] {
            display: none;
        }

        .detailsInner {
            color: var(--muted);
            font-size: 14px;
            line-height: var(--lhTight);
        }

        .subsec {
            margin-top: 12px;
        }

        .subsec:first-child {
            margin-top: 0;
        }

        .subLabel {
            font-size: 13px;
            font-weight: 600;
            color: var(--muted);
            margin: 0 0 6px 0;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Keep in mind: slightly more prominent than working body, but below Answer */
        .keep .detailsInner {
            color: #3f3f3f;
        }

        .keep .subLabel::before {
            content: "ⓘ";
            font-size: 12px;
            color: var(--quiet);
            transform: translateY(-.5px);
        }

        .keepBody {
            border-left: 1px solid var(--hairline);
            padding-left: 10px;
        }

        .formulas {
            margin-top: 12px;
        }

        .divider {
            margin: 12px 0;
            border-top: 1px solid var(--hairline2);
        }

        /* Working / Alternative working (no internal panels) */
        .working,
        .altWorking {
            margin-top: 12px;
        }

        /* KaTeX containment invariant */
        .katex,
        .katex * {
            max-width: 100%;
        }

        .katex-display {
            max-width: 100%;
            overflow-x: auto;
            /* only display math can scroll horizontally */
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
            margin: 10px 0;
        }

        .katex-display::-webkit-scrollbar {
            display: none;
        }

        /* Underlay exception (display-math only within Working & Alternative working) */
        .working .katex-display,
        .altWorking .katex-display {
            background: rgba(0, 0, 0, .03);
            padding: 6px 8px;
            /* no border, no radius, no shadow */
        }

        /* Tables overflow containment */
        .tableWrap {
            max-width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
            margin: 10px 0;
        }

        .tableWrap::-webkit-scrollbar {
            display: none;
        }

        /* Ensure main document never scrolls horizontally */
        .paper,
        .surface,
        .layout,
        main {
            overflow-x: hidden;
        }

        /* Drawer for mobile navigation */
        .scrim {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .25);
            display: none;
            z-index: 50;
        }

        .drawer {
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            width: min(320px, 86vw);
            background: var(--surface);
            border-right: 1px solid var(--hairline);
            transform: translateX(-100%);
            transition: transform 160ms ease;
            z-index: 60;
            padding: 14px 14px 10px 14px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .drawerHeader {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .drawerTitle {
            margin: 0;
            font-size: 14px;
            font-weight: 600;
            color: var(--muted);
        }

        .closeBtn {
            font-size: 14px;
            padding: 6px 10px;
            border: 1px solid transparent;
            background: transparent;
            color: var(--accent);
            text-decoration: underline;
            text-underline-offset: 3px;
            border-radius: 10px;
            cursor: pointer;
        }

        .closeBtn:focus {
            outline: 2px solid var(--focus);
            outline-offset: 2px;
            text-decoration: none;
        }

        .drawerNav {
            flex: 1 1 auto;
            overflow-y: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
            padding-right: 4px;
        }

        .drawerNav::-webkit-scrollbar {
            display: none;
        }

        /* Responsive rules */
        @media (max-width: 860px) {
            .layout {
                gap: 14px;
            }

            nav {
                width: 120px;
                flex-basis: 120px;
            }

            :root {
                --navW: 120px;
            }
        }

        @media (max-width: 740px) {

            /* Mobile: hide desktop nav rail; use drawer */
            nav {
                display: none;
            }

            .jumpBtn {
                display: inline-block;
            }

            .surface {
                padding: 14px;
            }

            .qPrompt {
                font-size: 16px;
            }

            .qid {
                font-size: 13px;
            }

            .answerVal {
                font-size: 15px;
            }

            .details {
                padding-left: 10px;
                padding-right: 10px;
            }
        }

        @media (min-width: 741px) {
            .jumpBtn {
                display: none;
            }
        }

        @media (prefers-reduced-motion: reduce) {
            .drawer {
                transition: none;
            }

            html:focus-within {
                scroll-behavior: auto;
            }
        }

        @media (prefers-reduced-motion: no-preference) {
            html:focus-within {
                scroll-behavior: smooth;
            }

            /* navigation-triggered jumps */
        }

        /* Deterministic failure display */
        .missing {
            font-size: 16px;
            color: var(--muted);
            padding: 18px 0;
            letter-spacing: .02em;
        }

        /* Focus trap sentinel (invisible but focusable if needed) */
        .srOnly {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
    </style>
</head>

<body>
    <header>
        <div class="topbar" role="region" aria-label="Paper controls">
            <label for="paperSelect">Paper</label>
            <select id="paperSelect" aria-label="Paper selector">
                <option>Loading…</option>
            </select>

            <!-- Mobile only -->
            <button id="jumpBtn" class="jumpBtn" type="button" aria-haspopup="dialog" aria-controls="navDrawer">
                Jump to
            </button>
        </div>
    </header>

    <div class="frame">
        <div class="surface">
            <div class="layout">
                <nav aria-label="Paper navigation">
                    <div class="navSticky">
                        <ul id="navList" class="navList" aria-label="Question list"></ul>
                    </div>
                </nav>

                <main id="main" tabindex="-1">
                    <div id="paperTitle" class="paperTitle"></div>
                    <div id="paper" class="paper" aria-label="Paper content"></div>
                </main>
            </div>
        </div>
    </div>

    <!-- Mobile drawer -->
    <div id="scrim" class="scrim" hidden></div>
    <div id="navDrawer" class="drawer" role="dialog" aria-modal="true" aria-label="Jump to question" hidden>
        <div class="drawerHeader">
            <h2 class="drawerTitle">Jump to</h2>
            <button id="closeDrawer" class="closeBtn" type="button">Close</button>
        </div>
        <div id="drawerNav" class="drawerNav" tabindex="0"></div>
        <div class="srOnly" tabindex="0" id="trapEnd">End</div>
    </div>

    <!-- Markdown renderer (Deterministic Payload add-on) -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.1.0/dist/markdown-it.min.js"
        crossorigin="anonymous"></script>

    <!-- KaTeX JS + auto-render -->
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"
        crossorigin="anonymous"></script>

    <script>
        // ===== CANONICAL CONSTANT — PAPERS PAYLOAD PATH (v1.0) =====
        // Single source of truth for payload path; reference this constant only.
        const RTQ_PAPERS_PAYLOAD_PATH = "../../payload/rtq.papers.payload.json";

        // Markdown-it: HTML passthrough + TeX backslash preservation.
        const md = window.markdownit({
            html: true,
            linkify: false,
            breaks: false
        });
        // Required: do not escape TeX backslashes (prevents KaTeX corruption).
        if (md && md.inline && md.inline.ruler) {
            try { md.inline.ruler.disable(['escape']); } catch (_) { }
        }

        const els = {
            select: document.getElementById('paperSelect'),
            navList: document.getElementById('navList'),
            paper: document.getElementById('paper'),
            title: document.getElementById('paperTitle'),
            jumpBtn: document.getElementById('jumpBtn'),
            scrim: document.getElementById('scrim'),
            drawer: document.getElementById('navDrawer'),
            closeDrawer: document.getElementById('closeDrawer'),
            drawerNav: document.getElementById('drawerNav'),
            main: document.getElementById('main')
        };

        let payload = null;
        let currentPaperIndex = 0;
        let observer = null;
        let currentActiveId = null;

        function safeText(s) {
            return (s == null) ? "" : String(s);
        }

        function setMissing() {
            els.select.innerHTML = "";
            const opt = document.createElement('option');
            opt.textContent = "Papers payload missing";
            els.select.appendChild(opt);
            els.select.disabled = true;
            els.title.textContent = "";
            els.navList.innerHTML = "";
            els.paper.innerHTML = '<div class="missing">PAPERS PAYLOAD MISSING</div>';
        }

        async function loadPayload() {
            try {
                const res = await fetch(RTQ_PAPERS_PAYLOAD_PATH, { cache: "no-store" });
                if (!res.ok) throw new Error("Bad response");
                const json = await res.json();
                if (!json || !Array.isArray(json.papers)) throw new Error("Invalid schema");
                payload = json;
            } catch (e) {
                payload = null;
            }
        }

        function buildSelector() {
            els.select.innerHTML = "";
            payload.papers.forEach((p, i) => {
                const opt = document.createElement('option');
                opt.value = String(i);
                opt.textContent = safeText(p.label || p.key || ("Paper " + (i + 1)));
                els.select.appendChild(opt);
            });
            els.select.disabled = false;
            els.select.value = String(currentPaperIndex);
        }

        function normalizePaper(p) {
            const out = {
                key: safeText(p.key),
                label: safeText(p.label),
                defaults: p.defaults && typeof p.defaults === "object" ? p.defaults : { expandedAll: false },
                sections: Array.isArray(p.sections) ? p.sections : null,
                questions: Array.isArray(p.questions) ? p.questions : null
            };
            return out;
        }

        function flattenNavItemsFromQuestion(q, arr) {
            const id = safeText(q.id);
            if (id) arr.push({ type: "item", id });
            if (Array.isArray(q.children)) {
                q.children.forEach(child => flattenNavItemsFromQuestion(child, arr));
            }
        }

        function buildNavModel(paper) {
            const items = [];
            if (paper.sections) {
                paper.sections.forEach(sec => {
                    const label = safeText(sec.label);
                    if (label) items.push({ type: "section", label });
                    (sec.questions || []).forEach(q => flattenNavItemsFromQuestion(q, items));
                });
            } else {
                (paper.questions || []).forEach(q => flattenNavItemsFromQuestion(q, items));
            }
            return items;
        }

        function renderNav(items) {
            // Desktop rail
            els.navList.innerHTML = "";
            items.forEach(it => {
                if (it.type === "section") {
                    const li = document.createElement('li');
                    li.className = "navSection";
                    li.textContent = it.label;
                    els.navList.appendChild(li);
                    return;
                }
                const li = document.createElement('li');
                const btn = document.createElement('button');
                btn.className = "navItem";
                btn.type = "button";
                btn.textContent = it.id;
                btn.dataset.targetId = it.id;
                btn.addEventListener('click', () => jumpTo(it.id));
                li.appendChild(btn);
                els.navList.appendChild(li);
            });

            // Mobile drawer content (same semantics)
            els.drawerNav.innerHTML = "";
            const ul = document.createElement('ul');
            ul.className = "navList";
            ul.setAttribute("aria-label", "Question list");
            items.forEach(it => {
                if (it.type === "section") {
                    const li = document.createElement('li');
                    li.className = "navSection";
                    li.textContent = it.label;
                    ul.appendChild(li);
                    return;
                }
                const li = document.createElement('li');
                const btn = document.createElement('button');
                btn.className = "navItem";
                btn.type = "button";
                btn.textContent = it.id;
                btn.dataset.targetId = it.id;
                btn.addEventListener('click', () => {
                    closeDrawer();
                    jumpTo(it.id);
                });
                li.appendChild(btn);
                ul.appendChild(li);
            });
            els.drawerNav.appendChild(ul);
        }

        function mdToHtml(markdown) {
            return md.render(safeText(markdown));
        }

        function wrapTables(root) {
            const tables = root.querySelectorAll('table');
            tables.forEach(t => {
                if (t.closest('.tableWrap')) return;
                const wrap = document.createElement('div');
                wrap.className = "tableWrap";
                t.parentNode.insertBefore(wrap, t);
                wrap.appendChild(t);
            });
        }

        function renderKatexIfAvailable(container) {
            // If KaTeX fails to load, fall back to plain text (do not hide content).
            if (!window.renderMathInElement) return;
            try {
                window.renderMathInElement(container, {
                    delimiters: [
                        { left: "$$", right: "$$", display: true },
                        { left: "$", right: "$", display: false }
                    ],
                    throwOnError: false
                });
            } catch (_) { }
        }

        function attachDisclosure(qEl, detailsEl, btn, expanded) {
            function setState(isExpanded) {
                detailsEl.hidden = !isExpanded;
                btn.setAttribute('aria-expanded', isExpanded ? "true" : "false");
                btn.querySelector('.lbl').textContent = isExpanded ? "Hide working" : "Show working";
                btn.querySelector('.chev').textContent = isExpanded ? "▾" : "▸";
            }
            setState(expanded);

            btn.addEventListener('click', () => {
                const next = detailsEl.hidden; // if hidden -> expand
                setState(next);
            });
        }

        function renderSolutionDetails(q, expandedByDefault) {
            const sd = q.solutionDetails;
            if (!sd || typeof sd !== "object") return null;

            const details = document.createElement('div');
            details.className = "details";
            details.hidden = !expandedByDefault;

            const inner = document.createElement('div');
            inner.className = "detailsInner";
            details.appendChild(inner);

            // Keep in mind (optional)
            if (sd.keepInMind != null && safeText(sd.keepInMind).trim() !== "") {
                const block = document.createElement('div');
                block.className = "subsec keep";
                const label = document.createElement('div');
                label.className = "subLabel";
                label.textContent = "Keep in mind";
                const body = document.createElement('div');
                body.className = "md keepBody";
                body.innerHTML = mdToHtml(sd.keepInMind);
                block.appendChild(label);
                block.appendChild(body);
                inner.appendChild(block);
            }

            // Formulas used (optional)
            if (sd.formulasUsed != null && safeText(sd.formulasUsed).trim() !== "") {
                const block = document.createElement('div');
                block.className = "subsec formulas";
                const label = document.createElement('div');
                label.className = "subLabel";
                label.textContent = "Formulas used";
                const body = document.createElement('div');
                body.className = "md";
                body.innerHTML = mdToHtml(sd.formulasUsed);
                block.appendChild(label);
                block.appendChild(body);
                inner.appendChild(block);

                // Optional quiet divider before Working if Working exists
                if ((sd.working != null && safeText(sd.working).trim() !== "") ||
                    (sd.alternativeWorking != null && safeText(sd.alternativeWorking).trim() !== "")) {
                    const div = document.createElement('div');
                    div.className = "divider";
                    inner.appendChild(div);
                }
            }

            // Working (primary)
            if (sd.working != null && safeText(sd.working).trim() !== "") {
                const block = document.createElement('div');
                block.className = "subsec working";
                const label = document.createElement('div');
                label.className = "subLabel";
                label.textContent = "Working";
                const body = document.createElement('div');
                body.className = "md";
                body.innerHTML = mdToHtml(sd.working);
                block.appendChild(label);
                block.appendChild(body);
                inner.appendChild(block);
            }

            // Alternative working (0+)
            if (sd.alternativeWorking != null && safeText(sd.alternativeWorking).trim() !== "") {
                const block = document.createElement('div');
                block.className = "subsec altWorking";
                const label = document.createElement('div');
                label.className = "subLabel";
                label.textContent = "Alternative working";
                const body = document.createElement('div');
                body.className = "md";
                body.innerHTML = mdToHtml(sd.alternativeWorking);
                block.appendChild(label);
                block.appendChild(body);
                inner.appendChild(block);
            }

            // Post-process: table wrappers + KaTeX
            wrapTables(details);
            renderKatexIfAvailable(details);

            return details;
        }

        function renderQuestionNode(q, depth, expandedAll) {
            const qid = safeText(q.id);
            const qEl = document.createElement('section');
            qEl.className = "q";
            qEl.dataset.depth = String(Math.min(depth, 4));
            if (qid) qEl.id = "q-" + cssSafeId(qid);

            const head = document.createElement('div');
            head.className = "qHead";

            const idEl = document.createElement('div');
            idEl.className = "qid";
            idEl.textContent = qid;

            const prompt = document.createElement('div');
            prompt.className = "qPrompt md";
            prompt.innerHTML = mdToHtml(q.question);

            head.appendChild(idEl);
            head.appendChild(prompt);
            qEl.appendChild(head);

            // Answer (visible by default)
            const ans = document.createElement('div');
            ans.className = "answerRow";
            const al = document.createElement('div');
            al.className = "answerLabel";
            al.textContent = "Answer";
            const av = document.createElement('div');
            av.className = "answerVal md";
            av.innerHTML = mdToHtml(q.answer);
            ans.appendChild(al);
            ans.appendChild(av);
            qEl.appendChild(ans);

            // Ensure markdown tables and KaTeX inside question + answer
            wrapTables(qEl);
            renderKatexIfAvailable(qEl);

            // Solution Details toggle + block (only if present)
            const hasSD = q.solutionDetails && typeof q.solutionDetails === "object";
            if (hasSD) {
                const toggleRow = document.createElement('div');
                toggleRow.className = "toggleRow";

                const btn = document.createElement('button');
                btn.type = "button";
                btn.className = "toggleBtn";
                btn.setAttribute('aria-expanded', expandedAll ? "true" : "false");
                btn.innerHTML = '<span class="chev" aria-hidden="true"></span><span class="lbl"></span>';

                toggleRow.appendChild(btn);
                qEl.appendChild(toggleRow);

                const details = renderSolutionDetails(q, !!expandedAll);
                if (details) {
                    qEl.appendChild(details);
                    attachDisclosure(qEl, details, btn, !!expandedAll);
                }
            }

            // Children
            if (Array.isArray(q.children) && q.children.length) {
                q.children.forEach(child => {
                    qEl.appendChild(renderQuestionNode(child, depth + 1, expandedAll));
                });
            }

            return qEl;
        }

        function cssSafeId(s) {
            // Minimal stable transformation for DOM IDs; do not infer nesting from id.
            return safeText(s).replace(/\s+/g, '').replace(/[^\w\-\(\)\[\]]/g, '_');
        }

        function renderPaper(paper) {
            // Clear any old observer
            if (observer) {
                observer.disconnect();
                observer = null;
            }
            currentActiveId = null;

            const expandedAll = !!(paper.defaults && paper.defaults.expandedAll);

            // Title (quiet)
            els.title.textContent = safeText(paper.label || paper.key);

            // Paper content
            els.paper.innerHTML = "";

            if (paper.sections) {
                paper.sections.forEach(sec => {
                    const lbl = safeText(sec.label);
                    if (lbl) {
                        const h = document.createElement('div');
                        h.className = "sectionLabel";
                        h.textContent = lbl;
                        els.paper.appendChild(h);
                    }
                    (sec.questions || []).forEach(q => {
                        els.paper.appendChild(renderQuestionNode(q, 0, expandedAll));
                    });
                });
            } else {
                (paper.questions || []).forEach(q => {
                    els.paper.appendChild(renderQuestionNode(q, 0, expandedAll));
                });
            }

            // Build navigation
            const navModel = buildNavModel(paper);
            renderNav(navModel);

            // Activate scroll tracking
            setupActiveTracking(navModel);

            // Reset to top (natural, no forced focus movement)
            // Do not auto-scroll beyond typical user action; paper switching is explicit.
            window.scrollTo({ top: 0, behavior: (prefersReducedMotion() ? "auto" : "smooth") });
        }

        function prefersReducedMotion() {
            return window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
        }

        function jumpTo(qid) {
            const target = document.getElementById("q-" + cssSafeId(qid));
            if (!target) return;
            target.scrollIntoView({ block: "start", inline: "nearest", behavior: prefersReducedMotion() ? "auto" : "smooth" });
        }

        function setupActiveTracking(navModel) {
            const ids = navModel.filter(x => x.type === "item").map(x => x.id);
            const targets = ids
                .map(id => document.getElementById("q-" + cssSafeId(id)))
                .filter(Boolean);

            // Set initial current to first visible if any
            setActive(ids[0] || null);

            observer = new IntersectionObserver((entries) => {
                // Pick the entry closest to top that is intersecting
                const visible = entries
                    .filter(e => e.isIntersecting)
                    .sort((a, b) => Math.abs(a.boundingClientRect.top) - Math.abs(b.boundingClientRect.top));
                if (!visible.length) return;
                const el = visible[0].target;
                const id = (el.id || "").replace(/^q-/, "");
                // Map back to original qid by matching target ids
                const match = ids.find(qid => ("q-" + cssSafeId(qid)) === el.id);
                if (match) setActive(match);
            }, {
                root: null,
                rootMargin: "-18% 0px -70% 0px",
                threshold: [0.01, 0.2]
            });

            targets.forEach(t => observer.observe(t));
        }

        function setActive(qid) {
            if (qid === currentActiveId) return;
            currentActiveId = qid;

            // Desktop nav
            els.navList.querySelectorAll('.navItem').forEach(btn => {
                btn.setAttribute('aria-current', btn.dataset.targetId === qid ? "true" : "false");
            });

            // Drawer nav
            els.drawerNav.querySelectorAll('.navItem').forEach(btn => {
                btn.setAttribute('aria-current', btn.dataset.targetId === qid ? "true" : "false");
            });
        }

        // Drawer controls (mobile)
        function openDrawer() {
            els.scrim.hidden = false;
            els.scrim.style.display = "block";
            els.drawer.hidden = false;
            // Lock background scroll without creating nested scroll for paper content
            document.body.style.overflow = "hidden";
            requestAnimationFrame(() => {
                els.drawer.style.transform = "translateX(0)";
            });
            // Focus first nav item if possible, else close
            const firstBtn = els.drawer.querySelector('.navItem');
            (firstBtn || els.closeDrawer).focus({ preventScroll: true });
        }

        function closeDrawer() {
            els.drawer.style.transform = "translateX(-100%)";
            els.scrim.style.display = "none";
            els.scrim.hidden = true;
            els.drawer.hidden = true;
            document.body.style.overflow = "";
            // Return focus to Jump to (no forced focus movement during reading; this is direct response to close)
            els.jumpBtn.focus({ preventScroll: true });
        }

        function trapFocus(e) {
            if (els.drawer.hidden) return;
            if (e.key !== "Tab") return;

            const focusables = els.drawer.querySelectorAll('button, [href], [tabindex]:not([tabindex="-1"])');
            const list = Array.from(focusables).filter(el => !el.disabled && el.offsetParent !== null);
            if (!list.length) return;

            const first = list[0];
            const last = list[list.length - 1];

            if (e.shiftKey && document.activeElement === first) {
                e.preventDefault();
                last.focus();
            } else if (!e.shiftKey && document.activeElement === last) {
                e.preventDefault();
                first.focus();
            }
        }

        function wireEvents() {
            els.select.addEventListener('change', () => {
                const idx = parseInt(els.select.value, 10);
                if (Number.isFinite(idx)) {
                    currentPaperIndex = idx;
                    const p = normalizePaper(payload.papers[currentPaperIndex]);
                    renderPaper(p);
                }
            });

            els.jumpBtn.addEventListener('click', () => openDrawer());
            els.closeDrawer.addEventListener('click', () => closeDrawer());
            els.scrim.addEventListener('click', () => closeDrawer());

            document.addEventListener('keydown', (e) => {
                if (e.key === "Escape" && !els.drawer.hidden) {
                    e.preventDefault();
                    closeDrawer();
                }
                trapFocus(e);
            });
        }

        async function init() {
            wireEvents();
            await loadPayload();
            if (!payload) {
                setMissing();
                return;
            }

            buildSelector();
            const p = normalizePaper(payload.papers[currentPaperIndex]);
            renderPaper(p);
        }

        init();
    </script>
</body>

</html>