<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>RTQ – Maths Paper Solution Viewer (Stress Test)</title>

    <!-- KaTeX (Real Rendering Add-on) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"
        crossorigin="anonymous"></script>

    <!-- Markdown-it (Deterministic Payload Add-on) -->

    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.1.0/dist/markdown-it.min.js"
        crossorigin="anonymous"></script>

    <style>
        :root {
            /* Soft-warm neutral base (subtle) */
            --bg: #f6f4f0;
            --surface: #fbfaf7;
            --ink: #1e1f20;
            --muted: #5a5d61;
            --quiet: #7a7f86;
            --hairline: rgba(0, 0, 0, 0.10);
            --hairline2: rgba(0, 0, 0, 0.08);

            /* Restrained accent (non-semantic; non-content emphasis only) */
            --accent: #3b5f7a;
            --focus: rgba(59, 95, 122, 0.55);

            --frame-max: 1040px;

            --space-xxl: 44px;
            /* between top-level questions (largest) */
            --space-xl: 28px;
            --space-lg: 18px;
            --space-md: 12px;
            --space-sm: 8px;
            --space-xs: 6px;

            --nav-w: 120px;
            --radius-none: 0px;
        }

        * {
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
        }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--ink);
            overflow-x: hidden;
            /* never allow page-level horizontal scroll */
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
            line-height: 1.45;
        }

        /* Top controls */
        header {
            position: sticky;
            top: 0;
            z-index: 20;
            background: color-mix(in srgb, var(--bg) 92%, white 8%);
            border-bottom: 1px solid var(--hairline2);
        }

        .frame {
            max-width: var(--frame-max);
            margin: 0 auto;
            padding: 0 18px;
        }

        .topbar {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 0;
        }

        .topbar label {
            font-size: 13px;
            color: var(--muted);
            white-space: nowrap;
        }

        select {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            border: 1px solid var(--hairline);
            background: var(--surface);
            color: var(--ink);
            padding: 8px 30px 8px 10px;
            font-size: 14px;
            border-radius: 6px;
            line-height: 1.2;
            max-width: min(520px, 100%);
        }

        .select-wrap {
            position: relative;
            display: inline-flex;
            align-items: center;
            flex: 1 1 auto;
            min-width: 0;
        }

        .select-wrap::after {
            content: "▾";
            position: absolute;
            right: 10px;
            color: var(--quiet);
            pointer-events: none;
            font-size: 12px;
            transform: translateY(1px);
        }

        .jump-btn {
            border: 1px solid var(--hairline);
            background: var(--surface);
            color: var(--accent);
            /* non-content UI: allowed */
            padding: 8px 10px;
            font-size: 14px;
            border-radius: 8px;
            line-height: 1.2;
        }

        .jump-btn:active {
            transform: translateY(1px);
        }

        .jump-btn:hover {
            text-decoration: underline;
        }

        .jump-btn:focus-visible {
            outline: 2px solid var(--focus);
            outline-offset: 2px;
        }

        /* Desktop layout: navigation + paper content inside one centered frame */
        .layout {
            display: grid;
            grid-template-columns: var(--nav-w) 1fr;
            gap: 28px;
            padding-top: 18px;
            padding-bottom: 56px;
            background: var(--surface);
            /* unified surface across nav + content (inside frame) */
            border-left: 1px solid var(--hairline2);
            border-right: 1px solid var(--hairline2);
            min-height: calc(100vh - 48px);
        }

        nav[aria-label="Questions"] {
            padding-top: 6px;
            padding-left: 2px;
            padding-right: 10px;
        }

        /* Sticky nav rail persistence */
        .nav-rail {
            position: sticky;
            top: 58px;
            /* below topbar */
            align-self: start;
            max-height: calc(100vh - 70px);
            /* allows independent scroll ONLY when overflow */
        }

        .nav-scroll {
            overflow-y: auto;
            /* only scrolls if exceeds viewport height */
            max-height: inherit;
            padding: 6px 6px 10px 2px;
            outline: none;
            scrollbar-width: none;
            /* Firefox */
            -ms-overflow-style: none;
            /* legacy */
        }

        .nav-scroll::-webkit-scrollbar {
            display: none;
        }

        /* WebKit/Blink */

        .nav-section {
            font-size: 12px;
            color: var(--quiet);
            margin: 10px 0 6px;
            user-select: none;
        }

        .nav-item {
            display: block;
            width: 100%;
            text-align: left;
            background: transparent;
            border: 0;
            padding: 6px 8px 6px 10px;
            margin: 0;
            font-size: 13px;
            color: color-mix(in srgb, var(--muted) 85%, var(--ink) 15%);
            cursor: pointer;
            border-left: 2px solid transparent;
            /* active marker slot */
        }

        .nav-item:hover {
            text-decoration: underline;
            /* single minimal change */
        }

        .nav-item:focus-visible {
            outline: 2px solid var(--focus);
            outline-offset: 2px;
            border-radius: 8px;
        }

        .nav-item[aria-current="true"] {
            font-weight: 600;
            /* cue 1 */
            border-left-color: var(--accent);
            /* cue 2 (allowed in non-content UI) */
            color: var(--ink);
            text-decoration: none;
        }

        /* Paper content */
        main {
            padding: 0 18px 0 0;
            min-width: 0;
        }

        .paper-title {
            font-size: 14px;
            color: var(--quiet);
            margin: 6px 0 18px;
        }

        /* Question blocks – whitespace-driven grouping */
        .q-block {
            margin: 0 0 var(--space-xxl);
        }

        .q-block.depth-0 {
            margin-bottom: var(--space-xxl);
        }

        .q-block.depth-1 {
            margin-bottom: var(--space-xl);
        }

        .q-block.depth-2 {
            margin-bottom: var(--space-lg);
        }

        .q-block.depth-3 {
            margin-bottom: var(--space-lg);
        }

        /* Indentation for nesting – subtle, no container */
        .q-indent {
            padding-left: 0;
            margin-left: 0;
        }

        .depth-1>.q-indent {
            padding-left: 18px;
        }

        .depth-2>.q-indent {
            padding-left: 34px;
        }

        .depth-3>.q-indent {
            padding-left: 46px;
        }

        .q-head {
            display: flex;
            gap: 10px;
            align-items: baseline;
            margin-bottom: var(--space-sm);
        }

        .q-id {
            font-size: 14px;
            color: var(--muted);
            flex: 0 0 auto;
            min-width: 60px;
            text-align: right;
            padding-top: 2px;
        }

        .q-text {
            font-size: 16px;
            line-height: 1.55;
            /* generous for question */
            color: var(--ink);
            min-width: 0;
        }

        .answer {
            display: grid;
            grid-template-columns: 64px 1fr;
            gap: 10px;
            align-items: start;
            margin-top: var(--space-md);
            margin-bottom: var(--space-sm);
        }

        .answer .label {
            font-size: 12px;
            color: var(--muted);
            font-weight: 600;
            /* label only */
            text-align: right;
            padding-top: 3px;
        }

        .answer .body {
            font-size: 14px;
            color: color-mix(in srgb, var(--ink) 82%, var(--muted) 18%);
            line-height: 1.45;
            min-width: 0;
        }

        /* Disclosure control: text-first, not button-like */
        .toggle-row {
            display: grid;
            grid-template-columns: 64px 1fr;
            gap: 10px;
            align-items: start;
            margin: 0 0 var(--space-sm);
        }

        .toggle-spacer {
            height: 1px;
        }

        .toggle {
            justify-self: start;
            border: 0;
            background: transparent;
            padding: 6px 0;
            margin: 0;
            font-size: 14px;
            color: color-mix(in srgb, var(--muted) 90%, var(--ink) 10%);
            cursor: pointer;
            text-align: left;
            display: inline-flex;
            gap: 8px;
            align-items: center;
        }

        .toggle .chev {
            font-size: 12px;
            color: var(--quiet);
            transform: translateY(1px);
        }

        .toggle:hover {
            text-decoration: underline;
            /* single minimal change */
        }

        .toggle:focus-visible {
            outline: 2px solid var(--focus);
            outline-offset: 2px;
            border-radius: 8px;
        }

        /* Solution Details surface separation – light, subordinate, no box feel */
        .solution {
            margin-top: 6px;
            padding: 12px 0 2px;
            background: color-mix(in srgb, var(--surface) 92%, var(--bg) 8%);
            border-top: 1px solid var(--hairline2);
            /* hairline only */
        }

        .sol-inner {
            display: grid;
            grid-template-columns: 64px 1fr;
            gap: 10px;
            align-items: start;
            padding-top: 2px;
        }

        .sol-spacer {
            height: 1px;
        }

        .sol-body {
            font-size: 14px;
            color: color-mix(in srgb, var(--muted) 70%, var(--ink) 30%);
            line-height: 1.42;
            /* slightly tighter than question */
            min-width: 0;
        }

        .sol-section {
            margin: 0 0 var(--space-md);
        }

        .sol-section:last-child {
            margin-bottom: 0;
        }

        .sol-label {
            font-size: 12px;
            font-weight: 600;
            /* label only */
            color: var(--muted);
            margin: 0 0 var(--space-xs);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        /* Keep in mind: slightly more prominent than working body, but below Answer */
        .keep .sol-body {
            color: color-mix(in srgb, var(--muted) 55%, var(--ink) 45%);
        }

        .keep .sol-label::before {
            content: "●";
            font-size: 10px;
            color: color-mix(in srgb, var(--muted) 50%, var(--quiet) 50%);
            transform: translateY(-1px);
        }

        /* Formulas used: quieter */
        .formulas .sol-body {
            color: color-mix(in srgb, var(--muted) 78%, var(--ink) 22%);
        }

        /* Optional hairline divider between formulas and working (quiet) */
        .divider {
            height: 1px;
            background: var(--hairline2);
            margin: 10px 0 12px;
            width: min(520px, 100%);
        }

        /* Markdown content styling (quiet, structural) */
        .md> :first-child {
            margin-top: 0;
        }

        .md> :last-child {
            margin-bottom: 0;
        }

        .md p {
            margin: 0 0 10px;
        }

        .md ul,
        .md ol {
            margin: 0 0 10px 18px;
            padding: 0;
        }

        .md li {
            margin: 4px 0;
        }

        .md hr {
            border: 0;
            border-top: 1px solid var(--hairline2);
            margin: 12px 0;
        }

        /* Tables (minimal, structural) + overflow only within table itself */
        .md table {
            border-collapse: collapse;
            width: max-content;
            max-width: 100%;
            display: block;
            overflow-x: auto;
            /* horizontal scroll permitted only for table */
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .md table::-webkit-scrollbar {
            display: none;
        }

        .md th,
        .md td {
            border: 1px solid var(--hairline2);
            padding: 8px 10px;
            font-size: 13px;
            color: color-mix(in srgb, var(--muted) 70%, var(--ink) 30%);
            vertical-align: top;
            background: transparent;
        }

        .md th {
            font-weight: 600;
            /* header weight only */
            color: color-mix(in srgb, var(--muted) 55%, var(--ink) 45%);
        }

        /* Inline SVG diagrams should render naturally */
        .md svg {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 10px 0;
        }

        /* KaTeX containment invariant */
        .katex,
        .katex * {
            max-width: 100%;
        }

        .katex-display {
            max-width: 100%;
            overflow-x: auto;
            /* allowed only inside math block */
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .katex-display::-webkit-scrollbar {
            display: none;
        }

        .katex-display>.katex {
            max-width: 100%;
            display: inline-block;
            /* ensures scroll stays inside the block */
        }

        /* Display-math underlay exception: ONLY inside Working / Alternative working */
        .working-body .katex-display,
        .altworking-body .katex-display {
            background: rgba(0, 0, 0, 0.035);
            /* extremely subtle underlay */
            padding: 8px 10px;
            margin: 10px 0;
            border: 0;
            border-radius: var(--radius-none);
            box-shadow: none;
        }

        /* Ensure inline math never receives background (explicit) */
        .katex {
            background: transparent !important;
        }

        /* Links (rare; from payload) – quiet, not semantic */
        .md a {
            color: var(--accent);
            text-decoration: underline;
            text-underline-offset: 2px;
        }

        .md a:focus-visible {
            outline: 2px solid var(--focus);
            outline-offset: 2px;
            border-radius: 6px;
        }

        /* Mobile / tablet */
        @media (max-width: 900px) {
            .layout {
                grid-template-columns: 1fr;
                gap: 0;
                padding-top: 14px;
                border-left: 0;
                border-right: 0;
                background: var(--surface);
            }

            nav[aria-label="Questions"] {
                display: none;
                /* drawer baseline */
            }

            main {
                padding: 0 0 0 0;
            }

            .q-id {
                min-width: 44px;
                text-align: left;
            }

            .answer,
            .toggle-row,
            .sol-inner {
                grid-template-columns: 44px 1fr;
            }

            .jump-btn {
                display: inline-flex;
            }
        }

        @media (min-width: 901px) {
            .jump-btn {
                display: none;
            }
        }

        /* Drawer (mobile) */
        .drawer-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.20);
            z-index: 40;
            display: none;
        }

        .drawer {
            position: fixed;
            top: 0;
            right: 0;
            width: min(320px, 90vw);
            height: 100vh;
            background: color-mix(in srgb, var(--surface) 96%, var(--bg) 4%);
            z-index: 50;
            border-left: 1px solid var(--hairline2);
            display: none;
            padding: 10px 10px 16px;
        }

        .drawer header {
            position: sticky;
            top: 0;
            background: transparent;
            border-bottom: 1px solid var(--hairline2);
            padding: 10px 6px 10px;
            z-index: 1;
        }

        .drawer-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        .drawer-title span {
            font-size: 13px;
            color: var(--muted);
            font-weight: 600;
        }

        .drawer-close {
            border: 1px solid var(--hairline);
            background: var(--surface);
            color: var(--muted);
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 13px;
        }

        .drawer-close:hover {
            text-decoration: underline;
        }

        .drawer-close:focus-visible {
            outline: 2px solid var(--focus);
            outline-offset: 2px;
        }

        .drawer .nav-scroll {
            max-height: calc(100vh - 60px);
            padding-top: 10px;
        }

        /* Reduce motion */
        @media (prefers-reduced-motion: reduce) {
            html:focus-within {
                scroll-behavior: auto;
            }
        }
    </style>
</head>

<body>
    <header>
        <div class="frame">
            <div class="topbar" role="region" aria-label="Paper controls">
                <label for="paperSelect">Paper</label>
                <div class="select-wrap">
                    <select id="paperSelect" aria-label="Paper selector"></select>
                </div>
                <button id="jumpBtn" class="jump-btn" type="button" aria-haspopup="dialog"
                    aria-controls="navDrawer">Jump to</button>
            </div>
        </div>
    </header>

    <div class="frame layout" role="presentation">
        <nav aria-label="Questions">
            <div class="nav-rail">
                <div id="navList" class="nav-scroll" tabindex="0"></div>
            </div>
        </nav>

        <main id="paperMain">
            <!-- paper content injected here -->
        </main>
    </div>

    <!-- Mobile drawer -->
    <div id="drawerOverlay" class="drawer-overlay" hidden></div>
    <div id="navDrawer" class="drawer" role="dialog" aria-modal="true" aria-label="Jump to question" hidden>
        <header>
            <div class="drawer-title">
                <span>Jump to</span>
                <button id="drawerClose" class="drawer-close" type="button">Close</button>
            </div>
        </header>
        <div id="drawerNav" class="nav-scroll" tabindex="0"></div>
    </div>

    <script>
        // === Canonical constant: single source of truth ===
        const RTQ_PAPERS_PAYLOAD_PATH = "../../payload/rtq.papers.payload.json";

        (function () {
            const paperSelect = document.getElementById('paperSelect');
            const paperMain = document.getElementById('paperMain');
            const navList = document.getElementById('navList');

            const jumpBtn = document.getElementById('jumpBtn');
            const navDrawer = document.getElementById('navDrawer');
            const drawerNav = document.getElementById('drawerNav');
            const drawerOverlay = document.getElementById('drawerOverlay');
            const drawerClose = document.getElementById('drawerClose');

            let payload = null;
            let currentPaperIndex = 0;
            let currentObserver = null;
            let questionIdToEl = new Map();
            let navButtons = [];
            let drawerButtons = [];

            function prefersReducedMotion() {
                return window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
            }

            function smoothScrollTo(el) {
                if (!el) return;
                const behavior = prefersReducedMotion() ? 'auto' : 'smooth';
                el.scrollIntoView({ behavior, block: 'start', inline: 'nearest' });
            }

            function clearActiveNav() {
                navButtons.forEach(b => b.setAttribute('aria-current', 'false'));
                drawerButtons.forEach(b => b.setAttribute('aria-current', 'false'));
            }

            function setActiveNav(targetKey) {
                clearActiveNav();
                navButtons.forEach(b => { if (b.dataset.targetKey === targetKey) b.setAttribute('aria-current', 'true'); });
                drawerButtons.forEach(b => { if (b.dataset.targetKey === targetKey) b.setAttribute('aria-current', 'true'); });
            }

            function openDrawer() {
                drawerOverlay.hidden = false;
                navDrawer.hidden = false;
                drawerOverlay.style.display = 'block';
                navDrawer.style.display = 'block';
                // Trap background interaction by inerting main frame
                document.querySelector('.layout').setAttribute('aria-hidden', 'true');
                drawerClose.focus();
            }

            function closeDrawer() {
                drawerOverlay.hidden = true;
                navDrawer.hidden = true;
                drawerOverlay.style.display = 'none';
                navDrawer.style.display = 'none';
                document.querySelector('.layout').removeAttribute('aria-hidden');
                jumpBtn.focus();
            }

            jumpBtn.addEventListener('click', openDrawer);
            drawerClose.addEventListener('click', closeDrawer);
            drawerOverlay.addEventListener('click', closeDrawer);
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && !navDrawer.hidden) closeDrawer();
            });

            function initMarkdown() {
                const md = window.markdownit({
                    html: true,
                    linkify: true,
                    breaks: false
                });
                // TeX backslash preservation: disable inline escape rule (required)
                if (md && md.inline && md.inline.ruler && md.inline.ruler.disable) {
                    md.inline.ruler.disable(['escape']);
                }
                return md;
            }

            const md = initMarkdown();

            function mdToHtml(markdown) {
                if (typeof markdown !== 'string') return '';
                return md.render(markdown);
            }

            function runKaTeX(container) {
                // If KaTeX fails to load, fall back gracefully to plain text HTML (already rendered by markdown)
                if (!window.renderMathInElement || !window.katex) return;
                try {
                    window.renderMathInElement(container, {
                        delimiters: [
                            { left: "$$", right: "$$", display: true },
                            { left: "$", right: "$", display: false }
                        ],
                        throwOnError: false
                    });
                } catch (_e) {
                    // No-op: keep rendered markdown text as-is
                }
            }

            function makeEl(tag, cls, attrs) {
                const el = document.createElement(tag);
                if (cls) el.className = cls;
                if (attrs) {
                    for (const [k, v] of Object.entries(attrs)) {
                        if (v === null || v === undefined) continue;
                        el.setAttribute(k, String(v));
                    }
                }
                return el;
            }

            function hasSolutionDetails(q) {
                return !!(q && q.solutionDetails && (
                    q.solutionDetails.keepInMind || q.solutionDetails.formulasUsed ||
                    q.solutionDetails.working || q.solutionDetails.alternativeWorking
                ));
            }

            function renderSolutionDetails(sol, expandedByDefault) {
                const wrap = makeEl('div', 'solution');
                wrap.hidden = !expandedByDefault;

                const inner = makeEl('div', 'sol-inner');
                inner.appendChild(makeEl('div', 'sol-spacer'));
                const body = makeEl('div', 'sol-body');

                // Keep in mind (optional)
                if (sol.keepInMind) {
                    const section = makeEl('section', 'sol-section keep');
                    const label = makeEl('div', 'sol-label');
                    label.textContent = 'Keep in mind';
                    const content = makeEl('div', 'md');
                    content.innerHTML = mdToHtml(sol.keepInMind);
                    section.appendChild(label);
                    section.appendChild(content);
                    body.appendChild(section);
                }

                // Formulas used (optional)
                if (sol.formulasUsed) {
                    const section = makeEl('section', 'sol-section formulas');
                    const label = makeEl('div', 'sol-label');
                    label.textContent = 'Formulas used';
                    const content = makeEl('div', 'md');
                    content.innerHTML = mdToHtml(sol.formulasUsed);
                    section.appendChild(label);
                    section.appendChild(content);
                    body.appendChild(section);
                    // Optional divider before Working (quiet)
                    if (sol.working || sol.alternativeWorking) {
                        body.appendChild(makeEl('div', 'divider', { 'aria-hidden': 'true' }));
                    }
                }

                // Working (primary)
                if (sol.working) {
                    const section = makeEl('section', 'sol-section working');
                    const label = makeEl('div', 'sol-label');
                    label.textContent = 'Working';
                    const content = makeEl('div', 'md working-body');
                    content.innerHTML = mdToHtml(sol.working);
                    section.appendChild(label);
                    section.appendChild(content);
                    body.appendChild(section);
                }

                // Alternative working (0+ in payload; here single field per schema)
                if (sol.alternativeWorking) {
                    const section = makeEl('section', 'sol-section altworking');
                    const label = makeEl('div', 'sol-label');
                    label.textContent = 'Alternative working';
                    const content = makeEl('div', 'md altworking-body');
                    content.innerHTML = mdToHtml(sol.alternativeWorking);
                    section.appendChild(label);
                    section.appendChild(content);
                    body.appendChild(section);
                }

                inner.appendChild(body);
                wrap.appendChild(inner);
                return wrap;
            }

            function renderQuestionNode(q, depth, expandedAll) {
                const block = makeEl('section', `q-block depth-${Math.min(depth, 3)}`, { 'data-qid': q.id });

                const indentWrap = makeEl('div', 'q-indent');
                block.appendChild(indentWrap);

                // Question header: id + prompt
                const head = makeEl('div', 'q-head');
                const qid = makeEl('div', 'q-id');
                qid.textContent = q.id; // no "Q" prefix
                const qtext = makeEl('div', 'q-text md');
                qtext.innerHTML = mdToHtml(q.question || '');
                head.appendChild(qid);
                head.appendChild(qtext);
                indentWrap.appendChild(head);

                // Answer (always visible)
                const ans = makeEl('div', 'answer');
                const ansLabel = makeEl('div', 'label');
                ansLabel.textContent = 'Answer';
                const ansBody = makeEl('div', 'body md');
                ansBody.innerHTML = mdToHtml(q.answer || '');
                ans.appendChild(ansLabel);
                ans.appendChild(ansBody);
                indentWrap.appendChild(ans);

                // Solution Details toggle (if present)
                let solWrap = null;
                if (hasSolutionDetails(q)) {
                    const toggleRow = makeEl('div', 'toggle-row');
                    toggleRow.appendChild(makeEl('div', 'toggle-spacer'));
                    const btn = makeEl('button', 'toggle', { type: 'button', 'aria-expanded': String(!!expandedAll) });
                    const chev = makeEl('span', 'chev', { 'aria-hidden': 'true' });
                    chev.textContent = expandedAll ? '▾' : '▸';
                    const label = makeEl('span', 'label');
                    label.textContent = expandedAll ? 'Hide working' : 'Show working';
                    btn.appendChild(chev);
                    btn.appendChild(label);

                    solWrap = renderSolutionDetails(q.solutionDetails || {}, !!expandedAll);

                    const solId = `sol-${cssSafeId(q.id)}-${Math.random().toString(16).slice(2)}`;
                    solWrap.id = solId;
                    btn.setAttribute('aria-controls', solId);

                    btn.addEventListener('click', () => {
                        const willExpand = solWrap.hidden;
                        solWrap.hidden = !willExpand;
                        btn.setAttribute('aria-expanded', String(willExpand));
                        chev.textContent = willExpand ? '▾' : '▸';
                        label.textContent = willExpand ? 'Hide working' : 'Show working';
                        // No forced focus movement, no auto scroll.
                        // Re-run KaTeX on newly revealed content for stability.
                        if (willExpand) {
                            runKaTeX(solWrap);
                        }
                    });

                    toggleRow.appendChild(btn);
                    indentWrap.appendChild(toggleRow);
                    indentWrap.appendChild(solWrap);
                }

                // Children
                if (Array.isArray(q.children) && q.children.length) {
                    q.children.forEach(child => {
                        indentWrap.appendChild(renderQuestionNode(child, depth + 1, expandedAll));
                    });
                }

                // KaTeX pass after markdown render; expanded blocks rendered too (safe)
                runKaTeX(block);
                return block;
            }

            function cssSafeId(str) {
                return String(str)
                    .replace(/\s+/g, '-')
                    .replace(/[^\w\-\(\)\[\]]+/g, '_');
            }

            function flattenNav(paper) {
                // Returns array of {type:'section'|'q', label, key, depth}
                const out = [];
                function walk(q, depth) {
                    out.push({ type: 'q', label: q.id, key: q.id, depth });
                    if (Array.isArray(q.children)) {
                        q.children.forEach(ch => walk(ch, depth + 1));
                    }
                }
                if (Array.isArray(paper.sections)) {
                    paper.sections.forEach(sec => {
                        out.push({ type: 'section', label: sec.label });
                        (sec.questions || []).forEach(q => walk(q, 0));
                    });
                } else {
                    (paper.questions || []).forEach(q => walk(q, 0));
                }
                return out;
            }

            function buildNav(listEl, items) {
                listEl.innerHTML = '';
                const buttons = [];
                items.forEach(item => {
                    if (item.type === 'section') {
                        const sep = makeEl('div', 'nav-section');
                        sep.textContent = item.label;
                        listEl.appendChild(sep);
                    } else {
                        const btn = makeEl('button', 'nav-item', {
                            type: 'button',
                            'aria-current': 'false',
                            'data-target-key': item.key
                        });
                        btn.dataset.targetKey = item.key;
                        btn.textContent = item.label;

                        // Subtle indentation in nav for hierarchy (still identifiers only)
                        const pad = 10 + Math.min(item.depth, 3) * 10;
                        btn.style.paddingLeft = pad + 'px';

                        btn.addEventListener('click', () => {
                            const target = questionIdToEl.get(item.key);
                            if (target) smoothScrollTo(target);
                            if (!navDrawer.hidden) closeDrawer();
                        });

                        listEl.appendChild(btn);
                        buttons.push(btn);
                    }
                });
                return buttons;
            }

            function observeActiveQuestion() {
                if (currentObserver) currentObserver.disconnect();
                const entries = Array.from(questionIdToEl.entries()).map(([key, el]) => ({ key, el }));
                const rootMargin = '-40% 0px -55% 0px'; // bias toward top-mid for "current position"
                currentObserver = new IntersectionObserver((obsEntries) => {
                    const visible = obsEntries
                        .filter(e => e.isIntersecting)
                        .map(e => ({ key: e.target.getAttribute('data-qid'), top: e.boundingClientRect.top }))
                        .sort((a, b) => a.top - b.top);
                    if (visible.length) {
                        setActiveNav(visible[0].key);
                    }
                }, { root: null, threshold: [0.01, 0.1], rootMargin });

                entries.forEach(({ el }) => currentObserver.observe(el));
            }

            function renderPaper(paper) {
                paperMain.innerHTML = '';
                navList.innerHTML = '';
                drawerNav.innerHTML = '';
                questionIdToEl.clear();
                navButtons = [];
                drawerButtons = [];

                const title = makeEl('div', 'paper-title');
                title.textContent = paper.label || '';
                paperMain.appendChild(title);

                const expandedAll = !!(paper.defaults && paper.defaults.expandedAll);

                const paperContainer = makeEl('div', 'paper');

                function renderTopQuestions(questions) {
                    (questions || []).forEach(q => {
                        const qEl = renderQuestionNode(q, 0, expandedAll);
                        paperContainer.appendChild(qEl);
                        // register for nav jump + active tracking
                        questionIdToEl.set(q.id, qEl);
                    });
                }

                if (Array.isArray(paper.sections)) {
                    paper.sections.forEach(sec => {
                        const secLabel = makeEl('div', 'paper-title');
                        secLabel.textContent = String(sec.label || '');
                        paperContainer.appendChild(secLabel);
                        renderTopQuestions(sec.questions);
                    });
                } else {
                    renderTopQuestions(paper.questions);
                }

                paperMain.appendChild(paperContainer);

                const navItems = flattenNav(paper);
                navButtons = buildNav(navList, navItems);
                drawerButtons = buildNav(drawerNav, navItems);

                observeActiveQuestion();
                // Ensure KaTeX pass on entire paper (safe)
                runKaTeX(paperMain);
            }

            function setSelectorOptions(papers) {
                paperSelect.innerHTML = '';
                papers.forEach((p, idx) => {
                    const opt = document.createElement('option');
                    opt.value = String(idx);
                    opt.textContent = p.label || p.key || `Paper ${idx + 1}`;
                    paperSelect.appendChild(opt);
                });
                paperSelect.value = String(currentPaperIndex);
            }

            function renderMissing() {
                // Deterministic failure mode: shell + controls; content area must render exactly text below.
                paperSelect.innerHTML = '';
                navList.innerHTML = '';
                drawerNav.innerHTML = '';
                paperMain.textContent = 'PAPERS PAYLOAD MISSING';
            }

            async function loadPayload() {
                try {
                    const res = await fetch(RTQ_PAPERS_PAYLOAD_PATH, { cache: 'no-store' });
                    if (!res.ok) throw new Error('fetch failed');
                    const json = await res.json();
                    if (!json || !Array.isArray(json.papers)) throw new Error('invalid schema');
                    payload = json;

                    setSelectorOptions(payload.papers);

                    paperSelect.addEventListener('change', () => {
                        const idx = Number(paperSelect.value);
                        if (Number.isNaN(idx) || idx < 0 || idx >= payload.papers.length) return;
                        currentPaperIndex = idx;
                        renderPaper(payload.papers[currentPaperIndex]);
                    });

                    // initial render (first paper, in order)
                    currentPaperIndex = 0;
                    renderPaper(payload.papers[0]);

                } catch (_e) {
                    renderMissing();
                }
            }

            loadPayload();
        })();
    </script>
</body>

</html>