<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>RTQ – Maths Paper Solution Viewer (Stress-Test Harness)</title>

    <!-- Real KaTeX Rendering (CDN) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js" crossorigin="anonymous"></script>

    <style>
        :root {
            /* Stage 4 surface semantics (grayscale, calm, functional) */
            --page-bg: #e9e9e9;
            --frame-bg: #fbfbfb;
            --text: #111;
            --muted: #444;
            --quiet: #666;
            --hairline: #d4d4d4;
            --soft: #f3f3f3;

            --frame-max: 1120px;
            --gutter: 18px;
            --nav-w: 150px;

            --q-gap-0: 26px;
            /* largest spacing unit between top-level questions */
            --q-gap-1: 18px;
            --q-gap-2: 14px;

            --within-gap: 8px;
            /* tighter spacing within a question */
            --line: 1.55;
            --line-tight: 1.45;

            --radius: 10px;
            /* gentle, non-cardlike */
        }

        * {
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
        }

        body {
            margin: 0;
            background: var(--page-bg);
            color: var(--text);
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
            line-height: var(--line);
            overflow-x: hidden;
            /* page must never scroll horizontally */
        }

        /* Top controls aligned to frame */
        .topbar {
            position: sticky;
            top: 0;
            z-index: 50;
            background: var(--page-bg);
            border-bottom: 1px solid var(--hairline);
        }

        .topbar-inner {
            max-width: var(--frame-max);
            margin: 0 auto;
            padding: 10px var(--gutter);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .controls {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            min-width: 0;
        }

        label {
            font-size: 13px;
            color: var(--muted);
        }

        select {
            font-size: 14px;
            padding: 8px 10px;
            border: 1px solid var(--hairline);
            border-radius: 8px;
            background: #fff;
            color: var(--text);
            max-width: 100%;
        }

        .jump-btn {
            font-size: 14px;
            padding: 8px 10px;
            border: 1px solid var(--hairline);
            border-radius: 8px;
            background: #fff;
            color: var(--text);
            cursor: pointer;
            white-space: nowrap;
        }

        .jump-btn:focus-visible,
        select:focus-visible,
        .sd-toggle:focus-visible,
        .nav a:focus-visible,
        .drawer a:focus-visible,
        .drawer button:focus-visible {
            outline: 2px solid #000;
            outline-offset: 2px;
        }

        /* Centered frame containing nav + paper content, unified surface */
        .frame {
            max-width: var(--frame-max);
            margin: 0 auto;
            padding: 0 var(--gutter) 40px var(--gutter);
        }

        .frame-surface {
            background: var(--frame-bg);
            border: 1px solid var(--hairline);
            border-radius: var(--radius);
            padding: 16px 12px;
        }

        .grid {
            display: grid;
            grid-template-columns: var(--nav-w) 1fr;
            gap: 18px;
            align-items: start;
        }

        /* Navigation rail (quiet, documentation-style) */
        nav.nav {
            position: sticky;
            /* Add-on: Navigation Persistence */
            top: 56px;
            /* below topbar */
            align-self: start;
            max-height: calc(100vh - 72px);
            overflow-y: auto;
            /* allowed only when exceeds viewport */
            padding-right: 6px;

            /* Add-on: Scrollable Navigation Without Visible Scrollbars */
            scrollbar-width: none;
            /* Firefox */
            -ms-overflow-style: none;
            /* legacy */
        }

        nav.nav::-webkit-scrollbar {
            display: none;
        }

        /* WebKit/Blink */

        .nav .nav-title {
            font-size: 12px;
            color: var(--quiet);
            margin: 0 0 8px 0;
            letter-spacing: 0.02em;
        }

        .nav .nav-list {
            list-style: none;
            margin: 0;
            padding: 0;
            display: grid;
            gap: 2px;
        }

        .nav .sep {
            margin: 10px 0 6px 0;
            font-size: 12px;
            color: var(--muted);
            letter-spacing: 0.06em;
            text-transform: uppercase;
        }

        .nav a {
            display: block;
            text-decoration: none;
            color: var(--quiet);
            font-size: 13px;
            padding: 6px 6px;
            border-radius: 6px;
        }

        .nav a:hover {
            text-decoration: underline;
            /* affordance without colour meaning */
        }

        .nav a[aria-current="true"] {
            color: var(--text);
            font-weight: 700;
            /* allowed for current nav item */
            text-decoration: none;
            background: var(--soft);
            /* subtle surface shift */
        }

        /* Paper content column */
        main {
            min-width: 0;
            /* allow wrapping */
        }

        .paper-title {
            font-size: 16px;
            margin: 0 0 6px 0;
            color: var(--text);
        }

        .paper-sub {
            font-size: 13px;
            margin: 0 0 18px 0;
            color: var(--quiet);
        }

        /* Section headers (structural dividers, not containers) */
        .section {
            margin: 18px 0 10px 0;
            padding: 0;
        }

        .section .section-label {
            font-size: 12px;
            color: var(--muted);
            letter-spacing: 0.10em;
            text-transform: uppercase;
            margin: 0 0 6px 0;
        }

        /* Question blocks: whitespace rhythm, no cards/panels */
        .question {
            scroll-margin-top: 72px;
            /* keep anchored below topbar */
        }

        .q-depth-0 {
            margin-top: var(--q-gap-0);
        }

        .q-depth-1 {
            margin-top: var(--q-gap-1);
        }

        .q-depth-2 {
            margin-top: var(--q-gap-2);
        }

        .q-wrap {
            padding: 0;
            /* no container feel */
            min-width: 0;
        }

        .q-head {
            display: flex;
            gap: 10px;
            align-items: baseline;
            min-width: 0;
        }

        .q-id {
            flex: 0 0 auto;
            font-size: 14px;
            color: var(--muted);
            min-width: 42px;
            text-align: right;
        }

        .q-prompt {
            flex: 1 1 auto;
            min-width: 0;
            font-size: 16px;
            /* question text is primary anchor */
            color: var(--text);
            line-height: 1.6;
        }

        .q-prompt p {
            margin: 0 0 8px 0;
        }

        .q-prompt p:last-child {
            margin-bottom: 0;
        }

        /* Indentation for nesting (no borders) */
        .q-depth-1 .q-wrap {
            padding-left: 18px;
        }

        .q-depth-2 .q-wrap {
            padding-left: 34px;
        }

        /* Mobile: reduce indentation to preserve reading width */
        @media (max-width: 520px) {
            :root {
                --nav-w: 0px;
            }

            .grid {
                grid-template-columns: 1fr;
            }

            nav.nav {
                display: none;
            }

            .q-id {
                min-width: 34px;
            }

            .q-depth-1 .q-wrap {
                padding-left: 12px;
            }

            .q-depth-2 .q-wrap {
                padding-left: 18px;
            }
        }

        /* Answer block: visible by default, tertiary emphasis */
        .answer {
            margin-top: var(--within-gap);
            display: flex;
            gap: 10px;
            align-items: baseline;
            min-width: 0;
        }

        .answer .a-label {
            font-size: 12px;
            color: var(--muted);
            min-width: 52px;
            text-align: right;
            font-weight: 700;
            /* allowed for labels */
        }

        .answer .a-value {
            font-size: 14px;
            color: var(--text);
            min-width: 0;
            line-height: 1.5;
        }

        /* Disclosure control semantics */
        .sd-toggle-row {
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sd-toggle {
            font-size: 14px;
            padding: 8px 10px;
            border: 1px solid var(--hairline);
            border-radius: 8px;
            background: #fff;
            cursor: pointer;
            color: var(--text);
        }

        .sd-toggle:hover {
            text-decoration: underline;
        }

        .sd-toggle .chev {
            display: inline-block;
            width: 10px;
            text-align: center;
            margin-right: 6px;
            color: var(--muted);
        }

        /* Solution Details: subordinate, integrated continuation */
        .solution {
            margin-top: 10px;
            padding: 10px 10px 10px 10px;
            background: #f6f6f6;
            /* subtle surface differentiation */
            border-radius: 8px;
        }

        .solution[hidden] {
            display: none;
        }

        .sd-block {
            margin: 10px 0 0 0;
        }

        .sd-block:first-child {
            margin-top: 0;
        }

        .sd-title {
            font-size: 12px;
            color: var(--muted);
            font-weight: 700;
            margin: 0 0 6px 0;
        }

        .sd-body {
            font-size: 13px;
            color: var(--text);
            line-height: var(--line-tight);
        }

        .sd-body p {
            margin: 0 0 8px 0;
        }

        .sd-body p:last-child {
            margin-bottom: 0;
        }

        /* Working lines: continuous, no tiles */
        .sd-line {
            margin: 6px 0;
            font-size: 13px;
            color: var(--text);
            line-height: var(--line-tight);
            min-width: 0;
        }

        /* KaTeX containment invariant */
        .math-inline {
            display: inline-block;
            max-width: 100%;
            vertical-align: baseline;
        }

        .math-block {
            max-width: 100%;
            overflow-x: auto;
            /* horizontal scrolling permitted ONLY within math block */
            overflow-y: hidden;
            padding: 6px 8px;
            background: transparent;
            /* no tiled panel feel */
            border-radius: 6px;

            scrollbar-width: thin;
            /* keep functional; visible is OK inside math container */
        }

        .math-block .katex-display {
            margin: 0;
            /* prevent huge vertical gaps */
        }

        /* Ensure KaTeX never widens parent */
        .math-block,
        .math-block * {
            max-width: 100%;
        }

        /* Inline SVG diagrams */
        .diagram {
            margin-top: 10px;
            max-width: 100%;
        }

        .diagram svg {
            width: 100%;
            height: auto;
            display: block;
            border: 1px solid var(--hairline);
            /* light, diagram-boundary only */
            border-radius: 8px;
            background: #fff;
        }

        /* Drawer (mobile/tablet) */
        .drawer-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.25);
            display: none;
            z-index: 100;
        }

        .drawer-backdrop.open {
            display: block;
        }

        .drawer {
            position: fixed;
            top: 0;
            right: 0;
            width: min(340px, 86vw);
            height: 100%;
            background: var(--frame-bg);
            border-left: 1px solid var(--hairline);
            padding: 14px 12px;
            transform: translateX(100%);
            transition: none;
            /* no animated transitions */
            z-index: 110;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .drawer.open {
            transform: translateX(0);
        }

        .drawer .drawer-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .drawer .drawer-title {
            font-size: 13px;
            color: var(--muted);
            margin: 0;
            letter-spacing: 0.02em;
        }

        .drawer .close-btn {
            font-size: 14px;
            padding: 8px 10px;
            border: 1px solid var(--hairline);
            border-radius: 8px;
            background: #fff;
            cursor: pointer;
        }

        .drawer .drawer-nav {
            overflow-y: auto;
            padding-right: 6px;

            /* hide scrollbar visually but keep scrolling functional */
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .drawer .drawer-nav::-webkit-scrollbar {
            display: none;
        }

        .drawer ul {
            list-style: none;
            margin: 0;
            padding: 0;
            display: grid;
            gap: 2px;
        }

        .drawer a {
            display: block;
            text-decoration: none;
            color: var(--quiet);
            font-size: 14px;
            padding: 8px 8px;
            border-radius: 8px;
        }

        .drawer a:hover {
            text-decoration: underline;
        }

        .drawer a[aria-current="true"] {
            color: var(--text);
            font-weight: 700;
            background: var(--soft);
            text-decoration: none;
        }

        .drawer .sep {
            margin: 10px 0 6px 0;
            font-size: 12px;
            color: var(--muted);
            letter-spacing: 0.10em;
            text-transform: uppercase;
        }

        body.no-scroll {
            overflow: hidden;
        }

        /* Reduce motion preference respected (we don't animate anyway) */
        @media (prefers-reduced-motion: reduce) {
            * {
                scroll-behavior: auto !important;
            }
        }
    </style>
</head>

<body>
    <header class="topbar" role="banner">
        <div class="topbar-inner">
            <div class="controls">
                <label for="paperSelect">Paper</label>
                <select id="paperSelect" aria-label="Paper Selector"></select>
            </div>
            <button class="jump-btn" id="jumpBtn" type="button" aria-haspopup="dialog" aria-controls="drawerBackdrop">
                Jump to
            </button>
        </div>
    </header>

    <div class="frame" id="appFrame">
        <div class="frame-surface">
            <div class="grid">
                <nav class="nav" aria-label="Document navigation">
                    <p class="nav-title">Questions</p>
                    <div id="navMount"></div>
                </nav>

                <main id="paperMount" tabindex="-1">
                    <!-- paper renders here -->
                </main>
            </div>
        </div>
    </div>

    <!-- Drawer (overlay navigation for smaller screens) -->
    <div class="drawer-backdrop" id="drawerBackdrop" role="presentation"></div>
    <div class="drawer" id="drawer" role="dialog" aria-modal="true" aria-label="Jump to question">
        <div class="drawer-top">
            <p class="drawer-title">Questions</p>
            <button class="close-btn" id="drawerClose" type="button">Close</button>
        </div>
        <div class="drawer-nav" id="drawerNavMount"></div>
    </div>

    <script>
        (function () {
            // ---------- Utilities ----------
            function escapeHtml(str) {
                return String(str)
                    .replaceAll("&", "&amp;")
                    .replaceAll("<", "&lt;")
                    .replaceAll(">", "&gt;")
                    .replaceAll('"', "&quot;")
                    .replaceAll("'", "&#39;");
            }

            function slugifyId(id) {
                // Anchor-safe, stable
                return "q-" + String(id).trim()
                    .replaceAll(/\s+/g, "")
                    .replaceAll(/[()]/g, "")
                    .replaceAll(/[^\w-]/g, "-")
                    .replaceAll(/-+/g, "-")
                    .replaceAll(/^-|-$/g, "");
            }

            // Segment model:
            // {t:'text', v:'...'} | {t:'math_inline', v:'...'} | {t:'math_block', v:'...'} | {t:'svg', v:'geometry'|'bars'|'grid'|'table'}
            function renderSegments(segments) {
                if (!segments || !segments.length) return "";
                let html = "";
                for (const s of segments) {
                    if (!s) continue;
                    if (s.t === "text") html += escapeHtml(s.v);
                    else if (s.t === "math_inline") html += `<span class="math-inline" data-math="${escapeHtml(s.v)}" data-display="0">${escapeHtml(s.v)}</span>`;
                    else if (s.t === "math_block") html += `<div class="math-block" data-math="${escapeHtml(s.v)}" data-display="1">${escapeHtml(s.v)}</div>`;
                    else if (s.t === "svg") html += `<div class="diagram">${svgPlaceholder(s.v)}</div>`;
                }
                return html;
            }

            function svgPlaceholder(type) {
                // Grayscale inline SVG placeholders (reused types)
                const stroke = "#111";
                const mid = "#777";
                const light = "#d7d7d7";
                const bg = "#fff";

                if (type === "geometry") {
                    return `
          <svg viewBox="0 0 520 220" role="img" aria-label="Geometry diagram placeholder">
            <rect x="1" y="1" width="518" height="218" fill="${bg}" stroke="${light}" />
            <circle cx="380" cy="110" r="60" fill="none" stroke="${mid}" stroke-width="2"/>
            <polygon points="90,165 210,45 280,165" fill="none" stroke="${stroke}" stroke-width="2"/>
            <line x1="90" y1="165" x2="280" y2="165" stroke="${mid}" stroke-width="2"/>
            <line x1="210" y1="45" x2="380" y2="110" stroke="${mid}" stroke-width="2" stroke-dasharray="5 4"/>
            <text x="205" y="38" font-size="14" fill="${stroke}">A</text>
            <text x="78" y="182" font-size="14" fill="${stroke}">B</text>
            <text x="285" y="182" font-size="14" fill="${stroke}">C</text>
            <text x="365" y="112" font-size="14" fill="${stroke}">O</text>
            <text x="120" y="156" font-size="12" fill="${mid}">base</text>
            <text x="225" y="122" font-size="12" fill="${mid}">height</text>
          </svg>`;
                }

                if (type === "bars") {
                    return `
          <svg viewBox="0 0 520 220" role="img" aria-label="Ratio bars diagram placeholder">
            <rect x="1" y="1" width="518" height="218" fill="${bg}" stroke="${light}" />
            <text x="20" y="40" font-size="14" fill="${stroke}">Ratio bars</text>
            <rect x="20" y="70" width="460" height="28" fill="none" stroke="${stroke}" stroke-width="2"/>
            <line x1="20" y1="98" x2="480" y2="98" stroke="${mid}" stroke-width="1"/>
            <line x1="20" y1="70" x2="20" y2="98" stroke="${stroke}" stroke-width="2"/>
            <line x1="173" y1="70" x2="173" y2="98" stroke="${mid}" stroke-width="2"/>
            <line x1="326" y1="70" x2="326" y2="98" stroke="${mid}" stroke-width="2"/>
            <line x1="480" y1="70" x2="480" y2="98" stroke="${stroke}" stroke-width="2"/>
            <text x="88" y="92" font-size="12" fill="${mid}">2 parts</text>
            <text x="240" y="92" font-size="12" fill="${mid}">2 parts</text>
            <text x="392" y="92" font-size="12" fill="${mid}">2 parts</text>

            <rect x="20" y="130" width="460" height="28" fill="none" stroke="${stroke}" stroke-width="2"/>
            <line x1="20" y1="130" x2="480" y2="130" stroke="${mid}" stroke-width="1"/>
            <line x1="250" y1="130" x2="250" y2="158" stroke="${mid}" stroke-width="2"/>
            <text x="210" y="152" font-size="12" fill="${mid}">split</text>
          </svg>`;
                }

                if (type === "grid") {
                    return `
          <svg viewBox="0 0 520 220" role="img" aria-label="Coordinate grid diagram placeholder">
            <rect x="1" y="1" width="518" height="218" fill="${bg}" stroke="${light}" />
            <text x="20" y="40" font-size="14" fill="${stroke}">Coordinate grid</text>
            <g transform="translate(60,60)">
              <rect x="0" y="0" width="380" height="130" fill="none" stroke="${light}"/>
              ${Array.from({ length: 10 }).map((_, i) => `<line x1="${i * 38}" y1="0" x2="${i * 38}" y2="130" stroke="${light}" />`).join("")}
              ${Array.from({ length: 8 }).map((_, i) => `<line x1="0" y1="${i * 18.6}" x2="380" y2="${i * 18.6}" stroke="${light}" />`).join("")}
              <line x1="0" y1="130" x2="380" y2="130" stroke="${stroke}" stroke-width="2"/>
              <line x1="0" y1="0" x2="0" y2="130" stroke="${stroke}" stroke-width="2"/>
              <polyline points="0,120 76,95 152,78 228,55 304,35 380,20" fill="none" stroke="${stroke}" stroke-width="2"/>
              <circle cx="152" cy="78" r="4" fill="${stroke}"/>
              <circle cx="304" cy="35" r="4" fill="${stroke}"/>
              <text x="160" y="73" font-size="12" fill="${mid}">(2,3)</text>
              <text x="312" y="30" font-size="12" fill="${mid}">(5,6)</text>
            </g>
          </svg>`;
                }

                // "table" (grid/array)
                return `
        <svg viewBox="0 0 520 220" role="img" aria-label="Table diagram placeholder">
          <rect x="1" y="1" width="518" height="218" fill="${bg}" stroke="${light}" />
          <text x="20" y="40" font-size="14" fill="${stroke}">Table</text>
          <g transform="translate(80,60)">
            <rect x="0" y="0" width="360" height="130" fill="none" stroke="${stroke}" stroke-width="2"/>
            ${Array.from({ length: 5 }).map((_, i) => `<line x1="${i * 72}" y1="0" x2="${i * 72}" y2="130" stroke="${mid}" stroke-width="1.5" />`).join("")}
            ${Array.from({ length: 4 }).map((_, i) => `<line x1="0" y1="${i * 32.5}" x2="360" y2="${i * 32.5}" stroke="${mid}" stroke-width="1.5" />`).join("")}
            <text x="12" y="24" font-size="12" fill="${mid}">A</text>
            <text x="84" y="24" font-size="12" fill="${mid}">B</text>
            <text x="156" y="24" font-size="12" fill="${mid}">C</text>
            <text x="228" y="24" font-size="12" fill="${mid}">D</text>
            <text x="300" y="24" font-size="12" fill="${mid}">E</text>
          </g>
        </svg>`;
            }

            // KaTeX rendering (programmatic). Graceful fallback if KaTeX fails to load.
            function renderKatex(scope) {
                const root = scope || document;
                const nodes = root.querySelectorAll("[data-math]");
                const k = window.katex;
                for (const el of nodes) {
                    const expr = el.getAttribute("data-math") || "";
                    const displayMode = el.getAttribute("data-display") === "1";
                    if (!k || !k.render) {
                        // fallback: leave as plain text content (already set)
                        continue;
                    }
                    try {
                        el.textContent = ""; // replace fallback
                        k.render(expr, el, {
                            displayMode,
                            throwOnError: false,
                            strict: "ignore"
                        });
                    } catch (_e) {
                        // fallback: keep plain text
                        el.textContent = expr;
                    }
                }
            }

            // ---------- Data generation ----------
            function mkText(v) { return { t: "text", v }; }
            function mkIn(v) { return { t: "math_inline", v }; }
            function mkBlk(v) { return { t: "math_block", v }; }
            function mkSvg(v) { return { t: "svg", v }; }

            function qNode({ id, depth = 0, promptSegs = [], answerSegs = null, solution = null, children = [] }) {
                return { type: "q", id, depth, promptSegs, answerSegs, solution, children };
            }
            function sectionNode(label) {
                return { type: "section", label };
            }

            // Build working lines helpers
            function longAlgebraWorkingLines(seed) {
                // 12–18 lines of mixed text + display math, with occasional wide expressions
                const lines = [];
                lines.push({ kind: "text", segs: [mkText("Start by collecting like terms and isolating the variable.")] });
                lines.push({ kind: "math", expr: `3x + ${seed} = 5x - ${seed + 2}` });
                lines.push({ kind: "math", expr: `3x - 5x = -${seed + 2} - ${seed}` });
                lines.push({ kind: "math", expr: `-2x = -${2 * seed + 2}` });
                lines.push({ kind: "math", expr: `x = ${seed + 1}` });
                lines.push({ kind: "text", segs: [mkText("Check by substituting back into the original equation.")] });
                lines.push({ kind: "math", expr: `3(${seed + 1}) + ${seed} = 5(${seed + 1}) - ${seed + 2}` });
                lines.push({ kind: "math", expr: `${3 * (seed + 1) + seed} = ${5 * (seed + 1) - (seed + 2)}` });
                lines.push({ kind: "text", segs: [mkText("Both sides match, so the solution is correct.")] });

                // add a deliberately wide expression to stress overflow
                lines.push({ kind: "text", segs: [mkText("If you expand fully, you may see a long line like:")] });
                lines.push({ kind: "math", expr: `\\frac{(7x-${seed})\\,(5x+${seed + 3})\\,(2x-${seed - 1})}{(x+1)(x-1)} = \\frac{(7x-${seed})\\,(10x^2+${(seed + 3) * 2}x-${seed * (seed + 3)})}{x^2-1}` });

                return lines;
            }

            function extremelyLongWorkingLines() {
                // 55 lines (Working only) to stress expanded/collapsed readability
                const lines = [];
                lines.push({ kind: "text", segs: [mkText("Work through each line carefully. Each step follows from the previous one.")] });
                for (let i = 1; i <= 55; i++) {
                    // mix: some algebra, some fraction simplification, some sequences
                    if (i % 7 === 0) {
                        lines.push({ kind: "math", expr: `\\frac{${i}x+${i + 3}}{${i + 1}} - \\frac{${i - 1}x-${i}}{${i + 2}} = \\frac{(${i}x+${i + 3})(${i + 2}) - (${i - 1}x-${i})(${i + 1})}{(${i + 1})(${i + 2})}` });
                    } else if (i % 5 === 0) {
                        lines.push({ kind: "math", expr: `a_${i} = a_${i - 1} + ${i} \\quad \\Rightarrow \\quad a_${i} = a_1 + \\sum_{k=2}^{${i}} k` });
                    } else if (i % 3 === 0) {
                        lines.push({ kind: "math", expr: `(${i}x-${i - 2})(x+${i % 4 + 1}) = ${i}x^2 + (${i}(${i % 4 + 1})-${i - 2})x - (${i - 2})(${i % 4 + 1})` });
                    } else {
                        lines.push({ kind: "math", expr: `${i}x + ${i + 1} = ${i + 2}x - ${i - 1}` });
                    }
                }
                lines.push({ kind: "text", segs: [mkText("End of long working.")] });
                return lines;
            }

            function mkSolution({ guidance = null, formulas = null, workingLines = [], altWorkingLines = [] }) {
                // ordering: Guidance, Formulas used, Working, Alternative working
                return { guidance, formulas, workingLines, altWorkingLines };
            }

            // Build datasets
            function buildShortPaper() {
                const blocks = [];
                blocks.push(
                    qNode({
                        id: "1",
                        depth: 0,
                        promptSegs: [mkText("Calculate "), mkIn("48 \\div 6"), mkText(".")],
                        answerSegs: [mkIn("8")],
                        solution: mkSolution({
                            workingLines: [
                                { kind: "text", segs: [mkText("Use the fact that "), mkIn("6\\times 8 = 48"), mkText(".")] },
                                { kind: "math", expr: "48 \\div 6 = 8" }
                            ]
                        })
                    })
                );

                blocks.push(
                    qNode({
                        id: "2",
                        depth: 0,
                        promptSegs: [
                            mkText("A ribbon is "), mkIn("2.4\\text{ m}"), mkText(" long. You cut off "), mkIn("75\\text{ cm}"), mkText(". How much ribbon is left?")
                        ],
                        answerSegs: [mkIn("1.65\\text{ m}")],
                        solution: mkSolution({
                            guidance: [{ kind: "text", segs: [mkText("Convert to the same unit before subtracting.")] }],
                            workingLines: [
                                { kind: "math", expr: "75\\text{ cm} = 0.75\\text{ m}" },
                                { kind: "math", expr: "2.4\\text{ m} - 0.75\\text{ m} = 1.65\\text{ m}" }
                            ]
                        })
                    })
                );

                blocks.push(
                    qNode({
                        id: "3",
                        depth: 0,
                        promptSegs: [
                            mkText("Write "), mkIn("\\frac{3}{5}"), mkText(" as a decimal.")
                        ],
                        answerSegs: [mkIn("0.6")],
                        solution: mkSolution({
                            workingLines: [
                                { kind: "text", segs: [mkText("Divide the numerator by the denominator.")] },
                                { kind: "math", expr: "3 \\div 5 = 0.6" }
                            ],
                            altWorkingLines: [
                                { kind: "text", segs: [mkText("Or use tenths: multiply top and bottom by 2.")] },
                                { kind: "math", expr: "\\frac{3}{5} = \\frac{6}{10} = 0.6" }
                            ]
                        })
                    })
                );

                // Multi-part with parent prompt and nested subquestions (deep nesting add-on style)
                blocks.push(
                    qNode({
                        id: "4",
                        depth: 0,
                        promptSegs: [
                            mkText("A class is raising money. They sell biscuits and juice boxes.")
                        ],
                        answerSegs: null,
                        solution: null,
                        children: [
                            qNode({
                                id: "4a",
                                depth: 1,
                                promptSegs: [mkText("Biscuits cost "), mkIn("35\\text{ p}"), mkText(" each. How much do 8 biscuits cost?")],
                                answerSegs: [mkIn("280\\text{ p}")],
                                solution: mkSolution({
                                    workingLines: [
                                        { kind: "math", expr: "8 \\times 35 = 280" },
                                        { kind: "text", segs: [mkText("So the cost is "), mkIn("280\\text{ p}"), mkText(" (which is "), mkIn("\\pounds 2.80"), mkText(").")] }
                                    ]
                                })
                            }),
                            qNode({
                                id: "4b",
                                depth: 1,
                                promptSegs: [mkText("A juice box costs "), mkIn("\\pounds 1.20"), mkText(". They sell 15 juice boxes. What is the total?")],
                                answerSegs: [mkIn("\\pounds 18")],
                                solution: mkSolution({
                                    formulas: [{ kind: "text", segs: [mkText("Money total = price × quantity.")] }],
                                    workingLines: [
                                        { kind: "math", expr: "15 \\times 1.20 = 18.00" },
                                        { kind: "text", segs: [mkText("Total is "), mkIn("\\pounds 18"), mkText(".")] }
                                    ]
                                })
                            })
                        ]
                    })
                );

                blocks.push(
                    qNode({
                        id: "5",
                        depth: 0,
                        promptSegs: [mkText("Solve "), mkIn("x+7=19"), mkText(".")],
                        answerSegs: [mkIn("x=12")],
                        solution: mkSolution({
                            workingLines: [
                                { kind: "text", segs: [mkText("Subtract 7 from both sides.")] },
                                { kind: "math", expr: "x = 19 - 7 = 12" }
                            ]
                        })
                    })
                );

                blocks.push(
                    qNode({
                        id: "6",
                        depth: 0,
                        promptSegs: [mkText("A rectangle has length "), mkIn("9\\text{ cm}"), mkText(" and width "), mkIn("4\\text{ cm}"), mkText(". Find its area.")],
                        answerSegs: [mkIn("36\\text{ cm}^2")],
                        solution: mkSolution({
                            formulas: [{ kind: "text", segs: [mkText("Area of rectangle = length × width.")] }],
                            workingLines: [
                                { kind: "math", expr: "9 \\times 4 = 36" },
                                { kind: "math", expr: "\\text{Area} = 36\\text{ cm}^2" }
                            ]
                        })
                    })
                );

                return {
                    key: "short",
                    label: "Short paper",
                    title: "Short paper",
                    subtitle: "6 questions • mixed short arithmetic and one multi-part question",
                    defaultExpanded: false,
                    blocks
                };
            }

            function buildStandardPaper({ expanded = false } = {}) {
                const blocks = [];
                // Q1–Q25: small/medium
                for (let i = 1; i <= 25; i++) {
                    if (i === 18) {
                        // Deep nesting add-on: Q18 with (a)(i)(ii)(b)
                        blocks.push(qNode({
                            id: "18",
                            depth: 0,
                            promptSegs: [
                                mkText("A number machine takes a number "), mkIn("n"), mkText(", then does two steps: multiply by 3 and subtract 5.")
                            ],
                            answerSegs: null,
                            solution: null,
                            children: [
                                qNode({
                                    id: "18(a)(i)",
                                    depth: 1,
                                    promptSegs: [mkText("Write an expression for the output.")],
                                    answerSegs: [mkIn("3n-5")],
                                    solution: mkSolution({
                                        guidance: [{ kind: "text", segs: [mkText("Follow the steps in order: multiply, then subtract.")] }],
                                        workingLines: [
                                            { kind: "math", expr: "n \\xrightarrow{\\times 3} 3n \\xrightarrow{-5} 3n-5" }
                                        ]
                                    })
                                }),
                                qNode({
                                    id: "18(a)(ii)",
                                    depth: 1,
                                    promptSegs: [mkText("Find the output when "), mkIn("n=12"), mkText(".")],
                                    answerSegs: [mkIn("31")],
                                    solution: mkSolution({
                                        workingLines: [
                                            { kind: "math", expr: "3(12)-5 = 36-5 = 31" }
                                        ]
                                    })
                                }),
                                qNode({
                                    id: "18(b)",
                                    depth: 1,
                                    promptSegs: [mkText("The output is 40. Find "), mkIn("n"), mkText(".")],
                                    answerSegs: [mkIn("n=15")],
                                    solution: mkSolution({
                                        formulas: [{ kind: "text", segs: [mkText("Solve the equation by reversing the steps.")] }],
                                        workingLines: [
                                            { kind: "math", expr: "3n-5 = 40" },
                                            { kind: "math", expr: "3n = 45" },
                                            { kind: "math", expr: "n = 15" }
                                        ]
                                    })
                                })
                            ]
                        }));
                        continue;
                    }

                    const prompt = (function () {
                        switch (i % 6) {
                            case 0: return [mkText("Calculate "), mkIn(`${20 + i} \\times 7`), mkText(".")];
                            case 1: return [mkText("Find "), mkIn(`\\frac{${(i % 5) + 2}}{8}`), mkText(" of "), mkIn(`${40 + i}`), mkText(".")];
                            case 2: return [mkText("A train travels "), mkIn(`${12 + i}\\text{ km}`), mkText(" in "), mkIn("30\\text{ min}"), mkText(". What is the speed in km/h?")];
                            case 3: return [mkText("Simplify "), mkIn(`\\frac{${(i % 7) + 6}}{${(i % 5) + 10}}`), mkText(".")];
                            case 4: return [mkText("Solve "), mkIn(`2x+${(i % 9) + 3}=${(i % 11) + 25}`), mkText(".")];
                            default: return [mkText("Write "), mkIn(`${(i % 7) + 3}`), mkText("% as a fraction in its simplest form.")];
                        }
                    })();

                    const answer = (function () {
                        switch (i % 6) {
                            case 0: return [mkIn(String((20 + i) * 7))];
                            case 1: return [mkIn(String(((i % 5) + 2) * (40 + i) / 8))];
                            case 2: return [mkIn(`${2 * (12 + i)}\\text{ km/h}`)];
                            case 3: return [mkIn(`\\frac{${(i % 7) + 6}/2}{${(i % 5) + 10}/2}`)];
                            case 4: {
                                const a = (i % 9) + 3, b = (i % 11) + 25;
                                // 2x + a = b -> x = (b-a)/2
                                return [mkIn(`x=${(b - a) / 2}`)];
                            }
                            default: {
                                const p = (i % 7) + 3; // percent
                                // p% = p/100 simplified maybe (not fully)
                                return [mkIn(`\\frac{${p}}{100}`)];
                            }
                        }
                    })();

                    const sol = (function () {
                        const hasGuidance = (i === 7 || i === 12 || i === 21); // ensure coverage
                        const hasFormulas = (i === 8 || i === 14 || i === 22);
                        const hasAlt = (i === 9 || i === 15 || i === 23);
                        const allThree = (i === 15); // Guidance + Formulas + Alternative working in one
                        const guidance = (hasGuidance || allThree) ? [
                            { kind: "text", segs: [mkText("Take one small step at a time and keep your units consistent.")] }
                        ] : null;
                        const formulas = (hasFormulas || allThree) ? [
                            { kind: "text", segs: [mkText("Use the most direct relationship first (for example, a rate is distance divided by time).")] }
                        ] : null;
                        const workingLines = [];

                        if (i % 6 === 2) {
                            workingLines.push({ kind: "text", segs: [mkText("Convert 30 minutes to hours.")] });
                            workingLines.push({ kind: "math", expr: "30\\text{ min} = 0.5\\text{ h}" });
                            workingLines.push({ kind: "text", segs: [mkText("Speed = distance ÷ time.")] });
                            workingLines.push({ kind: "math", expr: `\\text{speed} = \\frac{${12 + i}}{0.5} = ${2 * (12 + i)}\\text{ km/h}` });
                        } else if (i % 6 === 4) {
                            const a = (i % 9) + 3, b = (i % 11) + 25;
                            workingLines.push({ kind: "math", expr: `2x+${a}=${b}` });
                            workingLines.push({ kind: "math", expr: `2x=${b}-${a}` });
                            workingLines.push({ kind: "math", expr: `x=\\frac{${b - a}}{2}=${(b - a) / 2}` });
                        } else {
                            workingLines.push({ kind: "text", segs: [mkText("Work carefully and check the result makes sense in the original question.")] });
                            // one display line to keep KaTeX in play
                            workingLines.push({ kind: "math", expr: `\\text{Answer shown above}` });
                        }

                        const altWorkingLines = (hasAlt || allThree) ? [
                            { kind: "text", segs: [mkText("Alternative method: rewrite the problem in a different form, then simplify.")] },
                            { kind: "math", expr: `\\left(\\frac{${(i % 5) + 2}}{8}\\right)(${40 + i}) = \\frac{${((i % 5) + 2) * (40 + i)}}{8}` }
                        ] : [];

                        return mkSolution({ guidance, formulas, workingLines, altWorkingLines });
                    })();

                    blocks.push(qNode({
                        id: String(i),
                        depth: 0,
                        promptSegs: prompt,
                        answerSegs: answer,
                        solution: sol
                    }));
                }

                // Q26–Q35: long algebra, multiple KaTeX blocks in Solution Details, collapsed by default (except expanded variant)
                for (let i = 26; i <= 35; i++) {
                    const seed = i - 20;
                    const promptSegs = [
                        mkText("Solve for "), mkIn("x"), mkText(": "),
                        mkIn(`3x+${seed}=5x-${seed + 2}`), mkText(". Then show a clear check.")
                    ];

                    const answerSegs = [mkIn(`x=${seed + 1}`)];

                    const lines = longAlgebraWorkingLines(seed);
                    // ensure multiple block placeholders (real KaTeX renders these)
                    // also add a brief reasoning paragraph
                    const workingLines = [
                        { kind: "text", segs: [mkText("Keep your equation balanced by doing the same operation to both sides.")] },
                        ...lines
                    ];

                    // Add extremely long workings to a selected subset
                    let extraLong = [];
                    if (i === 33 || i === 35) {
                        extraLong = extremelyLongWorkingLines();
                    }

                    // Alternative working for coverage in the long area
                    const altWorkingLines = (i === 28 || i === 31 || i === 34) ? [
                        { kind: "text", segs: [mkText("Alternative working: move all terms to one side and factor where possible.")] },
                        { kind: "math", expr: `3x+${seed}-(5x-${seed + 2})=0` },
                        { kind: "math", expr: `-2x+${2 * seed + 2}=0` },
                        { kind: "math", expr: `x=${seed + 1}` }
                    ] : [];

                    // Add guidance/formulas occasionally in this block for variety (still subordinate)
                    const guidance = (i === 26 || i === 30 || i === 35) ? [
                        { kind: "text", segs: [mkText("Watch for negative signs when you move terms across the equals sign.")] }
                    ] : null;

                    const formulas = (i === 27 || i === 32 || i === 35) ? [
                        { kind: "text", segs: [mkText("If you prefer, treat this as a linear equation of the form "), mkIn("ax+b=cx+d"), mkText(".")] }
                    ] : null;

                    blocks.push(qNode({
                        id: String(i),
                        depth: 0,
                        promptSegs,
                        answerSegs,
                        solution: mkSolution({
                            guidance,
                            formulas,
                            workingLines: [...workingLines, ...extraLong],
                            altWorkingLines
                        })
                    }));
                }

                // Deep nesting add-on: Q30 nested parts
                // Replace existing Q30 created above with a nested structure for stress testing.
                // Find and remove the previous Q30 node and insert nested version at the same approximate location.
                (function () {
                    const idx = blocks.findIndex(b => b.type === "q" && b.id === "30");
                    if (idx === -1) return;

                    // Remove previous Q30
                    blocks.splice(idx, 1,
                        qNode({
                            id: "30",
                            depth: 0,
                            promptSegs: [
                                mkText("A pattern is defined by "), mkIn("T_n = 4n-1"), mkText(".")
                            ],
                            answerSegs: null,
                            solution: null,
                            children: [
                                qNode({
                                    id: "30(a)(i)",
                                    depth: 1,
                                    promptSegs: [mkText("Find "), mkIn("T_6"), mkText(".")],
                                    answerSegs: [mkIn("23")],
                                    solution: mkSolution({
                                        workingLines: [
                                            { kind: "math", expr: "T_6 = 4(6)-1 = 24-1 = 23" }
                                        ]
                                    })
                                }),
                                qNode({
                                    id: "30(a)(ii)",
                                    depth: 1,
                                    promptSegs: [mkText("Find the value of "), mkIn("n"), mkText(" when "), mkIn("T_n=59"), mkText(".")],
                                    answerSegs: [mkIn("n=15")],
                                    solution: mkSolution({
                                        guidance: [{ kind: "text", segs: [mkText("Set the formula equal to 59, then solve for n.")] }],
                                        workingLines: [
                                            { kind: "math", expr: "4n-1 = 59" },
                                            { kind: "math", expr: "4n = 60" },
                                            { kind: "math", expr: "n = 15" }
                                        ]
                                    })
                                }),
                                qNode({
                                    id: "30(b)",
                                    depth: 1,
                                    promptSegs: [mkText("Explain why "), mkIn("T_n"), mkText(" is always odd.")],
                                    answerSegs: [mkText("Because "), mkIn("4n"), mkText(" is always even, and even − 1 is odd.")],
                                    solution: mkSolution({
                                        workingLines: [
                                            { kind: "text", segs: [mkText("Any multiple of 4 is even. Subtracting 1 from an even number makes it odd.")] },
                                            { kind: "math", expr: "4n = 2(2n) \\text{ is even } \\Rightarrow 4n-1 \\text{ is odd}" }
                                        ]
                                    })
                                })
                            ]
                        })
                    );
                })();

                return {
                    key: expanded ? "standardExpanded" : "standard",
                    label: expanded ? "Standard (Workings Expanded)" : "Standard paper",
                    title: expanded ? "Standard paper (Workings Expanded)" : "Standard paper",
                    subtitle: expanded
                        ? "35 questions • same as Standard • all Solution Details expanded by default (evaluation dataset)"
                        : "35 questions • Q26–Q35 are long algebra • Solution Details collapsed by default",
                    defaultExpanded: !!expanded,
                    blocks
                };
            }

            function buildDiagramHeavyPaper() {
                const blocks = [];
                // 20 questions, 8 diagrams
                const diagramQs = new Set([2, 4, 6, 9, 12, 15, 17, 20]);
                const diagramTypes = ["geometry", "bars", "grid", "table"];
                let dt = 0;

                for (let i = 1; i <= 20; i++) {
                    const hasDiagram = diagramQs.has(i);
                    const promptSegs = [];

                    if (i % 4 === 1) {
                        promptSegs.push(mkText("Find the perimeter of the shape shown. Give your answer in cm."));
                    } else if (i % 4 === 2) {
                        promptSegs.push(mkText("Use the diagram to work out the missing value."));
                    } else if (i % 4 === 3) {
                        promptSegs.push(mkText("On the coordinate grid, find the gradient of the line."));
                    } else {
                        promptSegs.push(mkText("Complete the table and write the rule for the pattern."));
                    }

                    if (hasDiagram) {
                        promptSegs.push(mkSvg(diagramTypes[dt % diagramTypes.length]));
                        dt++;
                    }

                    const answerSegs = (function () {
                        switch (i % 4) {
                            case 1: return [mkIn(`${12 + i}`), mkText(" cm")];
                            case 2: return [mkIn(`${i * 3}`)];
                            case 3: return [mkIn(`\\frac{${i % 5 + 1}}{${i % 3 + 1}}`)];
                            default: return [mkText("Rule: "), mkIn("y=2x+1")];
                        }
                    })();

                    const solution = (function () {
                        const workingLines = [];
                        if (i % 4 === 3) {
                            workingLines.push({ kind: "text", segs: [mkText("Gradient = rise ÷ run, using two points on the line.")] });
                            workingLines.push({ kind: "math", expr: "m = \\frac{\\Delta y}{\\Delta x}" });
                            workingLines.push({ kind: "math", expr: `m = \\frac{${i % 5 + 1}}{${i % 3 + 1}}` });
                        } else if (i % 4 === 4) {
                            workingLines.push({ kind: "text", segs: [mkText("Look at how y changes when x increases by 1.")] });
                            workingLines.push({ kind: "math", expr: "y = 2x + 1" });
                            workingLines.push({ kind: "text", segs: [mkText("Use the rule to fill any missing table values.")] });
                        } else {
                            workingLines.push({ kind: "text", segs: [mkText("Read the measurements from the diagram and combine them carefully.")] });
                            workingLines.push({ kind: "math", expr: "\\text{Answer shown above}" });
                        }

                        // Sprinkle coverage items here too (non-essential but stress-test)
                        const guidance = (i === 6 || i === 12 || i === 17) ? [
                            { kind: "text", segs: [mkText("Keep your place in the diagram by tracing each length once.")] }
                        ] : null;
                        const formulas = (i === 4 || i === 9 || i === 15) ? [
                            { kind: "text", segs: [mkText("Perimeter is the distance all the way around the shape.")] }
                        ] : null;
                        const altWorkingLines = (i === 12 || i === 20) ? [
                            { kind: "text", segs: [mkText("Alternative working: break the shape into simple parts and add the results.")] },
                            { kind: "math", expr: "\\text{part 1} + \\text{part 2} = \\text{total}" }
                        ] : [];

                        return mkSolution({ guidance, formulas, workingLines, altWorkingLines });
                    })();

                    blocks.push(qNode({
                        id: String(i),
                        depth: 0,
                        promptSegs,
                        answerSegs,
                        solution
                    }));
                }

                return {
                    key: "diagram",
                    label: "Diagram-heavy paper",
                    title: "Diagram-heavy paper",
                    subtitle: "20 questions • 8 questions include diagrams (inline SVG placeholders)",
                    defaultExpanded: false,
                    blocks
                };
            }

            function buildSectionedPaper() {
                const blocks = [];
                // Section A: 35 questions small/medium
                blocks.push(sectionNode("A"));
                for (let i = 1; i <= 35; i++) {
                    // include a few medium items and a nested one for variety
                    if (i === 18) {
                        blocks.push(qNode({
                            id: "18",
                            depth: 0,
                            promptSegs: [mkText("A shop offers a deal: buy 3 items, get "), mkIn("10\\%"), mkText(" off the total.")],
                            answerSegs: null,
                            solution: null,
                            children: [
                                qNode({
                                    id: "18(a)(i)",
                                    depth: 1,
                                    promptSegs: [mkText("The total before the discount is "), mkIn("\\pounds 24"), mkText(". Find the discount amount.")],
                                    answerSegs: [mkIn("\\pounds 2.40")],
                                    solution: mkSolution({
                                        workingLines: [
                                            { kind: "math", expr: "10\\% \\text{ of } 24 = 0.10 \\times 24 = 2.4" }
                                        ]
                                    })
                                }),
                                qNode({
                                    id: "18(a)(ii)",
                                    depth: 1,
                                    promptSegs: [mkText("Find the final price after the discount.")],
                                    answerSegs: [mkIn("\\pounds 21.60")],
                                    solution: mkSolution({
                                        workingLines: [
                                            { kind: "math", expr: "24 - 2.4 = 21.6" }
                                        ]
                                    })
                                }),
                                qNode({
                                    id: "18(b)",
                                    depth: 1,
                                    promptSegs: [mkText("Explain why taking "), mkIn("10\\%"), mkText(" off is the same as multiplying by "), mkIn("0.9"), mkText(".")],
                                    answerSegs: [mkText("Because 100% − 10% = 90%, and 90% = 0.9.")],
                                    solution: mkSolution({
                                        guidance: [{ kind: "text", segs: [mkText("Connect the percentage to the decimal multiplier.")] }],
                                        workingLines: [
                                            { kind: "math", expr: "100\\% - 10\\% = 90\\%" },
                                            { kind: "math", expr: "90\\% = \\frac{90}{100} = 0.9" }
                                        ]
                                    })
                                })
                            ]
                        }));
                        continue;
                    }

                    const promptSegs = (i % 5 === 0)
                        ? [mkText("Solve "), mkIn(`x^2 - ${i}x + ${i - 6} = 0`), mkText(" (give two answers if needed).")]
                        : (i % 3 === 0)
                            ? [mkText("Work out "), mkIn(`${120 + i}`), mkText(" as a product of its prime factors.")]
                            : [mkText("Calculate "), mkIn(`${6 + i} \\times ${i % 7 + 3}`), mkText(".")];

                    const answerSegs = (i % 5 === 0)
                        ? [mkText("Two answers possible")]
                        : (i % 3 === 0)
                            ? [mkText("Prime factors shown in working")]
                            : [mkIn(String((6 + i) * (i % 7 + 3)))];

                    const solution = (function () {
                        const workingLines = [];
                        const altWorkingLines = [];
                        const guidance = (i === 7 || i === 21 || i === 33) ? [
                            { kind: "text", segs: [mkText("If you get stuck, rewrite the problem in smaller steps you can check.")] }
                        ] : null;
                        const formulas = (i === 8 || i === 22 || i === 34) ? [
                            { kind: "text", segs: [mkText("Useful fact: "), mkIn("a^2-b^2=(a-b)(a+b)"), mkText(".")] }
                        ] : null;

                        if (i % 5 === 0) {
                            workingLines.push({ kind: "text", segs: [mkText("Try factoring or using a method that gives both solutions.")] });
                            workingLines.push({ kind: "math", expr: `x^2 - ${i}x + ${i - 6} = 0` });
                            workingLines.push({ kind: "math", expr: `(x-2)(x-${i - 3})=0` });
                            workingLines.push({ kind: "math", expr: `x=2 \\text{ or } x=${i - 3}` });
                            altWorkingLines.push({ kind: "text", segs: [mkText("Alternative working: use the quadratic formula.")] });
                            altWorkingLines.push({ kind: "math", expr: `x=\\frac{${i}\\pm\\sqrt{${i}^2-4\\cdot 1\\cdot ${i - 6}}}{2}` });
                        } else if (i % 3 === 0) {
                            workingLines.push({ kind: "text", segs: [mkText("Divide by the smallest prime each time until you reach 1.")] });
                            workingLines.push({ kind: "math", expr: `${120 + i} = 2 \\times ${Math.floor((120 + i) / 2)}` });
                            workingLines.push({ kind: "math", expr: `\\text{Continue until fully factorised.}` });
                        } else {
                            workingLines.push({ kind: "math", expr: `(${6 + i})(${i % 7 + 3}) = ${(6 + i) * (i % 7 + 3)}` });
                        }

                        return mkSolution({ guidance, formulas, workingLines, altWorkingLines });
                    })();

                    blocks.push(qNode({
                        id: String(i),
                        depth: 0,
                        promptSegs,
                        answerSegs,
                        solution
                    }));
                }

                // Section B: 8 medium
                blocks.push(sectionNode("B"));
                for (let j = 1; j <= 8; j++) {
                    const id = `B${j}`;
                    const promptSegs = [
                        mkText("A recipe uses "), mkIn(`${2 + j}`), mkText(" cups of flour for "), mkIn(`${4 + j}`), mkText(" cakes. How many cups are needed for "), mkIn(`${10 + j}`), mkText(" cakes?")
                    ];
                    const answerSegs = [mkText("Answer shown in working")];
                    const solution = mkSolution({
                        guidance: (j === 2 || j === 6) ? [{ kind: "text", segs: [mkText("Use proportional reasoning: scale up by the same factor.")] }] : null,
                        formulas: (j === 3 || j === 7) ? [{ kind: "text", segs: [mkText("If two ratios are equivalent, "), mkIn("\\frac{a}{b}=\\frac{c}{d}"), mkText(".")] }] : null,
                        workingLines: [
                            { kind: "math", expr: `\\frac{${2 + j}}{${4 + j}} = \\frac{x}{${10 + j}}` },
                            { kind: "math", expr: `x = \\frac{(${2 + j})(${10 + j})}{${4 + j}}` },
                            { kind: "math", expr: `x = \\frac{${(2 + j) * (10 + j)}}{${4 + j}}` }
                        ],
                        altWorkingLines: (j === 5) ? [
                            { kind: "text", segs: [mkText("Alternative working: find flour per cake first, then multiply.")] },
                            { kind: "math", expr: `\\text{per cake} = \\frac{${2 + j}}{${4 + j}}` },
                            { kind: "math", expr: `x = (${10 + j})\\cdot\\frac{${2 + j}}{${4 + j}}` }
                        ] : []
                    });

                    blocks.push(qNode({
                        id,
                        depth: 0,
                        promptSegs,
                        answerSegs,
                        solution
                    }));
                }

                // Section C: 6, all very long Solution Details (collapsed by default)
                blocks.push(sectionNode("C"));
                for (let k = 1; k <= 6; k++) {
                    const id = `C${k}`;
                    const promptSegs = [
                        mkText("Solve the equation and explain each step clearly: "),
                        mkIn(`\\frac{2x+${k}}{3} - \\frac{x-${k + 1}}{4} = ${k + 2}`)
                    ];
                    const answerSegs = [mkText("Answer shown in working")];

                    const guidance = (k === 1 || k === 4 || k === 6) ? [
                        { kind: "text", segs: [mkText("Clear the fractions by multiplying through by the lowest common multiple.")] }
                    ] : null;

                    const formulas = (k === 2 || k === 5 || k === 6) ? [
                        { kind: "text", segs: [mkText("Lowest common multiple of 3 and 4 is "), mkIn("12"), mkText(".")] }
                    ] : null;

                    const workingLines = [
                        { kind: "text", segs: [mkText("Multiply both sides by 12 to remove denominators.")] },
                        { kind: "math", expr: `12\\left(\\frac{2x+${k}}{3}\\right) - 12\\left(\\frac{x-${k + 1}}{4}\\right) = 12(${k + 2})` },
                        { kind: "math", expr: `4(2x+${k}) - 3(x-${k + 1}) = ${12 * (k + 2)}` },
                        { kind: "math", expr: `8x+${4 * k} - 3x + ${3 * (k + 1)} = ${12 * (k + 2)}` },
                        { kind: "math", expr: `5x + ${4 * k + 3 * (k + 1)} = ${12 * (k + 2)}` },
                        { kind: "math", expr: `5x + ${7 * k + 3} = ${12 * k + 24}` },
                        { kind: "math", expr: `5x = ${12 * k + 24} - (${7 * k + 3})` },
                        { kind: "math", expr: `5x = ${5 * k + 21}` },
                        { kind: "math", expr: `x = ${k} + \\frac{21}{5}` }
                    ];

                    // Add extremely long working to all Section C items for stress
                    const extraLong = extremelyLongWorkingLines();

                    const altWorkingLines = (k === 3 || k === 6) ? [
                        { kind: "text", segs: [mkText("Alternative working: put everything over a common denominator first.")] },
                        { kind: "math", expr: `\\frac{4(2x+${k}) - 3(x-${k + 1})}{12} = ${k + 2}` },
                        { kind: "math", expr: `4(2x+${k}) - 3(x-${k + 1}) = 12(${k + 2})` }
                    ] : [];

                    blocks.push(qNode({
                        id,
                        depth: 0,
                        promptSegs,
                        answerSegs,
                        solution: mkSolution({
                            guidance,
                            formulas,
                            workingLines: [...workingLines, ...extraLong],
                            altWorkingLines
                        })
                    }));
                }

                return {
                    key: "sectioned",
                    label: "Sectioned paper",
                    title: "Sectioned paper",
                    subtitle: "Section A: 35 • Section B: 8 • Section C: 6 (very long Solution Details, collapsed by default)",
                    defaultExpanded: false,
                    blocks
                };
            }

            const DATASETS = [
                buildShortPaper(),
                buildStandardPaper({ expanded: false }),
                buildStandardPaper({ expanded: true }), // add-on dataset variant
                buildDiagramHeavyPaper(),
                buildSectionedPaper()
            ];

            // ---------- Rendering ----------
            const paperSelect = document.getElementById("paperSelect");
            const navMount = document.getElementById("navMount");
            const drawerNavMount = document.getElementById("drawerNavMount");
            const paperMount = document.getElementById("paperMount");

            const drawerBackdrop = document.getElementById("drawerBackdrop");
            const drawer = document.getElementById("drawer");
            const jumpBtn = document.getElementById("jumpBtn");
            const drawerClose = document.getElementById("drawerClose");
            const appFrame = document.getElementById("appFrame");

            let activeObserver = null;
            let currentDatasetKey = null;

            function buildSelect() {
                paperSelect.innerHTML = DATASETS.map(d => `<option value="${escapeHtml(d.key)}">${escapeHtml(d.label)}</option>`).join("");
            }

            function flattenNav(blocks) {
                // Produces array of {type:'sep', label} or {type:'item', id, label}
                const out = [];
                function walk(node) {
                    if (!node) return;
                    if (node.type === "section") {
                        out.push({ type: "sep", label: node.label });
                        return;
                    }
                    if (node.type === "q") {
                        out.push({ type: "item", id: node.id, label: node.id });
                        if (node.children && node.children.length) {
                            for (const ch of node.children) walk(ch);
                        }
                    }
                }
                for (const b of blocks) walk(b);
                return out;
            }

            function renderNav(navItems, mountEl, kind) {
                const parts = [];
                parts.push(`<ul class="${kind === 'drawer' ? '' : 'nav-list'}">`);
                for (const it of navItems) {
                    if (it.type === "sep") {
                        parts.push(`</ul><div class="sep">${escapeHtml(it.label)}</div><ul class="${kind === 'drawer' ? '' : 'nav-list'}">`);
                        continue;
                    }
                    const href = "#" + slugifyId(it.id);
                    parts.push(`<li><a href="${href}" data-nav="${escapeHtml(it.id)}">${escapeHtml(it.label)}</a></li>`);
                }
                parts.push(`</ul>`);
                mountEl.innerHTML = parts.join("");
            }

            function renderSolution(solution, qAnchorId, isExpandedDefault) {
                if (!solution) return "";

                const sid = `sd-${qAnchorId}`;
                const btnId = `btn-${qAnchorId}`;

                const expanded = !!isExpandedDefault;
                const ariaExpanded = expanded ? "true" : "false";
                const hiddenAttr = expanded ? "" : " hidden";

                const chev = expanded ? "▾" : "▸";
                const label = expanded ? "Hide working" : "Show working";

                const blocks = [];

                // Guidance (label must be Keep in mind)
                if (solution.guidance && solution.guidance.length) {
                    blocks.push(`
            <div class="sd-block">
              <p class="sd-title">Keep in mind</p>
              <div class="sd-body">
                ${solution.guidance.map(line => line.kind === "text" ? `<p>${renderSegments(line.segs)}</p>` : `<div class="sd-line">${renderSegments([{ t: "math_block", v: line.expr }])}</div>`).join("")}
              </div>
            </div>
          `);
                }

                // Formulas used
                if (solution.formulas && solution.formulas.length) {
                    blocks.push(`
            <div class="sd-block">
              <p class="sd-title">Formulas used</p>
              <div class="sd-body">
                ${solution.formulas.map(line => line.kind === "text" ? `<p>${renderSegments(line.segs)}</p>` : `<div class="sd-line">${renderSegments([{ t: "math_block", v: line.expr }])}</div>`).join("")}
              </div>
            </div>
          `);
                }

                // Working
                if (solution.workingLines && solution.workingLines.length) {
                    blocks.push(`
            <div class="sd-block">
              <p class="sd-title">Working</p>
              <div class="sd-body">
                ${solution.workingLines.map(line => {
                        if (line.kind === "text") return `<p>${renderSegments(line.segs)}</p>`;
                        return `<div class="sd-line">${renderSegments([{ t: "math_block", v: line.expr }])}</div>`;
                    }).join("")}
              </div>
            </div>
          `);
                }

                // Alternative working (0+)
                if (solution.altWorkingLines && solution.altWorkingLines.length) {
                    blocks.push(`
            <div class="sd-block">
              <p class="sd-title">Alternative working</p>
              <div class="sd-body">
                ${solution.altWorkingLines.map(line => {
                        if (line.kind === "text") return `<p>${renderSegments(line.segs)}</p>`;
                        return `<div class="sd-line">${renderSegments([{ t: "math_block", v: line.expr }])}</div>`;
                    }).join("")}
              </div>
            </div>
          `);
                }

                return `
          <div class="sd-toggle-row">
            <button
              class="sd-toggle"
              type="button"
              id="${btnId}"
              aria-expanded="${ariaExpanded}"
              aria-controls="${sid}"
              data-toggle="${escapeHtml(qAnchorId)}"
            ><span class="chev" aria-hidden="true">${chev}</span>${label}</button>
          </div>
          <div class="solution" id="${sid}"${hiddenAttr}>
            ${blocks.join("")}
          </div>
        `;
            }

            function renderQuestionNode(node, defaultExpanded) {
                const anchorId = slugifyId(node.id);
                const depthClass = `q-depth-${Math.min(node.depth, 2)}`;

                const promptHtml = renderSegments(node.promptSegs);
                const answerHtml = (node.answerSegs && node.answerSegs.length)
                    ? `
            <div class="answer">
              <div class="a-label">Answer</div>
              <div class="a-value">${renderSegments(node.answerSegs)}</div>
            </div>
          `
                    : "";

                const solutionHtml = node.solution
                    ? renderSolution(node.solution, anchorId, defaultExpanded)
                    : "";

                let childrenHtml = "";
                if (node.children && node.children.length) {
                    childrenHtml = node.children.map(ch => renderQuestionNode(ch, defaultExpanded)).join("");
                }

                return `
          <section class="question ${depthClass}" id="${anchorId}" data-navid="${escapeHtml(node.id)}">
            <div class="q-wrap">
              <div class="q-head">
                <div class="q-id">${escapeHtml(node.id)}</div>
                <div class="q-prompt">${wrapAsParagraphs(promptHtml)}</div>
              </div>
              ${answerHtml}
              ${solutionHtml}
              ${childrenHtml}
            </div>
          </section>
        `;
            }

            function wrapAsParagraphs(promptHtml) {
                // promptHtml may include a diagram block; keep it inside the question prompt area.
                // We’ll wrap text chunks into <p> where appropriate, preserving any diagram divs and math blocks.
                // Simple heuristic: if promptHtml contains "<div class="diagram">", place it as its own block after a paragraph.
                if (!promptHtml) return "";
                const hasDiagram = promptHtml.includes('class="diagram"');
                if (!hasDiagram) {
                    return `<p>${promptHtml}</p>`;
                }

                // Split: everything before first diagram becomes a paragraph; diagrams remain as-is; rest becomes paragraph.
                const marker = '<div class="diagram">';
                const parts = promptHtml.split(marker);
                const before = parts[0];
                const after = parts.slice(1).join(marker); // include rest markers
                // Re-insert marker for after
                const reconstructed = marker + after;
                // Now find the end of first diagram div
                // We assume svgPlaceholder returns a full <div class="diagram">...</div>
                // We'll keep the entire reconstructed content and just wrap the leading text.
                return `${before.trim() ? `<p>${before.trim()}</p>` : ""}${reconstructed}`;
            }

            function renderPaper(dataset) {
                const navItems = flattenNav(dataset.blocks);

                // Render navigation (desktop rail + drawer)
                renderNav(navItems, navMount, "rail");
                renderNav(navItems, drawerNavMount, "drawer");

                // Render paper content
                const blocksHtml = dataset.blocks.map(b => {
                    if (b.type === "section") {
                        return `
              <div class="section" aria-label="Section ${escapeHtml(b.label)}">
                <p class="section-label">Section ${escapeHtml(b.label)}</p>
              </div>
            `;
                    }
                    return renderQuestionNode(b, dataset.defaultExpanded);
                }).join("");

                paperMount.innerHTML = `
          <h1 class="paper-title">${escapeHtml(dataset.title)}</h1>
          <p class="paper-sub">${escapeHtml(dataset.subtitle)}</p>
          ${blocksHtml}
        `;

                // Bind toggles within paper
                bindToggles();

                // Render KaTeX within paper
                renderKatex(paperMount);

                // Set up active nav highlighting
                setupActiveNavObserver(navItems);

                // Ensure document starts at top when switching dataset (document continuity within a dataset is preserved)
                window.scrollTo(0, 0);
            }

            function bindToggles() {
                const btns = paperMount.querySelectorAll("button[data-toggle]");
                for (const btn of btns) {
                    btn.addEventListener("click", () => {
                        const qAnchorId = btn.getAttribute("data-toggle");
                        const panel = document.getElementById(`sd-${qAnchorId}`);
                        if (!panel) return;

                        const isOpen = !panel.hasAttribute("hidden");
                        const nextOpen = !isOpen;

                        // update panel
                        if (nextOpen) panel.removeAttribute("hidden");
                        else panel.setAttribute("hidden", "");

                        // update button state and label
                        btn.setAttribute("aria-expanded", nextOpen ? "true" : "false");
                        const chev = btn.querySelector(".chev");
                        if (chev) chev.textContent = nextOpen ? "▾" : "▸";
                        btn.childNodes.forEach(n => {
                            // keep only text node after chevron
                        });
                        // Replace label text safely
                        const labelText = nextOpen ? "Hide working" : "Show working";
                        // Keep chevron span, replace rest
                        btn.innerHTML = `<span class="chev" aria-hidden="true">${nextOpen ? "▾" : "▸"}</span>${labelText}`;

                        // Re-render KaTeX inside newly revealed content (no focus movement, no forced scrolling)
                        if (nextOpen) renderKatex(panel);
                    }, { passive: true });
                }
            }

            function setupActiveNavObserver(navItems) {
                if (activeObserver) activeObserver.disconnect();

                const anchors = paperMount.querySelectorAll(".question[data-navid]");
                const mapIdToLinks = new Map();

                // collect links from both navs
                const railLinks = navMount.querySelectorAll("a[data-nav]");
                const drawerLinks = drawerNavMount.querySelectorAll("a[data-nav]");
                for (const a of [...railLinks, ...drawerLinks]) {
                    const id = a.getAttribute("data-nav");
                    if (!mapIdToLinks.has(id)) mapIdToLinks.set(id, []);
                    mapIdToLinks.get(id).push(a);
                }

                function setCurrent(id) {
                    for (const [key, links] of mapIdToLinks.entries()) {
                        const isCurrent = key === id;
                        for (const a of links) {
                            a.setAttribute("aria-current", isCurrent ? "true" : "false");
                        }
                    }
                }

                // Default: first question (if any)
                const first = anchors[0];
                if (first) setCurrent(first.getAttribute("data-navid"));

                // IntersectionObserver to pick the question nearest the top
                const options = {
                    root: null,
                    rootMargin: "-72px 0px -70% 0px",
                    threshold: [0, 0.1, 0.5, 1]
                };

                activeObserver = new IntersectionObserver((entries) => {
                    // pick the entry that is intersecting and has the smallest top distance
                    const visible = entries.filter(e => e.isIntersecting);
                    if (!visible.length) return;

                    // Choose the one closest to the top of viewport
                    visible.sort((a, b) => a.boundingClientRect.top - b.boundingClientRect.top);
                    const best = visible[0].target;
                    const id = best.getAttribute("data-navid");
                    if (id) setCurrent(id);
                }, options);

                for (const el of anchors) activeObserver.observe(el);

                // Navigation click: close drawer if open, no state changes to workings (invariant)
                function onNavClick(e) {
                    const a = e.target.closest("a[data-nav]");
                    if (!a) return;
                    closeDrawer();
                    // Let default anchor jump happen (no smooth scroll, no auto expansion)
                }
                navMount.removeEventListener("click", onNavClick);
                drawerNavMount.removeEventListener("click", onNavClick);
                navMount.addEventListener("click", onNavClick);
                drawerNavMount.addEventListener("click", onNavClick);
            }

            // ---------- Drawer (mobile navigation) ----------
            let lastFocus = null;

            function openDrawer() {
                lastFocus = document.activeElement;
                document.body.classList.add("no-scroll");
                drawerBackdrop.classList.add("open");
                drawer.classList.add("open");

                // prevent background interaction (best-effort)
                appFrame.setAttribute("aria-hidden", "true");
                if ("inert" in appFrame) appFrame.inert = true;

                // focus first focusable item
                const firstLink = drawer.querySelector("a,button,select,input,[tabindex]:not([tabindex='-1'])");
                (firstLink || drawerClose).focus();
            }

            function closeDrawer() {
                if (!drawer.classList.contains("open")) return;
                document.body.classList.remove("no-scroll");
                drawerBackdrop.classList.remove("open");
                drawer.classList.remove("open");

                appFrame.removeAttribute("aria-hidden");
                if ("inert" in appFrame) appFrame.inert = false;

                if (lastFocus && typeof lastFocus.focus === "function") lastFocus.focus();
            }

            function trapFocus(e) {
                if (!drawer.classList.contains("open")) return;
                if (e.key !== "Tab") return;

                const focusables = drawer.querySelectorAll("a,button,select,input,[tabindex]:not([tabindex='-1'])");
                if (!focusables.length) return;

                const first = focusables[0];
                const last = focusables[focusables.length - 1];

                if (e.shiftKey && document.activeElement === first) {
                    e.preventDefault();
                    last.focus();
                } else if (!e.shiftKey && document.activeElement === last) {
                    e.preventDefault();
                    first.focus();
                }
            }

            // ---------- Dataset switching ----------
            function getDataset(key) {
                return DATASETS.find(d => d.key === key) || DATASETS[0];
            }

            function setDataset(key) {
                currentDatasetKey = key;
                const ds = getDataset(key);
                renderPaper(ds);
            }

            // ---------- Init ----------
            buildSelect();
            paperSelect.addEventListener("change", () => {
                setDataset(paperSelect.value);
            });

            // Drawer controls
            jumpBtn.addEventListener("click", openDrawer);
            drawerClose.addEventListener("click", closeDrawer);
            drawerBackdrop.addEventListener("click", closeDrawer);
            document.addEventListener("keydown", (e) => {
                if (e.key === "Escape") closeDrawer();
                trapFocus(e);
            });

            // Initial dataset
            const initialKey = DATASETS[0].key;
            paperSelect.value = initialKey;
            setDataset(initialKey);

            // If KaTeX loads after initial render, re-render math (graceful)
            window.addEventListener("load", () => {
                renderKatex(document);
            }, { once: true });
        })();
    </script>
</body>

</html>