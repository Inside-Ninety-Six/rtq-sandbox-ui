<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>RTQ — Maths Paper Solution Viewer (Stress Test Harness)</title>

    <!-- Real KaTeX Rendering add-on (CDN). If it fails, we fall back to plain text. -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js" crossorigin="anonymous"></script>

    <style>
        :root {
            /* Stage 5: soft-warm neutral base (subtle, low-chroma; avoid decorative warmth) */
            --page-bg: #f3f1ee;
            --paper-bg: #fbfaf8;
            --nav-bg: transparent;
            --details-bg: #f7f5f2;

            --text-strong: #1f1f1f;
            --text: #2b2b2b;
            --text-soft: #4a4a4a;
            --text-quiet: #6a6a6a;

            --rule: rgba(0, 0, 0, 0.10);
            --rule-soft: rgba(0, 0, 0, 0.07);

            --focus: rgba(0, 0, 0, 0.45);

            --frame-max: 1160px;
            --gutter: 18px;

            --nav-col: 92px;
            --nav-gap: 26px;

            --q-gap: 28px;
            /* biggest spacing between top-level questions */
            --within-gap: 10px;
            /* question → answer */
            --toggle-gap: 8px;
            /* answer → toggle */
            --details-gap: 14px;
            /* inside details */

            --indent-step: 16px;
            /* nesting indentation */
            --radius: 10px;

            --font: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Noto Sans", "Liberation Sans", sans-serif;

            --transition: 180ms;
        }

        * {
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
        }

        body {
            margin: 0;
            font-family: var(--font);
            color: var(--text);
            background: var(--page-bg);
            line-height: 1.45;
            overflow-x: hidden;
            /* main document must never scroll horizontally */
        }

        /* Top controls */
        header {
            position: sticky;
            top: 0;
            z-index: 20;
            background: linear-gradient(to bottom, rgba(243, 241, 238, 0.98), rgba(243, 241, 238, 0.92));
            border-bottom: 1px solid var(--rule-soft);
            backdrop-filter: blur(6px);
        }

        .topbar {
            max-width: var(--frame-max);
            margin: 0 auto;
            padding: 12px var(--gutter);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .topbar .title {
            font-size: 14px;
            letter-spacing: 0.02em;
            color: var(--text-quiet);
            white-space: nowrap;
            user-select: none;
        }

        .topbar .spacer {
            flex: 1;
        }

        label {
            font-size: 13px;
            color: var(--text-soft);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        select {
            font: inherit;
            font-size: 14px;
            padding: 8px 10px;
            border-radius: 10px;
            border: 1px solid var(--rule);
            background: var(--paper-bg);
            color: var(--text);
            outline: none;
            min-width: 260px;
        }

        select:focus {
            outline: 2px solid var(--focus);
            outline-offset: 2px;
        }

        .jumpBtn {
            font: inherit;
            font-size: 14px;
            padding: 8px 10px;
            border-radius: 10px;
            border: 1px solid var(--rule);
            background: var(--paper-bg);
            color: var(--text);
            cursor: pointer;
        }

        .jumpBtn:hover {
            text-decoration: underline;
        }

        .jumpBtn:focus {
            outline: 2px solid var(--focus);
            outline-offset: 2px;
        }

        /* Main frame */
        .frame {
            max-width: var(--frame-max);
            margin: 0 auto;
            padding: 18px var(--gutter) 56px;
            display: grid;
            grid-template-columns: var(--nav-col) 1fr;
            gap: var(--nav-gap);
            align-items: start;
        }

        nav {
            position: sticky;
            top: 62px;
            /* below topbar; stable */
            align-self: start;
            background: var(--nav-bg);
            color: var(--text-quiet);
        }

        .navInner {
            max-height: calc(100vh - 74px);
            overflow-y: auto;
            padding: 4px 0 12px;
            /* Scrollable Navigation Without Visible Scrollbars add-on */
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .navInner::-webkit-scrollbar {
            display: none;
        }

        .navSectionLabel {
            margin: 10px 0 6px;
            font-size: 12px;
            letter-spacing: 0.06em;
            color: var(--text-quiet);
            text-transform: uppercase;
            user-select: none;
        }

        .navList {
            display: flex;
            flex-direction: column;
            gap: 2px;
            padding: 0;
            margin: 0;
            list-style: none;
        }

        .navLink {
            appearance: none;
            border: 0;
            background: transparent;
            padding: 6px 6px;
            width: 100%;
            text-align: left;
            font: inherit;
            font-size: 13px;
            color: var(--text-quiet);
            cursor: pointer;
            border-radius: 8px;
            line-height: 1.1;
            display: grid;
            grid-template-columns: 8px 1fr;
            align-items: center;
            gap: 6px;
        }

        .navLink .marker {
            width: 6px;
            height: 6px;
            border-radius: 99px;
            background: transparent;
        }

        .navLink:hover {
            text-decoration: underline;
            /* one minimal change */
        }

        .navLink:focus {
            outline: 2px solid var(--focus);
            outline-offset: 2px;
        }

        .navLink[aria-current="true"] {
            color: var(--text);
            font-weight: 600;
            /* only current nav item bold */
            text-decoration: none;
        }

        .navLink[aria-current="true"] .marker {
            background: rgba(0, 0, 0, 0.35);
            /* restrained */
        }

        main {
            background: var(--paper-bg);
            border-radius: var(--radius);
            padding: 18px 18px 26px;
            border: 1px solid rgba(0, 0, 0, 0.08);
        }

        /* Section headers inside paper (dividers, not containers) */
        .paperSection {
            margin: 22px 0 10px;
            padding: 10px 0 0;
            border-top: 1px solid var(--rule);
        }

        .paperSection h2 {
            margin: 0 0 8px;
            font-size: 15px;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--text-soft);
            font-weight: 600;
        }

        /* Question units */
        .q {
            margin: 0 0 var(--q-gap);
        }

        .q:last-child {
            margin-bottom: 0;
        }

        .qInner {
            display: grid;
            grid-template-columns: 38px 1fr;
            gap: 12px;
            align-items: start;
        }

        .qid {
            font-size: 14px;
            color: var(--text-soft);
            text-align: right;
            padding-top: 2px;
            user-select: none;
        }

        .qPrompt {
            font-size: 16px;
            /* Question text: primary anchor */
            color: var(--text-strong);
            line-height: 1.55;
        }

        .qPrompt p {
            margin: 0 0 10px;
        }

        .qPrompt p:last-child {
            margin-bottom: 0;
        }

        .answerRow {
            margin-top: var(--within-gap);
            display: grid;
            grid-template-columns: 38px 1fr;
            gap: 12px;
            align-items: baseline;
        }

        .answerBox {
            color: var(--text);
            font-size: 14px;
        }

        .answerLabel {
            font-weight: 600;
            /* labels allowed */
            color: var(--text-soft);
            margin-right: 8px;
        }

        .answerValue {
            color: var(--text);
        }

        .toggleRow {
            margin-top: var(--toggle-gap);
            display: grid;
            grid-template-columns: 38px 1fr;
            gap: 12px;
        }

        .toggleBtn {
            justify-self: start;
            appearance: none;
            background: transparent;
            border: 0;
            padding: 2px 0;
            font: inherit;
            font-size: 14px;
            color: var(--text-soft);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            border-radius: 8px;
        }

        .toggleBtn:hover {
            text-decoration: underline;
        }

        /* single minimal change */
        .toggleBtn:focus {
            outline: 2px solid var(--focus);
            outline-offset: 3px;
            text-decoration: none;
        }

        .chev {
            font-size: 12px;
            line-height: 1;
            transform: translateY(1px);
            color: var(--text-quiet);
        }

        /* Solution Details region (subordinate; light surface separation) */
        .detailsWrap {
            grid-column: 2 / 3;
            margin-top: 10px;
            padding: 12px 12px;
            background: var(--details-bg);
            border-radius: 10px;
            border: 1px solid rgba(0, 0, 0, 0.06);
        }

        /* Calm continuity transitions (respects reduced motion) */
        .details {
            overflow: hidden;
            max-height: 0;
            opacity: 0.001;
            transition: max-height var(--transition) ease, opacity var(--transition) ease;
        }

        .details.isOpen {
            opacity: 1;
        }

        @media (prefers-reduced-motion: reduce) {
            .details {
                transition: none;
            }
        }

        .detailsBlock {
            margin: 0 0 var(--details-gap);
        }

        .detailsBlock:last-child {
            margin-bottom: 0;
        }

        .detailsLabel {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-soft);
            margin: 0 0 6px;
        }

        .detailsBody {
            font-size: 14px;
            color: var(--text-soft);
            line-height: 1.42;
            /* slightly tighter than question */
        }

        /* No paragraph-level bold in Solution Details */
        .detailsBody strong,
        .detailsBody b {
            font-weight: 600;
        }

        /* still avoid in long blocks; we won't use */

        .detailsBody p {
            margin: 0 0 8px;
        }

        .detailsBody p:last-child {
            margin-bottom: 0;
        }

        /* KaTeX overflow rules: no page horizontal scrolling; allow only within block math containers */
        .math-inline {
            white-space: nowrap;
        }

        .math-block {
            margin: 10px 0;
            padding: 8px 10px;
            border: 1px solid rgba(0, 0, 0, 0.06);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.55);
            overflow-x: auto;
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .math-block::-webkit-scrollbar {
            display: none;
        }

        /* Keep math from pushing layout */
        .katex-display {
            margin: 0.2em 0;
        }

        /* Diagrams: inline SVG placeholders */
        .diagram {
            margin: 10px 0 2px;
            border: 1px solid rgba(0, 0, 0, 0.08);
            border-radius: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.52);
        }

        .diagram svg {
            display: block;
            width: 100%;
            height: auto;
        }

        .diagram .cap {
            margin-top: 8px;
            font-size: 12px;
            color: var(--text-quiet);
        }

        /* Nesting indentation only (no borders/containers) */
        .q[data-depth="1"] {
            margin-bottom: calc(var(--q-gap) * 0.78);
        }

        .q[data-depth="2"] {
            margin-bottom: calc(var(--q-gap) * 0.62);
        }

        .q[data-depth="3"] {
            margin-bottom: calc(var(--q-gap) * 0.52);
        }

        .q[data-depth="1"] .qInner,
        .q[data-depth="1"] .answerRow,
        .q[data-depth="1"] .toggleRow {
            padding-left: calc(var(--indent-step) * 1);
        }

        .q[data-depth="2"] .qInner,
        .q[data-depth="2"] .answerRow,
        .q[data-depth="2"] .toggleRow {
            padding-left: calc(var(--indent-step) * 2);
        }

        .q[data-depth="3"] .qInner,
        .q[data-depth="3"] .answerRow,
        .q[data-depth="3"] .toggleRow {
            padding-left: calc(var(--indent-step) * 3);
        }

        /* Responsive: tablet/mobile drawer */
        @media (max-width: 900px) {
            :root {
                --nav-col: 0px;
                --nav-gap: 0px;
                --gutter: 14px;
            }

            .frame {
                grid-template-columns: 1fr;
                gap: 0;
                padding-top: 12px;
            }

            nav {
                display: none;
            }

            main {
                border-radius: 12px;
                padding: 16px 14px 22px;
            }

            select {
                min-width: 210px;
            }

            .topbar .title {
                display: none;
            }

            /* keep controls stable; title can drop quietly */
            /* adapt indentation to preserve width */
            :root {
                --indent-step: 12px;
            }
        }

        /* Drawer */
        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.25);
            display: none;
            z-index: 50;
        }

        .overlay.isOpen {
            display: block;
        }

        .drawer {
            position: fixed;
            top: 0;
            right: 0;
            height: 100%;
            width: min(78vw, 360px);
            background: var(--paper-bg);
            border-left: 1px solid rgba(0, 0, 0, 0.10);
            padding: 14px 14px 12px;
            display: none;
            z-index: 60;
        }

        .drawer.isOpen {
            display: block;
        }

        .drawerHeader {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 10px;
        }

        .drawerTitle {
            font-size: 13px;
            color: var(--text-soft);
            letter-spacing: 0.02em;
            user-select: none;
        }

        .closeBtn {
            font: inherit;
            font-size: 14px;
            padding: 8px 10px;
            border-radius: 10px;
            border: 1px solid var(--rule);
            background: var(--paper-bg);
            color: var(--text);
            cursor: pointer;
        }

        .closeBtn:hover {
            text-decoration: underline;
        }

        .closeBtn:focus {
            outline: 2px solid var(--focus);
            outline-offset: 2px;
        }

        .drawerNav {
            max-height: calc(100vh - 66px);
            overflow-y: auto;
            padding-right: 2px;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .drawerNav::-webkit-scrollbar {
            display: none;
        }

        /* Utility */
        .srOnly {
            position: absolute !important;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
    </style>
</head>

<body>
    <header>
        <div class="topbar" id="topbar">
            <div class="title">RTQ — Paper</div>

            <label for="paperSelect">
                <span>Paper selector</span>
                <select id="paperSelect" aria-label="Paper selector">
                    <option value="short">Short paper</option>
                    <option value="standard">Standard paper</option>
                    <option value="standard_expanded">Standard (Workings Expanded)</option>
                    <option value="diagram">Diagram-heavy paper</option>
                    <option value="sectioned">Sectioned paper</option>
                </select>
            </label>

            <div class="spacer"></div>

            <button class="jumpBtn" id="jumpBtn" type="button" aria-haspopup="dialog" aria-controls="drawer"
                aria-expanded="false">
                Jump to
            </button>
        </div>
    </header>

    <div class="frame" id="frame">
        <nav aria-label="Paper navigation">
            <div class="navInner" id="navInner">
                <!-- Built by JS -->
            </div>
        </nav>

        <main id="paper" tabindex="-1">
            <!-- Built by JS -->
        </main>
    </div>

    <!-- Mobile/Tablet drawer -->
    <div class="overlay" id="overlay" aria-hidden="true"></div>
    <div class="drawer" id="drawer" role="dialog" aria-modal="true" aria-label="Jump to question" aria-hidden="true">
        <div class="drawerHeader">
            <div class="drawerTitle">Jump to</div>
            <button class="closeBtn" id="closeBtn" type="button">Close</button>
        </div>
        <div class="drawerNav" id="drawerNav">
            <!-- Built by JS -->
        </div>
    </div>

    <script>
        (function () {
            const paperEl = document.getElementById('paper');
            const navInner = document.getElementById('navInner');
            const drawerNav = document.getElementById('drawerNav');
            const paperSelect = document.getElementById('paperSelect');
            const jumpBtn = document.getElementById('jumpBtn');
            const overlay = document.getElementById('overlay');
            const drawer = document.getElementById('drawer');
            const closeBtn = document.getElementById('closeBtn');
            const frame = document.getElementById('frame');

            const prefersReducedMotion = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;

            // ---- Diagram library (4 reusable types) ----
            const Diagram = {
                geometry(labelA = 'A', labelB = 'B', labelC = 'C') {
                    return `
            <div class="diagram" role="img" aria-label="Geometry diagram placeholder">
              <svg viewBox="0 0 520 220" aria-hidden="true">
                <rect x="0" y="0" width="520" height="220" fill="none"/>
                <circle cx="130" cy="110" r="74" fill="none" stroke="rgba(0,0,0,0.50)" stroke-width="2"/>
                <polygon points="310,40 470,170 280,170" fill="none" stroke="rgba(0,0,0,0.55)" stroke-width="2"/>
                <line x1="310" y1="40" x2="280" y2="170" stroke="rgba(0,0,0,0.35)" stroke-dasharray="6 6" stroke-width="2"/>
                <text x="300" y="34" font-size="16" fill="rgba(0,0,0,0.55)">${labelA}</text>
                <text x="474" y="182" font-size="16" fill="rgba(0,0,0,0.55)">${labelB}</text>
                <text x="266" y="184" font-size="16" fill="rgba(0,0,0,0.55)">${labelC}</text>
                <text x="104" y="114" font-size="14" fill="rgba(0,0,0,0.45)">circle</text>
              </svg>
              <div class="cap">Diagram not to scale.</div>
            </div>
          `;
                },
                ratioBars() {
                    return `
            <div class="diagram" role="img" aria-label="Ratio bars diagram placeholder">
              <svg viewBox="0 0 520 170" aria-hidden="true">
                <rect x="0" y="0" width="520" height="170" fill="none"/>
                <text x="10" y="24" font-size="14" fill="rgba(0,0,0,0.55)">A</text>
                <rect x="40" y="12" width="430" height="26" fill="none" stroke="rgba(0,0,0,0.55)" stroke-width="2"/>
                <line x1="180" y1="12" x2="180" y2="38" stroke="rgba(0,0,0,0.35)" stroke-width="2"/>
                <line x1="320" y1="12" x2="320" y2="38" stroke="rgba(0,0,0,0.35)" stroke-width="2"/>

                <text x="10" y="84" font-size="14" fill="rgba(0,0,0,0.55)">B</text>
                <rect x="40" y="72" width="430" height="26" fill="none" stroke="rgba(0,0,0,0.55)" stroke-width="2"/>
                <line x1="125" y1="72" x2="125" y2="98" stroke="rgba(0,0,0,0.35)" stroke-width="2"/>
                <line x1="210" y1="72" x2="210" y2="98" stroke="rgba(0,0,0,0.35)" stroke-width="2"/>
                <line x1="295" y1="72" x2="295" y2="98" stroke="rgba(0,0,0,0.35)" stroke-width="2"/>

                <text x="40" y="140" font-size="13" fill="rgba(0,0,0,0.45)">Equal-sized parts shown by dividers.</text>
              </svg>
              <div class="cap">Ratio bars.</div>
            </div>
          `;
                },
                coordGrid() {
                    return `
            <div class="diagram" role="img" aria-label="Coordinate grid diagram placeholder">
              <svg viewBox="0 0 520 220" aria-hidden="true">
                <rect x="40" y="20" width="440" height="170" fill="none" stroke="rgba(0,0,0,0.45)" stroke-width="2"/>
                ${Array.from({ length: 10 }).map((_, i) => {
                        const x = 40 + (i + 1) * 40;
                        return `<line x1="${x}" y1="20" x2="${x}" y2="190" stroke="rgba(0,0,0,0.12)" stroke-width="2"/>`;
                    }).join('')}
                ${Array.from({ length: 3 }).map((_, i) => {
                        const y = 20 + (i + 1) * 42.5;
                        return `<line x1="40" y1="${y}" x2="480" y2="${y}" stroke="rgba(0,0,0,0.12)" stroke-width="2"/>`;
                    }).join('')}
                <line x1="40" y1="190" x2="480" y2="190" stroke="rgba(0,0,0,0.55)" stroke-width="2"/>
                <line x1="40" y1="20" x2="40" y2="190" stroke="rgba(0,0,0,0.55)" stroke-width="2"/>
                <circle cx="200" cy="130" r="6" fill="rgba(0,0,0,0.45)"/>
                <circle cx="360" cy="70" r="6" fill="rgba(0,0,0,0.45)"/>
                <line x1="200" y1="130" x2="360" y2="70" stroke="rgba(0,0,0,0.45)" stroke-width="2"/>
                <text x="188" y="152" font-size="14" fill="rgba(0,0,0,0.55)">(2,3)</text>
                <text x="346" y="62" font-size="14" fill="rgba(0,0,0,0.55)">(4,5)</text>
              </svg>
              <div class="cap">Coordinate grid.</div>
            </div>
          `;
                },
                arrayGrid() {
                    return `
            <div class="diagram" role="img" aria-label="Table-like grid diagram placeholder">
              <svg viewBox="0 0 520 190" aria-hidden="true">
                <rect x="70" y="30" width="380" height="120" fill="none" stroke="rgba(0,0,0,0.55)" stroke-width="2"/>
                ${Array.from({ length: 4 }).map((_, i) => {
                        const x = 70 + (i + 1) * 95;
                        return `<line x1="${x}" y1="30" x2="${x}" y2="150" stroke="rgba(0,0,0,0.28)" stroke-width="2"/>`;
                    }).join('')}
                ${Array.from({ length: 2 }).map((_, i) => {
                        const y = 30 + (i + 1) * 40;
                        return `<line x1="70" y1="${y}" x2="450" y2="${y}" stroke="rgba(0,0,0,0.28)" stroke-width="2"/>`;
                    }).join('')}
                <text x="88" y="56" font-size="14" fill="rgba(0,0,0,0.55)">2</text>
                <text x="183" y="56" font-size="14" fill="rgba(0,0,0,0.55)">4</text>
                <text x="278" y="56" font-size="14" fill="rgba(0,0,0,0.55)">6</text>
                <text x="373" y="56" font-size="14" fill="rgba(0,0,0,0.55)">8</text>

                <text x="88" y="96" font-size="14" fill="rgba(0,0,0,0.55)">3</text>
                <text x="183" y="96" font-size="14" fill="rgba(0,0,0,0.55)">6</text>
                <text x="278" y="96" font-size="14" fill="rgba(0,0,0,0.55)">9</text>
                <text x="373" y="96" font-size="14" fill="rgba(0,0,0,0.55)">12</text>

                <text x="88" y="136" font-size="14" fill="rgba(0,0,0,0.55)">5</text>
                <text x="183" y="136" font-size="14" fill="rgba(0,0,0,0.55)">10</text>
                <text x="278" y="136" font-size="14" fill="rgba(0,0,0,0.55)">15</text>
                <text x="373" y="136" font-size="14" fill="rgba(0,0,0,0.55)">20</text>
              </svg>
              <div class="cap">Table-like grid.</div>
            </div>
          `;
                }
            };

            // ---- Math helpers (KaTeX programmatic rendering) ----
            function mi(latex) {
                return `<span class="math-inline" data-latex="${escapeAttr(latex)}">${escapeHtml(latex)}</span>`;
            }
            function mb(latex) {
                return `<div class="math-block" data-latex="${escapeAttr(latex)}">${escapeHtml(latex)}</div>`;
            }
            function escapeHtml(s) {
                return (s ?? '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
            }
            function escapeAttr(s) {
                return escapeHtml(s).replace(/\n/g, '&#10;');
            }

            function renderKaTeXWithin(root) {
                // Graceful fallback: if KaTeX isn't available, we leave the text.
                if (!window.katex || !window.katex.render) return;

                // Inline
                root.querySelectorAll('.math-inline[data-latex]').forEach(el => {
                    const latex = el.getAttribute('data-latex') || '';
                    try {
                        window.katex.render(latex, el, { throwOnError: false, displayMode: false });
                    } catch (e) {
                        el.textContent = latex;
                    }
                });

                // Block
                root.querySelectorAll('.math-block[data-latex]').forEach(el => {
                    const latex = el.getAttribute('data-latex') || '';
                    try {
                        window.katex.render(latex, el, { throwOnError: false, displayMode: true });
                    } catch (e) {
                        el.textContent = latex;
                    }
                });
            }

            // ---- Dataset definitions ----
            function depthFromId(qid) {
                // Base depth 0 for "1", deeper for parentheses groups or letter suffixes.
                // 1 -> 0
                // 7a -> 1
                // 18(a) -> 1
                // 18(a)(i) -> 2
                // 30(a)(ii) -> 2
                // 18(b) -> 1
                let d = 0;
                const hasParen = (qid.match(/\(/g) || []).length;
                if (hasParen > 0) d = hasParen; // each (...) adds depth
                else if (/[a-z]$/i.test(qid)) d = 1;
                return Math.min(3, d);
            }

            function longWorkingLines(count, seed) {
                const lines = [];
                for (let i = 1; i <= count; i++) {
                    const n = (i % 9) + 2;
                    const m = ((i + 3) % 7) + 3;
                    // Mix of display equations; some intentionally wide
                    const expr =
                        (i % 10 === 0)
                            ? String.raw`\frac{${seed}+${i}}{${n}}=\frac{${seed}+${i}}{${n}}\quad\Rightarrow\quad ${seed}+${i}= ${n}\cdot x`
                            : (i % 6 === 0)
                                ? String.raw`x_{${i}}= \frac{(${seed}+${i})^2-${m}^2}{2(${seed}+${i})} \;\; \text{so} \;\; x_{${i}}= \frac{(${seed}+${i}-${m})(${seed}+${i}+${m})}{2(${seed}+${i})}`
                                : String.raw`${seed}+${i}: \;\; 3x-${n} = ${m} \;\;\Rightarrow\;\; 3x = ${m}+${n} \;\;\Rightarrow\;\; x=\frac{${m}+${n}}{3}`;
                    lines.push(mb(expr));
                }
                return lines.join('');
            }

            function buildShortPaper() {
                return {
                    key: 'short',
                    name: 'Short paper',
                    sections: null,
                    questions: [
                        {
                            id: '1',
                            prompt: `<p>Work out ${mi('37 + 58')}.</p>`,
                            answer: `${mi('95')}`,
                            details: {
                                keepInMind: null,
                                formulas: null,
                                workingHtml: `<p>Add tens then ones.</p>${mb('37+58=(30+50)+(7+8)=80+15=95')}`,
                                altWorkingHtml: null
                            },
                            expandedByDefault: false
                        },
                        {
                            id: '2',
                            prompt: `<p>${mi('\\frac{3}{4}')} of a number is 21. What is the number?</p>`,
                            answer: `${mi('28')}`,
                            details: {
                                keepInMind: `<p>To find the whole, divide by the fraction.</p>`,
                                formulas: null,
                                workingHtml: `${mb(String.raw`\frac{3}{4}n=21 \Rightarrow n=21\div\frac{3}{4}=21\cdot\frac{4}{3}=28`)}`,
                                altWorkingHtml: null
                            },
                            expandedByDefault: false
                        },
                        {
                            id: '3',
                            prompt: `<p>A rectangle has length 9 cm and width 4 cm. Find the perimeter.</p>`,
                            answer: `${mi('26\\text{ cm}')}`,
                            details: {
                                keepInMind: null,
                                formulas: `<p>Perimeter of a rectangle: ${mi('P=2(l+w)')}.</p>`,
                                workingHtml: `${mb(String.raw`P=2(9+4)=2\cdot 13=26\text{ cm}`)}`,
                                altWorkingHtml: null
                            },
                            expandedByDefault: false
                        },
                        {
                            id: '4',
                            prompt: `<p>Write ${mi('0.36')} as a fraction in its simplest form.</p>`,
                            answer: `${mi('\\frac{9}{25}')}`,
                            details: {
                                keepInMind: `<p>Convert decimals to fractions using place value, then simplify.</p>`,
                                formulas: null,
                                workingHtml: `${mb(String.raw`0.36=\frac{36}{100}=\frac{9}{25}`)}`,
                                altWorkingHtml: null
                            },
                            expandedByDefault: false
                        },
                        {
                            id: '5',
                            prompt: `<p>A bag has red and blue counters in the ratio ${mi('3:5')}. There are 24 counters in total. How many are red?</p>${Diagram.ratioBars()}`,
                            answer: `${mi('9')}`,
                            details: {
                                keepInMind: `<p>Add ratio parts first to find the value of one part.</p>`,
                                formulas: null,
                                workingHtml: `${mb(String.raw`3+5=8\text{ parts}\Rightarrow 24\div 8=3\text{ per part}\Rightarrow 3\cdot 3=9`)}`,
                                altWorkingHtml: `<p>Or scale the ratio directly.</p>${mb(String.raw`3:5 \Rightarrow 8\text{ parts};\;\; \text{red}=\frac{3}{8}\cdot 24=9`)}`,
                            },
                            expandedByDefault: false
                        },
                        // Multi-part with sub-questions (Deep Question Nesting add-on)
                        {
                            id: '6',
                            prompt: `<p>For each part, show your reasoning.</p>`,
                            answer: `${mi('\\text{See parts below}')}`,
                            details: {
                                keepInMind: null,
                                formulas: null,
                                workingHtml: `<p>This question has sub-parts.</p>`,
                                altWorkingHtml: null
                            },
                            expandedByDefault: false,
                            children: [
                                {
                                    id: '6a',
                                    prompt: `<p>Work out ${mi('12\\times 7')}.</p>`,
                                    answer: `${mi('84')}`,
                                    details: {
                                        keepInMind: null,
                                        formulas: null,
                                        workingHtml: `${mb('12\\times 7 = (10\\times 7)+(2\\times 7)=70+14=84')}`,
                                        altWorkingHtml: null
                                    },
                                    expandedByDefault: false
                                },
                                {
                                    id: '6b',
                                    prompt: `<p>Solve ${mi('x+9=17')}.</p>`,
                                    answer: `${mi('x=8')}`,
                                    details: {
                                        keepInMind: null,
                                        formulas: null,
                                        workingHtml: `${mb('x=17-9=8')}`,
                                        altWorkingHtml: null
                                    },
                                    expandedByDefault: false
                                },
                                {
                                    id: '6c',
                                    prompt: `<p>A square has area ${mi('49\\text{ cm}^2')}. Find the side length.</p>`,
                                    answer: `${mi('7\\text{ cm}')}`,
                                    details: {
                                        keepInMind: null,
                                        formulas: `<p>Area of a square: ${mi('A=s^2')}.</p>`,
                                        workingHtml: `${mb(String.raw`s^2=49\Rightarrow s=\sqrt{49}=7`)}`,
                                        altWorkingHtml: null
                                    },
                                    expandedByDefault: false
                                }
                            ]
                        }
                    ]
                };
            }

            function buildStandardPaper(allExpanded) {
                const qs = [];

                // 1–25: small/medium mix including solution variants coverage
                const presets = [
                    {
                        id: '1', p: `<p>Work out ${mi('4.8 \\div 0.6')}.</p>`, a: mi('8'), km: null, f: null,
                        w: `${mb(String.raw`4.8\div 0.6=\frac{48}{10}\div\frac{6}{10}=\frac{48}{10}\cdot\frac{10}{6}=\frac{48}{6}=8`)}`, alt: null
                    },
                    {
                        id: '2', p: `<p>A number is increased by ${mi('15\\%')} to give 69. Find the original number.</p>`, a: mi('60'),
                        km: `<p>${mi('15\\%')} increase means multiply by ${mi('1.15')}.</p>`, f: null,
                        w: `${mb(String.raw`1.15x=69\Rightarrow x=\frac{69}{1.15}=60`)}`, alt: null
                    },
                    {
                        id: '3', p: `<p>Find the value of ${mi('3^4')}.</p>`, a: mi('81'), km: null, f: null,
                        w: `${mb('3^4=3\\times 3\\times 3\\times 3=81')}`, alt: null
                    },
                    {
                        id: '4', p: `<p>A train travels 180 km in 3 hours. What is the average speed?</p>`, a: mi('60\\text{ km/h}'),
                        km: null, f: `<p>Speed: ${mi('v=\\frac{d}{t}')}.</p>`,
                        w: `${mb(String.raw`v=\frac{180}{3}=60`)}`, alt: null
                    },
                    {
                        id: '5', p: `<p>Simplify ${mi('\\frac{18}{24}')}.</p>`, a: mi('\\frac{3}{4}'),
                        km: `<p>Divide top and bottom by the highest common factor.</p>`, f: null,
                        w: `${mb(String.raw`\frac{18}{24}=\frac{18\div 6}{24\div 6}=\frac{3}{4}`)}`, alt: null
                    },
                    {
                        id: '6', p: `<p>A circle has radius 5 cm. Find the circumference.</p>`, a: mi('10\\pi\\text{ cm}'),
                        km: null, f: `<p>Circumference: ${mi('C=2\\pi r')}.</p>`,
                        w: `${mb('C=2\\pi\\cdot 5=10\\pi')}`, alt: null
                    },
                    {
                        id: '7', p: `<p>Two angles on a straight line are in the ratio ${mi('2:7')}. Find the larger angle.</p>${Diagram.geometry()}`, a: mi('140^\\circ'),
                        km: null, f: `<p>Angles on a straight line add to ${mi('180^\\circ')}.</p>`,
                        w: `${mb(String.raw`2+7=9\Rightarrow 180\div 9=20\Rightarrow 7\cdot 20=140^\circ`)}`, alt: null
                    },
                    {
                        id: '8', p: `<p>Plot the points ${mi('(2,3)')} and ${mi('(4,5)')} and join them with a straight line.</p>${Diagram.coordGrid()}`, a: mi('\\text{Line segment drawn}'),
                        km: `<p>Use the grid to find the coordinates carefully.</p>`, f: null,
                        w: `<p>Locate ${mi('(2,3)')} and ${mi('(4,5)')}, then draw the segment.</p>`, alt: null
                    },
                    {
                        id: '9', p: `<p>Expand and simplify ${mi('(x+4)(x-3)')}.</p>`, a: mi('x^2+x-12'),
                        km: null, f: null,
                        w: `${mb(String.raw`(x+4)(x-3)=x^2-3x+4x-12=x^2+x-12`)}`,
                        alt: `<p>Alternative method: use FOIL structure.</p>${mb(String.raw`x\cdot x + x\cdot(-3) +4\cdot x +4\cdot(-3)=x^2+x-12`)}`
                    },
                    {
                        id: '10', p: `<p>Write ${mi('2.375')} as a mixed number in simplest form.</p>`, a: mi('2\\frac{3}{8}'),
                        km: null, f: null,
                        w: `${mb(String.raw`2.375=2+\frac{375}{1000}=2+\frac{3}{8}=2\frac{3}{8}`)}`, alt: null
                    },
                    {
                        id: '11', p: `<p>Find the missing number: ${mi('7\\times \\square = 98')}.</p>`, a: mi('14'),
                        km: null, f: null, w: `${mb('98\\div 7=14')}`, alt: null
                    },
                    {
                        id: '12', p: `<p>Solve ${mi('2x+5=19')}.</p>`, a: mi('x=7'),
                        km: `<p>Undo operations in reverse order.</p>`,
                        f: `<p>Linear form: ${mi('ax+b=c')}.</p>`,
                        w: `${mb(String.raw`2x=19-5=14\Rightarrow x=\frac{14}{2}=7`)}`,
                        alt: `<p>Alternative: balance both sides.</p>${mb(String.raw`2x+5=19\Rightarrow 2x+5-5=19-5\Rightarrow 2x=14\Rightarrow x=7`)}`
                    },
                    {
                        id: '13', p: `<p>A recipe uses flour and sugar in the ratio ${mi('5:2')}. If flour is 750 g, how much sugar is used?</p>${Diagram.ratioBars()}`, a: mi('300\\text{ g}'),
                        km: null, f: null,
                        w: `${mb(String.raw`5\text{ parts}=750\Rightarrow 1\text{ part}=150\Rightarrow 2\text{ parts}=300`)}`, alt: null
                    },
                    {
                        id: '14', p: `<p>Calculate the mean of: 7, 9, 10, 4, 5.</p>`, a: mi('7'),
                        km: null, f: null,
                        w: `${mb(String.raw`\frac{7+9+10+4+5}{5}=\frac{35}{5}=7`)}`, alt: null
                    },
                    {
                        id: '15', p: `<p>In a table, the top row shows 2, 4, 6, 8. The bottom row shows 3, 6, 9, 12. Describe the rule.</p>${Diagram.arrayGrid()}`, a: mi('\\times \\frac{3}{2}'),
                        km: `<p>Look for a constant multiplier.</p>`, f: null,
                        w: `${mb(String.raw`2\mapsto 3,\; 4\mapsto 6,\; 6\mapsto 9,\; 8\mapsto 12\Rightarrow \text{multiply by } \frac{3}{2}`)}`,
                        alt: null
                    },
                    {
                        id: '16', p: `<p>Find the area of a triangle with base 12 cm and height 7 cm.</p>`, a: mi('42\\text{ cm}^2'),
                        km: null, f: `<p>Triangle area: ${mi('A=\\frac{1}{2}bh')}.</p>`,
                        w: `${mb(String.raw`A=\frac{1}{2}\cdot 12\cdot 7=42`)}`, alt: null
                    },
                    // Deep nesting stress: Q18 with sub and sub-sub
                    {
                        id: '18', p: `<p>Work through the parts.</p>`, a: mi('\\text{See parts}'),
                        km: null, f: null, w: `<p>This question includes nested parts.</p>`, alt: null, children: [
                            {
                                id: '18(a)(i)', p: `<p>Simplify ${mi('3x+5x-2x')}.</p>`, a: mi('6x'),
                                km: null, f: null, w: `${mb('3x+5x-2x=(3+5-2)x=6x')}`, alt: null
                            },
                            {
                                id: '18(a)(ii)', p: `<p>If ${mi('6x=42')}, find ${mi('x')}.</p>`, a: mi('7'),
                                km: null, f: null, w: `${mb('x=42\\div 6=7')}`, alt: null
                            },
                            {
                                id: '18(b)', p: `<p>Factorise ${mi('x^2-9')}.</p>`, a: mi('(x-3)(x+3)'),
                                km: `<p>Recognise a difference of squares.</p>`, f: `<p>${mi('a^2-b^2=(a-b)(a+b)')}.</p>`,
                                w: `${mb(String.raw`x^2-9=x^2-3^2=(x-3)(x+3)`)}`, alt: null
                            }
                        ]
                    },
                    {
                        id: '20', p: `<p>Convert ${mi('3\\text{ m}^2')} to ${mi('\\text{cm}^2')}.</p>`, a: mi('30000\\text{ cm}^2'),
                        km: `<p>Area units square the conversion factor.</p>`, f: null,
                        w: `${mb(String.raw`1\text{ m}=100\text{ cm}\Rightarrow 1\text{ m}^2=100^2=10000\text{ cm}^2\Rightarrow 3\text{ m}^2=30000\text{ cm}^2`)}`, alt: null
                    },
                ];

                // Fill 1–25 with presets + generated medium items
                const presetById = new Map(presets.map(x => [x.id, x]));
                for (let i = 1; i <= 25; i++) {
                    const id = String(i);
                    if (presetById.has(id)) {
                        const it = presetById.get(id);
                        qs.push(makeQ(it, !!allExpanded));
                        if (it.children) {
                            it.children.forEach(ch => qs.push(makeQ(ch, !!allExpanded)));
                        }
                    } else {
                        const a = (i % 5) + 3;
                        const b = (i % 7) + 4;
                        qs.push(makeQ({
                            id,
                            p: `<p>Work out ${mi(`${a}\\times ${b}`)}.</p>`,
                            a: mi(String(a * b)),
                            km: null,
                            f: null,
                            w: `${mb(`${a}\\times ${b}=${a * b}`)}`,
                            alt: null
                        }, !!allExpanded));
                    }
                }

                // 26–35 long algebra with multiple KaTeX block placeholders, and extremely long workings in some.
                for (let i = 26; i <= 35; i++) {
                    const hasAlt = (i % 3 === 0);
                    const hasKM = (i % 4 === 0);
                    const hasF = (i % 5 === 0);
                    const useVeryLong = (i === 30 || i === 33); // Extremely Long Workings add-on
                    const seed = i + 7;

                    const prompt = `
            <p>Solve the equation and simplify your final answer:</p>
            <p>${mi(String.raw`\frac{2x-${i}}{3} + \frac{x+${i - 10}}{2} = ${Math.floor(i / 2) + 4}`)}</p>
          `;

                    const working = `
            <p>Rearrange and collect like terms.</p>
            ${mb(String.raw`\frac{2x-${i}}{3} + \frac{x+${i - 10}}{2} = ${Math.floor(i / 2) + 4}`)}
            ${mb(String.raw`2\cdot(2x-${i}) + 3\cdot(x+${i - 10}) = 6\cdot(${Math.floor(i / 2) + 4})`)}
            ${mb(String.raw`(4x-2${i}) + (3x+3${i - 10}) = ${6 * (Math.floor(i / 2) + 4)}`)}
            ${mb(String.raw`7x + (${-2 * i + 3 * (i - 10)}) = ${6 * (Math.floor(i / 2) + 4)}`)}
            ${mb(String.raw`7x = ${6 * (Math.floor(i / 2) + 4) - (-2 * i + 3 * (i - 10))}`)}
            ${mb(String.raw`x = \frac{${6 * (Math.floor(i / 2) + 4) - (-2 * i + 3 * (i - 10))}}{7}`)}
            ${useVeryLong ? `<p>Extra working lines (stress test):</p>${longWorkingLines(56, seed)}` : ''}
          `;

                    const altWorking = hasAlt ? `
            <p>Alternative working: clear fractions first, then simplify.</p>
            ${mb(String.raw`6\left(\frac{2x-${i}}{3} + \frac{x+${i - 10}}{2}\right)=6\cdot(${Math.floor(i / 2) + 4})`)}
            ${mb(String.raw`2(2x-${i})+3(x+${i - 10})=${6 * (Math.floor(i / 2) + 4)}`)}
            ${mb(String.raw`7x = ${6 * (Math.floor(i / 2) + 4) - (-2 * i + 3 * (i - 10))}\Rightarrow x=\frac{${6 * (Math.floor(i / 2) + 4) - (-2 * i + 3 * (i - 10))}}{7}`)}
          ` : null;

                    // Answer kept short even if workings long
                    const ansNumer = (6 * (Math.floor(i / 2) + 4) - (-2 * i + 3 * (i - 10)));
                    const answer = mi(String.raw`\frac{${ansNumer}}{7}`);

                    qs.push(makeQ({
                        id: String(i),
                        p: prompt,
                        a: answer,
                        km: hasKM ? `<p>Keep track of signs when expanding brackets.</p>` : null,
                        f: hasF ? `<p>Clearing fractions: multiply both sides by the LCM.</p>` : null,
                        w: working,
                        alt: altWorking
                    }, !!allExpanded));
                }

                // Additional deep nesting stress inside long range
                qs.push(makeQ({
                    id: '30(a)(i)',
                    p: `<p>Given ${mi('f(x)=2x^2-5x+3')}, find ${mi('f(4)')}.</p>`,
                    a: mi('15'),
                    km: null,
                    f: null,
                    w: `${mb(String.raw`f(4)=2(4)^2-5(4)+3=2\cdot 16-20+3=32-20+3=15`)}`,
                    alt: null
                }, !!allExpanded));
                qs.push(makeQ({
                    id: '30(a)(ii)',
                    p: `<p>Solve ${mi('f(x)=0')} where ${mi('f(x)=2x^2-5x+3')}.</p>`,
                    a: `${mi('x=1')} , ${mi('x=\\frac{3}{2}')}`,
                    km: `<p>Check factor pairs that multiply to ${mi('2\\cdot 3')} and add to ${mi('-5')}.</p>`,
                    f: `<p>Quadratic factor form: ${mi('ax^2+bx+c=(px+q)(rx+s)')}.</p>`,
                    w: `${mb(String.raw`2x^2-5x+3=(2x-3)(x-1)`)}${mb(String.raw`(2x-3)(x-1)=0\Rightarrow x=\frac{3}{2}\text{ or }x=1`)}`,
                    alt: `<p>Alternative: use the quadratic formula.</p>${mb(String.raw`x=\frac{-(-5)\pm\sqrt{(-5)^2-4\cdot 2\cdot 3}}{2\cdot 2}=\frac{5\pm\sqrt{25-24}}{4}=\frac{5\pm 1}{4}`)}`
                }, !!allExpanded));
                qs.push(makeQ({
                    id: '30(b)',
                    p: `<p>State two values of ${mi('x')} that make ${mi('f(x)>0')}.</p>`,
                    a: `${mi('x=0')} and ${mi('x=3')}`,
                    km: null,
                    f: null,
                    w: `<p>Choose values outside the roots and test quickly.</p>${mb(String.raw`f(0)=3>0,\;\; f(3)=2(9)-15+3=6>0`)}`,
                    alt: null
                }, !!allExpanded));

                // Ensure at least one question includes Keep in mind + Formulas used + Alternative working
                // (Already Q12 includes all; long ones include combos too.)

                return {
                    key: allExpanded ? 'standard_expanded' : 'standard',
                    name: allExpanded ? 'Standard (Workings Expanded)' : 'Standard paper',
                    sections: null,
                    questions: qs
                };
            }

            function buildDiagramPaper() {
                const qs = [];
                const diagramIds = new Set([2, 4, 6, 8, 10, 12, 14, 16]); // 8 questions with diagrams
                const diagramTypes = [Diagram.geometry, Diagram.ratioBars, Diagram.coordGrid, Diagram.arrayGrid];

                for (let i = 1; i <= 20; i++) {
                    const hasDiagram = diagramIds.has(i);
                    const dt = diagramTypes[i % diagramTypes.length];
                    const diagHtml = hasDiagram ? dt() : '';

                    let prompt = `<p>Question ${mi(String(i))}: answer the problem.</p>`;
                    let answer = mi(String((i % 9) + 1));
                    let working = `${mb(String.raw`${i}+${(i % 7) + 3}=${i + ((i % 7) + 3)}`)}`;

                    if (hasDiagram && (i % 4 === 0)) {
                        prompt = `<p>Use the diagram to calculate the missing length.</p>${diagHtml}<p>Find ${mi('x')}.</p>`;
                        answer = mi(String.raw`x=${(i % 6) + 4}`);
                        working = `<p>Read the labelled lengths and set up a short equation.</p>${mb(String.raw`x+${(i % 5) + 2}=${(i % 10) + 12}\Rightarrow x=${(i % 10) + 12 - ((i % 5) + 2)}`)}`;
                    } else if (hasDiagram && (i % 4 === 2)) {
                        prompt = `<p>The ratio bars show a total of 36. Find the value of one part.</p>${diagHtml}`;
                        answer = mi('4');
                        working = `${mb(String.raw`36\div 9=4`)}`;
                    } else if (hasDiagram && (i % 4 === 1)) {
                        prompt = `<p>On the coordinate grid, estimate the gradient of the line segment.</p>${diagHtml}`;
                        answer = mi('1');
                        working = `${mb(String.raw`\text{Rise }=2,\;\text{run }=2\Rightarrow \text{gradient }=\frac{2}{2}=1`)}`;
                    } else if (hasDiagram && (i % 4 === 3)) {
                        prompt = `<p>The table shows a pattern. Write a rule for the bottom row in terms of the top row.</p>${diagHtml}`;
                        answer = mi('\\times\\frac{3}{2}');
                        working = `${mb(String.raw`\text{Each bottom entry}=\text{top}\cdot\frac{3}{2}`)}`;
                    }

                    const includeKM = (i === 3 || i === 9 || i === 17);
                    const includeF = (i === 5 || i === 11 || i === 19);
                    const includeAlt = (i === 7 || i === 13 || i === 20);
                    const includeAll = (i === 13);

                    qs.push(makeQ({
                        id: String(i),
                        p: prompt,
                        a: answer,
                        km: includeKM || includeAll ? `<p>Check units and labels from the diagram carefully.</p>` : null,
                        f: includeF || includeAll ? `<p>If needed, use ${mi('v=\\frac{d}{t}')}, ${mi('A=\\frac{1}{2}bh')}, or ratio parts.</p>` : null,
                        w: `<p>Working:</p>${working}`,
                        alt: includeAlt || includeAll ? `<p>Alternative working:</p>${mb(String.raw`\text{Another method gives the same result.}`)}` : null
                    }, false));
                }

                return {
                    key: 'diagram',
                    name: 'Diagram-heavy paper',
                    sections: null,
                    questions: qs
                };
            }

            function buildSectionedPaper() {
                // Section A: 35 small/medium
                // Section B: 8 medium
                // Section C: 6 very long details collapsed by default
                const sections = [
                    { label: 'A', questions: [] },
                    { label: 'B', questions: [] },
                    { label: 'C', questions: [] }
                ];

                // A: 35
                for (let i = 1; i <= 35; i++) {
                    const includeKM = (i === 4 || i === 12 || i === 27);
                    const includeF = (i === 6 || i === 18 || i === 31);
                    const includeAlt = (i === 9 || i === 21 || i === 33);
                    const includeAll = (i === 21);

                    sections[0].questions.push(makeQ({
                        id: String(i),
                        p: `<p>Answer the question:</p><p>Simplify ${mi(String.raw`\frac{${i + 12}}{${(i % 9) + 10}}`)}.</p>`,
                        a: mi(String.raw`\frac{${i + 12}}{${(i % 9) + 10}}`),
                        km: includeKM || includeAll ? `<p>Simplify only if there is a common factor.</p>` : null,
                        f: includeF || includeAll ? `<p>Fraction rule: ${mi(String.raw`\frac{a}{b}=\frac{a\div k}{b\div k}`)} when ${mi('k')} is a common factor.</p>` : null,
                        w: `${mb(String.raw`\text{Check common factors; if none, the fraction is already simplest.}`)}`,
                        alt: includeAlt || includeAll ? `<p>Alternative working: list factors.</p>${mb(String.raw`\text{List factors of numerator and denominator to compare.}`)}` : null
                    }, false));
                }

                // B: 8
                for (let i = 1; i <= 8; i++) {
                    const qid = String(35 + i);
                    const hasDiagram = (i === 3 || i === 7);
                    sections[1].questions.push(makeQ({
                        id: qid,
                        p: `<p>Solve:</p><p>${mi(String.raw`3x-${i + 4}=${2 * i + 10}`)}</p>${hasDiagram ? Diagram.geometry('P', 'Q', 'R') : ''}`,
                        a: mi(String.raw`x=\frac{${2 * i + 10 + i + 4}}{3}`),
                        km: (i === 3) ? `<p>Move constants to one side before dividing.</p>` : null,
                        f: (i === 5) ? `<p>Linear equation: isolate ${mi('x')}.</p>` : null,
                        w: `${mb(String.raw`3x=${2 * i + 10 + i + 4}\Rightarrow x=\frac{${2 * i + 10 + i + 4}}{3}`)}`,
                        alt: (i === 7) ? `<p>Alternative: balance step-by-step.</p>${mb(String.raw`3x-${i + 4}+${i + 4}=${2 * i + 10}+${i + 4}`)}` : null
                    }, false));
                }

                // C: 6 very long Solution Details (collapsed by default), multiple KaTeX blocks, and some extremely long
                for (let i = 1; i <= 6; i++) {
                    const qid = `C${i}`; // Paper semantics require number-based identifiers only.
                    // Convert to number-based style for navigation: use 1–6 in section C but labels in nav include section separators only.
                    // IDs must still be number-based; we keep "1–6" for section C list but store unique DOM ids.
                }

                // For sectioned papers, question identifiers must remain number-based.
                // We'll label Section C questions as 1–6 but keep unique DOM anchors by prefixing internally.
                for (let i = 1; i <= 6; i++) {
                    const id = String(i); // number-based only
                    const internalKey = `C_${id}`;
                    const useVeryLong = (i === 2 || i === 5);
                    const seed = 100 + i * 7;

                    sections[2].questions.push(makeQ({
                        id,
                        internalId: internalKey,
                        p: `
              <p>Algebraic proof and simplification:</p>
              <p>Show that ${mi(String.raw`\frac{x^2-1}{x-1}=x+1`)} for ${mi('x\\ne 1')}.</p>
            `,
                        a: mi(String.raw`x+1,\; x\ne 1`),
                        km: `<p>Always state any value that makes a denominator zero.</p>`,
                        f: `<p>Factorisation: ${mi(String.raw`x^2-1=(x-1)(x+1)`)}.</p>`,
                        w: `
              <p>Factorise the numerator and cancel common factors.</p>
              ${mb(String.raw`\frac{x^2-1}{x-1}=\frac{(x-1)(x+1)}{x-1}`)}
              ${mb(String.raw`=\; x+1,\;\; x\ne 1`)}
              ${mb(String.raw`\text{Check: if }x=1,\;\; \frac{x^2-1}{x-1}\text{ is undefined.}`)}
              ${useVeryLong ? `<p>Extra working lines (stress test):</p>${longWorkingLines(60, seed)}` : ''}
            `,
                        alt: `
              <p>Alternative working: expand and simplify (not recommended, but valid).</p>
              ${mb(String.raw`\frac{x^2-1}{x-1}=\frac{x^2-1}{x-1}\cdot\frac{x-1}{x-1}=\frac{x^3-x^2-x+1}{(x-1)^2}`)}
              ${mb(String.raw`\text{Then simplify (long route) to reach }x+1\text{ for }x\ne 1.`)}
            `
                    }, false));
                }

                return {
                    key: 'sectioned',
                    name: 'Sectioned paper',
                    sections
                };
            }

            function makeQ(raw, expandAll) {
                return {
                    id: raw.id,
                    internalId: raw.internalId || null,
                    prompt: raw.p,
                    answer: raw.a,
                    details: {
                        keepInMind: raw.km || null,
                        formulas: raw.f || null,
                        workingHtml: raw.w || '',
                        altWorkingHtml: raw.alt || null
                    },
                    expandedByDefault: expandAll ? true : false,
                    children: raw.children || null
                };
            }

            const datasets = {
                short: buildShortPaper(),
                standard: buildStandardPaper(false),
                standard_expanded: buildStandardPaper(true),
                diagram: buildDiagramPaper(),
                sectioned: buildSectionedPaper()
            };

            // ---- Build paper + nav ----
            let currentKey = paperSelect.value || 'short';
            let currentQuestionNodes = [];
            let observer = null;

            function flattenQuestions(dataset) {
                // Returns items in linear document order with optional section labels.
                const items = [];
                if (dataset.sections) {
                    dataset.sections.forEach(sec => {
                        items.push({ type: 'section', label: sec.label });
                        sec.questions.forEach(q => items.push({ type: 'q', q, section: sec.label }));
                    });
                } else {
                    dataset.questions.forEach(q => {
                        items.push({ type: 'q', q, section: null });
                        if (q.children) {
                            q.children.forEach(ch => items.push({ type: 'q', q: ch, section: null, parent: q.id }));
                        }
                    });
                }
                return items;
            }

            function build(datasetKey) {
                currentKey = datasetKey;
                const dataset = datasets[datasetKey];

                // Clear
                paperEl.innerHTML = '';
                navInner.innerHTML = '';
                drawerNav.innerHTML = '';
                currentQuestionNodes = [];

                const items = flattenQuestions(dataset);

                // Build paper content
                items.forEach(item => {
                    if (item.type === 'section') {
                        const sec = document.createElement('div');
                        sec.className = 'paperSection';
                        sec.innerHTML = `<h2>${escapeText(item.label)}</h2>`;
                        paperEl.appendChild(sec);
                        return;
                    }

                    const q = item.q;
                    const domId = `q_${datasetKey}_${(q.internalId || q.id).replace(/[^a-zA-Z0-9_()-]/g, '_')}`;
                    const depth = depthFromId(q.id);

                    const qWrap = document.createElement('article');
                    qWrap.className = 'q';
                    qWrap.setAttribute('data-qid', q.id);
                    qWrap.setAttribute('data-depth', String(depth));
                    qWrap.id = domId;

                    qWrap.innerHTML = `
            <div class="qInner">
              <div class="qid">${escapeHtml(q.id)}</div>
              <div class="qPrompt">${q.prompt}</div>
            </div>

            <div class="answerRow">
              <div></div>
              <div class="answerBox"><span class="answerLabel">Answer</span><span class="answerValue">${q.answer}</span></div>
            </div>

            <div class="toggleRow">
              <div></div>
              <div>
                <button class="toggleBtn" type="button" aria-expanded="false">
                  <span class="toggleText">Show working</span>
                  <span class="chev" aria-hidden="true">▾</span>
                </button>

                <div class="detailsWrap">
                  <div class="details" aria-hidden="true" inert>
                    ${renderDetailsBlocks(q.details)}
                  </div>
                </div>
              </div>
            </div>
          `;

                    paperEl.appendChild(qWrap);
                    currentQuestionNodes.push(qWrap);

                    // Default expanded state rules: dataset-specific, without cross-question effects.
                    const shouldOpen = !!q.expandedByDefault;
                    if (datasetKey === 'standard_expanded') {
                        // All expanded by default for this dataset variant only.
                        setOpen(qWrap, true, true);
                    } else {
                        setOpen(qWrap, shouldOpen, true);
                    }
                });

                // Build nav (desktop and drawer)
                buildNav(dataset, items, navInner, false);
                buildNav(dataset, items, drawerNav, true);

                // Re-render KaTeX (if loaded); otherwise leave plain text.
                renderKaTeXWithin(paperEl);

                // Setup active tracking
                setupObserver();

                // Ensure drawer reflects closed state
                closeDrawer(true);
            }

            function renderDetailsBlocks(details) {
                // Order: Keep in mind, Formulas used, Working, Alternative working
                const blocks = [];

                if (details.keepInMind) {
                    blocks.push(`
            <div class="detailsBlock">
              <div class="detailsLabel">Keep in mind</div>
              <div class="detailsBody">${details.keepInMind}</div>
            </div>
          `);
                }
                if (details.formulas) {
                    blocks.push(`
            <div class="detailsBlock">
              <div class="detailsLabel">Formulas used</div>
              <div class="detailsBody">${details.formulas}</div>
            </div>
          `);
                }
                blocks.push(`
          <div class="detailsBlock">
            <div class="detailsLabel">Working</div>
            <div class="detailsBody">${details.workingHtml || ''}</div>
          </div>
        `);

                if (details.altWorkingHtml) {
                    blocks.push(`
            <div class="detailsBlock">
              <div class="detailsLabel">Alternative working</div>
              <div class="detailsBody">${details.altWorkingHtml}</div>
            </div>
          `);
                }

                return blocks.join('');
            }

            function escapeHtml(s) {
                return (s ?? '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
            }
            function escapeText(s) { return escapeHtml(String(s ?? '')); }

            function buildNav(dataset, items, container, isDrawer) {
                const frag = document.createDocumentFragment();

                let ul = null;
                const ensureList = () => {
                    if (!ul) {
                        ul = document.createElement('ul');
                        ul.className = 'navList';
                        frag.appendChild(ul);
                    }
                };

                items.forEach(item => {
                    if (item.type === 'section') {
                        // Section label: non-clickable separator
                        const label = document.createElement('div');
                        label.className = 'navSectionLabel';
                        label.textContent = item.label;
                        frag.appendChild(label);
                        ul = null;
                        return;
                    }

                    ensureList();

                    const qid = item.q.id;
                    const domId = `q_${currentKey}_${(item.q.internalId || qid).replace(/[^a-zA-Z0-9_()-]/g, '_')}`;

                    const li = document.createElement('li');
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'navLink';
                    btn.setAttribute('data-target', domId);
                    btn.setAttribute('aria-current', 'false');
                    btn.innerHTML = `<span class="marker" aria-hidden="true"></span><span>${escapeText(qid)}</span>`;

                    btn.addEventListener('click', () => {
                        // Navigation must be non-destructive: do not change expand/collapse states.
                        const target = document.getElementById(domId);
                        if (target) {
                            const behavior = prefersReducedMotion ? 'auto' : 'smooth';
                            target.scrollIntoView({ behavior, block: 'start' });
                        }
                        if (isDrawer) closeDrawer(false);
                    });

                    li.appendChild(btn);
                    ul.appendChild(li);
                });

                if (!isDrawer) {
                    const inner = document.createElement('div');
                    inner.appendChild(frag);
                    container.appendChild(inner);
                } else {
                    container.appendChild(frag);
                }
            }

            // ---- Expand / collapse inline ----
            function setOpen(qWrap, open, skipTransition) {
                const btn = qWrap.querySelector('.toggleBtn');
                const text = qWrap.querySelector('.toggleText');
                const chev = qWrap.querySelector('.chev');
                const details = qWrap.querySelector('.details');

                if (!btn || !details || !text) return;

                btn.setAttribute('aria-expanded', open ? 'true' : 'false');
                text.textContent = open ? 'Hide working' : 'Show working';
                chev.textContent = open ? '▴' : '▾';

                if (open) {
                    details.classList.add('isOpen');
                    details.removeAttribute('inert');
                    details.setAttribute('aria-hidden', 'false');

                    // Measure & set max-height for transition
                    if (skipTransition || prefersReducedMotion) {
                        details.style.transition = 'none';
                        details.style.maxHeight = 'none';
                        details.style.opacity = '1';
                        requestAnimationFrame(() => { details.style.transition = ''; });
                    } else {
                        details.style.maxHeight = '0px';
                        details.style.opacity = '0.001';
                        requestAnimationFrame(() => {
                            const h = details.scrollHeight;
                            details.style.maxHeight = h + 'px';
                            details.style.opacity = '1';
                        });
                        // After transition, allow natural height
                        const onEnd = (e) => {
                            if (e.propertyName === 'max-height') {
                                details.style.maxHeight = 'none';
                                details.removeEventListener('transitionend', onEnd);
                            }
                        };
                        details.addEventListener('transitionend', onEnd);
                    }
                } else {
                    details.setAttribute('aria-hidden', 'true');
                    details.setAttribute('inert', '');

                    if (skipTransition || prefersReducedMotion) {
                        details.classList.remove('isOpen');
                        details.style.transition = 'none';
                        details.style.maxHeight = '0px';
                        details.style.opacity = '0.001';
                        requestAnimationFrame(() => { details.style.transition = ''; });
                    } else {
                        // If it was 'none', set to current height then collapse
                        const currentH = details.scrollHeight;
                        details.style.maxHeight = currentH + 'px';
                        details.style.opacity = '1';
                        requestAnimationFrame(() => {
                            details.classList.remove('isOpen');
                            details.style.maxHeight = '0px';
                            details.style.opacity = '0.001';
                        });
                    }
                }
            }

            function wireToggles() {
                paperEl.querySelectorAll('.q').forEach(qWrap => {
                    const btn = qWrap.querySelector('.toggleBtn');
                    if (!btn) return;
                    btn.addEventListener('click', () => {
                        const expanded = btn.getAttribute('aria-expanded') === 'true';
                        setOpen(qWrap, !expanded, false);
                    });
                });
            }

            // ---- Active nav tracking via IntersectionObserver ----
            function setupObserver() {
                if (observer) observer.disconnect();

                const allNavButtons = Array.from(document.querySelectorAll('.navLink'));
                const mapByTarget = new Map(allNavButtons.map(b => [b.getAttribute('data-target'), b]));

                // Reset
                allNavButtons.forEach(b => b.setAttribute('aria-current', 'false'));

                const options = {
                    root: null,
                    rootMargin: '-20% 0px -70% 0px',
                    threshold: 0.01
                };

                observer = new IntersectionObserver((entries) => {
                    // Choose the closest intersecting entry to top (by boundingClientRect.top)
                    const visible = entries.filter(e => e.isIntersecting).sort((a, b) => a.boundingClientRect.top - b.boundingClientRect.top);
                    if (!visible.length) return;
                    const id = visible[0].target.id;

                    // Clear current
                    allNavButtons.forEach(b => {
                        if (b.getAttribute('aria-current') === 'true') b.setAttribute('aria-current', 'false');
                    });

                    const btn = mapByTarget.get(id);
                    if (btn) {
                        btn.setAttribute('aria-current', 'true');
                    }

                    // Mirror current in drawer as well
                    const drawerButtons = Array.from(drawerNav.querySelectorAll('.navLink'));
                    drawerButtons.forEach(b => b.setAttribute('aria-current', 'false'));
                    const drawerBtn = drawerButtons.find(b => b.getAttribute('data-target') === id);
                    if (drawerBtn) drawerBtn.setAttribute('aria-current', 'true');
                }, options);

                currentQuestionNodes.forEach(node => observer.observe(node));
            }

            // ---- Drawer open/close (mobile/tablet) ----
            function openDrawer() {
                overlay.classList.add('isOpen');
                drawer.classList.add('isOpen');
                overlay.setAttribute('aria-hidden', 'false');
                drawer.setAttribute('aria-hidden', 'false');
                jumpBtn.setAttribute('aria-expanded', 'true');

                // Trap background interaction (accessibility basics)
                frame.setAttribute('inert', '');
                paperSelect.setAttribute('inert', '');

                // Focus close button (no forced scrolling)
                closeBtn.focus({ preventScroll: true });

                // Escape key
                window.addEventListener('keydown', onDrawerKey);
            }
            function closeDrawer(silent) {
                overlay.classList.remove('isOpen');
                drawer.classList.remove('isOpen');
                overlay.setAttribute('aria-hidden', 'true');
                drawer.setAttribute('aria-hidden', 'true');
                jumpBtn.setAttribute('aria-expanded', 'false');

                frame.removeAttribute('inert');
                paperSelect.removeAttribute('inert');

                window.removeEventListener('keydown', onDrawerKey);

                if (!silent) {
                    // Return focus to the Jump to button (no focus movement required by spec; this is reversible and expected)
                    jumpBtn.focus({ preventScroll: true });
                }
            }
            function onDrawerKey(e) {
                if (e.key === 'Escape') {
                    e.preventDefault();
                    closeDrawer(false);
                }
                // Basic focus trap: keep focus inside drawer when open
                if (e.key === 'Tab') {
                    const focusables = drawer.querySelectorAll('button, [href], [tabindex]:not([tabindex="-1"])');
                    if (!focusables.length) return;
                    const first = focusables[0];
                    const last = focusables[focusables.length - 1];
                    if (e.shiftKey && document.activeElement === first) {
                        e.preventDefault(); last.focus();
                    } else if (!e.shiftKey && document.activeElement === last) {
                        e.preventDefault(); first.focus();
                    }
                }
            }

            jumpBtn.addEventListener('click', () => {
                // Drawer is always accessible; on desktop it still opens but nav is already visible.
                if (drawer.classList.contains('isOpen')) closeDrawer(false);
                else openDrawer();
            });
            overlay.addEventListener('click', () => closeDrawer(false));
            closeBtn.addEventListener('click', () => closeDrawer(false));

            // ---- Paper switching ----
            paperSelect.addEventListener('change', () => {
                build(paperSelect.value);
                wireToggles();
            });

            // Initial build
            build(currentKey);
            wireToggles();

            // If KaTeX loads after DOM, render again.
            window.addEventListener('load', () => renderKaTeXWithin(paperEl));
        })();
    </script>
</body>

</html>