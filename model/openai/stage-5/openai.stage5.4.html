<!doctype html>
<html lang="en">

<head>
    <!-- Source brief: :contentReference[oaicite:0]{index=0} -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>RTQ – Maths Paper Solution Viewer (Stress Test Harness)</title>

    <!-- Real KaTeX Rendering (CDN) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css"
        integrity="sha384-n8MVd4RsNIU0tAV7G5Hq0mQmXy1dJk3G9l0c5i6f6TgB2xA6vYcYbO6jO3Zz6yFq" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"
        integrity="sha384-7zkQWk8V7w0M8Sxv5f2lHkG7Qb0n8cUoWgk1pQ+u1QO8uGd9BfD4s2b7m1u6fQbR"
        crossorigin="anonymous"></script>

    <style>
        :root {
            /* Stage 5: soft-warm neutral base, restrained contrast */
            --page-bg: #f3f0ea;
            --frame-bg: #fbfaf7;
            --text: #1a1a1a;
            --text-2: #3a3a3a;
            --text-3: #5a5a5a;
            --text-4: #747474;
            --rule: #d9d6cf;
            --rule-soft: #e6e2da;

            --focus: #2b2b2b;

            --maxw: 1060px;
            --gutter: 18px;
            --rail-w: 160px;

            --q-gap: 28px;
            /* largest: between top-level questions */
            --qa-gap: 10px;
            /* question → answer */
            --ans-toggle-gap: 8px;
            /* answer → toggle */
            --sol-gap: 12px;
            /* between solution subsections */
            --line-gap: 6px;
            /* within workings */

            --radius: 10px;
            /* used only for subtle surfaces; no card feel */
        }

        * {
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
        }

        body {
            margin: 0;
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
            background: var(--page-bg);
            color: var(--text);
            overflow-x: hidden;
            /* never page-level horizontal scroll */
            text-rendering: optimizeLegibility;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Top controls aligned with centered frame */
        .topbar {
            position: sticky;
            top: 0;
            z-index: 20;
            background: linear-gradient(to bottom, rgba(243, 240, 234, 0.96), rgba(243, 240, 234, 0.88));
            backdrop-filter: blur(6px);
            border-bottom: 1px solid var(--rule-soft);
        }

        .topbar .frame {
            max-width: var(--maxw);
            margin: 0 auto;
            padding: 12px var(--gutter);
        }

        .controls {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: space-between;
        }

        .controlsLeft {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        label {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-3);
            font-size: 14px;
        }

        select {
            appearance: none;
            border: 1px solid var(--rule);
            background: var(--frame-bg);
            color: var(--text-2);
            padding: 8px 10px;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1;
        }

        select:focus {
            outline: 2px solid var(--focus);
            outline-offset: 2px;
        }

        .navToggle {
            border: 1px solid transparent;
            background: transparent;
            padding: 8px 10px;
            border-radius: 8px;
            color: var(--text-3);
            font-size: 14px;
            cursor: pointer;
            text-decoration: underline;
            text-decoration-thickness: 1px;
            text-underline-offset: 3px;
        }

        .navToggle:hover {
            color: var(--text-2);
        }

        .navToggle:focus {
            outline: 2px solid var(--focus);
            outline-offset: 2px;
        }

        .status {
            font-size: 12px;
            color: var(--text-4);
            white-space: nowrap;
        }

        /* Centered content frame that holds both nav + paper on same surface */
        main {
            padding: 14px 0 60px;
        }

        .shell {
            max-width: var(--maxw);
            margin: 0 auto;
            padding: 0 var(--gutter);
        }

        .frameSurface {
            background: var(--frame-bg);
            border: 1px solid var(--rule-soft);
            border-radius: var(--radius);
            padding: 18px 16px 22px;
        }

        /* Desktop: two sibling columns */
        .layout {
            display: grid;
            grid-template-columns: var(--rail-w) 1fr;
            gap: 18px;
            align-items: start;
        }

        /* Navigation: quiet, no panel bg, sticky persistence */
        nav.rail {
            position: sticky;
            top: 68px;
            /* below topbar */
            align-self: start;
            background: transparent;
            /* must share same surface */
        }

        .railHeader {
            font-size: 12px;
            letter-spacing: 0.02em;
            color: var(--text-4);
            margin: 0 0 8px;
        }

        .navListWrap {
            max-height: calc(100vh - 110px);
            overflow: auto;
            padding-right: 6px;
            /* room for hidden scrollbar */
            scrollbar-width: none;
            /* Firefox */
            -ms-overflow-style: none;
            /* legacy */
        }

        .navListWrap::-webkit-scrollbar {
            display: none;
        }

        /* WebKit/Blink */

        .navList {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .navSep {
            margin: 10px 0 4px;
            font-size: 12px;
            color: var(--text-4);
            letter-spacing: 0.02em;
        }

        .navItem a {
            display: block;
            padding: 4px 2px;
            font-size: 13px;
            color: var(--text-4);
            text-decoration: none;
            border-radius: 6px;
            /* not a pill; just focus affordance */
            position: relative;
        }

        .navItem a:hover {
            color: var(--text-3);
            text-decoration: underline;
            text-decoration-thickness: 1px;
            text-underline-offset: 3px;
        }

        .navItem a:focus {
            outline: 2px solid var(--focus);
            outline-offset: 2px;
        }

        .navItem a[aria-current="true"] {
            color: var(--text-2);
            font-weight: 600;
            /* one strong cue only */
            text-decoration: none;
        }

        .navItem a[aria-current="true"]::before {
            content: "";
            position: absolute;
            left: -10px;
            top: 50%;
            transform: translateY(-50%);
            width: 5px;
            height: 5px;
            border-radius: 999px;
            background: var(--text-3);
            opacity: 0.85;
        }

        /* Paper content */
        article.paper {
            min-width: 0;
        }

        .paperTitle {
            margin: 0 0 10px;
            font-size: 14px;
            color: var(--text-4);
        }

        .paperNote {
            margin: 0 0 18px;
            font-size: 13px;
            color: var(--text-4);
            line-height: 1.45;
        }

        /* Question blocks: no cards; separation via rhythm */
        section.q {
            padding: 0;
            margin: 0;
        }

        /* top-level separation (largest) */
        section.q.level-0 {
            margin-top: var(--q-gap);
            padding-top: var(--q-gap);
            border-top: 1px solid var(--rule-soft);
        }

        /* first question: no extra top rule */
        section.q.level-0:first-of-type {
            margin-top: 0;
            padding-top: 0;
            border-top: none;
        }

        /* nested questions: indentation + progressively weaker separation */
        section.q.level-1 {
            margin-top: 16px;
            padding-left: 14px;
        }

        section.q.level-2 {
            margin-top: 12px;
            padding-left: 26px;
        }

        .qHead {
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }

        .qid {
            flex: 0 0 auto;
            font-size: 14px;
            color: var(--text-3);
            line-height: 1.35;
            margin-top: 1px;
        }

        .qPrompt {
            flex: 1 1 auto;
            min-width: 0;
            font-size: 16px;
            /* question anchor */
            line-height: 1.55;
            color: var(--text);
        }

        .qPrompt p {
            margin: 0 0 10px;
        }

        .qPrompt p:last-child {
            margin-bottom: 0;
        }

        /* diagrams inside question prompt (responsive, grayscale) */
        .diagram {
            margin-top: 10px;
            max-width: 560px;
        }

        .diagram svg {
            width: 100%;
            height: auto;
            display: block;
        }

        /* Answer: visible, subordinate to question but above solution */
        .answerRow {
            margin-top: var(--qa-gap);
            display: flex;
            gap: 10px;
            align-items: baseline;
            flex-wrap: wrap;
        }

        .answerLabel {
            font-size: 12px;
            letter-spacing: 0.02em;
            color: var(--text-4);
            font-weight: 600;
        }

        .answerValue {
            font-size: 14px;
            color: var(--text-2);
            line-height: 1.45;
        }

        /* Disclosure control: text-first, not button-like */
        .toggleRow {
            margin-top: var(--ans-toggle-gap);
        }

        button.toggle {
            appearance: none;
            border: 1px solid transparent;
            background: transparent;
            padding: 6px 0;
            color: var(--text-3);
            font-size: 14px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            border-radius: 8px;
            /* for focus outline comfort */
            text-decoration: underline;
            text-decoration-thickness: 1px;
            text-underline-offset: 3px;
        }

        button.toggle:hover {
            color: var(--text-2);
        }

        button.toggle:focus {
            outline: 2px solid var(--focus);
            outline-offset: 2px;
        }

        .chev {
            font-size: 12px;
            line-height: 1;
            opacity: 0.9;
            transform-origin: center;
        }

        .toggle[aria-expanded="true"] .chev {
            transform: rotate(180deg);
        }

        /* Solution details: subtle surface separation + subordination */
        .solWrap {
            margin-top: 10px;
            display: grid;
            grid-template-rows: 0fr;
            transition: grid-template-rows 180ms ease;
        }

        .solWrap.open {
            grid-template-rows: 1fr;
        }

        @media (prefers-reduced-motion: reduce) {
            .solWrap {
                transition: none;
            }
        }

        .sol {
            overflow: hidden;
        }

        .solInner {
            padding: 12px 12px 12px;
            background: rgba(217, 214, 207, 0.22);
            /* light but clear */
            border-radius: 10px;
            /* subtle, not cardy */
        }

        .solBlock {
            margin-top: var(--sol-gap);
        }

        .solBlock:first-child {
            margin-top: 0;
        }

        .solLabel {
            font-size: 12px;
            letter-spacing: 0.02em;
            color: var(--text-4);
            font-weight: 600;
            margin-bottom: 6px;
        }

        .solBody {
            font-size: 13px;
            line-height: 1.45;
            color: var(--text-3);
        }

        .solBody p {
            margin: 0 0 8px;
        }

        .solBody p:last-child {
            margin-bottom: 0;
        }

        /* Workings should read as continuous lines, not tiles */
        .workLines {
            display: flex;
            flex-direction: column;
            gap: var(--line-gap);
        }

        .workLines .line {
            margin: 0;
        }

        /* KaTeX containment invariant */
        .math-inline {
            white-space: nowrap;
        }

        .math-block {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            max-width: 100%;
            padding: 4px 0;
        }

        .math-block::-webkit-scrollbar {
            display: none;
        }

        .math-block {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        /* Keep KaTeX from widening the page */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            -webkit-overflow-scrolling: touch;
            padding: 6px 0;
        }

        .katex-display::-webkit-scrollbar {
            display: none;
        }

        .katex-display {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        /* Mobile: rail hidden, drawer used */
        @media (max-width: 860px) {
            :root {
                --rail-w: 0px;
            }

            .layout {
                grid-template-columns: 1fr;
            }

            nav.rail {
                display: none;
            }

            .frameSurface {
                padding: 16px 14px 18px;
            }

            .qid {
                font-size: 13px;
            }

            .qPrompt {
                font-size: 15px;
            }

            section.q.level-1 {
                padding-left: 10px;
            }

            section.q.level-2 {
                padding-left: 18px;
            }
        }

        /* Drawer (mobile / small screens) */
        .drawer {
            position: fixed;
            inset: 0;
            z-index: 50;
        }

        .drawer[hidden] {
            display: none;
        }

        .drawerScrim {
            position: absolute;
            inset: 0;
            background: rgba(26, 26, 26, 0.28);
        }

        .drawerPanel {
            position: absolute;
            right: 0;
            top: 0;
            height: 100%;
            width: min(320px, 86vw);
            background: var(--frame-bg);
            border-left: 1px solid var(--rule);
            padding: 14px 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .drawerHeader {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .drawerTitle {
            font-size: 14px;
            color: var(--text-3);
            font-weight: 600;
        }

        .drawerClose {
            border: 1px solid transparent;
            background: transparent;
            color: var(--text-3);
            cursor: pointer;
            padding: 8px 10px;
            border-radius: 8px;
            text-decoration: underline;
            text-decoration-thickness: 1px;
            text-underline-offset: 3px;
            font-size: 14px;
        }

        .drawerClose:hover {
            color: var(--text-2);
        }

        .drawerClose:focus {
            outline: 2px solid var(--focus);
            outline-offset: 2px;
        }

        .drawerNav {
            overflow: auto;
            padding-right: 6px;
            scrollbar-width: none;
            -ms-overflow-style: none;
            max-height: calc(100vh - 60px);
        }

        .drawerNav::-webkit-scrollbar {
            display: none;
        }

        /* Respect "no bold paragraphs in Solution Details" */
        strong {
            font-weight: 600;
        }

        /* used sparingly in labels only (we avoid strong in solution bodies) */
    </style>
</head>

<body>
    <header class="topbar">
        <div class="frame">
            <div class="controls" role="region" aria-label="Paper controls">
                <div class="controlsLeft">
                    <label for="paperSelect">
                        Paper
                        <select id="paperSelect" aria-label="Select paper dataset"></select>
                    </label>
                    <button id="navToggle" class="navToggle" type="button">Jump to</button>
                </div>
                <div id="katexStatus" class="status" aria-live="polite"></div>
            </div>
        </div>
    </header>

    <main>
        <div class="shell">
            <div class="frameSurface">
                <div class="layout">
                    <nav class="rail" aria-label="Questions">
                        <div class="railHeader">Questions</div>
                        <div class="navListWrap" id="navListWrap">
                            <ol id="navList" class="navList"></ol>
                        </div>
                    </nav>

                    <article id="paper" class="paper" aria-label="Paper content"></article>
                </div>
            </div>
        </div>
    </main>

    <!-- Mobile drawer navigation -->
    <div id="navDrawer" class="drawer" hidden>
        <div class="drawerScrim" data-close></div>
        <div class="drawerPanel" role="dialog" aria-modal="true" aria-label="Question navigation">
            <div class="drawerHeader">
                <div class="drawerTitle">Jump to</div>
                <button class="drawerClose" type="button" data-close>Close</button>
            </div>
            <nav class="drawerNav" aria-label="Questions">
                <ol id="navListMobile" class="navList"></ol>
            </nav>
        </div>
    </div>

    <script>
        (function () {
            const elPaperSelect = document.getElementById('paperSelect');
            const elPaper = document.getElementById('paper');
            const elNavList = document.getElementById('navList');
            const elNavListMobile = document.getElementById('navListMobile');
            const elNavToggle = document.getElementById('navToggle');
            const elDrawer = document.getElementById('navDrawer');
            const elKatexStatus = document.getElementById('katexStatus');

            let currentDatasetKey = null;
            let intersectionObserver = null;
            let lastFocusedBeforeDrawer = null;

            const uid = (() => {
                let n = 0;
                return () => (++n).toString(36) + "-" + Math.random().toString(36).slice(2, 6);
            })();

            /* ---------- SVG diagram templates (reused) ---------- */
            function svgGeometry() {
                return `
          <svg viewBox="0 0 520 240" role="img" aria-label="Geometry diagram">
            <rect x="1" y="1" width="518" height="238" fill="none" stroke="#bdb8ae"/>
            <circle cx="360" cy="110" r="60" fill="none" stroke="#6f6a61" stroke-width="2"/>
            <polygon points="100,180 190,60 280,180" fill="none" stroke="#2b2b2b" stroke-width="2"/>
            <text x="92" y="195" font-size="14" fill="#6a665f">A</text>
            <text x="186" y="52" font-size="14" fill="#6a665f">B</text>
            <text x="286" y="195" font-size="14" fill="#6a665f">C</text>
            <text x="355" y="110" font-size="14" fill="#6a665f">O</text>
            <text x="340" y="40" font-size="13" fill="#6a665f">r</text>
            <line x1="360" y1="110" x2="360" y2="50" stroke="#6f6a61" stroke-width="2" />
          </svg>
        `;
            }
            function svgRatioBars() {
                return `
          <svg viewBox="0 0 520 180" role="img" aria-label="Ratio bars diagram">
            <rect x="1" y="1" width="518" height="178" fill="none" stroke="#bdb8ae"/>
            <text x="20" y="38" font-size="14" fill="#6a665f">A</text>
            <rect x="50" y="22" width="420" height="26" fill="none" stroke="#2b2b2b" stroke-width="2"/>
            <line x1="190" y1="22" x2="190" y2="48" stroke="#2b2b2b" stroke-width="2"/>
            <line x1="330" y1="22" x2="330" y2="48" stroke="#2b2b2b" stroke-width="2"/>
            <text x="20" y="106" font-size="14" fill="#6a665f">B</text>
            <rect x="50" y="90" width="420" height="26" fill="none" stroke="#2b2b2b" stroke-width="2"/>
            <line x1="120" y1="90" x2="120" y2="116" stroke="#2b2b2b" stroke-width="2"/>
            <line x1="260" y1="90" x2="260" y2="116" stroke="#2b2b2b" stroke-width="2"/>
            <line x1="400" y1="90" x2="400" y2="116" stroke="#2b2b2b" stroke-width="2"/>
          </svg>
        `;
            }
            function svgCoordinateGrid() {
                return `
          <svg viewBox="0 0 520 260" role="img" aria-label="Coordinate grid diagram">
            <rect x="1" y="1" width="518" height="258" fill="none" stroke="#bdb8ae"/>
            <g stroke="#d0ccc3" stroke-width="1">
              ${Array.from({ length: 10 }, (_, i) => `<line x1="${40 + i * 44}" y1="20" x2="${40 + i * 44}" y2="240" />`).join("")}
              ${Array.from({ length: 6 }, (_, i) => `<line x1="40" y1="${20 + i * 36}" x2="480" y2="${20 + i * 36}" />`).join("")}
            </g>
            <g stroke="#2b2b2b" stroke-width="2">
              <line x1="40" y1="240" x2="480" y2="240" />
              <line x1="40" y1="240" x2="40" y2="20" />
            </g>
            <circle cx="172" cy="168" r="5" fill="#2b2b2b"/>
            <circle cx="304" cy="96" r="5" fill="#2b2b2b"/>
            <line x1="172" y1="168" x2="304" y2="96" stroke="#6f6a61" stroke-width="2" />
            <text x="182" y="164" font-size="13" fill="#6a665f">(3,2)</text>
            <text x="314" y="92" font-size="13" fill="#6a665f">(6,4)</text>
          </svg>
        `;
            }
            function svgTableGrid() {
                return `
          <svg viewBox="0 0 520 220" role="img" aria-label="Table grid diagram">
            <rect x="1" y="1" width="518" height="218" fill="none" stroke="#bdb8ae"/>
            <rect x="60" y="40" width="400" height="140" fill="none" stroke="#2b2b2b" stroke-width="2"/>
            <g stroke="#2b2b2b" stroke-width="2">
              <line x1="60" y1="86.666" x2="460" y2="86.666" />
              <line x1="60" y1="133.333" x2="460" y2="133.333" />
              <line x1="193.333" y1="40" x2="193.333" y2="180" />
              <line x1="326.666" y1="40" x2="326.666" y2="180" />
            </g>
            <text x="72" y="30" font-size="13" fill="#6a665f">Value</text>
            <text x="212" y="30" font-size="13" fill="#6a665f">Count</text>
            <text x="346" y="30" font-size="13" fill="#6a665f">Total</text>
          </svg>
        `;
            }

            function makeDiagram(kind) {
                const map = { geometry: svgGeometry, ratio: svgRatioBars, grid: svgCoordinateGrid, table: svgTableGrid };
                const fn = map[kind] || svgGeometry;
                const wrap = document.createElement('div');
                wrap.className = 'diagram';
                wrap.innerHTML = fn();
                return wrap;
            }

            /* ---------- Content helpers ---------- */
            function h(tag, attrs = {}, ...children) {
                const el = document.createElement(tag);
                for (const [k, v] of Object.entries(attrs)) {
                    if (v === null || v === undefined) continue;
                    if (k === 'class') el.className = v;
                    else if (k === 'html') el.innerHTML = v;
                    else if (k.startsWith('data-')) el.setAttribute(k, v);
                    else if (k === 'for') el.htmlFor = v;
                    else if (k === 'id') el.id = v;
                    else if (k === 'role') el.setAttribute('role', v);
                    else if (k === 'aria-label') el.setAttribute('aria-label', v);
                    else if (k === 'aria-labelledby') el.setAttribute('aria-labelledby', v);
                    else if (k === 'aria-controls') el.setAttribute('aria-controls', v);
                    else if (k === 'aria-expanded') el.setAttribute('aria-expanded', v);
                    else if (k === 'aria-hidden') el.setAttribute('aria-hidden', v);
                    else if (k === 'href') el.setAttribute('href', v);
                    else if (k === 'type') el.setAttribute('type', v);
                    else el.setAttribute(k, v);
                }
                for (const c of children) {
                    if (c === null || c === undefined) continue;
                    if (typeof c === 'string') el.appendChild(document.createTextNode(c));
                    else el.appendChild(c);
                }
                return el;
            }

            function texInline(latex) {
                return `<span class="math-inline" data-tex="${escapeAttr(latex)}">[KaTeX inline] ${escapeHtml(latex)}</span>`;
            }
            function texBlock(latex) {
                return `<div class="math-block" data-tex="${escapeAttr(latex)}">[KaTeX block] ${escapeHtml(latex)}</div>`;
            }
            function escapeHtml(s) {
                return String(s)
                    .replaceAll("&", "&amp;")
                    .replaceAll("<", "&lt;")
                    .replaceAll(">", "&gt;")
                    .replaceAll('"', "&quot;")
                    .replaceAll("'", "&#039;");
            }
            function escapeAttr(s) {
                return escapeHtml(s).replaceAll("\n", "&#10;");
            }

            function promptFromParagraphs(paras) {
                return paras.map(p => `<p>${p}</p>`).join("");
            }

            function workLinesFromLatex(lines, asBlockEvery = 1) {
                // returns HTML: a vertical stack of math blocks
                const chunks = lines.map((latex, i) => {
                    if (asBlockEvery === 1) return `<div class="line">${texBlock(latex)}</div>`;
                    return (i % asBlockEvery === 0)
                        ? `<div class="line">${texBlock(latex)}</div>`
                        : `<div class="line">${texInline(latex)}</div>`;
                });
                return `<div class="workLines">${chunks.join("")}</div>`;
            }

            /* ---------- Datasets ---------- */
            function buildDatasets() {
                const datasets = {};

                // Short paper (6 Q) with one multi-part question and nesting
                datasets.short = {
                    label: "Short paper",
                    title: "Short paper",
                    note: "A short set for quick answer-checking. Solution details start collapsed.",
                    expandedByDefault: false,
                    sections: null,
                    items: [
                        q("1", 0,
                            promptFromParagraphs([
                                `Calculate ${texInline("47 + 38")}.`
                            ]),
                            `${texInline("85")}`,
                            sol({
                                keep: ["Add tens first, then ones. Check by estimating."],
                                formulas: [],
                                working: [
                                    texBlock("47+38=(40+7)+(30+8)"),
                                    texBlock("=(40+30)+(7+8)=70+15=85")
                                ],
                                alternatives: []
                            })
                        ),
                        q("2", 0,
                            promptFromParagraphs([
                                `Work out ${texInline("6\\times 14")}.`
                            ]),
                            `${texInline("84")}`,
                            sol({
                                keep: ["Use BIDMAS for expressions. Here it’s straightforward multiplication."],
                                formulas: [],
                                working: [
                                    texBlock("6\\times 14=6\\times(10+4)"),
                                    texBlock("=60+24=84")
                                ],
                                alternatives: [
                                    { title: "Alternative working", body: [texBlock("14\\times 6=(7\\times 2)\\times 6=7\\times 12=84")] }
                                ]
                            })
                        ),
                        // Multi-part Q3 with deep nesting
                        q("3", 0,
                            promptFromParagraphs([
                                `A rectangle has length ${texInline("12\\text{ cm}")} and width ${texInline("7\\text{ cm}")}.`
                            ]),
                            `${texInline("\\text{See parts}")}`,
                            null,
                            { isContainer: true }
                        ),
                        q("3(a)", 1,
                            promptFromParagraphs([
                                `Find the perimeter.`
                            ]),
                            `${texInline("38\\text{ cm}")}`,
                            sol({
                                keep: ["Perimeter is the distance all the way around."],
                                formulas: [`${texInline("P=2(l+w)")}`],
                                working: [
                                    texBlock("P=2(12+7)=2\\times 19=38\\text{ cm}")
                                ],
                                alternatives: []
                            })
                        ),
                        q("3(b)(i)", 2,
                            promptFromParagraphs([
                                `Find the area.`
                            ]),
                            `${texInline("84\\text{ cm}^2")}`,
                            sol({
                                keep: [],
                                formulas: [`${texInline("A=l\\times w")}`],
                                working: [
                                    texBlock("A=12\\times 7=84\\text{ cm}^2")
                                ],
                                alternatives: []
                            })
                        ),
                        q("3(b)(ii)", 2,
                            promptFromParagraphs([
                                `If the length increases by ${texInline("3\\text{ cm}")}, what is the new area?`
                            ]),
                            `${texInline("105\\text{ cm}^2")}`,
                            sol({
                                keep: [],
                                formulas: [],
                                working: [
                                    texBlock("l=12+3=15"),
                                    texBlock("A=15\\times 7=105\\text{ cm}^2")
                                ],
                                alternatives: []
                            })
                        ),
                        q("4", 0,
                            promptFromParagraphs([
                                `Simplify ${texInline("\\frac{18}{24}")}.`
                            ]),
                            `${texInline("\\frac{3}{4}")}`,
                            sol({
                                keep: ["Divide top and bottom by the same number."],
                                formulas: [],
                                working: [
                                    texBlock("\\frac{18}{24}=\\frac{18\\div 6}{24\\div 6}=\\frac{3}{4}")
                                ],
                                alternatives: []
                            })
                        ),
                        q("5", 0,
                            promptFromParagraphs([
                                `A circle has radius ${texInline("5\\text{ cm}")}. Find the circumference.`
                            ]),
                            `${texInline("10\\pi\\text{ cm}")}`,
                            sol({
                                keep: ["Use the radius, not the diameter."],
                                formulas: [`${texInline("C=2\\pi r")}`],
                                working: [
                                    texBlock("C=2\\pi\\times 5=10\\pi\\text{ cm}")
                                ],
                                alternatives: []
                            })
                        ),
                        q("6", 0,
                            promptFromParagraphs([
                                `A bag contains 3 red and 5 blue counters. One counter is picked at random. Find the probability it is red.`
                            ]),
                            `${texInline("\\frac{3}{8}")}`,
                            sol({
                                keep: ["Probability = favourable outcomes ÷ total outcomes."],
                                formulas: [],
                                working: [
                                    texBlock("P(\\text{red})=\\frac{3}{3+5}=\\frac{3}{8}")
                                ],
                                alternatives: []
                            })
                        ),
                    ]
                };

                // Standard paper (35 Q): Q26–Q35 long algebra
                datasets.standard = {
                    label: "Standard paper",
                    title: "Standard paper",
                    note: "35 questions. Questions 26–35 contain long algebra with Solution Details collapsed by default.",
                    expandedByDefault: false,
                    sections: null,
                    items: buildStandardItems({ expandedAll: false })
                };

                // Standard (Workings Expanded)
                datasets.standardExpanded = {
                    label: "Standard (Workings Expanded)",
                    title: "Standard paper (Workings Expanded)",
                    note: "Evaluation variant only: same as Standard paper, but all Solution Details start expanded.",
                    expandedByDefault: true,
                    sections: null,
                    items: buildStandardItems({ expandedAll: true })
                };

                // Diagram-heavy paper (20 Q), 8 with diagrams
                datasets.diagram = {
                    label: "Diagram-heavy paper",
                    title: "Diagram-heavy paper",
                    note: "20 questions. Eight include diagrams inside the Question prompt.",
                    expandedByDefault: false,
                    sections: null,
                    items: buildDiagramItems()
                };

                // Sectioned paper: A(35), B(8), C(6) long
                datasets.sectioned = {
                    label: "Sectioned paper",
                    title: "Sectioned paper",
                    note: "Original structure with sections A, B, C. Section C questions have very long Solution Details (collapsed by default).",
                    expandedByDefault: false,
                    sections: [
                        { key: "A", label: "A" },
                        { key: "B", label: "B" },
                        { key: "C", label: "C" },
                    ],
                    items: buildSectionedItems()
                };

                return datasets;
            }

            function q(idLabel, level, promptHTML, answerHTML, solutionObj, opts = {}) {
                return {
                    idLabel,
                    level,
                    promptHTML,
                    answerHTML,
                    solutionObj,
                    section: opts.section || null,
                    isContainer: !!opts.isContainer,
                    diagram: opts.diagram || null
                };
            }

            function sol({ keep = [], formulas = [], working = [], alternatives = [] }) {
                // working and alternatives accept arrays of HTML strings
                return { keep, formulas, working, alternatives };
            }

            function buildStandardItems({ expandedAll }) {
                const items = [];
                // Q1–Q17 short/medium mix
                for (let n = 1; n <= 17; n++) {
                    items.push(
                        q(String(n), 0,
                            promptFromParagraphs([
                                n % 3 === 0
                                    ? `Work out ${texInline(`${20 + n}\\times 3`)}.`
                                    : n % 3 === 1
                                        ? `Calculate ${texInline(`${60 + n} - ${18 + n}`)}.`
                                        : `Find ${texInline(`\\frac{${12 + n}}{6}`)}.`
                            ]),
                            n % 3 === 0
                                ? `${texInline(String((20 + n) * 3))}`
                                : n % 3 === 1
                                    ? `${texInline(String((60 + n) - (18 + n)))}`
                                    : `${texInline(String((12 + n) / 6))}`,
                            sol({
                                keep: (n === 2 || n === 9 || n === 13) ? ["Use BIDMAS when there are mixed operations."] : [],
                                formulas: (n === 7 || n === 11) ? [`${texInline("\\text{Fraction} = \\frac{\\text{part}}{\\text{whole}}")}`] : [],
                                working: [
                                    texBlock(n % 3 === 0 ? `${20 + n}\\times 3=(${20 + n}\\times 2)+(${20 + n}\\times 1)` : n % 3 === 1 ? `${60 + n}-(${18 + n})` : `\\frac{${12 + n}}{6}`),
                                    texBlock(n % 3 === 0 ? `=${(20 + n) * 2}+${20 + n}=${(20 + n) * 3}` : n % 3 === 1 ? `=${(60 + n) - (18 + n)}` : `=${(12 + n) / 6}`)
                                ],
                                alternatives: (n === 5 || n === 14 || n === 16) ? [
                                    { title: "Alternative working", body: [texBlock("\\text{Check by estimating to see if the answer is sensible.}")] }
                                ] : []
                            })
                        )
                    );
                }

                // Q18 deep nesting: 18(a)(i), 18(a)(ii), 18(b)
                items.push(q("18", 0,
                    promptFromParagraphs([
                        `Solve the following.`
                    ]),
                    `${texInline("\\text{See parts}")}`,
                    null,
                    { isContainer: true }
                ));
                items.push(q("18(a)(i)", 2,
                    promptFromParagraphs([`Solve ${texInline("3x+5=20")}.`]),
                    `${texInline("x=5")}`,
                    sol({
                        keep: ["Do the same operation to both sides."],
                        formulas: [],
                        working: [
                            texBlock("3x+5=20"),
                            texBlock("3x=20-5=15"),
                            texBlock("x=\\frac{15}{3}=5")
                        ],
                        alternatives: [
                            { title: "Alternative working", body: [texBlock("\\text{Check: }3\\times 5+5=20\\;\\checkmark")] }
                        ]
                    })
                ));
                items.push(q("18(a)(ii)", 2,
                    promptFromParagraphs([`Solve ${texInline("2(x-4)=10")}.`]),
                    `${texInline("x=9")}`,
                    sol({
                        keep: [],
                        formulas: [],
                        working: [
                            texBlock("2(x-4)=10"),
                            texBlock("x-4=\\frac{10}{2}=5"),
                            texBlock("x=9")
                        ],
                        alternatives: []
                    })
                ));
                items.push(q("18(b)", 1,
                    promptFromParagraphs([`Rearrange to make ${texInline("y")} the subject: ${texInline("y=3a-2b")}.`]),
                    `${texInline("a=\\frac{y+2b}{3}")}`,
                    sol({
                        keep: ["Isolate the term containing the subject first."],
                        formulas: [],
                        working: [
                            texBlock("y=3a-2b"),
                            texBlock("y+2b=3a"),
                            texBlock("a=\\frac{y+2b}{3}")
                        ],
                        alternatives: []
                    })
                ));

                // Q19–Q25 medium, include solution variants coverage
                for (let n = 19; n <= 25; n++) {
                    const hasKeep = (n === 19 || n === 22 || n === 25);
                    const hasForm = (n === 20 || n === 23 || n === 24);
                    const hasAlt = (n === 21 || n === 23 || n === 25);
                    items.push(
                        q(String(n), 0,
                            promptFromParagraphs([
                                n === 20
                                    ? `A triangle has base ${texInline("9\\text{ cm}")} and height ${texInline("8\\text{ cm}")}. Find its area.`
                                    : n === 21
                                        ? `Convert ${texInline("0.375")} to a fraction in simplest form.`
                                        : n === 22
                                            ? `A train travels ${texInline("120\\text{ km}")} in ${texInline("2\\text{ h}")}. Find the average speed in ${texInline("\\text{km/h}")}.`
                                            : n === 23
                                                ? `Expand and simplify ${texInline("(x+3)(x-5)")}.`
                                                : n === 24
                                                    ? `Find the mean of the numbers: 6, 9, 10, 15, 20.`
                                                    : `A circle has diameter ${texInline("12\\text{ cm}")}. Find the radius.`
                            ]),
                            n === 20 ? `${texInline("36\\text{ cm}^2")}`
                                : n === 21 ? `${texInline("\\frac{3}{8}")}`
                                    : n === 22 ? `${texInline("60\\text{ km/h}")}`
                                        : n === 23 ? `${texInline("x^2-2x-15")}`
                                            : n === 24 ? `${texInline("12")}`
                                                : `${texInline("6\\text{ cm}")}`,
                            sol({
                                keep: hasKeep ? [
                                    n === 19 ? "Decimals can be turned into fractions by using place value." :
                                        n === 22 ? "Speed = distance ÷ time. Keep the units consistent." :
                                            "Read the question carefully before choosing a formula."
                                ] : [],
                                formulas: hasForm ? [
                                    n === 20 ? `${texInline("A=\\frac{1}{2}bh")}` :
                                        n === 24 ? `${texInline("\\text{Mean}=\\frac{\\text{sum}}{\\text{count}}")}` :
                                            `${texInline("C=\\pi d\\;\\;\\text{and}\\;\\;r=\\frac{d}{2}")}`
                                ] : [],
                                working: buildWorkingForStandardMedium(n),
                                alternatives: hasAlt ? [
                                    {
                                        title: "Alternative working", body: [
                                            n === 23 ? texBlock("(x+3)(x-5)=x(x-5)+3(x-5)=x^2-5x+3x-15=x^2-2x-15") :
                                                n === 21 ? texBlock("0.375=\\frac{375}{1000}=\\frac{3}{8}") :
                                                    texBlock("\\text{Quick check: substitute the answer back into the context.}")
                                        ]
                                    }
                                ] : []
                            })
                        )
                    );
                }

                // Q26–Q35: long algebra (collapsed by default; expandedAll may override)
                for (let n = 26; n <= 35; n++) {
                    const longId = String(n);
                    const longPrompt = promptFromParagraphs([
                        `Solve and show clear working: ${texInline("2x^2 + (n-20)x - 12 = 0")} where ${texInline("n=" + n)}.`,
                        `Give exact solutions where possible.`
                    ]);
                    const a = 2, b = (n - 20), c = -12;
                    const disc = b * b - 4 * a * c; // always positive
                    // Keep answer short (two roots)
                    const ans = `${texInline(`x=\\frac{-${b}+\\sqrt{${disc}}}{4}`)} , ${texInline(`x=\\frac{-${b}-\\sqrt{${disc}}}{4}`)}`;

                    // Extremely long working for selected questions (50–60 lines)
                    const isExtreme = (n === 30 || n === 34);
                    const work = [];
                    work.push(texBlock(`2x^2+(${b})x-12=0`));
                    work.push(texBlock(`a=2,\\;b=${b},\\;c=-12`));
                    work.push(texBlock(`\\Delta=b^2-4ac=${b}^2-4\\cdot 2\\cdot(-12)=${b * b}+96=${disc}`));
                    work.push(texBlock(`x=\\frac{-b\\pm\\sqrt{\\Delta}}{2a}=\\frac{-(${b})\\pm\\sqrt{${disc}}}{4}`));
                    work.push(texBlock(`x=\\frac{-${b}\\pm\\sqrt{${disc}}}{4}`));
                    // Add multiple KaTeX blocks for stress
                    work.push(texBlock(`\\text{Check (substitute): }2x^2+(${b})x-12`));
                    work.push(texBlock(`\\text{If }x=\\frac{-${b}+\\sqrt{${disc}}}{4},\\;\\text{then simplify carefully.}`));

                    // Build a long tail of lines (especially for extreme)
                    const longLines = [];
                    const base = n - 19;
                    const count = isExtreme ? 56 : 18;
                    for (let i = 1; i <= count; i++) {
                        // intentionally include occasional long expressions to force horizontal math scrolling
                        if (i % 9 === 0) {
                            longLines.push(`\\frac{-${b}+\\sqrt{${disc}}}{4}=\\frac{-${b}+\\sqrt{${disc}}}{4}\\cdot\\frac{\\sqrt{${disc}}+${b}}{\\sqrt{${disc}}+${b}}=\\frac{-${b}(\\sqrt{${disc}}+${b})+${disc}+${b}\\sqrt{${disc}}}{4(\\sqrt{${disc}}+${b})}`);
                        } else {
                            longLines.push(`\\text{Step ${i}: }\\;2x^2+${b}x-12\\;\\Rightarrow\\;2x^2=${base + i}+12-${b}x`);
                        }
                    }
                    const longWorkHTML = work.join("") + workLinesFromLatex(longLines, 1);

                    // Alternative working for some
                    const alt = (n === 29 || n === 33 || n === 35) ? [
                        {
                            title: "Alternative working", body: [
                                texBlock("\\text{Alternative: factorisation may be possible if }\\Delta\\text{ is a square.}"),
                                texBlock(`\\Delta=${disc}\\;\\Rightarrow\\;\\text{try }\\sqrt{\\Delta}\\text{ if it is an integer.}`),
                                texBlock("\\text{If not, leave the answer in surd form.}")
                            ]
                        }
                    ] : [];

                    items.push(
                        q(longId, 0, longPrompt, ans,
                            sol({
                                keep: (n === 27 || n === 31 || n === 34) ? [
                                    "Write down a, b, c before using the quadratic formula.",
                                    "Keep your arithmetic tidy to avoid sign errors."
                                ] : [],
                                formulas: (n === 26 || n === 30 || n === 32) ? [
                                    `${texInline("x=\\frac{-b\\pm\\sqrt{b^2-4ac}}{2a}")}`
                                ] : [],
                                working: [longWorkHTML],
                                alternatives: alt
                            })
                        )
                    );
                }

                // Q30 deep nesting add-on: 30(a)(i), 30(a)(ii), 30(b)
                // Keep these in correct paper order by inserting right after Q30 (already added) would be complex;
                // Instead, include them as separate nested questions directly after Q30 for stress-test nesting.
                // Find index of Q30 and splice.
                const idx30 = items.findIndex(it => it.idLabel === "30");
                if (idx30 >= 0) {
                    const nested = [
                        q("30(a)", 1,
                            promptFromParagraphs([`For ${texInline("x=5")}, evaluate ${texInline("2x^2 + (30-20)x - 12")}.`]),
                            `${texInline("2\\cdot 25+10\\cdot 5-12=88")}`,
                            sol({
                                keep: ["Substitute carefully, then simplify."],
                                formulas: [],
                                working: [
                                    texBlock("2x^2+(10)x-12"),
                                    texBlock("=2\\cdot 5^2+10\\cdot 5-12"),
                                    texBlock("=50+50-12=88")
                                ],
                                alternatives: []
                            }),
                            {}
                        ),
                        q("30(a)(i)", 2,
                            promptFromParagraphs([`Show the substitution step clearly.`]),
                            `${texInline("2\\cdot 5^2+10\\cdot 5-12")}`,
                            sol({
                                keep: [],
                                formulas: [],
                                working: [texBlock("2x^2+10x-12\\;\\text{with }x=5\\Rightarrow 2\\cdot 5^2+10\\cdot 5-12")],
                                alternatives: []
                            })
                        ),
                        q("30(a)(ii)", 2,
                            promptFromParagraphs([`Complete the simplification.`]),
                            `${texInline("88")}`,
                            sol({
                                keep: [],
                                formulas: [],
                                working: [texBlock("2\\cdot 25+50-12=50+50-12=88")],
                                alternatives: []
                            })
                        ),
                        q("30(b)", 1,
                            promptFromParagraphs([`Explain why the quadratic has two solutions when ${texInline("\\Delta>0")}.`]),
                            `Two distinct real solutions.`,
                            sol({
                                keep: ["The discriminant tells you how many real roots exist."],
                                formulas: [`${texInline("\\Delta=b^2-4ac")}`],
                                working: [
                                    texBlock("\\Delta>0\\Rightarrow \\sqrt{\\Delta}\\text{ is real and non-zero}"),
                                    texBlock("x=\\frac{-b\\pm\\sqrt{\\Delta}}{2a}\\Rightarrow \\text{two different values}")
                                ],
                                alternatives: []
                            })
                        ),
                    ];
                    items.splice(idx30 + 1, 0, ...nested);
                }

                // Ensure identifiers remain unique (they are)
                // Mark expanded default at item-level by dataset config; we control when rendering.
                items.forEach(it => it._expandedAll = expandedAll);
                return items;
            }

            function buildWorkingForStandardMedium(n) {
                const out = [];
                if (n === 20) {
                    out.push(texBlock("A=\\frac{1}{2}bh"));
                    out.push(texBlock("A=\\frac{1}{2}\\cdot 9\\cdot 8=36\\text{ cm}^2"));
                } else if (n === 21) {
                    out.push(texBlock("0.375=\\frac{375}{1000}"));
                    out.push(texBlock("\\frac{375}{1000}=\\frac{3}{8}"));
                } else if (n === 22) {
                    out.push(texBlock("\\text{Speed} = \\frac{\\text{distance}}{\\text{time}}"));
                    out.push(texBlock("=\\frac{120}{2}=60\\text{ km/h}"));
                } else if (n === 23) {
                    out.push(texBlock("(x+3)(x-5)=x^2-5x+3x-15"));
                    out.push(texBlock("=x^2-2x-15"));
                } else if (n === 24) {
                    out.push(texBlock("\\text{Sum}=6+9+10+15+20=60"));
                    out.push(texBlock("\\text{Mean}=\\frac{60}{5}=12"));
                } else {
                    out.push(texBlock("d=12\\text{ cm}"));
                    out.push(texBlock("r=\\frac{d}{2}=6\\text{ cm}"));
                }
                return out;
            }

            function buildDiagramItems() {
                const items = [];
                // 20 questions; 8 diagrams
                const diagramQs = new Set([2, 4, 6, 9, 12, 14, 17, 19]);
                const kinds = ["geometry", "ratio", "grid", "table"];
                let kindIdx = 0;

                for (let n = 1; n <= 20; n++) {
                    const hasD = diagramQs.has(n);
                    const kind = kinds[kindIdx % kinds.length];
                    if (hasD) kindIdx++;

                    const prompt = (n === 1)
                        ? promptFromParagraphs([`Estimate ${texInline("198+403")} by rounding to the nearest hundred.`])
                        : (n === 2)
                            ? promptFromParagraphs([`In the diagram, find the radius ${texInline("r")} of the circle if the diameter is ${texInline("14\\text{ cm}")}.`])
                            : (n === 4)
                                ? promptFromParagraphs([`Use the ratio bars to find A when B is 24 and the ratio ${texInline("A:B=3:4")}.`])
                                : (n === 6)
                                    ? promptFromParagraphs([`On the coordinate grid, find the gradient of the line joining ${texInline("(3,2)")} and ${texInline("(6,4)")}.`])
                                    : (n === 9)
                                        ? promptFromParagraphs([`Complete the table for total cost when price is ${texInline("£3")} each for 1, 2, 3 items.`])
                                        : promptFromParagraphs([`Answer the question: simplify ${texInline(`\\frac{${10 + n}}{${2 + (n % 4)}}`)}.`]);

                    const answer = (n === 1) ? `${texInline("600")}` :
                        (n === 2) ? `${texInline("7\\text{ cm}")}` :
                            (n === 4) ? `${texInline("18")}` :
                                (n === 6) ? `${texInline("\\frac{2}{3}")}` :
                                    (n === 9) ? `£3, £6, £9` :
                                        `${texInline("\\text{simplified fraction}")}`;

                    const keep = (n === 6 || n === 12 || n === 17) ? ["Draw a small sketch if it helps you keep track of information."] : [];
                    const formulas = (n === 6) ? [`${texInline("m=\\frac{y_2-y_1}{x_2-x_1}")}`] :
                        (n === 2) ? [`${texInline("r=\\frac{d}{2}")}`] :
                            (n === 4) ? [`${texInline("\\text{Share} = \\text{total}\\times\\frac{\\text{parts}}{\\text{total parts}}")}`] : [];
                    const alternatives = (n === 4 || n === 9 || n === 14) ? [
                        { title: "Alternative working", body: [texBlock("\\text{Check by scaling the ratio to match the given value.}")] }
                    ] : [];

                    const working = [];
                    if (n === 1) {
                        working.push(texBlock("198\\approx 200,\\;403\\approx 400"));
                        working.push(texBlock("200+400=600"));
                    } else if (n === 2) {
                        working.push(texBlock("d=14\\Rightarrow r=\\frac{14}{2}=7"));
                    } else if (n === 4) {
                        working.push(texBlock("A:B=3:4\\Rightarrow \\text{total parts}=7"));
                        working.push(texBlock("B=24\\Rightarrow 4\\text{ parts}=24\\Rightarrow 1\\text{ part}=6"));
                        working.push(texBlock("A=3\\text{ parts}=3\\times 6=18"));
                    } else if (n === 6) {
                        working.push(texBlock("m=\\frac{4-2}{6-3}=\\frac{2}{3}"));
                    } else if (n === 9) {
                        working.push(texBlock("\\text{Cost}=3\\times\\text{number of items}"));
                        working.push(texBlock("1\\to 3,\\;2\\to 6,\\;3\\to 9"));
                    } else {
                        working.push(texBlock(`\\frac{${10 + n}}{${2 + (n % 4)}}\\;\\text{(simplify by dividing numerator and denominator by a common factor if possible)}`));
                    }

                    items.push(
                        q(String(n), 0, prompt, answer,
                            sol({ keep, formulas, working, alternatives }),
                            { diagram: hasD ? kind : null }
                        )
                    );
                }
                return items;
            }

            function buildSectionedItems() {
                const items = [];
                // Section A: 35 small/medium
                for (let n = 1; n <= 35; n++) {
                    const idLabel = String(n);
                    items.push(
                        q(idLabel, 0,
                            promptFromParagraphs([
                                n % 5 === 0
                                    ? `Find ${texInline(`\\frac{${5 + n}}{${1 + (n % 3)}}`)} as a mixed number.`
                                    : n % 5 === 1
                                        ? `Calculate ${texInline(`${90 + n} \\div 3`)}.`
                                        : n % 5 === 2
                                            ? `Work out ${texInline(`${12 + n}^2`)}.`
                                            : n % 5 === 3
                                                ? `If ${texInline("p=4")} and ${texInline("q=7")}, find ${texInline("2p+3q")}.`
                                                : `Simplify ${texInline("5x+3x-2")}.`
                            ]),
                            n % 5 === 0 ? `${texInline("\\text{mixed number}")}`
                                : n % 5 === 1 ? `${texInline(String(Math.floor((90 + n) / 3)))}` // close enough for stress
                                    : n % 5 === 2 ? `${texInline(String((12 + n) * (12 + n)))}`
                                        : n % 5 === 3 ? `${texInline("29")}`
                                            : `${texInline("8x-2")}`,
                            sol({
                                keep: (n === 6 || n === 17 || n === 28) ? ["Write the expression clearly before simplifying."] : [],
                                formulas: (n === 12 || n === 20 || n === 33) ? [`${texInline("a^2=a\\times a")}`] : [],
                                working: [
                                    texBlock("\\text{Show tidy steps:}"),
                                    texBlock("\\text{(Example line)}\\;\\;\\text{simplify carefully and check units where needed.}")
                                ],
                                alternatives: (n === 10 || n === 21 || n === 30) ? [
                                    { title: "Alternative working", body: [texBlock("\\text{Use a quick estimate to check your answer makes sense.}")] }
                                ] : []
                            }),
                            { section: "A" }
                        )
                    );
                }

                // Section B: 8 medium
                for (let i = 1; i <= 8; i++) {
                    const n = i;
                    const idLabel = `B${i}`; // navigation must be identifiers only; but brief allows only question identifiers like numbers. For sectioned paper, keep numbers but separated by section.
                    // Use real numeric labels continuing? Better: use 1–8 under B but will clash with A. So use 1–8 but section separator implies context.
                    // However navigation labels must be question identifiers only; "B1" is not a question identifier. Use 36–43 for B? But brief says section labels separators and question identifiers beneath them. So use 1–8 under B, but then duplicates.
                    // To avoid duplicates and keep identifier number-based, use 1–8 but include section in DOM id to avoid collision while label remains number.
                    items.push(
                        q(String(i), 0,
                            promptFromParagraphs([
                                i === 1 ? `A bag has 5 green and 7 yellow marbles. Find ${texInline("P(\\text{green})")}.`
                                    : i === 2 ? `Solve ${texInline("4x-9=19")}.`
                                        : i === 3 ? `Find the area of a circle with radius ${texInline("3\\text{ cm}")}.`
                                            : i === 4 ? `Expand ${texInline("(2x-1)(x+6)")}.`
                                                : i === 5 ? `A recipe uses flour and sugar in ratio ${texInline("5:2")}. If flour is 250g, find sugar.`
                                                    : i === 6 ? `Rearrange ${texInline("v=u+at")} to make ${texInline("t")} the subject.`
                                                        : i === 7 ? `Find the median of 3, 8, 8, 10, 14, 20, 21.`
                                                            : `Convert ${texInline("2.4")} to a fraction in simplest form.`
                            ]),
                            i === 1 ? `${texInline("\\frac{5}{12}")}`
                                : i === 2 ? `${texInline("x=7")}`
                                    : i === 3 ? `${texInline("9\\pi\\text{ cm}^2")}`
                                        : i === 4 ? `${texInline("2x^2+11x-6")}`
                                            : i === 5 ? `100g`
                                                : i === 6 ? `${texInline("t=\\frac{v-u}{a}")}`
                                                    : i === 7 ? `${texInline("10")}`
                                                        : `${texInline("\\frac{12}{5}")}`,
                            sol({
                                keep: (i === 2 || i === 6 || i === 8) ? ["Work one step at a time and keep signs consistent."] : [],
                                formulas: (i === 3) ? [`${texInline("A=\\pi r^2")}`] :
                                    (i === 6) ? [`${texInline("v=u+at")}`] : [],
                                working: [
                                    i === 1 ? texBlock("P(\\text{green})=\\frac{5}{5+7}=\\frac{5}{12}")
                                        : i === 2 ? texBlock("4x-9=19\\Rightarrow 4x=28\\Rightarrow x=7")
                                            : i === 3 ? texBlock("A=\\pi\\times 3^2=9\\pi")
                                                : i === 4 ? texBlock("(2x-1)(x+6)=2x^2+12x-x-6=2x^2+11x-6")
                                                    : i === 5 ? texBlock("5\\text{ parts}=250\\Rightarrow 1\\text{ part}=50\\Rightarrow 2\\text{ parts}=100")
                                                        : i === 6 ? texBlock("v=u+at\\Rightarrow v-u=at\\Rightarrow t=\\frac{v-u}{a}")
                                                            : i === 7 ? texBlock("\\text{Middle value is }10")
                                                                : texBlock("2.4=\\frac{24}{10}=\\frac{12}{5}")
                                ],
                                alternatives: (i === 5 || i === 7 || i === 8) ? [
                                    { title: "Alternative working", body: [texBlock("\\text{Check by substituting back into the original relationship.}")] }
                                ] : []
                            }),
                            { section: "B", _domKeyPrefix: "B-" }
                        )
                    );
                }

                // Section C: 6 very long solution details, collapsed default
                for (let i = 1; i <= 6; i++) {
                    const idLabel = String(i);
                    const longPrompt = promptFromParagraphs([
                        `Prove the identity and show all steps: ${texInline("\\frac{1}{x-1}-\\frac{1}{x+1}=\\frac{2}{x^2-1}")}.`,
                        `State any restrictions on ${texInline("x")}.`
                    ]);

                    const keep = (i === 1 || i === 3 || i === 6) ? [
                        "Write restrictions first to avoid dividing by zero.",
                        "Use a common denominator before simplifying."
                    ] : [];

                    const formulas = (i === 2 || i === 4 || i === 6) ? [
                        `${texInline("\\frac{a}{b}-\\frac{c}{d}=\\frac{ad-bc}{bd}")}`,
                        `${texInline("x^2-1=(x-1)(x+1)")}`
                    ] : [];

                    // 50–60 lines for selected (extremely long)
                    const extreme = (i === 2 || i === 5);
                    const lines = [];
                    lines.push("\\frac{1}{x-1}-\\frac{1}{x+1}");
                    lines.push("=\\frac{x+1}{(x-1)(x+1)}-\\frac{x-1}{(x+1)(x-1)}");
                    lines.push("=\\frac{(x+1)-(x-1)}{(x-1)(x+1)}");
                    lines.push("=\\frac{x+1-x+1}{x^2-1}");
                    lines.push("=\\frac{2}{x^2-1}");
                    const extraCount = extreme ? 55 : 22;
                    for (let k = 1; k <= extraCount; k++) {
                        if (k % 10 === 0) {
                            lines.push("\\frac{(x+1)-(x-1)}{(x-1)(x+1)}=\\frac{x+1-x+1}{(x-1)(x+1)}=\\frac{2}{(x-1)(x+1)}=\\frac{2}{x^2-1}");
                        } else {
                            lines.push(`\\text{Line ${k}: }\\;x\\neq 1,\\;x\\neq -1\\;\\text{(restriction reminder)}`);
                        }
                    }

                    const workingHTML = workLinesFromLatex(lines, 1);

                    const alt = (i === 3 || i === 6) ? [
                        {
                            title: "Alternative working", body: [
                                texBlock("\\text{Alternative: start by factorising }x^2-1=(x-1)(x+1)."),
                                texBlock("\\text{Then show both sides become }\\frac{2}{(x-1)(x+1)}.")
                            ]
                        }
                    ] : [];

                    items.push(
                        q(idLabel, 0, longPrompt,
                            `${texInline("x\\neq 1,\\;x\\neq -1;\\;\\text{identity holds}")}`,
                            sol({
                                keep,
                                formulas,
                                working: [workingHTML],
                                alternatives: alt
                            }),
                            { section: "C", _domKeyPrefix: "C-" }
                        )
                    );
                }

                // Add deep nesting add-on inside Section C (still under section C)
                items.push(q("6(a)(i)", 2,
                    promptFromParagraphs([`State the restriction(s) on ${texInline("x")} for ${texInline("\\frac{1}{x-1}")}.`]),
                    `${texInline("x\\neq 1")}`,
                    sol({
                        keep: [],
                        formulas: [],
                        working: [texBlock("\\frac{1}{x-1}\\text{ is undefined when }x-1=0\\Rightarrow x=1")],
                        alternatives: []
                    }),
                    { section: "C", _domKeyPrefix: "C-" }
                ));
                items.push(q("6(a)(ii)", 2,
                    promptFromParagraphs([`State the restriction(s) on ${texInline("x")} for ${texInline("\\frac{1}{x+1}")}.`]),
                    `${texInline("x\\neq -1")}`,
                    sol({
                        keep: [],
                        formulas: [],
                        working: [texBlock("\\frac{1}{x+1}\\text{ is undefined when }x+1=0\\Rightarrow x=-1")],
                        alternatives: []
                    }),
                    { section: "C", _domKeyPrefix: "C-" }
                ));
                items.push(q("6(b)", 1,
                    promptFromParagraphs([`Explain why ${texInline("x^2-1")} can be written as ${texInline("(x-1)(x+1)")}.`]),
                    `Because it is a difference of two squares.`,
                    sol({
                        keep: [],
                        formulas: [`${texInline("a^2-b^2=(a-b)(a+b)")}`],
                        working: [
                            texBlock("x^2-1^2=(x-1)(x+1)")
                        ],
                        alternatives: []
                    }),
                    { section: "C", _domKeyPrefix: "C-" }
                ));

                // Ensure Solution Details coverage stress test (frequent keep/formulas/alt)
                // (Already broadly covered across sections A/B/C with multiple instances.)

                return items;
            }

            /* ---------- Rendering ---------- */
            function populateSelector(datasets) {
                elPaperSelect.innerHTML = "";
                for (const [k, ds] of Object.entries(datasets)) {
                    elPaperSelect.appendChild(h('option', { value: k }, ds.label));
                }
            }

            function renderPaper(datasets, key) {
                currentDatasetKey = key;
                const ds = datasets[key];
                elPaper.innerHTML = "";
                elNavList.innerHTML = "";
                elNavListMobile.innerHTML = "";

                // Title + note
                elPaper.appendChild(h('div', { class: 'paperTitle' }, ds.title));
                elPaper.appendChild(h('div', { class: 'paperNote' }, ds.note));

                const navModel = [];

                // Build DOM in linear order, with section separators in navigation only
                const sectionOrder = ds.sections ? ds.sections.map(s => s.key) : null;

                // Collect items in order; for sectioned, keep existing order in items array but navigation includes separators
                let lastNavSection = null;

                ds.items.forEach((item, idx) => {
                    const domKeyPrefix = item._domKeyPrefix || (item.section ? (item.section + "-") : "");
                    const safeId = makeDomId(domKeyPrefix + item.idLabel);

                    // Render question
                    const sec = h('section', { class: `q level-${item.level}`, id: safeId, 'data-qid': item.idLabel, 'data-level': String(item.level) });

                    // Question head
                    const head = h('div', { class: 'qHead' },
                        h('div', { class: 'qid' }, item.idLabel),
                        h('div', { class: 'qPrompt', html: item.promptHTML })
                    );
                    sec.appendChild(head);

                    // Diagram inside question block if present
                    if (item.diagram) {
                        sec.appendChild(makeDiagram(item.diagram));
                    }

                    // Answer
                    const answerRow = h('div', { class: 'answerRow' },
                        h('div', { class: 'answerLabel' }, 'Answer'),
                        h('div', { class: 'answerValue', html: item.answerHTML })
                    );
                    sec.appendChild(answerRow);

                    // If container-only question (e.g., "18" or "3"), still show toggle? No: it has no solution details.
                    const hasSolution = !!item.solutionObj;

                    if (hasSolution) {
                        const solId = "sol-" + safeId;
                        const toggle = h('button', {
                            class: 'toggle',
                            type: 'button',
                            'aria-expanded': String(Boolean(ds.expandedByDefault)),
                            'aria-controls': solId
                        },
                            h('span', { class: 'toggleText' }, ds.expandedByDefault ? 'Hide working' : 'Show working'),
                            h('span', { class: 'chev', 'aria-hidden': 'true' }, '▾')
                        );
                        const toggleRow = h('div', { class: 'toggleRow' }, toggle);
                        sec.appendChild(toggleRow);

                        const solWrap = h('div', { class: 'solWrap' + (ds.expandedByDefault ? ' open' : ''), 'aria-hidden': ds.expandedByDefault ? 'false' : 'true' });
                        const solOuter = h('div', { class: 'sol', id: solId });
                        const solInner = h('div', { class: 'solInner' });

                        // Keep in mind (optional)
                        if (item.solutionObj.keep && item.solutionObj.keep.length) {
                            solInner.appendChild(
                                h('div', { class: 'solBlock' },
                                    h('div', { class: 'solLabel' }, 'Keep in mind'),
                                    h('div', { class: 'solBody', html: item.solutionObj.keep.map(t => `<p>${escapeHtml(t)}</p>`).join("") })
                                )
                            );
                        }
                        // Formulas used (optional)
                        if (item.solutionObj.formulas && item.solutionObj.formulas.length) {
                            solInner.appendChild(
                                h('div', { class: 'solBlock' },
                                    h('div', { class: 'solLabel' }, 'Formulas used'),
                                    h('div', { class: 'solBody', html: item.solutionObj.formulas.map(t => `<p>${t}</p>`).join("") })
                                )
                            );
                        }
                        // Working (primary)
                        solInner.appendChild(
                            h('div', { class: 'solBlock' },
                                h('div', { class: 'solLabel' }, 'Working'),
                                h('div', { class: 'solBody', html: normalizeWorkingHTML(item.solutionObj.working) })
                            )
                        );
                        // Alternative working (0+)
                        if (item.solutionObj.alternatives && item.solutionObj.alternatives.length) {
                            item.solutionObj.alternatives.forEach(alt => {
                                solInner.appendChild(
                                    h('div', { class: 'solBlock' },
                                        h('div', { class: 'solLabel' }, 'Alternative working'),
                                        h('div', { class: 'solBody', html: normalizeWorkingHTML(alt.body) })
                                    )
                                );
                            });
                        }

                        solOuter.appendChild(solInner);
                        solWrap.appendChild(solOuter);
                        sec.appendChild(solWrap);

                        // Toggle interaction (inline only)
                        toggle.addEventListener('click', () => {
                            const isOpen = toggle.getAttribute('aria-expanded') === 'true';
                            const next = !isOpen;
                            toggle.setAttribute('aria-expanded', String(next));
                            toggle.querySelector('.toggleText').textContent = next ? 'Hide working' : 'Show working';
                            solWrap.classList.toggle('open', next);
                            solWrap.setAttribute('aria-hidden', next ? 'false' : 'true');
                        });
                    }

                    elPaper.appendChild(sec);

                    // Build nav model entry (identifiers only). For sectioned paper: add separators A/B/C.
                    if (ds.sections) {
                        // Determine current item section
                        const sKey = item.section || lastNavSection;
                        if (sKey && sKey !== lastNavSection) {
                            navModel.push({ type: 'sep', label: sKey });
                            lastNavSection = sKey;
                        } else if (!sKey && lastNavSection !== null) {
                            // If somehow out-of-section, no-op
                        }
                    }

                    navModel.push({ type: 'q', label: item.idLabel, targetId: safeId });
                });

                renderNavigation(navModel);
                setupActiveTracking(navModel);
                renderKatexAll();

                // Update KaTeX status
                if (window.katex && typeof window.katex.render === 'function') {
                    elKatexStatus.textContent = "KaTeX rendering: on";
                } else {
                    elKatexStatus.textContent = "KaTeX rendering: unavailable (showing plain text)";
                }
            }

            function normalizeWorkingHTML(arr) {
                if (!arr || !arr.length) return `<p>(No working provided.)</p>`;
                // allow both raw html strings and already-composed blocks
                return arr.map(x => {
                    if (typeof x !== 'string') return '';
                    // If a string already contains block wrappers (e.g. workLines), keep as-is
                    // Otherwise wrap plain text in <p>
                    const looksLikeHtml = /<\/(div|p|span|math|section)>|<div|<p|<span/i.test(x);
                    return looksLikeHtml ? x : `<p>${escapeHtml(x)}</p>`;
                }).join("");
            }

            function makeDomId(label) {
                // label may contain (), spaces, etc
                return "q-" + String(label)
                    .toLowerCase()
                    .replaceAll(/[^\w]+/g, "-")
                    .replaceAll(/^-+|-+$/g, "")
                    .replaceAll(/--+/g, "-");
            }

            function renderNavigation(model) {
                elNavList.innerHTML = "";
                elNavListMobile.innerHTML = "";

                function addTo(listEl, node) {
                    listEl.appendChild(node);
                }

                model.forEach(entry => {
                    if (entry.type === 'sep') {
                        const li = h('li', { class: 'navSep' }, entry.label);
                        addTo(elNavList, li.cloneNode(true));
                        addTo(elNavListMobile, li);
                        return;
                    }
                    const li = h('li', { class: 'navItem' });
                    const a = h('a', { href: `#${entry.targetId}`, 'data-target': entry.targetId }, entry.label);
                    li.appendChild(a);

                    const li2 = li.cloneNode(true);
                    // Need to rebind anchor clone
                    const a2 = li2.querySelector('a');

                    addTo(elNavList, li);
                    addTo(elNavListMobile, li2);

                    // Smooth scroll for both
                    [a, a2].forEach(anchor => {
                        anchor.addEventListener('click', (e) => {
                            e.preventDefault();
                            const target = document.getElementById(anchor.getAttribute('data-target'));
                            if (!target) return;
                            closeDrawer();
                            target.scrollIntoView({ behavior: prefersReducedMotion() ? 'auto' : 'smooth', block: 'start' });
                            // Do not change expanded/collapsed states (invariant).
                        });
                    });
                });
            }

            function prefersReducedMotion() {
                return window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
            }

            function setupActiveTracking(model) {
                // Clean old observer
                if (intersectionObserver) {
                    intersectionObserver.disconnect();
                    intersectionObserver = null;
                }
                const qSections = Array.from(elPaper.querySelectorAll('section.q'));
                const navAnchors = Array.from(document.querySelectorAll('.navItem a'));

                const idToAnchors = new Map();
                navAnchors.forEach(a => {
                    const tid = a.getAttribute('data-target');
                    if (!idToAnchors.has(tid)) idToAnchors.set(tid, []);
                    idToAnchors.get(tid).push(a);
                });

                function setCurrent(targetId) {
                    navAnchors.forEach(a => a.setAttribute('aria-current', 'false'));
                    const arr = idToAnchors.get(targetId) || [];
                    arr.forEach(a => a.setAttribute('aria-current', 'true'));
                }

                // IntersectionObserver: choose the first question that's sufficiently in view
                intersectionObserver = new IntersectionObserver((entries) => {
                    const visible = entries
                        .filter(en => en.isIntersecting)
                        .sort((a, b) => a.boundingClientRect.top - b.boundingClientRect.top);
                    if (visible.length) {
                        setCurrent(visible[0].target.id);
                    }
                }, {
                    root: null,
                    rootMargin: "-20% 0px -70% 0px",
                    threshold: [0, 0.1, 0.25]
                });

                qSections.forEach(sec => intersectionObserver.observe(sec));

                // Set initial
                if (qSections.length) setCurrent(qSections[0].id);
            }

            /* ---------- KaTeX rendering ---------- */
            function renderKatexAll() {
                // Render inline and block elements with data-tex
                // If KaTeX unavailable, keep placeholder text (graceful fallback).
                const hasKatex = window.katex && typeof window.katex.render === 'function';
                const nodes = elPaper.querySelectorAll('[data-tex]');
                nodes.forEach(node => {
                    const tex = node.getAttribute('data-tex');
                    if (!tex) return;

                    // Prevent double render
                    if (node.getAttribute('data-rendered') === 'true') return;

                    if (!hasKatex) {
                        node.setAttribute('data-rendered', 'true');
                        return;
                    }
                    try {
                        const displayMode = node.classList.contains('math-block');
                        node.textContent = ""; // clear placeholder
                        window.katex.render(tex, node, {
                            displayMode,
                            throwOnError: false,
                            strict: "ignore",
                            trust: false
                        });
                        node.setAttribute('data-rendered', 'true');
                    } catch (err) {
                        // fall back to text
                        node.textContent = `[KaTeX] ${tex}`;
                        node.setAttribute('data-rendered', 'true');
                    }
                });
            }

            /* ---------- Drawer interaction (mobile) ---------- */
            function openDrawer() {
                if (!isSmallScreen()) return; // only needed on small screens
                lastFocusedBeforeDrawer = document.activeElement;
                elDrawer.hidden = false;
                document.body.style.overflow = 'hidden';

                // Focus close button by default
                const closeBtn = elDrawer.querySelector('[data-close]');
                if (closeBtn) closeBtn.focus();

                // Trap focus
                document.addEventListener('keydown', onDrawerKeydown, true);
            }
            function closeDrawer() {
                if (elDrawer.hidden) return;
                elDrawer.hidden = true;
                document.body.style.overflow = '';
                document.removeEventListener('keydown', onDrawerKeydown, true);
                if (lastFocusedBeforeDrawer && typeof lastFocusedBeforeDrawer.focus === 'function') {
                    lastFocusedBeforeDrawer.focus();
                }
            }
            function isSmallScreen() {
                return window.matchMedia && window.matchMedia('(max-width: 860px)').matches;
            }

            function onDrawerKeydown(e) {
                if (e.key === 'Escape') {
                    e.preventDefault();
                    closeDrawer();
                    return;
                }
                if (e.key !== 'Tab') return;

                // Basic focus trap within drawer panel
                const focusables = elDrawer.querySelectorAll('button, a, select, input, [tabindex]:not([tabindex="-1"])');
                const list = Array.from(focusables).filter(el => !el.disabled && el.offsetParent !== null);
                if (!list.length) return;

                const first = list[0];
                const last = list[list.length - 1];
                if (e.shiftKey && document.activeElement === first) {
                    e.preventDefault();
                    last.focus();
                } else if (!e.shiftKey && document.activeElement === last) {
                    e.preventDefault();
                    first.focus();
                }
            }

            elNavToggle.addEventListener('click', () => {
                if (isSmallScreen()) {
                    openDrawer();
                } else {
                    // On desktop, "Jump to" scrolls navigation into view without changing states
                    const rail = document.querySelector('nav.rail');
                    if (rail) rail.scrollIntoView({ behavior: prefersReducedMotion() ? 'auto' : 'smooth', block: 'start' });
                }
            });

            elDrawer.addEventListener('click', (e) => {
                const t = e.target;
                if (t && t.matches && t.matches('[data-close], .drawerScrim')) {
                    closeDrawer();
                }
            });

            window.addEventListener('resize', () => {
                // If transitioning to desktop while drawer open, close it
                if (!isSmallScreen()) closeDrawer();
            });

            /* ---------- Dataset build + mount ---------- */
            const datasets = buildDatasets();
            populateSelector(datasets);

            // Default selection: Standard paper
            elPaperSelect.value = 'standard';
            renderPaper(datasets, elPaperSelect.value);

            elPaperSelect.addEventListener('change', () => {
                renderPaper(datasets, elPaperSelect.value);
            });

            // If KaTeX loads after initial render, re-render math
            window.addEventListener('load', () => {
                // Re-render math safely (only nodes not rendered)
                renderKatexAll();
                if (window.katex && typeof window.katex.render === 'function') {
                    elKatexStatus.textContent = "KaTeX rendering: on";
                } else {
                    elKatexStatus.textContent = "KaTeX rendering: unavailable (showing plain text)";
                }
            });
        })();
    </script>
</body>

</html>