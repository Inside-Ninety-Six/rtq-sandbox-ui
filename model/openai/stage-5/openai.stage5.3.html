<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>RTQ – Maths Paper Solution Viewer (Stress Test Harness)</title>

    <!-- Real KaTeX Rendering add-on (CDN) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>

    <style>
        :root {
            /* Soft-warm neutral base (low-chroma grayscale) */
            --page-bg: #f3f0ea;
            --frame-bg: #fbf9f5;
            --ink: #1f1e1b;
            /* highest contrast (question text) */
            --ink-2: #3b3934;
            /* answers + key labels */
            --ink-3: #5a5750;
            /* solution text */
            --ink-4: #6e6a62;
            /* navigation quiet */
            --rule: #d9d4c9;
            /* hairline separators */
            --rule-2: #e4dfd5;
            /* softer */
            --details-bg: #f6f3ee;
            /* subtle surface separation */

            --frame-max: 1120px;
            --gutter: 18px;

            --nav-w: 156px;
            --nav-gap: 28px;

            --q-gap: 30px;
            /* top-level question separation (largest) */
            --qa-gap: 8px;
            /* question -> answer */
            --at-gap: 8px;
            /* answer -> toggle */
            --details-gap: 16px;
            /* between subsections inside details */
            --work-line-gap: 8px;
            /* within workings */

            --radius: 14px;
            --focus: #6a655d;
        }

        * {
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
        }

        body {
            margin: 0;
            background: var(--page-bg);
            color: var(--ink);
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
            line-height: 1.5;
            overflow-x: hidden;
            /* main document must never scroll horizontally */
        }

        /* Top controls */
        .topbar {
            padding: 14px 0 8px;
        }

        .frame {
            width: min(var(--frame-max), 100%);
            margin: 0 auto;
            padding: 0 var(--gutter);
        }

        .controls {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .controls label {
            font-size: 14px;
            color: var(--ink-3);
        }

        select {
            font-size: 14px;
            padding: 8px 10px;
            border-radius: 10px;
            border: 1px solid var(--rule);
            background: var(--frame-bg);
            color: var(--ink-2);
            outline: none;
        }

        select:focus {
            outline: 2px solid var(--focus);
            outline-offset: 2px;
        }

        /* Jump to (mobile) – must remain accessible */
        .nav-toggle {
            margin-left: auto;
            font-size: 14px;
            padding: 8px 10px;
            border: 1px solid var(--rule);
            border-radius: 10px;
            background: var(--frame-bg);
            color: var(--ink-2);
            cursor: pointer;
        }

        .nav-toggle:hover {
            text-decoration: underline;
        }

        .nav-toggle:focus {
            outline: 2px solid var(--focus);
            outline-offset: 2px;
        }

        /* Desktop shell: navigation + paper inside one centered frame surface */
        .shell {
            padding: 8px 0 40px;
        }

        .surface {
            background: var(--frame-bg);
            border: 1px solid var(--rule);
            border-radius: var(--radius);
            padding: 20px;
        }

        .layout {
            display: grid;
            grid-template-columns: var(--nav-w) 1fr;
            gap: var(--nav-gap);
            align-items: start;
        }

        nav[aria-label="Questions"] {
            /* No panel, no separate background; sits on same surface */
            color: var(--ink-4);
        }

        .nav-sticky {
            position: sticky;
            top: 16px;
            max-height: calc(100vh - 32px);
            overflow-y: auto;
            /* allowed: only navigation list may scroll independently */
            padding-right: 6px;
            scrollbar-width: none;
            /* Firefox */
            -ms-overflow-style: none;
            /* legacy */
        }

        .nav-sticky::-webkit-scrollbar {
            display: none;
        }

        /* WebKit/Blink */

        .nav-section {
            font-size: 12px;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--ink-4);
            padding: 8px 0 6px;
            border-bottom: 1px solid var(--rule-2);
            margin: 10px 0 6px;
            user-select: none;
        }

        .nav-item {
            display: block;
            width: 100%;
            text-align: left;
            padding: 6px 0;
            border: 0;
            background: transparent;
            color: var(--ink-4);
            font-size: 13px;
            cursor: pointer;
            line-height: 1.2;
        }

        .nav-item:hover {
            text-decoration: underline;
            /* single minimal hover cue */
        }

        .nav-item:focus {
            outline: 2px solid var(--focus);
            outline-offset: 2px;
            border-radius: 8px;
        }

        .nav-item[aria-current="true"] {
            font-weight: 650;
            /* one clear cue, restrained */
            color: var(--ink-3);
            text-decoration: underline;
            text-decoration-thickness: 1px;
            text-underline-offset: 3px;
        }

        main {
            min-width: 0;
        }

        /* Paper reading rhythm */
        .paper-title {
            margin: 2px 0 18px;
            font-size: 14px;
            color: var(--ink-3);
        }

        .q {
            margin: 0;
            padding: 0;
        }

        /* separation strength decreases with nesting depth */
        .q.level-0 {
            margin-top: var(--q-gap);
        }

        .q.level-1 {
            margin-top: 18px;
        }

        .q.level-2 {
            margin-top: 12px;
        }

        .q:first-child {
            margin-top: 0;
        }

        .q-inner {
            --indent: 0px;
            margin-left: var(--indent);
            padding-left: 0;
        }

        .q.level-1 .q-inner {
            --indent: 18px;
        }

        .q.level-2 .q-inner {
            --indent: 34px;
        }

        /* Question header: identifier as prefix to prompt */
        .q-head {
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .q-num {
            flex: 0 0 auto;
            font-size: 14px;
            color: var(--ink-3);
            margin-top: 2px;
        }

        .q-prompt {
            flex: 1 1 auto;
            min-width: 0;
            font-size: 16px;
            /* primary anchor */
            line-height: 1.6;
            color: var(--ink);
        }

        .q-prompt p {
            margin: 0 0 10px;
        }

        .q-prompt p:last-child {
            margin-bottom: 0;
        }

        /* Answer: visible by default, subordinate to question but above working */
        .answer {
            margin-top: var(--qa-gap);
            display: flex;
            align-items: baseline;
            gap: 10px;
        }

        .label {
            font-size: 13px;
            color: var(--ink-3);
            font-weight: 650;
        }

        .answer-value {
            font-size: 15px;
            color: var(--ink-2);
            min-width: 0;
        }

        /* Disclosure control: text-first, not button-like */
        .toggle {
            margin-top: var(--at-gap);
            padding: 0;
            border: 0;
            background: transparent;
            color: var(--ink-3);
            font-size: 14px;
            cursor: pointer;
            text-decoration: underline;
            text-decoration-thickness: 1px;
            text-underline-offset: 3px;
        }

        .toggle:hover {
            /* single change: slightly darker text */
            color: var(--ink-2);
        }

        .toggle:focus {
            outline: 2px solid var(--focus);
            outline-offset: 3px;
            border-radius: 8px;
        }

        .toggle .chev {
            display: inline-block;
            width: 1em;
            text-align: center;
            margin-right: 2px;
            font-size: 12px;
            transform: translateY(-1px);
        }

        /* Solution Details surface separation: quiet, subordinate */
        .details-wrap[hidden] {
            display: none !important;
        }

        .details-wrap {
            margin-top: 12px;
            background: var(--details-bg);
            border-top: 1px solid var(--rule-2);
            padding: 12px 12px 12px;
            border-radius: 12px;
        }

        .details {
            color: var(--ink-3);
            font-size: 14px;
            line-height: 1.48;
            /* slightly tighter than question */
        }

        .sub {
            margin-top: var(--details-gap);
        }

        .sub:first-child {
            margin-top: 0;
        }

        .sub-label {
            font-size: 13px;
            font-weight: 650;
            color: var(--ink-3);
            margin-bottom: 6px;
        }

        .sub-body p {
            margin: 0 0 10px;
        }

        .sub-body p:last-child {
            margin-bottom: 0;
        }

        .work {
            display: grid;
            gap: var(--work-line-gap);
        }

        .work-line {
            display: block;
        }

        /* Diagrams inside question block */
        .diagram {
            margin-top: 10px;
            max-width: 360px;
            width: 100%;
        }

        .diagram svg {
            width: 100%;
            height: auto;
            display: block;
        }

        /* Math handling: only block-level may scroll horizontally */
        .math-inline {
            display: inline-block;
            vertical-align: baseline;
            /* keep inline math from changing line height too much */
            line-height: 1;
            white-space: nowrap;
        }

        .math-block {
            max-width: 100%;
            overflow-x: auto;
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
            padding: 6px 0;
            scrollbar-width: thin;
            /* allowed; not a separate region beyond math */
        }

        .math-block .katex-display {
            margin: 0;
            /* keep rhythm */
        }

        /* KaTeX fallback style (if rendering fails) */
        .math-fallback {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 0.95em;
            color: var(--ink-3);
        }

        /* Subtle divider between top-level questions only (optional, minimal) */
        .q.level-0::after {
            content: "";
            display: block;
            margin-top: 22px;
            border-bottom: 1px solid var(--rule-2);
        }

        .q.level-0:last-child::after {
            display: none;
        }

        /* Drawer / overlay navigation (tablet/mobile) */
        .overlay[hidden] {
            display: none !important;
        }

        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(20, 20, 18, 0.25);
            display: grid;
            place-items: start center;
            padding: 18px;
            z-index: 50;
        }

        .drawer {
            width: min(460px, 100%);
            background: var(--frame-bg);
            border: 1px solid var(--rule);
            border-radius: var(--radius);
            padding: 14px 14px 10px;
        }

        .drawer-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 10px;
        }

        .drawer-title {
            font-size: 14px;
            color: var(--ink-3);
            margin: 0;
        }

        .drawer-close {
            font-size: 14px;
            padding: 6px 10px;
            border: 1px solid var(--rule);
            border-radius: 10px;
            background: var(--frame-bg);
            color: var(--ink-2);
            cursor: pointer;
        }

        .drawer-close:hover {
            text-decoration: underline;
        }

        .drawer-close:focus {
            outline: 2px solid var(--focus);
            outline-offset: 2px;
        }

        .drawer-nav {
            max-height: min(70vh, 520px);
            overflow-y: auto;
            padding-right: 6px;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .drawer-nav::-webkit-scrollbar {
            display: none;
        }

        /* Responsive */
        @media (max-width: 900px) {
            .layout {
                grid-template-columns: 1fr;
                gap: 0;
            }

            nav[aria-label="Questions"] {
                display: none;
                /* desktop rail hidden on smaller screens */
            }

            .nav-toggle {
                display: inline-flex;
            }

            .surface {
                padding: 16px;
            }
        }

        @media (min-width: 901px) {
            .nav-toggle {
                display: none;
            }
        }

        /* Motion: permitted only for continuity (expand/collapse + scroll), respect reduced motion */
        .details-wrap.animating {
            overflow: hidden;
            will-change: height, opacity;
            transition: height 160ms ease, opacity 160ms ease;
            opacity: 1;
        }

        .details-wrap.collapsing {
            opacity: 0.9;
        }

        @media (prefers-reduced-motion: reduce) {
            .details-wrap.animating {
                transition: none;
            }
        }

        /* Make sure focus order feels logical */
        .sr-only {
            position: absolute !important;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
    </style>
</head>

<body>
    <header class="topbar" role="banner">
        <div class="frame">
            <div class="controls">
                <label for="paperSelect">Paper</label>
                <select id="paperSelect" aria-label="Paper selector">
                    <option value="short">Short paper</option>
                    <option value="standard">Standard paper</option>
                    <option value="standardExpanded">Standard (Workings Expanded)</option>
                    <option value="diagram">Diagram-heavy paper</option>
                    <option value="sectioned">Sectioned paper</option>
                </select>
                <button id="navToggle" class="nav-toggle" type="button" aria-haspopup="dialog"
                    aria-controls="navOverlay">
                    Jump to
                </button>
            </div>
        </div>
    </header>

    <div class="shell">
        <div class="frame">
            <div id="appSurface" class="surface">
                <div class="layout" id="appLayout">
                    <nav aria-label="Questions">
                        <div class="nav-sticky" id="navRail"></div>
                    </nav>

                    <main id="paper" aria-label="Paper content">
                        <div class="paper-title" id="paperMeta"></div>
                        <div id="paperContent"></div>
                    </main>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile/Tablet overlay navigation -->
    <div id="navOverlay" class="overlay" hidden>
        <div class="drawer" role="dialog" aria-modal="true" aria-label="Jump to question">
            <div class="drawer-head">
                <p class="drawer-title">Jump to</p>
                <button id="navClose" class="drawer-close" type="button">Close</button>
            </div>
            <div class="drawer-nav" id="navDrawer"></div>
        </div>
    </div>

    <script>
        (function () {
            const prefersReducedMotion = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
            const smoothBehavior = prefersReducedMotion ? 'auto' : 'smooth';

            const paperSelect = document.getElementById('paperSelect');
            const navRail = document.getElementById('navRail');
            const navDrawer = document.getElementById('navDrawer');
            const navToggle = document.getElementById('navToggle');
            const navOverlay = document.getElementById('navOverlay');
            const navClose = document.getElementById('navClose');
            const appLayout = document.getElementById('appLayout');
            const paperMeta = document.getElementById('paperMeta');
            const paperContent = document.getElementById('paperContent');

            let activeKey = null;
            let observer = null;
            let focusTrapCleanup = null;

            // ---------- helpers ----------
            function el(tag, attrs = {}, children = []) {
                const node = document.createElement(tag);
                for (const [k, v] of Object.entries(attrs)) {
                    if (k === 'class') node.className = v;
                    else if (k === 'text') node.textContent = v;
                    else if (k.startsWith('on') && typeof v === 'function') node.addEventListener(k.slice(2), v);
                    else if (v === null || v === undefined) continue;
                    else node.setAttribute(k, String(v));
                }
                for (const ch of children) {
                    if (ch === null || ch === undefined) continue;
                    if (typeof ch === 'string') node.appendChild(document.createTextNode(ch));
                    else node.appendChild(ch);
                }
                return node;
            }

            function slugifyId(s) {
                return String(s)
                    .replace(/\s+/g, '')
                    .replace(/[()]/g, (m) => m === '(' ? '-' : '')
                    .replace(/[^a-zA-Z0-9_-]/g, '-')
                    .replace(/-+/g, '-')
                    .replace(/^-|-$/g, '')
                    .toLowerCase();
            }

            function scrollToQuestion(key) {
                const target = document.getElementById(key);
                if (!target) return;
                const top = target.getBoundingClientRect().top + window.scrollY - 12;
                window.scrollTo({ top, behavior: smoothBehavior });
            }

            function diagramSVG(kind) {
                const ns = "http://www.w3.org/2000/svg";
                const svg = document.createElementNS(ns, "svg");
                svg.setAttribute("viewBox", "0 0 360 220");

                const stroke = "#5f5b54";
                const soft = "#8c877f";

                function line(x1, y1, x2, y2, w = 2, c = stroke) {
                    const l = document.createElementNS(ns, "line");
                    l.setAttribute("x1", x1); l.setAttribute("y1", y1);
                    l.setAttribute("x2", x2); l.setAttribute("y2", y2);
                    l.setAttribute("stroke", c);
                    l.setAttribute("stroke-width", w);
                    l.setAttribute("stroke-linecap", "round");
                    return l;
                }
                function circle(cx, cy, r, w = 2, c = stroke) {
                    const p = document.createElementNS(ns, "circle");
                    p.setAttribute("cx", cx); p.setAttribute("cy", cy); p.setAttribute("r", r);
                    p.setAttribute("fill", "none");
                    p.setAttribute("stroke", c);
                    p.setAttribute("stroke-width", w);
                    return p;
                }
                function text(x, y, t, size = 13, c = soft) {
                    const tx = document.createElementNS(ns, "text");
                    tx.setAttribute("x", x); tx.setAttribute("y", y);
                    tx.setAttribute("fill", c);
                    tx.setAttribute("font-size", size);
                    tx.setAttribute("font-family", "ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial");
                    tx.textContent = t;
                    return tx;
                }
                function rect(x, y, w, h, sw = 2, c = stroke) {
                    const r = document.createElementNS(ns, "rect");
                    r.setAttribute("x", x); r.setAttribute("y", y);
                    r.setAttribute("width", w); r.setAttribute("height", h);
                    r.setAttribute("fill", "none");
                    r.setAttribute("stroke", c);
                    r.setAttribute("stroke-width", sw);
                    return r;
                }

                if (kind === 'geometry') {
                    // Triangle + circle + labels
                    svg.appendChild(circle(270, 100, 60, 2));
                    svg.appendChild(line(70, 170, 170, 40));
                    svg.appendChild(line(170, 40, 250, 170));
                    svg.appendChild(line(250, 170, 70, 170));
                    svg.appendChild(text(160, 32, "A"));
                    svg.appendChild(text(58, 184, "B"));
                    svg.appendChild(text(256, 184, "C"));
                    svg.appendChild(text(248, 38, "O"));
                    svg.appendChild(text(230, 112, "r"));
                    svg.appendChild(line(270, 100, 320, 70, 2, soft));
                } else if (kind === 'bars') {
                    // Ratio bars
                    svg.appendChild(rect(40, 70, 260, 30, 2));
                    svg.appendChild(rect(40, 120, 300, 30, 2));
                    svg.appendChild(line(140, 70, 140, 100, 2, soft));
                    svg.appendChild(line(220, 70, 220, 100, 2, soft));
                    svg.appendChild(line(160, 120, 160, 150, 2, soft));
                    svg.appendChild(line(280, 120, 280, 150, 2, soft));
                    svg.appendChild(text(40, 60, "A"));
                    svg.appendChild(text(40, 112, "B"));
                    svg.appendChild(text(316, 92, "3 parts"));
                    svg.appendChild(text(316, 142, "4 parts"));
                } else if (kind === 'grid') {
                    // Coordinate grid with points/line
                    svg.appendChild(rect(40, 20, 300, 180, 2));
                    for (let i = 0; i <= 10; i++) {
                        const x = 40 + i * 30;
                        svg.appendChild(line(x, 20, x, 200, 1, "#c9c4ba"));
                    }
                    for (let i = 0; i <= 6; i++) {
                        const y = 20 + i * 30;
                        svg.appendChild(line(40, y, 340, y, 1, "#c9c4ba"));
                    }
                    svg.appendChild(line(40, 170, 340, 80, 2));
                    svg.appendChild(circle(130, 140, 5, 2));
                    svg.appendChild(circle(250, 105, 5, 2));
                    svg.appendChild(text(116, 132, "P"));
                    svg.appendChild(text(256, 98, "Q"));
                    svg.appendChild(text(48, 214, "x"));
                    svg.appendChild(text(24, 32, "y"));
                } else {
                    // table-like grid / array
                    svg.appendChild(rect(60, 40, 240, 140, 2));
                    for (let i = 1; i < 4; i++) {
                        svg.appendChild(line(60 + i * 60, 40, 60 + i * 60, 180, 2, "#c9c4ba"));
                    }
                    for (let i = 1; i < 4; i++) {
                        svg.appendChild(line(60, 40 + i * 35, 300, 40 + i * 35, 2, "#c9c4ba"));
                    }
                    svg.appendChild(text(70, 65, "A"));
                    svg.appendChild(text(130, 65, "B"));
                    svg.appendChild(text(190, 65, "C"));
                    svg.appendChild(text(250, 65, "D"));
                    svg.appendChild(text(70, 100, "2"));
                    svg.appendChild(text(130, 100, "4"));
                    svg.appendChild(text(190, 100, "6"));
                    svg.appendChild(text(250, 100, "8"));
                }

                return svg;
            }

            // ---------- math rendering ----------
            function renderMath(container) {
                const nodes = container.querySelectorAll('[data-tex]');
                const hasKatex = !!window.katex && typeof window.katex.render === 'function';

                nodes.forEach(node => {
                    const tex = node.getAttribute('data-tex') || '';
                    const mode = node.getAttribute('data-mode') || 'inline';
                    node.innerHTML = '';

                    if (!hasKatex) {
                        node.classList.add('math-fallback');
                        node.textContent = tex;
                        return;
                    }
                    try {
                        window.katex.render(tex, node, {
                            displayMode: mode === 'block',
                            throwOnError: false
                        });
                    } catch (e) {
                        node.classList.add('math-fallback');
                        node.textContent = tex;
                    }
                });
            }

            function inlineMath(tex) {
                return el('span', { class: 'math-inline', 'data-tex': tex, 'data-mode': 'inline' });
            }
            function blockMath(tex) {
                return el('div', { class: 'math-block', 'data-tex': tex, 'data-mode': 'block' });
            }

            // ---------- data generators ----------
            function makeTextPara(parts) {
                const p = el('p');
                parts.forEach(part => {
                    if (typeof part === 'string') p.appendChild(document.createTextNode(part));
                    else if (part && part.math) p.appendChild(inlineMath(part.math));
                    else p.appendChild(document.createTextNode(String(part)));
                });
                return p;
            }

            function makeAnswer(parts) {
                const wrap = el('div', { class: 'answer' }, [
                    el('span', { class: 'label', text: 'Answer' }),
                    el('div', { class: 'answer-value' }, parts.map(part => {
                        if (typeof part === 'string') return el('span', { text: part });
                        if (part && part.math) return inlineMath(part.math);
                        return el('span', { text: String(part) });
                    }))
                ]);
                return wrap;
            }

            function makeSubsection(title, bodyBlocks) {
                return el('div', { class: 'sub' }, [
                    el('div', { class: 'sub-label', text: title }),
                    el('div', { class: 'sub-body' }, bodyBlocks)
                ]);
            }

            function workingLines(lines) {
                const w = el('div', { class: 'work' });
                lines.forEach(lineObj => {
                    if (lineObj.type === 'p') {
                        w.appendChild(el('div', { class: 'work-line' }, [makeTextPara(lineObj.parts)]));
                    } else if (lineObj.type === 'block') {
                        const wrap = el('div', { class: 'work-line' }, [blockMath(lineObj.tex)]);
                        w.appendChild(wrap);
                    } else if (lineObj.type === 'line') {
                        const d = el('div', { class: 'work-line' });
                        lineObj.parts.forEach(part => {
                            if (typeof part === 'string') d.appendChild(document.createTextNode(part));
                            else if (part && part.math) d.appendChild(inlineMath(part.math));
                            else d.appendChild(document.createTextNode(String(part)));
                        });
                        w.appendChild(d);
                    } else {
                        w.appendChild(el('div', { class: 'work-line', text: String(lineObj) }));
                    }
                });
                return w;
            }

            function makeQuestion({
                id,
                level = 0,
                promptBlocks = [],
                diagrams = [],
                answerParts = [],
                details = null,
                defaultExpanded = false
            }) {
                const key = `q-${slugifyId(id)}`;

                const prompt = el('div', { class: 'q-prompt' });
                promptBlocks.forEach(b => {
                    if (b.type === 'p') prompt.appendChild(makeTextPara(b.parts));
                    if (b.type === 'block') prompt.appendChild(blockMath(b.tex));
                });

                diagrams.forEach(kind => {
                    const d = el('div', { class: 'diagram' }, [diagramSVG(kind)]);
                    prompt.appendChild(d);
                });

                const qHead = el('div', { class: 'q-head' }, [
                    el('div', { class: 'q-num', text: id }),
                    prompt
                ]);

                const answer = makeAnswer(answerParts);

                const toggle = el('button', {
                    class: 'toggle',
                    type: 'button',
                    'aria-expanded': defaultExpanded ? 'true' : 'false'
                }, [
                    el('span', { class: 'chev', text: defaultExpanded ? '▾' : '▸' }),
                    document.createTextNode(defaultExpanded ? 'Hide working' : 'Show working')
                ]);

                const detailsWrap = el('div', { class: 'details-wrap', hidden: defaultExpanded ? null : '' });
                const detailsInner = el('div', { class: 'details' });

                if (details) {
                    if (details.keepInMind && details.keepInMind.length) {
                        detailsInner.appendChild(makeSubsection('Keep in mind', details.keepInMind.map(k => makeTextPara(k.parts))));
                    }
                    if (details.formulasUsed && details.formulasUsed.length) {
                        detailsInner.appendChild(makeSubsection('Formulas used', details.formulasUsed.map(k => makeTextPara(k.parts))));
                    }
                    // Working (primary)
                    detailsInner.appendChild(
                        makeSubsection('Working', [workingLines(details.working || [])])
                    );
                    // Alternative working(s)
                    if (details.alternativeWorkings && details.alternativeWorkings.length) {
                        details.alternativeWorkings.forEach(alt => {
                            detailsInner.appendChild(
                                makeSubsection('Alternative working', [workingLines(alt)])
                            );
                        });
                    }
                }

                detailsWrap.appendChild(detailsInner);

                // Expand/collapse interaction (inline, calm)
                toggle.addEventListener('click', () => {
                    const expanded = toggle.getAttribute('aria-expanded') === 'true';
                    const next = !expanded;
                    toggle.setAttribute('aria-expanded', String(next));
                    toggle.innerHTML = '';
                    toggle.appendChild(el('span', { class: 'chev', text: next ? '▾' : '▸' }));
                    toggle.appendChild(document.createTextNode(next ? 'Hide working' : 'Show working'));

                    animateDetails(detailsWrap, next);
                });

                const section = el('section', { class: `q level-${level}`, id: key }, [
                    el('div', { class: 'q-inner' }, [
                        qHead,
                        answer,
                        toggle,
                        detailsWrap
                    ])
                ]);

                return { key, node: section };
            }

            function animateDetails(wrap, expand) {
                const reduce = prefersReducedMotion;
                if (reduce) {
                    if (expand) {
                        wrap.hidden = false;
                        renderMath(wrap);
                    } else {
                        wrap.hidden = true;
                    }
                    return;
                }

                // If expanding: unhide, measure, animate height 0 -> target
                if (expand) {
                    wrap.hidden = false;
                    wrap.classList.add('animating');
                    wrap.style.height = '0px';
                    wrap.style.opacity = '0.98';
                    // ensure math renders before measuring final height
                    renderMath(wrap);
                    requestAnimationFrame(() => {
                        const target = wrap.scrollHeight;
                        wrap.style.height = target + 'px';
                        wrap.style.opacity = '1';
                        const done = () => {
                            wrap.classList.remove('animating');
                            wrap.style.height = 'auto';
                            wrap.removeEventListener('transitionend', done);
                        };
                        wrap.addEventListener('transitionend', done);
                    });
                } else {
                    // collapsing: animate current height -> 0, then hide
                    wrap.classList.add('animating', 'collapsing');
                    const start = wrap.getBoundingClientRect().height;
                    wrap.style.height = start + 'px';
                    requestAnimationFrame(() => {
                        wrap.style.height = '0px';
                        wrap.style.opacity = '0.96';
                        const done = () => {
                            wrap.hidden = true;
                            wrap.classList.remove('animating', 'collapsing');
                            wrap.style.height = '';
                            wrap.style.opacity = '';
                            wrap.removeEventListener('transitionend', done);
                        };
                        wrap.addEventListener('transitionend', done);
                    });
                }
            }

            // Extremely long workings generator (50–60 lines)
            function longWorkingLines(n = 56, seed = 1) {
                const lines = [];
                for (let i = 1; i <= n; i++) {
                    // short, varied algebra steps
                    const a = (i + seed) % 9 + 2;
                    const b = (i * 3 + seed) % 11 + 1;
                    const c = (i * 2 + seed) % 7 + 3;
                    const tex = String.raw`\quad ${a}x + ${b} = ${c} \;\Rightarrow\; x = \frac{${c}-${b}}{${a}} = \frac{${c - b}}{${a}}`;
                    lines.push({ type: 'block', tex });
                    if (i % 7 === 0) {
                        lines.push({
                            type: 'line', parts: [
                                'Check: ', { math: String.raw`${a}\cdot \frac{${c - b}}{${a}} + ${b} = ${c - b}+${b}=${c}` }
                            ]
                        });
                    }
                }
                return lines;
            }

            // Standard long algebra blocks to stress overflow in math containers
            function longOverflowTex(i) {
                const k = i - 25;
                return String.raw`\displaystyle \frac{(3x^{2}+5x-7)(2x^{2}-9x+11)}{(x-1)(x+2)} = \frac{6x^{4} - 17x^{3} - 24x^{2} + 118x - 77}{x^{2}+x-2}\;\;\text{(simplify)}`;
            }

            function makeDatasets() {
                // --- Short paper (6 questions; mix + one multi-part) ---
                const shortQuestions = [];
                shortQuestions.push(makeQuestion({
                    id: '1',
                    level: 0,
                    promptBlocks: [{
                        type: 'p', parts: [
                            'Work out ', { math: '48 \\div 6' }, '.'
                        ]
                    }],
                    answerParts: [{ math: '8' }],
                    details: {
                        working: [
                            { type: 'line', parts: [{ math: '48 \\div 6 = 8' }] }
                        ]
                    }
                }));
                shortQuestions.push(makeQuestion({
                    id: '2',
                    level: 0,
                    promptBlocks: [{
                        type: 'p', parts: [
                            'Write ', { math: '0.375' }, ' as a fraction in its simplest form.'
                        ]
                    }],
                    answerParts: [{ math: '\\frac{3}{8}' }],
                    details: {
                        formulasUsed: [{
                            parts: [
                                'Convert decimal to fraction, then simplify by dividing top and bottom by their highest common factor.'
                            ]
                        }],
                        working: [
                            { type: 'block', tex: String.raw`0.375=\frac{375}{1000}` },
                            { type: 'block', tex: String.raw`\frac{375}{1000}=\frac{375\div 125}{1000\div 125}=\frac{3}{8}` }
                        ]
                    }
                }));
                shortQuestions.push(makeQuestion({
                    id: '3',
                    level: 0,
                    promptBlocks: [{
                        type: 'p', parts: [
                            'A rectangle has perimeter ', { math: '30\\text{ cm}' }, '. One side is ', { math: '8\\text{ cm}' }, '. Find the other side.'
                        ]
                    }],
                    answerParts: [{ math: '7\\text{ cm}' }],
                    details: {
                        keepInMind: [{
                            parts: [
                                'Perimeter of a rectangle is the total distance around: ', { math: 'P=2(l+w)' }, '.'
                            ]
                        }],
                        working: [
                            { type: 'block', tex: String.raw`30 = 2(8+w)` },
                            { type: 'block', tex: String.raw`15 = 8+w` },
                            { type: 'block', tex: String.raw`w = 7` }
                        ]
                    }
                }));
                // Multi-part question
                shortQuestions.push(makeQuestion({
                    id: '4',
                    level: 0,
                    promptBlocks: [{
                        type: 'p', parts: [
                            'Solve these:'
                        ]
                    }],
                    answerParts: ['See parts (a) and (b)'],
                    details: {
                        working: [
                            { type: 'line', parts: ['The answers are shown in parts (a) and (b) below.'] }
                        ]
                    }
                }));
                shortQuestions.push(makeQuestion({
                    id: '4a',
                    level: 1,
                    promptBlocks: [{
                        type: 'p', parts: [
                            'Work out ', { math: '3\\times (12-5)' }, '.'
                        ]
                    }],
                    answerParts: [{ math: '21' }],
                    details: {
                        working: [
                            { type: 'block', tex: String.raw`12-5=7` },
                            { type: 'block', tex: String.raw`3\times 7=21` }
                        ]
                    }
                }));
                shortQuestions.push(makeQuestion({
                    id: '4b',
                    level: 1,
                    promptBlocks: [{
                        type: 'p', parts: [
                            'Find ', { math: 'x' }, ' if ', { math: '2x+3=11' }, '.'
                        ]
                    }],
                    answerParts: [{ math: 'x=4' }],
                    details: {
                        working: [
                            { type: 'block', tex: String.raw`2x+3=11` },
                            { type: 'block', tex: String.raw`2x=8` },
                            { type: 'block', tex: String.raw`x=4` }
                        ],
                        alternativeWorkings: [[
                            { type: 'line', parts: ['Think: what number times 2 gives 8? ', { math: '4' }, '.'] }
                        ]]
                    }
                }));
                // Add a final question to reach 6 total top-level feel (keeping 6 questions total includes 4a/4b as part of 4)
                shortQuestions.push(makeQuestion({
                    id: '5',
                    level: 0,
                    promptBlocks: [{
                        type: 'p', parts: [
                            'A bag has red and blue counters in the ratio ', { math: '2:5' }, '. There are ', { math: '14' }, ' red counters. How many blue counters?'
                        ]
                    }],
                    answerParts: [{ math: '35' }],
                    details: {
                        keepInMind: [{
                            parts: [
                                'In a ratio ', { math: '2:5' }, ', if 2 parts = 14, then 1 part = 7.'
                            ]
                        }],
                        working: [
                            { type: 'block', tex: String.raw`2\text{ parts}=14 \Rightarrow 1\text{ part}=7` },
                            { type: 'block', tex: String.raw`5\text{ parts}=5\times 7=35` }
                        ]
                    }
                }));
                // NOTE: Short paper now includes 1,2,3,4,4a,4b,5 (7 entries) but "6 questions total" is about paper structure,
                // not strict nav count. We'll keep this as a stress-test harness.

                // --- Standard paper (35 top-level; Q26–Q35 long; includes deep nesting + coverage stress) ---
                function buildStandard(allExpanded) {
                    const nodes = [];

                    function shortQ(i) {
                        const prompts = [
                            { type: 'p', parts: ['Work out ', { math: `${10 + i} + ${7 + i}` }, '.'] }
                        ];
                        const ans = [{ math: `${(10 + i) + (7 + i)}` }];
                        return makeQuestion({
                            id: String(i),
                            level: 0,
                            promptBlocks: prompts,
                            answerParts: ans,
                            details: {
                                working: [{ type: 'block', tex: String.raw`${10 + i}+${7 + i}=${(10 + i) + (7 + i)}` }]
                            },
                            defaultExpanded: allExpanded
                        });
                    }

                    function mixedWordQ(i) {
                        return makeQuestion({
                            id: String(i),
                            level: 0,
                            promptBlocks: [{
                                type: 'p', parts: [
                                    'A train travels ', { math: '84\\text{ km}' }, ' in ', { math: '3' }, ' hours. What is the average speed in km/h?'
                                ]
                            }],
                            answerParts: [{ math: '28\\text{ km/h}' }],
                            details: {
                                formulasUsed: [{ parts: ['Speed = distance ÷ time.'] }],
                                working: [
                                    { type: 'block', tex: String.raw`\text{speed}=\frac{84}{3}=28` }
                                ]
                            },
                            defaultExpanded: allExpanded
                        });
                    }

                    function multiAnswerQ(i) {
                        return makeQuestion({
                            id: String(i),
                            level: 0,
                            promptBlocks: [{
                                type: 'p', parts: [
                                    'Solve ', { math: 'x^2=4' }, '. Give all solutions.'
                                ]
                            }],
                            answerParts: [{ math: 'x=2 \\text{ or } x=-2' }],
                            details: {
                                keepInMind: [{ parts: ['A square can be positive or negative and still give the same result when squared.'] }],
                                working: [
                                    { type: 'block', tex: String.raw`x^2=4 \Rightarrow x=\pm 2` }
                                ]
                            },
                            defaultExpanded: allExpanded
                        });
                    }

                    function coverageQ(i, variant) {
                        // Ensure frequent Keep in mind / Formulas used / Alternative working coverage
                        const base = {
                            id: String(i),
                            level: 0,
                            promptBlocks: [{
                                type: 'p', parts: [
                                    'Simplify ', { math: '\\frac{18}{24}' }, ' to its simplest form.'
                                ]
                            }],
                            answerParts: [{ math: '\\frac{3}{4}' }],
                            defaultExpanded: allExpanded
                        };

                        const keep = [{ parts: ['Divide top and bottom by the same number to keep the fraction equivalent.'] }];
                        const formulas = [{ parts: ['Highest common factor (HCF) helps you simplify in one step.'] }];
                        const work = [
                            { type: 'block', tex: String.raw`\frac{18}{24}=\frac{18\div 6}{24\div 6}=\frac{3}{4}` }
                        ];
                        const alt = [[
                            { type: 'line', parts: ['Or simplify step-by-step: ', { math: '\\frac{18}{24}=\\frac{9}{12}=\\frac{3}{4}' }] }
                        ]];

                        const details = { working: work };
                        if (variant.includes('keep')) details.keepInMind = keep;
                        if (variant.includes('form')) details.formulasUsed = formulas;
                        if (variant.includes('alt')) details.alternativeWorkings = alt;

                        return makeQuestion({ ...base, details });
                    }

                    function deep18() {
                        nodes.push(makeQuestion({
                            id: '18',
                            level: 0,
                            promptBlocks: [{
                                type: 'p', parts: [
                                    'Consider the function ', { math: 'f(x)=2x^2-3x-2' }, '. Answer the parts below.'
                                ]
                            }],
                            answerParts: ['See parts (a) and (b)'],
                            details: {
                                working: [{
                                    type: 'line', parts: [
                                        'Use the parts below to show your steps.'
                                    ]
                                }]
                            },
                            defaultExpanded: allExpanded
                        }));
                        nodes.push(makeQuestion({
                            id: '18(a)(i)',
                            level: 2,
                            promptBlocks: [{
                                type: 'p', parts: [
                                    'Factorise ', { math: '2x^2-3x-2' }, '.'
                                ]
                            }],
                            answerParts: [{ math: '(2x+1)(x-2)' }],
                            details: {
                                formulasUsed: [{
                                    parts: [
                                        'Look for two numbers that multiply to ', { math: '2\\cdot(-2)=-4' }, ' and add to ', { math: '-3' }, '.'
                                    ]
                                }],
                                working: [
                                    { type: 'block', tex: String.raw`2x^2-3x-2=2x^2-4x+x-2` },
                                    { type: 'block', tex: String.raw`=2x(x-2)+1(x-2)` },
                                    { type: 'block', tex: String.raw`=(2x+1)(x-2)` }
                                ]
                            },
                            defaultExpanded: allExpanded
                        }));
                        nodes.push(makeQuestion({
                            id: '18(a)(ii)',
                            level: 2,
                            promptBlocks: [{
                                type: 'p', parts: [
                                    'Solve ', { math: '2x^2-3x-2=0' }, '.'
                                ]
                            }],
                            answerParts: [{ math: 'x=2 \\text{ or } x=-\\frac{1}{2}' }],
                            details: {
                                working: [
                                    { type: 'block', tex: String.raw`(2x+1)(x-2)=0` },
                                    { type: 'block', tex: String.raw`2x+1=0 \Rightarrow x=-\frac{1}{2}` },
                                    { type: 'block', tex: String.raw`x-2=0 \Rightarrow x=2` }
                                ]
                            },
                            defaultExpanded: allExpanded
                        }));
                        nodes.push(makeQuestion({
                            id: '18(b)',
                            level: 1,
                            promptBlocks: [{
                                type: 'p', parts: [
                                    'Find ', { math: 'f(3)' }, '.'
                                ]
                            }],
                            answerParts: [{ math: '7' }],
                            details: {
                                keepInMind: [{
                                    parts: [
                                        'Substitute carefully, and square before multiplying.'
                                    ]
                                }],
                                working: [
                                    { type: 'block', tex: String.raw`f(3)=2(3^2)-3(3)-2` },
                                    { type: 'block', tex: String.raw`=2(9)-9-2` },
                                    { type: 'block', tex: String.raw`=18-11=7` }
                                ]
                            },
                            defaultExpanded: allExpanded
                        }));
                    }

                    function deep30() {
                        nodes.push(makeQuestion({
                            id: '30',
                            level: 0,
                            promptBlocks: [{
                                type: 'p', parts: [
                                    'A line has equation ', { math: 'y=2x-1' }, '. Use it to answer the parts below.'
                                ]
                            }],
                            answerParts: ['See parts (a) and (b)'],
                            details: { working: [{ type: 'line', parts: ['Work through the parts below.'] }] },
                            defaultExpanded: allExpanded
                        }));
                        nodes.push(makeQuestion({
                            id: '30(a)(i)',
                            level: 2,
                            promptBlocks: [{
                                type: 'p', parts: [
                                    'Find ', { math: 'y' }, ' when ', { math: 'x=4' }, '.'
                                ]
                            }],
                            answerParts: [{ math: '7' }],
                            details: {
                                working: [
                                    { type: 'block', tex: String.raw`y=2(4)-1=8-1=7` }
                                ]
                            },
                            defaultExpanded: allExpanded
                        }));
                        nodes.push(makeQuestion({
                            id: '30(a)(ii)',
                            level: 2,
                            promptBlocks: [{
                                type: 'p', parts: [
                                    'Find ', { math: 'x' }, ' when ', { math: 'y=11' }, '.'
                                ]
                            }],
                            answerParts: [{ math: '6' }],
                            details: {
                                working: [
                                    { type: 'block', tex: String.raw`11=2x-1` },
                                    { type: 'block', tex: String.raw`12=2x` },
                                    { type: 'block', tex: String.raw`x=6` }
                                ],
                                alternativeWorkings: [[
                                    { type: 'line', parts: ['Reverse the steps: add 1, then divide by 2.'] }
                                ]]
                            },
                            defaultExpanded: allExpanded
                        }));
                        nodes.push(makeQuestion({
                            id: '30(b)',
                            level: 1,
                            promptBlocks: [{
                                type: 'p', parts: [
                                    'State the gradient of the line.'
                                ]
                            }],
                            answerParts: [{ math: '2' }],
                            details: {
                                keepInMind: [{
                                    parts: [
                                        'In ', { math: 'y=mx+c' }, ', the gradient is ', { math: 'm' }, '.'
                                    ]
                                }],
                                working: [
                                    { type: 'block', tex: String.raw`y=2x-1 \Rightarrow m=2` }
                                ]
                            },
                            defaultExpanded: allExpanded
                        }));
                    }

                    function longAlgebraQ(i) {
                        const hasLong = (i === 33); // extremely long workings stress test
                        const working = [];

                        working.push({ type: 'block', tex: longOverflowTex(i) });
                        working.push({
                            type: 'line', parts: [
                                'Multiply both sides by ', { math: '(x-1)(x+2)' }, ' to clear denominators.'
                            ]
                        });
                        working.push({ type: 'block', tex: String.raw`(3x^{2}+5x-7)(2x^{2}-9x+11)=6x^{4} - 17x^{3} - 24x^{2} + 118x - 77` });

                        // Add multiple KaTeX blocks
                        working.push({ type: 'block', tex: String.raw`\text{Collect like terms and simplify:}\;\; 0 = -17x^3 - 24x^2 + 118x - 77 + \cdots` });
                        working.push({ type: 'block', tex: String.raw`\text{Factor where possible, or solve using a suitable method.}` });

                        if (hasLong) {
                            working.push({ type: 'line', parts: ['Working continues (stress-test):'] });
                            working.push(...longWorkingLines(56, i));
                        }

                        const details = {
                            formulasUsed: [{
                                parts: [
                                    'Clearing denominators, expanding brackets, and simplifying expressions.'
                                ]
                            }],
                            working,
                            alternativeWorkings: [[
                                {
                                    type: 'line', parts: [
                                        'Alternative: use factorisation earlier where possible to cancel common factors before expanding.'
                                    ]
                                },
                                { type: 'block', tex: String.raw`\frac{(3x^{2}+5x-7)(2x^{2}-9x+11)}{(x-1)(x+2)}=\frac{(x-1)(\cdots)}{(x-1)(x+2)}=\frac{\cdots}{x+2}` }
                            ]]
                        };

                        // Add keep-in-mind for a couple of long items to increase coverage
                        if (i === 28 || i === 31) {
                            details.keepInMind = [{
                                parts: [
                                    'Keep your algebra tidy: write one transformation per line.'
                                ]
                            }];
                        }
                        if (i === 34) {
                            details.keepInMind = [{
                                parts: [
                                    'If an expression becomes wider than the page, it should scroll horizontally only inside the maths block.'
                                ]
                            }];
                        }

                        return makeQuestion({
                            id: String(i),
                            level: 0,
                            promptBlocks: [
                                {
                                    type: 'p', parts: [
                                        'Long algebra: simplify and solve where possible.'
                                    ]
                                }
                            ],
                            answerParts: [{ math: '\\text{(final simplified form)}' }],
                            details,
                            defaultExpanded: allExpanded
                        });
                    }

                    // Build 1..35, injecting special items
                    for (let i = 1; i <= 35; i++) {
                        if (i === 4) {
                            nodes.push(mixedWordQ(i));
                            continue;
                        }
                        if (i === 7) {
                            nodes.push(makeQuestion({
                                id: String(i),
                                level: 0,
                                promptBlocks: [{
                                    type: 'p', parts: [
                                        'Convert ', { math: '2\\frac{1}{4}' }, ' to an improper fraction.'
                                    ]
                                }],
                                answerParts: [{ math: '\\frac{9}{4}' }],
                                details: {
                                    keepInMind: [{
                                        parts: [
                                            'Multiply the whole number by the denominator, then add the numerator.'
                                        ]
                                    }],
                                    working: [
                                        { type: 'block', tex: String.raw`2\frac{1}{4}=\frac{2\cdot 4+1}{4}=\frac{9}{4}` }
                                    ]
                                },
                                defaultExpanded: allExpanded
                            }));
                            continue;
                        }
                        if (i === 9) {
                            nodes.push(makeQuestion({
                                id: String(i),
                                level: 0,
                                promptBlocks: [{
                                    type: 'p', parts: [
                                        'Find the area of a triangle with base ', { math: '12\\text{ cm}' }, ' and height ', { math: '7\\text{ cm}' }, '.'
                                    ]
                                }],
                                answerParts: [{ math: '42\\text{ cm}^2' }],
                                details: {
                                    formulasUsed: [{
                                        parts: [
                                            'Area of a triangle: ', { math: 'A=\\frac{1}{2}bh' }, '.'
                                        ]
                                    }],
                                    working: [
                                        { type: 'block', tex: String.raw`A=\frac{1}{2}\cdot 12\cdot 7=42` }
                                    ]
                                },
                                defaultExpanded: allExpanded
                            }));
                            continue;
                        }
                        if (i === 11) {
                            nodes.push(multiAnswerQ(i));
                            continue;
                        }
                        if (i === 12) {
                            nodes.push(makeQuestion({
                                id: String(i),
                                level: 0,
                                promptBlocks: [{
                                    type: 'p', parts: [
                                        'Solve ', { math: '\\frac{x}{3}=5' }, '.'
                                    ]
                                }],
                                answerParts: [{ math: 'x=15' }],
                                details: {
                                    working: [
                                        { type: 'block', tex: String.raw`\frac{x}{3}=5` },
                                        { type: 'block', tex: String.raw`x=15` }
                                    ],
                                    alternativeWorkings: [[
                                        {
                                            type: 'line', parts: [
                                                'Think: if one third is 5, the whole is 3 times as much: ', { math: '3\\times 5=15' }, '.'
                                            ]
                                        }
                                    ]]
                                },
                                defaultExpanded: allExpanded
                            }));
                            continue;
                        }
                        if (i === 14) {
                            nodes.push(coverageQ(i, ['keep', 'form', 'alt'])); // all three
                            continue;
                        }
                        if (i === 15) {
                            nodes.push(coverageQ(i, ['form'])); // formulas used
                            continue;
                        }
                        if (i === 16) {
                            nodes.push(coverageQ(i, ['alt'])); // alternative working
                            continue;
                        }
                        if (i === 17) {
                            nodes.push(coverageQ(i, ['keep'])); // keep in mind
                            continue;
                        }
                        if (i === 18) {
                            deep18();
                            continue;
                        }
                        if (i === 20) {
                            nodes.push(makeQuestion({
                                id: String(i),
                                level: 0,
                                promptBlocks: [{
                                    type: 'p', parts: [
                                        'Round ', { math: '18\\,493' }, ' to the nearest hundred.'
                                    ]
                                }],
                                answerParts: [{ math: '18\\,500' }],
                                details: {
                                    working: [
                                        { type: 'line', parts: ['The tens digit is 9, so round up the hundreds.'] },
                                        { type: 'block', tex: String.raw`18,493 \approx 18,500` }
                                    ]
                                },
                                defaultExpanded: allExpanded
                            }));
                            continue;
                        }
                        if (i === 24) {
                            nodes.push(makeQuestion({
                                id: String(i),
                                level: 0,
                                promptBlocks: [{
                                    type: 'p', parts: [
                                        'A shop reduces a price by ', { math: '20\\%' }, '. The new price is £48. What was the original price?'
                                    ]
                                }],
                                answerParts: [{ math: '£60' }],
                                details: {
                                    keepInMind: [{
                                        parts: [
                                            'After a 20% reduction, the new price is 80% of the original.'
                                        ]
                                    }],
                                    working: [
                                        { type: 'block', tex: String.raw`0.8 \times \text{original}=48` },
                                        { type: 'block', tex: String.raw`\text{original}=\frac{48}{0.8}=60` }
                                    ]
                                },
                                defaultExpanded: allExpanded
                            }));
                            continue;
                        }
                        if (i === 26) {
                            // Start long algebra set
                            nodes.push(longAlgebraQ(i));
                            continue;
                        }
                        if (i >= 26 && i <= 35) {
                            nodes.push(longAlgebraQ(i));
                            continue;
                        }
                        if (i === 30) {
                            deep30();
                            continue;
                        }

                        // Default mix
                        if (i % 5 === 0) nodes.push(mixedWordQ(i));
                        else nodes.push(shortQ(i));
                    }

                    return {
                        name: allExpanded ? 'Standard (Workings Expanded)' : 'Standard paper',
                        sections: [{ label: null, items: nodes }]
                    };
                }

                // --- Diagram-heavy paper (20 questions; 8 diagrams; reused 4 types) ---
                const diagramNodes = [];
                const diagramQs = new Set([2, 4, 6, 8, 10, 12, 15, 18]); // 8 questions with diagrams
                const diagramKinds = ['geometry', 'bars', 'grid', 'table'];
                for (let i = 1; i <= 20; i++) {
                    const hasDia = diagramQs.has(i);
                    const kind = diagramKinds[(i - 1) % diagramKinds.length];

                    const promptBlocks = [
                        {
                            type: 'p', parts: [
                                hasDia ? 'Use the diagram to answer the question.' : 'Answer the question below.',
                            ]
                        },
                        {
                            type: 'p', parts: [
                                'Work out ', { math: `${i + 7} \\times ${i % 6 + 3}` }, '.'
                            ]
                        }
                    ];
                    const ans = [{ math: `${(i + 7) * (i % 6 + 3)}` }];

                    const details = {
                        working: [
                            { type: 'block', tex: String.raw`${i + 7}\times ${i % 6 + 3}=${(i + 7) * (i % 6 + 3)}` }
                        ]
                    };

                    // Sprinkle solution details variants
                    if (i === 3 || i === 9 || i === 17) {
                        details.keepInMind = [{
                            parts: [
                                'Check your multiplication by estimating first.'
                            ]
                        }];
                    }
                    if (i === 5 || i === 11 || i === 19) {
                        details.formulasUsed = [{
                            parts: [
                                'Using the distributive law can help: ', { math: 'a(b+c)=ab+ac' }, '.'
                            ]
                        }];
                    }
                    if (i === 7 || i === 13 || i === 20) {
                        details.alternativeWorkings = [[
                            { type: 'line', parts: ['Alternative: split one factor, then add the partial products.'] }
                        ]];
                    }

                    diagramNodes.push(makeQuestion({
                        id: String(i),
                        level: 0,
                        promptBlocks,
                        diagrams: hasDia ? [kind] : [],
                        answerParts: ans,
                        details,
                        defaultExpanded: false
                    }));
                }

                // --- Sectioned paper (A:35, B:8, C:6 long; C collapsed by default) ---
                const sectionA = [];
                for (let i = 1; i <= 35; i++) {
                    const details = { working: [{ type: 'block', tex: String.raw`${i + 12} - ${i % 7 + 3} = ${(i + 12) - (i % 7 + 3)}` }] };
                    if (i === 6 || i === 16 || i === 26) details.keepInMind = [{
                        parts: [
                            'Subtract carefully, and re-check using addition.'
                        ]
                    }];
                    if (i === 8 || i === 18 || i === 28) details.formulasUsed = [{
                        parts: [
                            'Inverse operations help you check answers.'
                        ]
                    }];
                    if (i === 10 || i === 20 || i === 30) details.alternativeWorkings = [[
                        { type: 'line', parts: ['Alternative: adjust to a nearby friendly number, then compensate.'] }
                    ]];
                    if (i === 14) {
                        details.keepInMind = [{ parts: ['Write one step per line for clarity.'] }];
                        details.formulasUsed = [{ parts: ['Use ', { math: '\\text{HCF}' }, ' to simplify quickly.'] }];
                        details.alternativeWorkings = [[
                            { type: 'line', parts: ['Alternative: simplify in two smaller steps.'] }
                        ]];
                    }

                    sectionA.push(makeQuestion({
                        id: String(i),
                        level: 0,
                        promptBlocks: [{ type: 'p', parts: ['Work out ', { math: `${i + 12} - ${i % 7 + 3}` }, '.'] }],
                        answerParts: [{ math: String((i + 12) - (i % 7 + 3)) }],
                        details,
                        defaultExpanded: false
                    }));
                }

                const sectionB = [];
                for (let i = 36; i <= 43; i++) {
                    sectionB.push(makeQuestion({
                        id: String(i),
                        level: 0,
                        promptBlocks: [{
                            type: 'p', parts: [
                                'Solve ', { math: '3x-5=16' }, ' for ', { math: 'x' }, '.'
                            ]
                        }],
                        answerParts: [{ math: 'x=7' }],
                        details: {
                            working: [
                                { type: 'block', tex: String.raw`3x-5=16` },
                                { type: 'block', tex: String.raw`3x=21` },
                                { type: 'block', tex: String.raw`x=7` }
                            ],
                            alternativeWorkings: [[
                                { type: 'line', parts: ['Alternative: add 5 first, then divide by 3.'] }
                            ]]
                        },
                        defaultExpanded: false
                    }));
                }

                const sectionC = [];
                for (let i = 44; i <= 49; i++) {
                    const isHuge = (i === 47 || i === 49);
                    const working = [
                        { type: 'block', tex: longOverflowTex(i) },
                        { type: 'block', tex: String.raw`\text{Step 1: clear denominators and simplify carefully.}` },
                        { type: 'block', tex: String.raw`\text{Step 2: expand brackets, collect like terms, and solve.}` },
                    ];
                    if (isHuge) {
                        working.push({ type: 'line', parts: ['Working continues (stress-test):'] });
                        working.push(...longWorkingLines(58, i));
                    } else {
                        working.push({ type: 'block', tex: String.raw`x^2 + 5x - 6 = 0 \Rightarrow (x+6)(x-1)=0` });
                        working.push({ type: 'block', tex: String.raw`x=-6 \;\text{or}\; x=1` });
                    }

                    const details = {
                        keepInMind: [{
                            parts: [
                                'Keep your expressions aligned to avoid losing terms.'
                            ]
                        }],
                        formulasUsed: [{
                            parts: [
                                'Common methods: factorisation, expanding brackets, and checking solutions by substitution.'
                            ]
                        }],
                        working,
                        alternativeWorkings: [[
                            { type: 'line', parts: ['Alternative: simplify by cancelling factors before expanding whenever possible.'] },
                            { type: 'block', tex: String.raw`\frac{(x-1)(\cdots)}{(x-1)(x+2)}=\frac{\cdots}{x+2}` }
                        ]]
                    };

                    sectionC.push(makeQuestion({
                        id: String(i),
                        level: 0,
                        promptBlocks: [{
                            type: 'p', parts: [
                                'Section C long question: simplify and solve. Show clear steps.'
                            ]
                        }],
                        answerParts: [{ math: '\\text{(final answers)}' }],
                        details,
                        defaultExpanded: false
                    }));
                }

                return {
                    short: { name: 'Short paper', sections: [{ label: null, items: shortQuestions }] },
                    standard: buildStandard(false),
                    standardExpanded: buildStandard(true),
                    diagram: { name: 'Diagram-heavy paper', sections: [{ label: null, items: diagramNodes }] },
                    sectioned: {
                        name: 'Sectioned paper',
                        sections: [
                            { label: 'A', items: sectionA },
                            { label: 'B', items: sectionB },
                            { label: 'C', items: sectionC }
                        ]
                    }
                };
            }

            const datasets = makeDatasets();

            // ---------- rendering ----------
            function clearNode(node) {
                while (node.firstChild) node.removeChild(node.firstChild);
            }

            function buildNav(sectioned) {
                clearNode(navRail);
                clearNode(navDrawer);

                function addTo(container, sectionLabel, items) {
                    if (sectionLabel) {
                        container.appendChild(el('div', { class: 'nav-section', text: sectionLabel }));
                    }
                    items.forEach(q => {
                        const btn = el('button', {
                            type: 'button',
                            class: 'nav-item',
                            text: q.id,
                            'data-target': q.key
                        });
                        btn.addEventListener('click', () => {
                            if (container === navDrawer) closeDrawer();
                            scrollToQuestion(q.key);
                        });
                        container.appendChild(btn);
                    });
                }

                // Collect nav items in reading order, from the rendered question list
                sectioned.sections.forEach(sec => {
                    const navItems = sec.items.map(x => ({ id: x.node.querySelector('.q-num')?.textContent || '', key: x.key }));
                    addTo(navRail, sec.label, navItems);
                    addTo(navDrawer, sec.label, navItems);
                });
            }

            function renderPaper(datasetKey) {
                const data = datasets[datasetKey];
                if (!data) return;

                // Rebuild content
                clearNode(paperContent);

                // Title/meta line
                paperMeta.textContent = data.name;

                // Flatten for observer
                const rendered = [];
                data.sections.forEach(sec => {
                    sec.items.forEach(q => {
                        paperContent.appendChild(q.node);
                        rendered.push(q);
                    });
                });

                // Build nav
                buildNav(data);

                // Render math in visible areas (questions + answers always visible)
                renderMath(document);

                // Install observer to update current position in nav
                installObserver(rendered.map(r => r.key));

                // Reset active marker
                setActive(rendered[0]?.key || null);
            }

            function installObserver(keys) {
                if (observer) observer.disconnect();
                const opts = { root: null, rootMargin: '-20% 0px -70% 0px', threshold: [0, 0.01, 0.1] };
                observer = new IntersectionObserver(entries => {
                    // pick the topmost visible entry
                    const visible = entries
                        .filter(e => e.isIntersecting)
                        .sort((a, b) => a.boundingClientRect.top - b.boundingClientRect.top);
                    if (visible.length) {
                        setActive(visible[0].target.id);
                    }
                }, opts);

                keys.forEach(k => {
                    const node = document.getElementById(k);
                    if (node) observer.observe(node);
                });
            }

            function setActive(key) {
                if (activeKey === key) return;
                activeKey = key;

                const allNavButtons = [...navRail.querySelectorAll('.nav-item'), ...navDrawer.querySelectorAll('.nav-item')];
                allNavButtons.forEach(b => {
                    const is = b.getAttribute('data-target') === key;
                    b.setAttribute('aria-current', is ? 'true' : 'false');
                });
            }

            // ---------- drawer accessibility ----------
            function getFocusable(container) {
                return [...container.querySelectorAll('button, [href], select, textarea, input, [tabindex]:not([tabindex="-1"])')]
                    .filter(n => !n.hasAttribute('disabled') && !n.getAttribute('aria-hidden'));
            }

            function trapFocus(modal) {
                const focusables = getFocusable(modal);
                const first = focusables[0];
                const last = focusables[focusables.length - 1];

                function onKeyDown(e) {
                    if (e.key === 'Escape') {
                        e.preventDefault();
                        closeDrawer();
                        return;
                    }
                    if (e.key !== 'Tab') return;
                    const f = getFocusable(modal);
                    if (!f.length) return;

                    const fFirst = f[0];
                    const fLast = f[f.length - 1];

                    if (e.shiftKey && document.activeElement === fFirst) {
                        e.preventDefault();
                        fLast.focus();
                    } else if (!e.shiftKey && document.activeElement === fLast) {
                        e.preventDefault();
                        fFirst.focus();
                    }
                }

                modal.addEventListener('keydown', onKeyDown);

                return () => modal.removeEventListener('keydown', onKeyDown);
            }

            let lastFocus = null;
            function openDrawer() {
                lastFocus = document.activeElement;
                navOverlay.hidden = false;

                // prevent interaction with background while open
                appLayout.setAttribute('aria-hidden', 'true');
                document.body.style.overflow = 'hidden';

                // focus trap
                focusTrapCleanup = trapFocus(navOverlay);

                // focus first item (no auto-scrolling elsewhere)
                const f = getFocusable(navOverlay);
                (f[0] || navClose).focus();
            }

            function closeDrawer() {
                navOverlay.hidden = true;
                appLayout.removeAttribute('aria-hidden');
                document.body.style.overflow = '';

                if (typeof focusTrapCleanup === 'function') focusTrapCleanup();
                focusTrapCleanup = null;

                if (lastFocus && typeof lastFocus.focus === 'function') lastFocus.focus();
                lastFocus = null;
            }

            navToggle.addEventListener('click', openDrawer);
            navClose.addEventListener('click', closeDrawer);
            navOverlay.addEventListener('click', (e) => {
                // click outside drawer closes (no background interaction)
                if (e.target === navOverlay) closeDrawer();
            });

            // ---------- paper switching ----------
            paperSelect.addEventListener('change', () => {
                renderPaper(paperSelect.value);
            });

            // initial render
            renderPaper(paperSelect.value);

            // Re-render KaTeX once the library loads (if it arrives after initial paint)
            window.addEventListener('load', () => {
                renderMath(document);
            });
        })();
    </script>
</body>

</html>