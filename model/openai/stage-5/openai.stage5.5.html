<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>RTQ — Maths Paper Solution Viewer (Stress Harness)</title>

    <!-- Real KaTeX Rendering add-on (graceful fallback if scripts fail) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js" crossorigin="anonymous"></script>

    <style>
        :root {
            /* Stage 5: soft-warm neutral base (subtle) */
            --page-bg: #f1efe9;
            --frame-bg: #f7f6f1;
            --text: #1f1f1f;
            --muted: #5a5853;
            --muted2: #7a776f;
            --hair: rgba(20, 20, 20, .12);
            --hair2: rgba(20, 20, 20, .08);
            --focus: rgba(20, 20, 20, .55);

            --frame-w: 1120px;

            --top-pad: 18px;
            --side-pad: 22px;

            --nav-w: 128px;

            /* rhythm (largest -> smallest) */
            --gap-q: 28px;
            /* between top-level questions */
            --gap-qa: 10px;
            /* between question and answer */
            --gap-at: 8px;
            /* between answer and toggle */
            --gap-sol: 14px;
            /* between subsections in solution */
            --gap-line: 8px;
            /* within workings */

            --fz-q: 16px;
            --fz-id: 13px;
            --fz-a: 14px;
            --fz-sol: 13px;
            --fz-nav: 12px;

            --lh-q: 1.6;
            --lh-sol: 1.45;

            --radius: 10px;

            --indent-1: clamp(12px, 2.8vw, 18px);
            --indent-2: clamp(20px, 4.6vw, 30px);
            --indent-3: clamp(28px, 6.4vw, 42px);

            --sticky-top: 64px;
        }

        * {
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
        }

        body {
            margin: 0;
            background: var(--page-bg);
            color: var(--text);
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
            overflow-x: hidden;
            /* main doc must never scroll horizontally */
        }

        /* Top controls: stable, aligned to frame */
        header {
            position: sticky;
            top: 0;
            z-index: 10;
            background: linear-gradient(to bottom, var(--page-bg), rgba(241, 239, 233, .88));
            backdrop-filter: blur(3px);
            border-bottom: 1px solid var(--hair2);
        }

        .header-inner {
            max-width: var(--frame-w);
            margin: 0 auto;
            padding: 12px var(--side-pad);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .brand {
            display: flex;
            align-items: baseline;
            gap: 10px;
            min-width: 0;
        }

        .brand .title {
            font-size: 13px;
            font-weight: 600;
            letter-spacing: .02em;
            color: rgba(20, 20, 20, .78);
            white-space: nowrap;
        }

        .brand .subtitle {
            font-size: 12px;
            color: var(--muted2);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 42vw;
        }

        .controls {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        label {
            font-size: 12px;
            color: var(--muted2);
            white-space: nowrap;
        }

        select {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            font-size: 13px;
            padding: 8px 10px;
            border-radius: 10px;
            border: 1px solid var(--hair);
            background: var(--frame-bg);
            color: var(--text);
            line-height: 1.2;
        }

        .jump-btn {
            font-size: 13px;
            padding: 8px 10px;
            border-radius: 10px;
            border: 1px solid var(--hair);
            background: transparent;
            color: rgba(20, 20, 20, .84);
            cursor: pointer;
            white-space: nowrap;
        }

        /* quiet interaction feedback: underline OR tone change only */
        .jump-btn:hover {
            text-decoration: underline;
        }

        .jump-btn:active {
            transform: translateY(0);
        }

        /* Focus: custom but restrained (no heavy fills) */
        :focus-visible {
            outline: 2px solid var(--focus);
            outline-offset: 2px;
            border-radius: 8px;
        }

        /* Frame: single surface containing nav + paper */
        .frame {
            max-width: var(--frame-w);
            margin: 0 auto;
            padding: var(--top-pad) var(--side-pad) 40px;
            background: var(--frame-bg);
            border-left: 1px solid var(--hair2);
            border-right: 1px solid var(--hair2);
            min-height: calc(100vh - 60px);
        }

        .layout {
            display: grid;
            grid-template-columns: var(--nav-w) minmax(0, 1fr);
            gap: 22px;
            align-items: start;
        }

        /* Navigation rail: quiet, no panel */
        nav {
            position: relative;
        }

        .nav-sticky {
            position: sticky;
            /* Navigation Persistence add-on */
            top: calc(var(--sticky-top) + 10px);
        }

        .nav-label {
            font-size: 11px;
            color: var(--muted2);
            letter-spacing: .02em;
            margin-bottom: 8px;
            user-select: none;
        }

        .nav-list {
            max-height: calc(100vh - (var(--sticky-top) + 54px));
            overflow: auto;
            /* allowed separate scroll region only for nav if needed */
            padding-right: 6px;

            /* Scrollable Navigation Without Visible Scrollbars add-on */
            scrollbar-width: none;
            /* Firefox */
            -ms-overflow-style: none;
            /* legacy */
        }

        .nav-list::-webkit-scrollbar {
            display: none;
        }

        .nav-list:focus-visible {
            outline: 2px solid var(--focus);
            outline-offset: 2px;
            border-radius: 10px;
        }

        .nav-section {
            font-size: 11px;
            color: rgba(20, 20, 20, .55);
            padding: 10px 0 6px;
            user-select: none;
        }

        .nav-item {
            width: 100%;
            text-align: left;
            display: inline-flex;
            align-items: baseline;
            gap: 8px;
            padding: 6px 0;
            border: 0;
            background: transparent;
            color: rgba(20, 20, 20, .62);
            font-size: var(--fz-nav);
            line-height: 1.2;
            cursor: pointer;
        }

        .nav-item:hover {
            text-decoration: underline;
        }

        /* one minimal change */
        .nav-item[aria-current="true"] {
            color: rgba(20, 20, 20, .82);
            font-weight: 700;
            /* allowed: current nav item only */
            text-decoration: none;
        }

        .nav-item[aria-current="true"]::before {
            content: "•";
            opacity: .6;
            transform: translateY(-.5px);
        }

        .nav-item::before {
            content: "";
            width: 10px;
            display: inline-block;
        }

        /* Paper content */
        main {
            min-width: 0;
        }

        .paper-meta {
            font-size: 12px;
            color: var(--muted2);
            margin: 0 0 12px 0;
            user-select: none;
        }

        .section-header {
            margin: 28px 0 6px;
            padding: 10px 0 0;
            font-size: 12px;
            letter-spacing: .04em;
            color: rgba(20, 20, 20, .55);
        }

        .section-rule {
            border: 0;
            border-top: 1px solid var(--hair2);
            margin: 10px 0 0;
        }

        .question {
            margin: 0;
            padding: 0;
            scroll-margin-top: 92px;
            /* for sticky header */
        }

        .q-block {
            margin-top: var(--gap-q);
            padding-top: 0;
        }

        .q-block:first-child {
            margin-top: 8px;
        }

        .q-line {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 10px;
            align-items: start;
        }

        .qid {
            font-size: var(--fz-id);
            color: rgba(20, 20, 20, .62);
            line-height: var(--lh-q);
            white-space: nowrap;
            user-select: none;
        }

        .qtext {
            font-size: var(--fz-q);
            line-height: var(--lh-q);
            color: rgba(20, 20, 20, .90);
            overflow-wrap: anywhere;
        }

        .answer {
            margin-left: calc(10px + 0px);
            margin-top: var(--gap-qa);
            padding-left: calc(10px + 0px);
        }

        .answer-row {
            display: flex;
            align-items: baseline;
            gap: 10px;
            flex-wrap: wrap;
        }

        .a-label {
            font-size: 12px;
            color: rgba(20, 20, 20, .60);
            font-weight: 600;
            letter-spacing: .02em;
        }

        .a-value {
            font-size: var(--fz-a);
            color: rgba(20, 20, 20, .84);
            line-height: 1.5;
            overflow-wrap: anywhere;
        }

        /* Disclosure control: text-first, not button-like */
        details.solution {
            margin-left: calc(10px + 0px);
            margin-top: var(--gap-at);
            padding-left: calc(10px + 0px);
        }

        details.solution>summary {
            list-style: none;
            cursor: pointer;
            font-size: 12px;
            color: rgba(20, 20, 20, .62);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            user-select: none;
            outline: none;
            text-decoration: none;
        }

        details.solution>summary::-webkit-details-marker {
            display: none;
        }

        details.solution>summary:hover {
            text-decoration: underline;
        }

        /* one minimal change */

        .chev {
            width: 10px;
            height: 10px;
            flex: 0 0 auto;
            opacity: .65;
            transform: rotate(-90deg);
        }

        details.solution[open] .chev {
            transform: rotate(0deg);
        }

        /* Solution Details surface separation: quiet and subordinate */
        .solution-body {
            margin-top: 10px;
            padding: 12px 12px 12px;
            background: rgba(20, 20, 20, .03);
            border-radius: 10px;
        }

        .sol-block {
            margin-top: var(--gap-sol);
        }

        .sol-block:first-child {
            margin-top: 0;
        }

        .sol-label {
            font-size: 12px;
            color: rgba(20, 20, 20, .60);
            font-weight: 600;
            letter-spacing: .02em;
            margin: 0 0 8px 0;
        }

        .sol-text {
            font-size: var(--fz-sol);
            line-height: var(--lh-sol);
            color: rgba(20, 20, 20, .72);
            margin: 0;
            overflow-wrap: anywhere;
        }

        .working-lines {
            display: grid;
            gap: var(--gap-line);
        }

        /* KaTeX containment invariant */
        .math-inline {
            white-space: nowrap;
            font-variant-numeric: lining-nums;
        }

        .math-block {
            max-width: 100%;
            overflow-x: auto;
            /* horizontal scrolling only here when needed */
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
            padding: 6px 8px;
            border-radius: 8px;
            background: rgba(20, 20, 20, .02);
            border: 1px solid rgba(20, 20, 20, .06);
        }

        .math-block .katex-display {
            margin: 0;
        }

        .math-block>.tex {
            display: inline-block;
            width: max-content;
            max-width: none;
        }

        /* Ensure KaTeX never widens page */
        .katex,
        .katex-display,
        .katex-html,
        .katex-mathml {
            max-width: 100%;
        }

        /* Diagrams */
        figure.diagram {
            margin: 10px 0 0;
            padding: 0;
            max-width: 520px;
        }

        figure.diagram svg {
            width: 100%;
            height: auto;
            display: block;
            border-radius: 10px;
            background: rgba(20, 20, 20, .02);
            border: 1px solid rgba(20, 20, 20, .08);
            touch-action: pan-y;
            /* avoid trapping vertical scroll */
        }

        figcaption {
            margin-top: 6px;
            font-size: 11px;
            color: var(--muted2);
        }

        /* Nesting via indentation only */
        .depth-0 {
            padding-left: 0;
        }

        .depth-1 {
            padding-left: var(--indent-1);
        }

        .depth-2 {
            padding-left: var(--indent-2);
        }

        .depth-3 {
            padding-left: var(--indent-3);
        }

        /* Reduce separation strength with nesting depth */
        .depth-1 .q-block {
            margin-top: calc(var(--gap-q) * .70);
        }

        .depth-2 .q-block {
            margin-top: calc(var(--gap-q) * .55);
        }

        .depth-3 .q-block {
            margin-top: calc(var(--gap-q) * .45);
        }

        /* Mobile: hide desktop nav; use drawer */
        @media (max-width: 900px) {
            .layout {
                grid-template-columns: 1fr;
                gap: 0;
            }

            nav {
                display: none;
            }

            .brand .subtitle {
                display: none;
            }

            .frame {
                border-left: 0;
                border-right: 0;
            }
        }

        /* Drawer (dialog) */
        dialog {
            border: 1px solid var(--hair);
            border-radius: 14px;
            padding: 0;
            width: min(520px, calc(100vw - 24px));
            background: var(--frame-bg);
            color: var(--text);
        }

        dialog::backdrop {
            background: rgba(20, 20, 20, .28);
        }

        .drawer-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            padding: 12px 14px;
            border-bottom: 1px solid var(--hair2);
        }

        .drawer-title {
            font-size: 12px;
            color: rgba(20, 20, 20, .74);
            font-weight: 600;
            letter-spacing: .02em;
        }

        .drawer-close {
            border: 1px solid var(--hair);
            background: transparent;
            border-radius: 10px;
            padding: 7px 10px;
            font-size: 12px;
            cursor: pointer;
            color: rgba(20, 20, 20, .80);
        }

        .drawer-close:hover {
            text-decoration: underline;
        }

        /* one change */

        .drawer-body {
            padding: 10px 14px 14px;
        }

        .drawer-list {
            max-height: min(62vh, 520px);
            overflow: auto;
            padding-right: 6px;

            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .drawer-list::-webkit-scrollbar {
            display: none;
        }

        /* Reduced motion */
        @media (prefers-reduced-motion: reduce) {
            html {
                scroll-behavior: auto;
            }

            details.solution {
                scroll-behavior: auto;
            }
        }

        @media (prefers-reduced-motion: no-preference) {
            html {
                scroll-behavior: smooth;
            }

            /* navigation jumps: smooth */
        }
    </style>

    <script defer>
        (function () {
            "use strict";

            const $ = (sel, root = document) => root.querySelector(sel);
            const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));

            const paperSelect = null;

            // ---------- Diagrams (inline SVG placeholders; 4 reused types) ----------
            function svgGeometry() {
                return `
        <svg viewBox="0 0 360 220" role="img" aria-label="Geometry diagram">
          <rect x="10" y="10" width="340" height="200" fill="none" stroke="rgba(20,20,20,.10)"/>
          <circle cx="255" cy="95" r="46" fill="none" stroke="rgba(20,20,20,.60)" stroke-width="2"/>
          <path d="M70 175 L160 55 L245 175 Z" fill="none" stroke="rgba(20,20,20,.78)" stroke-width="2"/>
          <text x="154" y="44" font-size="12" fill="rgba(20,20,20,.65)">A</text>
          <text x="60" y="193" font-size="12" fill="rgba(20,20,20,.65)">B</text>
          <text x="250" y="193" font-size="12" fill="rgba(20,20,20,.65)">C</text>
          <text x="262" y="98" font-size="12" fill="rgba(20,20,20,.65)">O</text>
          <path d="M160 55 L255 95" stroke="rgba(20,20,20,.40)" stroke-dasharray="4 4"/>
          <text x="195" y="88" font-size="12" fill="rgba(20,20,20,.58)">12 cm</text>
        </svg>`;
            }

            function svgRatioBars() {
                return `
        <svg viewBox="0 0 360 220" role="img" aria-label="Bar model diagram">
          <rect x="10" y="10" width="340" height="200" fill="none" stroke="rgba(20,20,20,.10)"/>
          <text x="18" y="36" font-size="12" fill="rgba(20,20,20,.65)">Ratio bars</text>

          <g transform="translate(20,60)">
            <rect x="0" y="0" width="280" height="28" fill="rgba(20,20,20,.03)" stroke="rgba(20,20,20,.35)"/>
            <line x1="70" y1="0" x2="70" y2="28" stroke="rgba(20,20,20,.35)"/>
            <line x1="140" y1="0" x2="140" y2="28" stroke="rgba(20,20,20,.35)"/>
            <line x1="210" y1="0" x2="210" y2="28" stroke="rgba(20,20,20,.35)"/>
            <text x="288" y="20" font-size="12" fill="rgba(20,20,20,.58)">A</text>
          </g>

          <g transform="translate(20,120)">
            <rect x="0" y="0" width="240" height="28" fill="rgba(20,20,20,.03)" stroke="rgba(20,20,20,.35)"/>
            <line x1="60" y1="0" x2="60" y2="28" stroke="rgba(20,20,20,.35)"/>
            <line x1="120" y1="0" x2="120" y2="28" stroke="rgba(20,20,20,.35)"/>
            <line x1="180" y1="0" x2="180" y2="28" stroke="rgba(20,20,20,.35)"/>
            <text x="248" y="20" font-size="12" fill="rgba(20,20,20,.58)">B</text>
          </g>

          <text x="20" y="190" font-size="12" fill="rgba(20,20,20,.58)">Each block = 5</text>
        </svg>`;
            }

            function svgGridLine() {
                return `
        <svg viewBox="0 0 360 220" role="img" aria-label="Coordinate grid diagram">
          <rect x="10" y="10" width="340" height="200" fill="none" stroke="rgba(20,20,20,.10)"/>
          <g transform="translate(40,20)">
            <rect x="0" y="0" width="280" height="180" fill="none" stroke="rgba(20,20,20,.25)"/>
            ${Array.from({ length: 7 }).map((_, i) => `<line x1="${i * 40}" y1="0" x2="${i * 40}" y2="180" stroke="rgba(20,20,20,.10)"/>`).join("")}
            ${Array.from({ length: 6 }).map((_, i) => `<line x1="0" y1="${i * 36}" x2="280" y2="${i * 36}" stroke="rgba(20,20,20,.10)"/>`).join("")}
            <line x1="0" y1="144" x2="280" y2="40" stroke="rgba(20,20,20,.75)" stroke-width="2"/>
            <circle cx="80" cy="112" r="4" fill="rgba(20,20,20,.75)"/>
            <circle cx="200" cy="68" r="4" fill="rgba(20,20,20,.75)"/>
            <text x="88" y="112" font-size="12" fill="rgba(20,20,20,.62)">(2,1)</text>
            <text x="208" y="68" font-size="12" fill="rgba(20,20,20,.62)">(5,3)</text>
          </g>
        </svg>`;
            }

            function svgTableGrid() {
                return `
        <svg viewBox="0 0 360 220" role="img" aria-label="Table grid diagram">
          <rect x="10" y="10" width="340" height="200" fill="none" stroke="rgba(20,20,20,.10)"/>
          <g transform="translate(40,45)">
            <rect x="0" y="0" width="280" height="130" fill="rgba(20,20,20,.02)" stroke="rgba(20,20,20,.35)"/>
            ${[1, 2, 3, 4].map(i => `<line x1="${i * 56}" y1="0" x2="${i * 56}" y2="130" stroke="rgba(20,20,20,.25)"/>`).join("")}
            ${[1, 2, 3].map(i => `<line x1="0" y1="${i * 32.5}" x2="280" y2="${i * 32.5}" stroke="rgba(20,20,20,.25)"/>`).join("")}
            <text x="10" y="22" font-size="12" fill="rgba(20,20,20,.62)">A</text>
            <text x="66" y="22" font-size="12" fill="rgba(20,20,20,.62)">B</text>
            <text x="122" y="22" font-size="12" fill="rgba(20,20,20,.62)">C</text>
            <text x="178" y="22" font-size="12" fill="rgba(20,20,20,.62)">D</text>
            <text x="234" y="22" font-size="12" fill="rgba(20,20,20,.62)">E</text>

            <text x="10" y="54" font-size="12" fill="rgba(20,20,20,.55)">2</text>
            <text x="66" y="54" font-size="12" fill="rgba(20,20,20,.55)">4</text>
            <text x="122" y="54" font-size="12" fill="rgba(20,20,20,.55)">6</text>
            <text x="178" y="54" font-size="12" fill="rgba(20,20,20,.55)">8</text>
            <text x="234" y="54" font-size="12" fill="rgba(20,20,20,.55)">10</text>
          </g>
          <text x="18" y="200" font-size="12" fill="rgba(20,20,20,.58)">Complete the table.</text>
        </svg>`;
            }

            const DIAGRAMS = {
                geometry: { svg: svgGeometry, caption: "Diagram not to scale." },
                bars: { svg: svgRatioBars, caption: "Bar model." },
                grid: { svg: svgGridLine, caption: "Coordinate grid." },
                table: { svg: svgTableGrid, caption: "Table / array." },
            };

            // ---------- Math helpers ----------
            function texInline(tex) {
                // fallback shows TeX plain text; Real KaTeX will render if available
                const safe = tex;
                return `<span class="math-inline tex-inline" data-tex="${escapeAttr(safe)}">${escapeHTML(safe)}</span>`;
            }
            function texBlock(tex) {
                const safe = tex;
                return `<div class="math-block"><span class="tex tex-block" data-tex="${escapeAttr(safe)}">${escapeHTML(safe)}</span></div>`;
            }
            function escapeHTML(s) {
                return String(s)
                    .replaceAll("&", "&amp;")
                    .replaceAll("<", "&lt;")
                    .replaceAll(">", "&gt;")
                    .replaceAll('"', "&quot;")
                    .replaceAll("'", "&#39;");
            }
            function escapeAttr(s) {
                return escapeHTML(s).replaceAll("\n", "&#10;");
            }

            // ---------- Dataset builders ----------
            function makeShortPaper() {
                const qs = [];

                qs.push(q({
                    id: "1",
                    depth: 0,
                    promptHTML: `Calculate ${texInline("48 \\div 6")}.`,
                    answerHTML: `${texInline("8")}`,
                    details: details({
                        workingLines: [
                            `We know ${texInline("6 \\times 8 = 48")}, so ${texInline("48 \\div 6 = 8")}.`
                        ]
                    })
                }));

                qs.push(q({
                    id: "2",
                    depth: 0,
                    promptHTML: `Work out ${texInline("3.5 + 2.75")}.`,
                    answerHTML: `${texInline("6.25")}`,
                    details: details({
                        keepInMind: [`Line up the decimal points before adding.`],
                        workingLines: [
                            `${texBlock("\\begin{aligned}3.50\\\\+2.75\\\\\\hline 6.25\\end{aligned}")}`
                        ]
                    })
                }));

                qs.push(q({
                    id: "3",
                    depth: 0,
                    promptHTML: `A pack has 12 pencils. How many pencils are there in 7 packs?`,
                    answerHTML: `${texInline("84")}`,
                    details: details({
                        formulasUsed: [`${texInline("\\text{Total} = \\text{groups} \\times \\text{each group}")}`],
                        workingLines: [
                            `${texInline("7 \\times 12 = 84")}.`
                        ],
                        alternativeLines: [
                            `Double and add: ${texInline("12 \\times 7 = 12\\times(5+2)=60+24=84")}.`
                        ]
                    })
                }));

                qs.push(q({
                    id: "4",
                    depth: 0,
                    promptHTML: `Simplify ${texInline("\\frac{18}{24}")}.`,
                    answerHTML: `${texInline("\\frac{3}{4}")}`,
                    details: details({
                        keepInMind: [`Divide top and bottom by the same number.`],
                        workingLines: [
                            `The greatest common factor of 18 and 24 is ${texInline("6")}.`,
                            `${texInline("\\frac{18}{24} = \\frac{18\\div 6}{24\\div 6} = \\frac{3}{4}")}.`
                        ]
                    })
                }));

                // Multi-part question
                qs.push(q({
                    id: "5",
                    depth: 0,
                    promptHTML: `A rectangle has length ${texInline("9\\text{ cm}")} and width ${texInline("4\\text{ cm}")}.`,
                    answerHTML: `${texInline("\\text{See parts (a) and (b)}")}`,
                    details: details({
                        workingLines: [
                            `Use the information to answer parts (a) and (b).`
                        ]
                    })
                }));
                qs.push(q({
                    id: "5a",
                    depth: 1,
                    promptHTML: `Find the perimeter.`,
                    answerHTML: `${texInline("26\\text{ cm}")}`,
                    details: details({
                        formulasUsed: [`${texInline("P = 2(l+w)")}`],
                        workingLines: [
                            `${texInline("P = 2(9+4) = 2\\times 13 = 26\\text{ cm}")}.`
                        ]
                    })
                }));
                qs.push(q({
                    id: "5b",
                    depth: 1,
                    promptHTML: `Find the area.`,
                    answerHTML: `${texInline("36\\text{ cm}^2")}`,
                    details: details({
                        formulasUsed: [`${texInline("A = l\\times w")}`],
                        workingLines: [
                            `${texInline("A = 9\\times 4 = 36\\text{ cm}^2")}.`
                        ]
                    })
                }));

                qs.push(q({
                    id: "6",
                    depth: 0,
                    promptHTML: `A number is rounded to the nearest 10 as ${texInline("80")}. Give two possible original numbers.`,
                    answerHTML: `${texInline("76")} or ${texInline("84")}`,
                    details: details({
                        keepInMind: [`Any whole number from 75 to 84 rounds to 80.`],
                        workingLines: [
                            `Examples: ${texInline("76")} rounds to ${texInline("80")}.`,
                            `${texInline("84")} rounds to ${texInline("80")}.`
                        ]
                    })
                }));

                return {
                    id: "short",
                    label: "Short paper",
                    meta: "6 questions (includes one multi-part question).",
                    sections: [{ label: null, items: qs }]
                };
            }

            function makeStandardPaper(allExpanded = false) {
                const qs = [];

                // Q1–Q17 short/medium mix
                for (let i = 1; i <= 17; i++) {
                    if (i === 5) {
                        qs.push(q({
                            id: "5",
                            depth: 0,
                            promptHTML: `Find ${texInline("25\\%")} of ${texInline("64")}.`,
                            answerHTML: `${texInline("16")}`,
                            details: details({
                                keepInMind: [`${texInline("25\\%")} means one quarter.`],
                                workingLines: [
                                    `${texInline("64 \\div 4 = 16")}.`
                                ]
                            }, allExpanded)
                        }));
                        continue;
                    }
                    if (i === 8) {
                        qs.push(q({
                            id: "8",
                            depth: 0,
                            promptHTML: `The mean of 4 numbers is ${texInline("7")}. The first three numbers are 6, 8 and 10. Find the fourth number.`,
                            answerHTML: `${texInline("4")}`,
                            details: details({
                                formulasUsed: [`${texInline("\\text{mean} = \\frac{\\text{total}}{\\text{number of values}}")}`],
                                workingLines: [
                                    `Total of 4 numbers: ${texInline("7\\times 4 = 28")}.`,
                                    `Sum of first three: ${texInline("6+8+10=24")}.`,
                                    `Fourth number: ${texInline("28-24=4")}.`
                                ]
                            }, allExpanded)
                        }));
                        continue;
                    }
                    if (i === 12) {
                        qs.push(q({
                            id: "12",
                            depth: 0,
                            promptHTML: `Solve ${texInline("3x+5=23")}.`,
                            answerHTML: `${texInline("x=6")}`,
                            details: details({
                                workingLines: [
                                    `${texInline("3x+5=23")}`,
                                    `${texInline("3x=18")}`,
                                    `${texInline("x=6")}`
                                ],
                                alternativeLines: [
                                    `Check: ${texInline("3\\times 6 + 5 = 18+5=23")}.`
                                ]
                            }, allExpanded)
                        }));
                        continue;
                    }
                    const prompt = (i % 3 === 0)
                        ? `Work out ${texInline(`${i + 12} \\times 7`)}.`
                        : (i % 3 === 1)
                            ? `Calculate ${texInline(`${50 + i} - ${17 + i}`)}.`
                            : `Simplify ${texInline(`\\frac{${12 + i}}{${18 + i}}`)}.`;

                    const answer = (i % 3 === 0)
                        ? texInline(String((i + 12) * 7))
                        : (i % 3 === 1)
                            ? texInline(String((50 + i) - (17 + i)))
                            : texInline(`\\frac{${12 + i}}{${18 + i}}`);

                    qs.push(q({
                        id: String(i),
                        depth: 0,
                        promptHTML: prompt,
                        answerHTML: answer,
                        details: details({
                            workingLines: [
                                `Show a clear method.`
                            ]
                        }, allExpanded)
                    }));
                }

                // Deep nesting question: Q18 with sub and sub-sub
                qs.push(q({
                    id: "18",
                    depth: 0,
                    promptHTML: `A bag contains red and blue counters. The ratio of red to blue is ${texInline("3:5")}. There are 24 red counters.`,
                    answerHTML: `${texInline("\\text{See parts (a) and (b)}")}`,
                    details: details({
                        keepInMind: [`If the ratio is ${texInline("3:5")}, the total parts are ${texInline("8")}.`],
                        workingLines: [
                            `Use the ratio information for parts (a) and (b).`
                        ]
                    }, allExpanded)
                }));

                qs.push(q({
                    id: "18(a)(i)",
                    depth: 1,
                    promptHTML: `Find the value of 1 part.`,
                    answerHTML: `${texInline("8")}`,
                    details: details({
                        workingLines: [
                            `Red counters represent 3 parts, so ${texInline("3\\text{ parts} = 24")}.`,
                            `${texInline("1\\text{ part} = 24\\div 3 = 8")}.`
                        ]
                    }, allExpanded)
                }));

                qs.push(q({
                    id: "18(a)(ii)",
                    depth: 2,
                    promptHTML: `Find the number of blue counters.`,
                    answerHTML: `${texInline("40")}`,
                    details: details({
                        workingLines: [
                            `Blue is 5 parts, so ${texInline("5\\times 8=40")}.`
                        ],
                        alternativeLines: [
                            `Total parts ${texInline("=8")}, total counters ${texInline("=8\\times 8=64")}. Blue ${texInline("=64-24=40")}.`
                        ]
                    }, allExpanded)
                }));

                qs.push(q({
                    id: "18(b)",
                    depth: 1,
                    promptHTML: `If 8 blue counters are removed, what is the new ratio of red to blue?`,
                    answerHTML: `${texInline("3:4")}`,
                    details: details({
                        keepInMind: [`Simplify ratios by dividing both parts by the same number.`],
                        workingLines: [
                            `Original blue: ${texInline("40")}. After removing 8, blue is ${texInline("32")}.`,
                            `New ratio red:blue is ${texInline("24:32")}.`,
                            `${texInline("24:32 = 3:4")}.`
                        ]
                    }, allExpanded)
                }));

                // Q19–Q25 medium mix
                for (let i = 19; i <= 25; i++) {
                    if (i === 21) {
                        qs.push(q({
                            id: "21",
                            depth: 0,
                            promptHTML: `A triangle has base ${texInline("10\\text{ cm}")} and height ${texInline("7\\text{ cm}")}. Find its area.`,
                            answerHTML: `${texInline("35\\text{ cm}^2")}`,
                            details: details({
                                formulasUsed: [`${texInline("A = \\frac{1}{2}bh")}`],
                                workingLines: [
                                    `${texInline("A=\\frac{1}{2}\\times 10\\times 7=35\\text{ cm}^2")}.`
                                ]
                            }, allExpanded)
                        }));
                        continue;
                    }
                    if (i === 24) {
                        qs.push(q({
                            id: "24",
                            depth: 0,
                            promptHTML: `A number is multiplied by 4 and then 3 is subtracted to give 29. Find the number.`,
                            answerHTML: `${texInline("8")}`,
                            details: details({
                                workingLines: [
                                    `Let the number be ${texInline("n")}.`,
                                    `${texInline("4n-3=29")}`,
                                    `${texInline("4n=32")}`,
                                    `${texInline("n=8")}`
                                ]
                            }, allExpanded)
                        }));
                        continue;
                    }
                    qs.push(q({
                        id: String(i),
                        depth: 0,
                        promptHTML: `Write ${texInline(`${i - 10}`)} as a fraction of ${texInline("50")}, in its simplest form.`,
                        answerHTML: `${texInline(`\\frac{${i - 10}}{50}`)}`,
                        details: details({
                            workingLines: [
                                `Start with ${texInline(`\\frac{${i - 10}}{50}`)} and simplify if possible.`
                            ]
                        }, allExpanded)
                    }));
                }

                // Q26–Q35 long algebra / long Solution Details (collapsed by default unless expanded dataset)
                const longIds = ["26", "27", "28", "29", "30", "31", "32", "33", "34", "35"];
                longIds.forEach((id, idx) => {
                    const n = 26 + idx;
                    const hasAllThree = (id === "27");
                    const hasAlt = (id === "30" || id === "33" || id === "27");
                    const hasKeep = (id === "27" || id === "31" || id === "34");
                    const hasForm = (id === "27" || id === "28" || id === "32");

                    const promptHTML = id === "30"
                        ? `For the function ${texInline("f(x)=x^2-6x+k")}, the graph passes through ${texInline("(2,3)")}.`
                        : `Solve and simplify the expression below, showing full working.`;

                    const answerHTML = id === "30"
                        ? `${texInline("k=11")}`
                        : `${texInline("x=\\frac{5}{2}")} or ${texInline("x=-3")}`;

                    // Extremely Long Workings add-on: use 50–60 lines for selected questions
                    const extremelyLong = (id === "33" || id === "35");

                    const baseLines = [
                        `Start from the given expression and collect like terms carefully.`,
                        texBlock("\\begin{aligned}2(3x-4) - (x+7) &= 6x-8 - x - 7\\\\ &= 5x-15\\end{aligned}"),
                        `Now solve ${texInline("5x-15=0")}.`,
                        texBlock("\\begin{aligned}5x &= 15\\\\ x &= 3\\end{aligned}")
                    ];

                    const longAlgebraBlocks = [
                        texBlock("\\begin{aligned}(x+4)(x-3) &= x^2 + x - 12\\\\ x^2 + x - 12 &= 0\\end{aligned}"),
                        texBlock("\\begin{aligned}x &= \\frac{-1 \\pm \\sqrt{1+48}}{2}\\\\ &= \\frac{-1 \\pm 7}{2}\\end{aligned}"),
                        texBlock("\\begin{aligned}x &= 3\\quad\\text{or}\\quad x=-4\\end{aligned}")
                    ];

                    let workingLines = [];
                    if (id === "30") {
                        // Deep nesting add-on inside long region: Q30(a)(i), (ii), (b)
                        // Provide a top-level Q30, plus sub-questions beneath it
                        qs.push(q({
                            id: "30",
                            depth: 0,
                            promptHTML: `Use the information below to answer parts (a) and (b): ${texInline("f(x)=x^2-6x+k")} passes through ${texInline("(2,3)")}.`,
                            answerHTML: `${texInline("\\text{See parts (a) and (b)}")}`,
                            details: details({
                                keepInMind: [`Substitute the point into ${texInline("y=f(x)")} to form an equation.`],
                                workingLines: [
                                    `You can use substitution for each part.`,
                                    texBlock("\\begin{aligned}3 &= 2^2 - 6\\cdot 2 + k\\\\ 3 &= 4 - 12 + k\\end{aligned}")
                                ],
                                formulasUsed: [`${texInline("y=f(x)")}`]
                            }, allExpanded)
                        }));

                        qs.push(q({
                            id: "30(a)(i)",
                            depth: 1,
                            promptHTML: `Find ${texInline("k")}.`,
                            answerHTML: `${texInline("k=11")}`,
                            details: details({
                                workingLines: [
                                    texBlock("\\begin{aligned}3 &= -8 + k\\\\ k &= 11\\end{aligned}")
                                ],
                                alternativeLines: [
                                    `Rearrange: ${texInline("k=3-4+12=11")}.`
                                ]
                            }, allExpanded)
                        }));

                        qs.push(q({
                            id: "30(a)(ii)",
                            depth: 2,
                            promptHTML: `Write ${texInline("f(x)")} in completed square form.`,
                            answerHTML: `${texInline("f(x)=(x-3)^2+2")}`,
                            details: details({
                                workingLines: [
                                    texBlock("\\begin{aligned}f(x) &= x^2-6x+11\\\\ &= (x^2-6x+9)+2\\\\ &= (x-3)^2+2\\end{aligned}")
                                ]
                            }, allExpanded)
                        }));

                        qs.push(q({
                            id: "30(b)",
                            depth: 1,
                            promptHTML: `Find the minimum value of ${texInline("f(x)")}.`,
                            answerHTML: `${texInline("2")}`,
                            details: details({
                                keepInMind: [`A square term like ${texInline("(x-3)^2")} is never negative.`],
                                workingLines: [
                                    `From ${texInline("f(x)=(x-3)^2+2")}, the minimum occurs when ${texInline("(x-3)^2=0")}.`,
                                    `So the minimum value is ${texInline("2")}.`
                                ]
                            }, allExpanded)
                        }));
                        return; // skip adding a separate flat Q30 below
                    }

                    // For other long questions, build long solution details
                    workingLines = [
                        `Read the expression carefully and keep your steps clear.`,
                        ...longAlgebraBlocks,
                        `State final solutions clearly.`
                    ];

                    if (extremelyLong) {
                        const lines = [];
                        lines.push(`We will build the solution line-by-line to keep it readable.`);
                        for (let i = 1; i <= 56; i++) {
                            const t = (i % 6 === 0)
                                ? texBlock("\\begin{aligned}x^2 + (2a-6)x + (a^2-6a+11) &= 0\\end{aligned}")
                                : (i % 6 === 1)
                                    ? `Expand and simplify: ${texInline("(x+a-3)^2")} shows the structure.`
                                    : (i % 6 === 2)
                                        ? texBlock("\\begin{aligned}(x+a-3)^2 &= x^2 + 2(a-3)x + (a-3)^2\\end{aligned}")
                                        : (i % 6 === 3)
                                            ? `Match coefficients and solve for the parameter.`
                                            : (i % 6 === 4)
                                                ? texBlock("\\begin{aligned}2(a-3) &= 2a-6\\end{aligned}")
                                                : `Now substitute back and solve for ${texInline("x")}.`;

                            // normalize commas above
                            if (typeof t === "string") lines.push(t.replace(/,\s*$/, ""));
                            else lines.push(t);
                        }
                        lines.push(`Finish by stating the final answer in simplest form.`);
                        workingLines = lines;
                    }

                    const altLines = hasAlt ? [
                        `Alternative method: factorise (if possible) or use a substitution.`,
                        texBlock("\\begin{aligned}x^2 + x - 12 &= 0\\\\ (x+4)(x-3) &= 0\\end{aligned}"),
                        `So ${texInline("x=-4")} or ${texInline("x=3")}.`
                    ] : null;

                    const keep = hasKeep ? [
                        `Keep your algebra steps on separate lines to avoid mistakes.`,
                        `If your solutions are fractions, check them by substitution.`
                    ] : null;

                    const formulas = hasForm ? [
                        `${texInline("x = \\frac{-b\\pm\\sqrt{b^2-4ac}}{2a}")}`,
                        `${texInline("\\text{discriminant } D=b^2-4ac")}`
                    ] : null;

                    // Ensure multiple KaTeX blocks for long questions
                    const additionalMathBlocks = [
                        texBlock("\\begin{aligned}D &= b^2-4ac\\\\ &= 1-4(1)(-12) = 49\\end{aligned}"),
                        texBlock("\\begin{aligned}\\sqrt{D} &= 7\\end{aligned}")
                    ];

                    const fullWorking = [
                        ...workingLines,
                        ...additionalMathBlocks,
                        texBlock("\\begin{aligned}x &= \\frac{-1\\pm 7}{2}\\\\ x&=3\\ \\text{or}\\ x=-4\\end{aligned}")
                    ];

                    qs.push(q({
                        id,
                        depth: 0,
                        promptHTML,
                        answerHTML,
                        details: details({
                            keepInMind: keep,
                            formulasUsed: formulas,
                            workingLines: fullWorking,
                            alternativeLines: altLines
                        }, allExpanded || false)
                    }));
                });

                return {
                    id: allExpanded ? "standard_expanded" : "standard",
                    label: allExpanded ? "Standard (Workings Expanded)" : "Standard paper",
                    meta: allExpanded
                        ? "35 questions (all workings start expanded in this dataset only)."
                        : "35 questions (Q26–Q35 include long algebra; workings collapsed by default).",
                    sections: [{ label: null, items: qs }]
                };
            }

            function makeDiagramHeavyPaper() {
                const qs = [];
                const diagramIds = new Set([2, 4, 6, 9, 11, 14, 17, 20]); // 8 diagrams

                for (let i = 1; i <= 20; i++) {
                    const hasDia = diagramIds.has(i);
                    const diaType = (i % 4 === 1) ? "geometry" : (i % 4 === 2) ? "bars" : (i % 4 === 3) ? "grid" : "table";
                    const dia = hasDia ? { type: diaType } : null;

                    const promptHTML = hasDia
                        ? `Use the diagram to answer the question.`
                        : (i % 2 === 0)
                            ? `Work out ${texInline(`${i + 9} \\times ${i % 5 + 3}`)}.`
                            : `Simplify ${texInline(`\\frac{${20 + i}}{${10 + i}}`)}.`;

                    const answerHTML = hasDia
                        ? (diaType === "grid" ? `${texInline("y=2x-3")}` : diaType === "bars" ? `${texInline("25")}` : diaType === "geometry" ? `${texInline("40^\\circ")}` : `${texInline("12")}`)
                        : (i % 2 === 0)
                            ? `${texInline(String((i + 9) * (i % 5 + 3)))}` :
                            `${texInline(`\\frac{${20 + i}}{${10 + i}}`)}`;

                    const keep = (i === 6 || i === 14 || i === 17) ? [`Look at labels carefully and keep units consistent.`] : null;
                    const formulas = (i === 4 || i === 11 || i === 20) ? [`${texInline("\\text{Area} = \\text{base}\\times\\text{height}")}`] : null;
                    const alt = (i === 9 || i === 20 || i === 2) ? [
                        `Alternative working: use a different representation and confirm the same result.`,
                        texBlock("\\begin{aligned}\\text{Check: } 5\\times 5 &= 25\\end{aligned}")
                    ] : null;

                    const workingLines = hasDia
                        ? [
                            `Read the given information from the diagram.`,
                            ...(diaType === "grid"
                                ? [
                                    texBlock("\\begin{aligned}\\text{slope} &= \\frac{3-1}{5-2} = \\frac{2}{3}\\end{aligned}"),
                                    `A suitable line form: ${texInline("y=2x-3")} (example).`
                                ]
                                : diaType === "bars"
                                    ? [
                                        `Each block represents 5.`,
                                        `${texInline("5\\text{ blocks} \\Rightarrow 5\\times 5 = 25")}.`
                                    ]
                                    : diaType === "geometry"
                                        ? [
                                            `Use angle facts to find the missing angle.`,
                                            texBlock("\\begin{aligned}180^\\circ - (70^\\circ+70^\\circ) &= 40^\\circ\\end{aligned}")
                                        ]
                                        : [
                                            `Complete the pattern in the table.`,
                                            texBlock("\\begin{aligned}2,4,6,8,10\\Rightarrow 12\\end{aligned}")
                                        ])
                        ]
                        : [
                            `Show a clear method.`,
                            (i % 2 === 0) ? texBlock("\\begin{aligned}a\\times b\\end{aligned}") : texBlock("\\begin{aligned}\\frac{p}{q}\\end{aligned}")
                        ];

                    qs.push(q({
                        id: String(i),
                        depth: 0,
                        promptHTML,
                        diagram: dia,
                        answerHTML,
                        details: details({
                            keepInMind: keep,
                            formulasUsed: formulas,
                            workingLines,
                            alternativeLines: alt
                        }, false)
                    }));
                }

                return {
                    id: "diagram",
                    label: "Diagram-heavy paper",
                    meta: "20 questions (8 include diagrams).",
                    sections: [{ label: null, items: qs }]
                };
            }

            function makeSectionedPaper() {
                const secA = [];
                const secB = [];
                const secC = [];

                // Section A: 35 questions small/medium
                for (let i = 1; i <= 35; i++) {
                    const keep = (i === 3 || i === 16 || i === 29) ? [`Check each step before moving on.`] : null;
                    const formulas = (i === 7 || i === 22 || i === 31) ? [`${texInline("\\text{speed} = \\frac{\\text{distance}}{\\text{time}}")}`] : null;
                    const alt = (i === 12 || i === 22 || i === 33) ? [
                        `Alternative working: rearrange first, then substitute.`,
                        texBlock("\\begin{aligned}ax+b=c\\Rightarrow ax=c-b\\Rightarrow x=\\frac{c-b}{a}\\end{aligned}")
                    ] : null;

                    secA.push(q({
                        id: String(i),
                        depth: 0,
                        promptHTML: (i % 5 === 0)
                            ? `Solve ${texInline(`${i % 9 + 2}x + ${i % 7 + 3} = ${i % 11 + 18}`)}.`
                            : `Calculate ${texInline(`${100 + i} \\div ${i % 9 + 2}`)} (give the exact value).`,
                        answerHTML: (i % 5 === 0)
                            ? `${texInline("x=\\frac{15}{4}")}`
                            : `${texInline(`${100 + i}`)} ${texInline("\\div")} ${texInline(`${i % 9 + 2}`)}`,
                        details: details({
                            keepInMind: keep,
                            formulasUsed: formulas,
                            workingLines: [
                                `Show a clear method.`,
                                texBlock("\\begin{aligned}\\text{Step 1}\\;\\rightarrow\\;\\text{Step 2}\\;\\rightarrow\\;\\text{Step 3}\\end{aligned}")
                            ],
                            alternativeLines: alt
                        }, false)
                    }));
                }

                // Section B: 8 medium
                for (let i = 36; i <= 43; i++) {
                    const idx = i - 35;
                    const withDia = (idx === 2 || idx === 6);
                    const dia = withDia ? { type: idx === 2 ? "geometry" : "table" } : null;

                    secB.push(q({
                        id: String(i),
                        depth: 0,
                        promptHTML: withDia
                            ? `Use the diagram to answer the question.`
                            : `A shop reduces a price by ${texInline("15\\%")}. The new price is ${texInline("\\pounds 34")}. Find the original price.`,
                        diagram: dia,
                        answerHTML: withDia
                            ? (idx === 2 ? `${texInline("x=30^\\circ")}` : `${texInline("16")}`)
                            : `${texInline("\\pounds 40")}`,
                        details: details({
                            keepInMind: idx === 1 ? [`A reduction of ${texInline("15\\%")} means ${texInline("85\\%")} remains.`] : null,
                            formulasUsed: idx === 1 ? [`${texInline("\\text{new} = 0.85\\times\\text{original}")}`] : null,
                            workingLines: withDia
                                ? [
                                    `Read the required value from the diagram.`,
                                    texBlock("\\begin{aligned}\\text{Use angle facts / pattern to find the missing value.}\\end{aligned}")
                                ]
                                : [
                                    texBlock("\\begin{aligned}34 &= 0.85\\times \\text{original}\\\\ \\text{original} &= \\frac{34}{0.85}=40\\end{aligned}")
                                ],
                            alternativeLines: idx === 4 ? [
                                `Alternative working: use fractions.`,
                                texBlock("\\begin{aligned}0.85=\\frac{85}{100}=\\frac{17}{20}\\Rightarrow \\text{original}=34\\times\\frac{20}{17}=40\\end{aligned}")
                            ] : null
                        }, false)
                    }));
                }

                // Section C: 6 very long Solution Details (collapsed by default)
                for (let i = 44; i <= 49; i++) {
                    const extremelyLong = (i === 46 || i === 49);
                    const working = [];

                    working.push(`This is a long working example. Keep your place by writing one step per line.`);
                    working.push(texBlock("\\begin{aligned}x^2 - 8x + 12 &= 0\\end{aligned}"));
                    working.push(texBlock("\\begin{aligned}(x-2)(x-6) &= 0\\end{aligned}"));
                    working.push(`So ${texInline("x=2")} or ${texInline("x=6")}.`);

                    // add multiple KaTeX blocks
                    working.push(texBlock("\\begin{aligned}\\text{Check }x=2: \\; 2^2-8\\cdot2+12 &= 4-16+12=0\\end{aligned}"));
                    working.push(texBlock("\\begin{aligned}\\text{Check }x=6: \\; 6^2-8\\cdot6+12 &= 36-48+12=0\\end{aligned}"));

                    if (extremelyLong) {
                        for (let k = 1; k <= 60; k++) {
                            const piece = (k % 7 === 0)
                                ? texBlock("\\begin{aligned}\\frac{d}{dx}(x^2-8x+12) &= 2x-8\\end{aligned}")
                                : (k % 7 === 1)
                                    ? `Rearrange and simplify carefully.`
                                    : (k % 7 === 2)
                                        ? texBlock("\\begin{aligned}x^2-8x+12 &= (x-4)^2 - 4\\end{aligned}")
                                        : (k % 7 === 3)
                                            ? `Use substitution to compare forms.`
                                            : (k % 7 === 4)
                                                ? texBlock("\\begin{aligned}(x-4)^2 &= 4\\end{aligned}")
                                                : (k % 7 === 5)
                                                    ? texBlock("\\begin{aligned}x-4 &= \\pm 2\\end{aligned}")
                                                    : `So ${texInline("x=6")} or ${texInline("x=2")}.`;

                            working.push(piece);
                        }
                    }

                    secC.push(q({
                        id: String(i),
                        depth: 0,
                        promptHTML: `Solve the equation and show full working: ${texInline("x^2-8x+12=0")}.`,
                        answerHTML: `${texInline("x=2")} or ${texInline("x=6")}`,
                        details: details({
                            keepInMind: (i === 44 || i === 47 || i === 49) ? [
                                `If factorising is difficult, try completing the square.`,
                                `Always check both solutions in the original equation.`
                            ] : null,
                            formulasUsed: (i === 45 || i === 48 || i === 49) ? [
                                `${texInline("x = \\frac{-b\\pm\\sqrt{b^2-4ac}}{2a}")}`,
                                `${texInline("D=b^2-4ac")}`
                            ] : null,
                            workingLines: working,
                            alternativeLines: (i === 49) ? [
                                `Alternative working: quadratic formula.`,
                                texBlock("\\begin{aligned}x &= \\frac{8\\pm\\sqrt{64-48}}{2}\\\\ &= \\frac{8\\pm 4}{2}\\\\ &= 2\\;\\text{or}\\;6\\end{aligned}")
                            ] : (i === 46 || i === 47) ? [
                                `Alternative working: completing the square.`,
                                texBlock("\\begin{aligned}x^2-8x+12 &= (x-4)^2 - 4\\end{aligned}"),
                                texBlock("\\begin{aligned}(x-4)^2 &= 4\\Rightarrow x-4=\\pm 2\\Rightarrow x=2\\text{ or }6\\end{aligned}")
                            ] : null
                        }, false)
                    }));
                }

                return {
                    id: "sectioned",
                    label: "Sectioned paper",
                    meta: "Section A: 35 questions; Section B: 8 questions; Section C: 6 questions (very long workings).",
                    sections: [
                        { label: "A", items: secA },
                        { label: "B", items: secB },
                        { label: "C", items: secC },
                    ]
                };
            }

            // ---------- Question + details constructors ----------
            function q({ id, depth, promptHTML, answerHTML, details, diagram = null }) {
                return { id, depth, promptHTML, answerHTML, details, diagram };
            }

            function details({ keepInMind = null, formulasUsed = null, workingLines = [], alternativeLines = null }, openByDefault = false) {
                return {
                    keepInMind,
                    formulasUsed,
                    workingLines,
                    alternativeLines,
                    openByDefault
                };
            }

            // ---------- Build datasets ----------
            const DATASETS = [
                makeShortPaper(),
                makeStandardPaper(false),
                makeStandardPaper(true), // Workings Expanded Stress Test add-on
                makeDiagramHeavyPaper(),
                makeSectionedPaper()
            ];

            // ---------- Render ----------
            function renderApp(datasetId) {
                const ds = DATASETS.find(d => d.id === datasetId) || DATASETS[0];

                const paperMeta = $("#paperMeta");
                const paperRoot = $("#paper");
                const navList = $("#navList");
                const drawerList = $("#drawerList");

                paperMeta.textContent = ds.meta;

                // Clear content
                paperRoot.innerHTML = "";
                navList.innerHTML = "";
                drawerList.innerHTML = "";

                // Build navigation items list structure
                const navItems = []; // {id, targetId, isSection, label}
                ds.sections.forEach(section => {
                    if (section.label) {
                        navItems.push({ isSection: true, label: section.label });
                    }
                    section.items.forEach(item => {
                        navItems.push({
                            isSection: false,
                            id: item.id,
                            targetId: domIdFor(item.id),
                            label: item.id
                        });
                    });
                });

                // Render nav rail
                navList.setAttribute("tabindex", "0");
                navItems.forEach(entry => {
                    if (entry.isSection) {
                        const s = document.createElement("div");
                        s.className = "nav-section";
                        s.textContent = entry.label;
                        navList.appendChild(s);
                        return;
                    }
                    navList.appendChild(makeNavButton(entry.label, entry.targetId));
                });

                // Render drawer list
                drawerList.setAttribute("tabindex", "0");
                navItems.forEach(entry => {
                    if (entry.isSection) {
                        const s = document.createElement("div");
                        s.className = "nav-section";
                        s.textContent = entry.label;
                        drawerList.appendChild(s);
                        return;
                    }
                    drawerList.appendChild(makeNavButton(entry.label, entry.targetId, true));
                });

                // Render paper sections + questions
                ds.sections.forEach(section => {
                    if (section.label) {
                        const h = document.createElement("div");
                        h.className = "section-header";
                        h.textContent = section.label;
                        paperRoot.appendChild(h);

                        const hr = document.createElement("hr");
                        hr.className = "section-rule";
                        paperRoot.appendChild(hr);
                    }

                    section.items.forEach(item => {
                        paperRoot.appendChild(renderQuestion(item));
                    });
                });

                // Hook up nav scroll keys (accessibility)
                [navList, drawerList].forEach(el => {
                    el.addEventListener("keydown", (e) => {
                        const k = e.key;
                        const step = 60;
                        if (k === "ArrowDown") { el.scrollTop += step; e.preventDefault(); }
                        else if (k === "ArrowUp") { el.scrollTop -= step; e.preventDefault(); }
                        else if (k === "PageDown") { el.scrollTop += el.clientHeight * 0.8; e.preventDefault(); }
                        else if (k === "PageUp") { el.scrollTop -= el.clientHeight * 0.8; e.preventDefault(); }
                        else if (k === "Home") { el.scrollTop = 0; }
                        else if (k === "End") { el.scrollTop = el.scrollHeight; }
                    });
                });

                // Disclosure label sync for details
                $$("details.solution", paperRoot).forEach(det => {
                    syncSummaryLabel(det);
                    det.addEventListener("toggle", () => syncSummaryLabel(det));
                });

                // Real KaTeX rendering add-on (graceful fallback)
                renderKatexIfAvailable(paperRoot);

                // Active nav tracking
                setupActiveTracking();

                // Ensure drawer closes on selection without changing expansion states
                $$(".nav-item", drawerList).forEach(btn => {
                    btn.addEventListener("click", () => {
                        const dlg = $("#jumpDialog");
                        if (dlg && dlg.open) dlg.close();
                    }, { capture: true });
                });
            }

            function makeNavButton(label, targetId, isDrawer = false) {
                const btn = document.createElement("button");
                btn.className = "nav-item";
                btn.type = "button";
                btn.textContent = label;
                btn.dataset.target = targetId;
                btn.setAttribute("aria-current", "false");

                btn.addEventListener("click", () => {
                    const target = document.getElementById(targetId);
                    if (!target) return;
                    const reduce = window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches;
                    target.scrollIntoView({ behavior: reduce ? "auto" : "smooth", block: "start" });
                });

                return btn;
            }

            function renderQuestion(item) {
                const wrap = document.createElement("section");
                wrap.className = `question depth-${Math.min(3, Math.max(0, item.depth || 0))}`;
                wrap.id = domIdFor(item.id);

                const block = document.createElement("div");
                block.className = "q-block";

                const qline = document.createElement("div");
                qline.className = "q-line";

                const idEl = document.createElement("div");
                idEl.className = "qid";
                idEl.textContent = item.id;

                const qtext = document.createElement("div");
                qtext.className = "qtext";
                qtext.innerHTML = item.promptHTML;

                qline.appendChild(idEl);
                qline.appendChild(qtext);

                block.appendChild(qline);

                // Diagram inside Question block
                if (item.diagram && DIAGRAMS[item.diagram.type]) {
                    const fig = document.createElement("figure");
                    fig.className = "diagram";
                    fig.innerHTML = DIAGRAMS[item.diagram.type].svg();
                    const cap = document.createElement("figcaption");
                    cap.textContent = DIAGRAMS[item.diagram.type].caption;
                    fig.appendChild(cap);
                    qtext.appendChild(fig);
                }

                // Answer
                const ans = document.createElement("div");
                ans.className = "answer";
                const row = document.createElement("div");
                row.className = "answer-row";
                const lab = document.createElement("span");
                lab.className = "a-label";
                lab.textContent = "Answer";
                const val = document.createElement("span");
                val.className = "a-value";
                val.innerHTML = item.answerHTML;

                row.appendChild(lab);
                row.appendChild(val);
                ans.appendChild(row);
                block.appendChild(ans);

                // Solution details (atomic)
                const det = document.createElement("details");
                det.className = "solution";
                if (item.details && item.details.openByDefault) det.open = true;

                const sum = document.createElement("summary");
                sum.innerHTML = `
          <svg class="chev" viewBox="0 0 12 12" aria-hidden="true" focusable="false">
            <path d="M2 4.5 L6 8.5 L10 4.5" fill="none" stroke="rgba(20,20,20,.72)" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"></path>
          </svg>
          <span class="summary-text">Show working</span>
        `;
                det.appendChild(sum);

                const body = document.createElement("div");
                body.className = "solution-body";

                // Keep in mind
                if (item.details && Array.isArray(item.details.keepInMind) && item.details.keepInMind.length) {
                    body.appendChild(solBlock("Keep in mind", item.details.keepInMind.map(t => `<p class="sol-text">${escapeHTML(t)}</p>`).join("")));
                }
                // Formulas used
                if (item.details && Array.isArray(item.details.formulasUsed) && item.details.formulasUsed.length) {
                    const lines = item.details.formulasUsed.map(f => `<p class="sol-text">${f}</p>`).join("");
                    body.appendChild(solBlock("Formulas used", lines));
                }
                // Working
                body.appendChild(solBlock("Working", renderWorkingLines(item.details ? item.details.workingLines : [])));

                // Alternative working(s)
                if (item.details && Array.isArray(item.details.alternativeLines) && item.details.alternativeLines.length) {
                    body.appendChild(solBlock("Alternative working", renderWorkingLines(item.details.alternativeLines)));
                }

                det.appendChild(body);
                block.appendChild(det);

                wrap.appendChild(block);
                return wrap;
            }

            function renderWorkingLines(lines) {
                const items = (lines || []).map(line => {
                    if (typeof line !== "string") return String(line);
                    // If line already contains HTML (math blocks etc), keep it.
                    // Otherwise wrap in sol-text paragraph.
                    const trimmed = line.trim();
                    const isHTMLish = trimmed.startsWith("<");
                    return isHTMLish ? trimmed : `<p class="sol-text">${escapeHTML(trimmed)}</p>`;
                });
                return `<div class="working-lines">${items.join("")}</div>`;
            }

            function solBlock(label, innerHTML) {
                const d = document.createElement("div");
                d.className = "sol-block";
                d.innerHTML = `
          <div class="sol-label">${label}</div>
          <div class="sol-body">${innerHTML}</div>
        `;
                return d;
            }

            function syncSummaryLabel(detailsEl) {
                const t = $(".summary-text", detailsEl);
                if (!t) return;
                t.textContent = detailsEl.open ? "Hide working" : "Show working";
            }

            function domIdFor(qid) {
                return "q-" + String(qid).toLowerCase().replace(/[^a-z0-9]+/g, "-").replace(/^-+|-+$/g, "");
            }

            // ---------- KaTeX rendering (graceful fallback) ----------
            function renderKatexIfAvailable(root) {
                // If KaTeX isn't loaded, leave plain text in place.
                if (!window.katex || typeof window.katex.render !== "function") return;

                // Inline
                $$(".tex-inline", root).forEach(el => {
                    const tex = el.getAttribute("data-tex") || el.textContent || "";
                    try {
                        window.katex.render(tex, el, { throwOnError: false, displayMode: false });
                    } catch (_e) {
                        // keep text
                    }
                });

                // Block
                $$(".tex-block", root).forEach(el => {
                    const tex = el.getAttribute("data-tex") || el.textContent || "";
                    try {
                        window.katex.render(tex, el, { throwOnError: false, displayMode: true });
                    } catch (_e) {
                        // keep text
                    }
                });
            }

            // ---------- Active nav tracking (quiet) ----------
            let activeObserverCleanup = null;
            function setupActiveTracking() {
                if (activeObserverCleanup) activeObserverCleanup();

                const questions = $$(".question");
                const navButtons = $$(".nav-item", $("#navList"));
                const drawerButtons = $$(".nav-item", $("#drawerList"));

                const btnByTarget = new Map();
                navButtons.forEach(b => btnByTarget.set(b.dataset.target, b));
                const drawerByTarget = new Map();
                drawerButtons.forEach(b => drawerByTarget.set(b.dataset.target, b));

                function setCurrent(targetId) {
                    navButtons.forEach(b => b.setAttribute("aria-current", "false"));
                    drawerButtons.forEach(b => b.setAttribute("aria-current", "false"));
                    const b1 = btnByTarget.get(targetId);
                    const b2 = drawerByTarget.get(targetId);
                    if (b1) b1.setAttribute("aria-current", "true");
                    if (b2) b2.setAttribute("aria-current", "true");
                }

                // Use IntersectionObserver; restrained and stable
                const io = new IntersectionObserver((entries) => {
                    const inView = entries
                        .filter(e => e.isIntersecting)
                        .sort((a, b) => (a.boundingClientRect.top - b.boundingClientRect.top));
                    if (inView.length) {
                        setCurrent(inView[0].target.id);
                    }
                }, {
                    root: null,
                    rootMargin: "-20% 0px -70% 0px",
                    threshold: [0.01, 0.1]
                });

                questions.forEach(qEl => io.observe(qEl));

                // Initialize
                if (questions[0]) setCurrent(questions[0].id);

                activeObserverCleanup = () => io.disconnect();
            }

            // ---------- Drawer (mobile/tablet) ----------
            function setupDrawer() {
                const btn = $("#jumpBtn");
                const dlg = $("#jumpDialog");
                const close = $("#drawerClose");

                if (!btn || !dlg || !close) return;

                btn.addEventListener("click", () => {
                    // showModal traps focus and blocks background interaction (required)
                    if (typeof dlg.showModal === "function") {
                        dlg.showModal();
                    } else {
                        dlg.setAttribute("open", ""); // fallback
                    }
                });

                close.addEventListener("click", () => {
                    if (dlg.open) dlg.close();
                    else dlg.removeAttribute("open");
                });

                dlg.addEventListener("click", (e) => {
                    // click outside closes
                    const rect = dlg.getBoundingClientRect();
                    const inside = (e.clientX >= rect.left && e.clientX <= rect.right && e.clientY >= rect.top && e.clientY <= rect.bottom);
                    if (!inside) {
                        if (dlg.open) dlg.close();
                        else dlg.removeAttribute("open");
                    }
                });
            }

            // ---------- Utility ----------
            function escapeHTML(s) {
                return String(s)
                    .replaceAll("&", "&amp;")
                    .replaceAll("<", "&lt;")
                    .replaceAll(">", "&gt;")
                    .replaceAll('"', "&quot;")
                    .replaceAll("'", "&#39;");
            }

            // ---------- Init ----------
            document.addEventListener("DOMContentLoaded", () => {
                const sel = $("#paperSelect");
                setupDrawer();

                // Populate selector
                sel.innerHTML = "";
                DATASETS.forEach(ds => {
                    const opt = document.createElement("option");
                    opt.value = ds.id;
                    opt.textContent = ds.label;
                    sel.appendChild(opt);
                });

                // Default selection
                sel.value = "short";
                renderApp(sel.value);

                sel.addEventListener("change", () => {
                    renderApp(sel.value);
                    // Keep structure stable; do not auto-expand/collapse beyond dataset defaults.
                    // (Switching rebuilds content + nav only.)
                });
            });
        })();
    </script>
</head>

<body>
    <header>
        <div class="header-inner" aria-label="Top controls">
            <div class="brand" aria-hidden="false">
                <div class="title">RTQ</div>
                <div class="subtitle">Maths Paper Solution Viewer — Stress Harness</div>
            </div>

            <div class="controls">
                <label for="paperSelect">Paper</label>
                <select id="paperSelect" aria-label="Paper selector"></select>
                <button class="jump-btn" id="jumpBtn" type="button">Jump to</button>
            </div>
        </div>
    </header>

    <div class="frame">
        <div class="layout">
            <nav aria-label="Document navigation">
                <div class="nav-sticky">
                    <div class="nav-label">Questions</div>
                    <div class="nav-list" id="navList" aria-label="Question list"></div>
                </div>
            </nav>

            <main aria-label="Paper content">
                <p class="paper-meta" id="paperMeta"></p>
                <div id="paper"></div>
            </main>
        </div>
    </div>

    <!-- Mobile / Tablet navigation drawer -->
    <dialog id="jumpDialog" aria-label="Jump to question">
        <div class="drawer-head">
            <div class="drawer-title">Jump to</div>
            <button class="drawer-close" id="drawerClose" type="button">Close</button>
        </div>
        <div class="drawer-body">
            <div class="drawer-list" id="drawerList" aria-label="Question list (drawer)"></div>
        </div>
    </dialog>
</body>

</html>