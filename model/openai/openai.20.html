<!-- index.html -->
<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RTQ – Maths Paper Solution Viewer (Stress Test)</title>

  <!-- KaTeX (CDN) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">

  <style>
    :root {
      --frame-max: 1120px;
      --gutter: 20px;
      --nav-w: 160px;
      --gap: 34px;

      --text: #111;
      --muted: #666;
      --hairline: #d7d7d7;

      --btn-bg: #f2f2f2;
      --btn-bd: #cfcfcf;

      --q-gap: 38px;
      /* largest spacing unit */
      --inner-gap: 10px;
      --indent-1: 18px;
      --indent-2: 36px;
    }

    * {
      box-sizing: border-box;
      /* border: solid 1px #efefef; */
    }

    html,
    body {
      height: 100%;
    }

    body {
      margin: 0;
      color: var(--text);
      background: #fff;
      overflow-x: hidden;
      /* main document must never scroll horizontally */
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      line-height: 1.45;
    }

    /* Centered content frame */
    .frame {
      max-width: var(--frame-max);
      margin: 0 auto;
      padding: 16px var(--gutter);
    }

    header.topbar .frame {
      padding-top: 18px;
      padding-bottom: 10px;
    }

    .top-controls {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 14px;
    }

    .selector {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      min-width: 260px;
    }

    .selector label {
      display: inline-flex;
      gap: 10px;
      align-items: center;
      font-size: 14px;
      color: var(--text);
      margin: 0;
      white-space: nowrap;
    }

    select {
      font-size: 14px;
      padding: 8px 10px;
      border: 1px solid var(--btn-bd);
      background: #fff;
      color: var(--text);
      border-radius: 8px;
      min-width: 240px;
    }

    .paper-meta {
      font-size: 13px;
      color: var(--muted);
      max-width: 520px;
      text-align: right;
    }

    /* Desktop shell: two sibling columns inside centered frame */
    .shell {
      display: grid;
      grid-template-columns: var(--nav-w) minmax(0, 1fr);
      column-gap: var(--gap);
      align-items: start;
      padding-bottom: 80px;
    }

    /* Minimal nav rail */
    aside.nav {
      position: relative;
      min-width: 0;
    }

    .nav-sticky {
      position: sticky;
      top: 16px;
      align-self: start;
    }

    .nav-title {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 8px;
    }

    /* Scrollable nav only when needed, scrollbar hidden, still functional */
    .nav-inner {
      max-height: calc(100vh - 60px);
      overflow-y: auto;
      padding-right: 6px;

      scrollbar-width: none;
      /* Firefox */
      -ms-overflow-style: none;
      /* legacy */
    }

    .nav-inner::-webkit-scrollbar {
      display: none;
    }

    /* WebKit/Blink */

    .nav-inner:focus {
      outline: 2px solid var(--hairline);
      outline-offset: 4px;
      border-radius: 10px;
    }

    .nav-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .nav-item a {
      display: block;
      padding: 4px 0;
      font-size: 14px;
      text-decoration: none;
      color: var(--text);
    }

    .nav-item a:hover {
      text-decoration: underline;
    }

    .nav-item a:focus {
      outline: 2px solid var(--hairline);
      outline-offset: 3px;
      border-radius: 8px;
    }

    .nav-sep {
      margin-top: 12px;
      padding-top: 10px;
      font-size: 12px;
      letter-spacing: 0.08em;
      color: var(--muted);
      text-transform: uppercase;
    }

    /* Paper content */
    .paper {
      min-width: 0;
    }

    .question {
      margin: 0 0 var(--q-gap) 0;
      /* largest spacing unit */
    }

    .q-row {
      display: block;
      min-width: 0;
    }

    .q-label {
      font-weight: 650;
      font-size: 16px;
      margin: 0 0 6px 0;
    }

    .q-body {
      margin: 0;
      padding: 0;
      min-width: 0;
    }

    .q-body p {
      margin: 0 0 8px 0;
    }

    .answer {
      margin-top: var(--inner-gap);
      color: var(--text);
    }

    .answer .subhead,
    .working .subhead {
      font-size: 12.5px;
      color: var(--muted);
      margin: 0 0 6px 0;
    }

    .answer .ansline {
      margin: 0;
      padding: 0;
    }

    .working {
      margin-top: var(--inner-gap);
      min-width: 0;
    }

    .working-toggle {
      margin: 0 0 8px 0;
    }

    .btn {
      appearance: none;
      border: 1px solid var(--btn-bd);
      background: var(--btn-bg);
      color: var(--text);
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 13px;
      cursor: pointer;
    }

    .btn:focus {
      outline: 2px solid var(--hairline);
      outline-offset: 2px;
    }

    /* Workings collapsed: show at most 1–2 lines */
    .working-lines>* {
      margin: 0 0 8px 0;
    }

    .working[data-state="collapsed"] .working-lines> :nth-child(n+3) {
      display: none;
    }

    .working[data-state="collapsed"] .working-lines {
      position: relative;
    }

    .working[data-state="collapsed"] .working-lines::after {
      content: "";
      display: block;
      height: 14px;
      background: linear-gradient(to bottom, rgba(255, 255, 255, 0), rgba(255, 255, 255, 1));
      pointer-events: none;
    }

    /* Indentation for nesting depth (no borders/cards) */
    .indent-0 {
      margin-left: 0;
    }

    .indent-1 {
      margin-left: var(--indent-1);
    }

    .indent-2 {
      margin-left: var(--indent-2);
    }

    /* Diagrams */
    .diagram {
      margin: 8px 0 10px 0;
      width: 100%;
      max-width: 520px;
    }

    .diagram svg {
      width: 100%;
      height: auto;
      display: block;
    }

    /* Math overflow: only within block-level math containers */
    .math-block {
      width: 100%;
      overflow-x: auto;
      overflow-y: hidden;
      -webkit-overflow-scrolling: touch;
      padding: 6px 0;
      max-width: 100%;
    }

    .math-block::-webkit-scrollbar {
      height: 10px;
    }

    .math-block:focus {
      outline: 2px solid var(--hairline);
      outline-offset: 4px;
      border-radius: 10px;
    }

    /* Make sure KaTeX display doesn't force page overflow */
    .katex-display {
      margin: 0;
      text-align: left;
    }

    /* Mobile / small screens */
    .jump-btn {
      display: none;
      position: fixed;
      right: 14px;
      bottom: 14px;
      z-index: 50;
      padding: 11px 12px;
      border-radius: 12px;
    }

    .drawer {
      display: none;
    }

    .drawer[aria-hidden="false"] {
      display: block;
    }

    .drawer-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.28);
      z-index: 60;
    }

    .drawer-panel {
      position: fixed;
      top: 0;
      bottom: 0;
      left: 0;
      width: min(360px, 86vw);
      background: #fff;
      z-index: 61;
      padding: 14px 14px 18px 14px;
      overflow: hidden;
      /* no extra scroll outside nav list */
    }

    .drawer-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--hairline);
    }

    .drawer-title {
      font-size: 13px;
      color: var(--muted);
    }

    .drawer-inner {
      margin-top: 10px;
      max-height: calc(100vh - 74px);
      overflow-y: auto;

      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .drawer-inner::-webkit-scrollbar {
      display: none;
    }

    .drawer-inner:focus {
      outline: 2px solid var(--hairline);
      outline-offset: 4px;
      border-radius: 10px;
    }

    @media (max-width: 920px) {
      :root {
        --gutter: 16px;
        --gap: 20px;
      }

      .shell {
        grid-template-columns: 1fr;
      }

      aside.nav {
        display: none;
        /* drawer replaces rail */
      }

      .paper-meta {
        text-align: left;
        max-width: none;
      }

      .top-controls {
        flex-direction: column;
        align-items: flex-start;
      }

      select {
        min-width: min(520px, 92vw);
      }

      .jump-btn {
        display: inline-block;
      }
    }

    @media (max-width: 520px) {
      :root {
        --indent-1: 14px;
        --indent-2: 26px;
      }

      .q-label {
        font-size: 15px;
      }
    }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="frame">
      <div class="top-controls">
        <div class="selector">
          <label for="paperSelect">
            <span>Paper</span>
            <select id="paperSelect" aria-label="Paper selector"></select>
          </label>
        </div>
        <div class="paper-meta" id="paperMeta"></div>
      </div>
    </div>
  </header>

  <main class="frame" aria-label="Paper view">
    <div class="shell">
      <aside class="nav" id="navRail" aria-label="Navigation rail">
        <div class="nav-sticky">
          <div class="nav-title">Jump to</div>
          <div class="nav-inner" id="navList" tabindex="0" aria-label="Question list (rail)"></div>
        </div>
      </aside>

      <section class="paper" id="paper"></section>
    </div>
  </main>

  <button class="btn jump-btn" id="jumpBtn" type="button" aria-haspopup="dialog" aria-controls="drawer">Jump to</button>

  <div class="drawer" id="drawer" aria-hidden="true">
    <div class="drawer-backdrop" data-close="1" tabindex="-1" aria-label="Close navigation"></div>
    <div class="drawer-panel" role="dialog" aria-modal="true" aria-label="Jump to question">
      <div class="drawer-head">
        <div class="drawer-title">Jump to</div>
        <button class="btn" id="drawerClose" type="button">Close</button>
      </div>
      <div class="drawer-inner" id="drawerList" tabindex="0" aria-label="Question list (drawer)"></div>
    </div>
  </div>

  <!-- KaTeX (CDN) -->
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>

  <script>
    (() => {
      const $ = (sel, root = document) => root.querySelector(sel);
      const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));

      const el = (tag, attrs = {}, children = []) => {
        const node = document.createElement(tag);
        for (const [k, v] of Object.entries(attrs)) {
          if (k === "class") node.className = v;
          else if (k === "html") node.innerHTML = v;
          else if (k.startsWith("data-")) node.setAttribute(k, v);
          else if (k === "text") node.textContent = v;
          else if (k === "tabindex") node.tabIndex = v;
          else if (k === "role") node.setAttribute("role", v);
          else if (k.startsWith("aria-")) node.setAttribute(k, v);
          else node.setAttribute(k, v);
        }
        for (const c of children) node.appendChild(c);
        return node;
      };

      const seg = {
        t: (s) => ({ kind: "text", value: s }),
        im: (expr) => ({ kind: "inlineMath", expr }),
        bm: (expr) => ({ kind: "blockMath", expr }),
        d: (type) => ({ kind: "diagram", type })
      };

      const block = {
        p: (...segments) => ({ kind: "p", segments }),
        bm: (expr) => ({ kind: "blockMath", expr }),
        d: (type) => ({ kind: "diagram", type })
      };

      function safeId(s) {
        return String(s).replace(/[^a-zA-Z0-9]+/g, "_");
      }

      const DiagramSVG = {
        geometry: () => `
          <svg viewBox="0 0 520 260" aria-label="Geometry diagram" role="img">
            <rect x="1" y="1" width="518" height="258" fill="none" stroke="#bdbdbd" />
            <polygon points="90,200 260,50 430,200" fill="none" stroke="#111" stroke-width="2"/>
            <circle cx="260" cy="140" r="56" fill="none" stroke="#111" stroke-width="2"/>
            <text x="252" y="40" font-size="16" fill="#111">A</text>
            <text x="72" y="220" font-size="16" fill="#111">B</text>
            <text x="438" y="220" font-size="16" fill="#111">C</text>
            <line x1="260" y1="50" x2="260" y2="200" stroke="#111" stroke-dasharray="6 5"/>
            <text x="272" y="132" font-size="14" fill="#111">r</text>
          </svg>
        `,
        bars: () => `
          <svg viewBox="0 0 520 220" aria-label="Ratio bars diagram" role="img">
            <rect x="1" y="1" width="518" height="218" fill="none" stroke="#bdbdbd" />
            <text x="18" y="32" font-size="14" fill="#111">Ratio bars</text>
            <rect x="60" y="70" width="360" height="34" fill="none" stroke="#111" stroke-width="2"/>
            <line x1="180" y1="70" x2="180" y2="104" stroke="#111" stroke-width="2"/>
            <line x1="300" y1="70" x2="300" y2="104" stroke="#111" stroke-width="2"/>
            <text x="64" y="62" font-size="12" fill="#111">A</text>
            <text x="184" y="62" font-size="12" fill="#111">B</text>
            <text x="304" y="62" font-size="12" fill="#111">C</text>

            <rect x="60" y="130" width="300" height="34" fill="none" stroke="#111" stroke-width="2"/>
            <line x1="160" y1="130" x2="160" y2="164" stroke="#111" stroke-width="2"/>
            <line x1="260" y1="130" x2="260" y2="164" stroke="#111" stroke-width="2"/>
            <text x="64" y="122" font-size="12" fill="#111">D</text>
            <text x="164" y="122" font-size="12" fill="#111">E</text>
            <text x="264" y="122" font-size="12" fill="#111">F</text>
          </svg>
        `,
        coord: () => `
          <svg viewBox="0 0 520 260" aria-label="Coordinate grid diagram" role="img">
            <rect x="1" y="1" width="518" height="258" fill="none" stroke="#bdbdbd" />
            <g stroke="#d0d0d0">
              ${Array.from({ length: 10 }).map((_, i) => `<line x1="${60 + i * 40}" y1="40" x2="${60 + i * 40}" y2="220"/>`).join("")}
              ${Array.from({ length: 5 }).map((_, i) => `<line x1="60" y1="${60 + i * 40}" x2="460" y2="${60 + i * 40}"/>`).join("")}
            </g>
            <g stroke="#111" stroke-width="2">
              <line x1="60" y1="220" x2="460" y2="220"/>
              <line x1="60" y1="220" x2="60" y2="40"/>
            </g>
            <polyline points="80,200 160,170 240,140 320,110 400,80" fill="none" stroke="#111" stroke-width="2"/>
            <circle cx="240" cy="140" r="5" fill="#111"/>
            <text x="250" y="135" font-size="14" fill="#111">(3,2)</text>
          </svg>
        `,
        grid: () => `
          <svg viewBox="0 0 520 220" aria-label="Table grid diagram" role="img">
            <rect x="1" y="1" width="518" height="218" fill="none" stroke="#bdbdbd" />
            <text x="18" y="32" font-size="14" fill="#111">Table</text>
            <g stroke="#111" fill="none">
              <rect x="90" y="60" width="340" height="130" stroke-width="2"/>
              ${Array.from({ length: 4 }).map((_, i) => `<line x1="${90 + (i + 1) * 68}" y1="60" x2="${90 + (i + 1) * 68}" y2="190" stroke-width="2"/>`).join("")}
              ${Array.from({ length: 2 }).map((_, i) => `<line x1="90" y1="${60 + (i + 1) * 43.3333}" x2="430" y2="${60 + (i + 1) * 43.3333}" stroke-width="2"/>`).join("")}
            </g>
            <text x="110" y="88" font-size="12" fill="#111">x</text>
            <text x="110" y="132" font-size="12" fill="#111">y</text>
            <text x="110" y="175" font-size="12" fill="#111">z</text>
          </svg>
        `
      };

      function renderSegments(segments, parent) {
        for (const s of segments) {
          if (s.kind === "text") {
            parent.appendChild(document.createTextNode(s.value));
          } else if (s.kind === "inlineMath") {
            const span = el("span", {
              class: "math-inline",
              "data-math": s.expr,
              "data-display": "false",
              text: s.expr
            });
            parent.appendChild(span);
          } else if (s.kind === "blockMath") {
            const div = el("div", {
              class: "math-block",
              tabindex: 0,
              "data-math": s.expr,
              "data-display": "true",
              text: s.expr
            });
            parent.appendChild(div);
          } else if (s.kind === "diagram") {
            const wrap = el("div", { class: "diagram", html: DiagramSVG[s.type]?.() || "" });
            parent.appendChild(wrap);
          }
        }
      }

      function renderBlocks(blocks, parent) {
        for (const b of blocks) {
          if (b.kind === "p") {
            const p = el("p");
            renderSegments(b.segments, p);
            parent.appendChild(p);
          } else if (b.kind === "blockMath") {
            const div = el("div", {
              class: "math-block",
              tabindex: 0,
              "data-math": b.expr,
              "data-display": "true",
              text: b.expr
            });
            parent.appendChild(div);
          } else if (b.kind === "diagram") {
            parent.appendChild(el("div", { class: "diagram", html: DiagramSVG[b.type]?.() || "" }));
          }
        }
      }

      function tryRenderKatex(root) {
        const hasKatex = typeof window.katex !== "undefined" && window.katex && typeof window.katex.render === "function";
        if (!hasKatex) return false;

        const nodes = $$("[data-math]", root);
        for (const n of nodes) {
          if (n.getAttribute("data-katex-rendered") === "1") continue;

          const expr = n.getAttribute("data-math") || "";
          const displayMode = (n.getAttribute("data-display") || "false") === "true";

          try {
            window.katex.render(expr, n, { displayMode, throwOnError: false });
            n.setAttribute("data-katex-rendered", "1");
          } catch (e) {
            // graceful fallback: keep plain text, do not hide content
            n.textContent = expr;
            n.setAttribute("data-katex-rendered", "0");
          }
        }
        return true;
      }

      function renderKatexWithRetry(root, tries = 10) {
        // always keep content visible; replace when/if KaTeX becomes available
        let count = 0;
        const tick = () => {
          const ok = tryRenderKatex(root);
          count++;
          if (ok || count >= tries) return;
          setTimeout(tick, 200);
        };
        tick();
      }

      function genLongMathLines(n, seed = 1) {
        const lines = [];
        for (let i = 0; i < n; i++) {
          const k = (i + seed) % 8;
          const exprs = [
            String.raw`\frac{(12x^2-7x+1)(x-3)}{(x-3)} = 12x^2-7x+1`,
            String.raw`2(3x-5) - (x+7) = 5x - 17`,
            String.raw`(x+4)^2 = x^2 + 8x + 16`,
            String.raw`\frac{5}{8} + \frac{3}{16} = \frac{13}{16}`,
            String.raw`x_{n+1} = 2x_n + 1,\quad x_0=3`,
            String.raw`A = \pi r^2,\quad r=\frac{21}{4}`,
            String.raw`3x^2 - 14x + 8 = 0,\quad x=\frac{14\pm\sqrt{196-96}}{6}`,
            String.raw`\sqrt{49a^2b^4} = 7ab^2`
          ];
          lines.push(block.bm(exprs[k]));
        }
        return lines;
      }

      function makeQuestionItem({ id, label, depth = 0, promptBlocks, answerBlocks, workingBlocks, defaultWorkingExpanded = false }) {
        return {
          type: "question",
          id,
          label,
          depth,
          promptBlocks,
          answerBlocks,
          workingBlocks,
          defaultWorkingExpanded
        };
      }

      function buildShortPaper() {
        const qs = [
          makeQuestionItem({
            id: "1",
            label: "1",
            depth: 0,
            promptBlocks: [
              block.p(seg.t("Calculate "), seg.im(String.raw`37 + 58`), seg.t("."))
            ],
            answerBlocks: [
              block.p(seg.im(String.raw`95`))
            ],
            workingBlocks: [
              block.p(seg.t("Add tens and ones: "), seg.im(String.raw`(30+50) + (7+8)`), seg.t(".")),
              block.bm(String.raw`37 + 58 = 95`),
              block.p(seg.t("Check by subtraction: "), seg.im(String.raw`95 - 58 = 37`), seg.t("."))
            ]
          }),

          makeQuestionItem({
            id: "2",
            label: "2",
            depth: 0,
            promptBlocks: [
              block.p(seg.t("Work out "), seg.im(String.raw`\frac{3}{4} + \frac{1}{8}`), seg.t("."))
            ],
            answerBlocks: [
              block.p(seg.im(String.raw`\frac{7}{8}`))
            ],
            workingBlocks: [
              block.p(seg.t("Use a common denominator.")),
              block.bm(String.raw`\frac{3}{4} = \frac{6}{8}`),
              block.bm(String.raw`\frac{6}{8} + \frac{1}{8} = \frac{7}{8}`)
            ]
          }),

          // Multi-part
          makeQuestionItem({
            id: "3",
            label: "3",
            depth: 0,
            promptBlocks: [
              block.p(seg.t("A shop sells pencils in packs.")),
              block.d("bars"),
              block.p(seg.t("3(a) If 1 pack has 6 pencils, how many pencils are in 4 packs?"))
            ],
            answerBlocks: [
              block.p(seg.im(String.raw`24`))
            ],
            workingBlocks: [
              block.bm(String.raw`4 \times 6 = 24`),
              block.p(seg.t("So there are 24 pencils."))
            ]
          }),

          makeQuestionItem({
            id: "3b",
            label: "3b",
            depth: 1,
            promptBlocks: [
              block.p(seg.t("3(b) Each pencil costs 15p. What is the cost of 24 pencils?"))
            ],
            answerBlocks: [
              block.p(seg.im(String.raw`360\text{p} = £3.60`))
            ],
            workingBlocks: [
              block.bm(String.raw`24 \times 15 = 24\times(10+5) = 240 + 120 = 360`),
              block.p(seg.t("Convert pence to pounds: "), seg.im(String.raw`360\text{p} = £3.60`), seg.t("."))
            ]
          }),

          makeQuestionItem({
            id: "4",
            label: "4",
            depth: 0,
            promptBlocks: [
              block.p(seg.t("On the coordinate grid, a line passes through the points shown.")),
              block.d("coord"),
              block.p(seg.t("Give one point that lies on the line."))
            ],
            answerBlocks: [
              block.p(seg.t("Example: "), seg.im(String.raw`(3,2)`))
            ],
            workingBlocks: [
              block.p(seg.t("Read a plotted point from the grid (any correct point on the line is accepted).")),
              block.p(seg.t("Example point: "), seg.im(String.raw`(3,2)`))
            ]
          }),

          makeQuestionItem({
            id: "5",
            label: "5",
            depth: 0,
            promptBlocks: [
              block.p(seg.t("A rectangle has perimeter 30 cm. Its length is 9 cm.")),
              block.p(seg.t("Find its width."))
            ],
            answerBlocks: [
              block.p(seg.im(String.raw`6\text{ cm}`))
            ],
            workingBlocks: [
              block.bm(String.raw`P = 2(\ell + w)`),
              block.bm(String.raw`30 = 2(9 + w)`),
              block.bm(String.raw`15 = 9 + w`),
              block.bm(String.raw`w = 6`)
            ]
          }),

          makeQuestionItem({
            id: "6",
            label: "6",
            depth: 0,
            promptBlocks: [
              block.p(seg.t("Simplify "), seg.im(String.raw`4a + 7a - 3a`), seg.t("."))
            ],
            answerBlocks: [
              block.p(seg.im(String.raw`8a`))
            ],
            workingBlocks: [
              block.p(seg.t("Combine like terms.")),
              block.bm(String.raw`4a + 7a - 3a = (4+7-3)a = 8a`)
            ]
          })
        ];

        return {
          key: "short",
          name: "Short paper",
          description: "6 questions; mix of short arithmetic and one multi-part question.",
          items: qs
        };
      }

      function buildStandardPaper(allWorkingsExpanded = false) {
        const items = [];

        function shortWorking(i) {
          return [
            block.p(seg.t("Write down what is given, then calculate.")),
            block.bm(String.raw`${i}+${i + 3}=${2 * i + 3}`),
            block.p(seg.t("So the result is "), seg.im(String.raw`${2 * i + 3}`), seg.t("."))
          ];
        }

        // Q1–Q17
        for (let i = 1; i <= 17; i++) {
          items.push(makeQuestionItem({
            id: String(i),
            label: String(i),
            depth: 0,
            promptBlocks: [
              block.p(seg.t("Calculate "), seg.im(String.raw`${10 + i} + ${20 + i}`), seg.t("."))
            ],
            answerBlocks: [
              block.p(seg.im(String.raw`${(10 + i) + (20 + i)}`))
            ],
            workingBlocks: shortWorking(i),
            defaultWorkingExpanded: allWorkingsExpanded
          }));
        }

        // Deep nesting: Q18(a)(i), Q18(a)(ii), Q18(b)
        items.push(makeQuestionItem({
          id: "18",
          label: "18",
          depth: 0,
          promptBlocks: [
            block.p(seg.t("A sequence is defined by "), seg.im(String.raw`x_{n+1}=2x_n+1`), seg.t(" with "), seg.im(String.raw`x_0=3`), seg.t("."))
          ],
          answerBlocks: [
            block.p(seg.t("See parts (a) and (b)."))
          ],
          workingBlocks: [
            block.p(seg.t("Use the rule to generate terms."))
          ],
          defaultWorkingExpanded: allWorkingsExpanded
        }));

        items.push(makeQuestionItem({
          id: "18a",
          label: "18a",
          depth: 1,
          promptBlocks: [
            block.p(seg.t("18(a) Find "), seg.im(String.raw`x_1`), seg.t(" and "), seg.im(String.raw`x_2`), seg.t("."))
          ],
          answerBlocks: [
            block.p(seg.im(String.raw`x_1=7,\; x_2=15`))
          ],
          workingBlocks: [
            block.bm(String.raw`x_1 = 2x_0 + 1 = 2\cdot 3 + 1 = 7`),
            block.bm(String.raw`x_2 = 2x_1 + 1 = 2\cdot 7 + 1 = 15`),
            block.p(seg.t("So "), seg.im(String.raw`x_1=7`), seg.t(" and "), seg.im(String.raw`x_2=15`), seg.t("."))
          ],
          defaultWorkingExpanded: allWorkingsExpanded
        }));

        items.push(makeQuestionItem({
          id: "18a(i)",
          label: "18a(i)",
          depth: 2,
          promptBlocks: [
            block.p(seg.t("18(a)(i) Show that "), seg.im(String.raw`x_3=31`), seg.t("."))
          ],
          answerBlocks: [
            block.p(seg.im(String.raw`31`))
          ],
          workingBlocks: [
            block.bm(String.raw`x_3 = 2x_2 + 1 = 2\cdot 15 + 1 = 31`)
          ],
          defaultWorkingExpanded: allWorkingsExpanded
        }));

        items.push(makeQuestionItem({
          id: "18a(ii)",
          label: "18a(ii)",
          depth: 2,
          promptBlocks: [
            block.p(seg.t("18(a)(ii) Write an expression for "), seg.im(String.raw`x_{n+1} - 2x_n`), seg.t("."))
          ],
          answerBlocks: [
            block.p(seg.im(String.raw`1`))
          ],
          workingBlocks: [
            block.bm(String.raw`x_{n+1} = 2x_n + 1`),
            block.bm(String.raw`x_{n+1} - 2x_n = 1`)
          ],
          defaultWorkingExpanded: allWorkingsExpanded
        }));

        items.push(makeQuestionItem({
          id: "18b",
          label: "18b",
          depth: 1,
          promptBlocks: [
            block.p(seg.t("18(b) Explain why the sequence is increasing."))
          ],
          answerBlocks: [
            block.p(seg.t("Each term is double the previous term plus 1, so it is always larger."))
          ],
          workingBlocks: [
            block.p(seg.t("Because "), seg.im(String.raw`x_{n+1}=2x_n+1`), seg.t(" and "), seg.im(String.raw`2x_n+1>x_n`), seg.t(" for all positive "), seg.im(String.raw`x_n`), seg.t("."))
          ],
          defaultWorkingExpanded: allWorkingsExpanded
        }));

        // Q19–Q25
        for (let i = 19; i <= 25; i++) {
          // include one question that has no parent-level prompt (simulate by making it look like a subpart label)
          const lbl = String(i);
          items.push(makeQuestionItem({
            id: lbl,
            label: lbl,
            depth: 0,
            promptBlocks: [
              block.p(seg.t("Work out "), seg.im(String.raw`\frac{${i % 7 + 1}}{8} + \frac{${(i + 2) % 7 + 1}}{16}`), seg.t("."))
            ],
            answerBlocks: [
              block.p(seg.t("A simplified fraction."))
            ],
            workingBlocks: [
              block.p(seg.t("Use a common denominator of 16.")),
              block.bm(String.raw`\frac{a}{8}=\frac{2a}{16}`),
              block.p(seg.t("Add the numerators, then simplify if possible."))
            ],
            defaultWorkingExpanded: allWorkingsExpanded
          }));
        }

        // Q26–Q35 long algebra questions (collapsed by default unless variant)
        for (let i = 26; i <= 35; i++) {
          const isVeryLong = (i === 33 || i === 35);
          const isLong = (i >= 26 && i <= 35);

          const work = [];
          work.push(block.p(seg.t("Rearrange and simplify step by step.")));
          work.push(block.bm(String.raw`2(3x-5) - (x+7) = 5x - 17`));
          work.push(block.bm(String.raw`6x-10-x-7 = 5x-17`));
          work.push(block.bm(String.raw`5x-17 = 5x-17`));
          work.push(block.p(seg.t("This shows the expressions match for all "), seg.im(String.raw`x`), seg.t(".")));

          // add multiple KaTeX block placeholders
          work.push(block.bm(String.raw`(x+4)^2 = x^2 + 8x + 16`));
          work.push(block.bm(String.raw`\frac{(12x^2-7x+1)(x-3)}{(x-3)}`));

          if (isVeryLong) {
            work.push(block.p(seg.t("Extended working (stress test):")));
            work.push(...genLongMathLines(60, i));
          } else if (i === 34) {
            work.push(block.p(seg.t("Long working (stress test):")));
            work.push(...genLongMathLines(28, i));
          } else if (isLong) {
            work.push(block.p(seg.t("Extra steps:")));
            work.push(...genLongMathLines(10, i));
          }

          items.push(makeQuestionItem({
            id: String(i),
            label: String(i),
            depth: 0,
            promptBlocks: [
              block.p(seg.t("Solve and simplify: "), seg.im(String.raw`2(3x-5) - (x+7)`), seg.t(".")),
              block.p(seg.t("State the simplest form."))
            ],
            answerBlocks: [
              block.p(seg.im(String.raw`5x - 17`))
            ],
            workingBlocks: work,
            defaultWorkingExpanded: allWorkingsExpanded
          }));
        }

        // Deep nesting: Q30(a)(i), Q30(a)(ii), Q30(b) (inserted already as Q30 in loop above; keep separate by replacing)
        // Replace the earlier generated Q30 item (if any) by removing it and inserting nested structure.
        const idx30 = items.findIndex(x => x.type === "question" && x.id === "30");
        if (idx30 !== -1) items.splice(idx30, 1);

        // Remove Q31–Q35 if their order got disturbed by replacement (we keep them as-is).
        // Insert nested Q30 structure before Q31.
        const idx31 = items.findIndex(x => x.type === "question" && x.id === "31");
        const insertAt = idx31 === -1 ? items.length : idx31;

        const q30Group = [
          makeQuestionItem({
            id: "30",
            label: "30",
            depth: 0,
            promptBlocks: [
              block.p(seg.t("A right-angled triangle has legs "), seg.im(String.raw`6`), seg.t(" and "), seg.im(String.raw`8`), seg.t(".")),
              block.d("geometry"),
              block.p(seg.t("Answer parts (a) and (b)."))
            ],
            answerBlocks: [
              block.p(seg.t("See parts (a) and (b)."))
            ],
            workingBlocks: [
              block.p(seg.t("Use Pythagoras’ theorem where needed."))
            ],
            defaultWorkingExpanded: allWorkingsExpanded
          }),
          makeQuestionItem({
            id: "30a",
            label: "30a",
            depth: 1,
            promptBlocks: [
              block.p(seg.t("30(a) Find the hypotenuse length.")),
            ],
            answerBlocks: [
              block.p(seg.im(String.raw`10`))
            ],
            workingBlocks: [
              block.bm(String.raw`c^2 = 6^2 + 8^2 = 36 + 64 = 100`),
              block.bm(String.raw`c = \sqrt{100} = 10`)
            ],
            defaultWorkingExpanded: allWorkingsExpanded
          }),
          makeQuestionItem({
            id: "30a(i)",
            label: "30a(i)",
            depth: 2,
            promptBlocks: [
              block.p(seg.t("30(a)(i) Show your calculation for "), seg.im(String.raw`6^2 + 8^2`), seg.t("."))
            ],
            answerBlocks: [
              block.p(seg.im(String.raw`100`))
            ],
            workingBlocks: [
              block.bm(String.raw`6^2 + 8^2 = 36 + 64 = 100`)
            ],
            defaultWorkingExpanded: allWorkingsExpanded
          }),
          makeQuestionItem({
            id: "30a(ii)",
            label: "30a(ii)",
            depth: 2,
            promptBlocks: [
              block.p(seg.t("30(a)(ii) Write "), seg.im(String.raw`\sqrt{100}`), seg.t(" as an integer."))
            ],
            answerBlocks: [
              block.p(seg.im(String.raw`10`))
            ],
            workingBlocks: [
              block.p(seg.t("The square root of 100 is 10.")),
              block.bm(String.raw`\sqrt{100} = 10`)
            ],
            defaultWorkingExpanded: allWorkingsExpanded
          }),
          makeQuestionItem({
            id: "30b",
            label: "30b",
            depth: 1,
            promptBlocks: [
              block.p(seg.t("30(b) The triangle is enlarged by scale factor "), seg.im(String.raw`3`), seg.t(". Find the new hypotenuse."))
            ],
            answerBlocks: [
              block.p(seg.im(String.raw`30`))
            ],
            workingBlocks: [
              block.p(seg.t("Lengths scale by the scale factor.")),
              block.bm(String.raw`10 \times 3 = 30`)
            ],
            defaultWorkingExpanded: allWorkingsExpanded
          })
        ];

        items.splice(insertAt, 0, ...q30Group);

        return {
          key: allWorkingsExpanded ? "standard_expanded" : "standard",
          name: allWorkingsExpanded ? "Standard (Workings Expanded)" : "Standard paper",
          description: allWorkingsExpanded
            ? "Same as Standard paper; all workings start expanded (dataset variant only)."
            : "35 top-level questions; Q26–Q35 long algebra questions (workings collapsed by default).",
          items
        };
      }

      function buildDiagramHeavyPaper() {
        const diagramIds = new Set([2, 4, 6, 8, 11, 13, 15, 18]);
        const types = ["geometry", "bars", "coord", "grid"];
        const items = [];

        for (let i = 1; i <= 20; i++) {
          const hasDiagram = diagramIds.has(i);
          const diagType = types[i % types.length];

          const prompt = [
            block.p(seg.t("Answer the question below.")),
            ...(hasDiagram ? [block.d(diagType)] : []),
            block.p(
              seg.t("Work out "),
              seg.im(String.raw`\frac{${(i % 7) + 1}}{${(i % 5) + 4}}`),
              seg.t(" of "),
              seg.im(String.raw`${(i + 2) * 6}`),
              seg.t(".")
            )
          ];

          const working = [
            block.p(seg.t("Convert the fraction if needed, then multiply.")),
            block.bm(String.raw`\frac{a}{b}\times N = \frac{aN}{b}`),
            block.p(seg.t("Simplify the fraction or result if possible.")),
            ...(hasDiagram ? [block.p(seg.t("Use the diagram only if it helps you interpret the situation."))] : [])
          ];

          items.push(makeQuestionItem({
            id: String(i),
            label: String(i),
            depth: 0,
            promptBlocks: prompt,
            answerBlocks: [
              block.p(seg.t("A single number or simplified fraction."))
            ],
            workingBlocks: working
          }));
        }

        return {
          key: "diagram_heavy",
          name: "Diagram-heavy paper",
          description: "20 questions; 8 questions contain diagrams (inline SVG placeholders).",
          items
        };
      }

      function buildSectionedPaper() {
        const items = [];
        const addSep = (label) => items.push({ type: "section", label });

        addSep("Section A");
        for (let i = 1; i <= 35; i++) {
          items.push(makeQuestionItem({
            id: String(i),
            label: String(i),
            depth: 0,
            promptBlocks: [
              block.p(seg.t("Calculate "), seg.im(String.raw`${i * 2} + ${i + 9}`), seg.t("."))
            ],
            answerBlocks: [
              block.p(seg.im(String.raw`${i * 2 + i + 9}`))
            ],
            workingBlocks: [
              block.p(seg.t("Add the numbers.")),
              block.bm(String.raw`${i * 2} + ${i + 9} = ${i * 3 + 9}`)
            ]
          }));
        }

        addSep("Section B");
        for (let i = 36; i <= 43; i++) {
          items.push(makeQuestionItem({
            id: String(i),
            label: String(i),
            depth: 0,
            promptBlocks: [
              block.p(seg.t("A table shows values of "), seg.im(String.raw`x`), seg.t(", "), seg.im(String.raw`y`), seg.t(", "), seg.im(String.raw`z`), seg.t(".")),
              block.d("grid"),
              block.p(seg.t("Give one relationship that could fit the table."))
            ],
            answerBlocks: [
              block.p(seg.t("Example: "), seg.im(String.raw`y = 2x + 1`))
            ],
            workingBlocks: [
              block.p(seg.t("Compare differences and try a simple rule.")),
              block.bm(String.raw`y - 2x = 1`)
            ]
          }));
        }

        addSep("Section C");
        for (let i = 44; i <= 49; i++) {
          const work = [
            block.p(seg.t("Very long working (stress test):")),
            ...genLongMathLines(55, i),
            block.p(seg.t("Conclude with the simplest form."))
          ];
          items.push(makeQuestionItem({
            id: String(i),
            label: String(i),
            depth: 0,
            promptBlocks: [
              block.p(seg.t("Simplify the expression and show full working:")),
              block.bm(String.raw`\frac{(12x^2-7x+1)(x-3)}{(x-3)}`),
              block.p(seg.t("Write your final answer in simplest form."))
            ],
            answerBlocks: [
              block.p(seg.im(String.raw`12x^2 - 7x + 1`))
            ],
            workingBlocks: work
          }));
        }

        return {
          key: "sectioned",
          name: "Sectioned paper",
          description: "Original paper structure: Section A (35), Section B (8), Section C (6; very long workings).",
          items
        };
      }

      const Papers = [
        buildShortPaper(),
        buildStandardPaper(false),
        buildDiagramHeavyPaper(),
        buildSectionedPaper(),
        buildStandardPaper(true)
      ];

      const byKey = Object.fromEntries(Papers.map(p => [p.key, p]));

      const paperSelect = $("#paperSelect");
      const paperMeta = $("#paperMeta");
      const paperRoot = $("#paper");
      const navRailList = $("#navList");
      const drawerList = $("#drawerList");

      const drawer = $("#drawer");
      const jumpBtn = $("#jumpBtn");
      const drawerClose = $("#drawerClose");

      function setBodyScrollLocked(locked) {
        document.body.style.overflow = locked ? "hidden" : "";
      }

      function openDrawer() {
        drawer.setAttribute("aria-hidden", "false");
        setBodyScrollLocked(true);
        setTimeout(() => drawerList.focus(), 0);
      }
      function closeDrawer() {
        drawer.setAttribute("aria-hidden", "true");
        setBodyScrollLocked(false);
        jumpBtn.focus();
      }

      jumpBtn.addEventListener("click", openDrawer);
      drawerClose.addEventListener("click", closeDrawer);
      drawer.addEventListener("click", (e) => {
        const t = e.target;
        if (t && t.getAttribute && t.getAttribute("data-close") === "1") closeDrawer();
      });
      window.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && drawer.getAttribute("aria-hidden") === "false") closeDrawer();
      });

      function makeNavList(items, targetContainer) {
        const ul = el("ul", { class: "nav-list" });

        for (const it of items) {
          if (it.type === "section") {
            ul.appendChild(el("li", { class: "nav-sep", text: it.label }));
            continue;
          }
          const id = `q_${safeId(it.id)}`;
          const a = el("a", {
            href: `#${id}`,
            text: it.label,
            "aria-label": `Jump to question ${it.label}`
          });

          a.addEventListener("click", (ev) => {
            ev.preventDefault();
            const target = document.getElementById(id);
            if (target) {
              target.scrollIntoView({ behavior: "smooth", block: "start" });
            }
            if (targetContainer === drawerList) closeDrawer();
          });

          ul.appendChild(el("li", { class: "nav-item" }, [a]));
        }

        targetContainer.innerHTML = "";
        targetContainer.appendChild(ul);

        // keyboard scrolling support for nav region
        targetContainer.addEventListener("keydown", (e) => {
          const step = 40;
          if (e.key === "ArrowDown") { targetContainer.scrollTop += step; e.preventDefault(); }
          if (e.key === "ArrowUp") { targetContainer.scrollTop -= step; e.preventDefault(); }
          if (e.key === "PageDown") { targetContainer.scrollTop += step * 6; e.preventDefault(); }
          if (e.key === "PageUp") { targetContainer.scrollTop -= step * 6; e.preventDefault(); }
          if (e.key === "Home") { targetContainer.scrollTop = 0; e.preventDefault(); }
          if (e.key === "End") { targetContainer.scrollTop = targetContainer.scrollHeight; e.preventDefault(); }
        }, { once: true });
      }

      function renderQuestion(item) {
        const qId = `q_${safeId(item.id)}`;
        const wrap = el("article", { class: `question indent-${item.depth}`, id: qId });

        const label = el("div", { class: "q-label", text: `Q${item.label}` });
        const body = el("div", { class: "q-body" });

        // Question prompt (always visible)
        renderBlocks(item.promptBlocks, body);

        // Answer (visible by default)
        const ans = el("div", { class: "answer" });
        ans.appendChild(el("div", { class: "subhead", text: "Answer" }));
        renderBlocks(item.answerBlocks, ans);

        // Working (collapsed by default unless dataset variant)
        const working = el("div", {
          class: "working",
          "data-state": item.defaultWorkingExpanded ? "expanded" : "collapsed"
        });

        working.appendChild(el("div", { class: "subhead", text: "Working" }));

        const toggleWrap = el("div", { class: "working-toggle" });
        const btn = el("button", {
          class: "btn",
          type: "button",
          "aria-expanded": item.defaultWorkingExpanded ? "true" : "false",
          text: item.defaultWorkingExpanded ? "Hide working" : "Show working"
        });
        toggleWrap.appendChild(btn);
        working.appendChild(toggleWrap);

        const lines = el("div", { class: "working-lines" });
        renderBlocks(item.workingBlocks, lines);
        working.appendChild(lines);

        btn.addEventListener("click", () => {
          const expanded = working.getAttribute("data-state") === "expanded";
          working.setAttribute("data-state", expanded ? "collapsed" : "expanded");
          btn.setAttribute("aria-expanded", expanded ? "false" : "true");
          btn.textContent = expanded ? "Show working" : "Hide working";
        });

        wrap.appendChild(label);
        wrap.appendChild(body);
        wrap.appendChild(ans);
        wrap.appendChild(working);

        return wrap;
      }

      function renderPaper(paper) {
        // Meta
        const topLevelCount = paper.items.filter(x => x.type === "question" && String(x.id).match(/^\d+$/)).length;
        const totalNavCount = paper.items.filter(x => x.type === "question").length;

        paperMeta.textContent = `${paper.description}  •  Top-level: ${topLevelCount}  •  Nav items: ${totalNavCount}`;

        // Navs (rail + drawer)
        makeNavList(paper.items, navRailList);
        makeNavList(paper.items, drawerList);

        // Content
        paperRoot.innerHTML = "";
        for (const it of paper.items) {
          if (it.type === "section") {
            // Section labels appear only as plain-text separators (non-clickable)
            const sep = el("div", {
              class: "question",
              html: `<div class="q-label" style="font-weight:650;">${it.label}</div>`
            });
            paperRoot.appendChild(sep);
            continue;
          }
          paperRoot.appendChild(renderQuestion(it));
        }

        // KaTeX rendering
        renderKatexWithRetry(paperRoot);
      }

      function initSelector() {
        paperSelect.innerHTML = "";
        for (const p of Papers) {
          paperSelect.appendChild(el("option", { value: p.key, text: p.name }));
        }

        paperSelect.addEventListener("change", () => {
          const p = byKey[paperSelect.value];
          if (!p) return;
          renderPaper(p);
          // switching papers must hide/show content and rebuild navigation accordingly
          // and must not auto-expand/collapse beyond defaults (re-render applies defaults)
        });
      }

      // Init
      initSelector();
      paperSelect.value = "short";
      renderPaper(byKey[paperSelect.value]);

      // Ensure KaTeX replaces text if it loads later
      window.addEventListener("load", () => {
        renderKatexWithRetry(document, 8);
      });
    })();
  </script>
</body>

</html>