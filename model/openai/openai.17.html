<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>RTQ – Maths Paper Solution Viewer (Stress Test)</title>

    <!-- KaTeX (CDN) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">

    <style>
        :root {
            /* Centered frame + two-column desktop layout */
            --frame-max: 1080px;
            --frame-pad: 16px;
            --nav-w: 220px;
            --paper-max: 840px;

            /* Rhythm */
            --q-gap: 28px;
            /* largest spacing unit between top-level questions */
            --in-gap: 10px;
            /* within-question spacing */
            --indent-1: 18px;
            --indent-2: 34px;
            --indent-3: 50px;

            /* Grayscale */
            --text: #111;
            --muted: #555;
            --hair: #d7d7d7;
            --bg: #fff;
        }

        * {
            box-sizing: border-box;
        }

        html {
            scroll-behavior: auto;
        }

        body {
            margin: 0;
            color: var(--text);
            background: var(--bg);
            line-height: 1.35;
            overflow-x: hidden;
            /* main document must never scroll horizontally */
        }

        /* Top control area aligned to centered frame */
        .topbar {
            position: sticky;
            top: 0;
            z-index: 50;
            background: var(--bg);
            border-bottom: 1px solid var(--hair);
        }

        .topbar-inner {
            max-width: var(--frame-max);
            margin: 0 auto;
            padding: 10px var(--frame-pad);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            flex-wrap: wrap;
        }

        .controls {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        label {
            font-size: 14px;
            color: var(--muted);
        }

        select,
        button {
            font: inherit;
            color: inherit;
            background: transparent;
            border: 1px solid var(--hair);
            border-radius: 6px;
            padding: 6px 10px;
            cursor: pointer;
        }

        select:focus,
        button:focus,
        a:focus {
            outline: 2px solid #000;
            outline-offset: 2px;
        }

        .jump-btn {
            display: inline-block;
        }

        /* Centered frame with two sibling columns on desktop */
        .frame {
            max-width: var(--frame-max);
            margin: 0 auto;
            padding: 0 var(--frame-pad) 80px var(--frame-pad);
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
        }

        /* Desktop nav rail: sticky, minimal chrome, can scroll if exceeds viewport */
        .nav {
            display: none;
        }

        .nav-rail {
            position: sticky;
            top: 52px;
            /* below topbar */
            height: calc(100vh - 52px);
            overflow-y: auto;
            /* permitted only for navigation list when needed */
            padding: 12px 10px 12px 0;
            border-right: 1px solid var(--hair);

            /* hide scrollbar but keep scrolling functional */
            scrollbar-width: none;
            /* Firefox */
            -ms-overflow-style: none;
            /* legacy */
        }

        .nav-rail::-webkit-scrollbar {
            display: none;
        }

        /* WebKit/Blink */

        .nav-title {
            margin: 0 0 10px 0;
            font-size: 13px;
            color: var(--muted);
        }

        .nav-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .nav-item a {
            display: inline-block;
            text-decoration: none;
            color: inherit;
            font-size: 14px;
            padding: 2px 4px;
            border-radius: 4px;
        }

        .nav-item a:hover {
            text-decoration: underline;
        }

        .nav-sep {
            font-size: 12px;
            color: var(--muted);
            margin: 10px 0 2px 0;
        }

        /* Paper column */
        .paper-col {
            min-width: 0;
            /* allow math containers to scroll instead of forcing layout wider */
        }

        .paper {
            max-width: var(--paper-max);
        }

        /* Question blocks: spacing-only rhythm (no cards/panels) */
        .q {
            margin: 0 0 var(--q-gap) 0;
        }

        .q-head {
            display: flex;
            gap: 10px;
            align-items: baseline;
        }

        .q-num {
            font-weight: 700;
            min-width: 44px;
            flex: 0 0 auto;
        }

        .q-prompt {
            margin: 0;
        }

        .q-body {
            margin-top: var(--in-gap);
        }

        .indent-1 {
            margin-left: var(--indent-1);
        }

        .indent-2 {
            margin-left: var(--indent-2);
        }

        .indent-3 {
            margin-left: var(--indent-3);
        }

        .answer {
            margin: 0 0 var(--in-gap) 0;
        }

        .label {
            color: var(--muted);
            font-size: 13px;
            margin-right: 6px;
            display: inline-block;
        }

        /* Expand/collapse control */
        .toggle {
            margin: 0 0 var(--in-gap) 0;
            touch-action: manipulation;
            /* reduce accidental triggers */
        }

        /* Working preview: at most 1–2 lines */
        .working-preview {
            color: var(--muted);
            font-size: 14px;
            margin: 0 0 var(--in-gap) 0;
        }

        .working-full[hidden] {
            display: none !important;
        }

        /* Math overflow rules: only block-level math containers can scroll horizontally */
        .math-inline {
            display: inline-block;
            max-width: 100%;
            vertical-align: baseline;
        }

        .math-block {
            margin: 6px 0;
            overflow-x: auto;
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            /* allowed; horizontal only */
        }

        .math-block .katex-display {
            margin: 0;
        }

        /* Diagrams (inline SVG placeholders only) */
        .diagram {
            margin: 8px 0 0 0;
            max-width: 520px;
        }

        .diagram svg {
            width: 100%;
            height: auto;
            display: block;
        }

        /* Mobile/tablet: navigation overlay (minimal) */
        .nav-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, 0.98);
            z-index: 60;
            display: none;
        }

        .nav-overlay.open {
            display: block;
        }

        .nav-overlay-inner {
            position: absolute;
            inset: 0;
            padding: 10px var(--frame-pad) 16px var(--frame-pad);
            display: grid;
            grid-template-rows: auto 1fr;
            gap: 10px;
        }

        .nav-overlay-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        .nav-overlay-title {
            margin: 0;
            font-size: 14px;
            color: var(--muted);
            font-weight: 600;
        }

        .nav-overlay-scroll {
            overflow-y: auto;
            /* permitted only for navigation list when needed */
            scrollbar-width: none;
            -ms-overflow-style: none;
            padding: 6px 0 20px 0;
        }

        .nav-overlay-scroll::-webkit-scrollbar {
            display: none;
        }

        /* Responsive structure */
        @media (min-width: 980px) {
            .frame {
                grid-template-columns: var(--nav-w) 1fr;
                gap: 20px;
            }

            .nav {
                display: block;
            }

            .jump-btn {
                display: none;
            }

            .paper {
                margin-left: 0;
            }
        }

        @media (max-width: 979px) {

            /* reduce indentation to preserve reading width */
            :root {
                --indent-1: 12px;
                --indent-2: 22px;
                --indent-3: 30px;
            }
        }
    </style>
</head>

<body>
    <!-- Top controls (fixed location) -->
    <div class="topbar" role="region" aria-label="Paper controls">
        <div class="topbar-inner">
            <div class="controls">
                <label for="paperSelect">Paper:</label>
                <select id="paperSelect" aria-label="Paper selector"></select>
            </div>
            <button id="openNav" class="jump-btn" type="button" aria-haspopup="dialog" aria-controls="navOverlay">
                Jump to
            </button>
        </div>
    </div>

    <!-- Centered frame containing nav rail + paper content -->
    <div class="frame">
        <aside class="nav" aria-label="Question navigation">
            <nav id="navRail" class="nav-rail" tabindex="0" aria-label="Navigation list (scrollable if needed)">
                <p class="nav-title">Jump to</p>
                <ul id="navListRail" class="nav-list"></ul>
            </nav>
        </aside>

        <main class="paper-col" aria-label="Paper content">
            <div id="paper" class="paper" aria-label="Maths paper"></div>
        </main>
    </div>

    <!-- Mobile/Tablet navigation overlay -->
    <div id="navOverlay" class="nav-overlay" role="dialog" aria-modal="true" aria-label="Question navigation">
        <div class="nav-overlay-inner">
            <div class="nav-overlay-header">
                <h2 class="nav-overlay-title">Jump to</h2>
                <button id="closeNav" type="button">Close</button>
            </div>
            <div id="navOverlayScroll" class="nav-overlay-scroll" tabindex="0"
                aria-label="Navigation list (scrollable if needed)">
                <ul id="navListOverlay" class="nav-list"></ul>
            </div>
        </div>
    </div>

    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
    <script>
        (function () {
            const paperEl = document.getElementById('paper');
            const selectEl = document.getElementById('paperSelect');

            const navListRail = document.getElementById('navListRail');
            const navListOverlay = document.getElementById('navListOverlay');

            const navRail = document.getElementById('navRail');
            const navOverlay = document.getElementById('navOverlay');
            const navOverlayScroll = document.getElementById('navOverlayScroll');
            const openNavBtn = document.getElementById('openNav');
            const closeNavBtn = document.getElementById('closeNav');

            // ---------- Helpers ----------
            function el(tag, attrs = {}, children = []) {
                const n = document.createElement(tag);
                for (const [k, v] of Object.entries(attrs)) {
                    if (k === 'class') n.className = v;
                    else if (k === 'html') n.innerHTML = v;
                    else if (k.startsWith('on') && typeof v === 'function') n.addEventListener(k.slice(2), v);
                    else if (v === true) n.setAttribute(k, '');
                    else if (v !== false && v != null) n.setAttribute(k, String(v));
                }
                for (const c of children) {
                    if (c == null) continue;
                    if (typeof c === 'string') n.appendChild(document.createTextNode(c));
                    else n.appendChild(c);
                }
                return n;
            }

            function stabilizeScroll(anchorEl, mutate) {
                // Keep the interacted question visually anchored (no disorienting jumps).
                const beforeTop = anchorEl.getBoundingClientRect().top;
                mutate();
                const afterTop = anchorEl.getBoundingClientRect().top;
                const delta = afterTop - beforeTop;
                if (delta) window.scrollBy(0, delta);
            }

            function safeRenderKatex(root) {
                // Render elements with data-math. If KaTeX fails, keep plain text.
                const has = !!window.katex && typeof window.katex.render === 'function';
                root.querySelectorAll('[data-math]').forEach(node => {
                    const tex = node.getAttribute('data-math') || '';
                    const display = node.getAttribute('data-display') === 'true';
                    if (!has) {
                        node.textContent = tex;
                        return;
                    }
                    try {
                        window.katex.render(tex, node, { displayMode: display, throwOnError: false });
                    } catch (e) {
                        node.textContent = tex;
                    }
                });
            }

            function enableKeyboardScroll(container) {
                container.addEventListener('keydown', (e) => {
                    const k = e.key;
                    const step = 42;
                    const page = Math.max(200, Math.floor(container.clientHeight * 0.9));
                    if (k === 'ArrowDown') { container.scrollTop += step; e.preventDefault(); }
                    else if (k === 'ArrowUp') { container.scrollTop -= step; e.preventDefault(); }
                    else if (k === 'PageDown') { container.scrollTop += page; e.preventDefault(); }
                    else if (k === 'PageUp') { container.scrollTop -= page; e.preventDefault(); }
                    else if (k === 'Home') { container.scrollTop = 0; e.preventDefault(); }
                    else if (k === 'End') { container.scrollTop = container.scrollHeight; e.preventDefault(); }
                });
            }
            enableKeyboardScroll(navRail);
            enableKeyboardScroll(navOverlayScroll);

            function focusTrapOverlay(e) {
                if (!navOverlay.classList.contains('open')) return;
                if (e.key !== 'Tab') return;
                const focusables = navOverlay.querySelectorAll('button, a, [tabindex]:not([tabindex="-1"])');
                if (!focusables.length) return;
                const first = focusables[0];
                const last = focusables[focusables.length - 1];
                const active = document.activeElement;
                if (e.shiftKey && active === first) { e.preventDefault(); last.focus(); }
                else if (!e.shiftKey && active === last) { e.preventDefault(); first.focus(); }
            }

            // ---------- Diagrams (4 reusable SVG types) ----------
            function svgGeometry() {
                return `
          <svg viewBox="0 0 240 140" role="img" aria-label="Geometry diagram">
            <rect x="1" y="1" width="238" height="138" fill="none" stroke="#111" stroke-width="1"/>
            <circle cx="170" cy="70" r="32" fill="none" stroke="#111" stroke-width="1"/>
            <polygon points="40,110 90,30 140,110" fill="none" stroke="#111" stroke-width="1"/>
            <text x="86" y="25" font-size="10" fill="#111">A</text>
            <text x="35" y="124" font-size="10" fill="#111">B</text>
            <text x="144" y="124" font-size="10" fill="#111">C</text>
            <text x="170" y="18" font-size="10" fill="#111">O</text>
            <line x1="170" y1="38" x2="170" y2="102" stroke="#111" stroke-width="1" stroke-dasharray="3 3"/>
          </svg>
        `;
            }
            function svgBars() {
                return `
          <svg viewBox="0 0 240 140" role="img" aria-label="Bar ratio diagram">
            <rect x="1" y="1" width="238" height="138" fill="none" stroke="#111" stroke-width="1"/>
            <text x="12" y="28" font-size="10" fill="#111">Ratio bars</text>
            <rect x="20" y="46" width="180" height="18" fill="none" stroke="#111" stroke-width="1"/>
            <line x1="80" y1="46" x2="80" y2="64" stroke="#111" stroke-width="1"/>
            <line x1="140" y1="46" x2="140" y2="64" stroke="#111" stroke-width="1"/>
            <text x="22" y="78" font-size="10" fill="#111">A</text>
            <rect x="20" y="88" width="150" height="18" fill="none" stroke="#111" stroke-width="1"/>
            <line x1="70" y1="88" x2="70" y2="106" stroke="#111" stroke-width="1"/>
            <line x1="120" y1="88" x2="120" y2="106" stroke="#111" stroke-width="1"/>
            <text x="22" y="120" font-size="10" fill="#111">B</text>
          </svg>
        `;
            }
            function svgGrid() {
                let lines = '';
                for (let i = 0; i <= 10; i++) {
                    const x = 20 + i * 18;
                    lines += `<line x1="${x}" y1="20" x2="${x}" y2="120" stroke="#111" stroke-width="0.5" opacity="0.35"/>`;
                }
                for (let j = 0; j <= 6; j++) {
                    const y = 20 + j * (100 / 6);
                    lines += `<line x1="20" y1="${y}" x2="200" y2="${y}" stroke="#111" stroke-width="0.5" opacity="0.35"/>`;
                }
                return `
          <svg viewBox="0 0 240 140" role="img" aria-label="Coordinate grid diagram">
            <rect x="1" y="1" width="238" height="138" fill="none" stroke="#111" stroke-width="1"/>
            ${lines}
            <line x1="20" y1="120" x2="200" y2="120" stroke="#111" stroke-width="1"/>
            <line x1="20" y1="20" x2="20" y2="120" stroke="#111" stroke-width="1"/>
            <circle cx="92" cy="70" r="3" fill="#111"/>
            <circle cx="164" cy="52" r="3" fill="#111"/>
            <line x1="92" y1="70" x2="164" y2="52" stroke="#111" stroke-width="1"/>
            <text x="86" y="84" font-size="10" fill="#111">(4,3)</text>
            <text x="156" y="46" font-size="10" fill="#111">(8,4)</text>
          </svg>
        `;
            }
            function svgTable() {
                let grid = '';
                const x0 = 20, y0 = 30, w = 180, h = 86;
                grid += `<rect x="${x0}" y="${y0}" width="${w}" height="${h}" fill="none" stroke="#111" stroke-width="1"/>`;
                for (let i = 1; i < 5; i++) {
                    const y = y0 + i * (h / 5);
                    grid += `<line x1="${x0}" y1="${y}" x2="${x0 + w}" y2="${y}" stroke="#111" stroke-width="1"/>`;
                }
                for (let j = 1; j < 4; j++) {
                    const x = x0 + j * (w / 4);
                    grid += `<line x1="${x}" y1="${y0}" x2="${x}" y2="${y0 + h}" stroke="#111" stroke-width="1"/>`;
                }
                return `
          <svg viewBox="0 0 240 140" role="img" aria-label="Table diagram">
            <rect x="1" y="1" width="238" height="138" fill="none" stroke="#111" stroke-width="1"/>
            <text x="20" y="22" font-size="10" fill="#111">Table / array</text>
            ${grid}
          </svg>
        `;
            }
            const DIAGRAMS = [svgGeometry, svgBars, svgGrid, svgTable];

            // ---------- Content model ----------
            function mkText(t) { return { type: 'text', text: t }; }
            function mkInline(tex) { return { type: 'inline', tex }; }
            function mkBlock(tex) { return { type: 'block', tex }; }

            function makeNode({ key, label, depth = 0, questionParts = [], answerParts = [], workingLines = [], diagramIndex = null, expandedDefault = false, section = null }) {
                return { key, label, depth, questionParts, answerParts, workingLines, diagramIndex, expandedDefault, section };
            }

            // Long block expressions to force overflow on mobile
            function wideExpr(seed) {
                const base = [
                    String.raw`\frac{(x+${seed})^2}{${seed + 1}}`,
                    String.raw`+\frac{(2x+${seed + 2})}{${seed + 3}}`,
                    String.raw`+\frac{(3x+${seed + 4})^2}{${seed + 5}}`,
                    String.raw`+\frac{(4x+${seed + 6})}{${seed + 7}}`,
                    String.raw`+\frac{(5x+${seed + 8})^2}{${seed + 9}}`
                ].join('');
                const tail = Array.from({ length: 6 }, (_, i) => String.raw`+\frac{(x+${seed + i + 10})}{${seed + i + 11}}`).join('');
                return String.raw`\displaystyle ${base}${tail}`;
            }

            function workingShort(seed) {
                return [
                    String.raw`2 + 3 = 5`,
                    String.raw`5 \times ${seed} = ${5 * seed}`
                ];
            }
            function workingMedium(seed) {
                return [
                    String.raw`Let\; x = ${seed}`,
                    String.raw`x + 7 = ${seed + 7}`,
                    String.raw`\frac{x+7}{2} = ${((seed + 7) / 2).toFixed(1)}`
                ];
            }
            function workingLong(seed, nLines) {
                const lines = [];
                lines.push(String.raw`Start\;:\; 3x + ${seed} = 2x + ${seed + 9}`);
                lines.push(String.raw`Subtract\; 2x\;:\; x + ${seed} = ${seed + 9}`);
                lines.push(String.raw`Subtract\; ${seed}\;:\; x = 9`);
                for (let i = 0; i < nLines; i++) {
                    if (i % 10 === 0) lines.push(wideExpr(seed + i));
                    else if (i % 6 === 0) lines.push(String.raw`\frac{${seed + i}}{${seed + i + 1}} = ${((seed + i) / (seed + i + 1)).toFixed(3)}`);
                    else lines.push(String.raw`x + ${seed + i} = ${seed + i + 9}`);
                }
                lines.push(String.raw`Therefore,\; x = 9`);
                return lines;
            }

            // ---------- Datasets ----------
            function shortPaper() {
                const nodes = [];
                nodes.push(makeNode({
                    key: 'q1', label: '1', depth: 0,
                    questionParts: [mkText('Calculate '), mkInline(String.raw`7 + 8`), mkText('.')],
                    answerParts: [mkInline(String.raw`15`)],
                    workingLines: workingShort(3),
                    expandedDefault: false
                }));
                nodes.push(makeNode({
                    key: 'q2', label: '2', depth: 0,
                    questionParts: [mkText('Find '), mkInline(String.raw`6 \times 9`), mkText('.')],
                    answerParts: [mkInline(String.raw`54`)],
                    workingLines: [String.raw`6 \times 9 = 54`],
                    expandedDefault: false
                }));
                nodes.push(makeNode({
                    key: 'q3', label: '3', depth: 0,
                    questionParts: [mkText('A bag has '), mkInline(String.raw`24`), mkText(' apples. Half are eaten. How many are left?')],
                    answerParts: [mkInline(String.raw`12`)],
                    workingLines: [String.raw`Half\;of\;24\;=\;12`],
                    expandedDefault: false
                }));
                nodes.push(makeNode({
                    key: 'q4', label: '4', depth: 0,
                    questionParts: [mkText('Answer parts (a) and (b).')],
                    answerParts: [mkText('See parts.')],
                    workingLines: [String.raw`Workings\;are\;shown\;in\;each\;part.`],
                    expandedDefault: false
                }));
                nodes.push(makeNode({
                    key: 'q4a', label: '4a', depth: 1,
                    questionParts: [mkText('Solve '), mkInline(String.raw`x + 5 = 12`), mkText('.')],
                    answerParts: [mkInline(String.raw`x = 7`)],
                    workingLines: [String.raw`x = 12 - 5 = 7`],
                    expandedDefault: false
                }));
                nodes.push(makeNode({
                    key: 'q4b', label: '4b', depth: 1,
                    questionParts: [mkText('Evaluate '), mkInline(String.raw`\frac{3}{4}\;of\;20`), mkText('.')],
                    answerParts: [mkInline(String.raw`15`)],
                    workingLines: [String.raw`\frac{3}{4}\times 20 = 15`],
                    expandedDefault: false
                }));
                nodes.push(makeNode({
                    key: 'q5', label: '5', depth: 0,
                    questionParts: [mkText('Write '), mkInline(String.raw`0.25`), mkText(' as a fraction in simplest form.')],
                    answerParts: [mkInline(String.raw`\frac{1}{4}`)],
                    workingLines: [String.raw`0.25 = \frac{25}{100} = \frac{1}{4}`],
                    expandedDefault: false
                }));
                nodes.push(makeNode({
                    key: 'q6', label: '6', depth: 0,
                    questionParts: [mkText('Perimeter of a square is '), mkInline(String.raw`32`), mkText(' cm. Find one side length.')],
                    answerParts: [mkInline(String.raw`8\text{ cm}`)],
                    workingLines: [String.raw`32 \div 4 = 8`],
                    expandedDefault: false
                }));
                return { id: 'short', name: 'Short paper', nodes };
            }

            function standardPaper({ expandedAll = false } = {}) {
                const nodes = [];
                for (let i = 1; i <= 35; i++) {
                    const key = 'q' + i;
                    const isLong = i >= 26;
                    const workingLines = isLong ? workingLong(i, 22) : (i % 7 === 0 ? workingMedium(i) : workingShort((i % 9) + 2));
                    nodes.push(makeNode({
                        key, label: String(i), depth: 0,
                        questionParts: [mkText('Question prompt: '), mkInline(String.raw`${i}+${i + 3}`), mkText('.')],
                        answerParts: [mkInline(String.raw`${2 * i + 3}`)],
                        workingLines,
                        expandedDefault: expandedAll
                    }));

                    // Deep nesting: Q18(a)(i),(ii),(b)
                    if (i === 18) {
                        nodes.push(makeNode({
                            key: 'q18a', label: '18a', depth: 1,
                            questionParts: [mkText('Part (a): simplify '), mkInline(String.raw`2x + 3x`), mkText('.')],
                            answerParts: [mkInline(String.raw`5x`)],
                            workingLines: [String.raw`2x + 3x = (2+3)x = 5x`],
                            expandedDefault: expandedAll
                        }));
                        nodes.push(makeNode({
                            key: 'q18a_i', label: '18a(i)', depth: 2,
                            questionParts: [mkText('Find '), mkInline(String.raw`x`), mkText(' if '), mkInline(String.raw`5x = 35`), mkText('.')],
                            answerParts: [mkInline(String.raw`x = 7`)],
                            workingLines: [String.raw`5x = 35 \Rightarrow x = 35 \div 5 = 7`],
                            expandedDefault: expandedAll
                        }));
                        nodes.push(makeNode({
                            key: 'q18a_ii', label: '18a(ii)', depth: 2,
                            questionParts: [mkText('Compute '), mkInline(String.raw`7x`), mkText(' when '), mkInline(String.raw`x=7`), mkText('.')],
                            answerParts: [mkInline(String.raw`49`)],
                            workingLines: [String.raw`7 \times 7 = 49`],
                            expandedDefault: expandedAll
                        }));
                        nodes.push(makeNode({
                            key: 'q18b', label: '18b', depth: 1,
                            questionParts: [mkText('Part (b): solve '), mkInline(String.raw`x - 4 = 9`), mkText('.')],
                            answerParts: [mkInline(String.raw`x = 13`)],
                            workingLines: [String.raw`x = 9 + 4 = 13`],
                            expandedDefault: expandedAll
                        }));
                    }

                    // Deep nesting: Q30(a)(i),(ii),(b)
                    if (i === 30) {
                        nodes.push(makeNode({
                            key: 'q30a', label: '30a', depth: 1,
                            questionParts: [mkText('Part (a): factorise '), mkInline(String.raw`x^2 - 9`), mkText('.')],
                            answerParts: [mkInline(String.raw`(x-3)(x+3)`)],
                            workingLines: [String.raw`x^2 - 9 = x^2 - 3^2 = (x-3)(x+3)`],
                            expandedDefault: expandedAll
                        }));
                        nodes.push(makeNode({
                            key: 'q30a_i', label: '30a(i)', depth: 2,
                            questionParts: [mkText('Evaluate '), mkInline(String.raw`(x-3)(x+3)`), mkText(' for '), mkInline(String.raw`x=10`), mkText('.')],
                            answerParts: [mkInline(String.raw`91`)],
                            workingLines: [String.raw`(10-3)(10+3) = 7 \times 13 = 91`],
                            expandedDefault: expandedAll
                        }));
                        nodes.push(makeNode({
                            key: 'q30a_ii', label: '30a(ii)', depth: 2,
                            questionParts: [mkText('Solve '), mkInline(String.raw`x^2 - 9 = 0`), mkText('.')],
                            answerParts: [mkInline(String.raw`x = 3\;or\;x = -3`)],
                            workingLines: [String.raw`x^2 - 9 = 0 \Rightarrow x^2 = 9`, String.raw`x = \pm 3`],
                            expandedDefault: expandedAll
                        }));
                        nodes.push(makeNode({
                            key: 'q30b', label: '30b', depth: 1,
                            questionParts: [mkText('Part (b): simplify '), mkInline(String.raw`\frac{12x}{3}`), mkText('.')],
                            answerParts: [mkInline(String.raw`4x`)],
                            workingLines: [String.raw`\frac{12x}{3} = 4x`],
                            expandedDefault: expandedAll
                        }));
                    }
                }
                return {
                    id: expandedAll ? 'standard_expanded' : 'standard',
                    name: expandedAll ? 'Standard (Workings Expanded)' : 'Standard paper',
                    nodes
                };
            }

            function diagramHeavyPaper() {
                const nodes = [];
                const diagramQs = new Set([2, 4, 6, 8, 11, 13, 16, 19]); // 8 diagrams
                for (let i = 1; i <= 20; i++) {
                    const hasDiagram = diagramQs.has(i);
                    nodes.push(makeNode({
                        key: 'q' + i, label: String(i), depth: 0,
                        questionParts: [mkText('Question '), mkText(hasDiagram ? 'with diagram: ' : 'prompt: '), mkInline(String.raw`${i}+10`), mkText('.')],
                        answerParts: [mkInline(String.raw`${i + 10}`)],
                        workingLines: (i % 4 === 0) ? workingMedium(i) : workingShort((i % 7) + 2),
                        diagramIndex: hasDiagram ? (i % DIAGRAMS.length) : null,
                        expandedDefault: false
                    }));
                }
                return { id: 'diagram', name: 'Diagram-heavy paper', nodes };
            }

            function sectionedPaper() {
                const nodes = [];

                // Section A: 35 small/medium
                for (let i = 1; i <= 35; i++) {
                    nodes.push(makeNode({
                        key: 'Aq' + i, label: String(i), depth: 0, section: 'A',
                        questionParts: [mkText('Section A prompt: '), mkInline(String.raw`${i}\times 2`), mkText('.')],
                        answerParts: [mkInline(String.raw`${i * 2}`)],
                        workingLines: (i % 6 === 0) ? workingMedium(i) : workingShort((i % 9) + 2),
                        expandedDefault: false
                    }));
                    if (i === 18) {
                        nodes.push(makeNode({
                            key: 'Aq18a_i', label: '18a(i)', depth: 2, section: 'A',
                            questionParts: [mkText('Nested part: '), mkInline(String.raw`x+2=9`), mkText('.')],
                            answerParts: [mkInline(String.raw`x=7`)],
                            workingLines: [String.raw`x = 9 - 2 = 7`],
                            expandedDefault: false
                        }));
                    }
                }

                // Section B: 8 medium
                for (let i = 1; i <= 8; i++) {
                    const label = String(35 + i);
                    nodes.push(makeNode({
                        key: 'Bq' + i, label, depth: 0, section: 'B',
                        questionParts: [mkText('Section B prompt: solve '), mkInline(String.raw`x+${i + 3}=${i + 15}`), mkText('.')],
                        answerParts: [mkInline(String.raw`x=12`)],
                        workingLines: [String.raw`x = ${i + 15} - ${i + 3} = 12`],
                        expandedDefault: false
                    }));
                }

                // Section C: 6 very long workings (collapsed by default)
                for (let i = 1; i <= 6; i++) {
                    const label = String(43 + i);
                    const lines = workingLong(100 + i, 55); // 50–60 lines
                    // ensure multiple very wide block lines inside working
                    lines.splice(8, 0, wideExpr(300 + i));
                    lines.splice(22, 0, wideExpr(400 + i));
                    lines.splice(36, 0, wideExpr(500 + i));

                    nodes.push(makeNode({
                        key: 'Cq' + i, label, depth: 0, section: 'C',
                        questionParts: [mkText('Section C long-working algebra: '), mkInline(String.raw`3x+${i}=2x+${i + 9}`), mkText('.')],
                        answerParts: [mkInline(String.raw`x=9`)],
                        workingLines: lines,
                        expandedDefault: false
                    }));
                }

                return { id: 'sectioned', name: 'Sectioned paper (original structure)', nodes, sectioned: true };
            }

            const DATASETS = [
                shortPaper(),
                standardPaper({ expandedAll: false }),
                standardPaper({ expandedAll: true }),
                diagramHeavyPaper(),
                sectionedPaper()
            ];

            // ---------- Rendering ----------
            function renderParts(parts) {
                const frag = document.createDocumentFragment();
                for (const p of parts) {
                    if (p.type === 'text') {
                        frag.appendChild(document.createTextNode(p.text));
                    } else if (p.type === 'inline') {
                        const span = el('span', { class: 'math-inline', 'data-math': p.tex, 'data-display': 'false' });
                        frag.appendChild(span);
                    } else if (p.type === 'block') {
                        const block = el('div', { class: 'math-block' }, [
                            el('div', { 'data-math': p.tex, 'data-display': 'true' })
                        ]);
                        frag.appendChild(block);
                    }
                }
                return frag;
            }

            function renderWorkingLines(lines) {
                const wrap = el('div', {});
                for (const line of lines) {
                    wrap.appendChild(
                        el('div', { class: 'math-block' }, [
                            el('div', { 'data-math': line, 'data-display': 'true' })
                        ])
                    );
                }
                return wrap;
            }

            function makeQuestion(node) {
                const q = el('section', { class: 'q', id: node.key });

                const head = el('div', { class: 'q-head' }, [
                    el('div', { class: 'q-num' }, [node.label]),
                    el('p', { class: 'q-prompt' }, [])
                ]);
                head.querySelector('.q-prompt').appendChild(renderParts(node.questionParts));

                let diagramEl = null;
                if (node.diagramIndex != null) {
                    diagramEl = el('div', { class: 'diagram', html: DIAGRAMS[node.diagramIndex % DIAGRAMS.length]() });
                }

                const body = el('div', { class: 'q-body' }, []);
                if (node.depth === 1) body.classList.add('indent-1');
                if (node.depth === 2) body.classList.add('indent-2');
                if (node.depth === 3) body.classList.add('indent-3');

                const answer = el('div', { class: 'answer' }, [
                    el('span', { class: 'label' }, ['Answer:']),
                    el('span', {}, [])
                ]);
                answer.querySelector('span:last-child').appendChild(renderParts(node.answerParts));

                // Preview: at most 1–2 lines
                const previewLines = node.workingLines.slice(0, Math.min(2, node.workingLines.length));
                const preview = el('div', { class: 'working-preview' }, []);
                if (previewLines.length) {
                    preview.appendChild(el('span', { class: 'label' }, ['Working (preview):']));
                    previewLines.forEach(l => {
                        preview.appendChild(
                            el('div', { class: 'math-block' }, [el('div', { 'data-math': l, 'data-display': 'true' })])
                        );
                    });
                }

                const full = el('div', { class: 'working-full' }, [
                    el('div', { class: 'label' }, ['Working:']),
                    renderWorkingLines(node.workingLines),
                    // secondary hide control at end (no sticky chrome; keeps control easy to find)
                    el('button', { type: 'button', class: 'toggle toggle-bottom', 'aria-expanded': 'false' }, ['Hide working'])
                ]);

                const toggleTop = el('button', { type: 'button', class: 'toggle', 'aria-expanded': 'false' }, ['Show working']);

                function setExpanded(expanded) {
                    toggleTop.setAttribute('aria-expanded', expanded ? 'true' : 'false');
                    toggleTop.textContent = expanded ? 'Hide working' : 'Show working';
                    full.hidden = !expanded;
                    preview.hidden = expanded;

                    const bottomBtn = full.querySelector('.toggle-bottom');
                    bottomBtn.setAttribute('aria-expanded', expanded ? 'true' : 'false');
                    bottomBtn.textContent = 'Hide working';
                }

                setExpanded(!!node.expandedDefault);

                function onToggleClick() {
                    const expanded = toggleTop.getAttribute('aria-expanded') === 'true';
                    stabilizeScroll(q, () => {
                        setExpanded(!expanded);
                    });
                    safeRenderKatex(q);
                }

                toggleTop.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); onToggleClick(); });
                full.querySelector('.toggle-bottom').addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); onToggleClick(); });

                body.appendChild(answer);
                body.appendChild(toggleTop);
                body.appendChild(preview);
                body.appendChild(full);

                q.appendChild(head);
                if (diagramEl) q.appendChild(diagramEl);
                q.appendChild(body);

                return q;
            }

            function buildNavigation(dataset) {
                navListRail.innerHTML = '';
                navListOverlay.innerHTML = '';

                function addSep(text) {
                    navListRail.appendChild(el('li', { class: 'nav-sep' }, [text]));
                    navListOverlay.appendChild(el('li', { class: 'nav-sep' }, [text]));
                }
                function addItem(label, id) {
                    const a1 = el('a', { href: '#' + id }, [label]);
                    const a2 = el('a', { href: '#' + id }, [label]);

                    a1.addEventListener('click', () => { /* navigation must not change expanded states */ });
                    a2.addEventListener('click', () => {
                        navOverlay.classList.remove('open');
                        openNavBtn.focus();
                    });

                    navListRail.appendChild(el('li', { class: 'nav-item' }, [a1]));
                    navListOverlay.appendChild(el('li', { class: 'nav-item' }, [a2]));
                }

                if (dataset.sectioned) {
                    const labels = { A: 'Section A', B: 'Section B', C: 'Section C' };
                    ['A', 'B', 'C'].forEach(sec => {
                        addSep(labels[sec]);
                        dataset.nodes.filter(n => n.section === sec).forEach(n => addItem(n.label, n.key));
                    });
                } else {
                    dataset.nodes.forEach(n => addItem(n.label, n.key));
                }
            }

            function renderDataset(dataset) {
                paperEl.innerHTML = '';
                const frag = document.createDocumentFragment();
                dataset.nodes.forEach(n => frag.appendChild(makeQuestion(n)));
                paperEl.appendChild(frag);

                buildNavigation(dataset);

                // Render KaTeX; if it fails, content remains visible as plain text
                safeRenderKatex(paperEl);

                navOverlay.classList.remove('open');
            }

            // ---------- Selector ----------
            function initSelector() {
                DATASETS.forEach(d => {
                    selectEl.appendChild(el('option', { value: d.id }, [d.name]));
                });
                selectEl.addEventListener('change', () => {
                    const d = DATASETS.find(x => x.id === selectEl.value) || DATASETS[0];
                    renderDataset(d);
                    window.scrollTo(0, 0);
                });
            }

            // ---------- Mobile nav ----------
            openNavBtn.addEventListener('click', () => {
                navOverlay.classList.add('open');
                const first = navOverlay.querySelector('a') || closeNavBtn;
                first && first.focus();
            });
            closeNavBtn.addEventListener('click', () => {
                navOverlay.classList.remove('open');
                openNavBtn.focus();
            });
            navOverlay.addEventListener('click', (e) => {
                if (e.target === navOverlay) {
                    navOverlay.classList.remove('open');
                    openNavBtn.focus();
                }
            });
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && navOverlay.classList.contains('open')) {
                    navOverlay.classList.remove('open');
                    openNavBtn.focus();
                }
                focusTrapOverlay(e);
            });

            // ---------- Start ----------
            initSelector();
            selectEl.value = 'standard';
            renderDataset(DATASETS.find(d => d.id === 'standard') || DATASETS[0]);
        })();
    </script>
</body>

</html>