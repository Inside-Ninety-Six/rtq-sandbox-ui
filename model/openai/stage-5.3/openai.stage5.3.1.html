<!-- exemplar style reference (not copied): :contentReference[oaicite:0]{index=0} -->
<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>RTQ – Maths Paper Solution Viewer (Stress Test Harness)</title>

    <!-- KaTeX (Real Rendering add-on enabled) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css"
        integrity="sha384-nB0miv6/jRmo5UMMR1QmkuH8s8fB8fAq5L0r8b3G4lGQJpV8lYtD9uN3S8aW9h4F" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"
        integrity="sha384-0cCFrwW/6Y8q+q2iBqH7q3bU0mEJqV8Yv0Qm8r7cZp8j5o2t3JYbKq7ZJw4m6Q3G"
        crossorigin="anonymous"></script>

    <style>
        :root {
            /* Soft cool-neutral base (Stage 5.3.1 override) */
            /* --bg: #e9edf1;
            --surface: #f4f6f8;
            --surface-2: #f0f3f6;
            --surface-3: #eef2f6; */

            --bg: #efeeea;
            /* soft warm-neutral, not beige */
            --surface: #f6f5f1;
            --surface-2: #f2f1ed;
            --surface-3: #f0efe9;

            --ink: #1b1f24;
            --muted: #4a545e;
            --quiet: #6b7580;
            --hairline: rgba(25, 30, 36, 0.10);
            --hairline-quiet: rgba(25, 30, 36, 0.08);

            /* Single restrained accent (non-semantic) */
            /* --accent: #3b6ea8;
            /* calm blue */
            /* --accent-quiet: rgba(59, 110, 168, 0.14); */
            --accent: #3b6ea8;
            --accent-quiet: rgba(59, 110, 168, 0.14);

            --radius-none: 0px;
            --shadow-none: none;

            --frame-max: 1100px;
            --nav-w: 160px;

            /* Rhythm scale */
            --sp-1: 6px;
            --sp-2: 10px;
            --sp-3: 14px;
            --sp-4: 20px;
            --sp-5: 28px;
            --sp-6: 40px;

            --lh-strong: 1.55;
            --lh-body: 1.45;
            --lh-dense: 1.35;

            --fs-nav: 13px;
            --fs-ui: 14px;
            --fs-q: 18px;
            --fs-body: 15px;
            --fs-supp: 14px;

            /* Indentation */
            --indent-1: 18px;
            --indent-2: 34px;
            --indent-3: 50px;
        }

        * {
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
        }

        html {
            overflow-x: hidden;
        }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--ink);
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
            line-height: var(--lh-body);
            overflow-x: hidden;
        }

        a {
            color: var(--accent);
            text-decoration: underline;
            text-underline-offset: 2px;
        }

        a:hover {
            text-decoration-thickness: 2px;
        }

        button,
        select {
            font: inherit;
            color: inherit;
        }

        /* Focus (custom but restrained) */
        :focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        /* Page shell */
        .topbar-wrap {
            width: 100%;
            background: transparent;
        }

        .frame {
            max-width: var(--frame-max);
            margin: 0 auto;
            padding: var(--sp-4) var(--sp-4);
        }

        .topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--sp-3);
            padding: var(--sp-3) 0 var(--sp-3);
        }

        .topbar h1 {
            font-size: 15px;
            margin: 0;
            font-weight: 600;
            letter-spacing: 0.2px;
            color: var(--muted);
        }

        .controls {
            display: flex;
            align-items: center;
            gap: var(--sp-2);
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .control {
            display: flex;
            align-items: center;
            gap: var(--sp-2);
            font-size: var(--fs-ui);
            color: var(--muted);
        }

        label {
            color: var(--muted);
        }

        select {
            background: var(--surface);
            border: 1px solid var(--hairline);
            border-radius: 10px;
            /* subtle, not a card */
            padding: 8px 10px;
            line-height: 1.2;
            min-width: 240px;
        }

        /* Minimal mobile jump control */
        .jump-btn {
            background: transparent;
            border: 1px solid var(--hairline);
            border-radius: 10px;
            padding: 8px 10px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: var(--muted);
            cursor: pointer;
            user-select: none;
        }

        .jump-btn:hover {
            border-color: rgba(25, 30, 36, 0.16);
            color: var(--ink);
        }

        .chev {
            width: 10px;
            height: 10px;
            display: inline-block;
            border-right: 1.5px solid currentColor;
            border-bottom: 1.5px solid currentColor;
            transform: rotate(-45deg);
            margin-top: 1px;
            opacity: 0.8;
        }

        /* Centered unified surface (nav + content share same base surface) */
        .paper-surface {
            background: var(--surface);
            border: 1px solid rgba(25, 30, 36, 0.06);
            border-radius: 16px;
            /* gentle, page-like */
            padding: var(--sp-5);
        }

        /* Desktop two-column structure */
        .layout {
            display: grid;
            grid-template-columns: var(--nav-w) 1fr;
            gap: var(--sp-5);
            align-items: start;
        }

        nav[aria-label="Paper navigation"] {
            position: sticky;
            top: 18px;
            align-self: start;
        }

        .nav-title {
            font-size: 12px;
            text-transform: none;
            letter-spacing: 0.2px;
            color: var(--quiet);
            margin: 0 0 var(--sp-2);
            font-weight: 600;
        }

        .nav-list {
            display: flex;
            flex-direction: column;
            gap: 2px;
            max-height: calc(100vh - 72px);
            overflow-y: auto;
            padding-right: 6px;
            /* room for hidden scrollbar */
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .nav-list::-webkit-scrollbar {
            display: none;
        }

        .nav-sep {
            font-size: 12px;
            color: var(--quiet);
            margin: var(--sp-2) 0 var(--sp-1);
            font-weight: 600;
        }

        .nav-item {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 8px;
            font-size: var(--fs-nav);
            color: rgba(27, 31, 36, 0.72);
            text-decoration: none;
            padding: 6px 6px;
            border-radius: 8px;
            /* not a pill highlight; no background used */
            cursor: pointer;
        }

        .nav-item:hover {
            text-decoration: underline;
            text-underline-offset: 2px;
            color: rgba(27, 31, 36, 0.85);
        }

        .nav-item[data-active="true"] {
            font-weight: 700;
            /* weight-only primary indication */
            color: rgba(27, 31, 36, 0.90);
        }

        /* Secondary cue (per override 5.4.3 cue count): subtle marker, neutral */
        .nav-item[data-active="true"]::before {
            content: "";
            width: 8px;
            height: 1px;
            background: rgba(27, 31, 36, 0.26);
            display: inline-block;
            margin-right: 2px;
            transform: translateY(0.5px);
        }

        /* Main content */
        main {
            min-width: 0;
        }

        .paper-meta {
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            gap: var(--sp-3);
            padding-bottom: var(--sp-3);
            border-bottom: 1px solid var(--hairline-quiet);
            margin-bottom: var(--sp-5);
        }

        .paper-meta .paper-name {
            font-size: 16px;
            font-weight: 650;
            color: rgba(27, 31, 36, 0.82);
            margin: 0;
        }

        .paper-meta .paper-note {
            font-size: 13px;
            color: var(--quiet);
            margin: 0;
        }

        /* Question blocks: separation by whitespace (no cards, no panels) */
        .q {
            padding: 0;
            margin: 0 0 var(--sp-6);
        }

        .q:last-child {
            margin-bottom: 0;
        }

        .q-inner {
            display: block;
            min-width: 0;
        }

        .q-head {
            display: flex;
            gap: var(--sp-2);
            align-items: baseline;
            margin-bottom: var(--sp-2);
        }

        .qid {
            font-size: 15px;
            font-weight: 650;
            color: rgba(27, 31, 36, 0.70);
            flex: 0 0 auto;
            min-width: 68px;
        }

        .qtext {
            font-size: var(--fs-q);
            line-height: var(--lh-strong);
            color: rgba(27, 31, 36, 0.96);
            margin: 0;
            max-width: 70ch;
        }

        .q-body {
            display: flex;
            flex-direction: column;
            gap: var(--sp-3);
        }

        /* Diagrams: live within Question */
        .diagram {
            width: 100%;
            max-width: 520px;
            margin-top: var(--sp-2);
        }

        .diagram svg {
            width: 100%;
            height: auto;
            display: block;
        }

        .diagram .cap {
            font-size: 12px;
            color: var(--quiet);
            margin-top: 6px;
        }

        /* Answer: visible, subordinate to question, above workings */
        .answer {
            display: flex;
            align-items: baseline;
            gap: var(--sp-2);
            color: rgba(27, 31, 36, 0.86);
            font-size: var(--fs-body);
        }

        .answer .alabel {
            font-weight: 650;
            color: rgba(27, 31, 36, 0.70);
        }

        .answer .aval {
            color: rgba(27, 31, 36, 0.88);
        }

        /* Disclosure control: text-first, not button-like */
        .toggle {
            align-self: flex-start;
            background: transparent;
            border: none;
            padding: 0;
            color: var(--accent);
            cursor: pointer;
            font-size: var(--fs-ui);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            user-select: none;
        }

        .toggle:hover {
            text-decoration: underline;
            text-underline-offset: 2px;
        }

        .toggle .chev2 {
            width: 10px;
            height: 10px;
            border-right: 1.5px solid currentColor;
            border-bottom: 1.5px solid currentColor;
            transform: rotate(45deg);
            opacity: 0.9;
            transition: transform 140ms ease;
        }

        .toggle[aria-expanded="true"] .chev2 {
            transform: rotate(-135deg);
        }

        /* Solution Details: subtle surface + hairline divider (Stage 6.0.3) */
        .soln {
            margin-top: var(--sp-3);
            border-top: 1px solid var(--hairline);
            background: var(--surface-2);
            padding: var(--sp-3) var(--sp-3);
            max-width: 80ch;
        }

        /* Collapsible region: calm continuity */
        .soln-wrap {
            overflow: hidden;
            max-height: 0px;
            opacity: 0;
            transition: max-height 180ms ease, opacity 160ms ease;
        }

        .soln-wrap[data-open="true"] {
            opacity: 1;
        }

        @media (prefers-reduced-motion: reduce) {
            html {
                scroll-behavior: auto !important;
            }

            .soln-wrap {
                transition: none !important;
            }

            .toggle .chev2 {
                transition: none !important;
            }

            .drawer {
                transition: none !important;
            }

            .scrim {
                transition: none !important;
            }
        }

        .soln-grid {
            display: flex;
            flex-direction: column;
            gap: var(--sp-4);
            padding-top: var(--sp-3);
        }

        .s-block .s-label {
            font-weight: 650;
            font-size: 13px;
            color: rgba(27, 31, 36, 0.70);
            margin: 0 0 var(--sp-2);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Keep in mind (slightly more prominent than working body, still subordinate) */
        .s-block.guidance .s-body {
            color: rgba(27, 31, 36, 0.78);
            font-size: var(--fs-supp);
            line-height: var(--lh-body);
        }

        .s-block.guidance .g-icon {
            width: 14px;
            height: 14px;
            display: inline-block;
            border: 1px solid rgba(27, 31, 36, 0.18);
            border-radius: 999px;
            position: relative;
            flex: 0 0 auto;
        }

        .s-block.guidance .g-icon::after {
            content: "";
            position: absolute;
            left: 50%;
            top: 50%;
            width: 6px;
            height: 6px;
            transform: translate(-50%, -50%);
            background: rgba(27, 31, 36, 0.22);
            border-radius: 999px;
        }

        .s-block.guidance ul {
            margin: 0;
            padding-left: 18px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        /* Formulas used: quieter */
        .s-block.formulas .s-body {
            color: rgba(27, 31, 36, 0.72);
            font-size: 13.5px;
            line-height: var(--lh-dense);
            display: flex;
            flex-direction: column;
            gap: var(--sp-2);
        }

        .s-block.formulas .formula-line {
            display: block;
        }

        .divider {
            height: 1px;
            background: var(--hairline-quiet);
            margin-top: var(--sp-1);
        }

        /* Working + Alternative working body */
        .s-block.working .s-body,
        .s-block.alt .s-body {
            color: rgba(27, 31, 36, 0.70);
            font-size: 13.5px;
            line-height: var(--lh-dense);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .p {
            margin: 0;
            max-width: 80ch;
        }

        /* Tables inside workings: minimal, quiet */
        .table-wrap {
            max-width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .table-wrap::-webkit-scrollbar {
            display: none;
        }

        table {
            border-collapse: collapse;
            width: max-content;
            max-width: 100%;
            font-size: 13px;
            color: rgba(27, 31, 36, 0.72);
        }

        th,
        td {
            border: 1px solid var(--hairline-quiet);
            padding: 6px 8px;
            vertical-align: top;
            white-space: nowrap;
        }

        th {
            font-weight: 650;
            color: rgba(27, 31, 36, 0.70);
            background: transparent;
        }

        /* KaTeX containment invariant */
        .math-block {
            max-width: 100%;
            overflow-x: auto;
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
            padding: 6px 8px;
        }

        .math-block::-webkit-scrollbar {
            display: none;
        }

        /* Underlay exception (display-math only within working/alt) */
        .math-underlay {
            background: rgba(27, 31, 36, 0.035);
            /* no border, no radius, no shadow */
        }

        /* Ensure KaTeX doesn't widen page */
        .katex-display {
            margin: 0;
            max-width: 100%;
        }

        .katex-display>.katex {
            max-width: 100%;
        }

        .inline-math {
            white-space: nowrap;
        }

        /* Nesting indentation: spacing only */
        .depth-1 {
            margin-left: var(--indent-1);
        }

        .depth-2 {
            margin-left: var(--indent-2);
        }

        .depth-3 {
            margin-left: var(--indent-3);
        }

        /* Make separation weaken with depth */
        .q.depth-1 {
            margin-bottom: var(--sp-5);
        }

        .q.depth-2 {
            margin-bottom: var(--sp-4);
        }

        .q.depth-3 {
            margin-bottom: var(--sp-3);
        }

        /* Mobile & tablet */
        @media (max-width: 920px) {
            :root {
                --nav-w: 150px;
            }

            .paper-surface {
                padding: var(--sp-4);
            }
        }

        @media (max-width: 780px) {
            :root {
                --indent-1: 14px;
                --indent-2: 24px;
                --indent-3: 34px;
                --fs-q: 17px;
            }

            .layout {
                grid-template-columns: 1fr;
                gap: var(--sp-4);
            }

            nav[aria-label="Paper navigation"] {
                display: none;
                /* mobile uses drawer */
            }

            select {
                min-width: 220px;
            }

            .paper-meta {
                flex-direction: column;
                align-items: flex-start;
                gap: 6px;
            }

            .qid {
                min-width: 58px;
            }
        }

        /* Drawer (mobile) */
        .drawer-root {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 30;
        }

        .scrim {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.08);
            opacity: 0;
            transition: opacity 160ms ease;
        }

        .drawer {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: min(320px, 86vw);
            background: var(--surface);
            border-right: 1px solid rgba(25, 30, 36, 0.10);
            transform: translateX(-102%);
            transition: transform 180ms ease;
            padding: var(--sp-4);
            display: flex;
            flex-direction: column;
            gap: var(--sp-3);
        }

        .drawer header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--sp-2);
        }

        .drawer header h2 {
            font-size: 14px;
            margin: 0;
            font-weight: 650;
            color: rgba(27, 31, 36, 0.78);
        }

        .close {
            background: transparent;
            border: 1px solid var(--hairline);
            border-radius: 10px;
            padding: 6px 10px;
            cursor: pointer;
            color: var(--muted);
        }

        .close:hover {
            color: var(--ink);
            border-color: rgba(25, 30, 36, 0.16);
        }

        .drawer .nav-list {
            max-height: calc(100vh - 140px);
            padding-right: 8px;
        }

        .drawer-root[data-open="true"] {
            pointer-events: auto;
        }

        .drawer-root[data-open="true"] .scrim {
            opacity: 1;
        }

        .drawer-root[data-open="true"] .drawer {
            transform: translateX(0%);
        }

        /* Utility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
    </style>
</head>

<body>
    <div class="topbar-wrap">
        <div class="frame">
            <div class="topbar" role="banner">
                <h1>RTQ – Paper screen prototype</h1>
                <div class="controls" role="region" aria-label="Top controls">
                    <div class="control">
                        <label for="paperSelect">Paper</label>
                        <select id="paperSelect" aria-label="Paper selector"></select>
                    </div>
                    <button id="jumpBtn" class="jump-btn" type="button">
                        <span>Jump to</span>
                        <span class="chev" aria-hidden="true"></span>
                    </button>
                </div>
            </div>

            <section class="paper-surface" aria-label="Paper surface">
                <div class="layout">
                    <nav aria-label="Paper navigation">
                        <p class="nav-title">Jump</p>
                        <div id="navList" class="nav-list" tabindex="0" aria-label="Question list"></div>
                    </nav>

                    <main id="main" tabindex="-1">
                        <div class="paper-meta" aria-label="Paper info">
                            <p id="paperName" class="paper-name"></p>
                            <p id="paperNote" class="paper-note"></p>
                        </div>
                        <section id="paper" aria-label="Paper content"></section>
                    </main>
                </div>
            </section>
        </div>
    </div>

    <!-- Mobile drawer -->
    <div id="drawerRoot" class="drawer-root" data-open="false" aria-hidden="true">
        <div class="scrim" id="scrim" aria-hidden="true"></div>
        <aside class="drawer" role="dialog" aria-modal="true" aria-label="Jump to question">
            <header>
                <h2>Jump</h2>
                <button id="closeDrawer" class="close" type="button">Close</button>
            </header>
            <div id="drawerNav" class="nav-list" tabindex="0" aria-label="Question list (drawer)"></div>
            <div class="sr-only" aria-live="polite" id="live"></div>
        </aside>
    </div>

    <script>
        (function () {
            const $ = (sel, root = document) => root.querySelector(sel);
            const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));

            const paperSelect = $('#paperSelect');
            const paperName = $('#paperName');
            const paperNote = $('#paperNote');
            const paperEl = $('#paper');
            const navList = $('#navList');
            const drawerNav = $('#drawerNav');
            const jumpBtn = $('#jumpBtn');
            const drawerRoot = $('#drawerRoot');
            const scrim = $('#scrim');
            const closeDrawer = $('#closeDrawer');
            const main = $('#main');

            const prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;

            // Smooth scroll preference
            if (!prefersReduced) {
                document.documentElement.style.scrollBehavior = 'smooth';
            }

            function uidFromLabel(label) {
                // Create stable anchor id: q-18a-ii etc
                return 'q-' + label
                    .replaceAll(' ', '')
                    .replaceAll('(', '-')
                    .replaceAll(')', '')
                    .replaceAll('.', '-')
                    .replaceAll('—', '-')
                    .replaceAll('–', '-')
                    .replaceAll(':', '-');
            }

            /* ---------- Diagrams (inline SVG placeholders, reused types) ---------- */
            function svgGeometry() {
                return `
      <svg viewBox="0 0 360 220" role="img" aria-label="Geometry diagram">
        <rect x="1" y="1" width="358" height="218" fill="none" stroke="rgba(27,31,36,0.20)"/>
        <circle cx="270" cy="120" r="46" fill="none" stroke="rgba(27,31,36,0.30)" stroke-width="2"/>
        <polygon points="70,170 150,40 210,170" fill="none" stroke="rgba(27,31,36,0.32)" stroke-width="2"/>
        <line x1="70" y1="170" x2="210" y2="170" stroke="rgba(27,31,36,0.28)" stroke-width="2"/>
        <text x="145" y="32" font-size="12" fill="rgba(27,31,36,0.55)">A</text>
        <text x="60" y="190" font-size="12" fill="rgba(27,31,36,0.55)">B</text>
        <text x="215" y="190" font-size="12" fill="rgba(27,31,36,0.55)">C</text>
        <text x="260" y="72" font-size="12" fill="rgba(27,31,36,0.55)">r</text>
        <line x1="270" y1="120" x2="310" y2="120" stroke="rgba(27,31,36,0.26)" stroke-width="2"/>
      </svg>
    `;
            }
            function svgBars() {
                return `
      <svg viewBox="0 0 360 160" role="img" aria-label="Ratio bars diagram">
        <rect x="1" y="1" width="358" height="158" fill="none" stroke="rgba(27,31,36,0.20)"/>
        <rect x="40" y="42" width="260" height="22" fill="rgba(27,31,36,0.05)" stroke="rgba(27,31,36,0.20)"/>
        <line x1="125" y1="42" x2="125" y2="64" stroke="rgba(27,31,36,0.22)"/>
        <line x1="210" y1="42" x2="210" y2="64" stroke="rgba(27,31,36,0.22)"/>
        <rect x="40" y="92" width="220" height="22" fill="rgba(27,31,36,0.04)" stroke="rgba(27,31,36,0.20)"/>
        <line x1="113" y1="92" x2="113" y2="114" stroke="rgba(27,31,36,0.22)"/>
        <line x1="186" y1="92" x2="186" y2="114" stroke="rgba(27,31,36,0.22)"/>
        <text x="40" y="30" font-size="12" fill="rgba(27,31,36,0.55)">Bar A</text>
        <text x="40" y="80" font-size="12" fill="rgba(27,31,36,0.55)">Bar B</text>
      </svg>
    `;
            }
            function svgGrid() {
                const lines = [];
                for (let i = 0; i <= 10; i++) {
                    const x = 40 + i * 28;
                    lines.push(`<line x1="${x}" y1="20" x2="${x}" y2="220" stroke="rgba(27,31,36,0.10)"/>`);
                }
                for (let j = 0; j <= 7; j++) {
                    const y = 20 + j * 28;
                    lines.push(`<line x1="40" y1="${y}" x2="320" y2="${y}" stroke="rgba(27,31,36,0.10)"/>`);
                }
                return `
      <svg viewBox="0 0 360 240" role="img" aria-label="Coordinate grid diagram">
        <rect x="1" y="1" width="358" height="238" fill="none" stroke="rgba(27,31,36,0.20)"/>
        ${lines.join('')}
        <line x1="40" y1="216" x2="320" y2="216" stroke="rgba(27,31,36,0.22)"/>
        <line x1="60" y1="20" x2="60" y2="220" stroke="rgba(27,31,36,0.22)"/>
        <polyline points="60,196 116,168 172,140 228,112 284,84" fill="none" stroke="rgba(27,31,36,0.32)" stroke-width="2"/>
        <circle cx="172" cy="140" r="4" fill="rgba(27,31,36,0.35)"/>
        <text x="168" y="132" font-size="12" fill="rgba(27,31,36,0.55)">P</text>
      </svg>
    `;
            }
            function svgArray() {
                // table-like grid/array
                const cells = [];
                const x0 = 60, y0 = 40, w = 50, h = 36;
                for (let r = 0; r < 3; r++) {
                    for (let c = 0; c < 4; c++) {
                        cells.push(`<rect x="${x0 + c * w}" y="${y0 + r * h}" width="${w}" height="${h}" fill="none" stroke="rgba(27,31,36,0.18)"/>`);
                    }
                }
                return `
      <svg viewBox="0 0 360 200" role="img" aria-label="Grid or array diagram">
        <rect x="1" y="1" width="358" height="198" fill="none" stroke="rgba(27,31,36,0.20)"/>
        ${cells.join('')}
        <text x="60" y="30" font-size="12" fill="rgba(27,31,36,0.55)">Array</text>
        <text x="90" y="94" font-size="12" fill="rgba(27,31,36,0.45)">x</text>
        <text x="140" y="94" font-size="12" fill="rgba(27,31,36,0.45)">x</text>
        <text x="190" y="94" font-size="12" fill="rgba(27,31,36,0.45)">x</text>
        <text x="240" y="94" font-size="12" fill="rgba(27,31,36,0.45)">x</text>
      </svg>
    `;
            }

            function diagramBlock(kind, caption) {
                const svg = (kind === 'geometry') ? svgGeometry()
                    : (kind === 'bars') ? svgBars()
                        : (kind === 'grid') ? svgGrid()
                            : svgArray();
                return { t: 'diagram', kind, caption, svg };
            }

            /* ---------- Content block constructors ---------- */
            const P = (text) => ({ t: 'p', text });
            const M = (latex, underlay = false) => ({ t: 'math', latex, underlay });
            const L = (items) => ({ t: 'list', items });
            const TBL = (headers, rows) => ({ t: 'table', headers, rows });

            function longAlignedLines(n = 55) {
                // A long algebra-style working in aligned environment (50–60 lines)
                const lines = [];
                lines.push(`\\text{Let }x\\text{ be the number.}\\\\`);
                lines.push(`\\text{Start with } 5x + 18 = 3(2x + 9) + 12\\\\`);
                for (let i = 1; i <= n - 6; i++) {
                    if (i === 1) lines.push(`5x + 18 = 6x + 27 + 12\\\\`);
                    else if (i === 2) lines.push(`5x + 18 = 6x + 39\\\\`);
                    else if (i === 3) lines.push(`18 = x + 39\\\\`);
                    else if (i === 4) lines.push(`18 - 39 = x\\\\`);
                    else if (i === 5) lines.push(`-21 = x\\\\`);
                    else {
                        // filler-but-plausible check lines (still maths, no extra UI constructs)
                        const k = i - 5;
                        lines.push(`\\text{Check }k=${k}:\\; 5(-21)+18 = -105+18 = -87\\\\`);
                    }
                }
                lines.push(`\\text{So }x = -21.\\\\`);
                lines.push(`\\text{Answer: }-21`);
                return `\\begin{aligned}\n${lines.join('\n')}\n\\end{aligned}`;
            }

            /* ---------- Dataset generation ---------- */
            function makeShortPaper() {
                const qs = [];
                qs.push({
                    label: '1',
                    depth: 0,
                    prompt: [
                        P('Fill in the missing number: \\(48 + \\square = 73\\).')
                    ],
                    diagrams: [],
                    answer: [
                        P('\\(25\\)')
                    ],
                    solution: {
                        guidance: null,
                        formulas: null,
                        working: [
                            P('Let the missing number be \\(a\\).'),
                            M(`\\begin{aligned}
48 + a &= 73\\\\
a &= 73 - 48\\\\
a &= 25
\\end{aligned}`, true),
                            P('Missing number \\(= 25\\).')
                        ],
                        alternatives: []
                    }
                });

                // Multi-part with nesting
                qs.push({
                    label: '2',
                    depth: 0,
                    prompt: [P('A box contains \\(36\\) counters. \\(\\tfrac{1}{4}\\) are red. How many are red?')],
                    diagrams: [],
                    answer: [P('\\(9\\)')],
                    solution: {
                        guidance: L(['Find \\(\\tfrac{1}{4}\\) by dividing by \\(4\\).']),
                        formulas: null,
                        working: [
                            M(`\\begin{aligned}
\\tfrac{1}{4}\\text{ of }36 &= 36 \\div 4\\\\
&= 9
\\end{aligned}`, true)
                        ],
                        alternatives: []
                    }
                });

                // Parent question with subparts (no mode switching)
                qs.push({
                    label: '3',
                    depth: 0,
                    prompt: [P('Answer the following.')],
                    diagrams: [],
                    answer: [P('')],
                    solution: {
                        guidance: null,
                        formulas: null,
                        working: [],
                        alternatives: []
                    }
                });

                qs.push({
                    label: '3a',
                    depth: 1,
                    prompt: [P('Write \\(0.6\\) as a fraction in its simplest form.')],
                    diagrams: [],
                    answer: [P('\\(\\tfrac{3}{5}\\)')],
                    solution: {
                        guidance: null,
                        formulas: null,
                        working: [
                            M(`\\begin{aligned}
0.6 &= \\tfrac{6}{10}\\\\
&= \\tfrac{3}{5}
\\end{aligned}`, true)
                        ],
                        alternatives: []
                    }
                });

                qs.push({
                    label: '3b',
                    depth: 1,
                    prompt: [P('A rectangle has length \\(8\\,\\text{cm}\\) and width \\(5\\,\\text{cm}\\). Find its area.')],
                    diagrams: [diagramBlock('array', 'A rectangle can be represented as an array.')],
                    answer: [P('\\(40\\,\\text{cm}^2\\)')],
                    solution: {
                        guidance: null,
                        formulas: L(['Area of a rectangle: \\(A = \\ell \\times w\\).']),
                        working: [
                            M(`\\begin{aligned}
A &= 8 \\times 5\\\\
&= 40\\,\\text{cm}^2
\\end{aligned}`, true)
                        ],
                        alternatives: []
                    }
                });

                qs.push({
                    label: '4',
                    depth: 0,
                    prompt: [P('The mean of \\(6\\), \\(8\\), \\(11\\), and \\(15\\) is \\(m\\). Find \\(m\\).')],
                    diagrams: [],
                    answer: [P('\\(10\\)')],
                    solution: {
                        guidance: L(['Add the numbers, then divide by how many numbers there are.']),
                        formulas: L(['Mean \\(= \\tfrac{\\text{sum}}{\\text{count}}\\).']),
                        working: [
                            M(`\\begin{aligned}
m &= \\tfrac{6+8+11+15}{4}\\\\
&= \\tfrac{40}{4}\\\\
&= 10
\\end{aligned}`, true)
                        ],
                        alternatives: []
                    }
                });

                qs.push({
                    label: '5',
                    depth: 0,
                    prompt: [P('A shop reduces a \\(\\pounds 30\\) item by \\(20\\%\\). What is the new price?')],
                    diagrams: [],
                    answer: [P('\\(\\pounds 24\\)')],
                    solution: {
                        guidance: L(['Find \\(20\\%\\) of \\(30\\), then subtract it from \\(30\\).']),
                        formulas: L(['\\(\\text{Percentage} = \\tfrac{\\text{part}}{\\text{whole}}\\times 100\\%\\).']),
                        working: [
                            M(`\\begin{aligned}
20\\%\\text{ of }30 &= \\tfrac{20}{100}\\times 30\\\\
&= 6\\\\
\\text{New price} &= 30 - 6 = 24
\\end{aligned}`, true)
                        ],
                        alternatives: []
                    }
                });

                qs.push({
                    label: '6',
                    depth: 0,
                    prompt: [P('Solve: \\(3x + 7 = 25\\).')],
                    diagrams: [],
                    answer: [P('\\(x = 6\\)')],
                    solution: {
                        guidance: null,
                        formulas: null,
                        working: [
                            M(`\\begin{aligned}
3x + 7 &= 25\\\\
3x &= 18\\\\
x &= 6
\\end{aligned}`, true)
                        ],
                        alternatives: [
                            [
                                P('Subtract \\(7\\) from both sides, then divide by \\(3\\).'),
                                M(`\\begin{aligned}
3x &= 25 - 7\\\\
3x &= 18\\\\
x &= 18\\div 3 = 6
\\end{aligned}`, true)
                            ]
                        ]
                    }
                });

                return {
                    key: 'short',
                    name: 'Short paper',
                    note: '6 questions • mix of short arithmetic and one multi-part question',
                    defaultExpanded: false,
                    questions: qs
                };
            }

            function makeStandardPaper(allExpanded) {
                const qs = [];

                // Q1–Q10: small/medium mix
                for (let i = 1; i <= 10; i++) {
                    const label = String(i);
                    const isDiag = (i === 8);
                    const promptText = (i === 1)
                        ? 'Calculate \\(308 + 86 + 4444\\).'
                        : (i === 2)
                            ? 'Subtract three hundred and three from six thousand and sixty.'
                            : (i === 3)
                                ? 'Multiply \\(345\\) by \\(67\\).'
                                : (i === 4)
                                    ? 'Divide \\(3112\\) by \\(8\\).'
                                    : (i === 5)
                                        ? 'Write the fractions in ascending order: \\(\\tfrac34,\\ \\tfrac35,\\ \\tfrac{9}{10},\\ \\tfrac{17}{20}\\).'
                                        : (i === 6)
                                            ? 'A film starts at \\(6{:}45\\,\\text{pm}\\) and lasts \\(2\\) hours \\(35\\) minutes. When does it finish?'
                                            : (i === 7)
                                                ? 'A square has perimeter \\(64\\,\\text{cm}\\). Find its area.'
                                                : (i === 8)
                                                    ? 'On this coordinate grid, point \\(P\\) is shown. Write the coordinates of \\(P\\).'
                                                    : (i === 9)
                                                        ? 'Seven consecutive whole numbers add up to \\(735\\). What is the largest?'
                                                        : 'Solve: \\(5y - 9 = 3y + 15\\).';

                    const answerText = (i === 1) ? '\\(4838\\)'
                        : (i === 2) ? '\\(5757\\)'
                            : (i === 3) ? '\\(23115\\)'
                                : (i === 4) ? '\\(389\\)'
                                    : (i === 5) ? '\\(\\tfrac35,\\ \\tfrac34,\\ \\tfrac{17}{20},\\ \\tfrac{9}{10}\\)'
                                        : (i === 6) ? '\\(9{:}20\\,\\text{pm}\\)'
                                            : (i === 7) ? '\\(256\\,\\text{cm}^2\\)'
                                                : (i === 8) ? '\\((4,3)\\)'
                                                    : (i === 9) ? '\\(108\\)'
                                                        : '\\(y = 12\\)';

                    const guidance = (i === 3 || i === 4 || i === 10) ? L(['Use BIDMAS and keep operations in order.']) :
                        (i === 6) ? L(['Convert times carefully and keep units consistent.']) :
                            (i === 5) ? L(['Use a common denominator to compare fractions.']) :
                                null;

                    const formulas = (i === 7) ? L(['Perimeter of a square: \\(P = 4s\\).', 'Area of a square: \\(A = s^2\\).']) :
                        (i === 5) ? L(['To compare fractions, write them with a common denominator.']) :
                            null;

                    const diagrams = isDiag ? [diagramBlock('grid', 'Coordinate grid (grayscale placeholder).')] : [];

                    let workingBlocks = [];
                    if (i === 1) {
                        workingBlocks = [
                            M(`\\begin{aligned}
308 + 86 + 4444 &= 394 + 4444\\\\
&= 4838
\\end{aligned}`, true)
                        ];
                    } else if (i === 2) {
                        workingBlocks = [M(`\\begin{aligned}
6060 - 303 &= 5757
\\end{aligned}`, true)];
                    } else if (i === 3) {
                        workingBlocks = [
                            M(`\\begin{aligned}
345\\times 67 &= 345\\times(60+7)\\\\
&= 345\\times60 + 345\\times7\\\\
&= 20700 + 2415\\\\
&= 23115
\\end{aligned}`, true)
                        ];
                    } else if (i === 4) {
                        workingBlocks = [
                            M(`\\begin{aligned}
\\tfrac{3112}{8} &= 389
\\end{aligned}`, true)
                        ];
                    } else if (i === 5) {
                        workingBlocks = [
                            P('Write each fraction out of \\(20\\).'),
                            M(`\\begin{aligned}
\\tfrac{3}{5} &= \\tfrac{12}{20}\\\\
\\tfrac{3}{4} &= \\tfrac{15}{20}\\\\
\\tfrac{17}{20} &= \\tfrac{17}{20}\\\\
\\tfrac{9}{10} &= \\tfrac{18}{20}
\\end{aligned}`, true),
                            P('So: \\(\\tfrac{12}{20} < \\tfrac{15}{20} < \\tfrac{17}{20} < \\tfrac{18}{20}\\).')
                        ];
                    } else if (i === 6) {
                        workingBlocks = [
                            M(`\\begin{aligned}
6{:}45 + 2{:}35 &= 9{:}20
\\end{aligned}`, true)
                        ];
                    } else if (i === 7) {
                        workingBlocks = [
                            M(`\\begin{aligned}
4s &= 64\\\\
s &= 16\\\\
A &= 16^2 = 256
\\end{aligned}`, true)
                        ];
                    } else if (i === 8) {
                        workingBlocks = [
                            P('Read the x-value first, then the y-value.'),
                            M(`\\begin{aligned}
P &= (4,3)
\\end{aligned}`, true)
                        ];
                    } else if (i === 9) {
                        workingBlocks = [
                            P('Seven consecutive numbers have mean \\(735\\div 7 = 105\\).'),
                            P('So they are \\(102,103,104,105,106,107,108\\).'),
                            P('Largest \\(=108\\).')
                        ];
                    } else {
                        workingBlocks = [
                            M(`\\begin{aligned}
5y - 9 &= 3y + 15\\\\
2y &= 24\\\\
y &= 12
\\end{aligned}`, true)
                        ];
                    }

                    const alt = (i === 10)
                        ? [[
                            P('Move the \\(y\\) terms to one side and the constants to the other.'),
                            M(`\\begin{aligned}
5y - 3y &= 15 + 9\\\\
2y &= 24\\\\
y &= 12
\\end{aligned}`, true)
                        ]]
                        : [];

                    qs.push({
                        label,
                        depth: 0,
                        prompt: [P(promptText)],
                        diagrams,
                        answer: [P(answerText)],
                        solution: {
                            guidance,
                            formulas,
                            working: workingBlocks,
                            alternatives: alt
                        }
                    });
                }

                // Deep nesting pack: Q18(a)(i), Q18(a)(ii), Q18(b)
                qs.push({
                    label: '18',
                    depth: 0,
                    prompt: [P('Answer the following.')],
                    diagrams: [],
                    answer: [P('')],
                    solution: { guidance: null, formulas: null, working: [], alternatives: [] }
                });
                qs.push({
                    label: '18(a)(i)',
                    depth: 1,
                    prompt: [P('Solve: \\(2x + 5 = 17\\).')],
                    diagrams: [],
                    answer: [P('\\(x=6\\)')],
                    solution: {
                        guidance: null,
                        formulas: null,
                        working: [
                            M(`\\begin{aligned}
2x + 5 &= 17\\\\
2x &= 12\\\\
x &= 6
\\end{aligned}`, true)
                        ],
                        alternatives: []
                    }
                });
                qs.push({
                    label: '18(a)(ii)',
                    depth: 1,
                    prompt: [P('Now solve: \\(3x - 4 = 2x + 9\\).')],
                    diagrams: [],
                    answer: [P('\\(x=13\\)')],
                    solution: {
                        guidance: null,
                        formulas: null,
                        working: [
                            M(`\\begin{aligned}
3x - 4 &= 2x + 9\\\\
x &= 13
\\end{aligned}`, true)
                        ],
                        alternatives: []
                    }
                });
                qs.push({
                    label: '18(b)',
                    depth: 1,
                    prompt: [P('A recipe uses flour and sugar in the ratio \\(3:2\\). If flour is \\(450\\,\\text{g}\\), how much sugar is needed?')],
                    diagrams: [diagramBlock('bars', 'Ratio bars (grayscale placeholder).')],
                    answer: [P('\\(300\\,\\text{g}\\)')],
                    solution: {
                        guidance: L(['If \\(3\\) parts \\(=450\\), then \\(1\\) part is \\(450\\div 3\\).']),
                        formulas: null,
                        working: [
                            M(`\\begin{aligned}
1\\text{ part} &= 450\\div 3 = 150\\\\
2\\text{ parts} &= 2\\times150 = 300
\\end{aligned}`, true)
                        ],
                        alternatives: []
                    }
                });

                // Q20 with a combined Solution Details variant (Guidance + Formulas + Alternative)
                qs.push({
                    label: '20',
                    depth: 0,
                    prompt: [P('A bag contains \\(3\\) red and \\(5\\) blue counters. One counter is taken at random. What is the probability it is red?')],
                    diagrams: [],
                    answer: [P('\\(\\tfrac{3}{8}\\)')],
                    solution: {
                        guidance: L(['Probability is \\(\\tfrac{\\text{number of favourable outcomes}}{\\text{total outcomes}}\\).']),
                        formulas: L(['\\(P(A)=\\tfrac{\\text{favourable}}{\\text{total}}\\).']),
                        working: [
                            M(`\\begin{aligned}
P(\\text{red}) &= \\tfrac{3}{3+5}\\\\
&= \\tfrac{3}{8}
\\end{aligned}`, true)
                        ],
                        alternatives: [[
                            P('Count totals first, then write the fraction.'),
                            M(`\\begin{aligned}
\\text{Total} &= 8\\\\
P(\\text{red}) &= \\tfrac{3}{8}
\\end{aligned}`, true)
                        ]]
                    }
                });

                // Q26–Q35: long algebra / long solution details (collapsed by default unless allExpanded dataset)
                for (let q = 21; q <= 35; q++) {
                    if (q === 30) {
                        // Parent with sub-structure (deep nesting add-on)
                        qs.push({
                            label: '30',
                            depth: 0,
                            prompt: [P('Solve the following.')],
                            diagrams: [],
                            answer: [P('')],
                            solution: { guidance: null, formulas: null, working: [], alternatives: [] }
                        });
                        qs.push({
                            label: '30(a)(i)',
                            depth: 1,
                            prompt: [P('Simplify: \\(\\tfrac{6x}{9} - \\tfrac{x}{3}\\).')],
                            diagrams: [],
                            answer: [P('\\(\\tfrac{x}{3}\\)')],
                            solution: {
                                guidance: null,
                                formulas: L(['To subtract fractions, use a common denominator.']),
                                working: [
                                    M(`\\begin{aligned}
\\tfrac{6x}{9} &= \\tfrac{2x}{3}\\\\
\\tfrac{2x}{3} - \\tfrac{x}{3} &= \\tfrac{x}{3}
\\end{aligned}`, true)
                                ],
                                alternatives: []
                            }
                        });
                        qs.push({
                            label: '30(a)(ii)',
                            depth: 1,
                            prompt: [P('Solve: \\(\\tfrac{x}{4} + 7 = 10\\).')],
                            diagrams: [],
                            answer: [P('\\(x=12\\)')],
                            solution: {
                                guidance: null,
                                formulas: null,
                                working: [
                                    M(`\\begin{aligned}
\\tfrac{x}{4} &= 3\\\\
x &= 12
\\end{aligned}`, true)
                                ],
                                alternatives: []
                            }
                        });
                        qs.push({
                            label: '30(b)',
                            depth: 1,
                            prompt: [P('A number is increased by \\(15\\%\\) to give \\(92\\). What was the original number?')],
                            diagrams: [],
                            answer: [P('\\(80\\)')],
                            solution: {
                                guidance: L(['If \\(15\\%\\) is added, the final is \\(115\\%\\) of the original.']),
                                formulas: L(['\\(\\text{Final} = \\tfrac{115}{100}\\times \\text{Original}\\).']),
                                working: [
                                    M(`\\begin{aligned}
92 &= \\tfrac{115}{100}x\\\\
x &= 92\\times \\tfrac{100}{115}\\\\
x &= 80
\\end{aligned}`, true)
                                ],
                                alternatives: [[
                                    P('Work with decimals: \\(1.15x = 92\\).'),
                                    M(`\\begin{aligned}
x &= 92\\div 1.15\\\\
x &= 80
\\end{aligned}`, true)
                                ]]
                            }
                        });
                        continue;
                    }

                    const label = String(q);
                    const isLong = (q >= 26);
                    const prompt = isLong
                        ? `A quadratic expression is \\(x^2 + ${q - 20}x - ${q + 10}\\). Factorise it.`
                        : `Calculate: \\((${q + 11} - ${q - 3} + ${q % 9}) \\div ${q % 7 + 2}\\).`;

                    const answer = isLong
                        ? `\\((x + ${Math.floor((q - 20) / 2)})(x + ${Math.ceil((q - 20) / 2)})\\) (one possible factorisation)`
                        : `\\(${Math.floor(((q + 11) - (q - 3) + (q % 9)) / (q % 7 + 2))}\\)`;

                    // Coverage: ensure ≥3 guidance, ≥3 formulas, ≥3 alternative working across paper
                    const includeGuidance = (q === 22 || q === 24 || q === 27 || q === 31);
                    const includeFormulas = (q === 23 || q === 27 || q === 29 || q === 33);
                    const includeAlt = (q === 24 || q === 28 || q === 31 || q === 34);

                    const guidance = includeGuidance ? L([
                        'Take it one step at a time and keep your expressions tidy.',
                        'If you get stuck, rewrite the problem in a simpler form first.'
                    ]) : null;

                    const formulas = includeFormulas ? L([
                        'Factorising: find two numbers that multiply to the constant term and add to the coefficient of \\(x\\).',
                        'If needed: \\(ax^2+bx+c = a(x-r)(x-s)\\) for roots \\(r,s\\).'
                    ]) : null;

                    const working = isLong
                        ? [
                            P('We want two numbers that add to the middle coefficient and multiply to the constant term.'),
                            M(`\\begin{aligned}
x^2 + ${q - 20}x - ${q + 10}
&= (x + a)(x + b)\\\\
a+b &= ${q - 20}\\\\
ab &= -${q + 10}
\\end{aligned}`, true),
                            P('Choose a pair \\((a,b)\\) that fits those conditions (one possible pair shown).'),
                            M(`\\begin{aligned}
x^2 + ${q - 20}x - ${q + 10}
&= (x + ${Math.floor((q - 20) / 2)})(x + ${Math.ceil((q - 20) / 2)})
\\end{aligned}`, true),
                            // Extremely long working for selected questions (50–60 lines)
                            ...(q === 33 ? [P('Long working stress test (many lines):'), M(longAlignedLines(55), true)] : [])
                        ]
                        : [
                            M(`\\begin{aligned}
(${q + 11} - ${q - 3} + ${q % 9}) \\div ${q % 7 + 2}
&= (${14} + ${q % 9}) \\div ${q % 7 + 2}
\\end{aligned}`, true)
                        ];

                    const alternatives = includeAlt ? [[
                        P('Alternative approach: rewrite and simplify before factorising.'),
                        M(`\\begin{aligned}
x^2 + ${q - 20}x - ${q + 10}
&= x^2 + ${q - 20}x + \\left(\\tfrac{${q - 20}}{2}\\right)^2 - \\left(\\tfrac{${q - 20}}{2}\\right)^2 - ${q + 10}
\\end{aligned}`, true),
                        P('Then complete the square and work from there.')
                    ]] : [];

                    const diagrams = (q === 25) ? [diagramBlock('geometry', 'A geometry placeholder used in the question.')] : [];

                    // Include a table in a working to stress test table overflow (within solution details)
                    const extraTable = (q === 28) ? [
                        P('Trial pairs for the constant term:'),
                        TBL(['Pair', 'Sum', 'Product'], [
                            ['\\((-1, ${q+10})\\)', `\\(${q + 9}\\)`, `\\(-${q + 10}\\)`],
                            [`\\((-2, ${Math.floor((q + 10) / 2)})\\)`, `\\(${Math.floor((q + 10) / 2) - 2}\\)`, `\\(-${(q + 10)}\\)`],
                            [`\\((5, -${Math.floor((q + 10) / 5)})\\)`, `\\(${5 - Math.floor((q + 10) / 5)}\\)`, `\\(-${(q + 10)}\\)`]
                        ])
                    ] : [];

                    qs.push({
                        label,
                        depth: 0,
                        prompt: [P(prompt)],
                        diagrams,
                        answer: [P(answer)],
                        solution: {
                            guidance,
                            formulas,
                            working: [...working, ...extraTable],
                            alternatives
                        }
                    });
                }

                return {
                    key: allExpanded ? 'standardExpanded' : 'standard',
                    name: allExpanded ? 'Standard (Workings Expanded)' : 'Standard paper',
                    note: allExpanded
                        ? '35 questions • all Solution Details start expanded (stress test)'
                        : '35 questions • Q26–Q35 include long algebra • Solution Details collapsed by default',
                    defaultExpanded: !!allExpanded,
                    questions: qs
                };
            }

            function makeDiagramHeavyPaper() {
                const qs = [];
                const diagramIndices = new Set([2, 4, 6, 8, 11, 14, 17, 20]); // 8 diagrams

                for (let i = 1; i <= 20; i++) {
                    const label = String(i);
                    const withDiagram = diagramIndices.has(i);
                    const kind = (i % 4 === 1) ? 'geometry' : (i % 4 === 2) ? 'bars' : (i % 4 === 3) ? 'grid' : 'array';

                    const prompt = withDiagram
                        ? `Use the diagram to answer the question.`
                        : `Calculate: \\(${10 + i} \\times ${i % 7 + 3}\\).`;

                    const answer = withDiagram
                        ? (kind === 'grid' ? '\\((4,3)\\)' : kind === 'bars' ? '\\(\\tfrac{3}{5}\\)' : kind === 'geometry' ? '\\(46\\,\\text{cm}\\)' : '\\(12\\)')
                        : `\\(${(10 + i) * (i % 7 + 3)}\\)`;

                    const diagrams = withDiagram ? [diagramBlock(kind, 'Diagram placeholder (grayscale).')] : [];

                    const guidance = withDiagram
                        ? L(['Look carefully at labels and read values directly from the diagram where possible.'])
                        : null;

                    const formulas = (withDiagram && kind === 'geometry')
                        ? L(['Circle circumference: \\(C = 2\\pi r\\) (if needed).'])
                        : null;

                    const working = withDiagram
                        ? (kind === 'bars'
                            ? [P('If the whole bar is \\(5\\) equal parts and \\(3\\) are shaded, the fraction is:'), M(`\\begin{aligned}\\tfrac{3}{5}\\end{aligned}`, true)]
                            : kind === 'grid'
                                ? [P('Read the coordinates from the grid.'), M(`\\begin{aligned}P=(4,3)\\end{aligned}`, true)]
                                : kind === 'geometry'
                                    ? [P('Use the given lengths on the diagram.'), M(`\\begin{aligned}\\text{Perimeter}=46\\,\\text{cm}\\end{aligned}`, true)]
                                    : [P('Count the total in the array.'), M(`\\begin{aligned}\\text{Total}=12\\end{aligned}`, true)]
                        )
                        : [M(`\\begin{aligned}
${10 + i}\\times ${i % 7 + 3} = ${(10 + i) * (i % 7 + 3)}
\\end{aligned}`, true)];

                    qs.push({
                        label,
                        depth: 0,
                        prompt: [P(prompt)],
                        diagrams,
                        answer: [P(answer)],
                        solution: {
                            guidance,
                            formulas,
                            working,
                            alternatives: []
                        }
                    });
                }

                return {
                    key: 'diagram',
                    name: 'Diagram-heavy paper',
                    note: '20 questions • 8 questions contain diagrams (inline SVG placeholders)',
                    defaultExpanded: false,
                    questions: qs
                };
            }

            function makeSectionedPaper() {
                const qs = [];

                // Section separators are represented in navigation only.
                // Content remains one linear document.

                // Section A: 35 questions small/medium
                for (let i = 1; i <= 35; i++) {
                    const label = String(i);
                    qs.push({
                        label,
                        depth: 0,
                        section: 'A',
                        prompt: [P(`Section A: Calculate \\(${i + 20} + ${i + 7}\\).`)],
                        diagrams: [],
                        answer: [P(`\\(${(i + 20) + (i + 7)}\\)`)],
                        solution: {
                            guidance: (i === 3 || i === 12 || i === 21) ? L(['Keep your place-value columns aligned if you use a written method.']) : null,
                            formulas: null,
                            working: [
                                M(`\\begin{aligned}
${i + 20} + ${i + 7} &= ${(i + 20) + (i + 7)}
\\end{aligned}`, true)
                            ],
                            alternatives: []
                        }
                    });
                }

                // Section B: 8 questions medium
                for (let i = 1; i <= 8; i++) {
                    const label = `B${i}`; // Not allowed (non-number-based). So keep numeric labels; section label handled separately.
                }
                for (let i = 36; i <= 43; i++) {
                    qs.push({
                        label: String(i),
                        depth: 0,
                        section: 'B',
                        prompt: [P(`Section B: Solve \\(${i - 30}x - 4 = 2x + ${i - 10}\\).`)],
                        diagrams: [],
                        answer: [P(`\\(x = ${Math.floor((i - 6) / ((i - 30) - 2))}\\)`)],
                        solution: {
                            guidance: (i === 37) ? L(['Collect the \\(x\\) terms on one side before dividing.']) : null,
                            formulas: null,
                            working: [
                                M(`\\begin{aligned}
${i - 30}x - 4 &= 2x + ${i - 10}\\\\
(${i - 30}-2)x &= ${i - 10} + 4\\\\
${(i - 32)}x &= ${i - 6}\\\\
x &= \\tfrac{${i - 6}}{${i - 32}}
\\end{aligned}`, true)
                            ],
                            alternatives: (i === 40) ? [[
                                P('Alternative: move constants first, then deal with coefficients.'),
                                M(`\\begin{aligned}
${i - 30}x &= 2x + ${i - 10} + 4\\\\
(${i - 32})x &= ${i - 6}
\\end{aligned}`, true)
                            ]] : []
                        }
                    });
                }

                // Section C: 6 questions all very long Solution Details (collapsed by default)
                for (let i = 44; i <= 49; i++) {
                    const label = String(i);
                    const hasAll = (i === 47); // Ensure at least one has Guidance + Formulas + Alternative
                    qs.push({
                        label,
                        depth: 0,
                        section: 'C',
                        prompt: [P(`Section C: A sequence is defined by \\(u_1=3\\) and \\(u_{n+1}=u_n+${i - 40}\\). Find \\(u_6\\).`)],
                        diagrams: (i === 46) ? [diagramBlock('array', 'A table-like diagram placeholder.')] : [],
                        answer: [P(`\\(u_6 = ${3 + 5 * (i - 40)}\\)`)],
                        solution: {
                            guidance: hasAll ? L([
                                'Write out the first few terms before jumping to a formula.',
                                'Check that you add the same amount each time.'
                            ]) : L(['List terms carefully and keep your additions consistent.']),
                            formulas: hasAll ? L([
                                'Arithmetic sequence: \\(u_n = u_1 + (n-1)d\\).',
                                'Here, \\(d=${i-40}\\).'
                            ]) : null,
                            working: [
                                P('Write out terms one by one:'),
                                M(`\\begin{aligned}
u_1 &= 3\\\\
u_2 &= 3 + ${i - 40}\\\\
u_3 &= 3 + 2(${i - 40})\\\\
u_4 &= 3 + 3(${i - 40})\\\\
u_5 &= 3 + 4(${i - 40})\\\\
u_6 &= 3 + 5(${i - 40}) = ${3 + 5 * (i - 40)}
\\end{aligned}`, true),
                                // Long working stress test in Section C too
                                ...(i === 49 ? [P('Extremely long working (many lines):'), M(longAlignedLines(58), true)] : [])
                            ],
                            alternatives: hasAll ? [[
                                P('Alternative: use the arithmetic sequence formula directly.'),
                                M(`\\begin{aligned}
u_6 &= u_1 + (6-1)d\\\\
&= 3 + 5\\times ${i - 40}\\\\
&= ${3 + 5 * (i - 40)}
\\end{aligned}`, true)
                            ]] : []
                        }
                    });
                }

                return {
                    key: 'sectioned',
                    name: 'Sectioned paper',
                    note: 'Section A: 35 • Section B: 8 • Section C: 6 (very long Solution Details)',
                    defaultExpanded: false,
                    questions: qs,
                    sections: ['A', 'B', 'C'],
                    // Navigation-only separators
                    navSeparators: [
                        { section: 'A', label: 'A', first: '1' },
                        { section: 'B', label: 'B', first: '36' },
                        { section: 'C', label: 'C', first: '44' }
                    ]
                };
            }

            const DATASETS = [
                makeShortPaper(),
                makeStandardPaper(false),
                makeStandardPaper(true),
                makeDiagramHeavyPaper(),
                makeSectionedPaper()
            ];

            /* ---------- Rendering helpers ---------- */
            function clear(el) { while (el.firstChild) el.removeChild(el.firstChild); }

            function renderInlineMathText(text) {
                // Supports inline \(...\) only inside paragraphs.
                // Display math is provided as separate blocks.
                const frag = document.createDocumentFragment();
                const s = String(text || '');
                let i = 0;
                while (i < s.length) {
                    const start = s.indexOf('\\(', i);
                    if (start === -1) {
                        frag.appendChild(document.createTextNode(s.slice(i)));
                        break;
                    }
                    frag.appendChild(document.createTextNode(s.slice(i, start)));
                    const end = s.indexOf('\\)', start + 2);
                    if (end === -1) {
                        // malformed; fallback to text
                        frag.appendChild(document.createTextNode(s.slice(start)));
                        break;
                    }
                    const latex = s.slice(start + 2, end);
                    const span = document.createElement('span');
                    span.className = 'inline-math';
                    span.setAttribute('data-math-inline', '');
                    span.setAttribute('data-latex', latex);
                    span.textContent = latex;
                    frag.appendChild(span);
                    i = end + 2;
                }
                return frag;
            }

            function makeBlock(block, context) {
                // context: { underlayAllowed: boolean } for display math underlay exception
                if (block.t === 'p') {
                    const p = document.createElement('p');
                    p.className = 'p';
                    p.appendChild(renderInlineMathText(block.text));
                    return p;
                }
                if (block.t === 'list') {
                    const ul = document.createElement('ul');
                    for (const item of block.items) {
                        const li = document.createElement('li');
                        li.appendChild(renderInlineMathText(item));
                        ul.appendChild(li);
                    }
                    return ul;
                }
                if (block.t === 'math') {
                    const div = document.createElement('div');
                    div.className = 'math-block';
                    if (context && context.underlayAllowed && block.underlay) {
                        div.classList.add('math-underlay');
                    }
                    div.setAttribute('data-math-display', '');
                    div.setAttribute('data-latex', block.latex);
                    div.textContent = block.latex; // fallback if KaTeX fails
                    return div;
                }
                if (block.t === 'table') {
                    const wrap = document.createElement('div');
                    wrap.className = 'table-wrap';
                    const table = document.createElement('table');
                    const thead = document.createElement('thead');
                    const trh = document.createElement('tr');
                    for (const h of block.headers) {
                        const th = document.createElement('th');
                        th.appendChild(renderInlineMathText(h));
                        trh.appendChild(th);
                    }
                    thead.appendChild(trh);
                    table.appendChild(thead);

                    const tbody = document.createElement('tbody');
                    for (const row of block.rows) {
                        const tr = document.createElement('tr');
                        for (const cell of row) {
                            const td = document.createElement('td');
                            td.appendChild(renderInlineMathText(cell));
                            tr.appendChild(td);
                        }
                        tbody.appendChild(tr);
                    }
                    table.appendChild(tbody);
                    wrap.appendChild(table);
                    return wrap;
                }
                if (block.t === 'diagram') {
                    const wrap = document.createElement('div');
                    wrap.className = 'diagram';
                    wrap.innerHTML = block.svg;
                    if (block.caption) {
                        const cap = document.createElement('div');
                        cap.className = 'cap';
                        cap.textContent = block.caption;
                        wrap.appendChild(cap);
                    }
                    return wrap;
                }
                const fallback = document.createElement('div');
                fallback.textContent = '';
                return fallback;
            }

            function renderSolutionDetails(soln, expandedByDefault) {
                const container = document.createElement('div');

                // Toggle
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'toggle';
                btn.setAttribute('aria-expanded', String(!!expandedByDefault));
                btn.innerHTML = `<span class="tlabel">${expandedByDefault ? 'Hide working' : 'Show working'}</span><span class="chev2" aria-hidden="true"></span>`;
                container.appendChild(btn);

                // Collapsible region
                const wrap = document.createElement('div');
                wrap.className = 'soln-wrap';
                wrap.dataset.open = String(!!expandedByDefault);
                wrap.setAttribute('aria-hidden', String(!expandedByDefault));

                const solnBox = document.createElement('div');
                solnBox.className = 'soln';
                const grid = document.createElement('div');
                grid.className = 'soln-grid';

                // Guidance / Keep in mind
                if (soln.guidance) {
                    const b = document.createElement('div');
                    b.className = 's-block guidance';
                    const label = document.createElement('div');
                    label.className = 's-label';
                    label.innerHTML = `<span class="g-icon" aria-hidden="true"></span><span>Keep in mind</span>`;
                    const body = document.createElement('div');
                    body.className = 's-body';
                    body.appendChild(makeBlock(soln.guidance, {}));
                    b.appendChild(label);
                    b.appendChild(body);
                    grid.appendChild(b);
                }

                // Formulas used
                if (soln.formulas) {
                    const b = document.createElement('div');
                    b.className = 's-block formulas';
                    const label = document.createElement('div');
                    label.className = 's-label';
                    label.textContent = 'Formulas used';
                    const body = document.createElement('div');
                    body.className = 's-body';

                    // Render formulas list lines as separate blocks for scannability (no extra UI controls)
                    const items = soln.formulas.items || [];
                    for (const line of items) {
                        const lineWrap = document.createElement('div');
                        lineWrap.className = 'formula-line';
                        lineWrap.appendChild(renderInlineMathText(line));
                        body.appendChild(lineWrap);
                    }
                    b.appendChild(label);
                    b.appendChild(body);

                    // Optional minimal divider before working (quiet hairline)
                    const div = document.createElement('div');
                    div.className = 'divider';
                    b.appendChild(div);

                    grid.appendChild(b);
                }

                // Working
                if (soln.working && soln.working.length) {
                    const b = document.createElement('div');
                    b.className = 's-block working';
                    const label = document.createElement('div');
                    label.className = 's-label';
                    label.textContent = 'Working';
                    const body = document.createElement('div');
                    body.className = 's-body';

                    // Underlay exception: display-math only within working/alt blocks
                    for (const blk of soln.working) {
                        body.appendChild(makeBlock(blk, { underlayAllowed: true }));
                    }
                    b.appendChild(label);
                    b.appendChild(body);
                    grid.appendChild(b);
                }

                // Alternative working(s)
                if (soln.alternatives && soln.alternatives.length) {
                    for (const altBlocks of soln.alternatives) {
                        const b = document.createElement('div');
                        b.className = 's-block alt';
                        const label = document.createElement('div');
                        label.className = 's-label';
                        label.textContent = 'Alternative working';
                        const body = document.createElement('div');
                        body.className = 's-body';
                        for (const blk of altBlocks) {
                            body.appendChild(makeBlock(blk, { underlayAllowed: true }));
                        }
                        b.appendChild(label);
                        b.appendChild(body);
                        grid.appendChild(b);
                    }
                }

                solnBox.appendChild(grid);
                wrap.appendChild(solnBox);
                container.appendChild(wrap);

                // Ensure collapsed content not focusable
                if (!expandedByDefault) {
                    wrap.inert = true;
                }

                // Setup initial height for transitions
                requestAnimationFrame(() => {
                    if (expandedByDefault) {
                        // expand
                        wrap.style.maxHeight = wrap.scrollHeight + 'px';
                        // after transition, remove maxHeight cap
                        setTimeout(() => { wrap.style.maxHeight = 'none'; }, prefersReduced ? 0 : 200);
                    } else {
                        wrap.style.maxHeight = '0px';
                    }
                });

                btn.addEventListener('click', () => {
                    const isOpen = btn.getAttribute('aria-expanded') === 'true';
                    const next = !isOpen;

                    btn.setAttribute('aria-expanded', String(next));
                    btn.querySelector('.tlabel').textContent = next ? 'Hide working' : 'Show working';

                    // Toggle open/close with calm continuity
                    if (next) {
                        wrap.inert = false;
                        wrap.setAttribute('aria-hidden', 'false');
                        wrap.dataset.open = 'true';
                        // set from 0 to content height
                        wrap.style.maxHeight = wrap.scrollHeight + 'px';
                        if (!prefersReduced) {
                            setTimeout(() => { wrap.style.maxHeight = 'none'; }, 200);
                        } else {
                            wrap.style.maxHeight = 'none';
                        }
                    } else {
                        // from auto to height then to 0
                        wrap.style.maxHeight = wrap.scrollHeight + 'px';
                        // force reflow
                        void wrap.offsetHeight;
                        wrap.style.maxHeight = '0px';
                        wrap.dataset.open = 'false';
                        wrap.setAttribute('aria-hidden', 'true');
                        if (!prefersReduced) {
                            setTimeout(() => { wrap.inert = true; }, 200);
                        } else {
                            wrap.inert = true;
                        }
                    }
                });

                return container;
            }

            function renderQuestion(q, datasetDefaultExpanded) {
                const section = document.createElement('article');
                section.className = `q depth-${q.depth || 0}`;
                section.id = uidFromLabel(q.label);
                section.dataset.label = q.label;

                const inner = document.createElement('div');
                inner.className = `q-inner ${q.depth ? ('depth-' + q.depth) : ''}`;

                const head = document.createElement('div');
                head.className = 'q-head';
                const id = document.createElement('div');
                id.className = 'qid';
                id.textContent = q.label;
                const qtext = document.createElement('p');
                qtext.className = 'qtext';
                // If prompt blocks empty, keep calm: show nothing after identifier
                if (q.prompt && q.prompt.length) {
                    // Join prompt blocks into a single paragraph rhythm for the question prompt
                    // (diagrams remain separate, inside question block)
                    const first = q.prompt[0];
                    if (first && first.t === 'p') {
                        qtext.appendChild(renderInlineMathText(first.text));
                    } else {
                        qtext.textContent = '';
                    }
                } else {
                    qtext.textContent = '';
                }
                head.appendChild(id);
                head.appendChild(qtext);

                const body = document.createElement('div');
                body.className = 'q-body';

                // Additional prompt blocks beyond first (if any)
                if (q.prompt && q.prompt.length > 1) {
                    for (let i = 1; i < q.prompt.length; i++) {
                        body.appendChild(makeBlock(q.prompt[i], {}));
                    }
                }

                // Diagrams (inside question)
                if (q.diagrams && q.diagrams.length) {
                    for (const d of q.diagrams) {
                        body.appendChild(makeBlock(d, {}));
                    }
                }

                // Answer
                const ans = document.createElement('div');
                ans.className = 'answer';
                const al = document.createElement('span');
                al.className = 'alabel';
                al.textContent = 'Answer';
                const av = document.createElement('span');
                av.className = 'aval';
                if (q.answer && q.answer.length) {
                    // render answer as inline-rich text blocks; if multiple, stack quietly
                    if (q.answer.length === 1 && q.answer[0].t === 'p') {
                        av.appendChild(renderInlineMathText(q.answer[0].text));
                    } else {
                        // if multiple, render first inline and the rest below as separate p
                        const wrap = document.createElement('span');
                        wrap.appendChild(renderInlineMathText(q.answer[0].text || ''));
                        av.appendChild(wrap);
                    }
                }
                ans.appendChild(al);
                ans.appendChild(av);
                body.appendChild(ans);

                // Solution details toggle + contents
                const expandedByDefault = (typeof q.expanded === 'boolean') ? q.expanded : datasetDefaultExpanded;
                const sd = renderSolutionDetails(q.solution || { guidance: null, formulas: null, working: [], alternatives: [] }, expandedByDefault);
                body.appendChild(sd);

                inner.appendChild(head);
                inner.appendChild(body);
                section.appendChild(inner);

                return section;
            }

            function renderNav(dataset) {
                clear(navList);
                clear(drawerNav);

                const items = buildNavItems(dataset);

                for (const item of items) {
                    if (item.type === 'sep') {
                        const sep1 = document.createElement('div');
                        sep1.className = 'nav-sep';
                        sep1.textContent = item.label;
                        navList.appendChild(sep1);

                        const sep2 = document.createElement('div');
                        sep2.className = 'nav-sep';
                        sep2.textContent = item.label;
                        drawerNav.appendChild(sep2);
                        continue;
                    }

                    const a1 = document.createElement('a');
                    a1.href = '#' + item.anchor;
                    a1.className = 'nav-item';
                    a1.textContent = item.label;
                    a1.addEventListener('click', (e) => onNavClick(e, item.anchor));
                    navList.appendChild(a1);

                    const a2 = document.createElement('a');
                    a2.href = '#' + item.anchor;
                    a2.className = 'nav-item';
                    a2.textContent = item.label;
                    a2.addEventListener('click', (e) => {
                        onNavClick(e, item.anchor);
                        closeDrawerNow();
                    });
                    drawerNav.appendChild(a2);
                }
            }

            function buildNavItems(dataset) {
                const out = [];
                if (dataset.navSeparators && dataset.navSeparators.length) {
                    // Insert separators based on section changes
                    let currentSection = null;
                    for (const q of dataset.questions) {
                        const sec = q.section || null;
                        if (sec && sec !== currentSection) {
                            currentSection = sec;
                            out.push({ type: 'sep', label: sec });
                        }
                        out.push({ type: 'item', label: q.label, anchor: uidFromLabel(q.label) });
                    }
                    return out;
                }
                // No sections: simple list
                for (const q of dataset.questions) {
                    out.push({ type: 'item', label: q.label, anchor: uidFromLabel(q.label) });
                }
                return out;
            }

            function onNavClick(e, anchor) {
                e.preventDefault();
                const el = document.getElementById(anchor);
                if (!el) return;

                // Smooth scroll to keep orientation (Stage 5.5.3)
                el.scrollIntoView({ behavior: prefersReduced ? 'auto' : 'smooth', block: 'start' });

                // Do not change expanded/collapsed state (Invariant)
                // Do not move focus automatically (Accessibility rule)
            }

            /* ---------- Active nav highlighting (IntersectionObserver) ---------- */
            let io = null;
            function setupActiveTracking() {
                if (io) io.disconnect();
                const targets = $$('.q', paperEl);

                const active = { id: null };
                io = new IntersectionObserver((entries) => {
                    // Choose the closest-to-top visible question.
                    // Strategy: track entries that intersect, then pick smallest boundingClientRect.top >= -20
                    const visible = entries
                        .filter(en => en.isIntersecting)
                        .map(en => ({ id: en.target.id, top: en.boundingClientRect.top }))
                        .sort((a, b) => Math.abs(a.top) - Math.abs(b.top));

                    if (!visible.length) return;
                    const nextId = visible[0].id;
                    if (nextId === active.id) return;
                    active.id = nextId;
                    updateActiveNav('#' + nextId);
                }, {
                    root: null,
                    threshold: [0.05, 0.12, 0.2]
                });

                for (const t of targets) io.observe(t);

                // Initialize
                requestAnimationFrame(() => {
                    const first = targets[0];
                    if (first) updateActiveNav('#' + first.id);
                });
            }

            function updateActiveNav(hash) {
                const id = (hash || '').replace('#', '');
                const setActive = (root) => {
                    $$('.nav-item', root).forEach(a => {
                        const isActive = a.getAttribute('href') === '#' + id;
                        a.dataset.active = String(isActive);
                    });
                };
                setActive(navList);
                setActive(drawerNav);
            }

            /* ---------- Drawer (mobile) ---------- */
            let lastFocus = null;
            function openDrawer() {
                // Only meaningful on small screens, but safe everywhere.
                lastFocus = document.activeElement;
                drawerRoot.dataset.open = 'true';
                drawerRoot.setAttribute('aria-hidden', 'false');

                // Prevent background interaction (required)
                // Use inert where supported; fallback: aria-hidden + disable tabbing on background interactive elements
                main.setAttribute('aria-hidden', 'true');
                main.inert = true;
                navList.setAttribute('aria-hidden', 'true');
                navList.inert = true;

                // Focus first nav item
                const first = drawerNav.querySelector('.nav-item');
                (first || closeDrawer).focus();

                // Trap focus inside drawer
                document.addEventListener('keydown', trapFocus, true);
                document.addEventListener('keydown', onEsc, true);
            }

            function closeDrawerNow() {
                drawerRoot.dataset.open = 'false';
                drawerRoot.setAttribute('aria-hidden', 'true');

                main.removeAttribute('aria-hidden');
                main.inert = false;
                navList.removeAttribute('aria-hidden');
                navList.inert = false;

                document.removeEventListener('keydown', trapFocus, true);
                document.removeEventListener('keydown', onEsc, true);

                if (lastFocus && lastFocus.focus) lastFocus.focus();
            }

            function onEsc(e) {
                if (e.key === 'Escape') {
                    e.preventDefault();
                    closeDrawerNow();
                }
            }

            function trapFocus(e) {
                if (e.key !== 'Tab') return;
                const focusables = $$('a[href], button:not([disabled]), [tabindex]:not([tabindex="-1"]), select', drawerRoot)
                    .filter(el => el.offsetParent !== null);
                if (!focusables.length) return;
                const first = focusables[0];
                const last = focusables[focusables.length - 1];
                if (e.shiftKey && document.activeElement === first) {
                    e.preventDefault();
                    last.focus();
                } else if (!e.shiftKey && document.activeElement === last) {
                    e.preventDefault();
                    first.focus();
                }
            }

            jumpBtn.addEventListener('click', () => {
                const isOpen = drawerRoot.dataset.open === 'true';
                if (isOpen) closeDrawerNow();
                else openDrawer();
            });
            scrim.addEventListener('click', closeDrawerNow);
            closeDrawer.addEventListener('click', closeDrawerNow);

            /* ---------- KaTeX rendering (programmatic, graceful fallback) ---------- */
            function renderKaTeX() {
                // Wait for KaTeX to be available; if not, keep text fallback
                if (!window.katex || !window.katex.render) {
                    return;
                }

                // Inline
                $$('[data-math-inline]').forEach(el => {
                    const latex = el.getAttribute('data-latex') || el.textContent || '';
                    try {
                        window.katex.render(latex, el, {
                            throwOnError: false,
                            displayMode: false,
                            strict: "ignore"
                        });
                    } catch (_e) {
                        // fallback: keep text
                    }
                });

                // Display
                $$('[data-math-display]').forEach(el => {
                    const latex = el.getAttribute('data-latex') || el.textContent || '';
                    try {
                        // render into a child to preserve scroll container
                        const out = document.createElement('div');
                        window.katex.render(latex, out, {
                            throwOnError: false,
                            displayMode: true,
                            strict: "ignore"
                        });
                        // KaTeX renders into 'out'; move contents into el
                        el.textContent = '';
                        // Ensure the katex output can't force width
                        // (Contained by .math-block overflow-x)
                        el.appendChild(out);
                    } catch (_e) {
                        // fallback: keep text
                    }
                });
            }

            /* ---------- Mount dataset ---------- */
            function mountDataset(key) {
                const dataset = DATASETS.find(d => d.key === key) || DATASETS[0];

                paperName.textContent = dataset.name;
                paperNote.textContent = dataset.note;

                clear(paperEl);

                // Build paper content (single linear document)
                for (const q of dataset.questions) {
                    paperEl.appendChild(renderQuestion(q, dataset.defaultExpanded));
                }

                // Build navigation (question identifiers only)
                renderNav(dataset);

                // KaTeX render pass (after DOM update)
                requestAnimationFrame(() => {
                    renderKaTeX();
                    setupActiveTracking();
                });
            }

            /* ---------- Paper selector ---------- */
            function initSelector() {
                clear(paperSelect);
                for (const d of DATASETS) {
                    const opt = document.createElement('option');
                    opt.value = d.key;
                    opt.textContent = d.name;
                    paperSelect.appendChild(opt);
                }
                paperSelect.value = DATASETS[0].key;
                paperSelect.addEventListener('change', () => {
                    mountDataset(paperSelect.value);
                });
            }

            // Kick off
            initSelector();
            mountDataset(paperSelect.value);

            // Re-render KaTeX if it loads after initial paint
            // (graceful: if it never loads, text stays)
            let katexCheckTries = 0;
            const katexTimer = setInterval(() => {
                katexCheckTries++;
                if (window.katex && window.katex.render) {
                    clearInterval(katexTimer);
                    renderKaTeX();
                }
                if (katexCheckTries > 20) {
                    clearInterval(katexTimer);
                }
            }, 120);

        })();
    </script>
</body>

</html>