<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RTQ – Maths Paper Solution Viewer (Stress Test Harness)</title>

  <!-- KaTeX (CDN) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" crossorigin="anonymous">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js" crossorigin="anonymous"></script>

  <style>
    :root {
      /* Cool-neutral base direction (soft graphite bias) */
      --page-bg: #f3f5f7;
      --surface: #fbfcfd;
      --surface-2: #f6f8fa;
      --text: #121416;
      --muted: #4a5057;
      --quiet: #6a727b;
      --hairline: rgba(18,20,22,0.12);
      --hairline-2: rgba(18,20,22,0.08);

      /* Restrained non-semantic accent (links/focus/affordances only) */
      --accent: #2f5ea8;

      --frame-max: 1120px;

      --space-1: 6px;
      --space-2: 10px;
      --space-3: 14px;
      --space-4: 18px;
      --space-5: 24px;
      --space-6: 34px;

      --indent-1: 18px;
      --indent-2: 34px;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: var(--page-bg);
      color: var(--text);
      overflow-x: hidden; /* page must never scroll horizontally */
    }

    a { color: var(--accent); text-decoration: underline; text-underline-offset: 2px; }
    a:hover { text-decoration-thickness: 2px; }

    @media (prefers-reduced-motion: no-preference) {
      html { scroll-behavior: smooth; }
    }

    .topbar {
      padding: var(--space-4) 0 var(--space-3);
    }

    .frame {
      max-width: var(--frame-max);
      margin: 0 auto;
      padding: 0 var(--space-4) var(--space-6);
    }

    .controls {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--space-3);
    }

    .control-left {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      min-width: 0;
    }

    label {
      font-size: 13px;
      color: var(--quiet);
      white-space: nowrap;
    }

    select {
      font-size: 14px;
      padding: 8px 10px;
      border: 1px solid var(--hairline);
      border-radius: 10px;
      background: var(--surface);
      color: var(--text);
      max-width: 100%;
    }

    select:focus {
      outline: 2px solid color-mix(in oklab, var(--accent) 60%, transparent);
      outline-offset: 2px;
    }

    .jump {
      display: none;
      font-size: 14px;
      padding: 8px 10px;
      border: 1px solid var(--hairline);
      border-radius: 10px;
      background: var(--surface);
      color: var(--text);
    }
    .jump:hover { border-color: color-mix(in oklab, var(--hairline) 20%, var(--accent)); }
    .jump:focus {
      outline: 2px solid color-mix(in oklab, var(--accent) 60%, transparent);
      outline-offset: 2px;
    }

    .shell {
      background: var(--surface);
      padding: var(--space-5) var(--space-4);
    }

    .columns {
      display: grid;
      grid-template-columns: 170px 1fr;
      gap: var(--space-5);
      align-items: start;
    }

    nav {
      font-size: 13px;
      color: var(--quiet);
    }

    .nav-sticky {
      position: sticky;
      top: var(--space-4);
      max-height: calc(100vh - (var(--space-4) * 2));
      overflow: auto;
      padding-right: 6px;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    .nav-sticky::-webkit-scrollbar { display: none; }

    .nav-title {
      font-size: 12px;
      letter-spacing: 0.02em;
      text-transform: uppercase;
      color: color-mix(in oklab, var(--quiet) 80%, var(--text));
      margin: 0 0 var(--space-2);
    }

    .nav-section {
      margin: var(--space-3) 0 var(--space-2);
      font-size: 12px;
      color: color-mix(in oklab, var(--quiet) 80%, var(--text));
      text-transform: uppercase;
      letter-spacing: 0.02em;
      user-select: none;
    }

    .nav-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: grid;
      gap: 2px;
    }

    .nav-item a {
      display: block;
      padding: 4px 6px;
      border-radius: 8px;
      color: var(--quiet);
      text-decoration: none;
    }

    .nav-item a:hover {
      text-decoration: underline;
      text-underline-offset: 2px;
    }

    .nav-item a:focus {
      outline: 2px solid color-mix(in oklab, var(--accent) 60%, transparent);
      outline-offset: 2px;
      border-radius: 8px;
    }

    .nav-item[data-depth="0"] a { padding-left: 6px; }
    .nav-item[data-depth="1"] a { padding-left: 16px; }
    .nav-item[data-depth="2"] a { padding-left: 28px; }

    .nav-item.active a {
      font-weight: 700;
      color: color-mix(in oklab, var(--quiet) 55%, var(--text));
    }

    main { min-width: 0; }

    .paper-title {
      margin: 0 0 var(--space-4);
      font-size: 16px;
      font-weight: 650;
      color: var(--text);
    }

    .q { margin: 0 0 var(--space-6); }
    .q:last-child { margin-bottom: 0; }

    .q-inner {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: var(--space-3);
      align-items: start;
      min-width: 0;
    }

    .qid {
      font-size: 14px;
      font-weight: 650;
      color: color-mix(in oklab, var(--text) 92%, var(--quiet));
      line-height: 1.4;
      padding-top: 1px;
      white-space: nowrap;
    }

    .q-body { min-width: 0; }

    .q-text {
      font-size: 15px;
      line-height: 1.55;
      color: var(--text);
    }

    .q-text p { margin: 0 0 var(--space-2); }
    .q-text p:last-child { margin-bottom: 0; }

    .q-level-1 { padding-left: var(--indent-1); margin-top: var(--space-4); margin-bottom: var(--space-4); }
    .q-level-2 { padding-left: var(--indent-2); margin-top: var(--space-3); margin-bottom: var(--space-3); }

    .answer {
      margin-top: var(--space-2);
      display: flex;
      gap: var(--space-2);
      align-items: baseline;
      flex-wrap: wrap;
      font-size: 14px;
      line-height: 1.45;
      color: color-mix(in oklab, var(--text) 78%, var(--quiet));
    }

    .answer .label {
      font-weight: 650;
      color: color-mix(in oklab, var(--text) 84%, var(--quiet));
    }

    .answer .value {
      color: color-mix(in oklab, var(--text) 82%, var(--quiet));
    }

    details.sol { margin-top: var(--space-2); }

    summary.sol-toggle {
      list-style: none;
      cursor: pointer;
      user-select: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: var(--accent);
      text-decoration: underline;
      text-underline-offset: 2px;
      border-radius: 8px;
      padding: 2px 2px;
    }
    summary.sol-toggle::-webkit-details-marker { display: none; }

    summary.sol-toggle:focus {
      outline: 2px solid color-mix(in oklab, var(--accent) 60%, transparent);
      outline-offset: 2px;
    }

    .chev {
      width: 12px;
      height: 12px;
      flex: 0 0 auto;
      opacity: 0.75;
      transform: rotate(0deg);
      transition: transform 140ms ease;
    }
    details[open] .chev { transform: rotate(180deg); }

    .toggle-show { display: inline; }
    .toggle-hide { display: none; }
    details[open] .toggle-show { display: none; }
    details[open] .toggle-hide { display: inline; }

    .sol-surface {
      margin-top: var(--space-2);
      border-top: 1px solid var(--hairline);
      background: var(--surface-2);
      padding: var(--space-3) var(--space-3);
    }

    .sol-block { margin: 0 0 var(--space-3); }
    .sol-block:last-child { margin-bottom: 0; }

    .sol-label {
      font-size: 13px;
      font-weight: 650;
      color: color-mix(in oklab, var(--text) 74%, var(--quiet));
      margin: 0 0 var(--space-1);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .hint-icon {
      width: 14px;
      height: 14px;
      opacity: 0.7;
      flex: 0 0 auto;
    }

    .sol-body {
      font-size: 13px;
      line-height: 1.5;
      color: color-mix(in oklab, var(--text) 62%, var(--quiet));
    }

    .sol-block.keep .sol-body {
      color: color-mix(in oklab, var(--text) 68%, var(--quiet));
    }
    .sol-block.formulas .sol-body {
      color: color-mix(in oklab, var(--text) 58%, var(--quiet));
    }
    .sol-block.working .sol-body,
    .sol-block.altworking .sol-body {
      color: color-mix(in oklab, var(--text) 56%, var(--quiet));
    }

    .sol-body p { margin: 0 0 var(--space-2); }
    .sol-body p:last-child { margin-bottom: 0; }

    .sol-body ul {
      margin: 0;
      padding-left: 18px;
      display: grid;
      gap: 4px;
    }

    .math-block { margin: var(--space-2) 0; }
    .math-scroll {
      display: inline-block;
      max-width: 100%;
      padding: 6px 10px;
      background: rgba(18, 20, 22, 0.035);
      overflow-x: auto;
      overflow-y: hidden;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    .math-scroll::-webkit-scrollbar { display: none; }
    .math-scroll .katex-display { margin: 0; }
    .math-scroll .katex-display > .katex { max-width: 100%; }

    .math-inline { white-space: nowrap; }

    .table-scroll {
      overflow-x: auto;
      overflow-y: hidden;
      max-width: 100%;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      -ms-overflow-style: none;
      margin: var(--space-2) 0;
    }
    .table-scroll::-webkit-scrollbar { display: none; }

    table {
      border-collapse: collapse;
      width: max-content;
      min-width: 100%;
      font-size: 13px;
      line-height: 1.4;
      color: color-mix(in oklab, var(--text) 58%, var(--quiet));
    }

    th, td {
      border: 1px solid var(--hairline-2);
      padding: 6px 8px;
      vertical-align: top;
    }

    thead th {
      font-weight: 650;
      color: color-mix(in oklab, var(--text) 64%, var(--quiet));
      background: transparent;
    }

    .diagram {
      margin: var(--space-2) 0;
      max-width: 520px;
    }
    .diagram svg {
      width: 100%;
      height: auto;
      display: block;
    }
    .diagram-caption {
      font-size: 12px;
      color: var(--quiet);
      margin-top: 4px;
    }

    @media (max-width: 860px) {
      .shell { padding: var(--space-4) var(--space-3); }
      .columns { grid-template-columns: 1fr; }
      nav.desktop-nav { display: none; }
      .jump { display: inline-flex; }
    }

    .drawer {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 50;
    }
    .drawer[aria-hidden="false"] { pointer-events: auto; }

    .drawer-scrim {
      position: absolute;
      inset: 0;
      background: rgba(18,20,22,0.18);
      opacity: 0;
      transition: opacity 140ms ease;
    }
    .drawer[aria-hidden="false"] .drawer-scrim { opacity: 1; }

    .drawer-panel {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: min(360px, 86vw);
      background: var(--surface);
      transform: translateX(-100%);
      transition: transform 180ms ease;
      padding: var(--space-4) var(--space-3);
      display: grid;
      grid-template-rows: auto 1fr;
      gap: var(--space-3);
    }
    .drawer[aria-hidden="false"] .drawer-panel { transform: translateX(0); }

    .drawer-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--space-2);
    }

    .drawer-title {
      margin: 0;
      font-size: 13px;
      color: color-mix(in oklab, var(--quiet) 80%, var(--text));
      text-transform: uppercase;
      letter-spacing: 0.02em;
    }

    .drawer-close {
      font-size: 14px;
      padding: 6px 10px;
      border: 1px solid var(--hairline);
      border-radius: 10px;
      background: var(--surface);
      color: var(--text);
    }
    .drawer-close:focus {
      outline: 2px solid color-mix(in oklab, var(--accent) 60%, transparent);
      outline-offset: 2px;
    }

    .drawer-nav {
      overflow: auto;
      padding-right: 6px;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    .drawer-nav::-webkit-scrollbar { display: none; }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="frame">
      <div class="controls" role="region" aria-label="Paper controls">
        <div class="control-left">
          <label for="paperSelect">Paper</label>
          <select id="paperSelect" aria-label="Select paper dataset">
            <option value="short">Short paper</option>
            <option value="standard">Standard paper</option>
            <option value="standardExpanded">Standard (Workings Expanded)</option>
            <option value="diagram">Diagram-heavy paper</option>
            <option value="sectioned">Sectioned paper</option>
          </select>
        </div>
        <button class="jump" id="jumpBtn" type="button" aria-haspopup="dialog" aria-controls="mobileDrawer">Jump to</button>
      </div>
    </div>
  </div>

  <div class="frame">
    <div class="shell">
      <div class="columns">
        <nav class="desktop-nav" aria-label="Document navigation">
          <div class="nav-sticky" id="desktopNavInner">
            <div class="nav-title">Jump to</div>
            <div id="desktopNav"></div>
          </div>
        </nav>

        <main id="paper" aria-label="Paper content">
          <h1 class="paper-title" id="paperTitle">Short paper</h1>
          <div id="paperContent"></div>
        </main>
      </div>
    </div>
  </div>

  <div class="drawer" id="mobileDrawer" aria-hidden="true">
    <div class="drawer-scrim" id="drawerScrim"></div>
    <div class="drawer-panel" role="dialog" aria-modal="true" aria-label="Jump to navigation">
      <div class="drawer-header">
        <h2 class="drawer-title">Jump to</h2>
        <button class="drawer-close" id="drawerClose" type="button">Close</button>
      </div>
      <nav class="drawer-nav" aria-label="Document navigation" id="mobileNav"></nav>
    </div>
  </div>

  <script>
    const EXEMPLAR_BLOCKS = {
"1": "## Question 1\n\n**Question**\n\nEvaluate $5 + 7$.\n\n**Answer**\n\n$12$\n\n**Solution Details**\n\n**Working**\n\n$5 + 7 = 12$",
"2": "## Question 2\n\n**Question**\n\nCalculate $18 \\div 3$.\n\n**Answer**\n\n$6$\n\n**Solution Details**\n\n**Working**\n\n$18 \\div 3 = 6$",
"3": "## Question 3\n\n**Question**\n\nWork out $9 \\times 4$.\n\n**Answer**\n\n$36$\n\n**Solution Details**\n\n**Working**\n\n$9 \\times 4 = 36$",
"4": "## Question 4\n\n**Question**\n\nFind $3^2$.\n\n**Answer**\n\n$9$\n\n**Solution Details**\n\n**Working**\n\n$3^2 = 3 \\times 3 = 9$",
"5": "## Question 5\n\n**Question**\n\nSimplify $14 - 9$.\n\n**Answer**\n\n$5$\n\n**Solution Details**\n\n**Working**\n\n$14 - 9 = 5$",
"6": "## Question 6\n\n**Question**\n\nCalculate $\\frac{1}{2} + \\frac{1}{4}$.\n\n**Answer**\n\n$\\frac{3}{4}$\n\n**Solution Details**\n\n**Working**\n\nFind a common denominator.\n\n$\\frac{1}{2} = \\frac{2}{4}$\n\nSo,\n\n$\\frac{2}{4} + \\frac{1}{4} = \\frac{3}{4}$",
"7": "## Question 7\n\n**Question**\n\nDiagram: %image%\n\nA triangle $ABC$ has $AB = 6\\,cm$, $BC = 8\\,cm$, and $AC = 10\\,cm$.\n\n(a) State the type of triangle.\n\n(b) Work out the perimeter.\n\n(c) Work out the area.\n\n**Answer**\n\n(a) Right-angled\n\n(b) $24\\,cm$\n\n(c) $24\\,cm^2$\n\n**Solution Details**\n\n**Working**\n\n(a)\n\nCheck Pythagoras:\n\n$6^2 + 8^2 = 36 + 64 = 100 = 10^2$\n\nSo it is right-angled.\n\n(b)\n\nPerimeter $= 6 + 8 + 10 = 24\\,cm$\n\n(c)\n\nArea of right-angled triangle $= \\frac{1}{2} \\times 6 \\times 8 = 24\\,cm^2$\n\n### Question 7a\n\n**Question**\n\nWork out $6^2 + 8^2$.\n\n**Answer**\n\n$100$\n\n**Solution Details**\n\n**Working**\n\n$6^2 + 8^2 = 36 + 64 = 100$\n\n#### Question 7ai\n\n**Question**\n\nEvaluate $10^2$.\n\n**Answer**\n\n$100$\n\n**Solution Details**\n\n**Working**\n\n$10^2 = 100$",
"8": "## Question 8\n\n**Question**\n\nDiagram: %image%\n\nA bar model shows the ratio of red to blue counters is $3:2$.\n\nIf there are $15$ red counters, how many blue counters are there?\n\n**Answer**\n\n$10$\n\n**Solution Details**\n\n**Working**\n\n$3$ parts represent $15$.\n\nSo $1$ part $= 15 \\div 3 = 5$.\n\nBlue is $2$ parts, so $2 \\times 5 = 10$.",
"9": "## Question 9\n\n**Question**\n\nA train travels $96\\,km$ in $2\\,hours$.\n\nWork out the speed in $km/h$.\n\n**Answer**\n\n$48\\,km/h$\n\n**Solution Details**\n\n**Working**\n\nSpeed $= \\frac{\\text{distance}}{\\text{time}}$.\n\n$\\frac{96}{2} = 48$.\n\nSo the speed is $48\\,km/h$.",
"10": "## Question 10\n\n**Question**\n\nDiagram: %image%\n\nA coordinate grid shows points $A(1,2)$ and $B(7,8)$.\n\n(a) Find the gradient of $AB$.\n\n(b) Find the midpoint of $AB$.\n\n**Answer**\n\n(a) $1$\n\n(b) $(4,5)$\n\n**Solution Details**\n\n**Working**\n\n(a)\n\nGradient $= \\frac{8-2}{7-1} = \\frac{6}{6} = 1$.\n\n(b)\n\nMidpoint $= \\left(\\frac{1+7}{2}, \\frac{2+8}{2}\\right) = (4,5)$.\n\n**Alternative working**\n\n(a)\n\nRise is $6$ and run is $6$, so gradient $= \\frac{6}{6} = 1$.\n\n(b)\n\nCount $3$ squares right and $3$ squares up from $A(1,2)$ to get $(4,5)$.",
"11": "## Question 11\n\n**Question**\n\nConvert $3.5\\,m$ to $cm$.\n\n**Answer**\n\n$350\\,cm$\n\n**Solution Details**\n\n**Working**\n\n$1\\,m = 100\\,cm$.\n\nSo $3.5\\,m = 3.5 \\times 100 = 350\\,cm$.",
"12": "## Question 12\n\n**Question**\n\nWrite $0.75$ as a fraction in simplest form.\n\n**Answer**\n\n$\\frac{3}{4}$\n\n**Solution Details**\n\n**Working**\n\n$0.75 = \\frac{75}{100}$.\n\nSimplify by dividing top and bottom by $25$:\n\n$\\frac{75}{100} = \\frac{3}{4}$.",
"13": "## Question 13\n\n**Question**\n\nWork out $25\\%$ of $80$.\n\n**Answer**\n\n$20$\n\n**Solution Details**\n\n**Working**\n\n$25\\% = \\frac{25}{100} = \\frac{1}{4}$.\n\n$\\frac{1}{4}$ of $80$ is $80 \\div 4 = 20$.",
"14": "## Question 14\n\n**Question**\n\nDiagram: %image%\n\nA grid shows a $3 \\times 4$ rectangle.\n\nWork out the area.\n\n**Answer**\n\n$12$\n\n**Solution Details**\n\n**Working**\n\nArea $= 3 \\times 4 = 12$.",
"15": "## Question 15\n\n**Question**\n\nDiagram: %image%\n\nA square has side length $7\\,cm$.\n\n(a) Work out the perimeter.\n\n(b) Work out the area.\n\n**Answer**\n\n(a) $28\\,cm$\n\n(b) $49\\,cm^2$\n\n**Solution Details**\n\n**Working**\n\n(a)\n\nPerimeter $= 4 \\times 7 = 28\\,cm$.\n\n(b)\n\nArea $= 7^2 = 49\\,cm^2$.",
"16": "## Question 16\n\n**Question**\n\nDiagram: %image%\n\nA triangle has base $10\\,cm$ and height $6\\,cm$.\n\nWork out the area.\n\n**Answer**\n\n$30\\,cm^2$\n\n**Solution Details**\n\n**Working**\n\nArea of triangle $= \\frac{1}{2} \\times 10 \\times 6 = 30\\,cm^2$.",
"17": "## Question 17\n\n**Question**\n\nSimplify $3x + 5x$.\n\n**Answer**\n\n$8x$\n\n**Solution Details**\n\n**Working**\n\nAdd the like terms:\n\n$3x + 5x = 8x$.",
"18": "## Question 18\n\n**Question**\n\nSolve $x + 9 = 14$.\n\n**Answer**\n\n$x = 5$\n\n**Solution Details**\n\n**Working**\n\nSubtract $9$ from both sides:\n\n$x = 14 - 9 = 5$.",
"19": "## Question 19\n\n**Question**\n\nDiagram: %image%\n\nA pie chart shows $\\frac{3}{8}$ of pupils walk to school.\n\nIf there are $240$ pupils, how many walk to school?\n\n**Answer**\n\n$90$\n\n**Solution Details**\n\n**Working**\n\n$\\frac{3}{8}$ of $240$ is $240 \\div 8 = 30$ per part.\n\n$3$ parts is $3 \\times 30 = 90$.",
"20": "## Question 20\n\n**Question**\n\nWork out $\\frac{5}{6} - \\frac{1}{3}$.\n\n**Answer**\n\n$\\frac{1}{2}$\n\n**Solution Details**\n\n**Working**\n\nMake the denominators the same:\n\n$\\frac{1}{3} = \\frac{2}{6}$.\n\n$\\frac{5}{6} - \\frac{2}{6} = \\frac{3}{6} = \\frac{1}{2}$.",
"21": "## Question 21\n\n**Question**\n\nDiagram: %image%\n\nA table shows the number of stickers collected each day.\n\n| Day | Mon | Tue | Wed | Thu | Fri |\n|---|---|---|---|---|---|\n| Stickers | 6 | 9 | 5 | 8 | 7 |\n\nWork out the total number of stickers.\n\n**Answer**\n\n$35$\n\n**Solution Details**\n\n**Working**\n\nAdd them:\n\n$6 + 9 + 5 + 8 + 7 = 35$.",
"22": "## Question 22\n\n**Question**\n\nExpand and simplify $(x + 3)(x + 7)$.\n\n**Answer**\n\n$x^2 + 10x + 21$\n\n**Solution Details**\n\n**Working**\n\nExpand:\n\n$\n\\begin{aligned}\n(x + 3)(x + 7) &= x(x+7) + 3(x+7)\\\\\n&= x^2 + 7x + 3x + 21\\\\\n&= x^2 + 10x + 21\n\\end{aligned}\n$\n\nCheck the middle terms add to $10x$.",
"23": "## Question 23\n\n**Question**\n\nSolve $2x - 5 = 17$.\n\n**Answer**\n\n$x = 11$\n\n**Solution Details**\n\n**Working**\n\nAdd $5$ to both sides:\n\n$2x = 22$\n\nDivide by $2$:\n\n$x = 11$.",
"24": "## Question 24\n\n**Question**\n\nFactorise $x^2 + 9x + 20$.\n\n**Answer**\n\n$(x+4)(x+5)$\n\n**Solution Details**\n\n**Working**\n\nFind two numbers that multiply to $20$ and add to $9$.\n\n$4$ and $5$.\n\nSo $x^2 + 9x + 20 = (x+4)(x+5)$.",
"25": "## Question 25\n\n**Question**\n\nWork out $3(2x - 4)$.\n\n**Answer**\n\n$6x - 12$\n\n**Solution Details**\n\n**Working**\n\nMultiply $3$ by each term:\n\n$3 \\times 2x = 6x$\n\n$3 \\times (-4) = -12$\n\nSo $3(2x - 4) = 6x - 12$.",
"26": "## Question 26\n\n**Question**\n\nDiagram: %image%\n\nA line is drawn on a coordinate grid.\n\nState the gradient.\n\n**Answer**\n\n$2$\n\n**Solution Details**\n\n**Working**\n\nPick two points and work out rise over run.\n\nThe line goes up $4$ and across $2$.\n\nSo gradient $= \\frac{4}{2} = 2$.",
"27": "## Question 27\n\n**Question**\n\nSimplify $\\frac{12}{18}$.\n\n**Answer**\n\n$\\frac{2}{3}$\n\n**Solution Details**\n\n**Working**\n\nDivide top and bottom by $6$:\n\n$\\frac{12}{18} = \\frac{2}{3}$.",
"28": "## Question 28\n\n**Question**\n\nWork out $7.2 \\div 0.9$.\n\n**Answer**\n\n$8$\n\n**Solution Details**\n\n**Working**\n\nMultiply both numbers by $10$:\n\n$7.2 \\div 0.9 = 72 \\div 9 = 8$.",
"29": "## Question 29\n\n**Question**\n\nA bag contains $5$ red and $3$ blue balls.\n\nWhat is the probability of picking a blue ball?\n\n**Answer**\n\n$\\frac{3}{8}$\n\n**Solution Details**\n\n**Working**\n\nTotal balls $= 5 + 3 = 8$.\n\nBlue balls $= 3$.\n\nProbability $= \\frac{3}{8}$.",
"30": "## Question 30\n\n**Question**\n\nSolve $\\frac{x}{4} = 6$.\n\n**Answer**\n\n$x = 24$\n\n**Solution Details**\n\n**Working**\n\nMultiply both sides by $4$:\n\n$x = 6 \\times 4 = 24$.",
"31": "## Question 31\n\n**Question**\n\nWork out $\\frac{2}{5}$ of $60$.\n\n**Answer**\n\n$24$\n\n**Solution Details**\n\n**Working**\n\n$\\frac{1}{5}$ of $60$ is $60 \\div 5 = 12$.\n\nSo $\\frac{2}{5}$ is $2 \\times 12 = 24$.",
"32": "## Question 32\n\n**Question**\n\nConvert $2.3\\,kg$ to grams.\n\n**Answer**\n\n$2300\\,g$\n\n**Solution Details**\n\n**Working**\n\n$1\\,kg = 1000\\,g$.\n\n$2.3\\,kg = 2.3 \\times 1000 = 2300\\,g$.",
"33": "## Question 33\n\n**Question**\n\nExpand and simplify $(2x - 3)(x + 5)$.\n\n**Answer**\n\n$2x^2 + 7x - 15$\n\n**Solution Details**\n\n**Working**\n\n$\n\\begin{aligned}\n(2x - 3)(x + 5) &= 2x(x+5) - 3(x+5)\\\\\n&= 2x^2 + 10x - 3x - 15\\\\\n&= 2x^2 + 7x - 15\n\\end{aligned}\n$",
"34": "## Question 34\n\n**Question**\n\nSolve $3x + 4 = 25$.\n\n**Answer**\n\n$x = 7$\n\n**Solution Details**\n\n**Working**\n\nSubtract $4$:\n\n$3x = 21$\n\nDivide by $3$:\n\n$x = 7$.",
"35": "## Question 35\n\n**Question**\n\nFactorise $x^2 - 9$.\n\n**Answer**\n\n$(x-3)(x+3)$\n\n**Solution Details**\n\n**Working**\n\nThis is a difference of two squares:\n\n$x^2 - 9 = x^2 - 3^2 = (x-3)(x+3)$.",
"36": "## Question 36\n\n**Question**\n\nWork out the value of $2x$ when $x = 8$.\n\n**Answer**\n\n$16$\n\n**Solution Details**\n\n**Working**\n\n$2x = 2 \\times 8 = 16$.",
"37": "## Question 37\n\n**Question**\n\nWrite $4.2$ as a mixed number.\n\n**Answer**\n\n$4\\frac{1}{5}$\n\n**Solution Details**\n\n**Working**\n\n$4.2 = 4 + 0.2$.\n\n$0.2 = \\frac{2}{10} = \\frac{1}{5}$.\n\nSo $4.2 = 4\\frac{1}{5}$.",
"38": "## Question 38\n\n**Question**\n\nA shirt costs £24.\n\nIt is reduced by $15\\%$.\n\nWork out the new price.\n\n**Answer**\n\n£20.40\n\n**Solution Details**\n\n**Working**\n\n$15\\%$ of £24 is $0.15 \\times 24 = 3.6$.\n\nNew price $= 24 - 3.6 = 20.4$.\n\nSo the new price is £20.40.",
"39": "## Question 39\n\n**Question**\n\nSolve $\\frac{3x - 2}{5} = 4$.\n\n**Answer**\n\n$x = \\frac{22}{3}$\n\n**Solution Details**\n\n**Working**\n\nMultiply both sides by $5$:\n\n$3x - 2 = 20$\n\nAdd $2$:\n\n$3x = 22$\n\nDivide by $3$:\n\n$x = \\frac{22}{3}$.",
"40": "## Question 40\n\n**Question**\n\nFactorise $2x^2 + 9x + 10$.\n\n**Answer**\n\n$(2x+5)(x+2)$\n\n**Solution Details**\n\n**Working**\n\nFind two numbers that multiply to $2 \\times 10 = 20$ and add to $9$.\n\n$5$ and $4$.\n\n$\n\\begin{aligned}\n2x^2 + 9x + 10 &= 2x^2 + 5x + 4x + 10\\\\\n&= x(2x+5) + 2(2x+5)\\\\\n&= (2x+5)(x+2)\n\\end{aligned}\n$",
"41": "## Question 41\n\n**Question**\n\nExpand and simplify $(x - 4)^2$.\n\n**Answer**\n\n$x^2 - 8x + 16$\n\n**Solution Details**\n\n**Working**\n\n$\n\\begin{aligned}\n(x - 4)^2 &= (x - 4)(x - 4)\\\\\n&= x(x-4) - 4(x-4)\\\\\n&= x^2 - 4x - 4x + 16\\\\\n&= x^2 - 8x + 16\n\\end{aligned}\n$",
"42": "## Question 42\n\n**Question**\n\nSolve $x^2 = 49$.\n\n**Answer**\n\n$x = 7$ or $x = -7$\n\n**Solution Details**\n\n**Working**\n\nSquare roots:\n\n$x = \\sqrt{49} = 7$ or $x = -\\sqrt{49} = -7$.",
"43": "## Question 43\n\n**Question**\n\nSimplify $\\frac{x^2}{x^5}$.\n\n**Answer**\n\n$\\frac{1}{x^3}$\n\n**Solution Details**\n\n**Working**\n\nUse index laws:\n\n$\\frac{x^2}{x^5} = x^{2-5} = x^{-3} = \\frac{1}{x^3}$.",
"44": "## Question 44\n\n**Question**\n\nWork out $\\frac{7}{8}$ of $64$.\n\n**Answer**\n\n$56$\n\n**Solution Details**\n\n**Working**\n\n$\\frac{1}{8}$ of $64$ is $8$.\n\nSo $\\frac{7}{8}$ is $7 \\times 8 = 56$.",
"45": "## Question 45\n\n**Question**\n\nSimplify $\\frac{4}{x} + \\frac{3}{2x}$.\n\n**Answer**\n\n$\\frac{11}{2x}$\n\n**Solution Details**\n\n**Working**\n\nCommon denominator is $2x$.\n\n$\\frac{4}{x} = \\frac{8}{2x}$.\n\nSo $\\frac{8}{2x} + \\frac{3}{2x} = \\frac{11}{2x}$.",
"46": "## Question 46\n\n**Question**\n\nSolve $5(2x - 1) = 3(3x + 4)$.\n\n**Answer**\n\n$x = 17$\n\n**Solution Details**\n\n**Working**\n\nExpand both sides:\n\n$10x - 5 = 9x + 12$\n\nSubtract $9x$:\n\n$x - 5 = 12$\n\nAdd $5$:\n\n$x = 17$.",
"47": "## Question 47\n\n**Question**\n\nWork out $\\frac{3}{10}$ of £90.\n\n**Answer**\n\n£27\n\n**Solution Details**\n\n**Working**\n\n$\\frac{1}{10}$ of £90 is £9.\n\nSo $\\frac{3}{10}$ is $3 \\times 9 = 27$.\n\nSo the answer is £27.",
"48": "## Question 48\n\n**Question**\n\nA recipe uses $250\\,g$ of flour.\n\nHow much flour is needed for $3$ batches?\n\n**Answer**\n\n$750\\,g$\n\n**Solution Details**\n\n**Working**\n\n$250 \\times 3 = 750$.\n\nSo $750\\,g$ is needed.",
"49": "## Question 49\n\n**Question**\n\nSolve $\\frac{2x + 1}{3} = 5$.\n\n**Answer**\n\n$x = 7$\n\n**Solution Details**\n\n**Working**\n\nMultiply both sides by $3$:\n\n$2x + 1 = 15$\n\nSubtract $1$:\n\n$2x = 14$\n\nDivide by $2$:\n\n$x = 7$.",
"50": "## Question 50\n\n**Question**\n\nWork out $0.6 \\times 0.7$.\n\n**Answer**\n\n$0.42$\n\n**Solution Details**\n\n**Working**\n\n$6 \\times 7 = 42$.\n\nThere are two decimal places in total, so $0.6 \\times 0.7 = 0.42$.",
"51": "## Question 51\n\n**Question**\n\nSimplify $\\frac{9}{12}$.\n\n**Answer**\n\n$\\frac{3}{4}$\n\n**Solution Details**\n\n**Working**\n\nDivide top and bottom by $3$:\n\n$\\frac{9}{12} = \\frac{3}{4}$.",
"52": "## Question 52\n\n**Question**\n\nDiagram: %image%\n\nA table shows the number of goals scored by a team over 4 matches.\n\n| Match | 1 | 2 | 3 | 4 |\n|---|---|---|---|---|\n| Goals | 2 | 1 | 3 | 0 |\n\nWork out the mean number of goals.\n\n**Answer**\n\n$1.5$\n\n**Solution Details**\n\n**Working**\n\nTotal goals $= 2 + 1 + 3 + 0 = 6$.\n\nMean $= 6 \\div 4 = 1.5$.",
"53": "## Question 53\n\n**Question**\n\nWork out the value of $x$ if $4x = 28$.\n\n**Answer**\n\n$x = 7$\n\n**Solution Details**\n\n**Working**\n\nDivide both sides by $4$:\n\n$x = 28 \\div 4 = 7$.",
"54": "## Question 54\n\n**Question**\n\nWrite $\\frac{18}{5}$ as a mixed number.\n\n**Answer**\n\n$3\\frac{3}{5}$\n\n**Solution Details**\n\n**Working**\n\n$18 \\div 5 = 3$ remainder $3$.\n\nSo $\\frac{18}{5} = 3\\frac{3}{5}$."
};

    const KEEP_IN_MIND = [
      "Use the correct order of operations (BIDMAS).",
      "Check units and convert if needed.",
      "Line up digits carefully when adding or subtracting.",
      "When dividing by a fraction, multiply by the reciprocal.",
      "Show each step clearly; don’t do too much in one line.",
      "Write the final answer with the correct unit."
    ];

    const FORMULAS_USED = [
      "Percentage = (part ÷ whole) × 100%",
      "Area of triangle = ½ × base × height",
      "Area of square = side²",
      "Perimeter of square = 4 × side",
      "Speed = distance ÷ time",
      "1 m = 100 cm",
      "1 kg = 1000 g"
    ];

    const DATASETS = {
      short: {
        title: "Short paper",
        questionIds: ["1","2","3","4","5","7"],
        workingsExpanded: false,
        sectioned: null
      },
      standard: {
        title: "Standard paper",
        questionIds: ["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","30","33","39","40","41","42","43","45","46","49"],
        workingsExpanded: false,
        sectioned: null
      },
      standardExpanded: {
        title: "Standard (Workings Expanded)",
        questionIds: ["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","30","33","39","40","41","42","43","45","46","49"],
        workingsExpanded: true,
        sectioned: null
      },
      diagram: {
        title: "Diagram-heavy paper",
        questionIds: ["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","21"],
        workingsExpanded: false,
        sectioned: null
      },
      sectioned: {
        title: "Sectioned paper",
        questionIds: ["1","2","3","4","5","6","7","8","11","12","13","14","16","17","18","19","20","21","23","24","25","26","27","28","29","30","31","32","34","35","36","37","38","44","47","10","15","33","39","42","43","49","52","9","22","40","41","45","46"],
        workingsExpanded: false,
        sectioned: {"A":["1","2","3","4","5","6","7","8","11","12","13","14","16","17","18","19","20","21","23","24","25","26","27","28","29","30","31","32","34","35","36","37","38","44","47"],"B":["10","15","33","39","42","43","49","52"],"C":["9","22","40","41","45","46"]}
      }
    };

    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    function escapeId(s) {
      return String(s).replace(/[^a-zA-Z0-9_-]/g, "_");
    }

    function diagramSVG(kind, labelSeed) {
      const stroke = "#2b2f34";
      const thin = "1.2";
      const text = "#2b2f34";
      const quiet = "#4a5057";

      if (kind === 0) {
        return `
<svg viewBox="0 0 260 160" xmlns="http://www.w3.org/2000/svg" aria-label="Diagram: geometry" role="img">
  <rect x="1" y="1" width="258" height="158" fill="none" stroke="rgba(18,20,22,0.12)" stroke-width="1"/>
  <polygon points="55,120 120,30 175,120" fill="none" stroke="${stroke}" stroke-width="${thin}"/>
  <circle cx="195" cy="70" r="28" fill="none" stroke="${stroke}" stroke-width="${thin}"/>
  <text x="112" y="26" font-size="12" fill="${text}" text-anchor="middle">A</text>
  <text x="48" y="134" font-size="12" fill="${text}">B</text>
  <text x="178" y="134" font-size="12" fill="${text}">C</text>
  <text x="195" y="74" font-size="12" fill="${quiet}" text-anchor="middle">${labelSeed}</text>
  <line x1="55" y1="120" x2="175" y2="120" stroke="${stroke}" stroke-width="${thin}"/>
  <text x="115" y="136" font-size="12" fill="${quiet}" text-anchor="middle">base</text>
</svg>`;
      }

      if (kind === 1) {
        return `
<svg viewBox="0 0 260 160" xmlns="http://www.w3.org/2000/svg" aria-label="Diagram: ratio bars" role="img">
  <rect x="1" y="1" width="258" height="158" fill="none" stroke="rgba(18,20,22,0.12)" stroke-width="1"/>
  <text x="18" y="28" font-size="12" fill="${text}">Bar model</text>
  <rect x="18" y="46" width="220" height="22" fill="none" stroke="${stroke}" stroke-width="${thin}"/>
  <line x1="18" y1="57" x2="238" y2="57" stroke="${stroke}" stroke-width="${thin}" stroke-dasharray="4 4"/>
  <rect x="18" y="86" width="160" height="22" fill="none" stroke="${stroke}" stroke-width="${thin}"/>
  <rect x="178" y="86" width="60" height="22" fill="none" stroke="${stroke}" stroke-width="${thin}"/>
  <text x="98" y="102" font-size="12" fill="${quiet}" text-anchor="middle">${labelSeed}</text>
  <text x="208" y="102" font-size="12" fill="${quiet}" text-anchor="middle">?</text>
</svg>`;
      }

      if (kind === 2) {
        return `
<svg viewBox="0 0 260 160" xmlns="http://www.w3.org/2000/svg" aria-label="Diagram: coordinate grid" role="img">
  <rect x="1" y="1" width="258" height="158" fill="none" stroke="rgba(18,20,22,0.12)" stroke-width="1"/>
  <g stroke="rgba(18,20,22,0.10)" stroke-width="1">
    <line x1="20" y1="20" x2="20" y2="140"/>
    <line x1="40" y1="20" x2="40" y2="140"/>
    <line x1="60" y1="20" x2="60" y2="140"/>
    <line x1="80" y1="20" x2="80" y2="140"/>
    <line x1="100" y1="20" x2="100" y2="140"/>
    <line x1="120" y1="20" x2="120" y2="140"/>
    <line x1="140" y1="20" x2="140" y2="140"/>
    <line x1="160" y1="20" x2="160" y2="140"/>
    <line x1="180" y1="20" x2="180" y2="140"/>
    <line x1="200" y1="20" x2="200" y2="140"/>
    <line x1="220" y1="20" x2="220" y2="140"/>
    <line x1="240" y1="20" x2="240" y2="140"/>
    <line x1="20" y1="20" x2="240" y2="20"/>
    <line x1="20" y1="40" x2="240" y2="40"/>
    <line x1="20" y1="60" x2="240" y2="60"/>
    <line x1="20" y1="80" x2="240" y2="80"/>
    <line x1="20" y1="100" x2="240" y2="100"/>
    <line x1="20" y1="120" x2="240" y2="120"/>
    <line x1="20" y1="140" x2="240" y2="140"/>
  </g>
  <g stroke="${stroke}" stroke-width="${thin}">
    <line x1="20" y1="140" x2="240" y2="140"/>
    <line x1="20" y1="140" x2="20" y2="20"/>
  </g>
  <circle cx="80" cy="100" r="3" fill="${stroke}"/>
  <circle cx="160" cy="60" r="3" fill="${stroke}"/>
  <line x1="80" y1="100" x2="160" y2="60" stroke="${stroke}" stroke-width="${thin}"/>
  <text x="160" y="54" font-size="12" fill="${quiet}">${labelSeed}</text>
</svg>`;
      }

      return `
<svg viewBox="0 0 260 160" xmlns="http://www.w3.org/2000/svg" aria-label="Diagram: grid table" role="img">
  <rect x="1" y="1" width="258" height="158" fill="none" stroke="rgba(18,20,22,0.12)" stroke-width="1"/>
  <text x="18" y="28" font-size="12" fill="${text}">Grid</text>
  <g fill="none" stroke="${stroke}" stroke-width="${thin}">
    <rect x="40" y="46" width="180" height="90"/>
    <line x1="100" y1="46" x2="100" y2="136"/>
    <line x1="160" y1="46" x2="160" y2="136"/>
    <line x1="40" y1="76" x2="220" y2="76"/>
    <line x1="40" y1="106" x2="220" y2="106"/>
  </g>
  <text x="70" y="67" font-size="12" fill="${quiet}" text-anchor="middle">${labelSeed}</text>
  <text x="130" y="97" font-size="12" fill="${quiet}" text-anchor="middle">?</text>
</svg>`;
    }

    function chooseDiagramKind(seedStr) {
      let h = 0;
      for (let i = 0; i < seedStr.length; i++) h = (h * 31 + seedStr.charCodeAt(i)) >>> 0;
      return h % 4;
    }

    function parseTopLevelBlock(blockText) {
      const lines = blockText.split(/\r?\n/);
      const root = { level: 1, id: "__root__", children: [], contentLines: [] };
      const stack = [root];

      function headingLevel(line) {
        const m = line.match(/^(#{2,4})\s+Question\s+(.+)\s*$/);
        if (!m) return null;
        return { level: m[1].length, id: m[2].trim() };
      }

      for (let i = 0; i < lines.length; i++) {
        const hl = headingLevel(lines[i]);
        if (hl) {
          const node = { level: hl.level, id: hl.id, children: [], contentLines: [] };
          while (stack.length && stack[stack.length - 1].level >= node.level) stack.pop();
          stack[stack.length - 1].children.push(node);
          stack.push(node);
        } else {
          stack[stack.length - 1].contentLines.push(lines[i]);
        }
      }
      return root.children[0];
    }

    function cleanupPlaceholders(s) {
      return s
        .split(/\r?\n/)
        .filter(line => line.trim() !== "%empty%")
        .join("\n")
        .replace(/%image%/g, "__DIAGRAM__");
    }

    function splitSections(contentLines) {
      const s = contentLines.join("\n");

      function findLabelIndex(label) {
        const re = new RegExp(`^\\*\\*${label}\\*\\*\\s*$`, "mi");
        const m = s.match(re);
        return m ? m.index : -1;
      }

      const idxQ = findLabelIndex("Question");
      const idxA = findLabelIndex("Answer");
      const idxS = findLabelIndex("Solution Details");

      function sliceBetween(from, to) {
        if (from < 0 || to < 0 || to <= from) return "";
        const headLen = (s.slice(from).match(/^[^\n]*\n/)?.[0]?.length || 0);
        return s.slice(from + headLen, to).replace(/^\n+/, "").replace(/\n+$/, "");
      }

      const question = cleanupPlaceholders(sliceBetween(idxQ, idxA));
      const answer = cleanupPlaceholders(sliceBetween(idxA, idxS));
      const sol = idxS >= 0 ? cleanupPlaceholders(s.slice(idxS + (s.slice(idxS).match(/^[^\n]*\n/)?.[0]?.length || 0)).trim()) : "";

      function extractBoldSection(solText, sectionName) {
        const re = new RegExp(`^\\*\\*${sectionName}\\*\\*\\s*$`, "mi");
        const m = solText.match(re);
        if (!m) return "";
        const start = m.index + m[0].length;
        const after = solText.slice(start);
        const next = after.search(/^\*\*[^\n]+\*\*\s*$/mi);
        const body = next >= 0 ? after.slice(0, next) : after;
        return body.replace(/^\n+/, "").replace(/\n+$/, "");
      }

      const working = extractBoldSection(sol, "Working");
      const altworking = extractBoldSection(sol, "Alternative Working") || extractBoldSection(sol, "Alternative working");

      return { question, answer, working, altworking };
    }

    function renderMarkdownFragment(target, mdText, context) {
      const lines = (mdText || "").split(/\r?\n/);
      let i = 0;

      function isTableRow(line) {
        const t = line.trim();
        return t.startsWith("|") && t.endsWith("|") && t.length > 2;
      }

      function renderInline(el, text) {
        if (text.trim() === "__DIAGRAM__") {
          const diag = document.createElement("div");
          diag.className = "diagram";
          const kind = chooseDiagramKind(context.diagramSeed || "0");
          diag.innerHTML = diagramSVG(kind, context.diagramSeed || "Diagram");
          const cap = document.createElement("div");
          cap.className = "diagram-caption";
          cap.textContent = "Diagram";
          diag.appendChild(cap);
          el.appendChild(diag);
          return;
        }

        const onlyInline = text.trim().match(/^\$(.+)\$$/);
        if (onlyInline && !onlyInline[1].includes("$")) {
          const block = document.createElement("div");
          block.className = "math-block";
          const scroll = document.createElement("div");
          scroll.className = "math-scroll";
          const node = document.createElement("div");
          node.className = "math-render";
          node.dataset.math = onlyInline[1].trim();
          node.dataset.display = "true";
          node.textContent = onlyInline[1].trim();
          scroll.appendChild(node);
          block.appendChild(scroll);
          el.appendChild(block);
          return;
        }

        let idx = 0;
        while (idx < text.length) {
          const nextMath = text.indexOf("$", idx);
          if (nextMath === -1) {
            appendStyledText(el, text.slice(idx));
            break;
          }
          appendStyledText(el, text.slice(idx, nextMath));
          const endMath = text.indexOf("$", nextMath + 1);
          if (endMath === -1) {
            appendStyledText(el, text.slice(nextMath));
            break;
          }
          const latex = text.slice(nextMath + 1, endMath);
          const span = document.createElement("span");
          span.className = "math-inline math-render";
          span.dataset.math = latex;
          span.dataset.display = "false";
          span.textContent = latex;
          el.appendChild(span);
          idx = endMath + 1;
        }
      }

      function appendStyledText(el, chunk) {
        if (!chunk) return;
        const partsBold = chunk.split(/(\*\*[^*]+\*\*)/g).filter(Boolean);
        partsBold.forEach(part => {
          const mBold = part.match(/^\*\*([^*]+)\*\*$/);
          if (mBold) {
            const strong = document.createElement("strong");
            strong.textContent = mBold[1];
            el.appendChild(strong);
            return;
          }
          const partsIt = part.split(/(_[^_]+_)/g).filter(Boolean);
          partsIt.forEach(p2 => {
            const mIt = p2.match(/^_([^_]+)_$/);
            if (mIt) {
              const em = document.createElement("em");
              em.textContent = mIt[1];
              el.appendChild(em);
            } else {
              el.appendChild(document.createTextNode(p2));
            }
          });
        });
      }

      function parseTable(startIdx) {
        const tableLines = [];
        let j = startIdx;
        while (j < lines.length && isTableRow(lines[j])) {
          tableLines.push(lines[j]);
          j++;
        }
        const rows = tableLines.map(l => l.trim().slice(1, -1).split("|").map(c => c.trim()));
        if (!rows.length) return { next: j };

        const wrap = document.createElement("div");
        wrap.className = "table-scroll";
        const table = document.createElement("table");
        wrap.appendChild(table);

        const hasSep = rows.length >= 2 && rows[1].every(c => /^:?-{2,}:?$/.test(c));
        const headCells = rows[0];
        const bodyRows = hasSep ? rows.slice(2) : rows.slice(1);

        const thead = document.createElement("thead");
        const trh = document.createElement("tr");
        headCells.forEach(c => {
          const th = document.createElement("th");
          renderInline(th, c);
          trh.appendChild(th);
        });
        thead.appendChild(trh);
        table.appendChild(thead);

        const tbody = document.createElement("tbody");
        bodyRows.forEach(r => {
          const tr = document.createElement("tr");
          headCells.forEach((_, idx) => {
            const td = document.createElement("td");
            renderInline(td, (r[idx] ?? "").trim());
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);

        target.appendChild(wrap);
        return { next: j };
      }

      function parseDisplayMathBlock(startIdx) {
        let j = startIdx + 1;
        const buf = [];
        while (j < lines.length && lines[j].trim() !== "$") {
          buf.push(lines[j]);
          j++;
        }
        const latex = buf.join("\n").trim();
        const block = document.createElement("div");
        block.className = "math-block";
        const scroll = document.createElement("div");
        scroll.className = "math-scroll";
        const node = document.createElement("div");
        node.className = "math-render";
        node.dataset.math = latex;
        node.dataset.display = "true";
        node.textContent = latex;
        scroll.appendChild(node);
        block.appendChild(scroll);
        target.appendChild(block);
        return { next: Math.min(j + 1, lines.length) };
      }

      function flushParagraph(buf) {
        const text = buf.join(" ").trim();
        if (!text) return;
        const p = document.createElement("p");
        renderInline(p, text);
        target.appendChild(p);
      }

      while (i < lines.length) {
        const t = (lines[i] || "").trim();

        if (t === "__DIAGRAM__") {
          const p = document.createElement("p");
          renderInline(p, t);
          target.appendChild(p);
          i++;
          continue;
        }

        if (t === "$") {
          const res = parseDisplayMathBlock(i);
          i = res.next;
          continue;
        }

        if (isTableRow(lines[i] || "")) {
          const res = parseTable(i);
          i = res.next;
          continue;
        }

        if (/^[-•]\s+/.test(t)) {
          const ul = document.createElement("ul");
          while (i < lines.length && /^[-•]\s+/.test((lines[i] || "").trim())) {
            const li = document.createElement("li");
            renderInline(li, (lines[i] || "").trim().replace(/^[-•]\s+/, ""));
            ul.appendChild(li);
            i++;
          }
          target.appendChild(ul);
          continue;
        }

        if (!t) { i++; continue; }

        const pBuf = [];
        while (i < lines.length) {
          const tt = (lines[i] || "").trim();
          if (!tt) break;
          if (tt === "$" || isTableRow(lines[i] || "") || /^[-•]\s+/.test(tt) || tt === "__DIAGRAM__") break;
          pBuf.push(tt);
          i++;
        }
        flushParagraph(pBuf);
      }
    }

    function pickKeepInMind(questionText) {
      const t = (questionText || "").toLowerCase();
      if (t.includes("fraction") || t.includes("÷") || t.includes("divide")) return [KEEP_IN_MIND[3]];
      if (t.includes("unit") || t.includes("cm") || t.includes("metre") || t.includes("meter") || t.includes("kg") || t.includes(" g")) return [KEEP_IN_MIND[1], KEEP_IN_MIND[5]];
      if (t.includes("add") || t.includes("subtract") || t.includes("+") || t.includes("-")) return [KEEP_IN_MIND[2]];
      if (t.includes("order") || t.includes("bidmas") || t.includes("bracket")) return [KEEP_IN_MIND[0]];
      return [KEEP_IN_MIND[4]];
    }

    function pickFormulas(questionText) {
      const t = (questionText || "").toLowerCase();
      if (t.includes("%") || t.includes("percent")) return [FORMULAS_USED[0]];
      if (t.includes("triangle")) return [FORMULAS_USED[1]];
      if (t.includes("square")) return [FORMULAS_USED[2], FORMULAS_USED[3]];
      if (t.includes("speed") || t.includes("distance") || t.includes("time")) return [FORMULAS_USED[4]];
      if (t.includes("cm") || t.includes("metre") || t.includes("meter") || t.includes(" m")) return [FORMULAS_USED[5]];
      if (t.includes("kg") || t.includes("gram") || t.includes(" g")) return [FORMULAS_USED[6]];
      return [FORMULAS_USED[0]];
    }

    function distributionGroups(questionIds) {
      const N = questionIds.length;
      const base = Math.floor(N / 4);
      const remainder = N - 4 * base;
      const counts = { both: base, keep: base, formula: base, neither: base };
      const order = ["both", "keep", "formula", "neither"];
      for (let i = 0; i < remainder; i++) counts[order[i]]++;

      const remaining = { ...counts };
      const assignment = {};
      const pattern = ["both", "keep", "formula", "neither"];
      let p = 0;
      for (const qid of questionIds) {
        let tries = 0;
        while (tries < 4) {
          const g = pattern[p % 4];
          p++;
          if (remaining[g] > 0) {
            assignment[qid] = g;
            remaining[g]--;
            break;
          }
          tries++;
        }
        if (!assignment[qid]) {
          for (const g of pattern) {
            if (remaining[g] > 0) {
              assignment[qid] = g;
              remaining[g]--;
              break;
            }
          }
        }
      }
      return assignment;
    }

    function buildQuestionDOM(node, level, datasetCtx, topLevelQNum) {
      const wrapper = document.createElement("div");
      wrapper.className = `q q-level-${level}`;
      wrapper.id = `q-${escapeId(node.id)}`;
      wrapper.dataset.qid = node.id;
      wrapper.dataset.depth = String(level);

      const inner = document.createElement("div");
      inner.className = "q-inner";
      wrapper.appendChild(inner);

      const qidEl = document.createElement("div");
      qidEl.className = "qid";
      qidEl.textContent = node.id;
      inner.appendChild(qidEl);

      const body = document.createElement("div");
      body.className = "q-body";
      inner.appendChild(body);

      const sections = splitSections(node.contentLines);

      const qText = document.createElement("div");
      qText.className = "q-text";
      renderMarkdownFragment(qText, sections.question, { diagramSeed: `${topLevelQNum}-${node.id}` });
      body.appendChild(qText);

      const ans = document.createElement("div");
      ans.className = "answer";
      const ansLabel = document.createElement("div");
      ansLabel.className = "label";
      ansLabel.textContent = "Answer";
      const ansVal = document.createElement("div");
      ansVal.className = "value";
      renderMarkdownFragment(ansVal, sections.answer, { diagramSeed: `${topLevelQNum}-${node.id}` });
      ans.appendChild(ansLabel);
      ans.appendChild(ansVal);
      body.appendChild(ans);

      const details = document.createElement("details");
      details.className = "sol";
      if (datasetCtx.workingsExpanded) details.open = true;

      const summary = document.createElement("summary");
      summary.className = "sol-toggle";
      summary.innerHTML = `
        <svg class="chev" viewBox="0 0 20 20" aria-hidden="true" focusable="false">
          <path d="M5 7l5 6 5-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
        </svg>
        <span class="toggle-show">Show working</span>
        <span class="toggle-hide">Hide working</span>
      `;
      details.appendChild(summary);

      const surface = document.createElement("div");
      surface.className = "sol-surface";
      details.appendChild(surface);

      if (level === 0) {
        const group = datasetCtx.groupAssignment[topLevelQNum] || "neither";
        const questionPlain = (sections.question || "").replace(/\s+/g, " ").trim();

        if (group === "keep" || group === "both") {
          const blk = document.createElement("div");
          blk.className = "sol-block keep";
          const label = document.createElement("div");
          label.className = "sol-label";
          label.innerHTML = `
            <svg class="hint-icon" viewBox="0 0 20 20" aria-hidden="true" focusable="false">
              <path d="M10 2a7 7 0 00-4 12.7V18h8v-3.3A7 7 0 0010 2z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"></path>
              <path d="M7.5 18h5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"></path>
            </svg>
            Keep in mind
          `;
          const bodyEl = document.createElement("div");
          bodyEl.className = "sol-body";
          const ul = document.createElement("ul");
          pickKeepInMind(questionPlain).forEach(b => {
            const li = document.createElement("li");
            li.textContent = b;
            ul.appendChild(li);
          });
          bodyEl.appendChild(ul);
          blk.appendChild(label);
          blk.appendChild(bodyEl);
          surface.appendChild(blk);
        }

        if (group === "formula" || group === "both") {
          const blk = document.createElement("div");
          blk.className = "sol-block formulas";
          const label = document.createElement("div");
          label.className = "sol-label";
          label.textContent = "Formulas used";
          const bodyEl = document.createElement("div");
          bodyEl.className = "sol-body";
          const ul = document.createElement("ul");
          pickFormulas(questionPlain).forEach(f => {
            const li = document.createElement("li");
            li.textContent = f;
            ul.appendChild(li);
          });
          bodyEl.appendChild(ul);
          blk.appendChild(label);
          blk.appendChild(bodyEl);
          surface.appendChild(blk);
        }
      }

      const workingBlk = document.createElement("div");
      workingBlk.className = "sol-block working";
      const workingLabel = document.createElement("div");
      workingLabel.className = "sol-label";
      workingLabel.textContent = "Working";
      const workingBody = document.createElement("div");
      workingBody.className = "sol-body";
      renderMarkdownFragment(workingBody, sections.working, { diagramSeed: `${topLevelQNum}-${node.id}` });
      workingBlk.appendChild(workingLabel);
      workingBlk.appendChild(workingBody);
      surface.appendChild(workingBlk);

      if ((sections.altworking || "").trim()) {
        const altBlk = document.createElement("div");
        altBlk.className = "sol-block altworking";
        const altLabel = document.createElement("div");
        altLabel.className = "sol-label";
        altLabel.textContent = "Alternative working";
        const altBody = document.createElement("div");
        altBody.className = "sol-body";
        renderMarkdownFragment(altBody, sections.altworking, { diagramSeed: `${topLevelQNum}-${node.id}` });
        altBlk.appendChild(altLabel);
        altBlk.appendChild(altBody);
        surface.appendChild(altBlk);
      }

      body.appendChild(details);

      if (node.children && node.children.length) {
        for (const child of node.children) {
          const childDom = buildQuestionDOM(child, Math.min(level + 1, 2), datasetCtx, topLevelQNum);
          wrapper.appendChild(childDom);
        }
      }

      return wrapper;
    }

    function collectNavItems(container, sectionedMap) {
      const items = [];
      const qNodes = $$(".q", container);
      for (const q of qNodes) {
        const depth = Number(q.dataset.depth || "0");
        items.push({ id: q.dataset.qid, anchor: q.id, depth });
      }

      if (!sectionedMap) return { sections: null, items };

      const sections = [];
      for (const [sec, qids] of Object.entries(sectionedMap)) {
        const secItems = [];
        for (const qid of qids) {
          const topAnchor = `q-${escapeId(qid)}`;
          const top = items.find(it => it.anchor === topAnchor);
          if (top) secItems.push(top);

          const nested = items.filter(it => it.depth > 0 && it.id.startsWith(qid));
          nested.forEach(it => secItems.push(it));
        }
        sections.push({ label: sec, items: secItems });
      }
      return { sections, items };
    }

    function renderNav(target, navModel, onSelect) {
      target.innerHTML = "";

      const makeList = (items) => {
        const ul = document.createElement("ul");
        ul.className = "nav-list";
        for (const it of items) {
          const li = document.createElement("li");
          li.className = "nav-item";
          li.dataset.depth = String(it.depth);
          li.dataset.anchor = it.anchor;

          const a = document.createElement("a");
          a.href = "#" + it.anchor;
          a.textContent = it.id;
          a.addEventListener("click", (e) => {
            e.preventDefault();
            onSelect(it.anchor);
          });
          li.appendChild(a);
          ul.appendChild(li);
        }
        return ul;
      };

      if (navModel.sections) {
        for (const sec of navModel.sections) {
          const h = document.createElement("div");
          h.className = "nav-section";
          h.textContent = "Section " + sec.label;
          target.appendChild(h);
          target.appendChild(makeList(sec.items.filter(Boolean)));
        }
      } else {
        target.appendChild(makeList(navModel.items));
      }
    }

    function applyActiveNav(anchorId) {
      $$(".nav-item").forEach(n => n.classList.toggle("active", n.dataset.anchor === anchorId));
    }

    function setupScrollSpy(paperEl) {
      const topQs = $$(".q.q-level-0", paperEl);
      if (!topQs.length) return () => {};

      applyActiveNav(topQs[0].id);

      const obs = new IntersectionObserver((entries) => {
        const visible = entries
          .filter(e => e.isIntersecting)
          .sort((a,b) => a.boundingClientRect.top - b.boundingClientRect.top);
        if (visible.length) applyActiveNav(visible[0].target.id);
      }, {
        threshold: [0.15, 0.3, 0.6],
        rootMargin: "-10% 0px -80% 0px"
      });

      topQs.forEach(q => obs.observe(q));
      return () => obs.disconnect();
    }

    function renderKaTeX(root) {
      const nodes = $$(".math-render", root);
      const hasKaTeX = !!window.katex;
      nodes.forEach(n => {
        const latex = n.dataset.math || "";
        const displayMode = n.dataset.display === "true";
        if (!hasKaTeX) {
          n.textContent = latex;
          return;
        }
        try {
          katex.render(latex, n, { displayMode, throwOnError: false, strict: "ignore" });
        } catch (e) {
          n.textContent = latex;
        }
      });
    }

    function renderPaper(datasetKey) {
      const ds = DATASETS[datasetKey];
      $("#paperTitle").textContent = ds.title;

      const paperContent = $("#paperContent");
      paperContent.innerHTML = "";

      const topLevelIds = ds.sectioned ? Object.values(ds.sectioned).flat() : ds.questionIds;
      const groupAssignment = distributionGroups(topLevelIds);

      const datasetCtx = { workingsExpanded: !!ds.workingsExpanded, groupAssignment };

      const blocksToRender = ds.sectioned ? Object.values(ds.sectioned).flat() : ds.questionIds;

      for (const qnum of blocksToRender) {
        const block = EXEMPLAR_BLOCKS[qnum];
        if (!block) continue;
        const tree = parseTopLevelBlock(block);
        const dom = buildQuestionDOM(tree, 0, datasetCtx, qnum);
        dom.id = `q-${escapeId(qnum)}`;
        dom.dataset.qid = qnum;
        paperContent.appendChild(dom);
      }

      const navModel = collectNavItems(paperContent, ds.sectioned);

      const onSelect = (anchor) => {
        const el = document.getElementById(anchor);
        if (el) {
          el.scrollIntoView({
            behavior: matchMedia("(prefers-reduced-motion: reduce)").matches ? "auto" : "smooth",
            block: "start"
          });
        }
        closeDrawer();
      };

      renderNav($("#desktopNav"), navModel, onSelect);
      renderNav($("#mobileNav"), navModel, onSelect);

      renderKaTeX(paperContent);

      if (window.__rtqSpyCleanup) window.__rtqSpyCleanup();
      window.__rtqSpyCleanup = setupScrollSpy(paperContent);
    }

    const drawer = $("#mobileDrawer");
    const jumpBtn = $("#jumpBtn");
    const scrim = $("#drawerScrim");
    const closeBtn = $("#drawerClose");
    const focusablesSelector = 'a[href], button:not([disabled]), [tabindex]:not([tabindex="-1"]), select, input, textarea';

    function setInert(on) {
      const main = $(".shell");
      const top = $(".topbar");
      if (!main || !top) return;
      if (on) {
        main.setAttribute("inert", "");
        top.setAttribute("inert", "");
        main.setAttribute("aria-hidden", "true");
        top.setAttribute("aria-hidden", "true");
      } else {
        main.removeAttribute("inert");
        top.removeAttribute("inert");
        main.removeAttribute("aria-hidden");
        top.removeAttribute("aria-hidden");
      }
    }

    function openDrawer() {
      drawer.setAttribute("aria-hidden", "false");
      setInert(true);
      const focusables = $$(focusablesSelector, drawer).filter(el => el.offsetParent !== null);
      (focusables[0] || closeBtn).focus();
      document.addEventListener("keydown", onDrawerKeydown);
    }

    function closeDrawer() {
      if (drawer.getAttribute("aria-hidden") === "true") return;
      drawer.setAttribute("aria-hidden", "true");
      setInert(false);
      document.removeEventListener("keydown", onDrawerKeydown);
      jumpBtn.focus();
    }

    function onDrawerKeydown(e) {
      if (e.key === "Escape") {
        e.preventDefault();
        closeDrawer();
        return;
      }
      if (e.key !== "Tab") return;

      const focusables = $$(focusablesSelector, drawer).filter(el => el.offsetParent !== null);
      if (!focusables.length) return;

      const first = focusables[0];
      const last = focusables[focusables.length - 1];
      if (e.shiftKey && document.activeElement === first) {
        e.preventDefault();
        last.focus();
      } else if (!e.shiftKey && document.activeElement === last) {
        e.preventDefault();
        first.focus();
      }
    }

    jumpBtn.addEventListener("click", () => openDrawer());
    scrim.addEventListener("click", () => closeDrawer());
    closeBtn.addEventListener("click", () => closeDrawer());

    const paperSelect = $("#paperSelect");
    paperSelect.addEventListener("change", () => {
      renderPaper(paperSelect.value);
      window.scrollTo({ top: 0, left: 0, behavior: matchMedia("(prefers-reduced-motion: reduce)").matches ? "auto" : "smooth" });
    });

    renderPaper("short");
  </script>
</body>
</html>
