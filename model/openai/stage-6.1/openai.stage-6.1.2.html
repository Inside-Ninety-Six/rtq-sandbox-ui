<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RTQ – Maths Paper Solution Viewer (Prototype)</title>

  <!-- KaTeX (CDN) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" crossorigin="anonymous">

  <style>
    :root {
      /* Soft-warm neutral base (subtle) */
      --page-bg: #f4f1eb;
      --frame-bg: #f8f6f1;
      --ink: #1d1d1f;
      /* strongest text (Question) */
      --ink-2: #2f2f33;
      /* Answer */
      --ink-3: #4b4b52;
      /* Supporting text */
      --ink-4: #6a6a73;
      /* Nav + quiet UI */
      --hairline: rgba(0, 0, 0, .10);
      --hairline-2: rgba(0, 0, 0, .14);

      /* Non-semantic accent (non-content UI only) */
      --accent: #2f5d7a;

      --frame-max: 1040px;
      --gutter: 18px;

      --nav-w: 140px;

      --q-gap: 34px;
      --qa-gap: 12px;
      --at-gap: 10px;
      --sub-gap: 16px;

      --indent: 18px;
      --indent-mobile: 12px;

      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      height: 100%;
    }

    body {
      margin: 0;
      font-family: var(--font);
      color: var(--ink);
      background: var(--page-bg);
      line-height: 1.45;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Top control area aligned to centered frame */
    .topbar {
      position: sticky;
      top: 0;
      z-index: 20;
      background: var(--page-bg);
      border-bottom: 1px solid var(--hairline);
    }

    .frame {
      max-width: var(--frame-max);
      margin: 0 auto;
      padding: 10px var(--gutter);
    }

    .controls {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .control-group {
      display: flex;
      align-items: center;
      gap: 10px;
      min-height: 44px;
      /* touch comfort */
    }

    label {
      font-size: 13px;
      color: var(--ink-4);
    }

    select {
      font: inherit;
      font-size: 14px;
      padding: 9px 10px;
      border: 1px solid var(--hairline-2);
      background: #fff;
      color: var(--ink);
      border-radius: 8px;
      min-height: 44px;
    }

    select:focus {
      outline: 2px solid rgba(47, 93, 122, .45);
      outline-offset: 2px;
    }

    .jump-btn {
      margin-left: auto;
      font: inherit;
      font-size: 14px;
      padding: 9px 12px;
      min-height: 44px;
      border: 1px solid var(--hairline-2);
      background: #fff;
      color: var(--ink);
      border-radius: 8px;
      cursor: pointer;
    }

    .jump-btn:hover {
      text-decoration: underline;
    }

    .jump-btn:focus {
      outline: 2px solid rgba(47, 93, 122, .45);
      outline-offset: 2px;
    }

    /* Centered content frame containing nav + paper */
    .paper-shell {
      background: var(--frame-bg);
      border-top: 1px solid rgba(0, 0, 0, 0);
      /* keep surface calm */
    }

    .columns {
      display: flex;
      gap: 24px;
      align-items: flex-start;
    }

    nav[aria-label="Questions"] {
      width: var(--nav-w);
      flex: 0 0 var(--nav-w);
      color: var(--ink-4);
      font-size: 13px;
      line-height: 1.35;
      position: sticky;
      top: 74px;
      /* below topbar in typical cases */
      max-height: calc(100vh - 90px);
    }

    /* Scrollable nav only when needed; hide scrollbar */
    .nav-scroll {
      max-height: calc(100vh - 90px);
      overflow-y: auto;
      padding: 6px 0;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .nav-scroll::-webkit-scrollbar {
      display: none;
    }

    .nav-section {
      padding: 10px 0 6px 0;
      color: var(--ink-4);
      font-size: 12px;
      letter-spacing: .02em;
    }

    .nav-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      padding: 2px 0 14px 0;
    }

    .nav-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: var(--ink-4);
      text-decoration: none;
      padding: 6px 8px 6px 0;
      min-height: 32px;
      border-radius: 6px;
      outline: none;
    }

    .nav-link:hover {
      text-decoration: underline;
    }

    .nav-link:focus {
      outline: 2px solid rgba(47, 93, 122, .45);
      outline-offset: 2px;
    }

    /* Active state: restrained cues (weight + subtle marker), no fills */
    .nav-link[aria-current="true"] {
      color: #2b2b31;
      font-weight: 600;
    }

    .nav-link[aria-current="true"]::before {
      content: "";
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent);
      opacity: .7;
      flex: 0 0 6px;
      transform: translateY(0.5px);
    }

    .nav-link:not([aria-current="true"])::before {
      content: "";
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: transparent;
      flex: 0 0 6px;
    }

    main {
      flex: 1 1 auto;
      min-width: 0;
      padding: 6px 0 40px 0;
    }

    /* Paper content: whitespace-driven grouping */
    .paper-title {
      margin: 14px 0 8px 0;
      font-size: 14px;
      color: var(--ink-4);
    }

    .q {
      margin-top: var(--q-gap);
    }

    .q:first-child {
      margin-top: 18px;
    }

    /* Depth-based rhythm (strongest separation at depth 0) */
    .q[data-depth="0"] {
      margin-top: 34px;
    }

    .q[data-depth="1"] {
      margin-top: 18px;
    }

    .q[data-depth="2"] {
      margin-top: 14px;
    }

    .q[data-depth="3"] {
      margin-top: 12px;
    }

    .q-body {
      padding-left: calc(var(--indent) * var(--depth, 0));
    }

    .q-head {
      display: flex;
      gap: 10px;
      align-items: flex-start;
    }

    .qid {
      flex: 0 0 auto;
      color: var(--ink-3);
      font-size: 14px;
      line-height: 1.4;
      margin-top: 1px;
      white-space: nowrap;
    }

    .q-text {
      flex: 1 1 auto;
      min-width: 0;
      font-size: 16px;
      color: var(--ink);
      line-height: 1.55;
    }

    .answer {
      margin-top: var(--qa-gap);
      display: flex;
      gap: 10px;
      align-items: baseline;
      color: var(--ink-2);
    }

    .label {
      flex: 0 0 auto;
      font-size: 13px;
      color: var(--ink-3);
      font-weight: 600;
      /* label only */
      letter-spacing: .01em;
    }

    .answer-body {
      flex: 1 1 auto;
      min-width: 0;
      font-size: 15px;
      color: var(--ink-2);
      line-height: 1.5;
    }

    .toggle-row {
      margin-top: var(--at-gap);
    }

    .toggle {
      appearance: none;
      border: none;
      background: transparent;
      padding: 6px 0;
      font: inherit;
      font-size: 14px;
      color: var(--accent);
      cursor: pointer;
      min-height: 44px;
      /* touch */
      display: inline-flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
    }

    .toggle:hover {
      text-decoration: underline;
    }

    .toggle:focus {
      outline: 2px solid rgba(47, 93, 122, .45);
      outline-offset: 2px;
    }

    .chev {
      font-size: 12px;
      color: var(--ink-4);
    }

    /* Solution Details surface separation (quiet, no card) */
    .solution {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid var(--hairline);
    }

    .sol-block {
      margin-top: 14px;
    }

    .sol-title {
      font-size: 13px;
      font-weight: 600;
      /* label only */
      color: var(--ink-3);
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .keep-icon {
      width: 14px;
      height: 14px;
      display: inline-block;
      border: 1px solid var(--hairline-2);
      border-radius: 999px;
      position: relative;
      flex: 0 0 14px;
    }

    .keep-icon::after {
      content: "";
      position: absolute;
      inset: 4px;
      border-radius: 999px;
      background: rgba(0, 0, 0, .18);
    }

    .sol-body {
      color: var(--ink-3);
      font-size: 14px;
      line-height: 1.45;
    }

    /* Keep in mind: slightly more prominent than working body */
    .sol-block.keep .sol-body {
      color: #3b3b41;
    }

    /* Formulas used: slightly quieter */
    .sol-block.formulas .sol-body {
      color: var(--ink-3);
    }

    /* Working + Alternative working: densest + quietest */
    .sol-block.working .sol-body,
    .sol-block.alt .sol-body {
      color: var(--ink-3);
    }

    /* Markdown rendering: preserve rhythm without heavy chrome */
    .md> :first-child {
      margin-top: 0;
    }

    .md> :last-child {
      margin-bottom: 0;
    }

    .md p {
      margin: 10px 0;
    }

    .md ul,
    .md ol {
      margin: 10px 0;
      padding-left: 22px;
    }

    .md li {
      margin: 6px 0;
    }

    .md hr {
      border: none;
      border-top: 1px solid var(--hairline);
      margin: 12px 0;
    }

    /* Tables: minimal structural gridlines only */
    .table-wrap {
      overflow-x: auto;
      max-width: 100%;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .table-wrap::-webkit-scrollbar {
      display: none;
    }

    table {
      width: max-content;
      max-width: 100%;
      border-collapse: collapse;
      margin: 10px 0;
      font-size: 13px;
      color: var(--ink-3);
    }

    th,
    td {
      border: 1px solid var(--hairline);
      padding: 6px 8px;
      vertical-align: top;
    }

    th {
      font-weight: 600;
    }

    /* Links in markdown: quiet, non-semantic */
    .md a {
      color: var(--accent);
      text-decoration: underline;
      text-underline-offset: 2px;
    }

    /* KaTeX containment invariant: never widen page; scroll only within display blocks */
    .katex-display {
      max-width: 100%;
      overflow-x: auto;
      overflow-y: hidden;
      padding-bottom: 2px;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .katex-display::-webkit-scrollbar {
      display: none;
    }

    /* Display-math underlay exception: ONLY within Working / Alternative working */
    .math-underlay {
      display: block;
      max-width: 100%;
      padding: 6px 8px;
      margin: 8px 0;
      background: rgba(0, 0, 0, .035);
      /* extremely subtle */
    }

    .math-underlay .katex-display {
      margin: 0;
      padding: 0 0 2px 0;
    }

    /* Inline KaTeX: transparent (no underlay) */
    .katex {
      background: transparent !important;
    }

    /* SVG diagrams: keep grayscale and responsive */
    .md svg {
      max-width: 100%;
      height: auto;
      display: block;
      margin: 10px 0;
    }

    /* Mobile drawer */
    .drawer-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .32);
      display: none;
      z-index: 50;
    }

    .drawer {
      position: fixed;
      top: 0;
      right: 0;
      height: 100%;
      width: min(86vw, 360px);
      background: #fff;
      border-left: 1px solid var(--hairline);
      display: none;
      z-index: 60;
      padding: 14px 14px 18px 14px;
    }

    .drawer header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 8px;
    }

    .drawer h2 {
      margin: 0;
      font-size: 14px;
      color: var(--ink);
      font-weight: 600;
    }

    .drawer .close {
      appearance: none;
      border: 1px solid var(--hairline-2);
      background: #fff;
      border-radius: 8px;
      min-height: 44px;
      padding: 9px 12px;
      cursor: pointer;
      font: inherit;
      font-size: 14px;
    }

    .drawer .close:hover {
      text-decoration: underline;
    }

    .drawer .close:focus {
      outline: 2px solid rgba(47, 93, 122, .45);
      outline-offset: 2px;
    }

    .drawer .nav-scroll {
      max-height: calc(100vh - 90px);
    }

    /* Responsive: on small screens, nav rail hidden; Jump to always accessible */
    @media (max-width: 860px) {
      :root {
        --nav-w: 0px;
      }

      .columns {
        gap: 0;
      }

      nav[aria-label="Questions"] {
        display: none;
      }

      .jump-btn {
        display: inline-flex;
      }

      .q-body {
        padding-left: calc(var(--indent-mobile) * var(--depth, 0));
      }
    }

    @media (min-width: 861px) {
      .jump-btn {
        display: none;
      }
    }

    /* Reduced motion: keep calm */
    @media (prefers-reduced-motion: reduce) {
      html:focus-within {
        scroll-behavior: auto;
      }
    }

    @media (prefers-reduced-motion: no-preference) {
      html {
        scroll-behavior: smooth;
      }
    }
  </style>

  <!-- Markdown-it (CDN) -->
  <script defer src="https://cdn.jsdelivr.net/npm/markdown-it@14.1.0/dist/markdown-it.min.js"
    crossorigin="anonymous"></script>

  <!-- KaTeX (CDN) -->
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js" crossorigin="anonymous"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"
    crossorigin="anonymous"></script>
</head>

<body>
  <header class="topbar">
    <div class="frame">
      <div class="controls" aria-label="Top controls">
        <div class="control-group">
          <label for="paperSelect">Paper</label>
          <select id="paperSelect" aria-label="Paper selector" disabled>
            <option>Loading…</option>
          </select>
        </div>

        <button id="jumpBtn" class="jump-btn" type="button" aria-haspopup="dialog" aria-controls="navDrawer">
          Jump to
        </button>
      </div>
    </div>
  </header>

  <div class="paper-shell">
    <div class="frame">
      <div class="columns">
        <nav aria-label="Questions">
          <div id="navDesktop" class="nav-scroll" tabindex="0"></div>
        </nav>

        <main id="paperMain" tabindex="-1">
          <div class="paper-title" id="paperMeta"></div>
          <div id="paperContent"></div>
        </main>
      </div>
    </div>
  </div>

  <!-- Mobile drawer / overlay -->
  <div id="drawerBackdrop" class="drawer-backdrop" hidden></div>

  <div id="navDrawer" class="drawer" role="dialog" aria-modal="true" aria-label="Jump to question" hidden>
    <header>
      <h2>Jump to</h2>
      <button id="drawerClose" class="close" type="button">Close</button>
    </header>
    <div id="navMobile" class="nav-scroll" tabindex="0"></div>
  </div>

  <script>
    // CANONICAL CONSTANT — PAPERS PAYLOAD PATH (v1.0)
    const RTQ_PAPERS_PAYLOAD_PATH = "../../payload/rtq.papers.payload.json";

    (function () {
      const els = {
        paperSelect: document.getElementById('paperSelect'),
        paperMeta: document.getElementById('paperMeta'),
        paperContent: document.getElementById('paperContent'),
        navDesktop: document.getElementById('navDesktop'),
        navMobile: document.getElementById('navMobile'),
        jumpBtn: document.getElementById('jumpBtn'),
        drawer: document.getElementById('navDrawer'),
        drawerBackdrop: document.getElementById('drawerBackdrop'),
        drawerClose: document.getElementById('drawerClose'),
        paperMain: document.getElementById('paperMain'),
      };

      let md = null;
      let payload = null;
      let currentPaperIndex = 0;
      let observer = null;

      // Drawer focus trap
      let lastFocus = null;
      const focusableSelector = [
        'a[href]',
        'button:not([disabled])',
        'select:not([disabled])',
        'textarea:not([disabled])',
        'input:not([disabled])',
        '[tabindex]:not([tabindex="-1"])'
      ].join(',');

      function initMarkdown() {
        if (!window.markdownit) return null;
        const inst = window.markdownit({
          html: true,
          linkify: true,
          breaks: false
        });
        // TeX backslash preservation (required)
        if (inst && inst.inline && inst.inline.ruler && inst.inline.ruler.disable) {
          inst.inline.ruler.disable(['escape']);
        }
        return inst;
      }

      function renderMarkdown(markdown) {
        if (!md || typeof markdown !== 'string') return '';
        return md.render(markdown);
      }

      function safeId(s) {
        return String(s || '')
          .trim()
          .replace(/\s+/g, '_')
          .replace(/[^a-zA-Z0-9_\-]/g, '_');
      }

      function setMissingPayload() {
        els.paperSelect.innerHTML = '<option>Papers payload missing</option>';
        els.paperSelect.disabled = true;

        els.paperMeta.textContent = '';
        els.navDesktop.innerHTML = '';
        els.navMobile.innerHTML = '';
        els.paperContent.innerHTML = '<div class="q"><div class="q-body" style="--depth:0"><div class="q-text">PAPERS PAYLOAD MISSING</div></div></div>';
      }

      async function loadPayload() {
        try {
          const res = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
          if (!res.ok) throw new Error('fetch failed');
          const json = await res.json();
          if (!json || !Array.isArray(json.papers)) throw new Error('bad schema');
          payload = json;
        } catch (e) {
          payload = null;
        }
      }

      function buildSelector() {
        const papers = payload.papers || [];
        els.paperSelect.innerHTML = '';
        for (let i = 0; i < papers.length; i++) {
          const p = papers[i] || {};
          const opt = document.createElement('option');
          opt.value = String(i);
          opt.textContent = String(p.label ?? p.key ?? `Paper ${i + 1}`);
          els.paperSelect.appendChild(opt);
        }
        els.paperSelect.disabled = papers.length === 0;
        els.paperSelect.value = String(currentPaperIndex);
      }

      function getPaperNavModel(paper) {
        const items = [];
        if (!paper) return items;

        if (Array.isArray(paper.sections)) {
          for (const sec of paper.sections) {
            items.push({ type: 'section', label: String(sec?.label ?? '') });
            const qs = Array.isArray(sec?.questions) ? sec.questions : [];
            for (const q of qs) {
              walkQuestionsForNav(q, items);
            }
          }
        } else {
          const qs = Array.isArray(paper.questions) ? paper.questions : [];
          for (const q of qs) {
            walkQuestionsForNav(q, items);
          }
        }
        return items;
      }

      function walkQuestionsForNav(q, items) {
        if (!q || typeof q !== 'object') return;
        const id = String(q.id ?? '').trim();
        if (id) items.push({ type: 'question', id });
        const children = Array.isArray(q.children) ? q.children : [];
        for (const child of children) {
          walkQuestionsForNav(child, items);
        }
      }

      function renderNav(navItems) {
        function makeNav(container) {
          container.innerHTML = '';
          const list = document.createElement('div');
          list.className = 'nav-list';

          for (const item of navItems) {
            if (item.type === 'section') {
              const sep = document.createElement('div');
              sep.className = 'nav-section';
              sep.textContent = item.label || '';
              container.appendChild(sep);
              continue;
            }
            if (item.type === 'question') {
              const a = document.createElement('a');
              a.className = 'nav-link';
              a.href = `#q_${safeId(item.id)}`;
              a.dataset.target = `q_${safeId(item.id)}`;
              a.textContent = item.id;
              list.appendChild(a);
            }
          }
          container.appendChild(list);
        }

        makeNav(els.navDesktop);
        makeNav(els.navMobile);

        const allLinks = document.querySelectorAll('.nav-link');
        for (const link of allLinks) {
          link.addEventListener('click', (ev) => {
            ev.preventDefault();
            const targetId = link.dataset.target;
            const el = document.getElementById(targetId);
            if (el) el.scrollIntoView({ behavior: prefersReducedMotion() ? 'auto' : 'smooth', block: 'start' });
            closeDrawer();
          });
        }
      }

      function prefersReducedMotion() {
        return window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      }

      function renderPaper(paper) {
        // tear down observer
        if (observer) {
          observer.disconnect();
          observer = null;
        }

        els.paperContent.innerHTML = '';
        els.paperMeta.textContent = '';

        if (!paper) return;

        const label = String(paper.label ?? paper.key ?? '');
        els.paperMeta.textContent = label ? label : '';

        const expandedAll = !!(paper.defaults && paper.defaults.expandedAll === true);

        const container = document.createElement('div');
        const questionsRoot = [];

        if (Array.isArray(paper.sections)) {
          for (const sec of paper.sections) {
            const qs = Array.isArray(sec?.questions) ? sec.questions : [];
            for (const q of qs) questionsRoot.push(q);
          }
        } else {
          const qs = Array.isArray(paper.questions) ? paper.questions : [];
          for (const q of qs) questionsRoot.push(q);
        }

        for (const q of questionsRoot) {
          container.appendChild(renderQuestionNode(q, 0, expandedAll));
        }

        els.paperContent.appendChild(container);

        // Markdown -> HTML already inserted; now KaTeX render
        runKatex(els.paperContent);

        // Post-process for underlay exception ONLY in Working / Alternative working
        applyDisplayMathUnderlay(els.paperContent);

        // Wrap tables for overflow safety
        wrapTables(els.paperContent);

        // Build observer to keep nav oriented
        setupActiveTracking();
      }

      function renderQuestionNode(q, depth, expandedAll) {
        const id = String(q?.id ?? '').trim();
        const elId = `q_${safeId(id)}`;

        const outer = document.createElement('section');
        outer.className = 'q';
        outer.dataset.depth = String(depth);
        outer.id = elId;

        const body = document.createElement('div');
        body.className = 'q-body';
        body.style.setProperty('--depth', String(depth));

        const head = document.createElement('div');
        head.className = 'q-head';

        const qid = document.createElement('span');
        qid.className = 'qid';
        qid.textContent = id;

        const qText = document.createElement('div');
        qText.className = 'q-text md';
        qText.innerHTML = renderMarkdown(q?.question ?? '');

        head.appendChild(qid);
        head.appendChild(qText);

        const answer = document.createElement('div');
        answer.className = 'answer';

        const aLabel = document.createElement('span');
        aLabel.className = 'label';
        aLabel.textContent = 'Answer';

        const aBody = document.createElement('div');
        aBody.className = 'answer-body md';
        aBody.innerHTML = renderMarkdown(q?.answer ?? '');

        answer.appendChild(aLabel);
        answer.appendChild(aBody);

        body.appendChild(head);
        body.appendChild(answer);

        const hasSolution = q && typeof q === 'object' && q.solutionDetails && typeof q.solutionDetails === 'object';
        if (hasSolution) {
          const toggleRow = document.createElement('div');
          toggleRow.className = 'toggle-row';

          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'toggle';
          btn.setAttribute('aria-expanded', expandedAll ? 'true' : 'false');
          btn.setAttribute('aria-controls', `${elId}_sol`);
          btn.innerHTML = `<span class="toggle-text">${expandedAll ? 'Hide working' : 'Show working'}</span><span class="chev" aria-hidden="true">${expandedAll ? '▴' : '▾'}</span>`;

          const sol = document.createElement('div');
          sol.className = 'solution';
          sol.id = `${elId}_sol`;
          if (!expandedAll) sol.hidden = true;

          const sd = q.solutionDetails || {};

          // Order must be: Keep in mind, Formulas used, Working, Alternative working
          if (typeof sd.keepInMind === 'string') {
            sol.appendChild(makeSolBlock('keep', 'Keep in mind', sd.keepInMind, true));
          }
          if (typeof sd.formulasUsed === 'string') {
            sol.appendChild(makeSolBlock('formulas', 'Formulas used', sd.formulasUsed, false));
          }
          if (typeof sd.working === 'string') {
            sol.appendChild(makeSolBlock('working', 'Working', sd.working, false));
          }
          if (typeof sd.alternativeWorking === 'string') {
            sol.appendChild(makeSolBlock('alt', 'Alternative working', sd.alternativeWorking, false));
          }

          btn.addEventListener('click', () => {
            const isOpen = btn.getAttribute('aria-expanded') === 'true';
            const nextOpen = !isOpen;

            btn.setAttribute('aria-expanded', nextOpen ? 'true' : 'false');
            sol.hidden = !nextOpen;

            const t = btn.querySelector('.toggle-text');
            const c = btn.querySelector('.chev');
            if (t) t.textContent = nextOpen ? 'Hide working' : 'Show working';
            if (c) c.textContent = nextOpen ? '▴' : '▾';
          });

          toggleRow.appendChild(btn);
          body.appendChild(toggleRow);
          body.appendChild(sol);
        }

        outer.appendChild(body);

        // Children (nesting from payload only)
        const children = Array.isArray(q?.children) ? q.children : [];
        for (const child of children) {
          outer.appendChild(renderQuestionNode(child, depth + 1, expandedAll));
        }

        return outer;
      }

      function makeSolBlock(kind, title, markdown, withIcon) {
        const wrap = document.createElement('div');
        wrap.className = `sol-block ${kind}`;

        const h = document.createElement('div');
        h.className = 'sol-title';

        if (withIcon) {
          const icon = document.createElement('span');
          icon.className = 'keep-icon';
          icon.setAttribute('aria-hidden', 'true');
          h.appendChild(icon);
        }

        const t = document.createElement('span');
        t.textContent = title;
        h.appendChild(t);

        const b = document.createElement('div');
        b.className = 'sol-body md';
        b.innerHTML = renderMarkdown(markdown);

        wrap.appendChild(h);
        wrap.appendChild(b);
        return wrap;
      }

      function runKatex(container) {
        // Fail gracefully: if KaTeX not available, leave content as text.
        try {
          if (!container) return;
          if (typeof window.renderMathInElement !== 'function') return;

          window.renderMathInElement(container, {
            delimiters: [
              { left: "$$", right: "$$", display: true },
              { left: "$", right: "$", display: false }
            ],
            throwOnError: false
          });
        } catch (e) {
          // Keep content visible (no action)
        }
      }

      function applyDisplayMathUnderlay(root) {
        if (!root) return;

        // Only within Working and Alternative working blocks
        const scopes = root.querySelectorAll('.sol-block.working .sol-body, .sol-block.alt .sol-body');
        for (const scope of scopes) {
          const displays = Array.from(scope.querySelectorAll('.katex-display'));
          for (const kd of displays) {
            // Avoid double-wrapping
            const parent = kd.parentElement;
            if (parent && parent.classList && parent.classList.contains('math-underlay')) continue;

            const underlay = document.createElement('div');
            underlay.className = 'math-underlay';
            kd.replaceWith(underlay);
            underlay.appendChild(kd);
          }
        }
      }

      function wrapTables(root) {
        if (!root) return;
        const tables = Array.from(root.querySelectorAll('table'));
        for (const table of tables) {
          const parent = table.parentElement;
          if (parent && parent.classList && parent.classList.contains('table-wrap')) continue;

          const wrap = document.createElement('div');
          wrap.className = 'table-wrap';
          table.replaceWith(wrap);
          wrap.appendChild(table);
        }
      }

      function setupActiveTracking() {
        const sections = Array.from(document.querySelectorAll('section.q[id^="q_"]'));
        if (!sections.length) return;

        const linkMap = new Map();
        for (const a of document.querySelectorAll('.nav-link')) {
          linkMap.set(a.dataset.target, a);
        }

        function setCurrent(targetId) {
          for (const [id, a] of linkMap.entries()) {
            if (id === targetId) {
              a.setAttribute('aria-current', 'true');
            } else {
              a.removeAttribute('aria-current');
            }
          }
        }

        const topMargin = prefersReducedMotion() ? '0px' : '-20%';
        observer = new IntersectionObserver((entries) => {
          // Pick the closest visible section to the top
          const visible = entries
            .filter(e => e.isIntersecting)
            .sort((a, b) => a.boundingClientRect.top - b.boundingClientRect.top);

          if (!visible.length) return;
          const id = visible[0].target.id;
          setCurrent(id);
        }, {
          root: null,
          rootMargin: `${topMargin} 0px -70% 0px`,
          threshold: [0.01, 0.1, 0.25]
        });

        for (const s of sections) observer.observe(s);

        // Initialize current to first visible
        setTimeout(() => {
          const first = sections[0];
          if (first) {
            const r = first.getBoundingClientRect();
            if (r.top >= 0 && r.top < window.innerHeight) {
              const id = first.id;
              const a = linkMap.get(id);
              if (a) a.setAttribute('aria-current', 'true');
            }
          }
        }, 0);
      }

      function openDrawer() {
        lastFocus = document.activeElement;
        els.drawer.hidden = false;
        els.drawerBackdrop.hidden = false;
        els.drawer.style.display = 'block';
        els.drawerBackdrop.style.display = 'block';

        // Prevent interaction with background
        document.body.style.overflow = 'hidden';
        document.querySelector('.paper-shell').setAttribute('aria-hidden', 'true');
        document.querySelector('.topbar').setAttribute('aria-hidden', 'true');

        // Focus first focusable inside drawer
        const focusables = els.drawer.querySelectorAll(focusableSelector);
        if (focusables.length) focusables[0].focus();

        document.addEventListener('keydown', onDrawerKeydown, true);
        els.drawerBackdrop.addEventListener('click', closeDrawer, { once: true });
      }

      function closeDrawer() {
        if (els.drawer.hidden) return;
        els.drawer.hidden = true;
        els.drawerBackdrop.hidden = true;
        els.drawer.style.display = 'none';
        els.drawerBackdrop.style.display = 'none';

        document.body.style.overflow = '';
        document.querySelector('.paper-shell').removeAttribute('aria-hidden');
        document.querySelector('.topbar').removeAttribute('aria-hidden');

        document.removeEventListener('keydown', onDrawerKeydown, true);

        if (lastFocus && typeof lastFocus.focus === 'function') lastFocus.focus();
        lastFocus = null;
      }

      function onDrawerKeydown(e) {
        if (e.key === 'Escape') {
          e.preventDefault();
          closeDrawer();
          return;
        }
        if (e.key !== 'Tab') return;

        const focusables = Array.from(els.drawer.querySelectorAll(focusableSelector));
        if (!focusables.length) return;

        const first = focusables[0];
        const last = focusables[focusables.length - 1];
        if (e.shiftKey) {
          if (document.activeElement === first) {
            e.preventDefault();
            last.focus();
          }
        } else {
          if (document.activeElement === last) {
            e.preventDefault();
            first.focus();
          }
        }
      }

      function wireUI() {
        els.paperSelect.addEventListener('change', () => {
          const idx = Number(els.paperSelect.value);
          currentPaperIndex = Number.isFinite(idx) ? idx : 0;
          const paper = (payload && payload.papers) ? payload.papers[currentPaperIndex] : null;

          const navModel = getPaperNavModel(paper);
          renderNav(navModel);
          renderPaper(paper);
        });

        els.jumpBtn.addEventListener('click', () => {
          openDrawer();
        });

        els.drawerClose.addEventListener('click', () => closeDrawer());
      }

      async function boot() {
        md = initMarkdown();

        await loadPayload();

        if (!payload) {
          setMissingPayload();
          wireUI();
          return;
        }

        buildSelector();
        els.paperSelect.disabled = false;

        wireUI();

        const paper = payload.papers[currentPaperIndex];
        const navModel = getPaperNavModel(paper);
        renderNav(navModel);
        renderPaper(paper);
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', boot);
      } else {
        boot();
      }
    })();
  </script>
</body>

</html>