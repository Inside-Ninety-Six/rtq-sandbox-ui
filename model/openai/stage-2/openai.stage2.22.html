<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RTQ – Maths Paper Solution Viewer (Stress Test)</title>

  <!-- KaTeX via CDN -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.27/dist/katex.min.css" />
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.27/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.27/dist/contrib/auto-render.min.js"></script>

  <style>
    * {
      box-sizing: border-box;
    }

    html,
    body {
      height: 100%;
    }

    body {
      margin: 0;
      overflow-x: hidden;
      /* main document must never scroll horizontally */
      background: #fff;
      color: #000;
    }

    .frame {
      max-width: 1120px;
      margin: 0 auto;
      padding: 16px;
    }

    header {
      padding-bottom: 12px;
      border-bottom: 1px solid #d0d0d0;
      margin-bottom: 12px;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }

    .controls label {
      white-space: nowrap;
    }

    .controls select,
    .controls button {
      padding: 6px 10px;
    }

    .layout {
      display: flex;
      gap: 24px;
      align-items: flex-start;
    }

    nav {
      flex: 0 0 170px;
      width: 170px;
    }

    .nav-sticky {
      position: sticky;
      top: 12px;
      padding-right: 8px;
      border-right: 1px solid #e0e0e0;
    }

    .nav-scroll {
      max-height: calc(100vh - 120px);
      overflow: auto;

      /* hide scrollbar, keep scroll functional */
      scrollbar-width: none;
      /* Firefox */
      -ms-overflow-style: none;
      /* legacy */
    }

    .nav-scroll::-webkit-scrollbar {
      display: none;
    }

    /* WebKit/Blink */

    .nav-scroll:focus {
      outline: auto;
      /* browser default */
      outline-offset: 2px;
    }

    .nav-list {
      list-style: none;
      margin: 0;
      padding: 0;
    }

    .nav-item a {
      display: block;
      padding: 4px 0;
      text-decoration: none;
      color: inherit;
    }

    .nav-sep {
      padding: 10px 0 6px;
    }

    main {
      flex: 1 1 auto;
      min-width: 0;
    }

    .paper-title {
      margin: 0 0 14px 0;
    }

    .paper-section {
      margin: 18px 0 22px 0;
      padding: 0;
    }

    .question {
      margin: 0 0 30px 0;
      /* largest spacing unit between top-level questions */
      padding: 0;
    }

    .q-header {
      margin: 0 0 6px 0;
    }

    .q-header strong {
      font-weight: 700;
    }

    .q-prompt {
      margin: 0;
    }

    .answer {
      margin-top: 8px;
    }

    .working-wrap {
      margin-top: 8px;
    }

    .working-controls {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 6px;
    }

    .working-preview {
      margin: 0;
    }

    .working-body {
      margin-top: 6px;
    }

    .working-body p,
    .working-preview p,
    .q-prompt p,
    .answer p {
      margin: 0 0 6px 0;
    }

    .indent-1 {
      padding-left: 16px;
    }

    .indent-2 {
      padding-left: 32px;
    }

    .indent-3 {
      padding-left: 48px;
    }

    figure.diagram {
      margin: 10px 0 0 0;
    }

    figure.diagram svg {
      width: 100%;
      height: auto;
      display: block;
    }

    figure.diagram figcaption {
      margin-top: 6px;
    }

    /* KaTeX overflow safety: horizontal scroll only inside display blocks */
    .katex-display {
      max-width: 100%;
      overflow-x: auto;
      overflow-y: hidden;
      -webkit-overflow-scrolling: touch;
    }

    /* Mobile / tablet drawer nav */
    .jump-btn {
      display: none;
    }

    nav.drawer {
      display: none;
    }

    nav.drawer[aria-hidden="false"] {
      display: block;
      position: fixed;
      inset: 0;
      background: #fff;
      padding: 16px;
      z-index: 10;
      border-left: 1px solid #d0d0d0;
    }

    .drawer-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid #d0d0d0;
      margin-bottom: 10px;
    }

    .drawer-header p {
      margin: 0;
    }

    .drawer .nav-sticky {
      position: static;
      top: auto;
      border-right: none;
      padding-right: 0;
    }

    .drawer .nav-scroll {
      max-height: calc(100vh - 90px);
    }

    @media (max-width: 900px) {
      .layout {
        display: block;
      }

      nav.rail {
        display: none;
      }

      .jump-btn {
        display: inline-block;
      }
    }
  </style>
</head>

<body>
  <div class="frame">
    <header>
      <div class="controls">
        <div>
          <label for="paperSelect">Paper Selector</label>
          <select id="paperSelect">
            <option value="short">Short paper</option>
            <option value="standard">Standard paper</option>
            <option value="standard_expanded">Standard (Workings Expanded)</option>
            <option value="diagram">Diagram-heavy paper</option>
            <option value="sectioned">Sectioned paper</option>
          </select>
        </div>

        <button type="button" id="jumpToBtn" class="jump-btn">Jump to</button>
      </div>
    </header>

    <div class="layout">
      <!-- Desktop navigation rail -->
      <nav class="rail" id="navRail">
        <div class="nav-sticky">
          <div class="nav-scroll" id="navScrollRail" tabindex="0">
            <ul class="nav-list" id="navListRail"></ul>
          </div>
        </div>
      </nav>

      <!-- Mobile navigation drawer (same content, rebuilt on dataset switch) -->
      <nav class="drawer" id="navDrawer" aria-hidden="true">
        <div class="drawer-header">
          <p><strong>Jump to</strong></p>
          <button type="button" id="closeDrawerBtn">Close</button>
        </div>
        <div class="nav-sticky">
          <div class="nav-scroll" id="navScrollDrawer" tabindex="0">
            <ul class="nav-list" id="navListDrawer"></ul>
          </div>
        </div>
      </nav>

      <main id="paper" tabindex="-1">
        <!-- Paper content rendered here -->
      </main>
    </div>
  </div>

  <script>
    (function () {
      const paperSelect = document.getElementById('paperSelect');
      const paperEl = document.getElementById('paper');

      const navRail = document.getElementById('navRail');
      const navListRail = document.getElementById('navListRail');

      const navDrawer = document.getElementById('navDrawer');
      const navListDrawer = document.getElementById('navListDrawer');

      const jumpToBtn = document.getElementById('jumpToBtn');
      const closeDrawerBtn = document.getElementById('closeDrawerBtn');

      const MOBILE_BREAKPOINT = 900;

      function isMobile() {
        return window.innerWidth <= MOBILE_BREAKPOINT;
      }

      function setDrawerOpen(open) {
        if (!isMobile()) return;
        navDrawer.setAttribute('aria-hidden', open ? 'false' : 'true');
        navDrawer.hidden = !open;
        if (open) {
          // Do not auto-scroll; focus stays stable unless user tabs.
          closeDrawerBtn.focus();
        } else {
          jumpToBtn.focus();
        }
      }

      function ensureNavMode() {
        if (isMobile()) {
          navRail.hidden = true;
          navDrawer.hidden = (navDrawer.getAttribute('aria-hidden') !== 'false');
        } else {
          navRail.hidden = false;
          navDrawer.hidden = true;
          navDrawer.setAttribute('aria-hidden', 'true');
        }
      }

      jumpToBtn.addEventListener('click', function () {
        setDrawerOpen(true);
      });

      closeDrawerBtn.addEventListener('click', function () {
        setDrawerOpen(false);
      });

      window.addEventListener('resize', ensureNavMode);

      function svgGeometry() {
        return `
          <svg viewBox="0 0 320 160" xmlns="http://www.w3.org/2000/svg">
            <rect x="1" y="1" width="318" height="158" fill="none" stroke="#000" stroke-width="2"/>
            <circle cx="240" cy="80" r="45" fill="none" stroke="#000" stroke-width="2"/>
            <path d="M60 120 L120 30 L180 120 Z" fill="none" stroke="#000" stroke-width="2"/>
            <text x="120" y="28" font-size="14">A</text>
            <text x="52" y="132" font-size="14">B</text>
            <text x="182" y="132" font-size="14">C</text>
            <text x="232" y="32" font-size="14">r</text>
          </svg>
        `;
      }

      function svgBars() {
        return `
          <svg viewBox="0 0 320 160" xmlns="http://www.w3.org/2000/svg">
            <rect x="1" y="1" width="318" height="158" fill="none" stroke="#000" stroke-width="2"/>
            <rect x="30" y="45" width="120" height="30" fill="none" stroke="#000" stroke-width="2"/>
            <rect x="150" y="45" width="140" height="30" fill="none" stroke="#000" stroke-width="2"/>
            <rect x="30" y="95" width="80" height="30" fill="none" stroke="#000" stroke-width="2"/>
            <rect x="110" y="95" width="180" height="30" fill="none" stroke="#000" stroke-width="2"/>
            <text x="30" y="38" font-size="14">Ratio bars</text>
          </svg>
        `;
      }

      function svgGrid() {
        return `
          <svg viewBox="0 0 320 160" xmlns="http://www.w3.org/2000/svg">
            <rect x="1" y="1" width="318" height="158" fill="none" stroke="#000" stroke-width="2"/>
            <line x1="40" y1="130" x2="280" y2="130" stroke="#000" stroke-width="2"/>
            <line x1="60" y1="20" x2="60" y2="140" stroke="#000" stroke-width="2"/>
            ${Array.from({ length: 10 }).map((_, i) => {
          const x = 60 + i * 22;
          return `<line x1="${x}" y1="28" x2="${x}" y2="130" stroke="#000" stroke-width="1" opacity="0.5"/>`;
        }).join('')}
            ${Array.from({ length: 5 }).map((_, i) => {
          const y = 30 + i * 20;
          return `<line x1="60" y1="${y}" x2="280" y2="${y}" stroke="#000" stroke-width="1" opacity="0.5"/>`;
        }).join('')}
            <circle cx="148" cy="90" r="4" fill="#000"/>
            <circle cx="214" cy="70" r="4" fill="#000"/>
            <line x1="148" y1="90" x2="214" y2="70" stroke="#000" stroke-width="2"/>
            <text x="30" y="20" font-size="14">Coordinate grid</text>
          </svg>
        `;
      }

      function svgTable() {
        return `
          <svg viewBox="0 0 320 160" xmlns="http://www.w3.org/2000/svg">
            <rect x="1" y="1" width="318" height="158" fill="none" stroke="#000" stroke-width="2"/>
            <rect x="40" y="35" width="240" height="90" fill="none" stroke="#000" stroke-width="2"/>
            ${[1, 2, 3].map(i => `<line x1="${40 + i * 60}" y1="35" x2="${40 + i * 60}" y2="125" stroke="#000" stroke-width="2"/>`).join('')}
            ${[1, 2].map(i => `<line x1="40" y1="${35 + i * 30}" x2="280" y2="${35 + i * 30}" stroke="#000" stroke-width="2"/>`).join('')}
            <text x="40" y="28" font-size="14">Table / array</text>
          </svg>
        `;
      }

      function para(text) {
        return `<p>${text}</p>`;
      }

      function figure(svg, caption) {
        return `
          <figure class="diagram">
            ${svg}
            <figcaption>${caption}</figcaption>
          </figure>
        `;
      }

      function makeWorkingLinesShort() {
        return [
          para(`We compute step by step: \\(12 + 7 = 19\\).`),
          para(`So the result is \\(19\\).`)
        ];
      }

      function makeWorkingLinesMedium() {
        return [
          para(`Let \\(x\\) be the unknown.`),
          para(`Rearrange: \\(3x + 5 = 2\\times 11\\).`),
          para(`So \\(3x + 5 = 22\\) and \\(3x = 17\\).`),
          para(`Therefore \\(x = \\frac{17}{3}\\).`)
        ];
      }

      function makeLongAlgebraWorkingLines(blockCount = 3) {
        const blocks = [];
        blocks.push(para(`Start with the expression:`));
        blocks.push(para(`$$\\frac{2x-3}{x+4} = 5$$`));
        blocks.push(para(`Multiply both sides by \\(x+4\\):`));
        blocks.push(para(`$$2x - 3 = 5(x+4)$$`));
        blocks.push(para(`Expand and collect terms:`));
        blocks.push(para(`$$2x - 3 = 5x + 20$$`));
        blocks.push(para(`$$-3 - 20 = 5x - 2x$$`));
        blocks.push(para(`$$-23 = 3x$$`));
        blocks.push(para(`So \\(x = -\\frac{23}{3}\\).`));

        if (blockCount >= 2) {
          blocks.push(para(`Check by substitution:`));
          blocks.push(para(`$$\\frac{2(-\\frac{23}{3})-3}{(-\\frac{23}{3})+4} = \\frac{-\\frac{46}{3}-3}{-\\frac{23}{3}+\\frac{12}{3}}$$`));
          blocks.push(para(`$$= \\frac{-\\frac{55}{3}}{-\\frac{11}{3}} = 5$$`));
        }

        if (blockCount >= 3) {
          blocks.push(para(`Alternative method (cross-multiply):`));
          blocks.push(para(`$$2x-3 = 5x+20 \\Rightarrow -23 = 3x$$`));
        }

        return blocks;
      }

      function makeExtremelyLongWorkingLines(lineCount) {
        const lines = [];
        lines.push(para(`We build a long chain of small algebra steps (stress test).`));
        lines.push(para(`$$x_0 = 1$$`));
        for (let i = 1; i <= lineCount; i++) {
          // Mix inline and display to stress rendering and spacing
          if (i % 6 === 0) {
            lines.push(para(`$$x_${i} = x_${i - 1} + 2 = ${i * 2 - 1}$$`));
          } else if (i % 9 === 0) {
            lines.push(para(`Using a rearrangement: \\(x_${i} - x_${i - 1} = 2\\).`));
          } else if (i % 12 === 0) {
            lines.push(para(`$$\\frac{x_${i}}{x_${i - 1}} = \\frac{x_${i - 1}+2}{x_${i - 1}} = 1 + \\frac{2}{x_${i - 1}}$$`));
          } else {
            lines.push(para(`Then \\(x_${i} = x_${i - 1} + 2\\).`));
          }
        }
        lines.push(para(`So after ${lineCount} steps, we have a long working block.`));
        return lines;
      }

      function makeQuestion(id, label, depth, promptHTML, answerHTML, workingPreviewHTML, workingBodyHTML, workingExpandedByDefault) {
        return {
          type: 'question',
          id,
          label,
          depth,
          promptHTML,
          answerHTML,
          workingPreviewHTML,
          workingBodyHTML,
          workingExpandedByDefault: !!workingExpandedByDefault
        };
      }

      function makeSectionHeader(text) {
        return { type: 'sectionHeader', text };
      }

      function buildShortPaper() {
        const items = [];

        items.push(makeQuestion(
          'q-1', '1', 0,
          para(`Calculate: \\(12 + 7\\).`),
          para(`<strong>Answer:</strong> \\(19\\).`),
          para(`Preview: \\(12 + 7 = 19\\).`),
          makeWorkingLinesShort().join(''),
          false
        ));

        items.push(makeQuestion(
          'q-2', '2', 0,
          para(`Calculate: \\(6\\times 8\\).`),
          para(`<strong>Answer:</strong> \\(48\\).`),
          para(`Preview: \\(6\\times 8 = 48\\).`),
          [
            para(`Multiply: \\(6\\times 8 = 48\\).`),
            para(`So the answer is \\(48\\).`)
          ].join(''),
          false
        ));

        // Multi-part with sub-questions
        items.push(makeQuestion(
          'q-3', '3', 0,
          para(`A box has 24 sweets. Some are shared equally.`),
          para(`<strong>Answer:</strong> See parts (a) and (b).`),
          para(`Preview: read parts (a) and (b).`),
          para(`The working is shown in each sub-part below.`),
          false
        ));

        items.push(makeQuestion(
          'q-3a', '3a', 1,
          para(`(a) Share 24 sweets equally between 6 children.`),
          para(`<strong>Answer:</strong> \\(4\\) sweets each.`),
          para(`Preview: \\(24\\div 6 = 4\\).`),
          [
            para(`Divide: \\(24 \\div 6 = 4\\).`),
            para(`So each child gets \\(4\\).`)
          ].join(''),
          false
        ));

        items.push(makeQuestion(
          'q-3b', '3b', 1,
          para(`(b) If 3 sweets are left over, how many were shared equally?`),
          para(`<strong>Answer:</strong> \\(21\\) sweets.`),
          para(`Preview: \\(24 - 3 = 21\\).`),
          [
            para(`Take away the leftovers: \\(24 - 3 = 21\\).`),
            para(`So \\(21\\) sweets were shared equally.`)
          ].join(''),
          false
        ));

        items.push(makeQuestion(
          'q-4', '4', 0,
          para(`Simplify: \\(\\frac{12}{18}\\).`),
          para(`<strong>Answer:</strong> \\(\\frac{2}{3}\\).`),
          para(`Preview: divide top and bottom by 6.`),
          [
            para(`Highest common factor of 12 and 18 is 6.`),
            para(`$$\\frac{12}{18} = \\frac{12\\div 6}{18\\div 6} = \\frac{2}{3}$$`)
          ].join(''),
          false
        ));

        items.push(makeQuestion(
          'q-5', '5', 0,
          para(`Solve: \\(x + 9 = 14\\).`),
          para(`<strong>Answer:</strong> \\(x = 5\\).`),
          para(`Preview: \\(14 - 9 = 5\\).`),
          [
            para(`Subtract 9 from both sides.`),
            para(`$$x = 14 - 9 = 5$$`)
          ].join(''),
          false
        ));

        items.push(makeQuestion(
          'q-6', '6', 0,
          para(`Calculate the area of a rectangle with sides 7 cm and 3 cm.`),
          para(`<strong>Answer:</strong> \\(21\\text{ cm}^2\\).`),
          para(`Preview: \\(7\\times 3\\).`),
          [
            para(`Area = length \\(\\times\\) width.`),
            para(`$$7\\times 3 = 21$$`),
            para(`So the area is \\(21\\text{ cm}^2\\).`)
          ].join(''),
          false
        ));

        return { title: 'Short paper', items };
      }

      function buildStandardPaper(allWorkingsExpanded) {
        const items = [];
        const expanded = !!allWorkingsExpanded;

        // Q1–Q17 mixed short/medium
        for (let q = 1; q <= 17; q++) {
          const id = `q-${q}`;
          const label = String(q);
          const prompt = (q % 5 === 0)
            ? para(`Simplify: \\(\\frac{${q * 2}}{${q * 3}}\\).`)
            : para(`Calculate: \\(${q} + ${q + 7}\\).`);
          const answer = (q % 5 === 0)
            ? para(`<strong>Answer:</strong> \\(\\frac{2}{3}\\) (simplified form).`)
            : para(`<strong>Answer:</strong> \\(${q + (q + 7)}\\).`);
          const preview = (q % 5 === 0)
            ? para(`Preview: reduce the fraction.`)
            : para(`Preview: add the numbers.`);

          const body = (q % 5 === 0)
            ? [
              para(`Divide top and bottom by \\(${q}\\).`),
              para(`$$\\frac{${q * 2}}{${q * 3}} = \\frac{2}{3}$$`)
            ].join('')
            : [
              para(`Add: \\(${q} + ${q + 7} = ${q + (q + 7)}\\).`)
            ].join('');

          items.push(makeQuestion(id, label, 0, prompt, answer, preview, body, expanded));
        }

        // Deep nesting: Q18(a)(i), Q18(a)(ii), Q18(b)
        items.push(makeQuestion(
          'q-18', '18', 0,
          para(`A sequence follows a rule.`),
          para(`<strong>Answer:</strong> See parts.`),
          para(`Preview: read parts (a) and (b).`),
          para(`The working is shown in each sub-part below.`),
          expanded
        ));

        items.push(makeQuestion(
          'q-18a', '18a', 1,
          para(`(a) The first term is \\(2\\). The rule is “add 3”.`),
          para(`<strong>Answer:</strong> See (i) and (ii).`),
          para(`Preview: apply the rule.`),
          para(`Workings are shown in (i) and (ii).`),
          expanded
        ));

        items.push(makeQuestion(
          'q-18ai', '18a(i)', 2,
          para(`(i) Find the 4th term.`),
          para(`<strong>Answer:</strong> \\(11\\).`),
          para(`Preview: add 3 each time.`),
          [
            para(`Terms: \\(2, 5, 8, 11\\).`),
            para(`So the 4th term is \\(11\\).`)
          ].join(''),
          expanded
        ));

        items.push(makeQuestion(
          'q-18aii', '18a(ii)', 2,
          para(`(ii) Find the 10th term.`),
          para(`<strong>Answer:</strong> \\(29\\).`),
          para(`Preview: use \\(a_n = 2 + (n-1)\\times 3\\).`),
          [
            para(`Use the formula:`),
            para(`$$a_n = 2 + (n-1)\\times 3$$`),
            para(`$$a_{10} = 2 + 9\\times 3 = 29$$`)
          ].join(''),
          expanded
        ));

        items.push(makeQuestion(
          'q-18b', '18b', 1,
          para(`(b) Explain why the sequence is arithmetic.`),
          para(`<strong>Answer:</strong> The difference is constant.`),
          para(`Preview: the difference is always 3.`),
          [
            para(`Each term increases by 3.`),
            para(`So the common difference is constant.`)
          ].join(''),
          expanded
        ));

        // Q19–Q25 medium
        for (let q = 19; q <= 25; q++) {
          const id = `q-${q}`;
          const label = String(q);
          const prompt = (q % 2 === 0)
            ? para(`Solve: \\(3x + 5 = 22\\).`)
            : para(`Find the mean of \\(4, 6, 8, 10\\).`);
          const answer = (q % 2 === 0)
            ? para(`<strong>Answer:</strong> \\(x = \\frac{17}{3}\\).`)
            : para(`<strong>Answer:</strong> \\(7\\).`);
          const preview = (q % 2 === 0)
            ? para(`Preview: rearrange and divide by 3.`)
            : para(`Preview: add then divide by 4.`);

          const body = (q % 2 === 0)
            ? makeWorkingLinesMedium().join('')
            : [
              para(`Add: \\(4+6+8+10 = 28\\).`),
              para(`Divide by 4: \\(\\frac{28}{4} = 7\\).`)
            ].join('');

          items.push(makeQuestion(id, label, 0, prompt, answer, preview, body, expanded));
        }

        // Q26–Q35 long algebra; include multiple KaTeX blocks and some extremely long workings
        for (let q = 26; q <= 35; q++) {
          const id = `q-${q}`;
          const label = String(q);

          // Deep nesting within long section: Q30(a)(i), Q30(a)(ii), Q30(b)
          if (q === 30) {
            items.push(makeQuestion(
              'q-30', '30', 0,
              para(`Solve and compare methods.`),
              para(`<strong>Answer:</strong> See parts.`),
              para(`Preview: parts (a) and (b).`),
              para(`The working is shown in each sub-part below.`),
              expanded
            ));

            items.push(makeQuestion(
              'q-30a', '30a', 1,
              para(`(a) Solve: \\(\\frac{2x-3}{x+4} = 5\\).`),
              para(`<strong>Answer:</strong> \\(x = -\\frac{23}{3}\\).`),
              para(`Preview: multiply both sides by \\(x+4\\).`),
              makeLongAlgebraWorkingLines(3).join(''),
              expanded
            ));

            items.push(makeQuestion(
              'q-30ai', '30a(i)', 2,
              para(`(i) Show the rearrangement step.`),
              para(`<strong>Answer:</strong> \\(-23 = 3x\\).`),
              para(`Preview: collect like terms.`),
              [
                para(`From \\(2x - 3 = 5x + 20\\):`),
                para(`$$2x - 5x = 20 + 3$$`),
                para(`$$-3x = 23$$`),
                para(`$$-23 = 3x$$`)
              ].join(''),
              expanded
            ));

            items.push(makeQuestion(
              'q-30aii', '30a(ii)', 2,
              para(`(ii) Verify the solution by substitution.`),
              para(`<strong>Answer:</strong> LHS equals 5.`),
              para(`Preview: substitute \\(x=-\\frac{23}{3}\\).`),
              [
                para(`Substitute and simplify:`),
                para(`$$\\frac{2(-\\frac{23}{3})-3}{(-\\frac{23}{3})+4} = 5$$`)
              ].join(''),
              expanded
            ));

            items.push(makeQuestion(
              'q-30b', '30b', 1,
              para(`(b) Solve: \\(x^2 - 9 = 0\\).`),
              para(`<strong>Answer:</strong> \\(x = 3\\) or \\(x = -3\\).`),
              para(`Preview: factorise.`),
              [
                para(`Factorise:`),
                para(`$$x^2 - 9 = (x-3)(x+3)$$`),
                para(`So \\(x=3\\) or \\(x=-3\\).`)
              ].join(''),
              expanded
            ));

            continue;
          }

          const prompt = para(`Solve: \\(\\frac{2x-3}{x+4} = 5\\) (show full method).`);
          const answer = para(`<strong>Answer:</strong> \\(x = -\\frac{23}{3}\\).`);
          const preview = para(`Preview: multiply, expand, then solve for \\(x\\).`);

          const body = (q === 33 || q === 35)
            ? makeExtremelyLongWorkingLines(56).join('')
            : makeLongAlgebraWorkingLines(3).join('');

          items.push(makeQuestion(id, label, 0, prompt, answer, preview, body, expanded));
        }

        return {
          title: allWorkingsExpanded ? 'Standard (Workings Expanded)' : 'Standard paper',
          items
        };
      }

      function buildDiagramPaper() {
        const items = [];
        // 20 questions, 8 with diagrams
        for (let q = 1; q <= 20; q++) {
          const id = `q-d-${q}`;
          const label = String(q);

          const hasDiagram = [2, 4, 6, 8, 10, 12, 16, 18].includes(q);

          let prompt = para(`Answer the question using the information given.`);
          let diagramHTML = '';
          if (hasDiagram) {
            const diagramType = q % 4;
            if (diagramType === 0) diagramHTML = figure(svgGeometry(), 'Geometry diagram');
            if (diagramType === 1) diagramHTML = figure(svgBars(), 'Ratio bars');
            if (diagramType === 2) diagramHTML = figure(svgGrid(), 'Coordinate grid');
            if (diagramType === 3) diagramHTML = figure(svgTable(), 'Table / array');

            prompt = [
              para(`Use the diagram below.`),
              diagramHTML,
              para(`Find the value of \\(x\\) given the relationship \\(2x+1=9\\).`)
            ].join('');
          } else {
            prompt = [
              para(`Calculate: \\(${q + 9} - ${q}\\).`),
              para(`Write your answer as a number.`)
            ].join('');
          }

          const answer = hasDiagram
            ? para(`<strong>Answer:</strong> \\(x = 4\\).`)
            : para(`<strong>Answer:</strong> \\(${(q + 9) - q}\\).`);

          const preview = hasDiagram
            ? para(`Preview: rearrange \\(2x+1=9\\).`)
            : para(`Preview: subtract.`);

          const body = hasDiagram
            ? [
              para(`Start with \\(2x + 1 = 9\\).`),
              para(`Subtract 1: \\(2x = 8\\).`),
              para(`Divide by 2: \\(x = 4\\).`)
            ].join('')
            : [
              para(`Subtract: \\(${q + 9} - ${q} = 9\\).`)
            ].join('');

          items.push(makeQuestion(id, label, 0, prompt, answer, preview, body, false));
        }

        return { title: 'Diagram-heavy paper', items };
      }

      function buildSectionedPaper() {
        const items = [];

        items.push(makeSectionHeader('Section A'));
        for (let q = 1; q <= 35; q++) {
          const id = `q-a-${q}`;
          const label = String(q);

          const prompt = (q % 6 === 0)
            ? para(`Solve: \\(x + ${q} = ${q + 12}\\).`)
            : para(`Calculate: \\(${q} \\times 3\\).`);

          const answer = (q % 6 === 0)
            ? para(`<strong>Answer:</strong> \\(x = 12\\).`)
            : para(`<strong>Answer:</strong> \\(${q * 3}\\).`);

          const preview = (q % 6 === 0)
            ? para(`Preview: subtract \\(${q}\\) from both sides.`)
            : para(`Preview: multiply by 3.`);

          const body = (q % 6 === 0)
            ? [
              para(`Subtract \\(${q}\\) from both sides:`),
              para(`$$x = ${q + 12} - ${q} = 12$$`)
            ].join('')
            : [
              para(`Multiply: \\(${q}\\times 3 = ${q * 3}\\).`)
            ].join('');

          items.push(makeQuestion(id, label, 0, prompt, answer, preview, body, false));
        }

        items.push(makeSectionHeader('Section B'));
        for (let q = 1; q <= 8; q++) {
          const id = `q-b-${q}`;
          const label = `B${q}`;

          const prompt = para(`Simplify: \\(\\frac{${q * 8}}{${q * 12}}\\).`);
          const answer = para(`<strong>Answer:</strong> \\(\\frac{2}{3}\\).`);
          const preview = para(`Preview: reduce the fraction.`);
          const body = [
            para(`Divide top and bottom by \\(${q * 4}\\):`),
            para(`$$\\frac{${q * 8}}{${q * 12}} = \\frac{2}{3}$$`)
          ].join('');

          items.push(makeQuestion(id, label, 0, prompt, answer, preview, body, false));
        }

        items.push(makeSectionHeader('Section C'));
        for (let q = 1; q <= 6; q++) {
          const id = `q-c-${q}`;
          const label = `C${q}`;

          const prompt = para(`Long working question: solve \\(\\frac{2x-3}{x+4} = 5\\).`);
          const answer = para(`<strong>Answer:</strong> \\(x = -\\frac{23}{3}\\).`);
          const preview = para(`Preview: multiply, expand, then solve.`);

          const body = (q === 2 || q === 5)
            ? makeExtremelyLongWorkingLines(60).join('')
            : makeLongAlgebraWorkingLines(3).join('');

          items.push(makeQuestion(id, label, 0, prompt, answer, preview, body, false));
        }

        return { title: 'Sectioned paper', items };
      }

      const datasets = {
        short: buildShortPaper,
        standard: () => buildStandardPaper(false),
        standard_expanded: () => buildStandardPaper(true),
        diagram: buildDiagramPaper,
        sectioned: buildSectionedPaper
      };

      function clearEl(el) {
        while (el.firstChild) el.removeChild(el.firstChild);
      }

      function renderMathSafely(root) {
        // If KaTeX fails to load, fall back to plain text (do nothing).
        if (!window.renderMathInElement) return;

        try {
          window.renderMathInElement(root, {
            delimiters: [
              { left: "$$", right: "$$", display: true },
              { left: "\\(", right: "\\)", display: false }
            ],
            throwOnError: false
          });
        } catch (e) {
          // Graceful fallback: keep text.
        }
      }

      function buildNavItem(label, targetId) {
        const li = document.createElement('li');
        li.className = 'nav-item';

        const a = document.createElement('a');
        a.href = `#${targetId}`;
        a.textContent = label;

        a.addEventListener('click', function () {
          // Navigation is non-destructive: do not change expanded/collapsed states.
          // On mobile, close drawer after choosing a target.
          if (isMobile()) setDrawerOpen(false);
        });

        li.appendChild(a);
        return li;
      }

      function buildNavSeparator(text) {
        const div = document.createElement('div');
        div.className = 'nav-sep';
        div.textContent = text;
        return div;
      }

      function buildQuestionNode(q) {
        const section = document.createElement('section');
        section.className = 'question';
        section.id = q.id;

        if (q.depth === 1) section.classList.add('indent-1');
        if (q.depth === 2) section.classList.add('indent-2');
        if (q.depth === 3) section.classList.add('indent-3');

        const header = document.createElement('header');
        header.className = 'q-header';
        header.innerHTML = `<p><strong>Q${q.label}</strong></p>`;
        section.appendChild(header);

        const prompt = document.createElement('div');
        prompt.className = 'q-prompt';
        prompt.innerHTML = q.promptHTML;
        section.appendChild(prompt);

        const answer = document.createElement('div');
        answer.className = 'answer';
        answer.innerHTML = q.answerHTML;
        section.appendChild(answer);

        // Working block: collapsed by default with preview
        const workingWrap = document.createElement('div');
        workingWrap.className = 'working-wrap';

        const controls = document.createElement('div');
        controls.className = 'working-controls';

        const btn = document.createElement('button');
        btn.type = 'button';
        btn.textContent = q.workingExpandedByDefault ? 'Hide working' : 'Show working';

        const previewId = `${q.id}-working-preview`;
        const bodyId = `${q.id}-working-body`;

        // ARIA attributes used only for state/association (minimal and necessary for control clarity)
        btn.setAttribute('aria-controls', bodyId);
        btn.setAttribute('aria-expanded', q.workingExpandedByDefault ? 'true' : 'false');

        controls.appendChild(btn);
        workingWrap.appendChild(controls);

        const preview = document.createElement('div');
        preview.className = 'working-preview';
        preview.id = previewId;
        preview.innerHTML = q.workingPreviewHTML || '';
        workingWrap.appendChild(preview);

        const body = document.createElement('div');
        body.className = 'working-body';
        body.id = bodyId;
        body.innerHTML = q.workingBodyHTML || '';
        workingWrap.appendChild(body);

        // Default visibility rules:
        // - Answers visible by default
        // - Workings collapsed by default (except dataset variant)
        // Hidden workings must not be focusable -> use hidden attribute.
        function applyState(expanded) {
          btn.setAttribute('aria-expanded', expanded ? 'true' : 'false');
          btn.textContent = expanded ? 'Hide working' : 'Show working';

          if (expanded) {
            body.hidden = false;
            preview.hidden = true;
          } else {
            body.hidden = true;
            preview.hidden = false;
          }
        }

        // Initialize
        applyState(!!q.workingExpandedByDefault);

        btn.addEventListener('click', function () {
          const expanded = btn.getAttribute('aria-expanded') === 'true';
          applyState(!expanded);
          // Do NOT move focus; do NOT auto-scroll.
        });

        section.appendChild(workingWrap);

        return section;
      }

      function buildSectionNode(text) {
        const sec = document.createElement('section');
        sec.className = 'paper-section';
        sec.innerHTML = `<p><strong>${text}</strong></p>`;
        return sec;
      }

      function renderDataset(key) {
        ensureNavMode();

        const dataset = datasets[key]();
        clearEl(navListRail);
        clearEl(navListDrawer);
        clearEl(paperEl);

        const title = document.createElement('p');
        title.className = 'paper-title';
        title.innerHTML = `<strong>${dataset.title}</strong>`;
        paperEl.appendChild(title);

        dataset.items.forEach(item => {
          if (item.type === 'sectionHeader') {
            // Content includes original section separators (A/B/C)
            paperEl.appendChild(buildSectionNode(item.text));

            // Nav includes non-clickable separators
            navListRail.appendChild(buildNavSeparator(item.text));
            navListDrawer.appendChild(buildNavSeparator(item.text));
            return;
          }

          const qNode = buildQuestionNode(item);
          paperEl.appendChild(qNode);

          // Navigation is question-number-only
          navListRail.appendChild(buildNavItem(item.label, item.id));
          navListDrawer.appendChild(buildNavItem(item.label, item.id));
        });

        // KaTeX render programmatically; fallback is plain text
        renderMathSafely(paperEl);
      }

      paperSelect.addEventListener('change', function () {
        renderDataset(paperSelect.value);
      });

      // Initialize nav mode and initial render
      ensureNavMode();
      renderDataset(paperSelect.value);
    })();
  </script>
</body>

</html>