<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RTQ – Maths Paper Solution Viewer (Stress-Test Harness)</title>

  <!-- KaTeX (CDN) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css"
    integrity="sha384-nB0miv6/jRmo5kQmF7J9Gk3E0b7r2W6cJQy1cLzR8JrjZzXqF6kC2o9G6V0y0v8Q" crossorigin="anonymous">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"
    integrity="sha384-7zkQWk3V9ZJ8oWQ0q2p+uX0u9Kzq0m9n5Vh7Ww8qvF0y8vZx1y2tQd0GQmGQbF2j"
    crossorigin="anonymous"></script>

  <style>
    /* Grayscale only; rely on rhythm/spacing, not cards/boxes */
    :root {
      --frame-max: 1060px;
      --nav-w: 160px;
      --gutter: 18px;
      --tight: 10px;
      --mid: 16px;
      --loose: 28px;
      /* largest spacing unit between top-level questions */
      --ink: #111;
      --muted: #666;
      --hairline: #d6d6d6;
      --bg: #fff;
      --focus: #000;
    }

    html,
    body {
      height: 100%;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--ink);
      overflow-x: hidden;
      /* never page-level horizontal scrolling */
      font: 16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }

    /* Top controls: stable, aligned with centered frame */
    .topbar {
      position: sticky;
      top: 0;
      z-index: 5;
      background: var(--bg);
      border-bottom: 1px solid var(--hairline);
    }

    .topbar-inner {
      max-width: var(--frame-max);
      margin: 0 auto;
      padding: 10px var(--gutter);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .topbar h1 {
      margin: 0;
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.2px;
      white-space: nowrap;
    }

    .topbar .spacer {
      flex: 1;
    }

    label {
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
    }

    select,
    button {
      font: inherit;
    }

    select {
      border: 1px solid var(--hairline);
      background: #fff;
      padding: 6px 8px;
      border-radius: 0;
    }

    .jump-btn {
      border: 1px solid var(--hairline);
      background: #fff;
      padding: 6px 10px;
      border-radius: 0;
      cursor: pointer;
    }

    .jump-btn:focus-visible,
    .nav a:focus-visible,
    .toggle-btn:focus-visible,
    .nav-item:focus-visible {
      outline: 2px solid var(--focus);
      outline-offset: 2px;
    }

    /* Centered frame contains BOTH nav + content as sibling columns */
    .frame {
      max-width: var(--frame-max);
      margin: 0 auto;
      padding: 0 var(--gutter);
    }

    .columns {
      display: grid;
      grid-template-columns: var(--nav-w) 1fr;
      gap: 18px;
      align-items: start;
      padding-top: 14px;
    }

    /* Navigation: minimal rail, sticky; may scroll if too tall, scrollbar hidden */
    .nav {
      position: sticky;
      top: 54px;
      /* below topbar; stable */
      align-self: start;
    }

    .nav-title {
      font-size: 12px;
      color: var(--muted);
      margin: 0 0 8px 0;
    }

    .nav-scroll {
      max-height: calc(100vh - 70px);
      overflow: auto;
      /* allowed ONLY here if needed */
      scrollbar-width: none;
      /* Firefox */
      -ms-overflow-style: none;
      /* legacy */
    }

    .nav-scroll::-webkit-scrollbar {
      display: none;
    }

    /* WebKit/Blink */

    .nav-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .nav-sep {
      margin: 10px 0 6px 0;
      font-size: 12px;
      color: var(--muted);
    }

    .nav-item {
      display: block;
      width: 100%;
      text-align: left;
      border: none;
      background: transparent;
      padding: 6px 2px;
      cursor: pointer;
      font-size: 14px;
      color: var(--ink);
    }

    .nav-item[data-level="1"] {
      padding-left: 10px;
      font-size: 13px;
      color: #222;
    }

    .nav-item[data-level="2"] {
      padding-left: 20px;
      font-size: 13px;
      color: #222;
    }

    .nav-item:hover {
      text-decoration: underline;
    }

    .nav-item[aria-current="true"] {
      text-decoration: underline;
    }

    /* Paper content: single continuous scroll (body) */
    .paper {
      padding-bottom: 60px;
      min-width: 0;
    }

    .paper-meta {
      margin: 0 0 12px 0;
      font-size: 12px;
      color: var(--muted);
    }

    /* Questions: whitespace-driven rhythm; no cards/panels */
    .q {
      margin: 0 0 var(--loose) 0;
      /* biggest unit between top-level questions */
      padding: 0;
    }

    .q[data-depth="0"] {
      margin-left: 0;
    }

    .q[data-depth="1"] {
      margin-left: 18px;
    }

    .q[data-depth="2"] {
      margin-left: 34px;
    }

    .q-head {
      display: flex;
      align-items: baseline;
      gap: 10px;
      margin-bottom: var(--tight);
    }

    .q-num {
      font-weight: 700;
      white-space: nowrap;
    }

    .q-prompt {
      margin: 0;
    }

    /* Answer: visible by default, secondary to question, above working */
    .answer {
      margin: 0 0 var(--tight) 0;
      color: #222;
    }

    .answer .label {
      font-size: 12px;
      color: var(--muted);
      margin-right: 8px;
    }

    /* Working: collapsed by default; inline toggle; minimal preview (1–2 lines) */
    .working {
      margin-top: 2px;
    }

    .working-row {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .toggle-btn {
      border: 1px solid var(--hairline);
      background: #fff;
      padding: 6px 10px;
      cursor: pointer;
      border-radius: 0;
      font-size: 14px;
    }

    .working-preview {
      color: var(--muted);
      font-size: 13px;
      max-width: 100%;
    }

    .working-body {
      margin-top: 8px;
    }

    .working[data-state="collapsed"] .working-body {
      display: none;
    }

    /* Math containers: allow horizontal scroll ONLY inside block-level math */
    .math-inline {
      white-space: nowrap;
    }

    .math-block {
      margin: 8px 0;
      max-width: 100%;
      overflow-x: auto;
      /* permitted only here */
      overflow-y: hidden;
      -webkit-overflow-scrolling: touch;
    }

    .math-block>.math-block-inner {
      display: inline-block;
      /* prevents forcing page overflow */
      padding: 2px 0;
    }

    /* Diagrams: inline SVG placeholders inside question */
    .diagram {
      margin: 10px 0 0 0;
      max-width: 100%;
    }

    .diagram svg {
      width: 100%;
      height: auto;
      display: block;
    }

    .diagram .caption {
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
    }

    /* Mobile: nav becomes overlay/drawer; keep “Jump to” always accessible */
    .nav-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.05);
      display: none;
      z-index: 10;
    }

    .nav-overlay[aria-hidden="false"] {
      display: block;
    }

    .nav-drawer {
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      width: min(320px, 86vw);
      background: #fff;
      border-right: 1px solid var(--hairline);
      padding: 12px var(--gutter);
      display: grid;
      grid-template-rows: auto 1fr;
      gap: 10px;
    }

    .drawer-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .drawer-title {
      margin: 0;
      font-size: 13px;
      color: var(--muted);
      font-weight: 600;
    }

    .close-btn {
      border: 1px solid var(--hairline);
      background: #fff;
      padding: 6px 10px;
      cursor: pointer;
      border-radius: 0;
    }

    .drawer-scroll {
      overflow: auto;
      /* allowed only in navigation list */
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .drawer-scroll::-webkit-scrollbar {
      display: none;
    }

    @media (max-width: 860px) {
      :root {
        --nav-w: 0px;
      }

      .columns {
        grid-template-columns: 1fr;
      }

      .nav {
        display: none;
      }
    }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce) {
      html:focus-within {
        scroll-behavior: auto;
      }
    }
  </style>
</head>

<body>
  <header class="topbar" role="banner">
    <div class="topbar-inner">
      <h1>RTQ – Paper Viewer</h1>

      <label for="paperSelect">Paper</label>
      <select id="paperSelect" aria-label="Paper selector"></select>

      <div class="spacer"></div>

      <button id="jumpBtn" class="jump-btn" type="button" aria-haspopup="dialog" aria-controls="navOverlay">
        Jump to
      </button>
    </div>
  </header>

  <!-- Mobile navigation overlay -->
  <div id="navOverlay" class="nav-overlay" aria-hidden="true">
    <div class="nav-drawer" role="dialog" aria-modal="true" aria-label="Jump to question">
      <div class="drawer-head">
        <p class="drawer-title">Jump to</p>
        <button id="closeDrawer" class="close-btn" type="button">Close</button>
      </div>
      <div id="drawerScroll" class="drawer-scroll" tabindex="0" aria-label="Question list (scrollable)">
        <ul id="drawerList" class="nav-list"></ul>
      </div>
    </div>
  </div>

  <main class="frame" role="main">
    <div class="columns">
      <!-- Desktop navigation rail -->
      <nav class="nav" aria-label="Question navigation">
        <p class="nav-title">Jump to</p>
        <div id="navScroll" class="nav-scroll" tabindex="0" aria-label="Question list (scrollable)">
          <ul id="navList" class="nav-list"></ul>
        </div>
      </nav>

      <!-- Paper content -->
      <article id="paper" class="paper" aria-label="Paper content"></article>
    </div>
  </main>

  <script>
    /* -------------------------
       Dataset builders
       ------------------------- */

    function range(n, fn) { return Array.from({ length: n }, (_, i) => fn(i)); }

    function katexLine(tex) { return { kind: "katex", display: false, tex }; }
    function katexBlock(tex) { return { kind: "katex", display: true, tex }; }
    function textLine(text) { return { kind: "text", text }; }
    function diagram(kind) { return { kind: "diagram", diagramKind: kind }; }

    function makeLongWorkingLines(count) {
      // 50–60 lines of maths working (selected questions)
      const lines = [];
      for (let i = 1; i <= count; i++) {
        lines.push(katexBlock(String.raw`\text{Step }${i}: \quad x_{${i}} = \frac{${i}+1}{${i}+2} \Rightarrow x_{${i}} - x_{${i - 1}} = \frac{1}{(${i}+2)(${i}+1)}`));
      }
      return lines;
    }

    function makeAlgebraWorking() {
      return [
        katexBlock(String.raw`2(3x - 4) = 5x + 8`),
        katexBlock(String.raw`6x - 8 = 5x + 8`),
        katexBlock(String.raw`x = 16`)
      ];
    }

    function makeStandardQuestions() {
      const qs = [];

      // Q1–Q17 (small/medium mix)
      for (let q = 1; q <= 17; q++) {
        qs.push({
          id: `q${q}`,
          label: `${q}`,
          depth: 0,
          prompt: [
            textLine(`Compute:`),
            katexLine(String.raw`${q}+${q + 3}=\ ?`)
          ],
          answer: [katexLine(String.raw`${2 * q + 3}`)],
          working: [
            katexBlock(String.raw`${q}+${q + 3}=${2 * q + 3}`)
          ]
        });
      }

      // Q18 deep nesting: 18(a)(i), 18(a)(ii), 18(b)
      qs.push({
        id: `q18`,
        label: `18`,
        depth: 0,
        prompt: [
          textLine(`A rectangle has perimeter 24 cm.`),
          textLine(`Answer parts (a) and (b).`)
        ],
        answer: [textLine(`(See sub-parts)`)], // answer visible but not misleading; sub-parts carry final answers
        working: [textLine(`Use sub-parts below.`)],
        children: [
          {
            id: `q18a`,
            label: `18a`,
            depth: 1,
            prompt: [
              textLine(`(a) If the length is 7 cm, find the width.`)
            ],
            answer: [katexLine(String.raw`5\text{ cm}`)],
            working: [
              katexBlock(String.raw`2(L+W)=24`),
              katexBlock(String.raw`2(7+W)=24`),
              katexBlock(String.raw`7+W=12`),
              katexBlock(String.raw`W=5`)
            ],
            children: [
              {
                id: `q18a_i`,
                label: `18a(i)`,
                depth: 2,
                prompt: [textLine(`(i) Write the perimeter equation.`)],
                answer: [katexLine(String.raw`2(L+W)=24`)],
                working: [
                  katexBlock(String.raw`\text{Perimeter of a rectangle} = 2L + 2W = 2(L+W)`),
                  katexBlock(String.raw`2(L+W)=24`)
                ]
              },
              {
                id: `q18a_ii`,
                label: `18a(ii)`,
                depth: 2,
                prompt: [textLine(`(ii) Substitute L = 7 and solve for W.`)],
                answer: [katexLine(String.raw`W=5`)],
                working: [
                  katexBlock(String.raw`2(7+W)=24`),
                  katexBlock(String.raw`7+W=12`),
                  katexBlock(String.raw`W=5`)
                ]
              }
            ]
          },
          {
            id: `q18b`,
            label: `18b`,
            depth: 1,
            prompt: [
              textLine(`(b) If the width is 4 cm, find the length.`)
            ],
            answer: [katexLine(String.raw`8\text{ cm}`)],
            working: [
              katexBlock(String.raw`2(L+4)=24`),
              katexBlock(String.raw`L+4=12`),
              katexBlock(String.raw`L=8`)
            ]
          }
        ]
      });

      // Q19–Q25 (more variety)
      for (let q = 19; q <= 25; q++) {
        qs.push({
          id: `q${q}`,
          label: `${q}`,
          depth: 0,
          prompt: [
            textLine(`Simplify:`),
            katexLine(String.raw`\frac{${q + 1}}{${q + 2}} + \frac{1}{${q + 2}}`)
          ],
          answer: [katexLine(String.raw`\frac{${q + 2}}{${q + 2}}=1`)],
          working: [
            katexBlock(String.raw`\frac{${q + 1}}{${q + 2}} + \frac{1}{${q + 2}} = \frac{${q + 2}}{${q + 2}} = 1`)
          ]
        });
      }

      // Q26–Q35 long algebra; workings collapsed by default (dataset defaults)
      for (let q = 26; q <= 35; q++) {
        const base = [
          textLine(`Solve for x:`),
          katexLine(String.raw`2(3x-4)=5x+8`)
        ];

        let workingLines = [
          ...makeAlgebraWorking(),
          katexBlock(String.raw`\text{Check: }2(3\cdot16-4)=2(48-4)=88,\quad 5\cdot16+8=88`)
        ];

        // Add multiple KaTeX blocks for long ones
        if (q >= 30) {
          workingLines = [
            ...workingLines,
            katexBlock(String.raw`\text{Alternative method: }6x-8=5x+8 \Rightarrow 6x-5x=8+8`),
            katexBlock(String.raw`x=16`)
          ];
        }

        // Extremely long workings on selected questions
        if (q === 33 || q === 34) {
          workingLines = [
            ...workingLines,
            textLine(`Extended working:`),
            ...makeLongWorkingLines(55)
          ];
        }

        // Deep nesting add-on: Q30(a)(i), Q30(a)(ii), Q30(b)
        if (q === 30) {
          qs.push({
            id: `q30`,
            label: `30`,
            depth: 0,
            prompt: base,
            answer: [katexLine(String.raw`x=16`)],
            working: workingLines,
            children: [
              {
                id: `q30a`,
                label: `30a`,
                depth: 1,
                prompt: [textLine(`(a) Rearrange the equation step-by-step.`)],
                answer: [textLine(`(See sub-parts)`)],
                working: [textLine(`Use sub-parts below.`)],
                children: [
                  {
                    id: `q30a_i`,
                    label: `30a(i)`,
                    depth: 2,
                    prompt: [textLine(`(i) Expand the brackets.`)],
                    answer: [katexLine(String.raw`6x-8=5x+8`)],
                    working: [
                      katexBlock(String.raw`2(3x-4)=6x-8`),
                      katexBlock(String.raw`6x-8=5x+8`)
                    ]
                  },
                  {
                    id: `q30a_ii`,
                    label: `30a(ii)`,
                    depth: 2,
                    prompt: [textLine(`(ii) Collect like terms to find x.`)],
                    answer: [katexLine(String.raw`x=16`)],
                    working: [
                      katexBlock(String.raw`6x-5x=8+8`),
                      katexBlock(String.raw`x=16`)
                    ]
                  }
                ]
              },
              {
                id: `q30b`,
                label: `30b`,
                depth: 1,
                prompt: [textLine(`(b) Verify your solution.`)],
                answer: [katexLine(String.raw`88=88`)],
                working: [
                  katexBlock(String.raw`2(3\cdot16-4)=88`),
                  katexBlock(String.raw`5\cdot16+8=88`)
                ]
              }
            ]
          });
          continue; // avoid duplicate plain Q30 below
        }

        qs.push({
          id: `q${q}`,
          label: `${q}`,
          depth: 0,
          prompt: base,
          answer: [katexLine(String.raw`x=16`)],
          working: workingLines
        });
      }

      return qs;
    }

    function makeShortPaper() {
      return {
        id: "short",
        title: "Short paper",
        meta: "6 questions • mix of short arithmetic and one multi-part question",
        defaults: { workingsExpanded: false },
        sections: null,
        questions: [
          {
            id: "q1", label: "1", depth: 0,
            prompt: [textLine("Compute:"), katexLine(String.raw`7+5=\ ?`)],
            answer: [katexLine(String.raw`12`)],
            working: [katexBlock(String.raw`7+5=12`)]
          },
          {
            id: "q2", label: "2", depth: 0,
            prompt: [textLine("Compute:"), katexLine(String.raw`36\div 6=\ ?`)],
            answer: [katexLine(String.raw`6`)],
            working: [katexBlock(String.raw`36\div 6=6`)]
          },
          {
            id: "q3", label: "3", depth: 0,
            prompt: [textLine("Find:"), katexLine(String.raw`\frac{3}{4}\text{ of }20`)],
            answer: [katexLine(String.raw`15`)],
            working: [
              katexBlock(String.raw`\frac{3}{4}\times 20 = 3\times 5 = 15`)
            ]
          },
          {
            id: "q4", label: "4", depth: 0,
            prompt: [textLine("Simplify:"), katexLine(String.raw`2x+3x`)],
            answer: [katexLine(String.raw`5x`)],
            working: [katexBlock(String.raw`2x+3x=(2+3)x=5x`)]
          },
          {
            id: "q5", label: "5", depth: 0,
            prompt: [textLine("A bag has 12 red and 8 blue marbles. How many marbles?")],
            answer: [katexLine(String.raw`20`)],
            working: [katexBlock(String.raw`12+8=20`)]
          },
          {
            id: "q6", label: "6", depth: 0,
            prompt: [textLine("Answer parts (a) and (b).")],
            answer: [textLine("(See sub-parts)")],
            working: [textLine("Use sub-parts below.")],
            children: [
              {
                id: "q6a", label: "6a", depth: 1,
                prompt: [textLine("(a) Solve:"), katexLine(String.raw`x+9=14`)],
                answer: [katexLine(String.raw`x=5`)],
                working: [katexBlock(String.raw`x=14-9=5`)]
              },
              {
                id: "q6b", label: "6b", depth: 1,
                prompt: [textLine("(b) Solve:"), katexLine(String.raw`3y=27`)],
                answer: [katexLine(String.raw`y=9`)],
                working: [katexBlock(String.raw`y=27\div 3=9`)]
              }
            ]
          }
        ]
      };
    }

    function makeStandardPaper(workingsExpanded) {
      return {
        id: workingsExpanded ? "standardExpanded" : "standard",
        title: workingsExpanded ? "Standard (Workings Expanded)" : "Standard paper",
        meta: "35 questions • Q26–Q35 long algebra • deep nesting • extremely long workings in selected questions",
        defaults: { workingsExpanded: !!workingsExpanded },
        sections: null,
        questions: makeStandardQuestions()
      };
    }

    function makeDiagramHeavyPaper() {
      // 20 questions; 8 contain diagrams; reuse 4 diagram types
      const diagQs = new Set([2, 4, 6, 8, 11, 13, 16, 19]);
      const types = ["geometry", "bars", "grid", "table"];
      const qs = [];
      for (let q = 1; q <= 20; q++) {
        const hasD = diagQs.has(q);
        const kind = types[(q - 1) % types.length];
        qs.push({
          id: `q${q}`, label: `${q}`, depth: 0,
          prompt: [
            textLine(hasD ? "Use the diagram to answer:" : "Answer:"),
            hasD ? diagram(kind) : katexLine(String.raw`${q}+${q + 1}=\ ?`)
          ],
          answer: [hasD ? textLine("Answer depends on the diagram values shown.") : katexLine(String.raw`${2 * q + 1}`)],
          working: [
            hasD
              ? textLine("Show working with measurements/values read from the diagram.")
              : katexBlock(String.raw`${q}+${q + 1}=${2 * q + 1}`)
          ]
        });
      }
      return {
        id: "diagram",
        title: "Diagram-heavy paper",
        meta: "20 questions • 8 include diagrams (inline SVG placeholders)",
        defaults: { workingsExpanded: false },
        sections: null,
        questions: qs
      };
    }

    function makeSectionedPaper() {
      // Original structure only: A/B/C labels as plain-text separators (non-clickable)
      const secA = range(35, i => {
        const q = i + 1;
        return {
          id: `a${q}`, label: `${q}`, depth: 0,
          prompt: [textLine("Compute:"), katexLine(String.raw`${q}\times 3=\ ?`)],
          answer: [katexLine(String.raw`${q * 3}`)],
          working: [katexBlock(String.raw`${q}\times 3=${q * 3}`)]
        };
      });

      const secB = range(8, i => {
        const q = i + 1;
        return {
          id: `b${q}`, label: `${q}`, depth: 0,
          prompt: [textLine("Solve:"), katexLine(String.raw`x+${q}=20`)],
          answer: [katexLine(String.raw`x=${20 - q}`)],
          working: [katexBlock(String.raw`x=20-${q}=${20 - q}`)]
        };
      });

      const secC = range(6, i => {
        const q = i + 1;
        return {
          id: `c${q}`, label: `${q}`, depth: 0,
          prompt: [
            textLine("Long working question:"),
            katexLine(String.raw`\text{Simplify and solve a multi-step expression}`)
          ],
          answer: [katexLine(String.raw`x=16`)],
          working: [
            textLine("Workings (very long):"),
            ...makeLongWorkingLines(60)
          ]
        };
      });

      return {
        id: "sectioned",
        title: "Sectioned paper",
        meta: "Section A: 35 • Section B: 8 • Section C: 6 (very long workings)",
        defaults: { workingsExpanded: false },
        sections: [
          { key: "A", label: "Section A", questions: secA },
          { key: "B", label: "Section B", questions: secB },
          { key: "C", label: "Section C", questions: secC }
        ],
        questions: null
      };
    }

    const DATASETS = [
      makeShortPaper(),
      makeStandardPaper(false),
      makeDiagramHeavyPaper(),
      makeSectionedPaper(),
      makeStandardPaper(true)
    ];

    /* -------------------------
       Rendering
       ------------------------- */

    const elPaper = document.getElementById("paper");
    const elSelect = document.getElementById("paperSelect");
    const elNavList = document.getElementById("navList");
    const elNavScroll = document.getElementById("navScroll");
    const elDrawerList = document.getElementById("drawerList");
    const elOverlay = document.getElementById("navOverlay");
    const elDrawerScroll = document.getElementById("drawerScroll");
    const elJumpBtn = document.getElementById("jumpBtn");
    const elCloseDrawer = document.getElementById("closeDrawer");

    function uidFor(item) { return item._domId; }

    function safeId(raw) {
      return raw.replace(/[^a-zA-Z0-9\-_]/g, "_");
    }

    function flattenQuestions(itemList, into, sectionKey) {
      for (const q of itemList) {
        const domId = safeId(`${sectionKey ? sectionKey + "-" : ""}${q.id}`);
        q._domId = domId;
        into.push({ q, sectionKey });
        if (q.children && q.children.length) {
          flattenQuestions(q.children, into, sectionKey);
        }
      }
    }

    function buildNavModel(dataset) {
      const items = [];
      if (dataset.sections) {
        for (const sec of dataset.sections) {
          flattenQuestions(sec.questions, items, sec.key);
        }
      } else {
        flattenQuestions(dataset.questions, items, null);
      }
      return items;
    }

    function renderInlineContent(container, parts) {
      for (const p of parts) {
        if (p.kind === "text") {
          const span = document.createElement("span");
          span.textContent = p.text;
          container.appendChild(span);
        } else if (p.kind === "katex") {
          const span = document.createElement("span");
          span.className = "math-inline";
          span.setAttribute("data-tex", p.tex);
          span.setAttribute("data-display", "false");
          span.textContent = `[KaTeX inline] ${p.tex}`; // fallback if KaTeX fails
          container.appendChild(span);
        }
      }
    }

    function renderBlockPart(parent, part) {
      if (part.kind === "text") {
        const p = document.createElement("p");
        p.style.margin = "0 0 8px 0";
        p.textContent = part.text;
        parent.appendChild(p);
      } else if (part.kind === "katex") {
        if (part.display) {
          const wrap = document.createElement("div");
          wrap.className = "math-block";
          const inner = document.createElement("div");
          inner.className = "math-block-inner";
          inner.setAttribute("data-tex", part.tex);
          inner.setAttribute("data-display", "true");
          inner.textContent = `[KaTeX block] ${part.tex}`; // fallback if KaTeX fails
          wrap.appendChild(inner);
          parent.appendChild(wrap);
        } else {
          const p = document.createElement("p");
          p.style.margin = "0 0 8px 0";
          renderInlineContent(p, [part]);
          parent.appendChild(p);
        }
      } else if (part.kind === "diagram") {
        parent.appendChild(renderDiagram(part.diagramKind));
      }
    }

    function renderDiagram(kind) {
      const wrap = document.createElement("div");
      wrap.className = "diagram";

      const svgNS = "http://www.w3.org/2000/svg";
      const svg = document.createElementNS(svgNS, "svg");
      svg.setAttribute("viewBox", "0 0 320 180");
      svg.setAttribute("role", "img");
      svg.setAttribute("aria-label", `Diagram placeholder: ${kind}`);

      const stroke = "#111";
      const hair = "#777";

      function line(x1, y1, x2, y2, w = 2) {
        const l = document.createElementNS(svgNS, "line");
        l.setAttribute("x1", x1); l.setAttribute("y1", y1);
        l.setAttribute("x2", x2); l.setAttribute("y2", y2);
        l.setAttribute("stroke", stroke);
        l.setAttribute("stroke-width", String(w));
        return l;
      }
      function thinLine(x1, y1, x2, y2) {
        const l = line(x1, y1, x2, y2, 1);
        l.setAttribute("stroke", hair);
        return l;
      }
      function text(x, y, t) {
        const tx = document.createElementNS(svgNS, "text");
        tx.setAttribute("x", x);
        tx.setAttribute("y", y);
        tx.setAttribute("fill", stroke);
        tx.setAttribute("font-size", "12");
        tx.textContent = t;
        return tx;
      }
      function rect(x, y, w, h, sw = 2) {
        const r = document.createElementNS(svgNS, "rect");
        r.setAttribute("x", x); r.setAttribute("y", y);
        r.setAttribute("width", w); r.setAttribute("height", h);
        r.setAttribute("fill", "none");
        r.setAttribute("stroke", stroke);
        r.setAttribute("stroke-width", String(sw));
        return r;
      }
      function circle(cx, cy, r) {
        const c = document.createElementNS(svgNS, "circle");
        c.setAttribute("cx", cx); c.setAttribute("cy", cy);
        c.setAttribute("r", r);
        c.setAttribute("fill", "none");
        c.setAttribute("stroke", stroke);
        c.setAttribute("stroke-width", "2");
        return c;
      }

      if (kind === "geometry") {
        // triangle + circle labels
        svg.appendChild(line(60, 140, 160, 40));
        svg.appendChild(line(160, 40, 260, 140));
        svg.appendChild(line(60, 140, 260, 140));
        svg.appendChild(circle(160, 110, 22));
        svg.appendChild(text(150, 28, "A"));
        svg.appendChild(text(42, 152, "B"));
        svg.appendChild(text(265, 152, "C"));
        svg.appendChild(text(188, 116, "r"));
      } else if (kind === "bars") {
        // ratio bars
        svg.appendChild(rect(40, 50, 240, 26, 2));
        svg.appendChild(thinLine(120, 50, 120, 76));
        svg.appendChild(thinLine(200, 50, 200, 76));
        svg.appendChild(text(40, 45, "Bar model"));
        svg.appendChild(text(78, 68, "1"));
        svg.appendChild(text(158, 68, "1"));
        svg.appendChild(text(238, 68, "1"));
        svg.appendChild(rect(40, 100, 180, 22, 2));
        svg.appendChild(thinLine(100, 100, 100, 122));
        svg.appendChild(thinLine(160, 100, 160, 122));
        svg.appendChild(text(40, 95, "Part"));
      } else if (kind === "grid") {
        // coordinate grid with points/line
        svg.appendChild(rect(40, 20, 240, 140, 1));
        for (let x = 60; x <= 260; x += 40) svg.appendChild(thinLine(x, 20, x, 160));
        for (let y = 40; y <= 140; y += 40) svg.appendChild(thinLine(40, y, 280, y));
        svg.appendChild(line(60, 140, 260, 40, 2));
        svg.appendChild(circle(100, 120, 4));
        svg.appendChild(circle(220, 60, 4));
        svg.appendChild(text(92, 115, "P"));
        svg.appendChild(text(226, 56, "Q"));
      } else if (kind === "table") {
        // table-like array
        svg.appendChild(rect(60, 40, 200, 110, 2));
        svg.appendChild(thinLine(60, 75, 260, 75));
        svg.appendChild(thinLine(60, 110, 260, 110));
        svg.appendChild(thinLine(126, 40, 126, 150));
        svg.appendChild(thinLine(193, 40, 193, 150));
        svg.appendChild(text(68, 32, "Grid"));
        svg.appendChild(text(78, 65, "A"));
        svg.appendChild(text(145, 65, "B"));
        svg.appendChild(text(212, 65, "C"));
      }

      wrap.appendChild(svg);

      const cap = document.createElement("div");
      cap.className = "caption";
      cap.textContent = "Diagram (placeholder)";
      wrap.appendChild(cap);

      return wrap;
    }

    function makeWorkingPreview(workingParts) {
      // Minimal preview: at most 1–2 lines (text or tex strings)
      const preview = [];
      for (const p of workingParts) {
        if (preview.length >= 2) break;
        if (p.kind === "text") {
          preview.push(p.text);
        } else if (p.kind === "katex") {
          preview.push(p.display ? "[KaTeX block]" : "[KaTeX inline]");
        }
      }
      return preview.join("  •  ") || "";
    }

    function renderQuestion(q, defaults) {
      const sec = document.createElement("section");
      sec.className = "q";
      sec.id = uidFor(q);
      sec.setAttribute("data-depth", String(q.depth || 0));

      const head = document.createElement("div");
      head.className = "q-head";

      const num = document.createElement("div");
      num.className = "q-num";
      num.textContent = q.label;

      const promptWrap = document.createElement("div");
      promptWrap.className = "q-prompt";
      // Question prompt always visible
      for (const p of q.prompt) {
        renderBlockPart(promptWrap, p);
      }

      head.appendChild(num);
      head.appendChild(promptWrap);
      sec.appendChild(head);

      // Answer (visible by default)
      const ans = document.createElement("div");
      ans.className = "answer";
      const al = document.createElement("span");
      al.className = "label";
      al.textContent = "Answer";
      ans.appendChild(al);

      const ansBody = document.createElement("span");
      if (Array.isArray(q.answer)) {
        // Render answer inline-ish; if blocks appear, keep them as blocks
        const hasBlock = q.answer.some(p => p.kind === "katex" && p.display);
        if (hasBlock) {
          const wrap = document.createElement("div");
          wrap.style.marginTop = "6px";
          for (const p of q.answer) {
            renderBlockPart(wrap, p);
          }
          ans.appendChild(wrap);
        } else {
          renderInlineContent(ansBody, q.answer);
          ans.appendChild(ansBody);
        }
      } else {
        ansBody.textContent = String(q.answer ?? "");
        ans.appendChild(ansBody);
      }
      sec.appendChild(ans);

      // Working (collapsed by default, except dataset variant)
      const working = document.createElement("div");
      working.className = "working";

      const expandedByDefault = !!defaults.workingsExpanded;
      working.setAttribute("data-state", expandedByDefault ? "expanded" : "collapsed");

      const row = document.createElement("div");
      row.className = "working-row";

      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "toggle-btn";
      btn.textContent = expandedByDefault ? "Hide working" : "Show working";
      btn.setAttribute("aria-expanded", expandedByDefault ? "true" : "false");
      btn.setAttribute("aria-controls", `wb-${uidFor(q)}`);

      const preview = document.createElement("div");
      preview.className = "working-preview";
      preview.textContent = makeWorkingPreview(q.working || []);
      preview.style.display = expandedByDefault ? "none" : "block";

      row.appendChild(btn);
      row.appendChild(preview);
      working.appendChild(row);

      const body = document.createElement("div");
      body.className = "working-body";
      body.id = `wb-${uidFor(q)}`;

      for (const p of (q.working || [])) {
        renderBlockPart(body, p);
      }

      working.appendChild(body);

      btn.addEventListener("click", () => {
        const isExpanded = working.getAttribute("data-state") === "expanded";
        working.setAttribute("data-state", isExpanded ? "collapsed" : "expanded");
        btn.textContent = isExpanded ? "Show working" : "Hide working";
        btn.setAttribute("aria-expanded", isExpanded ? "false" : "true");
        preview.style.display = isExpanded ? "block" : "none";
        // No scroll repositioning beyond natural layout shift
        requestKatexRender(working);
      });

      sec.appendChild(working);

      // Children (nested parts)
      if (q.children && q.children.length) {
        for (const child of q.children) {
          sec.appendChild(renderQuestion(child, defaults));
        }
      }

      return sec;
    }

    function renderPaper(dataset) {
      // Clear
      elPaper.innerHTML = "";
      elNavList.innerHTML = "";
      elDrawerList.innerHTML = "";

      // Meta
      const meta = document.createElement("p");
      meta.className = "paper-meta";
      meta.textContent = dataset.meta || "";
      elPaper.appendChild(meta);

      const defaults = dataset.defaults || { workingsExpanded: false };

      // Render questions (single continuous doc)
      if (dataset.sections) {
        for (const sec of dataset.sections) {
          // Plain-text section separator within content (original structure only)
          const h = document.createElement("p");
          h.style.margin = "0 0 12px 0";
          h.style.color = "var(--muted)";
          h.style.fontSize = "12px";
          h.textContent = sec.label;
          elPaper.appendChild(h);

          for (const q of sec.questions) {
            elPaper.appendChild(renderQuestion(q, defaults));
          }
        }
      } else {
        for (const q of dataset.questions) {
          elPaper.appendChild(renderQuestion(q, defaults));
        }
      }

      // Build navigation (question-number-only; section labels A/B/C as plain text separators)
      const navModel = buildNavModel(dataset);

      function addSectionSep(where, label) {
        const li = document.createElement("li");
        const sep = document.createElement("div");
        sep.className = "nav-sep";
        sep.textContent = label;
        li.appendChild(sep);
        where.appendChild(li);
      }

      let lastSection = null;
      for (const item of navModel) {
        const q = item.q;

        if (dataset.sections) {
          if (item.sectionKey !== lastSection) {
            lastSection = item.sectionKey;
            // Non-clickable plain-text separator
            const secLabel = dataset.sections.find(s => s.key === item.sectionKey)?.label || `Section ${item.sectionKey}`;
            addSectionSep(elNavList, secLabel);
            addSectionSep(elDrawerList, secLabel);
          }
        }

        const li1 = document.createElement("li");
        const btn1 = document.createElement("button");
        btn1.type = "button";
        btn1.className = "nav-item";
        btn1.textContent = q.label;
        btn1.setAttribute("data-level", String(q.depth || 0));
        btn1.addEventListener("click", () => jumpTo(q._domId));
        li1.appendChild(btn1);
        elNavList.appendChild(li1);

        const li2 = document.createElement("li");
        const btn2 = document.createElement("button");
        btn2.type = "button";
        btn2.className = "nav-item";
        btn2.textContent = q.label;
        btn2.setAttribute("data-level", String(q.depth || 0));
        btn2.addEventListener("click", () => {
          closeDrawer();
          jumpTo(q._domId);
        });
        li2.appendChild(btn2);
        elDrawerList.appendChild(li2);
      }

      // Initial KaTeX render pass (graceful fallback if KaTeX missing)
      requestKatexRender(elPaper);

      // Setup scroll spy (no progress semantics; only “where am I” highlight)
      setupScrollSpy(navModel);

      // Ensure nav scroll regions are keyboard-scrollable
      wireNavKeyboardScroll(elNavScroll);
      wireNavKeyboardScroll(elDrawerScroll);
    }

    function jumpTo(domId) {
      const el = document.getElementById(domId);
      if (!el) return;
      el.scrollIntoView({ behavior: "smooth", block: "start" });
      // Do NOT alter expanded/collapsed states (navigation is non-destructive)
    }

    function wireNavKeyboardScroll(container) {
      container.addEventListener("keydown", (e) => {
        const key = e.key;
        const amount = 40;
        if (key === "ArrowDown") { container.scrollTop += amount; e.preventDefault(); }
        if (key === "ArrowUp") { container.scrollTop -= amount; e.preventDefault(); }
        if (key === "PageDown") { container.scrollTop += container.clientHeight * 0.9; e.preventDefault(); }
        if (key === "PageUp") { container.scrollTop -= container.clientHeight * 0.9; e.preventDefault(); }
        if (key === "Home") { container.scrollTop = 0; e.preventDefault(); }
        if (key === "End") { container.scrollTop = container.scrollHeight; e.preventDefault(); }
      });
    }

    function requestKatexRender(root) {
      // Graceful fallback: if KaTeX not loaded, keep the placeholder text
      if (!window.katex || typeof window.katex.render !== "function") return;

      const inlineNodes = root.querySelectorAll('[data-tex][data-display="false"]');
      inlineNodes.forEach(node => {
        const tex = node.getAttribute("data-tex");
        try {
          window.katex.render(tex, node, { throwOnError: false, displayMode: false });
        } catch (_e) {
          // keep fallback text
        }
      });

      const blockNodes = root.querySelectorAll('[data-tex][data-display="true"]');
      blockNodes.forEach(node => {
        const tex = node.getAttribute("data-tex");
        try {
          window.katex.render(tex, node, { throwOnError: false, displayMode: true });
        } catch (_e) {
          // keep fallback text
        }
      });
    }

    function setupScrollSpy(navModel) {
      const idToButtons = new Map();
      const navButtons = elNavList.querySelectorAll(".nav-item");
      navButtons.forEach(btn => {
        const label = btn.textContent;
        // map by label is not safe; we’ll map by DOM position
      });

      // Build arrays for intersection tracking
      const targets = navModel.map(item => document.getElementById(item.q._domId)).filter(Boolean);

      const buttonsA = Array.from(elNavList.querySelectorAll(".nav-item"));
      const buttonsB = Array.from(elDrawerList.querySelectorAll(".nav-item"));

      function clearCurrent() {
        [...buttonsA, ...buttonsB].forEach(b => b.removeAttribute("aria-current"));
      }

      const obs = new IntersectionObserver((entries) => {
        // Choose the top-most visible question as "current"
        const visible = entries
          .filter(e => e.isIntersecting)
          .sort((a, b) => a.boundingClientRect.top - b.boundingClientRect.top);

        if (visible.length) {
          const id = visible[0].target.id;
          const idx = navModel.findIndex(item => item.q._domId === id);
          if (idx >= 0) {
            clearCurrent();
            if (buttonsA[idx]) buttonsA[idx].setAttribute("aria-current", "true");
            if (buttonsB[idx]) buttonsB[idx].setAttribute("aria-current", "true");
          }
        }
      }, { root: null, threshold: 0.01, rootMargin: "-15% 0px -75% 0px" });

      targets.forEach(t => obs.observe(t));
    }

    /* -------------------------
       Mobile drawer
       ------------------------- */

    function openDrawer() {
      elOverlay.setAttribute("aria-hidden", "false");
      // focus first item if present
      const first = elDrawerList.querySelector(".nav-item");
      (first || elCloseDrawer).focus();
    }
    function closeDrawer() {
      elOverlay.setAttribute("aria-hidden", "true");
      elJumpBtn.focus();
    }

    elJumpBtn.addEventListener("click", () => {
      // Only show drawer on small screens; on desktop, keep as quick focus to nav
      if (window.matchMedia("(max-width: 860px)").matches) {
        openDrawer();
      } else {
        elNavScroll.focus();
      }
    });
    elCloseDrawer.addEventListener("click", closeDrawer);
    elOverlay.addEventListener("click", (e) => {
      if (e.target === elOverlay) closeDrawer();
    });
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && elOverlay.getAttribute("aria-hidden") === "false") {
        closeDrawer();
      }
    });

    /* -------------------------
       Selector
       ------------------------- */

    function initSelector() {
      DATASETS.forEach((ds, idx) => {
        const opt = document.createElement("option");
        opt.value = ds.id;
        opt.textContent = ds.title;
        elSelect.appendChild(opt);
      });

      elSelect.addEventListener("change", () => {
        const ds = DATASETS.find(d => d.id === elSelect.value) || DATASETS[0];
        renderPaper(ds);
      });

      // Default to first dataset
      elSelect.value = DATASETS[0].id;
      renderPaper(DATASETS[0]);
    }

    initSelector();
  </script>
</body>

</html>