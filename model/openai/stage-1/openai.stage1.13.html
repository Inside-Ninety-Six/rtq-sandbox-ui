Updated to match v3.8 brief + Stage 2 refinement scope.

```html
<!-- index.html -->
<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>RTQ – Maths Paper Solution Viewer (Stress Test Harness)</title>

    <!-- KaTeX (CDN) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>

    <style>
        :root {
            --bg: #f7f7f7;
            --paper: #ffffff;
            --ink: #111111;
            --muted: #555555;
            --line: #e6e6e6;
            --line-strong: #cfcfcf;
            --focus: #000000;
            --radius: 10px;
            --gap: 16px;

            /* set by JS to avoid overlap with sticky topbar */
            --sticky-top: 56px;
        }

        * {
            box-sizing: border-box;
        }

        html,
        body {
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            /* main document must never scroll horizontally */
        }

        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
            color: var(--ink);
            background: var(--bg);
            line-height: 1.58;
            -webkit-text-size-adjust: 100%;
            text-size-adjust: 100%;
        }

        :focus-visible {
            outline: 3px solid var(--focus);
            outline-offset: 2px;
        }

        /* Top controls */
        .topbar {
            position: sticky;
            top: 0;
            z-index: 50;
            background: #efefef;
            border-bottom: 1px solid var(--line-strong);
            padding: 10px 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .topbar .left {
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 0;
            flex: 1 1 auto;
        }

        .topbar .title {
            font-weight: 950;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            min-width: 0;
        }

        .control {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 0 0 auto;
        }

        label {
            font-size: 12px;
            font-weight: 950;
            color: var(--muted);
            white-space: nowrap;
        }

        select {
            appearance: none;
            border: 1px solid var(--line-strong);
            background: #ffffff;
            color: var(--ink);
            border-radius: 10px;
            padding: 10px 12px;
            /* touch comfort */
            font-weight: 850;
            cursor: pointer;
            min-height: 44px;
            touch-action: manipulation;
        }

        .iconbtn {
            appearance: none;
            border: 1px solid var(--line-strong);
            background: #ffffff;
            color: var(--ink);
            border-radius: 10px;
            padding: 10px 12px;
            /* touch comfort */
            font-weight: 950;
            cursor: pointer;
            min-height: 44px;
            touch-action: manipulation;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .iconbtn:active {
            transform: translateY(1px);
        }

        /* App layout */
        .app {
            padding: 14px 12px 72px;
            max-width: 1250px;
            margin: 0 auto;
        }

        .layout {
            display: block;
        }

        /* Desktop nav rail: minimal, sticky, low chrome */
        .rail {
            display: none;
        }

        .rail h2 {
            margin: 0 0 10px;
            font-size: 12px;
            font-weight: 950;
            color: var(--muted);
            letter-spacing: 0.2px;
        }

        /* Scrollable nav (permitted only for nav when overflow); scrollbar hidden */
        .nav-scroll {
            max-height: calc(100vh - 92px);
            overflow-y: auto;
            overscroll-behavior: contain;
            padding-right: 2px;
            scrollbar-width: none;
            -ms-overflow-style: none;
            -webkit-overflow-scrolling: touch;
        }

        .nav-scroll::-webkit-scrollbar {
            display: none;
        }

        .nav-scroll:focus-visible {
            outline: 2px solid var(--focus);
            outline-offset: 4px;
        }

        .nav {
            list-style: none;
            padding: 0;
            margin: 0;
            display: grid;
            gap: 2px;
            /* touch comfort: rhythm via padding */
        }

        .nav li {
            margin: 0;
        }

        .nav a {
            display: block;
            padding: 10px 8px;
            /* touch comfort */
            border: none;
            background: transparent;
            border-radius: 0;
            text-decoration: none;
            color: var(--muted);
            font-weight: 950;
            font-size: 13px;
            line-height: 1.25;
            overflow-wrap: anywhere;
            word-break: break-word;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .nav a:hover {
            color: var(--ink);
            text-decoration: underline;
            text-decoration-thickness: 2px;
            text-underline-offset: 2px;
        }

        .nav a:focus-visible {
            outline: 2px solid var(--focus);
            outline-offset: 2px;
            text-decoration: none;
        }

        .nav-sep {
            padding: 10px 8px;
            font-weight: 950;
            font-size: 12px;
            color: var(--muted);
            letter-spacing: 0.3px;
            margin-top: 6px;
        }

        /* Paper container (paper-level, not per-question) */
        .paper {
            background: var(--paper);
            border: 1px solid var(--line-strong);
            border-radius: var(--radius);
            padding: 18px 18px 12px;
            overflow: visible;
            max-width: 100%;
        }

        .paper-header {
            padding-bottom: 12px;
            margin-bottom: 8px;
            border-bottom: 1px solid var(--line);
        }

        .paper-header h1 {
            margin: 0;
            font-size: 18px;
            font-weight: 1000;
        }

        .paper-header p {
            margin: 6px 0 0;
            color: var(--muted);
            font-size: 13px;
        }

        /* Section headings */
        .section {
            margin: 24px 0 0;
            padding: 14px 0 0;
            border-top: 1px solid var(--line);
        }

        .section h2 {
            margin: 0 0 12px;
            font-size: 16px;
            font-weight: 1000;
        }

        /* Questions: grouping via whitespace only */
        .q {
            margin: 24px 0 0;
            padding: 0;
        }

        .q+.q {
            margin-top: 36px;
            /* largest spacing unit */
        }

        .qhead {
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            gap: 10px;
            margin: 0 0 10px;
        }

        .qhead h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 1000;
        }

        .qmeta {
            color: var(--muted);
            font-size: 12px;
            white-space: nowrap;
            font-weight: 950;
        }

        /* Nesting: indentation only (reduced on mobile via media query) */
        .nest {
            margin-top: 16px;
            padding-left: 18px;
        }

        .nest.nest-2 {
            margin-top: 14px;
            padding-left: 36px;
        }

        .nest h4,
        .nest h5 {
            margin: 0 0 8px;
            font-weight: 1000;
        }

        .nest h4 {
            font-size: 14px;
        }

        .nest h5 {
            font-size: 13px;
        }

        /* Blocks (no cards/panels) */
        .block {
            margin: 8px 0 0;
            padding: 0;
            border: none;
            background: transparent;
            max-width: 100%;
        }

        .block-title {
            margin: 0 0 6px;
            font-weight: 1000;
            font-size: 13px;
            letter-spacing: 0.2px;
        }

        .block p {
            margin: 0 0 8px;
            overflow-wrap: anywhere;
            word-break: break-word;
        }

        .block p:last-child {
            margin-bottom: 0;
        }

        /* Answer before Working, but secondary to question */
        .answer {
            margin-top: 10px;
            padding: 0;
            background: transparent;
        }

        /* Working: subordinate */
        .working {
            margin-top: 10px;
            padding: 0 0 0 12px;
            background: transparent;
            border-left: 2px solid var(--line);
        }

        .toggle-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin: 0 0 6px;
        }

        .toggle-row .block-title {
            margin: 0;
        }

        /* Stage 2: keep collapse control within reach while reading long workings (no animation) */
        .working .toggle-row {
            position: sticky;
            top: var(--sticky-top);
            z-index: 5;
            background: var(--paper);
            padding: 6px 0;
        }

        .toggle {
            appearance: none;
            border: 1px solid var(--line-strong);
            background: #ffffff;
            color: var(--ink);
            border-radius: 999px;
            padding: 10px 14px;
            /* touch comfort */
            font-weight: 950;
            cursor: pointer;
            flex: 0 0 auto;
            min-height: 44px;
            touch-action: manipulation;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .working-content[hidden] {
            display: none;
        }

        .working-preview {
            color: var(--muted);
            font-size: 12px;
            line-height: 1.45;
            margin: 0;
            /* minimal preview: 1 line */
        }

        /* Block-math scrolling wrapper: only place overflow-x:auto is applied */
        .mathscroll {
            display: block;
            max-width: 100%;
            overflow-x: auto;
            overflow-y: hidden;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
            scrollbar-width: none;
            -ms-overflow-style: none;
            touch-action: pan-y;
            /* keep vertical scroll dominant */
        }

        .mathscroll::-webkit-scrollbar {
            display: none;
        }

        .mathscroll:focus-visible {
            outline: 2px solid var(--focus);
            outline-offset: 3px;
        }

        .mathblock,
        .mathrow {
            display: inline-block;
            /* enables horizontal scroll when wider than container */
            margin: 6px 0 0;
            padding: 0;
            border: none;
            background: transparent;
            line-height: 1.55;
        }

        .mathrow {
            margin: 0;
        }

        .mathblock.plain,
        .mathrow.plain {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
            font-size: 13px;
            white-space: nowrap;
        }

        /* Working stack: continuous lines */
        .mathstack {
            display: grid;
            gap: 6px;
            margin-top: 8px;
        }

        /* Plain text lines inside workings (tier labels) */
        .worktext {
            margin: 0;
            padding: 0;
            font-size: 13px;
            color: var(--ink);
            overflow-wrap: anywhere;
            word-break: break-word;
        }

        /* Diagrams: responsive, no scroll trapping */
        .diagram {
            margin: 10px 0 0;
            padding: 0;
            background: transparent;
            border: none;
        }

        .diagram svg {
            width: 100%;
            height: auto;
            display: block;
            pointer-events: none;
            /* prevent diagram from trapping touch/scroll */
        }

        /* Mobile/Tablet drawer */
        .drawer-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.35);
            z-index: 80;
            display: none;
        }

        .drawer-backdrop.open {
            display: block;
        }

        .drawer {
            position: fixed;
            top: 0;
            left: 0;
            width: min(360px, 92vw);
            height: 100%;
            background: #ffffff;
            border-right: 1px solid var(--line-strong);
            padding: 12px;
            overflow: hidden;
            /* drawer itself does not scroll */
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        .drawer h2 {
            margin: 0;
            font-size: 12px;
            font-weight: 950;
            color: var(--muted);
            letter-spacing: 0.2px;
        }

        .drawer .row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            margin: 6px 0 10px;
            flex: 0 0 auto;
        }

        .drawer .close {
            appearance: none;
            border: 1px solid var(--line-strong);
            background: #ffffff;
            border-radius: 10px;
            padding: 10px 12px;
            /* touch comfort */
            font-weight: 950;
            cursor: pointer;
            min-height: 44px;
            touch-action: manipulation;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .drawer nav.nav-scroll {
            max-height: none;
            flex: 1 1 auto;
            min-height: 0;
        }

        /* Desktop layout */
        @media (min-width: 900px) {
            .layout {
                display: grid;
                grid-template-columns: 240px 1fr;
                gap: var(--gap);
                align-items: start;
            }

            .rail {
                display: block;
                position: sticky;
                top: 58px;
                align-self: start;
            }

            .drawer-backdrop {
                display: none !important;
            }

            #navToggle {
                display: none;
            }
        }

        /* Mobile ergonomics refinement */
        @media (max-width: 480px) {
            .paper {
                padding: 16px 14px 10px;
            }

            .qhead {
                gap: 8px;
            }

            .qmeta {
                font-size: 11px;
            }

            .nest {
                padding-left: 12px;
            }

            .nest.nest-2 {
                padding-left: 22px;
            }

            .toggle-row {
                align-items: flex-start;
            }

            .toggle {
                padding: 12px 14px;
            }

            .nav a {
                padding: 12px 10px;
            }
        }
    </style>
</head>

<body>
    <header class="topbar" aria-label="Top controls">
        <div class="left">
            <button class="iconbtn" id="navToggle" type="button" aria-haspopup="dialog" aria-controls="drawerBackdrop"
                aria-expanded="false">
                Jump to
            </button>
            <div class="title">RTQ – Maths Paper (Continuous Scroll)</div>
        </div>

        <div class="control" aria-label="Paper selector control">
            <label for="paperSelect">Paper</label>
            <select id="paperSelect">
                <option value="short">Short paper</option>
                <option value="standard">Standard paper</option>
                <option value="standardExpanded">Standard (Workings Expanded)</option>
                <option value="diagram">Diagram-heavy paper</option>
                <option value="sectioned">Sectioned paper</option>
            </select>
        </div>
    </header>

    <!-- Drawer (tablet/mobile) -->
    <div class="drawer-backdrop" id="drawerBackdrop" aria-hidden="true">
        <div class="drawer" role="dialog" aria-modal="true" aria-label="Navigation">
            <div class="row">
                <h2>Navigation</h2>
                <button class="close" id="drawerClose" type="button">Close</button>
            </div>
            <nav class="nav-scroll" id="navDrawer" aria-label="Questions (drawer)" tabindex="0">
                <ul class="nav" id="navListDrawer"></ul>
            </nav>
        </div>
    </div>

    <main class="app">
        <div class="layout">
            <!-- Desktop rail -->
            <aside class="rail" aria-label="Question navigation (rail)">
                <h2>Navigation</h2>
                <nav class="nav-scroll" id="navRail" aria-label="Questions (rail)" tabindex="0">
                    <ul class="nav" id="navListRail"></ul>
                </nav>
            </aside>

            <!-- Paper -->
            <section class="paper" aria-label="Paper content">
                <div class="paper-header">
                    <h1 id="paperTitle">RTQ – Maths Paper</h1>
                    <p id="paperSubtitle">Answers visible by default. Workings collapsed by default. Questions are
                        always visible.</p>
                </div>
                <div id="paperRoot"></div>
            </section>
        </div>
    </main>

    <script>
        (function () {
            function setStickyTop() {
                const topbar = document.querySelector(".topbar");
                const h = topbar ? Math.round(topbar.getBoundingClientRect().height) : 0;
                document.documentElement.style.setProperty("--sticky-top", (h + 6) + "px");
            }
            setStickyTop();
            window.addEventListener("resize", setStickyTop);

            // ------------------ Diagrams (reused SVG types) ------------------
            function svgGeometry() {
                return `
          <div class="diagram" aria-label="Diagram (geometry)">
            <svg viewBox="0 0 320 180" role="img" aria-label="Geometry diagram">
              <rect x="1" y="1" width="318" height="178" fill="#fff" stroke="#cfcfcf" />
              <polygon points="70,140 160,40 250,140" fill="#f2f2f2" stroke="#444" stroke-width="2"/>
              <circle cx="160" cy="40" r="4" fill="#444"/>
              <circle cx="70" cy="140" r="4" fill="#444"/>
              <circle cx="250" cy="140" r="4" fill="#444"/>
              <text x="155" y="28" font-size="12" fill="#111">A</text>
              <text x="54" y="156" font-size="12" fill="#111">B</text>
              <text x="258" y="156" font-size="12" fill="#111">C</text>
              <text x="18" y="22" font-size="12" fill="#111">[labels]</text>
            </svg>
          </div>`;
            }
            function svgBars() {
                return `
          <div class="diagram" aria-label="Diagram (ratio bars)">
            <svg viewBox="0 0 320 180" role="img" aria-label="Ratio bars diagram">
              <rect x="1" y="1" width="318" height="178" fill="#fff" stroke="#cfcfcf" />
              <text x="14" y="22" font-size="12" fill="#111">Ratio bars</text>
              <rect x="20" y="45" width="260" height="22" fill="#f2f2f2" stroke="#444"/>
              <g stroke="#444" stroke-width="2">
                <line x1="20" y1="45" x2="20" y2="67"/>
                <line x1="85" y1="45" x2="85" y2="67"/>
                <line x1="150" y1="45" x2="150" y2="67"/>
                <line x1="215" y1="45" x2="215" y2="67"/>
                <line x1="280" y1="45" x2="280" y2="67"/>
              </g>
              <text x="22" y="92" font-size="12" fill="#111">A</text>
              <text x="22" y="124" font-size="12" fill="#111">B</text>
              <rect x="20" y="100" width="180" height="22" fill="#eaeaea" stroke="#444"/>
              <rect x="20" y="132" width="240" height="22" fill="#f0f0f0" stroke="#444"/>
              <text x="200" y="114" font-size="12" fill="#111">[labels]</text>
            </svg>
          </div>`;
            }
            function svgGrid() {
                return `
          <div class="diagram" aria-label="Diagram (coordinate grid)">
            <svg viewBox="0 0 320 180" role="img" aria-label="Coordinate grid diagram">
              <rect x="1" y="1" width="318" height="178" fill="#fff" stroke="#cfcfcf" />
              <g stroke="#dddddd">
                ${Array.from({ length: 15 }).map((_, i) => `<line x1="${20 + i * 20}" y1="20" x2="${20 + i * 20}" y2="160"/>`).join("")}
                ${Array.from({ length: 8 }).map((_, i) => `<line x1="20" y1="${20 + i * 20}" x2="300" y2="${20 + i * 20}"/>`).join("")}
              </g>
              <g stroke="#444" stroke-width="2">
                <line x1="20" y1="160" x2="300" y2="160"/>
                <line x1="20" y1="20" x2="20" y2="160"/>
              </g>
              <polyline points="40,140 120,100 200,80 280,40" fill="none" stroke="#444" stroke-width="2"/>
              <circle cx="120" cy="100" r="4" fill="#444"/>
              <circle cx="200" cy="80" r="4" fill="#444"/>
              <text x="205" y="72" font-size="12" fill="#111">P</text>
              <text x="24" y="18" font-size="12" fill="#111">[labels]</text>
            </svg>
          </div>`;
            }
            function svgArray() {
                return `
          <div class="diagram" aria-label="Diagram (array)">
            <svg viewBox="0 0 320 180" role="img" aria-label="Array diagram">
              <rect x="1" y="1" width="318" height="178" fill="#fff" stroke="#cfcfcf" />
              <text x="14" y="22" font-size="12" fill="#111">Grid / array</text>
              <g stroke="#444" fill="#f2f2f2">
                ${Array.from({ length: 4 }).map((_, r) =>
                    Array.from({ length: 6 }).map((_, c) => {
                        const x = 30 + c * 40, y = 40 + r * 30;
                        return `<rect x="${x}" y="${y}" width="36" height="26"/>`;
                    }).join("")
                ).join("")}
              </g>
              <text x="30" y="160" font-size="12" fill="#111">[labels]</text>
            </svg>
          </div>`;
            }
            const diagramTypes = { geometry: svgGeometry, bars: svgBars, grid: svgGrid, array: svgArray };

            // ------------------ DOM helpers ------------------
            function el(tag, attrs, children) {
                const node = document.createElement(tag);
                if (attrs) {
                    Object.keys(attrs).forEach(k => {
                        if (k === "class") node.className = attrs[k];
                        else if (k === "html") node.innerHTML = attrs[k];
                        else if (k.startsWith("aria-")) node.setAttribute(k, attrs[k]);
                        else node.setAttribute(k, attrs[k]);
                    });
                }
                (children || []).forEach(ch => {
                    if (typeof ch === "string") node.appendChild(document.createTextNode(ch));
                    else if (ch) node.appendChild(ch);
                });
                return node;
            }

            function katexInline(tex) {
                const inner = el("span", { class: "js-katex", "data-tex": tex, "data-display": "false" }, []);
                return inner.outerHTML;
            }

            function katexBlock(tex) {
                const target = el("div", { class: "mathblock js-katex", "data-tex": tex, "data-display": "true" }, []);
                const wrap = el("div", { class: "mathscroll", tabindex: "0", "aria-label": "Scrollable math" }, [target]);
                return wrap.outerHTML;
            }

            function makeQuestionBlock(questionHtml, diagramKey) {
                const parts = [`<p class="block-title">Question</p>${questionHtml}`];
                if (diagramKey && diagramTypes[diagramKey]) parts.push(diagramTypes[diagramKey]());
                return el("div", { class: "block question", html: parts.join("") }, []);
            }

            function makeAnswerBlock(answerTex) {
                return el("div", { class: "block answer", html: `<p class="block-title">Answer</p>${katexBlock(answerTex)}` }, []);
            }

            function makeWorkingBlock(qid, lines) {
                const working = el("div", { class: "block working" }, []);
                const toggleRow = el("div", { class: "toggle-row" }, [
                    el("p", { class: "block-title" }, ["Working"]),
                    el("button", {
                        class: "toggle js-working-toggle",
                        type: "button",
                        "aria-expanded": "false",
                        "data-target": qid + "-working"
                    }, ["Show working"])
                ]);

                const preview = el("p", { class: "working-preview" }, ["Working is hidden."]);
                const content = el("div", { class: "working-content", id: qid + "-working" }, []);
                content.hidden = true;

                const stack = el("div", {
                    class: "mathstack js-katex-stack",
                    "data-lines": JSON.stringify(lines || [])
                }, []);
                content.appendChild(stack);

                working.appendChild(toggleRow);
                working.appendChild(preview);
                working.appendChild(content);
                return working;
            }

            function renderNode(node, depth) {
                const wrapperTag = depth === 0 ? "article" : "section";
                const wrapperClass = depth === 0 ? "q" : ("nest nest-" + depth);
                const wrapper = el(wrapperTag, { class: wrapperClass, id: node.id, "aria-label": node.label }, []);

                if (depth === 0) {
                    wrapper.appendChild(el("div", { class: "qhead" }, [
                        el("h3", {}, [node.label]),
                        el("div", { class: "qmeta" }, [node.meta || node.label])
                    ]));
                } else {
                    const hTag = depth === 1 ? "h4" : "h5";
                    wrapper.appendChild(el(hTag, {}, [node.label]));
                }

                wrapper.appendChild(makeQuestionBlock(node.questionHtml || "<p>(No prompt.)</p>", node.diagram || null));
                wrapper.appendChild(makeAnswerBlock(node.answerTex || "\\text{(answer)}"));
                wrapper.appendChild(makeWorkingBlock(node.id, node.workingLines || [{ type: "math", tex: "\\text{(working)}" }]));

                if (node.children && node.children.length) {
                    node.children.forEach(ch => wrapper.appendChild(renderNode(ch, depth + 1)));
                }
                return wrapper;
            }

            // ------------------ Long working generator (50–60 lines) ------------------
            function longAlgebraLines(seed, count) {
                const a = 2 + (seed % 5);
                const b = 3 + (seed % 7);
                const c = 1 + (seed % 4);
                const d = 4 + (seed % 6);

                const lines = [];
                function push(tex) { lines.push({ type: "math", tex }); }

                push(`\\text{Start: } (${a}x+${b})(x+${c})-${d}`);
                push(`= ${a}x\\cdot x + ${a}x\\cdot ${c} + ${b}\\cdot x + ${b}\\cdot ${c} - ${d}`);
                push(`= ${a}x^{2} + ${a * c}x + ${b}x + ${b * c} - ${d}`);
                push(`= ${a}x^{2} + ${(a * c + b)}x + ${(b * c - d)}`);
                push(`\\text{Complete the square:}`);
                push(`= ${a}\\left(x^{2} + \\frac{${(a * c + b)}}{${a}}x\\right) + ${(b * c - d)}`);
                push(`= ${a}\\left(x^{2} + \\frac{${(a * c + b)}}{${a}}x + \\left(\\frac{${(a * c + b)}}{${2 * a}}\\right)^{2}\\right) + ${(b * c - d)} - ${a}\\left(\\frac{${(a * c + b)}}{${2 * a}}\\right)^{2}`);
                push(`= ${a}\\left(x + \\frac{${(a * c + b)}}{${2 * a}}\\right)^{2} + ${(b * c - d)} - \\frac{${(a * c + b) * (a * c + b)}}{${4 * a}}`);

                const base = (a * c + b);
                const target = Math.max(50, Math.min(60, count || 55));

                for (let i = 1; lines.length < target; i++) {
                    const k = i + 1;
                    const p = base + (i % 9);
                    const q = (b * c - d) - (i % 7);

                    if (i % 6 === 0) {
                        push(`\\text{Factor check: } ${a}x^{2} + ${p}x + ${q}`);
                    } else if (i % 6 === 1) {
                        push(`\\text{Substitute } x=${k}:\\quad ${a}(${k})^{2} + ${p}(${k}) + ${q}`);
                    } else if (i % 6 === 2) {
                        push(`= ${a * k * k} + ${p * k} + ${q}`);
                    } else if (i % 6 === 3) {
                        push(`= ${(a * k * k + p * k + q)}`);
                    } else if (i % 6 === 4) {
                        push(`\\text{Rewrite: } ${a}x^{2} + ${p}x + ${q} = ${a}\\left(x + \\frac{${p}}{${2 * a}}\\right)^{2} + \\left(${q} - \\frac{${p * p}}{${4 * a}}\\right)`);
                    } else {
                        push(`\\text{Simplify terms.}`);
                    }
                }

                return lines.slice(0, target);
            }

            // ------------------ Overflow tiers (display math only; in Working) ------------------
            const overflowTiers = {
                M: [
                    { label: "Tier M (Mobile overflow) — display math", tex: "\\frac{(x+1)(x+2)(x+3)(x+4)(x+5)(x+6)}{(x-1)(x-2)(x-3)(x-4)}" },
                    { label: "Tier M (Mobile overflow) — display math", tex: "\\left(\\frac{p^{4}q^{3}r^{2}s}{t^{3}u^{2}v}\\right)\\cdot\\left(\\frac{(p+q+r+s)^{5}}{(t+u+v)^{4}}\\right)" }
                ],
                T: [
                    { label: "Tier T (Tablet overflow) — display math", tex: "\\left(\\frac{1}{1+\\frac{1}{1+\\frac{1}{1+\\frac{1}{1+\\frac{1}{1+x}}}}}\\right)^{8}" },
                    { label: "Tier T (Tablet overflow) — matrix-like (display math)", tex: "\\begin{bmatrix} 1 & 2 & 3 & 4 & 5 & 6 & 7 & 8 \\\\ 9 & 10 & 11 & 12 & 13 & 14 & 15 & 16 \\\\ 17 & 18 & 19 & 20 & 21 & 22 & 23 & 24 \\end{bmatrix}" },
                    { label: "Tier T (Tablet overflow) — array/alignment (display math)", tex: "\\begin{array}{rcl} \\frac{3x^{9}-5x^{8}+7x^{7}-11x^{6}+13x^{5}-17x^{4}+19x^{3}-23x^{2}+29x-31}{x^{4}-2x^{3}+3x^{2}-4x+5} &=& \\frac{3x^{9}-5x^{8}+\\cdots-31}{x^{4}-2x^{3}+3x^{2}-4x+5} \\end{array}" }
                ],
                D: [
                    { label: "Tier D (Desktop overflow) — display math", tex: "x^{30}-2x^{29}+3x^{28}-4x^{27}+5x^{26}-6x^{25}+7x^{24}-8x^{23}+9x^{22}-10x^{21}+11x^{20}-12x^{19}+13x^{18}-14x^{17}+15x^{16}-16x^{15}+17x^{14}-18x^{13}+19x^{12}-20x^{11}+21x^{10}-22x^{9}+23x^{8}-24x^{7}+25x^{6}-26x^{5}+27x^{4}-28x^{3}+29x^{2}-30x+31" },
                    { label: "Tier D (Desktop overflow) — aligned (display math)", tex: "\\begin{aligned} y &= \\frac{(x+1)(x+2)(x+3)(x+4)(x+5)(x+6)(x+7)(x+8)}{(x-1)(x-2)(x-3)(x-4)} \\\\ &\\quad + \\frac{(2x^{7}-3x^{6}+5x^{5}-7x^{4}+11x^{3}-13x^{2}+17x-19)}{(x^{4}-2x^{3}+3x^{2}-4x+5)} \\end{aligned}" }
                ]
            };

            function tierLine(label, tex) {
                return [
                    { type: "text", text: label },
                    { type: "math", tex: tex }
                ];
            }

            // ------------------ Datasets ------------------
            function buildShortPaper() {
                const nav = [];
                const nodes = [];

                nodes.push(renderNode({
                    id: "short-q1",
                    label: "Question 1",
                    meta: "1",
                    questionHtml: `<p>A toy costs £3. How much do 4 toys cost?</p>`,
                    answerTex: `12`,
                    workingLines: [{ type: "math", tex: `4\\times 3` }, { type: "math", tex: `=12` }]
                }, 0));
                nav.push({ type: "link", text: "1", href: "#short-q1" });

                nodes.push(renderNode({
                    id: "short-q2",
                    label: "Question 2",
                    meta: "2",
                    questionHtml: `<p>Write the next two numbers in the sequence:</p>${katexBlock("5,10,15,20,\\_,\\_")}`,
                    answerTex: `25,\\;30`,
                    workingLines: [{ type: "math", tex: `20+5=25` }, { type: "math", tex: `25+5=30` }]
                }, 0));
                nav.push({ type: "link", text: "2", href: "#short-q2" });

                nodes.push(renderNode({
                    id: "short-q3",
                    label: "Question 3",
                    meta: "3",
                    questionHtml: `<p>Work with the expression ${katexInline("2x+6")} and keep the question visible while you check parts.</p>`,
                    answerTex: `\\text{See parts}`,
                    workingLines: [{ type: "math", tex: `\\text{Parts (a) and (b) follow.}` }],
                    children: [
                        {
                            id: "short-q3a",
                            label: "Sub-question 3(a)",
                            questionHtml: `<p>Evaluate when ${katexInline("x=4")}.</p>`,
                            answerTex: `14`,
                            workingLines: [{ type: "math", tex: `2(4)+6` }, { type: "math", tex: `=8+6` }, { type: "math", tex: `=14` }],
                            children: [
                                {
                                    id: "short-q3ai",
                                    label: "Sub-sub-question 3(a)(i)",
                                    questionHtml: `<p>Show substitution step.</p>`,
                                    answerTex: `2(4)+6`,
                                    workingLines: [{ type: "math", tex: `2x+6` }, { type: "math", tex: `\\Rightarrow 2(4)+6` }]
                                },
                                {
                                    id: "short-q3aii",
                                    label: "Sub-sub-question 3(a)(ii)",
                                    questionHtml: `<p>Finish the arithmetic.</p>`,
                                    answerTex: `14`,
                                    workingLines: [{ type: "math", tex: `2(4)+6=8+6` }, { type: "math", tex: `8+6=14` }]
                                }
                            ]
                        },
                        {
                            id: "short-q3b",
                            label: "Sub-question 3(b)",
                            questionHtml: `<p>Simplify ${katexInline("3x+2x+6")}.</p>`,
                            answerTex: `5x+6`,
                            workingLines: [{ type: "math", tex: `3x+2x=5x` }, { type: "math", tex: `\\Rightarrow 5x+6` }]
                        }
                    ]
                }, 0));
                nav.push({ type: "link", text: "3", href: "#short-q3" });
                nav.push({ type: "link", text: "3a", href: "#short-q3a" });
                nav.push({ type: "link", text: "3ai", href: "#short-q3ai" });
                nav.push({ type: "link", text: "3aii", href: "#short-q3aii" });
                nav.push({ type: "link", text: "3b", href: "#short-q3b" });

                for (let i = 4; i <= 6; i++) {
                    const id = "short-q" + i;
                    nodes.push(renderNode({
                        id,
                        label: "Question " + i,
                        meta: String(i),
                        questionHtml: `<p>Short arithmetic prompt with ${katexInline("n=4")}.</p>`,
                        answerTex: `${(i + 2) * 4}`,
                        workingLines: [{ type: "math", tex: `( ${i + 2} )\\times 4` }, { type: "math", tex: `=${(i + 2) * 4}` }]
                    }, 0));
                    nav.push({ type: "link", text: String(i), href: "#" + id });
                }

                return {
                    id: "short",
                    title: "Short paper",
                    subtitle: "6 questions total (includes deep nesting at Q3(a)(i)/(ii)).",
                    navItems: nav,
                    nodes,
                    defaultWorkingsExpanded: false
                };
            }

            function buildStandardPaper(expandedDefault) {
                const nav = [];
                const nodes = [];

                for (let i = 1; i <= 35; i++) {
                    const id = "std-q" + i;

                    if (i === 18) {
                        nodes.push(renderNode({
                            id,
                            label: "Question 18",
                            meta: "18",
                            questionHtml: `<p>Work through the parts below.</p>`,
                            answerTex: `\\text{See parts}`,
                            workingLines: [{ type: "math", tex: `\\text{Parts (a) and (b) follow.}` }],
                            children: [
                                {
                                    id: "std-q18a",
                                    label: "Sub-question 18(a)",
                                    questionHtml: `<p>Simplify ${katexInline("(x+2)(x-2)")}.</p>`,
                                    answerTex: `x^{2}-4`,
                                    workingLines: [{ type: "math", tex: `(x+2)(x-2)` }, { type: "math", tex: `=x^{2}-4` }],
                                    children: [
                                        {
                                            id: "std-q18ai",
                                            label: "Sub-sub-question 18(a)(i)",
                                            questionHtml: `<p>Expand step.</p>`,
                                            answerTex: `x^{2}-2x+2x-4`,
                                            workingLines: [{ type: "math", tex: `(x+2)(x-2)` }, { type: "math", tex: `=x(x-2)+2(x-2)` }, { type: "math", tex: `=x^{2}-2x+2x-4` }]
                                        },
                                        {
                                            id: "std-q18aii",
                                            label: "Sub-sub-question 18(a)(ii)",
                                            questionHtml: `<p>Collect like terms.</p>`,
                                            answerTex: `x^{2}-4`,
                                            workingLines: [{ type: "math", tex: `x^{2}-2x+2x-4` }, { type: "math", tex: `=x^{2}-4` }]
                                        }
                                    ]
                                },
                                {
                                    id: "std-q18b",
                                    label: "Sub-question 18(b)",
                                    questionHtml: `<p>Evaluate at ${katexInline("x=3")}.</p>`,
                                    answerTex: `5`,
                                    workingLines: [{ type: "math", tex: `x^{2}-4` }, { type: "math", tex: `=3^{2}-4` }, { type: "math", tex: `=9-4=5` }]
                                }
                            ]
                        }, 0));
                        nav.push({ type: "link", text: "18", href: "#std-q18" });
                        nav.push({ type: "link", text: "18a", href: "#std-q18a" });
                        nav.push({ type: "link", text: "18ai", href: "#std-q18ai" });
                        nav.push({ type: "link", text: "18aii", href: "#std-q18aii" });
                        nav.push({ type: "link", text: "18b", href: "#std-q18b" });
                        continue;
                    }

                    if (i === 30) {
                        const longWithTiers = []
                            .concat(tierLine(overflowTiers.D[0].label, overflowTiers.D[0].tex))
                            .concat(tierLine(overflowTiers.D[1].label, overflowTiers.D[1].tex))
                            .concat(longAlgebraLines(301, 55));

                        nodes.push(renderNode({
                            id,
                            label: "Question 30",
                            meta: "30",
                            questionHtml: `<p>Answer the parts below. One sub-sub-question includes an extremely long working and Tier D overflow cases.</p>`,
                            answerTex: `\\text{See parts}`,
                            workingLines: [{ type: "math", tex: `\\text{Parts (a) and (b) follow.}` }],
                            children: [
                                {
                                    id: "std-q30a",
                                    label: "Sub-question 30(a)",
                                    questionHtml: `<p>Consider ${katexInline("(3x+5)(x+2)-4")}.</p>`,
                                    answerTex: `\\text{See sub-parts}`,
                                    workingLines: [{ type: "math", tex: `\\text{Sub-parts (i) and (ii) follow.}` }],
                                    children: [
                                        {
                                            id: "std-q30ai",
                                            label: "Sub-sub-question 30(a)(i)",
                                            questionHtml: `<p>Simplify fully (long working).</p>`,
                                            answerTex: `3x^{2}+11x+6`,
                                            workingLines: longWithTiers
                                        },
                                        {
                                            id: "std-q30aii",
                                            label: "Sub-sub-question 30(a)(ii)",
                                            questionHtml: `<p>Evaluate at ${katexInline("x=1")}.</p>`,
                                            answerTex: `20`,
                                            workingLines: [{ type: "math", tex: `3(1)^{2}+11(1)+6` }, { type: "math", tex: `=3+11+6=20` }]
                                        }
                                    ]
                                },
                                {
                                    id: "std-q30b",
                                    label: "Sub-question 30(b)",
                                    questionHtml: `<p>State the degree of ${katexInline("3x^{2}+11x+6")}.</p>`,
                                    answerTex: `2`,
                                    workingLines: [{ type: "math", tex: `\\text{Highest power of }x\\text{ is }2` }]
                                }
                            ]
                        }, 0));
                        nav.push({ type: "link", text: "30", href: "#std-q30" });
                        nav.push({ type: "link", text: "30a", href: "#std-q30a" });
                        nav.push({ type: "link", text: "30ai", href: "#std-q30ai" });
                        nav.push({ type: "link", text: "30aii", href: "#std-q30aii" });
                        nav.push({ type: "link", text: "30b", href: "#std-q30b" });
                        continue;
                    }

                    const isLong = i >= 26 && i <= 35;

                    const questionHtml = isLong
                        ? `<p>Long algebra prompt:</p>${katexBlock("(2x+3)(x+4)-5")}${katexBlock("\\text{Simplify}")}`
                        : `<p>Standard prompt with ${katexInline("x")}.</p>${katexBlock("\\text{(prompt placeholder)}")}`;

                    let workingLines;
                    if (isLong) {
                        workingLines = longAlgebraLines(i, 55);

                        if (i === 26) workingLines = [].concat(tierLine(overflowTiers.M[0].label, overflowTiers.M[0].tex)).concat(workingLines);
                        if (i === 27) workingLines = [].concat(tierLine(overflowTiers.M[1].label, overflowTiers.M[1].tex)).concat(workingLines);
                        if (i === 28) workingLines = [].concat(tierLine(overflowTiers.T[0].label, overflowTiers.T[0].tex)).concat(workingLines);
                        if (i === 29) {
                            workingLines = []
                                .concat(tierLine(overflowTiers.T[1].label, overflowTiers.T[1].tex))
                                .concat(tierLine(overflowTiers.T[2].label, overflowTiers.T[2].tex))
                                .concat(workingLines);
                        }
                    } else {
                        workingLines = [
                            { type: "math", tex: `\\text{Step 1: } x+${(i % 7) + 1}` },
                            { type: "math", tex: `\\text{Step 2: } (x+${(i % 7) + 1})+${(i % 5) + 2}` },
                            { type: "math", tex: `\\text{Result: } x+${(i % 7) + 1 + (i % 5) + 2}` }
                        ];
                    }

                    nodes.push(renderNode({
                        id,
                        label: "Question " + i,
                        meta: String(i),
                        questionHtml,
                        answerTex: isLong ? `\\text{(short final form)}` : `\\text{(short answer)}`,
                        workingLines
                    }, 0));
                    nav.push({ type: "link", text: String(i), href: "#" + id });
                }

                return {
                    id: expandedDefault ? "standardExpanded" : "standard",
                    title: expandedDefault ? "Standard (Workings Expanded)" : "Standard paper",
                    subtitle: expandedDefault
                        ? "35 questions total. Q26–Q35 contain long algebra questions. In this dataset only: ALL workings start expanded by default."
                        : "35 questions total. Q26–Q35 contain long algebra questions (workings collapsed by default).",
                    navItems: nav,
                    nodes,
                    defaultWorkingsExpanded: !!expandedDefault
                };
            }

            function buildDiagramPaper() {
                const nav = [];
                const nodes = [];
                const diagramQs = new Set([2, 4, 6, 9, 12, 14, 17, 20]);
                const diagramCycle = ["geometry", "bars", "grid", "array"];
                let dIdx = 0;

                for (let i = 1; i <= 20; i++) {
                    const id = "dia-q" + i;
                    const hasDiagram = diagramQs.has(i);
                    const diag = hasDiagram ? diagramCycle[dIdx++ % diagramCycle.length] : null;

                    if (i === 12) {
                        nodes.push(renderNode({
                            id,
                            label: "Question 12",
                            meta: "12",
                            diagram: diag,
                            questionHtml: `<p>Use the diagram and answer parts below.</p>`,
                            answerTex: `\\text{See parts}`,
                            workingLines: [{ type: "math", tex: `\\text{Parts (a) follow.}` }],
                            children: [
                                {
                                    id: "dia-q12a",
                                    label: "Sub-question 12(a)",
                                    questionHtml: `<p>Find ${katexInline("\\angle ABC")}.</p>`,
                                    answerTex: `60^{\\circ}`,
                                    workingLines: [{ type: "math", tex: `\\text{Using angle rules.}` }, { type: "math", tex: `60^{\\circ}` }],
                                    children: [
                                        {
                                            id: "dia-q12ai",
                                            label: "Sub-sub-question 12(a)(i)",
                                            questionHtml: `<p>State the rule used.</p>`,
                                            answerTex: `\\text{Angles in a triangle sum to }180^{\\circ}`,
                                            workingLines: [{ type: "math", tex: `\\angle A+\\angle B+\\angle C=180^{\\circ}` }]
                                        },
                                        {
                                            id: "dia-q12aii",
                                            label: "Sub-sub-question 12(a)(ii)",
                                            questionHtml: `<p>Compute the missing angle.</p>`,
                                            answerTex: `60^{\\circ}`,
                                            workingLines: [{ type: "math", tex: `180^{\\circ}-70^{\\circ}-50^{\\circ}=60^{\\circ}` }]
                                        }
                                    ]
                                }
                            ]
                        }, 0));
                        nav.push({ type: "link", text: "12", href: "#dia-q12" });
                        nav.push({ type: "link", text: "12a", href: "#dia-q12a" });
                        nav.push({ type: "link", text: "12ai", href: "#dia-q12ai" });
                        nav.push({ type: "link", text: "12aii", href: "#dia-q12aii" });
                        continue;
                    }

                    nodes.push(renderNode({
                        id,
                        label: "Question " + i,
                        meta: String(i),
                        diagram: diag,
                        questionHtml: hasDiagram
                            ? `<p>Refer to the diagram. Compute ${katexInline("x")}.</p>`
                            : `<p>Diagram-free prompt with ${katexInline("x")}.</p>`,
                        answerTex: `\\text{(short answer)}`,
                        workingLines: [
                            { type: "math", tex: `\\text{Step 1: read the given values.}` },
                            { type: "math", tex: `\\text{Step 2: apply a rule.}` },
                            { type: "math", tex: `\\text{Result: } x=\\text{(value)}` }
                        ]
                    }, 0));
                    nav.push({ type: "link", text: String(i), href: "#" + id });
                }

                return {
                    id: "diagram",
                    title: "Diagram-heavy paper",
                    subtitle: "20 questions total. 8 questions contain diagrams (inline SVG placeholders).",
                    navItems: nav,
                    nodes,
                    defaultWorkingsExpanded: false
                };
            }

            function buildSectionedPaper() {
                const nav = [];
                const nodes = [];

                nodes.push(el("div", { class: "section", id: "sec-a", "aria-label": "Section A" }, [el("h2", {}, ["Section A"])]));
                nav.push({ type: "sep", text: "A" });

                for (let i = 1; i <= 35; i++) {
                    const id = "sec-a" + i;

                    if (i === 20) {
                        nodes.push(renderNode({
                            id,
                            label: "Question A20",
                            meta: "A20",
                            questionHtml: `<p>Section A multi-part question.</p>`,
                            answerTex: `\\text{See parts}`,
                            workingLines: [{ type: "math", tex: `\\text{Parts (a) follow.}` }],
                            children: [
                                {
                                    id: "sec-a20a",
                                    label: "Sub-question A20(a)",
                                    questionHtml: `<p>Simplify ${katexInline("(x+1)^2")}.</p>`,
                                    answerTex: `x^{2}+2x+1`,
                                    workingLines: [{ type: "math", tex: `(x+1)^{2}` }, { type: "math", tex: `=x^{2}+2x+1` }],
                                    children: [
                                        {
                                            id: "sec-a20ai",
                                            label: "Sub-sub-question A20(a)(i)",
                                            questionHtml: `<p>Expand.</p>`,
                                            answerTex: `x^{2}+x+x+1`,
                                            workingLines: [{ type: "math", tex: `(x+1)(x+1)` }, { type: "math", tex: `=x^{2}+x+x+1` }]
                                        },
                                        {
                                            id: "sec-a20aii",
                                            label: "Sub-sub-question A20(a)(ii)",
                                            questionHtml: `<p>Collect like terms.</p>`,
                                            answerTex: `x^{2}+2x+1`,
                                            workingLines: [{ type: "math", tex: `x^{2}+x+x+1` }, { type: "math", tex: `=x^{2}+2x+1` }]
                                        }
                                    ]
                                }
                            ]
                        }, 0));
                        nav.push({ type: "link", text: "A20", href: "#sec-a20" });
                        nav.push({ type: "link", text: "A20a", href: "#sec-a20a" });
                        nav.push({ type: "link", text: "A20ai", href: "#sec-a20ai" });
                        nav.push({ type: "link", text: "A20aii", href: "#sec-a20aii" });
                        continue;
                    }

                    nodes.push(renderNode({
                        id,
                        label: "Question A" + i,
                        meta: "A" + i,
                        questionHtml: `<p>Section A prompt with ${katexInline("x")}.</p>${katexBlock("\\text{(prompt placeholder)}")}`,
                        answerTex: `\\text{(short answer)}`,
                        workingLines: [{ type: "math", tex: `x+${(i % 9) + 1}` }, { type: "math", tex: `\\text{(simplify)}` }, { type: "math", tex: `x+${(i % 9) + 1}` }]
                    }, 0));
                    nav.push({ type: "link", text: "A" + i, href: "#" + id });
                }

                nodes.push(el("div", { class: "section", id: "sec-b", "aria-label": "Section B" }, [el("h2", {}, ["Section B"])]));
                nav.push({ type: "sep", text: "B" });

                for (let i = 1; i <= 8; i++) {
                    const id = "sec-b" + i;
                    nodes.push(renderNode({
                        id,
                        label: "Question B" + i,
                        meta: "B" + i,
                        questionHtml: `<p>Section B medium prompt.</p>${katexBlock("\\text{(prompt placeholder)}")}`,
                        answerTex: `\\text{(short answer)}`,
                        workingLines: [{ type: "math", tex: `\\text{Step 1}` }, { type: "math", tex: `\\text{Step 2}` }, { type: "math", tex: `\\text{Result}` }]
                    }, 0));
                    nav.push({ type: "link", text: "B" + i, href: "#" + id });
                }

                nodes.push(el("div", { class: "section", id: "sec-c", "aria-label": "Section C" }, [el("h2", {}, ["Section C"])]));
                nav.push({ type: "sep", text: "C" });

                for (let i = 1; i <= 6; i++) {
                    const id = "sec-c" + i;

                    if (i === 3) {
                        const longC = []
                            .concat(tierLine(overflowTiers.D[0].label, overflowTiers.D[0].tex))
                            .concat(longAlgebraLines(703, 55));

                        nodes.push(renderNode({
                            id,
                            label: "Question C3",
                            meta: "C3",
                            questionHtml: `<p>Section C long prompt (includes nested parts).</p>${katexBlock("(4x+7)(x+3)-6")}`,
                            answerTex: `\\text{(short final form)}`,
                            workingLines: longC,
                            children: [
                                {
                                    id: "sec-c3a",
                                    label: "Sub-question C3(a)",
                                    questionHtml: `<p>State a simplified intermediate form.</p>`,
                                    answerTex: `4x^{2}+19x+15`,
                                    workingLines: [{ type: "math", tex: `(4x+7)(x+3)-6` }, { type: "math", tex: `=4x^{2}+19x+15` }]
                                }
                            ]
                        }, 0));
                        nav.push({ type: "link", text: "C3", href: "#sec-c3" });
                        nav.push({ type: "link", text: "C3a", href: "#sec-c3a" });
                        continue;
                    }

                    nodes.push(renderNode({
                        id,
                        label: "Question C" + i,
                        meta: "C" + i,
                        questionHtml: `<p>Section C long prompt.</p>${katexBlock("(3x+5)(x+2)-4")}${katexBlock("\\text{Simplify}")}`,
                        answerTex: `\\text{(short final form)}`,
                        workingLines: longAlgebraLines(600 + i, 55)
                    }, 0));
                    nav.push({ type: "link", text: "C" + i, href: "#" + id });
                }

                return {
                    id: "sectioned",
                    title: "Sectioned paper",
                    subtitle: "Section A (35), Section B (8), Section C (6 questions, all very long workings). Workings collapsed by default.",
                    navItems: nav,
                    nodes,
                    defaultWorkingsExpanded: false
                };
            }

            const datasets = {
                short: buildShortPaper,
                standard: () => buildStandardPaper(false),
                standardExpanded: () => buildStandardPaper(true),
                diagram: buildDiagramPaper,
                sectioned: buildSectionedPaper
            };

            // ------------------ Render + Nav ------------------
            const paperRoot = document.getElementById("paperRoot");
            const paperTitle = document.getElementById("paperTitle");
            const paperSubtitle = document.getElementById("paperSubtitle");
            const navRailList = document.getElementById("navListRail");
            const navDrawerList = document.getElementById("navListDrawer");
            const navRail = document.getElementById("navRail");
            const navDrawer = document.getElementById("navDrawer");
            const paperSelect = document.getElementById("paperSelect");

            function clearNode(node) {
                while (node.firstChild) node.removeChild(node.firstChild);
            }

            function buildNavList(navItems, ul) {
                clearNode(ul);
                navItems.forEach(item => {
                    const li = document.createElement("li");
                    if (item.type === "sep") {
                        li.appendChild(el("div", { class: "nav-sep" }, [item.text]));
                    } else {
                        const a = el("a", { href: item.href }, []);
                        a.appendChild(document.createTextNode(item.text));
                        li.appendChild(a);
                    }
                    ul.appendChild(li);
                });
            }

            // Stage 2: stabilize scroll when expanding/collapsing
            function toggleWithStability(btn, panel, nextExpanded) {
                const beforeTop = btn.getBoundingClientRect().top;

                btn.setAttribute("aria-expanded", String(nextExpanded));
                panel.hidden = !nextExpanded;
                btn.textContent = nextExpanded ? "Hide working" : "Show working";

                const workingBlock = btn.closest(".block.working");
                const preview = workingBlock ? workingBlock.querySelector(".working-preview") : null;
                if (preview) preview.style.display = nextExpanded ? "none" : "";

                requestAnimationFrame(() => {
                    const afterTop = btn.getBoundingClientRect().top;
                    const delta = afterTop - beforeTop;

                    if (Math.abs(delta) > 1) window.scrollBy(0, delta);

                    // If collapsing while far down the working, ensure the question context remains nearby
                    if (!nextExpanded) {
                        const q = btn.closest(".q, .nest");
                        if (q) {
                            const qRect = q.getBoundingClientRect();
                            // If the question block is mostly above viewport, bring it back without snapping past it.
                            if (qRect.bottom < 120) {
                                q.scrollIntoView({ block: "start" });
                                window.scrollBy(0, -Math.max(0, (parseInt(getComputedStyle(document.documentElement).getPropertyValue("--sticky-top")) || 56) + 8));
                            }
                        }
                    }
                });
            }

            function setWorkingDefaults(defaultExpanded) {
                const toggles = document.querySelectorAll(".js-working-toggle");
                toggles.forEach(btn => {
                    const targetId = btn.getAttribute("data-target");
                    const panel = document.getElementById(targetId);
                    if (!panel) return;

                    const next = !!defaultExpanded;
                    btn.setAttribute("aria-expanded", String(next));
                    panel.hidden = !next;
                    btn.textContent = next ? "Hide working" : "Show working";

                    const workingBlock = btn.closest(".block.working");
                    const preview = workingBlock ? workingBlock.querySelector(".working-preview") : null;
                    if (preview) preview.style.display = next ? "none" : "";

                    btn.addEventListener("click", () => {
                        const expanded = btn.getAttribute("aria-expanded") === "true";
                        toggleWithStability(btn, panel, !expanded);
                    });
                });
            }

            function renderKatex() {
                // Inline + block KaTeX targets outside working stacks
                document.querySelectorAll(".js-katex").forEach(node => {
                    if (node.closest(".js-katex-stack")) return;

                    const tex = node.getAttribute("data-tex") || "";
                    const display = (node.getAttribute("data-display") || "false") === "true";
                    if (window.katex && typeof window.katex.render === "function") {
                        try {
                            window.katex.render(tex, node, { displayMode: display, throwOnError: false });
                        } catch (e) {
                            node.classList.add("plain");
                            node.textContent = tex;
                        }
                    } else {
                        node.classList.add("plain");
                        node.textContent = tex;
                    }
                });

                // Working stacks: mix of plain-text labels and display math with per-expression scroll wrappers
                document.querySelectorAll(".js-katex-stack").forEach(stack => {
                    let arr = [];
                    try { arr = JSON.parse(stack.getAttribute("data-lines") || "[]"); } catch (e) { arr = []; }
                    stack.innerHTML = "";

                    arr.forEach(item => {
                        if (!item || typeof item !== "object") return;

                        if (item.type === "text") {
                            stack.appendChild(el("p", { class: "worktext" }, [String(item.text || "")]));
                            return;
                        }

                        const tex = String(item.tex || "");
                        const wrap = el("div", { class: "mathscroll", tabindex: "0", "aria-label": "Scrollable math" }, []);
                        const target = el("div", { class: "mathrow" }, []);
                        wrap.appendChild(target);
                        stack.appendChild(wrap);

                        if (window.katex && typeof window.katex.render === "function") {
                            try {
                                window.katex.render(tex, target, { displayMode: true, throwOnError: false });
                            } catch (e) {
                                target.classList.add("plain");
                                target.textContent = tex;
                            }
                        } else {
                            target.classList.add("plain");
                            target.textContent = tex;
                        }
                    });
                });
            }

            // Keyboard scrolling for horizontal math containers (only when focused)
            function wireMathKeyboardScroll() {
                document.querySelectorAll(".mathscroll").forEach(scroller => {
                    scroller.addEventListener("keydown", (e) => {
                        const k = e.key;
                        const step = 40;
                        const page = Math.max(120, Math.floor(scroller.clientWidth * 0.85));

                        if (k === "ArrowRight") { scroller.scrollLeft += step; e.preventDefault(); }
                        else if (k === "ArrowLeft") { scroller.scrollLeft -= step; e.preventDefault(); }
                        else if (k === "PageDown") { scroller.scrollLeft += page; e.preventDefault(); }
                        else if (k === "PageUp") { scroller.scrollLeft -= page; e.preventDefault(); }
                        else if (k === "Home") { scroller.scrollLeft = 0; e.preventDefault(); }
                        else if (k === "End") { scroller.scrollLeft = scroller.scrollWidth; e.preventDefault(); }
                    });
                });
            }

            function renderPaper(key) {
                const data = datasets[key]();

                paperTitle.textContent = data.title;
                paperSubtitle.textContent =
                    data.subtitle + " Answers visible by default. " +
                    (data.defaultWorkingsExpanded ? "Workings expanded by default." : "Workings collapsed by default.") +
                    " Questions are always visible.";

                clearNode(paperRoot);
                data.nodes.forEach(n => paperRoot.appendChild(n));

                buildNavList(data.navItems, navRailList);
                buildNavList(data.navItems, navDrawerList);

                setWorkingDefaults(data.defaultWorkingsExpanded);
                renderKatex();
                wireMathKeyboardScroll();

                if (navRail) navRail.scrollTop = 0;
                if (navDrawer) navDrawer.scrollTop = 0;
            }

            // ------------------ Drawer behavior ------------------
            const navToggle = document.getElementById("navToggle");
            const backdrop = document.getElementById("drawerBackdrop");
            const closeBtn = document.getElementById("drawerClose");

            function openDrawer() {
                backdrop.classList.add("open");
                backdrop.setAttribute("aria-hidden", "false");
                navToggle.setAttribute("aria-expanded", "true");
                closeBtn.focus();
            }
            function closeDrawer() {
                backdrop.classList.remove("open");
                backdrop.setAttribute("aria-hidden", "true");
                navToggle.setAttribute("aria-expanded", "false");
                navToggle.focus();
            }

            navToggle.addEventListener("click", () => {
                const isOpen = backdrop.classList.contains("open");
                if (isOpen) closeDrawer(); else openDrawer();
            });
            closeBtn.addEventListener("click", closeDrawer);
            backdrop.addEventListener("click", (e) => { if (e.target === backdrop) closeDrawer(); });
            document.addEventListener("keydown", (e) => {
                if (e.key === "Escape" && backdrop.classList.contains("open")) closeDrawer();
            });
            navDrawerList.addEventListener("click", (e) => {
                const a = e.target.closest && e.target.closest('a[href^="#"]');
                if (a) closeDrawer();
            });

            // ------------------ Keyboard scrolling for nav regions ------------------
            function wireNavKeyboardScroll(scroller) {
                if (!scroller) return;
                scroller.addEventListener("keydown", (e) => {
                    const k = e.key;
                    const step = 44;
                    const page = Math.max(160, Math.floor(scroller.clientHeight * 0.85));

                    if (document.activeElement !== scroller) return;

                    if (k === "ArrowDown") { scroller.scrollTop += step; e.preventDefault(); }
                    else if (k === "ArrowUp") { scroller.scrollTop -= step; e.preventDefault(); }
                    else if (k === "PageDown") { scroller.scrollTop += page; e.preventDefault(); }
                    else if (k === "PageUp") { scroller.scrollTop -= page; e.preventDefault(); }
                    else if (k === "Home") { scroller.scrollTop = 0; e.preventDefault(); }
                    else if (k === "End") { scroller.scrollTop = scroller.scrollHeight; e.preventDefault(); }
                });
            }
            wireNavKeyboardScroll(navRail);
            wireNavKeyboardScroll(navDrawer);

            // ------------------ Paper selector ------------------
            paperSelect.addEventListener("change", () => {
                renderPaper(paperSelect.value);
            });

            // ------------------ Init ------------------
            renderPaper("short");
        })();
    </script>
</body>

</html>
```