<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>RTQ – Maths Paper Solution Viewer (Stress Test Harness)</title>

    <!-- KaTeX (CDN) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>

    <style>
        :root {
            --bg: #ffffff;
            --fg: #111111;
            --muted: #555555;
            --faint: #777777;
            --hairline: #d0d0d0;

            --space-1: 6px;
            --space-2: 10px;
            --space-3: 14px;
            --space-4: 18px;
            --space-5: 26px;
            /* largest spacing between top-level questions */
            --space-6: 34px;

            --nav-w: 190px;
            --max-reading: 920px;
        }

        * {
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
        }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--fg);
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.35;
            overflow-x: hidden;
            /* never page-level horizontal scroll */
        }

        /* Layout: minimal nav rail + main document */
        .app {
            display: grid;
            grid-template-columns: var(--nav-w) 1fr;
            gap: 0;
            min-height: 100vh;
        }

        /* Minimal top bar */
        .topbar {
            position: sticky;
            top: 0;
            z-index: 5;
            background: var(--bg);
            border-bottom: 1px solid var(--hairline);
        }

        .topbar-inner {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-2) var(--space-3);
            gap: var(--space-3);
            max-width: calc(var(--max-reading) + 2 * var(--space-3));
            margin: 0 auto;
        }

        .topbar-left {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            flex-wrap: wrap;
        }

        label {
            font-size: 13px;
            color: var(--muted);
        }

        select {
            appearance: none;
            border: 1px solid var(--hairline);
            background: var(--bg);
            color: var(--fg);
            padding: 8px 10px;
            border-radius: 8px;
            font-size: 14px;
            min-width: 220px;
        }

        .btn {
            border: 1px solid var(--hairline);
            background: var(--bg);
            color: var(--fg);
            padding: 8px 10px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }

        .btn:focus {
            outline: 2px solid #000;
            outline-offset: 2px;
        }

        .btn-quiet {
            border-color: var(--hairline);
            color: var(--muted);
        }

        /* Desktop navigation rail */
        .nav {
            position: sticky;
            top: 0;
            height: 100vh;
            border-right: 1px solid var(--hairline);
            background: var(--bg);
            padding: var(--space-2) var(--space-2) var(--space-3) var(--space-2);
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }

        .nav-title {
            font-size: 12px;
            color: var(--muted);
            padding: 6px 8px;
        }

        .nav-list {
            flex: 1;
            overflow-y: auto;
            /* allowed only when needed (auto) */
            padding: 2px;
            border-radius: 10px;

            /* hide scrollbar but keep scrolling functional */
            scrollbar-width: none;
            /* Firefox */
            -ms-overflow-style: none;
            /* legacy */
        }

        .nav-list::-webkit-scrollbar {
            display: none;
        }

        .nav-list:focus {
            outline: 2px solid #000;
            outline-offset: 2px;
        }

        .nav-item {
            width: 100%;
            text-align: left;
            border: 0;
            background: transparent;
            cursor: pointer;
            padding: 6px 8px;
            border-radius: 8px;
            color: var(--fg);
            font-size: 14px;
        }

        .nav-item:hover {
            background: #f3f3f3;
        }

        .nav-item:focus {
            outline: 2px solid #000;
            outline-offset: 2px;
        }

        .nav-sep {
            padding: 10px 8px 6px 8px;
            font-size: 12px;
            color: var(--muted);
            letter-spacing: 0.02em;
        }

        /* Main document column */
        .main {
            min-width: 0;
        }

        .paper {
            padding: var(--space-4) var(--space-3) var(--space-6) var(--space-3);
            max-width: calc(var(--max-reading) + 2 * var(--space-3));
            margin: 0 auto;
        }

        .paper-title {
            font-size: 16px;
            font-weight: 600;
            margin: 0 0 var(--space-3) 0;
        }

        .paper-subtitle {
            font-size: 13px;
            color: var(--muted);
            margin: 0 0 var(--space-4) 0;
        }

        /* Sections for "Sectioned paper": plain text, no cards */
        .section-label {
            margin: var(--space-5) 0 var(--space-3) 0;
            color: var(--muted);
            font-size: 13px;
            letter-spacing: 0.02em;
        }

        /* Question blocks: whitespace rhythm, no cards/panels */
        .q {
            margin: 0 0 var(--space-5) 0;
            /* largest gap between top-level questions */
        }

        .q[data-depth="1"] {
            margin-bottom: var(--space-4);
        }

        .q[data-depth="2"] {
            margin-bottom: var(--space-3);
        }

        .q-inner {
            /* indentation only, no borders */
            padding-left: calc(var(--indent, 0px));
            max-width: var(--max-reading);
        }

        /* Adaptive indentation to preserve reading width on mobile */
        @media (max-width: 520px) {
            .q-inner {
                padding-left: calc(min(var(--indent, 0px), 16px));
            }
        }

        .q-head {
            display: flex;
            align-items: baseline;
            gap: var(--space-2);
            margin: 0 0 var(--space-2) 0;
        }

        .q-label {
            font-weight: 600;
            white-space: nowrap;
        }

        .q-prompt {
            margin: 0 0 var(--space-2) 0;
        }

        .q-prompt p {
            margin: 0 0 var(--space-2) 0;
        }

        .answer {
            margin: 0 0 var(--space-2) 0;
            color: var(--fg);
        }

        .answer-label {
            color: var(--muted);
            font-size: 13px;
            margin-right: 8px;
        }

        .working {
            margin: 0;
            color: var(--fg);
        }

        .working-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--space-2);
            margin: 0 0 var(--space-1) 0;
        }

        .toggle {
            border: 0;
            background: transparent;
            cursor: pointer;
            padding: 6px 8px;
            margin: 0;
            border-radius: 8px;
            color: var(--muted);
            font-size: 14px;
        }

        .toggle:hover {
            background: #f3f3f3;
        }

        .toggle:focus {
            outline: 2px solid #000;
            outline-offset: 2px;
        }

        .working-label {
            color: var(--muted);
            font-size: 13px;
            padding: 6px 0;
        }

        .working-body {
            margin: 0;
            padding: 0 0 0 0;
        }

        /* Collapsed workings show only minimal preview (1–2 lines) */
        .working-body.collapsed .math-line:nth-child(n+3) {
            display: none;
        }

        .working-body.collapsed .text-line:nth-child(n+3) {
            display: none;
        }

        .working-body.collapsed .ellipsis {
            display: block;
        }

        .ellipsis {
            display: none;
            color: var(--faint);
            font-size: 13px;
            margin: 4px 0 0 0;
        }

        /* KaTeX line containers */
        .math-line {
            margin: 2px 0;
            padding: 0;
            min-height: 1.1em;
        }

        .math-inline {
            display: inline-block;
            vertical-align: baseline;
            min-height: 1em;
        }

        .math-block {
            margin: 6px 0;
            padding: 0;
        }

        /* Overflow handling: only within block-level math containers */
        .math-block {
            overflow-x: auto;
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
            /* keep page from scrolling horizontally */
            max-width: 100%;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .math-block::-webkit-scrollbar {
            display: none;
        }

        /* Keep KaTeX display from wrapping and causing horizontal overflow only here */
        .math-block .katex-display {
            margin: 0;
            padding: 0;
            white-space: nowrap;
        }

        /* Diagrams (inline SVG placeholders) */
        .diagram {
            margin: var(--space-2) 0;
            max-width: 100%;
        }

        svg {
            max-width: 100%;
            height: auto;
            display: block;
        }

        /* Mobile: hide desktop nav, show always-accessible Jump control */
        .jump-fab {
            display: none;
            position: fixed;
            right: 14px;
            bottom: 14px;
            z-index: 10;
            border: 1px solid var(--hairline);
            background: var(--bg);
            border-radius: 999px;
            padding: 12px 14px;
            font-size: 14px;
            cursor: pointer;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
        }

        .jump-fab:focus {
            outline: 2px solid #000;
            outline-offset: 2px;
        }

        @media (max-width: 900px) {
            .app {
                grid-template-columns: 1fr;
            }

            .nav {
                display: none;
            }

            .jump-fab {
                display: inline-flex;
                align-items: center;
                gap: 8px;
            }
        }

        /* Mobile navigation overlay */
        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.25);
            z-index: 20;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        .overlay[aria-hidden="false"] {
            display: flex;
        }

        .overlay-panel {
            width: min(440px, 100%);
            max-height: 80vh;
            background: var(--bg);
            border: 1px solid var(--hairline);
            border-radius: 14px;
            overflow: hidden;
            /* panel itself should not scroll; nav list may */
            display: flex;
            flex-direction: column;
        }

        .overlay-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 12px;
            border-bottom: 1px solid var(--hairline);
            gap: 10px;
        }

        .overlay-title {
            font-size: 14px;
            color: var(--muted);
            margin: 0;
        }

        .overlay-close {
            border: 1px solid var(--hairline);
            background: var(--bg);
            border-radius: 10px;
            padding: 8px 10px;
            cursor: pointer;
            font-size: 14px;
        }

        .overlay-close:focus {
            outline: 2px solid #000;
            outline-offset: 2px;
        }

        .overlay-list {
            padding: 10px;
            overflow-y: auto;
            /* nav can scroll if needed */
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .overlay-list::-webkit-scrollbar {
            display: none;
        }

        /* Accessibility helper */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
    </style>
</head>

<body>
    <div class="app">
        <!-- Desktop navigation rail -->
        <aside class="nav" aria-label="Document navigation">
            <div class="nav-title">Jump to question</div>
            <div id="navListDesktop" class="nav-list" tabindex="0" aria-label="Question list"></div>
        </aside>

        <!-- Main document -->
        <main class="main">
            <div class="topbar">
                <div class="topbar-inner">
                    <div class="topbar-left">
                        <label for="paperSelect">Paper</label>
                        <select id="paperSelect" aria-label="Paper selector"></select>
                    </div>
                    <button id="jumpBtnTop" class="btn btn-quiet" type="button">Jump to</button>
                </div>
            </div>

            <div id="paperRoot" class="paper" aria-label="Maths paper"></div>
        </main>
    </div>

    <!-- Mobile Jump button (always accessible on small screens) -->
    <button id="jumpFab" class="jump-fab" type="button" aria-haspopup="dialog" aria-controls="navOverlay">
        Jump to
    </button>

    <!-- Mobile navigation overlay -->
    <div id="navOverlay" class="overlay" role="dialog" aria-modal="true" aria-hidden="true"
        aria-label="Jump to question">
        <div class="overlay-panel">
            <div class="overlay-head">
                <p class="overlay-title">Jump to question</p>
                <button id="overlayClose" class="overlay-close" type="button">Close</button>
            </div>
            <div id="navListMobile" class="overlay-list" tabindex="0" aria-label="Question list"></div>
        </div>
    </div>

    <script>
        // ---------- Dataset builders (stress-test harness) ----------

        function slugify(label) {
            return label
                .toLowerCase()
                .replace(/\s+/g, "-")
                .replace(/[()]/g, "")
                .replace(/[^a-z0-9\-]/g, "-")
                .replace(/-+/g, "-")
                .replace(/^-|-$/g, "");
        }

        function diagramSvg(kind) {
            // Grayscale inline SVG placeholders (reused types)
            if (kind === "geometry") {
                return `
          <svg viewBox="0 0 240 120" role="img" aria-label="Diagram placeholder: geometry">
            <circle cx="175" cy="60" r="35" stroke="#111" fill="none" stroke-width="2"></circle>
            <polygon points="40,95 95,25 150,95" stroke="#111" fill="none" stroke-width="2"></polygon>
            <text x="90" y="20" font-size="12" fill="#111">A</text>
            <text x="32" y="108" font-size="12" fill="#111">B</text>
            <text x="150" y="108" font-size="12" fill="#111">C</text>
            <text x="170" y="18" font-size="12" fill="#111">O</text>
            <line x1="175" y1="60" x2="210" y2="60" stroke="#111" stroke-width="2"></line>
            <text x="210" y="56" font-size="12" fill="#111">r</text>
          </svg>
        `;
            }
            if (kind === "bars") {
                return `
          <svg viewBox="0 0 240 120" role="img" aria-label="Diagram placeholder: ratio bars">
            <rect x="20" y="30" width="200" height="18" stroke="#111" fill="none" stroke-width="2"></rect>
            <line x1="87" y1="30" x2="87" y2="48" stroke="#111" stroke-width="2"></line>
            <line x1="154" y1="30" x2="154" y2="48" stroke="#111" stroke-width="2"></line>
            <text x="22" y="25" font-size="12" fill="#111">A</text>
            <text x="22" y="70" font-size="12" fill="#111">B</text>
            <rect x="20" y="75" width="200" height="18" stroke="#111" fill="none" stroke-width="2"></rect>
            <line x1="120" y1="75" x2="120" y2="93" stroke="#111" stroke-width="2"></line>
          </svg>
        `;
            }
            if (kind === "grid") {
                return `
          <svg viewBox="0 0 240 120" role="img" aria-label="Diagram placeholder: coordinate grid">
            <rect x="20" y="15" width="200" height="90" stroke="#111" fill="none" stroke-width="2"></rect>
            <line x1="20" y1="60" x2="220" y2="60" stroke="#111" stroke-width="1"></line>
            <line x1="120" y1="15" x2="120" y2="105" stroke="#111" stroke-width="1"></line>
            <circle cx="70" cy="80" r="3" fill="#111"></circle>
            <circle cx="170" cy="40" r="3" fill="#111"></circle>
            <line x1="70" y1="80" x2="170" y2="40" stroke="#111" stroke-width="2"></line>
            <text x="72" y="94" font-size="12" fill="#111">(1, -2)</text>
            <text x="172" y="34" font-size="12" fill="#111">(3, 1)</text>
          </svg>
        `;
            }
            // table-like grid / array
            return `
        <svg viewBox="0 0 240 120" role="img" aria-label="Diagram placeholder: table grid">
          <rect x="30" y="20" width="180" height="80" stroke="#111" fill="none" stroke-width="2"></rect>
          <line x1="90" y1="20" x2="90" y2="100" stroke="#111" stroke-width="1"></line>
          <line x1="150" y1="20" x2="150" y2="100" stroke="#111" stroke-width="1"></line>
          <line x1="30" y1="46" x2="210" y2="46" stroke="#111" stroke-width="1"></line>
          <line x1="30" y1="73" x2="210" y2="73" stroke="#111" stroke-width="1"></line>
          <text x="45" y="38" font-size="12" fill="#111">x</text>
          <text x="105" y="38" font-size="12" fill="#111">y</text>
          <text x="165" y="38" font-size="12" fill="#111">z</text>
        </svg>
      `;
        }

        function t(parts) {
            // Rich prompt fragments: text / inlineMath / diagram
            return parts;
        }

        function q(node) {
            // Node helper ensures consistent shape
            return Object.assign({
                kind: "question",
                label: "",
                depth: 0,
                prompt: t([]),
                answer: { parts: t([]) },
                working: [],
                children: []
            }, node);
        }

        function section(label) {
            return { kind: "section", label };
        }

        function makeShortWorking(lines = 5) {
            const out = [];
            for (let i = 1; i <= lines; i++) {
                out.push({ type: "blockMath", tex: `\\text{Step ${i}:}\\quad 12 + ${i} = ${12 + i}` });
            }
            return out;
        }

        function longAlgebraWorkingLines(count) {
            const out = [];
            for (let i = 1; i <= count; i++) {
                // Mix of algebra lines, occasional longer expressions for overflow stress
                const tex = (i % 9 === 0)
                    ? `\\frac{(x+${i})^2 - (x-${i})^2}{2x} = \\frac{(x^2+2${i}x+${i * i})-(x^2-2${i}x+${i * i})}{2x} = \\frac{4${i}x}{2x} = 2\\cdot ${i}`
                    : `x + ${i} = ${i + 7} \\Rightarrow x = ${7}`;
                out.push({ type: "blockMath", tex });
            }
            return out;
        }

        function buildDatasets() {
            // ---------- Short paper (6 questions, one multi-part) ----------
            const shortPaper = [
                q({
                    label: "1",
                    prompt: t([{ type: "text", value: "Calculate " }, { type: "inlineMath", tex: "7+5" }, { type: "text", value: "." }]),
                    answer: { parts: t([{ type: "inlineMath", tex: "12" }]) },
                    working: [
                        { type: "blockMath", tex: "7+5=12" }
                    ]
                }),
                q({
                    label: "2",
                    prompt: t([{ type: "text", value: "Find " }, { type: "inlineMath", tex: "3\\times 9" }, { type: "text", value: "." }]),
                    answer: { parts: t([{ type: "inlineMath", tex: "27" }]) },
                    working: [
                        { type: "blockMath", tex: "3\\times 9 = 27" }
                    ]
                }),
                q({
                    label: "3",
                    prompt: t([{ type: "text", value: "A rectangle has length " }, { type: "inlineMath", tex: "8\\,\\text{cm}" }, { type: "text", value: " and width " }, { type: "inlineMath", tex: "3\\,\\text{cm}" }, { type: "text", value: "." }]),
                    answer: { parts: t([{ type: "text", value: "Perimeter: " }, { type: "inlineMath", tex: "22\\,\\text{cm}" }]) },
                    working: [
                        { type: "blockMath", tex: "P = 2(8+3)=2\\times 11=22" }
                    ]
                }),
                q({
                    label: "4",
                    prompt: t([{ type: "text", value: "Solve " }, { type: "inlineMath", tex: "x+4=11" }, { type: "text", value: "." }]),
                    answer: { parts: t([{ type: "inlineMath", tex: "x=7" }]) },
                    working: [
                        { type: "blockMath", tex: "x+4=11" },
                        { type: "blockMath", tex: "x=11-4=7" }
                    ]
                }),
                q({
                    label: "5",
                    prompt: t([{ type: "text", value: "Write " }, { type: "inlineMath", tex: "0.25" }, { type: "text", value: " as a fraction in simplest form." }]),
                    answer: { parts: t([{ type: "inlineMath", tex: "\\frac14" }]) },
                    working: [
                        { type: "blockMath", tex: "0.25=\\frac{25}{100}=\\frac{1}{4}" }
                    ]
                }),
                q({
                    label: "6",
                    prompt: t([{ type: "text", value: "Multi-part question:" }]),
                    answer: { parts: t([{ type: "text", value: "See each part." }]) },
                    working: [],
                    children: [
                        q({
                            label: "6a",
                            depth: 1,
                            prompt: t([{ type: "text", value: "Calculate " }, { type: "inlineMath", tex: "15-7" }, { type: "text", value: "." }]),
                            answer: { parts: t([{ type: "inlineMath", tex: "8" }]) },
                            working: [{ type: "blockMath", tex: "15-7=8" }]
                        }),
                        q({
                            label: "6b",
                            depth: 1,
                            prompt: t([{ type: "text", value: "Find the value of " }, { type: "inlineMath", tex: "2^5" }, { type: "text", value: "." }]),
                            answer: { parts: t([{ type: "inlineMath", tex: "32" }]) },
                            working: [{ type: "blockMath", tex: "2^5 = 2\\times2\\times2\\times2\\times2 = 32" }]
                        }),
                        q({
                            label: "6c",
                            depth: 1,
                            prompt: t([{ type: "text", value: "A bag has " }, { type: "inlineMath", tex: "12" }, { type: "text", value: " apples. " },
                            { type: "text", value: "You share them equally between " }, { type: "inlineMath", tex: "3" }, { type: "text", value: " people. How many each?" }]),
                            answer: { parts: t([{ type: "inlineMath", tex: "4" }]) },
                            working: [{ type: "blockMath", tex: "12\\div 3 = 4" }]
                        })
                    ]
                })
            ];

            // ---------- Standard paper (35 questions; Q26–Q35 long algebra; deep nesting at Q18 and Q30) ----------
            const standardPaper = [];
            for (let n = 1; n <= 35; n++) {
                if (n === 12) {
                    // No parent-level prompt (stress case): children exist
                    standardPaper.push(q({
                        label: "12",
                        prompt: t([]),
                        answer: { parts: t([{ type: "text", value: "See parts." }]) },
                        working: [],
                        children: [
                            q({
                                label: "12a",
                                depth: 1,
                                prompt: t([{ type: "text", value: "Compute " }, { type: "inlineMath", tex: "18\\div 6" }, { type: "text", value: "." }]),
                                answer: { parts: t([{ type: "inlineMath", tex: "3" }]) },
                                working: [{ type: "blockMath", tex: "18\\div 6 = 3" }]
                            }),
                            q({
                                label: "12b",
                                depth: 1,
                                prompt: t([{ type: "text", value: "Simplify " }, { type: "inlineMath", tex: "\\frac{12}{18}" }, { type: "text", value: "." }]),
                                answer: { parts: t([{ type: "inlineMath", tex: "\\frac{2}{3}" }]) },
                                working: [{ type: "blockMath", tex: "\\frac{12}{18}=\\frac{2}{3}" }]
                            })
                        ]
                    }));
                    continue;
                }

                if (n === 18) {
                    standardPaper.push(q({
                        label: "18",
                        prompt: t([{ type: "text", value: "Deep nesting question:" }]),
                        answer: { parts: t([{ type: "text", value: "See each part." }]) },
                        working: [],
                        children: [
                            q({
                                label: "18(a)",
                                depth: 1,
                                prompt: t([{ type: "text", value: "Let " }, { type: "inlineMath", tex: "x=4" }, { type: "text", value: "." }]),
                                answer: { parts: t([{ type: "text", value: "See sub-parts." }]) },
                                working: [],
                                children: [
                                    q({
                                        label: "18(a)(i)",
                                        depth: 2,
                                        prompt: t([{ type: "text", value: "Evaluate " }, { type: "inlineMath", tex: "2x+3" }, { type: "text", value: "." }]),
                                        answer: { parts: t([{ type: "inlineMath", tex: "11" }]) },
                                        working: [
                                            { type: "blockMath", tex: "2x+3 = 2\\cdot 4 + 3 = 8+3 = 11" }
                                        ]
                                    }),
                                    q({
                                        label: "18(a)(ii)",
                                        depth: 2,
                                        prompt: t([{ type: "text", value: "Evaluate " }, { type: "inlineMath", tex: "x^2-1" }, { type: "text", value: "." }]),
                                        answer: { parts: t([{ type: "inlineMath", tex: "15" }]) },
                                        working: [
                                            { type: "blockMath", tex: "x^2-1 = 4^2-1 = 16-1 = 15" }
                                        ]
                                    })
                                ]
                            }),
                            q({
                                label: "18(b)",
                                depth: 1,
                                prompt: t([{ type: "text", value: "Solve " }, { type: "inlineMath", tex: "3y-5=10" }, { type: "text", value: "." }]),
                                answer: { parts: t([{ type: "inlineMath", tex: "y=5" }]) },
                                working: [
                                    { type: "blockMath", tex: "3y-5=10" },
                                    { type: "blockMath", tex: "3y=15" },
                                    { type: "blockMath", tex: "y=5" }
                                ]
                            })
                        ]
                    }));
                    continue;
                }

                if (n === 30) {
                    standardPaper.push(q({
                        label: "30",
                        prompt: t([{ type: "text", value: "Deep nesting question:" }]),
                        answer: { parts: t([{ type: "text", value: "See each part." }]) },
                        working: [],
                        children: [
                            q({
                                label: "30(a)",
                                depth: 1,
                                prompt: t([{ type: "text", value: "Given " }, { type: "inlineMath", tex: "a=2" }, { type: "text", value: " and " }, { type: "inlineMath", tex: "b=5" }, { type: "text", value: "." }]),
                                answer: { parts: t([{ type: "text", value: "See sub-parts." }]) },
                                working: [],
                                children: [
                                    q({
                                        label: "30(a)(i)",
                                        depth: 2,
                                        prompt: t([{ type: "text", value: "Calculate " }, { type: "inlineMath", tex: "a+b" }, { type: "text", value: "." }]),
                                        answer: { parts: t([{ type: "inlineMath", tex: "7" }]) },
                                        working: [{ type: "blockMath", tex: "a+b=2+5=7" }]
                                    }),
                                    q({
                                        label: "30(a)(ii)",
                                        depth: 2,
                                        prompt: t([{ type: "text", value: "Calculate " }, { type: "inlineMath", tex: "ab" }, { type: "text", value: "." }]),
                                        answer: { parts: t([{ type: "inlineMath", tex: "10" }]) },
                                        working: [{ type: "blockMath", tex: "ab=2\\times 5=10" }]
                                    })
                                ]
                            }),
                            q({
                                label: "30(b)",
                                depth: 1,
                                prompt: t([{ type: "text", value: "Simplify " }, { type: "inlineMath", tex: "(x+2)(x-2)" }, { type: "text", value: "." }]),
                                answer: { parts: t([{ type: "inlineMath", tex: "x^2-4" }]) },
                                working: [
                                    { type: "blockMath", tex: "(x+2)(x-2)=x^2-4" }
                                ]
                            })
                        ]
                    }));
                    continue;
                }

                // Q26–Q35 long algebra questions (workings long; collapsed by default generally)
                if (n >= 26) {
                    standardPaper.push(q({
                        label: String(n),
                        prompt: t([
                            { type: "text", value: "Algebra (long): Solve and show steps. " }
                        ]),
                        answer: { parts: t([{ type: "inlineMath", tex: "x=7" }]) },
                        working: [
                            { type: "blockMath", tex: "\\text{Given: } x + " + n + " = " + (n + 7) },
                            ...longAlgebraWorkingLines(n === 33 ? 60 : (n === 30 ? 30 : 22)), // stress a very long one
                            { type: "blockMath", tex: "\\therefore\\; x=7" }
                        ]
                    }));
                    continue;
                }

                // Typical short/medium questions
                const prompt = (n % 5 === 0)
                    ? t([{ type: "text", value: "Convert " }, { type: "inlineMath", tex: `\\frac{${n}}{${n + 5}}` }, { type: "text", value: " to a decimal (2 d.p.)." }])
                    : t([{ type: "text", value: "Calculate " }, { type: "inlineMath", tex: `${n}+${n + 3}` }, { type: "text", value: "." }]);

                const answer = (n % 5 === 0)
                    ? t([{ type: "inlineMath", tex: `\\text{(decimal)}\\;\\approx\\;${(n / (n + 5)).toFixed(2)}` }])
                    : t([{ type: "inlineMath", tex: `${n + n + 3}` }]);

                standardPaper.push(q({
                    label: String(n),
                    prompt,
                    answer: { parts: answer },
                    working: makeShortWorking(n % 4 === 0 ? 6 : 4)
                }));
            }

            // ---------- Diagram-heavy paper (20 questions; 8 have diagrams) ----------
            const diagramHeavy = [];
            const diagramIndices = new Set([2, 4, 6, 9, 11, 14, 16, 19]);
            for (let n = 1; n <= 20; n++) {
                const hasDiagram = diagramIndices.has(n);
                const kind = (n % 4 === 1) ? "geometry" : (n % 4 === 2) ? "bars" : (n % 4 === 3) ? "grid" : "table";
                diagramHeavy.push(q({
                    label: String(n),
                    prompt: t([
                        { type: "text", value: "Use the information given to answer." },
                        ...(hasDiagram ? [{ type: "diagram", kind }] : []),
                        { type: "text", value: " Find the value requested." },
                        { type: "inlineMath", tex: "\\;[\\text{diagram data varies}]" }
                    ]),
                    answer: { parts: t([{ type: "inlineMath", tex: `${n + 2}` }]) },
                    working: [
                        { type: "blockMath", tex: `\\text{From the diagram, } ${n}+2 = ${n + 2}` },
                        { type: "blockMath", tex: `\\therefore\\; \\text{answer} = ${n + 2}` }
                    ]
                }));
            }

            // ---------- Sectioned paper (original structure: A/B/C) ----------
            const sectioned = [];
            sectioned.push(section("Section A"));
            for (let n = 1; n <= 35; n++) {
                if (n === 18) {
                    sectioned.push(q({
                        label: "18",
                        prompt: t([{ type: "text", value: "Deep nesting question:" }]),
                        answer: { parts: t([{ type: "text", value: "See each part." }]) },
                        working: [],
                        children: [
                            q({
                                label: "18(a)",
                                depth: 1,
                                prompt: t([{ type: "text", value: "Let " }, { type: "inlineMath", tex: "x=4" }, { type: "text", value: "." }]),
                                answer: { parts: t([{ type: "text", value: "See sub-parts." }]) },
                                working: [],
                                children: [
                                    q({
                                        label: "18(a)(i)",
                                        depth: 2,
                                        prompt: t([{ type: "text", value: "Evaluate " }, { type: "inlineMath", tex: "2x+3" }, { type: "text", value: "." }]),
                                        answer: { parts: t([{ type: "inlineMath", tex: "11" }]) },
                                        working: [{ type: "blockMath", tex: "2x+3=11" }]
                                    }),
                                    q({
                                        label: "18(a)(ii)",
                                        depth: 2,
                                        prompt: t([{ type: "text", value: "Evaluate " }, { type: "inlineMath", tex: "x^2-1" }, { type: "text", value: "." }]),
                                        answer: { parts: t([{ type: "inlineMath", tex: "15" }]) },
                                        working: [{ type: "blockMath", tex: "x^2-1=15" }]
                                    })
                                ]
                            }),
                            q({
                                label: "18(b)",
                                depth: 1,
                                prompt: t([{ type: "text", value: "Solve " }, { type: "inlineMath", tex: "3y-5=10" }, { type: "text", value: "." }]),
                                answer: { parts: t([{ type: "inlineMath", tex: "y=5" }]) },
                                working: [{ type: "blockMath", tex: "y=5" }]
                            })
                        ]
                    }));
                } else {
                    sectioned.push(q({
                        label: String(n),
                        prompt: t([{ type: "text", value: "Short/medium question." }, { type: "inlineMath", tex: `\\;${n}+${n + 1}` }]),
                        answer: { parts: t([{ type: "inlineMath", tex: `${2 * n + 1}` }]) },
                        working: makeShortWorking(4)
                    }));
                }
            }

            sectioned.push(section("Section B"));
            for (let n = 1; n <= 8; n++) {
                sectioned.push(q({
                    label: `B${n}`,
                    prompt: t([{ type: "text", value: "Medium question." }, { type: "inlineMath", tex: `\\;\\frac{${n + 10}}{${n + 2}}` }]),
                    answer: { parts: t([{ type: "inlineMath", tex: `\\text{(simplified)}\\;\\approx\\;${((n + 10) / (n + 2)).toFixed(2)}` }]) },
                    working: [
                        { type: "blockMath", tex: `\\frac{${n + 10}}{${n + 2}}` },
                        { type: "blockMath", tex: `\\approx ${((n + 10) / (n + 2)).toFixed(2)}` }
                    ]
                }));
            }

            sectioned.push(section("Section C"));
            for (let n = 1; n <= 6; n++) {
                const lines = (n === 3 || n === 6) ? 60 : 34; // extremely long workings
                sectioned.push(q({
                    label: `C${n}`,
                    prompt: t([{ type: "text", value: "Very long working (collapsed by default): simplify the expression." }]),
                    answer: { parts: t([{ type: "inlineMath", tex: "x=7" }]) },
                    working: [
                        { type: "blockMath", tex: "\\text{Start: } x + 20 = 27" },
                        ...longAlgebraWorkingLines(lines),
                        { type: "blockMath", tex: "\\therefore\\; x=7" }
                    ]
                }));
            }

            // ---------- Standard (Workings Expanded) dataset variant ----------
            const standardExpanded = JSON.parse(JSON.stringify(standardPaper));

            return {
                "short": {
                    title: "Short paper",
                    subtitle: "6 questions • mix of short arithmetic + one multi-part",
                    defaultWorkingsExpanded: false,
                    nodes: shortPaper
                },
                "standard": {
                    title: "Standard paper",
                    subtitle: "35 questions • Q26–Q35 long algebra • deep nesting at Q18 & Q30",
                    defaultWorkingsExpanded: false,
                    nodes: standardPaper
                },
                "standardExpanded": {
                    title: "Standard (Workings Expanded)",
                    subtitle: "Same as Standard • all workings start expanded (dataset variant only)",
                    defaultWorkingsExpanded: true,
                    nodes: standardExpanded
                },
                "diagram": {
                    title: "Diagram-heavy paper",
                    subtitle: "20 questions • 8 include diagrams (SVG placeholders)",
                    defaultWorkingsExpanded: false,
                    nodes: diagramHeavy
                },
                "sectioned": {
                    title: "Sectioned paper",
                    subtitle: "Section A (35) • Section B (8) • Section C (6, very long workings)",
                    defaultWorkingsExpanded: false,
                    nodes: sectioned
                }
            };
        }

        const DATASETS = buildDatasets();

        // ---------- Rendering ----------

        const paperSelect = document.getElementById("paperSelect");
        const paperRoot = document.getElementById("paperRoot");
        const navDesktop = document.getElementById("navListDesktop");
        const navMobile = document.getElementById("navListMobile");

        const navOverlay = document.getElementById("navOverlay");
        const overlayClose = document.getElementById("overlayClose");
        const jumpFab = document.getElementById("jumpFab");
        const jumpBtnTop = document.getElementById("jumpBtnTop");

        let currentDatasetKey = "short";
        let lastFocusEl = null;

        function createEl(tag, attrs = {}, children = []) {
            const el = document.createElement(tag);
            for (const [k, v] of Object.entries(attrs)) {
                if (k === "class") el.className = v;
                else if (k === "dataset") el.dataset[k] = v;
                else if (k.startsWith("data-")) el.setAttribute(k, v);
                else if (k === "html") el.innerHTML = v;
                else if (k === "text") el.textContent = v;
                else el.setAttribute(k, v);
            }
            children.forEach(ch => el.appendChild(ch));
            return el;
        }

        function renderRichParts(parts, container) {
            if (!parts || parts.length === 0) return;
            // Group as paragraph where sensible
            const p = createEl("p", {});
            let hasAnything = false;

            for (const part of parts) {
                hasAnything = true;
                if (part.type === "text") {
                    p.appendChild(document.createTextNode(part.value));
                } else if (part.type === "inlineMath") {
                    const span = createEl("span", { class: "math-inline", "data-tex": part.tex, "data-display": "inline", "aria-label": "math" });
                    span.textContent = part.tex; // fallback
                    p.appendChild(span);
                } else if (part.type === "diagram") {
                    const d = createEl("div", { class: "diagram", html: diagramSvg(part.kind) });
                    // close paragraph before inserting block diagram
                    if (p.childNodes.length) {
                        container.appendChild(p);
                    } else {
                        // no content yet, drop empty paragraph
                    }
                    container.appendChild(d);
                    // start new paragraph
                    p.textContent = "";
                }
            }
            if (hasAnything && p.childNodes.length) {
                container.appendChild(p);
            }
        }

        function renderWorkingLines(lines, bodyEl) {
            if (!lines || lines.length === 0) return;
            for (const item of lines) {
                if (item.type === "blockMath") {
                    const line = createEl("div", { class: "math-line math-block", "data-tex": item.tex, "data-display": "block" });
                    line.textContent = item.tex; // fallback
                    bodyEl.appendChild(line);
                } else if (item.type === "text") {
                    const line = createEl("div", { class: "text-line" });
                    line.textContent = item.value;
                    bodyEl.appendChild(line);
                }
            }
            bodyEl.appendChild(createEl("div", { class: "ellipsis", text: "…" }));
        }

        function buildQuestionBlock(node, dataset) {
            const indentPx = node.depth === 0 ? 0 : (node.depth === 1 ? 22 : 40);
            const id = "q-" + slugify(node.label);

            const qWrap = createEl("section", {
                class: "q",
                id,
                "data-depth": String(node.depth),
                "aria-label": `Question ${node.label}`
            });

            const qInner = createEl("div", { class: "q-inner" });
            qInner.style.setProperty("--indent", indentPx + "px");

            // Head: label only (no cards/panels)
            const head = createEl("div", { class: "q-head" }, [
                createEl("div", { class: "q-label", text: node.label })
            ]);

            // Prompt
            const prompt = createEl("div", { class: "q-prompt" });
            renderRichParts(node.prompt, prompt);

            // Answer (visible by default)
            const answer = createEl("div", { class: "answer" });
            const answerLabel = createEl("span", { class: "answer-label", text: "Answer:" });
            answer.appendChild(answerLabel);
            const answerContent = createEl("span", {});
            renderInlineAnswerParts(node.answer?.parts || [], answerContent);
            answer.appendChild(answerContent);

            // Working (collapsed by default unless dataset variant says expanded)
            const working = createEl("div", { class: "working" });
            const workingHead = createEl("div", { class: "working-head" });
            const workingLabel = createEl("div", { class: "working-label", text: "Working" });

            const toggle = createEl("button", { class: "toggle", type: "button" });
            const hasWorking = (node.working && node.working.length > 0);

            const body = createEl("div", { class: "working-body", "aria-live": "off" });

            const shouldExpand = dataset.defaultWorkingsExpanded === true;
            let expanded = shouldExpand;

            function syncToggle() {
                if (!hasWorking) {
                    toggle.style.display = "none";
                    workingLabel.textContent = "Working (none)";
                    body.style.display = "none";
                    return;
                }
                toggle.textContent = expanded ? "Hide working" : "Show working";
                body.classList.toggle("collapsed", !expanded);
            }

            if (hasWorking) {
                renderWorkingLines(node.working, body);
                toggle.addEventListener("click", () => {
                    expanded = !expanded;
                    syncToggle();
                });
            }

            syncToggle();

            workingHead.appendChild(workingLabel);
            workingHead.appendChild(toggle);
            working.appendChild(workingHead);
            working.appendChild(body);

            qInner.appendChild(head);
            if (node.prompt && node.prompt.length) {
                qInner.appendChild(prompt);
            } else {
                // Prompt intentionally absent for stress case: keep spacing minimal
            }
            qInner.appendChild(answer);
            qInner.appendChild(working);

            // Children
            if (node.children && node.children.length) {
                for (const child of node.children) {
                    qInner.appendChild(buildQuestionBlock(child, dataset));
                }
            }

            qWrap.appendChild(qInner);
            return qWrap;
        }

        function renderInlineAnswerParts(parts, container) {
            if (!parts || parts.length === 0) return;
            for (const part of parts) {
                if (part.type === "text") {
                    container.appendChild(document.createTextNode(part.value));
                } else if (part.type === "inlineMath") {
                    const span = createEl("span", { class: "math-inline", "data-tex": part.tex, "data-display": "inline", "aria-label": "math" });
                    span.textContent = part.tex; // fallback
                    container.appendChild(span);
                } else if (part.type === "diagram") {
                    const d = createEl("span", { class: "diagram", html: diagramSvg(part.kind) });
                    container.appendChild(d);
                }
            }
        }

        function flattenNavItems(nodes) {
            // Returns array of {type:"item", label, targetId} or {type:"sep", label}
            const out = [];
            function walk(list) {
                for (const node of list) {
                    if (node.kind === "section") {
                        out.push({ type: "sep", label: node.label });
                        continue;
                    }
                    const targetId = "q-" + slugify(node.label);
                    out.push({ type: "item", label: node.label, targetId });
                    if (node.children && node.children.length) {
                        walk(node.children);
                    }
                }
            }
            walk(nodes);
            return out;
        }

        function renderNav(navItems) {
            navDesktop.innerHTML = "";
            navMobile.innerHTML = "";

            function addNavTo(container, isMobile) {
                for (const it of navItems) {
                    if (it.type === "sep") {
                        container.appendChild(createEl("div", { class: "nav-sep", text: it.label }));
                    } else {
                        const btn = createEl("button", { class: "nav-item", type: "button", text: it.label });
                        btn.addEventListener("click", () => {
                            const target = document.getElementById(it.targetId);
                            if (target) {
                                target.scrollIntoView({ behavior: "smooth", block: "start" });
                            }
                            if (isMobile) {
                                closeOverlay();
                            }
                        });
                        container.appendChild(btn);
                    }
                }
            }

            addNavTo(navDesktop, false);
            addNavTo(navMobile, true);
        }

        function renderDataset(key) {
            currentDatasetKey = key;
            const dataset = DATASETS[key];

            // Clear
            paperRoot.innerHTML = "";

            // Title
            const title = createEl("h1", { class: "paper-title", text: dataset.title });
            const subtitle = createEl("p", { class: "paper-subtitle", text: dataset.subtitle });

            paperRoot.appendChild(title);
            paperRoot.appendChild(subtitle);

            // Render nodes in one continuous linear document
            for (const node of dataset.nodes) {
                if (node.kind === "section") {
                    paperRoot.appendChild(createEl("div", { class: "section-label", text: node.label }));
                } else {
                    paperRoot.appendChild(buildQuestionBlock(node, dataset));
                }
            }

            // Navigation
            const navItems = flattenNavItems(dataset.nodes);
            renderNav(navItems);

            // Render KaTeX programmatically (fallback to text if KaTeX fails)
            renderMathSafe();
        }

        // ---------- KaTeX rendering (programmatic, with graceful fallback) ----------

        function renderMathSafe() {
            const maxWaitMs = 2200;
            const start = performance.now();

            function attempt() {
                const hasKatex = !!(window.katex && typeof window.katex.render === "function");
                if (hasKatex) {
                    const nodes = document.querySelectorAll("[data-tex]");
                    nodes.forEach(el => {
                        const tex = el.getAttribute("data-tex") || "";
                        const display = el.getAttribute("data-display") === "block";
                        try {
                            window.katex.render(tex, el, {
                                displayMode: display,
                                throwOnError: false,
                                strict: "ignore"
                            });
                        } catch (e) {
                            // leave fallback text
                            el.textContent = tex;
                        }
                    });
                    return;
                }

                if (performance.now() - start < maxWaitMs) {
                    setTimeout(attempt, 60);
                } else {
                    // KaTeX failed to load: keep plain text already present
                }
            }

            attempt();
        }

        // ---------- Overlay controls (mobile) ----------

        function openOverlay() {
            lastFocusEl = document.activeElement;
            navOverlay.setAttribute("aria-hidden", "false");
            // Move focus into the list for keyboard scrolling
            setTimeout(() => navMobile.focus(), 0);
            document.addEventListener("keydown", onOverlayKeyDown);
        }

        function closeOverlay() {
            navOverlay.setAttribute("aria-hidden", "true");
            document.removeEventListener("keydown", onOverlayKeyDown);
            if (lastFocusEl && typeof lastFocusEl.focus === "function") {
                lastFocusEl.focus();
            }
        }

        function onOverlayKeyDown(e) {
            if (e.key === "Escape") {
                e.preventDefault();
                closeOverlay();
            }
        }

        navOverlay.addEventListener("click", (e) => {
            // Click outside panel closes
            if (e.target === navOverlay) closeOverlay();
        });
        overlayClose.addEventListener("click", closeOverlay);
        jumpFab.addEventListener("click", openOverlay);
        jumpBtnTop.addEventListener("click", () => {
            // On desktop, it’s redundant but still useful; on mobile, open overlay
            const isMobile = window.matchMedia("(max-width: 900px)").matches;
            if (isMobile) openOverlay();
            else {
                // Desktop: focus nav rail and let user Tab or scroll within it
                navDesktop.focus();
            }
        });

        // ---------- Selector ----------

        function initSelector() {
            const entries = [
                ["short", "Short paper"],
                ["standard", "Standard paper"],
                ["standardExpanded", "Standard (Workings Expanded)"],
                ["diagram", "Diagram-heavy paper"],
                ["sectioned", "Sectioned paper"]
            ];

            for (const [key, label] of entries) {
                const opt = document.createElement("option");
                opt.value = key;
                opt.textContent = label;
                paperSelect.appendChild(opt);
            }

            paperSelect.value = currentDatasetKey;
            paperSelect.addEventListener("change", (e) => {
                const key = e.target.value;
                renderDataset(key);
                // Switching papers hides/shows content and rebuilds navigation; defaults handled per dataset.
                window.scrollTo({ top: 0, behavior: "auto" });
            });
        }

        // ---------- Boot ----------
        initSelector();
        renderDataset(currentDatasetKey);
    </script>
</body>

</html>