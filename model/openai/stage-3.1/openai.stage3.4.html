<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RTQ – Maths Paper Solution Viewer (Stress Test Harness)</title>

  <!-- KaTeX (CDN) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>

  <style>
    :root {
      --frame-max: 1120px;
      --gutter: 20px;

      --text: #111;
      --muted: #444;
      --quiet: #666;
      --hairline: #d6d6d6;
      --paper-gap: 26px;
      /* largest spacing unit */
      --within-gap: 10px;
      /* tighter within question */
      --indent: 18px;

      --control-h: 56px;
      --nav-w: 160px;
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      height: 100%;
    }

    body {
      margin: 0;
      color: var(--text);
      background: #fff;
      font: 14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }

    /* Top control area (aligned to centered frame gutters) */
    header {
      position: sticky;
      top: 0;
      z-index: 50;
      background: #fff;
      border-bottom: 1px solid var(--hairline);
    }

    .topbar {
      max-width: var(--frame-max);
      margin: 0 auto;
      padding: 0 var(--gutter);
      height: var(--control-h);
      display: flex;
      align-items: center;
      gap: 12px;
      justify-content: space-between;
    }

    .controls {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 0;
    }

    label {
      color: var(--muted);
      font-size: 13px;
      white-space: nowrap;
    }

    select {
      font: inherit;
      padding: 6px 8px;
      border: 1px solid var(--hairline);
      border-radius: 8px;
      background: #fff;
      color: var(--text);
      min-width: 260px;
      max-width: 60vw;
    }

    .jumpBtn {
      font: inherit;
      padding: 7px 10px;
      border: 1px solid var(--hairline);
      border-radius: 10px;
      background: #fff;
      color: var(--text);
    }

    .jumpBtn:focus,
    select:focus,
    a:focus,
    summary:focus,
    button:focus {
      outline: 2px solid #000;
      outline-offset: 2px;
    }

    /* Centered content frame with sibling columns */
    .frame {
      max-width: var(--frame-max);
      margin: 0 auto;
      padding: 0 var(--gutter);
    }

    .cols {
      display: grid;
      grid-template-columns: var(--nav-w) 1fr;
      gap: 22px;
      align-items: start;
      padding-top: 18px;
      padding-bottom: 40px;
    }

    nav {
      min-width: 0;
    }

    /* Sticky nav rail (quiet, low chrome) */
    .navRail {
      position: sticky;
      top: calc(var(--control-h) + 14px);
      padding-top: 2px;
    }

    .navTitle {
      font-size: 12px;
      color: var(--quiet);
      margin: 0 0 8px 0;
      letter-spacing: .01em;
    }

    /* Scrollable nav list with hidden scrollbars (only nav may scroll) */
    .navList {
      max-height: calc(100vh - (var(--control-h) + 34px));
      overflow-y: auto;
      padding-right: 6px;
      scrollbar-width: none;
      /* Firefox */
      -ms-overflow-style: none;
      /* legacy */
    }

    .navList::-webkit-scrollbar {
      display: none;
    }

    .navListInner {
      display: flex;
      flex-direction: column;
      gap: 6px;
      padding: 0 0 6px 0;
    }

    .navSep {
      color: var(--quiet);
      font-size: 12px;
      margin: 10px 0 4px;
      padding-top: 6px;
      border-top: 1px solid var(--hairline);
    }

    .navItem {
      display: inline-block;
      text-decoration: none;
      color: var(--text);
      font-size: 13px;
      padding: 2px 0;
    }

    .navItem[aria-current="true"] {
      text-decoration: underline;
      text-underline-offset: 3px;
    }

    main {
      min-width: 0;
    }

    /* Paper content rhythm */
    .paper {
      padding-bottom: 10px;
    }

    .sectionHdr {
      margin: 24px 0 10px;
      color: var(--text);
      font-weight: 600;
      font-size: 13px;
      letter-spacing: .01em;
    }

    .q {
      margin: 0 0 var(--paper-gap) 0;
      /* biggest gap between top-level questions */
    }

    /* Within-question spacing is tighter */
    .qInner {
      display: flex;
      flex-direction: column;
      gap: var(--within-gap);
    }

    .qPrompt {
      display: flex;
      gap: 10px;
      align-items: flex-start;
      min-width: 0;
    }

    .qid {
      flex: 0 0 auto;
      font-weight: 600;
      color: var(--text);
      width: 64px;
      /* stable prefix column feel */
      text-align: right;
      padding-right: 6px;
    }

    .qtext {
      flex: 1 1 auto;
      min-width: 0;
      color: var(--text);
    }

    .qtext p {
      margin: 0 0 8px 0;
    }

    .qtext p:last-child {
      margin-bottom: 0;
    }

    /* Answers: visible by default, visually subordinate to question but above working */
    .answer {
      display: flex;
      gap: 10px;
      align-items: flex-start;
      min-width: 0;
    }

    .alabel {
      flex: 0 0 auto;
      width: 64px;
      text-align: right;
      padding-right: 6px;
      color: var(--muted);
      font-weight: 600;
    }

    .avalue {
      flex: 1 1 auto;
      min-width: 0;
      color: var(--text);
    }

    /* Solution Details as a single expandable region per question */
    details.sd {
      margin-left: calc(64px + 10px);
      /* align under q text column */
    }

    summary.sdSum {
      list-style: none;
      cursor: pointer;
      user-select: none;
      color: var(--muted);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    summary.sdSum::-webkit-details-marker {
      display: none;
    }

    .sdRow {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 0;
    }

    .sdToggle {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: 1px solid var(--hairline);
      border-radius: 10px;
      padding: 6px 10px;
      background: #fff;
      color: var(--text);
      width: fit-content;
    }

    .sdToggleText {
      font-weight: 600;
      font-size: 13px;
    }

    .sdPreview {
      color: var(--quiet);
      font-size: 12px;
      max-width: 60ch;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    details.sd[open] .sdPreview {
      display: none;
    }

    .sdBody {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .sdBlockTitle {
      font-weight: 600;
      color: var(--muted);
      font-size: 12px;
      margin: 0 0 6px 0;
    }

    .sdBlock {
      color: var(--text);
    }

    .sdBlock p {
      margin: 0 0 6px 0;
      color: var(--text);
    }

    .sdBlock p:last-child {
      margin-bottom: 0;
    }

    /* KaTeX overflow safety: only block math may scroll horizontally */
    .mathBlock {
      overflow-x: auto;
      overflow-y: hidden;
      max-width: 100%;
      padding: 2px 0;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .mathBlock::-webkit-scrollbar {
      display: none;
    }

    .mathInline {
      white-space: nowrap;
    }

    /* Diagrams (inline SVG placeholders) */
    .diagramWrap {
      margin-top: 10px;
      max-width: 420px;
    }

    .diagramWrap svg {
      display: block;
      width: 100%;
      height: auto;
    }

    .diagramCaption {
      font-size: 12px;
      color: var(--quiet);
      margin-top: 6px;
    }

    /* Nesting: indentation only, no borders/cards */
    .depth1 {
      margin-left: var(--indent);
    }

    .depth2 {
      margin-left: calc(var(--indent) * 2);
    }

    .depth3 {
      margin-left: calc(var(--indent) * 3);
    }

    /* Mobile / Tablet */
    @media (max-width: 920px) {
      :root {
        --nav-w: 0px;
      }

      .cols {
        grid-template-columns: 1fr;
        gap: 0;
      }

      nav {
        display: none;
      }

      /* use overlay */
      select {
        min-width: 220px;
      }

      .qid,
      .alabel {
        width: 52px;
      }

      details.sd {
        margin-left: calc(52px + 10px);
      }
    }

    /* Overlay navigation (mobile/tablet) */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(255, 255, 255, .98);
      z-index: 100;
      display: none;
    }

    .overlay[aria-hidden="false"] {
      display: block;
    }

    .overlayInner {
      max-width: var(--frame-max);
      margin: 0 auto;
      height: 100%;
      padding: 10px var(--gutter) 18px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .overlayHeader {
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: var(--control-h);
      border-bottom: 1px solid var(--hairline);
      gap: 10px;
    }

    .overlayHeader h2 {
      font-size: 13px;
      margin: 0;
      color: var(--text);
      font-weight: 600;
    }

    .closeBtn {
      font: inherit;
      padding: 7px 10px;
      border: 1px solid var(--hairline);
      border-radius: 10px;
      background: #fff;
      color: var(--text);
    }

    .overlayNav {
      flex: 1 1 auto;
      overflow-y: auto;
      padding-top: 10px;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .overlayNav::-webkit-scrollbar {
      display: none;
    }

    .overlayNav .navListInner {
      gap: 10px;
    }

    .overlayNav .navItem {
      font-size: 16px;
      padding: 6px 0;
    }

    /* Quiet helper text */
    .srOnly {
      position: absolute !important;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
  </style>
</head>

<body>
  <header>
    <div class="topbar">
      <div class="controls">
        <label for="paperSel">Paper</label>
        <select id="paperSel" aria-label="Paper selector">
          <!-- populated by JS -->
        </select>
      </div>
      <button class="jumpBtn" id="jumpBtn" type="button">Jump to</button>
    </div>
  </header>

  <div class="frame">
    <div class="cols">
      <nav aria-label="Document navigation">
        <div class="navRail">
          <p class="navTitle">Questions</p>
          <div class="navList" id="navList" tabindex="0" aria-label="Question list">
            <div class="navListInner" id="navListInner"></div>
          </div>
        </div>
      </nav>

      <main id="main" tabindex="-1" aria-label="Paper content">
        <div class="paper" id="paper"></div>
      </main>
    </div>
  </div>

  <!-- Mobile/Tablet overlay navigation -->
  <div class="overlay" id="navOverlay" aria-hidden="true" role="dialog" aria-modal="true" aria-label="Jump to question">
    <div class="overlayInner">
      <div class="overlayHeader">
        <h2>Jump to</h2>
        <button class="closeBtn" id="closeOverlay" type="button">Close</button>
      </div>
      <div class="overlayNav" id="overlayNav" tabindex="0" aria-label="Question list (overlay)">
        <div class="navListInner" id="overlayNavInner"></div>
      </div>
    </div>
  </div>

  <script>
    (function () {
      const $ = (sel, root = document) => root.querySelector(sel);
      const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));

      const paperSel = $("#paperSel");
      const paperEl = $("#paper");
      const navListInner = $("#navListInner");
      const overlayNavInner = $("#overlayNavInner");
      const overlay = $("#navOverlay");
      const jumpBtn = $("#jumpBtn");
      const closeOverlay = $("#closeOverlay");

      let lastActiveElement = null;

      function slugifyLabel(label) {
        // Turn "18(a)(i)" into "18-a-i"
        return String(label)
          .replace(/\s+/g, "")
          .replace(/[()]/g, "")
          .replace(/[^a-zA-Z0-9]+/g, "-")
          .replace(/-+/g, "-")
          .replace(/^-|-$/g, "")
          .toLowerCase();
      }

      function el(tag, attrs = {}, children = []) {
        const node = document.createElement(tag);
        for (const [k, v] of Object.entries(attrs)) {
          if (k === "class") node.className = v;
          else if (k === "html") node.innerHTML = v;
          else if (k.startsWith("on") && typeof v === "function") node.addEventListener(k.slice(2), v);
          else if (v === null || v === undefined) { }
          else node.setAttribute(k, String(v));
        }
        for (const c of children) {
          if (c === null || c === undefined) continue;
          if (typeof c === "string") node.appendChild(document.createTextNode(c));
          else node.appendChild(c);
        }
        return node;
      }

      function texInline(tex) {
        return el("span", { class: "mathInline", "data-tex": tex, "data-display": "inline" }, [tex]);
      }
      function texBlock(tex) {
        return el("div", { class: "mathBlock", "data-tex": tex, "data-display": "block" }, [tex]);
      }

      // Inline SVG diagram templates (grayscale)
      function makeDiagram(type) {
        const common = 'stroke="#111" fill="none" stroke-width="2"';
        const light = 'stroke="#666" fill="none" stroke-width="1.5"';
        const labelStyle = 'font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; font-size: 12px; fill:#111;';
        if (type === "geometry") {
          return `
            <svg viewBox="0 0 320 200" aria-label="Geometry diagram" role="img">
              <circle cx="240" cy="60" r="36" ${common}></circle>
              <path d="M40 160 L150 40 L260 160 Z" ${common}></path>
              <path d="M150 40 L150 160" ${light}></path>
              <text x="140" y="32" style="${labelStyle}">A</text>
              <text x="28" y="172" style="${labelStyle}">B</text>
              <text x="268" y="172" style="${labelStyle}">C</text>
              <text x="228" y="26" style="${labelStyle}">O</text>
              <text x="258" y="66" style="${labelStyle}">r</text>
            </svg>
          `;
        }
        if (type === "bars") {
          return `
            <svg viewBox="0 0 320 200" aria-label="Ratio bars diagram" role="img">
              <rect x="30" y="50" width="240" height="26" ${common}></rect>
              <line x1="110" y1="50" x2="110" y2="76" ${light}></line>
              <line x1="190" y1="50" x2="190" y2="76" ${light}></line>
              <rect x="30" y="110" width="200" height="26" ${common}></rect>
              <line x1="96" y1="110" x2="96" y2="136" ${light}></line>
              <line x1="162" y1="110" x2="162" y2="136" ${light}></line>
              <text x="30" y="40" style="${labelStyle}">Bar 1</text>
              <text x="30" y="100" style="${labelStyle}">Bar 2</text>
            </svg>
          `;
        }
        if (type === "grid") {
          return `
            <svg viewBox="0 0 320 200" aria-label="Coordinate grid diagram" role="img">
              <rect x="40" y="20" width="240" height="160" ${light}></rect>
              ${Array.from({ length: 7 }).map((_, i) => {
            const x = 40 + i * 40;
            return `<line x1="${x}" y1="20" x2="${x}" y2="180" ${light}></line>`;
          }).join("")}
              ${Array.from({ length: 5 }).map((_, i) => {
            const y = 20 + i * 40;
            return `<line x1="40" y1="${y}" x2="280" y2="${y}" ${light}></line>`;
          }).join("")}
              <line x1="40" y1="180" x2="280" y2="180" ${common}></line>
              <line x1="40" y1="180" x2="40" y2="20" ${common}></line>
              <circle cx="200" cy="100" r="4" fill="#111"></circle>
              <circle cx="120" cy="140" r="4" fill="#111"></circle>
              <path d="M120 140 L200 100" ${common}></path>
              <text x="206" y="96" style="${labelStyle}">P</text>
              <text x="126" y="136" style="${labelStyle}">Q</text>
            </svg>
          `;
        }
        // table-like grid
        return `
          <svg viewBox="0 0 320 200" aria-label="Table diagram" role="img">
            <rect x="60" y="40" width="200" height="120" ${common}></rect>
            <line x1="60" y1="80" x2="260" y2="80" ${light}></line>
            <line x1="60" y1="120" x2="260" y2="120" ${light}></line>
            <line x1="126" y1="40" x2="126" y2="160" ${light}></line>
            <line x1="192" y1="40" x2="192" y2="160" ${light}></line>
            <text x="68" y="34" style="${labelStyle}">Grid</text>
          </svg>
        `;
      }

      function makeSolutionDetails(sd, openByDefault) {
        // sd: { preview, keepInMind?: nodes[], formulas?: nodes[], working?: nodes[], alternative?: nodes[] }
        const details = el("details", { class: "sd" + (openByDefault ? "" : ""), ...(openByDefault ? { open: "" } : {}) });

        const toggleText = el("span", { class: "sdToggleText", "data-toggletext": "" }, [openByDefault ? "Hide working" : "Show working"]);
        const toggleWrap = el("span", { class: "sdToggle" }, [toggleText]);

        const preview = el("span", { class: "sdPreview" }, [sd.preview || ""]);
        const sumRow = el("span", { class: "sdRow" }, [toggleWrap, preview]);

        const summary = el("summary", { class: "sdSum" }, [sumRow]);
        details.appendChild(summary);

        const body = el("div", { class: "sdBody" });

        function addBlock(title, contentNodes) {
          if (!contentNodes || !contentNodes.length) return;
          const blk = el("div", { class: "sdBlock" }, [
            el("div", { class: "sdBlockTitle" }, [title]),
            ...contentNodes
          ]);
          body.appendChild(blk);
        }

        addBlock("Keep in mind", sd.keepInMind);
        addBlock("Formulas used", sd.formulas);
        addBlock("Working", sd.working);
        addBlock("Alternative working", sd.alternative);

        details.appendChild(body);

        // Update toggle label on open/close (no cross-question effects)
        details.addEventListener("toggle", () => {
          toggleText.textContent = details.open ? "Hide working" : "Show working";
        });

        return details;
      }

      function qBlock({ label, depth = 0, promptNodes = [], diagramType = null, diagramCaption = "", answerNodes = [], sd = null, sdOpen = false }) {
        const id = "q-" + slugifyLabel(label);

        const qid = el("div", { class: "qid" }, [label]);
        const qtext = el("div", { class: "qtext" }, promptNodes);

        if (diagramType) {
          const d = el("div", { class: "diagramWrap", "data-diagram": diagramType }, []);
          d.innerHTML = makeDiagram(diagramType);
          const cap = diagramCaption ? el("div", { class: "diagramCaption" }, [diagramCaption]) : null;
          qtext.appendChild(d);
          if (cap) qtext.appendChild(cap);
        }

        const prompt = el("div", { class: "qPrompt" }, [qid, qtext]);

        const ans = el("div", { class: "answer" }, [
          el("div", { class: "alabel" }, ["Answer"]),
          el("div", { class: "avalue" }, answerNodes),
        ]);

        const inner = el("div", { class: "qInner" }, [prompt, ans]);

        if (sd) {
          inner.appendChild(makeSolutionDetails(sd, sdOpen));
        }

        const wrap = el("section", { class: "q" + (depth === 1 ? " depth1" : depth === 2 ? " depth2" : depth === 3 ? " depth3" : ""), id }, [
          inner
        ]);

        return { node: wrap, id, label };
      }

      function p(text) {
        return el("p", {}, [text]);
      }

      function makeShortPaper() {
        return {
          key: "short",
          name: "Short paper",
          nav: [],
          content: []
        };
      }

      function makeDatasets() {
        // Helpers for math-heavy lines
        const longWorkingLines = (n) => {
          const lines = [];
          for (let i = 1; i <= n; i++) {
            // varied but predictable stress-test content
            lines.push(texBlock(String.raw`\text{Line ${i}}:\quad 7x + ${i} = ${i + 21}\;\Rightarrow\; x = \frac{${i + 21}-${i}}{7} = \frac{21}{7} = 3`));
            if (i % 6 === 0) {
              lines.push(texBlock(String.raw`\frac{a}{b}=\frac{c}{d}\Rightarrow ad=bc\quad\text{(check step)}`));
            }
          }
          return lines;
        };

        const smallWorking = [
          p("Work carefully through the steps."),
          texBlock(String.raw`12 + 18 = 30`),
          texBlock(String.raw`30 \div 6 = 5`)
        ];

        const altWorkingSample = [
          p("A different route gives the same result."),
          texBlock(String.raw`6 \times 5 = 30`),
          texBlock(String.raw`30 - 18 = 12`)
        ];

        // Short paper (6 questions, mix + one multipart)
        const short = {
          key: "short",
          name: "Short paper",
          structure: [
            {
              type: "questions", items: [
                {
                  label: "1", depth: 0,
                  promptNodes: [p("Calculate"), p(""), el("span", {}, ["", texInline(String.raw`48 \div 6`), ""])],
                  answerNodes: [texInline(String.raw`8`)],
                  sd: { preview: "One short division step.", working: [texBlock(String.raw`48 \div 6 = 8`)] },
                  sdOpen: false
                },
                {
                  label: "2", depth: 0,
                  promptNodes: [p("Work out"), p(""), el("span", {}, ["", texInline(String.raw`3.2 + 1.75`), ""])],
                  answerNodes: [texInline(String.raw`4.95`)],
                  sd: { preview: "Add decimals carefully.", keepInMind: [p("Line up decimal points.")], working: [texBlock(String.raw`3.20 + 1.75 = 4.95`)] },
                  sdOpen: false
                },
                {
                  label: "3", depth: 0,
                  promptNodes: [p("A shop sells pencils for 35p each. What is the cost of 7 pencils?")],
                  answerNodes: [texInline(String.raw`£2.45`)],
                  sd: {
                    preview: "Multiply and convert p to £.", formulas: [texBlock(String.raw`\text{cost}=\text{price}\times\text{quantity}`)], working: [
                      texBlock(String.raw`35 \times 7 = 245\text{ pence}`),
                      texBlock(String.raw`245\text{ pence} = £2.45`)
                    ]
                  },
                  sdOpen: false
                },
                // Multi-part question
                {
                  label: "4", depth: 0,
                  promptNodes: [p("A rectangle has length 9 cm and width 4 cm.")],
                  answerNodes: [p("See parts (a) and (b).")],
                  sd: { preview: "Parts follow below.", working: [p("This parent prompt has sub-questions below.")] },
                  sdOpen: false
                },
                {
                  label: "4a", depth: 1,
                  promptNodes: [p("Find the perimeter.")],
                  answerNodes: [texInline(String.raw`26\text{ cm}`)],
                  sd: {
                    preview: "Perimeter formula.", formulas: [texBlock(String.raw`P=2(l+w)`)], working: [
                      texBlock(String.raw`P = 2(9+4)=2\times 13=26`)
                    ]
                  },
                  sdOpen: false
                },
                {
                  label: "4b", depth: 1,
                  promptNodes: [p("Find the area.")],
                  answerNodes: [texInline(String.raw`36\text{ cm}^2`)],
                  sd: {
                    preview: "Area formula.", formulas: [texBlock(String.raw`A=l\times w`)], working: [
                      texBlock(String.raw`A = 9\times 4 = 36`)
                    ]
                  },
                  sdOpen: false
                },
                {
                  label: "5", depth: 0,
                  promptNodes: [p("Simplify"), p(""), el("span", {}, ["", texInline(String.raw`6x + 3x - 2x`), ""])],
                  answerNodes: [texInline(String.raw`7x`)],
                  sd: {
                    preview: "Collect like terms.", working: [
                      texBlock(String.raw`6x + 3x - 2x = (6+3-2)x = 7x`)
                    ], alternative: altWorkingSample
                  },
                  sdOpen: false
                },
                {
                  label: "6", depth: 0,
                  promptNodes: [p("Solve"), p(""), el("span", {}, ["", texInline(String.raw`2y - 5 = 9`), ""])],
                  answerNodes: [texInline(String.raw`y=7`)],
                  sd: {
                    preview: "Two-line equation.", working: [
                      texBlock(String.raw`2y = 14`),
                      texBlock(String.raw`y = 7`)
                    ]
                  },
                  sdOpen: false
                }
              ]
            }
          ]
        };

        // Standard paper (35 questions; Q26–Q35 long algebra; include deep nesting & extremely long workings for selected)
        function makeStandard(allExpanded) {
          const items = [];

          // Q1–Q17: small/medium
          for (let i = 1; i <= 17; i++) {
            items.push({
              label: String(i),
              depth: 0,
              promptNodes: [
                p(`Question ${i}: Work out the value.`),
                el("p", {}, [texInline(String.raw`${i + 12} + ${i}`)])
              ],
              answerNodes: [texInline(String.raw`${(i + 12) + i}`)],
              sd: {
                preview: "A short calculation.", working: [
                  texBlock(String.raw`${i + 12} + ${i} = ${(i + 12) + i}`)
                ]
              },
              sdOpen: !!allExpanded ? true : false
            });
          }

          // Deep nesting: Q18 parent + subquestions
          items.push({
            label: "18",
            depth: 0,
            promptNodes: [
              p("You are given the expression:"),
              el("p", {}, [texInline(String.raw`3(2x-1) + 4x`)]),
              p("Answer parts (a) and (b).")
            ],
            answerNodes: [p("See parts (a) and (b).")],
            sd: { preview: "Parts below use expansion and solving.", working: [p("This parent prompt has sub-questions below.")] },
            sdOpen: !!allExpanded ? true : false
          });
          items.push({
            label: "18(a)(i)",
            depth: 1,
            promptNodes: [p("Expand and simplify.")],
            answerNodes: [texInline(String.raw`10x-3`)],
            sd: {
              preview: "Expand then collect terms.", working: [
                texBlock(String.raw`3(2x-1)+4x = 6x-3+4x`),
                texBlock(String.raw`= 10x-3`)
              ]
            },
            sdOpen: !!allExpanded ? true : false
          });
          items.push({
            label: "18(a)(ii)",
            depth: 1,
            promptNodes: [p("If the expression equals 27, find x.")],
            answerNodes: [texInline(String.raw`x=3`)],
            sd: {
              preview: "Solve a linear equation.", working: [
                texBlock(String.raw`10x-3=27`),
                texBlock(String.raw`10x=30`),
                texBlock(String.raw`x=3`)
              ]
            },
            sdOpen: !!allExpanded ? true : false
          });
          items.push({
            label: "18(b)",
            depth: 1,
            promptNodes: [p("Work out the value when x = 5.")],
            answerNodes: [texInline(String.raw`47`)],
            sd: {
              preview: "Substitute and simplify.", working: [
                texBlock(String.raw`10x-3 \text{ when } x=5 \Rightarrow 10(5)-3=50-3=47`)
              ]
            },
            sdOpen: !!allExpanded ? true : false
          });

          // Q19–Q25: medium mix
          for (let i = 19; i <= 25; i++) {
            const isFrac = i % 2 === 1;
            items.push({
              label: String(i),
              depth: 0,
              promptNodes: [
                p(`Question ${i}: ${isFrac ? "Simplify the fraction." : "Solve the equation."}`),
                isFrac
                  ? el("p", {}, [texInline(String.raw`\frac{${i + 10}}{${i + 5}}`)])
                  : el("p", {}, [texInline(String.raw`${i - 10}x + 6 = ${i + 2}`)])
              ],
              answerNodes: [
                isFrac ? texInline(String.raw`\frac{${i + 10}}{${i + 5}}`) : texInline(String.raw`x=1`)
              ],
              sd: isFrac
                ? {
                  preview: "A short simplification.", keepInMind: [p("Look for a common factor.")], working: [
                    texBlock(String.raw`\frac{${i + 10}}{${i + 5}} \text{ (simplify if possible)}`)
                  ]
                }
                : {
                  preview: "Two or three steps.", working: [
                    texBlock(String.raw`${i - 10}x = ${i + 2}-6`),
                    texBlock(String.raw`${i - 10}x = ${i - 4}`),
                    texBlock(String.raw`x=1`)
                  ]
                },
              sdOpen: !!allExpanded ? true : false
            });
          }

          // Q26–Q35: long algebra questions, workings collapsed by default (unless expanded dataset)
          for (let i = 26; i <= 35; i++) {
            const veryLong = (i === 30 || i === 33); // extremely long workings (50–60 lines)
            const preview = veryLong ? "Long working (many lines)." : "Long algebra working.";
            const baseWorking = [
              p("Read the steps in order."),
              texBlock(String.raw`\text{Start: } (x+${i - 20})(x-${i - 22}) = x^2 + 2x - ${(i - 20) * (i - 22)}`),
              texBlock(String.raw`\text{Rearrange and simplify where needed.}`)
            ];
            const longLines = veryLong ? longWorkingLines(56) : [
              texBlock(String.raw`x^2 + 2x - ${(i - 20) * (i - 22)} = 0`),
              texBlock(String.raw`x = \frac{-2 \pm \sqrt{4 + 4\cdot ${(i - 20) * (i - 22)}}}{2}`),
              texBlock(String.raw`x = -1 \pm \sqrt{1+ ${(i - 20) * (i - 22)}}`)
            ];

            // Deep nesting inside Q30
            if (i === 30) {
              items.push({
                label: "30",
                depth: 0,
                promptNodes: [
                  p("A function is defined by:"),
                  el("p", {}, [texInline(String.raw`f(x)=x^2+2x-56`)]),
                  p("Answer parts (a) and (b).")
                ],
                answerNodes: [p("See parts (a) and (b).")],
                sd: { preview: "Parts below include long working.", working: [p("This parent prompt has sub-questions below.")] },
                sdOpen: !!allExpanded ? true : false
              });
              items.push({
                label: "30(a)(i)",
                depth: 1,
                promptNodes: [p("Solve f(x)=0.")],
                answerNodes: [texInline(String.raw`x=7 \text{ or } x=-9`)],
                sd: {
                  preview: "Quadratic solving with many steps.",
                  working: [
                    p("Work through the factorisation or quadratic formula."),
                    texBlock(String.raw`x^2+2x-56=0`)
                  ].concat(longWorkingLines(52)),
                  alternative: [
                    p("Alternative: factorise."),
                    texBlock(String.raw`x^2+2x-56=(x+9)(x-7)`),
                    texBlock(String.raw`x=-9 \text{ or } x=7`)
                  ]
                },
                sdOpen: !!allExpanded ? true : false
              });
              items.push({
                label: "30(a)(ii)",
                depth: 1,
                promptNodes: [p("Work out f(3).")],
                answerNodes: [texInline(String.raw`-41`)],
                sd: {
                  preview: "Substitution.", working: [
                    texBlock(String.raw`f(3)=3^2+2(3)-56=9+6-56=-41`)
                  ]
                },
                sdOpen: !!allExpanded ? true : false
              });
              items.push({
                label: "30(b)",
                depth: 1,
                promptNodes: [p("State the axis of symmetry.")],
                answerNodes: [texInline(String.raw`x=-1`)],
                sd: {
                  preview: "Use x = -b/(2a).", formulas: [
                    texBlock(String.raw`x = -\frac{b}{2a}`)
                  ], working: [
                    texBlock(String.raw`x = -\frac{2}{2\cdot 1} = -1`)
                  ]
                },
                sdOpen: !!allExpanded ? true : false
              });
              continue; // skip normal Q30 generation
            }

            items.push({
              label: String(i),
              depth: 0,
              promptNodes: [
                p(`Question ${i}: Solve the equation and show your working.`),
                el("p", {}, [texInline(String.raw`x^2 + 2x - ${(i - 20) * (i - 22)} = 0`)])
              ],
              answerNodes: [texInline(String.raw`x = -1 \pm \sqrt{1+ ${(i - 20) * (i - 22)}}`)],
              sd: {
                preview,
                keepInMind: [p("Take your time. Keep expressions tidy.")],
                formulas: [texBlock(String.raw`x=\frac{-b\pm\sqrt{b^2-4ac}}{2a}`)],
                working: baseWorking.concat(longLines),
                alternative: (i % 3 === 0) ? altWorkingSample : []
              },
              sdOpen: !!allExpanded ? true : false
            });
          }

          return {
            key: allExpanded ? "standard_expanded" : "standard",
            name: allExpanded ? "Standard (Workings Expanded)" : "Standard paper",
            structure: [{ type: "questions", items }]
          };
        }

        // Diagram-heavy paper (20 questions, 8 with diagrams)
        const diagramQuestions = new Set([3, 5, 7, 9, 12, 14, 16, 19]);
        const diagrams = ["geometry", "bars", "grid", "table"];
        const diagram = {
          key: "diagram",
          name: "Diagram-heavy paper",
          structure: [{
            type: "questions",
            items: Array.from({ length: 20 }, (_, idx) => {
              const n = idx + 1;
              const hasD = diagramQuestions.has(n);
              const dType = hasD ? diagrams[n % diagrams.length] : null;
              return {
                label: String(n),
                depth: 0,
                promptNodes: [
                  p(`Question ${n}: Use the information shown.`),
                  hasD ? p("Refer to the diagram.") : p("No diagram for this question."),
                  el("p", {}, [texInline(String.raw`${n + 4} \times 3`)])
                ],
                diagramType: dType,
                diagramCaption: hasD ? "Diagram is part of the question." : "",
                answerNodes: [texInline(String.raw`${(n + 4) * 3}`)],
                sd: {
                  preview: hasD ? "Use the diagram, then calculate." : "A short multiplication.",
                  working: [
                    p(hasD ? "Identify the needed values, then compute." : "Multiply."),
                    texBlock(String.raw`${n + 4}\times 3 = ${(n + 4) * 3}`)
                  ]
                },
                sdOpen: false
              };
            })
          }]
        };

        // Sectioned paper (original structure)
        const sectioned = {
          key: "sectioned",
          name: "Sectioned paper",
          structure: [
            {
              type: "section",
              label: "A",
              items: (function () {
                const items = [];
                for (let i = 1; i <= 35; i++) {
                  items.push({
                    label: String(i),
                    depth: 0,
                    promptNodes: [
                      p(`Section A: Question ${i}.`),
                      el("p", {}, [texInline(String.raw`${i}+${i + 1}`)])
                    ],
                    answerNodes: [texInline(String.raw`${i + (i + 1)}`)],
                    sd: { preview: "Short working.", working: [texBlock(String.raw`${i}+${i + 1}=${i + (i + 1)}`)] },
                    sdOpen: false
                  });
                }
                return items;
              })()
            },
            {
              type: "section",
              label: "B",
              items: Array.from({ length: 8 }, (_, k) => {
                const q = k + 1;
                const label = String(q);
                return {
                  label,
                  depth: 0,
                  promptNodes: [
                    p(`Section B: Question ${label}.`),
                    p("Solve the equation."),
                    el("p", {}, [texInline(String.raw`${q + 3}x - 4 = ${q + 11}`)])
                  ],
                  answerNodes: [texInline(String.raw`x= \frac{${q + 15}}{${q + 3}}`)],
                  sd: {
                    preview: "Medium working.",
                    working: [
                      texBlock(String.raw`${q + 3}x = ${q + 11}+4`),
                      texBlock(String.raw`${q + 3}x = ${q + 15}`),
                      texBlock(String.raw`x=\frac{${q + 15}}{${q + 3}}`)
                    ]
                  },
                  sdOpen: false
                };
              })
            },
            {
              type: "section",
              label: "C",
              items: Array.from({ length: 6 }, (_, k) => {
                const n = k + 1;
                const qLabel = String(n);
                return {
                  label: qLabel,
                  depth: 0,
                  promptNodes: [
                    p(`Section C: Question ${qLabel}. Show your working.`),
                    el("p", {}, [texInline(String.raw`(x+${n})(x-${n + 2}) = 0`)])
                  ],
                  answerNodes: [texInline(String.raw`x=-${n}\ \text{ or }\ x=${n + 2}`)],
                  sd: {
                    preview: "Very long working (collapsed by default).",
                    keepInMind: [p("Section C questions have long workings.")],
                    formulas: [texBlock(String.raw`ab=0\Rightarrow a=0 \text{ or } b=0`)],
                    working: [
                      texBlock(String.raw`(x+${n})(x-${n + 2})=0`),
                      texBlock(String.raw`x+${n}=0 \text{ or } x-${n + 2}=0`),
                      texBlock(String.raw`x=-${n} \text{ or } x=${n + 2}`)
                    ].concat(longWorkingLines(52)),
                    alternative: []
                  },
                  sdOpen: false
                };
              })
            }
          ]
        };

        const standard = makeStandard(false);
        const standardExpanded = makeStandard(true);

        return [short, standard, diagram, sectioned, standardExpanded];
      }

      const DATASETS = makeDatasets();

      function buildSelector() {
        paperSel.innerHTML = "";
        for (const ds of DATASETS) {
          paperSel.appendChild(el("option", { value: ds.key }, [ds.name]));
        }
        paperSel.value = "short";
      }

      function clearActiveNav() {
        $$(".navItem[aria-current='true']", navListInner).forEach(a => a.removeAttribute("aria-current"));
        $$(".navItem[aria-current='true']", overlayNavInner).forEach(a => a.removeAttribute("aria-current"));
      }

      function buildNav(navEntries) {
        navListInner.innerHTML = "";
        overlayNavInner.innerHTML = "";

        function addTo(container, entry, isOverlay) {
          if (entry.type === "sep") {
            container.appendChild(el("div", { class: "navSep" }, [entry.label]));
            return;
          }
          const a = el("a", { class: "navItem", href: "#" + entry.id }, [entry.label]);
          a.addEventListener("click", (e) => {
            e.preventDefault();
            // no smooth scrolling (no motion effects)
            const target = document.getElementById(entry.id);
            if (target) target.scrollIntoView({ behavior: "auto", block: "start" });
            clearActiveNav();
            a.setAttribute("aria-current", "true");

            // mirror highlight in the other nav
            const otherRoot = isOverlay ? navListInner : overlayNavInner;
            const other = otherRoot.querySelector(`a.navItem[href="#${entry.id}"]`);
            if (other) other.setAttribute("aria-current", "true");

            closeNavOverlay();
          });
          container.appendChild(a);
        }

        for (const entry of navEntries) {
          addTo(navListInner, entry, false);
          addTo(overlayNavInner, entry, true);
        }
      }

      function buildPaper(ds) {
        paperEl.innerHTML = "";
        const navEntries = [];

        function addQuestionBlock(item) {
          const qb = qBlock({
            label: item.label,
            depth: item.depth || 0,
            promptNodes: item.promptNodes || [],
            diagramType: item.diagramType || null,
            diagramCaption: item.diagramCaption || "",
            answerNodes: item.answerNodes || [],
            sd: item.sd || null,
            sdOpen: !!item.sdOpen
          });
          paperEl.appendChild(qb.node);
          navEntries.push({ type: "item", label: qb.label, id: qb.id });
        }

        for (const part of ds.structure) {
          if (part.type === "questions") {
            for (const item of part.items) {
              addQuestionBlock(item);
            }
          } else if (part.type === "section") {
            // section header in content
            paperEl.appendChild(el("div", { class: "sectionHdr" }, [part.label]));
            // section separator in nav (non-clickable)
            navEntries.push({ type: "sep", label: part.label });
            for (const item of part.items) {
              addQuestionBlock(item);
            }
          }
        }

        buildNav(navEntries);

        // Render KaTeX if available, otherwise leave raw text
        renderKatexSafe();

        // Track active question in nav using IntersectionObserver (quiet orientation aid only)
        setupActiveObserver(navEntries);
      }

      function renderKatexSafe() {
        const katexReady = !!(window.katex && typeof window.katex.render === "function");
        const nodes = $$("[data-tex]", paperEl);

        if (!katexReady) {
          // fallback: keep plain text already present
          return;
        }

        for (const n of nodes) {
          const tex = n.getAttribute("data-tex") || "";
          const display = n.getAttribute("data-display") === "block";
          try {
            window.katex.render(tex, n, {
              displayMode: display,
              throwOnError: false,
              strict: "ignore"
            });
          } catch (_e) {
            // fallback: keep text (already there)
            n.textContent = tex;
          }
        }
      }

      let observer = null;
      function setupActiveObserver(navEntries) {
        if (observer) observer.disconnect();

        const ids = navEntries.filter(e => e.type === "item").map(e => e.id);
        const targets = ids.map(id => document.getElementById(id)).filter(Boolean);
        if (!targets.length) return;

        observer = new IntersectionObserver((entries) => {
          // pick the entry closest to top and visible
          const visible = entries
            .filter(e => e.isIntersecting)
            .sort((a, b) => a.boundingClientRect.top - b.boundingClientRect.top);

          if (!visible.length) return;
          const id = visible[0].target.id;

          // update current (quiet underline)
          clearActiveNav();
          const a1 = navListInner.querySelector(`a.navItem[href="#${id}"]`);
          const a2 = overlayNavInner.querySelector(`a.navItem[href="#${id}"]`);
          if (a1) a1.setAttribute("aria-current", "true");
          if (a2) a2.setAttribute("aria-current", "true");
        }, {
          root: null,
          threshold: [0.15],
          rootMargin: "-10% 0px -70% 0px"
        });

        targets.forEach(t => observer.observe(t));
      }

      function openNavOverlay() {
        lastActiveElement = document.activeElement;
        overlay.setAttribute("aria-hidden", "false");
        // prevent background scroll via body lock without creating nested scroll regions
        document.body.style.overflow = "hidden";
        closeOverlay.focus();
      }

      function closeNavOverlay() {
        overlay.setAttribute("aria-hidden", "true");
        document.body.style.overflow = "";
        if (lastActiveElement && typeof lastActiveElement.focus === "function") {
          lastActiveElement.focus();
        }
      }

      function isOverlayVisible() {
        return overlay.getAttribute("aria-hidden") === "false";
      }

      // Focus trap for overlay (keyboard accessibility)
      function trapFocus(e) {
        if (!isOverlayVisible()) return;
        if (e.key === "Escape") {
          e.preventDefault();
          closeNavOverlay();
          return;
        }
        if (e.key !== "Tab") return;

        const focusable = $$("button, [href], select, [tabindex]:not([tabindex='-1'])", overlay)
          .filter(x => !x.hasAttribute("disabled") && x.getAttribute("aria-hidden") !== "true");
        if (!focusable.length) return;

        const first = focusable[0];
        const last = focusable[focusable.length - 1];

        if (e.shiftKey && document.activeElement === first) {
          e.preventDefault();
          last.focus();
        } else if (!e.shiftKey && document.activeElement === last) {
          e.preventDefault();
          first.focus();
        }
      }

      // Events
      paperSel.addEventListener("change", () => {
        const ds = DATASETS.find(d => d.key === paperSel.value) || DATASETS[0];
        buildPaper(ds);
      });

      jumpBtn.addEventListener("click", () => {
        // Overlay only needed on smaller screens, but harmless on desktop too
        openNavOverlay();
      });

      closeOverlay.addEventListener("click", closeNavOverlay);

      overlay.addEventListener("click", (e) => {
        // Click outside inner content closes
        if (e.target === overlay) closeNavOverlay();
      });

      document.addEventListener("keydown", trapFocus);

      // Initial load
      buildSelector();
      buildPaper(DATASETS.find(d => d.key === "short"));

      // If KaTeX loads after DOM, render once more safely
      window.addEventListener("load", () => {
        renderKatexSafe();
      });
    })();
  </script>
</body>

</html>