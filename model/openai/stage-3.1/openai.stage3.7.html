<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RTQ – Maths Paper Solution Viewer (Grayscale Stress Harness)</title>

  <!-- KaTeX (CDN) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css"
    integrity="sha384-nB0miv6/jRmo5v7Y4m9zQwGv0QWQm4bHq7l7yYfXgY0pWmZ6o0mQf4rZVZz9m3p6" crossorigin="anonymous">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"
    integrity="sha384-7zkQWk1m3r2B0o1m0q5o0uQWc7Q7l0kzvOe0bq2q6t3m7wzvQpZ1hW9m0iCqgKx3"
    crossorigin="anonymous"></script>

  <style>
    :root {
      --bg: #f6f6f6;
      --paper: #ffffff;
      --ink: #1a1a1a;
      --muted: #5a5a5a;
      --quiet: #7a7a7a;
      --hairline: #e2e2e2;
      --focus: #000000;
      --max: 1120px;
      --navw: 140px;
      --gutter: 20px;
      --headerH: 72px;
      --tap: 44px;
      --radius: 10px;
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      height: 100%;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--ink);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height: 1.35;
    }

    /* Top controls aligned to the same centered frame */
    .topbar {
      position: sticky;
      top: 0;
      z-index: 30;
      background: rgba(246, 246, 246, 0.92);
      backdrop-filter: blur(6px);
      border-bottom: 1px solid var(--hairline);
    }

    .frame {
      max-width: var(--max);
      margin: 0 auto;
      padding: 0 var(--gutter);
    }

    .controls {
      height: var(--headerH);
      display: flex;
      align-items: center;
      gap: 14px;
      justify-content: space-between;
    }

    .controls-left {
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 0;
    }

    .controls-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    label {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      color: var(--muted);
      font-size: 14px;
      white-space: nowrap;
    }

    select {
      height: 38px;
      border: 1px solid var(--hairline);
      border-radius: 8px;
      padding: 0 10px;
      background: #fff;
      color: var(--ink);
      font-size: 14px;
    }

    .meta {
      font-size: 13px;
      color: var(--muted);
      white-space: nowrap;
    }

    .btn {
      height: 38px;
      padding: 0 12px;
      border: 1px solid var(--hairline);
      border-radius: 8px;
      background: #fff;
      color: var(--ink);
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      min-width: 0;
    }

    .btn:focus-visible {
      outline: 2px solid var(--focus);
      outline-offset: 2px;
    }

    /* Desktop layout: nav + content inside the same centered frame */
    .layout {
      display: grid;
      grid-template-columns: var(--navw) 1fr;
      gap: 26px;
      padding: 18px var(--gutter) 70px;
      max-width: var(--max);
      margin: 0 auto;
    }

    nav {
      align-self: start;
    }

    /* Sticky nav rail */
    .nav-rail {
      position: sticky;
      top: calc(var(--headerH) + 14px);
      padding-top: 6px;
    }

    /* The nav list may scroll independently if it exceeds viewport height */
    .nav-scroller {
      max-height: calc(100vh - var(--headerH) - 28px);
      overflow-y: auto;
      padding: 4px 0 10px;
      scrollbar-width: none;
      /* Firefox */
      -ms-overflow-style: none;
      /* legacy */
    }

    .nav-scroller::-webkit-scrollbar {
      display: none;
    }

    .nav-title {
      font-size: 12px;
      color: var(--quiet);
      letter-spacing: 0.02em;
      text-transform: uppercase;
      margin: 0 0 10px 0;
    }

    .nav-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: grid;
      gap: 6px;
    }

    .nav-sep {
      margin: 10px 0 6px;
      font-size: 12px;
      color: var(--quiet);
      letter-spacing: 0.02em;
      text-transform: uppercase;
    }

    .nav-link {
      display: inline-flex;
      align-items: center;
      height: 30px;
      padding: 0 8px;
      border-radius: 8px;
      text-decoration: none;
      color: var(--muted);
      font-size: 14px;
    }

    .nav-link:hover {
      color: var(--ink);
      background: #efefef;
    }

    .nav-link:focus-visible {
      outline: 2px solid var(--focus);
      outline-offset: 2px;
    }

    .nav-link[aria-current="true"] {
      color: var(--ink);
      background: #eaeaea;
    }

    /* Paper content */
    main {
      background: var(--paper);
      border-radius: var(--radius);
      padding: 22px 22px 30px;
      box-shadow: 0 0 0 1px var(--hairline);
    }

    .paper-title {
      margin: 0 0 8px 0;
      font-size: 18px;
      color: var(--ink);
      font-weight: 650;
    }

    .paper-sub {
      margin: 0 0 18px 0;
      font-size: 13px;
      color: var(--muted);
    }

    /* Spacing rhythm: biggest between top-level questions */
    .question {
      padding: 0;
      margin: 0 0 28px 0;
    }

    .question:last-child {
      margin-bottom: 0;
    }

    /* Indentation for nesting (no borders/cards) */
    .q-wrap {
      padding-left: 0;
    }

    .depth-1 {
      padding-left: 18px;
    }

    .depth-2 {
      padding-left: 36px;
    }

    .depth-3 {
      padding-left: 54px;
    }

    .q-head {
      display: flex;
      align-items: baseline;
      gap: 10px;
      margin-bottom: 8px;
    }

    .qid {
      font-weight: 700;
      font-size: 16px;
      color: var(--ink);
      flex: 0 0 auto;
      min-width: 32px;
      text-align: right;
    }

    .q-prompt {
      font-size: 16px;
      color: var(--ink);
      margin: 0;
    }

    .q-body {
      margin-left: 42px;
      /* aligns under prompt after number */
      display: grid;
      gap: 10px;
      /* tighter within-question spacing */
    }

    .answer {
      display: grid;
      gap: 6px;
    }

    .label {
      font-size: 13px;
      color: var(--muted);
      font-weight: 600;
    }

    .answer .value {
      font-size: 15px;
      color: var(--ink);
    }

    /* Disclosure control */
    .disclosure {
      display: grid;
      gap: 6px;
    }

    .toggle {
      height: var(--tap);
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 0 12px;
      border: 1px solid var(--hairline);
      border-radius: 10px;
      background: #fff;
      color: var(--ink);
      font-size: 14px;
      cursor: pointer;
      width: fit-content;
      max-width: 100%;
    }

    .toggle:focus-visible {
      outline: 2px solid var(--focus);
      outline-offset: 2px;
    }

    .chev {
      width: 10px;
      height: 10px;
      border-right: 2px solid var(--muted);
      border-bottom: 2px solid var(--muted);
      transform: rotate(-45deg);
      transition: transform 120ms linear;
      flex: 0 0 auto;
    }

    .toggle[aria-expanded="true"] .chev {
      transform: rotate(45deg);
    }

    .toggle-text {
      white-space: nowrap;
    }

    /* Minimal preview (1–2 lines) when collapsed */
    .preview {
      color: var(--quiet);
      font-size: 13px;
      max-width: 100%;
    }

    .preview .preview-label {
      color: var(--muted);
      font-weight: 600;
      margin-right: 6px;
    }

    .preview .preview-line {
      display: inline;
    }

    .details {
      display: grid;
      gap: 12px;
      padding-top: 4px;
    }

    .details[hidden] {
      display: none;
    }

    .block {
      display: grid;
      gap: 6px;
    }

    .block-title {
      font-size: 13px;
      color: var(--muted);
      font-weight: 700;
    }

    .block-body {
      color: var(--ink);
      font-size: 14px;
      display: grid;
      gap: 8px;
    }

    /* KaTeX overflow safety */
    .math-block {
      overflow-x: auto;
      overflow-y: hidden;
      max-width: 100%;
      padding-bottom: 2px;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .math-block::-webkit-scrollbar {
      display: none;
    }

    .math-inline {
      white-space: nowrap;
    }

    /* Diagrams: inline SVG in question block */
    .diagram {
      max-width: 520px;
      width: 100%;
    }

    .diagram svg {
      width: 100%;
      height: auto;
      display: block;
    }

    /* Mobile / Tablet */
    @media (max-width: 900px) {
      :root {
        --navw: 120px;
      }

      main {
        padding: 18px 16px 26px;
      }

      .q-body {
        margin-left: 40px;
      }

      .qid {
        min-width: 28px;
      }
    }

    @media (max-width: 760px) {
      .layout {
        grid-template-columns: 1fr;
        gap: 0;
        padding-top: 10px;
      }

      nav {
        display: none;
      }

      .controls-right .meta {
        display: none;
      }
    }

    /* Drawer (mobile nav) */
    .drawer {
      position: fixed;
      inset: 0;
      z-index: 60;
      display: none;
    }

    .drawer[aria-hidden="false"] {
      display: block;
    }

    .drawer-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.22);
    }

    .drawer-panel {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
      width: min(340px, 92vw);
      background: #fff;
      box-shadow: -1px 0 0 var(--hairline);
      display: grid;
      grid-template-rows: auto 1fr;
    }

    .drawer-head {
      padding: 14px 14px 10px;
      border-bottom: 1px solid var(--hairline);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .drawer-head h2 {
      margin: 0;
      font-size: 14px;
      color: var(--ink);
      font-weight: 700;
    }

    .drawer-close {
      height: 38px;
      padding: 0 10px;
      border: 1px solid var(--hairline);
      border-radius: 8px;
      background: #fff;
      cursor: pointer;
      font-size: 14px;
    }

    .drawer-close:focus-visible {
      outline: 2px solid var(--focus);
      outline-offset: 2px;
    }

    .drawer-body {
      overflow-y: auto;
      padding: 12px 10px 14px;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .drawer-body::-webkit-scrollbar {
      display: none;
    }

    .drawer-body .nav-list {
      gap: 8px;
    }

    .drawer-body .nav-link {
      height: 42px;
      /* touch comfort */
      font-size: 16px;
    }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="frame">
      <div class="controls" role="region" aria-label="Paper controls">
        <div class="controls-left">
          <label for="paperSelect">
            Paper
            <select id="paperSelect" aria-label="Paper selector"></select>
          </label>

          <button id="jumpBtn" class="btn" type="button" aria-haspopup="dialog" aria-controls="navDrawer">
            Jump to
            <span aria-hidden="true"
              style="display:inline-block;width:8px;height:8px;border-right:2px solid #5a5a5a;border-bottom:2px solid #5a5a5a;transform:rotate(45deg)"></span>
          </button>
        </div>

        <div class="controls-right">
          <span id="paperMeta" class="meta" aria-live="polite"></span>
        </div>
      </div>
    </div>
  </header>

  <div class="layout" aria-label="Paper layout">
    <nav class="nav-rail" aria-label="Question navigation">
      <div class="nav-title">Questions</div>
      <div class="nav-scroller" id="navScroller">
        <div id="navContent"></div>
      </div>
    </nav>

    <main id="paperMain" aria-label="Paper content">
      <!-- rendered -->
    </main>
  </div>

  <!-- Mobile Drawer -->
  <div id="navDrawer" class="drawer" role="dialog" aria-modal="true" aria-hidden="true"
    aria-label="Question navigation drawer">
    <div class="drawer-backdrop" data-close="true"></div>
    <div class="drawer-panel" role="document">
      <div class="drawer-head">
        <h2>Jump to</h2>
        <button class="drawer-close" type="button" data-close="true">Close</button>
      </div>
      <div class="drawer-body">
        <div id="navDrawerContent"></div>
      </div>
    </div>
  </div>

  <script>
    // -----------------------------
    // Data helpers (rendered as a single linear document)
    // -----------------------------
    function t(text) { return { kind: "text", text }; }
    function mi(tex) { return { kind: "mathInline", tex }; }
    function mb(tex) { return { kind: "mathBlock", tex }; }

    function diagram(type) {
      return { kind: "diagram", type };
    }

    function firstPreviewLine(q) {
      // Preview should be minimal (1–2 lines). We show 1 line from the Working only.
      if (!q.solution || !q.solution.working || !q.solution.working.length) return null;
      const line = q.solution.working.find(p => p.kind === "text" || p.kind === "mathInline" || p.kind === "mathBlock");
      return line || null;
    }

    function qDepthFromId(id) {
      // Depth inferred from nesting parentheses: 0 = top-level, 1 = (a), 2 = (a)(i), etc.
      const matches = id.match(/\([^)]+\)/g);
      const depth = matches ? matches.length : 0;
      return Math.min(depth, 3);
    }

    function slugId(id) {
      return "q-" + id
        .replaceAll(" ", "")
        .replaceAll("(", "-")
        .replaceAll(")", "")
        .replaceAll(")", "")
        .replaceAll(")", "")
        .replaceAll("/", "-")
        .replaceAll(".", "-")
        .replaceAll("—", "-")
        .replaceAll("–", "-")
        .replaceAll(":", "-");
    }

    // -----------------------------
    // Diagram SVGs (reused types)
    // -----------------------------
    function svgGeometry() {
      return `
      <svg viewBox="0 0 520 260" xmlns="http://www.w3.org/2000/svg" aria-label="Geometry diagram (placeholder)" role="img">
        <rect x="1" y="1" width="518" height="258" fill="none" stroke="#d8d8d8"/>
        <polygon points="120,210 260,50 400,210" fill="none" stroke="#333" stroke-width="2"/>
        <circle cx="260" cy="50" r="3" fill="#333"/>
        <circle cx="120" cy="210" r="3" fill="#333"/>
        <circle cx="400" cy="210" r="3" fill="#333"/>
        <text x="252" y="36" font-size="14" fill="#333">A</text>
        <text x="104" y="234" font-size="14" fill="#333">B</text>
        <text x="408" y="234" font-size="14" fill="#333">C</text>
        <text x="250" y="150" font-size="12" fill="#666">AB = 8 cm</text>
        <text x="300" y="170" font-size="12" fill="#666">AC = 10 cm</text>
      </svg>`;
    }

    function svgRatioBars() {
      return `
      <svg viewBox="0 0 520 200" xmlns="http://www.w3.org/2000/svg" aria-label="Ratio bars diagram (placeholder)" role="img">
        <rect x="1" y="1" width="518" height="198" fill="none" stroke="#d8d8d8"/>
        <text x="20" y="34" font-size="14" fill="#333">A</text>
        <rect x="60" y="20" width="400" height="26" fill="none" stroke="#333"/>
        <line x1="160" y1="20" x2="160" y2="46" stroke="#333"/>
        <line x1="260" y1="20" x2="260" y2="46" stroke="#333"/>
        <line x1="360" y1="20" x2="360" y2="46" stroke="#333"/>
        <text x="20" y="94" font-size="14" fill="#333">B</text>
        <rect x="60" y="80" width="300" height="26" fill="none" stroke="#333"/>
        <line x1="160" y1="80" x2="160" y2="106" stroke="#333"/>
        <line x1="260" y1="80" x2="260" y2="106" stroke="#333"/>
        <text x="60" y="160" font-size="12" fill="#666">Each segment represents 1 part</text>
      </svg>`;
    }

    function svgCoordinateGrid() {
      return `
      <svg viewBox="0 0 520 260" xmlns="http://www.w3.org/2000/svg" aria-label="Coordinate grid diagram (placeholder)" role="img">
        <rect x="1" y="1" width="518" height="258" fill="none" stroke="#d8d8d8"/>
        <g stroke="#e2e2e2" stroke-width="1">
          ${Array.from({ length: 11 }, (_, i) => `<line x1="${60 + i * 40}" y1="30" x2="${60 + i * 40}" y2="230"/>`).join("")}
          ${Array.from({ length: 6 }, (_, i) => `<line x1="60" y1="${30 + i * 40}" x2="460" y2="${30 + i * 40}"/>`).join("")}
        </g>
        <g stroke="#333" stroke-width="2">
          <line x1="60" y1="230" x2="460" y2="230"/>
          <line x1="60" y1="230" x2="60" y2="30"/>
        </g>
        <circle cx="140" cy="190" r="4" fill="#333"/>
        <circle cx="340" cy="110" r="4" fill="#333"/>
        <line x1="140" y1="190" x2="340" y2="110" stroke="#333" stroke-width="2"/>
        <text x="128" y="210" font-size="12" fill="#666">(2,1)</text>
        <text x="328" y="130" font-size="12" fill="#666">(7,4)</text>
      </svg>`;
    }

    function svgTableGrid() {
      return `
      <svg viewBox="0 0 520 220" xmlns="http://www.w3.org/2000/svg" aria-label="Table diagram (placeholder)" role="img">
        <rect x="1" y="1" width="518" height="218" fill="none" stroke="#d8d8d8"/>
        <g fill="none" stroke="#333" stroke-width="2">
          <rect x="90" y="40" width="340" height="140"/>
          <line x1="90" y1="86.7" x2="430" y2="86.7"/>
          <line x1="90" y1="133.4" x2="430" y2="133.4"/>
          <line x1="203.3" y1="40" x2="203.3" y2="180"/>
          <line x1="316.6" y1="40" x2="316.6" y2="180"/>
        </g>
        <text x="110" y="70" font-size="12" fill="#666">Mon</text>
        <text x="225" y="70" font-size="12" fill="#666">Tue</text>
        <text x="340" y="70" font-size="12" fill="#666">Wed</text>
        <text x="110" y="118" font-size="12" fill="#666">4</text>
        <text x="225" y="118" font-size="12" fill="#666">6</text>
        <text x="340" y="118" font-size="12" fill="#666">?</text>
        <text x="110" y="164" font-size="12" fill="#666">3</text>
        <text x="225" y="164" font-size="12" fill="#666">2</text>
        <text x="340" y="164" font-size="12" fill="#666">5</text>
      </svg>`;
    }

    function diagramSVG(type) {
      switch (type) {
        case "geometry": return svgGeometry();
        case "ratio": return svgRatioBars();
        case "grid": return svgCoordinateGrid();
        case "table": return svgTableGrid();
        default: return svgGeometry();
      }
    }

    // -----------------------------
    // Paper datasets
    // -----------------------------
    function makeShortPaper() {
      return {
        id: "short",
        label: "Short paper",
        title: "Short paper",
        subtitle: "6 questions • mix of short arithmetic + one multi-part question",
        sections: null,
        defaults: { workingsExpanded: false },
        questions: [
          {
            id: "1",
            prompt: [t("Calculate "), mi("7\\times 8"), t(".")],
            answer: [mi("56")],
            solution: {
              keepInMind: [],
              formulasUsed: [],
              working: [t("Multiply: "), mi("7\\times 8 = 56")],
              alternatives: []
            }
          },
          {
            id: "2",
            prompt: [t("Write "), mi("\\frac{3}{4}"), t(" as a decimal.")],
            answer: [mi("0.75")],
            solution: {
              keepInMind: [t("A fraction is a division.")],
              formulasUsed: [],
              working: [mi("\\frac{3}{4} = 3\\div 4 = 0.75")],
              alternatives: []
            }
          },
          {
            id: "3",
            prompt: [t("A box has 24 pencils. Half are blue. How many are blue?")],
            answer: [mi("12")],
            solution: {
              keepInMind: [t("Half means divide by 2.")],
              formulasUsed: [],
              working: [mi("24\\div 2 = 12")],
              alternatives: []
            }
          },
          {
            id: "4",
            prompt: [t("Simplify "), mi("18\\div 6 + 5"), t(".")],
            answer: [mi("8")],
            solution: {
              keepInMind: [t("Do division before addition.")],
              formulasUsed: [],
              working: [mi("18\\div 6 = 3"), mi("3+5 = 8")],
              alternatives: []
            }
          },
          {
            id: "5(a)",
            prompt: [t("Solve "), mi("x + 7 = 19"), t(".")],
            answer: [mi("x=12")],
            solution: {
              keepInMind: [],
              formulasUsed: [],
              working: [mi("x = 19-7 = 12")],
              alternatives: []
            }
          },
          {
            id: "5(b)",
            prompt: [t("Now solve "), mi("2x = 24"), t(".")],
            answer: [mi("x=12")],
            solution: {
              keepInMind: [],
              formulasUsed: [],
              working: [mi("x = 24\\div 2 = 12")],
              alternatives: [[t("Divide both sides by 2: "), mi("\\frac{2x}{2} = \\frac{24}{2}")]]
            }
          }
        ]
      };
    }

    function makeStandardPaper(workingsExpanded) {
      // 35 questions, Q26–Q35 long algebra with multiple KaTeX blocks in Solution Details
      const qs = [];
      for (let i = 1; i <= 25; i++) {
        qs.push({
          id: String(i),
          prompt: [
            t("Compute "),
            mi(`${i}+${i + 3}`),
            t(" and write your answer.")
          ],
          answer: [mi(String(i + (i + 3)))],
          solution: {
            keepInMind: (i % 9 === 0) ? [t("Add in a steady way: tens, then ones.")] : [],
            formulasUsed: (i % 11 === 0) ? [t("Addition: "), mi("a+b=b+a")] : [],
            working: [
              mi(`${i}+${i + 3} = ${2 * i + 3}`)
            ],
            alternatives: (i % 7 === 0) ? [
              [t("Count on: start at "), mi(String(i)), t(" and add "), mi(String(i + 3)), t(".")]
            ] : []
          }
        });
      }

      function longAlgebraWorking(n) {
        const lines = [];
        lines.push(t("Start with the expression and simplify step by step:"));
        lines.push(mb(`\\text{Let } E = (x+${n})^2 - (x-${n})^2`));
        lines.push(mb(`E = \\big(x^2 + 2${n}x + ${n * n}\\big) - \\big(x^2 - 2${n}x + ${n * n}\\big)`));
        lines.push(mb(`E = x^2 + 2${n}x + ${n * n} - x^2 + 2${n}x - ${n * n}`));
        lines.push(mb(`E = 4${n}x`));
        lines.push(t("So the simplified form is:"));
        lines.push(mb(`E = ${4 * n}x`));

        // Add a deliberately wide line to trigger overflow on smaller screens.
        lines.push(t("Check with a long expansion (this line may overflow on mobile):"));
        lines.push(mb(`(x+${n})^2 = x^2 + 2\\cdot x\\cdot ${n} + ${n}^2\\quad\\text{and}\\quad (x-${n})^2 = x^2 - 2\\cdot x\\cdot ${n} + ${n}^2`));
        return lines;
      }

      for (let i = 26; i <= 35; i++) {
        const n = i - 20; // 6..15
        const hasKeep = (i === 28 || i === 31 || i === 34);
        const hasFormulas = (i === 29 || i === 33 || i === 35);
        const hasAlt = (i === 30 || i === 32 || i === 35); // include combo on 35
        qs.push({
          id: String(i),
          prompt: [
            t("Simplify "),
            mi(`(x+${n})^2 - (x-${n})^2`),
            t(".")
          ],
          answer: [mi(`${4 * n}x`)],
          solution: {
            keepInMind: hasKeep ? [t("When subtracting brackets, every sign inside the second bracket changes.")] : [],
            formulasUsed: hasFormulas ? [
              t("Difference of squares: "),
              mi("a^2-b^2=(a-b)(a+b)"),
              t(" • Expansion: "),
              mi("(x\\pm n)^2=x^2\\pm 2nx+n^2")
            ] : [],
            working: longAlgebraWorking(n),
            alternatives: hasAlt ? [[
              t("Use difference of squares with "),
              mi("a=x+n"),
              t(" and "),
              mi("b=x-n"),
              t(":"),
              mb(`(a^2-b^2)=(a-b)(a+b) = \\big((x+${n})-(x-${n})\\big)\\big((x+${n})+(x-${n})\\big)`),
              mb(`= (2${n})(2x) = ${4 * n}x`)
            ]] : []
          }
        });
      }

      // Deep nesting examples (add-on)
      // Replace a few prompts with nested ids for stress.
      qs.push({
        id: "18(a)(i)",
        prompt: [t("Find the value of "), mi("3y"), t(" when "), mi("y=7"), t(".")],
        answer: [mi("21")],
        solution: { keepInMind: [], formulasUsed: [], working: [mi("3y=3\\times 7=21")], alternatives: [] }
      });
      qs.push({
        id: "18(a)(ii)",
        prompt: [t("Now find "), mi("3y+4"), t(" when "), mi("y=7"), t(".")],
        answer: [mi("25")],
        solution: { keepInMind: [], formulasUsed: [], working: [mi("3\\times 7+4=21+4=25")], alternatives: [] }
      });
      qs.push({
        id: "18(b)",
        prompt: [t("Solve "), mi("y-5=9"), t(".")],
        answer: [mi("y=14")],
        solution: { keepInMind: [], formulasUsed: [], working: [mi("y=9+5=14")], alternatives: [] }
      });

      return {
        id: workingsExpanded ? "standardExpanded" : "standard",
        label: workingsExpanded ? "Standard (Workings Expanded)" : "Standard paper",
        title: workingsExpanded ? "Standard (Workings Expanded)" : "Standard paper",
        subtitle: "35 questions • Q26–Q35 long algebra",
        sections: null,
        defaults: { workingsExpanded: !!workingsExpanded },
        questions: qs
      };
    }

    function makeDiagramHeavyPaper() {
      const qs = [];
      const diagTypes = ["geometry", "ratio", "grid", "table"];
      for (let i = 1; i <= 20; i++) {
        const hasDiagram = [2, 4, 6, 9, 11, 14, 17, 20].includes(i);
        const dType = diagTypes[i % diagTypes.length];
        qs.push({
          id: String(i),
          prompt: [
            t("Answer the question below."),
            ...(hasDiagram ? [diagram(dType)] : []),
            t("Calculate "),
            mi(`${i * 2}+${i}`),
            t(".")
          ],
          answer: [mi(String(i * 3))],
          solution: {
            keepInMind: (i === 6 || i === 14 || i === 17) ? [t("Read values from the diagram carefully, then compute.")] : [],
            formulasUsed: (i === 4 || i === 11 || i === 20) ? [t("Addition: "), mi("a+b=b+a")] : [],
            working: [
              mi(`${i * 2}+${i} = ${i * 3}`)
            ],
            alternatives: (i === 9 || i === 17) ? [[t("Group the addends: "), mi(`${i}+${i}+${i}`), t(".")]] : []
          }
        });
      }
      return {
        id: "diagram",
        label: "Diagram-heavy paper",
        title: "Diagram-heavy paper",
        subtitle: "20 questions • 8 include diagrams",
        sections: null,
        defaults: { workingsExpanded: false },
        questions: qs
      };
    }

    function makeSectionedPaper() {
      // Section A: 35 small/medium
      // Section B: 8 medium
      // Section C: 6 very long Solution Details (collapsed by default)
      const sectionA = [];
      for (let i = 1; i <= 35; i++) {
        sectionA.push({
          id: String(i),
          prompt: [t("Work out "), mi(`${i}+${i + 1}`), t(".")],
          answer: [mi(String(2 * i + 1))],
          solution: {
            keepInMind: (i === 7 || i === 19 || i === 28) ? [t("Add ones, then tens if needed.")] : [],
            formulasUsed: (i === 11 || i === 22 || i === 33) ? [t("Addition: "), mi("a+b=b+a")] : [],
            working: [mi(`${i}+${i + 1}=${2 * i + 1}`)],
            alternatives: (i === 14) ? [[t("Count on 1 from "), mi(String(i)), t(".")]] : []
          }
        });
      }

      const sectionB = [];
      for (let i = 1; i <= 8; i++) {
        const qNum = 35 + i;
        sectionB.push({
          id: String(qNum),
          prompt: [
            t("A recipe uses "),
            mi(`${2 * i}`),
            t(" eggs for "),
            mi("4"),
            t(" people. How many eggs for "),
            mi("10"),
            t(" people?")
          ],
          answer: [mi(String(5 * i))],
          solution: {
            keepInMind: (i === 2 || i === 6) ? [t("Scale up using a multiplier.")] : [],
            formulasUsed: (i === 3 || i === 7) ? [t("Proportion: "), mi("\\text{new} = \\text{old}\\times \\frac{10}{4}")] : [],
            working: [
              mb(`\\text{Multiplier} = \\frac{10}{4} = 2.5`),
              mb(`${2 * i}\\times 2.5 = ${5 * i}`)
            ],
            alternatives: (i === 5) ? [[
              t("Find per person, then multiply:"),
              mb(`\\frac{${2 * i}}{4} = ${i / 2}`),
              mb(`${i / 2}\\times 10 = ${5 * i}`)
            ]] : []
          }
        });
      }

      function extremelyLongWorking(seed) {
        const lines = [];
        lines.push(t("This is a long working stress-test (many lines):"));
        lines.push(mb(`\\text{Given } 3x + ${seed} = 2x + ${seed + 9}`));
        lines.push(mb(`3x-2x = ${seed + 9}-${seed}`));
        lines.push(mb(`x = 9`));
        lines.push(t("Now show a detailed check and expansion lines:"));
        for (let k = 1; k <= 58; k++) {
          const a = seed + k;
          // Mix in some wider lines occasionally.
          if (k % 10 === 0) {
            lines.push(mb(`\\underbrace{(x+${a})^2}_{x^2+2${a}x+${a * a}} - \\underbrace{(x-${a})^2}_{x^2-2${a}x+${a * a}} = 4${a}x`));
          } else {
            lines.push(mb(`\\text{Line ${k}: } x + ${a} = ${a + 9} \\;\\Rightarrow\\; x = 9`));
          }
        }
        return lines;
      }

      const sectionC = [];
      for (let i = 1; i <= 6; i++) {
        const qId = 43 + i;
        const includeKeep = (i <= 3);
        const includeFormulas = (i === 2 || i === 4 || i === 6);
        const includeAlt = (i === 3 || i === 6);
        sectionC.push({
          id: String(qId),
          prompt: [
            t("Solve for "),
            mi("x"),
            t(": "),
            mi(`3x+${10 + i}=2x+${19 + i}`),
            t(".")
          ],
          answer: [mi("x=9")],
          solution: {
            keepInMind: includeKeep ? [t("Keep both sides balanced by doing the same thing to each side.")] : [],
            formulasUsed: includeFormulas ? [t("Inverse operations: "), mi("\\text{add/subtract, then divide}")] : [],
            working: extremelyLongWorking(10 + i),
            alternatives: includeAlt ? [[
              t("Alternative working (short):"),
              mb(`3x+${10 + i}=2x+${19 + i}`),
              mb(`x=${19 + i}-${10 + i}=9`)
            ]] : []
          }
        });
      }

      return {
        id: "sectioned",
        label: "Sectioned paper",
        title: "Sectioned paper",
        subtitle: "Sections A/B/C • C has very long Solution Details",
        sections: [
          { label: "A", questions: sectionA },
          { label: "B", questions: sectionB },
          { label: "C", questions: sectionC }
        ],
        defaults: { workingsExpanded: false },
        questions: null
      };
    }

    // -----------------------------
    // Stress coverage add-on: ensure frequent Solution Details variants
    // (We already sprinkled Keep in mind / Formulas used / Alternative working across datasets,
    // and Section C includes Keep in mind + Formulas used + Alternative working on at least one question.)
    // -----------------------------

    const DATASETS = [
      makeShortPaper(),
      makeStandardPaper(false),
      makeStandardPaper(true),
      makeDiagramHeavyPaper(),
      makeSectionedPaper()
    ];

    function getDatasetById(id) {
      return DATASETS.find(d => d.id === id) || DATASETS[0];
    }

    // -----------------------------
    // Rendering
    // -----------------------------
    const paperSelect = document.getElementById("paperSelect");
    const paperMain = document.getElementById("paperMain");
    const navContent = document.getElementById("navContent");
    const navDrawerContent = document.getElementById("navDrawerContent");
    const paperMeta = document.getElementById("paperMeta");

    const navDrawer = document.getElementById("navDrawer");
    const jumpBtn = document.getElementById("jumpBtn");

    function el(tag, attrs = {}, children = []) {
      const node = document.createElement(tag);
      for (const [k, v] of Object.entries(attrs)) {
        if (k === "class") node.className = v;
        else if (k === "html") node.innerHTML = v;
        else if (k.startsWith("on") && typeof v === "function") node.addEventListener(k.slice(2), v);
        else if (v === false || v === null || v === undefined) { }
        else node.setAttribute(k, String(v));
      }
      for (const c of children) {
        if (c === null || c === undefined) continue;
        if (typeof c === "string") node.appendChild(document.createTextNode(c));
        else node.appendChild(c);
      }
      return node;
    }

    function renderParts(parts) {
      const frag = document.createDocumentFragment();
      for (const p of parts) {
        if (p.kind === "text") {
          frag.appendChild(document.createTextNode(p.text));
        } else if (p.kind === "mathInline") {
          const s = el("span", { class: "math-inline", "data-math": "inline", "data-tex": p.tex }, [""]);
          frag.appendChild(s);
        } else if (p.kind === "mathBlock") {
          const d = el("div", { class: "math-block", "data-math": "block", "data-tex": p.tex }, [""]);
          frag.appendChild(d);
        } else if (p.kind === "diagram") {
          const wrap = el("div", { class: "diagram", "aria-label": "Diagram" });
          wrap.innerHTML = diagramSVG(p.type);
          frag.appendChild(wrap);
        }
      }
      return frag;
    }

    function flattenQuestions(dataset) {
      if (dataset.sections) {
        const flat = [];
        for (const s of dataset.sections) {
          for (const q of s.questions) flat.push(q);
        }
        return flat;
      }
      return dataset.questions || [];
    }

    function buildNav(dataset) {
      const flat = flattenQuestions(dataset);
      const sections = dataset.sections;

      function navListFor(sectionsOrFlat, inDrawer) {
        const container = document.createElement("div");
        if (sections) {
          for (const sec of sections) {
            container.appendChild(el("div", { class: "nav-sep" }, [sec.label]));
            const ul = el("ul", { class: "nav-list" });
            for (const q of sec.questions) {
              const href = "#" + slugId(q.id);
              const a = el("a", { class: "nav-link", href, "data-qid": q.id }, [q.id]);
              a.addEventListener("click", (e) => {
                // Keep native anchor jump (no state changes), then close drawer if open.
                if (inDrawer) closeDrawer();
              });
              ul.appendChild(el("li", {}, [a]));
            }
            container.appendChild(ul);
          }
        } else {
          const ul = el("ul", { class: "nav-list" });
          for (const q of flat) {
            const href = "#" + slugId(q.id);
            const a = el("a", { class: "nav-link", href, "data-qid": q.id }, [q.id]);
            a.addEventListener("click", () => { if (inDrawer) closeDrawer(); });
            ul.appendChild(el("li", {}, [a]));
          }
          container.appendChild(ul);
        }
        return container;
      }

      navContent.innerHTML = "";
      navDrawerContent.innerHTML = "";
      navContent.appendChild(navListFor(sections, false));
      navDrawerContent.appendChild(navListFor(sections, true));
    }

    function renderQuestion(q, datasetDefaults) {
      const qid = q.id;
      const depth = q.depth ?? qDepthFromId(qid);
      const anchorId = slugId(qid);

      const article = el("article", { class: "question", id: anchorId, "data-qid": qid });
      const wrap = el("div", { class: "q-wrap depth-" + depth });

      const head = el("div", { class: "q-head" }, [
        el("div", { class: "qid" }, [qid]),
        el("p", { class: "q-prompt" }, [renderParts(q.prompt)])
      ]);

      const body = el("div", { class: "q-body" });

      // Answer always visible
      const answer = el("div", { class: "answer" }, [
        el("div", { class: "label" }, ["Answer"]),
        el("div", { class: "value" }, [renderParts(q.answer)])
      ]);

      // Solution Details disclosure
      const disclosure = el("div", { class: "disclosure" });
      const detailsId = "details-" + anchorId;

      const shouldStartExpanded = !!(q.workingsExpanded ?? datasetDefaults.workingsExpanded);

      const toggle = el("button", {
        class: "toggle",
        type: "button",
        "aria-expanded": String(shouldStartExpanded),
        "aria-controls": detailsId
      }, [
        el("span", { class: "toggle-text" }, [shouldStartExpanded ? "Hide working" : "Show working"]),
        el("span", { class: "chev", "aria-hidden": "true" })
      ]);

      const previewLine = firstPreviewLine(q);
      const preview = el("div", { class: "preview", "data-preview": "true" }, [
        el("span", { class: "preview-label" }, ["Working preview:"]),
        el("span", { class: "preview-line" }, previewLine ? [renderParts([previewLine])] : ["(none)"])
      ]);

      const details = el("div", { class: "details", id: detailsId });
      if (!shouldStartExpanded) details.hidden = true;

      function makeBlock(title, parts) {
        return el("div", { class: "block" }, [
          el("div", { class: "block-title" }, [title]),
          el("div", { class: "block-body" }, [renderParts(parts)])
        ]);
      }

      // Solution Details content order: Keep in mind, Formulas used, Working, Alternative working
      const sol = q.solution || { keepInMind: [], formulasUsed: [], working: [], alternatives: [] };

      if (sol.keepInMind && sol.keepInMind.length) {
        details.appendChild(makeBlock("Keep in mind", sol.keepInMind));
      }
      if (sol.formulasUsed && sol.formulasUsed.length) {
        details.appendChild(makeBlock("Formulas used", sol.formulasUsed));
      }

      details.appendChild(makeBlock("Working", sol.working || []));

      if (sol.alternatives && sol.alternatives.length) {
        for (const alt of sol.alternatives) {
          details.appendChild(makeBlock("Alternative working", alt));
        }
      }

      // Collapsed: show preview; Expanded: hide preview
      preview.style.display = shouldStartExpanded ? "none" : "block";

      toggle.addEventListener("click", () => {
        const expanded = toggle.getAttribute("aria-expanded") === "true";
        const next = !expanded;
        toggle.setAttribute("aria-expanded", String(next));
        toggle.querySelector(".toggle-text").textContent = next ? "Hide working" : "Show working";
        details.hidden = !next;
        preview.style.display = next ? "none" : "block";
        // No focus movement, no auto-scrolling.
        // Re-render KaTeX for newly revealed nodes (if needed).
        renderKaTeXIn(details);
      });

      disclosure.appendChild(toggle);
      disclosure.appendChild(preview);
      disclosure.appendChild(details);

      body.appendChild(answer);
      body.appendChild(disclosure);

      wrap.appendChild(head);
      wrap.appendChild(body);
      article.appendChild(wrap);

      return article;
    }

    function renderPaper(datasetId) {
      const dataset = getDatasetById(datasetId);

      paperMain.innerHTML = "";
      buildNav(dataset);

      const allQs = flattenQuestions(dataset);
      paperMeta.textContent = `${allQs.length} questions`;

      paperMain.appendChild(el("h1", { class: "paper-title" }, [dataset.title]));
      paperMain.appendChild(el("p", { class: "paper-sub" }, [dataset.subtitle]));

      const container = document.createElement("div");
      for (const q of allQs) {
        container.appendChild(renderQuestion(q, dataset.defaults));
      }
      paperMain.appendChild(container);

      // After DOM injection, render KaTeX safely
      renderKaTeXIn(paperMain);

      // Re-init active nav highlighting
      initActiveNavObserver();
    }

    // -----------------------------
    // KaTeX rendering (programmatic, with graceful fallback)
    // -----------------------------
    function safeRenderKaTeX(node, tex, displayMode) {
      try {
        if (window.katex && typeof window.katex.render === "function") {
          window.katex.render(tex, node, {
            displayMode: !!displayMode,
            throwOnError: false
          });
        } else {
          // Fallback: show raw text; do not hide content.
          node.textContent = tex;
        }
      } catch (e) {
        node.textContent = tex;
      }
    }

    function renderKaTeXIn(root) {
      const nodes = root.querySelectorAll("[data-math][data-tex]");
      nodes.forEach(n => {
        if (n.getAttribute("data-rendered") === "true") return;
        const kind = n.getAttribute("data-math");
        const tex = n.getAttribute("data-tex") || "";
        safeRenderKaTeX(n, tex, kind === "block");
        n.setAttribute("data-rendered", "true");
      });
    }

    // -----------------------------
    // Nav active state (orientation only; no progress semantics)
    // -----------------------------
    let observer = null;

    function clearNavCurrent() {
      document.querySelectorAll('.nav-link[aria-current="true"]').forEach(a => a.removeAttribute("aria-current"));
    }

    function setNavCurrent(qid) {
      clearNavCurrent();
      document.querySelectorAll(`.nav-link[data-qid="${CSS.escape(qid)}"]`).forEach(a => {
        a.setAttribute("aria-current", "true");
      });
    }

    function initActiveNavObserver() {
      if (observer) observer.disconnect();

      const questions = Array.from(document.querySelectorAll("article.question"));
      if (!questions.length) return;

      observer = new IntersectionObserver((entries) => {
        // Pick the entry closest to the top that is intersecting.
        const visible = entries
          .filter(e => e.isIntersecting)
          .sort((a, b) => a.boundingClientRect.top - b.boundingClientRect.top);

        if (visible.length) {
          const qid = visible[0].target.getAttribute("data-qid");
          if (qid) setNavCurrent(qid);
        }
      }, {
        root: null,
        rootMargin: "-20% 0px -70% 0px",
        threshold: [0.01, 0.1]
      });

      questions.forEach(q => observer.observe(q));
    }

    // -----------------------------
    // Mobile drawer accessibility (no background interaction while open)
    // -----------------------------
    let lastFocus = null;

    function openDrawer() {
      lastFocus = document.activeElement;
      navDrawer.setAttribute("aria-hidden", "false");
      document.body.style.overflow = "hidden"; // prevent background scroll
      // Focus first link (or close button if none)
      const firstLink = navDrawer.querySelector(".nav-link");
      const closeBtn = navDrawer.querySelector(".drawer-close");
      (firstLink || closeBtn).focus();

      // Trap focus within dialog
      document.addEventListener("keydown", onTrapFocus);
    }

    function closeDrawer() {
      navDrawer.setAttribute("aria-hidden", "true");
      document.body.style.overflow = "";
      document.removeEventListener("keydown", onTrapFocus);
      if (lastFocus && typeof lastFocus.focus === "function") lastFocus.focus();
    }

    function onTrapFocus(e) {
      if (navDrawer.getAttribute("aria-hidden") === "true") return;

      if (e.key === "Escape") {
        e.preventDefault();
        closeDrawer();
        return;
      }

      if (e.key !== "Tab") return;

      const focusables = navDrawer.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
      const list = Array.from(focusables).filter(el => !el.hasAttribute("disabled") && el.offsetParent !== null);
      if (!list.length) return;

      const first = list[0];
      const last = list[list.length - 1];

      if (e.shiftKey && document.activeElement === first) {
        e.preventDefault();
        last.focus();
      } else if (!e.shiftKey && document.activeElement === last) {
        e.preventDefault();
        first.focus();
      }
    }

    jumpBtn.addEventListener("click", () => {
      // Drawer only matters on small screens; on desktop this is still useful.
      openDrawer();
    });

    navDrawer.addEventListener("click", (e) => {
      const target = e.target;
      if (target && target.getAttribute && target.getAttribute("data-close") === "true") {
        closeDrawer();
      }
    });

    // -----------------------------
    // Init selector + default render
    // -----------------------------
    function init() {
      DATASETS.forEach(d => {
        paperSelect.appendChild(el("option", { value: d.id }, [d.label]));
      });

      const initial = "standard";
      paperSelect.value = initial;
      renderPaper(initial);

      paperSelect.addEventListener("change", () => {
        renderPaper(paperSelect.value);
        // No automatic expand/collapse beyond dataset defaults.
      });
    }

    init();
  </script>
</body>

</html>