<!DOCTYPE html>
<html lang="en-GB">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Viewer - Prototype</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"
        integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"
        integrity="sha384-XjKyFAMyFxhDD7DxaTUlyesK3+hLLwj4Kj5B56dmXqe820GEnn0IExq9Xz6nK0yo"
        crossorigin="anonymous"></script>

    <style>
        /* * STAGE 5.3 + OVERRIDE: Cool-Neutral Surface & Restrained Accent
     * Base Palette: Slate (Blue-Grey) scales
     */
        :root {
            /* Cool Neutral Backgrounds & Surfaces */
            --bg-page: #f1f5f9;
            /* Slate 100 */
            --bg-paper: #ffffff;
            /* White */
            --bg-details: #f8fafc;
            /* Slate 50 - Very subtle separation */

            /* Typography & Content Colors */
            --text-question: #0f172a;
            /* Slate 900 - Primary Anchor */
            --text-body: #334155;
            /* Slate 700 */
            --text-secondary: #475569;
            /* Slate 600 */
            --text-tertiary: #64748b;
            /* Slate 500 */

            /* Accent Override: Restrained Blue */
            --color-accent: #2563eb;
            /* Blue 600 - Emphasis only */
            --color-accent-subtle: #eff6ff;
            /* Blue 50 */

            /* Borders & Lines */
            --border-subtle: #e2e8f0;
            /* Slate 200 */
            --border-focus: #2563eb;
            /* Accent */

            /* Spacing Variables (Rhythm) */
            --space-question-gap: 3rem;
            --space-internal-gap: 1rem;
            --space-indent: 1.5rem;

            /* Layout */
            --nav-width: 180px;
            --frame-max-width: 960px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--bg-page);
            color: var(--text-body);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        /* === LAYOUT FRAME === */
        .app-frame {
            max-width: var(--frame-max-width);
            margin: 0 auto;
            min-height: 100vh;
            background-color: transparent;
            display: flex;
            flex-direction: column;
        }

        /* === HEADER / CONTROLS === */
        .top-controls {
            padding: 1rem 0;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-subtle);
            background-color: var(--bg-page);
            /* Maintain page bg */
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .control-group {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        select,
        button,
        label {
            font-family: inherit;
            font-size: 0.9rem;
            color: var(--text-body);
        }

        select {
            padding: 0.5rem;
            border: 1px solid var(--border-subtle);
            border-radius: 4px;
            background: var(--bg-paper);
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* === MAIN COLUMNS === */
        .content-area {
            display: flex;
            gap: 2rem;
            flex: 1;
            position: relative;
        }

        /* === NAVIGATION RAIL === */
        .navigation-rail {
            width: var(--nav-width);
            flex-shrink: 0;
            padding-top: 2rem;
            /* Sticky & Scrollable Add-on */
            position: sticky;
            top: 60px;
            /* Offset for header */
            max-height: calc(100vh - 60px);
            overflow-y: auto;
            /* Hide Scrollbar */
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .navigation-rail::-webkit-scrollbar {
            display: none;
        }

        .nav-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .nav-section-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            padding-left: 0.75rem;
        }

        .nav-item {
            display: block;
            padding: 0.4rem 0.75rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
            text-decoration: none;
            border-radius: 4px;
            transition: color 0.15s ease, background-color 0.15s ease;
            cursor: pointer;
        }

        .nav-item:hover {
            color: var(--text-question);
            text-decoration: underline;
            text-decoration-color: var(--border-subtle);
        }

        .nav-item.active {
            color: var(--color-accent);
            font-weight: 600;
            background-color: var(--color-accent-subtle);
        }

        .nav-item:focus-visible {
            outline: 2px solid var(--border-focus);
            outline-offset: 2px;
        }

        /* === PAPER CONTENT === */
        .paper-content {
            flex: 1;
            background-color: var(--bg-paper);
            padding: 3rem 4rem;
            /* Generous padding like a document */
            min-height: 80vh;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            /* Very subtle depth */
        }

        /* === QUESTION STRUCTURE === */
        .question-block {
            margin-bottom: var(--space-question-gap);
            scroll-margin-top: 100px;
            /* For anchor jumping */
        }

        /* Separation Logic */
        .question-block.sub-question {
            margin-bottom: calc(var(--space-question-gap) * 0.5);
            margin-left: var(--space-indent);
        }

        .question-block.sub-sub-question {
            margin-bottom: calc(var(--space-question-gap) * 0.3);
            margin-left: calc(var(--space-indent) * 2);
        }

        .q-header {
            display: flex;
            gap: 1rem;
            align-items: baseline;
            margin-bottom: 0.75rem;
        }

        .q-id {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 1rem;
            min-width: 2ch;
        }

        .q-prompt {
            color: var(--text-question);
            font-size: 1.125rem;
            /* 18px */
            font-weight: 500;
            line-height: 1.6;
            flex: 1;
        }

        /* Diagrams */
        .diagram-container {
            margin: 1.5rem 0;
            display: flex;
            justify-content: flex-start;
        }

        .diagram-svg {
            max-width: 100%;
            height: auto;
            display: block;
            stroke: var(--text-body);
            fill: none;
            stroke-width: 1.5;
        }

        .diagram-fill {
            fill: var(--border-subtle);
            stroke: none;
        }

        .diagram-text {
            fill: var(--text-body);
            stroke: none;
            font-size: 12px;
            font-family: inherit;
        }

        /* === ANSWER === */
        .answer-block {
            margin-left: calc(2ch + 1rem);
            /* Align with prompt text */
            margin-bottom: 1rem;
            display: flex;
            align-items: baseline;
            gap: 0.5rem;
        }

        .answer-label {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .answer-value {
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-question);
        }

        /* === SOLUTION DETAILS === */
        .solution-details-container {
            margin-left: calc(2ch + 1rem);
        }

        .toggle-btn {
            background: none;
            border: none;
            padding: 0;
            font-size: 0.9rem;
            color: var(--color-accent);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .toggle-btn:hover {
            text-decoration: underline;
        }

        .toggle-btn:focus-visible {
            outline: 2px solid var(--border-focus);
            outline-offset: 2px;
            border-radius: 2px;
        }

        .toggle-icon {
            transition: transform 0.2s ease;
            fill: currentColor;
        }

        .toggle-btn[aria-expanded="true"] .toggle-icon {
            transform: rotate(180deg);
        }

        .details-content {
            display: none;
            background-color: var(--bg-details);
            padding: 1.5rem;
            border-radius: 4px;
            margin-top: 0.5rem;
            border-left: 2px solid var(--border-subtle);
        }

        .details-content[data-visible="true"] {
            display: block;
            animation: reveal 0.2s ease-out;
        }

        @keyframes reveal {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Detail Sub-blocks */
        .detail-section {
            margin-bottom: 1.5rem;
        }

        .detail-section:last-child {
            margin-bottom: 0;
        }

        .detail-label {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text-tertiary);
            text-transform: uppercase;
            margin-bottom: 0.5rem;
            display: block;
        }

        .detail-body {
            font-size: 0.95rem;
            color: var(--text-body);
            line-height: 1.6;
        }

        /* Math handling */
        .katex-block-wrapper {
            overflow-x: auto;
            padding: 0.5rem 0;
            max-width: 100%;
            /* Scrollbar styling for math */
            scrollbar-width: thin;
            scrollbar-color: var(--text-tertiary) var(--bg-details);
        }

        .katex-placeholder {
            font-family: 'Courier New', monospace;
            background: rgba(0, 0, 0, 0.03);
            padding: 2px 4px;
            border-radius: 3px;
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        .katex-display-placeholder {
            display: block;
            padding: 1rem;
            margin: 1rem 0;
            background: rgba(0, 0, 0, 0.03);
            font-family: 'Courier New', monospace;
            color: var(--text-secondary);
            white-space: pre-wrap;
            border-left: 3px solid var(--border-subtle);
        }

        /* === RESPONSIVE === */
        @media (max-width: 768px) {
            .content-area {
                flex-direction: column;
            }

            .navigation-rail {
                display: none;
                /* Brief says minimal drawer/overlay, simpler for pure HTML/CSS proto to hide or put top */
            }

            /* Mobile Nav Placeholder */
            .mobile-nav-hint {
                display: block;
                padding: 1rem;
                background: var(--bg-details);
                text-align: center;
                font-size: 0.9rem;
                color: var(--text-secondary);
                margin-bottom: 1rem;
            }

            .paper-content {
                padding: 1.5rem;
            }

            .answer-block,
            .solution-details-container {
                margin-left: 0;
                margin-top: 0.5rem;
            }
        }

        @media (min-width: 769px) {
            .mobile-nav-hint {
                display: none;
            }
        }
    </style>
</head>

<body>

    <div class="app-frame">
        <header class="top-controls">
            <div class="control-group">
                <label for="paper-select"><strong>Select Paper:</strong></label>
                <select id="paper-select">
                    <option value="short">Short Paper (6 Qs)</option>
                    <option value="standard">Standard Paper (35 Qs)</option>
                    <option value="standard-expanded">Standard (Workings Expanded)</option>
                    <option value="diagram">Diagram-Heavy (20 Qs)</option>
                    <option value="sectioned">Sectioned Paper (A/B/C)</option>
                </select>
            </div>
            <div class="control-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="render-katex">
                    Render Real KaTeX
                </label>
            </div>
        </header>

        <div class="content-area">
            <nav class="navigation-rail" aria-label="Question Navigation">
                <ul class="nav-list" id="nav-list">
                </ul>
            </nav>

            <main class="paper-content" id="paper-main">
                <div class="mobile-nav-hint">Navigation available on Desktop</div>
            </main>
        </div>
    </div>

    <script>
        // --- DATASETS (Mock Generation based on Exemplars) ---

        const SVG_DEFS = {
            geometry: `<svg viewBox="0 0 200 150" class="diagram-svg" width="200" height="150">
            <path d="M20,130 L180,130 L100,20 Z" class="diagram-fill" stroke="currentColor"/>
            <text x="90" y="145" class="diagram-text">12 cm</text>
            <text x="40" y="70" class="diagram-text">10 cm</text>
        </svg>`,
            bar: `<svg viewBox="0 0 300 100" class="diagram-svg" width="300" height="100">
            <rect x="10" y="20" width="280" height="30" stroke="currentColor" fill="none"/>
            <rect x="10" y="20" width="70" height="30" class="diagram-fill"/>
            <text x="10" y="70" class="diagram-text">Category A (25%)</text>
        </svg>`,
            grid: `<svg viewBox="0 0 200 200" class="diagram-svg" width="200" height="200">
            <defs><pattern id="grid" width="20" height="20" patternUnits="userSpaceOnUse"><path d="M 20 0 L 0 0 0 20" fill="none" stroke="#e2e8f0" stroke-width="1"/></pattern></defs>
            <rect width="200" height="200" fill="url(#grid)" stroke="#cbd5e1"/>
            <line x1="100" y1="0" x2="100" y2="200" stroke="currentColor"/>
            <line x1="0" y1="100" x2="200" y2="100" stroke="currentColor"/>
            <circle cx="140" cy="60" r="4" fill="currentColor"/>
        </svg>`,
            table: `<svg viewBox="0 0 300 120" class="diagram-svg" width="300" height="120">
            <rect x="0" y="0" width="300" height="120" fill="none" stroke="currentColor"/>
            <line x1="0" y1="40" x2="300" y2="40" stroke="currentColor"/>
            <line x1="100" y1="0" x2="100" y2="120" stroke="currentColor"/>
            <text x="20" y="25" class="diagram-text" font-weight="bold">Item</text>
            <text x="120" y="25" class="diagram-text" font-weight="bold">Cost</text>
            <text x="20" y="70" class="diagram-text">Apple</text>
            <text x="120" y="70" class="diagram-text">£0.50</text>
            <text x="20" y="105" class="diagram-text">Banana</text>
            <text x="120" y="105" class="diagram-text">£0.30</text>
        </svg>`
        };

        // Helper to create math strings
        const MATH = (str, display = false) => display ? `$$ ${str} $$` : `$ ${str} $`;

        // Content Generators
        function genQuestion(id, prompt, answer, working, opts = {}) {
            return {
                id,
                prompt,
                answer,
                solution: {
                    working,
                    guidance: opts.guidance,
                    formula: opts.formula,
                    altWorking: opts.altWorking
                },
                type: opts.type || 'text',
                diagram: opts.diagram,
                subLevel: opts.subLevel || 0, // 0=Top, 1=Sub (a), 2=Sub-sub (i)
                section: opts.section // For sectioned paper
            };
        }

        // Generate Standard Questions (Mix of Exemplar types)
        function generateDataset(type) {
            const questions = [];

            // --- SHORT PAPER ---
            if (type === 'short') {
                questions.push(genQuestion('1', `Fill in the missing number: ${MATH('45 + \\boxed{\\phantom{0}} = 92')}`, '47',
                    `Let the missing number be $a$.
                 $$ 45 + a = 92 $$
                 $$ a = 92 - 45 $$
                 $$ a = 47 $$`));

                questions.push(genQuestion('2', `Calculate ${MATH('34 \\times 12')}.`, '408',
                    `$$ \\begin{aligned} 34 \\times 12 &= 34 \\times (10 + 2) \\\\ &= 340 + 68 \\\\ &= 408 \\end{aligned} $$`));

                // Nested question
                questions.push(genQuestion('3a', 'How many minutes are in 3.5 hours?', '210 minutes',
                    `$$ 3.5 \\times 60 = 210 $$`, { subLevel: 1 }));
                questions.push(genQuestion('3b', 'If a film starts at 14:30 and lasts 210 minutes, when does it end?', '18:00',
                    `$$ 210 \\text{ minutes} = 3 \\text{ hours} 30 \\text{ minutes} $$
                 $$ 14:30 + 3:30 = 18:00 $$`, { subLevel: 1 }));

                questions.push(genQuestion('4', 'Calculate the area of the rectangle.', '24 cm²',
                    `$$ \\text{Area} = \\text{width} \\times \\text{height} $$
                 $$ \\text{Area} = 6 \\times 4 = 24 $$`, { diagram: 'geometry', formula: 'Area = w × h' }));

                questions.push(genQuestion('5', 'Solve for x: ' + MATH('2x + 5 = 15'), '5',
                    `$$ 2x = 15 - 5 $$
                 $$ 2x = 10 $$
                 $$ x = 5 $$`));
            }

            // --- STANDARD PAPER (35 Qs) ---
            if (type === 'standard' || type === 'standard-expanded') {
                // Fill 1-25 with short/medium
                for (let i = 1; i <= 25; i++) {
                    questions.push(genQuestion(`${i}`, `Sample arithmetic question ${i}: ${MATH(i + ' \\times ' + (i + 1))}`, `${i * (i + 1)}`,
                        `Multiply the two numbers: $$ ${i} \\times ${i + 1} = ${i * (i + 1)} $$`));
                }
                // 26-35 Long Algebra / Word Problems (Exemplar Style)
                for (let i = 26; i <= 35; i++) {
                    // Add extreme length for Q30+
                    let workingLines = `Let the unknown variable be $x$. \nAccording to the problem statement, we have: \n$$ 5x^2 + 3x - 20 = 100 $$`;
                    for (let j = 0; j < 15; j++) {
                        workingLines += `\n$$ \\text{Step ${j + 1}}: \\quad 5x^2 + 3x = ${120 + j} \\quad (\\text{rearranging terms}) $$`;
                    }
                    workingLines += `\nFinally, solving gives: $$ x = ${i} $$`;

                    // Add Deep Nesting to Q30
                    if (i === 30) {
                        questions.push(genQuestion('30a', 'Part A of the complex problem.', '10', workingLines, { subLevel: 1 }));
                        questions.push(genQuestion('30b(i)', 'Calculate the sub-component.', '5', 'Simple step here.', { subLevel: 2 }));
                        questions.push(genQuestion('30b(ii)', 'Verify the result.', 'Correct', 'Verification steps...', { subLevel: 2 }));
                    } else {
                        questions.push(genQuestion(`${i}`, `Complex algebraic derivation problem ${i}.`, `${i}`, workingLines, {
                            guidance: 'Remember to apply BIDMAS correctly.',
                            formula: 'Quadratic Formula: $x = \\frac{-b \\pm \\sqrt{b^2 - 4ac}}{2a}$',
                            altWorking: 'Alternatively, you could solve by factorising...'
                        }));
                    }
                }
            }

            // --- DIAGRAM PAPER ---
            if (type === 'diagram') {
                const types = ['geometry', 'bar', 'grid', 'table'];
                for (let i = 1; i <= 20; i++) {
                    questions.push(genQuestion(`${i}`, `Question with diagram ${i}`, 'Answer', 'Working...', {
                        diagram: (i % 3 === 0) ? types[i % 4] : null
                    }));
                }
            }

            // --- SECTIONED PAPER ---
            if (type === 'sectioned') {
                // Section A
                questions.push({ section: 'Section A', isHeader: true });
                for (let i = 1; i <= 5; i++) questions.push(genQuestion(`${i}`, `Section A Question ${i}`, 'Ans', 'Working...', { section: 'A' }));

                // Section B
                questions.push({ section: 'Section B', isHeader: true });
                for (let i = 6; i <= 10; i++) questions.push(genQuestion(`${i}`, `Section B Question ${i}`, 'Ans', 'Working...', { section: 'B' }));

                // Section C (Long)
                questions.push({ section: 'Section C', isHeader: true });
                for (let i = 11; i <= 16; i++) {
                    let longWorking = `$$ \\text{Initial Equation: } \\int_{0}^{10} x^2 dx $$`;
                    for (let k = 0; k < 40; k++) longWorking += `\n$$ \\text{Integration Step ${k}}: \\quad \\frac{x^3}{3} + C_${k} $$`;
                    questions.push(genQuestion(`${i}`, `Section C Complex Problem ${i}`, '42', longWorking, { section: 'C' }));
                }
            }

            return questions;
        }

        // --- RENDER LOGIC ---

        const paperSelect = document.getElementById('paper-select');
        const katexCheck = document.getElementById('render-katex');
        const navList = document.getElementById('nav-list');
        const paperMain = document.getElementById('paper-main');

        function renderMath(text) {
            if (!text) return '';
            if (katexCheck.checked && window.katex) {
                // Very basic replacement for prototype
                return text.replace(/\$\$([\s\S]*?)\$\$/g, (match, tex) => {
                    try { return katex.renderToString(tex, { displayMode: true, throwOnError: false }); }
                    catch (e) { return match; }
                }).replace(/\$([\s\S]*?)\$/g, (match, tex) => {
                    try { return katex.renderToString(tex, { displayMode: false, throwOnError: false }); }
                    catch (e) { return match; }
                });
            } else {
                // Placeholder Mode
                return text.replace(/\$\$([\s\S]*?)\$\$/g, '<div class="katex-display-placeholder">$1</div>')
                    .replace(/\$([\s\S]*?)\$/g, '<span class="katex-placeholder">$1</span>');
            }
        }

        function renderPaper() {
            const type = paperSelect.value;
            const expandedByDefault = type === 'standard-expanded';
            const data = generateDataset(type);

            // Clear
            navList.innerHTML = '';
            paperMain.innerHTML = '<div class="mobile-nav-hint">Navigation available on Desktop</div>';

            // Render Loop
            data.forEach(item => {
                if (item.isHeader) {
                    // Nav Header
                    const li = document.createElement('li');
                    li.className = 'nav-section-label';
                    li.textContent = item.section;
                    navList.appendChild(li);

                    // Paper Header (Divider)
                    const div = document.createElement('div');
                    div.innerHTML = `<h2 style="font-size:1rem; color:var(--text-tertiary); border-bottom:1px solid var(--border-subtle); margin: 3rem 0 2rem 0; padding-bottom:0.5rem;">${item.section}</h2>`;
                    paperMain.appendChild(div);
                    return;
                }

                // --- Nav Item ---
                const navLi = document.createElement('li');
                const navLink = document.createElement('a');
                navLink.className = 'nav-item';
                navLink.textContent = item.id;
                navLink.href = `#q-${item.id}`;
                navLink.onclick = (e) => {
                    e.preventDefault();
                    document.getElementById(`q-${item.id}`).scrollIntoView({ behavior: 'smooth', block: 'start' });
                };
                navLi.appendChild(navLink);
                navList.appendChild(navLi);

                // --- Paper Question Block ---
                const qBlock = document.createElement('article');
                qBlock.id = `q-${item.id}`;
                qBlock.className = `question-block ${item.subLevel === 1 ? 'sub-question' : ''} ${item.subLevel === 2 ? 'sub-sub-question' : ''}`;

                // Header (ID + Prompt)
                const header = document.createElement('div');
                header.className = 'q-header';
                header.innerHTML = `
                <span class="q-id">${item.id}</span>
                <div class="q-prompt">
                    ${renderMath(item.prompt)}
                    ${item.diagram ? `<div class="diagram-container">${SVG_DEFS[item.diagram]}</div>` : ''}
                </div>
            `;
                qBlock.appendChild(header);

                // Answer
                const ansBlock = document.createElement('div');
                ansBlock.className = 'answer-block';
                ansBlock.innerHTML = `
                <span class="answer-label">Answer</span>
                <span class="answer-value">${renderMath(item.answer)}</span>
            `;
                qBlock.appendChild(ansBlock);

                // Solution Details
                const solContainer = document.createElement('div');
                solContainer.className = 'solution-details-container';

                // Toggle
                const toggle = document.createElement('button');
                toggle.className = 'toggle-btn';
                toggle.setAttribute('aria-expanded', expandedByDefault);
                toggle.innerHTML = `
                <span class="toggle-text">${expandedByDefault ? 'Hide working' : 'Show working'}</span>
                <svg class="toggle-icon" width="12" height="12" viewBox="0 0 12 12"><path d="M2 4 L6 8 L10 4" stroke="currentColor" fill="none" stroke-width="2"/></svg>
            `;

                // Content Wrapper
                const details = document.createElement('div');
                details.className = 'details-content';
                if (expandedByDefault) details.setAttribute('data-visible', 'true');

                // Build Details HTML
                let detailsHTML = '';

                if (item.solution.guidance) {
                    detailsHTML += `<div class="detail-section"><span class="detail-label">Keep in mind</span><div class="detail-body">${renderMath(item.solution.guidance)}</div></div>`;
                }
                if (item.solution.formula) {
                    detailsHTML += `<div class="detail-section"><span class="detail-label">Formulas used</span><div class="detail-body">${renderMath(item.solution.formula)}</div></div>`;
                }
                if (item.solution.working) {
                    detailsHTML += `<div class="detail-section"><span class="detail-label">Working</span><div class="detail-body katex-block-wrapper">${renderMath(item.solution.working)}</div></div>`;
                }
                if (item.solution.altWorking) {
                    detailsHTML += `<div class="detail-section"><span class="detail-label">Alternative working</span><div class="detail-body katex-block-wrapper">${renderMath(item.solution.altWorking)}</div></div>`;
                }

                details.innerHTML = detailsHTML;

                // Wire Toggle
                toggle.onclick = () => {
                    const isExpanded = toggle.getAttribute('aria-expanded') === 'true';
                    toggle.setAttribute('aria-expanded', !isExpanded);
                    toggle.querySelector('.toggle-text').textContent = !isExpanded ? 'Hide working' : 'Show working';

                    if (!isExpanded) {
                        details.setAttribute('data-visible', 'true');
                    } else {
                        details.removeAttribute('data-visible');
                        // Hide logic via CSS display:none on base class
                    }
                };

                solContainer.appendChild(toggle);
                solContainer.appendChild(details);
                qBlock.appendChild(solContainer);

                paperMain.appendChild(qBlock);
            });

            setupObserver();
        }

        // --- ACTIVE SCROLL SPY ---
        let observer;
        function setupObserver() {
            if (observer) observer.disconnect();

            const options = { root: null, rootMargin: '-10% 0px -80% 0px', threshold: 0 };

            observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        // Remove active from all
                        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                        // Add to current
                        const id = entry.target.id.replace('q-', '');
                        const navLink = Array.from(document.querySelectorAll('.nav-item')).find(n => n.textContent === id);
                        if (navLink) {
                            navLink.classList.add('active');
                            // Scroll nav if needed
                            navLink.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                        }
                    }
                });
            }, options);

            document.querySelectorAll('.question-block').forEach(q => observer.observe(q));
        }

        // Init
        paperSelect.addEventListener('change', renderPaper);
        katexCheck.addEventListener('change', renderPaper);

        // Initial Render
        renderPaper();

    </script>
</body>

</html>