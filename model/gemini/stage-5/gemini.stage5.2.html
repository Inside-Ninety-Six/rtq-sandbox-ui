<!DOCTYPE html>
<html lang="en-GB">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer (Prototype)</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"
        integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"
        integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8"
        crossorigin="anonymous"></script>

    <style>
        /* * STAGE 5: VISUAL TONE & SEMANTICS
         * Warm-neutral base, calm, paper-like.
         */
        :root {
            /* Palette - Soft Warm Neutral */
            --c-page-bg: #F5F4F2;
            --c-paper-bg: #FFFFFF;
            --c-text-primary: #2B2825;
            --c-text-secondary: #5D5954;
            --c-text-tertiary: #85807A;
            --c-line: #E6E3DF;
            --c-solution-bg: #FAF9F7;
            /* Very subtle separation */
            --c-focus: #2B2825;
            --c-nav-active: #2B2825;

            /* Spacing Rhythm */
            --sp-xs: 0.25rem;
            --sp-sm: 0.5rem;
            --sp-md: 1rem;
            --sp-lg: 1.5rem;
            --sp-xl: 2.5rem;
            /* Section/Question Gap */
            --sp-xxl: 4rem;
            /* Top Level Gap */

            /* Layout */
            --w-frame: 1024px;
            --w-nav: 180px;

            /* Typography */
            --font-stack: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --lh-reading: 1.6;
            --lh-dense: 1.4;
        }

        /* RESET & BASE */
        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-stack);
            background-color: var(--c-page-bg);
            color: var(--c-text-primary);
            line-height: var(--lh-reading);
            -webkit-font-smoothing: antialiased;
            overflow-y: scroll;
            /* Force scrollbar stability */
        }

        button {
            font-family: inherit;
            border: none;
            background: none;
            cursor: pointer;
            color: inherit;
        }

        /* ACCESSIBILITY FOCUS */
        :focus-visible {
            outline: 2px solid var(--c-focus);
            outline-offset: 2px;
        }

        /* LAYOUT SHELL */
        .app-shell {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        /* HEADER / CONTROLS */
        .top-controls {
            width: 100%;
            max-width: var(--w-frame);
            padding: var(--sp-md) var(--sp-lg);
            border-bottom: 1px solid var(--c-line);
            margin-bottom: var(--sp-lg);
            background-color: var(--c-page-bg);
            /* Match page to feel integrated */
            display: flex;
            flex-wrap: wrap;
            gap: var(--sp-md);
            align-items: center;
            justify-content: space-between;
            z-index: 100;
        }

        .controls-group {
            display: flex;
            gap: var(--sp-md);
            align-items: center;
            flex-wrap: wrap;
        }

        .controls-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--c-text-secondary);
        }

        select,
        input[type="checkbox"] {
            font-size: 0.9rem;
            padding: 0.25rem 0.5rem;
            border: 1px solid var(--c-line);
            border-radius: 4px;
            background: var(--c-paper-bg);
            color: var(--c-text-primary);
        }

        /* CENTERED FRAME */
        .content-frame {
            width: 100%;
            max-width: var(--w-frame);
            display: flex;
            flex-direction: row;
            /* Desktop default */
            padding: 0 var(--sp-md);
            gap: var(--sp-xl);
            position: relative;
        }

        /* NAVIGATION RAIL */
        .nav-rail {
            width: var(--w-nav);
            flex-shrink: 0;
            padding-top: var(--sp-md);
            /* Sticky logic */
            position: sticky;
            top: 1rem;
            height: calc(100vh - 2rem);
            overflow-y: auto;
            /* Scrollbar hiding */
            scrollbar-width: none;
            -ms-overflow-style: none;

            display: flex;
            flex-direction: column;
            gap: var(--sp-xs);

            border-right: 1px solid transparent;
            /* Visual separation if needed */
        }

        .nav-rail::-webkit-scrollbar {
            display: none;
        }

        .nav-section-label {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--c-text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: var(--sp-md);
            margin-bottom: var(--sp-xs);
            padding-left: var(--sp-sm);
        }

        .nav-item {
            display: block;
            text-decoration: none;
            font-size: 0.9rem;
            color: var(--c-text-secondary);
            padding: var(--sp-xs) var(--sp-sm);
            border-radius: 4px;
            transition: color 0.1s ease, background-color 0.1s ease;
        }

        .nav-item:hover {
            color: var(--c-text-primary);
            background-color: rgba(0, 0, 0, 0.03);
            /* Extremely subtle */
            text-decoration: underline;
            text-decoration-color: var(--c-line);
            text-decoration-thickness: 1px;
        }

        .nav-item.active {
            color: var(--c-nav-active);
            font-weight: 700;
            background-color: rgba(0, 0, 0, 0.05);
        }

        /* PAPER CONTENT STREAM */
        .paper-stream {
            flex-grow: 1;
            padding-bottom: 20vh;
            /* Bottom buffer */
            background-color: var(--c-paper-bg);
            min-height: 80vh;
            /* No borders, just whitespace */
        }

        /* QUESTION UNIT */
        .question-unit {
            margin-bottom: var(--sp-xxl);
            /* RHYTHM: Largest gap */
            scroll-margin-top: 4rem;
            /* For sticky nav offset */
            position: relative;
        }

        /* Nesting indentation */
        .question-unit.depth-1 {
            margin-left: var(--sp-lg);
            margin-bottom: var(--sp-lg);
        }

        .question-unit.depth-2 {
            margin-left: calc(var(--sp-lg) * 2);
            margin-bottom: var(--sp-md);
        }

        /* Question Header */
        .q-header {
            display: flex;
            gap: var(--sp-md);
            margin-bottom: var(--sp-lg);
        }

        .q-number {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--c-text-secondary);
            min-width: 2rem;
            flex-shrink: 0;
        }

        .q-prompt {
            font-size: 1.1rem;
            color: var(--c-text-primary);
            max-width: 65ch;
        }

        /* Diagrams */
        .diagram-container {
            margin: var(--sp-md) 0;
            padding: var(--sp-md);
            background: #fff;
            border: 1px solid var(--c-line);
            display: inline-block;
            max-width: 100%;
        }

        .diagram-svg {
            display: block;
            max-width: 100%;
            height: auto;
        }

        /* Answer Block */
        .answer-block {
            margin-left: calc(2rem + var(--sp-md));
            /* Align with text */
            margin-bottom: var(--sp-md);
            display: flex;
            align-items: baseline;
            gap: var(--sp-sm);
        }

        .answer-label {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--c-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .answer-value {
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--c-text-primary);
        }

        /* Solution Details Wrapper */
        .solution-wrapper {
            margin-left: calc(2rem + var(--sp-md));
        }

        /* Text Disclosure Control */
        .disclosure-btn {
            font-size: 0.95rem;
            color: var(--c-text-secondary);
            display: flex;
            align-items: center;
            gap: var(--sp-xs);
            padding: var(--sp-xs) 0;
            transition: color 0.1s;
        }

        .disclosure-btn:hover {
            color: var(--c-text-primary);
            text-decoration: underline;
        }

        .disclosure-icon {
            width: 0.8em;
            height: 0.8em;
            transition: transform 0.2s ease;
            fill: currentColor;
        }

        .disclosure-btn[aria-expanded="true"] .disclosure-icon {
            transform: rotate(180deg);
        }

        /* Solution Content Region */
        .solution-details {
            display: none;
            /* Collapsed by default */
            margin-top: var(--sp-sm);
            background-color: var(--c-solution-bg);
            /* Subtle surface separation */
            padding: var(--sp-md) var(--sp-lg);
            border-radius: 4px;
            /* Typography inside solution */
            font-size: 1rem;
            line-height: var(--lh-dense);
        }

        .solution-details.open {
            display: block;
            animation: fadeInSlide 0.2s ease-out;
        }

        @keyframes fadeInSlide {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Solution Subsections */
        .sol-section {
            margin-bottom: var(--sp-lg);
        }

        .sol-section:last-child {
            margin-bottom: 0;
        }

        .sol-label {
            display: block;
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--c-text-secondary);
            margin-bottom: var(--sp-xs);
            text-transform: uppercase;
        }

        .sol-content {
            color: var(--c-text-primary);
        }

        /* MATH STYLES */
        .katex-placeholder {
            font-family: "Courier New", monospace;
            background: rgba(0, 0, 0, 0.05);
            padding: 0 0.2em;
            border-radius: 2px;
            font-size: 0.9em;
        }

        .katex-block-scroll {
            overflow-x: auto;
            padding-bottom: 0.5rem;
            margin-bottom: 0.5rem;
        }

        /* Allow KaTeX to be legible */
        .katex-display {
            margin: 0.5em 0;
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .content-frame {
                flex-direction: column;
                gap: 0;
            }

            .nav-rail {
                display: none;
                /* Hidden by default on mobile, triggered by menu */
                width: 100%;
                height: auto;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: var(--c-page-bg);
                z-index: 200;
                padding: var(--sp-xl) var(--sp-md);
            }

            .nav-rail.mobile-open {
                display: block;
            }

            .paper-stream {
                padding-top: var(--sp-lg);
            }

            /* Mobile Toggle */
            .mobile-nav-toggle {
                display: block;
            }

            /* Adjust spacing for mobile */
            .question-unit {
                margin-bottom: var(--sp-xl);
            }

            .answer-block,
            .solution-wrapper {
                margin-left: 0;
            }

            .q-header {
                flex-direction: column;
                gap: var(--sp-xs);
            }
        }

        @media (min-width: 769px) {
            .mobile-nav-toggle {
                display: none;
            }
        }
    </style>
</head>

<body>

    <div class="app-shell">
        <header class="top-controls">
            <div class="controls-group">
                <label class="controls-label" for="paper-select">Paper:</label>
                <select id="paper-select">
                    <option value="short">Short Paper (6 questions)</option>
                    <option value="standard">Standard Paper (35 questions)</option>
                    <option value="diagram">Diagram-Heavy (20 questions)</option>
                    <option value="sectioned">Sectioned Paper (A/B/C)</option>
                    <option value="std-expanded">Stress Test: Workings Expanded</option>
                </select>
            </div>

            <div class="controls-group">
                <div class="mobile-nav-toggle">
                    <button id="nav-toggle-btn" aria-label="Toggle navigation">
                        <span style="font-weight:700; font-size:1.1rem;">☰ Menu</span>
                    </button>
                </div>

                <label class="controls-label">
                    <input type="checkbox" id="katex-toggle"> Real KaTeX Rendering
                </label>
            </div>
        </header>

        <div class="content-frame">
            <nav class="nav-rail" id="nav-rail" aria-label="Question navigation">
                <div id="nav-close-mobile" style="text-align:right; margin-bottom:1rem; display:none;">
                    <button style="font-size:1.5rem; padding:0.5rem;">×</button>
                </div>
            </nav>

            <main class="paper-stream" id="paper-content">
            </main>
        </div>
    </div>

    <script>
        /**
         * RTQ PROTOTYPE LOGIC
         * Strict adherence to Stage 3/4/5 constraints.
         */

        /* --- STATE & CONFIG --- */
        const STATE = {
            paperId: 'short',
            useRealKatex: false,
            questions: []
        };

        /* --- GENERATORS --- */

        // SVG Generators for Grayscale Diagrams
        const SVG_LIB = {
            geometry: () => `
        <svg viewBox="0 0 200 150" class="diagram-svg" width="200" height="150">
            <polygon points="20,130 100,20 180,130" fill="none" stroke="#333" stroke-width="2"/>
            <circle cx="100" cy="90" r="30" fill="none" stroke="#666" stroke-dasharray="4"/>
            <text x="90" y="145" font-size="12" fill="#333">12cm</text>
            <text x="145" y="70" font-size="12" fill="#333">x</text>
        </svg>`,
            bar: () => `
        <svg viewBox="0 0 200 100" class="diagram-svg" width="200" height="100">
            <rect x="20" y="20" width="40" height="60" fill="#ddd"/>
            <rect x="70" y="40" width="40" height="40" fill="#bbb"/>
            <rect x="120" y="10" width="40" height="70" fill="#999"/>
            <line x1="20" y1="80" x2="180" y2="80" stroke="#333" stroke-width="1"/>
        </svg>`,
            grid: () => `
        <svg viewBox="0 0 150 150" class="diagram-svg" width="150" height="150">
            <defs><pattern id="g" width="20" height="20" patternUnits="userSpaceOnUse"><path d="M 20 0 L 0 0 0 20" fill="none" stroke="#eee" stroke-width="1"/></pattern></defs>
            <rect width="100%" height="100%" fill="url(#g)" />
            <line x1="10" y1="75" x2="140" y2="75" stroke="#333" stroke-width="1"/>
            <line x1="75" y1="10" x2="75" y2="140" stroke="#333" stroke-width="1"/>
            <line x1="20" y1="130" x2="130" y2="20" stroke="#333" stroke-width="2"/>
        </svg>`,
            table: () => `
        <svg viewBox="0 0 200 80" class="diagram-svg" width="200" height="80">
            <rect x="0" y="0" width="200" height="80" fill="none" stroke="#ccc"/>
            <line x1="0" y1="40" x2="200" y2="40" stroke="#ccc"/>
            <line x1="100" y1="0" x2="100" y2="80" stroke="#ccc"/>
            <text x="20" y="25" font-size="12" fill="#333">Item A</text>
            <text x="120" y="25" font-size="12" fill="#333">£4.50</text>
            <text x="20" y="65" font-size="12" fill="#333">Item B</text>
            <text x="120" y="65" font-size="12" fill="#333">£2.20</text>
        </svg>`
        };

        // Math Generation (Placeholder vs KaTeX)
        const renderMath = (latex, displayMode = false) => {
            if (STATE.useRealKatex && window.katex) {
                try {
                    return katex.renderToString(latex, { displayMode: displayMode, throwOnError: false });
                } catch (e) {
                    return `<span class="katex-error">${latex}</span>`;
                }
            } else {
                return displayMode
                    ? `<div class="katex-placeholder">[Block Math: ${latex}]</div>`
                    : `<span class="katex-placeholder">[${latex}]</span>`;
            }
        };

        /* --- DATASET FACTORY --- */
        const createQuestion = (id, prompt, answer, workings, options = {}) => ({
            id,
            prompt,
            answer,
            workings, // Array of strings (steps)
            subParts: options.subParts || [],
            section: options.section || null,
            diagram: options.diagram || null,
            keepInMind: options.keepInMind || null,
            formulas: options.formulas || null,
            altWorking: options.altWorking || null,
            depth: options.depth || 0,
            forceExpand: options.forceExpand || false
        });

        const generatePapers = () => {
            // Helper to generate long dummy working
            const longWorking = Array(40).fill("x = \\frac{-b \\pm \\sqrt{b^2 - 4ac}}{2a}").map((s, i) => `${i + 1}. Step detail: ${s} + ${i}`);

            // 1. Short Paper
            const short = [
                createQuestion("1", "Calculate the sum of 145 and 382.", "527", ["145 + 382 = 527"]),
                createQuestion("2", "Find $x$ if $2x + 4 = 10$.", "x = 3", ["2x = 6", "x = 3"]),
                createQuestion("3", "Identify the shape.", "Isosceles Triangle", ["Two sides equal length."], { diagram: 'geometry' }),
                createQuestion("4", "Solve.", "Answer below", [], {
                    subParts: [
                        createQuestion("4a", "What is $5^2$?", "25", ["5 \\times 5 = 25"], { depth: 1 }),
                        createQuestion("4b", "What is $\\sqrt{81}$?", "9", ["9 \\times 9 = 81"], { depth: 1 })
                    ]
                }),
                createQuestion("5", "A longer word problem involving ratios.", "1:4", ["Total parts = 5", "Share = 20", "Ratio is 1:4"], { keepInMind: "Remember to simplify.", formulas: "Ratio formula" }),
                createQuestion("6", "Final algebra.", "y = 2", ["4y = 8", "y = 2"])
            ];

            // 2. Standard Paper (35 Qs)
            const standard = [];
            for (let i = 1; i <= 35; i++) {
                let opts = {};
                let workings = [`Step 1 for Q${i}`, `Step 2 result`];

                if (i >= 26) {
                    // Long algebra, collapsed defaults (handled by UI logic), potentially deep workings
                    workings = longWorking.slice(0, 10);
                    opts.altWorking = ["Alternative method using substitution..."];
                    opts.keepInMind = "Watch out for negative signs.";
                }

                // Deep nesting add-on logic (Stage 3 Add-on)
                if (i === 18) {
                    standard.push(createQuestion("18", "Complex multi-part question.", "See parts", [], {
                        subParts: [
                            createQuestion("18(a)", "First part", "10", ["Simple arithmetic"], {
                                depth: 1,
                                subParts: [
                                    createQuestion("18(a)(i)", "Inner part", "5", ["Half of 10"], { depth: 2 }),
                                    createQuestion("18(a)(ii)", "Inner part 2", "5", ["Half of 10"], { depth: 2 })
                                ]
                            }),
                            createQuestion("18(b)", "Second part", "15", ["10 + 5"], { depth: 1 })
                        ]
                    }));
                    continue;
                }

                standard.push(createQuestion(`${i}`, `Standard question text number ${i}. Solve for $x$.`, `${i * 2}`, workings, opts));
            }

            // 3. Diagram Heavy
            const diagram = [];
            const types = ['geometry', 'bar', 'grid', 'table'];
            for (let i = 1; i <= 20; i++) {
                let opts = {};
                if (i % 3 === 0) opts.diagram = types[i % 4];
                diagram.push(createQuestion(`${i}`, `Question ${i} refers to the diagram.`, "42", ["Analysis of diagram..."], opts));
            }

            // 4. Sectioned
            const sectioned = [];
            // Section A
            for (let i = 1; i <= 35; i++) sectioned.push(createQuestion(`${i}`, `Sec A Q${i}`, "Ans", ["Work"], { section: i === 1 ? 'Section A' : null }));
            // Section B
            for (let i = 36; i <= 43; i++) sectioned.push(createQuestion(`${i}`, `Sec B Q${i}`, "Ans", ["Work"], { section: i === 36 ? 'Section B' : null }));
            // Section C
            for (let i = 44; i <= 49; i++) sectioned.push(createQuestion(`${i}`, `Sec C Q${i}`, "Ans", longWorking, { section: i === 44 ? 'Section C' : null }));

            return { short, standard, diagram, sectioned };
        };

        /* --- RENDERER --- */

        const renderPaper = () => {
            const papers = generatePapers();
            let data;
            let forceAllOpen = false;

            if (STATE.paperId === 'std-expanded') {
                data = papers.standard;
                forceAllOpen = true;
            } else {
                data = papers[STATE.paperId];
            }

            const mainEl = document.getElementById('paper-content');
            const navEl = document.getElementById('nav-rail');

            // Clear existing
            mainEl.innerHTML = '';
            // Rebuild Nav (preserve mobile close button)
            const mobileClose = navEl.firstElementChild;
            navEl.innerHTML = '';
            navEl.appendChild(mobileClose);

            // Flatten recursive structure for linear rendering
            const flatList = [];
            const traverse = (qs) => {
                qs.forEach(q => {
                    flatList.push(q);
                    if (q.subParts && q.subParts.length > 0) traverse(q.subParts);
                });
            };
            traverse(data);

            flatList.forEach(q => {
                // 1. Build Nav Item
                if (q.section) {
                    const secLabel = document.createElement('div');
                    secLabel.className = 'nav-section-label';
                    secLabel.textContent = q.section;
                    navEl.appendChild(secLabel);
                }

                const navLink = document.createElement('a');
                navLink.className = 'nav-item';
                navLink.href = `#q-${q.id}`;
                navLink.textContent = q.id;
                navLink.dataset.target = `q-${q.id}`;
                navLink.onclick = (e) => {
                    e.preventDefault();
                    document.getElementById(`q-${q.id}`).scrollIntoView({ behavior: 'smooth' });
                    // Update active state
                    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                    navLink.classList.add('active');
                    // Mobile: close nav if open
                    if (window.innerWidth <= 768) toggleMobileNav(false);
                };
                navEl.appendChild(navLink);

                // 2. Build Question DOM
                const article = document.createElement('article');
                article.id = `q-${q.id}`;
                article.className = `question-unit depth-${q.depth}`;

                // Header (Number + Prompt)
                const header = document.createElement('div');
                header.className = 'q-header';
                header.innerHTML = `
            <div class="q-number">${q.id}</div>
            <div class="q-content">
                <div class="q-prompt">${renderMath(q.prompt)}</div>
                ${q.diagram ? `<div class="diagram-container">${SVG_LIB[q.diagram]()}</div>` : ''}
            </div>
        `;
                article.appendChild(header);

                // Answer (if leaf node or has answer)
                if (q.answer) {
                    const ansBlock = document.createElement('div');
                    ansBlock.className = 'answer-block';
                    ansBlock.innerHTML = `
                <span class="answer-label">Answer:</span>
                <span class="answer-value">${renderMath(q.answer)}</span>
            `;
                    article.appendChild(ansBlock);
                }

                // Solution Details (if has workings or extra info)
                const hasSol = (q.workings.length > 0 || q.keepInMind || q.formulas || q.altWorking);
                if (hasSol) {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'solution-wrapper';

                    // Toggle
                    const btn = document.createElement('button');
                    btn.className = 'disclosure-btn';
                    btn.setAttribute('aria-expanded', forceAllOpen ? 'true' : 'false');
                    btn.innerHTML = `
                <span>${forceAllOpen ? 'Hide working' : 'Show working'}</span>
                <svg class="disclosure-icon" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
            `;

                    // Details Body
                    const details = document.createElement('div');
                    details.className = `solution-details ${forceAllOpen ? 'open' : ''}`;

                    // Construct inner HTML order: Keep in Mind -> Formulas -> Working -> Alt
                    let html = '';

                    if (q.keepInMind) {
                        html += `<div class="sol-section">
                    <span class="sol-label">Keep in mind</span>
                    <div class="sol-content">${renderMath(q.keepInMind)}</div>
                </div>`;
                    }
                    if (q.formulas) {
                        html += `<div class="sol-section">
                    <span class="sol-label">Formulas used</span>
                    <div class="sol-content">${renderMath(q.formulas)}</div>
                </div>`;
                    }
                    if (q.workings.length > 0) {
                        html += `<div class="sol-section">
                    <span class="sol-label">Working</span>
                    <div class="sol-content">
                        ${q.workings.map(line => `<div class="katex-block-scroll">${renderMath(line, true)}</div>`).join('')}
                    </div>
                </div>`;
                    }
                    if (q.altWorking) {
                        html += `<div class="sol-section">
                    <span class="sol-label">Alternative working</span>
                    <div class="sol-content">
                        ${q.altWorking.map(line => `<div class="katex-block-scroll">${renderMath(line, true)}</div>`).join('')}
                    </div>
                </div>`;
                    }

                    details.innerHTML = html;

                    // Interaction Event
                    btn.onclick = () => {
                        const isOpen = details.classList.contains('open');
                        if (isOpen) {
                            details.classList.remove('open');
                            btn.setAttribute('aria-expanded', 'false');
                            btn.querySelector('span').textContent = 'Show working';
                        } else {
                            details.classList.add('open');
                            btn.setAttribute('aria-expanded', 'true');
                            btn.querySelector('span').textContent = 'Hide working';
                        }
                    };

                    wrapper.appendChild(btn);
                    wrapper.appendChild(details);
                    article.appendChild(wrapper);
                }

                mainEl.appendChild(article);
            });
        };

        /* --- MOBILE NAV LOGIC --- */
        const toggleMobileNav = (show) => {
            const nav = document.getElementById('nav-rail');
            const closeBtn = document.getElementById('nav-close-mobile');
            if (show) {
                nav.classList.add('mobile-open');
                closeBtn.style.display = 'block';
            } else {
                nav.classList.remove('mobile-open');
                closeBtn.style.display = 'none';
            }
        };

        /* --- INITIALIZATION --- */
        document.addEventListener('DOMContentLoaded', () => {
            // Event Listeners
            document.getElementById('paper-select').addEventListener('change', (e) => {
                STATE.paperId = e.target.value;
                renderPaper();
            });

            document.getElementById('katex-toggle').addEventListener('change', (e) => {
                STATE.useRealKatex = e.target.checked;
                renderPaper();
            });

            document.getElementById('nav-toggle-btn').addEventListener('click', () => {
                toggleMobileNav(true);
            });

            document.getElementById('nav-close-mobile').querySelector('button').addEventListener('click', () => {
                toggleMobileNav(false);
            });

            // Observer for Scroll Spy (Optional but good for sticky nav)
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const id = entry.target.id;
                        document.querySelectorAll('.nav-item').forEach(n => {
                            n.classList.toggle('active', n.dataset.target === id);
                        });
                    }
                });
            }, { threshold: 0.1, rootMargin: "-10% 0px -80% 0px" });

            // Initial Render
            renderPaper();

            // Attach observer after render
            // (Simple implementation: re-attach on render needed in full app, 
            // here we just rely on click-to-activate for simplicity/robustness in prototype)
        });

    </script>
</body>

</html>