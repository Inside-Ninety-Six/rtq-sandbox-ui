<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"ABC","indexWithinVariant":"247","totalWithinVariant":"320","hueFamily":"cyan","intensityMode":"high_chroma_surfaces","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-09T21:52:13.245Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;ABC&quot;,&quot;indexWithinVariant&quot;:&quot;247&quot;,&quot;totalWithinVariant&quot;:&quot;320&quot;,&quot;hueFamily&quot;:&quot;cyan&quot;,&quot;intensityMode&quot;:&quot;high_chroma_surfaces&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-09T21:52:13.245Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Viewer</title>

    <!-- Tailwind CSS (Prototyping) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- KaTeX CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <!-- Markdown-it -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <!-- KaTeX JS & Auto-render -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        page: 'var(--surf-page)',
                        frame: 'var(--surf-frame)',
                        paper: 'var(--surf-paper)',
                        wash: 'var(--surf-wash)',
                        primary: 'var(--text-primary)',
                        secondary: 'var(--text-secondary)',
                        accent: 'var(--accent)',
                        hairline: 'var(--line-hairline)',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        /* 
           STAGE 6 ADD-ON: COLORLAB C - High Chroma Surfaces (Cyan)
           Mode: high_chroma_surfaces
           Hue: Cyan (~210)
           Light Mode Only
        */
        :root {
            /* Palette Definition OKLCH */
            /* High Chroma Surfaces: 2 major surfaces C in [0.06..0.12], remaining major C in [0.03..0.07] */
            
            /* Page Background (Chromatic) */
            --surf-page: oklch(0.93 0.08 210);
            
            /* Frame Base (Chromatic - Navigation sits here) */
            --surf-frame: oklch(0.91 0.09 210); 
            
            /* Paper Surface (Tinted - Content sits here) */
            --surf-paper: oklch(0.985 0.03 210);
            
            /* Solution Details Wash (High Chroma Wash C in 0.05..0.10) */
            --surf-wash: oklch(0.95 0.07 210);
            
            /* Text (Near Neutral) */
            --text-primary: oklch(0.25 0.015 210);
            --text-secondary: oklch(0.45 0.02 210);
            
            /* Accent (Restrained but visible, C in 0.12..0.20) */
            --accent: oklch(0.55 0.18 210);
            
            /* Hairlines */
            --line-hairline: oklch(0.85 0.04 210);
        }

        body {
            background-color: var(--surf-page);
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
        }

        /* Scrollbar hiding utility for navigation */
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* KaTeX Containment Invariant */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding-bottom: 4px; /* Space for scrollbar if needed */
        }
        
        /* Markdown Content Styling */
        .markdown-body p {
            margin-bottom: 0.75em;
            line-height: 1.6;
        }
        .markdown-body p:last-child {
            margin-bottom: 0;
        }
        .markdown-body ul {
            list-style-type: disc;
            padding-left: 1.5em;
            margin-bottom: 0.75em;
        }
        .markdown-body ol {
            list-style-type: decimal;
            padding-left: 1.5em;
            margin-bottom: 0.75em;
        }
        .markdown-body table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 1em;
            font-size: 0.95em;
        }
        .markdown-body th, .markdown-body td {
            border: 1px solid var(--line-hairline);
            padding: 0.5em;
            text-align: left;
        }
        .markdown-body th {
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Utility for transition continuity */
        .transition-height {
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
        }

        /* Focus styles */
        :focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col font-sans">

    <div id="app-root" class="flex-grow flex flex-col">
        <!-- Render target -->
    </div>

    <script>
        // --- STAGE 0: CONSTANTS ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";

        // --- MARKDOWN SETUP (Stage 6 Add-on) ---
        const md = window.markdownit ? window.markdownit({
            html: true, // Allow inline SVG
            linkify: true,
            breaks: false // Critical: prevents <br> inside Math
        }) : null;

        if (md) {
            md.inline.ruler.disable(['escape']); // Preserve TeX backslashes
        }

        // --- STATE ---
        let state = {
            papers: [],
            currentPaperId: null,
            expandedNodes: new Set(), // Set of question IDs with expanded workings
            mobileNavOpen: false,
            loading: true,
            error: false
        };

        // --- INITIALIZATION ---
        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Payload not found");
                const payload = await response.json();
                
                state.papers = payload.papers || [];
                if (state.papers.length > 0) {
                    // Default to first paper
                    selectPaper(state.papers[0].key);
                } else {
                    state.error = true;
                }
            } catch (err) {
                console.error(err);
                state.error = true;
            } finally {
                state.loading = false;
                renderApp();
            }
        }

        function selectPaper(paperKey) {
            const paper = state.papers.find(p => p.key === paperKey);
            if (!paper) return;

            state.currentPaperId = paperKey;
            
            // Handle defaults
            const defaults = paper.defaults || {};
            const expandedAll = defaults.expandedAll !== false; // Default true unless false

            state.expandedNodes.clear();
            
            // If default expanded, we need to walk the tree to know which IDs exist? 
            // Actually simpler: we can just check during render. 
            // But to support toggle logic properly, we ideally track explicitly.
            // For this prototype, we will treat 'expandedNodes' as a set of *explicitly toggled* states if we wanted complex logic,
            // but for "Expanded by Default", it's easier to track "Collapsed" nodes if default is true.
            // Let's invert: state.collapsedNodes.
            
            state.expandedByDefault = expandedAll;
            state.toggledNodes = new Set(); // Stores IDs that deviate from default
            
            // Reset scroll
            window.scrollTo(0, 0);
            renderApp();
        }

        function isExpanded(nodeId) {
            const explicitlyToggled = state.toggledNodes.has(nodeId);
            if (explicitlyToggled) {
                return !state.expandedByDefault;
            }
            return state.expandedByDefault;
        }

        function toggleNode(nodeId) {
            if (state.toggledNodes.has(nodeId)) {
                state.toggledNodes.delete(nodeId);
            } else {
                state.toggledNodes.add(nodeId);
            }
            renderApp(); // Re-render to update DOM
        }

        function toggleMobileNav() {
            state.mobileNavOpen = !state.mobileNavOpen;
            renderApp();
        }

        function scrollToQuestion(id) {
            // Close mobile nav if open
            if (state.mobileNavOpen) {
                state.mobileNavOpen = false;
                renderApp();
            }
            
            // Wait for render cycle
            setTimeout(() => {
                const el = document.getElementById(`q-${id}`);
                if (el) {
                    el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 50);
        }

        // --- RENDERING ---

        function renderApp() {
            const root = document.getElementById('app-root');
            root.innerHTML = '';

            if (state.loading) {
                root.innerHTML = `<div class="p-8 text-center text-secondary">Loading...</div>`;
                return;
            }

            if (state.error || state.papers.length === 0) {
                // FAILURE MODE (Stage 3/6 deterministic)
                renderShell(root, `<div class="p-12 text-center text-xl font-bold text-primary">PAPERS PAYLOAD MISSING</div>`);
                return;
            }

            const currentPaper = state.papers.find(p => p.key === state.currentPaperId);
            const contentHTML = renderPaperContent(currentPaper);
            renderShell(root, contentHTML, currentPaper);
            
            // Post-render: KaTeX
            renderMathInElement(root, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false}
                ],
                throwOnError: false
            });
        }

        function renderShell(root, contentHTML, currentPaper) {
            // Top Controls
            const header = document.createElement('header');
            header.className = "sticky top-0 z-40 bg-frame border-b border-hairline px-4 h-14 flex items-center justify-between lg:justify-start lg:gap-8";
            
            // Paper Selector
            const selector = document.createElement('select');
            selector.className = "bg-paper border border-hairline rounded px-3 py-1 text-sm text-primary focus:border-accent outline-none";
            selector.onchange = (e) => selectPaper(e.target.value);
            state.papers.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.key;
                opt.text = p.label;
                opt.selected = p.key === state.currentPaperId;
                selector.appendChild(opt);
            });
            header.appendChild(selector);

            // Mobile Jump To Trigger
            const jumpBtn = document.createElement('button');
            jumpBtn.className = "lg:hidden text-sm font-medium text-accent";
            jumpBtn.textContent = "Jump to";
            jumpBtn.onclick = toggleMobileNav;
            header.appendChild(jumpBtn);

            root.appendChild(header);

            // DocumentFrameShell
            const frame = document.createElement('div');
            frame.className = "flex-grow flex justify-center bg-frame";
            
            const innerShell = document.createElement('div');
            innerShell.className = "w-full max-w-7xl flex relative"; 
            
            // Navigation (Desktop)
            const navRail = document.createElement('aside');
            navRail.className = "hidden lg:block w-64 flex-shrink-0 sticky top-14 h-[calc(100vh-3.5rem)] overflow-y-auto no-scrollbar py-8 pl-6 pr-4 border-r border-transparent"; // Quiet nav
            if (currentPaper) {
                navRail.innerHTML = renderNavList(currentPaper, false);
            }
            innerShell.appendChild(navRail);

            // Paper Content Column
            const mainCol = document.createElement('main');
            mainCol.className = "flex-grow min-w-0 py-8 px-4 lg:px-12";
            mainCol.innerHTML = contentHTML;
            innerShell.appendChild(mainCol);

            frame.appendChild(innerShell);
            root.appendChild(frame);

            // Mobile Navigation Drawer
            if (state.mobileNavOpen && currentPaper) {
                const drawerOverlay = document.createElement('div');
                drawerOverlay.className = "fixed inset-0 z-50 flex justify-end";
                
                const scrim = document.createElement('div');
                scrim.className = "absolute inset-0 bg-black/20";
                scrim.onclick = toggleMobileNav;
                drawerOverlay.appendChild(scrim);

                const drawer = document.createElement('div');
                drawer.className = "relative w-64 bg-frame h-full shadow-xl flex flex-col";
                
                const drawerHeader = document.createElement('div');
                drawerHeader.className = "h-14 border-b border-hairline flex items-center justify-between px-4";
                drawerHeader.innerHTML = `
                    <span class="font-bold text-primary">Jump to</span>
                    <button class="text-secondary hover:text-primary px-2" onclick="toggleMobileNav()">âœ•</button>
                `;
                drawer.appendChild(drawerHeader);

                const drawerContent = document.createElement('div');
                drawerContent.className = "flex-1 overflow-y-auto p-4";
                drawerContent.innerHTML = renderNavList(currentPaper, true);
                drawer.appendChild(drawerContent);

                drawerOverlay.appendChild(drawer);
                root.appendChild(drawerOverlay);
            }
        }

        // --- NAVIGATION RENDERING ---
        function renderNavList(paper, isMobile) {
            let html = '<nav class="space-y-4" aria-label="Question navigation">';
            
            // Helper to render recursively or linearly?
            // Payload is structured. We need a flat list representation of IDs for nav.
            // We'll walk the tree.
            
            const renderNodes = (nodes) => {
                let s = '';
                nodes.forEach(node => {
                    const depthClass = node.children && node.children.length > 0 ? 'font-medium text-primary' : 'text-secondary font-normal text-sm';
                    // Indentation logic: Flat list visual, but hierarchy via type scale/quietness. 
                    // Brief: "no nested visual indentation... hierarchy expressed only via restrained type scale"
                    // Actually, simple list is best.
                    
                    s += `<div class="py-0.5 cursor-pointer hover:text-accent transition-colors ${depthClass}" onclick="scrollToQuestion('${node.id}')">${node.id}</div>`;
                    
                    if (node.children) {
                        s += renderNodes(node.children);
                    }
                });
                return s;
            };

            if (paper.sections) {
                paper.sections.forEach(sec => {
                    html += `<div class="mb-4">`;
                    if (sec.label && sec.label.trim().length > 0) {
                        html += `<div class="text-xs font-bold text-secondary uppercase tracking-wider mb-2 select-none">${sec.label}</div>`;
                    }
                    html += `<div class="flex flex-col gap-1">`;
                    html += renderNodes(sec.questions);
                    html += `</div></div>`;
                });
            } else if (paper.questions) {
                html += `<div class="flex flex-col gap-1">`;
                html += renderNodes(paper.questions);
                html += `</div>`;
            }

            html += '</nav>';
            return html;
        }

        // --- CONTENT RENDERING ---

        function renderPaperContent(paper) {
            if (!paper) return '';
            
            let html = `<div class="bg-paper max-w-3xl mx-auto shadow-sm min-h-[50vh] pb-16">`; // Paper surface
            
            // Render Questions
            if (paper.sections) {
                paper.sections.forEach((sec, idx) => {
                    if (sec.label && sec.label.trim().length > 0) {
                        // Section Header
                        html += `
                            <div class="px-8 pt-12 pb-4 border-b border-hairline mb-8">
                                <h2 class="text-2xl font-bold text-primary">${sec.label}</h2>
                            </div>
                        `;
                    } else if (idx > 0) {
                         // Separation between sections even if label hidden
                         html += `<div class="h-12"></div>`;
                    }
                    html += `<div class="px-6 lg:px-12 flex flex-col gap-12">`;
                    sec.questions.forEach(q => {
                        html += renderQuestionNode(q, 0);
                    });
                    html += `</div>`;
                });
            } else if (paper.questions) {
                html += `<div class="px-6 lg:px-12 py-12 flex flex-col gap-12">`;
                paper.questions.forEach(q => {
                    html += renderQuestionNode(q, 0);
                });
                html += `</div>`;
            }

            html += `</div>`;
            return html;
        }

        function renderQuestionNode(node, depth) {
            const indentClass = depth > 0 ? `ml-4 lg:ml-8 border-l-2 border-transparent` : ''; // Minimal indentation for children
            const verticalSpacing = depth > 0 ? 'mt-6' : ''; // Tighter for children
            
            let html = `<div id="q-${node.id}" class="scroll-mt-20 ${indentClass} ${verticalSpacing} group">`;
            
            // 1. Question Body
            html += `<div class="flex gap-4">`;
            // Identifier
            html += `<div class="flex-shrink-0 w-8 lg:w-12 text-secondary font-semibold text-right pt-0.5 select-none">${node.id}</div>`;
            // Content
            html += `<div class="flex-grow min-w-0">`;
            
            // Prompt
            html += `<div class="text-lg text-primary markdown-body mb-4">${md ? md.render(node.question) : node.question}</div>`;
            
            // 2. Solution Block (Optional)
            if (node.solutionBlock) {
                // Wrapper
                html += `<div class="mt-4 pt-4 border-t border-hairline/50">`; // Subtle boundary check
                
                // Answer
                if (node.solutionBlock.answer) {
                    html += `
                        <div class="mb-4">
                            <div class="text-xs font-bold text-secondary uppercase tracking-wider mb-1">Answer</div>
                            <div class="text-primary font-medium markdown-body">${md ? md.render(node.solutionBlock.answer) : node.solutionBlock.answer}</div>
                        </div>
                    `;
                }

                // Solution Details
                if (node.solutionBlock.solutionDetails) {
                    const expanded = isExpanded(node.id);
                    const btnText = expanded ? "Hide working" : "Show working";
                    const iconRot = expanded ? "rotate-180" : "";
                    
                    // Disclosure Control
                    html += `
                        <button 
                            onclick="toggleNode('${node.id}')"
                            class="flex items-center gap-2 text-sm font-medium text-accent hover:underline focus:outline-none mb-2 select-none"
                            aria-expanded="${expanded}"
                        >
                            <span>${btnText}</span>
                            <svg class="w-4 h-4 transition-transform ${iconRot}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                    `;

                    // Details Region
                    if (expanded) {
                        const sd = node.solutionBlock.solutionDetails;
                        html += `<div class="bg-wash rounded-sm p-4 lg:p-6 mt-2 animate-fade-in border border-hairline/30">`; // Wash surface
                        
                        // Keep in mind
                        if (sd.keepInMind) {
                            html += `
                                <div class="mb-6">
                                    <div class="text-xs font-bold text-accent uppercase tracking-wider mb-2">Keep in mind</div>
                                    <div class="text-sm text-secondary markdown-body">${md ? md.render(sd.keepInMind) : sd.keepInMind}</div>
                                </div>
                            `;
                        }

                        // Formulas used
                        if (sd.formulasUsed) {
                            html += `
                                <div class="mb-6">
                                    <div class="text-xs font-bold text-secondary uppercase tracking-wider mb-2">Formulas used</div>
                                    <div class="text-sm text-secondary markdown-body">${md ? md.render(sd.formulasUsed) : sd.formulasUsed}</div>
                                </div>
                            `;
                        }

                        // Working (Primary)
                        if (sd.working) {
                            html += `
                                <div class="mb-6">
                                    <div class="text-xs font-bold text-secondary uppercase tracking-wider mb-2">Working</div>
                                    <div class="text-base text-primary markdown-body">${md ? md.render(sd.working) : sd.working}</div>
                                </div>
                            `;
                        }

                        // Alternative working
                        if (sd.alternativeWorking && Array.isArray(sd.alternativeWorking)) {
                            sd.alternativeWorking.forEach((alt, idx) => {
                                html += `
                                    <div class="mt-8 pt-6 border-t border-hairline">
                                        <div class="text-xs font-bold text-secondary uppercase tracking-wider mb-2">Alternative working</div>
                                        <div class="text-base text-primary markdown-body">${md ? md.render(alt) : alt}</div>
                                    </div>
                                `;
                            });
                        }
                        
                        html += `</div>`; // End wash
                    }
                }
                
                html += `</div>`; // End Solution Block Wrapper
            }

            // Children
            if (node.children && node.children.length > 0) {
                html += `<div class="mt-4">`;
                node.children.forEach(child => {
                    html += renderQuestionNode(child, depth + 1);
                });
                html += `</div>`;
            }

            html += `</div>`; // End Content Col
            html += `</div>`; // End Flex Row
            html += `</div>`; // End Node ID wrapper
            return html;
        }

        // Start
        init();

    </script>
</body>
</html>
