<!DOCTYPE html>
<html lang="en" class="antialiased light">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AB","indexWithinVariant":"146","totalWithinVariant":"200","hueFamily":"blue","intensityMode":"","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-08T19:51:18.502Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AB&quot;,&quot;indexWithinVariant&quot;:&quot;146&quot;,&quot;totalWithinVariant&quot;:&quot;200&quot;,&quot;hueFamily&quot;:&quot;blue&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-08T19:51:18.502Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>

    <!-- Fonts: Inter for modern, neutral, readable typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- KaTeX CSS (No Integrity, No SRI) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <!-- Tailwind CSS (CDN for prototyping) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class', // Forced light mode per instructions, but setup clean
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        // ColorLab B: Forced Hue = Blue
                        // Using Slate for neutrals (cool/paper-like) and Blue for accents
                        border: "hsl(214.3, 31.8%, 91.4%)", // Slate-200
                        input: "hsl(214.3, 31.8%, 91.4%)",
                        ring: "hsl(221.2, 83.2%, 53.3%)", // Blue-600
                        background: "hsl(0, 0%, 100%)",
                        foreground: "hsl(222.2, 84%, 4.9%)", // Slate-950
                        primary: {
                            DEFAULT: "hsl(221.2, 83.2%, 53.3%)", // Blue-600
                            foreground: "hsl(210, 40%, 98%)",
                        },
                        secondary: {
                            DEFAULT: "hsl(210, 40%, 96.1%)", // Slate-100
                            foreground: "hsl(222.2, 47.4%, 11.2%)", // Slate-900
                        },
                        muted: {
                            DEFAULT: "hsl(210, 40%, 96.1%)", // Slate-100
                            foreground: "hsl(215.4, 16.3%, 46.9%)", // Slate-500
                        },
                        accent: {
                            DEFAULT: "hsl(210, 40%, 96.1%)", // Slate-100
                            foreground: "hsl(222.2, 47.4%, 11.2%)", // Slate-900
                        },
                        paper: {
                            wash: "hsl(210, 20%, 99%)", // Very subtle cool wash for solution details
                        }
                    }
                }
            }
        }
    </script>

    <!-- KaTeX JS (No Integrity) -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Markdown-it (No Integrity) -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <style>
        /* Base Resets & Typography */
        body {
            background-color: #ffffff;
            color: #0f172a; /* Slate-900 */
            -webkit-font-smoothing: antialiased;
        }

        /* Layout & Scroll */
        html {
            scroll-behavior: smooth;
        }

        /* Nav Scrollbar Hiding */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* KaTeX Containment & Overflow Safety */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding-bottom: 4px; /* Space for scrollbar if needed */
            -webkit-overflow-scrolling: touch;
            margin: 1em 0;
            background: transparent !important; /* Block math only, handled via container if needed */
        }
        
        /* Inline math protection */
        .katex {
            background-color: transparent !important;
        }

        /* Solution Details Demarcation - Subtle wash, no framing */
        .solution-details-region {
            background-color: #f8fafc; /* Slate-50/Blue-50 mix equivalent */
            border-left: 2px solid transparent; 
            /* Optional left border for rhythm, transparent by default, 
               could be border-slate-100 if density requires */
        }

        /* Focus States */
        :focus-visible {
            outline: 2px solid #2563eb; /* Blue-600 */
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* Markdown Content Styling */
        .markdown-content p {
            margin-bottom: 0.75em;
            line-height: 1.6;
        }
        .markdown-content p:last-child {
            margin-bottom: 0;
        }
        .markdown-content ul {
            list-style-type: disc;
            padding-left: 1.25em;
            margin-bottom: 0.75em;
        }
        .markdown-content ol {
            list-style-type: decimal;
            padding-left: 1.25em;
            margin-bottom: 0.75em;
        }
        /* Minimal tables */
        .markdown-content table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1em;
            font-size: 0.95em;
        }
        .markdown-content th, .markdown-content td {
            border: 1px solid #e2e8f0; /* Slate-200 */
            padding: 0.5em;
            text-align: left;
        }
        .markdown-content th {
            font-weight: 600;
            background-color: transparent;
        }

        /* Mobile Drawer Animations */
        .drawer-enter {
            transform: translateX(-100%);
            opacity: 0;
        }
        .drawer-enter-active {
            transform: translateX(0);
            opacity: 1;
            transition: all 0.3s ease-out;
        }
        .drawer-exit {
            transform: translateX(0);
            opacity: 1;
        }
        .drawer-exit-active {
            transform: translateX(-100%);
            opacity: 0;
            transition: all 0.2s ease-in;
        }

        /* Utility */
        .hidden-visually {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
    </style>
</head>
<body class="bg-white min-h-screen flex flex-col">

    <!-- RUNTIME CONSTANTS & LOGIC -->
    <script>
        // --- STAGE 0: CONSTANTS ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";
        
        // --- ADD-ONS: ColorLab B ---
        const RTQ_COLORLAB_FORCE_HUE_FAMILY = "blue";
    </script>

    <!-- APP SHELL -->
    <div id="app" class="flex flex-col min-h-screen max-w-7xl mx-auto w-full">
        
        <!-- Top Controls Region -->
        <header class="sticky top-0 z-40 w-full bg-white/95 backdrop-blur supports-[backdrop-filter]:bg-white/60 border-b border-border h-16 flex items-center px-4 md:px-8">
            <div class="flex items-center w-full justify-between gap-4">
                <!-- Desktop: Placeholder for alignment / branding if needed, or just spacer -->
                <div class="hidden md:flex items-center gap-2 font-medium text-slate-900">
                    <span class="text-lg tracking-tight">Paper Viewer</span>
                </div>

                <!-- Paper Selector -->
                <div class="flex items-center gap-3 flex-1 md:flex-none justify-start md:justify-end">
                    <label for="paper-select" class="sr-only">Select Paper</label>
                    <select id="paper-select" class="h-9 w-full md:w-[280px] rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50">
                        <option value="" disabled selected>Loading papers...</option>
                    </select>
                </div>

                <!-- Mobile: Jump To Trigger -->
                <button id="mobile-menu-trigger" class="md:hidden inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 h-9 px-4 py-2 hover:bg-accent hover:text-accent-foreground group">
                    <span class="mr-2">Jump to</span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4 text-slate-500 group-hover:text-slate-900"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>
                </button>
            </div>
        </header>

        <!-- DocumentFrameShell -->
        <div class="flex-1 flex w-full relative">
            
            <!-- Desktop Navigation Rail (Sticky) -->
            <aside class="hidden md:block w-64 shrink-0 border-r border-border h-[calc(100vh-4rem)] sticky top-16 overflow-y-auto no-scrollbar py-6 pl-8 pr-4">
                <nav id="desktop-nav" class="flex flex-col gap-1 text-sm">
                    <!-- Nav items injected here -->
                    <div class="animate-pulse h-4 bg-slate-100 rounded w-3/4 mb-2"></div>
                    <div class="animate-pulse h-4 bg-slate-100 rounded w-1/2 mb-2"></div>
                    <div class="animate-pulse h-4 bg-slate-100 rounded w-2/3"></div>
                </nav>
            </aside>

            <!-- Paper Content Column -->
            <main class="flex-1 min-w-0">
                <div id="paper-content" class="px-4 py-8 md:px-12 md:py-10 max-w-4xl mx-auto space-y-12">
                    <!-- Content injected here -->
                    <div class="flex flex-col space-y-4">
                         <div class="h-6 bg-slate-100 rounded w-3/4 animate-pulse"></div>
                         <div class="h-24 bg-slate-50 rounded w-full animate-pulse"></div>
                    </div>
                </div>
            </main>

        </div>
    </div>

    <!-- Mobile Navigation Drawer -->
    <div id="mobile-drawer-overlay" class="fixed inset-0 z-50 bg-black/20 backdrop-blur-sm hidden transition-opacity opacity-0" aria-hidden="true"></div>
    <div id="mobile-drawer" class="fixed inset-y-0 left-0 z-50 w-3/4 max-w-sm bg-white shadow-xl transform -translate-x-full transition-transform duration-300 ease-in-out flex flex-col h-full border-r border-border" aria-hidden="true">
        <div class="flex items-center justify-between px-4 py-4 border-b border-border h-16">
            <h2 class="text-lg font-semibold tracking-tight">Jump to</h2>
            <button id="mobile-drawer-close" class="p-2 rounded-md hover:bg-accent text-slate-500 hover:text-slate-900">
                <span class="sr-only">Close menu</span>
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
            </button>
        </div>
        <div class="flex-1 overflow-y-auto py-4 px-4 no-scrollbar">
            <nav id="mobile-nav" class="flex flex-col gap-1 text-sm">
                <!-- Mobile nav items injected here -->
            </nav>
        </div>
    </div>

    <!-- MAIN SCRIPT -->
    <script>
        (function() {
            // --- STATE ---
            let appState = {
                papers: [],
                currentPaper: null,
                expandedState: {}, // key: questionNodeId, value: boolean
                md: null // Markdown instance
            };

            // --- DOM ELEMENTS ---
            const els = {
                paperSelect: document.getElementById('paper-select'),
                paperContent: document.getElementById('paper-content'),
                desktopNav: document.getElementById('desktop-nav'),
                mobileNav: document.getElementById('mobile-nav'),
                mobileTrigger: document.getElementById('mobile-menu-trigger'),
                mobileDrawer: document.getElementById('mobile-drawer'),
                mobileOverlay: document.getElementById('mobile-drawer-overlay'),
                mobileClose: document.getElementById('mobile-drawer-close')
            };

            // --- INITIALIZATION ---
            async function init() {
                // 1. Setup Markdown
                if (window.markdownit) {
                    appState.md = window.markdownit({
                        html: true,     // Payload requirement
                        linkify: true,
                        breaks: false   // Critical: prevents <br> in math
                    });
                    appState.md.inline.ruler.disable(['escape']); // Critical: preserve TeX backslashes
                } else {
                    console.error("Markdown-it failed to load.");
                    // Graceful degradation handled in render
                }

                // 2. Fetch Payload
                try {
                    const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                    if (!response.ok) throw new Error("Payload fetch failed");
                    const data = await response.json();
                    
                    if (!data.papers || !Array.isArray(data.papers)) {
                        throw new Error("Invalid payload structure");
                    }

                    appState.papers = data.papers;
                    renderPaperSelector();
                    
                    // Default to first paper
                    if (appState.papers.length > 0) {
                        loadPaper(appState.papers[0].key);
                    } else {
                        renderError("No papers found in payload.");
                    }

                } catch (e) {
                    console.error(e);
                    renderError("PAPERS PAYLOAD MISSING");
                }

                // 3. Event Listeners
                setupEventListeners();
            }

            function setupEventListeners() {
                // Paper switching
                els.paperSelect.addEventListener('change', (e) => {
                    loadPaper(e.target.value);
                });

                // Mobile Drawer
                function openDrawer() {
                    els.mobileDrawer.classList.remove('hidden');
                    els.mobileOverlay.classList.remove('hidden');
                    // Force reflow for transition
                    void els.mobileDrawer.offsetWidth;
                    
                    els.mobileDrawer.classList.remove('-translate-x-full');
                    els.mobileOverlay.classList.remove('opacity-0');
                    els.mobileDrawer.setAttribute('aria-hidden', 'false');
                    els.mobileOverlay.setAttribute('aria-hidden', 'false');
                    document.body.style.overflow = 'hidden'; // Prevent bg scroll
                }

                function closeDrawer() {
                    els.mobileDrawer.classList.add('-translate-x-full');
                    els.mobileOverlay.classList.add('opacity-0');
                    
                    setTimeout(() => {
                        els.mobileDrawer.classList.add('hidden');
                        els.mobileOverlay.classList.add('hidden');
                        els.mobileDrawer.setAttribute('aria-hidden', 'true');
                        els.mobileOverlay.setAttribute('aria-hidden', 'true');
                        document.body.style.overflow = '';
                    }, 300);
                }

                els.mobileTrigger.addEventListener('click', openDrawer);
                els.mobileClose.addEventListener('click', closeDrawer);
                els.mobileOverlay.addEventListener('click', closeDrawer);
                
                // Nav click handling (delegation)
                const handleNavClick = (e) => {
                    const link = e.target.closest('a[data-q-id]');
                    if (link) {
                        e.preventDefault();
                        const targetId = link.getAttribute('href').substring(1);
                        const targetEl = document.getElementById(targetId);
                        if (targetEl) {
                            // Smooth scroll with offset for sticky header
                            const headerOffset = 80;
                            const elementPosition = targetEl.getBoundingClientRect().top;
                            const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
                            window.scrollTo({
                                top: offsetPosition,
                                behavior: "smooth"
                            });
                            // Close drawer if open (mobile)
                            if (!els.mobileDrawer.classList.contains('hidden')) {
                                closeDrawer();
                            }
                        }
                    }
                };

                els.desktopNav.addEventListener('click', handleNavClick);
                els.mobileNav.addEventListener('click', handleNavClick);
            }

            // --- LOGIC ---

            function loadPaper(paperKey) {
                const paper = appState.papers.find(p => p.key === paperKey);
                if (!paper) return;

                appState.currentPaper = paper;
                appState.expandedState = {}; // Reset expansion state
                
                // Initialize defaults
                const expandAll = paper.defaults?.expandedAll !== false; // Default true unless false
                
                // Recursive function to set initial state
                const initExpanded = (nodes) => {
                    if (!nodes) return;
                    nodes.forEach(node => {
                        if (node.solutionBlock?.solutionDetails) {
                            appState.expandedState[node.id] = expandAll;
                        }
                        if (node.children) initExpanded(node.children);
                    });
                };

                if (paper.sections) {
                    paper.sections.forEach(s => initExpanded(s.questions));
                } else if (paper.questions) {
                    initExpanded(paper.questions);
                }

                renderPaper();
                renderNav();
            }

            function toggleSolution(nodeId) {
                appState.expandedState[nodeId] = !appState.expandedState[nodeId];
                
                // Re-render just the disclosure part? 
                // For simplicity in this prototype, we'll re-render the specific node's solution block logic
                // Or modify the DOM directly to avoid full page re-render glitching scroll.
                // Better: Toggle utility classes on the specific container.
                
                const region = document.getElementById(`solution-region-${nodeId}`);
                const btnText = document.getElementById(`toggle-text-${nodeId}`);
                const btnIcon = document.getElementById(`toggle-icon-${nodeId}`);
                
                if (region) {
                    const isExpanded = appState.expandedState[nodeId];
                    if (isExpanded) {
                        region.classList.remove('hidden');
                        if(btnText) btnText.textContent = "Hide working";
                        if(btnIcon) btnIcon.style.transform = "rotate(180deg)";
                    } else {
                        region.classList.add('hidden');
                        if(btnText) btnText.textContent = "Show working";
                        if(btnIcon) btnIcon.style.transform = "rotate(0deg)";
                    }
                }
            }

            // --- RENDERING HELPERS ---

            function mdRender(text) {
                if (!text) return "";
                if (!appState.md) return text; // Fallback
                return appState.md.render(text);
            }

            // --- RENDERERS ---

            function renderPaperSelector() {
                els.paperSelect.innerHTML = appState.papers.map(p => 
                    `<option value="${p.key}">${p.label}</option>`
                ).join('');
            }

            function renderError(msg) {
                els.paperContent.innerHTML = `
                    <div class="flex items-center justify-center h-64 border-2 border-dashed border-slate-200 rounded-lg">
                        <p class="text-slate-500 font-medium">${msg}</p>
                    </div>
                `;
                els.desktopNav.innerHTML = "";
                els.mobileNav.innerHTML = "";
            }

            function renderPaper() {
                const p = appState.currentPaper;
                let html = "";

                // Paper Header (if needed, but design brief implies minimal)
                // Using Sections or Flat list
                
                if (p.sections) {
                    p.sections.forEach(section => {
                        // Section Header (only if label exists)
                        if (section.label && section.label.trim().length > 0) {
                            html += `
                                <div class="mb-8 pt-4 border-b border-slate-100 pb-2">
                                    <h2 class="text-xl font-semibold text-slate-800">${section.label}</h2>
                                </div>
                            `;
                        }
                        // Questions
                        html += `<div class="space-y-12">`; // Spacing between top-level questions
                        section.questions.forEach(q => {
                            html += renderQuestionNode(q, 0);
                        });
                        html += `</div>`;
                        // Boundary between sections
                        html += `<div class="h-12"></div>`;
                    });
                } else if (p.questions) {
                    html += `<div class="space-y-12">`;
                    p.questions.forEach(q => {
                        html += renderQuestionNode(q, 0);
                    });
                    html += `</div>`;
                }

                els.paperContent.innerHTML = html;

                // Post-render: KaTeX
                if (window.renderMathInElement) {
                    renderMathInElement(els.paperContent, {
                        delimiters: [
                            {left: '$$', right: '$$', display: true},
                            {left: '$', right: '$', display: false},
                            {left: '\\(', right: '\\)', display: false},
                            {left: '\\[', right: '\\]', display: true}
                        ],
                        throwOnError: false
                    });
                }

                // Hydrate Toggle Buttons
                const toggles = els.paperContent.querySelectorAll('.js-toggle-working');
                toggles.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.dataset.id;
                        toggleSolution(id);
                    });
                });
            }

            function renderQuestionNode(node, depth) {
                // Structure: Question Body -> Solution Block -> Children
                
                // Depth styling handling (Stage 5.1: separation strength decreases with nesting)
                // We use indentation for children via margin-left on the children container
                
                // 1. Question Body
                const promptHtml = mdRender(node.question);
                
                let html = `
                    <div id="${node.id}" class="question-node group relative scroll-mt-24">
                        <!-- Question Body -->
                        <div class="flex gap-4">
                            <div class="shrink-0 w-8 md:w-12 pt-0.5">
                                <span class="text-slate-500 font-medium text-sm md:text-base select-none">${node.id}</span>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="markdown-content text-slate-900 text-base md:text-lg leading-relaxed font-medium">
                                    ${promptHtml}
                                </div>
                            </div>
                        </div>
                `;

                // 2. Solution Block (Optional)
                if (node.solutionBlock) {
                    const sb = node.solutionBlock;
                    const hasAnswer = !!sb.answer;
                    const hasDetails = !!sb.solutionDetails;
                    
                    if (hasAnswer || hasDetails) {
                        html += `<div class="ml-8 md:ml-12 mt-4 space-y-4">`;

                        // Answer
                        if (hasAnswer) {
                            html += `
                                <div class="flex flex-col gap-1">
                                    <span class="text-xs font-bold uppercase tracking-wider text-slate-500">Answer</span>
                                    <div class="markdown-content text-slate-800">
                                        ${mdRender(sb.answer)}
                                    </div>
                                </div>
                            `;
                        }

                        // Solution Details
                        if (hasDetails) {
                            const isExpanded = appState.expandedState[node.id];
                            html += `
                                <div class="pt-2">
                                    <button class="js-toggle-working flex items-center gap-2 text-sm font-medium text-blue-600 hover:text-blue-700 transition-colors focus-visible:ring-2 focus-visible:ring-blue-600 rounded-sm px-1 -ml-1 py-1" data-id="${node.id}">
                                        <span id="toggle-text-${node.id}">${isExpanded ? "Hide working" : "Show working"}</span>
                                        <svg id="toggle-icon-${node.id}" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="transition-transform duration-200 ${isExpanded ? 'rotate-180' : ''}"><path d="m6 9 6 6 6-6"/></svg>
                                    </button>
                                    
                                    <div id="solution-region-${node.id}" class="solution-details-region mt-3 pl-4 pr-2 py-4 rounded-sm text-slate-700 ${isExpanded ? '' : 'hidden'}">
                                        ${renderSolutionDetails(sb.solutionDetails)}
                                    </div>
                                </div>
                            `;
                        }
                        
                        html += `</div>`; // End Solution wrapper
                    }
                }

                // 3. Children
                if (node.children && node.children.length > 0) {
                    html += `<div class="mt-6 space-y-8 pl-4 md:pl-6 border-l border-slate-100 ml-2 md:ml-3">`;
                    node.children.forEach(child => {
                        html += renderQuestionNode(child, depth + 1);
                    });
                    html += `</div>`;
                }

                html += `</div>`; // End Node
                return html;
            }

            function renderSolutionDetails(sd) {
                let html = `<div class="space-y-6 text-sm md:text-base">`;

                // Keep in mind
                if (sd.keepInMind) {
                    html += `
                        <div class="space-y-1">
                            <h4 class="text-xs font-bold uppercase tracking-wider text-slate-500 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>
                                Keep in mind
                            </h4>
                            <div class="markdown-content">
                                ${mdRender(sd.keepInMind)}
                            </div>
                        </div>
                    `;
                }

                // Formulas used
                if (sd.formulasUsed) {
                    html += `
                        <div class="space-y-1">
                            <h4 class="text-xs font-bold uppercase tracking-wider text-slate-500">Formulas used</h4>
                            <div class="markdown-content text-slate-600">
                                ${mdRender(sd.formulasUsed)}
                            </div>
                        </div>
                    `;
                }

                // Working (Primary)
                if (sd.working) {
                    html += `
                        <div class="space-y-2">
                            <h4 class="text-xs font-bold uppercase tracking-wider text-slate-500">Working</h4>
                            <div class="markdown-content">
                                ${mdRender(sd.working)}
                            </div>
                        </div>
                    `;
                }

                // Alternative Working
                if (sd.alternativeWorking && Array.isArray(sd.alternativeWorking)) {
                    sd.alternativeWorking.forEach((aw, idx) => {
                        html += `
                            <div class="pt-4 mt-4 border-t border-slate-200/50 space-y-2">
                                <h4 class="text-xs font-bold uppercase tracking-wider text-slate-500">Alternative working</h4>
                                <div class="markdown-content">
                                    ${mdRender(aw)}
                                </div>
                            </div>
                        `;
                    });
                }

                html += `</div>`;
                return html;
            }

            function renderNav() {
                // Generate Flat list of all questions with nesting visual cue via text style
                const p = appState.currentPaper;
                let items = [];

                const collectItems = (nodes) => {
                    nodes.forEach(node => {
                        items.push({ id: node.id, label: node.id, isChild: !!node.children }); 
                        // Note: visual hierarchy in brief is flat list, sub-questions quieter. 
                        // Implementation: We'll infer visual weight based on ID length or position. 
                        // Actually, recursive walk is better to know depth.
                    });
                };
                
                const traverse = (nodes, depth) => {
                    nodes.forEach(node => {
                        items.push({ id: node.id, depth: depth });
                        if (node.children) traverse(node.children, depth + 1);
                    });
                };

                // Section handling
                let navHtml = "";
                
                if (p.sections) {
                    p.sections.forEach(section => {
                        // Section Label (Non-clickable)
                        if (section.label && section.label.trim()) {
                            navHtml += `
                                <div class="px-2 py-2 mt-4 text-xs font-bold text-slate-400 uppercase tracking-wider select-none">
                                    ${section.label}
                                </div>
                            `;
                        }
                        // Section Items
                        const sectionItems = [];
                        traverse(section.questions, 0); // Re-use traverse but capture to sectionItems? 
                        // Simpler: Just run traverse on the section's questions and append to navHtml immediate
                        
                        let currentSectionItems = [];
                        const collectSection = (nodes, depth) => {
                            nodes.forEach(n => {
                                currentSectionItems.push({id: n.id, depth: depth});
                                if (n.children) collectSection(n.children, depth + 1);
                            });
                        };
                        collectSection(section.questions, 0);

                        currentSectionItems.forEach(item => {
                            navHtml += renderNavItem(item);
                        });
                    });
                } else if (p.questions) {
                    let allItems = [];
                    traverse(p.questions, 0);
                    allItems.forEach(item => {
                        navHtml += renderNavItem(item);
                    });
                }

                els.desktopNav.innerHTML = navHtml;
                els.mobileNav.innerHTML = navHtml;
            }

            function renderNavItem(item) {
                // Hierarchy via type scale/quietness, same left edge
                // Depth 0: Normal weight/color
                // Depth > 0: Quieter
                const isTop = item.depth === 0;
                
                return `
                    <a href="#${item.id}" data-q-id="${item.id}" class="
                        group block px-2 py-1.5 rounded-sm transition-colors hover:bg-slate-100 hover:text-slate-900 focus-visible:bg-slate-100
                        ${isTop ? 'text-slate-600 font-medium' : 'text-slate-400 font-normal text-xs'}
                    ">
                        ${item.id}
                    </a>
                `;
            }

            // Start
            init();
        })();
    </script>
</body>
</html>
