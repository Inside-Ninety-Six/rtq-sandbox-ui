<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AD","indexWithinVariant":"21","totalWithinVariant":"440","hueFamily":"","intensityMode":"","primaryHueFamily":"cyan","secondaryHueFamily":"purple","dualIntensityMode":"dual_accent_only","timestamp":"2026-01-10T03:04:28.514Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AD&quot;,&quot;indexWithinVariant&quot;:&quot;21&quot;,&quot;totalWithinVariant&quot;:&quot;440&quot;,&quot;hueFamily&quot;:&quot;&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;primaryHueFamily&quot;:&quot;cyan&quot;,&quot;secondaryHueFamily&quot;:&quot;purple&quot;,&quot;dualIntensityMode&quot;:&quot;dual_accent_only&quot;,&quot;timestamp&quot;:&quot;2026-01-10T03:04:28.514Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>

    <!-- Tailwind CSS (Prototype Mode) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- KaTeX CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    
    <!-- KaTeX JS -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Markdown-it -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                fontFamily: {
                    sans: ['Inter', 'system-ui', 'sans-serif'],
                },
                extend: {
                    colors: {
                        // ColorLab D: dual_accent_only (Light Mode)
                        // Primary: Blue, Secondary: Amber
                        // Surfaces: Neutral (C <= 0.015)
                        page: 'oklch(0.985 0.002 260)',
                        frame: 'oklch(0.985 0.002 260)', 
                        paper: 'oklch(1.0 0 0)',
                        
                        // Text: Neutral (C <= 0.010)
                        ink: {
                            primary: 'oklch(0.20 0.01 260)',
                            secondary: 'oklch(0.45 0.01 260)',
                            tertiary: 'oklch(0.65 0.01 260)'
                        },

                        // Primary Accent (Blue): C [0.08..0.14]
                        // Used for: Links, Focus, Disclosure Text
                        primary: {
                            DEFAULT: 'oklch(0.55 0.13 255)', 
                            hover: 'oklch(0.50 0.13 255)',
                            bg: 'oklch(0.96 0.02 255)' // Subtle wash
                        },

                        // Secondary Accent (Amber): C [0.06..0.12]
                        // Used for: Supplementary role (Nav marker)
                        secondary: {
                            DEFAULT: 'oklch(0.75 0.12 85)',
                            fg: 'oklch(0.45 0.08 85)'
                        },

                        // Hairlines
                        divider: 'oklch(0.92 0.005 260)'
                    }
                }
            }
        }
    </script>

    <style>
        /* Global Reset & Base */
        html, body {
            height: 100%;
            overscroll-behavior-y: none; /* Prevent bounce */
        }
        
        /* KaTeX Containment Invariant (Locked) */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 4px; /* Scrollbar breathing room */
            margin: 0.5em 0;
        }
        
        /* Table styles (Markdown) */
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 1rem 0;
            font-size: 0.95em;
        }
        th, td {
            border: 1px solid oklch(0.92 0.005 260);
            padding: 0.5rem;
            text-align: left;
        }
        th {
            font-weight: 600;
        }
        
        /* Scrollbar Hiding for Nav */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Focus styles - ColorLab D Primary */
        *:focus-visible {
            outline: 2px solid oklch(0.55 0.13 255);
            outline-offset: 2px;
        }

        /* Typography spacing within markdown blocks */
        .md-content p { margin-bottom: 0.75em; line-height: 1.6; }
        .md-content p:last-child { margin-bottom: 0; }
        .md-content ul { list-style-type: disc; padding-left: 1.25em; margin-bottom: 0.75em; }
        .md-content ol { list-style-type: decimal; padding-left: 1.25em; margin-bottom: 0.75em; }

        /* Animation */
        .fade-in { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-page text-ink-primary flex flex-col h-full overflow-hidden">

    <!-- Top Controls Region -->
    <div id="top-controls" class="flex-none bg-frame border-b border-divider z-20 relative">
        <div class="max-w-[1200px] mx-auto px-4 md:px-6 h-14 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <!-- Mobile Jump To Trigger -->
                <button id="mobile-menu-trigger" class="md:hidden flex items-center gap-2 text-ink-primary font-medium text-sm p-2 -ml-2 rounded hover:bg-gray-100 transition-colors" aria-label="Jump to question">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                    <span>Jump to</span>
                </button>
                
                <!-- Paper Selector -->
                <div class="flex items-center gap-3">
                    <label for="paper-select" class="text-sm font-medium text-ink-secondary hidden sm:block">Paper:</label>
                    <select id="paper-select" class="bg-transparent border border-divider rounded px-2 py-1 text-sm font-medium focus:border-primary text-ink-primary min-w-[160px]">
                        <option disabled selected>Loading papers...</option>
                    </select>
                </div>
            </div>
            <div class="text-xs text-ink-tertiary font-medium">RTQ v11.3.7</div>
        </div>
    </div>

    <!-- DocumentFrameShell -->
    <div class="flex-1 flex overflow-hidden max-w-[1200px] mx-auto w-full relative bg-frame">
        
        <!-- Desktop Navigation Rail (Sticky) -->
        <nav id="desktop-nav" class="hidden md:block w-48 lg:w-56 flex-none h-full overflow-y-auto no-scrollbar py-8 pl-4 pr-6 border-r border-transparent">
            <!-- Nav content injected here -->
        </nav>

        <!-- Paper Content Column -->
        <main id="paper-container" class="flex-1 h-full overflow-y-auto scroll-smooth relative bg-frame" tabindex="-1">
            <div class="max-w-[720px] mx-auto py-8 px-4 md:px-8 min-h-full pb-32">
                <div id="paper-content" class="space-y-12">
                    <!-- Content injected here -->
                    <div class="flex flex-col items-center justify-center pt-20 text-ink-secondary">
                        <svg class="animate-spin h-6 w-6 mb-4 text-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p>Loading payload...</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Mobile Drawer Overlay -->
    <div id="mobile-drawer-backdrop" class="fixed inset-0 bg-black/20 z-40 hidden transition-opacity opacity-0" aria-hidden="true"></div>
    <div id="mobile-drawer" class="fixed inset-y-0 left-0 w-[280px] bg-white z-50 transform -translate-x-full transition-transform duration-300 shadow-xl flex flex-col">
        <div class="h-14 flex items-center justify-between px-4 border-b border-divider flex-none">
            <h2 class="font-semibold text-ink-primary">Jump to</h2>
            <button id="drawer-close" class="p-2 -mr-2 text-ink-secondary hover:text-ink-primary" aria-label="Close navigation">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <nav id="mobile-nav-list" class="flex-1 overflow-y-auto py-4 px-4 space-y-1">
            <!-- Mobile nav items injected here -->
        </nav>
    </div>

    <!-- Application Logic -->
    <script>
        // --- STAGE 0: CONSTANTS ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // --- STATE ---
        let appState = {
            papers: [],
            activePaperKey: null,
            expandedStates: {}, // Map<questionId, boolean>
            currentNavId: null
        };

        // --- MARKDOWN SETUP (Stage 6 Hardening) ---
        const md = window.markdownit ? window.markdownit({
            html: true,
            linkify: true,
            breaks: false // MUST be false
        }) : null;

        if (md) {
            md.inline.ruler.disable(['escape']);
        }

        // --- APP INITIALIZATION ---
        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Payload missing");
                const payload = await response.json();
                
                if (!payload.papers || payload.papers.length === 0) throw new Error("No papers");
                
                appState.papers = payload.papers;
                
                // Init with first paper
                const firstPaper = appState.papers[0];
                selectPaper(firstPaper.key);
                
                renderControls();

            } catch (e) {
                console.error(e);
                document.getElementById('paper-content').innerHTML = `
                    <div class="p-8 text-center border border-divider rounded bg-white">
                        <h1 class="text-xl font-bold text-ink-primary mb-2">PAPERS PAYLOAD MISSING</h1>
                        <p class="text-ink-secondary">Unable to load content from ${RTQ_PAPERS_PAYLOAD_PATH}</p>
                    </div>
                `;
                document.getElementById('paper-select').innerHTML = '<option disabled>Error</option>';
            }
        }

        // --- LOGIC: CONTROLS ---
        function renderControls() {
            const select = document.getElementById('paper-select');
            select.innerHTML = appState.papers.map(p => 
                `<option value="${p.key}" ${p.key === appState.activePaperKey ? 'selected' : ''}>${p.label}</option>`
            ).join('');
            
            select.addEventListener('change', (e) => {
                selectPaper(e.target.value);
            });

            // Mobile Drawer Logic
            const trigger = document.getElementById('mobile-menu-trigger');
            const drawer = document.getElementById('mobile-drawer');
            const backdrop = document.getElementById('mobile-drawer-backdrop');
            const closeBtn = document.getElementById('drawer-close');

            function openDrawer() {
                drawer.classList.remove('-translate-x-full');
                backdrop.classList.remove('hidden');
                setTimeout(() => backdrop.classList.remove('opacity-0'), 10);
                document.body.style.overflow = 'hidden';
            }

            function closeDrawer() {
                drawer.classList.add('-translate-x-full');
                backdrop.classList.add('opacity-0');
                setTimeout(() => backdrop.classList.add('hidden'), 300);
                document.body.style.overflow = '';
            }

            trigger.onclick = openDrawer;
            closeBtn.onclick = closeDrawer;
            backdrop.onclick = closeDrawer;
        }

        function selectPaper(key) {
            appState.activePaperKey = key;
            const paper = appState.papers.find(p => p.key === key);
            
            // Reset expanded states based on defaults
            const defaultExpanded = paper.defaults?.expandedAll !== false;
            appState.expandedStates = {}; // Clear old state
            
            // Render
            renderNav(paper);
            renderPaperContent(paper, defaultExpanded);
            
            // Scroll to top
            document.getElementById('paper-container').scrollTop = 0;
            
            // Re-run KaTeX
            renderMath();
        }

        // --- RENDERING: NAV ---
        function renderNav(paper) {
            // Helper to generate list items
            const generateNavItems = (questions) => {
                let html = '';
                questions.forEach(q => {
                    const depth = 0; // Flat list visually
                    html += `
                        <button onclick="scrollToQuestion('${q.id}')" 
                                class="w-full text-left py-1 px-2 text-sm text-ink-secondary hover:text-ink-primary hover:bg-black/5 rounded transition-colors mb-0.5"
                                data-nav-id="${q.id}">
                            ${q.id}
                        </button>
                    `;
                    // Children? The spec says flat identifiers list. 
                    // Usually we flatten the tree for navigation or just render top levels. 
                    // Brief says: "Navigation labels consist solely of question identifiers... Mobile navigation must expose the full set".
                    // We need to traverse.
                    if (q.children && q.children.length > 0) {
                        html += generateNavItems(q.children);
                    }
                });
                return html;
            };

            let navHtml = '';
            
            if (paper.sections) {
                paper.sections.forEach(section => {
                    if (section.label && section.label.trim().length > 0) {
                        navHtml += `
                            <div class="mt-6 first:mt-0 mb-2 px-2 text-xs font-bold text-ink-tertiary uppercase tracking-wider select-none">
                                ${section.label}
                            </div>
                        `;
                    }
                    navHtml += generateNavItems(section.questions);
                });
            } else if (paper.questions) {
                navHtml += generateNavItems(paper.questions);
            }

            document.getElementById('desktop-nav').innerHTML = navHtml;
            document.getElementById('mobile-nav-list').innerHTML = navHtml;
        }

        // --- RENDERING: PAPER CONTENT ---
        function renderPaperContent(paper, defaultExpanded) {
            const container = document.getElementById('paper-content');
            let html = '';

            // Recursive render function
            const renderNode = (node, depth = 0) => {
                const isSub = depth > 0;
                
                // Determine if Solution Block exists
                // Rules: If solutionBlock absent => no block.
                // If present: Answer visible default. SolutionDetails expandable.
                const hasSolBlock = !!node.solutionBlock;
                const hasAnswer = hasSolBlock && !!node.solutionBlock.answer;
                const hasDetails = hasSolBlock && !!node.solutionBlock.solutionDetails;
                
                // Initial expanded state
                const isExpanded = appState.expandedStates[node.id] !== undefined 
                    ? appState.expandedStates[node.id] 
                    : (defaultExpanded && hasDetails);

                // Update state map to track it
                if (appState.expandedStates[node.id] === undefined && hasDetails) {
                    appState.expandedStates[node.id] = isExpanded;
                }

                // Render Fields
                const qHtml = md ? md.render(node.question || '') : node.question;
                
                // --- STRUCTURE ---
                // Question Node Surface? Optional. We use spacing mostly.
                // Sub-questions get indentation (Stage 3).
                
                let blockHtml = `
                    <div id="q-${node.id}" class="question-node group ${isSub ? 'mt-6 ml-4 md:ml-8' : 'pt-8 first:pt-0'}">
                        
                        <!-- Question Body -->
                        <div class="mb-4">
                            <div class="flex items-baseline gap-3">
                                <span class="flex-none text-ink-tertiary font-semibold text-sm select-none w-8 text-right -ml-8 md:block hidden">${node.id}</span>
                                <span class="flex-none text-ink-tertiary font-semibold text-sm select-none mr-2 md:hidden">${node.id}</span>
                                <div class="md-content text-lg text-ink-primary font-medium leading-relaxed max-w-none flex-1">
                                    ${qHtml}
                                </div>
                            </div>
                        </div>
                `;

                // --- SOLUTION BLOCK ---
                if (hasSolBlock && (hasAnswer || hasDetails)) {
                    blockHtml += `<div class="solution-block pl-0 md:pl-3 border-l-2 border-transparent hover:border-divider transition-colors duration-300">`;
                    
                    // Answer
                    if (hasAnswer) {
                        const aHtml = md ? md.render(node.solutionBlock.answer) : node.solutionBlock.answer;
                        blockHtml += `
                            <div class="mb-3 mt-4">
                                <div class="text-xs font-bold text-ink-secondary uppercase tracking-wide mb-1">Answer</div>
                                <div class="md-content text-base text-ink-primary bg-page/50 inline-block rounded pr-2">
                                    ${aHtml}
                                </div>
                            </div>
                        `;
                    }

                    // Solution Details Toggle
                    if (hasDetails) {
                        const btnId = `btn-${node.id}`;
                        const regionId = `details-${node.id}`;
                        const label = isExpanded ? 'Hide working' : 'Show working';
                        
                        blockHtml += `
                            <div class="mt-4">
                                <button onclick="toggleWorking('${node.id}')" 
                                        class="text-primary hover:text-primary-hover font-medium text-sm flex items-center gap-1 focus:outline-none focus-visible:ring-2 focus-visible:ring-primary rounded px-1 -ml-1 transition-colors"
                                        aria-expanded="${isExpanded}"
                                        aria-controls="${regionId}">
                                    <span>${label}</span>
                                    <svg class="w-4 h-4 transform transition-transform ${isExpanded ? 'rotate-180' : ''}" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                    </svg>
                                </button>
                            </div>
                        `;

                        // Details Region
                        if (isExpanded) {
                            const sd = node.solutionBlock.solutionDetails;
                            
                            blockHtml += `
                                <div id="${regionId}" class="mt-3 fade-in pl-0 border-l-2 border-divider md:border-l-0 md:pl-0">
                                    <div class="bg-primary-bg/30 rounded-lg p-4 md:p-5 text-base relative overflow-hidden">
                                        <!-- Keep in Mind -->
                                        ${sd.keepInMind ? `
                                            <div class="mb-5">
                                                <div class="text-xs font-bold text-ink-secondary mb-2 flex items-center gap-1.5">
                                                    <svg class="w-3.5 h-3.5 text-ink-tertiary" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                                    Keep in mind
                                                </div>
                                                <div class="md-content text-ink-primary/90 text-sm">
                                                    ${md.render(sd.keepInMind)}
                                                </div>
                                            </div>
                                        ` : ''}

                                        <!-- Formulas Used -->
                                        ${sd.formulasUsed ? `
                                            <div class="mb-5">
                                                <div class="text-xs font-bold text-ink-secondary mb-2">Formulas used</div>
                                                <div class="md-content text-ink-secondary text-sm font-mono bg-white/50 p-2 rounded border border-black/5">
                                                    ${md.render(sd.formulasUsed)}
                                                </div>
                                            </div>
                                        ` : ''}

                                        <!-- Working -->
                                        ${sd.working ? `
                                            <div class="mb-6">
                                                <div class="text-xs font-bold text-ink-secondary mb-2">Working</div>
                                                <div class="md-content text-ink-primary space-y-4">
                                                    ${md.render(sd.working)}
                                                </div>
                                            </div>
                                        ` : ''}

                                        <!-- Alt Working -->
                                        ${sd.alternativeWorking && Array.isArray(sd.alternativeWorking) ? sd.alternativeWorking.map(alt => `
                                            <div class="mt-6 pt-6 border-t border-divider">
                                                <div class="text-xs font-bold text-ink-secondary mb-2">Alternative working</div>
                                                <div class="md-content text-ink-primary space-y-4">
                                                    ${md.render(alt)}
                                                </div>
                                            </div>
                                        `).join('') : ''}
                                    </div>
                                </div>
                            `;
                        }
                    }
                    blockHtml += `</div>`; // End Solution Block
                }

                // Children
                if (node.children && node.children.length > 0) {
                    blockHtml += `<div class="children-container">`;
                    node.children.forEach(child => {
                        blockHtml += renderNode(child, depth + 1);
                    });
                    blockHtml += `</div>`;
                }

                blockHtml += `</div>`; // End Question Node
                
                // Top Level Divider (Stage 5 tone: purely whitespace unless dense. Using ample whitespace).
                if (depth === 0) {
                    blockHtml += `<div class="h-16 md:h-24"></div>`;
                }

                return blockHtml;
            };

            // Main Loop
            if (paper.sections) {
                paper.sections.forEach(section => {
                    if (section.label && section.label.trim().length > 0) {
                        html += `
                            <div class="section-header pt-12 pb-8 flex items-center gap-4">
                                <h2 class="text-2xl font-bold text-ink-secondary">${section.label}</h2>
                                <div class="h-px bg-divider flex-1"></div>
                            </div>
                        `;
                    }
                    section.questions.forEach(q => {
                        html += renderNode(q, 0);
                    });
                });
            } else if (paper.questions) {
                paper.questions.forEach(q => {
                    html += renderNode(q, 0);
                });
            }

            container.innerHTML = html;
        }

        // --- INTERACTION ---
        window.toggleWorking = (id) => {
            appState.expandedStates[id] = !appState.expandedStates[id];
            
            // Re-render whole paper? Ideally just the node, but simple re-render is safer for prototype state consistency.
            // To prevent scroll jump, we could try to preserve position, but expanding creates shift anyway.
            // Let's re-render current paper content.
            const paper = appState.papers.find(p => p.key === appState.activePaperKey);
            
            // Capture scroll relative to viewport? 
            // Simple prototype approach: Render, then re-math.
            // We lose scroll position if we blast HTML. 
            // Better: update just that node's HTML? No, tree structure. 
            // Let's stick to full re-render for simplicity and assume browser handles scroll anchoring reasonably well, or simple restore.
            const scrollPos = document.getElementById('paper-container').scrollTop;
            renderPaperContent(paper, false); // false implies rely on appState
            document.getElementById('paper-container').scrollTop = scrollPos;
            renderMath();
        }

        window.scrollToQuestion = (id) => {
            const el = document.getElementById(`q-${id}`);
            if (el) {
                el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                // Update nav active state logic would go here (intersection observer)
                // For now, highlight clicked
                updateActiveNav(id);
                // Close mobile drawer
                document.getElementById('mobile-drawer').classList.add('-translate-x-full');
                document.getElementById('mobile-drawer-backdrop').classList.add('hidden');
                document.body.style.overflow = '';
            }
        }

        function updateActiveNav(id) {
            // Reset all
            document.querySelectorAll('[data-nav-id]').forEach(b => {
                b.classList.remove('font-bold', 'text-primary'); // ColorLab D Primary
                b.classList.add('text-ink-secondary');
            });
            // Set active
            const activeBtn = document.querySelector(`[data-nav-id="${id}"]`);
            if (activeBtn) {
                activeBtn.classList.remove('text-ink-secondary');
                // ColorLab D: Primary accent permitted for nav marker/text
                activeBtn.classList.add('font-bold', 'text-primary');
                
                // If using Secondary accent for marker as per ColorLab D suggestion, we could add a border-l-2
                // activeBtn.classList.add('border-l-2', 'border-secondary', 'pl-1.5'); 
            }
        }

        function renderMath() {
            renderMathInElement(document.body, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false}
                ],
                throwOnError: false
            });
        }

        // --- START ---
        init();

    </script>
</body>
</html>
