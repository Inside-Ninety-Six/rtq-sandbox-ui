<!DOCTYPE html>
<html lang="en" class="light">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AB","indexWithinVariant":"60","totalWithinVariant":"200","hueFamily":"red","intensityMode":"","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-08T16:07:54.070Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AB&quot;,&quot;indexWithinVariant&quot;:&quot;60&quot;,&quot;totalWithinVariant&quot;:&quot;200&quot;,&quot;hueFamily&quot;:&quot;red&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-08T16:07:54.070Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Paper Viewer</title>

    <!-- Tailwind CSS (via CDN for prototype) - Configured for Red Accent -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    colors: {
                        // ColorLab B: Forced Hue Family = "red"
                        // Base neutrals are slate/gray, Accent is Red
                        accent: {
                            50: '#fef2f2',
                            100: '#fee2e2',
                            200: '#fecaca',
                            300: '#fca5a5',
                            400: '#f87171',
                            500: '#ef4444',
                            600: '#dc2626', // Primary interaction
                            700: '#b91c1c', // Text emphasis
                            800: '#991b1b',
                            900: '#7f1d1d',
                        },
                        gray: {
                            50: '#f9fafb',
                            100: '#f3f4f6',
                            200: '#e5e7eb',
                            300: '#d1d5db',
                            400: '#9ca3af',
                            500: '#6b7280',
                            600: '#4b5563', // Body text
                            700: '#374151',
                            800: '#1f2937', // Headings
                            900: '#111827',
                        }
                    }
                }
            }
        }
    </script>

    <!-- KaTeX (No SRI per Stage 6.1) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Markdown-it (No SRI per Stage 6.1) -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <style>
        /* Base typography and layout resets */
        body {
            background-color: #ffffff;
            color: #374151; /* gray-700 */
            -webkit-font-smoothing: antialiased;
        }

        /* Focus management */
        :focus-visible {
            outline: 2px solid #ef4444; /* accent-500 */
            outline-offset: 2px;
        }

        /* Scrollbar hiding for Nav */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* KaTeX Containment Invariant */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding: 0.5rem 0;
            margin: 0.5rem 0;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Table Styling within Markdown */
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 1rem 0;
            font-size: 0.95em;
        }
        th, td {
            border: 1px solid #e5e7eb; /* gray-200 */
            padding: 0.5rem;
            text-align: left;
        }
        th {
            font-weight: 600;
            background-color: transparent;
        }

        /* Markdown Content Styling */
        .md-content p {
            margin-bottom: 0.75rem;
            line-height: 1.6;
        }
        .md-content ul {
            list-style-type: disc;
            padding-left: 1.25rem;
            margin-bottom: 0.75rem;
        }
        .md-content ol {
            list-style-type: decimal;
            padding-left: 1.25rem;
            margin-bottom: 0.75rem;
        }
        /* Inline KaTeX background invariant */
        .katex {
            background-color: transparent !important;
        }

        /* Utility classes for expansion transitions */
        .details-wrapper {
            display: grid;
            grid-template-rows: 0fr;
            transition: grid-template-rows 0.2s ease-out;
            opacity: 0;
        }
        .details-wrapper.expanded {
            grid-template-rows: 1fr;
            opacity: 1;
        }
        .details-inner {
            overflow: hidden;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Top Controls Region -->
    <header class="sticky top-0 z-20 bg-white border-b border-gray-200">
        <div class="max-w-screen-xl mx-auto px-4 md:px-8 h-14 flex items-center justify-between">
            <!-- Paper Selector -->
            <div class="flex items-center gap-4">
                <label for="paper-select" class="text-sm font-medium text-gray-500 sr-only">Select Paper</label>
                <select id="paper-select" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded focus:ring-accent-500 focus:border-accent-500 block p-2">
                    <option value="" disabled selected>Loading papers...</option>
                </select>
            </div>

            <!-- Mobile Jump To Trigger -->
            <button id="mobile-jump-trigger" class="md:hidden text-sm font-medium text-accent-700 hover:text-accent-800 focus:text-accent-800">
                Jump to
            </button>
        </div>
    </header>

    <!-- DocumentFrameShell -->
    <div class="flex-1 max-w-screen-xl mx-auto w-full grid grid-cols-1 md:grid-cols-[220px_1fr] gap-8 px-4 md:px-8 pt-8 pb-32">
        
        <!-- Navigation Rail (Desktop) -->
        <aside class="hidden md:block">
            <div class="sticky top-20 max-h-[calc(100vh-6rem)] overflow-y-auto no-scrollbar py-2">
                <nav id="desktop-nav" class="space-y-1" aria-label="Paper navigation">
                    <!-- Nav items injected here -->
                </nav>
            </div>
        </aside>

        <!-- Paper Document Column -->
        <main id="paper-content" class="min-w-0">
            <!-- Paper content injected here -->
            <div id="loading-state" class="text-gray-500 text-center mt-12">Loading...</div>
        </main>
    </div>

    <!-- Mobile Navigation Drawer -->
    <div id="mobile-drawer-backdrop" class="fixed inset-0 bg-black/20 z-30 hidden" aria-hidden="true"></div>
    <div id="mobile-drawer" class="fixed inset-y-0 right-0 z-40 w-64 bg-white shadow-xl transform translate-x-full transition-transform duration-200 ease-in-out flex flex-col" role="dialog" aria-modal="true" aria-label="Navigation">
        <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
            <h2 class="text-sm font-bold text-gray-900">Jump to</h2>
            <button id="close-drawer" class="text-gray-500 hover:text-gray-700 p-1">
                <span class="sr-only">Close navigation</span>
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <div class="flex-1 overflow-y-auto p-4">
            <nav id="mobile-nav" class="space-y-1">
                <!-- Mobile nav items injected here -->
            </nav>
        </div>
    </div>

    <script>
        // --- STAGE 0: CONSTANTS (Runtime Definition) ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // --- STAGE 6.0: MARKDOWN CONFIGURATION (Authoritative) ---
        // Must be defined before rendering
        const md = window.markdownit ? window.markdownit({
            html: true,     // allow inline SVG/HTML
            linkify: true,
            breaks: false   // MUST stay false to prevent <br> breaking KaTeX
        }) : null;

        if (md) {
            // Disable escape rule to preserve TeX backslashes
            md.inline.ruler.disable(['escape']);
        }

        // --- STATE ---
        const state = {
            papers: [],
            currentPaper: null,
            expandedStates: new Map(), // Map<questionId, boolean>
            defaultExpanded: true
        };

        // --- DOM ELEMENTS ---
        const els = {
            paperSelect: document.getElementById('paper-select'),
            paperContent: document.getElementById('paper-content'),
            desktopNav: document.getElementById('desktop-nav'),
            mobileNav: document.getElementById('mobile-nav'),
            mobileDrawer: document.getElementById('mobile-drawer'),
            mobileBackdrop: document.getElementById('mobile-drawer-backdrop'),
            jumpTrigger: document.getElementById('mobile-jump-trigger'),
            closeDrawer: document.getElementById('close-drawer'),
            loadingState: document.getElementById('loading-state')
        };

        // --- INITIALIZATION ---
        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error('Payload fetch failed');
                const data = await response.json();
                
                if (!data.papers || !Array.isArray(data.papers)) {
                    throw new Error('Invalid payload structure');
                }

                state.papers = data.papers;
                renderPaperSelector();
                
                // Load first paper by default
                if (state.papers.length > 0) {
                    loadPaper(state.papers[0].key);
                }

            } catch (err) {
                console.error(err);
                els.loadingState.style.display = 'none';
                els.paperContent.innerHTML = '<div class="text-center text-red-600 font-bold mt-10">PAPERS PAYLOAD MISSING</div>';
            }

            setupMobileDrawer();
        }

        // --- CORE RENDER LOGIC ---

        function renderPaperSelector() {
            els.paperSelect.innerHTML = state.papers.map(p => 
                `<option value="${p.key}">${p.label}</option>`
            ).join('');
            
            els.paperSelect.addEventListener('change', (e) => {
                loadPaper(e.target.value);
            });
        }

        function loadPaper(paperKey) {
            const paper = state.papers.find(p => p.key === paperKey);
            if (!paper) return;

            state.currentPaper = paper;
            state.defaultExpanded = paper.defaults?.expandedAll !== false;
            state.expandedStates.clear(); // Reset manual toggle states

            renderPaperContent(paper);
            renderNavigation(paper);
            
            // Re-run KaTeX
            if (window.renderMathInElement) {
                renderMathInElement(els.paperContent, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false}
                    ],
                    throwOnError: false
                });
            }
        }

        function renderPaperContent(paper) {
            els.paperContent.innerHTML = ''; // Clear existing
            els.loadingState.style.display = 'none';

            let html = '';

            // Handle Sectioned vs Flat Papers
            if (paper.sections) {
                paper.sections.forEach((section, index) => {
                    // Render Section Header if label exists
                    if (section.label && section.label.trim().length > 0) {
                        html += `
                            <div class="mb-8 pt-4 pb-2 border-b border-gray-200">
                                <h2 class="text-xl font-bold text-gray-800">${escapeHtml(section.label)}</h2>
                            </div>
                        `;
                    }
                    // Render Questions in Section
                    html += `<div class="space-y-12">`;
                    section.questions.forEach(q => {
                        html += renderQuestionNode(q, 0);
                    });
                    html += `</div>`;
                    
                    // Spacer between sections
                    if (index < paper.sections.length - 1) {
                        html += `<div class="h-16"></div>`;
                    }
                });
            } else if (paper.questions) {
                html += `<div class="space-y-12">`;
                paper.questions.forEach(q => {
                    html += renderQuestionNode(q, 0);
                });
                html += `</div>`;
            }

            els.paperContent.innerHTML = html;
        }

        function renderQuestionNode(node, depth) {
            const indentClass = depth > 0 ? 'ml-4 md:ml-8 mt-6' : ''; // Indentation for children
            const hasSolutionDetails = node.solutionBlock && node.solutionBlock.solutionDetails;
            const hasAnswer = node.solutionBlock && node.solutionBlock.answer;
            const hasChildren = node.children && node.children.length > 0;

            // Determine expanded state: explicit toggle > default
            let isExpanded = state.defaultExpanded;
            if (state.expandedStates.has(node.id)) {
                isExpanded = state.expandedStates.get(node.id);
            }

            let html = `
                <div id="q-${node.id}" class="question-node scroll-mt-24 ${indentClass}">
                    <!-- Question Body -->
                    <div class="mb-4">
                        <div class="flex gap-3 items-baseline">
                            <span class="text-gray-500 font-medium select-none shrink-0" style="min-width: 1.5rem">${node.id}</span>
                            <div class="text-gray-800 text-lg leading-relaxed md-content flex-1 font-medium">
                                ${renderMarkdown(node.question)}
                            </div>
                        </div>
                    </div>
            `;

            // Solution Block
            if (node.solutionBlock) {
                html += `<div class="ml-9 md:ml-[calc(1.5rem+0.75rem)]">`; // Align with text, skipping ID

                // Answer
                if (hasAnswer) {
                    html += `
                        <div class="mb-4 text-gray-700">
                            <span class="text-xs font-bold uppercase tracking-wider text-gray-500 block mb-1">Answer</span>
                            <div class="md-content text-base font-normal">
                                ${renderMarkdown(node.solutionBlock.answer)}
                            </div>
                        </div>
                    `;
                }

                // Solution Details (Collapsible)
                if (hasSolutionDetails) {
                    const toggleId = `toggle-${node.id}`;
                    const contentId = `details-${node.id}`;
                    const details = node.solutionBlock.solutionDetails;

                    html += `
                        <div class="solution-details-container mt-4">
                            <button 
                                onclick="toggleSolution('${node.id}')"
                                class="text-accent-700 hover:text-accent-800 text-sm font-medium flex items-center gap-1 focus:outline-none focus:underline decoration-accent-300 underline-offset-4"
                                aria-expanded="${isExpanded}"
                                aria-controls="${contentId}"
                            >
                                <span>${isExpanded ? 'Hide working' : 'Show working'}</span>
                                <svg class="w-4 h-4 transition-transform ${isExpanded ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </button>

                            <div id="${contentId}" class="details-wrapper ${isExpanded ? 'expanded' : ''} text-gray-600">
                                <div class="details-inner pt-4 border-l border-gray-100 pl-4 space-y-6">
                                    ${renderSolutionDetailsContent(details)}
                                </div>
                            </div>
                        </div>
                    `;
                }

                html += `</div>`; // End alignment wrapper
            }

            // Children Recursive
            if (hasChildren) {
                html += `<div class="children-container">`;
                node.children.forEach(child => {
                    html += renderQuestionNode(child, depth + 1);
                });
                html += `</div>`;
            }

            html += `</div>`; // End question node
            return html;
        }

        function renderSolutionDetailsContent(details) {
            let html = '';

            // 1. Keep in mind (Optional)
            if (details.keepInMind) {
                html += `
                    <div class="keep-in-mind">
                        <h4 class="text-sm font-bold text-gray-700 mb-1 flex items-center gap-2">
                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            Keep in mind
                        </h4>
                        <div class="md-content text-sm text-gray-600 pl-6">
                            ${renderMarkdown(details.keepInMind)}
                        </div>
                    </div>
                `;
            }

            // 2. Formulas used (Optional)
            if (details.formulasUsed) {
                html += `
                    <div class="formulas-used">
                        <h4 class="text-sm font-bold text-gray-700 mb-1">Formulas used</h4>
                        <div class="md-content text-sm text-gray-600">
                            ${renderMarkdown(details.formulasUsed)}
                        </div>
                    </div>
                `;
            }

            // 3. Working (Primary)
            if (details.working) {
                html += `
                    <div class="working">
                        <h4 class="text-sm font-bold text-gray-700 mb-2">Working</h4>
                        <div class="md-content text-base">
                            ${renderMarkdown(details.working)}
                        </div>
                    </div>
                `;
            }

            // 4. Alternative Working (Optional, 0+)
            if (details.alternativeWorking && Array.isArray(details.alternativeWorking)) {
                details.alternativeWorking.forEach((alt, idx) => {
                    html += `
                        <div class="pt-4 mt-4 border-t border-gray-100">
                            <h4 class="text-sm font-bold text-gray-700 mb-2">Alternative working</h4>
                            <div class="md-content text-base">
                                ${renderMarkdown(alt)}
                            </div>
                        </div>
                    `;
                });
            }

            return html;
        }

        // --- NAVIGATION RENDERING ---

        function renderNavigation(paper) {
            const createNavList = (items) => {
                return items.map(node => {
                    const isSub = node.id.length > 2 || /[a-z]/.test(node.id); // Simple heuristic for visual hierarchy cue
                    const baseClass = "block py-1 text-sm border-l-2 border-transparent pl-3 hover:text-gray-900 hover:border-gray-200 transition-colors cursor-pointer text-left w-full";
                    const activeClass = "text-accent-700 font-bold border-accent-600"; // ColorLab B: Red
                    const inactiveClass = isSub ? "text-gray-400 font-normal" : "text-gray-500 font-medium";

                    let html = `<a href="#q-${node.id}" class="nav-item ${baseClass} ${inactiveClass}" data-target="q-${node.id}">
                        ${node.id}
                    </a>`;
                    
                    if (node.children) {
                        html += createNavList(node.children);
                    }
                    return html;
                }).join('');
            };

            let navHtml = '';

            if (paper.sections) {
                paper.sections.forEach((section, idx) => {
                    // Section Label (Non-clickable, Spacing separator)
                    if (section.label && section.label.trim().length > 0) {
                        const mt = idx > 0 ? 'mt-4' : '';
                        navHtml += `<div class="${mt} px-3 pb-1 text-xs font-bold text-gray-400 uppercase tracking-wider cursor-default select-none">${escapeHtml(section.label)}</div>`;
                    } else if (idx > 0) {
                         navHtml += `<div class="mt-4"></div>`; // Spacing only if no label
                    }
                    navHtml += createNavList(section.questions);
                });
            } else {
                navHtml += createNavList(paper.questions);
            }

            els.desktopNav.innerHTML = navHtml;
            els.mobileNav.innerHTML = navHtml; // Re-use html for mobile drawer

            // Initialize ScrollSpy/Active State logic
            setupNavInteractions();
        }

        function setupNavInteractions() {
            // Smooth scroll & Active state handling
            const links = document.querySelectorAll('.nav-item');
            
            links.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetId = link.getAttribute('data-target');
                    const targetEl = document.getElementById(targetId);
                    if (targetEl) {
                        // Close drawer if open
                        closeDrawer();
                        
                        // Scroll
                        const headerOffset = 80;
                        const elementPosition = targetEl.getBoundingClientRect().top;
                        const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
                        
                        window.scrollTo({
                            top: offsetPosition,
                            behavior: "smooth"
                        });
                        
                        // Update active state manually (intersection observer handles scroll)
                        updateActiveNav(targetId);
                    }
                });
            });

            // Intersection Observer for scroll spy
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        updateActiveNav(entry.target.id);
                    }
                });
            }, {
                rootMargin: '-10% 0px -80% 0px' // Trigger when element is near top
            });

            document.querySelectorAll('.question-node').forEach(node => observer.observe(node));
        }

        function updateActiveNav(targetId) {
            document.querySelectorAll('.nav-item').forEach(el => {
                const isActive = el.getAttribute('data-target') === targetId;
                // Styles based on "Red" theme requirements
                if (isActive) {
                    el.classList.remove('text-gray-400', 'text-gray-500', 'font-normal', 'font-medium', 'border-transparent');
                    el.classList.add('text-accent-700', 'font-bold', 'border-accent-600');
                } else {
                    el.classList.remove('text-accent-700', 'font-bold', 'border-accent-600');
                    el.classList.add('border-transparent');
                    // Re-apply hierarchy logic
                    const isSub = el.textContent.trim().length > 3; // Rough check again
                    if (isSub) {
                        el.classList.add('text-gray-400', 'font-normal');
                    } else {
                        el.classList.add('text-gray-500', 'font-medium');
                    }
                }
            });
        }

        // --- INTERACTION LOGIC ---

        // Global scope for onclick handler
        window.toggleSolution = function(nodeId) {
            const content = document.getElementById(`details-${nodeId}`);
            const btn = document.querySelector(`button[onclick="toggleSolution('${nodeId}')"]`);
            
            const isCurrentlyExpanded = state.expandedStates.has(nodeId) 
                ? state.expandedStates.get(nodeId) 
                : state.defaultExpanded;
            
            const newState = !isCurrentlyExpanded;
            state.expandedStates.set(nodeId, newState);

            if (content) {
                if (newState) {
                    content.classList.add('expanded');
                } else {
                    content.classList.remove('expanded');
                }
            }

            if (btn) {
                btn.setAttribute('aria-expanded', newState);
                const span = btn.querySelector('span');
                const svg = btn.querySelector('svg');
                if (span) span.textContent = newState ? 'Hide working' : 'Show working';
                if (svg) svg.classList.toggle('rotate-180', newState);
            }
        };

        function setupMobileDrawer() {
            const toggle = () => {
                const isOpen = !els.mobileDrawer.classList.contains('translate-x-full');
                if (isOpen) closeDrawer();
                else openDrawer();
            };

            els.jumpTrigger.addEventListener('click', toggle);
            els.closeDrawer.addEventListener('click', closeDrawer);
            els.mobileBackdrop.addEventListener('click', closeDrawer);
        }

        function openDrawer() {
            els.mobileDrawer.classList.remove('translate-x-full');
            els.mobileBackdrop.classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // Lock body scroll
        }

        function closeDrawer() {
            els.mobileDrawer.classList.add('translate-x-full');
            els.mobileBackdrop.classList.add('hidden');
            document.body.style.overflow = '';
        }

        // --- UTILS ---

        function renderMarkdown(text) {
            if (!text) return '';
            if (!md) return text; // Fallback
            return md.render(text);
        }

        function escapeHtml(unsafe) {
            return unsafe
                 .replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
        }

        // --- START ---
        init();

    </script>
</body>
</html>
