<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"ABC","indexWithinVariant":"87","totalWithinVariant":"320","hueFamily":"cyan","intensityMode":"high_chroma_surfaces","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-09T13:58:39.565Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;ABC&quot;,&quot;indexWithinVariant&quot;:&quot;87&quot;,&quot;totalWithinVariant&quot;:&quot;320&quot;,&quot;hueFamily&quot;:&quot;cyan&quot;,&quot;intensityMode&quot;:&quot;high_chroma_surfaces&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-09T13:58:39.565Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Viewer</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://rsms.me/">
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
    <!-- KaTeX -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <!-- Markdown-it -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* 
           COLORLAB C: HIGH CHROMA SURFACES (CYAN)
           Hue: 220 (Cyan/Blue range) 
           Mode: Light Only
        */
        :root {
            /* Palette Definition - OKLCH */
            --hue: 220; 

            /* High Chroma Surfaces: C in [0.06 .. 0.12] */
            --col-page-bg: oklch(0.94 0.08 var(--hue));
            --col-frame-bg: oklch(0.91 0.10 var(--hue));
            --col-paper-bg: oklch(0.97 0.06 var(--hue)); /* Slightly quieter but still tinted */

            /* Wash Surfaces */
            --col-wash: oklch(0.93 0.09 var(--hue));
            --col-wash-strong: oklch(0.90 0.11 var(--hue)); /* For focus/hover */

            /* Text: Neutral */
            --col-text-primary: oklch(0.20 0.015 var(--hue));
            --col-text-secondary: oklch(0.45 0.02 var(--hue));

            /* Accent: Cyan */
            --col-accent: oklch(0.55 0.18 var(--hue));
            --col-accent-subtle: oklch(0.85 0.12 var(--hue));

            /* Dividers */
            --col-divider: oklch(0.85 0.04 var(--hue));

            /* Spacing */
            --spacing-unit: 1rem;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--col-page-bg);
            color: var(--col-text-primary);
            overflow-y: scroll; /* Force vertical scrollbar to avoid layout shift */
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Typography Override */
        h1, h2, h3, h4, h5, h6 { font-weight: 600; }

        /* KaTeX Overflow Handling */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding-bottom: 0.5rem; /* Scrollbar breathing room */
            -webkit-overflow-scrolling: touch;
        }
        
        /* Inline math background restriction */
        .katex { background: transparent !important; }

        /* Markdown Body Fixes */
        .markdown-body p { margin-bottom: 0.75rem; }
        .markdown-body p:last-child { margin-bottom: 0; }
        .markdown-body ul { list-style-type: disc; padding-left: 1.25rem; margin-bottom: 0.75rem; }
        .markdown-body ol { list-style-type: decimal; padding-left: 1.25rem; margin-bottom: 0.75rem; }
        .markdown-body table { border-collapse: collapse; width: 100%; margin-bottom: 1rem; }
        .markdown-body th, .markdown-body td { border: 1px solid var(--col-divider); padding: 0.5rem; text-align: left; }
        .markdown-body th { font-weight: 600; }

        /* Custom Scrollbar for Nav (Hidden visually) */
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* Focus Styles */
        :focus-visible {
            outline: 2px solid var(--col-accent);
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* Utility classes for ColorLab application */
        .bg-page { background-color: var(--col-page-bg); }
        .bg-frame { background-color: var(--col-frame-bg); }
        .bg-paper { background-color: var(--col-paper-bg); }
        .bg-wash { background-color: var(--col-wash); }
        .text-primary { color: var(--col-text-primary); }
        .text-secondary { color: var(--col-text-secondary); }
        .text-accent { color: var(--col-accent); }
        .border-divider { border-color: var(--col-divider); }
        
    </style>
</head>
<body class="antialiased selection:bg-[var(--col-accent-subtle)]">

    <!-- Top Controls (Paper Selector + Jump To) -->
    <div id="top-controls" class="w-full flex justify-center items-center py-4 px-4 sm:px-8 border-b border-[var(--col-divider)] bg-[var(--col-frame-bg)] sticky top-0 z-20">
        <div class="w-full max-w-7xl flex justify-between items-center">
            <!-- Paper Selector -->
            <div class="flex items-center gap-3">
                <label for="paper-select" class="text-sm font-medium text-[var(--col-text-secondary)] hidden sm:block">Paper</label>
                <select id="paper-select" class="bg-[var(--col-paper-bg)] border border-[var(--col-divider)] text-[var(--col-text-primary)] text-sm rounded px-3 py-1.5 focus:ring-1 focus:ring-[var(--col-accent)] outline-none min-w-[200px]">
                    <option value="" disabled selected>Loading papers...</option>
                </select>
            </div>
            
            <!-- Mobile Jump To Trigger -->
            <button id="mobile-jump-trigger" class="lg:hidden text-sm font-medium text-[var(--col-accent)] px-3 py-1.5 hover:bg-[var(--col-wash)] rounded transition-colors">
                Jump to...
            </button>
        </div>
    </div>

    <!-- Document Frame Shell -->
    <div id="document-shell" class="flex-1 w-full max-w-7xl mx-auto flex flex-row relative bg-[var(--col-frame-bg)]">
        
        <!-- Desktop Navigation Rail (Sticky) -->
        <nav id="desktop-nav" class="hidden lg:block w-64 flex-shrink-0 sticky top-[73px] h-[calc(100vh-73px)] overflow-y-auto no-scrollbar py-8 pl-4 pr-6 border-r border-transparent">
            <!-- Nav Content Generated Here -->
            <div id="nav-list-container" class="space-y-6"></div>
        </nav>

        <!-- Paper Content Column -->
        <main id="paper-column" class="flex-1 min-w-0 py-8 px-4 sm:px-8 lg:px-12 bg-[var(--col-frame-bg)]">
            <div id="paper-surface" class="bg-[var(--col-paper-bg)] min-h-[500px] shadow-sm ring-1 ring-black/5 rounded-sm p-8 sm:p-12 lg:p-16 max-w-4xl mx-auto">
                <!-- Status / Error Message Area -->
                <div id="status-message" class="text-center text-[var(--col-text-secondary)] py-20 hidden"></div>
                
                <!-- Paper Content Generated Here -->
                <div id="paper-content" class="space-y-12"></div>
            </div>
        </main>

    </div>

    <!-- Mobile Navigation Drawer -->
    <div id="mobile-drawer-backdrop" class="fixed inset-0 bg-black/20 backdrop-blur-sm z-40 hidden transition-opacity opacity-0"></div>
    <div id="mobile-drawer" class="fixed inset-y-0 right-0 w-80 bg-[var(--col-frame-bg)] shadow-xl transform translate-x-full transition-transform duration-300 z-50 flex flex-col">
        <div class="p-4 border-b border-[var(--col-divider)] flex justify-between items-center bg-[var(--col-page-bg)]">
            <h2 class="font-medium text-[var(--col-text-primary)]">Jump to question</h2>
            <button id="close-drawer" class="p-2 text-[var(--col-text-secondary)] hover:text-[var(--col-text-primary)]">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
        </div>
        <div class="flex-1 overflow-y-auto p-4" id="mobile-nav-list">
            <!-- Cloned Nav Content -->
        </div>
    </div>

    <script>
        // --- STAGE 0: CONSTANTS ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // --- MARKDOWN SETUP (Stage 6 Hardening) ---
        const md = window.markdownit ? window.markdownit({
            html: true,
            linkify: true,
            breaks: false 
        }) : null;
        
        if (md) {
            md.inline.ruler.disable(['escape']);
        }

        // --- STATE ---
        let appState = {
            papers: [],
            currentPaperId: null,
            expandedStates: {}, // Map<questionId, boolean>
            payloadLoaded: false
        };

        // --- DOM ELEMENTS ---
        const els = {
            paperSelect: document.getElementById('paper-select'),
            paperContent: document.getElementById('paper-content'),
            navListContainer: document.getElementById('nav-list-container'),
            mobileNavList: document.getElementById('mobile-nav-list'),
            statusMessage: document.getElementById('status-message'),
            drawerBackdrop: document.getElementById('mobile-drawer-backdrop'),
            drawer: document.getElementById('mobile-drawer'),
            mobileJumpTrigger: document.getElementById('mobile-jump-trigger'),
            closeDrawerBtn: document.getElementById('close-drawer')
        };

        // --- INITIALIZATION ---
        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error('Payload fetch failed');
                const data = await response.json();
                
                if (!data.papers || !Array.isArray(data.papers)) {
                    throw new Error('Invalid payload structure');
                }

                appState.papers = data.papers;
                appState.payloadLoaded = true;
                
                populatePaperSelector();
                
                // Select first paper by default
                if (appState.papers.length > 0) {
                    loadPaper(appState.papers[0].key);
                } else {
                    renderError("NO PAPERS FOUND");
                }

            } catch (err) {
                console.error(err);
                renderError("PAPERS PAYLOAD MISSING");
            }
        }

        function renderError(msg) {
            els.statusMessage.textContent = msg;
            els.statusMessage.classList.remove('hidden');
            els.paperContent.innerHTML = '';
        }

        function populatePaperSelector() {
            els.paperSelect.innerHTML = '';
            appState.papers.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.key;
                opt.textContent = p.label || p.key;
                els.paperSelect.appendChild(opt);
            });
            els.paperSelect.addEventListener('change', (e) => {
                loadPaper(e.target.value);
            });
        }

        function loadPaper(paperKey) {
            const paper = appState.papers.find(p => p.key === paperKey);
            if (!paper) return;

            appState.currentPaperId = paperKey;
            appState.expandedStates = {}; // Reset expanded states on paper switch

            renderPaperContent(paper);
            renderNavigation(paper);
            
            // Mobile drawer reset
            closeDrawer();
        }

        // --- RENDERING CORE ---

        function renderPaperContent(paper) {
            els.paperContent.innerHTML = '';
            els.statusMessage.classList.add('hidden');

            const container = document.createElement('div');
            container.className = "flex flex-col gap-16"; // Top-level Question Separation (largest)

            let nodes = [];
            
            // Handle Sections vs Flat
            if (paper.sections && Array.isArray(paper.sections)) {
                paper.sections.forEach(section => {
                    // Section Header
                    if (section.label && section.label.trim().length > 0) {
                        const secHeader = document.createElement('div');
                        secHeader.className = "text-xl font-semibold text-[var(--col-text-secondary)] pb-4 border-b border-[var(--col-divider)] mb-8";
                        secHeader.textContent = section.label;
                        container.appendChild(secHeader);
                    }
                    // Section Questions
                    if (section.questions) {
                        section.questions.forEach(q => {
                            container.appendChild(createQuestionNode(q, 0, paper));
                        });
                    }
                });
            } else if (paper.questions) {
                paper.questions.forEach(q => {
                    container.appendChild(createQuestionNode(q, 0, paper));
                });
            }

            els.paperContent.appendChild(container);

            // Render Math
            if (window.renderMathInElement) {
                renderMathInElement(els.paperContent, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false},
                        {left: '\\(', right: '\\)', display: false},
                        {left: '\\[', right: '\\]', display: true}
                    ],
                    throwOnError: false
                });
            }
        }

        function createQuestionNode(node, level, paper) {
            const wrapper = document.createElement('div');
            wrapper.className = `flex flex-col w-full`;
            wrapper.id = `q-${node.id}`; // Anchor for navigation

            // 1. Question Body
            const bodyRow = document.createElement('div');
            bodyRow.className = "flex flex-row gap-4 md:gap-6";
            
            // Identifier
            const ident = document.createElement('div');
            ident.className = "flex-shrink-0 w-8 md:w-12 text-lg font-semibold text-[var(--col-text-secondary)] pt-0.5";
            ident.textContent = node.id;
            
            // Prompt
            const prompt = document.createElement('div');
            prompt.className = "flex-1 text-lg text-[var(--col-text-primary)] leading-relaxed markdown-body";
            prompt.innerHTML = renderMarkdown(node.question || "");

            bodyRow.appendChild(ident);
            bodyRow.appendChild(prompt);
            wrapper.appendChild(bodyRow);

            // 2. Solution Block (Optional)
            if (node.solutionBlock) {
                const sb = node.solutionBlock;
                const hasAnswer = !!sb.answer;
                const hasDetails = !!sb.solutionDetails;

                if (hasAnswer || hasDetails) {
                    const blockWrapper = document.createElement('div');
                    // Spacing from Question Body -> Solution Block
                    blockWrapper.className = "mt-6 ml-8 md:ml-12 pl-4 border-l border-[var(--col-divider)]";

                    // A. Answer
                    if (hasAnswer) {
                        const ansDiv = document.createElement('div');
                        ansDiv.className = "mb-4";
                        const ansLabel = document.createElement('span');
                        ansLabel.className = "font-bold text-sm text-[var(--col-text-secondary)] uppercase tracking-wide mr-2";
                        ansLabel.textContent = "Answer";
                        
                        const ansContent = document.createElement('div');
                        ansContent.className = "mt-1 text-lg font-medium text-[var(--col-text-primary)] markdown-body";
                        ansContent.innerHTML = renderMarkdown(sb.answer);

                        ansDiv.appendChild(ansLabel);
                        ansDiv.appendChild(ansContent);
                        blockWrapper.appendChild(ansDiv);
                    }

                    // B. Solution Details
                    if (hasDetails) {
                        const sd = sb.solutionDetails;
                        // State
                        const isExpandedDefault = paper.defaults?.expandedAll !== false;
                        // Check explicit toggle state in appState, fallback to default
                        const isExpanded = appState.expandedStates[node.id] !== undefined 
                            ? appState.expandedStates[node.id] 
                            : isExpandedDefault;

                        // Disclosure Control
                        const toggleBtn = document.createElement('button');
                        toggleBtn.className = "text-sm font-medium text-[var(--col-accent)] hover:text-[var(--col-text-primary)] transition-colors flex items-center gap-1 focus:outline-none mb-2";
                        toggleBtn.innerHTML = `
                            <span>${isExpanded ? 'Hide working' : 'Show working'}</span>
                            <svg class="w-4 h-4 transform transition-transform ${isExpanded ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                        `;

                        // Details Region
                        const detailsRegion = document.createElement('div');
                        detailsRegion.className = `mt-3 p-4 md:p-6 rounded-sm bg-[var(--col-wash)] transition-all duration-300 overflow-hidden ${isExpanded ? 'opacity-100' : 'opacity-0 max-h-0 hidden'}`;
                        
                        // Internal Content
                        // Order: Keep in mind -> Formulas -> Working -> Alt Working
                        
                        // Keep in mind
                        if (sd.keepInMind) {
                            const kim = createSubSection("Keep in mind", sd.keepInMind);
                            detailsRegion.appendChild(kim);
                        }

                        // Formulas
                        if (sd.formulasUsed) {
                            const form = createSubSection("Formulas used", sd.formulasUsed);
                            detailsRegion.appendChild(form);
                        }

                        // Working
                        if (sd.working) {
                            const work = createSubSection("Working", sd.working);
                            detailsRegion.appendChild(work);
                        }

                        // Alt Workings
                        if (sd.alternativeWorking && Array.isArray(sd.alternativeWorking)) {
                            sd.alternativeWorking.forEach(alt => {
                                detailsRegion.appendChild(createSubSection("Alternative working", alt));
                            });
                        }

                        // Toggle Interaction
                        toggleBtn.onclick = () => {
                            const newState = !isExpanded;
                            appState.expandedStates[node.id] = newState;
                            if (newState) {
                                detailsRegion.classList.remove('hidden');
                                // Force reflow
                                void detailsRegion.offsetWidth;
                                detailsRegion.classList.remove('max-h-0', 'opacity-0');
                                toggleBtn.querySelector('span').textContent = 'Hide working';
                                toggleBtn.querySelector('svg').classList.add('rotate-180');
                            } else {
                                detailsRegion.classList.add('opacity-0');
                                detailsRegion.classList.add('max-h-0');
                                setTimeout(() => detailsRegion.classList.add('hidden'), 300);
                                toggleBtn.querySelector('span').textContent = 'Show working';
                                toggleBtn.querySelector('svg').classList.remove('rotate-180');
                            }
                        };

                        blockWrapper.appendChild(toggleBtn);
                        blockWrapper.appendChild(detailsRegion);
                    }

                    wrapper.appendChild(blockWrapper);
                }
            }

            // 3. Children
            if (node.children && node.children.length > 0) {
                const childrenContainer = document.createElement('div');
                // Indentation and spacing for children
                childrenContainer.className = "flex flex-col gap-6 mt-6 ml-4 md:ml-8"; 
                node.children.forEach(child => {
                    childrenContainer.appendChild(createQuestionNode(child, level + 1, paper));
                });
                wrapper.appendChild(childrenContainer);
            }

            return wrapper;
        }

        function createSubSection(label, markdownContent) {
            const div = document.createElement('div');
            div.className = "mb-6 last:mb-0";
            
            const title = document.createElement('h5');
            title.className = "text-xs font-bold uppercase tracking-wider text-[var(--col-text-secondary)] mb-2";
            title.textContent = label;
            
            const body = document.createElement('div');
            body.className = "text-base text-[var(--col-text-primary)] markdown-body space-y-2";
            body.innerHTML = renderMarkdown(markdownContent);

            div.appendChild(title);
            div.appendChild(body);
            return div;
        }

        function renderMarkdown(text) {
            if (!md) return text; // Fallback
            return md.render(text);
        }

        // --- NAVIGATION RENDERING ---

        function renderNavigation(paper) {
            const list = document.createElement('ul');
            list.className = "flex flex-col gap-1";

            const flattenNodes = (nodes, targetList) => {
                nodes.forEach(node => {
                    const item = document.createElement('li');
                    const link = document.createElement('button');
                    link.className = "w-full text-left px-2 py-1.5 text-sm rounded hover:bg-[var(--col-wash)] transition-colors text-[var(--col-text-secondary)] hover:text-[var(--col-text-primary)]";
                    link.textContent = node.id; // Identifier only
                    
                    link.onclick = () => {
                        const el = document.getElementById(`q-${node.id}`);
                        if (el) {
                            // Smooth scroll
                            const y = el.getBoundingClientRect().top + window.pageYOffset - 100; // Offset for header
                            window.scrollTo({top: y, behavior: 'smooth'});
                            closeDrawer();
                        }
                    };

                    item.appendChild(link);
                    targetList.appendChild(item);

                    if (node.children) {
                        flattenNodes(node.children, targetList);
                    }
                });
            };

            if (paper.sections) {
                paper.sections.forEach((sec, idx) => {
                    // Section Label (Separator)
                    if (sec.label && sec.label.trim().length > 0) {
                        const secItem = document.createElement('li');
                        secItem.className = `px-2 pt-4 pb-1 text-xs font-bold text-[var(--col-text-secondary)] uppercase tracking-widest ${idx === 0 ? 'pt-0' : ''}`;
                        secItem.textContent = sec.label;
                        list.appendChild(secItem);
                    }
                    if (sec.questions) flattenNodes(sec.questions, list);
                });
            } else if (paper.questions) {
                flattenNodes(paper.questions, list);
            }

            els.navListContainer.innerHTML = '';
            els.navListContainer.appendChild(list.cloneNode(true)); // Desktop

            els.mobileNavList.innerHTML = '';
            els.mobileNavList.appendChild(list.cloneNode(true)); // Mobile
        }

        // --- MOBILE DRAWER UTILS ---
        
        function openDrawer() {
            els.drawerBackdrop.classList.remove('hidden');
            // small delay to allow display block to apply before opacity transition
            requestAnimationFrame(() => {
                els.drawerBackdrop.classList.remove('opacity-0');
                els.drawer.classList.remove('translate-x-full');
            });
        }

        function closeDrawer() {
            els.drawer.classList.add('translate-x-full');
            els.drawerBackdrop.classList.add('opacity-0');
            setTimeout(() => {
                els.drawerBackdrop.classList.add('hidden');
            }, 300);
        }

        els.mobileJumpTrigger.addEventListener('click', openDrawer);
        els.closeDrawerBtn.addEventListener('click', closeDrawer);
        els.drawerBackdrop.addEventListener('click', closeDrawer);

        // --- BOOT ---
        init();

    </script>
</body>
</html>
