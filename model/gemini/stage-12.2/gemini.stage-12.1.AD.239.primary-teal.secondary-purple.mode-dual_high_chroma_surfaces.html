<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AD","indexWithinVariant":"239","totalWithinVariant":"440","hueFamily":"","intensityMode":"","primaryHueFamily":"teal","secondaryHueFamily":"purple","dualIntensityMode":"dual_high_chroma_surfaces","timestamp":"2026-01-10T13:08:32.964Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AD&quot;,&quot;indexWithinVariant&quot;:&quot;239&quot;,&quot;totalWithinVariant&quot;:&quot;440&quot;,&quot;hueFamily&quot;:&quot;&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;primaryHueFamily&quot;:&quot;teal&quot;,&quot;secondaryHueFamily&quot;:&quot;purple&quot;,&quot;dualIntensityMode&quot;:&quot;dual_high_chroma_surfaces&quot;,&quot;timestamp&quot;:&quot;2026-01-10T13:08:32.964Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- KaTeX CSS (No Integrity/SRI per Stage 6.0.7b) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <!-- Markdown-it (No Integrity/SRI) -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <!-- KaTeX JS (No Integrity/SRI) -->
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <style>
        /* =========================================
           STAGE 0 & COLORLAB D CONFIGURATION
           Mode: dual_high_chroma_surfaces
           Primary: Blue (H=264)
           Secondary: Amber (H=85)
           Light Mode Only
           ========================================= */
        :root {
            /* Hues */
            --hue-primary: 264;
            --hue-secondary: 85;

            /* Surfaces (High Chroma Mode Rules) */
            /* Page: C in 0.06..0.12 */
            --surface-page: oklch(0.96 0.06 var(--hue-primary));
            /* Frame Base: C in 0.06..0.12 (Shared nav/paper container bg) */
            --surface-frame: oklch(0.94 0.07 var(--hue-primary));
            /* Paper: C in 0.03..0.07 (Remaining major surface) */
            --surface-paper: oklch(0.99 0.03 var(--hue-primary));
            /* Solution Details Wash: C in 0.05..0.10 */
            --surface-wash: oklch(0.95 0.05 var(--hue-primary));
            
            /* Text (C <= 0.015) */
            --text-primary: oklch(0.20 0.015 var(--hue-primary));
            --text-secondary: oklch(0.45 0.015 var(--hue-primary));
            --text-quiet: oklch(0.55 0.015 var(--hue-primary));

            /* Borders */
            --border-hairline: oklch(0.85 0.02 var(--hue-primary));
            --border-focus: var(--accent-primary);

            /* Accents (Dual Hue Discipline) */
            /* Primary: C in 0.12..0.20 */
            --accent-primary: oklch(0.55 0.18 var(--hue-primary)); 
            /* Secondary: C in 0.10..0.18 */
            --accent-secondary: oklch(0.70 0.16 var(--hue-secondary));

            /* Spacing Units */
            --space-xs: 0.25rem;
            --space-sm: 0.5rem;
            --space-md: 1rem;
            --space-lg: 1.5rem;
            --space-xl: 2.5rem;
            --space-2xl: 4rem;

            /* Dimensions */
            --nav-width-desktop: 240px;
            --max-paper-width: 800px;
            --header-height: 60px;
        }

        /* =========================================
           RESET & BASE
           ========================================= */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--surface-page);
            color: var(--text-primary);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            overflow-y: scroll; /* Always show scrollbar to prevent layout shift */
        }

        button {
            font-family: inherit;
            border: none;
            background: none;
            cursor: pointer;
            color: inherit;
        }

        a {
            color: var(--accent-primary);
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }

        /* Focus Styles (Stage 5.5.2) */
        :focus-visible {
            outline: 2px solid var(--border-focus);
            outline-offset: 2px;
        }

        /* =========================================
           LAYOUT ARCHITECTURE (STAGE 3 TREE)
           ========================================= */
        .viewport-shell {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: var(--surface-page);
        }

        /* Top Controls Region */
        .top-controls {
            height: var(--header-height);
            display: flex;
            align-items: center;
            justify-content: center; /* Centered relative to shell */
            padding: 0 var(--space-md);
            position: sticky;
            top: 0;
            z-index: 50;
            background-color: var(--surface-page); /* Matches page bg */
            border-bottom: 1px solid var(--border-hairline);
        }
        
        .top-controls-inner {
            width: 100%;
            max-width: calc(var(--max-paper-width) + var(--nav-width-desktop) + var(--space-xl));
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* DocumentFrameShell */
        .document-frame-shell {
            flex: 1;
            display: flex;
            justify-content: center;
            background-color: var(--surface-frame); /* Shared surface */
            padding-top: var(--space-lg);
            padding-bottom: var(--space-2xl);
        }

        .document-frame-inner {
            display: flex;
            width: 100%;
            max-width: calc(var(--max-paper-width) + var(--nav-width-desktop) + var(--space-xl));
            padding: 0 var(--space-md);
            gap: var(--space-lg);
        }

        /* Navigation Rail (Desktop) */
        .nav-rail {
            display: none; /* Hidden on mobile */
            width: var(--nav-width-desktop);
            flex-shrink: 0;
            position: sticky;
            top: calc(var(--header-height) + var(--space-lg));
            height: calc(100vh - var(--header-height) - var(--space-2xl));
            overflow-y: auto;
            /* Hide scrollbar visually */
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .nav-rail::-webkit-scrollbar {
            display: none;
        }

        /* Paper Region */
        .paper-column {
            flex: 1;
            min-width: 0; /* Enable truncation/flex shrinking */
            max-width: var(--max-paper-width);
        }

        .paper-surface {
            background-color: var(--surface-paper);
            /* No shadows, no borders per constraints, just surface diff */
            padding: var(--space-xl);
            min-height: 50vh;
        }

        /* =========================================
           NAVIGATION (STAGE 5.4)
           ========================================= */
        .nav-list {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .nav-section-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: var(--space-md);
            margin-bottom: var(--space-sm);
            padding-left: var(--space-sm);
            pointer-events: none;
        }

        .nav-item {
            font-size: 0.875rem;
            padding: var(--space-xs) var(--space-sm);
            color: var(--text-secondary);
            border-left: 2px solid transparent;
            text-align: left;
            transition: color 0.1s ease, border-color 0.1s ease;
        }

        .nav-item:hover {
            color: var(--text-primary);
        }

        .nav-item.active {
            color: var(--text-primary);
            font-weight: 600;
            border-left-color: var(--accent-primary); /* Accent permitted in Nav */
        }
        
        /* Hierarchy via type scale only (Stage 5.4.5) */
        .nav-item[data-depth="0"] { font-size: 0.95rem; }
        .nav-item[data-depth="1"] { font-size: 0.85rem; color: var(--text-quiet); }
        .nav-item[data-depth="2"] { font-size: 0.8rem; color: var(--text-quiet); }

        /* =========================================
           MOBILE DRAWER (STAGE 6.0.6)
           ========================================= */
        .mobile-jump-trigger {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--accent-primary);
        }
        
        .drawer-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.3); /* Scrim */
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
            display: flex;
            justify-content: flex-end; /* Drawer from right or left? Brief says drawer. Let's do left for nav matches */
            justify-content: flex-start; 
        }

        .drawer-overlay.open {
            opacity: 1;
            pointer-events: auto;
        }

        .drawer-content {
            width: 80%;
            max-width: 300px;
            height: 100%;
            background-color: var(--surface-page);
            transform: translateX(-100%);
            transition: transform 0.2s ease;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 8px rgba(0,0,0,0.05); /* Very subtle shadow for separation */
        }

        .drawer-overlay.open .drawer-content {
            transform: translateX(0);
        }

        .drawer-header {
            height: var(--header-height);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 var(--space-md);
            border-bottom: 1px solid var(--border-hairline);
        }

        .drawer-title {
            font-weight: 600;
            font-size: 1rem;
        }

        .drawer-close {
            font-size: 1.5rem;
            line-height: 1;
            padding: var(--space-xs);
        }

        .drawer-body {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-md);
        }

        /* =========================================
           CONTENT TYPOGRAPHY & SPACING
           ========================================= */
        .section-header {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: var(--space-xl);
            padding-bottom: var(--space-sm);
            border-bottom: 1px solid var(--border-hairline);
            margin-top: var(--space-2xl);
        }
        .section-header:first-child {
            margin-top: 0;
        }

        .question-node {
            display: flex;
            flex-direction: column;
        }

        /* Spacing Hierarchy */
        .node-top-level + .node-top-level {
            margin-top: var(--space-2xl); /* Largest spacing */
        }

        .children-container {
            margin-top: var(--space-lg);
            padding-left: var(--space-md); /* Indentation per Stage 3 */
            display: flex;
            flex-direction: column;
            gap: var(--space-lg); /* Child to Child spacing */
            border-left: 1px solid transparent; /* Placeholder for alignment */
        }

        /* =========================================
           QUESTION CONTENT
           ========================================= */
        .question-body {
            display: flex;
            gap: var(--space-sm);
            color: var(--text-primary);
            font-size: 1.05rem;
            line-height: 1.6;
        }

        .q-id {
            font-weight: 600;
            min-width: 1.5em; 
            flex-shrink: 0;
            color: var(--text-secondary); /* Stage 4.2: Secondary orientation */
        }

        .q-prompt {
            flex: 1;
            /* Markdown content styles */
        }
        .q-prompt p { margin-bottom: 0.75em; }
        .q-prompt p:last-child { margin-bottom: 0; }
        
        /* Diagrams */
        .q-prompt svg {
            max-width: 100%;
            height: auto;
            display: block;
            margin: var(--space-md) 0;
        }

        /* =========================================
           SOLUTION BLOCK
           ========================================= */
        .solution-block {
            margin-top: var(--space-md);
            margin-left: 2em; /* Align roughly with text start */
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }

        /* Answer */
        .answer-region {
            font-size: 1rem;
            color: var(--text-primary);
        }
        .answer-label {
            font-weight: 700;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            margin-right: var(--space-sm);
        }
        .answer-content {
            display: inline;
        }

        /* Disclosure Control */
        .disclosure-control {
            align-self: flex-start;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--accent-primary);
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            padding: var(--space-xs) 0;
            transition: color 0.1s ease;
        }
        .disclosure-control:hover {
            color: var(--text-primary); /* Feedback */
            text-decoration: underline;
        }
        .chevron {
            transition: transform 0.2s ease;
        }
        .disclosure-control[aria-expanded="true"] .chevron {
            transform: rotate(180deg);
        }

        /* Solution Details Region */
        .solution-details {
            display: none;
            background-color: var(--surface-wash); /* Subordinate surface */
            padding: var(--space-lg);
            /* Stage 3.F: No heavy borders, no rounded corners. Just a block. */
        }
        .solution-details.open {
            display: flex;
            flex-direction: column;
            gap: var(--space-lg);
            animation: slideDown 0.2s ease-out;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Subsections */
        .sd-subsection {
            display: flex;
            flex-direction: column;
            gap: var(--space-xs);
        }
        .sd-label {
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }
        .sd-content {
            font-size: 0.95rem;
            color: var(--text-primary); /* Readable! Not washed out. */
            line-height: 1.6;
        }
        
        /* Keep in mind */
        .sd-keep-in-mind .sd-content ul {
            padding-left: 1.2em;
        }

        /* Formulas used */
        .sd-formulas .sd-content {
            font-family: inherit;
        }

        /* Working / Alternative Working */
        .sd-working .sd-content, .sd-alt-working .sd-content {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }

        /* Tables (Stage 5.8.5) */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            margin: var(--space-sm) 0;
        }
        th, td {
            border: 1px solid var(--border-hairline);
            padding: var(--space-sm);
            text-align: left;
        }
        th {
            font-weight: 600;
        }

        /* =========================================
           KaTeX CONTAINMENT (Stage 6.0.8)
           ========================================= */
        /* Display math wrapper */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding: 0.5em 0;
            /* Scrollbar hiding for neatness, optional */
            scrollbar-width: thin;
        }
        /* Inline math: transparent bg always (Stage 6.0.4) */
        .katex {
            background-color: transparent !important;
        }
        
        /* =========================================
           RESPONSIVE
           ========================================= */
        @media (min-width: 1024px) {
            .nav-rail {
                display: block;
            }
            .mobile-only {
                display: none;
            }
        }
        
        @media (max-width: 1023px) {
            .document-frame-shell {
                padding-top: var(--space-md);
            }
            .paper-surface {
                padding: var(--space-md);
            }
            .solution-block {
                margin-left: 0; /* Less indent on mobile */
            }
        }

        /* Error Message */
        .error-message {
            color: var(--accent-secondary); /* Secondary accent for alert-like but not error semantics? No, semantics say no error. */
            color: var(--text-primary);
            font-weight: 600;
            text-align: center;
            padding: var(--space-2xl);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

    </style>
</head>
<body>

    <div id="app" class="viewport-shell">
        <!-- Top Controls -->
        <header class="top-controls">
            <div class="top-controls-inner">
                <div class="mobile-jump-trigger mobile-only">
                    <button id="btn-jump-to" aria-label="Jump to question">
                        <span class="jump-label">Jump to</span>
                        <svg width="16" height="16" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.13523 6.15803C3.3241 5.95657 3.64052 5.94637 3.84197 6.13523L7.5 9.56464L11.158 6.13523C11.3595 5.94637 11.6759 5.95657 11.8648 6.15803C12.0536 6.35949 12.0434 6.67591 11.842 6.86477L7.84197 10.6148C7.64964 10.7951 7.35036 10.7951 7.15803 10.6148L3.15803 6.86477C2.95657 6.67591 2.94637 6.35949 3.13523 6.15803Z" fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
                    </button>
                </div>
                
                <!-- Paper Selector -->
                <div class="paper-selector-wrapper">
                    <select id="paper-selector" aria-label="Select paper" style="font-size: 0.9rem; padding: 0.5rem; border: 1px solid var(--border-hairline); border-radius: 4px; color: var(--text-primary); background: var(--surface-page);">
                        <option value="" disabled selected>Loading papers...</option>
                    </select>
                </div>

                <div style="width: 20px;"></div> <!-- Spacer/Balance -->
            </div>
        </header>

        <!-- Main Document Frame -->
        <div class="document-frame-shell">
            <div class="document-frame-inner">
                
                <!-- Desktop Nav Rail -->
                <nav class="nav-rail" id="desktop-nav" aria-label="Document navigation">
                    <div class="nav-list" id="nav-list-desktop">
                        <!-- Nav Items Generated Here -->
                    </div>
                </nav>

                <!-- Paper Column -->
                <main class="paper-column" id="paper-region">
                    <div class="paper-surface" id="paper-content">
                        <!-- Questions Generated Here -->
                    </div>
                </main>

            </div>
        </div>

        <!-- Mobile Navigation Drawer -->
        <div class="drawer-overlay" id="mobile-drawer">
            <div class="drawer-content">
                <div class="drawer-header">
                    <span class="drawer-title">Jump to</span>
                    <button class="drawer-close" id="btn-drawer-close" aria-label="Close navigation">Ã—</button>
                </div>
                <div class="drawer-body">
                    <div class="nav-list" id="nav-list-mobile">
                        <!-- Nav Items Generated Here -->
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // =========================================
        // STAGE 0 CONSTANT (AUTHORITATIVE)
        // =========================================
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";

        // =========================================
        // MARKDOWN RENDERER CONFIG (STAGE 6)
        // =========================================
        const md = window.markdownit
            ? window.markdownit({
                html: true, // Allow inline SVG
                linkify: true,
                breaks: false, // Must be false for KaTeX
            })
            : null;

        if (md) {
            md.inline.ruler.disable(['escape']); // Preserve backslashes for TeX
        }

        // =========================================
        // STATE MANAGEMENT
        // =========================================
        const state = {
            papers: [],
            activePaperKey: null,
            expandedNodes: new Set(), // Set of Question IDs
            isMobileDrawerOpen: false
        };

        // =========================================
        // DOM ELEMENTS
        // =========================================
        const els = {
            paperSelector: document.getElementById('paper-selector'),
            paperContent: document.getElementById('paper-content'),
            navListDesktop: document.getElementById('nav-list-desktop'),
            navListMobile: document.getElementById('nav-list-mobile'),
            mobileDrawer: document.getElementById('mobile-drawer'),
            btnJumpTo: document.getElementById('btn-jump-to'),
            btnDrawerClose: document.getElementById('btn-drawer-close')
        };

        // =========================================
        // INITIALIZATION
        // =========================================
        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Fetch failed");
                const payload = await response.json();
                
                if (!payload.papers || !Array.isArray(payload.papers)) throw new Error("Invalid payload");
                
                state.papers = payload.papers;
                renderPaperSelector();
                
                // Select first paper by default
                if (state.papers.length > 0) {
                    loadPaper(state.papers[0].key);
                }
            } catch (err) {
                console.error(err);
                els.paperContent.innerHTML = '<div class="error-message">PAPERS PAYLOAD MISSING</div>';
                els.paperSelector.innerHTML = '<option disabled selected>Error loading payload</option>';
            }
        }

        function renderPaperSelector() {
            els.paperSelector.innerHTML = state.papers.map(p => 
                `<option value="${p.key}">${p.label}</option>`
            ).join('');
            
            els.paperSelector.addEventListener('change', (e) => {
                loadPaper(e.target.value);
            });
        }

        function loadPaper(paperKey) {
            const paper = state.papers.find(p => p.key === paperKey);
            if (!paper) return;

            state.activePaperKey = paperKey;
            
            // Set Defaults
            state.expandedNodes.clear();
            const defaultExpanded = paper.defaults?.expandedAll !== false;
            
            // Collect all IDs that have solutionDetails to set initial state if needed
            // (We handle this lazily via a helper, effectively "all" or "none" initially)
            state.defaultExpanded = defaultExpanded;

            renderPaperContent(paper);
            renderNavigation(paper);
            
            // Trigger KaTeX Render on the whole content
            if (window.renderMathInElement) {
                renderMathInElement(els.paperContent, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false}
                    ],
                    throwOnError: false
                });
            }
            
            // Reset scroll
            window.scrollTo(0, 0);
        }

        // =========================================
        // RENDERING
        // =========================================
        
        function renderPaperContent(paper) {
            let html = '';

            // Handle Sectioned vs Flat
            if (paper.sections) {
                paper.sections.forEach(section => {
                    // Render Section Header if label exists
                    if (section.label && section.label.trim().length > 0) {
                        html += `<div class="section-header">${section.label}</div>`;
                    }
                    html += renderQuestionList(section.questions, 0);
                });
            } else if (paper.questions) {
                html += renderQuestionList(paper.questions, 0);
            }

            els.paperContent.innerHTML = html;
            attachEventListeners();
        }

        function renderQuestionList(questions, depth) {
            return questions.map(q => renderQuestionNode(q, depth)).join('');
        }

        function renderQuestionNode(q, depth) {
            const isTopLevel = depth === 0;
            const nodeClass = isTopLevel ? 'question-node node-top-level' : 'question-node';
            
            // Parse Question Body
            const qBodyHtml = md ? md.render(q.question || '') : (q.question || '');

            // Solution Block Logic
            let solutionBlockHtml = '';
            if (q.solutionBlock) {
                const sb = q.solutionBlock;
                const hasAnswer = !!sb.answer;
                const hasDetails = !!sb.solutionDetails;

                let answerHtml = '';
                if (hasAnswer) {
                    const ansContent = md ? md.renderInline(sb.answer) : sb.answer;
                    answerHtml = `
                        <div class="answer-region">
                            <span class="answer-label">Answer</span>
                            <div class="answer-content">${ansContent}</div>
                        </div>
                    `;
                }

                let detailsHtml = '';
                if (hasDetails) {
                    const sd = sb.solutionDetails;
                    // Check expansion state
                    const isExpanded = state.expandedNodes.has(q.id) || (!state.expandedNodes.has(q.id) && state.defaultExpanded);
                    // Explicit tracking: if user toggled, it's in set. If not, fallback to default.
                    // Actually, simpler: init set based on default? 
                    // Let's rely on data attribute for JS toggle, render appropriate HTML.
                    // Better: Compute render state.
                    const isOpen = state.expandedNodes.has(q.id) ? true : (state.defaultExpanded && !state.expandedNodes.has('CLOSED_'+q.id)); 
                    // ^ Logic slightly complex. Let's simplify:
                    // If default is true, we store CLOSED_id to hide.
                    // If default is false, we store OPEN_id to show.
                    
                    // Re-impl state logic for clarity:
                    let show = state.defaultExpanded;
                    if (state.expandedNodes.has(q.id)) show = true;
                    if (state.expandedNodes.has('!'+q.id)) show = false;

                    const btnText = show ? "Hide working" : "Show working";
                    const ariaExpanded = show ? "true" : "false";
                    const detailsClass = show ? "solution-details open" : "solution-details";

                    // Build Subsections
                    let subsectionsHtml = '';
                    
                    if (sd.keepInMind) {
                        subsectionsHtml += `
                            <div class="sd-subsection sd-keep-in-mind">
                                <div class="sd-label">
                                    <svg width="12" height="12" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M7.49991 0.876892C3.84222 0.876892 0.877075 3.84204 0.877075 7.49972C0.877075 11.1574 3.84222 14.1226 7.49991 14.1226C11.1576 14.1226 14.1227 11.1574 14.1227 7.49972C14.1227 3.84204 11.1576 0.876892 7.49991 0.876892ZM1.82707 7.49972C1.82707 4.36671 4.36689 1.82689 7.49991 1.82689C10.6329 1.82689 13.1727 4.36671 13.1727 7.49972C13.1727 10.6327 10.6329 13.1726 7.49991 13.1726C4.36689 13.1726 1.82707 10.6327 1.82707 7.49972ZM8.24992 4.49999C8.24992 4.9142 7.91413 5.24999 7.49992 5.24999C7.08571 5.24999 6.74992 4.9142 6.74992 4.49999C6.74992 4.08577 7.08571 3.74999 7.49992 3.74999C7.91413 3.74999 8.24992 4.08577 8.24992 4.49999ZM6.00003 5.99999H6.50003H7.50003C7.77618 5.99999 8.00003 6.22385 8.00003 6.49999V9.99999H9.00003C9.27618 9.99999 9.50003 10.2238 9.50003 10.5C9.50003 10.7761 9.27618 11 9.00003 11H8.00003H6.00003C5.72389 11 5.50003 10.7761 5.50003 10.5C5.50003 10.2238 5.72389 9.99999 6.00003 9.99999H7.00003V6.49999H6.00003C5.72389 6.49999 5.50003 6.22385 5.50003 5.99999C5.50003 5.72385 5.72389 5.99999 6.00003 5.99999Z" fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
                                    Keep in mind
                                </div>
                                <div class="sd-content">${md ? md.render(sd.keepInMind) : sd.keepInMind}</div>
                            </div>
                        `;
                    }

                    if (sd.formulasUsed) {
                        subsectionsHtml += `
                            <div class="sd-subsection sd-formulas">
                                <div class="sd-label">Formulas used</div>
                                <div class="sd-content">${md ? md.render(sd.formulasUsed) : sd.formulasUsed}</div>
                            </div>
                        `;
                    }

                    if (sd.working) {
                        subsectionsHtml += `
                            <div class="sd-subsection sd-working">
                                <div class="sd-label">Working</div>
                                <div class="sd-content">${md ? md.render(sd.working) : sd.working}</div>
                            </div>
                        `;
                    }

                    if (sd.alternativeWorking && Array.isArray(sd.alternativeWorking)) {
                        sd.alternativeWorking.forEach(alt => {
                            subsectionsHtml += `
                                <div class="sd-subsection sd-alt-working">
                                    <div class="sd-label">Alternative working</div>
                                    <div class="sd-content">${md ? md.render(alt) : alt}</div>
                                </div>
                            `;
                        });
                    }

                    detailsHtml = `
                        <button class="disclosure-control" aria-expanded="${ariaExpanded}" data-target="${q.id}">
                            ${btnText}
                            <svg class="chevron" width="12" height="12" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.13523 6.15803C3.3241 5.95657 3.64052 5.94637 3.84197 6.13523L7.5 9.56464L11.158 6.13523C11.3595 5.94637 11.6759 5.95657 11.8648 6.15803C12.0536 6.35949 12.0434 6.67591 11.842 6.86477L7.84197 10.6148C7.64964 10.7951 7.35036 10.7951 7.15803 10.6148L3.15803 6.86477C2.95657 6.67591 2.94637 6.35949 3.13523 6.15803Z" fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
                        </button>
                        <div class="${detailsClass}" id="sd-${q.id}">
                            ${subsectionsHtml}
                        </div>
                    `;
                }

                solutionBlockHtml = `
                    <div class="solution-block">
                        ${answerHtml}
                        ${detailsHtml}
                    </div>
                `;
            }

            // Children Logic
            let childrenHtml = '';
            if (q.children && q.children.length > 0) {
                childrenHtml = `
                    <div class="children-container">
                        ${renderQuestionList(q.children, depth + 1)}
                    </div>
                `;
            }

            return `
                <div class="${nodeClass}" id="q-${q.id}" data-qid="${q.id}">
                    <div class="question-body">
                        <span class="q-id">${q.id}</span>
                        <div class="q-prompt">${qBodyHtml}</div>
                    </div>
                    ${solutionBlockHtml}
                    ${childrenHtml}
                </div>
            `;
        }

        function attachEventListeners() {
            document.querySelectorAll('.disclosure-control').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    // Find button reference safely
                    const targetBtn = e.target.closest('.disclosure-control');
                    const qid = targetBtn.dataset.target;
                    
                    // Toggle logic
                    const wasExpanded = targetBtn.getAttribute('aria-expanded') === 'true';
                    const willExpand = !wasExpanded;

                    // Update State
                    if (state.defaultExpanded) {
                        if (willExpand) state.expandedNodes.delete('!'+qid);
                        else state.expandedNodes.add('!'+qid);
                    } else {
                        if (willExpand) state.expandedNodes.add(qid);
                        else state.expandedNodes.delete(qid);
                    }

                    // DOM Update
                    targetBtn.setAttribute('aria-expanded', willExpand);
                    targetBtn.innerHTML = `${willExpand ? "Hide working" : "Show working"} <svg class="chevron" width="12" height="12" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.13523 6.15803C3.3241 5.95657 3.64052 5.94637 3.84197 6.13523L7.5 9.56464L11.158 6.13523C11.3595 5.94637 11.6759 5.95657 11.8648 6.15803C12.0536 6.35949 12.0434 6.67591 11.842 6.86477L7.84197 10.6148C7.64964 10.7951 7.35036 10.7951 7.15803 10.6148L3.15803 6.86477C2.95657 6.67591 2.94637 6.35949 3.13523 6.15803Z" fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"></path></svg>`;
                    
                    const region = document.getElementById(`sd-${qid}`);
                    if (willExpand) {
                        region.classList.add('open');
                        region.style.display = 'flex';
                    } else {
                        region.classList.remove('open');
                        region.style.display = 'none';
                    }
                });
            });
        }

        // =========================================
        // NAVIGATION GEN & SYNC
        // =========================================
        function renderNavigation(paper) {
            let html = '';
            
            // Flatten logic
            const buildList = (qs, depth) => {
                let s = '';
                qs.forEach(q => {
                    s += `<a href="#q-${q.id}" class="nav-item" data-qid="${q.id}" data-depth="${depth}">${q.id}</a>`;
                    if (q.children) s += buildList(q.children, depth + 1);
                });
                return s;
            };

            if (paper.sections) {
                paper.sections.forEach(sec => {
                    if (sec.label && sec.label.trim().length > 0) {
                        html += `<div class="nav-section-label">${sec.label}</div>`;
                    }
                    html += buildList(sec.questions, 0);
                });
            } else if (paper.questions) {
                html += buildList(paper.questions, 0);
            }

            els.navListDesktop.innerHTML = html;
            els.navListMobile.innerHTML = html;

            // Nav interactions
            const setupLinks = (root) => {
                root.querySelectorAll('a').forEach(a => {
                    a.addEventListener('click', (e) => {
                        e.preventDefault();
                        const qid = a.dataset.qid;
                        const target = document.getElementById(`q-${qid}`);
                        if (target) {
                            // Close drawer if open
                            if (state.isMobileDrawerOpen) toggleDrawer(false);
                            
                            // Smooth Scroll with Offset
                            const y = target.getBoundingClientRect().top + window.scrollY - 80; // Header offset
                            window.scrollTo({top: y, behavior: 'smooth'});
                        }
                    });
                });
            };
            setupLinks(els.navListDesktop);
            setupLinks(els.navListMobile);
            
            // Init Intersection Observer for Active State
            setupScrollSpy();
        }

        let observer = null;
        function setupScrollSpy() {
            if (observer) observer.disconnect();
            
            const options = {
                root: null,
                rootMargin: '-80px 0px -80% 0px', // Active when near top
                threshold: 0
            };

            observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const qid = entry.target.dataset.qid;
                        updateActiveNav(qid);
                    }
                });
            }, options);

            document.querySelectorAll('.question-node').forEach(node => {
                observer.observe(node);
            });
        }

        function updateActiveNav(qid) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.querySelectorAll(`.nav-item[data-qid="${qid}"]`).forEach(el => {
                el.classList.add('active');
                // Auto-scroll nav rail
                el.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
            });
        }

        // =========================================
        // MOBILE DRAWER LOGIC
        // =========================================
        function toggleDrawer(open) {
            state.isMobileDrawerOpen = open;
            if (open) {
                els.mobileDrawer.classList.add('open');
                els.mobileDrawer.setAttribute('aria-hidden', 'false');
            } else {
                els.mobileDrawer.classList.remove('open');
                els.mobileDrawer.setAttribute('aria-hidden', 'true');
            }
        }

        els.btnJumpTo.addEventListener('click', () => toggleDrawer(true));
        els.btnDrawerClose.addEventListener('click', () => toggleDrawer(false));
        els.mobileDrawer.addEventListener('click', (e) => {
            if (e.target === els.mobileDrawer) toggleDrawer(false);
        });

        // =========================================
        // START
        // =========================================
        init();

    </script>
</body>
</html>
