<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AD","indexWithinVariant":"234","totalWithinVariant":"440","hueFamily":"","intensityMode":"","primaryHueFamily":"blue","secondaryHueFamily":"pink","dualIntensityMode":"dual_tinted_neutrals","timestamp":"2026-01-10T12:40:19.752Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AD&quot;,&quot;indexWithinVariant&quot;:&quot;234&quot;,&quot;totalWithinVariant&quot;:&quot;440&quot;,&quot;hueFamily&quot;:&quot;&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;primaryHueFamily&quot;:&quot;blue&quot;,&quot;secondaryHueFamily&quot;:&quot;pink&quot;,&quot;dualIntensityMode&quot;:&quot;dual_tinted_neutrals&quot;,&quot;timestamp&quot;:&quot;2026-01-10T12:40:19.752Z&quot;}'>

<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>RTQ Maths Paper Solution Viewer</title>

<!-- Fonts -->
<link rel="preconnect" href="https://rsms.me/">
<link rel="stylesheet" href="https://rsms.me/inter/inter.css">

<!-- KaTeX CSS (No Integrity/SRI as per Stage 6 instructions) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

<!-- KaTeX JS (No Integrity/SRI) -->
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

<!-- Markdown-it (No Integrity/SRI) -->
<script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

<style>
  /* 
    STAGE 6 ADD-ON: COLORLAB D (Dual-Accent, Light-Only) 
    Mode: dual_tinted_neutrals
    Primary Hue: 264 (Blue)
    Secondary Hue: 85 (Amber)
  */
  :root {
    /* Hues */
    --hue-primary: 264;
    --hue-secondary: 85;

    /* Mode: dual_tinted_neutrals Constraints */
    /* Surfaces: C in 0.015 .. 0.035 */
    --c-surface: 0.02; 
    --c-surface-wash: 0.03;

    /* Text: C <= 0.012 */
    --c-text: 0.01;

    /* Accents: Primary C [0.10..0.16], Secondary C [0.08..0.14] */
    --c-accent-primary: 0.14;
    --c-accent-secondary: 0.12;

    /* --- Surfaces --- */
    /* Page background */
    --bg-page: oklch(0.97 var(--c-surface) var(--hue-primary));
    /* Frame base */
    --bg-frame: oklch(0.96 var(--c-surface) var(--hue-primary));
    /* Paper surface */
    --bg-paper: oklch(0.985 var(--c-surface) var(--hue-primary));
    /* Solution Wash */
    --bg-wash: oklch(0.96 var(--c-surface-wash) var(--hue-primary));
    /* Drawer scrim */
    --bg-scrim: oklch(0 0 0 / 0.4);

    /* --- Text --- */
    --text-primary: oklch(0.20 var(--c-text) var(--hue-primary));
    --text-secondary: oklch(0.45 var(--c-text) var(--hue-primary));
    --text-tertiary: oklch(0.60 var(--c-text) var(--hue-primary));

    /* --- Accents --- */
    /* Primary: Links, Focus, Disclosure, Nav Active (Primary Role) */
    --color-primary: oklch(0.55 var(--c-accent-primary) var(--hue-primary));
    /* Secondary: Supplementary Role (Paper Selector Highlight / Nav Marker override) */
    --color-secondary: oklch(0.65 var(--c-accent-secondary) var(--hue-secondary));

    /* --- Lines --- */
    --line-hairline: oklch(0.90 0.02 var(--hue-primary));
    --line-focus-ring: var(--color-primary);

    /* --- Spacing System --- */
    --sp-xs: 0.25rem;
    --sp-sm: 0.5rem;
    --sp-md: 1rem;
    --sp-lg: 1.5rem;
    --sp-xl: 2.5rem;
    --sp-2xl: 4rem;

    /* --- Layout --- */
    --nav-width: 240px;
    --frame-max-width: 1024px;
    --header-height: 60px;
  }

  /* Reset & Base */
  *, *::before, *::after { box-sizing: border-box; }
  body {
    margin: 0;
    padding: 0;
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background-color: var(--bg-page);
    color: var(--text-primary);
    line-height: 1.5;
    -webkit-font-smoothing: antialiased;
    height: 100vh;
    overflow: hidden; /* App shell manages scroll */
  }

  button { font-family: inherit; }
  a { color: var(--color-primary); text-decoration: none; }
  a:hover { text-decoration: underline; }

  /* Focus States (Stage 5.5.2) */
  :focus-visible {
    outline: 2px solid var(--line-focus-ring);
    outline-offset: 2px;
    border-radius: 2px;
  }

  /* --- App Shell --- */
  #app-root {
    display: flex;
    flex-direction: column;
    height: 100%;
    max-width: var(--frame-max-width);
    margin: 0 auto;
    background-color: var(--bg-frame);
    /* Desktop: Nav and Paper share frame surface */
  }

  /* --- Top Controls --- */
  .top-controls {
    height: var(--header-height);
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 var(--sp-md);
    border-bottom: 1px solid var(--line-hairline);
    background-color: var(--bg-frame);
    z-index: 10;
  }

  .paper-selector {
    padding: var(--sp-sm);
    font-size: 0.9rem;
    border: 1px solid var(--line-hairline);
    border-radius: 4px;
    background: var(--bg-paper);
    color: var(--text-primary);
    min-width: 200px;
  }

  .jump-to-trigger {
    display: none; /* Desktop hidden */
    padding: var(--sp-sm) var(--sp-md);
    background: transparent;
    border: 1px solid var(--line-hairline);
    border-radius: 4px;
    color: var(--color-primary);
    font-weight: 500;
    font-size: 0.9rem;
    cursor: pointer;
  }

  /* --- Document Frame --- */
  .document-frame-shell {
    display: flex;
    flex: 1;
    overflow: hidden; /* Columns scroll independently if needed, though mostly paper scrolls */
  }

  /* --- Navigation Rail (Desktop) --- */
  .nav-rail {
    width: var(--nav-width);
    flex-shrink: 0;
    border-right: 1px solid var(--line-hairline);
    display: none; /* Hidden on mobile by default */
    flex-direction: column;
    overflow-y: auto;
    padding: var(--sp-lg) var(--sp-md);
    /* Hide scrollbars visually */
    scrollbar-width: none; 
    -ms-overflow-style: none;
  }
  .nav-rail::-webkit-scrollbar { display: none; }

  /* Nav Items */
  .nav-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 2px;
  }
  
  .nav-section-label {
    margin-top: var(--sp-md);
    margin-bottom: var(--sp-sm);
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-tertiary);
    font-weight: 600;
    padding-left: var(--sp-sm);
    pointer-events: none;
  }
  .nav-section-label:first-child { margin-top: 0; }

  .nav-item {
    display: block;
    padding: var(--sp-xs) var(--sp-sm);
    font-size: 0.9rem;
    color: var(--text-secondary);
    border-radius: 4px;
    cursor: pointer;
    transition: color 0.1s ease, background-color 0.1s ease;
    text-align: left;
    background: none;
    border: none;
    width: 100%;
  }
  
  .nav-item:hover {
    color: var(--text-primary);
    background-color: oklch(0.94 var(--c-surface) var(--hue-primary)); /* subtle hover */
  }

  /* Current Item Indication (Weight only + Primary Color per Stage 6/D6) */
  .nav-item.is-current {
    font-weight: 600;
    color: var(--color-primary);
  }

  /* Hierarchy via type scale only (Stage 3/4) */
  .nav-item[data-depth="0"] { font-size: 0.9rem; }
  .nav-item[data-depth="1"] { font-size: 0.85rem; }
  .nav-item[data-depth="2"] { font-size: 0.8rem; }
  .nav-item[data-depth="3"] { font-size: 0.8rem; }

  /* --- Paper Column --- */
  .paper-column {
    flex: 1;
    overflow-y: auto;
    background-color: var(--bg-paper);
    padding: var(--sp-xl) var(--sp-xl) var(--sp-2xl);
    scroll-behavior: smooth;
  }

  /* --- Content Grammar --- */
  
  /* Section Header in Paper */
  .paper-section-header {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--text-secondary);
    border-bottom: 1px solid var(--line-hairline);
    padding-bottom: var(--sp-sm);
    margin-bottom: var(--sp-xl);
    margin-top: var(--sp-xl);
  }
  .paper-section-header:first-child { margin-top: 0; }

  /* Question Node */
  .question-node {
    margin-bottom: var(--sp-xl); /* Top level separation */
  }

  /* Nested separation adjustments */
  .children-container {
    margin-top: var(--sp-lg);
    padding-left: var(--sp-md); /* Indentation */
  }
  .children-container .question-node {
    margin-bottom: var(--sp-lg); /* Tighter sibling separation */
  }

  /* Question Body */
  .question-body {
    color: var(--text-primary);
    font-weight: 500;
    margin-bottom: var(--sp-md);
  }
  .q-identifier {
    font-weight: 700;
    margin-right: 0.5em;
    color: var(--text-secondary); /* subordinate */
  }

  /* Solution Block */
  .solution-block {
    /* No heavy container */
    margin-top: var(--sp-md);
  }

  /* Answer */
  .answer-region {
    margin-bottom: var(--sp-md);
  }
  .answer-label {
    font-size: 0.85rem;
    font-weight: 700;
    color: var(--text-secondary);
    display: block;
    margin-bottom: var(--sp-xs);
  }
  .answer-content {
    font-size: 1rem;
    color: var(--text-primary);
  }

  /* Solution Details */
  .solution-details-container {
    /* Region boundary cue */
  }

  .disclosure-control {
    display: inline-flex;
    align-items: center;
    gap: 0.5ch;
    font-size: 0.9rem;
    color: var(--color-primary);
    background: none;
    border: none;
    padding: 0;
    cursor: pointer;
    font-weight: 500;
    margin-bottom: var(--sp-sm);
  }
  .disclosure-control:hover {
    text-decoration: underline;
  }
  .disclosure-icon {
    font-size: 0.8em;
    transition: transform 0.2s ease;
  }
  .disclosure-control[aria-expanded="true"] .disclosure-icon {
    transform: rotate(180deg);
  }

  .solution-details-region {
    display: none;
    margin-top: var(--sp-sm);
    padding: var(--sp-md);
    background-color: var(--bg-wash); /* Surface differentiation */
    border-radius: 4px; /* Permitted quiet demarcation */
    font-size: 0.95rem; /* Hierarchy via size */
    color: var(--text-primary); /* Anti-faded guardrail */
  }
  
  .solution-details-region[data-visible="true"] {
    display: block;
    animation: fadeIn 0.2s ease-out;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-4px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Subsections */
  .sd-subsection {
    margin-bottom: var(--sp-md);
  }
  .sd-subsection:last-child { margin-bottom: 0; }

  .sd-label {
    font-size: 0.8rem;
    font-weight: 700;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: var(--sp-sm);
    display: flex;
    align-items: center;
    gap: 0.5em;
  }
  
  /* Keep In Mind: slightly higher contrast body */
  .sd-keep-in-mind .sd-body {
    color: var(--text-primary);
  }

  .sd-body ul, .sd-body ol {
    margin: 0;
    padding-left: 1.2em;
  }
  .sd-body p { margin: 0 0 0.5em 0; }
  .sd-body p:last-child { margin-bottom: 0; }

  /* Working & Alternative Working separation */
  .sd-alternative-working {
    margin-top: var(--sp-lg);
    padding-top: var(--sp-md);
    border-top: 1px solid var(--line-hairline); /* Allowed secondary separator */
  }

  /* Tables inside content */
  table {
    width: 100%;
    border-collapse: collapse;
    margin: var(--sp-sm) 0;
    font-size: 0.9rem;
  }
  th, td {
    border: 1px solid oklch(0.85 0.01 var(--hue-primary));
    padding: var(--sp-xs) var(--sp-sm);
    text-align: left;
  }
  th {
    font-weight: 600;
    background: rgba(0,0,0,0.02);
  }

  /* Math Containment Invariant */
  .katex-display {
    overflow-x: auto;
    overflow-y: hidden;
    max-width: 100%;
    -webkit-overflow-scrolling: touch;
    padding: 0.5em 0;
    background: transparent; /* No block bg */
  }
  /* Inline katex background forbidden */
  .katex { background: transparent !important; }

  /* Error State */
  .error-message {
    padding: var(--sp-xl);
    text-align: center;
    color: var(--text-secondary);
    font-weight: 600;
    letter-spacing: 0.05em;
  }

  /* --- Mobile Drawer (Stage 6 Add-on) --- */
  .mobile-drawer-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background-color: var(--bg-scrim);
    z-index: 999;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease;
    display: flex;
    justify-content: flex-end; /* Drawer on right usually, or left? Brief says "Jump to" trigger. Let's do Left for consistency with desktop logic. */
    justify-content: flex-start;
  }
  .mobile-drawer-overlay.is-open {
    opacity: 1;
    pointer-events: auto;
  }

  .mobile-drawer {
    width: 85%;
    max-width: 320px;
    height: 100%;
    background-color: var(--bg-frame);
    transform: translateX(-100%);
    transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    display: flex;
    flex-direction: column;
    box-shadow: 2px 0 12px rgba(0,0,0,0.1);
  }
  .mobile-drawer-overlay.is-open .mobile-drawer {
    transform: translateX(0);
  }

  .drawer-header {
    height: var(--header-height);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 var(--sp-md);
    border-bottom: 1px solid var(--line-hairline);
  }
  .drawer-title { font-weight: 600; color: var(--text-primary); }
  .drawer-close {
    background: none; border: none; font-size: 1.5rem; color: var(--text-secondary);
    cursor: pointer; padding: var(--sp-xs);
  }

  .drawer-content {
    flex: 1;
    overflow-y: auto;
    padding: var(--sp-md);
  }

  /* --- Responsive --- */
  @media (min-width: 768px) {
    .jump-to-trigger { display: none; }
    .nav-rail { display: flex; }
    .paper-column { padding-left: var(--sp-2xl); padding-right: var(--sp-2xl); }
  }
  @media (max-width: 767px) {
    .jump-to-trigger { display: block; }
    .nav-rail { display: none; }
    .paper-column { padding: var(--sp-md); }
  }

</style>
</head>
<body>

<div id="app-root">
  <header class="top-controls">
    <select id="paper-selector" class="paper-selector" aria-label="Select Paper">
      <option disabled selected>Loading papers...</option>
    </select>
    <button id="jump-to-btn" class="jump-to-trigger" aria-label="Open Navigation">
      Jump to
    </button>
  </header>

  <div class="document-frame-shell">
    <nav class="nav-rail" id="desktop-nav">
      <!-- Nav Content Generated JS -->
    </nav>

    <main class="paper-column" id="paper-content">
      <!-- Paper Content Generated JS -->
    </main>
  </div>
</div>

<!-- Mobile Drawer -->
<div class="mobile-drawer-overlay" id="drawer-overlay" aria-hidden="true">
  <div class="mobile-drawer" role="dialog" aria-modal="true" aria-label="Navigation">
    <header class="drawer-header">
      <span class="drawer-title">Jump to</span>
      <button class="drawer-close" id="drawer-close" aria-label="Close navigation">&times;</button>
    </header>
    <div class="drawer-content" id="mobile-nav-content">
      <!-- Nav Content Cloned Here -->
    </div>
  </div>
</div>

<script>
/**
 * STAGE 0: CONSTANTS
 */
const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

/**
 * STATE
 */
let APP_STATE = {
  papers: [],
  currentPaper: null,
  activeQuestionId: null
};

/**
 * MARKDOWN SETUP
 * Stage 6 Add-on: Config Invariants
 */
let md = null;
if (window.markdownit) {
  md = window.markdownit({
    html: true,       // allow inline SVG passthrough
    linkify: true,
    breaks: false     // MUST stay false to prevent <br> in math blocks
  });
  // Disable escape rule to preserve TeX backslashes
  md.inline.ruler.disable(['escape']);
}

/**
 * INIT
 */
async function init() {
  try {
    const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
    if (!response.ok) throw new Error("Payload fetch failed");
    const payload = await response.json();
    
    if (!payload.papers || !Array.isArray(payload.papers)) {
      throw new Error("Invalid payload schema");
    }

    APP_STATE.papers = payload.papers;
    renderPaperSelector();
    
    // Load first paper by default
    if (APP_STATE.papers.length > 0) {
      loadPaper(APP_STATE.papers[0].key);
    } else {
      renderError("No papers found in payload.");
    }

  } catch (e) {
    console.error(e);
    renderError("PAPERS PAYLOAD MISSING");
  }

  setupInteractions();
}

/**
 * RENDERING
 */

function renderError(msg) {
  const container = document.getElementById('paper-content');
  container.innerHTML = `<div class="error-message">${msg}</div>`;
  // clear nav
  document.getElementById('desktop-nav').innerHTML = '';
  document.getElementById('mobile-nav-content').innerHTML = '';
}

function renderPaperSelector() {
  const select = document.getElementById('paper-selector');
  select.innerHTML = '';
  APP_STATE.papers.forEach(p => {
    const opt = document.createElement('option');
    opt.value = p.key;
    opt.textContent = p.label;
    select.appendChild(opt);
  });
  
  select.addEventListener('change', (e) => {
    loadPaper(e.target.value);
  });
}

function loadPaper(key) {
  const paper = APP_STATE.papers.find(p => p.key === key);
  if (!paper) return;
  APP_STATE.currentPaper = paper;

  // Defaults
  const defaults = paper.defaults || {};
  const expandAll = defaults.expandedAll !== false; // Default true unless false

  // Render Content
  const contentContainer = document.getElementById('paper-content');
  contentContainer.innerHTML = '';

  // Handle Sections vs Flat
  let html = '';
  let navItems = [];

  if (paper.sections && Array.isArray(paper.sections)) {
    paper.sections.forEach(section => {
      // Nav Section Label
      if (section.label && section.label.trim().length > 0) {
        navItems.push({ type: 'section', label: section.label });
      }
      
      // Paper Section Header
      if (section.label && section.label.trim().length > 0) {
        html += `<div class="paper-section-header">${escapeHTML(section.label)}</div>`;
      }
      
      // Questions
      if (section.questions) {
        section.questions.forEach(q => {
          html += renderQuestionNode(q, 0, expandAll);
          collectNavItems(q, navItems, 0);
        });
      }
    });
  } else if (paper.questions && Array.isArray(paper.questions)) {
    paper.questions.forEach(q => {
      html += renderQuestionNode(q, 0, expandAll);
      collectNavItems(q, navItems, 0);
    });
  }

  contentContainer.innerHTML = html;

  // Render Navigation
  renderNavigation(navItems);

  // KaTeX Auto-render
  if (window.renderMathInElement) {
    renderMathInElement(contentContainer, {
      delimiters: [
        {left: '$$', right: '$$', display: true},
        {left: '$', right: '$', display: false}
      ],
      throwOnError: false
    });
  }
  
  // Reset Scroll
  contentContainer.scrollTop = 0;
}

function renderQuestionNode(node, depth, expandAll) {
  const indentClass = depth > 0 ? 'children-container' : '';
  const nodeID = `q-${node.id}`; // clean ID for anchors

  let html = `<div class="question-node" id="${nodeID}" data-qid="${node.id}">`;
  
  // Surface wrapper optional (not used per minimal grayscale spec unless needed, sticking to spacing)
  
  // 1. Question Body
  const qHtml = renderMarkdown(node.question);
  html += `
    <div class="question-body">
      <span class="q-identifier">${node.id}</span>
      <span>${qHtml}</span>
    </div>
  `;

  // 2. Solution Block (Optional)
  if (node.solutionBlock) {
    html += `<div class="solution-block">`;
    
    // Answer
    if (node.solutionBlock.answer) {
      html += `
        <div class="answer-region">
          <span class="answer-label">Answer</span>
          <div class="answer-content">${renderMarkdown(node.solutionBlock.answer)}</div>
        </div>
      `;
    }

    // Solution Details
    if (node.solutionBlock.solutionDetails) {
      const details = node.solutionBlock.solutionDetails;
      const isExpanded = expandAll; 
      
      html += `<div class="solution-details-container">`;
      
      // Toggle Control
      html += `
        <button class="disclosure-control" aria-expanded="${isExpanded}" onclick="toggleSolution(this)">
          <span class="disclosure-text">${isExpanded ? 'Hide working' : 'Show working'}</span>
          <span class="disclosure-icon" aria-hidden="true">â–¼</span>
        </button>
      `;

      // Region
      html += `<div class="solution-details-region" data-visible="${isExpanded}">`;

      // Keep In Mind
      if (details.keepInMind) {
        html += `
          <div class="sd-subsection sd-keep-in-mind">
            <div class="sd-label">
               <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
               Keep in mind
            </div>
            <div class="sd-body">${renderMarkdown(details.keepInMind)}</div>
          </div>
        `;
      }

      // Formulas Used
      if (details.formulasUsed) {
        html += `
          <div class="sd-subsection sd-formulas-used">
            <div class="sd-label">Formulas used</div>
            <div class="sd-body">${renderMarkdown(details.formulasUsed)}</div>
          </div>
        `;
      }

      // Working
      if (details.working) {
        html += `
          <div class="sd-subsection sd-working">
            <div class="sd-label">Working</div>
            <div class="sd-body">${renderMarkdown(details.working)}</div>
          </div>
        `;
      }

      // Alternative Working
      if (details.alternativeWorking && Array.isArray(details.alternativeWorking)) {
        details.alternativeWorking.forEach(alt => {
           html += `
            <div class="sd-subsection sd-alternative-working">
              <div class="sd-label">Alternative working</div>
              <div class="sd-body">${renderMarkdown(alt)}</div>
            </div>
          `;
        });
      } else if (details.alternativeWorking && typeof details.alternativeWorking === 'string') {
        // Fallback if string
         html += `
            <div class="sd-subsection sd-alternative-working">
              <div class="sd-label">Alternative working</div>
              <div class="sd-body">${renderMarkdown(details.alternativeWorking)}</div>
            </div>
          `;
      }

      html += `</div>`; // end region
      html += `</div>`; // end container
    }
    html += `</div>`; // end solution block
  }

  // Children
  if (node.children && node.children.length > 0) {
    html += `<div class="children-container">`;
    node.children.forEach(child => {
      html += renderQuestionNode(child, depth + 1, expandAll);
    });
    html += `</div>`;
  }

  html += `</div>`; // end question node
  return html;
}

/**
 * NAV GENERATION
 */
function collectNavItems(node, list, depth) {
  list.push({ type: 'item', id: node.id, depth: depth });
  if (node.children) {
    node.children.forEach(child => collectNavItems(child, list, depth + 1));
  }
}

function renderNavigation(items) {
  const desktopNav = document.getElementById('desktop-nav');
  const mobileNav = document.getElementById('mobile-nav-content');
  
  let html = `<ul class="nav-list">`;
  
  items.forEach(item => {
    if (item.type === 'section') {
      html += `<li class="nav-section-label">${escapeHTML(item.label)}</li>`;
    } else {
      html += `<li>
        <button class="nav-item" data-target="q-${item.id}" data-depth="${Math.min(item.depth, 3)}" onclick="scrollToQuestion('q-${item.id}')">
          ${item.id}
        </button>
      </li>`;
    }
  });
  
  html += `</ul>`;
  
  desktopNav.innerHTML = html;
  mobileNav.innerHTML = html;
}

/**
 * INTERACTIONS
 */
function toggleSolution(btn) {
  const isExpanded = btn.getAttribute('aria-expanded') === 'true';
  const newState = !isExpanded;
  btn.setAttribute('aria-expanded', newState);
  
  const textSpan = btn.querySelector('.disclosure-text');
  if(textSpan) textSpan.textContent = newState ? 'Hide working' : 'Show working';

  const region = btn.nextElementSibling;
  region.setAttribute('data-visible', newState);
}

function scrollToQuestion(id) {
  const el = document.getElementById(id);
  if (el) {
    el.scrollIntoView({ behavior: 'smooth', block: 'start' });
    // Update active state manually on click
    updateActiveNav(el.getAttribute('data-qid'));
    // Close drawer if open
    closeDrawer();
  }
}

function updateActiveNav(qid) {
  document.querySelectorAll('.nav-item').forEach(btn => {
    if (btn.innerText === qid) btn.classList.add('is-current');
    else btn.classList.remove('is-current');
  });
}

function setupInteractions() {
  // Mobile Drawer
  const drawerOverlay = document.getElementById('drawer-overlay');
  const openBtn = document.getElementById('jump-to-btn');
  const closeBtn = document.getElementById('drawer-close');

  openBtn.addEventListener('click', () => {
    drawerOverlay.classList.add('is-open');
    drawerOverlay.setAttribute('aria-hidden', 'false');
  });

  function closeDrawer() {
    drawerOverlay.classList.remove('is-open');
    drawerOverlay.setAttribute('aria-hidden', 'true');
  }

  closeBtn.addEventListener('click', closeDrawer);
  drawerOverlay.addEventListener('click', (e) => {
    if (e.target === drawerOverlay) closeDrawer();
  });
}

/**
 * UTILS
 */
function renderMarkdown(text) {
  if (!text) return '';
  if (!md) return text; // fallback
  return md.render(text);
}

function escapeHTML(str) {
  return str.replace(/[&<>'"]/g, 
    tag => ({
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      "'": '&#39;',
      '"': '&quot;'
    }[tag]));
}

// Start
init();

</script>
</body>
</html>
