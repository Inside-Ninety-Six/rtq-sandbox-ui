<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AD","indexWithinVariant":"40","totalWithinVariant":"440","hueFamily":"","intensityMode":"","primaryHueFamily":"teal","secondaryHueFamily":"green","dualIntensityMode":"dual_deep_theme","timestamp":"2026-01-10T03:54:27.085Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AD&quot;,&quot;indexWithinVariant&quot;:&quot;40&quot;,&quot;totalWithinVariant&quot;:&quot;440&quot;,&quot;hueFamily&quot;:&quot;&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;primaryHueFamily&quot;:&quot;teal&quot;,&quot;secondaryHueFamily&quot;:&quot;green&quot;,&quot;dualIntensityMode&quot;:&quot;dual_deep_theme&quot;,&quot;timestamp&quot;:&quot;2026-01-10T03:54:27.085Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer (Stage 6 Baseline)</title>

    <!-- Tailwind CSS (Prototype Mode) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- KaTeX CSS (No integrity) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <!-- KaTeX JS (No integrity) -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Markdown-it (No integrity) -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <style>
        /* --- ColorLab D: Dual-Accent Palette (Dual Deep Theme - Light Only) --- */
        :root {
            /* Hues: Primary (Blue), Secondary (Amber) */
            --hue-p: 260; 
            --hue-s: 85;

            /* Dual Deep Theme: Surfaces (High Chroma, Light Mode) */
            --bg-page: oklch(0.95 0.08 var(--hue-p));   /* Deep tinted page background */
            --bg-frame: oklch(0.93 0.10 var(--hue-p));  /* Slightly deeper frame base */
            --bg-paper: oklch(0.98 0.06 var(--hue-p));  /* Paper surface, tinted white */
            --bg-wash: oklch(0.96 0.05 var(--hue-p));   /* Solution details wash */
            
            /* Text (High Legibility, Low Chroma) */
            --txt-primary: oklch(0.20 0.015 var(--hue-p));
            --txt-secondary: oklch(0.40 0.02 var(--hue-p));
            --txt-quiet: oklch(0.55 0.02 var(--hue-p));

            /* Accents (Disciplined) */
            --accent-primary: oklch(0.55 0.22 var(--hue-p)); /* Focus, Links, Disclosure Text */
            --accent-secondary: oklch(0.65 0.18 var(--hue-s)); /* Nav Marker Only */

            /* Structure */
            --border-hairline: oklch(0.85 0.02 var(--hue-p));
            --border-focus: var(--accent-primary);
        }

        /* Base Typography */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-page);
            color: var(--txt-primary);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        /* --- Layout Shell (DocumentFrameShell) --- */
        .frame-shell {
            background-color: var(--bg-frame);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .frame-inner {
            width: 100%;
            max-width: 1280px;
            display: grid;
            grid-template-columns: 1fr; /* Mobile default */
            position: relative;
        }

        @media (min-width: 1024px) {
            .frame-inner {
                grid-template-columns: 240px 1fr; /* Desktop: Nav + Paper */
                column-gap: 48px;
                padding: 0 48px;
            }
        }

        /* --- Navigation --- */
        /* Desktop Sticky Rail */
        .nav-rail {
            display: none;
        }
        @media (min-width: 1024px) {
            .nav-rail {
                display: block;
                position: sticky;
                top: 2rem;
                height: calc(100vh - 4rem);
                overflow-y: auto;
                padding-bottom: 2rem;
                /* Scrollbar hiding */
                scrollbar-width: none;
                -ms-overflow-style: none;
            }
            .nav-rail::-webkit-scrollbar {
                display: none;
            }
        }

        /* Nav List Styling */
        .nav-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .nav-section-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--txt-quiet);
            font-weight: 600;
            padding: 16px 0 4px 0;
            border-bottom: 1px solid transparent; /* Alignment aid */
            pointer-events: none;
        }

        .nav-item {
            display: block;
            text-decoration: none;
            color: var(--txt-secondary);
            font-size: 0.875rem;
            padding: 4px 0;
            transition: color 0.15s ease;
            position: relative;
            /* Hierarchy via type scale only, strict left align */
            text-align: left;
        }
        
        .nav-item:hover {
            color: var(--txt-primary);
            text-decoration: underline;
            text-decoration-color: var(--accent-primary);
            text-underline-offset: 2px;
        }

        .nav-item.active {
            color: var(--txt-primary);
            font-weight: 700;
        }
        
        /* Secondary accent marker for active state */
        .nav-item.active::before {
            content: '';
            position: absolute;
            left: -12px;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background-color: var(--accent-secondary);
        }

        .nav-item-sub {
            font-size: 0.8125rem; /* Quieter */
            color: var(--txt-quiet);
        }

        /* --- Paper Content --- */
        .paper-column {
            background-color: var(--bg-paper);
            min-height: 100vh;
            padding: 48px 32px 128px 32px; /* Generous bottom padding */
            box-shadow: none; /* Flat */
        }

        @media (max-width: 640px) {
            .paper-column {
                padding: 24px 16px 96px 16px;
            }
        }

        /* Top Controls (Paper Selector) */
        .top-controls {
            position: sticky;
            top: 0;
            z-index: 40;
            background-color: var(--bg-frame);
            border-bottom: 1px solid var(--border-hairline);
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        @media (min-width: 1024px) {
            .top-controls {
                position: static;
                background: transparent;
                border-bottom: none;
                padding: 32px 0 0 0; /* Aligns with nav start */
                margin-bottom: 32px;
            }
        }

        /* Question Node Structure */
        .question-node {
            margin-bottom: 3rem; /* Largest spacing unit */
            position: relative;
        }
        
        .question-header {
            display: flex;
            align-items: baseline;
            gap: 0.75rem;
        }

        .q-id {
            font-weight: 700;
            color: var(--txt-secondary);
            font-size: 1rem;
            flex-shrink: 0;
            width: 2.5rem; /* Fixed width for alignment */
        }
        .q-body {
            color: var(--txt-primary);
            font-size: 1.0625rem;
            width: 100%;
        }

        /* Solution Block */
        .solution-block {
            margin-left: 3.25rem; /* Indented to align with text start */
            margin-top: 1.25rem;
            padding-left: 0;
        }
        @media (max-width: 640px) {
            .solution-block {
                margin-left: 0;
                padding-top: 1rem;
            }
            .question-header {
                flex-direction: column;
                gap: 0.25rem;
            }
            .q-id { width: auto; }
        }

        /* Answer */
        .answer-region {
            margin-bottom: 1rem;
            color: var(--txt-secondary);
            font-weight: 500;
        }
        .answer-label {
            font-size: 0.8125rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--txt-quiet);
            margin-right: 0.5rem;
            font-weight: 700;
        }

        /* Disclosure Control */
        .disclosure-btn {
            background: none;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--accent-primary);
            font-weight: 500;
            font-size: 0.9375rem;
            padding: 4px 0;
            margin-bottom: 0.5rem;
        }
        .disclosure-btn:hover {
            text-decoration: underline;
        }
        .disclosure-icon {
            transition: transform 0.2s ease;
        }
        .disclosure-btn[aria-expanded="true"] .disclosure-icon {
            transform: rotate(180deg);
        }

        /* Solution Details Region */
        .solution-details {
            display: none;
            margin-top: 0.75rem;
            background-color: var(--bg-wash);
            padding: 1.5rem;
            border-left: 1px solid var(--border-hairline);
            font-size: 0.9375rem;
        }
        .solution-details.expanded {
            display: block;
            animation: fadeIn 0.2s ease-out;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-4px); } to { opacity: 1; transform: translateY(0); } }

        /* Subsections (Keep in mind, Formulas, Working) */
        .sd-section {
            margin-bottom: 1.5rem;
        }
        .sd-section:last-child { margin-bottom: 0; }
        
        .sd-label {
            display: block;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--txt-quiet);
            margin-bottom: 0.5rem;
            letter-spacing: 0.02em;
        }

        /* Working / Alternative Working Separation */
        .alt-working-divider {
            height: 1px;
            background-color: var(--border-hairline);
            margin: 1.5rem 0;
        }

        /* Math & Markdown Styles */
        .md-content p { margin-bottom: 0.75rem; }
        .md-content p:last-child { margin-bottom: 0; }
        
        /* KaTeX Containment Invariant */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            padding: 0.5rem 0;
            margin: 0.5rem 0;
            max-width: 100%;
            /* Minimal underlay for display math only per locked system */
            background-color: rgba(0,0,0,0.02); 
            border-radius: 4px;
        }
        /* Hide scrollbars for math */
        .katex-display::-webkit-scrollbar { display: none; }
        .katex-display { -ms-overflow-style: none; scrollbar-width: none; }

        .katex { font-size: 1.1em; } /* Visual balance */

        /* Tables in Markdown */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            font-size: 0.875rem;
        }
        th, td {
            border: 1px solid var(--border-hairline);
            padding: 8px 12px;
            text-align: left;
        }
        th { font-weight: 600; background-color: rgba(0,0,0,0.02); }

        /* Mobile Drawer */
        .drawer-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.2); /* Scrim */
            z-index: 50;
            display: none;
        }
        .drawer-overlay.open { display: block; }
        
        .drawer {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            width: 280px;
            background: var(--bg-frame);
            z-index: 51;
            transform: translateX(100%);
            transition: transform 0.2s ease-out;
            box-shadow: -4px 0 16px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
        }
        .drawer.open { transform: translateX(0); }
        
        .drawer-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-hairline);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .drawer-content {
            overflow-y: auto;
            padding: 16px;
            flex: 1;
        }

        /* Focus States (Accessibility) */
        :focus-visible {
            outline: 2px solid var(--border-focus);
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* Utilities */
        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Message */
        .error-msg {
            padding: 2rem;
            color: var(--txt-secondary);
            font-weight: 600;
            text-align: center;
        }

        /* Selector styling */
        select {
            appearance: none;
            background-color: var(--bg-paper);
            border: 1px solid var(--border-hairline);
            padding: 8px 32px 8px 12px;
            border-radius: 4px;
            font-size: 0.875rem;
            color: var(--txt-primary);
            cursor: pointer;
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23666%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat;
            background-position: right 0.7em top 50%;
            background-size: 0.65em auto;
        }
    </style>
</head>
<body>

    <!-- Runtime Constants -->
    <script>
        // CANONICAL CONSTANT â€” PAPERS PAYLOAD PATH (v1.0)
        // This value is authoritative.
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        
        // Shadcn Token Profiles (Reference only for strictness, unused in vanilla prototype)
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";
    </script>

    <div id="root" class="frame-shell">
        <!-- Top Controls (Mobile Header / Desktop Spacer) -->
        <div class="frame-inner">
            <header class="top-controls">
                <div id="paper-select-container">
                    <!-- Paper Selector injected here -->
                    <span class="text-sm text-[var(--txt-quiet)]">Loading...</span>
                </div>
                
                <!-- Mobile Jump Trigger -->
                <button id="mobile-jump-trigger" class="lg:hidden text-[var(--accent-primary)] font-medium text-sm flex items-center gap-1">
                    Jump to
                    <svg width="16" height="16" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.13523 6.15803C3.3241 5.95657 3.64052 5.94637 3.84197 6.13523L7.5 9.56464L11.158 6.13523C11.3595 5.94637 11.6759 5.95657 11.8648 6.15803C12.0536 6.35949 12.0434 6.67591 11.842 6.86477L7.84197 10.6148C7.64964 10.7951 7.35036 10.7951 7.15803 10.6148L3.15803 6.86477C2.95657 6.67591 2.94637 6.35949 3.13523 6.15803Z" fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
                </button>
            </header>
        </div>

        <div class="frame-inner flex-1">
            <!-- Desktop Navigation Rail -->
            <nav id="desktop-nav" class="nav-rail" aria-label="Paper navigation">
                <!-- Nav Content Injected Here -->
            </nav>

            <!-- Paper Content Column -->
            <main id="paper-content" class="paper-column">
                <!-- Question List Injected Here -->
            </main>
        </div>
    </div>

    <!-- Mobile Navigation Drawer -->
    <div id="mobile-drawer-overlay" class="drawer-overlay"></div>
    <aside id="mobile-drawer" class="drawer" aria-label="Mobile navigation">
        <div class="drawer-header">
            <span class="font-bold text-[var(--txt-primary)]">Jump to question</span>
            <button id="drawer-close" class="text-[var(--txt-secondary)] hover:text-[var(--txt-primary)] p-2">
                <svg width="15" height="15" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M11.7816 4.03157C12.0062 3.80702 12.0062 3.44295 11.7816 3.2184C11.5571 2.99385 11.193 2.99385 10.9685 3.2184L7.50005 6.68682L4.03164 3.2184C3.80708 2.99385 3.44301 2.99385 3.21846 3.2184C2.99391 3.44295 2.99391 3.80702 3.21846 4.03157L6.68688 7.50001L3.21846 10.9684C2.99391 11.193 2.99391 11.557 3.21846 11.7816C3.44301 12.0061 3.80708 12.0061 4.03164 11.7816L7.50005 8.31316L10.9685 11.7816C11.193 12.0061 11.5571 12.0061 11.7816 11.7816C12.0062 11.557 12.0062 11.193 11.7816 10.9684L8.31322 7.50001L11.7816 4.03157Z" fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
            </button>
        </div>
        <div id="drawer-nav-content" class="drawer-content">
            <!-- Mobile Nav Copy Injected Here -->
        </div>
    </aside>

    <script>
        /**
         * RTQ Logic Layer
         */

        // 1. Markdown Setup (Authoritative Config)
        const md = window.markdownit ? window.markdownit({
            html: true,
            linkify: true,
            breaks: false, // Critical: prevent <br> in math
        }) : null;

        if (md) {
            md.inline.ruler.disable(['escape']); // Preserve TeX backslashes
        }

        // Global State
        let appData = {
            papers: [],
            activePaperKey: null,
            expandedMap: {} // { "questionId": boolean }
        };

        // 2. Fetch Payload
        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Fetch failed");
                const payload = await response.json();
                
                appData.papers = payload.papers || [];
                if (appData.papers.length === 0) throw new Error("No papers found");
                
                // Initialize with first paper
                appData.activePaperKey = appData.papers[0].key;
                
                renderPaperSelector();
                renderApp();

            } catch (err) {
                console.error(err);
                document.getElementById('paper-content').innerHTML = `<div class="error-msg">PAPERS PAYLOAD MISSING</div>`;
                document.getElementById('paper-select-container').innerHTML = '';
            }
        }

        // 3. Renderers

        function renderPaperSelector() {
            const container = document.getElementById('paper-select-container');
            const select = document.createElement('select');
            select.ariaLabel = "Select paper";
            
            appData.papers.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.key;
                opt.textContent = p.label || p.key;
                if (p.key === appData.activePaperKey) opt.selected = true;
                select.appendChild(opt);
            });

            select.addEventListener('change', (e) => {
                appData.activePaperKey = e.target.value;
                appData.expandedMap = {}; // Reset state on paper switch
                renderApp();
            });

            container.innerHTML = '';
            container.appendChild(select);
        }

        function renderApp() {
            const paper = appData.papers.find(p => p.key === appData.activePaperKey);
            if (!paper) return;

            const contentContainer = document.getElementById('paper-content');
            const navContainer = document.getElementById('desktop-nav');
            const drawerContainer = document.getElementById('drawer-nav-content');

            // Determine if Sectioned or Flat
            const isSectioned = !!(paper.sections && paper.sections.length > 0);
            
            // Build Question List HTML
            let html = '';
            
            if (isSectioned) {
                paper.sections.forEach(sec => {
                    // Render Section Header if label exists
                    if (sec.label && sec.label.trim().length > 0) {
                        html += `<div class="py-4 border-b border-[var(--border-hairline)] mb-8">
                            <span class="text-2xl font-bold text-[var(--txt-primary)]">${sec.label}</span>
                        </div>`;
                    }
                    if (sec.questions) {
                        sec.questions.forEach(q => {
                            html += renderQuestionNode(q, paper.defaults || {}, 0);
                        });
                    }
                });
            } else if (paper.questions) {
                paper.questions.forEach(q => {
                    html += renderQuestionNode(q, paper.defaults || {}, 0);
                });
            } else {
                html = '<div class="error-msg">No questions found in payload.</div>';
            }

            contentContainer.innerHTML = html;

            // Post-Render: KaTeX
            renderMathInElement(contentContainer, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false}
                ],
                throwOnError: false
            });

            // Re-bind listeners for toggles
            document.querySelectorAll('.disclosure-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const qId = btn.getAttribute('data-qid');
                    toggleSolution(qId, btn);
                });
            });

            // Build Navigation
            const navHtml = buildNavHtml(paper);
            navContainer.innerHTML = `<ul class="nav-list">${navHtml}</ul>`;
            drawerContainer.innerHTML = `<ul class="nav-list">${navHtml}</ul>`;

            // Setup Nav Links (Smooth Scroll)
            setupNavLinks();
        }

        // Recursive Question Renderer
        function renderQuestionNode(node, defaults, depth) {
            const idSafe = node.id.replace(/[^a-zA-Z0-9]/g, '_');
            const hasSolutionBlock = !!node.solutionBlock;
            const hasAnswer = hasSolutionBlock && !!node.solutionBlock.answer;
            const hasDetails = hasSolutionBlock && !!node.solutionBlock.solutionDetails;

            // Default expansion logic: if paper says expandedAll, default true.
            // But we track manual toggles in appData.expandedMap.
            let isExpanded = defaults.expandedAll !== false; // Default true unless explicitly false
            if (appData.expandedMap.hasOwnProperty(node.id)) {
                isExpanded = appData.expandedMap[node.id];
            }

            // Question Body
            let qHtml = `<div class="question-node" id="q-${idSafe}" data-depth="${depth}">`;
            
            // Header
            qHtml += `<div class="question-header">
                <span class="q-id">${node.id}</span>
                <div class="q-body md-content">${parseMarkdown(node.question)}</div>
            </div>`;

            // Solution Block
            if (hasSolutionBlock) {
                qHtml += `<div class="solution-block">`;
                
                // Answer
                if (hasAnswer) {
                    qHtml += `<div class="answer-region">
                        <span class="answer-label">Answer</span>
                        <span class="md-content inline-block">${parseMarkdown(node.solutionBlock.answer)}</span>
                    </div>`;
                }

                // Details Toggle & Region
                if (hasDetails) {
                    const btnLabel = isExpanded ? "Hide working" : "Show working";
                    const expandedAttr = isExpanded ? 'true' : 'false';
                    const displayStyle = isExpanded ? 'block' : 'none';
                    const expandedClass = isExpanded ? 'expanded' : '';

                    qHtml += `<button class="disclosure-btn" data-qid="${node.id}" aria-expanded="${expandedAttr}">
                        <span>${btnLabel}</span>
                        <svg class="disclosure-icon" width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2 4L6 8L10 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    </button>`;

                    qHtml += `<div class="solution-details ${expandedClass}" id="sol-${idSafe}" style="display:${displayStyle}">`;
                    
                    const sd = node.solutionBlock.solutionDetails;
                    
                    // Keep In Mind
                    if (sd.keepInMind) {
                        qHtml += `<div class="sd-section">
                            <span class="sd-label">Keep in mind</span>
                            <div class="md-content">${parseMarkdown(sd.keepInMind)}</div>
                        </div>`;
                    }
                    
                    // Formulas Used
                    if (sd.formulasUsed) {
                        qHtml += `<div class="sd-section">
                            <span class="sd-label">Formulas used</span>
                            <div class="md-content">${parseMarkdown(sd.formulasUsed)}</div>
                        </div>`;
                    }

                    // Working
                    if (sd.working) {
                        qHtml += `<div class="sd-section">
                            <span class="sd-label">Working</span>
                            <div class="md-content">${parseMarkdown(sd.working)}</div>
                        </div>`;
                    }

                    // Alternative Working(s)
                    if (sd.alternativeWorking && Array.isArray(sd.alternativeWorking)) {
                        sd.alternativeWorking.forEach((alt, idx) => {
                            qHtml += `<div class="alt-working-divider"></div>
                            <div class="sd-section">
                                <span class="sd-label">Alternative working</span>
                                <div class="md-content">${parseMarkdown(alt)}</div>
                            </div>`;
                        });
                    }

                    qHtml += `</div>`; // End details region
                }

                qHtml += `</div>`; // End solution block
            }

            // Children Recursion
            if (node.children && node.children.length > 0) {
                qHtml += `<div class="mt-4 pl-0">`; // Structure container
                node.children.forEach(child => {
                    qHtml += renderQuestionNode(child, defaults, depth + 1);
                });
                qHtml += `</div>`;
            }

            qHtml += `</div>`; // End node
            return qHtml;
        }

        function buildNavHtml(paper) {
            let nav = '';
            
            const renderItem = (q, isSub) => {
                const idSafe = q.id.replace(/[^a-zA-Z0-9]/g, '_');
                const subClass = isSub ? 'nav-item-sub' : '';
                return `<li class="nav-li">
                    <a href="#q-${idSafe}" class="nav-item ${subClass}" data-target="q-${idSafe}">${q.id}</a>
                </li>`;
            };

            const processList = (list) => {
                let html = '';
                list.forEach(q => {
                    html += renderItem(q, false); // Top level
                    if (q.children) {
                        // Flatten sub-children for nav list as per spec (flat list, type hierarchy)
                        const flatten = (children) => {
                            children.forEach(child => {
                                html += renderItem(child, true);
                                if (child.children) flatten(child.children);
                            });
                        };
                        flatten(q.children);
                    }
                });
                return html;
            };

            if (paper.sections) {
                paper.sections.forEach((sec, idx) => {
                    if (sec.label && sec.label.trim()) {
                        nav += `<li class="nav-section-label">${sec.label}</li>`;
                    } else if (idx > 0) {
                        // Spacer if no label but distinct section
                        nav += `<li class="py-2"></li>`;
                    }
                    if (sec.questions) nav += processList(sec.questions);
                });
            } else if (paper.questions) {
                nav += processList(paper.questions);
            }

            return nav;
        }

        // 4. Interactions & Utilities

        function parseMarkdown(text) {
            if (!text) return '';
            if (!md) return text; // Fallback
            return md.render(text);
        }

        function toggleSolution(qId, btnEl) {
            // Update State
            const isExpanded = btnEl.getAttribute('aria-expanded') === 'true';
            const newState = !isExpanded;
            appData.expandedMap[qId] = newState;

            // DOM Update (Performant)
            btnEl.setAttribute('aria-expanded', newState);
            btnEl.querySelector('span').textContent = newState ? "Hide working" : "Show working";
            
            const idSafe = qId.replace(/[^a-zA-Z0-9]/g, '_');
            const region = document.getElementById(`sol-${idSafe}`);
            if (region) {
                if (newState) {
                    region.style.display = 'block';
                    region.classList.add('expanded');
                } else {
                    region.style.display = 'none';
                    region.classList.remove('expanded');
                }
            }
        }

        function setupNavLinks() {
            const links = document.querySelectorAll('.nav-item');
            
            // Intersection Observer for Active State
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        // Remove active from all
                        document.querySelectorAll('.nav-item').forEach(l => l.classList.remove('active'));
                        // Add to current
                        const targetId = entry.target.id;
                        const activeLink = document.querySelector(`.nav-item[data-target="${targetId}"]`);
                        if (activeLink) activeLink.classList.add('active');
                    }
                });
            }, {
                root: null,
                rootMargin: '-20% 0px -60% 0px', // Bias towards top-center
                threshold: 0
            });

            document.querySelectorAll('.question-node').forEach(node => observer.observe(node));

            // Smooth Scroll Click
            links.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetId = link.getAttribute('data-target');
                    const target = document.getElementById(targetId);
                    if (target) {
                        target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        // Close drawer on mobile
                        toggleDrawer(false);
                    }
                });
            });
        }

        // Mobile Drawer Logic
        const drawer = document.getElementById('mobile-drawer');
        const overlay = document.getElementById('mobile-drawer-overlay');
        const jumpTrigger = document.getElementById('mobile-jump-trigger');
        const closeTrigger = document.getElementById('drawer-close');

        function toggleDrawer(open) {
            if (open) {
                drawer.classList.add('open');
                overlay.classList.add('open');
                document.body.style.overflow = 'hidden'; // Lock scroll
            } else {
                drawer.classList.remove('open');
                overlay.classList.remove('open');
                document.body.style.overflow = '';
            }
        }

        jumpTrigger.addEventListener('click', () => toggleDrawer(true));
        closeTrigger.addEventListener('click', () => toggleDrawer(false));
        overlay.addEventListener('click', () => toggleDrawer(false));

        // Start
        init();

    </script>
</body>
</html>
