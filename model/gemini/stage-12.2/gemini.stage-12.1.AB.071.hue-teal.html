<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AB","indexWithinVariant":"71","totalWithinVariant":"200","hueFamily":"teal","intensityMode":"","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-08T16:37:56.566Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AB&quot;,&quot;indexWithinVariant&quot;:&quot;71&quot;,&quot;totalWithinVariant&quot;:&quot;200&quot;,&quot;hueFamily&quot;:&quot;teal&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-08T16:37:56.566Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Viewer</title>
    
    <!-- Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS (Dev Mode) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        // Implementing ColorLab B: Teal Force
                        accent: {
                            50: '#f0fdfa',
                            100: '#ccfbf1',
                            200: '#99f6e4',
                            300: '#5eead4',
                            400: '#2dd4bf',
                            500: '#14b8a6',
                            600: '#0d9488',
                            700: '#0f766e',
                            800: '#115e59',
                            900: '#134e4a',
                        },
                        neutral: {
                            // Warm slate/stone hybrid for paper feel
                            50: '#f9fafb', // gray-50
                            100: '#f3f4f6',
                            200: '#e5e7eb',
                            300: '#d1d5db',
                            400: '#9ca3af',
                            500: '#6b7280',
                            600: '#4b5563',
                            700: '#374151',
                            800: '#1f2937',
                            900: '#111827',
                        }
                    }
                }
            }
        }
    </script>

    <!-- KaTeX -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Markdown-it -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Base / Reset */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb; /* neutral-50 */
            color: #111827; /* neutral-900 */
        }

        /* Math Containment & Scroll */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding-bottom: 0.5rem;
            -webkit-overflow-scrolling: touch;
            /* Scrollbar styling */
            scrollbar-width: thin;
            scrollbar-color: #cbd5e1 transparent;
        }
        .katex-display::-webkit-scrollbar {
            height: 4px;
        }
        .katex-display::-webkit-scrollbar-track {
            background: transparent;
        }
        .katex-display::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 2px;
        }

        /* Nav Scrollbar Hiding */
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* Focus Styles */
        :focus-visible {
            outline: 2px solid #0d9488; /* accent-600 */
            outline-offset: 2px;
        }

        /* Table Resets for Markdown */
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 0.75rem;
            margin-bottom: 0.75rem;
            font-size: 0.875rem;
        }
        th, td {
            border: 1px solid #e5e7eb; /* neutral-200 */
            padding: 0.5rem;
            text-align: left;
        }
        th {
            background-color: #f9fafb; /* neutral-50 */
            font-weight: 600;
        }
        
        /* Markdown Content Typography */
        .md-content p { margin-bottom: 0.75em; }
        .md-content p:last-child { margin-bottom: 0; }
        .md-content ul { list-style-type: disc; padding-left: 1.25em; margin-bottom: 0.75em; }
        .md-content ol { list-style-type: decimal; padding-left: 1.25em; margin-bottom: 0.75em; }
        /* Inline SVG passthrough sizing */
        .md-content svg { max-width: 100%; height: auto; display: block; margin: 1em 0; }
    </style>
</head>
<body>

    <div id="app" class="min-h-screen flex flex-col relative">
        <!-- JS will render content here -->
    </div>

    <script>
        // =================================================================
        // STAGE 0: CONSTANTS & CONFIG
        // =================================================================
        
        // Canonical Paths
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // ColorLab Config (Default)
        let RTQ_COLORLAB_FORCE_HUE_FAMILY = "teal";
        let RTQ_COLORLAB_INTENSITY_MODE = "standard";

        // Run Config Parsing (Simulated Check)
        // If a RUN_CONFIG block existed in input, we would parse it here.
        // For this generation, we use defaults.

        // =================================================================
        // STATE & INIT
        // =================================================================
        
        const state = {
            papers: [],
            currentPaperKey: null,
            expandedNodes: new Set(), // Set of question IDs where details are expanded
            mobileNavOpen: false,
            loading: true,
            error: false
        };

        // Markdown Renderer Init
        let md = null;
        if (window.markdownit) {
            md = window.markdownit({
                html: true,     // Allow inline SVG
                linkify: true,
                breaks: false   // Critical: Do not break KaTeX math
            });
            // Disable escape rule to preserve TeX backslashes
            md.inline.ruler.disable(['escape']);
        }

        // =================================================================
        // DATA LOADING
        // =================================================================

        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Payload not found");
                
                const data = await response.json();
                state.papers = data.papers || [];
                
                if (state.papers.length > 0) {
                    // Load first paper by default
                    selectPaper(state.papers[0].key);
                } else {
                    state.error = true;
                }
            } catch (err) {
                console.error(err);
                state.error = true;
            } finally {
                state.loading = false;
                renderApp();
            }
        }

        function selectPaper(key) {
            const paper = state.papers.find(p => p.key === key);
            if (!paper) return;
            
            state.currentPaperKey = key;
            state.expandedNodes.clear();
            
            // Handle defaults (e.g. expand all)
            const expandAll = paper.defaults?.expandedAll !== false; // Default to true if not specified as false? 
            // Brief says: "Solution Details are expanded by default when present (unless a paperâ€™s defaults explicitly set expandedAll=false)."
            
            if (expandAll) {
                // We need to walk the tree to find IDs to add to expandedNodes, 
                // OR we just treat "missing from Set" as expanded if default is true?
                // To be robust, let's treat the Set as "overrides" or "current state".
                // Easier: Just initialize the set with everything if we can traverse, or use a "isExpanded(id)" helper.
                // Helper approach: isExpanded(id) checks state.expandedNodes.has(id).
                // If default is expanded, we might need a "collapsedNodes" set instead?
                // Let's stick to: "state.expandedNodes" contains IDs of OPEN details.
                // We will populate it recursively.
                const nodesToExpand = [];
                const traverse = (nodes) => {
                    nodes.forEach(n => {
                        if (n.solutionBlock?.solutionDetails) nodesToExpand.push(n.id);
                        if (n.children) traverse(n.children);
                    });
                };
                
                const rootItems = paper.questions || paper.sections?.flatMap(s => s.questions) || [];
                traverse(rootItems);
                nodesToExpand.forEach(id => state.expandedNodes.add(id));
            }
            
            state.mobileNavOpen = false;
            renderApp();
            
            // Scroll to top
            window.scrollTo(0, 0);
        }

        function toggleDetails(id) {
            if (state.expandedNodes.has(id)) {
                state.expandedNodes.delete(id);
            } else {
                state.expandedNodes.add(id);
            }
            
            // Re-render specific node or whole app? 
            // Whole app is safer for prototype to ensure consistency, though less performant.
            // Given constraints, full re-render is fine.
            // Preserving scroll is handled by browser usually if DOM diff isn't too huge, 
            // but vanilla replacement might jump. 
            // Better: Find the DOM element and update it, OR re-render and restore scroll.
            // Let's try full re-render first. 
            const scrollY = window.scrollY;
            renderApp();
            window.scrollTo(0, scrollY);
        }

        function toggleMobileNav() {
            state.mobileNavOpen = !state.mobileNavOpen;
            renderApp();
        }

        // =================================================================
        // RENDERING
        // =================================================================

        const app = document.getElementById('app');

        function renderApp() {
            if (state.error) {
                app.innerHTML = `
                    <div class="flex items-center justify-center min-h-screen">
                        <h1 class="text-xl font-semibold text-neutral-500 tracking-wide">PAPERS PAYLOAD MISSING</h1>
                    </div>
                `;
                return;
            }

            if (state.loading) {
                app.innerHTML = `
                    <div class="flex items-center justify-center min-h-screen">
                        <div class="animate-pulse text-neutral-400">Loading...</div>
                    </div>
                `;
                return;
            }

            const currentPaper = state.papers.find(p => p.key === state.currentPaperKey);
            if (!currentPaper) return;

            // Structure: 
            // Top Bar
            // Shell -> Nav + Content
            // Mobile Drawer

            const topBarHTML = renderTopControls(currentPaper);
            const navRailHTML = renderDesktopNav(currentPaper);
            const contentHTML = renderPaperContent(currentPaper);
            const mobileDrawerHTML = state.mobileNavOpen ? renderMobileDrawer(currentPaper) : '';

            app.innerHTML = `
                ${topBarHTML}
                
                <div class="flex-1 w-full max-w-7xl mx-auto px-4 md:px-6 lg:px-8 py-6 md:py-8 lg:py-10 flex items-start gap-8 lg:gap-12 relative">
                    ${navRailHTML}
                    <main class="flex-1 min-w-0" role="main">
                        ${contentHTML}
                    </main>
                </div>

                ${mobileDrawerHTML}
            `;

            // Post-render: Initialize Icons and Math
            lucide.createIcons();
            renderMathInElement(document.body, {
                delimiters: [
                    {left: "$$", right: "$$", display: true},
                    {left: "$", right: "$", display: false}
                ],
                throwOnError: false,
                trust: true // Trust HTML in math if needed, though strictly we use sanitized markdown output
            });
        }

        // --- Top Controls ---
        function renderTopControls(currentPaper) {
            const options = state.papers.map(p => 
                `<option value="${p.key}" ${p.key === state.currentPaperKey ? 'selected' : ''}>${p.label}</option>`
            ).join('');

            return `
                <header class="sticky top-0 z-40 bg-white/90 backdrop-blur-sm border-b border-neutral-200 supports-[backdrop-filter]:bg-white/60">
                    <div class="max-w-7xl mx-auto px-4 md:px-6 lg:px-8 h-14 flex items-center justify-between">
                        
                        <!-- Paper Selector -->
                        <div class="flex items-center gap-3">
                            <label for="paper-select" class="sr-only">Select Paper</label>
                            <div class="relative">
                                <select id="paper-select" onchange="selectPaper(this.value)" 
                                    class="appearance-none bg-neutral-100 hover:bg-neutral-200 transition-colors pl-3 pr-8 py-1.5 rounded-md text-sm font-medium text-neutral-700 focus:ring-2 focus:ring-accent-500 focus:outline-none cursor-pointer border-transparent">
                                    ${options}
                                </select>
                                <i data-lucide="chevron-down" class="absolute right-2 top-1/2 -translate-y-1/2 w-4 h-4 text-neutral-500 pointer-events-none"></i>
                            </div>
                        </div>

                        <!-- Mobile Jump To Trigger -->
                        <button onclick="toggleMobileNav()" class="lg:hidden flex items-center gap-2 text-sm font-medium text-accent-700 hover:text-accent-800 px-2 py-1.5 rounded-md hover:bg-accent-50 transition-colors">
                            <span>Jump to</span>
                            <i data-lucide="menu" class="w-4 h-4"></i>
                        </button>

                    </div>
                </header>
            `;
        }

        // --- Navigation ---
        function getNavItems(paper) {
            // Flatten the structure for the list
            // If sections exist: [{type: 'section', label: 'A'}, {type: 'q', id: '1'}, ...]
            const items = [];
            
            if (paper.sections) {
                paper.sections.forEach(sec => {
                    if (sec.label && sec.label.trim().length > 0) {
                        items.push({ type: 'section', label: sec.label });
                    }
                    sec.questions.forEach(q => traverseNav(q, items));
                });
            } else if (paper.questions) {
                paper.questions.forEach(q => traverseNav(q, items));
            }
            return items;
        }

        function traverseNav(node, list) {
            list.push({ type: 'question', id: node.id, depth: 0 }); // Depth 0 for flat list logic, purely for type scale if needed later
            if (node.children) {
                node.children.forEach(c => traverseNav(c, list));
            }
        }

        function renderNavList(items, isMobile = false) {
            return items.map(item => {
                if (item.type === 'section') {
                    return `
                        <div class="mt-4 mb-2 first:mt-0 px-2 text-xs font-semibold text-neutral-400 uppercase tracking-wider select-none">
                            ${item.label}
                        </div>
                    `;
                } else {
                    // Question Item
                    // Check if deep nested (heuristic: id length or contains brackets?) 
                    // Brief says: "Hierarchy is expressed only via typographic scale/quietness... same left edge"
                    // We'll treat all as flat but maybe slightly smaller font for long IDs if needed? 
                    // Actually, brief says "sub-questions are quieter/smaller".
                    // Since we don't have explicit depth in the flattened list from the traversal above (I set 0), 
                    // let's infer 'sub' status if it looks like a sub-question (e.g. parens).
                    // Or better, let's keep it simple: Base style.
                    
                    const isSub = item.id.includes('(') || item.id.match(/[a-z]/); 
                    const baseClass = "block w-full text-left px-2 py-1 rounded transition-colors";
                    const activeClass = "font-bold text-accent-700";
                    const inactiveClass = isSub ? "text-neutral-500 font-normal hover:text-neutral-900" : "text-neutral-600 font-medium hover:text-neutral-900";
                    
                    // Simple hash anchor
                    return `
                        <a href="#q-${item.id}" onclick="${isMobile ? 'toggleMobileNav()' : ''}" class="${baseClass} ${inactiveClass} text-sm">
                            ${item.id}
                        </a>
                    `;
                }
            }).join('');
        }

        function renderDesktopNav(paper) {
            const items = getNavItems(paper);
            return `
                <aside class="hidden lg:block w-48 shrink-0 sticky top-24 h-[calc(100vh-8rem)] overflow-y-auto no-scrollbar pb-10">
                    <nav aria-label="Paper navigation" class="space-y-0.5">
                        ${renderNavList(items)}
                    </nav>
                </aside>
            `;
        }

        function renderMobileDrawer(paper) {
            const items = getNavItems(paper);
            return `
                <div class="fixed inset-0 z-50 lg:hidden" role="dialog" aria-modal="true">
                    <!-- Backdrop -->
                    <div class="fixed inset-0 bg-neutral-900/20 backdrop-blur-sm" onclick="toggleMobileNav()"></div>
                    
                    <!-- Drawer -->
                    <div class="fixed inset-y-0 right-0 w-64 bg-white shadow-xl flex flex-col transform transition-transform duration-300 ease-out">
                        <div class="flex items-center justify-between px-4 h-14 border-b border-neutral-100">
                            <span class="font-semibold text-neutral-900">Jump to</span>
                            <button onclick="toggleMobileNav()" class="p-2 -mr-2 text-neutral-500 hover:text-neutral-900">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                        <div class="flex-1 overflow-y-auto p-4">
                            <nav class="space-y-1">
                                ${renderNavList(items, true)}
                            </nav>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- Paper Content ---
        function renderPaperContent(paper) {
            let html = '';
            
            // Sections or Flat Questions?
            if (paper.sections) {
                html += paper.sections.map(sec => `
                    <section class="mb-12">
                        ${sec.label && sec.label.trim() ? `
                            <div class="mb-8 pb-2 border-b border-neutral-200">
                                <h2 class="text-lg font-bold text-neutral-900">${sec.label}</h2>
                            </div>
                        ` : ''}
                        <div class="space-y-16"> <!-- Top level gap -->
                            ${sec.questions.map(q => renderQuestionNode(q, 0)).join('')}
                        </div>
                    </section>
                `).join('');
            } else if (paper.questions) {
                html += `
                    <div class="space-y-16">
                        ${paper.questions.map(q => renderQuestionNode(q, 0)).join('')}
                    </div>
                `;
            }
            return html;
        }

        function renderQuestionNode(node, depth) {
            // Render MD
            const qBody = md ? md.render(node.question) : node.question;
            const hasSolutionBlock = !!node.solutionBlock;
            const hasAnswer = hasSolutionBlock && !!node.solutionBlock.answer;
            const hasDetails = hasSolutionBlock && !!node.solutionBlock.solutionDetails;
            const isExpanded = state.expandedNodes.has(node.id);

            // Spacing for Children
            // Parent -> Children spacing is strong but weaker than top-level (which is 16/4rem)
            // Let's use space-y-8 for children container
            
            // Indentation
            // Stage 3 permits optional indentation. 
            // Depth > 0 gets padding-left. Adapts to viewport.
            const indentClass = depth > 0 ? 'pl-4 md:pl-8 border-l-2 border-transparent hover:border-neutral-100 transition-colors' : '';

            // Child rendering
            const childrenHTML = node.children && node.children.length > 0 
                ? `<div class="mt-8 space-y-8">
                    ${node.children.map(c => renderQuestionNode(c, depth + 1)).join('')}
                   </div>` 
                : '';

            // Solution Block HTML
            let solutionBlockHTML = '';
            if (hasSolutionBlock) {
                // Answer
                let answerHTML = '';
                if (hasAnswer) {
                    const ansBody = md ? md.render(node.solutionBlock.answer) : node.solutionBlock.answer;
                    answerHTML = `
                        <div class="mb-4">
                            <span class="block text-xs font-bold text-neutral-500 uppercase tracking-wide mb-1">Answer</span>
                            <div class="text-neutral-800 font-medium md-content">${ansBody}</div>
                        </div>
                    `;
                }

                // Details Toggle & Region
                let detailsHTML = '';
                if (hasDetails) {
                    const label = isExpanded ? "Hide working" : "Show working";
                    const icon = isExpanded ? "chevron-up" : "chevron-down";
                    
                    // Toggle Control
                    const toggleControl = `
                        <button onclick="toggleDetails('${node.id}')" 
                            class="group inline-flex items-center gap-1.5 text-sm font-medium text-accent-600 hover:text-accent-800 transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-accent-500 rounded-sm">
                            <span>${label}</span>
                            <i data-lucide="${icon}" class="w-4 h-4 transition-transform group-hover:translate-y-px"></i>
                        </button>
                    `;

                    // Expanded Content
                    let expandedContent = '';
                    if (isExpanded) {
                        const details = node.solutionBlock.solutionDetails;
                        
                        // Keep in Mind
                        if (details.keepInMind) {
                            expandedContent += `
                                <div class="mb-6">
                                    <h4 class="text-sm font-bold text-neutral-700 mb-2 flex items-center gap-2">
                                        <i data-lucide="lightbulb" class="w-4 h-4 text-neutral-400"></i>
                                        Keep in mind
                                    </h4>
                                    <div class="text-sm text-neutral-600 md-content">${md.render(details.keepInMind)}</div>
                                </div>
                            `;
                        }

                        // Formulas Used
                        if (details.formulasUsed) {
                            expandedContent += `
                                <div class="mb-6">
                                    <h4 class="text-sm font-bold text-neutral-700 mb-2">Formulas used</h4>
                                    <div class="text-sm text-neutral-600 md-content">${md.render(details.formulasUsed)}</div>
                                </div>
                            `;
                        }

                        // Working
                        if (details.working) {
                            expandedContent += `
                                <div class="mb-6">
                                    <h4 class="text-sm font-bold text-neutral-700 mb-2">Working</h4>
                                    <div class="text-neutral-700 md-content space-y-4">${md.render(details.working)}</div>
                                </div>
                            `;
                        }

                        // Alt Working
                        if (details.alternativeWorking && Array.isArray(details.alternativeWorking)) {
                            details.alternativeWorking.forEach((alt, idx) => {
                                expandedContent += `
                                    <div class="mt-8 pt-6 border-t border-neutral-200/60">
                                        <h4 class="text-sm font-bold text-neutral-700 mb-2">Alternative working</h4>
                                        <div class="text-neutral-700 md-content space-y-4">${md.render(alt)}</div>
                                    </div>
                                `;
                            });
                        }

                        // Wrap details region
                        // Stage 3 permits very subtle background wash for details region
                        expandedContent = `
                            <div class="mt-4 pt-4 pb-1 pl-4 border-l border-neutral-200 bg-neutral-50/50 rounded-r-sm">
                                ${expandedContent}
                            </div>
                        `;
                    }

                    detailsHTML = `
                        <div class="mt-3">
                            ${toggleControl}
                            ${expandedContent}
                        </div>
                    `;
                }

                // Separator Question -> Solution
                // Using spacing primarily (mt-6 from question to solution block wrapper)
                solutionBlockHTML = `
                    <div class="mt-6">
                        ${answerHTML}
                        ${detailsHTML}
                    </div>
                `;
            }

            return `
                <div id="q-${node.id}" class="group/node ${indentClass}">
                    <!-- Question Body -->
                    <div class="relative">
                        <!-- ID + Prompt Wrapper -->
                        <div class="flex gap-4">
                            <!-- ID -->
                            <div class="shrink-0 w-8 md:w-12 pt-0.5">
                                <span class="text-sm font-semibold text-neutral-500 select-none">${node.id}</span>
                            </div>
                            <!-- Prompt -->
                            <div class="flex-1 min-w-0">
                                <div class="text-base md:text-lg text-neutral-900 leading-relaxed md-content font-medium">
                                    ${qBody}
                                </div>
                                ${solutionBlockHTML}
                            </div>
                        </div>
                    </div>
                    <!-- Children -->
                    ${childrenHTML}
                </div>
            `;
        }

        // =================================================================
        // BOOT
        // =================================================================
        
        window.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
