<!DOCTYPE html>
<html lang="en" class="light">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AB","indexWithinVariant":"32","totalWithinVariant":"200","hueFamily":"pink","intensityMode":"","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-08T14:51:58.783Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AB&quot;,&quot;indexWithinVariant&quot;:&quot;32&quot;,&quot;totalWithinVariant&quot;:&quot;200&quot;,&quot;hueFamily&quot;:&quot;pink&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-08T14:51:58.783Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>

    <!-- 
      STAGE 0: CONSTANTS 
      This is the single source of truth for the payload path.
    -->
    <script>
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json"; // Reference only
        
        // STAGE 6 ADD-ON: COLORLAB B
        // Parameter defaults
        const DEFAULT_HUE = "pink";
        
        // Simple Run Config Parser
        // (In a real scenario, we'd parse the user message, but here we hardcode the logic to check if a block existed)
        // Since no block was passed in context, we use the default.
        const COLORLAB_HUE = DEFAULT_HUE;
    </script>

    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- KaTeX CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <!-- Markdown-it -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <!-- KaTeX JS & Auto-render -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        // ColorLab B - Pink Configuration
        // We define a warm neutral palette tinted slightly with the hue, plus the hue for accents.
        tailwind.config = {
            darkMode: 'class', // Forced light mode per instructions
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    colors: {
                        // Semantic mapping for "Pink" ColorLab
                        border: "hsl(var(--border))",
                        input: "hsl(var(--input))",
                        ring: "hsl(var(--ring))",
                        background: "hsl(var(--background))",
                        foreground: "hsl(var(--foreground))",
                        primary: {
                            DEFAULT: "hsl(var(--primary))",
                            foreground: "hsl(var(--primary-foreground))",
                        },
                        secondary: {
                            DEFAULT: "hsl(var(--secondary))",
                            foreground: "hsl(var(--secondary-foreground))",
                        },
                        muted: {
                            DEFAULT: "hsl(var(--muted))",
                            foreground: "hsl(var(--muted-foreground))",
                        },
                        accent: {
                            DEFAULT: "hsl(var(--accent))",
                            foreground: "hsl(var(--accent-foreground))",
                        },
                    }
                }
            }
        }
    </script>

    <style>
        /* CSS Variables for ColorLab B (Pink Theme - Light Mode Only) */
        :root {
            /* Warm/Rose-tinted neutrals for background */
            --background: 0 0% 100%; /* Pure white */
            --foreground: 330 5% 10%; /* Dark warm gray */

            /* Pink Accents */
            --primary: 330 81% 60%; /* Pink-500/600ish */
            --primary-foreground: 0 0% 100%;

            /* Muted / Surface differentiation */
            --muted: 330 20% 96%; /* Very pale pink/gray wash */
            --muted-foreground: 330 5% 40%;

            --accent: 330 81% 94%; /* Light pink highlight for interactive states */
            --accent-foreground: 330 81% 40%;

            --border: 330 10% 90%;
            --input: 330 10% 90%;
            --ring: 330 81% 60%;
            
            /* Typography specific */
            --text-question: 330 5% 10%;
            --text-body: 330 5% 20%;
            --text-subtle: 330 5% 50%;
        }

        /* Base Typography & Reset */
        body {
            @apply bg-background text-foreground antialiased font-sans;
            /* Subtly warm base */
            background-color: #fdfcfd; 
        }

        /* 
           KaTeX Containment Invariant 
           Never allow page-level horizontal scroll.
           Overflow scroll ONLY inside math blocks.
        */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding: 0.5em 0;
            /* Scrollbar hiding for cleaner look */
            scrollbar-width: thin;
            scrollbar-color: hsl(var(--border)) transparent;
        }
        
        /* Inline KaTeX background rule: Transparent only */
        .katex {
            background-color: transparent !important;
        }

        /* Hide scrollbars for Nav but keep functionality */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Layout & Spacing */
        .layout-shell {
            @apply max-w-7xl mx-auto px-4 sm:px-6 lg:px-8;
        }

        /* Focus States */
        :focus-visible {
            @apply outline-none ring-2 ring-primary ring-offset-2;
        }

        /* Tables in Markdown */
        table {
            @apply w-full border-collapse my-4 text-sm;
        }
        th {
            @apply border-b border-border font-semibold text-left p-2 text-muted-foreground;
        }
        td {
            @apply border-b border-border p-2 text-foreground;
        }
        /* Mobile table scroll wrapper handled in renderer */

        /* Smooth scrolling for anchor jumps */
        html {
            scroll-behavior: smooth;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Top Controls Region -->
    <header class="sticky top-0 z-40 w-full border-b border-border bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60">
        <div class="layout-shell flex h-14 items-center gap-4">
            <!-- Mobile Menu Trigger -->
            <button id="mobile-menu-trigger" class="lg:hidden p-2 -ml-2 hover:bg-muted rounded-md text-muted-foreground" aria-label="Jump to question">
                <i data-lucide="menu" class="w-5 h-5"></i>
            </button>
            
            <div class="flex-1 flex items-center gap-4">
                <span class="font-semibold text-foreground hidden sm:inline-block">RTQ Paper Viewer</span>
                
                <!-- Paper Selector -->
                <select id="paper-selector" class="h-9 w-[200px] rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50" aria-label="Select paper">
                    <option value="" disabled selected>Loading papers...</option>
                </select>
            </div>
            
            <!-- Mobile "Jump to" label proxy (visual only, trigger is the menu button/bar) -->
            <button id="mobile-jump-text" class="lg:hidden text-sm font-medium text-primary" onclick="document.getElementById('mobile-menu-trigger').click()">
                Jump to
            </button>
        </div>
    </header>

    <!-- DocumentFrameShell -->
    <div class="flex-1 layout-shell flex gap-8 py-8 relative">
        
        <!-- Desktop Navigation Rail (Left Column) -->
        <aside class="hidden lg:block w-64 flex-shrink-0">
            <div class="sticky top-24 max-h-[calc(100vh-8rem)] overflow-y-auto no-scrollbar py-2">
                <nav id="desktop-nav" class="flex flex-col space-y-1" aria-label="Paper navigation">
                    <!-- Nav items injected here -->
                </nav>
            </div>
        </aside>

        <!-- Paper Document Column (Right/Main Column) -->
        <main id="paper-content" class="flex-1 min-w-0 pb-24">
            <!-- Content injected here -->
            <div class="flex items-center justify-center h-64 text-muted-foreground">
                Loading content...
            </div>
        </main>
    </div>

    <!-- Mobile Navigation Drawer -->
    <div id="mobile-drawer-backdrop" class="fixed inset-0 z-50 bg-black/40 hidden transition-opacity opacity-0" aria-hidden="true"></div>
    <div id="mobile-drawer" class="fixed inset-y-0 left-0 z-50 w-3/4 max-w-xs bg-background shadow-lg transform -translate-x-full transition-transform duration-200 ease-in-out flex flex-col" aria-modal="true" role="dialog">
        <div class="p-4 border-b border-border flex items-center justify-between">
            <h2 class="font-semibold text-lg">Jump to</h2>
            <button id="close-drawer" class="p-2 -mr-2 hover:bg-muted rounded-md">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>
        <div class="flex-1 overflow-y-auto p-4">
            <nav id="mobile-nav" class="space-y-1">
                <!-- Nav items injected here -->
            </nav>
        </div>
    </div>

    <!-- App Logic -->
    <script>
        // --- State ---
        const state = {
            papers: [],
            activePaper: null,
            expandedWorkings: {}, // Map<QuestionID, Boolean>
            navOpen: false
        };

        // --- Elements ---
        const els = {
            selector: document.getElementById('paper-selector'),
            content: document.getElementById('paper-content'),
            desktopNav: document.getElementById('desktop-nav'),
            mobileNav: document.getElementById('mobile-nav'),
            drawer: document.getElementById('mobile-drawer'),
            backdrop: document.getElementById('mobile-drawer-backdrop'),
            drawerTrigger: document.getElementById('mobile-menu-trigger'),
            drawerClose: document.getElementById('close-drawer'),
        };

        // --- Markdown Renderer Setup (Authoritative) ---
        const md = window.markdownit ? window.markdownit({
            html: true,
            linkify: true,
            breaks: false // MUST be false for KaTeX
        }) : null;
        
        if (md) {
            md.inline.ruler.disable(['escape']); // Preserve TeX backslashes
        }

        // --- Fetch & Init ---
        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Fetch failed");
                
                const payload = await response.json();
                state.papers = payload.papers || [];

                if (state.papers.length === 0) throw new Error("No papers found");

                renderSelector();
                
                // Select first paper by default
                loadPaper(state.papers[0].key);

            } catch (error) {
                console.error(error);
                renderError();
            }
        }

        function renderError() {
            els.content.innerHTML = `
                <div class="flex flex-col items-center justify-center py-12 text-center">
                    <div class="text-xl font-bold text-red-600 mb-2">PAPERS PAYLOAD MISSING</div>
                    <p class="text-muted-foreground">Could not load content from ${RTQ_PAPERS_PAYLOAD_PATH}</p>
                </div>
            `;
            els.selector.innerHTML = `<option>Error loading payload</option>`;
            els.selector.disabled = true;
        }

        function renderSelector() {
            els.selector.innerHTML = state.papers.map(p => 
                `<option value="${p.key}">${p.label}</option>`
            ).join('');
            
            els.selector.addEventListener('change', (e) => {
                loadPaper(e.target.value);
            });
        }

        function loadPaper(paperKey) {
            const paper = state.papers.find(p => p.key === paperKey);
            if (!paper) return;

            state.activePaper = paper;
            
            // Reset expanded states based on defaults
            state.expandedWorkings = {};
            const defaultExpand = paper.defaults?.expandedAll !== false; 
            // We'll populate this map lazily or assume default if not set
            
            renderContent(paper);
            renderNavigation(paper);
            
            // Re-run Lucide icons
            lucide.createIcons();
            
            // Auto-render KaTeX
            renderMathInElement(document.body, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false},
                    {left: '\\(', right: '\\)', display: false},
                    {left: '\\[', right: '\\]', display: true}
                ],
                throwOnError: false,
                output: 'html' // faster
            });

            // Reset Scroll
            window.scrollTo(0,0);
        }

        // --- Content Rendering ---

        function renderContent(paper) {
            let html = '';

            // Handle "Questions List" vs "Sections"
            if (paper.sections) {
                paper.sections.forEach(section => {
                    // Optional Section Header
                    if (section.label && section.label.trim().length > 0) {
                        html += `
                            <div class="mb-6 pt-4 border-b border-border pb-2">
                                <h2 class="text-lg font-bold text-muted-foreground" id="section-${section.label}">${section.label}</h2>
                            </div>
                        `;
                    }
                    html += `<div class="space-y-12">`; // Top-level spacing
                    section.questions.forEach(q => {
                        html += renderQuestionNode(q, 0);
                    });
                    html += `</div>`;
                    html += `<div class="h-12"></div>`; // Spacing between sections
                });
            } else if (paper.questions) {
                html += `<div class="space-y-12">`;
                paper.questions.forEach(q => {
                    html += renderQuestionNode(q, 0);
                });
                html += `</div>`;
            } else {
                html = `<p class="text-muted-foreground">No questions found.</p>`;
            }

            els.content.innerHTML = html;
            
            // Attach event listeners for toggles
            document.querySelectorAll('.toggle-working-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.currentTarget.dataset.id;
                    toggleWorking(id);
                });
            });
        }

        // Recursive Question Renderer
        function renderQuestionNode(node, depth) {
            const isTopLevel = depth === 0;
            const paddingClass = depth > 0 ? 'pl-4 sm:pl-8 border-l-2 border-transparent hover:border-border/50 transition-colors' : '';
            
            // Check for children
            const hasChildren = node.children && node.children.length > 0;
            
            // Solution Block logic
            const sb = node.solutionBlock;
            const hasAnswer = sb && sb.answer;
            const hasDetails = sb && sb.solutionDetails;
            
            // Determine expanded state
            const isExpanded = state.expandedWorkings[node.id] !== undefined 
                ? state.expandedWorkings[node.id] 
                : (state.activePaper.defaults?.expandedAll !== false);

            // Generate HTML
            let html = `
                <div class="group relative ${paddingClass} py-2" id="q-${node.id}">
                    <!-- Question Body -->
                    <div class="mb-3">
                        <div class="flex items-baseline gap-3">
                            <span class="font-bold text-muted-foreground text-sm select-none flex-shrink-0 w-8 md:w-10 text-right -ml-10 md:-ml-12 absolute hidden md:block">${node.id}</span>
                            <span class="font-bold text-muted-foreground text-sm select-none mr-2 md:hidden">${node.id}</span>
                            <div class="prose prose-neutral prose-p:my-1 max-w-none text-foreground leading-relaxed">
                                ${md ? md.render(node.question || '') : node.question}
                            </div>
                        </div>
                    </div>
            `;

            // Solution Block
            if (sb) {
                html += `<div class="mt-4 ml-0 md:ml-0 space-y-3">`;

                // Answer
                if (hasAnswer) {
                    html += `
                        <div class="flex flex-col sm:flex-row sm:items-baseline gap-2 sm:gap-4">
                            <span class="text-xs font-bold text-muted-foreground uppercase tracking-wider select-none shrink-0">Answer</span>
                            <div class="prose prose-neutral prose-sm max-w-none font-medium text-foreground bg-muted/30 px-3 py-1.5 rounded-sm">
                                ${md ? md.render(sb.answer) : sb.answer}
                            </div>
                        </div>
                    `;
                }

                // Solution Details Toggle & Region
                if (hasDetails) {
                    html += `
                        <div class="mt-3">
                            <button 
                                class="toggle-working-btn flex items-center gap-2 text-sm font-medium text-primary hover:text-primary/80 transition-colors focus-visible:ring-offset-0"
                                data-id="${node.id}"
                                aria-expanded="${isExpanded}"
                                aria-controls="working-${node.id}"
                            >
                                <span class="select-none">${isExpanded ? 'Hide working' : 'Show working'}</span>
                                <i data-lucide="${isExpanded ? 'chevron-up' : 'chevron-down'}" class="w-4 h-4"></i>
                            </button>

                            <div id="working-${node.id}" class="${isExpanded ? 'block' : 'hidden'} mt-3 pl-0 sm:pl-4 border-l-2 border-primary/20 animate-in fade-in slide-in-from-top-1 duration-200">
                                <div class="space-y-6 py-2">
                                    ${renderSolutionDetails(sb.solutionDetails)}
                                </div>
                            </div>
                        </div>
                    `;
                }

                html += `</div>`; // End Solution Block Wrapper
            }

            // Render Children (Recursive)
            if (hasChildren) {
                html += `<div class="mt-4 space-y-4">`;
                node.children.forEach(child => {
                    html += renderQuestionNode(child, depth + 1);
                });
                html += `</div>`;
            }

            html += `</div>`; // End Question Node
            return html;
        }

        function renderSolutionDetails(details) {
            let html = '';
            
            // Order: Keep in mind -> Formulas -> Working -> Alternative

            // 1. Keep in mind
            if (details.keepInMind) {
                html += `
                    <div class="space-y-1 text-sm">
                        <div class="font-bold text-accent-foreground flex items-center gap-2">
                            <i data-lucide="lightbulb" class="w-3 h-3"></i> Keep in mind
                        </div>
                        <div class="prose prose-sm prose-neutral max-w-none text-muted-foreground">
                            ${md ? md.render(details.keepInMind) : details.keepInMind}
                        </div>
                    </div>
                `;
            }

            // 2. Formulas used
            if (details.formulasUsed) {
                html += `
                    <div class="space-y-1 text-sm">
                        <div class="font-bold text-muted-foreground">Formulas used</div>
                        <div class="prose prose-sm prose-neutral max-w-none text-muted-foreground">
                            ${md ? md.render(details.formulasUsed) : details.formulasUsed}
                        </div>
                    </div>
                `;
            }

            // 3. Working (Primary)
            if (details.working) {
                html += `
                    <div class="space-y-2">
                        <div class="font-bold text-xs uppercase tracking-wider text-muted-foreground border-b border-border/50 pb-1 w-max">Working</div>
                        <div class="prose prose-neutral max-w-none text-foreground/90 working-content">
                            ${md ? md.render(details.working) : details.working}
                        </div>
                    </div>
                `;
            }

            // 4. Alternative Working
            if (details.alternativeWorking && Array.isArray(details.alternativeWorking)) {
                details.alternativeWorking.forEach((alt, idx) => {
                    html += `
                        <div class="mt-6 pt-4 border-t border-border/40 space-y-2">
                            <div class="font-bold text-xs uppercase tracking-wider text-muted-foreground">Alternative working ${idx > 0 ? idx + 1 : ''}</div>
                            <div class="prose prose-neutral max-w-none text-foreground/90 working-content">
                                ${md ? md.render(alt) : alt}
                            </div>
                        </div>
                    `;
                });
            } else if (details.alternativeWorking) {
                // Fallback for string
                html += `
                    <div class="mt-6 pt-4 border-t border-border/40 space-y-2">
                        <div class="font-bold text-xs uppercase tracking-wider text-muted-foreground">Alternative working</div>
                        <div class="prose prose-neutral max-w-none text-foreground/90 working-content">
                            ${md ? md.render(details.alternativeWorking) : details.alternativeWorking}
                        </div>
                    </div>
                `;
            }

            return html;
        }

        function toggleWorking(id) {
            const current = state.expandedWorkings[id] !== undefined 
                ? state.expandedWorkings[id] 
                : (state.activePaper.defaults?.expandedAll !== false);
            
            state.expandedWorkings[id] = !current;
            
            // Re-render whole list is expensive but robust for prototype. 
            // Better: update DOM node.
            const container = document.getElementById(`working-${id}`);
            const btn = document.querySelector(`button[data-id="${id}"]`);
            const btnText = btn.querySelector('span');
            const btnIcon = btn.querySelector('i');
            
            if (state.expandedWorkings[id]) {
                container.classList.remove('hidden');
                container.classList.add('block');
                btn.setAttribute('aria-expanded', 'true');
                btnText.textContent = 'Hide working';
                btnIcon.setAttribute('data-lucide', 'chevron-up');
            } else {
                container.classList.add('hidden');
                container.classList.remove('block');
                btn.setAttribute('aria-expanded', 'false');
                btnText.textContent = 'Show working';
                btnIcon.setAttribute('data-lucide', 'chevron-down');
            }
            lucide.createIcons();
        }

        // --- Navigation Rendering ---

        function renderNavigation(paper) {
            const items = [];
            
            // Helper to traverse and build flat list with depth metadata
            function traverse(nodes, depth) {
                nodes.forEach(node => {
                    items.push({ id: node.id, depth, type: 'item' });
                    if (node.children) traverse(node.children, depth + 1);
                });
            }

            if (paper.sections) {
                paper.sections.forEach(section => {
                    if (section.label) items.push({ label: section.label, type: 'section' });
                    traverse(section.questions, 0);
                });
            } else if (paper.questions) {
                traverse(paper.questions, 0);
            }

            const buildNavHTML = (isMobile) => {
                return items.map(item => {
                    if (item.type === 'section') {
                        return `
                            <div class="mt-4 mb-2 px-2 text-xs font-bold text-muted-foreground uppercase tracking-wider select-none">
                                Section ${item.label}
                            </div>
                        `;
                    }
                    // Item
                    // Visual hierarchy via opacity/size, not indent
                    const fontSize = item.depth === 0 ? 'text-sm' : 'text-xs';
                    const weight = item.depth === 0 ? 'font-medium' : 'font-normal';
                    const opacity = item.depth === 0 ? 'text-foreground' : 'text-muted-foreground';
                    
                    return `
                        <a href="#q-${item.id}" 
                           class="block px-2 py-1.5 rounded-md hover:bg-muted ${fontSize} ${weight} ${opacity} transition-colors focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-inset nav-link"
                           onclick="handleNavClick(event, '${item.id}')"
                        >
                            ${item.id}
                        </a>
                    `;
                }).join('');
            };

            els.desktopNav.innerHTML = buildNavHTML(false);
            els.mobileNav.innerHTML = buildNavHTML(true);

            // Intersection Observer for Active State
            setupScrollSpy(items.filter(i => i.type === 'item').map(i => i.id));
        }

        function handleNavClick(e, id) {
            e.preventDefault();
            const target = document.getElementById(`q-${id}`);
            if (target) {
                // Offset for sticky header
                const headerOffset = 80;
                const elementPosition = target.getBoundingClientRect().top;
                const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
                
                window.scrollTo({
                    top: offsetPosition,
                    behavior: "smooth"
                });
            }
            if (state.navOpen) toggleDrawer(false);
        }

        function toggleDrawer(open) {
            state.navOpen = open;
            if (open) {
                els.backdrop.classList.remove('hidden');
                // trigger reflow
                els.backdrop.offsetHeight;
                els.backdrop.classList.remove('opacity-0');
                els.drawer.classList.remove('-translate-x-full');
            } else {
                els.backdrop.classList.add('opacity-0');
                els.drawer.classList.add('-translate-x-full');
                setTimeout(() => {
                    if (!state.navOpen) els.backdrop.classList.add('hidden');
                }, 200);
            }
        }

        // --- Scroll Spy ---
        let observer;
        function setupScrollSpy(ids) {
            if (observer) observer.disconnect();

            const observerOptions = {
                root: null,
                rootMargin: '-100px 0px -80% 0px',
                threshold: 0
            };

            observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const id = entry.target.id.replace('q-', '');
                        updateActiveNav(id);
                    }
                });
            }, observerOptions);

            ids.forEach(id => {
                const el = document.getElementById(`q-${id}`);
                if (el) observer.observe(el);
            });
        }

        function updateActiveNav(id) {
            // Reset all
            document.querySelectorAll('.nav-link').forEach(l => {
                l.classList.remove('text-primary', 'font-bold', 'bg-accent/50');
            });
            
            // Set active
            const links = document.querySelectorAll(`a[href="#q-${id}"]`);
            links.forEach(l => {
                l.classList.add('text-primary', 'font-bold', 'bg-accent/50');
                l.classList.remove('text-muted-foreground');
            });
        }

        // --- Events ---
        els.drawerTrigger.addEventListener('click', () => toggleDrawer(true));
        els.drawerClose.addEventListener('click', () => toggleDrawer(false));
        els.backdrop.addEventListener('click', () => toggleDrawer(false));

        // Start
        init();

    </script>
</body>
</html>
