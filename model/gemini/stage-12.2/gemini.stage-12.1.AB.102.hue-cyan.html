<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AB","indexWithinVariant":"102","totalWithinVariant":"200","hueFamily":"cyan","intensityMode":"","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-08T17:59:57.806Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AB&quot;,&quot;indexWithinVariant&quot;:&quot;102&quot;,&quot;totalWithinVariant&quot;:&quot;200&quot;,&quot;hueFamily&quot;:&quot;cyan&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-08T17:59:57.806Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer (Stage 6 Baseline)</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- KaTeX CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Base Setup */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F8FAFC; /* slate-50 */
            color: #0F172A; /* slate-900 */
            -webkit-font-smoothing: antialiased;
        }

        /* Scrollbar Hiding for Navigation */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* KaTeX Containment Invariant */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding: 0.5rem 0;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Inline math transparency rule */
        .katex {
            background-color: transparent !important;
        }

        /* Markdown Content Styling */
        .markdown-content p {
            margin-bottom: 0.75em;
            line-height: 1.6;
        }
        .markdown-content p:last-child {
            margin-bottom: 0;
        }
        .markdown-content ul {
            list-style-type: disc;
            padding-left: 1.25rem;
            margin-bottom: 0.75em;
        }
        .markdown-content ol {
            list-style-type: decimal;
            padding-left: 1.25rem;
            margin-bottom: 0.75em;
        }
        /* Minimal Structural Tables */
        .markdown-content table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 0.75em;
            font-size: 0.95em;
        }
        .markdown-content th, .markdown-content td {
            border: 1px solid #E2E8F0; /* slate-200 */
            padding: 0.5rem;
            text-align: left;
        }
        .markdown-content th {
            font-weight: 600;
            background-color: transparent;
        }
        /* Markdown Container Wrapper for Tables on Mobile */
        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-bottom: 0.75em;
        }

        /* Focus States */
        *:focus-visible {
            outline: 2px solid #06B6D4; /* cyan-500 */
            outline-offset: 2px;
        }
    </style>

    <script>
        // Tailwind Configuration for ColorLab B (Cyan)
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            50: '#ECFEFF',
                            100: '#CFFAFE',
                            200: '#A5F3FC',
                            300: '#67E8F9',
                            400: '#22D3EE',
                            500: '#06B6D4',
                            600: '#0891B2',
                            700: '#0E7490',
                            800: '#155E75',
                            900: '#164E63',
                        },
                        neutral: {
                            50: '#F8FAFC',  // slate-50
                            100: '#F1F5F9', // slate-100
                            200: '#E2E8F0', // slate-200
                            300: '#CBD5E1', // slate-300
                            400: '#94A3B8', // slate-400
                            500: '#64748B', // slate-500
                            600: '#475569', // slate-600
                            700: '#334155', // slate-700
                            800: '#1E293B', // slate-800
                            900: '#0F172A', // slate-900
                        }
                    }
                }
            }
        }
    </script>
</head>
<body>
    <div id="root"></div>

    <!-- Libraries (No Integrity Attributes) -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script type="text/babel">
        // --- STAGE 0: CONSTANTS ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // --- MARKDOWN SETUP ---
        const md = window.markdownit ? window.markdownit({
            html: true,
            linkify: true,
            breaks: false 
        }) : null;

        if (md) {
            md.inline.ruler.disable(['escape']);
        }

        // --- COMPONENTS ---

        // Lucide Icon Wrapper
        const Icon = ({ name, size = 16, className = "" }) => {
            const lucide = window.lucide;
            if (!lucide) return null;
            
            React.useEffect(() => {
                lucide.createIcons();
            });

            return <i data-lucide={name} width={size} height={size} className={className}></i>;
        };

        // Render Markdown content and trigger KaTeX
        const MarkdownView = ({ content, className = "" }) => {
            const containerRef = React.useRef(null);

            React.useEffect(() => {
                if (containerRef.current && window.renderMathInElement) {
                    window.renderMathInElement(containerRef.current, {
                        delimiters: [
                            {left: '$$', right: '$$', display: true},
                            {left: '$', right: '$', display: false}
                        ],
                        throwOnError: false
                    });
                }
            }, [content]);

            if (!content) return null;

            // Render Markdown to HTML
            let htmlContent = "";
            try {
                htmlContent = md ? md.render(content) : content;
            } catch (e) {
                console.error("Markdown rendering failed", e);
                htmlContent = content; // Fallback
            }

            return (
                <div 
                    ref={containerRef}
                    className={`markdown-content ${className}`}
                    dangerouslySetInnerHTML={{ __html: htmlContent }}
                />
            );
        };

        // --- NAVIGATION COMPONENTS ---

        // Helper to flatten questions for navigation list
        const flattenQuestions = (questions, depth = 0) => {
            let flat = [];
            questions.forEach(q => {
                flat.push({ id: q.id, depth });
                if (q.children && q.children.length > 0) {
                    flat = flat.concat(flattenQuestions(q.children, depth + 1));
                }
            });
            return flat;
        };

        const NavItem = ({ id, depth, isActive, onClick }) => {
            // Hierarchy via type scale/quietness, flat alignment
            const baseClasses = "block w-full text-left py-1.5 px-3 rounded-md transition-colors duration-200 select-none cursor-pointer";
            const activeClasses = isActive 
                ? "font-bold text-brand-700 bg-brand-50" 
                : "text-neutral-600 hover:text-neutral-900 hover:bg-neutral-100";
            
            // Sub-question visual quietness (smaller text for deeper items)
            const textClasses = depth === 0 ? "text-sm" : "text-xs";
            
            return (
                <button 
                    onClick={onClick}
                    className={`${baseClasses} ${activeClasses} ${textClasses}`}
                    type="button"
                >
                    {id}
                </button>
            );
        };

        const NavigationList = ({ paper, currentId, onNavigate }) => {
            // Check for sections
            const isSectioned = paper.sections && paper.sections.length > 0;

            if (isSectioned) {
                return (
                    <nav className="space-y-4 pb-20">
                        {paper.sections.map((section, idx) => {
                            const flatQuestions = flattenQuestions(section.questions);
                            return (
                                <div key={idx}>
                                    {section.label && section.label.trim() !== "" && (
                                        <div className="px-3 py-2 text-xs font-semibold text-neutral-400 uppercase tracking-wider mb-1">
                                            {section.label}
                                        </div>
                                    )}
                                    <div className="space-y-0.5">
                                        {flatQuestions.map((item, qIdx) => (
                                            <NavItem 
                                                key={`${idx}-${qIdx}`}
                                                id={item.id}
                                                depth={item.depth}
                                                isActive={currentId === item.id}
                                                onClick={() => onNavigate(item.id)}
                                            />
                                        ))}
                                    </div>
                                    {/* Spacing between sections */}
                                    {idx < paper.sections.length - 1 && <div className="h-4"></div>}
                                </div>
                            );
                        })}
                    </nav>
                );
            }

            // Flat paper
            const flatQuestions = flattenQuestions(paper.questions || []);
            return (
                <nav className="space-y-0.5 pb-20">
                    {flatQuestions.map((item, idx) => (
                        <NavItem 
                            key={idx}
                            id={item.id}
                            depth={item.depth}
                            isActive={currentId === item.id}
                            onClick={() => onNavigate(item.id)}
                        />
                    ))}
                </nav>
            );
        };

        // --- CONTENT COMPONENTS ---

        // Solution Details Internal Blocks
        const SolutionDetailsContent = ({ details }) => {
            const { keepInMind, formulasUsed, working, alternativeWorking } = details;

            return (
                <div className="mt-4 space-y-6 text-neutral-600">
                    {/* Keep in mind */}
                    {keepInMind && (
                        <div className="space-y-2">
                            <div className="flex items-center gap-2 text-sm font-bold text-neutral-700">
                                <Icon name="lightbulb" size={16} className="text-neutral-400" />
                                <span>Keep in mind</span>
                            </div>
                            <div className="text-sm">
                                <MarkdownView content={keepInMind} />
                            </div>
                        </div>
                    )}

                    {/* Formulas used */}
                    {formulasUsed && (
                        <div className="space-y-2">
                             <div className="text-sm font-bold text-neutral-700">Formulas used</div>
                             <div className="text-sm">
                                <MarkdownView content={formulasUsed} />
                            </div>
                        </div>
                    )}

                    {/* Working (Primary) */}
                    {working && (
                        <div className="space-y-2">
                            <div className="text-sm font-bold text-neutral-700">Working</div>
                            <div className="text-sm">
                                <MarkdownView content={working} />
                            </div>
                        </div>
                    )}

                    {/* Alternative Working */}
                    {alternativeWorking && alternativeWorking.length > 0 && (
                        <div className="pt-4 mt-4 border-t border-neutral-100">
                            {alternativeWorking.map((alt, idx) => (
                                <div key={idx} className="space-y-2 mt-4 first:mt-0">
                                    <div className="text-sm font-bold text-neutral-700">Alternative working</div>
                                    <div className="text-sm">
                                        <MarkdownView content={alt} />
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        // Solution Block (Answer + Toggle + Details)
        const SolutionBlock = ({ solutionBlock, defaultExpanded }) => {
            if (!solutionBlock) return null;

            const { answer, solutionDetails } = solutionBlock;
            const hasDetails = solutionDetails && (
                solutionDetails.keepInMind || 
                solutionDetails.formulasUsed || 
                solutionDetails.working || 
                (solutionDetails.alternativeWorking && solutionDetails.alternativeWorking.length > 0)
            );

            // Toggle State
            const [isExpanded, setIsExpanded] = React.useState(defaultExpanded && hasDetails);

            // If neither exist, render nothing
            if (!answer && !hasDetails) return null;

            return (
                <div className="mt-6 pt-0">
                    {/* Boundary Separator (Spacing only per tone rules, maybe hairline if needed) */}
                    
                    {/* Answer */}
                    {answer && (
                        <div className="mb-4">
                            <div className="text-xs font-bold text-neutral-500 uppercase tracking-wide mb-1">Answer</div>
                            <div className="text-neutral-900 font-medium">
                                <MarkdownView content={answer} />
                            </div>
                        </div>
                    )}

                    {/* Disclosure Control */}
                    {hasDetails && (
                        <div className="mt-4">
                            <button 
                                onClick={() => setIsExpanded(!isExpanded)}
                                className="group flex items-center gap-1.5 text-sm font-medium text-brand-600 hover:text-brand-700 focus:outline-none transition-colors"
                                aria-expanded={isExpanded}
                            >
                                <span>{isExpanded ? "Hide working" : "Show working"}</span>
                                <Icon 
                                    name="chevron-down" 
                                    size={16} 
                                    className={`transition-transform duration-200 ${isExpanded ? "rotate-180" : ""}`} 
                                />
                            </button>

                            {/* Solution Details Region */}
                            {isExpanded && (
                                <div className="mt-4 pl-0 animate-in fade-in slide-in-from-top-1 duration-200">
                                    {/* Optional subtle wash could go here, sticking to whitespace/clean per ColorLab B light mode */}
                                    <SolutionDetailsContent details={solutionDetails} />
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        const QuestionNode = ({ question, depth = 0, paperDefaults }) => {
            // Determine default expansion based on paper config
            // If paper.defaults.expandedAll is explicitly false, start collapsed. Otherwise default expanded.
            const defaultExpanded = paperDefaults?.expandedAll !== false;

            return (
                <div id={`q-${question.id}`} className="scroll-mt-24 group">
                    {/* Top Level Separation */}
                    {depth === 0 && <div className="h-16"></div>}
                    {/* Child Separation */}
                    {depth > 0 && <div className="h-8"></div>}

                    {/* Question Node Surface (Implicit) */}
                    <div className="relative">
                        
                        {/* Question Body */}
                        <div className="flex gap-4">
                            {/* Identifier */}
                            <div className="flex-none w-12 pt-0.5">
                                <span className="text-base font-semibold text-neutral-500">{question.id}</span>
                            </div>
                            
                            {/* Content Column */}
                            <div className="flex-1 min-w-0">
                                {/* Prompt */}
                                <div className="text-lg text-neutral-900 font-medium leading-relaxed">
                                    <MarkdownView content={question.question} />
                                </div>

                                {/* Solution Block */}
                                <SolutionBlock 
                                    solutionBlock={question.solutionBlock} 
                                    defaultExpanded={defaultExpanded}
                                />

                                {/* Children */}
                                {question.children && question.children.length > 0 && (
                                    <div className="mt-4 pl-4 border-l border-neutral-100"> 
                                        {/* Indentation with very subtle guide line for structure */}
                                        {question.children.map((child, idx) => (
                                            <QuestionNode 
                                                key={idx} 
                                                question={child} 
                                                depth={depth + 1}
                                                paperDefaults={paperDefaults}
                                            />
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const PaperView = ({ paper }) => {
            if (!paper) return null;

            // Render either Sections or Flat Questions
            const content = paper.sections 
                ? paper.sections.map((sec, idx) => (
                    <div key={idx} className="mb-12">
                         {sec.label && sec.label.trim() !== "" && (
                            <div className="flex items-center gap-4 mb-8">
                                <span className="text-sm font-bold text-neutral-400 uppercase tracking-widest">{sec.label}</span>
                                <div className="h-px bg-neutral-200 flex-1"></div>
                            </div>
                         )}
                         <div>
                            {sec.questions.map((q, qIdx) => (
                                <QuestionNode key={qIdx} question={q} depth={0} paperDefaults={paper.defaults} />
                            ))}
                         </div>
                    </div>
                  ))
                : paper.questions.map((q, idx) => (
                    <QuestionNode key={idx} question={q} depth={0} paperDefaults={paper.defaults} />
                  ));

            return (
                <div className="pb-32">
                    <div className="max-w-3xl">
                        {/* Paper Header / Title could go here if in payload, using Label for now */}
                        <h1 className="text-2xl font-bold text-neutral-900 mb-8">{paper.label}</h1>
                        {content}
                    </div>
                </div>
            );
        };

        // --- SHELL COMPONENTS ---

        const TopControls = ({ papers, currentKey, onSelect, onMobileMenu }) => {
            return (
                <div className="sticky top-0 z-30 bg-neutral-50/95 backdrop-blur-sm border-b border-neutral-200">
                    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div className="h-16 flex items-center justify-between">
                            {/* Logo / Brand Placeholder */}
                            <div className="flex items-center gap-2">
                                <div className="w-6 h-6 bg-brand-600 rounded-sm"></div>
                                <span className="text-sm font-semibold text-neutral-900 hidden sm:block">RTQ Viewer</span>
                            </div>

                            {/* Controls */}
                            <div className="flex items-center gap-4">
                                <select 
                                    value={currentKey} 
                                    onChange={(e) => onSelect(e.target.value)}
                                    className="bg-white border border-neutral-300 text-neutral-700 text-sm rounded-md focus:ring-brand-500 focus:border-brand-500 block w-48 p-2.5"
                                >
                                    {papers.map(p => (
                                        <option key={p.key} value={p.key}>{p.label}</option>
                                    ))}
                                </select>

                                {/* Mobile Menu Trigger */}
                                <button 
                                    onClick={onMobileMenu}
                                    className="lg:hidden p-2 text-neutral-600 hover:text-neutral-900 focus:outline-none"
                                >
                                    <span className="sr-only">Jump to</span>
                                    <Icon name="menu" size={24} />
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---

        const App = () => {
            const [payload, setPayload] = React.useState(null);
            const [error, setError] = React.useState(false);
            const [currentPaperKey, setCurrentPaperKey] = React.useState(null);
            const [mobileNavOpen, setMobileNavOpen] = React.useState(false);

            // Fetch Payload
            React.useEffect(() => {
                fetch(RTQ_PAPERS_PAYLOAD_PATH)
                    .then(res => {
                        if (!res.ok) throw new Error("Network response was not ok");
                        return res.json();
                    })
                    .then(data => {
                        setPayload(data);
                        if (data.papers && data.papers.length > 0) {
                            setCurrentPaperKey(data.papers[0].key);
                        }
                    })
                    .catch(err => {
                        console.error("Payload loading failed:", err);
                        setError(true);
                    });
            }, []);

            // Scroll Handling for Jump To
            const handleNavigate = (id) => {
                setMobileNavOpen(false);
                const el = document.getElementById(`q-${id}`);
                if (el) {
                    el.scrollIntoView({ behavior: 'smooth' });
                }
            };

            if (error) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-neutral-50 text-neutral-400 font-mono text-sm">
                        PAPERS PAYLOAD MISSING
                    </div>
                );
            }

            if (!payload || !currentPaperKey) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-neutral-50">
                        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-brand-600"></div>
                    </div>
                );
            }

            const currentPaper = payload.papers.find(p => p.key === currentPaperKey);

            return (
                <div className="min-h-screen bg-neutral-50 selection:bg-brand-100 selection:text-brand-900">
                    <TopControls 
                        papers={payload.papers} 
                        currentKey={currentPaperKey} 
                        onSelect={setCurrentPaperKey}
                        onMobileMenu={() => setMobileNavOpen(true)}
                    />

                    {/* Document Frame Shell */}
                    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div className="lg:grid lg:grid-cols-[240px_1fr] lg:gap-12 relative">
                            
                            {/* Desktop Nav Rail */}
                            <aside className="hidden lg:block sticky top-16 h-[calc(100vh-4rem)] pt-8 overflow-y-auto no-scrollbar">
                                <div className="text-xs font-bold text-neutral-400 uppercase tracking-widest mb-4">Jump to</div>
                                <NavigationList 
                                    paper={currentPaper} 
                                    currentId={null} // Active state tracking could be implemented with IntersectionObserver, keeping simple per brief
                                    onNavigate={handleNavigate} 
                                />
                            </aside>

                            {/* Paper Content Region */}
                            <main className="pt-8 min-h-screen">
                                <PaperView paper={currentPaper} />
                            </main>
                        </div>
                    </div>

                    {/* Mobile Navigation Drawer */}
                    {mobileNavOpen && (
                        <div className="fixed inset-0 z-50 lg:hidden" role="dialog" aria-modal="true">
                            {/* Backdrop */}
                            <div className="fixed inset-0 bg-neutral-900/20 backdrop-blur-sm" onClick={() => setMobileNavOpen(false)}></div>
                            
                            {/* Drawer */}
                            <div className="fixed inset-y-0 right-0 w-full max-w-xs bg-white shadow-xl flex flex-col animate-in slide-in-from-right duration-200">
                                <div className="flex items-center justify-between px-4 h-16 border-b border-neutral-100">
                                    <h2 className="text-lg font-semibold text-neutral-900">Jump to</h2>
                                    <button onClick={() => setMobileNavOpen(false)} className="p-2 text-neutral-500 hover:text-neutral-900">
                                        <Icon name="x" size={24} />
                                    </button>
                                </div>
                                <div className="flex-1 overflow-y-auto p-4">
                                    <NavigationList 
                                        paper={currentPaper} 
                                        currentId={null}
                                        onNavigate={handleNavigate} 
                                    />
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // Render
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
