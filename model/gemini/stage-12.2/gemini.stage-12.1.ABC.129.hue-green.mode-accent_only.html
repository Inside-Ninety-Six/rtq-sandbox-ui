<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"ABC","indexWithinVariant":"129","totalWithinVariant":"320","hueFamily":"green","intensityMode":"accent_only","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-09T16:05:16.499Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;ABC&quot;,&quot;indexWithinVariant&quot;:&quot;129&quot;,&quot;totalWithinVariant&quot;:&quot;320&quot;,&quot;hueFamily&quot;:&quot;green&quot;,&quot;intensityMode&quot;:&quot;accent_only&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-09T16:05:16.499Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>

    <!-- 
        STAGE 6 BASELINE: LIBRARIES
        KaTeX and Markdown-it loaded via CDN without SRI (Integrity) as per Stage 6.0.7b 
    -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <style>
        /* 
           STAGE 6 ADD-ON: COLORLAB C (Tinted Neutrals - Blue) 
           Hue: Blue (approx 260 in OKLCH)
           Mode: tinted_neutrals (Light Mode Only)
        */
        :root {
            /* Palette Configuration */
            --hue: 260;

            /* Surfaces (C in [0.015 .. 0.035]) */
            --color-page-bg: oklch(0.985 0.015 var(--hue));
            --color-frame-bg: oklch(0.97 0.02 var(--hue)); 
            --color-paper-bg: oklch(0.99 0.015 var(--hue));
            
            /* Solution Details Wash (C in [0.025 .. 0.045]) */
            --color-solution-wash: oklch(0.96 0.03 var(--hue));
            
            /* Text (Primary C <= 0.010, Secondary C <= 0.012) */
            --color-text-primary: oklch(0.20 0.01 var(--hue));
            --color-text-secondary: oklch(0.45 0.012 var(--hue));
            --color-text-tertiary: oklch(0.60 0.012 var(--hue));
            
            /* Accent / Interactive (C in [0.10 .. 0.16]) */
            --color-accent: oklch(0.55 0.14 var(--hue));
            --color-hairline: oklch(0.88 0.02 var(--hue));
            --color-focus: var(--color-accent);

            /* Typography & Spacing */
            --font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            --space-xs: 0.25rem;
            --space-sm: 0.5rem;
            --space-md: 1rem;
            --space-lg: 1.5rem;
            --space-xl: 2.5rem; /* Top-level question separation */
            
            --max-paper-width: 48rem; /* approx 768px readable width */
            --nav-width: 16rem;
        }

        /* RESET & BASE */
        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: var(--font-family);
            background-color: var(--color-page-bg);
            color: var(--color-text-primary);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        /* 
           DOCUMENT FRAME SHELL (Stage 3)
           Desktop: Two sibling columns (Nav + Paper) sharing base surface.
           Mobile: Single column.
        */
        .document-frame-shell {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background-color: var(--color-frame-bg);
        }

        /* TOP CONTROLS REGION */
        .top-controls {
            position: sticky;
            top: 0;
            z-index: 50;
            background-color: var(--color-frame-bg);
            border-bottom: 1px solid var(--color-hairline);
            padding: var(--space-sm) var(--space-md);
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 3.5rem;
        }

        .paper-selector {
            font-size: 0.9rem;
            padding: var(--space-xs) var(--space-sm);
            border: 1px solid var(--color-hairline);
            border-radius: 4px;
            background-color: var(--color-paper-bg);
            color: var(--color-text-primary);
            cursor: pointer;
        }

        .mobile-jump-to {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            background: none;
            border: none;
            color: var(--color-accent);
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
        }

        /* DESKTOP LAYOUT */
        .desktop-columns {
            display: flex;
            flex: 1;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        /* NAVIGATION RAIL (Desktop) */
        .nav-rail {
            width: var(--nav-width);
            flex-shrink: 0;
            position: sticky;
            top: 3.5rem; /* Below top controls */
            height: calc(100vh - 3.5rem);
            overflow-y: auto;
            padding: var(--space-lg) var(--space-md);
            border-right: 1px solid var(--color-hairline);
            /* Scrollbar hiding per Add-on */
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .nav-rail::-webkit-scrollbar {
            display: none;
        }

        /* PAPER CONTENT COLUMN */
        .paper-column {
            flex: 1;
            padding: var(--space-lg) var(--space-md) var(--space-xl);
            display: flex;
            justify-content: center;
        }

        .paper-region {
            width: 100%;
            max-width: var(--max-paper-width);
            background-color: var(--color-paper-bg);
            /* Stage 5: Paper surface must not create a "card" look, just a subtle surface distinction if used */
            /* In tinted_neutrals, paper-bg is distinct from frame-bg */
        }

        /* LOADING / ERROR STATES */
        .state-message {
            padding: var(--space-xl);
            text-align: center;
            color: var(--color-text-secondary);
            font-weight: 500;
        }

        /* NAVIGATION LIST STYLING (Stage 5.4 - Flat List) */
        .nav-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .nav-section-label {
            display: block;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--color-text-tertiary);
            margin-top: var(--space-md);
            margin-bottom: var(--space-sm);
            font-weight: 600;
        }

        .nav-item {
            display: block;
            width: 100%;
            text-align: left;
            background: none;
            border: none;
            padding: var(--space-xs) 0;
            font-size: 0.9rem;
            color: var(--color-text-secondary);
            cursor: pointer;
            text-decoration: none;
            /* Hierarchy via type scale only, no indent */
        }
        
        .nav-item[data-depth="1"] { font-size: 0.85rem; color: var(--color-text-secondary); }
        .nav-item[data-depth="2"] { font-size: 0.8rem; color: var(--color-text-tertiary); }

        .nav-item:hover {
            color: var(--color-text-primary);
            text-decoration: underline;
            text-decoration-color: var(--color-accent);
            text-decoration-thickness: 2px;
        }

        .nav-item.active {
            color: var(--color-text-primary);
            font-weight: 700;
            /* Optional marker allowed by Stage 5.4 override */
            border-left: 2px solid var(--color-accent);
            padding-left: var(--space-sm);
            margin-left: calc(-1 * var(--space-sm) - 2px);
        }

        /* DRAWER (Mobile) */
        .drawer-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.2);
            z-index: 100;
            display: none;
        }
        .drawer-overlay.open { display: block; }

        .drawer {
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            width: 80%;
            max-width: 300px;
            background-color: var(--color-frame-bg);
            z-index: 101;
            transform: translateX(-100%);
            transition: transform 0.2s ease-out;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--color-hairline);
        }
        .drawer.open { transform: translateX(0); }

        .drawer-header {
            padding: var(--space-md);
            border-bottom: 1px solid var(--color-hairline);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .drawer-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--color-text-secondary);
        }

        .drawer-content {
            overflow-y: auto;
            padding: var(--space-md);
        }

        /* PAPER CONTENT TYPOGRAPHY & LAYOUT */
        
        /* Headers */
        .section-header-block {
            margin-bottom: var(--space-lg);
            border-bottom: 1px solid var(--color-hairline);
            padding-bottom: var(--space-sm);
        }
        .section-header-text {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--color-text-primary);
        }

        /* Question Node */
        .question-node {
            margin-bottom: var(--space-xl); /* Strongest separation */
        }
        .question-node[data-is-child="true"] {
            margin-bottom: var(--space-md);
            margin-top: var(--space-md);
        }

        /* Question Body */
        .question-body {
            margin-bottom: var(--space-md);
            color: var(--color-text-primary);
        }
        .question-id {
            font-weight: 700;
            margin-right: var(--space-sm);
            color: var(--color-text-primary);
        }

        /* Solution Block */
        .solution-block {
            /* Separation handled by spacing */
        }

        /* Answer */
        .answer-region {
            margin-bottom: var(--space-sm);
        }
        .answer-label {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--color-text-secondary);
            display: block;
            margin-bottom: var(--space-xs);
        }
        .answer-content {
            font-weight: 500;
        }

        /* Solution Details Disclosure */
        .disclosure-control {
            display: inline-flex;
            align-items: center;
            gap: 0.5ch;
            background: none;
            border: none;
            padding: 0;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--color-accent);
            cursor: pointer;
            margin-bottom: var(--space-sm);
        }
        .disclosure-control:hover {
            text-decoration: underline;
        }

        /* Solution Details Region */
        .solution-details-region {
            display: none;
            background-color: var(--color-solution-wash);
            padding: var(--space-md);
            border-radius: 4px; /* Soft structure, no card look */
            margin-top: var(--space-sm);
        }
        .solution-details-region.expanded {
            display: block;
        }

        /* Subsections */
        .sd-subsection {
            margin-bottom: var(--space-md);
        }
        .sd-subsection:last-child {
            margin-bottom: 0;
        }
        .sd-label {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--color-text-secondary);
            margin-bottom: var(--space-xs);
            display: block;
        }

        /* Working / Alt Working content */
        .working-body p {
            margin-bottom: var(--space-sm);
        }
        .working-body p:last-child {
            margin-bottom: 0;
        }

        /* Keep in mind / Formulas specific styling (Stage 5.9) */
        .keep-in-mind-body {
            font-size: 0.95rem;
        }
        .keep-in-mind-body ul {
            padding-left: 1.2rem;
            margin: 0;
        }

        /* Children Container */
        .children-container {
            margin-left: 0; /* Flat visually per tree, hierarchy via type/spacing inside node */
            padding-left: var(--space-md); /* Indentation for reading flow */
            border-left: 1px solid var(--color-hairline); /* Quiet guide */
        }

        /* KATE X & MARKDOWN STYLING */
        /* KaTeX containment invariant: No horizontal scroll on page */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            -webkit-overflow-scrolling: touch;
            padding: 0.5em 0;
        }
        /* Tables */
        table {
            border-collapse: collapse;
            width: 100%;
            max-width: 100%;
            margin: var(--space-sm) 0;
            display: block;
            overflow-x: auto;
        }
        th, td {
            border: 1px solid var(--color-hairline);
            padding: var(--space-sm);
            text-align: left;
        }
        th {
            font-weight: 600;
            background-color: rgba(0,0,0,0.02);
        }

        /* UTILS */
        .hidden { display: none !important; }
        
        /* Focus styles */
        :focus-visible {
            outline: 2px solid var(--color-focus);
            outline-offset: 2px;
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .nav-rail { display: none; }
            .mobile-jump-to { display: flex; }
            .paper-column { padding: var(--space-md); }
            /* Indentation adaptation for small screens */
            .children-container { padding-left: var(--space-sm); }
        }
        @media (min-width: 769px) {
            .mobile-jump-to { display: none; }
        }

    </style>
</head>
<body>

<!-- STAGE 0: CONSTANTS (Runtime Definition) -->
<script>
    // CANONICAL CONSTANT â€” PAPERS PAYLOAD PATH (v1.0)
    const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
</script>

<div class="document-frame-shell">
    
    <!-- Top Controls -->
    <header class="top-controls">
        <select id="paper-selector" class="paper-selector" aria-label="Select Paper">
            <option value="" disabled selected>Loading papers...</option>
        </select>
        
        <button id="mobile-jump-to" class="mobile-jump-to" aria-label="Jump to question">
            <span>Jump to</span>
            <svg width="16" height="16" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.13523 6.15803C3.3241 5.95657 3.64052 5.94637 3.84197 6.13523L7.5 9.56464L11.158 6.13523C11.3595 5.94637 11.6759 5.95657 11.8648 6.15803C12.0536 6.35949 12.0434 6.67591 11.842 6.86477L7.84197 10.6148C7.64964 10.7951 7.35036 10.7951 7.15803 10.6148L3.15803 6.86477C2.95657 6.67591 2.94637 6.35949 3.13523 6.15803Z" fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
        </button>
    </header>

    <!-- Main Content Area -->
    <div class="desktop-columns">
        
        <!-- Navigation Rail (Desktop) -->
        <nav class="nav-rail" aria-label="Paper Navigation">
            <ul id="desktop-nav-list" class="nav-list"></ul>
        </nav>

        <!-- Paper Content -->
        <main class="paper-column">
            <div id="paper-container" class="paper-region">
                <!-- Content injected here -->
                <div class="state-message">Loading payload...</div>
            </div>
        </main>
    </div>
</div>

<!-- Mobile Navigation Drawer -->
<div id="drawer-overlay" class="drawer-overlay"></div>
<div id="drawer" class="drawer" role="dialog" aria-modal="true" aria-label="Jump to question">
    <div class="drawer-header">
        <span class="drawer-title" style="font-weight:700">Jump to</span>
        <button id="drawer-close" class="drawer-close" aria-label="Close navigation">&times;</button>
    </div>
    <div class="drawer-content">
        <ul id="mobile-nav-list" class="nav-list"></ul>
    </div>
</div>

<script>
/**
 * RTQ MATHS PAPER SOLUTION VIEWER - PROTOTYPE
 * Stage 6 Baseline
 */

// --- Global State ---
let APP_STATE = {
    papers: [],
    currentPaperKey: null,
    currentPaperData: null,
    expandedNodes: new Set() // Tracks IDs of expanded questions
};

// --- Markdown Renderer Setup (Stage 6 Add-on) ---
const md = window.markdownit ? window.markdownit({
    html: true,      // Allow inline SVG
    linkify: true,
    breaks: false    // CRITICAL: prevents <br> in math blocks
}) : null;

if (md) {
    // Disable escape rule to preserve TeX backslashes
    md.inline.ruler.disable(['escape']);
}

// --- Payload Loading ---
async function loadPayload() {
    try {
        const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
        if (!response.ok) throw new Error("Fetch failed");
        const data = await response.json();
        
        APP_STATE.papers = data.papers || [];
        initPaperSelector();
        
        if (APP_STATE.papers.length > 0) {
            switchPaper(APP_STATE.papers[0].key);
        } else {
            renderError("No papers found in payload.");
        }
    } catch (e) {
        console.error(e);
        renderError("PAPERS PAYLOAD MISSING");
    }
}

function renderError(msg) {
    const container = document.getElementById('paper-container');
    container.innerHTML = `<div class="state-message">${msg}</div>`;
    
    // Clear selector
    const selector = document.getElementById('paper-selector');
    selector.innerHTML = `<option>${msg}</option>`;
    selector.disabled = true;
}

// --- Initialization ---
function initPaperSelector() {
    const selector = document.getElementById('paper-selector');
    selector.innerHTML = '';
    
    APP_STATE.papers.forEach(paper => {
        const opt = document.createElement('option');
        opt.value = paper.key;
        opt.textContent = paper.label || paper.key;
        selector.appendChild(opt);
    });

    selector.addEventListener('change', (e) => {
        switchPaper(e.target.value);
    });
}

// --- Paper Switching ---
function switchPaper(paperKey) {
    const paper = APP_STATE.papers.find(p => p.key === paperKey);
    if (!paper) return;

    APP_STATE.currentPaperKey = paperKey;
    APP_STATE.currentPaperData = paper;
    
    // Default expansion logic based on paper defaults
    APP_STATE.expandedNodes.clear();
    const shouldExpandAll = paper.defaults && paper.defaults.expandedAll !== false; // Default true unless false
    
    if (shouldExpandAll) {
        // We'll handle visual state during render, but for tracking let's just assume 
        // if user toggles, we track specific ID. 
        // Simplification: We will apply class 'expanded' by default if this is true.
    }

    renderPaper(paper, shouldExpandAll);
    renderNavigation(paper);
    
    // Trigger KaTeX
    renderMathInElement(document.getElementById('paper-container'), {
        delimiters: [
            {left: '$$', right: '$$', display: true},
            {left: '$', right: '$', display: false},
            {left: '\\(', right: '\\)', display: false},
            {left: '\\[', right: '\\]', display: true}
        ],
        throwOnError: false
    });
}

// --- Rendering Core ---

function renderPaper(paper, defaultExpanded) {
    const container = document.getElementById('paper-container');
    container.innerHTML = ''; // Clear

    // Handle flat vs sectioned
    if (paper.sections) {
        paper.sections.forEach(section => {
            if (section.label && section.label.trim().length > 0) {
                const secHeader = document.createElement('div');
                secHeader.className = 'section-header-block';
                secHeader.innerHTML = `<div class="section-header-text">${section.label}</div>`;
                container.appendChild(secHeader);
            }
            renderQuestionList(section.questions, container, defaultExpanded);
        });
    } else if (paper.questions) {
        renderQuestionList(paper.questions, container, defaultExpanded);
    }
}

function renderQuestionList(questions, container, defaultExpanded, depth = 0) {
    if (!questions) return;
    questions.forEach(q => {
        const node = createQuestionNode(q, defaultExpanded, depth);
        container.appendChild(node);
    });
}

function createQuestionNode(data, defaultExpanded, depth) {
    const node = document.createElement('div');
    node.className = 'question-node';
    node.id = `q-${data.id}`; // Anchor ID
    if (depth > 0) node.dataset.isChild = "true";

    // 1. Question Body
    const body = document.createElement('div');
    body.className = 'question-body';
    // Combine ID and Prompt
    const contentHtml = md ? md.render(data.question || '') : (data.question || '');
    body.innerHTML = `<span class="question-id">${data.id}</span> ${contentHtml}`;
    node.appendChild(body);

    // 2. Solution Block (Optional)
    if (data.solutionBlock) {
        const solBlock = document.createElement('div');
        solBlock.className = 'solution-block';

        // A. Answer (Optional)
        if (data.solutionBlock.answer) {
            const answerDiv = document.createElement('div');
            answerDiv.className = 'answer-region';
            const ansHtml = md ? md.render(data.solutionBlock.answer) : data.solutionBlock.answer;
            answerDiv.innerHTML = `
                <span class="answer-label">Answer</span>
                <div class="answer-content">${ansHtml}</div>
            `;
            solBlock.appendChild(answerDiv);
        }

        // B. Solution Details (Optional)
        if (data.solutionBlock.solutionDetails) {
            const details = data.solutionBlock.solutionDetails;
            
            // Disclosure Control
            const toggle = document.createElement('button');
            toggle.className = 'disclosure-control';
            const isExpanded = defaultExpanded; 
            // Text-first control
            toggle.innerHTML = `<span>${isExpanded ? 'Hide working' : 'Show working'}</span>
                <svg width="12" height="12" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg" style="transform: ${isExpanded ? 'rotate(180deg)' : 'rotate(0deg)'}; transition: transform 0.2s;"><path d="M3.13523 6.15803C3.3241 5.95657 3.64052 5.94637 3.84197 6.13523L7.5 9.56464L11.158 6.13523C11.3595 5.94637 11.6759 5.95657 11.8648 6.15803C12.0536 6.35949 12.0434 6.67591 11.842 6.86477L7.84197 10.6148C7.64964 10.7951 7.35036 10.7951 7.15803 10.6148L3.15803 6.86477C2.95657 6.67591 2.94637 6.35949 3.13523 6.15803Z" fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"></path></svg>`;
            
            // Region
            const region = document.createElement('div');
            region.className = `solution-details-region ${isExpanded ? 'expanded' : ''}`;
            
            // Toggle Logic
            toggle.onclick = () => {
                const currentlyExpanded = region.classList.contains('expanded');
                if (currentlyExpanded) {
                    region.classList.remove('expanded');
                    toggle.innerHTML = `<span>Show working</span><svg width="12" height="12" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg" style="transform: rotate(0deg); transition: transform 0.2s;"><path d="M3.13523 6.15803C3.3241 5.95657 3.64052 5.94637 3.84197 6.13523L7.5 9.56464L11.158 6.13523C11.3595 5.94637 11.6759 5.95657 11.8648 6.15803C12.0536 6.35949 12.0434 6.67591 11.842 6.86477L7.84197 10.6148C7.64964 10.7951 7.35036 10.7951 7.15803 10.6148L3.15803 6.86477C2.95657 6.67591 2.94637 6.35949 3.13523 6.15803Z" fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"></path></svg>`;
                } else {
                    region.classList.add('expanded');
                    toggle.innerHTML = `<span>Hide working</span><svg width="12" height="12" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg" style="transform: rotate(180deg); transition: transform 0.2s;"><path d="M3.13523 6.15803C3.3241 5.95657 3.64052 5.94637 3.84197 6.13523L7.5 9.56464L11.158 6.13523C11.3595 5.94637 11.6759 5.95657 11.8648 6.15803C12.0536 6.35949 12.0434 6.67591 11.842 6.86477L7.84197 10.6148C7.64964 10.7951 7.35036 10.7951 7.15803 10.6148L3.15803 6.86477C2.95657 6.67591 2.94637 6.35949 3.13523 6.15803Z" fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"></path></svg>`;
                }
            };

            // Order: Keep in mind -> Formulas -> Working -> Alternative
            
            // Keep in mind
            if (details.keepInMind) {
                const km = document.createElement('div');
                km.className = 'sd-subsection';
                km.innerHTML = `
                    <span class="sd-label">Keep in mind</span>
                    <div class="keep-in-mind-body">${md ? md.render(details.keepInMind) : details.keepInMind}</div>
                `;
                region.appendChild(km);
            }

            // Formulas
            if (details.formulasUsed) {
                const fu = document.createElement('div');
                fu.className = 'sd-subsection';
                fu.innerHTML = `
                    <span class="sd-label">Formulas used</span>
                    <div class="formulas-body">${md ? md.render(details.formulasUsed) : details.formulasUsed}</div>
                `;
                region.appendChild(fu);
            }

            // Working
            if (details.working) {
                const wk = document.createElement('div');
                wk.className = 'sd-subsection';
                wk.innerHTML = `
                    <span class="sd-label">Working</span>
                    <div class="working-body">${md ? md.render(details.working) : details.working}</div>
                `;
                region.appendChild(wk);
            }

            // Alternative Working (Array)
            if (details.alternativeWorking && Array.isArray(details.alternativeWorking)) {
                details.alternativeWorking.forEach(alt => {
                    const aw = document.createElement('div');
                    aw.className = 'sd-subsection';
                    aw.innerHTML = `
                        <span class="sd-label">Alternative working</span>
                        <div class="working-body">${md ? md.render(alt) : alt}</div>
                    `;
                    region.appendChild(aw);
                });
            }

            solBlock.appendChild(toggle);
            solBlock.appendChild(region);
        }

        node.appendChild(solBlock);
    }

    // 3. Children (Recursion)
    if (data.children && data.children.length > 0) {
        const childContainer = document.createElement('div');
        childContainer.className = 'children-container';
        data.children.forEach(child => {
            const childNode = createQuestionNode(child, defaultExpanded, depth + 1);
            childContainer.appendChild(childNode);
        });
        node.appendChild(childContainer);
    }

    return node;
}

// --- Navigation Rendering ---
function renderNavigation(paper) {
    const desktopList = document.getElementById('desktop-nav-list');
    const mobileList = document.getElementById('mobile-nav-list');
    
    desktopList.innerHTML = '';
    mobileList.innerHTML = '';

    const items = [];

    // Helper to traverse and build linear list structure
    // Nav hierarchy via typographic scale (depth), but flat HTML structure for the rail
    const traverse = (questions, depth=0) => {
        if (!questions) return;
        questions.forEach(q => {
            items.push({ id: q.id, depth: depth });
            if (q.children) traverse(q.children, depth + 1);
        });
    };

    if (paper.sections) {
        paper.sections.forEach(sec => {
            // Section Label
            if (sec.label && sec.label.trim().length > 0) {
                const labelItem = document.createElement('span');
                labelItem.className = 'nav-section-label';
                labelItem.textContent = sec.label;
                desktopList.appendChild(labelItem.cloneNode(true));
                mobileList.appendChild(labelItem.cloneNode(true));
            }
            // Items
            items.length = 0; // Clear buffer
            traverse(sec.questions);
            renderNavItems(items, desktopList, mobileList);
        });
    } else {
        traverse(paper.questions);
        renderNavItems(items, desktopList, mobileList);
    }
}

function renderNavItems(items, dList, mList) {
    items.forEach(item => {
        const btnD = createNavButton(item);
        const btnM = createNavButton(item);
        
        // Mobile closes drawer on click
        btnM.addEventListener('click', () => {
            closeDrawer();
        });

        const liD = document.createElement('li'); liD.appendChild(btnD);
        const liM = document.createElement('li'); liM.appendChild(btnM);
        
        dList.appendChild(liD);
        mList.appendChild(liM);
    });
}

function createNavButton(item) {
    const btn = document.createElement('a');
    btn.className = 'nav-item';
    btn.textContent = item.id;
    btn.href = `#q-${item.id}`;
    btn.dataset.depth = Math.min(item.depth, 2); // Cap depth attribute for styling
    
    btn.onclick = (e) => {
        e.preventDefault();
        // Scroll logic
        const target = document.getElementById(`q-${item.id}`);
        if (target) {
            // Highlight active logic would go here (intersection observer ideal, simple click set for now)
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.querySelectorAll(`a[href="#q-${item.id}"]`).forEach(n => n.classList.add('active'));
            
            target.scrollIntoView({ behavior: 'smooth', block: 'start' });
            // Adjust for sticky header
            window.scrollBy(0, -70);
        }
    };
    return btn;
}

// --- Mobile Drawer Logic ---
const drawer = document.getElementById('drawer');
const overlay = document.getElementById('drawer-overlay');
const jumpBtn = document.getElementById('mobile-jump-to');
const closeBtn = document.getElementById('drawer-close');

function openDrawer() {
    drawer.classList.add('open');
    overlay.classList.add('open');
    document.body.style.overflow = 'hidden'; // Lock scroll
}

function closeDrawer() {
    drawer.classList.remove('open');
    overlay.classList.remove('open');
    document.body.style.overflow = '';
}

jumpBtn.onclick = openDrawer;
closeBtn.onclick = closeDrawer;
overlay.onclick = closeDrawer;

// --- Start ---
// Attempt load
loadPayload();

// Scroll Spy for Nav Highlighting (Simple)
let scrollTimeout;
window.addEventListener('scroll', () => {
    if (scrollTimeout) clearTimeout(scrollTimeout);
    scrollTimeout = setTimeout(() => {
        const nodes = document.querySelectorAll('.question-node');
        let current = null;
        for (let node of nodes) {
            const rect = node.getBoundingClientRect();
            if (rect.top >= 0 && rect.top < window.innerHeight / 2) {
                current = node;
                break; 
            }
        }
        if (current) {
            const id = current.id.replace('q-', '');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.querySelectorAll(`a[href="#q-${id}"]`).forEach(n => n.classList.add('active'));
        }
    }, 100);
});

</script>
</body>
</html>
