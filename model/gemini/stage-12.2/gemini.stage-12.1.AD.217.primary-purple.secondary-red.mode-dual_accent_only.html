<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AD","indexWithinVariant":"217","totalWithinVariant":"440","hueFamily":"","intensityMode":"","primaryHueFamily":"purple","secondaryHueFamily":"red","dualIntensityMode":"dual_accent_only","timestamp":"2026-01-10T11:54:01.629Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AD&quot;,&quot;indexWithinVariant&quot;:&quot;217&quot;,&quot;totalWithinVariant&quot;:&quot;440&quot;,&quot;hueFamily&quot;:&quot;&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;primaryHueFamily&quot;:&quot;purple&quot;,&quot;secondaryHueFamily&quot;:&quot;red&quot;,&quot;dualIntensityMode&quot;:&quot;dual_accent_only&quot;,&quot;timestamp&quot;:&quot;2026-01-10T11:54:01.629Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer (Stage 6 Baseline)</title>

    <!-- Tailwind CSS (via CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- KaTeX CSS (No integrity, per Stage 6 baseline) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    
    <!-- KaTeX JS (No integrity, per Stage 6 baseline) -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Markdown-it (No integrity) -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <script>
        // Tailwind Configuration for ColorLab D (Dual Accent, Light Only)
        // Fallbacks used: Primary=Blue(250), Secondary=Amber(85)
        // Mode: dual_accent_only
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'], // Modern, friendly, neutral
                    },
                    colors: {
                        // OKLCH Definitions per ColorLab D (dual_accent_only)
                        page: 'oklch(0.98 0.005 250)',   // Very subtle cool tint
                        paper: 'oklch(1.0 0 0)',         // Pure white for content clarity
                        frame: 'oklch(0.98 0.005 250)',  // Matches page for unified shell
                        
                        // Text (C <= 0.010)
                        primary: 'oklch(0.20 0.01 250)',
                        secondary: 'oklch(0.45 0.01 250)',
                        tertiary: 'oklch(0.60 0.005 250)',

                        // Accents (Primary=Blue, Secondary=Amber)
                        // Primary: C [0.08 .. 0.14]
                        accent: {
                            DEFAULT: 'oklch(0.55 0.14 250)', 
                            hover: 'oklch(0.50 0.14 250)',
                            subtle: 'oklch(0.94 0.04 250)', // Very light wash
                        },
                        // Secondary: C [0.06 .. 0.12]
                        aux: {
                            DEFAULT: 'oklch(0.70 0.12 85)',
                        },

                        // Borders
                        hairline: 'oklch(0.92 0.005 250)',
                        focus: 'oklch(0.55 0.14 250)',
                    },
                    spacing: {
                        'nav-width': '240px',
                    }
                }
            }
        }
    </script>

    <style>
        /* Global Reset & Typography */
        body {
            background-color: theme('colors.page');
            color: theme('colors.primary');
            font-family: theme('fontFamily.sans');
            -webkit-font-smoothing: antialiased;
            overflow-y: scroll; /* Force scrollbar */
        }

        /* 
         * KaTeX Containment Invariant (Locked) 
         * Never allow page-level horizontal scroll.
         * Horizontal scroll allowed ONLY within block math.
         */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding-bottom: 4px; /* Scrollbar spacing */
            margin: 1em 0;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Block math underlay safety (Stage 5.8) - Optional subtle styling */
        .katex-display > .katex {
            text-align: left; /* Alignment preference */
        }

        /* Layout Utilities */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Focus Visibility (Stage 5.5.2) */
        :focus-visible {
            outline: 2px solid theme('colors.accent.DEFAULT');
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* Tables in Markdown (Stage 5.8.5) */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
            font-size: 0.95em;
        }
        th, td {
            border: 1px solid theme('colors.hairline');
            padding: 0.5rem;
            text-align: left;
        }
        th {
            font-weight: 600;
            color: theme('colors.primary');
        }

        /* Drawer Transition */
        .drawer-overlay {
            transition: opacity 0.2s ease-out;
        }
        .drawer-content {
            transition: transform 0.2s ease-out;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Top Controls (Paper Selector + Mobile Trigger) -->
    <header class="sticky top-0 z-30 w-full bg-page border-b border-hairline h-14 flex items-center justify-center">
        <div class="w-full max-w-6xl px-4 flex items-center justify-between">
            <!-- Mobile Menu Trigger -->
            <button id="mobile-menu-trigger" class="lg:hidden p-2 -ml-2 text-primary hover:text-accent transition-colors" aria-label="Jump to question">
                <span class="text-sm font-medium">Jump to</span>
            </button>

            <!-- Paper Selector -->
            <div class="flex items-center gap-2">
                <label for="paper-select" class="sr-only">Select Paper</label>
                <select id="paper-select" class="bg-transparent text-sm font-medium text-primary py-1 pr-8 pl-2 border border-hairline rounded focus:border-accent focus:ring-0 cursor-pointer">
                    <!-- Options injected via JS -->
                </select>
            </div>

            <!-- Spacer for visual balance on mobile -->
            <div class="w-10 lg:hidden"></div>
        </div>
    </header>

    <!-- DocumentFrameShell -->
    <div class="flex-1 w-full max-w-6xl mx-auto flex flex-col lg:flex-row relative">
        
        <!-- Desktop Navigation Rail (Sticky) -->
        <aside class="hidden lg:block w-nav-width flex-shrink-0 relative">
            <div class="sticky top-14 h-[calc(100vh-3.5rem)] overflow-y-auto no-scrollbar py-8 pl-4 pr-6 border-r border-transparent">
                <nav id="desktop-nav" aria-label="Paper navigation">
                    <!-- Nav items injected via JS -->
                </nav>
            </div>
        </aside>

        <!-- Paper Content Column -->
        <main id="paper-content" class="flex-1 min-w-0 py-8 px-4 lg:px-12 bg-paper">
            <!-- Content injected via JS -->
            <div id="loading-indicator" class="text-secondary text-center py-20">Loading paper...</div>
        </main>

    </div>

    <!-- Mobile Navigation Drawer -->
    <div id="mobile-drawer" class="fixed inset-0 z-50 pointer-events-none opacity-0 transition-opacity duration-200" aria-hidden="true">
        <!-- Backdrop -->
        <div id="drawer-backdrop" class="absolute inset-0 bg-black/20 pointer-events-auto"></div>
        
        <!-- Drawer Panel -->
        <div id="drawer-panel" class="absolute left-0 top-0 bottom-0 w-64 bg-page border-r border-hairline shadow-lg transform -translate-x-full transition-transform duration-200 pointer-events-auto flex flex-col">
            <div class="h-14 border-b border-hairline flex items-center justify-between px-4">
                <h2 class="font-semibold text-primary">Jump to</h2>
                <button id="drawer-close" class="p-2 -mr-2 text-secondary hover:text-primary">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto py-4 px-4">
                <nav id="mobile-nav-list">
                    <!-- Nav items injected via JS -->
                </nav>
            </div>
        </div>
    </div>

    <!-- Runtime Logic -->
    <script>
        // --- STAGE 0: CONSTANTS ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // --- GLOBAL STATE ---
        let globalPayload = null;
        let currentPaperKey = null;
        let expandedState = {}; // questionId -> boolean

        // --- MARKDOWN INIT (Stage 6 Baseline) ---
        // MUST be html:true, breaks:false, escape disabled
        const md = window.markdownit ? window.markdownit({
            html: true,
            linkify: true,
            breaks: false 
        }) : null;

        if (md) {
            md.inline.ruler.disable(['escape']);
        }

        // --- APP INITIALIZATION ---
        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Payload missing");
                globalPayload = await response.json();
                
                if (!globalPayload.papers || globalPayload.papers.length === 0) {
                    throw new Error("No papers in payload");
                }

                initPaperSelector();
                
                // Select first paper by default
                const initialPaper = globalPayload.papers[0];
                switchPaper(initialPaper.key);

            } catch (err) {
                console.error(err);
                renderError();
            }
            
            setupMobileDrawer();
        }

        function renderError() {
            const container = document.getElementById('paper-content');
            container.innerHTML = `<div class="text-center mt-20 text-lg font-medium text-secondary">PAPERS PAYLOAD MISSING</div>`;
            document.getElementById('paper-select').disabled = true;
        }

        function initPaperSelector() {
            const select = document.getElementById('paper-select');
            select.innerHTML = globalPayload.papers.map(p => 
                `<option value="${p.key}">${p.label}</option>`
            ).join('');
            
            select.addEventListener('change', (e) => {
                switchPaper(e.target.value);
            });
        }

        function switchPaper(key) {
            currentPaperKey = key;
            const paper = globalPayload.papers.find(p => p.key === key);
            
            if (!paper) return;

            // Reset Expanded State based on defaults
            expandedState = {};
            const defaultExpanded = paper.defaults?.expandedAll !== false;
            
            // Note: We don't pre-populate expandedState for every ID because 
            // the render logic assumes default if key is missing. 
            // However, to support toggling, we'll lazily set state.
            
            // Render Content
            renderPaperContent(paper, defaultExpanded);
            
            // Render Navigation
            renderNavigation(paper);

            // Trigger KaTeX
            renderMath();
            
            // Scroll top
            window.scrollTo(0, 0);
        }

        // --- RENDERING LOGIC ---

        function getFlatQuestionList(paper) {
            let list = [];
            if (paper.sections) {
                paper.sections.forEach(section => {
                    if (section.label && section.label.trim() !== "") {
                        list.push({ type: 'section', label: section.label });
                    }
                    if (section.questions) {
                        list = list.concat(flattenQuestions(section.questions));
                    }
                });
            } else if (paper.questions) {
                list = flattenQuestions(paper.questions);
            }
            return list;
        }

        function flattenQuestions(questions) {
            let flat = [];
            questions.forEach(q => {
                flat.push({ type: 'question', id: q.id, depth: 0 }); // Depth 0 for top level list items
                if (q.children) {
                    flat = flat.concat(flattenChildrenForNav(q.children));
                }
            });
            return flat;
        }

        function flattenChildrenForNav(children) {
            let flat = [];
            children.forEach(c => {
                flat.push({ type: 'question', id: c.id, depth: 1 }); // Simplified depth for nav type scale
                if (c.children) {
                    flat = flat.concat(flattenChildrenForNav(c.children));
                }
            });
            return flat;
        }

        function renderNavigation(paper) {
            const list = getFlatQuestionList(paper);
            
            const createNavHTML = (isMobile) => {
                return list.map(item => {
                    if (item.type === 'section') {
                        return `
                            <div class="mt-6 mb-2 text-xs font-semibold text-tertiary uppercase tracking-wider select-none">
                                Section ${item.label}
                            </div>
                        `;
                    } else {
                        // Hierarchy via type scale only (Stage 5.4.5)
                        const isSub = item.depth > 0;
                        const fontSize = isSub ? 'text-xs' : 'text-sm';
                        const color = isSub ? 'text-secondary' : 'text-primary';
                        const padding = isMobile ? 'py-3' : 'py-1';
                        
                        return `
                            <button onclick="scrollToQuestion('${item.id}')" 
                                class="block w-full text-left ${fontSize} ${color} ${padding} hover:text-accent transition-colors focus-visible:text-accent outline-none group">
                                <span class="group-hover:translate-x-0.5 transition-transform inline-block">
                                    ${item.id}
                                </span>
                            </button>
                        `;
                    }
                }).join('');
            };

            document.getElementById('desktop-nav').innerHTML = createNavHTML(false);
            document.getElementById('mobile-nav-list').innerHTML = createNavHTML(true);
        }

        window.scrollToQuestion = (id) => {
            const el = document.getElementById(`q-${id}`);
            if (el) {
                // Close drawer if open
                closeDrawer();
                
                const offset = 80; // Header + padding
                const bodyRect = document.body.getBoundingClientRect().top;
                const elementRect = el.getBoundingClientRect().top;
                const elementPosition = elementRect - bodyRect;
                const offsetPosition = elementPosition - offset;

                window.scrollTo({
                    top: offsetPosition,
                    behavior: 'smooth'
                });
            }
        }

        function renderPaperContent(paper, defaultExpanded) {
            const container = document.getElementById('paper-content');
            let html = '';

            if (paper.sections) {
                html = paper.sections.map(section => {
                    const header = (section.label && section.label.trim() !== "") 
                        ? `<div class="mb-8 pb-2 border-b border-hairline">
                               <span class="text-lg font-semibold text-primary">Section ${section.label}</span>
                           </div>` 
                        : '';
                    return `<div class="mb-12">
                                ${header}
                                <div class="space-y-16">
                                    ${section.questions.map(q => renderQuestionNode(q, 0, defaultExpanded)).join('')}
                                </div>
                            </div>`;
                }).join('');
            } else if (paper.questions) {
                html = `<div class="space-y-16">
                            ${paper.questions.map(q => renderQuestionNode(q, 0, defaultExpanded)).join('')}
                        </div>`;
            }
            
            container.innerHTML = html;
        }

        function renderQuestionNode(node, depth, defaultExpanded) {
            const isExpanded = expandedState[node.id] !== undefined ? expandedState[node.id] : defaultExpanded;
            const hasSolDetails = node.solutionBlock && node.solutionBlock.solutionDetails;
            const hasAnswer = node.solutionBlock && node.solutionBlock.answer;
            
            // Indentation logic for content (Stage 3 permit: "spacing only")
            const indentClass = depth > 0 ? 'ml-4 lg:ml-8 border-l border-transparent pl-4' : '';

            // Render Parts
            const questionBody = renderMarkdown(node.question);
            
            let solutionBlockHTML = '';
            
            if (node.solutionBlock) {
                // Answer
                let answerHTML = '';
                if (hasAnswer) {
                    answerHTML = `
                        <div class="mb-4">
                            <div class="text-xs font-bold text-secondary uppercase tracking-wide mb-1">Answer</div>
                            <div class="text-primary text-base font-medium">
                                ${renderMarkdown(node.solutionBlock.answer)}
                            </div>
                        </div>
                    `;
                }

                // Solution Details Toggle + Content
                let detailsHTML = '';
                if (hasSolDetails) {
                    const btnText = isExpanded ? 'Hide working' : 'Show working';
                    const chevron = isExpanded 
                        ? `<svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/></svg>`
                        : `<svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>`;

                    const detailsContent = isExpanded ? renderSolutionDetails(node.solutionBlock.solutionDetails) : '';

                    detailsHTML = `
                        <div class="mt-4">
                            <button onclick="toggleWorking('${node.id}')" 
                                class="flex items-center text-sm font-medium text-accent hover:text-accent-hover focus:outline-none mb-3">
                                ${btnText} ${chevron}
                            </button>
                            ${isExpanded ? `<div class="mt-2 animate-fadeIn">${detailsContent}</div>` : ''}
                        </div>
                    `;
                }

                solutionBlockHTML = `
                    <div class="mt-6 pt-4 border-t border-hairline">
                        ${answerHTML}
                        ${detailsHTML}
                    </div>
                `;
            } else if (!node.children || node.children.length === 0) {
                 // No solution block and no children -> still valid
                 solutionBlockHTML = '';
            }

            // Recursive Children
            let childrenHTML = '';
            if (node.children && node.children.length > 0) {
                childrenHTML = `
                    <div class="mt-8 space-y-8">
                        ${node.children.map(c => renderQuestionNode(c, depth + 1, defaultExpanded)).join('')}
                    </div>
                `;
            }

            return `
                <div id="q-${node.id}" class="group ${indentClass}">
                    <!-- Question Body -->
                    <div class="flex items-baseline gap-3">
                        <span class="text-secondary font-medium text-sm w-8 flex-shrink-0 text-right pt-1 select-none" aria-hidden="true">${node.id}</span>
                        <div class="flex-1 min-w-0">
                            <div class="text-lg text-primary leading-relaxed prose-content">
                                ${questionBody}
                            </div>
                            
                            ${solutionBlockHTML}
                            ${childrenHTML}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderSolutionDetails(details) {
            let parts = [];

            // 1. Keep in mind
            if (details.keepInMind) {
                parts.push(`
                    <div class="mb-6">
                        <div class="flex items-center gap-2 mb-2">
                            <svg class="w-4 h-4 text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                            <span class="text-sm font-bold text-secondary">Keep in mind</span>
                        </div>
                        <div class="text-sm text-secondary leading-relaxed pl-6">
                            ${renderMarkdown(details.keepInMind)}
                        </div>
                    </div>
                `);
            }

            // 2. Formulas Used
            if (details.formulasUsed) {
                parts.push(`
                    <div class="mb-6 pl-6 border-l-2 border-hairline">
                        <div class="text-xs font-bold text-tertiary uppercase tracking-wide mb-1">Formulas used</div>
                        <div class="text-sm text-secondary font-mono">
                            ${renderMarkdown(details.formulasUsed)}
                        </div>
                    </div>
                `);
            }

            // 3. Working
            if (details.working) {
                parts.push(`
                    <div class="mb-6">
                        <div class="text-xs font-bold text-secondary uppercase tracking-wide mb-2">Working</div>
                        <div class="text-base text-primary leading-relaxed space-y-4">
                            ${renderMarkdown(details.working)}
                        </div>
                    </div>
                `);
            }

            // 4. Alternative Working
            if (details.alternativeWorking && Array.isArray(details.alternativeWorking)) {
                details.alternativeWorking.forEach((alt, idx) => {
                    parts.push(`
                        <div class="mt-8 pt-6 border-t border-hairline border-dashed">
                            <div class="text-xs font-bold text-secondary uppercase tracking-wide mb-2">Alternative working ${idx + 1}</div>
                            <div class="text-base text-primary leading-relaxed space-y-4">
                                ${renderMarkdown(alt)}
                            </div>
                        </div>
                    `);
                });
            } else if (details.alternativeWorking && typeof details.alternativeWorking === 'string') {
                 parts.push(`
                        <div class="mt-8 pt-6 border-t border-hairline border-dashed">
                            <div class="text-xs font-bold text-secondary uppercase tracking-wide mb-2">Alternative working</div>
                            <div class="text-base text-primary leading-relaxed space-y-4">
                                ${renderMarkdown(details.alternativeWorking)}
                            </div>
                        </div>
                    `);
            }

            return `<div class="bg-accent-subtle/30 rounded-sm p-4 lg:-ml-4 lg:mr-0 -mx-2">${parts.join('')}</div>`;
        }

        function renderMarkdown(text) {
            if (!text) return '';
            if (!md) return text; // Fallback
            return md.render(text);
        }

        window.toggleWorking = (id) => {
            const paper = globalPayload.papers.find(p => p.key === currentPaperKey);
            const defaultExpanded = paper.defaults?.expandedAll !== false;
            const current = expandedState[id] !== undefined ? expandedState[id] : defaultExpanded;
            
            expandedState[id] = !current;
            
            // Re-render whole paper to maintain consistent state (simple approach for vanilla prototype)
            // In a real app, we'd update just the node.
            const scrollPos = window.scrollY;
            renderPaperContent(paper, defaultExpanded);
            renderMath();
            window.scrollTo(0, scrollPos);
        }

        function renderMath() {
            if (window.renderMathInElement) {
                renderMathInElement(document.body, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false}
                    ],
                    throwOnError: false
                });
            }
        }

        // --- MOBILE DRAWER LOGIC ---
        function setupMobileDrawer() {
            const trigger = document.getElementById('mobile-menu-trigger');
            const drawer = document.getElementById('mobile-drawer');
            const backdrop = document.getElementById('drawer-backdrop');
            const panel = document.getElementById('drawer-panel');
            const closeBtn = document.getElementById('drawer-close');

            const open = () => {
                drawer.classList.remove('pointer-events-none', 'opacity-0');
                panel.classList.remove('-translate-x-full');
                document.body.style.overflow = 'hidden';
            };

            const close = () => {
                panel.classList.add('-translate-x-full');
                drawer.classList.add('opacity-0');
                setTimeout(() => {
                    drawer.classList.add('pointer-events-none');
                    document.body.style.overflow = '';
                }, 200);
            };

            trigger.addEventListener('click', open);
            closeBtn.addEventListener('click', close);
            backdrop.addEventListener('click', close);
            window.closeDrawer = close;
        }

        // Run
        init();

    </script>
</body>
</html>
