<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"A","indexWithinVariant":"28","totalWithinVariant":"50","hueFamily":"","intensityMode":"","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-08T12:26:12.133Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;A&quot;,&quot;indexWithinVariant&quot;:&quot;28&quot;,&quot;totalWithinVariant&quot;:&quot;50&quot;,&quot;hueFamily&quot;:&quot;&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-08T12:26:12.133Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        // ColorLab A Palette: Professional, Calm, Light-Mode Only
                        base: {
                            50: '#f8fafc',  // Page bg
                            100: '#f1f5f9',
                            200: '#e2e8f0', // Borders
                            300: '#cbd5e1',
                            400: '#94a3b8',
                            500: '#64748b', // Muted text
                            600: '#475569',
                            700: '#334155',
                            800: '#1e293b', // Primary text
                            900: '#0f172a',
                        },
                        accent: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            500: '#3b82f6',
                            600: '#2563eb', // Interactive
                            700: '#1d4ed8',
                        }
                    }
                }
            }
        }
    </script>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- KaTeX (SRI disabled per instructions) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Markdown-it -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        /* Scrollbar Hiding for Nav */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* KaTeX Containment Invariant */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 4px; /* Space for scrollbar if needed */
        }
        
        /* Inline KaTeX background rule: Transparent always */
        .katex {
            background-color: transparent !important;
        }

        /* Markdown Content Styling */
        .markdown-content p {
            margin-bottom: 0.75em;
            line-height: 1.6;
        }
        .markdown-content p:last-child {
            margin-bottom: 0;
        }
        .markdown-content ul {
            list-style-type: disc;
            padding-left: 1.25em;
            margin-bottom: 0.75em;
        }
        .markdown-content ol {
            list-style-type: decimal;
            padding-left: 1.25em;
            margin-bottom: 0.75em;
        }
        /* Tables: Minimal, structural */
        .markdown-content table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1em;
            font-size: 0.95em;
        }
        .markdown-content th, .markdown-content td {
            border: 1px solid #e2e8f0; /* base-200 */
            padding: 0.5em 0.75em;
            text-align: left;
        }
        .markdown-content th {
            font-weight: 600;
            color: #1e293b; /* base-800 */
        }
        /* Markdown SVG/Img Passthrough */
        .markdown-content img, .markdown-content svg {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 1em 0;
        }

        /* Base styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* base-50 */
            color: #1e293b; /* base-800 */
            -webkit-font-smoothing: antialiased;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script>
        // --- STAGE 0: CONSTANTS ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useLayoutEffect } = React;
        const { Menu, X, ChevronDown, ChevronRight, Check } = lucide;

        // --- MARKDOWN & KATEX SETUP ---
        // Initialize markdown-it exactly as requested in add-on
        const md = window.markdownit
            ? window.markdownit({
                html: true, // allow inline SVG and other inline HTML
                linkify: true,
                breaks: false, // MUST stay false
            })
            : null;

        if (md) {
            // Preserve TeX backslashes
            md.inline.ruler.disable(["escape"]);
        }

        // --- UTILITY COMPONENTS ---

        const MarkdownContent = ({ content, className = "" }) => {
            const containerRef = useRef(null);

            const htmlContent = useMemo(() => {
                if (!md || !content) return "";
                return md.render(content);
            }, [content]);

            useLayoutEffect(() => {
                if (containerRef.current && window.renderMathInElement) {
                    window.renderMathInElement(containerRef.current, {
                        delimiters: [
                            { left: "$$", right: "$$", display: true },
                            { left: "$", right: "$", display: false }
                        ],
                        throwOnError: false,
                        trust: true // Allow HTML in Math if needed, though mostly for KaTeX internals
                    });
                }
            }, [htmlContent]);

            if (!content) return null;

            return (
                <div 
                    ref={containerRef}
                    className={`markdown-content ${className}`}
                    dangerouslySetInnerHTML={{ __html: htmlContent }}
                />
            );
        };

        const Separator = ({ className = "" }) => (
            <div className={`h-px bg-base-200 w-full ${className}`} aria-hidden="true" />
        );

        // --- CORE COMPONENTS ---

        const SolutionDetails = ({ details }) => {
            // Internal order: Keep in mind -> Formulas used -> Working -> Alternative working
            const { keepInMind, formulasUsed, working, alternativeWorking } = details;

            return (
                <div className="mt-4 space-y-6 text-base-800">
                    {/* Keep in mind */}
                    {keepInMind && (
                        <div className="space-y-2">
                            <h4 className="text-sm font-bold text-base-800">Keep in mind</h4>
                            <MarkdownContent content={keepInMind} className="text-base text-base-700" />
                        </div>
                    )}

                    {/* Formulas used */}
                    {formulasUsed && (
                        <div className="space-y-2">
                            <h4 className="text-sm font-bold text-base-800">Formulas used</h4>
                            <MarkdownContent content={formulasUsed} className="text-sm text-base-600" />
                        </div>
                    )}

                    {/* Working (Primary) */}
                    {working && (
                        <div className="space-y-2">
                            <h4 className="text-sm font-bold text-base-800">Working</h4>
                            <MarkdownContent content={working} className="text-base" />
                        </div>
                    )}

                    {/* Alternative Working */}
                    {alternativeWorking && Array.isArray(alternativeWorking) && alternativeWorking.map((alt, idx) => (
                        <div key={idx} className="space-y-2 pt-4 border-t border-base-200">
                            <h4 className="text-sm font-bold text-base-800">Alternative working</h4>
                            <MarkdownContent content={alt} className="text-base" />
                        </div>
                    ))}
                </div>
            );
        };

        const QuestionNode = ({ node, defaults, level = 0 }) => {
            // Default expansion logic: paper defaults or true
            const [isExpanded, setIsExpanded] = useState(defaults?.expandedAll ?? true);
            
            const hasSolutionBlock = !!node.solutionBlock;
            const hasAnswer = hasSolutionBlock && !!node.solutionBlock.answer;
            const hasSolutionDetails = hasSolutionBlock && !!node.solutionBlock.solutionDetails;

            // Derived styles for nesting - indentation for CHILDREN only
            const nestingClass = level > 0 ? "ml-4 md:ml-8 border-l-2 border-base-100 pl-4" : "";

            return (
                <div id={node.id} className={`scroll-mt-24 ${level === 0 ? "mb-16" : "mt-8"} ${nestingClass} group`}>
                    {/* QUESTION BODY */}
                    <div className="flex flex-col gap-2">
                        <div className="text-sm font-medium text-base-500 select-none">
                            {node.id}
                        </div>
                        <div className="text-base md:text-lg font-medium text-base-900">
                            <MarkdownContent content={node.question} />
                        </div>
                    </div>

                    {/* SOLUTION BLOCK (Optional) */}
                    {hasSolutionBlock && (
                        <div className="mt-4 pl-0">
                            {/* Answer */}
                            {hasAnswer && (
                                <div className="mb-4">
                                    <div className="text-xs font-bold uppercase tracking-wider text-base-500 mb-1">
                                        Answer
                                    </div>
                                    <div className="text-base text-base-800 font-medium">
                                        <MarkdownContent content={node.solutionBlock.answer} />
                                    </div>
                                </div>
                            )}

                            {/* Solution Details Toggle & Region */}
                            {hasSolutionDetails && (
                                <div className="mt-4">
                                    <button 
                                        onClick={() => setIsExpanded(!isExpanded)}
                                        className="flex items-center gap-2 text-sm font-medium text-accent-600 hover:text-accent-700 focus:outline-none focus-visible:ring-2 focus-visible:ring-accent-500 rounded px-1 -ml-1 py-1 transition-colors"
                                        aria-expanded={isExpanded}
                                    >
                                        <span className="text-xs">{isExpanded ? "Hide working" : "Show working"}</span>
                                        {isExpanded ? <ChevronDown size={14} /> : <ChevronRight size={14} />}
                                    </button>

                                    {isExpanded && (
                                        <div className="mt-2 pl-0 md:pl-0">
                                            {/* Optional wash surface for solution details */}
                                            <div className="relative">
                                                {/* Very subtle marker/border to delineate region if density is high, per Stage 3 options */}
                                                <div className="absolute left-0 top-0 bottom-0 w-0.5 bg-accent-100 hidden"></div> 
                                                <SolutionDetails details={node.solutionBlock.solutionDetails} />
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    )}

                    {/* CHILDREN RECURSION */}
                    {node.children && node.children.length > 0 && (
                        <div className="mt-4">
                            {node.children.map((child, idx) => (
                                <QuestionNode 
                                    key={`${child.id}-${idx}`} 
                                    node={child} 
                                    defaults={defaults} 
                                    level={level + 1} 
                                />
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        const SectionBlock = ({ section, defaults }) => {
            const hasLabel = section.label && section.label.trim().length > 0;
            return (
                <div className="mb-16">
                    {hasLabel && (
                        <div className="mb-8 border-b border-base-200 pb-2">
                            <h2 className="text-xl font-bold text-base-900">Section {section.label}</h2>
                        </div>
                    )}
                    <div>
                        {section.questions.map((q, idx) => (
                            <QuestionNode key={`${q.id}-${idx}`} node={q} defaults={defaults} />
                        ))}
                    </div>
                </div>
            );
        };

        const NavigationItem = ({ id, isActive, onClick }) => {
            return (
                <button
                    onClick={() => onClick(id)}
                    className={`block w-full text-left py-1 px-3 text-sm rounded transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-accent-500
                        ${isActive 
                            ? "font-bold text-accent-700 bg-accent-50/50" 
                            : "font-normal text-base-500 hover:text-base-800 hover:bg-base-100"
                        }`}
                >
                    {id}
                </button>
            );
        }

        const NavigationList = ({ items, activeId, onJump }) => {
            // items is a flat list of { id, label, isSection, depth } 
            // derived from payload structure for rendering flat list
            
            return (
                <nav className="space-y-1" aria-label="Question navigation">
                    {items.map((item, idx) => {
                        if (item.isSection) {
                            return (
                                <div key={`sec-${idx}`} className="pt-4 pb-1 px-3">
                                    <span className="text-xs font-bold text-base-400 uppercase tracking-wider">
                                        Section {item.label}
                                    </span>
                                </div>
                            );
                        }
                        
                        // Hierarchy via type scale / quietness (Stage 5.4.5)
                        // Depth 0: Standard
                        // Depth > 0: Slightly smaller/quieter
                        const isSub = item.depth > 0;
                        const fontSize = isSub ? "text-xs" : "text-sm";
                        
                        return (
                            <div key={item.id} className=""> 
                                <button
                                    onClick={() => onJump(item.id)}
                                    className={`block w-full text-left py-1.5 px-3 rounded transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-accent-500
                                        ${fontSize}
                                        ${item.id === activeId 
                                            ? "font-bold text-accent-700 bg-accent-50" 
                                            : "font-normal text-base-500 hover:text-base-800 hover:bg-base-100"
                                        }
                                        `}
                                >
                                    {item.id}
                                </button>
                            </div>
                        );
                    })}
                </nav>
            );
        };

        // --- SHELL & LAYOUT ---

        const App = () => {
            const [status, setStatus] = useState("loading"); // loading | success | error
            const [payload, setPayload] = useState(null);
            const [currentPaperKey, setCurrentPaperKey] = useState(null);
            const [isDrawerOpen, setIsDrawerOpen] = useState(false);
            const [activeQuestionId, setActiveQuestionId] = useState(null);

            // Fetch Payload
            useEffect(() => {
                fetch(RTQ_PAPERS_PAYLOAD_PATH)
                    .then(res => {
                        if (!res.ok) throw new Error("Failed to load");
                        return res.json();
                    })
                    .then(data => {
                        setPayload(data);
                        if (data.papers && data.papers.length > 0) {
                            setCurrentPaperKey(data.papers[0].key);
                        }
                        setStatus("success");
                    })
                    .catch(err => {
                        console.error(err);
                        setStatus("error");
                    });
            }, []);

            // Scroll Spy for Active Question
            useEffect(() => {
                if (status !== 'success') return;

                const handleScroll = () => {
                    const questionElements = document.querySelectorAll('[id]'); 
                    // Filter to likely question IDs (heuristic or class based would be better but ID is robust enough for prototype)
                    let currentId = null;
                    
                    for (let el of questionElements) {
                        const rect = el.getBoundingClientRect();
                        if (rect.top >= 0 && rect.top < window.innerHeight / 2) {
                            currentId = el.id;
                            break; // First one in view
                        }
                    }
                    if (currentId) setActiveQuestionId(currentId);
                };

                window.addEventListener('scroll', handleScroll, { passive: true });
                return () => window.removeEventListener('scroll', handleScroll);
            }, [status, currentPaperKey]);

            // Derived Data
            const currentPaper = useMemo(() => {
                if (!payload || !currentPaperKey) return null;
                return payload.papers.find(p => p.key === currentPaperKey);
            }, [payload, currentPaperKey]);

            const navItems = useMemo(() => {
                if (!currentPaper) return [];
                const items = [];
                
                // Helper to flatten questions
                const traverse = (qs, depth = 0) => {
                    qs.forEach(q => {
                        items.push({ id: q.id, depth, isSection: false });
                        if (q.children) traverse(q.children, depth + 1);
                    });
                };

                if (currentPaper.sections) {
                    currentPaper.sections.forEach(sec => {
                        if (sec.label) {
                            items.push({ label: sec.label, isSection: true });
                        }
                        traverse(sec.questions);
                    });
                } else if (currentPaper.questions) {
                    traverse(currentPaper.questions);
                }
                return items;
            }, [currentPaper]);

            const handleJump = (id) => {
                const el = document.getElementById(id);
                if (el) {
                    el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    setActiveQuestionId(id);
                    setIsDrawerOpen(false);
                }
            };

            if (status === "loading") {
                return <div className="min-h-screen flex items-center justify-center text-base-400 font-medium">Loading Prototype...</div>;
            }

            if (status === "error" || !currentPaper) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-base-50">
                        <div className="bg-white p-8 border border-base-200 shadow-sm rounded max-w-md text-center">
                            <h1 className="text-red-600 font-bold mb-2">PAPERS PAYLOAD MISSING</h1>
                            <p className="text-base-500 text-sm">
                                Could not load payload from <code className="bg-base-100 px-1 py-0.5 rounded text-xs">{RTQ_PAPERS_PAYLOAD_PATH}</code>
                            </p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-base-50 flex flex-col">
                    {/* TOP CONTROLS */}
                    <header className="sticky top-0 z-20 bg-base-50/95 backdrop-blur border-b border-base-200">
                        <div className="max-w-7xl mx-auto px-4 md:px-8 h-14 flex items-center justify-between">
                            <div className="flex items-center gap-4">
                                {/* Paper Selector */}
                                <div className="relative">
                                    <select 
                                        value={currentPaperKey}
                                        onChange={(e) => setCurrentPaperKey(e.target.value)}
                                        className="appearance-none bg-white border border-base-300 text-base-900 text-sm rounded pl-3 pr-8 py-1.5 focus:outline-none focus:ring-2 focus:ring-accent-500 shadow-sm font-medium"
                                    >
                                        {payload.papers.map(p => (
                                            <option key={p.key} value={p.key}>{p.label}</option>
                                        ))}
                                    </select>
                                    <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-base-500">
                                        <ChevronDown size={14} />
                                    </div>
                                </div>
                            </div>
                            
                            {/* Mobile Jump Trigger */}
                            <button 
                                className="md:hidden flex items-center gap-2 text-sm font-medium text-accent-600 hover:text-accent-700"
                                onClick={() => setIsDrawerOpen(true)}
                            >
                                <span>Jump to</span>
                                <Menu size={18} />
                            </button>
                        </div>
                    </header>

                    {/* MAIN SHELL */}
                    <div className="flex-1 max-w-7xl mx-auto w-full flex items-start">
                        
                        {/* DESKTOP NAV RAIL */}
                        <aside className="hidden md:block w-64 sticky top-14 h-[calc(100vh-3.5rem)] overflow-y-auto no-scrollbar border-r border-transparent pr-4 py-8">
                            <div className="mb-4 px-3 text-xs font-bold text-base-400 uppercase tracking-widest">Questions</div>
                            <NavigationList items={navItems} activeId={activeQuestionId} onJump={handleJump} />
                        </aside>

                        {/* PAPER CONTENT */}
                        <main className="flex-1 min-w-0 px-4 md:px-12 py-8 md:py-12 bg-base-50">
                            {/* Render based on flat vs sectioned */}
                            <div className="max-w-3xl mx-auto bg-white shadow-sm border border-base-200 rounded-lg p-8 md:p-12 min-h-[80vh]">
                                {currentPaper.sections ? (
                                    currentPaper.sections.map((sec, idx) => (
                                        <SectionBlock key={idx} section={sec} defaults={currentPaper.defaults} />
                                    ))
                                ) : (
                                    currentPaper.questions.map((q, idx) => (
                                        <QuestionNode key={`${q.id}-${idx}`} node={q} defaults={currentPaper.defaults} />
                                    ))
                                )}
                                
                                <div className="mt-24 pt-8 border-t border-base-100 text-center text-base-400 text-sm">
                                    End of Paper
                                </div>
                            </div>
                        </main>
                    </div>

                    {/* MOBILE DRAWER */}
                    {isDrawerOpen && (
                        <div className="fixed inset-0 z-50 flex md:hidden">
                            {/* Scrim */}
                            <div 
                                className="absolute inset-0 bg-base-900/20 backdrop-blur-sm"
                                onClick={() => setIsDrawerOpen(false)}
                            />
                            {/* Drawer Content */}
                            <div className="relative bg-white w-64 max-w-[80vw] h-full shadow-xl flex flex-col animate-in slide-in-from-left duration-200">
                                <div className="h-14 flex items-center justify-between px-4 border-b border-base-200">
                                    <span className="font-bold text-base-800">Jump to</span>
                                    <button onClick={() => setIsDrawerOpen(false)} className="text-base-500 hover:text-base-900">
                                        <X size={20} />
                                    </button>
                                </div>
                                <div className="flex-1 overflow-y-auto p-4">
                                    <NavigationList items={navItems} activeId={activeQuestionId} onJump={handleJump} />
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
