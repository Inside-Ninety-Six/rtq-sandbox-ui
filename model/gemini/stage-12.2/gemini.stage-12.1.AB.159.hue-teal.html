<!DOCTYPE html>
<html lang="en" class="antialiased">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AB","indexWithinVariant":"159","totalWithinVariant":"200","hueFamily":"teal","intensityMode":"","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-08T20:24:51.251Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AB&quot;,&quot;indexWithinVariant&quot;:&quot;159&quot;,&quot;totalWithinVariant&quot;:&quot;200&quot;,&quot;hueFamily&quot;:&quot;teal&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-08T20:24:51.251Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- KaTeX CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <script>
        // CONFIG: ColorLab B (Teal) + Light Mode Only
        tailwind.config = {
            darkMode: 'class', // Manual toggle only, we will enforce 'light'
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        // Semantic Palette (Teal Hue Family + Warm Neutrals)
                        page: '#FAFAF9', // Warm Gray 50
                        surface: '#FFFFFF',
                        
                        // Text Levels
                        primary: '#1C1917', // Stone 900
                        secondary: '#44403C', // Stone 700
                        tertiary: '#78716C', // Stone 500
                        quaternary: '#A8A29E', // Stone 400

                        // Accent (Teal)
                        accent: {
                            DEFAULT: '#0D9488', // Teal 600
                            hover: '#0F766E',   // Teal 700
                            light: '#F0FDFA',   // Teal 50
                            focus: '#14B8A6',   // Teal 500
                        },

                        // Borders
                        border: {
                            DEFAULT: '#E7E5E4', // Stone 200
                            hairline: '#F5F5F4', // Stone 100
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* BASE & RESET */
        body {
            background-color: theme('colors.page');
            color: theme('colors.primary');
        }

        /* SCROLLBAR UTILITIES */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* KATEX CONTAINMENT INVARIANT */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            padding-block: 0.25rem;
            max-width: 100%;
            -webkit-overflow-scrolling: touch;
        }
        /* Inline KaTeX background rule */
        .katex { background-color: transparent !important; }

        /* FOCUS VISIBILITY (Accent) */
        :focus-visible {
            outline: 2px solid theme('colors.accent.focus');
            outline-offset: 2px;
        }

        /* TYPOGRAPHY UTILS */
        .prose p { margin-bottom: 0.75em; line-height: 1.6; }
        .prose p:last-child { margin-bottom: 0; }
        .prose ul { list-style-type: disc; padding-left: 1.25em; margin-bottom: 0.75em; }
        .prose ol { list-style-type: decimal; padding-left: 1.25em; margin-bottom: 0.75em; }
        
        /* TABLE STYLING */
        .prose table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95em;
            margin-bottom: 1em;
        }
        .prose th, .prose td {
            border: 1px solid theme('colors.border.DEFAULT');
            padding: 0.5rem;
            text-align: left;
        }
        .prose th { font-weight: 600; background-color: theme('colors.surface'); }

        /* NAVIGATION STICKY */
        .nav-sticky-col {
            position: sticky;
            top: 0;
            max-height: 100vh; /* Will be adjusted by JS based on header */
            overflow-y: auto;
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-sm md:text-base">

    <!-- TOP CONTROLS REGION -->
    <header id="top-controls" class="flex-none bg-page z-20 border-b border-border-hairline">
        <div class="max-w-7xl mx-auto px-4 md:px-8 h-16 flex items-center justify-between">
            
            <!-- Paper Selector -->
            <div class="flex items-center gap-3">
                <label for="paper-select" class="sr-only">Select Paper</label>
                <select id="paper-select" class="bg-surface border border-border rounded px-3 py-1.5 text-secondary text-sm font-medium focus:border-accent focus:ring-1 focus:ring-accent transition-colors">
                    <option disabled selected>Loading papers...</option>
                </select>
            </div>

            <!-- Mobile Jump To Trigger -->
            <button id="mobile-jump-trigger" class="md:hidden text-accent font-medium text-sm flex items-center gap-1 hover:text-accent-hover transition-colors">
                <span>Jump to</span>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
        </div>
    </header>

    <!-- MAIN SCROLLABLE REGION -->
    <div id="main-scroll" class="flex-1 overflow-y-auto scroll-smooth">
        <!-- DOCUMENT FRAME SHELL -->
        <div class="max-w-7xl mx-auto min-h-full flex relative">
            
            <!-- DESKTOP NAVIGATION RAIL (Column 1) -->
            <nav id="desktop-nav" class="hidden md:block w-48 lg:w-64 flex-none border-r border-border-hairline bg-page nav-sticky-col py-8 pr-6 pl-8">
                <ul id="nav-list-desktop" class="space-y-1">
                    <!-- Injected via JS -->
                </ul>
            </nav>

            <!-- PAPER CONTENT COLUMN (Column 2) -->
            <main id="paper-content" class="flex-1 w-full min-w-0 bg-page py-8 px-4 md:px-12 lg:px-16">
                <div id="paper-render-target" class="max-w-3xl mx-auto pb-32">
                    <!-- Injected via JS -->
                    <div class="flex items-center justify-center h-32 text-tertiary">
                        Loading paper content...
                    </div>
                </div>
            </main>

        </div>
    </div>

    <!-- MOBILE DRAWER -->
    <div id="mobile-drawer-backdrop" class="fixed inset-0 bg-primary/20 backdrop-blur-sm z-40 hidden transition-opacity opacity-0" aria-hidden="true"></div>
    <div id="mobile-drawer" class="fixed inset-y-0 right-0 w-64 bg-surface z-50 shadow-xl transform translate-x-full transition-transform duration-300 flex flex-col" aria-hidden="true">
        <div class="flex items-center justify-between p-4 border-b border-border">
            <h2 class="font-semibold text-primary">Jump to</h2>
            <button id="drawer-close" class="text-tertiary hover:text-primary p-2">
                <span class="sr-only">Close navigation</span>
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <nav class="flex-1 overflow-y-auto p-4">
            <ul id="nav-list-mobile" class="space-y-2">
                <!-- Injected via JS -->
            </ul>
        </nav>
    </div>

    <script>
        // --- STAGE 0: CONSTANTS ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // --- RUNTIME STATE ---
        const state = {
            papers: [],
            activePaperKey: null,
            expandedNodes: new Set(), // questionId -> boolean
            currentObservedId: null
        };

        // --- MARKDOWN SETUP ---
        const md = window.markdownit ? window.markdownit({
            html: true,
            linkify: true,
            breaks: false, // Critical invariant
        }) : null;

        if (md) {
            md.inline.ruler.disable(['escape']);
        }

        // --- DOM ELEMENTS ---
        const els = {
            paperSelect: document.getElementById('paper-select'),
            renderTarget: document.getElementById('paper-render-target'),
            desktopNavList: document.getElementById('nav-list-desktop'),
            mobileNavList: document.getElementById('nav-list-mobile'),
            mobileJumpTrigger: document.getElementById('mobile-jump-trigger'),
            mobileDrawer: document.getElementById('mobile-drawer'),
            drawerBackdrop: document.getElementById('mobile-drawer-backdrop'),
            drawerClose: document.getElementById('drawer-close'),
            mainScroll: document.getElementById('main-scroll')
        };

        // --- INITIALIZATION ---
        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Fetch failed");
                const payload = await response.json();
                
                if (!payload.papers || !Array.isArray(payload.papers)) throw new Error("Invalid schema");
                
                state.papers = payload.papers;
                renderPaperSelector();
                
                // Select first paper by default
                if (state.papers.length > 0) {
                    switchPaper(state.papers[0].key);
                }
            } catch (e) {
                console.error(e);
                els.renderTarget.innerHTML = `
                    <div class="text-center py-20">
                        <h2 class="text-xl font-semibold text-primary mb-2">PAPERS PAYLOAD MISSING</h2>
                        <p class="text-tertiary">Could not load content from ${RTQ_PAPERS_PAYLOAD_PATH}</p>
                    </div>
                `;
                els.paperSelect.innerHTML = '<option disabled>Error loading papers</option>';
            }
        }

        function renderPaperSelector() {
            els.paperSelect.innerHTML = state.papers.map(p => 
                `<option value="${p.key}">${p.label}</option>`
            ).join('');
            
            els.paperSelect.addEventListener('change', (e) => {
                switchPaper(e.target.value);
            });
        }

        function switchPaper(key) {
            const paper = state.papers.find(p => p.key === key);
            if (!paper) return;

            state.activePaperKey = key;
            
            // Set defaults
            state.expandedNodes.clear();
            const expandAll = paper.defaults?.expandedAll !== false; // Default true unless false
            // Note: We don't pre-fill the Set, we just treat missing as 'default' during render

            renderPaperContent(paper);
            renderNavigation(paper);
            
            // Reset Scroll
            els.mainScroll.scrollTop = 0;
            
            // Render Math
            renderMathInElement(els.renderTarget, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false}
                ],
                throwOnError: false
            });

            setupIntersectionObserver();
        }

        // --- CONTENT RENDERING ---

        function renderPaperContent(paper) {
            let html = '';

            // Handle Sections or Flat Questions
            if (paper.sections) {
                paper.sections.forEach(section => {
                    if (section.label && section.label.trim().length > 0) {
                        html += `
                            <div class="mb-8 pt-4 border-b border-border-hairline pb-2">
                                <span class="text-tertiary font-medium text-sm tracking-wide uppercase">${section.label}</span>
                            </div>
                        `;
                    }
                    html += `<div class="space-y-12">`; // Spacing between top-level
                    section.questions.forEach(q => {
                        html += renderQuestionNode(q, 0);
                    });
                    html += `</div>`;
                    html += `<div class="h-16"></div>`; // Spacing between sections
                });
            } else if (paper.questions) {
                html += `<div class="space-y-16">`; // Top level spacing
                paper.questions.forEach(q => {
                    html += renderQuestionNode(q, 0);
                });
                html += `</div>`;
            }

            els.renderTarget.innerHTML = html;
        }

        function renderQuestionNode(node, depth) {
            const hasSolutionBlock = !!node.solutionBlock;
            const hasAnswer = hasSolutionBlock && !!node.solutionBlock.answer;
            const hasDetails = hasSolutionBlock && !!node.solutionBlock.solutionDetails;
            
            // ID for navigation anchoring
            const anchorId = `q-${node.id}`;

            // Check expansion state
            const paper = state.papers.find(p => p.key === state.activePaperKey);
            const defaultExpanded = paper.defaults?.expandedAll !== false;
            // If explicit state set, use it. Else default.
            const isExpanded = state.expandedNodes.has(node.id) ? state.expandedNodes.get(node.id) : defaultExpanded;

            let html = `
                <article id="${anchorId}" class="group relative question-node" data-qid="${node.id}">
                    <!-- Question Body -->
                    <div class="mb-4">
                        <div class="flex items-baseline gap-3 md:gap-4">
                            <span class="flex-none text-tertiary font-semibold select-none text-base md:text-lg w-8 md:w-10 text-right font-sans" aria-hidden="true">${node.id}</span>
                            <div class="flex-1 min-w-0">
                                <div class="prose text-primary text-base md:text-lg leading-relaxed">
                                    ${renderMarkdown(node.question)}
                                </div>
                            </div>
                        </div>
                    </div>
            `;

            if (hasSolutionBlock) {
                html += `<div class="ml-11 md:ml-14 space-y-4">`;

                // Answer
                if (hasAnswer) {
                    html += `
                        <div class="relative">
                            <h3 class="text-xs font-bold text-quaternary uppercase tracking-wider mb-1">Answer</h3>
                            <div class="prose text-secondary font-medium">
                                ${renderMarkdown(node.solutionBlock.answer)}
                            </div>
                        </div>
                    `;
                }

                // Solution Details
                if (hasDetails) {
                    const details = node.solutionBlock.solutionDetails;
                    const expandedClass = isExpanded ? '' : 'hidden';
                    const labelText = isExpanded ? 'Hide working' : 'Show working';
                    
                    html += `
                        <div class="pt-2">
                            <button onclick="toggleWorking('${node.id}')" 
                                class="text-accent hover:text-accent-hover font-medium text-sm flex items-center gap-1 focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-1 rounded px-1 -ml-1 transition-colors"
                                aria-expanded="${isExpanded}" aria-controls="details-${node.id}">
                                <span>${labelText}</span>
                                <svg class="w-4 h-4 transform transition-transform ${isExpanded ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </button>

                            <div id="details-${node.id}" class="${expandedClass} mt-4 space-y-6 border-l border-border-hairline pl-4 md:pl-6 pb-2">
                    `;

                    // Details subsections order: Keep in mind -> Formulas -> Working -> Alternative
                    
                    // Keep in Mind
                    if (details.keepInMind) {
                        html += `
                            <div class="space-y-1">
                                <h4 class="text-xs font-bold text-accent uppercase tracking-wider flex items-center gap-2">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                    Keep in mind
                                </h4>
                                <div class="prose text-secondary text-sm">
                                    ${renderMarkdown(details.keepInMind)}
                                </div>
                            </div>
                        `;
                    }

                    // Formulas
                    if (details.formulasUsed) {
                         html += `
                            <div class="space-y-1">
                                <h4 class="text-xs font-bold text-quaternary uppercase tracking-wider">Formulas used</h4>
                                <div class="prose text-tertiary text-sm">
                                    ${renderMarkdown(details.formulasUsed)}
                                </div>
                            </div>
                        `;
                    }

                    // Working
                    if (details.working) {
                        html += `
                            <div class="space-y-2">
                                <h4 class="text-xs font-bold text-quaternary uppercase tracking-wider">Working</h4>
                                <div class="prose text-secondary text-sm leading-relaxed">
                                    ${renderMarkdown(details.working)}
                                </div>
                            </div>
                        `;
                    }

                    // Alternative Working
                    if (details.alternativeWorking && Array.isArray(details.alternativeWorking)) {
                        details.alternativeWorking.forEach((alt, idx) => {
                             html += `
                                <div class="pt-4 mt-2 border-t border-border-hairline space-y-2">
                                    <h4 class="text-xs font-bold text-quaternary uppercase tracking-wider">Alternative working</h4>
                                    <div class="prose text-secondary text-sm leading-relaxed">
                                        ${renderMarkdown(alt)}
                                    </div>
                                </div>
                            `;
                        });
                    }

                    html += `</div></div>`; // End details container & wrapper
                }
                html += `</div>`; // End solution block wrapper
            }

            // Children
            if (node.children && node.children.length > 0) {
                html += `<div class="mt-6 md:mt-8 space-y-6 md:space-y-8 pl-0">`; // Flat nesting visually, structure only
                node.children.forEach(child => {
                    html += renderQuestionNode(child, depth + 1);
                });
                html += `</div>`;
            }

            html += `</article>`;
            return html;
        }

        // --- NAVIGATION RENDERING ---

        function renderNavigation(paper) {
            // Helper to flatten questions for nav list
            const items = [];
            
            if (paper.sections) {
                paper.sections.forEach(section => {
                    if (section.label) items.push({ type: 'section', label: section.label });
                    section.questions.forEach(q => collectNavItems(q, items));
                });
            } else if (paper.questions) {
                paper.questions.forEach(q => collectNavItems(q, items));
            }

            const desktopHTML = items.map(item => renderNavItem(item, false)).join('');
            const mobileHTML = items.map(item => renderNavItem(item, true)).join('');

            els.desktopNavList.innerHTML = desktopHTML;
            els.mobileNavList.innerHTML = mobileHTML;
        }

        function collectNavItems(node, list) {
            list.push({ type: 'question', id: node.id });
            if (node.children) {
                node.children.forEach(child => collectNavItems(child, list));
            }
        }

        function renderNavItem(item, isMobile) {
            if (item.type === 'section') {
                return `
                    <li class="pt-4 pb-1">
                        <span class="text-xs font-semibold text-tertiary uppercase tracking-wider px-2 block border-b border-border-hairline mb-1">${item.label}</span>
                    </li>
                `;
            }
            
            // Hierarchy via font-size/color, flat alignment (ColorLab: Teal accent on active)
            // Active class will be applied by IntersectionObserver logic via 'data-nav-id'
            return `
                <li>
                    <a href="#q-${item.id}" 
                       data-nav-id="${item.id}"
                       onclick="handleNavClick(event, '${item.id}', ${isMobile})"
                       class="nav-link block px-2 py-1 text-sm text-tertiary hover:text-primary transition-colors border-l-2 border-transparent hover:border-border rounded-r-md">
                       ${item.id}
                    </a>
                </li>
            `;
        }

        // --- INTERACTION HANDLERS ---

        window.toggleWorking = function(nodeId) {
            // Toggle state
            const paper = state.papers.find(p => p.key === state.activePaperKey);
            const defaultExpanded = paper.defaults?.expandedAll !== false;
            const currentState = state.expandedNodes.has(nodeId) ? state.expandedNodes.get(nodeId) : defaultExpanded;
            
            state.expandedNodes.set(nodeId, !currentState);
            
            // DOM Update (preserving scroll/layout as much as possible)
            // We re-render the button and the region text/visibility
            const button = document.querySelector(`button[onclick="toggleWorking('${nodeId}')"]`);
            const region = document.getElementById(`details-${nodeId}`);
            
            if (button && region) {
                const newState = !currentState;
                const labelSpan = button.querySelector('span');
                const icon = button.querySelector('svg');
                
                labelSpan.textContent = newState ? 'Hide working' : 'Show working';
                button.setAttribute('aria-expanded', newState);
                
                if (newState) {
                    region.classList.remove('hidden');
                    icon.classList.add('rotate-180');
                    // Re-render math if hidden content wasn't rendered? 
                    // KaTeX auto-render usually catches things on load, but invisible elements might need care?
                    // Auto-render runs on document load. If content was in DOM but hidden, it is rendered.
                    // So just unhiding is fine.
                } else {
                    region.classList.add('hidden');
                    icon.classList.remove('rotate-180');
                }
            }
        };

        window.handleNavClick = function(e, id, isMobile) {
            e.preventDefault();
            const target = document.getElementById(`q-${id}`);
            if (target) {
                // Scroll into view
                // Desktop: Main Scroll. Mobile: Window/Body (actually Main Scroll too due to h-screen layout)
                
                // Calculate offset for fixed header
                const headerOffset = 80; // slightly more than 64px
                const elementPosition = target.getBoundingClientRect().top;
                const offsetPosition = elementPosition + els.mainScroll.scrollTop - headerOffset;

                els.mainScroll.scrollTo({
                    top: offsetPosition,
                    behavior: "smooth"
                });

                if (isMobile) {
                    closeDrawer();
                }
            }
        };

        // --- DRAWER LOGIC ---
        function openDrawer() {
            els.mobileDrawer.classList.remove('translate-x-full');
            els.drawerBackdrop.classList.remove('hidden');
            // small delay to allow display:block to apply before opacity transition
            setTimeout(() => els.drawerBackdrop.classList.remove('opacity-0'), 10);
            document.body.style.overflow = 'hidden';
        }

        function closeDrawer() {
            els.mobileDrawer.classList.add('translate-x-full');
            els.drawerBackdrop.classList.add('opacity-0');
            setTimeout(() => els.drawerBackdrop.classList.add('hidden'), 300);
            document.body.style.overflow = '';
        }

        els.mobileJumpTrigger.addEventListener('click', openDrawer);
        els.drawerClose.addEventListener('click', closeDrawer);
        els.drawerBackdrop.addEventListener('click', closeDrawer);

        // --- UTILS ---
        function renderMarkdown(text) {
            if (!text) return '';
            return md.render(text);
        }

        // --- SCROLL SPY (INTERSECTION OBSERVER) ---
        function setupIntersectionObserver() {
            const options = {
                root: els.mainScroll,
                rootMargin: '-10% 0px -80% 0px', // Active zone near top
                threshold: 0
            };

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        updateActiveNav(entry.target.getAttribute('data-qid'));
                    }
                });
            }, options);

            document.querySelectorAll('.question-node').forEach(node => {
                observer.observe(node);
            });
        }

        function updateActiveNav(id) {
            if (state.currentObservedId === id) return;
            state.currentObservedId = id;

            // Remove active class from all
            document.querySelectorAll('.nav-link').forEach(el => {
                // Reset to default
                el.classList.remove('text-primary', 'font-semibold', 'border-accent');
                el.classList.add('text-tertiary', 'border-transparent');
            });

            // Add active class to current
            const activeLinks = document.querySelectorAll(`[data-nav-id="${id}"]`);
            activeLinks.forEach(link => {
                link.classList.remove('text-tertiary', 'border-transparent');
                link.classList.add('text-primary', 'font-semibold', 'border-accent');
            });
        }

        // --- BOOT ---
        init();

    </script>
</body>
</html>
