<!DOCTYPE html>
<html lang="en" class="antialiased text-stone-900 bg-stone-50">
  <head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AB","indexWithinVariant":"28","totalWithinVariant":"200","hueFamily":"red","intensityMode":"","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-08T14:41:05.768Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AB&quot;,&quot;indexWithinVariant&quot;:&quot;28&quot;,&quot;totalWithinVariant&quot;:&quot;200&quot;,&quot;hueFamily&quot;:&quot;red&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-08T14:41:05.768Z&quot;}'>

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RTQ Maths Paper Solution Viewer (Stage 6)</title>

    <!-- 1. KaTeX CSS (No integrity, CDN) -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"
    />

    <!-- 2. Tailwind CSS (Script-based for config) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 3. React & ReactDOM -->
    <script
      src="https://unpkg.com/react@18/umd/react.development.js"
      crossorigin
    ></script>
    <script
      src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"
      crossorigin
    ></script>

    <!-- 4. Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 5. Markdown-it -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <!-- 6. KaTeX JS (No integrity) -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- 7. Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
      /* Utility: Hide Scrollbar but keep functionality */
      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .no-scrollbar {
        -ms-overflow-style: none; /* IE and Edge */
        scrollbar-width: none; /* Firefox */
      }

      /* KaTeX Containment Invariant */
      .katex-display {
        overflow-x: auto !important;
        overflow-y: hidden !important;
        max-width: 100% !important;
        padding-top: 0.25em;
        padding-bottom: 0.25em;
        -webkit-overflow-scrolling: touch;
      }
      
      /* Base Typography Adjustments */
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
      }

      /* Markdown Content Styling Override */
      .markdown-body p {
        margin-bottom: 0.75em;
        line-height: 1.6;
      }
      .markdown-body p:last-child {
        margin-bottom: 0;
      }
      .markdown-body ul {
        list-style-type: disc;
        padding-left: 1.5em;
        margin-bottom: 0.75em;
      }
      .markdown-body ol {
        list-style-type: decimal;
        padding-left: 1.5em;
        margin-bottom: 0.75em;
      }
      .markdown-body table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 1em;
        font-size: 0.95em;
      }
      .markdown-body th, .markdown-body td {
        border: 1px solid #e7e5e4; /* stone-200 */
        padding: 0.5em;
        text-align: left;
      }
      .markdown-body th {
        font-weight: 600;
        background-color: #fafaf9; /* stone-50 */
      }
    </style>

    <script>
      // TAILWIND CONFIGURATION
      // Implements ColorLab B (Red Hue Family) + Stage 5 Warm/Neutral Base
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              // Forced Hue: Red (mapped to 'brand')
              brand: {
                50: '#fef2f2',
                100: '#fee2e2',
                200: '#fecaca',
                300: '#fca5a5',
                400: '#f87171',
                500: '#ef4444', // Base Red
                600: '#dc2626',
                700: '#b91c1c',
                800: '#991b1b',
                900: '#7f1d1d',
              },
              // Base Neutral: Stone (Warm Grey)
              neutral: {
                50: '#fafaf9',
                100: '#f5f5f4',
                200: '#e7e5e4',
                300: '#d6d3d1',
                400: '#a8a29e',
                500: '#78716c',
                600: '#57534e',
                700: '#44403c',
                800: '#292524',
                900: '#1c1917',
              }
            }
          }
        }
      }
    </script>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      // ----------------------------------------------------------------------
      // STAGE 0: CONSTANTS (Canonical)
      // ----------------------------------------------------------------------
      const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
      const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

      // ----------------------------------------------------------------------
      // MARKDOWN & KATEX SETUP (Stage 6 Hardening)
      // ----------------------------------------------------------------------
      let md = null;
      if (window.markdownit) {
        md = window.markdownit({
          html: true,       // Allow inline SVG
          linkify: true,
          breaks: false,    // CRITICAL: Must be false for KaTeX
        });
        // Disable escape rule to preserve TeX backslashes
        md.inline.ruler.disable(['escape']);
      }

      const renderMarkdown = (text) => {
        if (!text) return "";
        if (!md) return text; 
        return md.render(text);
      };

      // ----------------------------------------------------------------------
      // COMPONENTS
      // ----------------------------------------------------------------------

      // --- Icons ---
      const ChevronRightIcon = ({ className }) => <i data-lucide="chevron-right" className={className}></i>;
      const ChevronDownIcon = ({ className }) => <i data-lucide="chevron-down" className={className}></i>;
      const MenuIcon = ({ className }) => <i data-lucide="menu" className={className}></i>;
      const XIcon = ({ className }) => <i data-lucide="x" className={className}></i>;
      const CheckIcon = ({ className }) => <i data-lucide="check" className={className}></i>;

      // --- UI Primitives ---

      // Button-like interactive element for Disclosure
      const DisclosureControl = ({ expanded, onClick, label }) => {
        return (
          <button 
            onClick={onClick}
            className="group flex items-center gap-1 text-sm font-medium text-brand-600 hover:text-brand-700 transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-brand-500 focus-visible:ring-offset-1 rounded-sm py-1"
            aria-expanded={expanded}
          >
            <span className="relative top-[1px]">
              {expanded ? <ChevronDownIcon className="w-4 h-4" /> : <ChevronRightIcon className="w-4 h-4" />}
            </span>
            <span>{expanded ? `Hide ${label}` : `Show ${label}`}</span>
          </button>
        );
      };

      // Math Content Wrapper (Auto-render KaTeX)
      const MathContent = ({ html }) => {
        const containerRef = React.useRef(null);

        React.useEffect(() => {
          if (containerRef.current && window.renderMathInElement) {
            window.renderMathInElement(containerRef.current, {
              delimiters: [
                { left: "$$", right: "$$", display: true },
                { left: "$", right: "$", display: false },
                { left: "\\(", right: "\\)", display: false },
                { left: "\\[", right: "\\]", display: true }
              ],
              throwOnError: false
            });
            lucide.createIcons();
          }
        }, [html]);

        return (
          <div 
            ref={containerRef}
            className="markdown-body text-neutral-800 leading-relaxed max-w-none"
            dangerouslySetInnerHTML={{ __html: html }}
          />
        );
      };

      // --- Paper Content Components ---

      // Solution Details Sub-sections
      const KeepInMind = ({ content }) => {
        if (!content) return null;
        return (
          <div className="mb-4">
            <h4 className="text-sm font-bold text-neutral-700 mb-1 flex items-center gap-2">
              Keep in mind
            </h4>
            <div className="text-sm text-neutral-600">
               <MathContent html={renderMarkdown(content)} />
            </div>
          </div>
        );
      };

      const FormulasUsed = ({ content }) => {
        if (!content) return null;
        return (
          <div className="mb-4">
            <h4 className="text-sm font-bold text-neutral-700 mb-1">Formulas used</h4>
            <div className="text-sm text-neutral-600">
              <MathContent html={renderMarkdown(content)} />
            </div>
          </div>
        );
      };

      const WorkingBlock = ({ content, label = "Working" }) => {
        if (!content) return null;
        return (
          <div className="mb-6 last:mb-0">
             <h4 className="text-sm font-bold text-neutral-700 mb-2">{label}</h4>
             <div className="text-base text-neutral-800">
               <MathContent html={renderMarkdown(content)} />
             </div>
          </div>
        );
      };

      // The core recursive Question Node
      const QuestionNode = ({ node, depth, paperDefaults, expandedState, toggleExpanded }) => {
        // Semantic parts
        const { id, question, solutionBlock, children } = node;
        const answer = solutionBlock?.answer;
        const details = solutionBlock?.solutionDetails;
        
        // Determine if Show/Hide toggle is needed
        const hasDetails = !!details;
        const isExpanded = expandedState[id] !== undefined ? expandedState[id] : (paperDefaults?.expandedAll !== false);

        // Styling based on depth (Subordination via spacing/rhythm, no boxes)
        // Depth 0 = Top Level. Depth > 0 = Child.
        const isTopLevel = depth === 0;
        
        return (
          <div 
            id={`q-${id}`}
            className={`
              relative flex flex-col 
              ${isTopLevel ? 'mb-12 pt-4 scroll-mt-24' : 'mt-6 ml-0 scroll-mt-24'} 
            `}
          >
            {/* Question Body */}
            <div className="flex gap-3 md:gap-4">
              <div className="flex-none w-8 md:w-10 pt-0.5 text-neutral-500 font-medium text-right text-base md:text-lg leading-relaxed select-none">
                {id}
              </div>
              <div className="flex-1 min-w-0">
                {/* Prompt */}
                <div className="text-base md:text-lg text-neutral-900 font-medium leading-relaxed mb-4">
                  <MathContent html={renderMarkdown(question)} />
                </div>

                {/* Solution Block (Optional) */}
                {solutionBlock && (
                  <div className="mt-4">
                    {/* Answer (Optional) */}
                    {answer && (
                      <div className="mb-3">
                        <span className="text-xs font-bold text-neutral-500 uppercase tracking-wide block mb-1">Answer</span>
                        <div className="text-base text-neutral-800 font-medium">
                          <MathContent html={renderMarkdown(answer)} />
                        </div>
                      </div>
                    )}

                    {/* Disclosure Control (Only if details exist) */}
                    {hasDetails && (
                      <div className="mt-3 select-none">
                        <DisclosureControl 
                          label="working" 
                          expanded={isExpanded} 
                          onClick={() => toggleExpanded(id)} 
                        />
                      </div>
                    )}

                    {/* Expanded Solution Details Region */}
                    {hasDetails && isExpanded && (
                      <div className="mt-4 pl-0 border-l-2 border-neutral-100/0 animate-in fade-in slide-in-from-top-1 duration-200">
                        {/* Optional Surface Differentiation: Very subtle background or just spacing. 
                            Stage 5 allows subtle surface. Using minimal left border or just spacing to keep it clean light mode. 
                        */}
                        <div className="py-2">
                           <KeepInMind content={details.keepInMind} />
                           
                           {(details.keepInMind && details.formulasUsed) && <div className="h-px w-12 bg-neutral-200 my-4"></div>}
                           
                           <FormulasUsed content={details.formulasUsed} />

                           {((details.keepInMind || details.formulasUsed) && details.working) && <div className="h-px w-12 bg-neutral-200 my-4"></div>}

                           <WorkingBlock content={details.working} />

                           {details.alternativeWorking && details.alternativeWorking.map((alt, idx) => (
                             <React.Fragment key={idx}>
                               <div className="h-px w-full bg-neutral-200 my-6"></div>
                               <WorkingBlock content={alt} label="Alternative working" />
                             </React.Fragment>
                           ))}
                        </div>
                      </div>
                    )}
                  </div>
                )}
              </div>
            </div>

            {/* Children (Recursion) */}
            {children && children.length > 0 && (
              <div className="mt-2 ml-8 md:ml-10 border-l border-neutral-200/50 pl-2 md:pl-4">
                {children.map((child, idx) => (
                  <QuestionNode 
                    key={child.id || idx} 
                    node={child} 
                    depth={depth + 1}
                    paperDefaults={paperDefaults}
                    expandedState={expandedState}
                    toggleExpanded={toggleExpanded}
                  />
                ))}
              </div>
            )}
            
            {/* Top Level Separator (Spacing only, or subtle hairline if needed) */}
            {isTopLevel && <div className="w-full h-px bg-transparent mt-8"></div>}
          </div>
        );
      };


      // --- Navigation Components ---

      const NavigationItem = ({ id, isActive, onClick, hasChildren }) => {
        // Hierarchy via type scale only (Stage 5.4.5)
        // We can infer hierarchy crudely by ID length or structure, but simpler is flat list.
        // We'll use style variants based on "perceived depth" if possible, but strict flat list is safest.
        
        return (
          <button
            onClick={onClick}
            className={`
              w-full text-left py-1.5 px-3 rounded-md text-sm transition-colors duration-200
              ${isActive 
                ? 'font-bold text-brand-700 bg-brand-50' 
                : 'text-neutral-500 hover:text-neutral-800 hover:bg-neutral-100'}
            `}
          >
            {id}
          </button>
        );
      };

      const NavigationList = ({ items, currentId, onJump, sections }) => {
        // If sections exist, group items. Else flat list.
        
        if (sections && sections.length > 0) {
          return (
            <div className="pb-8">
              {sections.map((sec, sIdx) => (
                <div key={sIdx} className="mb-6">
                  {/* Section Label (Non-clickable) */}
                  {sec.label && (
                    <div className="px-3 py-1 mb-2 text-xs font-bold text-neutral-400 uppercase tracking-wider select-none">
                      Section {sec.label}
                    </div>
                  )}
                  {sec.questions.map((q) => (
                    <FlattenedNavItems 
                      key={q.id} 
                      node={q} 
                      currentId={currentId} 
                      onJump={onJump} 
                    />
                  ))}
                </div>
              ))}
            </div>
          );
        }

        return (
           <div className="pb-8">
             {items.map((q) => (
               <FlattenedNavItems 
                 key={q.id} 
                 node={q} 
                 currentId={currentId} 
                 onJump={onJump} 
               />
             ))}
           </div>
        );
      };

      // Recursive helper to flatten nav items for the list
      const FlattenedNavItems = ({ node, currentId, onJump }) => {
        const isActive = currentId === node.id;
        
        return (
          <>
            <NavigationItem 
              id={node.id} 
              isActive={isActive} 
              onClick={() => onJump(node.id)} 
              hasChildren={node.children && node.children.length > 0}
            />
            {node.children && node.children.map(child => (
              <FlattenedNavItems key={child.id} node={child} currentId={currentId} onJump={onJump} />
            ))}
          </>
        );
      };

      // --- Shell ---

      const App = () => {
        const [papers, setPapers] = React.useState([]);
        const [selectedPaperKey, setSelectedPaperKey] = React.useState(null);
        const [loading, setLoading] = React.useState(true);
        const [error, setError] = React.useState(false);
        const [drawerOpen, setDrawerOpen] = React.useState(false);
        const [activeId, setActiveId] = React.useState(null);
        
        // Expansion state: Map<questionId, boolean>
        const [expandedState, setExpandedState] = React.useState({});

        // Load Payload
        React.useEffect(() => {
          fetch(RTQ_PAPERS_PAYLOAD_PATH)
            .then(res => {
              if (!res.ok) throw new Error("Missing");
              return res.json();
            })
            .then(data => {
              if (data && data.papers) {
                setPapers(data.papers);
                setSelectedPaperKey(data.papers[0]?.key);
              } else {
                setError(true);
              }
              setLoading(false);
            })
            .catch(() => {
              setError(true);
              setLoading(false);
            });
        }, []);

        // Toggle Logic
        const toggleExpanded = (qid) => {
          setExpandedState(prev => {
            // If undefined, fallback to paper default. 
            // We need to know current state to flip it.
            const paper = papers.find(p => p.key === selectedPaperKey);
            const defaultState = paper?.defaults?.expandedAll !== false;
            const current = prev[qid] !== undefined ? prev[qid] : defaultState;
            return { ...prev, [qid]: !current };
          });
        };

        // Scroll Spy for Navigation Active State
        React.useEffect(() => {
           const handleScroll = () => {
             const questionNodes = document.querySelectorAll('[id^="q-"]');
             let current = null;
             for (let node of questionNodes) {
               const rect = node.getBoundingClientRect();
               if (rect.top < 150) { // Threshold
                 current = node.id.replace('q-', '');
               }
             }
             if (current) setActiveId(current);
           };
           window.addEventListener('scroll', handleScroll, { passive: true });
           return () => window.removeEventListener('scroll', handleScroll);
        }, [selectedPaperKey]);

        // Handlers
        const handlePaperChange = (e) => {
          setSelectedPaperKey(e.target.value);
          setExpandedState({}); // Reset expansion on switch
          window.scrollTo(0, 0);
          setDrawerOpen(false);
        };

        const handleJump = (id) => {
          const el = document.getElementById(`q-${id}`);
          if (el) {
            el.scrollIntoView({ behavior: 'smooth' });
            setDrawerOpen(false);
            setActiveId(id);
          }
        };

        // Render Loading / Error
        if (loading) return <div className="p-8 text-neutral-500">Loading payload...</div>;
        if (error) return (
          <div className="min-h-screen flex items-center justify-center bg-stone-50 text-neutral-400 font-mono tracking-widest">
            PAPERS PAYLOAD MISSING
          </div>
        );

        const currentPaper = papers.find(p => p.key === selectedPaperKey);
        if (!currentPaper) return null;

        // Paper structure: either 'questions' or 'sections'
        const isSectioned = !!currentPaper.sections;
        const rootItems = isSectioned ? [] : currentPaper.questions; // used if flat
        
        return (
          <div className="min-h-screen flex flex-col md:flex-row max-w-7xl mx-auto bg-white shadow-sm md:my-8 md:border border-neutral-200 md:rounded-lg overflow-hidden md:h-[calc(100vh-4rem)]">
            
            {/* 1. Mobile Top Bar (Controls + Jump To) */}
            <div className="md:hidden sticky top-0 z-20 bg-white/95 backdrop-blur border-b border-neutral-200 px-4 py-3 flex items-center justify-between">
              <select 
                value={selectedPaperKey} 
                onChange={handlePaperChange}
                className="bg-transparent text-sm font-semibold text-neutral-800 border-none focus:ring-0 cursor-pointer pr-8"
              >
                {papers.map(p => <option key={p.key} value={p.key}>{p.label}</option>)}
              </select>
              <button 
                onClick={() => setDrawerOpen(true)}
                className="text-brand-600 text-sm font-bold flex items-center gap-1"
              >
                Jump to <MenuIcon className="w-4 h-4" />
              </button>
            </div>

            {/* 2. Navigation Rail (Desktop) / Drawer (Mobile) */}
            <nav className={`
               fixed inset-0 z-30 bg-white/95 backdrop-blur transform transition-transform duration-300 md:translate-x-0
               md:relative md:bg-stone-50 md:w-64 md:flex-none md:border-r border-neutral-200 md:z-0
               ${drawerOpen ? 'translate-x-0' : 'translate-x-full'}
            `}>
              <div className="h-full flex flex-col">
                 {/* Mobile Drawer Header */}
                 <div className="md:hidden flex items-center justify-between p-4 border-b border-neutral-100">
                   <h2 className="font-bold text-neutral-900">Jump to question</h2>
                   <button onClick={() => setDrawerOpen(false)} className="p-2 text-neutral-500">
                     <XIcon className="w-5 h-5" />
                   </button>
                 </div>

                 {/* Desktop Paper Selector (in rail header) */}
                 <div className="hidden md:block p-6 pb-2">
                    <label className="block text-xs font-bold text-neutral-400 uppercase tracking-wider mb-2">Select Paper</label>
                    <div className="relative">
                      <select 
                        value={selectedPaperKey} 
                        onChange={handlePaperChange}
                        className="w-full bg-white border border-neutral-200 rounded-md py-2 pl-3 pr-8 text-sm font-medium text-neutral-700 shadow-sm focus:border-brand-500 focus:ring-1 focus:ring-brand-500 outline-none appearance-none"
                      >
                        {papers.map(p => <option key={p.key} value={p.key}>{p.label}</option>)}
                      </select>
                      <ChevronDownIcon className="absolute right-3 top-2.5 w-4 h-4 text-neutral-400 pointer-events-none" />
                    </div>
                 </div>

                 {/* Nav List (Scrollable) */}
                 <div className="flex-1 overflow-y-auto no-scrollbar p-4 md:p-6">
                    <NavigationList 
                      items={rootItems} 
                      sections={currentPaper.sections}
                      currentId={activeId} 
                      onJump={handleJump} 
                    />
                 </div>
              </div>
            </nav>

            {/* 3. Paper Content Region */}
            <main className="flex-1 bg-white overflow-y-auto relative scroll-smooth h-full">
              <div className="max-w-3xl mx-auto px-4 py-8 md:px-12 md:py-12 pb-32">
                 
                 {/* Sectioned Paper Handling */}
                 {isSectioned ? (
                   <div>
                     {currentPaper.sections.map((sec, idx) => (
                       <div key={idx} className="mb-16">
                         {sec.label && (
                           <div className="mb-8 pb-4 border-b border-neutral-100">
                             <span className="text-xl font-bold text-neutral-900">Section {sec.label}</span>
                           </div>
                         )}
                         {sec.questions.map((q, qIdx) => (
                            <QuestionNode 
                              key={q.id} 
                              node={q} 
                              depth={0} 
                              paperDefaults={currentPaper.defaults}
                              expandedState={expandedState}
                              toggleExpanded={toggleExpanded}
                            />
                         ))}
                       </div>
                     ))}
                   </div>
                 ) : (
                   /* Flat Paper Handling */
                   <div>
                     {rootItems.map((q, idx) => (
                       <QuestionNode 
                         key={q.id} 
                         node={q} 
                         depth={0} 
                         paperDefaults={currentPaper.defaults}
                         expandedState={expandedState}
                         toggleExpanded={toggleExpanded}
                       />
                     ))}
                   </div>
                 )}

                 {/* End of Paper Padding */}
                 <div className="mt-24 text-center text-neutral-300 text-sm">
                   End of paper
                 </div>
              </div>
            </main>

          </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
