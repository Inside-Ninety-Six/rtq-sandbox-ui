<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"ABC","indexWithinVariant":"172","totalWithinVariant":"320","hueFamily":"purple","intensityMode":"deep_theme","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-09T18:02:38.953Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;ABC&quot;,&quot;indexWithinVariant&quot;:&quot;172&quot;,&quot;totalWithinVariant&quot;:&quot;320&quot;,&quot;hueFamily&quot;:&quot;purple&quot;,&quot;intensityMode&quot;:&quot;deep_theme&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-09T18:02:38.953Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- KaTeX CSS (No SRI/integrity as per Stage 6 instructions) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <style>
        /* =========================================
           STAGE 0: CONSTANTS & TOKENS
           ColorLab B: Force Hue = Purple (approx H=300)
           ColorLab C: Intensity Mode = deep_theme
           (Light Mode Only)
           ========================================= */
        :root {
            /* HUE FAMILY: PURPLE (300) */
            --hue: 300;

            /* Deep Theme - Backgrounds (Chromatic) */
            /* Page: L [0.92..0.98], C [0.08..0.16] -> L=0.95 C=0.08 */
            --color-bg-page: oklch(0.95 0.08 var(--hue));
            
            /* Frame: L [0.90..0.96], C [0.08..0.16] -> L=0.93 C=0.09 */
            --color-bg-frame: oklch(0.93 0.09 var(--hue));
            
            /* Paper: L [0.94..0.99], C [0.06..0.14] -> L=0.98 C=0.06 */
            --color-bg-paper: oklch(0.98 0.06 var(--hue));

            /* Wash Surfaces (Solution Details) */
            /* Deep Theme Wash: C [0.05..0.10] -> L=0.96 C=0.06 */
            --color-bg-wash: oklch(0.96 0.06 var(--hue));
            
            /* Keep in Mind / Formulas (if surfaced - optional, used wash) */
            --color-bg-wash-strong: oklch(0.95 0.07 var(--hue));

            /* Text (High Legibility, Neutral-leaning) */
            /* Primary: L [0.15..0.25], C <= 0.015 -> L=0.20 C=0.01 */
            --color-text-primary: oklch(0.20 0.01 var(--hue));
            
            /* Secondary: L [0.25..0.40], C <= 0.020 -> L=0.35 C=0.015 */
            --color-text-secondary: oklch(0.35 0.015 var(--hue));
            
            /* Tertiary/Quieter: L=0.45 C=0.02 */
            --color-text-tertiary: oklch(0.45 0.02 var(--hue));

            /* Accent (Links, Focus, Active Nav) */
            /* Deep Theme Accent: L [0.45..0.65], C [0.16..0.26] -> L=0.55 C=0.20 */
            --color-accent: oklch(0.55 0.20 var(--hue));
            
            /* Interactive/Hover (Slightly darker accent) */
            --color-accent-hover: oklch(0.50 0.20 var(--hue));

            /* Hairlines / Dividers */
            /* C <= 0.02 -> L=0.85 C=0.02 */
            --color-divider: oklch(0.85 0.02 var(--hue));

            /* Focus Ring */
            --color-focus: var(--color-accent);

            /* Spacing Units */
            --space-1: 0.25rem;
            --space-2: 0.5rem;
            --space-3: 0.75rem;
            --space-4: 1rem;
            --space-6: 1.5rem;
            --space-8: 2rem;
            --space-12: 3rem;

            /* Layout */
            --width-max-frame: 1200px;
            --width-nav-rail: 240px;
        }

        /* =========================================
           RESET & BASE
           ========================================= */
        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--color-bg-page);
            color: var(--color-text-primary);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        button {
            font-family: inherit;
            border: none;
            background: none;
            cursor: pointer;
            padding: 0;
            color: inherit;
        }

        :focus-visible {
            outline: 2px solid var(--color-focus);
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* =========================================
           LAYOUT ARCHITECTURE (STAGE 3 TREE)
           ========================================= */
        .app-root {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            align-items: center;
        }

        /* Top Controls Region */
        .top-controls-region {
            width: 100%;
            display: flex;
            justify-content: center;
            padding: var(--space-4) var(--space-4) 0;
            z-index: 20;
        }

        .top-controls-content {
            width: 100%;
            max-width: var(--width-max-frame);
            display: flex;
            justify-content: space-between;
            align-items: center;
            /* Match frame inner gutters if needed, here simple alignment */
        }

        /* DocumentFrameShell */
        .document-frame-shell {
            width: 100%;
            max-width: var(--width-max-frame);
            background-color: var(--color-bg-frame);
            min-height: 100vh; /* Fill rest of view */
            margin-top: var(--space-4);
            display: grid;
            /* Desktop default: Nav + Paper columns */
            grid-template-columns: var(--width-nav-rail) 1fr;
            /* Sibling columns, shared surface context */
        }

        @media (max-width: 800px) {
            .document-frame-shell {
                grid-template-columns: 1fr; /* Stacked/Single column on mobile */
            }
        }

        /* Navigation Rail (Desktop) */
        .nav-rail {
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
            padding: var(--space-6) var(--space-4);
            /* Scrollbar hiding logic */
            scrollbar-width: none;
            -ms-overflow-style: none;
            border-right: 1px solid transparent; /* Optical separation handled by space */
        }
        
        .nav-rail::-webkit-scrollbar {
            display: none;
        }

        @media (max-width: 800px) {
            .nav-rail {
                display: none; /* Hidden on mobile, use drawer */
            }
        }

        /* Paper Document Column */
        .paper-column {
            padding: var(--space-6) var(--space-6) var(--space-12);
            background-color: var(--color-bg-paper); /* Distinct paper surface in Deep Theme */
            /* Add subtle separation/shadow if strictly needed, but Stage 5 prefers flat/surface diff */
        }
        
        @media (max-width: 800px) {
            .paper-column {
                padding: var(--space-4);
            }
        }

        /* =========================================
           COMPONENTS: CONTROLS
           ========================================= */
        .paper-selector {
            font-size: 0.9rem;
            padding: var(--space-2) var(--space-3);
            border: 1px solid var(--color-divider);
            border-radius: 4px;
            background-color: var(--color-bg-paper);
            color: var(--color-text-primary);
        }

        .jump-to-trigger {
            display: none; /* Desktop hidden */
            font-weight: 500;
            color: var(--color-accent);
            align-items: center;
            gap: var(--space-1);
        }

        @media (max-width: 800px) {
            .jump-to-trigger {
                display: flex;
            }
        }

        /* =========================================
           COMPONENTS: NAVIGATION
           ========================================= */
        .nav-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-1);
        }

        .nav-section-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--color-text-tertiary);
            margin-top: var(--space-4);
            margin-bottom: var(--space-1);
            font-weight: 600;
        }
        
        .nav-item {
            font-size: 0.85rem;
            color: var(--color-text-secondary);
            padding: 2px 0;
            text-decoration: none;
            transition: color 0.1s ease;
            cursor: pointer;
            /* Flat list, no indentation */
        }

        .nav-item:hover {
            color: var(--color-text-primary);
            text-decoration: underline;
            text-decoration-color: var(--color-divider);
        }

        .nav-item.active {
            color: var(--color-accent); /* Allowed by Override */
            font-weight: 600;
        }

        /* Hierarchy via type scale only */
        .nav-item[data-depth="0"] { font-size: 0.9rem; }
        .nav-item[data-depth="1"] { font-size: 0.85rem; }
        .nav-item[data-depth="2"] { font-size: 0.8rem; }

        /* =========================================
           COMPONENTS: PAPER CONTENT
           ========================================= */
        .section-header {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--color-text-primary);
            margin-top: var(--space-8);
            margin-bottom: var(--space-4);
            padding-bottom: var(--space-2);
            border-bottom: 1px solid var(--color-divider);
        }

        .question-node {
            display: flex;
            flex-direction: column;
            margin-bottom: var(--space-8); /* Top-level spacing */
        }
        
        /* Children container vertical spacing */
        .children-container {
            display: flex;
            flex-direction: column;
            gap: var(--space-6);
            margin-top: var(--space-4);
            /* Adaptive indentation */
            padding-left: var(--space-4);
        }
        
        @media (max-width: 600px) {
            .children-container {
                padding-left: var(--space-2); /* Reduced on mobile */
            }
        }

        /* Question Body */
        .question-body {
            display: flex;
            gap: var(--space-3);
            color: var(--color-text-primary);
        }

        .question-id {
            font-weight: 600;
            flex-shrink: 0;
            min-width: 1.5rem;
        }

        .question-prompt {
            flex-grow: 1;
            /* Markdown content spacing */
        }

        .question-prompt p { margin-top: 0; margin-bottom: var(--space-2); }
        .question-prompt p:last-child { margin-bottom: 0; }

        /* Solution Block (Answer + Details) */
        .solution-block {
            margin-top: var(--space-3);
            margin-left: calc(1.5rem + var(--space-3)); /* Align with prompt text */
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
        }
        
        @media (max-width: 600px) {
            .solution-block {
                margin-left: 0; /* Reset indentation on mobile for space */
                padding-left: var(--space-2);
                border-left: 2px solid var(--color-divider); /* Subtle guide */
            }
        }

        /* Answer */
        .answer-region {
            font-weight: 500;
            color: var(--color-text-primary);
        }
        
        .answer-label {
            font-size: 0.85rem;
            color: var(--color-text-secondary);
            font-weight: 600;
            margin-right: var(--space-2);
        }

        /* Disclosure Control */
        .disclosure-control {
            display: inline-flex;
            align-items: center;
            gap: var(--space-1);
            font-size: 0.9rem;
            color: var(--color-accent);
            font-weight: 500;
            width: fit-content;
        }

        .disclosure-control:hover {
            color: var(--color-accent-hover);
            text-decoration: underline;
        }

        .chevron {
            transition: transform 0.2s ease;
        }
        .disclosure-control[aria-expanded="true"] .chevron {
            transform: rotate(180deg);
        }

        /* Solution Details Region */
        .solution-details {
            display: none;
            flex-direction: column;
            gap: var(--space-4);
            background-color: var(--color-bg-wash);
            padding: var(--space-4);
            border-radius: 4px; /* Soft structure */
        }

        .solution-details[data-visible="true"] {
            display: flex;
            animation: fadeIn 0.2s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-4px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Subsections (Keep in mind, Formulas, etc) */
        .sd-subsection {
            display: flex;
            flex-direction: column;
            gap: var(--space-1);
        }

        .sd-label {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--color-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .sd-body {
            font-size: 0.95rem;
            color: var(--color-text-secondary); /* Subordinate */
        }
        
        /* Internal Separators */
        .sd-divider {
            height: 1px;
            background-color: var(--color-divider);
            margin: var(--space-1) 0;
            border: none;
        }

        /* Working / Alt Working separation */
        .alt-working-block {
            margin-top: var(--space-4);
            padding-top: var(--space-4);
            border-top: 1px dashed var(--color-divider);
        }

        /* =========================================
           DRAWER (MOBILE)
           ========================================= */
        .drawer-backdrop {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0,0,0,0.4);
            z-index: 100;
            display: none;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .drawer-backdrop.open {
            display: block;
            opacity: 1;
        }

        .drawer-panel {
            position: fixed;
            top: 0; bottom: 0; right: 0;
            width: 80%;
            max-width: 320px;
            background-color: var(--color-bg-frame);
            z-index: 101;
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex;
            flex-direction: column;
            box-shadow: -4px 0 12px rgba(0,0,0,0.1);
        }

        .drawer-backdrop.open .drawer-panel {
            transform: translateX(0);
        }

        .drawer-header {
            padding: var(--space-4);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--color-divider);
        }

        .drawer-title {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .drawer-close {
            padding: var(--space-2);
            font-size: 1.5rem;
            line-height: 1;
            color: var(--color-text-secondary);
        }

        .drawer-content {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-4);
        }

        /* =========================================
           MARKDOWN & KATEX UTILS
           ========================================= */
        /* Block math containment - Safety net */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            padding: var(--space-2) 0;
            max-width: 100%;
        }

        /* Table styling */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            margin: var(--space-2) 0;
        }
        th, td {
            border: 1px solid var(--color-divider);
            padding: var(--space-2);
            text-align: left;
        }
        th {
            font-weight: 600;
            background-color: rgba(0,0,0,0.02);
        }

        /* Markdown lists */
        ul, ol {
            padding-left: var(--space-4);
            margin: var(--space-1) 0;
        }
        li {
            margin-bottom: var(--space-1);
        }

        /* Inline SVG passthrough styles */
        svg {
            max-width: 100%;
            height: auto;
        }

        /* Utility: Error view */
        .error-state {
            padding: var(--space-8);
            text-align: center;
            font-weight: 600;
            color: var(--color-text-secondary);
        }

    </style>
</head>
<body>

    <div class="app-root">
        <!-- Top Controls -->
        <div class="top-controls-region">
            <div class="top-controls-content">
                <select id="paper-selector" class="paper-selector" aria-label="Select Paper">
                    <option value="" disabled selected>Loading papers...</option>
                </select>

                <button id="jump-to-trigger" class="jump-to-trigger" aria-label="Open Navigation">
                    <span>Jump to</span>
                    <svg width="16" height="16" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1.5 3C1.22386 3 1 3.22386 1 3.5C1 3.77614 1.22386 4 1.5 4H13.5C13.7761 4 14 3.77614 14 3.5C14 3.22386 13.7761 3 13.5 3H1.5ZM1 7.5C1 7.22386 1.22386 7 1.5 7H13.5C13.7761 7 14 7.22386 14 7.5C14 7.77614 13.7761 8 13.5 8H1.5C1.22386 8 1 7.77614 1 7.5ZM1 11.5C1 11.2239 1.22386 11 1.5 11H13.5C13.7761 11 14 11.2239 14 11.5C14 11.7761 13.7761 12 13.5 12H1.5C1.22386 12 1 11.7761 1 11.5Z" fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
                </button>
            </div>
        </div>

        <!-- Document Frame Shell -->
        <div class="document-frame-shell">
            <!-- Left: Nav Rail (Desktop) -->
            <nav id="nav-rail" class="nav-rail" aria-label="Paper Navigation"></nav>

            <!-- Right: Paper Column -->
            <main id="paper-column" class="paper-column">
                <div id="paper-content" class="paper-content">
                    <!-- Dynamic Content Here -->
                </div>
            </main>
        </div>
    </div>

    <!-- Mobile Drawer -->
    <div id="drawer-backdrop" class="drawer-backdrop">
        <aside class="drawer-panel" role="dialog" aria-label="Navigation Drawer">
            <header class="drawer-header">
                <span class="drawer-title">Jump to</span>
                <button id="drawer-close" class="drawer-close" aria-label="Close navigation">&times;</button>
            </header>
            <nav id="drawer-nav" class="drawer-content">
                <!-- Cloned Nav Content Here -->
            </nav>
        </aside>
    </div>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <script>
        // --- STAGE 0: CONSTANTS ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";

        // --- MARKDOWN SETUP ---
        const md = window.markdownit ? window.markdownit({
            html: true,
            linkify: true,
            breaks: false // MUST be false
        }) : null;

        if (md) {
            md.inline.ruler.disable(['escape']);
        }

        // --- STATE ---
        let payloadData = null;
        let activePaper = null;
        let currentExpandedState = true;

        // --- DOM ELEMENTS ---
        const paperSelector = document.getElementById('paper-selector');
        const paperContent = document.getElementById('paper-content');
        const navRail = document.getElementById('nav-rail');
        const drawerNav = document.getElementById('drawer-nav');
        const drawerBackdrop = document.getElementById('drawer-backdrop');
        const jumpToTrigger = document.getElementById('jump-to-trigger');
        const drawerClose = document.getElementById('drawer-close');

        // --- INITIALIZATION ---
        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Payload load failed");
                payloadData = await response.json();
                
                populatePaperSelector();
                if (payloadData.papers && payloadData.papers.length > 0) {
                    loadPaper(payloadData.papers[0].key);
                }
            } catch (err) {
                console.error(err);
                renderError();
            }
        }

        function renderError() {
            paperContent.innerHTML = '<div class="error-state">PAPERS PAYLOAD MISSING</div>';
            paperSelector.innerHTML = '<option disabled selected>Error loading payload</option>';
        }

        function populatePaperSelector() {
            paperSelector.innerHTML = '';
            payloadData.papers.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.key;
                opt.textContent = p.label;
                paperSelector.appendChild(opt);
            });
            paperSelector.addEventListener('change', (e) => loadPaper(e.target.value));
        }

        function loadPaper(paperKey) {
            const paper = payloadData.papers.find(p => p.key === paperKey);
            if (!paper) return;
            activePaper = paper;
            
            // Set defaults
            currentExpandedState = (paper.defaults && paper.defaults.expandedAll !== undefined) 
                ? paper.defaults.expandedAll 
                : true;

            // Render
            renderPaperContent(paper);
            renderNavigation(paper);
            
            // Post-render: Math
            if (window.renderMathInElement) {
                renderMathInElement(paperContent, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false}
                    ],
                    throwOnError: false
                });
            }

            // Scroll to top
            window.scrollTo(0, 0);
        }

        // --- CONTENT RENDERING ---
        function renderPaperContent(paper) {
            paperContent.innerHTML = '';

            // Handle Sections vs Flat
            if (paper.sections) {
                paper.sections.forEach(section => {
                    const sectionBlock = document.createElement('div');
                    sectionBlock.className = 'section-block';
                    
                    if (section.label && section.label.trim() !== "") {
                        const header = document.createElement('div');
                        header.className = 'section-header';
                        header.textContent = section.label;
                        sectionBlock.appendChild(header);
                    }
                    
                    const list = document.createElement('div');
                    list.className = 'question-list';
                    section.questions.forEach(q => {
                        list.appendChild(renderQuestionNode(q, 0));
                    });
                    
                    sectionBlock.appendChild(list);
                    paperContent.appendChild(sectionBlock);
                });
            } else if (paper.questions) {
                const list = document.createElement('div');
                list.className = 'question-list';
                paper.questions.forEach(q => {
                    list.appendChild(renderQuestionNode(q, 0));
                });
                paperContent.appendChild(list);
            }
        }

        function renderQuestionNode(node, depth) {
            const wrapper = document.createElement('div');
            wrapper.className = 'question-node';
            if (node.id) wrapper.id = `q-${node.id}`; // Anchor

            // 1. Question Body
            const body = document.createElement('div');
            body.className = 'question-body';
            
            const idEl = document.createElement('div');
            idEl.className = 'question-id';
            idEl.textContent = node.id || '';
            
            const promptEl = document.createElement('div');
            promptEl.className = 'question-prompt';
            promptEl.innerHTML = md ? md.render(node.question || '') : (node.question || '');

            body.appendChild(idEl);
            body.appendChild(promptEl);
            wrapper.appendChild(body);

            // 2. Solution Block (Optional)
            if (node.solutionBlock) {
                const sb = node.solutionBlock;
                const hasAnswer = !!sb.answer;
                const hasDetails = !!sb.solutionDetails;

                if (hasAnswer || hasDetails) {
                    const sbWrapper = document.createElement('div');
                    sbWrapper.className = 'solution-block';

                    // Answer
                    if (hasAnswer) {
                        const ansWrapper = document.createElement('div');
                        ansWrapper.className = 'answer-region';
                        
                        const ansLabel = document.createElement('span');
                        ansLabel.className = 'answer-label';
                        ansLabel.textContent = 'Answer';
                        
                        const ansContent = document.createElement('span');
                        ansContent.innerHTML = md ? md.renderInline(sb.answer) : sb.answer;
                        
                        ansWrapper.appendChild(ansLabel);
                        ansWrapper.appendChild(ansContent);
                        sbWrapper.appendChild(ansWrapper);
                    }

                    // Details
                    if (hasDetails) {
                        // Toggle Control
                        const toggleBtn = document.createElement('button');
                        toggleBtn.className = 'disclosure-control';
                        toggleBtn.setAttribute('aria-expanded', currentExpandedState);
                        toggleBtn.innerHTML = `
                            <span class="btn-text">${currentExpandedState ? 'Hide working' : 'Show working'}</span>
                            <svg class="chevron" width="12" height="12" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.13523 6.15803C3.3241 5.95657 3.64052 5.94637 3.84197 6.13523L7.5 9.56464L11.158 6.13523C11.3595 5.94637 11.6759 5.95657 11.8648 6.15803C12.0536 6.35949 12.0434 6.67591 11.842 6.86477L7.84197 10.6148C7.64964 10.7951 7.35036 10.7951 7.15803 10.6148L3.15803 6.86477C2.95657 6.67591 2.94637 6.35949 3.13523 6.15803Z" fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
                        `;

                        // Details Container
                        const detailsRegion = document.createElement('div');
                        detailsRegion.className = 'solution-details';
                        detailsRegion.setAttribute('data-visible', currentExpandedState);

                        // Content within details
                        const details = sb.solutionDetails;
                        
                        // Keep in mind
                        if (details.keepInMind) {
                            detailsRegion.appendChild(renderSubSection('Keep in mind', details.keepInMind, true));
                        }
                        
                        // Formulas used
                        if (details.formulasUsed) {
                            if (details.keepInMind) detailsRegion.appendChild(createDivider());
                            detailsRegion.appendChild(renderSubSection('Formulas used', details.formulasUsed, false));
                        }

                        // Working (Primary)
                        if (details.working) {
                            if (details.keepInMind || details.formulasUsed) detailsRegion.appendChild(createDivider());
                            const wBlock = renderSubSection('Working', details.working, false);
                            detailsRegion.appendChild(wBlock);
                        }

                        // Alternatives
                        if (details.alternativeWorking && Array.isArray(details.alternativeWorking)) {
                            details.alternativeWorking.forEach(alt => {
                                const altDiv = document.createElement('div');
                                altDiv.className = 'alt-working-block';
                                altDiv.appendChild(renderSubSection('Alternative working', alt, false));
                                detailsRegion.appendChild(altDiv);
                            });
                        }

                        // Interaction
                        toggleBtn.onclick = () => {
                            const isExpanded = toggleBtn.getAttribute('aria-expanded') === 'true';
                            const newState = !isExpanded;
                            toggleBtn.setAttribute('aria-expanded', newState);
                            toggleBtn.querySelector('.btn-text').textContent = newState ? 'Hide working' : 'Show working';
                            detailsRegion.setAttribute('data-visible', newState);
                        };

                        sbWrapper.appendChild(toggleBtn);
                        sbWrapper.appendChild(detailsRegion);
                    }
                    wrapper.appendChild(sbWrapper);
                }
            }

            // 3. Recursion
            if (node.children && node.children.length > 0) {
                const childrenCont = document.createElement('div');
                childrenCont.className = 'children-container';
                node.children.forEach(child => {
                    childrenCont.appendChild(renderQuestionNode(child, depth + 1));
                });
                wrapper.appendChild(childrenCont);
            }

            return wrapper;
        }

        function renderSubSection(label, contentMarkdown, isKeepInMind) {
            const div = document.createElement('div');
            div.className = 'sd-subsection';
            
            const lbl = document.createElement('div');
            lbl.className = 'sd-label';
            lbl.textContent = label;
            
            const body = document.createElement('div');
            body.className = 'sd-body';
            body.innerHTML = md ? md.render(contentMarkdown) : contentMarkdown;

            div.appendChild(lbl);
            div.appendChild(body);
            return div;
        }

        function createDivider() {
            const hr = document.createElement('hr');
            hr.className = 'sd-divider';
            return hr;
        }

        // --- NAVIGATION RENDERING ---
        function renderNavigation(paper) {
            navRail.innerHTML = '';
            drawerNav.innerHTML = '';

            const navList = document.createElement('div');
            navList.className = 'nav-list';

            if (paper.sections) {
                paper.sections.forEach(sec => {
                    if (sec.label && sec.label.trim() !== "") {
                        const lbl = document.createElement('div');
                        lbl.className = 'nav-section-label';
                        lbl.textContent = sec.label;
                        navList.appendChild(lbl);
                    }
                    sec.questions.forEach(q => appendNavItemsRecursive(q, navList, 0));
                });
            } else if (paper.questions) {
                paper.questions.forEach(q => appendNavItemsRecursive(q, navList, 0));
            }

            navRail.appendChild(navList);
            drawerNav.appendChild(navList.cloneNode(true));

            setupScrollSpy();
            setupDrawerInteractions();
        }

        function appendNavItemsRecursive(node, container, depth) {
            const item = document.createElement('a');
            item.className = 'nav-item';
            item.textContent = node.id;
            item.href = `#q-${node.id}`;
            item.dataset.targetId = `q-${node.id}`;
            item.dataset.depth = Math.min(depth, 2); // Cap depth for type scale

            item.addEventListener('click', (e) => {
                e.preventDefault();
                const target = document.getElementById(item.dataset.targetId);
                if (target) {
                    // Close drawer if open
                    if (drawerBackdrop.classList.contains('open')) {
                        closeDrawer();
                    }
                    // Smooth scroll
                    const offset = 20;
                    const y = target.getBoundingClientRect().top + window.scrollY - offset;
                    window.scrollTo({top: y, behavior: 'smooth'});
                }
            });

            container.appendChild(item);

            if (node.children) {
                node.children.forEach(child => appendNavItemsRecursive(child, container, depth + 1));
            }
        }

        // --- INTERACTIONS ---
        function setupDrawerInteractions() {
            jumpToTrigger.onclick = () => {
                drawerBackdrop.classList.add('open');
                document.body.style.overflow = 'hidden'; // Lock scroll
            };
            
            const close = () => {
                closeDrawer();
            };

            drawerClose.onclick = close;
            drawerBackdrop.onclick = (e) => {
                if (e.target === drawerBackdrop) close();
            };
        }

        function closeDrawer() {
            drawerBackdrop.classList.remove('open');
            document.body.style.overflow = '';
        }

        // --- SCROLL SPY ---
        function setupScrollSpy() {
            const observerOptions = {
                root: null,
                rootMargin: '-10% 0px -80% 0px', // Active zone near top
                threshold: 0
            };

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const id = entry.target.id;
                        activateNavItem(id);
                    }
                });
            }, observerOptions);

            document.querySelectorAll('.question-node').forEach(node => {
                observer.observe(node);
            });
        }

        function activateNavItem(id) {
            // Desktop
            navRail.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const activeDesktop = navRail.querySelector(`.nav-item[data-target-id="${id}"]`);
            if (activeDesktop) {
                activeDesktop.classList.add('active');
                // Auto-scroll nav rail if needed
                activeDesktop.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
            }

            // Mobile Drawer (sync active state even if hidden)
            drawerNav.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const activeMobile = drawerNav.querySelector(`.nav-item[data-target-id="${id}"]`);
            if (activeMobile) activeMobile.classList.add('active');
        }

        // --- BOOTSTRAP ---
        init();

    </script>
</body>
</html>
