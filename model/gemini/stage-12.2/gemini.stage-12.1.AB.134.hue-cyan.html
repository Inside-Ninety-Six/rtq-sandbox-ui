<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AB","indexWithinVariant":"134","totalWithinVariant":"200","hueFamily":"cyan","intensityMode":"","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-08T19:21:47.286Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AB&quot;,&quot;indexWithinVariant&quot;:&quot;134&quot;,&quot;totalWithinVariant&quot;:&quot;200&quot;,&quot;hueFamily&quot;:&quot;cyan&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-08T19:21:47.286Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Viewer</title>

    <!-- Tailwind CSS (via CDN for prototyping) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        // Implementing ColorLab B: Forced Hue Family = CYAN
                        brand: {
                            50: '#ecfeff',
                            100: '#cffafe',
                            200: '#a5f3fc',
                            300: '#67e8f9',
                            400: '#22d3ee',
                            500: '#06b6d4',
                            600: '#0891b2', // Primary accent
                            700: '#0e7490',
                            800: '#155e75',
                            900: '#164e63',
                        },
                        paper: {
                            bg: '#ffffff',
                            surface: '#f8fafc', // Very subtle cool grey/cyan tint surface
                            border: '#e2e8f0',
                        }
                    }
                }
            }
        }
    </script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- KaTeX CSS (No integrity) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <!-- KaTeX JS (No integrity) -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Markdown-it -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Base styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #ffffff; /* Lab A: Light mode only, clean base */
            color: #0f172a;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Typography & Math handling */
        .prose-content p {
            margin-bottom: 0.75em;
            line-height: 1.6;
        }
        .prose-content p:last-child {
            margin-bottom: 0;
        }
        
        /* KaTeX Containment Invariant */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding: 0.5em 0;
            -webkit-overflow-scrolling: touch;
            /* Scrollbar hiding for cleaner look */
            scrollbar-width: thin; 
        }
        
        /* Inline math: transparent background only */
        .katex {
            background-color: transparent !important;
        }
        
        /* Nav scrollbar hiding */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Focus styles - ColorLab B Cyan */
        :focus-visible {
            outline: 2px solid #0891b2; /* cyan-600 */
            outline-offset: 2px;
        }

        /* Utility for sticky nav */
        .sticky-nav {
            position: sticky;
            top: 1rem;
            max-height: calc(100vh - 2rem);
            overflow-y: auto;
        }

        /* Drawer transition */
        .drawer-overlay {
            transition: opacity 0.3s ease;
        }
        .drawer-content {
            transition: transform 0.3s ease;
        }
        
        /* Markdown Tables */
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 1em 0;
            font-size: 0.95em;
        }
        th, td {
            border: 1px solid #e2e8f0;
            padding: 0.5em 0.75em;
            text-align: left;
        }
        th {
            font-weight: 600;
            background-color: #f8fafc;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Top Controls Region -->
    <header class="w-full border-b border-paper-border bg-white sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            
            <!-- Paper Selector -->
            <div class="flex items-center gap-4">
                <label for="paper-select" class="text-sm font-medium text-slate-600 sr-only">Select Paper</label>
                <select id="paper-select" class="bg-white border border-slate-300 text-slate-900 text-sm rounded-md focus:ring-brand-600 focus:border-brand-600 block w-64 p-2">
                    <option disabled selected>Loading papers...</option>
                </select>
            </div>

            <!-- Mobile Jump To Trigger -->
            <button id="mobile-menu-trigger" class="lg:hidden flex items-center gap-2 text-sm font-medium text-brand-700 hover:text-brand-800 px-3 py-2 rounded-md hover:bg-brand-50 transition-colors">
                <i data-lucide="menu" class="w-5 h-5"></i>
                <span>Jump to</span>
            </button>
        </div>
    </header>

    <!-- DocumentFrameShell -->
    <div class="flex-1 w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="flex gap-12 relative">
            
            <!-- Navigation Rail (Desktop) -->
            <nav class="hidden lg:block w-48 shrink-0 sticky-nav no-scrollbar h-fit pb-10" aria-label="Paper navigation">
                <div id="desktop-nav-list" class="flex flex-col gap-1">
                    <!-- Nav items generated here -->
                </div>
            </nav>

            <!-- Paper Document Column -->
            <main id="paper-content-region" class="flex-1 min-w-0 pb-32">
                <!-- Content generated here -->
                <div class="text-center text-slate-500 py-12">Select a paper to begin.</div>
            </main>

        </div>
    </div>

    <!-- Mobile Navigation Drawer -->
    <div id="drawer-overlay" class="fixed inset-0 bg-slate-900/20 z-50 hidden opacity-0 drawer-overlay" aria-hidden="true"></div>
    <div id="drawer-panel" class="fixed inset-y-0 right-0 z-50 w-64 bg-white shadow-xl transform translate-x-full transition-transform duration-300 ease-in-out flex flex-col" role="dialog" aria-modal="true">
        <div class="flex items-center justify-between p-4 border-b border-slate-100">
            <h2 class="text-lg font-semibold text-slate-800">Jump to</h2>
            <button id="drawer-close" class="p-2 text-slate-500 hover:text-slate-700 rounded-md hover:bg-slate-50">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>
        <div class="flex-1 overflow-y-auto p-4 no-scrollbar">
            <div id="mobile-nav-list" class="flex flex-col gap-2">
                <!-- Mobile nav items generated here -->
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // --- STAGE 0: CONSTANTS ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // --- Configuration ---
        // ColorLab B: Cyan
        const ACCENT_TEXT_CLASS = 'text-brand-700'; 
        const ACCENT_HOVER_CLASS = 'hover:text-brand-800';
        const NAV_ACTIVE_MARKER_CLASS = 'border-l-4 border-brand-600 font-bold text-brand-700 bg-brand-50'; // Using marker + weight + slight bg
        const NAV_INACTIVE_CLASS = 'text-slate-600 hover:text-slate-900 hover:bg-slate-50 border-l-4 border-transparent';

        // --- State ---
        let payloadData = null;
        let activePaperKey = null;
        let isDrawerOpen = false;

        // --- Markdown Setup ---
        const md = window.markdownit ? window.markdownit({
            html: true,
            linkify: true,
            breaks: false, // Invariant: Must be false for KaTeX
        }) : null;

        if (md) {
            md.inline.ruler.disable(['escape']);
        }

        // --- DOM Elements ---
        const paperSelect = document.getElementById('paper-select');
        const contentRegion = document.getElementById('paper-content-region');
        const desktopNavList = document.getElementById('desktop-nav-list');
        const mobileNavList = document.getElementById('mobile-nav-list');
        const drawerOverlay = document.getElementById('drawer-overlay');
        const drawerPanel = document.getElementById('drawer-panel');
        const mobileMenuTrigger = document.getElementById('mobile-menu-trigger');
        const drawerClose = document.getElementById('drawer-close');

        // --- Initial Load ---
        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error('Network response was not ok');
                payloadData = await response.json();
                
                populatePaperSelector();
                
                // Load first paper by default if available
                if (payloadData.papers && payloadData.papers.length > 0) {
                    loadPaper(payloadData.papers[0].key);
                }
            } catch (error) {
                console.error('Payload load failed', error);
                renderFailureMode();
            }
            lucide.createIcons();
        }

        function renderFailureMode() {
            contentRegion.innerHTML = `
                <div class="rounded-md bg-red-50 p-4 border border-red-100">
                    <h3 class="text-sm font-medium text-red-800">PAPERS PAYLOAD MISSING</h3>
                    <p class="mt-2 text-sm text-red-700">Could not load content from ${RTQ_PAPERS_PAYLOAD_PATH}</p>
                </div>
            `;
            paperSelect.innerHTML = '<option disabled>Error loading papers</option>';
        }

        function populatePaperSelector() {
            paperSelect.innerHTML = '';
            payloadData.papers.forEach(paper => {
                const option = document.createElement('option');
                option.value = paper.key;
                option.textContent = paper.label;
                paperSelect.appendChild(option);
            });
            
            paperSelect.addEventListener('change', (e) => {
                loadPaper(e.target.value);
            });
        }

        // --- Rendering Logic ---

        function loadPaper(key) {
            activePaperKey = key;
            const paper = payloadData.papers.find(p => p.key === key);
            if (!paper) return;

            // Reset scroll
            window.scrollTo(0, 0);

            // Render Content
            renderPaperContent(paper);
            
            // Render Navigation
            renderNavigation(paper);

            // Setup Math
            renderMathInElement(contentRegion, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false}
                ],
                throwOnError: false
            });

            // Re-init icons for new content
            lucide.createIcons();
        }

        function renderPaperContent(paper) {
            contentRegion.innerHTML = '';

            // Handle Sectioned vs Flat
            if (paper.sections) {
                paper.sections.forEach((section, index) => {
                    // Render Section Header if label exists
                    if (section.label && section.label.trim() !== '') {
                        const sectionHeader = document.createElement('div');
                        sectionHeader.className = "mb-8 mt-12 first:mt-0 border-b border-slate-200 pb-2";
                        sectionHeader.innerHTML = `<h2 class="text-xl font-semibold text-slate-800">${section.label}</h2>`;
                        contentRegion.appendChild(sectionHeader);
                    }
                    
                    // Render Questions
                    const questionList = document.createElement('div');
                    questionList.className = "flex flex-col gap-16"; // Top-level spacing
                    section.questions.forEach(q => {
                        questionList.appendChild(createQuestionNode(q, paper.defaults, 0));
                    });
                    contentRegion.appendChild(questionList);
                });
            } else if (paper.questions) {
                const questionList = document.createElement('div');
                questionList.className = "flex flex-col gap-16"; // Top-level spacing
                paper.questions.forEach(q => {
                    questionList.appendChild(createQuestionNode(q, paper.defaults, 0));
                });
                contentRegion.appendChild(questionList);
            }
        }

        function createQuestionNode(node, defaults, depth) {
            const container = document.createElement('div');
            container.id = `q-${node.id}`;
            container.className = "flex flex-col w-full"; // Node wrapper

            // Surface wrapper for question node (optional, keeping minimal per Stage 5)
            // Using whitespace primarily.

            // 1. Question Body
            const qBody = document.createElement('div');
            qBody.className = "mb-4"; 
            
            // Layout: Identifier + Prompt
            // Using a grid or flex to align ID and content
            const qContentWrapper = document.createElement('div');
            qContentWrapper.className = "flex gap-4 md:gap-6";

            const qId = document.createElement('div');
            qId.className = "shrink-0 w-8 md:w-12 text-slate-500 font-semibold text-lg select-none";
            qId.textContent = node.id; // Identifier only

            const qPrompt = document.createElement('div');
            qPrompt.className = "flex-1 text-slate-900 text-lg leading-relaxed prose-content";
            qPrompt.innerHTML = md ? md.render(node.question) : node.question;

            qContentWrapper.appendChild(qId);
            qContentWrapper.appendChild(qPrompt);
            qBody.appendChild(qContentWrapper);
            container.appendChild(qBody);

            // 2. Solution Block (Optional)
            if (node.solutionBlock) {
                const sb = node.solutionBlock;
                const wrapper = document.createElement('div');
                // Indent to align with text, skipping ID width (approx)
                wrapper.className = "ml-12 md:ml-18 pl-0 md:pl-0 flex flex-col gap-4"; // Indentation logic

                // 2a. Answer (Optional)
                if (sb.answer) {
                    const answerDiv = document.createElement('div');
                    answerDiv.className = "flex flex-col gap-1";
                    
                    const answerLabel = document.createElement('span');
                    answerLabel.className = "text-sm font-bold text-slate-700 uppercase tracking-wide";
                    answerLabel.textContent = "Answer";
                    
                    const answerContent = document.createElement('div');
                    answerContent.className = "text-slate-800 font-medium text-lg prose-content";
                    answerContent.innerHTML = md ? md.render(sb.answer) : sb.answer;

                    answerDiv.appendChild(answerLabel);
                    answerDiv.appendChild(answerContent);
                    wrapper.appendChild(answerDiv);
                }

                // 2b. Solution Details (Optional)
                if (sb.solutionDetails) {
                    // Defaults check
                    const isExpanded = defaults && defaults.expandedAll !== false;
                    
                    // Disclosure Control
                    const toggleBtn = document.createElement('button');
                    toggleBtn.className = `flex items-center gap-2 text-sm font-medium ${ACCENT_TEXT_CLASS} hover:text-brand-800 transition-colors focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-brand-500 rounded-sm`;
                    toggleBtn.setAttribute('aria-expanded', isExpanded);
                    toggleBtn.innerHTML = `
                        <span class="btn-text">${isExpanded ? 'Hide working' : 'Show working'}</span>
                        <i data-lucide="chevron-down" class="w-4 h-4 transition-transform duration-200 ${isExpanded ? 'rotate-180' : ''}"></i>
                    `;

                    // Details Region
                    const detailsRegion = document.createElement('div');
                    detailsRegion.className = `overflow-hidden transition-all duration-300 ease-in-out ${isExpanded ? 'max-h-[5000px] opacity-100 mt-4' : 'max-h-0 opacity-0 mt-0'}`;
                    
                    // Inner content of details
                    const detailsContent = document.createElement('div');
                    detailsContent.className = "flex flex-col gap-6 text-slate-600 border-l-2 border-slate-100 pl-4 py-2"; 

                    const sd = sb.solutionDetails;

                    // Keep in mind
                    if (sd.keepInMind) {
                        const block = createDetailsBlock("Keep in mind", sd.keepInMind, "list-disc pl-5");
                        detailsContent.appendChild(block);
                    }
                    
                    // Formulas used
                    if (sd.formulasUsed) {
                        const block = createDetailsBlock("Formulas used", sd.formulasUsed);
                        detailsContent.appendChild(block);
                    }

                    // Working (Primary)
                    if (sd.working) {
                        const block = createDetailsBlock("Working", sd.working, "mt-2");
                        detailsContent.appendChild(block);
                    }

                    // Alternative Working
                    if (sd.alternativeWorking && Array.isArray(sd.alternativeWorking)) {
                         sd.alternativeWorking.forEach((alt, idx) => {
                             const block = createDetailsBlock("Alternative working", alt, "mt-4 pt-4 border-t border-slate-100"); // Separator cue
                             detailsContent.appendChild(block);
                         });
                    }

                    detailsRegion.appendChild(detailsContent);

                    // Toggle Interaction
                    toggleBtn.onclick = () => {
                        const expanded = toggleBtn.getAttribute('aria-expanded') === 'true';
                        toggleBtn.setAttribute('aria-expanded', !expanded);
                        toggleBtn.querySelector('.btn-text').textContent = !expanded ? 'Hide working' : 'Show working';
                        toggleBtn.querySelector('i').classList.toggle('rotate-180');
                        
                        if (!expanded) {
                            detailsRegion.classList.remove('max-h-0', 'opacity-0', 'mt-0');
                            detailsRegion.classList.add('max-h-[5000px]', 'opacity-100', 'mt-4');
                        } else {
                            detailsRegion.classList.remove('max-h-[5000px]', 'opacity-100', 'mt-4');
                            detailsRegion.classList.add('max-h-0', 'opacity-0', 'mt-0');
                        }
                    };

                    wrapper.appendChild(toggleBtn);
                    wrapper.appendChild(detailsRegion);
                }

                container.appendChild(wrapper);
            }

            // 3. Children (Sub-questions)
            if (node.children && node.children.length > 0) {
                const childrenContainer = document.createElement('div');
                // Indentation logic for children: Vertical spacing + left padding
                childrenContainer.className = "flex flex-col gap-8 mt-8 ml-0 md:ml-8"; 
                
                node.children.forEach(child => {
                    childrenContainer.appendChild(createQuestionNode(child, defaults, depth + 1));
                });
                container.appendChild(childrenContainer);
            }

            return container;
        }

        function createDetailsBlock(label, contentMarkdown, extraClasses = "") {
            const block = document.createElement('div');
            block.className = `flex flex-col gap-1 ${extraClasses}`;
            
            const labelSpan = document.createElement('span');
            labelSpan.className = "text-xs font-bold uppercase tracking-wider text-slate-400 select-none";
            labelSpan.textContent = label;
            
            const body = document.createElement('div');
            // Solution body text constraint: Readable but subordinate.
            // Using text-slate-600.
            body.className = "prose-content text-base";
            body.innerHTML = md ? md.render(contentMarkdown) : contentMarkdown;
            
            block.appendChild(labelSpan);
            block.appendChild(body);
            return block;
        }

        // --- Navigation Rendering ---

        function renderNavigation(paper) {
            desktopNavList.innerHTML = '';
            mobileNavList.innerHTML = '';
            
            // Build linear list of identifiers
            const navItems = [];
            
            function traverse(nodes) {
                nodes.forEach(node => {
                    navItems.push({ id: node.id, label: node.id }); // Flat list logic
                    if (node.children) traverse(node.children);
                });
            }

            if (paper.sections) {
                paper.sections.forEach(section => {
                    // Section Label
                    if(section.label) {
                        navItems.push({ type: 'section', label: section.label });
                    }
                    traverse(section.questions);
                });
            } else if (paper.questions) {
                traverse(paper.questions);
            }

            // Render Logic
            navItems.forEach(item => {
                if (item.type === 'section') {
                    // Section Separator
                    const dEl = createNavSectionLabel(item.label);
                    const mEl = createNavSectionLabel(item.label);
                    desktopNavList.appendChild(dEl);
                    mobileNavList.appendChild(mEl);
                } else {
                    // Question Link
                    const dLink = createNavLink(item.id, item.id);
                    const mLink = createNavLink(item.id, item.id, true); // true = isMobile
                    desktopNavList.appendChild(dLink);
                    mobileNavList.appendChild(mLink);
                }
            });

            // Intersection Observer for scroll spy
            setupScrollSpy(navItems.filter(i => !i.type).map(i => i.id));
        }

        function createNavSectionLabel(label) {
            const div = document.createElement('div');
            div.className = "text-xs font-bold text-slate-400 mt-4 mb-2 uppercase tracking-widest px-3 select-none";
            div.textContent = label;
            return div;
        }

        function createNavLink(id, label, isMobile = false) {
            const btn = document.createElement('button');
            // Hierarchy via type scale: sub-questions (longer IDs generally) naturally look distinct? 
            // The brief says "Hierarchy via type scale... sub-questions quieter". 
            // We can infer hierarchy if needed, but the brief says flat list identifiers only.
            // We'll keep it simple: Standard size.
            
            btn.className = `w-full text-left px-3 py-1.5 text-sm transition-colors duration-200 border-l-4 border-transparent ${NAV_INACTIVE_CLASS}`;
            btn.dataset.targetId = `q-${id}`;
            
            // Visual tweak for sub-questions (heuristic: length > 2 usually means sub)
            if (id.length > 2 || id.includes('(')) {
                btn.classList.add('text-xs'); // Slightly smaller
                btn.classList.remove('text-sm');
            } else {
                btn.classList.add('font-medium');
            }

            btn.textContent = label;

            btn.onclick = () => {
                const target = document.getElementById(`q-${id}`);
                if (target) {
                    const headerOffset = 80;
                    const elementPosition = target.getBoundingClientRect().top;
                    const offsetPosition = elementPosition + window.pageYOffset - headerOffset;

                    window.scrollTo({
                        top: offsetPosition,
                        behavior: "smooth"
                    });
                    
                    if (isMobile) toggleDrawer();
                }
            };
            return btn;
        }

        // --- Interaction Logic ---

        function toggleDrawer() {
            isDrawerOpen = !isDrawerOpen;
            if (isDrawerOpen) {
                drawerOverlay.classList.remove('hidden', 'opacity-0');
                drawerOverlay.classList.add('block', 'opacity-100');
                drawerPanel.classList.remove('translate-x-full');
            } else {
                drawerOverlay.classList.remove('block', 'opacity-100');
                drawerOverlay.classList.add('hidden', 'opacity-0');
                drawerPanel.classList.add('translate-x-full');
            }
        }

        mobileMenuTrigger.onclick = toggleDrawer;
        drawerClose.onclick = toggleDrawer;
        drawerOverlay.onclick = toggleDrawer;

        // --- Scroll Spy ---
        function setupScrollSpy(ids) {
            const observerOptions = {
                root: null,
                rootMargin: '-100px 0px -80% 0px', // Trigger near top
                threshold: 0
            };

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        updateActiveNav(entry.target.id.replace('q-', ''));
                    }
                });
            }, observerOptions);

            ids.forEach(id => {
                const el = document.getElementById(`q-${id}`);
                if (el) observer.observe(el);
            });
        }

        function updateActiveNav(activeId) {
            document.querySelectorAll('[data-target-id]').forEach(btn => {
                // Reset
                btn.className = btn.className.replace(NAV_ACTIVE_MARKER_CLASS, '').replace(NAV_INACTIVE_CLASS, ''); // Remove both to clean
                
                if (btn.dataset.targetId === `q-${activeId}`) {
                     btn.classList.add(...NAV_ACTIVE_MARKER_CLASS.split(' '));
                } else {
                     btn.classList.add(...NAV_INACTIVE_CLASS.split(' '));
                }
            });
        }

        // Start
        init();

    </script>
</body>
</html>
