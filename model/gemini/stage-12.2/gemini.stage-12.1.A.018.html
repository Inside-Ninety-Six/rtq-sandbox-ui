<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"A","indexWithinVariant":"18","totalWithinVariant":"50","hueFamily":"","intensityMode":"","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-08T11:59:53.218Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;A&quot;,&quot;indexWithinVariant&quot;:&quot;18&quot;,&quot;totalWithinVariant&quot;:&quot;50&quot;,&quot;hueFamily&quot;:&quot;&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-08T11:59:53.218Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer (Stage 6 Prototype)</title>
    
    <!-- Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Tailwind CSS (via CDN for prototyping) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- KaTeX CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <!-- KaTeX JS -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Markdown-it -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <!-- Colorlab A Configuration: Slate + Indigo Theme -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        // COLORLAB A: Freedom to use a refined palette
                        base: '#F8FAFC', // Slate 50
                        surface: '#FFFFFF',
                        surfaceAlt: '#F1F5F9', // Slate 100 (for expanded workings)
                        txt: {
                            primary: '#0F172A', // Slate 900
                            secondary: '#475569', // Slate 600
                            tertiary: '#94A3B8', // Slate 400
                        },
                        border: '#E2E8F0', // Slate 200
                        accent: {
                            DEFAULT: '#4F46E5', // Indigo 600
                            hover: '#4338CA', // Indigo 700
                            light: '#E0E7FF', // Indigo 100
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Baseline Layout & Scroll Behavior */
        html {
            scroll-behavior: smooth;
        }
        
        body {
            overflow-y: scroll; /* Force vertical scrollbar */
        }

        /* Focus States (Stage 5.5.2) */
        :focus-visible {
            outline: 2px solid theme('colors.accent.DEFAULT');
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* Hide Scrollbars for Nav (Stage 6 Add-on) */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* KaTeX Containment Invariant (Stage 6.0.8) */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding: 0.5em 0;
            -webkit-overflow-scrolling: touch;
        }
        /* Inline math no background */
        .katex {
            background-color: transparent !important;
        }

        /* Markdown Content Styling */
        .md-content p {
            margin-bottom: 0.75em;
            line-height: 1.6;
        }
        .md-content p:last-child {
            margin-bottom: 0;
        }
        .md-content ul {
            list-style-type: disc;
            padding-left: 1.25em;
            margin-bottom: 0.75em;
        }
        .md-content ol {
            list-style-type: decimal;
            padding-left: 1.25em;
            margin-bottom: 0.75em;
        }
        /* Minimal Structural Tables */
        .md-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 1em 0;
            font-size: 0.95em;
        }
        .md-content th, .md-content td {
            border: 1px solid theme('colors.border');
            padding: 0.5em 0.75em;
            text-align: left;
        }
        .md-content th {
            font-weight: 600;
            background-color: theme('colors.surfaceAlt');
        }

        /* Utility for content subordination */
        .subordinate-text {
            color: theme('colors.txt.secondary');
        }
        
        /* Sticky Nav Persistence cue */
        .nav-sticky-col {
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-base text-txt-primary min-h-screen flex flex-col">

    <!-- TOP CONTROLS REGION -->
    <div class="sticky top-0 z-40 bg-base/95 backdrop-blur border-b border-border w-full">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            
            <!-- Paper Selector -->
            <div class="flex items-center gap-3">
                <label for="paper-select" class="text-sm font-medium text-txt-secondary hidden sm:block">Select Paper:</label>
                <select id="paper-select" class="bg-surface border border-border text-txt-primary text-sm rounded-md px-3 py-1.5 focus:border-accent focus:ring-1 focus:ring-accent outline-none min-w-[200px]">
                    <option value="" disabled selected>Loading papers...</option>
                </select>
            </div>

            <!-- Mobile Jump To Trigger -->
            <button id="mobile-jump-trigger" class="lg:hidden text-sm font-medium text-accent hover:text-accent-hover flex items-center gap-1 px-3 py-1.5 rounded-md hover:bg-accent-light transition-colors" aria-label="Jump to question">
                Jump to
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>
            </button>
        </div>
    </div>

    <!-- DOCUMENT FRAME SHELL -->
    <main class="flex-1 max-w-7xl w-full mx-auto grid grid-cols-1 lg:grid-cols-[240px_1fr] gap-0 lg:gap-12 relative">
        
        <!-- NAVIGATION RAIL (Desktop) -->
        <aside class="hidden lg:block nav-sticky-col py-8 pr-4 no-scrollbar border-r border-transparent"> <!-- Border transparent as no visual separation requested -->
            <nav id="desktop-nav" class="space-y-1" aria-label="Paper navigation">
                <!-- Nav items generated here -->
            </nav>
        </aside>

        <!-- PAPER DOCUMENT COLUMN -->
        <div id="paper-content" class="px-4 sm:px-6 lg:px-0 py-8 lg:py-12 min-h-[50vh]">
            <!-- Paper content generated here -->
            <div class="text-center text-txt-tertiary mt-20">Select a paper to begin.</div>
        </div>

    </main>

    <!-- MOBILE NAVIGATION DRAWER -->
    <div id="mobile-drawer-backdrop" class="fixed inset-0 bg-slate-900/20 backdrop-blur-sm z-50 hidden transition-opacity" aria-hidden="true"></div>
    <div id="mobile-drawer" class="fixed inset-y-0 right-0 w-64 bg-surface shadow-xl transform translate-x-full transition-transform duration-300 z-50 flex flex-col" aria-hidden="true">
        <div class="flex items-center justify-between p-4 border-b border-border">
            <h2 class="text-sm font-semibold text-txt-primary">Jump to</h2>
            <button id="mobile-drawer-close" class="text-txt-secondary hover:text-txt-primary p-1 rounded-md">
                <span class="sr-only">Close navigation</span>
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
        <nav id="mobile-nav-list" class="flex-1 overflow-y-auto p-4 space-y-1">
            <!-- Mobile nav items generated here -->
        </nav>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- CONSTANTS (Canonical) ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // --- STATE ---
        let appData = {
            papers: [],
            currentPaper: null,
            expandedStates: {} // Map: questionId -> boolean
        };

        // --- MARKDOWN SETUP ---
        const md = window.markdownit ? window.markdownit({
            html: true,
            linkify: true,
            breaks: false // Critical: keep false for KaTeX
        }) : null;

        if (md) {
            md.inline.ruler.disable(['escape']);
        }

        // --- DOM ELEMENTS ---
        const els = {
            paperSelect: document.getElementById('paper-select'),
            paperContent: document.getElementById('paper-content'),
            desktopNav: document.getElementById('desktop-nav'),
            mobileNavList: document.getElementById('mobile-nav-list'),
            mobileJumpTrigger: document.getElementById('mobile-jump-trigger'),
            mobileDrawer: document.getElementById('mobile-drawer'),
            mobileDrawerBackdrop: document.getElementById('mobile-drawer-backdrop'),
            mobileDrawerClose: document.getElementById('mobile-drawer-close')
        };

        // --- INITIALIZATION ---
        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Fetch failed");
                const payload = await response.json();
                
                appData.papers = payload.papers || [];
                renderPaperSelector();

                if (appData.papers.length > 0) {
                    loadPaper(appData.papers[0].key);
                }
            } catch (err) {
                console.error(err);
                els.paperContent.innerHTML = `<div class="p-8 text-center text-red-700 font-semibold border border-red-200 bg-red-50 rounded">PAPERS PAYLOAD MISSING</div>`;
            }
        }

        // --- RENDER PAPER SELECTOR ---
        function renderPaperSelector() {
            els.paperSelect.innerHTML = appData.papers.map(p => 
                `<option value="${p.key}">${p.label}</option>`
            ).join('');
            
            els.paperSelect.addEventListener('change', (e) => {
                loadPaper(e.target.value);
            });
        }

        // --- LOAD PAPER ---
        function loadPaper(paperKey) {
            const paper = appData.papers.find(p => p.key === paperKey);
            if (!paper) return;

            appData.currentPaper = paper;
            // Reset expanded states based on defaults
            appData.expandedStates = {}; 
            const defaultExpanded = paper.defaults?.expandedAll !== false; // Default to true if undefined

            // Recursively init expanded states if needed (though we check on render)
            
            renderPaperContent(paper);
            renderNavigation(paper);
            
            // Render Math
            if (window.renderMathInElement) {
                renderMathInElement(els.paperContent, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false}
                    ],
                    throwOnError: false
                });
            }

            // Scroll to top
            window.scrollTo(0,0);
        }

        // --- RENDER NAVIGATION ---
        function renderNavigation(paper) {
            const navItemsHtml = generateNavHtml(paper);
            els.desktopNav.innerHTML = navItemsHtml;
            els.mobileNavList.innerHTML = navItemsHtml;
            
            setupNavInteractions();
        }

        function generateNavHtml(paper) {
            let html = '';
            
            if (paper.sections) {
                paper.sections.forEach(section => {
                    // Section Label (only if non-empty)
                    if (section.label && section.label.trim() !== '') {
                        html += `
                            <div class="mt-4 first:mt-0 mb-1 px-3 text-xs font-bold text-txt-tertiary uppercase tracking-wider select-none">
                                ${section.label}
                            </div>
                        `;
                    }
                    // Section Questions
                    section.questions.forEach(q => {
                        html += generateNavNode(q);
                    });
                });
            } else if (paper.questions) {
                // Flat paper
                paper.questions.forEach(q => {
                    html += generateNavNode(q);
                });
            }
            return html;
        }

        function generateNavNode(questionNode, depth = 0) {
            let html = '';
            // Nav Item: Question Identifier Only. Flat structure visually (no indent).
            // Hierarchy via type scale (Stage 5.4.5)
            
            const fontSizeClass = depth === 0 ? 'text-sm font-medium' : 'text-xs font-normal opacity-90';
            const isActive = false; // No persistence tracking logic requested for this simple harness, but structure exists
            
            html += `
                <a href="#q-${questionNode.id}" 
                   class="block px-3 py-1.5 rounded-md text-txt-secondary hover:text-txt-primary hover:bg-slate-100 transition-colors ${fontSizeClass}"
                   data-qid="${questionNode.id}">
                   ${questionNode.id}
                </a>
            `;

            if (questionNode.children && questionNode.children.length > 0) {
                questionNode.children.forEach(child => {
                    html += generateNavNode(child, depth + 1);
                });
            }
            return html;
        }

        // --- RENDER PAPER CONTENT ---
        function renderPaperContent(paper) {
            let html = '';

            if (paper.sections) {
                paper.sections.forEach(section => {
                    // Section Header
                    if (section.label && section.label.trim() !== '') {
                        html += `
                            <div class="border-b border-border pb-2 mb-8 mt-12 first:mt-0">
                                <h2 class="text-xl font-bold text-txt-primary">${section.label}</h2>
                            </div>
                        `;
                    }
                    // Section Questions
                    html += `<div class="space-y-12">`; // Spacing between top-level questions
                    section.questions.forEach(q => {
                        html += renderQuestionNode(q, 0);
                    });
                    html += `</div>`;
                });
            } else if (paper.questions) {
                html += `<div class="space-y-12">`;
                paper.questions.forEach(q => {
                    html += renderQuestionNode(q, 0);
                });
                html += `</div>`;
            }

            els.paperContent.innerHTML = html;
        }

        function renderQuestionNode(node, depth) {
            const isTopLevel = depth === 0;
            const hasSolutionBlock = !!node.solutionBlock;
            const hasAnswer = hasSolutionBlock && !!node.solutionBlock.answer;
            const hasDetails = hasSolutionBlock && !!node.solutionBlock.solutionDetails;
            
            // Check expanded state: default to paper default if not set
            const defaultExpanded = appData.currentPaper.defaults?.expandedAll !== false;
            if (appData.expandedStates[node.id] === undefined) {
                appData.expandedStates[node.id] = defaultExpanded;
            }
            const isExpanded = appData.expandedStates[node.id];

            // Render Markdown
            const questionHtml = md ? md.render(node.question) : node.question;
            
            // Start Node Wrapper
            let html = `<div id="q-${node.id}" class="scroll-mt-24 group">`;

            // 1. Question Body
            // Indentation logic for children handled by parent container spacing, 
            // but visually the node itself is just a block.
            // Stage 5.6.1: Question body is primary anchor.
            
            // Flex row for ID + Content
            html += `
                <div class="flex flex-row items-baseline gap-3 sm:gap-4">
                    <span class="flex-none text-txt-tertiary font-semibold text-sm sm:text-base w-8 sm:w-10 text-right select-none pt-1">${node.id}</span>
                    <div class="flex-1 min-w-0">
                        <div class="md-content text-txt-primary text-base sm:text-lg leading-relaxed">
                            ${questionHtml}
                        </div>
            `;

            // 2. Solution Block (Optional)
            if (hasSolutionBlock) {
                html += `<div class="mt-4 sm:mt-6">`; // Spacing Question -> Solution Block

                // Answer (Optional)
                if (hasAnswer) {
                    const answerHtml = md ? md.render(node.solutionBlock.answer) : node.solutionBlock.answer;
                    html += `
                        <div class="mb-4">
                            <span class="text-xs font-bold uppercase tracking-wider text-txt-secondary block mb-1">Answer</span>
                            <div class="md-content text-txt-primary font-medium text-base">
                                ${answerHtml}
                            </div>
                        </div>
                    `;
                }

                // Solution Details (Optional)
                if (hasDetails) {
                    const details = node.solutionBlock.solutionDetails;
                    const expandId = `details-${node.id}`;
                    
                    // Toggle Control
                    html += `
                        <button onclick="toggleDetails('${node.id}')" 
                            class="inline-flex items-center gap-2 text-sm font-medium text-accent hover:text-accent-hover transition-colors focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-accent rounded-sm py-1"
                            aria-expanded="${isExpanded}" aria-controls="${expandId}">
                            <span>${isExpanded ? 'Hide working' : 'Show working'}</span>
                            <svg class="w-4 h-4 transform transition-transform ${isExpanded ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                    `;

                    // Expandable Region
                    // Stage 5.3.3: Surface differentiation allowed. Using 'bg-surfaceAlt' (slate-100)
                    if (isExpanded) {
                        html += `
                            <div id="${expandId}" class="mt-3 p-4 sm:p-6 bg-surfaceAlt rounded-sm border-l-2 border-border animate-in fade-in slide-in-from-top-1 duration-200">
                        `;
                        
                        // Order: Keep in mind -> Formulas -> Working -> Alternative
                        
                        // Keep in mind
                        if (details.keepInMind) {
                            html += `
                                <div class="mb-6">
                                    <div class="flex items-center gap-2 mb-2 text-txt-secondary">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                        <h4 class="text-sm font-bold uppercase tracking-wide">Keep in mind</h4>
                                    </div>
                                    <div class="md-content text-sm text-txt-secondary">
                                        ${md ? md.render(details.keepInMind) : details.keepInMind}
                                    </div>
                                </div>
                            `;
                        }

                        // Formulas used
                        if (details.formulasUsed) {
                            html += `
                                <div class="mb-6">
                                    <h4 class="text-xs font-bold uppercase tracking-wide text-txt-tertiary mb-2">Formulas used</h4>
                                    <div class="md-content text-sm text-txt-secondary">
                                        ${md ? md.render(details.formulasUsed) : details.formulasUsed}
                                    </div>
                                </div>
                            `;
                        }

                        // Working (Primary)
                        if (details.working) {
                            html += `
                                <div class="mb-6 last:mb-0">
                                    <h4 class="text-xs font-bold uppercase tracking-wide text-txt-tertiary mb-2">Working</h4>
                                    <div class="md-content text-base text-txt-secondary">
                                        ${md ? md.render(details.working) : details.working}
                                    </div>
                                </div>
                            `;
                        }

                        // Alternative working (Array)
                        if (details.alternativeWorking && details.alternativeWorking.length > 0) {
                            details.alternativeWorking.forEach((alt, idx) => {
                                html += `
                                    <div class="mt-8 pt-6 border-t border-border/50">
                                        <h4 class="text-xs font-bold uppercase tracking-wide text-txt-tertiary mb-2">Alternative working ${idx > 0 ? idx + 1 : ''}</h4>
                                        <div class="md-content text-base text-txt-secondary">
                                            ${md ? md.render(alt) : alt}
                                        </div>
                                    </div>
                                `;
                            });
                        } else if (typeof details.alternativeWorking === 'string') {
                            // Handle string case if schema varies
                            html += `
                                <div class="mt-8 pt-6 border-t border-border/50">
                                    <h4 class="text-xs font-bold uppercase tracking-wide text-txt-tertiary mb-2">Alternative working</h4>
                                    <div class="md-content text-base text-txt-secondary">
                                        ${md ? md.render(details.alternativeWorking) : details.alternativeWorking}
                                    </div>
                                </div>
                            `;
                        }

                        html += `</div>`; // End Expanded Region
                    }
                }

                html += `</div>`; // End Solution Block Wrapper
            }

            html += `
                    </div> <!-- End Flex-1 Content -->
                </div> <!-- End Flex Row -->
            `;

            // 3. Children Container
            if (node.children && node.children.length > 0) {
                html += `<div class="mt-6 ml-0 sm:ml-4 border-l border-transparent pl-0 sm:pl-0 space-y-6">`;
                // Indentation logic: We don't use heavy indentation lines, just spacing.
                // The brief says "Horizontal indentation... adapts by viewport".
                // I'll add a wrapper with margin-left for hierarchy.
                html += `<div class="pl-4 sm:pl-10 space-y-8">`;
                
                node.children.forEach(child => {
                    html += renderQuestionNode(child, depth + 1);
                });
                
                html += `</div></div>`;
            }

            html += `</div>`; // End Node Wrapper
            return html;
        }

        // --- INTERACTIONS ---
        
        window.toggleDetails = (nodeId) => {
            appData.expandedStates[nodeId] = !appData.expandedStates[nodeId];
            
            // Re-render specific question logic is tricky without a framework.
            // For prototype simplicity, we'll re-render the whole paper content
            // but try to maintain scroll position relatively.
            // Better approach for vanilla: Just find the container and replace HTML? 
            // Or just re-render full paper. Given the "No code" constraints on earlier stages,
            // let's do full re-render for correctness, it's fast enough for a prototype.
            
            // However, scroll position jump is annoying.
            // Let's grab current scroll Y.
            const scrollY = window.scrollY;
            
            // Re-render
            renderPaperContent(appData.currentPaper);
            
            // Re-run math
            if (window.renderMathInElement) {
                renderMathInElement(els.paperContent, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false}
                    ],
                    throwOnError: false
                });
            }

            window.scrollTo(0, scrollY);
        };

        function setupNavInteractions() {
            // Highlight active nav item (basic logic)
            // Mobile close on click
            document.querySelectorAll('#mobile-nav-list a').forEach(link => {
                link.addEventListener('click', () => {
                    closeMobileDrawer();
                });
            });
        }

        // Mobile Drawer Logic
        function openMobileDrawer() {
            els.mobileDrawer.classList.remove('translate-x-full');
            els.mobileDrawerBackdrop.classList.remove('hidden');
            setTimeout(() => {
                els.mobileDrawerBackdrop.classList.remove('opacity-0');
            }, 10);
            document.body.style.overflow = 'hidden';
        }

        function closeMobileDrawer() {
            els.mobileDrawer.classList.add('translate-x-full');
            els.mobileDrawerBackdrop.classList.add('opacity-0');
            setTimeout(() => {
                els.mobileDrawerBackdrop.classList.add('hidden');
            }, 300);
            document.body.style.overflow = '';
        }

        els.mobileJumpTrigger.addEventListener('click', openMobileDrawer);
        els.mobileDrawerClose.addEventListener('click', closeMobileDrawer);
        els.mobileDrawerBackdrop.addEventListener('click', closeMobileDrawer);

        // --- RUN ---
        init();

    </script>
</body>
</html>
