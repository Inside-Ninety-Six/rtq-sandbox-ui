<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"A","indexWithinVariant":"11","totalWithinVariant":"50","hueFamily":"","intensityMode":"","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-08T11:41:34.795Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;A&quot;,&quot;indexWithinVariant&quot;:&quot;11&quot;,&quot;totalWithinVariant&quot;:&quot;50&quot;,&quot;hueFamily&quot;:&quot;&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-08T11:41:34.795Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>

    <!-- Typography: Inter (Modern, Friendly, Sans) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- KaTeX CSS (No Integrity/Crossorigin as per Stage 6 baseline) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <!-- Markdown-it & KaTeX JS -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <style>
        /* 
         * COLORLAB A ENABLED: Palette Freedom (Light Only).
         * Posture: Clean, Modern, Professional.
         * Base: White/Slate. Accent: Indigo.
         */
        :root {
            /* Semantic Palette */
            --bg-page: #ffffff;
            --bg-surface: #ffffff;
            --bg-subtle: #f8fafc; /* Slate 50 */
            --bg-wash: #f1f5f9;   /* Slate 100 - For expanded regions if needed */
            
            --text-primary: #0f172a; /* Slate 900 */
            --text-secondary: #475569; /* Slate 600 */
            --text-tertiary: #94a3b8; /* Slate 400 */
            
            --border-hairline: #e2e8f0; /* Slate 200 */
            --border-subtle: #cbd5e1; /* Slate 300 */

            --accent-color: #4f46e5; /* Indigo 600 */
            --accent-subtle: #e0e7ff; /* Indigo 100 */

            /* Spacing Tokens (Base 4px) */
            --sp-1: 0.25rem;
            --sp-2: 0.5rem;
            --sp-3: 0.75rem;
            --sp-4: 1rem;
            --sp-6: 1.5rem;
            --sp-8: 2rem;
            --sp-12: 3rem;

            /* Dimensions */
            --nav-width: 240px;
            --frame-max-width: 1280px;
        }

        /* Reset & Base */
        * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-page);
            color: var(--text-primary);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        /* Typography Utilities */
        .type-h1 { font-size: 1.5rem; font-weight: 600; }
        .type-body { font-size: 1rem; font-weight: 400; line-height: 1.6; }
        .type-label { font-size: 0.875rem; font-weight: 600; color: var(--text-secondary); }
        .type-small { font-size: 0.875rem; color: var(--text-secondary); }
        .type-nav { font-size: 0.925rem; }
        
        /* Layout Shell */
        .shell {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .top-controls {
            position: sticky;
            top: 0;
            z-index: 50;
            background: var(--bg-page); /* Matches base surface */
            border-bottom: 1px solid var(--border-hairline);
            padding: var(--sp-3) var(--sp-4);
        }

        .frame {
            display: flex;
            width: 100%;
            max-width: var(--frame-max-width);
            margin: 0 auto;
            flex: 1;
            position: relative;
        }

        /* Navigation Rail (Desktop) */
        .nav-rail {
            width: var(--nav-width);
            flex-shrink: 0;
            position: sticky;
            top: 60px; /* Offset for top controls */
            height: calc(100vh - 60px);
            overflow-y: auto;
            padding: var(--sp-6) var(--sp-4) var(--sp-6) 0;
            display: none; /* Mobile default */
            /* Scrollbar hiding */
            scrollbar-width: none; 
            -ms-overflow-style: none;
        }
        .nav-rail::-webkit-scrollbar { display: none; }

        @media (min-width: 1024px) {
            .nav-rail { display: block; }
            .mobile-trigger { display: none; }
        }

        /* Navigation Items */
        .nav-list { list-style: none; padding: 0; margin: 0; }
        .nav-section-label {
            display: block;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-tertiary);
            margin-top: var(--sp-4);
            margin-bottom: var(--sp-2);
        }
        .nav-item {
            display: block;
            text-decoration: none;
            color: var(--text-secondary);
            padding: var(--sp-1) 0;
            cursor: pointer;
            transition: color 0.15s ease;
            text-align: left;
            border: none;
            background: none;
            width: 100%;
        }
        .nav-item:hover { color: var(--text-primary); }
        .nav-item.active { 
            color: var(--accent-color); 
            font-weight: 600; 
        }
        /* Hierarchy via type scale only */
        .nav-item[data-depth="0"] { font-size: 0.95rem; }
        .nav-item[data-depth="1"] { font-size: 0.875rem; color: var(--text-secondary); }
        .nav-item[data-depth="2"] { font-size: 0.825rem; color: var(--text-tertiary); }

        /* Content Column */
        .paper-content {
            flex: 1;
            padding: var(--sp-6) var(--sp-4) var(--sp-12) var(--sp-4);
            min-width: 0; /* Prevent flex blowout */
        }
        @media (min-width: 1024px) {
            .paper-content { padding-left: var(--sp-12); }
        }

        /* Question Node Structure */
        .question-node {
            margin-bottom: var(--sp-12); /* Large spacing between top-level questions */
            scroll-margin-top: 100px;
        }
        .question-node[data-child="true"] {
            margin-bottom: var(--sp-6);
            padding-left: 0;
        }
        /* Indentation for children */
        .children-container {
            margin-top: var(--sp-4);
            padding-left: var(--sp-4);
            border-left: 1px solid transparent; /* Structural placeholder */
        }
        @media (min-width: 768px) {
            .children-container { padding-left: var(--sp-8); }
        }

        /* Question Body */
        .q-body {
            display: flex;
            gap: var(--sp-3);
            margin-bottom: var(--sp-4);
        }
        .q-id {
            font-weight: 600;
            color: var(--text-secondary);
            flex-shrink: 0;
            min-width: 1.5em;
        }
        .q-prompt {
            color: var(--text-primary);
            width: 100%;
        }

        /* Solution Block */
        .solution-block {
            margin-top: var(--sp-4);
            margin-left: 0; /* Aligned with question flow */
        }
        @media (min-width: 768px) {
            .solution-block { margin-left: calc(1.5em + var(--sp-3)); }
        }

        /* Answer */
        .answer-region {
            margin-bottom: var(--sp-4);
        }
        .answer-label {
            font-size: 0.875rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-right: var(--sp-2);
        }

        /* Disclosure Control */
        .disclosure-btn {
            background: none;
            border: none;
            padding: 0;
            font-size: 0.925rem;
            color: var(--accent-color);
            cursor: pointer;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: var(--sp-1);
            margin-bottom: var(--sp-3);
        }
        .disclosure-btn:hover { text-decoration: underline; }
        .disclosure-btn:focus-visible { outline: 2px solid var(--accent-color); outline-offset: 2px; border-radius: 2px; }
        .chevron { transition: transform 0.2s ease; width: 16px; height: 16px; fill: currentColor; }
        .disclosure-btn[aria-expanded="true"] .chevron { transform: rotate(180deg); }

        /* Solution Details Region */
        .solution-details {
            display: none;
            animation: fadeIn 0.2s ease;
        }
        .solution-details[data-visible="true"] { display: block; }
        
        /* Optional Wash for density resilience (Stage 3 permitted) */
        .solution-details-content {
            /* padding: var(--sp-4); */ /* Padding removed to maintain flow, using left border or spacing instead */
            position: relative;
        }

        /* Internal Subsections */
        .sd-section { margin-bottom: var(--sp-6); }
        .sd-label {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 700;
            color: var(--text-tertiary);
            margin-bottom: var(--sp-2);
            display: block;
        }
        .sd-body { font-size: 0.95rem; color: var(--text-secondary); }

        /* Working / Alternative Working */
        .working-block + .alt-working-block {
            margin-top: var(--sp-8);
            padding-top: var(--sp-6);
            border-top: 1px solid var(--border-hairline); /* Allowed separator */
        }

        /* Tables (Minimal) */
        table { border-collapse: collapse; width: 100%; margin: var(--sp-4) 0; font-size: 0.9rem; }
        th, td { border: 1px solid var(--border-hairline); padding: var(--sp-2) var(--sp-3); text-align: left; }
        th { font-weight: 600; background-color: var(--bg-subtle); }

        /* Math Containment & KaTeX Overrides */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            padding: var(--sp-2) 0;
            margin: var(--sp-3) 0;
            max-width: 100%;
            -webkit-overflow-scrolling: touch;
        }
        /* Inline math: transparent background */
        .katex { background-color: transparent !important; }

        /* Mobile Drawer */
        .drawer-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 100;
            display: none;
        }
        .drawer {
            position: fixed; top: 0; bottom: 0; left: 0;
            width: 85%; max-width: 320px;
            background: var(--bg-page);
            z-index: 101;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 12px rgba(0,0,0,0.1);
        }
        .drawer.open { transform: translateX(0); }
        .drawer-overlay.open { display: block; }
        .drawer-header {
            padding: var(--sp-4);
            border-bottom: 1px solid var(--border-hairline);
            display: flex; justify-content: space-between; align-items: center;
        }
        .drawer-content { overflow-y: auto; flex: 1; padding: var(--sp-4); }

        /* Select Input */
        .paper-select {
            padding: var(--sp-2) var(--sp-8) var(--sp-2) var(--sp-3);
            border: 1px solid var(--border-subtle);
            border-radius: 4px;
            font-family: inherit;
            font-size: 0.925rem;
            color: var(--text-primary);
            background: var(--bg-surface) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23475569'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E") no-repeat right 0.5rem center;
            background-size: 1.25em;
            appearance: none;
            cursor: pointer;
        }
        .paper-select:focus { outline: 2px solid var(--accent-color); border-color: var(--accent-color); }

        /* Utilities */
        .hidden { display: none !important; }
        .error-msg { 
            padding: var(--sp-8); 
            text-align: center; 
            color: var(--text-secondary); 
            font-weight: 500; 
            border: 1px dashed var(--border-subtle);
            margin: var(--sp-8);
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Divider Utilities (Stage 3 Optional) */
        .divider-hairline { height: 1px; background: var(--border-hairline); width: 100%; margin: var(--sp-4) 0; }
    </style>
</head>
<body>

<div class="shell">
    <!-- Top Controls -->
    <div class="top-controls">
        <div class="frame" style="align-items: center; justify-content: space-between;">
            <div style="display: flex; align-items: center; gap: var(--sp-4);">
                <!-- Paper Selector -->
                <select id="paper-selector" class="paper-select" aria-label="Select Paper">
                    <option disabled selected>Loading papers...</option>
                </select>
            </div>
            
            <!-- Mobile Jump To Trigger -->
            <button id="mobile-jump-btn" class="mobile-trigger disclosure-btn" style="color: var(--text-primary);">
                <span>Jump to</span>
                <svg viewBox="0 0 24 24" width="20" height="20" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
            </button>
        </div>
    </div>

    <!-- Main Document Frame -->
    <div class="frame">
        <!-- Desktop Nav Rail -->
        <nav id="desktop-nav" class="nav-rail" aria-label="Paper Navigation">
            <!-- Populated via JS -->
        </nav>

        <!-- Paper Content Region -->
        <main id="paper-content" class="paper-content">
            <!-- Populated via JS -->
            <div class="error-msg">Loading content...</div>
        </main>
    </div>
</div>

<!-- Mobile Drawer -->
<div id="drawer-overlay" class="drawer-overlay"></div>
<aside id="mobile-drawer" class="drawer" aria-label="Mobile Navigation">
    <div class="drawer-header">
        <span class="type-h1" style="font-size: 1.1rem;">Jump to</span>
        <button id="drawer-close" class="disclosure-btn" style="color: var(--text-secondary);">
            <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </button>
    </div>
    <div id="drawer-nav-content" class="drawer-content">
        <!-- Cloned Nav Content -->
    </div>
</aside>

<script>
/**
 * STAGE 0: CONSTANTS (Canonical)
 */
const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

/**
 * STATE & INIT
 */
let papersData = [];
let currentPaperId = null;

// Markdown Renderer Configuration (Authoritative Stage 6)
const md = window.markdownit ? window.markdownit({
    html: true, // Allow inline SVG
    linkify: true,
    breaks: false // Critical: prevent <br> in math blocks
}) : null;

if (md) {
    // Preserve TeX backslashes
    md.inline.ruler.disable(['escape']);
}

/**
 * CORE RENDER LOGIC
 */
async function init() {
    try {
        const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
        if (!response.ok) throw new Error("Payload not found");
        
        const payload = await response.json();
        if (!payload.papers || !Array.isArray(payload.papers)) throw new Error("Invalid payload");
        
        papersData = payload.papers;
        populateSelector();
        
        // Default to first paper
        if (papersData.length > 0) {
            loadPaper(papersData[0].key);
        }
    } catch (e) {
        console.error(e);
        renderError();
    }
    
    setupInteractions();
}

function renderError() {
    const el = document.getElementById('paper-content');
    el.innerHTML = `<div class="error-msg">PAPERS PAYLOAD MISSING</div>`;
    // Clear nav
    document.getElementById('desktop-nav').innerHTML = '';
}

function populateSelector() {
    const select = document.getElementById('paper-selector');
    select.innerHTML = '';
    
    papersData.forEach(paper => {
        const opt = document.createElement('option');
        opt.value = paper.key;
        opt.textContent = paper.label || paper.key;
        select.appendChild(opt);
    });
    
    select.addEventListener('change', (e) => {
        loadPaper(e.target.value);
    });
}

function loadPaper(key) {
    currentPaperId = key;
    const paper = papersData.find(p => p.key === key);
    if (!paper) return;

    // Reset scroll
    window.scrollTo(0, 0);

    // Render Content
    const contentContainer = document.getElementById('paper-content');
    contentContainer.innerHTML = '';
    
    // Render Navigation
    const navContainer = document.getElementById('desktop-nav');
    navContainer.innerHTML = ''; // Clear

    // Handle Sections vs Flat
    let flatQuestionList = [];
    
    if (paper.sections && Array.isArray(paper.sections)) {
        paper.sections.forEach(section => {
            // Render Section Header in Content? 
            // Stage 3: Section block (optional; only if section headers exist).
            if (section.label && section.label.trim().length > 0) {
                // Render content section header
                const secHeader = document.createElement('div');
                secHeader.className = 'type-h1';
                secHeader.style.marginBottom = 'var(--sp-6)';
                secHeader.style.paddingBottom = 'var(--sp-2)';
                secHeader.style.borderBottom = '1px solid var(--border-hairline)';
                secHeader.textContent = section.label;
                contentContainer.appendChild(secHeader);

                // Nav Section Label
                const navSecLabel = document.createElement('span');
                navSecLabel.className = 'nav-section-label';
                navSecLabel.textContent = section.label;
                navContainer.appendChild(navSecLabel);
            }
            
            // Render questions in this section
            if (section.questions) {
                section.questions.forEach(q => {
                    renderQuestionNode(q, contentContainer, 0, paper.defaults);
                    addToNav(q, navContainer, 0);
                    // Collect for flat list tracking if needed, but nav is built directly
                });
            }
        });
    } else if (paper.questions) {
        paper.questions.forEach(q => {
            renderQuestionNode(q, contentContainer, 0, paper.defaults);
            addToNav(q, navContainer, 0);
        });
    }

    // Sync Mobile Nav
    const drawerContent = document.getElementById('drawer-nav-content');
    drawerContent.innerHTML = '';
    const clonedNav = navContainer.cloneNode(true);
    // Remove ids from clone to avoid dupes
    clonedNav.removeAttribute('id');
    // Convert links to close drawer
    Array.from(clonedNav.querySelectorAll('button')).forEach(btn => {
        btn.addEventListener('click', () => {
            closeDrawer();
            const targetId = btn.getAttribute('data-target');
            const target = document.getElementById(targetId);
            if (target) {
                target.scrollIntoView({behavior: 'smooth', block: 'start'});
                updateActiveNav(targetId);
            }
        });
    });
    drawerContent.appendChild(clonedNav);

    // Apply KaTeX
    renderMathInElement(contentContainer, {
        delimiters: [
            {left: '$$', right: '$$', display: true},
            {left: '$', right: '$', display: false}
        ],
        throwOnError: false,
        output: 'html' // MathML is better for accessibility but HTML is robust for layout
    });
    
    // Initial scroll spy setup
    setupScrollSpy();
}

/**
 * RECURSIVE QUESTION RENDERER
 */
function renderQuestionNode(node, container, depth, defaults) {
    const nodeEl = document.createElement('div');
    nodeEl.className = 'question-node';
    nodeEl.id = `q-${node.id}`; // DOM ID for anchoring
    nodeEl.setAttribute('data-child', depth > 0);
    
    // 1. Question Body
    const qBody = document.createElement('div');
    qBody.className = 'q-body';
    
    const qId = document.createElement('div');
    qId.className = 'q-id';
    qId.textContent = node.id;
    
    const qPrompt = document.createElement('div');
    qPrompt.className = 'q-prompt type-body';
    qPrompt.innerHTML = md ? md.render(node.question || '') : (node.question || '');
    
    qBody.appendChild(qId);
    qBody.appendChild(qPrompt);
    nodeEl.appendChild(qBody);

    // 2. Solution Block (Optional)
    if (node.solutionBlock) {
        const sb = document.createElement('div');
        sb.className = 'solution-block';
        
        // A. Answer (Optional, Visible by default)
        if (node.solutionBlock.answer) {
            const ansRegion = document.createElement('div');
            ansRegion.className = 'answer-region type-body';
            
            const ansLabel = document.createElement('span');
            ansLabel.className = 'answer-label';
            ansLabel.textContent = 'Answer';
            
            const ansContent = document.createElement('div');
            ansContent.style.display = 'inline'; // Run-in
            ansContent.innerHTML = md ? md.renderInline(node.solutionBlock.answer) : node.solutionBlock.answer;
            
            ansRegion.appendChild(ansLabel);
            ansRegion.appendChild(ansContent);
            sb.appendChild(ansRegion);
        }
        
        // B. Solution Details (Optional, Expandable)
        if (node.solutionBlock.solutionDetails) {
            const sdData = node.solutionBlock.solutionDetails;
            
            // Toggle
            const isExpandedDefault = defaults && defaults.expandedAll !== false;
            
            const toggleBtn = document.createElement('button');
            toggleBtn.className = 'disclosure-btn';
            toggleBtn.setAttribute('aria-expanded', isExpandedDefault);
            toggleBtn.setAttribute('aria-controls', `sd-${node.id}`);
            toggleBtn.innerHTML = `
                <span class="btn-text">${isExpandedDefault ? 'Hide working' : 'Show working'}</span>
                <svg class="chevron" viewBox="0 0 24 24"><path fill="currentColor" d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>
            `;
            
            const sdRegion = document.createElement('div');
            sdRegion.id = `sd-${node.id}`;
            sdRegion.className = 'solution-details';
            sdRegion.setAttribute('data-visible', isExpandedDefault);
            
            const sdContent = document.createElement('div');
            sdContent.className = 'solution-details-content';
            
            // Content Order: KeepInMind -> Formulas -> Working -> AltWorking
            
            // Keep in Mind
            if (sdData.keepInMind) {
                sdContent.appendChild(renderSDSection('Keep in mind', sdData.keepInMind, false));
            }
            
            // Formulas Used
            if (sdData.formulasUsed) {
                sdContent.appendChild(renderSDSection('Formulas used', sdData.formulasUsed, false));
            }
            
            // Working
            if (sdData.working) {
                sdContent.appendChild(renderSDSection('Working', sdData.working, true));
            }
            
            // Alternative Working (Array)
            if (sdData.alternativeWorking && Array.isArray(sdData.alternativeWorking)) {
                sdData.alternativeWorking.forEach((altText) => {
                    sdContent.appendChild(renderSDSection('Alternative working', altText, true, 'alt-working-block'));
                });
            } else if (typeof sdData.alternativeWorking === 'string') {
                 // Fallback if string
                 sdContent.appendChild(renderSDSection('Alternative working', sdData.alternativeWorking, true, 'alt-working-block'));
            }

            sdRegion.appendChild(sdContent);
            
            // Wiring
            toggleBtn.addEventListener('click', () => {
                const expanded = toggleBtn.getAttribute('aria-expanded') === 'true';
                toggleBtn.setAttribute('aria-expanded', !expanded);
                toggleBtn.querySelector('.btn-text').textContent = !expanded ? 'Hide working' : 'Show working';
                sdRegion.setAttribute('data-visible', !expanded);
            });
            
            sb.appendChild(toggleBtn);
            sb.appendChild(sdRegion);
        }
        
        nodeEl.appendChild(sb);
    }

    // 3. Children (Recursion)
    if (node.children && node.children.length > 0) {
        const childrenContainer = document.createElement('div');
        childrenContainer.className = 'children-container';
        
        node.children.forEach(child => {
            renderQuestionNode(child, childrenContainer, depth + 1, defaults);
            // NOTE: Children are not added to Nav structure recursively in layout grammar, 
            // but the prompt says "Navigation must expose the full set of question identifiers".
            // So we handle nav addition outside this recursive render loop to flattening logic.
            // Actually, renderQuestionNode is recursive for content. Nav is flat list.
            // We need to sync nav addition.
        });
        
        nodeEl.appendChild(childrenContainer);
    }

    container.appendChild(nodeEl);
}

function renderSDSection(label, mdText, isBlock, extraClass = '') {
    const wrap = document.createElement('div');
    wrap.className = `sd-section ${extraClass} ${label === 'Working' ? 'working-block' : ''}`;
    
    const lbl = document.createElement('span');
    lbl.className = 'sd-label';
    lbl.textContent = label;
    
    const body = document.createElement('div');
    body.className = 'sd-body type-body';
    body.innerHTML = md ? md.render(mdText) : mdText;
    
    wrap.appendChild(lbl);
    wrap.appendChild(body);
    return wrap;
}

/**
 * NAV RENDERING
 * Recursively walk node tree (or traverse children) to build flat list
 */
function addToNav(node, container, depth) {
    const item = document.createElement('button');
    item.className = 'nav-item';
    item.textContent = node.id;
    item.setAttribute('data-target', `q-${node.id}`);
    item.setAttribute('data-depth', Math.min(depth, 2)); // Cap depth for visual
    
    item.addEventListener('click', () => {
        const target = document.getElementById(`q-${node.id}`);
        if (target) {
            target.scrollIntoView({behavior: 'smooth', block: 'start'});
            updateActiveNav(`q-${node.id}`);
        }
    });
    
    container.appendChild(item);
    
    if (node.children) {
        node.children.forEach(child => addToNav(child, container, depth + 1));
    }
}

/**
 * INTERACTIONS & UI
 */
function setupInteractions() {
    // Mobile Drawer
    const jumpBtn = document.getElementById('mobile-jump-btn');
    const closeBtn = document.getElementById('drawer-close');
    const overlay = document.getElementById('drawer-overlay');
    const drawer = document.getElementById('mobile-drawer');
    
    function openDrawer() {
        drawer.classList.add('open');
        overlay.classList.add('open');
        document.body.style.overflow = 'hidden'; // Lock scroll
    }
    
    function _closeDrawer() {
        drawer.classList.remove('open');
        overlay.classList.remove('open');
        document.body.style.overflow = '';
    }
    
    jumpBtn.addEventListener('click', openDrawer);
    closeBtn.addEventListener('click', _closeDrawer);
    overlay.addEventListener('click', _closeDrawer);
    
    window.closeDrawer = _closeDrawer; // Expose for nav items
}

function updateActiveNav(targetId) {
    // Desktop
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    const dNavItem = document.querySelector(`#desktop-nav .nav-item[data-target="${targetId}"]`);
    if (dNavItem) dNavItem.classList.add('active');
    
    // Mobile
    // (Optional: sync active state in drawer)
}

function setupScrollSpy() {
    // Simple IntersectionObserver for active nav state
    const observer = new IntersectionObserver((entries) => {
        // Find the first visible element
        const visible = entries.find(e => e.isIntersecting);
        if (visible) {
            updateActiveNav(visible.target.id);
        }
    }, {
        rootMargin: '-10% 0px -80% 0px', // Focus area top of screen
        threshold: 0
    });
    
    document.querySelectorAll('.question-node').forEach(el => observer.observe(el));
}

// Start
document.addEventListener('DOMContentLoaded', init);

</script>
</body>
</html>
