<!DOCTYPE html>
<html lang="en" class="antialiased text-slate-900 bg-slate-50">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"A","indexWithinVariant":"16","totalWithinVariant":"50","hueFamily":"","intensityMode":"","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-08T11:54:37.212Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;A&quot;,&quot;indexWithinVariant&quot;:&quot;16&quot;,&quot;totalWithinVariant&quot;:&quot;50&quot;,&quot;hueFamily&quot;:&quot;&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-08T11:54:37.212Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>

    <!-- Tailwind CSS (Styling) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- KaTeX CSS (Maths) - No Integrity per Stage 6 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <!-- Markdown-it & KaTeX JS - No Integrity per Stage 6 -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Alpine.js (Interactivity) -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>

    <style>
        /* Typography System - ColorLab A Theme (Light Mode Only, Free Palette) */
        :root {
            --font-sans: 'Inter', sans-serif;
            --color-accent: #6d28d9; /* Violet-700 for focus/active */
            --color-focus: #8b5cf6;  /* Violet-500 ring */
        }
        
        body {
            font-family: var(--font-sans);
            /* Stage 5.3.1 Override: Light mode only, warm/neutral base allowed. Using Slate-50. */
            background-color: #f8fafc; 
        }

        /* Focus Visibility - Stage 5.5.2 */
        *:focus-visible {
            outline: 2px solid var(--color-focus);
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* Scrollbar Hiding (Navigation) - Add-on */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* KaTeX Containment Invariant - Stage 6.0.8 */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding-bottom: 4px; /* Space for scrollbar if needed */
            -webkit-overflow-scrolling: touch;
        }
        
        /* Inline KaTeX Transparent Background - Stage 5.8.4 */
        .katex {
            background-color: transparent !important;
        }

        /* Markdown Table Minimal Styling */
        table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 1rem;
            font-size: 0.95em;
        }
        th, td {
            border: 1px solid #e2e8f0; /* Slate-200 */
            padding: 0.5rem 0.75rem;
            text-align: left;
        }
        th {
            font-weight: 600;
            background-color: transparent;
        }

        /* Navigation Sticky & Scrolling */
        .nav-sticky-container {
            position: sticky;
            top: 1rem;
            max-height: calc(100vh - 2rem);
            overflow-y: auto;
        }

        /* Smooth Scrolling */
        html {
            scroll-behavior: smooth;
        }
        
        /* Utility for content rendering */
        .markdown-content p {
            margin-bottom: 0.75em;
            line-height: 1.6;
        }
        .markdown-content p:last-child {
            margin-bottom: 0;
        }
    </style>
</head>
<body>

    <!-- Runtime Constants Definition (Stage 6.0.1b) -->
    <script>
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";
    </script>

    <!-- Main App Container -->
    <div id="app" x-data="paperViewer()" x-init="init()" class="min-h-screen flex flex-col items-center pb-24">

        <!-- Top Controls Region (Aligned to Frame) -->
        <div class="w-full max-w-[1200px] px-4 md:px-8 pt-4 pb-2 md:pb-8 flex justify-between items-center z-20">
            <!-- Paper Selector -->
            <div class="relative">
                <select 
                    x-model="currentPaperKey" 
                    @change="loadPaper(currentPaperKey)"
                    class="appearance-none bg-white border border-slate-300 text-slate-900 text-sm rounded px-3 py-2 pr-8 focus:ring-2 focus:ring-violet-500 focus:border-transparent cursor-pointer shadow-sm hover:border-slate-400 transition-colors"
                    :disabled="isLoading || error">
                    <template x-for="paper in papers" :key="paper.key">
                        <option :value="paper.key" x-text="paper.label"></option>
                    </template>
                </select>
                <!-- Custom Chevron -->
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-500">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </div>
            </div>

            <!-- Mobile "Jump to" Trigger (Stage 6.0.6 - Drawer) -->
            <button 
                @click="mobileNavOpen = true"
                class="md:hidden inline-flex items-center justify-center p-2 rounded text-slate-600 hover:text-violet-700 hover:bg-violet-50 focus:bg-violet-50 transition-colors"
                aria-label="Jump to question">
                <span class="text-sm font-medium mr-1">Jump to</span>
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
            </button>
        </div>

        <!-- DocumentFrameShell (Structure) -->
        <div class="w-full max-w-[1200px] px-4 md:px-8 grid grid-cols-1 md:grid-cols-[200px_1fr] gap-0 md:gap-12 lg:gap-16 items-start">

            <!-- Navigation Column (Desktop) -->
            <nav class="hidden md:block nav-sticky-container pr-4" aria-label="Paper navigation">
                <!-- Navigation List (Flat) -->
                <div class="flex flex-col space-y-1">
                    <template x-for="item in flatNavItems" :key="item.uniqueKey">
                        <div class="flex flex-col">
                            <!-- Section Label (if visible) -->
                            <template x-if="item.isSectionLabel">
                                <div class="mt-4 mb-2 text-xs font-semibold text-slate-400 uppercase tracking-wider select-none px-2" x-text="item.label"></div>
                            </template>
                            
                            <!-- Question Item -->
                            <template x-if="!item.isSectionLabel">
                                <a 
                                    :href="'#' + item.anchorId"
                                    class="group flex items-center px-2 py-1.5 text-sm rounded transition-colors duration-200"
                                    :class="activeNavId === item.anchorId ? 'text-violet-700 font-semibold bg-violet-50/50' : 'text-slate-500 hover:text-slate-900'"
                                    @click.prevent="scrollToId(item.anchorId)">
                                    <!-- Typographic hierarchy via scale/opacity only (Stage 5.4.5) -->
                                    <span 
                                        x-text="item.label" 
                                        :class="{
                                            'text-base': item.depth === 0,
                                            'text-[0.92rem] opacity-90': item.depth === 1,
                                            'text-xs opacity-80': item.depth > 1
                                        }"></span>
                                </a>
                            </template>
                        </div>
                    </template>
                </div>
            </nav>

            <!-- Paper Document Column (Right; Primary) -->
            <main class="w-full bg-white md:shadow-sm md:ring-1 md:ring-slate-900/5 rounded-none md:rounded-sm min-h-[500px] pb-16">
                
                <!-- Error State -->
                <template x-if="error">
                    <div class="p-12 text-center">
                        <p class="text-slate-400 font-medium tracking-wide uppercase text-sm">PAPERS PAYLOAD MISSING</p>
                    </div>
                </template>

                <!-- Loading State -->
                <template x-if="isLoading && !error">
                    <div class="p-12 text-center">
                        <div class="inline-block animate-spin w-6 h-6 border-2 border-slate-200 border-t-violet-600 rounded-full mb-4"></div>
                        <p class="text-slate-400 text-sm">Loading paper...</p>
                    </div>
                </template>

                <!-- Content Render -->
                <div x-show="!isLoading && !error" class="p-6 md:p-10 lg:p-12 space-y-12">
                    
                    <!-- Handle 'sections' vs 'questions' root -->
                    <template x-if="currentPaper">
                        <div>
                            <!-- Case A: Sectioned Paper -->
                            <template x-if="currentPaper.sections">
                                <div class="space-y-12">
                                    <template x-for="(section, secIdx) in currentPaper.sections" :key="secIdx">
                                        <div class="section-block">
                                            <!-- Section Header (Stage 3) -->
                                            <template x-if="section.label && section.label.trim().length > 0">
                                                <div class="mb-8 border-b border-slate-100 pb-2">
                                                    <h2 class="text-lg font-semibold text-slate-800" x-text="section.label"></h2>
                                                </div>
                                            </template>
                                            
                                            <!-- Question List -->
                                            <div class="space-y-16"> <!-- Top level separation: largest unit -->
                                                <template x-for="question in section.questions" :key="question.id">
                                                    <div x-data="{ node: question, depth: 0 }" x-html="renderNode(node, depth)"></div>
                                                </template>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </template>

                            <!-- Case B: Flat Paper -->
                            <template x-if="currentPaper.questions">
                                <div class="space-y-16">
                                    <template x-for="question in currentPaper.questions" :key="question.id">
                                        <div x-data="{ node: question, depth: 0 }" x-html="renderNode(node, depth)"></div>
                                    </template>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>
            </main>

        </div>

        <!-- Mobile Navigation Drawer (Stage 6.0.6) -->
        <div 
            x-show="mobileNavOpen" 
            style="display: none;"
            class="fixed inset-0 z-50 flex justify-end md:hidden"
            role="dialog" aria-modal="true">
            
            <!-- Scrim -->
            <div 
                x-show="mobileNavOpen"
                x-transition.opacity.duration.300ms
                @click="mobileNavOpen = false"
                class="fixed inset-0 bg-slate-900/20 backdrop-blur-sm"></div>

            <!-- Drawer Surface -->
            <div 
                x-show="mobileNavOpen"
                x-transition:enter="transition ease-out duration-300"
                x-transition:enter-start="translate-x-full"
                x-transition:enter-end="translate-x-0"
                x-transition:leave="transition ease-in duration-200"
                x-transition:leave-start="translate-x-0"
                x-transition:leave-end="translate-x-full"
                class="relative w-3/4 max-w-[300px] bg-white h-full shadow-xl flex flex-col">
                
                <!-- Drawer Header -->
                <div class="flex items-center justify-between p-4 border-b border-slate-100">
                    <h2 class="text-sm font-semibold text-slate-800">Jump to</h2>
                    <button @click="mobileNavOpen = false" class="text-slate-400 hover:text-slate-800 p-1">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>

                <!-- Drawer Content -->
                <div class="flex-1 overflow-y-auto p-4">
                     <div class="flex flex-col space-y-1">
                        <template x-for="item in flatNavItems" :key="'mob-' + item.uniqueKey">
                            <div class="flex flex-col">
                                <template x-if="item.isSectionLabel">
                                    <div class="mt-4 mb-2 text-xs font-semibold text-slate-400 uppercase tracking-wider select-none px-2" x-text="item.label"></div>
                                </template>
                                <template x-if="!item.isSectionLabel">
                                    <a 
                                        :href="'#' + item.anchorId"
                                        class="block px-3 py-3 text-base rounded transition-colors"
                                        :class="activeNavId === item.anchorId ? 'bg-violet-50 text-violet-700 font-semibold' : 'text-slate-600 hover:bg-slate-50'"
                                        @click.prevent="scrollToId(item.anchorId); mobileNavOpen = false">
                                        <span x-text="item.label"></span>
                                    </a>
                                </template>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Application Logic -->
    <script>
        document.addEventListener('alpine:init', () => {
            
            // Markdown-it Configuration (Stage 6.0.7 & 6 Add-on)
            const md = window.markdownit ? window.markdownit({
                html: true,       // Enable inline HTML/SVG passthrough
                linkify: true,
                breaks: false     // Critical: must be false for KaTeX
            }) : null;

            if (md) {
                // Disable escape rule to preserve TeX backslashes
                md.inline.ruler.disable(['escape']);
            }

            Alpine.data('paperViewer', () => ({
                papers: [],
                currentPaper: null,
                currentPaperKey: '',
                isLoading: true,
                error: false,
                flatNavItems: [],
                activeNavId: null,
                mobileNavOpen: false,
                expandedStates: {}, // Map of question ID -> boolean

                async init() {
                    try {
                        const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                        if (!response.ok) throw new Error('Failed to load');
                        const payload = await response.json();
                        
                        this.papers = payload.papers;
                        if (this.papers.length > 0) {
                            this.loadPaper(this.papers[0].key);
                        } else {
                            this.error = true;
                        }
                    } catch (e) {
                        console.error(e);
                        this.error = true;
                    } finally {
                        this.isLoading = false;
                    }

                    // Setup scroll listener for Active Nav
                    window.addEventListener('scroll', () => {
                        this.updateActiveNav();
                    }, { passive: true });
                },

                loadPaper(key) {
                    this.isLoading = true;
                    this.currentPaperKey = key;
                    // Reset states
                    this.expandedStates = {};
                    
                    // Artificial small delay for UX smoothness
                    setTimeout(() => {
                        this.currentPaper = this.papers.find(p => p.key === key);
                        
                        if (this.currentPaper) {
                            // Initialize default expanded states based on paper defaults
                            const defaultExpanded = this.currentPaper.defaults?.expandedAll !== false;
                            this.initExpandedStates(this.currentPaper, defaultExpanded);
                            
                            // Build flat nav
                            this.flatNavItems = this.buildFlatNav(this.currentPaper);
                        }
                        
                        this.isLoading = false;
                        
                        // Render Math after DOM update
                        this.$nextTick(() => {
                            this.renderMath();
                            this.updateActiveNav();
                        });
                    }, 50); // 50ms transition
                },

                // Recursive initialization of toggle states
                initExpandedStates(paperData, defaultVal) {
                    const traverse = (nodes) => {
                        nodes.forEach(node => {
                            if (node.solutionBlock?.solutionDetails) {
                                this.expandedStates[node.id] = defaultVal;
                            }
                            if (node.children) traverse(node.children);
                        });
                    };

                    if (paperData.questions) traverse(paperData.questions);
                    if (paperData.sections) {
                        paperData.sections.forEach(sec => traverse(sec.questions));
                    }
                },

                // Build flat navigation list from recursive payload
                buildFlatNav(paper) {
                    const items = [];
                    
                    const processNode = (node, depth) => {
                        items.push({
                            uniqueKey: node.id,
                            label: node.id,
                            anchorId: `q-${node.id}`,
                            depth: depth,
                            isSectionLabel: false
                        });
                        if (node.children) {
                            node.children.forEach(child => processNode(child, depth + 1));
                        }
                    };

                    if (paper.sections) {
                        paper.sections.forEach((section, idx) => {
                            if (section.label && section.label.trim().length > 0) {
                                items.push({
                                    uniqueKey: `sec-${idx}`,
                                    label: section.label,
                                    anchorId: '',
                                    depth: 0,
                                    isSectionLabel: true
                                });
                            }
                            section.questions.forEach(q => processNode(q, 0));
                        });
                    } else if (paper.questions) {
                        paper.questions.forEach(q => processNode(q, 0));
                    }
                    return items;
                },

                scrollToId(id) {
                    const el = document.getElementById(id);
                    if (el) {
                        // Offset for sticky spacing
                        const y = el.getBoundingClientRect().top + window.pageYOffset - 24; 
                        window.scrollTo({top: y, behavior: 'smooth'});
                    }
                },

                updateActiveNav() {
                    let currentId = null;
                    // Find all question anchors
                    const anchors = this.flatNavItems
                        .filter(i => !i.isSectionLabel)
                        .map(i => document.getElementById(i.anchorId))
                        .filter(el => el !== null);

                    for (const anchor of anchors) {
                        const rect = anchor.getBoundingClientRect();
                        if (rect.top < 150) { // Threshold
                            currentId = anchor.id;
                        } else {
                            break;
                        }
                    }
                    if (currentId) this.activeNavId = currentId;
                    else if (anchors.length > 0) this.activeNavId = anchors[0].id;
                },

                renderMath() {
                    if (window.renderMathInElement) {
                        renderMathInElement(document.body, {
                            delimiters: [
                                {left: '$$', right: '$$', display: true},
                                {left: '$', right: '$', display: false}
                            ],
                            throwOnError: false
                        });
                    }
                },

                toggleWorking(id) {
                    this.expandedStates[id] = !this.expandedStates[id];
                },

                // Core Recursive Renderer (returns HTML string)
                renderNode(node, depth) {
                    // Safe Markdown rendering
                    const mdRender = (text) => md ? md.render(text || '') : (text || '');
                    
                    const hasSolutionBlock = !!node.solutionBlock;
                    const hasAnswer = hasSolutionBlock && !!node.solutionBlock.answer;
                    const hasSolutionDetails = hasSolutionBlock && !!node.solutionBlock.solutionDetails;
                    const isExpanded = this.expandedStates[node.id];

                    // --- 1. Question Body ---
                    let html = `
                    <div id="q-${node.id}" class="question-node scroll-mt-6 group">
                        <div class="flex gap-4">
                            <!-- Identifier -->
                            <div class="flex-none pt-1">
                                <span class="text-slate-500 font-medium text-sm select-none">${node.id}</span>
                            </div>
                            <!-- Prompt -->
                            <div class="flex-1 min-w-0">
                                <div class="markdown-content text-slate-900 font-medium text-lg leading-relaxed">
                                    ${mdRender(node.question)}
                                </div>
                            </div>
                        </div>
                    `;

                    // --- 2. Solution Block (Optional) ---
                    if (hasSolutionBlock) {
                        html += `<div class="mt-4 ml-0 md:ml-10">`; // Indent block for hierarchy

                        // Answer (Visible by default if present)
                        if (hasAnswer) {
                            html += `
                                <div class="mb-3">
                                    <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Answer</div>
                                    <div class="markdown-content text-slate-800 font-semibold">
                                        ${mdRender(node.solutionBlock.answer)}
                                    </div>
                                </div>
                            `;
                        }

                        // Solution Details Toggle & Region
                        if (hasSolutionDetails) {
                            const btnText = isExpanded ? 'Hide working' : 'Show working';
                            const btnIconRotation = isExpanded ? 'rotate-180' : '';
                            
                            // Button (Text-first + Icon)
                            html += `
                                <button 
                                    onclick="document.getElementById('app').__x.$data.toggleWorking('${node.id}')"
                                    class="inline-flex items-center text-sm font-medium text-violet-600 hover:text-violet-800 focus:text-violet-800 transition-colors py-1">
                                    <span>${btnText}</span>
                                    <svg class="ml-1 w-4 h-4 transition-transform duration-200 ${btnIconRotation}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </button>
                            `;

                            // Expanded Content
                            if (isExpanded) {
                                const sd = node.solutionBlock.solutionDetails;
                                
                                html += `<div class="mt-4 space-y-6 pt-2 pb-4 animate-in fade-in slide-in-from-top-1 duration-200">`;

                                // Keep in mind
                                if (sd.keepInMind) {
                                    html += `
                                        <div class="text-sm">
                                            <div class="font-bold text-slate-700 mb-1 flex items-center gap-2">
                                                <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                                Keep in mind
                                            </div>
                                            <div class="markdown-content text-slate-600 pl-6">
                                                ${mdRender(sd.keepInMind)}
                                            </div>
                                        </div>
                                    `;
                                }

                                // Formulas used
                                if (sd.formulasUsed) {
                                    html += `
                                        <div class="text-sm">
                                            <div class="font-bold text-slate-700 mb-1">Formulas used</div>
                                            <div class="markdown-content text-slate-600">
                                                ${mdRender(sd.formulasUsed)}
                                            </div>
                                        </div>
                                    `;
                                }

                                // Working (Primary) - Mixed Prose & Math
                                if (sd.working) {
                                    html += `
                                        <div>
                                            <div class="font-bold text-xs text-slate-400 uppercase tracking-wider mb-2">Working</div>
                                            <div class="markdown-content text-slate-700 space-y-4">
                                                ${mdRender(sd.working)}
                                            </div>
                                        </div>
                                    `;
                                }

                                // Alternative Working (Array)
                                if (sd.alternativeWorking && sd.alternativeWorking.length > 0) {
                                    sd.alternativeWorking.forEach((alt, idx) => {
                                        // Demarcation: Label + Spacing (Stage 5.8.7)
                                        html += `
                                            <div class="pt-4 border-t border-slate-100">
                                                <div class="font-bold text-xs text-slate-400 uppercase tracking-wider mb-2">Alternative working</div>
                                                <div class="markdown-content text-slate-700 space-y-4">
                                                    ${mdRender(alt)}
                                                </div>
                                            </div>
                                        `;
                                    });
                                }

                                html += `</div>`; // End details wrapper
                            }
                        }
                        html += `</div>`; // End Solution Block Wrapper
                    }

                    // --- 3. Children Container (Recursive) ---
                    if (node.children && node.children.length > 0) {
                        html += `<div class="mt-6 space-y-6 ml-0 md:ml-6 pl-4 border-l border-slate-100">`; // Indent + hairline for children
                        node.children.forEach(child => {
                            html += this.renderNode(child, depth + 1);
                        });
                        html += `</div>`;
                    }

                    html += `</div>`; // End Node
                    return html;
                }
            }));
        });
    </script>
</body>
</html>
