<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AD","indexWithinVariant":"11","totalWithinVariant":"440","hueFamily":"","intensityMode":"","primaryHueFamily":"purple","secondaryHueFamily":"amber","dualIntensityMode":"dual_high_chroma_surfaces","timestamp":"2026-01-10T02:38:52.080Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AD&quot;,&quot;indexWithinVariant&quot;:&quot;11&quot;,&quot;totalWithinVariant&quot;:&quot;440&quot;,&quot;hueFamily&quot;:&quot;&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;primaryHueFamily&quot;:&quot;purple&quot;,&quot;secondaryHueFamily&quot;:&quot;amber&quot;,&quot;dualIntensityMode&quot;:&quot;dual_high_chroma_surfaces&quot;,&quot;timestamp&quot;:&quot;2026-01-10T02:38:52.080Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Viewer</title>
    
    <!-- Libraries (SRI disabled per Stage 6 instructions) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/13.0.1/markdown-it.min.js"></script>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js"></script>

    <style>
        /* 
           ColorLab D Mode 3: dual_high_chroma_surfaces (Light Mode Only)
           Primary Hue: Blue (260)
           Secondary Hue: Amber (85)
        */
        :root {
            /* Surfaces - Mode 3 requires meaningfully chromatic surfaces (C 0.06-0.12) */
            --color-page-bg: oklch(0.93 0.06 260); 
            --color-frame-bg: oklch(0.91 0.08 260);
            --color-paper-bg: oklch(0.98 0.03 260); /* The "remaining" surface (C 0.03-0.07) */

            /* Text - mostly neutral */
            --color-text-primary: oklch(0.20 0.015 260);
            --color-text-secondary: oklch(0.45 0.015 260);

            /* Accents */
            /* Primary (Blue): C 0.12-0.20 */
            --color-accent-primary: oklch(0.55 0.18 260);
            /* Secondary (Amber): C 0.10-0.18 */
            --color-accent-secondary: oklch(0.65 0.16 85);

            /* Affordances */
            --color-focus: var(--color-accent-primary);
            --color-border: oklch(0.85 0.02 260);

            /* Solution Details Wash: C 0.05-0.10 */
            --color-wash: oklch(0.95 0.06 260);
        }

        /* Base styles */
        body {
            background-color: var(--color-page-bg);
            color: var(--color-text-primary);
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            /* Ensure single vertical scroll for body */
            overflow-y: auto;
            min-height: 100vh;
        }

        /* Nav Scrollbar Hiding */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* KaTeX Containment Invariant */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            padding: 0.5em 0;
            max-width: 100%;
            -webkit-overflow-scrolling: touch;
        }
        /* No background on inline math (Explicit Rule) */
        .katex {
            background-color: transparent !important;
        }
        
        /* Markdown Content Styling */
        .markdown-body p {
            margin-bottom: 0.75em;
            line-height: 1.6;
        }
        .markdown-body ul {
            list-style-type: disc;
            padding-left: 1.5em;
            margin-bottom: 0.75em;
        }
        .markdown-body ol {
            list-style-type: decimal;
            padding-left: 1.5em;
            margin-bottom: 0.75em;
        }
        /* Minimal Structural Tables */
        .markdown-body table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1em;
            font-size: 0.95em;
        }
        .markdown-body th, .markdown-body td {
            border: 1px solid var(--color-border);
            padding: 0.5em;
            text-align: left;
        }
        .markdown-body th {
            font-weight: 600;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        page: 'var(--color-page-bg)',
                        frame: 'var(--color-frame-bg)',
                        paper: 'var(--color-paper-bg)',
                        txt: {
                            primary: 'var(--color-text-primary)',
                            secondary: 'var(--color-text-secondary)',
                        },
                        accent: {
                            primary: 'var(--color-accent-primary)',
                            secondary: 'var(--color-accent-secondary)',
                        },
                        border: 'var(--color-border)',
                        wash: 'var(--color-wash)',
                    }
                }
            }
        }
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- STAGE 0: CONSTANTS (Canonical) ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // --- ICONS (SVG) ---
        // Lucid-style icons manually embedded to avoid CDN complexity
        const IconChevronDown = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m6 9 6 6 6-6"/></svg>
        );
        const IconMenu = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>
        );
        const IconX = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
        );
        const IconInfo = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
        );

        // --- MARKDOWN CONFIGURATION (Authoritative) ---
        const md = window.markdownit
            ? window.markdownit({
                html: true, // Allow inline SVG
                linkify: true,
                breaks: false, // Must be false to prevent br inside math
            })
            : null;
        
        if (md) {
            // Disable escaping to preserve TeX backslashes
            md.inline.ruler.disable(['escape']);
        }

        // --- UTILS ---
        const renderMarkdown = (content) => {
            if (!content || !md) return { __html: content || '' };
            return { __html: md.render(content) };
        };

        const useKaTeX = (containerRef, dependencies) => {
            React.useEffect(() => {
                if (containerRef.current && window.renderMathInElement) {
                    window.renderMathInElement(containerRef.current, {
                        delimiters: [
                            {left: '$$', right: '$$', display: true},
                            {left: '$', right: '$', display: false},
                            {left: '\\(', right: '\\)', display: false},
                            {left: '\\[', right: '\\]', display: true}
                        ],
                        throwOnError: false
                    });
                }
            }, dependencies);
        };

        // --- COMPONENTS ---

        const SolutionDetails = ({ details }) => {
            const { keepInMind, formulasUsed, working, alternativeWorking } = details;
            
            return (
                <div className="mt-5 pt-4 text-base">
                    {/* Keep In Mind */}
                    {keepInMind && (
                        <div className="mb-6">
                            <div className="flex items-center gap-2 mb-2 text-txt-primary font-bold">
                                <IconInfo className="w-4 h-4 text-txt-secondary" />
                                <span>Keep in mind</span>
                            </div>
                            <div 
                                className="markdown-body text-txt-primary"
                                dangerouslySetInnerHTML={renderMarkdown(keepInMind)} 
                            />
                        </div>
                    )}

                    {/* Formulas Used */}
                    {formulasUsed && (
                        <div className="mb-6">
                            <div className="mb-2 text-txt-primary font-bold text-sm">Formulas used</div>
                            <div 
                                className="markdown-body text-txt-secondary text-sm"
                                dangerouslySetInnerHTML={renderMarkdown(formulasUsed)} 
                            />
                        </div>
                    )}

                    {/* Working (Primary) */}
                    {working && (
                        <div className="mb-6">
                            <div className="mb-2 text-txt-primary font-bold text-sm">Working</div>
                            <div 
                                className="markdown-body text-txt-primary"
                                dangerouslySetInnerHTML={renderMarkdown(working)} 
                            />
                        </div>
                    )}

                    {/* Alternative Working */}
                    {alternativeWorking && Array.isArray(alternativeWorking) && alternativeWorking.map((alt, idx) => (
                        <div key={idx} className="mt-8 pt-4 border-t border-border">
                            <div className="mb-2 text-txt-primary font-bold text-sm">Alternative working</div>
                            <div 
                                className="markdown-body text-txt-primary"
                                dangerouslySetInnerHTML={renderMarkdown(alt)} 
                            />
                        </div>
                    ))}
                </div>
            );
        };

        const QuestionNode = ({ node, depth = 0, paperDefaults, expandedState, toggleExpanded }) => {
            const { id, question, solutionBlock, children } = node;
            const hasSolutionDetails = solutionBlock?.solutionDetails;
            const hasAnswer = solutionBlock?.answer;
            const isExpanded = expandedState[id] ?? paperDefaults?.expandedAll ?? true;
            const nodeRef = React.useRef(null);

            useKaTeX(nodeRef, [question, solutionBlock, isExpanded]);

            return (
                <div ref={nodeRef} className={`group ${depth === 0 ? 'mb-16' : 'mb-8'} scroll-mt-24`} id={`q-${id}`}>
                    <div className="flex gap-4 sm:gap-6">
                        {/* Identifier */}
                        <div className="flex-none w-12 sm:w-16 pt-1 font-bold text-txt-secondary text-right select-none" 
                             style={{ fontSize: depth === 0 ? '1.125rem' : '1rem', opacity: depth === 0 ? 1 : 0.85 }}>
                            {id}
                        </div>
                        
                        <div className="flex-1 min-w-0">
                            {/* Question Prompt */}
                            <div 
                                className="markdown-body text-txt-primary text-lg leading-relaxed"
                                dangerouslySetInnerHTML={renderMarkdown(question)} 
                            />

                            {/* Solution Block */}
                            {(hasAnswer || hasSolutionDetails) && (
                                <div className="mt-6">
                                    {/* Answer */}
                                    {hasAnswer && (
                                        <div className="mb-4">
                                            <span className="text-sm font-bold text-txt-secondary uppercase tracking-wider block mb-1">Answer</span>
                                            <div 
                                                className="markdown-body text-txt-primary font-medium"
                                                dangerouslySetInnerHTML={renderMarkdown(solutionBlock.answer)} 
                                            />
                                        </div>
                                    )}

                                    {/* Disclosure Control */}
                                    {hasSolutionDetails && (
                                        <div className="mt-4">
                                            <button 
                                                onClick={() => toggleExpanded(id)}
                                                className="flex items-center gap-2 text-accent-primary font-medium hover:underline focus:outline-none focus:ring-2 focus:ring-accent-primary focus:ring-offset-2 rounded px-1 -ml-1 transition-colors select-none"
                                                aria-expanded={isExpanded}
                                                aria-controls={`solution-${id}`}
                                            >
                                                <span>{isExpanded ? "Hide working" : "Show working"}</span>
                                                <IconChevronDown className={`w-4 h-4 transition-transform ${isExpanded ? 'rotate-180' : ''}`} />
                                            </button>

                                            {/* Expandable Region */}
                                            {isExpanded && (
                                                <div id={`solution-${id}`} className="mt-3 pl-5 pr-4 py-4 bg-wash rounded-sm border-l-[3px] border-accent-primary/30 animate-in fade-in slide-in-from-top-2 duration-200">
                                                    <SolutionDetails details={solutionBlock.solutionDetails} />
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Recursive Children */}
                    {children && children.length > 0 && (
                        <div className="mt-8 ml-0 sm:ml-8 border-l-2 border-transparent">
                            {children.map(child => (
                                <QuestionNode 
                                    key={child.id} 
                                    node={child} 
                                    depth={depth + 1} 
                                    paperDefaults={paperDefaults}
                                    expandedState={expandedState}
                                    toggleExpanded={toggleExpanded}
                                />
                            ))}
                        </div>
                    )}
                    
                    {/* Top Level Spacer / Visual Seam */}
                    {depth === 0 && <div className="mt-16 border-b border-border/50" />}
                </div>
            );
        };

        const Navigation = ({ 
            flatItems, 
            activeId, 
            onJump, 
            isMobileDrawerOpen, 
            closeMobileDrawer 
        }) => {
            const NavList = () => (
                <div className="space-y-0.5">
                    {flatItems.map((item, idx) => {
                        if (item.type === 'section') {
                            return (
                                <div key={`sec-${idx}`} className="mt-8 mb-3 px-3 text-xs font-bold text-txt-secondary uppercase tracking-widest opacity-80 select-none">
                                    {item.label}
                                </div>
                            );
                        }
                        
                        const isActive = activeId === item.id;
                        return (
                            <button
                                key={item.id}
                                onClick={() => { onJump(item.id); if (closeMobileDrawer) closeMobileDrawer(); }}
                                className={`w-full text-left px-3 py-1.5 rounded text-sm transition-colors duration-150
                                    ${isActive 
                                        ? 'font-bold text-accent-primary bg-accent-primary/10' 
                                        : 'text-txt-secondary hover:text-txt-primary hover:bg-black/5'}
                                `}
                            >
                                {item.id}
                            </button>
                        );
                    })}
                </div>
            );

            return (
                <>
                    {/* Desktop Sticky Rail */}
                    <nav className="hidden lg:block w-48 xl:w-56 sticky top-24 h-[calc(100vh-6rem)] overflow-y-auto no-scrollbar pr-4 pb-12">
                         <NavList />
                    </nav>

                    {/* Mobile Drawer */}
                    {isMobileDrawerOpen && (
                        <div className="fixed inset-0 z-50 lg:hidden flex">
                            <div className="fixed inset-0 bg-black/50 backdrop-blur-sm" onClick={closeMobileDrawer} />
                            <div className="relative w-72 bg-frame h-full shadow-2xl overflow-y-auto p-6 animate-in slide-in-from-left duration-200">
                                <div className="flex items-center justify-between mb-8">
                                    <h2 className="font-bold text-txt-primary text-lg">Jump to</h2>
                                    <button onClick={closeMobileDrawer} className="p-2 -mr-2 text-txt-secondary hover:text-txt-primary rounded-full hover:bg-black/5">
                                        <IconX className="w-6 h-6" />
                                    </button>
                                </div>
                                <NavList />
                            </div>
                        </div>
                    )}
                </>
            );
        };

        const App = () => {
            const [payload, setPayload] = React.useState(null);
            const [error, setError] = React.useState(null);
            const [selectedPaperKey, setSelectedPaperKey] = React.useState(null);
            const [expandedState, setExpandedState] = React.useState({});
            const [activeId, setActiveId] = React.useState(null);
            const [isDrawerOpen, setIsDrawerOpen] = React.useState(false);

            // Fetch payload using Canonical Constant
            React.useEffect(() => {
                fetch(RTQ_PAPERS_PAYLOAD_PATH)
                    .then(res => {
                        if (!res.ok) throw new Error("Failed to load");
                        return res.json();
                    })
                    .then(data => {
                        setPayload(data);
                        if (data.papers && data.papers.length > 0) {
                            setSelectedPaperKey(data.papers[0].key);
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        setError(true);
                    });
            }, []);

            // Scroll Spy
            React.useEffect(() => {
                const handleScroll = () => {
                    const questions = document.querySelectorAll('[id^="q-"]');
                    let current = null;
                    for (let q of questions) {
                        const rect = q.getBoundingClientRect();
                        if (rect.top < 200) {
                            current = q.id.replace('q-', '');
                        } else {
                            break;
                        }
                    }
                    if (current) setActiveId(current);
                };
                window.addEventListener('scroll', handleScroll, { passive: true });
                return () => window.removeEventListener('scroll', handleScroll);
            }, [selectedPaperKey, payload]);

            if (error) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-page text-txt-primary font-bold tracking-widest">
                        PAPERS PAYLOAD MISSING
                    </div>
                );
            }

            if (!payload || !selectedPaperKey) return null;

            const activePaper = payload.papers.find(p => p.key === selectedPaperKey) || payload.papers[0];

            const generateNavItems = () => {
                const items = [];
                const walk = (nodes) => {
                    nodes.forEach(node => {
                        items.push({ id: node.id, type: 'item' });
                        if (node.children) walk(node.children);
                    });
                };
                if (activePaper.sections) {
                    activePaper.sections.forEach(sec => {
                        if (sec.label && sec.label.trim().length > 0) {
                            items.push({ label: sec.label, type: 'section' });
                        }
                        walk(sec.questions);
                    });
                } else if (activePaper.questions) {
                    walk(activePaper.questions);
                }
                return items;
            };

            const navItems = generateNavItems();

            const handleToggleExpanded = (id) => {
                setExpandedState(prev => {
                    const current = prev[id] ?? activePaper.defaults?.expandedAll ?? true;
                    return { ...prev, [id]: !current };
                });
            };

            const scrollToQuestion = (id) => {
                const el = document.getElementById(`q-${id}`);
                if (el) {
                    const offset = 120;
                    const bodyRect = document.body.getBoundingClientRect().top;
                    const elementRect = el.getBoundingClientRect().top;
                    const elementPosition = elementRect - bodyRect;
                    const offsetPosition = elementPosition - offset;

                    window.scrollTo({
                        top: offsetPosition,
                        behavior: "smooth"
                    });
                }
            };

            return (
                <div className="min-h-screen flex flex-col max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 bg-frame/50">
                    {/* Top Controls */}
                    <header className="sticky top-0 z-40 bg-page/90 backdrop-blur-md py-4 border-b border-border mb-8">
                        <div className="flex items-center justify-between max-w-7xl mx-auto">
                            <div className="flex items-center gap-4">
                                <select 
                                    className="bg-frame border border-border rounded px-4 py-2 text-sm font-medium text-txt-primary focus:ring-2 focus:ring-accent-primary focus:outline-none shadow-sm cursor-pointer"
                                    value={selectedPaperKey}
                                    onChange={(e) => {
                                        setSelectedPaperKey(e.target.value);
                                        setExpandedState({});
                                        window.scrollTo({top: 0});
                                    }}
                                >
                                    {payload.papers.map(p => (
                                        <option key={p.key} value={p.key}>{p.label}</option>
                                    ))}
                                </select>
                            </div>

                            {/* Mobile Jump To Trigger */}
                            <button 
                                className="lg:hidden flex items-center gap-2 text-sm font-bold text-accent-primary"
                                onClick={() => setIsDrawerOpen(true)}
                            >
                                <span>Jump to</span>
                                <IconMenu className="w-5 h-5" />
                            </button>
                        </div>
                    </header>

                    {/* DocumentFrameShell Layout */}
                    <div className="flex-1 lg:grid lg:grid-cols-[16rem_1fr] gap-12 pb-24">
                        <Navigation 
                            flatItems={navItems} 
                            activeId={activeId} 
                            onJump={scrollToQuestion} 
                            isMobileDrawerOpen={isDrawerOpen}
                            closeMobileDrawer={() => setIsDrawerOpen(false)}
                        />

                        {/* Paper Content Column */}
                        <main className="min-w-0 bg-paper rounded-xl shadow-sm lg:shadow-none lg:bg-transparent p-6 lg:p-0">
                            {activePaper.sections ? (
                                activePaper.sections.map((section, idx) => (
                                    <div key={idx} className="mb-20">
                                        {section.label && section.label.trim() && (
                                            <div className="mb-10 pb-4 border-b border-border">
                                                <h2 className="text-2xl font-bold text-txt-primary">{section.label}</h2>
                                            </div>
                                        )}
                                        <div>
                                            {section.questions.map(q => (
                                                <QuestionNode 
                                                    key={q.id} 
                                                    node={q} 
                                                    paperDefaults={activePaper.defaults}
                                                    expandedState={expandedState}
                                                    toggleExpanded={handleToggleExpanded}
                                                />
                                            ))}
                                        </div>
                                    </div>
                                ))
                            ) : (
                                <div>
                                    {activePaper.questions.map(q => (
                                        <QuestionNode 
                                            key={q.id} 
                                            node={q} 
                                            paperDefaults={activePaper.defaults}
                                            expandedState={expandedState}
                                            toggleExpanded={handleToggleExpanded}
                                        />
                                    ))}
                                </div>
                            )}
                        </main>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
