<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"ABC","indexWithinVariant":"115","totalWithinVariant":"320","hueFamily":"amber","intensityMode":"high_chroma_surfaces","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-09T15:15:27.845Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;ABC&quot;,&quot;indexWithinVariant&quot;:&quot;115&quot;,&quot;totalWithinVariant&quot;:&quot;320&quot;,&quot;hueFamily&quot;:&quot;amber&quot;,&quot;intensityMode&quot;:&quot;high_chroma_surfaces&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-09T15:15:27.845Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>
    
    <!-- KaTeX CSS (No integrity/SRI per Stage 6.0.7b) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <style>
        /* ==========================================================================
           1. CSS VARIABLES (ColorLab C: High Chroma Surfaces + Amber)
           ========================================================================== */
        :root {
            /* 
               RTQ_COLORLAB_FORCE_HUE_FAMILY = "amber" (H ~ 88 in OKLCH)
               RTQ_COLORLAB_INTENSITY_MODE = "high_chroma_surfaces"
               
               Rules:
               - 2 Major surfaces C in [0.06 .. 0.12]
               - 1 Major surface C in [0.03 .. 0.07]
               - Wash C in [0.05 .. 0.10]
               - Accent C in [0.12 .. 0.20]
               - Text C <= 0.015
            */
            --hue: 88;

            /* Major Surface 1: Page Background (High Chroma) */
            --c-page-bg: oklch(0.96 0.09 var(--hue));

            /* Major Surface 2: Frame Base (High Chroma) */
            --c-frame-bg: oklch(0.93 0.10 var(--hue));

            /* Major Surface 3: Paper Surface (Tinted) */
            --c-paper-bg: oklch(0.99 0.05 var(--hue));

            /* Wash Surfaces */
            --c-wash: oklch(0.95 0.08 var(--hue)); /* Solution Details */

            /* Text & Borders */
            --c-text-primary: oklch(0.20 0.015 var(--hue));
            --c-text-secondary: oklch(0.45 0.015 var(--hue));
            --c-divider: oklch(0.85 0.04 var(--hue));
            
            /* Accents (Restrained usage: Links, Focus, Toggles) */
            --c-accent: oklch(0.60 0.18 var(--hue));
            --c-focus-ring: oklch(0.60 0.18 var(--hue));

            /* Spacing & Sizing */
            --space-xs: 0.25rem;
            --space-sm: 0.5rem;
            --space-md: 1rem;
            --space-lg: 1.5rem;
            --space-xl: 2.5rem;
            --space-xxl: 4rem;

            --font-family: 'Inter', system-ui, -apple-system, sans-serif;
            --nav-width: 240px;
            --max-width: 1100px; /* DocumentFrameShell max width */
        }

        /* ==========================================================================
           2. RESET & BASE
           ========================================================================== */
        * { box-sizing: border-box; }
        body {
            margin: 0;
            padding: 0;
            background-color: var(--c-page-bg);
            color: var(--c-text-primary);
            font-family: var(--font-family);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }
        
        button { font-family: inherit; }
        a { color: var(--c-accent); text-decoration: none; }
        a:hover { text-decoration: underline; }

        /* Focus States (Stage 5.5.2) */
        :focus-visible {
            outline: 2px solid var(--c-focus-ring);
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* ==========================================================================
           3. LAYOUT SHELL (Stage 3 Grammar)
           ========================================================================== */
        .viewport-shell {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Top Controls Region */
        .top-controls {
            width: 100%;
            background-color: var(--c-frame-bg); /* Aligned to frame context */
            border-bottom: 1px solid var(--c-divider);
            padding: var(--space-md) 0;
            position: sticky;
            top: 0;
            z-index: 20;
        }
        
        .top-controls-inner {
            max-width: var(--max-width);
            margin: 0 auto;
            padding: 0 var(--space-lg);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        /* DocumentFrameShell */
        .document-frame-shell {
            flex: 1;
            width: 100%;
            max-width: var(--max-width);
            margin: 0 auto;
            background-color: var(--c-frame-bg);
            display: flex; /* Sibling columns on desktop */
            /* Min-height ensures the shell stretches */
            min-height: calc(100vh - 60px); 
        }

        /* Navigation Rail (Left Column) */
        .nav-rail {
            width: var(--nav-width);
            flex-shrink: 0;
            padding: var(--space-lg) 0 var(--space-lg) var(--space-lg);
            /* Sticky positioning */
            position: sticky;
            top: 60px; /* Offset for top controls */
            height: calc(100vh - 60px);
            overflow-y: auto;
            /* Scrollbar hiding (Stage 6 Add-on) */
            scrollbar-width: none;
            -ms-overflow-style: none;
            display: none; /* Hidden on mobile by default */
        }
        .nav-rail::-webkit-scrollbar { display: none; }
        
        @media (min-width: 768px) {
            .nav-rail { display: block; }
        }

        /* Paper Document Column (Right Column) */
        .paper-column {
            flex: 1;
            padding: var(--space-lg);
            min-width: 0; /* Prevent flex blowout */
        }

        /* Paper Surface */
        .paper-surface {
            background-color: var(--c-paper-bg);
            min-height: 100%;
            padding: var(--space-xl) var(--space-xxl);
            /* Box shadow optional/removed per "no elevation" rule, sticking to surface color diff */
        }

        /* ==========================================================================
           4. NAVIGATION COMPONENTS
           ========================================================================== */
        .nav-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        /* Section Labels */
        .nav-section-label {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--c-text-secondary);
            margin-top: var(--space-md);
            margin-bottom: var(--space-xs);
            padding-left: var(--space-sm);
            cursor: default;
        }

        /* Nav Item */
        .nav-item {
            display: block;
            padding: var(--space-xs) var(--space-sm);
            font-size: 0.9rem;
            color: var(--c-text-secondary);
            border-radius: 4px;
            /* Flat list visual - hierarchy via type scale handled by JS classes if needed, 
               but strictly flat left edge per Stage 5.4.5 */
            border-left: 2px solid transparent;
            cursor: pointer;
            transition: color 0.1s ease, background-color 0.1s ease;
        }

        .nav-item:hover {
            background-color: rgba(0,0,0,0.03); /* Subtle hover */
            color: var(--c-text-primary);
        }

        .nav-item.active {
            font-weight: 700;
            color: var(--c-text-primary);
            /* Stage 6.0.11: Accent permitted for current nav marker if used */
            border-left-color: var(--c-accent); 
        }

        /* Mobile Drawer */
        .drawer-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
        }
        .drawer-overlay.open { display: block; }

        .drawer {
            position: fixed;
            top: 0; bottom: 0; left: 0;
            width: 280px;
            background: var(--c-frame-bg);
            z-index: 1000;
            transform: translateX(-100%);
            transition: transform 0.2s ease-out;
            display: flex;
            flex-direction: column;
            padding: var(--space-md);
        }
        .drawer.open { transform: translateX(0); }

        .drawer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-md);
            padding-bottom: var(--space-sm);
            border-bottom: 1px solid var(--c-divider);
        }
        .drawer-content {
            flex: 1;
            overflow-y: auto;
        }
        .mobile-jump-btn {
            display: inline-block;
            background: none;
            border: 1px solid var(--c-divider);
            padding: var(--space-xs) var(--space-md);
            border-radius: 4px;
            color: var(--c-text-primary);
            cursor: pointer;
        }
        @media (min-width: 768px) {
            .mobile-jump-btn { display: none; }
        }

        /* ==========================================================================
           5. CONTENT TYPOGRAPHY & SPACING
           ========================================================================== */
        /* Question Node */
        .question-node {
            margin-bottom: var(--space-xl); /* Top-level separation */
            scroll-margin-top: 100px; /* For anchor jumping */
        }
        
        /* Sub-questions indentation handled by container */
        .children-container {
            margin-top: var(--space-md);
            /* Stage 3: Indentation permitted. 
               Adaptive indentation: less on mobile, more on desktop. */
            padding-left: var(--space-md);
            border-left: 1px solid transparent; /* invisible structural guide */
        }
        @media (min-width: 768px) {
            .children-container { padding-left: var(--space-xl); }
        }

        /* Question Body */
        .question-body {
            font-size: 1.125rem;
            color: var(--c-text-primary);
            margin-bottom: var(--space-sm);
        }
        .q-identifier {
            font-weight: 700;
            margin-right: var(--space-sm);
        }

        /* Solution Block */
        .solution-block {
            margin-top: var(--space-md);
        }

        /* Answer */
        .answer-region {
            margin-bottom: var(--space-md);
        }
        .answer-label {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--c-text-secondary);
            display: block;
            margin-bottom: var(--space-xs);
        }
        .answer-content {
            font-size: 1rem;
            font-weight: 500;
        }

        /* Solution Details Controls */
        .disclosure-control {
            background: none;
            border: none;
            padding: 0;
            font-size: 0.9rem;
            color: var(--c-accent);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            margin-bottom: var(--space-sm);
        }
        .disclosure-control:hover { text-decoration: underline; }
        .chevron { transition: transform 0.2s; width: 1em; height: 1em; }
        .expanded .chevron { transform: rotate(180deg); }

        /* Solution Details Region */
        .solution-details-region {
            display: none;
            background-color: var(--c-wash);
            padding: var(--space-md) var(--space-lg);
            /* Optional hairilne per grammar - utilizing wash instead primarily */
            border-radius: 4px; /* Slight softening, not full card */
        }
        .solution-details-region.expanded {
            display: block;
            animation: fadeIn 0.2s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-4px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Internal Subsections */
        .sd-subsection {
            margin-bottom: var(--space-lg);
        }
        .sd-subsection:last-child { margin-bottom: 0; }

        .sd-label {
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--c-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: var(--space-sm);
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }

        .sd-body {
            font-size: 1rem;
            color: var(--c-text-primary); /* High readability */
        }
        
        /* Keep In Mind specific */
        .keep-in-mind .sd-body ul {
            padding-left: var(--space-lg);
            margin: 0;
        }

        /* Working / Alternative Working */
        .working-block + .alternative-working-block {
            padding-top: var(--space-lg);
            border-top: 1px solid var(--c-divider); /* Stage 5.8.7 */
        }

        /* ==========================================================================
           6. MARKDOWN & KATEX
           ========================================================================== */
        /* Markdown generated HTML resets */
        .md-content p { margin-top: 0; margin-bottom: var(--space-sm); }
        .md-content p:last-child { margin-bottom: 0; }
        
        /* Tables (Stage 5.8.5) */
        .md-content table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: var(--space-md);
            font-size: 0.95em;
        }
        .md-content th, .md-content td {
            border: 1px solid var(--c-divider);
            padding: var(--space-sm);
            text-align: left;
        }
        .md-content th { font-weight: 600; }
        .table-wrapper { overflow-x: auto; }

        /* KaTeX Overrides (Stage 4.8.6 & 6.0.8) */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding: 0.5em 0;
            /* Scrollbar hiding for math */
            scrollbar-width: thin;
            margin: var(--space-sm) 0;
        }
        /* Block math underlay permitted by grammar, but Stage 6.0.4 clarifies subtle diff only.
           In High Chroma Surfaces, the wash handles the background. No extra underlay needed on the math block itself. */
        
        .katex { font-size: 1.1em; } /* Visual balance */

        /* ==========================================================================
           7. UTILITIES
           ========================================================================== */
        .hidden { display: none !important; }
        .paper-selector {
            padding: var(--space-sm);
            font-size: 1rem;
            border: 1px solid var(--c-divider);
            border-radius: 4px;
            background: var(--c-paper-bg);
            color: var(--c-text-primary);
        }

        /* Loading / Error States */
        .status-message {
            text-align: center;
            padding: var(--space-xxl);
            font-size: 1.5rem;
            color: var(--c-text-secondary);
            font-weight: 700;
            text-transform: uppercase;
        }

        /* Responsive adjustments for Paper Surface */
        @media (max-width: 768px) {
            .paper-surface { padding: var(--space-lg) var(--space-md); }
            .top-controls-inner { padding: 0 var(--space-md); }
        }

    </style>
</head>
<body>

<!-- STAGE 0: CANONICAL CONSTANT -->
<!-- The literal path string MUST appear in only one place. -->
<script>
    const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
</script>

<!-- EXTERNAL LIBRARIES -->
<!-- Markdown-it (for payload rendering) -->
<script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>
<!-- KaTeX JS (No integrity/SRI) -->
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

<div id="app" class="viewport-shell">
    
    <!-- Top Controls -->
    <div class="top-controls">
        <div class="top-controls-inner">
            <select id="paper-selector" class="paper-selector" aria-label="Select Paper">
                <option value="" disabled selected>Loading papers...</option>
            </select>
            <button id="mobile-jump-btn" class="mobile-jump-btn">Jump to</button>
        </div>
    </div>

    <!-- Main Shell -->
    <div class="document-frame-shell">
        
        <!-- Navigation Rail (Desktop) -->
        <nav id="nav-rail" class="nav-rail" aria-label="Paper Navigation">
            <ul id="nav-list-desktop" class="nav-list">
                <!-- Generated Items -->
            </ul>
        </nav>

        <!-- Paper Column -->
        <main class="paper-column">
            <div id="paper-surface" class="paper-surface">
                <!-- Paper Content Generated Here -->
                <div id="loading-indicator" class="status-message">Loading...</div>
            </div>
        </main>

    </div>

    <!-- Mobile Drawer -->
    <div id="drawer-overlay" class="drawer-overlay"></div>
    <div id="drawer" class="drawer">
        <div class="drawer-header">
            <strong>Jump to</strong>
            <button id="drawer-close-btn" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">&times;</button>
        </div>
        <div class="drawer-content">
            <nav id="nav-drawer" aria-label="Mobile Paper Navigation">
                <ul id="nav-list-mobile" class="nav-list">
                    <!-- Generated Items -->
                </ul>
            </nav>
        </div>
    </div>

</div>

<script>
    /* ==========================================================================
       RUNTIME LOGIC (Stage 6 Baseline)
       ========================================================================== */

    // --- State ---
    let payload = null;
    let currentPaper = null;

    // --- DOM Elements ---
    const els = {
        selector: document.getElementById('paper-selector'),
        desktopNavList: document.getElementById('nav-list-desktop'),
        mobileNavList: document.getElementById('nav-list-mobile'),
        paperSurface: document.getElementById('paper-surface'),
        loadingIndicator: document.getElementById('loading-indicator'),
        mobileJumpBtn: document.getElementById('mobile-jump-btn'),
        drawer: document.getElementById('drawer'),
        drawerOverlay: document.getElementById('drawer-overlay'),
        drawerCloseBtn: document.getElementById('drawer-close-btn'),
    };

    // --- Markdown Init (Authoritative Config) ---
    // Stage 6 add-on requires strict config: html:true, breaks:false
    const md = window.markdownit ? window.markdownit({
        html: true,
        linkify: true,
        breaks: false 
    }) : null;

    if (md) {
        // Disable escape rule to preserve TeX backslashes
        md.inline.ruler.disable(['escape']);
    }

    // --- Initialization ---
    async function init() {
        try {
            // Deterministic Load
            const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
            if (!response.ok) throw new Error("Payload not found");
            payload = await response.json();
            
            populateSelector();
            
            // Default to first paper or 'standard'
            if (payload.papers && payload.papers.length > 0) {
                switchPaper(payload.papers[0].key);
            } else {
                renderError("NO PAPERS FOUND IN PAYLOAD");
            }

        } catch (e) {
            console.error(e);
            renderError("PAPERS PAYLOAD MISSING");
        }
    }

    function renderError(msg) {
        els.paperSurface.innerHTML = `<div class="status-message">${msg}</div>`;
        els.selector.innerHTML = `<option disabled selected>Error</option>`;
        els.selector.disabled = true;
    }

    // --- Selector Logic ---
    function populateSelector() {
        els.selector.innerHTML = '';
        payload.papers.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.key;
            opt.textContent = p.label;
            els.selector.appendChild(opt);
        });
        els.selector.addEventListener('change', (e) => switchPaper(e.target.value));
    }

    function switchPaper(key) {
        currentPaper = payload.papers.find(p => p.key === key);
        if (!currentPaper) return;
        renderPaper(currentPaper);
    }

    // --- Render Logic ---
    function renderPaper(paper) {
        // Clear Content
        els.paperSurface.innerHTML = '';
        
        // 1. Determine Content Source (Questions[] or Sections[])
        let contentNodes = [];
        let isSectioned = false;

        if (paper.questions) {
            contentNodes = paper.questions;
        } else if (paper.sections) {
            isSectioned = true;
        }

        // 2. Build Content HTML
        const contentFragment = document.createDocumentFragment();
        
        if (isSectioned) {
            paper.sections.forEach(section => {
                // Render Section Header if label exists
                if (section.label && section.label.trim() !== "") {
                    const secHeader = document.createElement('div');
                    secHeader.className = "nav-section-label"; // Reuse style or dedicated
                    secHeader.style.fontSize = "1.5rem"; // Paper body size
                    secHeader.style.marginBottom = "1rem";
                    secHeader.style.marginTop = "2rem";
                    secHeader.style.color = "var(--c-text-secondary)";
                    secHeader.textContent = section.label;
                    contentFragment.appendChild(secHeader);
                }
                // Render Questions
                section.questions.forEach(q => {
                    contentFragment.appendChild(renderQuestionNode(q, paper.defaults));
                });
            });
        } else {
            contentNodes.forEach(q => {
                contentFragment.appendChild(renderQuestionNode(q, paper.defaults));
            });
        }

        els.paperSurface.appendChild(contentFragment);

        // 3. Render KaTeX
        renderMath(els.paperSurface);

        // 4. Build Navigation
        buildNavigation(paper);

        // 5. Scroll to top
        window.scrollTo(0,0);
    }

    // --- Recursive Question Node Renderer ---
    function renderQuestionNode(node, defaults) {
        const wrapper = document.createElement('div');
        wrapper.className = 'question-node';
        wrapper.id = `q-${node.id}`; // Anchor ID

        // A. Question Body
        const qBody = document.createElement('div');
        qBody.className = 'question-body';
        const qHtml = md ? md.render(node.question || '') : node.question;
        qBody.innerHTML = `<span class="q-identifier">${node.id}</span><span class="md-content">${qHtml}</span>`;
        wrapper.appendChild(qBody);

        // B. Solution Block (Optional)
        if (node.solutionBlock) {
            const sb = node.solutionBlock;
            const blockDiv = document.createElement('div');
            blockDiv.className = 'solution-block';

            // B1. Answer (Optional)
            if (sb.answer) {
                const ansDiv = document.createElement('div');
                ansDiv.className = 'answer-region';
                const ansHtml = md ? md.render(sb.answer) : sb.answer;
                ansDiv.innerHTML = `<span class="answer-label">Answer</span><div class="answer-content md-content">${ansHtml}</div>`;
                blockDiv.appendChild(ansDiv);
            }

            // B2. Solution Details (Optional)
            if (sb.solutionDetails) {
                const details = sb.solutionDetails;
                
                // Toggle Control
                const toggleBtn = document.createElement('button');
                toggleBtn.className = 'disclosure-control';
                // Baseline: Expanded unless default says otherwise
                let isExpanded = (defaults && defaults.expandedAll === false) ? false : true;
                
                toggleBtn.innerHTML = `
                    <span class="text">${isExpanded ? 'Hide working' : 'Show working'}</span>
                    <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                `;

                // Region
                const region = document.createElement('div');
                region.className = `solution-details-region ${isExpanded ? 'expanded' : ''}`;
                
                // --- Subsections ---
                
                // 1. Keep In Mind
                if (details.keepInMind) {
                    const kim = document.createElement('div');
                    kim.className = 'sd-subsection keep-in-mind';
                    kim.innerHTML = `
                        <div class="sd-label">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                            Keep in mind
                        </div>
                        <div class="sd-body md-content">${md ? md.render(details.keepInMind) : details.keepInMind}</div>
                    `;
                    region.appendChild(kim);
                }

                // 2. Formulas Used
                if (details.formulasUsed) {
                    const form = document.createElement('div');
                    form.className = 'sd-subsection formulas-used';
                    form.innerHTML = `
                        <div class="sd-label">Formulas used</div>
                        <div class="sd-body md-content">${md ? md.render(details.formulasUsed) : details.formulasUsed}</div>
                    `;
                    region.appendChild(form);
                }

                // 3. Working
                if (details.working) {
                    const work = document.createElement('div');
                    work.className = 'sd-subsection working-block';
                    work.innerHTML = `
                        <div class="sd-label">Working</div>
                        <div class="sd-body md-content">${md ? md.render(details.working) : details.working}</div>
                    `;
                    region.appendChild(work);
                }

                // 4. Alternative Working (Array)
                if (details.alternativeWorking && Array.isArray(details.alternativeWorking)) {
                    details.alternativeWorking.forEach((altText, idx) => {
                        const alt = document.createElement('div');
                        alt.className = 'sd-subsection alternative-working-block';
                        alt.innerHTML = `
                            <div class="sd-label">Alternative working</div>
                            <div class="sd-body md-content">${md ? md.render(altText) : altText}</div>
                        `;
                        region.appendChild(alt);
                    });
                } else if (details.alternativeWorking && typeof details.alternativeWorking === 'string') {
                     // Fallback for single string
                     const alt = document.createElement('div');
                        alt.className = 'sd-subsection alternative-working-block';
                        alt.innerHTML = `
                            <div class="sd-label">Alternative working</div>
                            <div class="sd-body md-content">${md ? md.render(details.alternativeWorking) : details.alternativeWorking}</div>
                        `;
                        region.appendChild(alt);
                }

                // Interaction
                toggleBtn.addEventListener('click', () => {
                    const wasExpanded = region.classList.contains('expanded');
                    if (wasExpanded) {
                        region.classList.remove('expanded');
                        toggleBtn.querySelector('.text').textContent = "Show working";
                        toggleBtn.classList.remove('expanded');
                    } else {
                        region.classList.add('expanded');
                        toggleBtn.querySelector('.text').textContent = "Hide working";
                        toggleBtn.classList.add('expanded');
                    }
                });
                if(isExpanded) toggleBtn.classList.add('expanded');

                blockDiv.appendChild(toggleBtn);
                blockDiv.appendChild(region);
            }
            
            wrapper.appendChild(blockDiv);
        }

        // C. Children (Recursion)
        if (node.children && node.children.length > 0) {
            const childContainer = document.createElement('div');
            childContainer.className = 'children-container';
            node.children.forEach(child => {
                childContainer.appendChild(renderQuestionNode(child, defaults));
            });
            wrapper.appendChild(childContainer);
        }

        return wrapper;
    }

    // --- Math Rendering ---
    function renderMath(container) {
        if (!window.renderMathInElement) return;
        renderMathInElement(container, {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false}
            ],
            throwOnError: false
        });
    }

    // --- Navigation Logic ---
    function buildNavigation(paper) {
        const createNavItem = (id) => {
            const li = document.createElement('li');
            const a = document.createElement('a');
            a.className = 'nav-item';
            a.textContent = id;
            a.onclick = (e) => {
                e.preventDefault();
                scrollToQuestion(id);
                closeDrawer();
            };
            li.appendChild(a);
            return li;
        };

        const createSectionLabel = (label) => {
            if(!label || !label.trim()) return null;
            const div = document.createElement('div');
            div.className = 'nav-section-label';
            div.textContent = label;
            return div;
        };

        // Populate both desktop and mobile lists
        [els.desktopNavList, els.mobileNavList].forEach(list => {
            list.innerHTML = '';
            
            const traverseForNav = (nodes, parentFragment) => {
                nodes.forEach(node => {
                    parentFragment.appendChild(createNavItem(node.id));
                    if (node.children) {
                        traverseForNav(node.children, parentFragment);
                    }
                });
            };

            if (paper.sections) {
                paper.sections.forEach(sec => {
                    if (sec.label) {
                        const lbl = createSectionLabel(sec.label);
                        if(lbl) list.appendChild(lbl);
                    }
                    traverseForNav(sec.questions, list);
                });
            } else if (paper.questions) {
                traverseForNav(paper.questions, list);
            }
        });
        
        setupIntersectionObserver();
    }

    function scrollToQuestion(id) {
        const el = document.getElementById(`q-${id}`);
        if (el) {
            // Offset for sticky header
            const top = el.getBoundingClientRect().top + window.scrollY - 70;
            window.scrollTo({ top: top, behavior: 'smooth' });
        }
    }

    // --- Active State Observer ---
    function setupIntersectionObserver() {
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const id = entry.target.id.replace('q-', '');
                    updateActiveNav(id);
                }
            });
        }, { rootMargin: '-100px 0px -80% 0px' }); // Trigger near top

        document.querySelectorAll('.question-node').forEach(q => observer.observe(q));
    }

    function updateActiveNav(id) {
        [els.desktopNavList, els.mobileNavList].forEach(list => {
            list.querySelectorAll('.nav-item').forEach(item => {
                if (item.textContent === id) item.classList.add('active');
                else item.classList.remove('active');
            });
        });
    }

    // --- Mobile Drawer Interaction ---
    function openDrawer() {
        els.drawer.classList.add('open');
        els.drawerOverlay.classList.add('open');
    }
    function closeDrawer() {
        els.drawer.classList.remove('open');
        els.drawerOverlay.classList.remove('open');
    }
    els.mobileJumpBtn.addEventListener('click', openDrawer);
    els.drawerCloseBtn.addEventListener('click', closeDrawer);
    els.drawerOverlay.addEventListener('click', closeDrawer);

    // --- Boot ---
    init();

</script>
</body>
</html>
