<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"A","indexWithinVariant":"23","totalWithinVariant":"50","hueFamily":"","intensityMode":"","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-08T12:13:07.960Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;A&quot;,&quot;indexWithinVariant&quot;:&quot;23&quot;,&quot;totalWithinVariant&quot;:&quot;50&quot;,&quot;hueFamily&quot;:&quot;&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-08T12:13:07.960Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer (Stage 6 Baseline)</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- KaTeX CSS (No Integrity/SRI per brief) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <!-- Tailwind CSS (via CDN for prototyping speed) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Tailwind Config for ColorLab A (Light Mode Only, Premium Education Palette) -->
    <script>
        tailwind.config = {
            darkMode: 'class', // Disabled practically as we force light
            theme: {
                fontFamily: {
                    sans: ['Inter', 'sans-serif'],
                },
                extend: {
                    colors: {
                        // ColorLab A: Free palette choice. Using Slate + Indigo for a crisp, modern feel.
                        page: '#F8FAFC',     // Slate 50
                        surface: '#FFFFFF',  // White
                        ink: {
                            900: '#0F172A',  // Slate 900 (Headings/Questions)
                            600: '#475569',  // Slate 600 (Body/Muted)
                            400: '#94A3B8',  // Slate 400 (Quiet)
                        },
                        border: {
                            DEFAULT: '#E2E8F0', // Slate 200
                        },
                        accent: {
                            DEFAULT: '#4F46E5', // Indigo 600 (Interactive/Focus)
                            hover: '#4338CA',   // Indigo 700
                            light: '#E0E7FF',   // Indigo 100 (Subtle highlight if needed)
                        }
                    },
                    spacing: {
                        '18': '4.5rem',
                    }
                }
            }
        }
    </script>

    <style>
        /* Base Reset & Typography */
        body {
            background-color: theme('colors.page');
            color: theme('colors.ink.600');
            font-family: theme('fontFamily.sans');
            -webkit-font-smoothing: antialiased;
            overflow-y: scroll; /* Force scrollbar to prevent layout shift */
        }

        /* 
         * KaTeX Containment Invariant 
         * Ensure math blocks handle overflow internally
         */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding: 0.5em 0;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; /* Firefox */
        }
        .katex-display::-webkit-scrollbar {
            display: none; /* Chrome/Safari */
        }

        /* Tables in Markdown */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            font-size: 0.95em;
        }
        th, td {
            border: 1px solid theme('colors.border.DEFAULT');
            padding: 0.5rem 0.75rem;
            text-align: left;
        }
        th {
            font-weight: 600;
            color: theme('colors.ink.900');
            background-color: transparent;
        }
        
        /* Mobile Drawer Utilities */
        .drawer-open {
            overflow: hidden;
        }

        /* Navigation Scrollbar Hiding */
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* Focus States (Stage 5.5.2) */
        :focus-visible {
            outline: 2px solid theme('colors.accent.DEFAULT');
            outline-offset: 2px;
            border-radius: 2px;
        }
        
        /* Typography Utility Classes for Markdown Content */
        .md-content p {
            margin-bottom: 0.75rem;
            line-height: 1.6;
        }
        .md-content ul {
            list-style-type: disc;
            padding-left: 1.25rem;
            margin-bottom: 0.75rem;
        }
        .md-content ol {
            list-style-type: decimal;
            padding-left: 1.25rem;
            margin-bottom: 0.75rem;
        }
        .md-content li {
            margin-bottom: 0.25rem;
        }
        /* Inline Math No-Background Rule */
        .katex { 
            background-color: transparent !important; 
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Top Controls Region -->
    <!-- Aligned to shell via max-w container -->
    <div class="w-full bg-page border-b border-transparent pt-4 pb-2 sticky top-0 z-30">
        <div class="max-w-7xl mx-auto px-4 lg:px-8 flex items-center justify-between">
            
            <!-- Paper Selector -->
            <div class="flex items-center gap-3">
                <label for="paper-select" class="text-sm font-medium text-ink-900 sr-only">Select Paper</label>
                <select id="paper-select" class="bg-surface border border-border text-ink-900 text-sm rounded-md focus:ring-accent focus:border-accent block p-2 min-w-[200px] shadow-sm">
                    <option value="" disabled selected>Loading papers...</option>
                </select>
            </div>

            <!-- Mobile "Jump to" Trigger -->
            <button id="mobile-jump-trigger" class="lg:hidden text-sm font-medium text-accent hover:text-accent-hover flex items-center gap-1 px-3 py-2 rounded-md hover:bg-white/50 transition-colors">
                <span>Jump to</span>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
        </div>
    </div>

    <!-- DocumentFrameShell -->
    <main class="flex-1 w-full max-w-7xl mx-auto px-4 lg:px-8 pb-32">
        <div class="flex flex-col lg:flex-row gap-8 relative">
            
            <!-- Desktop Navigation Rail (Sticky) -->
            <aside class="hidden lg:block w-48 shrink-0 relative">
                <div class="sticky top-24 max-h-[calc(100vh-8rem)] overflow-y-auto no-scrollbar py-2" id="desktop-nav-container">
                    <!-- Nav generated here -->
                </div>
            </aside>

            <!-- Paper Document Column -->
            <div class="flex-1 min-w-0 pt-4" id="paper-content-region">
                <div id="paper-container" class="space-y-12">
                    <!-- Content generated here -->
                    <div class="flex items-center justify-center h-64 text-ink-400">
                        Initializing...
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- Mobile Navigation Drawer -->
    <div id="mobile-drawer-backdrop" class="fixed inset-0 bg-black/20 z-40 hidden opacity-0 transition-opacity duration-200" aria-hidden="true"></div>
    <div id="mobile-drawer" class="fixed inset-y-0 right-0 z-50 w-64 bg-surface shadow-xl transform translate-x-full transition-transform duration-300 ease-out flex flex-col" aria-hidden="true">
        <div class="p-4 border-b border-border flex justify-between items-center">
            <h2 class="text-sm font-semibold text-ink-900">Jump to question</h2>
            <button id="drawer-close" class="text-ink-400 hover:text-ink-900 p-1">
                <span class="sr-only">Close menu</span>
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <div class="flex-1 overflow-y-auto p-4" id="mobile-nav-container">
            <!-- Nav generated here -->
        </div>
    </div>

    <!-- External Libs -->
    <!-- Markdown-it -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>
    <!-- KaTeX JS (No Integrity) -->
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <script>
        // --- STAGE 0: CONSTANTS (Canonical) ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // --- App State ---
        let globalPayload = null;
        let currentPaper = null;
        let md = null;

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            initMarkdown();
            loadPayload();
            setupInteractions();
        });

        function initMarkdown() {
            if (window.markdownit) {
                md = window.markdownit({
                    html: true,     // Payload requirement: passthrough inline SVG
                    linkify: true,
                    breaks: false   // Payload requirement: false to prevent <br> in math
                });
                // Payload requirement: Disable escape to preserve TeX backslashes
                md.inline.ruler.disable(['escape']);
            }
        }

        async function loadPayload() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Network response was not ok");
                globalPayload = await response.json();
                
                if (globalPayload && globalPayload.papers) {
                    initPaperSelector(globalPayload.papers);
                } else {
                    throw new Error("Invalid payload structure");
                }
            } catch (error) {
                console.error("Failed to load payload:", error);
                renderFailure();
            }
        }

        function renderFailure() {
            const container = document.getElementById('paper-container');
            container.innerHTML = `
                <div class="p-8 text-center border border-red-200 bg-red-50 text-red-800 rounded-md">
                    <h2 class="text-lg font-bold mb-2">PAPERS PAYLOAD MISSING</h2>
                    <p class="text-sm">Ensure the payload exists at <code>${RTQ_PAPERS_PAYLOAD_PATH}</code></p>
                </div>
            `;
            // Disable controls
            document.getElementById('paper-select').disabled = true;
        }

        function initPaperSelector(papers) {
            const select = document.getElementById('paper-select');
            select.innerHTML = '';
            
            papers.forEach((paper, index) => {
                const option = document.createElement('option');
                option.value = paper.key;
                option.textContent = paper.label;
                select.appendChild(option);
            });

            // Select first paper by default
            if (papers.length > 0) {
                loadPaper(papers[0].key);
            }

            select.addEventListener('change', (e) => {
                loadPaper(e.target.value);
            });
        }

        function loadPaper(paperKey) {
            if (!globalPayload) return;
            currentPaper = globalPayload.papers.find(p => p.key === paperKey);
            if (!currentPaper) return;

            renderPaperContent(currentPaper);
            renderNavigation(currentPaper);
            
            // Re-run KaTeX on the new content
            if (window.renderMathInElement) {
                renderMathInElement(document.body, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false}
                    ],
                    throwOnError: false
                });
            }

            // Reset scroll
            window.scrollTo({ top: 0, behavior: 'auto' });
        }

        // --- Rendering Logic ---

        function renderPaperContent(paper) {
            const container = document.getElementById('paper-container');
            container.innerHTML = '';

            // Handle Sections vs Flat
            if (paper.sections) {
                paper.sections.forEach((section, idx) => {
                    // Render Section Header if label exists
                    if (section.label && section.label.trim().length > 0) {
                        const sectionHeader = document.createElement('div');
                        sectionHeader.className = "pt-8 pb-4 border-b border-border mb-8";
                        sectionHeader.innerHTML = `<h2 class="text-lg font-bold text-ink-900">${section.label}</h2>`;
                        container.appendChild(sectionHeader);
                    }
                    // Render Questions
                    renderQuestionList(section.questions, container, paper.defaults, 0);
                });
            } else if (paper.questions) {
                renderQuestionList(paper.questions, container, paper.defaults, 0);
            }
        }

        function renderQuestionList(questions, container, defaults, depth) {
            if (!questions) return;
            
            questions.forEach((q, index) => {
                const isTopLevel = depth === 0;
                
                // Wrapper
                const nodeWrapper = document.createElement('div');
                nodeWrapper.id = `q-${q.id}`; // Anchor target
                
                // Vertical Spacing: Top level gets largest gap
                if (isTopLevel) {
                    nodeWrapper.className = "mb-16"; // Large gap between top-level questions
                } else {
                    nodeWrapper.className = "mt-6"; // Smaller gap for children
                }

                // --- Question Node Surface ---
                // Using a subtle container only for logic grouping, visual grouping is whitespace
                const contentWrapper = document.createElement('div');
                
                // Indentation for children (responsive)
                if (!isTopLevel) {
                    contentWrapper.className = "pl-4 lg:pl-8 border-l-2 border-transparent hover:border-border transition-colors"; // Hover guide for nesting
                }

                // 1. Question Body
                const questionBody = document.createElement('div');
                questionBody.className = "mb-4";
                
                // Identifier & Prompt
                const qHtml = md ? md.render(q.question || "") : (q.question || "");
                
                // Layout: ID on left, Content on right (or stacked)
                // Using a simple flex row for ID + Prompt
                questionBody.innerHTML = `
                    <div class="flex gap-4">
                        <div class="shrink-0 w-8 lg:w-12 pt-1">
                            <span class="text-ink-600 font-semibold text-base lg:text-lg block">${q.id}</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="text-ink-900 font-medium text-lg leading-relaxed md-content">${qHtml}</div>
                        </div>
                    </div>
                `;
                contentWrapper.appendChild(questionBody);

                // 2. Solution Block (Optional)
                if (q.solutionBlock) {
                    const sb = q.solutionBlock;
                    const blockWrapper = document.createElement('div');
                    // Align with question content (offset by id width)
                    blockWrapper.className = "ml-12 lg:ml-16 mt-4"; 

                    // A) Answer
                    if (sb.answer) {
                        const answerDiv = document.createElement('div');
                        answerDiv.className = "mb-4";
                        const ansHtml = md ? md.render(sb.answer) : sb.answer;
                        answerDiv.innerHTML = `
                            <div class="flex gap-2 items-baseline">
                                <span class="text-sm font-bold text-ink-900 shrink-0 select-none">Answer</span>
                                <div class="text-ink-900 md-content">${ansHtml}</div>
                            </div>
                        `;
                        blockWrapper.appendChild(answerDiv);
                    }

                    // B) Solution Details (Disclosure)
                    if (sb.solutionDetails) {
                        const sd = sb.solutionDetails;
                        // Determine default state
                        const isExpanded = defaults && defaults.expandedAll !== false; // Default true
                        
                        // Wrapper for the whole details region
                        const detailsRegion = document.createElement('div');
                        
                        // Disclosure Control
                        const toggleBtn = document.createElement('button');
                        toggleBtn.className = "group flex items-center gap-2 text-sm font-medium text-accent hover:text-accent-hover focus:outline-none mb-3 transition-colors";
                        toggleBtn.setAttribute('aria-expanded', isExpanded);
                        toggleBtn.innerHTML = `
                            <span class="toggle-text">${isExpanded ? 'Hide working' : 'Show working'}</span>
                            <svg class="w-4 h-4 transform transition-transform ${isExpanded ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        `;

                        // The Content Container
                        const contentDiv = document.createElement('div');
                        contentDiv.className = `space-y-6 ${isExpanded ? '' : 'hidden'}`;
                        
                        // Internal Grammar: Keep in mind -> Formulas -> Working -> Alt
                        
                        // Keep in mind
                        if (sd.keepInMind) {
                            const kimDiv = document.createElement('div');
                            kimDiv.className = "relative pl-4 border-l-2 border-accent/30";
                            const kimHtml = md ? md.render(sd.keepInMind) : sd.keepInMind;
                            kimDiv.innerHTML = `
                                <h4 class="text-xs font-bold uppercase tracking-wider text-ink-600 mb-2">Keep in mind</h4>
                                <div class="text-sm text-ink-600 md-content">${kimHtml}</div>
                            `;
                            contentDiv.appendChild(kimDiv);
                        }

                        // Formulas Used
                        if (sd.formulasUsed) {
                            const formDiv = document.createElement('div');
                            const formHtml = md ? md.render(sd.formulasUsed) : sd.formulasUsed;
                            formDiv.innerHTML = `
                                <h4 class="text-xs font-bold uppercase tracking-wider text-ink-600 mb-2">Formulas used</h4>
                                <div class="text-sm text-ink-600 md-content">${formHtml}</div>
                            `;
                            contentDiv.appendChild(formDiv);
                        }

                        // Working (Primary)
                        if (sd.working) {
                            const workDiv = document.createElement('div');
                            // Mixed prose/math logic handled by markdown renderer + KaTeX CSS
                            const workHtml = md ? md.render(sd.working) : sd.working;
                            workDiv.innerHTML = `
                                <h4 class="text-xs font-bold uppercase tracking-wider text-ink-600 mb-2">Working</h4>
                                <div class="text-base text-ink-600 md-content space-y-4">${workHtml}</div>
                            `;
                            contentDiv.appendChild(workDiv);
                        }

                        // Alternative Working
                        if (sd.alternativeWorking && Array.isArray(sd.alternativeWorking)) {
                            sd.alternativeWorking.forEach((alt, i) => {
                                const altDiv = document.createElement('div');
                                altDiv.className = "pt-4 border-t border-dashed border-border mt-4";
                                const altHtml = md ? md.render(alt) : alt;
                                altDiv.innerHTML = `
                                    <h4 class="text-xs font-bold uppercase tracking-wider text-ink-600 mb-2">Alternative working ${sd.alternativeWorking.length > 1 ? i+1 : ''}</h4>
                                    <div class="text-base text-ink-600 md-content space-y-4">${altHtml}</div>
                                `;
                                contentDiv.appendChild(altDiv);
                            });
                        }

                        // Interaction Logic
                        toggleBtn.onclick = () => {
                            const expanded = toggleBtn.getAttribute('aria-expanded') === 'true';
                            toggleBtn.setAttribute('aria-expanded', !expanded);
                            toggleBtn.querySelector('.toggle-text').textContent = !expanded ? 'Hide working' : 'Show working';
                            toggleBtn.querySelector('svg').classList.toggle('rotate-180');
                            contentDiv.classList.toggle('hidden');
                        };

                        detailsRegion.appendChild(toggleBtn);
                        detailsRegion.appendChild(contentDiv);
                        blockWrapper.appendChild(detailsRegion);
                    }

                    contentWrapper.appendChild(blockWrapper);
                }

                nodeWrapper.appendChild(contentWrapper);

                // 3. Children (Recursive)
                if (q.children && q.children.length > 0) {
                    const childrenContainer = document.createElement('div');
                    childrenContainer.className = "mt-4";
                    renderQuestionList(q.children, childrenContainer, defaults, depth + 1);
                    nodeWrapper.appendChild(childrenContainer);
                }

                container.appendChild(nodeWrapper);
            });
        }

        // --- Navigation Logic ---

        function renderNavigation(paper) {
            const deskContainer = document.getElementById('desktop-nav-container');
            const mobileContainer = document.getElementById('mobile-nav-container');
            
            // Build list HTML
            let html = '<nav class="space-y-1">';
            
            if (paper.sections) {
                paper.sections.forEach(section => {
                    // Section Label (Non-clickable signpost)
                    if (section.label && section.label.trim().length > 0) {
                        html += `
                            <div class="px-2 py-2 mt-4 first:mt-0 text-xs font-bold text-ink-400 uppercase tracking-wider select-none">
                                ${section.label}
                            </div>
                        `;
                    }
                    html += buildNavItems(section.questions, 0);
                });
            } else if (paper.questions) {
                html += buildNavItems(paper.questions, 0);
            }
            html += '</nav>';

            deskContainer.innerHTML = html;
            mobileContainer.innerHTML = html;

            setupNavObservers();
        }

        function buildNavItems(questions, depth) {
            let html = '';
            questions.forEach(q => {
                // Stage 5.4.5: Flat list. Hierarchy via type scale only.
                // Sub-questions: slightly smaller/lighter, but SAME left padding.
                const isTop = depth === 0;
                const fontSize = isTop ? 'text-sm' : 'text-xs';
                const color = isTop ? 'text-ink-600' : 'text-ink-400';
                
                html += `
                    <a href="#q-${q.id}" class="nav-link block px-3 py-1.5 ${fontSize} ${color} hover:bg-black/5 hover:text-ink-900 rounded-md transition-colors" data-target="q-${q.id}">
                        ${q.id}
                    </a>
                `;
                
                if (q.children && q.children.length > 0) {
                    html += buildNavItems(q.children, depth + 1);
                }
            });
            return html;
        }

        function setupNavObservers() {
            // Smooth scroll and Drawer close
            const links = document.querySelectorAll('.nav-link');
            links.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetId = link.getAttribute('data-target');
                    const targetEl = document.getElementById(targetId);
                    if (targetEl) {
                        // Offset for sticky header
                        const offset = 100; 
                        const elementPosition = targetEl.getBoundingClientRect().top;
                        const offsetPosition = elementPosition + window.pageYOffset - offset;
                        
                        window.scrollTo({
                            top: offsetPosition,
                            behavior: "smooth"
                        });
                    }
                    closeDrawer();
                });
            });

            // Active state observer
            const observerOptions = {
                root: null,
                rootMargin: '-20% 0px -60% 0px',
                threshold: 0
            };

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const id = entry.target.id;
                        updateActiveNav(id);
                    }
                });
            }, observerOptions);

            document.querySelectorAll('[id^="q-"]').forEach(el => observer.observe(el));
        }

        function updateActiveNav(id) {
            // Reset all
            document.querySelectorAll('.nav-link').forEach(l => {
                l.classList.remove('font-bold', 'text-accent', 'bg-accent/5');
            });
            
            // Set active
            const activeLinks = document.querySelectorAll(`.nav-link[data-target="${id}"]`);
            activeLinks.forEach(l => {
                l.classList.add('font-bold', 'text-accent', 'bg-accent/5');
            });
        }

        // --- Interactions (Drawer) ---

        function setupInteractions() {
            const trigger = document.getElementById('mobile-jump-trigger');
            const closeBtn = document.getElementById('drawer-close');
            const drawer = document.getElementById('mobile-drawer');
            const backdrop = document.getElementById('mobile-drawer-backdrop');

            const open = () => {
                drawer.classList.remove('translate-x-full');
                backdrop.classList.remove('hidden', 'opacity-0');
                document.body.classList.add('drawer-open');
            };

            const close = () => {
                drawer.classList.add('translate-x-full');
                backdrop.classList.add('opacity-0');
                setTimeout(() => backdrop.classList.add('hidden'), 200);
                document.body.classList.remove('drawer-open');
            };

            trigger.onclick = open;
            closeBtn.onclick = close;
            backdrop.onclick = close;
            window.closeDrawer = close; // Expose for nav links
        }

    </script>
</body>
</html>
