<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AD","indexWithinVariant":"208","totalWithinVariant":"440","hueFamily":"","intensityMode":"","primaryHueFamily":"purple","secondaryHueFamily":"pink","dualIntensityMode":"dual_deep_theme","timestamp":"2026-01-10T11:16:55.770Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AD&quot;,&quot;indexWithinVariant&quot;:&quot;208&quot;,&quot;totalWithinVariant&quot;:&quot;440&quot;,&quot;hueFamily&quot;:&quot;&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;primaryHueFamily&quot;:&quot;purple&quot;,&quot;secondaryHueFamily&quot;:&quot;pink&quot;,&quot;dualIntensityMode&quot;:&quot;dual_deep_theme&quot;,&quot;timestamp&quot;:&quot;2026-01-10T11:16:55.770Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>
    
    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* 
           Stage 6 Add-on: ColorLab D (Dual-Accent Palette, Quantified, Light-Only) 
           Mode: dual_deep_theme
           Primary Hue Fallback: Blue (260)
           Secondary Hue Fallback: Amber (85)
        */
        :root {
            /* Hue Definitions */
            --hue-p: 260;
            --hue-s: 85;

            /* Mode: dual_deep_theme (Quantified OKLCH) */
            /* 1. All major surfaces are chromatic */
            --col-page-bg: oklch(0.95 0.08 var(--hue-p));
            --col-frame-bg: oklch(0.93 0.10 var(--hue-p));
            --col-paper-bg: oklch(0.98 0.06 var(--hue-p));

            /* 2. Surface separation via L steps */
            /* 3. Text high-legibility, mostly neutral */
            --col-text-p: oklch(0.20 0.015 var(--hue-p));
            --col-text-s: oklch(0.35 0.020 var(--hue-p));

            /* 4. Primary Accent (Links, Focus, Controls) */
            --col-accent-p: oklch(0.55 0.20 var(--hue-p));

            /* 5. Secondary Accent (Single supplementary role) */
            --col-accent-s: oklch(0.65 0.18 var(--hue-s));

            /* 6. Hairlines/Dividers (Neutral-leaning, low chroma) */
            --col-divider: oklch(0.85 0.02 var(--hue-p));

            /* Supporting Surfaces */
            --col-wash: oklch(0.96 0.04 var(--hue-p));
        }

        body {
            background-color: var(--col-page-bg);
            color: var(--col-text-p);
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            margin: 0;
        }

        /* Document Frame Shell */
        .doc-shell {
            background-color: var(--col-frame-bg);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 1280px; /* Centered max width */
            margin: 0 auto;
        }

        /* Desktop Layout (Two Column) */
        @media (min-width: 1024px) {
            .doc-shell {
                flex-direction: row;
                align-items: flex-start;
            }
            .nav-rail {
                position: sticky;
                top: 0;
                height: 100vh;
                width: 260px;
                flex-shrink: 0;
                overflow-y: auto;
                scrollbar-width: none; /* Hide scrollbar Firefox */
            }
            .nav-rail::-webkit-scrollbar { display: none; } /* Hide scrollbar Webkit */
            .paper-column {
                flex-grow: 1;
                min-width: 0; /* Prevent flex overflow */
            }
        }

        /* Paper Surface & Spacing */
        .paper-surface {
            background-color: var(--col-paper-bg);
            /* Padding handled by utility classes */
        }

        /* Typography & Markdown */
        .md-content p { margin-bottom: 0.75em; line-height: 1.6; }
        .md-content p:last-child { margin-bottom: 0; }
        .md-content ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 0.75em; }
        .md-content ol { list-style-type: decimal; padding-left: 1.5em; margin-bottom: 0.75em; }
        .md-content table { width: 100%; border-collapse: collapse; margin-bottom: 1em; font-size: 0.95em; }
        .md-content th, .md-content td { border: 1px solid var(--col-divider); padding: 0.5em; text-align: left; }
        .md-content th { font-weight: 600; background-color: rgba(0,0,0,0.02); }
        .md-content img, .md-content svg { max-width: 100%; height: auto; display: block; margin: 0.5em 0; }
        .md-content strong { font-weight: 600; color: var(--col-text-p); }

        /* KaTeX Containment Invariant */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding: 0.5em 0;
            background-color: transparent; /* No background for math blocks per Stage 5.8 */
            -webkit-overflow-scrolling: touch;
        }
        
        /* Utils */
        .text-primary { color: var(--col-text-p); }
        .text-secondary { color: var(--col-text-s); }
        .text-accent-p { color: var(--col-accent-p); }
        .text-accent-s { color: var(--col-accent-s); }
        .border-divider { border-color: var(--col-divider); }
        .bg-wash { background-color: var(--col-wash); }
        
        .interactive-text:hover { color: var(--col-accent-p); text-decoration: underline; text-decoration-color: var(--col-accent-p); text-decoration-thickness: 1px; }
        .interactive-text:focus-visible { outline: 2px solid var(--col-accent-p); outline-offset: 2px; border-radius: 2px; }

        .btn-reset { background: none; border: none; padding: 0; cursor: pointer; font: inherit; color: inherit; }

        /* Navigation Active State */
        .nav-item-active {
            font-weight: 700;
            color: var(--col-accent-p);
            border-left: 3px solid var(--col-accent-p);
        }
        .nav-item {
            border-left: 3px solid transparent; /* Stabilize layout */
        }
    </style>
</head>
<body>

<div id="app" class="w-full">
    <!-- UI Shell rendered here -->
</div>

<script>
    // ===== STAGE 0: CONSTANTS =====
    const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
    const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

    // ===== APP STATE =====
    let state = {
        papers: [],
        activePaperKey: null,
        loading: true,
        error: null,
        expandedMap: {}, // key: questionId, value: boolean
        mobileNavOpen: false
    };

    // ===== MARKDOWN SETUP (Stage 6) =====
    const md = window.markdownit ? window.markdownit({
        html: true,
        linkify: true,
        breaks: false // CRITICAL: false to prevent <br> in math
    }) : null;
    
    if (md) {
        md.inline.ruler.disable(['escape']); // Preserve TeX backslashes
    }

    // ===== INITIALIZATION =====
    async function init() {
        renderLoading();
        try {
            const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
            if (!response.ok) throw new Error("Payload Missing");
            const data = await response.json();
            
            if (!data.papers || !Array.isArray(data.papers)) throw new Error("Invalid Format");

            state.papers = data.papers;
            if (state.papers.length > 0) {
                switchPaper(state.papers[0].key);
            } else {
                throw new Error("No Papers");
            }
        } catch (e) {
            state.error = "PAPERS PAYLOAD MISSING"; // Deterministic Failure Message
            state.loading = false;
            renderApp();
        }
    }

    function switchPaper(key) {
        state.activePaperKey = key;
        state.expandedMap = {};
        state.mobileNavOpen = false;
        state.loading = false;
        
        const paper = state.papers.find(p => p.key === key);
        if (paper && paper.defaults && paper.defaults.expandedAll === false) {
            // Default is expanded, so we only track if strictly false.
            // Logic: if expandedAll is true/undefined, map stays empty (interpreted as open)
            // If expandedAll is false, we mark all potential toggles as false? 
            // Better: we interpret missing key in map as "Default State".
            // If paper.defaults.expandedAll is false, default is collapsed.
        }
        
        renderApp();
        // Scroll to top
        window.scrollTo(0, 0);
    }

    // ===== LOGIC HELPERS =====
    function getActivePaper() {
        return state.papers.find(p => p.key === state.activePaperKey);
    }

    function isExpanded(qId) {
        const paper = getActivePaper();
        const defaultExpanded = paper.defaults?.expandedAll !== false; // Default true
        if (state.expandedMap[qId] === undefined) return defaultExpanded;
        return state.expandedMap[qId];
    }

    function toggleQuestion(qId) {
        const current = isExpanded(qId);
        state.expandedMap[qId] = !current;
        renderApp(); // Re-render to update state
        
        // Restore focus to toggle button after re-render if using keyboard?
        // For simple prototype, re-render is acceptable.
        // In React we'd keep DOM. Here we rebuild string.
        // We will attempt to preserve scroll position naturally.
    }

    function toggleMobileNav() {
        state.mobileNavOpen = !state.mobileNavOpen;
        renderApp();
    }

    function closeMobileNav() {
        state.mobileNavOpen = false;
        renderApp();
    }

    function jumpTo(id) {
        closeMobileNav();
        const el = document.getElementById(`q-${id}`);
        if (el) {
            el.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }

    // ===== RENDERING =====
    function renderLoading() {
        document.getElementById('app').innerHTML = `
            <div class="flex items-center justify-center min-h-screen">
                <span class="text-secondary animate-pulse">Loading Papers...</span>
            </div>
        `;
    }

    function renderApp() {
        const app = document.getElementById('app');
        
        if (state.error) {
            app.innerHTML = `
                <div class="doc-shell p-8">
                    <h1 class="text-xl font-bold text-accent-p mb-4">RTQ Viewer</h1>
                    <div class="p-8 border-2 border-dashed border-divider text-center text-secondary">
                        ${state.error}
                    </div>
                </div>
            `;
            return;
        }

        const paper = getActivePaper();
        if (!paper) return;

        // Render Structure
        let html = `
            <div class="doc-shell relative">
                <!-- Mobile Header / Top Controls -->
                <div class="lg:hidden flex items-center justify-between p-4 border-b border-divider bg-[var(--col-frame-bg)] sticky top-0 z-20">
                    <div class="flex items-center gap-3">
                        ${renderPaperSelector()}
                    </div>
                    <button onclick="toggleMobileNav()" class="btn-reset p-2 text-primary" aria-label="Jump to">
                        <span class="text-sm font-medium mr-1 text-accent-p">Jump to</span>
                    </button>
                </div>

                <!-- Desktop Nav Rail -->
                <aside class="nav-rail hidden lg:block py-8 pl-6 pr-4">
                    <div class="mb-6">
                        ${renderPaperSelector()}
                    </div>
                    <nav class="space-y-1" role="navigation" aria-label="Paper Navigation">
                        ${renderNavList(paper)}
                    </nav>
                </aside>

                <!-- Mobile Drawer -->
                ${state.mobileNavOpen ? `
                <div class="fixed inset-0 z-50 flex">
                    <div class="fixed inset-0 bg-black/20" onclick="closeMobileNav()"></div>
                    <div class="relative w-64 bg-[var(--col-frame-bg)] h-full shadow-xl flex flex-col">
                        <div class="p-4 border-b border-divider flex justify-between items-center">
                            <span class="font-bold text-lg text-primary">Jump to</span>
                            <button onclick="closeMobileNav()" class="btn-reset p-2"><i data-lucide="x" class="w-5 h-5"></i></button>
                        </div>
                        <div class="flex-1 overflow-y-auto p-4">
                            <nav class="space-y-1">
                                ${renderNavList(paper, true)}
                            </nav>
                        </div>
                    </div>
                </div>
                ` : ''}

                <!-- Paper Content Column -->
                <main class="paper-column min-h-screen relative w-full">
                    <div class="paper-surface max-w-3xl mx-auto min-h-screen pt-8 pb-32 px-4 sm:px-8 lg:px-12 shadow-sm border-x border-divider/30">
                        ${renderPaperContent(paper)}
                    </div>
                </main>
            </div>
        `;

        app.innerHTML = html;
        
        // Post-Render Effects
        lucide.createIcons();
        renderMathInElement(document.body, {
            delimiters: [
                {left: "$$", right: "$$", display: true},
                {left: "$", right: "$", display: false}
            ],
            throwOnError: false,
            output: 'html' // Ensure HTML output for accessibility
        });
        
        // Setup Scroll Spy for Nav
        setupScrollSpy();
    }

    function renderPaperSelector() {
        // Simple HTML select
        return `
            <select onchange="switchPaper(this.value)" class="bg-transparent border border-divider rounded px-2 py-1 text-sm text-primary focus-visible:ring-2 focus-visible:ring-[var(--col-accent-p)] outline-none cursor-pointer">
                ${state.papers.map(p => `
                    <option value="${p.key}" ${p.key === state.activePaperKey ? 'selected' : ''}>
                        ${p.label}
                    </option>
                `).join('')}
            </select>
        `;
    }

    function renderNavList(paper, isMobile = false) {
        if (paper.sections) {
            return paper.sections.map(sec => {
                const label = sec.label && sec.label.trim().length > 0 
                    ? `<div class="pt-4 pb-2 text-xs font-bold text-secondary uppercase tracking-wider select-none px-3">${sec.label}</div>` 
                    : '';
                
                const items = sec.questions.map(q => renderNavItem(q)).join('');
                return `<div>${label}${items}</div>`;
            }).join('');
        } else {
            return paper.questions.map(q => renderNavItem(q)).join('');
        }
    }

    function renderNavItem(q) {
        // Flattened list. Children logic not strictly required for flat list unless payload has pure grouping nodes.
        // Assuming payload questions[] are top level, and we want to list identifiers.
        // If a question has children, do we list children in nav? Brief says "Identifiers only (e.g. 7, 7a)".
        // We need to traverse to list all identifiable nodes.
        
        let output = '';
        const id = q.id;
        
        // Render self
        if (id) {
            output += `
                <button onclick="jumpTo('${id}')" 
                    class="nav-item w-full text-left px-3 py-1.5 text-sm text-secondary hover:text-[var(--col-accent-p)] transition-colors block border-l-2 border-transparent"
                    data-target="q-${id}">
                    ${id}
                </button>
            `;
        }

        // Render children
        if (q.children && q.children.length > 0) {
            output += q.children.map(c => renderNavItem(c)).join('');
        }

        return output;
    }

    function renderPaperContent(paper) {
        if (paper.sections) {
            return paper.sections.map(sec => {
                const header = sec.label && sec.label.trim().length > 0
                    ? `<div class="mb-8 pt-4 border-b border-divider pb-2">
                        <h2 class="text-xl font-bold text-primary">${sec.label}</h2>
                       </div>`
                    : '';
                return `
                    <section class="mb-12">
                        ${header}
                        <div class="space-y-12">
                            ${sec.questions.map(q => renderQuestionNode(q, 0)).join('')}
                        </div>
                    </section>
                `;
            }).join('');
        } else {
            return `
                <div class="space-y-12">
                    ${paper.questions.map(q => renderQuestionNode(q, 0)).join('')}
                </div>
            `;
        }
    }

    function renderQuestionNode(q, depth) {
        const hasSolutionBlock = !!q.solutionBlock;
        const hasAnswer = hasSolutionBlock && !!q.solutionBlock.answer;
        const hasDetails = hasSolutionBlock && !!q.solutionBlock.solutionDetails;
        
        const expanded = isExpanded(q.id);
        const qHtml = md ? md.render(q.question || '') : q.question;

        // Indentation logic via padding-left, adaptive
        const indentClass = depth > 0 ? (depth === 1 ? 'ml-0 sm:ml-6' : 'ml-0 sm:ml-10') : '';
        const verticalSpacing = depth > 0 ? 'mt-8' : 'mt-16'; // Tighter for children

        return `
            <div id="q-${q.id}" class="question-node ${indentClass} ${verticalSpacing} relative group">
                <!-- Question Body -->
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-8 sm:w-10 pt-1">
                        <span class="text-lg sm:text-xl font-bold text-secondary font-sans leading-none block sticky top-24">${q.id}</span>
                    </div>
                    <div class="flex-grow min-w-0">
                        <!-- Prompt -->
                        <div class="md-content text-lg sm:text-xl text-primary font-medium leading-relaxed">
                            ${qHtml}
                        </div>

                        <!-- Solution Block -->
                        ${hasSolutionBlock ? `
                            <div class="mt-6 border-t border-divider/50 pt-4">
                                <!-- Answer -->
                                ${hasAnswer ? `
                                    <div class="mb-4">
                                        <div class="text-xs font-bold text-secondary uppercase tracking-wider mb-1">Answer</div>
                                        <div class="md-content text-lg text-primary">
                                            ${md.render(q.solutionBlock.answer)}
                                        </div>
                                    </div>
                                ` : ''}

                                <!-- Solution Details Toggle -->
                                ${hasDetails ? `
                                    <div class="mt-4">
                                        <button onclick="toggleQuestion('${q.id}')" 
                                            class="flex items-center gap-2 text-sm font-bold text-accent-p hover:underline btn-reset interactive-text mb-2">
                                            <span>${expanded ? 'Hide working' : 'Show working'}</span>
                                            <i data-lucide="chevron-${expanded ? 'up' : 'down'}" class="w-4 h-4"></i>
                                        </button>

                                        ${expanded ? renderSolutionDetails(q.solutionBlock.solutionDetails) : ''}
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}
                    </div>
                </div>

                <!-- Children -->
                ${q.children && q.children.length > 0 ? `
                    <div class="children-container mt-2">
                        ${q.children.map(c => renderQuestionNode(c, depth + 1)).join('')}
                    </div>
                ` : ''}
            </div>
        `;
    }

    function renderSolutionDetails(details) {
        if (!details) return '';
        
        const { keepInMind, formulasUsed, working, alternativeWorking } = details;

        return `
            <div class="bg-wash rounded-sm p-4 sm:p-6 mt-2 border-l-2 border-divider animate-in fade-in zoom-in-95 duration-200 origin-top">
                
                <!-- Keep in Mind -->
                ${keepInMind ? `
                    <div class="mb-6">
                        <div class="flex items-center gap-2 text-sm font-bold text-secondary mb-2">
                            <i data-lucide="lightbulb" class="w-4 h-4"></i>
                            <span>Keep in mind</span>
                        </div>
                        <div class="md-content text-base text-secondary">
                            ${md.render(keepInMind)}
                        </div>
                    </div>
                ` : ''}

                <!-- Formulas -->
                ${formulasUsed ? `
                    <div class="mb-6">
                        <div class="text-sm font-bold text-secondary mb-2">Formulas used</div>
                        <div class="md-content text-base text-secondary font-mono text-sm bg-white/50 p-2 rounded border border-divider/50">
                            ${md.render(formulasUsed)}
                        </div>
                    </div>
                ` : ''}

                <!-- Working (Primary) -->
                ${working ? `
                    <div class="mb-6">
                        <div class="text-sm font-bold text-secondary mb-2">Working</div>
                        <div class="md-content text-base text-secondary working-content space-y-4">
                            ${md.render(working)}
                        </div>
                    </div>
                ` : ''}

                <!-- Alt Working -->
                ${alternativeWorking && Array.isArray(alternativeWorking) ? alternativeWorking.map((aw, idx) => `
                    <div class="mt-8 pt-6 border-t border-divider border-dashed">
                        <div class="text-sm font-bold text-secondary mb-2">Alternative working ${alternativeWorking.length > 1 ? idx + 1 : ''}</div>
                        <div class="md-content text-base text-secondary working-content">
                            ${md.render(aw)}
                        </div>
                    </div>
                `).join('') : ''}
            </div>
        `;
    }

    // ===== SCROLL SPY =====
    function setupScrollSpy() {
        // Intersection Observer to highlight nav items
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const id = entry.target.id; // q-18(a)
                    // Remove active from all
                    document.querySelectorAll('.nav-item').forEach(el => {
                        el.classList.remove('nav-item-active');
                        el.classList.add('border-transparent');
                    });
                    
                    // Add active to current
                    const activeBtn = document.querySelector(`button[data-target="${id}"]`);
                    if (activeBtn) {
                        activeBtn.classList.add('nav-item-active');
                        activeBtn.classList.remove('border-transparent');
                        
                        // Scroll nav into view if desktop
                        if (window.innerWidth >= 1024) {
                           // Logic to keep nav visible? 
                           // For now, simple standard highlight.
                        }
                    }
                }
            });
        }, {
            rootMargin: '-10% 0px -80% 0px' // Trigger near top
        });

        document.querySelectorAll('.question-node').forEach(node => observer.observe(node));
    }

    // Start
    init();

</script>
</body>
</html>
