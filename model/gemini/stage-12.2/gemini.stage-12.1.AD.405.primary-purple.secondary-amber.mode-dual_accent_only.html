<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AD","indexWithinVariant":"405","totalWithinVariant":"440","hueFamily":"","intensityMode":"","primaryHueFamily":"purple","secondaryHueFamily":"amber","dualIntensityMode":"dual_accent_only","timestamp":"2026-01-11T00:34:20.875Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AD&quot;,&quot;indexWithinVariant&quot;:&quot;405&quot;,&quot;totalWithinVariant&quot;:&quot;440&quot;,&quot;hueFamily&quot;:&quot;&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;primaryHueFamily&quot;:&quot;purple&quot;,&quot;secondaryHueFamily&quot;:&quot;amber&quot;,&quot;dualIntensityMode&quot;:&quot;dual_accent_only&quot;,&quot;timestamp&quot;:&quot;2026-01-11T00:34:20.875Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Markdown-it -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/13.0.1/markdown-it.min.js"></script>

    <!-- KaTeX (SRI Disabled per Stage 6) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <style>
        /* COLORLAB D: DUAL-ACCENT PALETTE (Mode 1: dual_accent_only) */
        /* Primary Hue: Blue (approx 264), Secondary Hue: Amber (approx 88) */
        /* Light Mode Only per constraints */
        :root {
            /* Surfaces (C <= 0.015) */
            --col-surface-page: oklch(0.985 0.005 264);
            --col-surface-frame: oklch(0.985 0.005 264); /* Shared base surface per Stage 3 */
            --col-surface-paper: oklch(0.99 0.002 264);
            --col-surface-wash: oklch(0.97 0.01 264); /* Subtle wash for SD */

            /* Text (C <= 0.010) */
            --col-text-primary: oklch(0.20 0.01 264);
            --col-text-secondary: oklch(0.45 0.01 264);
            --col-text-quiet: oklch(0.60 0.005 264);

            /* Lines */
            --col-line-hairline: oklch(0.92 0.005 264);
            --col-line-table: oklch(0.90 0.005 264);

            /* Primary Accent (Blue, C [0.08..0.14]) - Links, Focus, Toggle */
            --col-accent-primary: oklch(0.55 0.12 264);
            --col-accent-primary-hover: oklch(0.50 0.12 264);
            
            /* Secondary Accent (Amber, C [0.06..0.12]) - Supplementary (e.g. current nav marker) */
            --col-accent-secondary: oklch(0.70 0.12 88);

            /* Focus Ring */
            --col-focus-ring: var(--col-accent-primary);
        }

        body {
            background-color: var(--col-surface-page);
            color: var(--col-text-primary);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            overflow-y: scroll; /* Force vertical scrollbar to avoid layout shift */
        }

        /* Focus Styles */
        :focus-visible {
            outline: 2px solid var(--col-focus-ring);
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* Typography Utilities */
        .text-primary { color: var(--col-text-primary); }
        .text-secondary { color: var(--col-text-secondary); }
        .text-quiet { color: var(--col-text-quiet); }
        .text-accent { color: var(--col-accent-primary); }
        
        .bg-paper { background-color: var(--col-surface-paper); }
        .bg-wash { background-color: var(--col-surface-wash); }
        
        .border-hairline { border-color: var(--col-line-hairline); }

        /* KaTeX Containment Invariant */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding: 0.5em 0;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Hide scrollbar for math/nav but keep functionality */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Navigation Scrollbar Hiding */
        .nav-scroll-container {
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE/Edge */
        }
        .nav-scroll-container::-webkit-scrollbar {
            display: none; /* Chrome/Safari/Opera */
        }

        /* Layout & Spacing */
        .doc-shell {
            max-width: 1200px;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Markdown Content Styles - Minimal/Paper-like */
        .prose p { margin-bottom: 1em; line-height: 1.6; }
        .prose ul { list-style-type: disc; padding-left: 1.25em; margin-bottom: 1em; }
        .prose ol { list-style-type: decimal; padding-left: 1.25em; margin-bottom: 1em; }
        .prose table { width: 100%; border-collapse: collapse; margin-bottom: 1em; font-size: 0.95em; }
        .prose th, .prose td { 
            border: 1px solid var(--col-line-table); 
            padding: 0.5em 0.75em; 
            text-align: left; 
            vertical-align: top; 
        }
        .prose th { font-weight: 600; background-color: transparent; }
        
        /* Inline math no background */
        .katex { font-size: 1.1em; }
        
        /* Solution Details Transition */
        .details-enter { max-height: 0; opacity: 0; overflow: hidden; transition: all 0.3s ease-out; }
        .details-enter-active { max-height: 2000px; opacity: 1; }
        .details-exit { max-height: 2000px; opacity: 1; overflow: hidden; transition: all 0.2s ease-in; }
        .details-exit-active { max-height: 0; opacity: 0; }

        /* Drawer Overlay */
        .drawer-overlay {
            background-color: rgba(0,0,0,0.2);
            backdrop-filter: blur(2px);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- STAGE 0: CONSTANTS ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // --- MARKDOWN INIT ---
        // Stage 6: Hardened config (breaks: false, disable escape)
        const md = window.markdownit ? window.markdownit({
            html: true,
            linkify: true,
            breaks: false 
        }) : null;

        if (md) {
            md.inline.ruler.disable(['escape']);
        }

        // --- ICONS ---
        const { Menu, X, ChevronDown, ChevronRight, Check } = lucide;

        // --- UTILS ---
        const cn = (...classes) => classes.filter(Boolean).join(" ");

        // KaTeX Auto-render wrapper
        const MathContent = ({ content, className }) => {
            const containerRef = React.useRef(null);

            React.useEffect(() => {
                if (containerRef.current && content) {
                    // 1. Render Markdown -> HTML
                    const rawHtml = md ? md.render(content) : content;
                    containerRef.current.innerHTML = rawHtml;

                    // 2. Render KaTeX
                    if (window.renderMathInElement) {
                        renderMathInElement(containerRef.current, {
                            delimiters: [
                                {left: '$$', right: '$$', display: true},
                                {left: '$', right: '$', display: false},
                                {left: '\\(', right: '\\)', display: false},
                                {left: '\\[', right: '\\]', display: true}
                            ],
                            throwOnError: false
                        });
                    }
                }
            }, [content]);

            return <div ref={containerRef} className={cn("prose max-w-none text-primary", className)} />;
        };

        // --- COMPONENTS ---

        // Navigation Item
        const NavItem = ({ id, active, onClick, depth = 0 }) => {
            // Stage 5.4.3: Active state strength = One strong cue (weight) + optional marker
            // ColorLab D: Secondary accent allowed for secondary marker
            return (
                <button 
                    onClick={onClick}
                    className={cn(
                        "group flex items-center w-full text-left py-1 px-2 text-sm transition-colors",
                        active ? "font-bold text-primary" : "font-normal text-secondary hover:text-primary"
                    )}
                >
                    {/* Visual flat list, hierarchy via type scale/opacity implied by brief, 
                        but here we keep strictly flat per "Flat list" lock.
                        We can scale down font slightly for deep nesting if needed, 
                        but brief says "Hierarchy via type scale only". */}
                    <span className={cn(
                        "truncate", 
                        depth > 0 ? "text-[0.9em]" : "text-[1em]"
                    )}>
                        {id}
                    </span>
                    {active && (
                        <span 
                            className="ml-auto w-1.5 h-1.5 rounded-full" 
                            style={{ backgroundColor: 'var(--col-accent-secondary)' }} 
                        />
                    )}
                </button>
            );
        };

        const NavSectionLabel = ({ label }) => (
            <div className="px-2 pt-4 pb-2 text-xs font-semibold uppercase tracking-wider text-quiet select-none">
                {label}
            </div>
        );

        // Recursive helper to flatten questions for Nav
        const flattenQuestions = (questions, sectionLabel = null, depth = 0) => {
            let list = [];
            questions.forEach(q => {
                list.push({ ...q, sectionLabel, depth });
                if (q.children && q.children.length > 0) {
                    list = list.concat(flattenQuestions(q.children, null, depth + 1));
                }
            });
            return list;
        };

        const NavigationList = ({ paper, activeId, onJump }) => {
            const isSectioned = paper.sections && paper.sections.length > 0;
            
            let navItems = [];
            if (isSectioned) {
                paper.sections.forEach(section => {
                    const label = (section.label || "").trim();
                    // flatten section questions
                    const qFlat = flattenQuestions(section.questions, label);
                    navItems.push({ type: 'section', label, items: qFlat });
                });
            } else {
                // Flat paper
                navItems.push({ type: 'section', label: null, items: flattenQuestions(paper.questions || []) });
            }

            return (
                <nav className="flex flex-col pb-10">
                    {navItems.map((block, idx) => (
                        <div key={idx}>
                            {block.label && <NavSectionLabel label={block.label} />}
                            <div className="flex flex-col gap-0.5">
                                {block.items.map(item => (
                                    <NavItem 
                                        key={item.id}
                                        id={item.id}
                                        depth={item.depth}
                                        active={activeId === item.id}
                                        onClick={() => onJump(item.id)}
                                    />
                                ))}
                            </div>
                            {/* Separator between sections if needed */}
                            {idx < navItems.length - 1 && <div className="h-4" />}
                        </div>
                    ))}
                </nav>
            );
        };

        // Solution Details Block
        const SolutionDetailsRegion = ({ details, expanded }) => {
            if (!expanded || !details) return null;

            // Structure: Keep in mind -> Formulas used -> Working -> Alternative working
            return (
                <div className="mt-4 pt-4 pb-4 px-4 -mx-4 md:mx-0 md:px-4 md:rounded-sm bg-wash text-secondary">
                    {/* Keep In Mind */}
                    {details.keepInMind && (
                        <div className="mb-4">
                            <div className="flex items-center gap-2 mb-1 text-xs font-bold uppercase tracking-wide text-secondary">
                                <Check size={14} /> Keep in mind
                            </div>
                            <MathContent content={details.keepInMind} className="text-sm" />
                        </div>
                    )}

                    {/* Formulas Used */}
                    {details.formulasUsed && (
                        <div className="mb-4 pt-4 border-t border-hairline">
                            <div className="text-xs font-bold uppercase tracking-wide text-secondary mb-1">
                                Formulas used
                            </div>
                            <MathContent content={details.formulasUsed} className="text-sm" />
                        </div>
                    )}

                    {/* Working (Primary) */}
                    {details.working && (
                        <div className="mb-4 pt-4 border-t border-hairline">
                            <div className="text-xs font-bold uppercase tracking-wide text-secondary mb-2">
                                Working
                            </div>
                            <MathContent content={details.working} className="text-base text-primary" />
                        </div>
                    )}

                    {/* Alternative Working */}
                    {details.alternativeWorking && details.alternativeWorking.map((alt, idx) => (
                        <div key={idx} className="mt-6 pt-4 border-t border-hairline">
                            <div className="text-xs font-bold uppercase tracking-wide text-secondary mb-2">
                                Alternative working
                            </div>
                            <MathContent content={alt} className="text-base text-primary" />
                        </div>
                    ))}
                </div>
            );
        };

        const SolutionBlock = ({ question, expandedMap, toggleExpanded }) => {
            const sb = question.solutionBlock;
            if (!sb) return null; // No solution block

            const hasAnswer = !!sb.answer;
            const hasDetails = !!sb.solutionDetails;
            const isExpanded = expandedMap[question.id];

            return (
                <div className="mt-4">
                    {/* Answer */}
                    {hasAnswer && (
                        <div className="mb-3">
                            <div className="text-xs font-bold text-secondary uppercase tracking-wide mb-1">Answer</div>
                            <MathContent content={sb.answer} className="text-lg font-medium" />
                        </div>
                    )}

                    {/* Disclosure Control */}
                    {hasDetails && (
                        <div>
                            <button 
                                onClick={() => toggleExpanded(question.id)}
                                className="inline-flex items-center gap-1 text-sm font-medium text-accent hover:text-[var(--col-accent-primary-hover)] transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-[var(--col-focus-ring)] rounded py-1 pr-2"
                                aria-expanded={isExpanded}
                            >
                                {isExpanded ? "Hide working" : "Show working"}
                                {isExpanded ? <ChevronDown size={16} /> : <ChevronRight size={16} />}
                            </button>

                            {isExpanded && (
                                <SolutionDetailsRegion details={sb.solutionDetails} expanded={isExpanded} />
                            )}
                        </div>
                    )}
                </div>
            );
        };

        const QuestionNode = ({ question, depth = 0, expandedMap, toggleExpanded }) => {
            // Layout: Vertical spacing based on depth
            // Top-level: SPC__TOP_LEVEL_INTER_QUESTION_SPACING
            const containerClass = depth === 0 ? "mb-16" : "mb-8 mt-6";
            
            // Indentation for children
            const childContainerClass = depth >= 0 ? "ml-4 md:ml-8 border-l border-hairline pl-4" : "";

            return (
                <div id={`q-${question.id}`} className={cn("scroll-mt-24", containerClass)}>
                    {/* Question Body */}
                    <div className="flex flex-col gap-2">
                        {/* Identifier & Prompt */}
                        <div className="flex gap-3">
                            <div className="shrink-0 w-8 md:w-10 text-secondary font-medium select-none pt-0.5">
                                {question.id}
                            </div>
                            <div className="flex-1 min-w-0">
                                <MathContent content={question.question} className="text-lg text-primary" />
                                
                                {/* Solution Block (Answer + Details) */}
                                <SolutionBlock 
                                    question={question} 
                                    expandedMap={expandedMap} 
                                    toggleExpanded={toggleExpanded} 
                                />
                            </div>
                        </div>
                    </div>

                    {/* Children */}
                    {question.children && question.children.length > 0 && (
                        <div className={childContainerClass}>
                            {question.children.map((child, idx) => (
                                <QuestionNode 
                                    key={idx} 
                                    question={child} 
                                    depth={depth + 1} 
                                    expandedMap={expandedMap}
                                    toggleExpanded={toggleExpanded}
                                />
                            ))}
                        </div>
                    )}
                    
                    {/* Top Level Divider if needed (Optional per brief, using spacing primarily) */}
                    {depth === 0 && <div className="mt-16 border-b border-hairline opacity-50" />}
                </div>
            );
        };

        const PaperRegion = ({ paper, expandedMap, toggleExpanded }) => {
            const isSectioned = paper.sections && paper.sections.length > 0;

            if (isSectioned) {
                return (
                    <div className="pb-32">
                        {paper.sections.map((section, sIdx) => (
                            <div key={sIdx} className="mb-12">
                                {section.label && (
                                    <div className="mb-8 pb-2 border-b border-hairline text-xl font-semibold text-secondary">
                                        Section {section.label}
                                    </div>
                                )}
                                <div>
                                    {section.questions.map((q, qIdx) => (
                                        <QuestionNode 
                                            key={qIdx} 
                                            question={q} 
                                            expandedMap={expandedMap} 
                                            toggleExpanded={toggleExpanded} 
                                        />
                                    ))}
                                </div>
                            </div>
                        ))}
                    </div>
                );
            }

            return (
                <div className="pb-32">
                    {paper.questions.map((q, idx) => (
                        <QuestionNode 
                            key={idx} 
                            question={q} 
                            expandedMap={expandedMap} 
                            toggleExpanded={toggleExpanded} 
                        />
                    ))}
                </div>
            );
        };

        // --- APP SHELL ---

        const App = () => {
            const [payload, setPayload] = React.useState(null);
            const [loading, setLoading] = React.useState(true);
            const [error, setError] = React.useState(false);
            const [activePaperKey, setActivePaperKey] = React.useState(null);
            const [expandedMap, setExpandedMap] = React.useState({});
            const [mobileNavOpen, setMobileNavOpen] = React.useState(false);
            const [activeNavId, setActiveNavId] = React.useState(null);

            // Fetch Payload
            React.useEffect(() => {
                fetch(RTQ_PAPERS_PAYLOAD_PATH)
                    .then(res => {
                        if (!res.ok) throw new Error("Failed to load");
                        return res.json();
                    })
                    .then(data => {
                        setPayload(data);
                        if (data.papers && data.papers.length > 0) {
                            setActivePaperKey(data.papers[0].key);
                        }
                        setLoading(false);
                    })
                    .catch(err => {
                        console.error(err);
                        setError(true);
                        setLoading(false);
                    });
            }, []);

            // Set Initial Expanded State when paper changes
            const currentPaper = React.useMemo(() => {
                if (!payload) return null;
                return payload.papers.find(p => p.key === activePaperKey);
            }, [payload, activePaperKey]);

            React.useEffect(() => {
                if (currentPaper) {
                    const defaultExpanded = currentPaper.defaults?.expandedAll !== false;
                    const newMap = {};
                    
                    const traverse = (qs) => {
                        qs.forEach(q => {
                            if (q.solutionBlock?.solutionDetails) {
                                newMap[q.id] = defaultExpanded;
                            }
                            if (q.children) traverse(q.children);
                        });
                    };

                    if (currentPaper.sections) {
                        currentPaper.sections.forEach(s => traverse(s.questions));
                    } else if (currentPaper.questions) {
                        traverse(currentPaper.questions);
                    }
                    setExpandedMap(newMap);
                    window.scrollTo(0, 0);
                }
            }, [currentPaper]);

            const toggleExpanded = (id) => {
                setExpandedMap(prev => ({
                    ...prev,
                    [id]: !prev[id]
                }));
            };

            const jumpTo = (id) => {
                setMobileNavOpen(false);
                setActiveNavId(id);
                const el = document.getElementById(`q-${id}`);
                if (el) {
                    el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            };

            // Scroll Spy (Basic)
            React.useEffect(() => {
                const handleScroll = () => {
                   // A simplified spy could go here, but omitted to keep code clean/robust.
                   // activeNavId is primarily set by jumpTo for now.
                };
                window.addEventListener('scroll', handleScroll);
                return () => window.removeEventListener('scroll', handleScroll);
            }, []);

            if (loading) return <div className="p-8 text-secondary">Loading Paper System...</div>;
            if (error || !payload) return (
                <div className="doc-shell p-8 flex items-center justify-center min-h-screen">
                    <div className="text-xl font-bold text-red-600">PAPERS PAYLOAD MISSING</div>
                </div>
            );

            return (
                <div className="doc-shell bg-[var(--col-surface-frame)]">
                    {/* TOP CONTROLS */}
                    <header className="sticky top-0 z-30 bg-[var(--col-surface-frame)]/95 backdrop-blur-sm border-b border-hairline px-4 md:px-8 h-16 flex items-center justify-between">
                        <div className="flex items-center gap-4">
                            {/* Paper Selector */}
                            <select 
                                value={activePaperKey} 
                                onChange={(e) => setActivePaperKey(e.target.value)}
                                className="bg-transparent text-primary font-medium text-sm focus:outline-none focus:ring-2 focus:ring-[var(--col-focus-ring)] rounded px-2 py-1 border border-hairline"
                            >
                                {payload.papers.map(p => (
                                    <option key={p.key} value={p.key}>{p.label}</option>
                                ))}
                            </select>
                        </div>
                        
                        {/* Mobile Jump Trigger */}
                        <button 
                            className="md:hidden flex items-center gap-2 text-sm font-medium text-accent px-3 py-1.5 rounded hover:bg-wash transition-colors"
                            onClick={() => setMobileNavOpen(true)}
                        >
                            <Menu size={18} />
                            Jump to
                        </button>
                    </header>

                    {/* MAIN CONTENT AREA */}
                    <div className="flex flex-1 md:px-8 relative">
                        
                        {/* DESKTOP NAV RAIL */}
                        <aside className="hidden md:block w-64 shrink-0 sticky top-16 h-[calc(100vh-4rem)] overflow-y-auto nav-scroll-container py-8 pr-6 border-r border-transparent">
                            <NavigationList 
                                paper={currentPaper} 
                                activeId={activeNavId} 
                                onJump={jumpTo} 
                            />
                        </aside>

                        {/* PAPER CONTENT */}
                        <main className="flex-1 min-w-0 py-8 px-4 md:pl-12 md:pr-4">
                            <PaperRegion 
                                paper={currentPaper} 
                                expandedMap={expandedMap} 
                                toggleExpanded={toggleExpanded} 
                            />
                        </main>
                    </div>

                    {/* MOBILE NAV DRAWER */}
                    {mobileNavOpen && (
                        <div className="fixed inset-0 z-50 flex justify-end">
                            {/* Backdrop */}
                            <div 
                                className="absolute inset-0 drawer-overlay" 
                                onClick={() => setMobileNavOpen(false)}
                            />
                            
                            {/* Drawer Content */}
                            <div className="relative w-64 bg-[var(--col-surface-page)] h-full shadow-xl flex flex-col">
                                <div className="flex items-center justify-between p-4 border-b border-hairline">
                                    <span className="font-semibold text-primary">Jump to</span>
                                    <button 
                                        onClick={() => setMobileNavOpen(false)}
                                        className="p-1 text-secondary hover:text-primary"
                                    >
                                        <X size={20} />
                                    </button>
                                </div>
                                <div className="flex-1 overflow-y-auto p-4">
                                    <NavigationList 
                                        paper={currentPaper} 
                                        activeId={activeNavId} 
                                        onJump={jumpTo} 
                                    />
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
