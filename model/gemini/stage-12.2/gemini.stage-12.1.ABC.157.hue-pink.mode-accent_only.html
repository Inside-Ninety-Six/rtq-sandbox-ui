<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"ABC","indexWithinVariant":"157","totalWithinVariant":"320","hueFamily":"pink","intensityMode":"accent_only","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-09T17:22:24.027Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;ABC&quot;,&quot;indexWithinVariant&quot;:&quot;157&quot;,&quot;totalWithinVariant&quot;:&quot;320&quot;,&quot;hueFamily&quot;:&quot;pink&quot;,&quot;intensityMode&quot;:&quot;accent_only&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-09T17:22:24.027Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Solution Viewer</title>
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- KaTeX -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <!-- Markdown-it -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* CONSTANTS & COLORLAB SETUP */
        :root {
            /* HUE FAMILY: PINK (350) */
            /* MODE: ACCENT_ONLY */
            /* Defined via ADD-ON: ColorLab A/B/C */
            
            /* Surfaces */
            --color-page-bg: oklch(0.99 0.005 350);
            --color-frame-bg: oklch(1.0 0 0);
            --color-paper-bg: oklch(1.0 0 0);
            --color-wash: oklch(0.985 0.005 350); /* Very subtle wash for expanded solutions */
            
            /* Text - Neutral/Low Chroma */
            --color-text-primary: oklch(0.20 0.01 350);
            --color-text-secondary: oklch(0.45 0.01 350);
            --color-text-tertiary: oklch(0.60 0.01 350);

            /* Borders/Dividers */
            --color-border: oklch(0.92 0.01 350);

            /* Accent (Links, Focus, Active Nav) - Chroma [0.08 .. 0.14] */
            --color-accent: oklch(0.65 0.12 350);
            --color-accent-hover: oklch(0.55 0.14 350);
        }

        body {
            background-color: var(--color-page-bg);
            color: var(--color-text-primary);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        /* Focus Styles - Custom but restrained */
        :focus-visible {
            outline: 2px solid var(--color-accent);
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* Scrollbar Hiding for Nav */
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        /* KaTeX Containment Invariant */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding-bottom: 4px; /* Space for scrollbar if needed */
            -webkit-overflow-scrolling: touch;
        }
        
        /* Markdown Table Styling (Minimal) */
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 1rem 0;
            font-size: 0.95em;
        }
        th {
            font-weight: 600;
            text-align: left;
            border-bottom: 1px solid var(--color-border);
            padding: 0.5rem 0.25rem;
        }
        td {
            border-bottom: 1px solid var(--color-border);
            padding: 0.5rem 0.25rem;
            color: var(--color-text-secondary);
        }
        tr:last-child td {
            border-bottom: none;
        }

        /* Markdown List Styling */
        ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 0.5rem; }
        ol { list-style-type: decimal; padding-left: 1.5rem; margin-bottom: 0.5rem; }
        li { margin-bottom: 0.25rem; }
        p { margin-bottom: 0.75rem; }
        p:last-child { margin-bottom: 0; }
        
        /* Utility for Text selection */
        ::selection {
            background-color: var(--color-accent);
            color: white;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- App Root -->
    <div id="app-root" class="flex-grow flex flex-col relative">
        
        <!-- Top Controls Region -->
        <header class="w-full border-b border-[var(--color-border)] bg-[var(--color-frame-bg)] sticky top-0 z-30">
            <div class="max-w-7xl mx-auto px-4 md:px-8 h-16 flex items-center justify-between">
                <!-- Paper Selector -->
                <div class="flex items-center gap-3">
                    <label for="paper-select" class="text-sm font-medium text-[var(--color-text-secondary)] hidden sm:block">Paper</label>
                    <select id="paper-select" class="bg-transparent border border-[var(--color-border)] rounded px-3 py-1.5 text-sm focus:border-[var(--color-accent)] focus:ring-0 cursor-pointer min-w-[200px]">
                        <option disabled selected>Loading papers...</option>
                    </select>
                </div>

                <!-- Mobile Jump To Trigger -->
                <button id="mobile-jump-trigger" class="lg:hidden flex items-center gap-2 text-sm font-medium text-[var(--color-accent)] hover:text-[var(--color-accent-hover)] transition-colors px-2 py-1">
                    <span>Jump to</span>
                    <i data-lucide="menu" class="w-4 h-4"></i>
                </button>
            </div>
        </header>

        <!-- Document Frame Shell -->
        <main class="flex-grow max-w-7xl mx-auto w-full px-4 md:px-8 py-8 grid grid-cols-1 lg:grid-cols-[220px_1fr] gap-8 lg:gap-12 relative bg-[var(--color-frame-bg)]">
            
            <!-- Desktop Navigation Rail (Sticky) -->
            <aside class="hidden lg:block relative">
                <nav id="desktop-nav" class="sticky top-24 max-h-[calc(100vh-8rem)] overflow-y-auto scrollbar-hide pr-4">
                    <!-- Nav content injected here -->
                </nav>
            </aside>

            <!-- Paper Content Column -->
            <div id="paper-column" class="min-w-0 pb-32">
                <div id="paper-content" class="space-y-12">
                    <!-- Paper content injected here -->
                    <div class="text-[var(--color-text-secondary)] animate-pulse">Initializing...</div>
                </div>
            </div>

        </main>

        <!-- Mobile Navigation Drawer -->
        <div id="drawer-overlay" class="fixed inset-0 bg-black/20 z-40 hidden opacity-0 transition-opacity duration-200"></div>
        <div id="drawer-panel" class="fixed inset-y-0 right-0 w-80 bg-[var(--color-frame-bg)] z-50 transform translate-x-full transition-transform duration-300 shadow-xl flex flex-col">
            <div class="p-4 border-b border-[var(--color-border)] flex items-center justify-between">
                <span class="font-medium text-[var(--color-text-primary)]">Jump to Question</span>
                <button id="drawer-close" class="p-2 text-[var(--color-text-secondary)] hover:text-[var(--color-text-primary)]">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div id="drawer-nav-content" class="flex-1 overflow-y-auto p-4">
                <!-- Mobile Nav items injected here -->
            </div>
        </div>

    </div>

    <!-- Script -->
    <script>
        // --- STAGE 0: CONSTANTS ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        // const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json"; // Included per spec, unused in runtime logic

        // --- MARKDOWN SETUP (Stage 6 Add-on) ---
        const md = window.markdownit ? window.markdownit({
            html: true,
            linkify: true,
            breaks: false 
        }) : null;

        if (md) {
            md.inline.ruler.disable(['escape']);
        }

        // --- STATE ---
        let state = {
            papers: [],
            currentPaperKey: null,
            payloadLoaded: false
        };

        // --- DOM ELEMENTS ---
        const els = {
            paperSelect: document.getElementById('paper-select'),
            paperContent: document.getElementById('paper-content'),
            desktopNav: document.getElementById('desktop-nav'),
            drawerNavContent: document.getElementById('drawer-nav-content'),
            mobileJumpTrigger: document.getElementById('mobile-jump-trigger'),
            drawerOverlay: document.getElementById('drawer-overlay'),
            drawerPanel: document.getElementById('drawer-panel'),
            drawerClose: document.getElementById('drawer-close')
        };

        // --- INITIALIZATION ---
        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error('Fetch failed');
                const data = await response.json();
                
                state.papers = data.papers || [];
                state.payloadLoaded = true;

                renderPaperSelector();
                
                // Load first paper by default
                if (state.papers.length > 0) {
                    loadPaper(state.papers[0].key);
                } else {
                    renderError("No papers found in payload.");
                }

            } catch (err) {
                console.error(err);
                renderError("PAPERS PAYLOAD MISSING");
            }
        }

        // --- RENDERING CORE ---
        
        function renderError(msg) {
            els.paperContent.innerHTML = `<div class="p-8 text-center text-[var(--color-text-secondary)] font-medium border border-[var(--color-border)] border-dashed rounded">${msg}</div>`;
            els.paperSelect.innerHTML = `<option disabled>Unavailable</option>`;
            els.paperSelect.disabled = true;
        }

        function renderPaperSelector() {
            els.paperSelect.innerHTML = state.papers.map(p => 
                `<option value="${p.key}">${p.label}</option>`
            ).join('');
            els.paperSelect.disabled = false;
        }

        function loadPaper(key) {
            state.currentPaperKey = key;
            const paper = state.papers.find(p => p.key === key);
            if (!paper) return;

            // Sync selector
            els.paperSelect.value = key;

            // Clear previous content
            els.paperContent.innerHTML = '';
            els.desktopNav.innerHTML = '';
            els.drawerNavContent.innerHTML = '';

            // Build Navigation Data
            const navItems = buildNavTree(paper);
            
            // Render Nav
            renderNavigation(navItems);

            // Render Content
            if (paper.sections) {
                renderSectionedPaper(paper);
            } else if (paper.questions) {
                renderFlatPaper(paper);
            }

            // Init Lucide icons
            lucide.createIcons();

            // Render Math
            renderMathInElement(document.body, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false}
                ],
                throwOnError: false,
                trust: true
            });
        }

        // --- NAVIGATION LOGIC ---

        function buildNavTree(paper) {
            let items = [];
            if (paper.sections) {
                paper.sections.forEach(section => {
                    // Section Header
                    if (section.label && section.label.trim() !== "") {
                        items.push({ type: 'section', label: section.label });
                    }
                    // Questions
                    section.questions.forEach(q => {
                        traverseQuestionForNav(q, items);
                    });
                });
            } else {
                paper.questions.forEach(q => {
                    traverseQuestionForNav(q, items);
                });
            }
            return items;
        }

        function traverseQuestionForNav(node, list) {
            list.push({ type: 'question', id: node.id });
            if (node.children) {
                node.children.forEach(child => traverseQuestionForNav(child, list));
            }
        }

        function renderNavigation(items) {
            const createNavHTML = (isDrawer) => {
                let html = '<div class="flex flex-col gap-1 text-sm">';
                items.forEach(item => {
                    if (item.type === 'section') {
                        html += `
                            <div class="mt-4 mb-2 first:mt-0 font-semibold text-[var(--color-text-secondary)] text-xs uppercase tracking-wider select-none px-3">
                                ${item.label}
                            </div>
                        `;
                    } else {
                        // Hierarchy via type scale only, flat list
                        const isSub = item.id.includes('(') || item.id.length > 3;
                        const classes = isSub 
                            ? "text-[var(--color-text-secondary)] font-normal text-xs py-1" 
                            : "text-[var(--color-text-primary)] font-medium text-sm py-1.5";
                        
                        html += `
                            <a href="#q-${item.id}" 
                               class="block px-3 rounded hover:bg-[var(--color-border)]/50 transition-colors ${classes} nav-link"
                               data-target="q-${item.id}"
                               onclick="handleNavClick(event, 'q-${item.id}')">
                                ${item.id}
                            </a>
                        `;
                    }
                });
                html += '</div>';
                return html;
            };

            els.desktopNav.innerHTML = createNavHTML(false);
            els.drawerNavContent.innerHTML = createNavHTML(true);
        }

        window.handleNavClick = (e, targetId) => {
            e.preventDefault();
            const el = document.getElementById(targetId);
            if (el) {
                const offset = 100;
                const bodyRect = document.body.getBoundingClientRect().top;
                const elementRect = el.getBoundingClientRect().top;
                const elementPosition = elementRect - bodyRect;
                const offsetPosition = elementPosition - offset;

                window.scrollTo({
                    top: offsetPosition,
                    behavior: "smooth"
                });

                // Simple active state update
                document.querySelectorAll('.nav-link').forEach(a => {
                    a.style.fontWeight = '';
                    a.style.color = '';
                    if(a.getAttribute('href') === `#${targetId}`) {
                        a.style.fontWeight = 'bold';
                        a.style.color = 'var(--color-accent)';
                    }
                });

                closeDrawer();
            }
        };

        // --- CONTENT RENDERING LOGIC ---

        function renderFlatPaper(paper) {
            const list = document.createElement('div');
            list.className = 'flex flex-col gap-16'; // Stage 5: Top level separation
            paper.questions.forEach(q => {
                list.appendChild(renderQuestionNode(q, paper.defaults, 0));
            });
            els.paperContent.appendChild(list);
        }

        function renderSectionedPaper(paper) {
            const container = document.createElement('div');
            container.className = 'flex flex-col gap-16';

            paper.sections.forEach(section => {
                const sectionBlock = document.createElement('div');
                sectionBlock.className = 'flex flex-col gap-12';
                
                if (section.label && section.label.trim()) {
                    const header = document.createElement('div');
                    header.className = 'flex items-center gap-4 pb-4 border-b border-[var(--color-border)]';
                    header.innerHTML = `<span class="text-xl font-semibold text-[var(--color-text-primary)]">${section.label}</span>`;
                    sectionBlock.appendChild(header);
                }

                const qList = document.createElement('div');
                qList.className = 'flex flex-col gap-16';
                section.questions.forEach(q => {
                    qList.appendChild(renderQuestionNode(q, paper.defaults, 0));
                });
                sectionBlock.appendChild(qList);
                container.appendChild(sectionBlock);
            });
            els.paperContent.appendChild(container);
        }

        function renderQuestionNode(node, defaults, depth) {
            const isTopLevel = depth === 0;
            const wrapper = document.createElement('div');
            wrapper.id = `q-${node.id}`;
            // Stage 3: Sub-questions indented, Top-level not.
            wrapper.className = `flex flex-col w-full ${isTopLevel ? '' : 'mt-6 ml-0 md:ml-4 border-l-2 border-transparent hover:border-[var(--color-border)] pl-4 transition-colors'}`;

            // Question Body
            const qBody = document.createElement('div');
            qBody.className = 'flex flex-col gap-2 mb-4';
            
            // Identifier
            const idEl = document.createElement('div');
            idEl.className = 'text-sm font-semibold text-[var(--color-text-tertiary)]';
            idEl.textContent = node.id;
            qBody.appendChild(idEl);

            // Prompt
            const promptEl = document.createElement('div');
            promptEl.className = 'text-base md:text-lg text-[var(--color-text-primary)] leading-relaxed';
            promptEl.innerHTML = md ? md.render(node.question || '') : (node.question || '');
            qBody.appendChild(promptEl);

            wrapper.appendChild(qBody);

            // Solution Block
            if (node.solutionBlock) {
                const solBlock = document.createElement('div');
                solBlock.className = 'flex flex-col gap-4';

                // Answer (if present)
                if (node.solutionBlock.answer) {
                    const ansWrapper = document.createElement('div');
                    ansWrapper.className = 'flex flex-col gap-1';
                    ansWrapper.innerHTML = `
                        <span class="text-xs font-bold text-[var(--color-accent)] uppercase tracking-wide">Answer</span>
                        <div class="text-[var(--color-text-primary)] font-medium">
                            ${md ? md.render(node.solutionBlock.answer) : node.solutionBlock.answer}
                        </div>
                    `;
                    solBlock.appendChild(ansWrapper);
                }

                // Solution Details (if present)
                if (node.solutionBlock.solutionDetails) {
                    const details = node.solutionBlock.solutionDetails;
                    const isExpanded = defaults && defaults.expandedAll !== false; 
                    
                    const containerId = `details-${node.id.replace(/[^a-zA-Z0-9]/g, '-')}`;
                    
                    const toggleBtn = document.createElement('button');
                    toggleBtn.className = 'group flex items-center gap-2 text-sm font-medium text-[var(--color-accent)] hover:text-[var(--color-accent-hover)] transition-colors w-fit mt-1 focus:outline-none';
                    toggleBtn.setAttribute('aria-expanded', isExpanded);
                    toggleBtn.setAttribute('aria-controls', containerId);
                    
                    const updateToggleText = (expanded) => {
                        toggleBtn.innerHTML = `
                            <span>${expanded ? 'Hide working' : 'Show working'}</span>
                            <i data-lucide="chevron-down" class="w-4 h-4 transition-transform duration-200 ${expanded ? 'rotate-180' : ''}"></i>
                        `;
                        lucide.createIcons({ root: toggleBtn });
                    };
                    updateToggleText(isExpanded);

                    const detailsRegion = document.createElement('div');
                    detailsRegion.id = containerId;
                    detailsRegion.className = `flex flex-col gap-6 mt-3 pl-4 border-l border-[var(--color-border)] bg-[var(--color-wash)]/50 rounded-r-sm py-4 pr-4 transition-all duration-300 origin-top overflow-hidden ${isExpanded ? '' : 'hidden'}`;
                    
                    // Render sub-blocks
                    // 1. Keep in mind
                    if (details.keepInMind) {
                        const kim = document.createElement('div');
                        kim.className = 'text-sm';
                        kim.innerHTML = `
                            <div class="font-bold text-[var(--color-text-primary)] mb-1 flex items-center gap-2">
                                <i data-lucide="lightbulb" class="w-3 h-3 text-[var(--color-text-secondary)]"></i>
                                Keep in mind
                            </div>
                            <div class="text-[var(--color-text-secondary)] space-y-1">
                                ${md ? md.render(details.keepInMind) : details.keepInMind}
                            </div>
                        `;
                        detailsRegion.appendChild(kim);
                    }

                    // 2. Formulas Used
                    if (details.formulasUsed) {
                        const form = document.createElement('div');
                        form.className = 'text-sm';
                        form.innerHTML = `
                            <div class="font-bold text-[var(--color-text-primary)] mb-1">Formulas used</div>
                            <div class="text-[var(--color-text-secondary)] font-mono text-xs bg-white/50 p-2 rounded border border-[var(--color-border)]">
                                ${md ? md.render(details.formulasUsed) : details.formulasUsed}
                            </div>
                        `;
                        detailsRegion.appendChild(form);
                    }

                    // 3. Working
                    if (details.working) {
                        const work = document.createElement('div');
                        work.className = 'text-sm';
                        work.innerHTML = `
                            <div class="font-bold text-[var(--color-text-primary)] mb-2">Working</div>
                            <div class="text-[var(--color-text-secondary)] space-y-4 leading-relaxed">
                                ${md ? md.render(details.working) : details.working}
                            </div>
                        `;
                        detailsRegion.appendChild(work);
                    }

                    // 4. Alternative Working
                    if (details.alternativeWorking && Array.isArray(details.alternativeWorking)) {
                        details.alternativeWorking.forEach((alt, idx) => {
                             const altEl = document.createElement('div');
                            altEl.className = 'text-sm pt-4 border-t border-[var(--color-border)] border-dashed';
                            altEl.innerHTML = `
                                <div class="font-bold text-[var(--color-text-primary)] mb-2">Alternative working ${details.alternativeWorking.length > 1 ? idx + 1 : ''}</div>
                                <div class="text-[var(--color-text-secondary)] space-y-4 leading-relaxed">
                                    ${md ? md.render(alt) : alt}
                                </div>
                            `;
                            detailsRegion.appendChild(altEl);
                        });
                    }

                    toggleBtn.onclick = () => {
                        const expanded = toggleBtn.getAttribute('aria-expanded') === 'true';
                        toggleBtn.setAttribute('aria-expanded', !expanded);
                        updateToggleText(!expanded);
                        if (!expanded) {
                            detailsRegion.classList.remove('hidden');
                        } else {
                            detailsRegion.classList.add('hidden');
                        }
                    };

                    solBlock.appendChild(toggleBtn);
                    solBlock.appendChild(detailsRegion);
                }

                wrapper.appendChild(solBlock);
            }

            // Recursive Children
            if (node.children && node.children.length > 0) {
                const childContainer = document.createElement('div');
                childContainer.className = 'flex flex-col gap-8 mt-6'; 
                node.children.forEach(child => {
                    childContainer.appendChild(renderQuestionNode(child, defaults, depth + 1));
                });
                wrapper.appendChild(childContainer);
            }

            return wrapper;
        }

        // --- EVENT HANDLERS ---
        
        els.paperSelect.addEventListener('change', (e) => {
            loadPaper(e.target.value);
            window.scrollTo({ top: 0, behavior: 'auto' });
        });

        // Mobile Drawer
        function openDrawer() {
            els.drawerOverlay.classList.remove('hidden');
            setTimeout(() => els.drawerOverlay.classList.remove('opacity-0'), 10);
            els.drawerPanel.classList.remove('translate-x-full');
            document.body.style.overflow = 'hidden';
        }

        function closeDrawer() {
            els.drawerOverlay.classList.add('opacity-0');
            els.drawerPanel.classList.add('translate-x-full');
            setTimeout(() => els.drawerOverlay.classList.add('hidden'), 300);
            document.body.style.overflow = '';
        }

        els.mobileJumpTrigger.addEventListener('click', openDrawer);
        els.drawerClose.addEventListener('click', closeDrawer);
        els.drawerOverlay.addEventListener('click', closeDrawer);

        // --- START ---
        init();

    </script>
</body>
</html>
