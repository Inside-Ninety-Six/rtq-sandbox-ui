<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"ABC","indexWithinVariant":"50","totalWithinVariant":"320","hueFamily":"amber","intensityMode":"tinted_neutrals","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-09T12:14:19.599Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;ABC&quot;,&quot;indexWithinVariant&quot;:&quot;50&quot;,&quot;totalWithinVariant&quot;:&quot;320&quot;,&quot;hueFamily&quot;:&quot;amber&quot;,&quot;intensityMode&quot;:&quot;tinted_neutrals&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-09T12:14:19.599Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Markdown-it -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <!-- KaTeX -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <style>
        /* 
         * COLORLAB CONFIGURATION 
         * Add-on B: Amber Hue (~85 deg OKLCH)
         * Add-on C: Tinted Neutrals Intensity (Light Mode)
         */
        :root {
            /* Palette Definition (OKLCH) */
            --hue-amber: 85;

            /* Surfaces: C ~0.015-0.035 */
            --color-page-bg: oklch(0.97 0.02 var(--hue-amber));
            --color-frame-bg: oklch(0.95 0.025 var(--hue-amber));
            --color-paper-bg: oklch(0.99 0.015 var(--hue-amber));
            
            /* Washes: C ~0.025-0.045 */
            --color-wash-bg: oklch(0.96 0.035 var(--hue-amber));
            --color-wash-sub: oklch(0.95 0.04 var(--hue-amber));

            /* Text: Low Chroma */
            --color-text-primary: oklch(0.20 0.01 var(--hue-amber));
            --color-text-secondary: oklch(0.45 0.015 var(--hue-amber));
            --color-text-tertiary: oklch(0.60 0.02 var(--hue-amber));

            /* Accent: C ~0.10-0.16 */
            --color-accent: oklch(0.65 0.14 var(--hue-amber));
            --color-accent-subtle: oklch(0.92 0.06 var(--hue-amber));

            /* Hairlines: C <= 0.02 */
            --color-hairline: oklch(0.90 0.02 var(--hue-amber));
            
            /* Focus */
            --color-focus: var(--color-accent);
        }

        body {
            background-color: var(--color-page-bg);
            color: var(--color-text-primary);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        /* Scrollbar Hiding (Add-on) */
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        /* KaTeX Overrides & Containment */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            padding-bottom: 4px; /* Space for scrollbar if needed */
            max-width: 100%;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Inline math background invariant */
        .katex {
            background-color: transparent !important;
        }

        /* Markdown Content Styling */
        .markdown-body p {
            margin-bottom: 0.75em;
            line-height: 1.6;
        }
        .markdown-body p:last-child {
            margin-bottom: 0;
        }
        .markdown-body ul {
            list-style-type: disc;
            padding-left: 1.5em;
            margin-bottom: 0.75em;
        }
        .markdown-body ol {
            list-style-type: decimal;
            padding-left: 1.5em;
            margin-bottom: 0.75em;
        }
        .markdown-body table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1em;
            font-size: 0.95em;
        }
        .markdown-body th, .markdown-body td {
            border: 1px solid var(--color-hairline);
            padding: 0.5em;
            text-align: left;
        }
        .markdown-body th {
            font-weight: 600;
        }

        /* Interaction Continuity */
        .disclosure-content {
            transition: opacity 0.2s ease-out, transform 0.2s ease-out;
        }
    </style>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        page: 'var(--color-page-bg)',
                        frame: 'var(--color-frame-bg)',
                        paper: 'var(--color-paper-bg)',
                        wash: 'var(--color-wash-bg)',
                        washsub: 'var(--color-wash-sub)',
                        primary: 'var(--color-text-primary)',
                        secondary: 'var(--color-text-secondary)',
                        tertiary: 'var(--color-text-tertiary)',
                        accent: 'var(--color-accent)',
                        accentsub: 'var(--color-accent-subtle)',
                        hairline: 'var(--color-hairline)',
                    }
                }
            }
        }
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- STAGE 0: CONSTANTS ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // --- MARKDOWN SETUP (STAGE 6 ADD-ON) ---
        // html: true (SVG passthrough), breaks: false (prevent <br> in math), disable escape (preserve TeX backslashes)
        const md = window.markdownit 
            ? window.markdownit({
                html: true,
                linkify: true,
                breaks: false, 
            })
            : null;

        if (md) {
            md.inline.ruler.disable(['escape']);
        }

        // --- ICONS ---
        const { ChevronDown, ChevronRight, Menu, X, Info } = lucide;

        // --- UTILS ---
        
        // Helper to render Markdown content safely
        const MarkdownContent = ({ content, className = "" }) => {
            if (!content) return null;
            
            const renderHTML = () => {
                if (!md) return content;
                return md.render(content);
            };

            const containerRef = React.useRef(null);

            React.useEffect(() => {
                if (containerRef.current && window.renderMathInElement) {
                    window.renderMathInElement(containerRef.current, {
                        delimiters: [
                            {left: '$$', right: '$$', display: true},
                            {left: '$', right: '$', display: false}
                        ],
                        throwOnError: false
                    });
                }
            }, [content]);

            return (
                <div 
                    ref={containerRef}
                    className={`markdown-body ${className}`}
                    dangerouslySetInnerHTML={{ __html: renderHTML() }}
                />
            );
        };

        // --- COMPONENTS ---

        // 5.9.2 Keep in mind
        const KeepInMind = ({ content }) => (
            <div className="mb-4">
                <div className="flex items-center gap-2 mb-1 text-secondary">
                    <Info size={14} className="text-secondary" />
                    <span className="text-xs font-bold uppercase tracking-wide">Keep in mind</span>
                </div>
                <div className="text-secondary text-sm">
                    <MarkdownContent content={content} />
                </div>
            </div>
        );

        // 5.9.3 Formulas used
        const FormulasUsed = ({ content }) => (
            <div className="mb-4 pt-2">
                <div className="text-xs font-bold uppercase tracking-wide text-tertiary mb-1">Formulas used</div>
                <div className="text-secondary text-sm font-mono text-xs">
                    <MarkdownContent content={content} />
                </div>
            </div>
        );

        // 5.8 Working & Alternative Working
        const WorkingBlock = ({ label, content, isAlt = false }) => (
            <div className={`mt-4 ${isAlt ? 'pt-4 border-t border-hairline' : ''}`}>
                <div className="text-xs font-bold uppercase tracking-wide text-secondary mb-2">
                    {label}
                </div>
                <div className="text-primary text-base">
                    <MarkdownContent content={content} />
                </div>
            </div>
        );

        // Solution Details Region
        const SolutionDetails = ({ details }) => {
            const { keepInMind, formulasUsed, working, alternativeWorking } = details;
            
            return (
                <div className="mt-3 pt-3 px-3 pb-4 bg-wash rounded-sm text-sm border-l-2 border-transparent">
                    {/* Render order per 5.6.4 */}
                    {keepInMind && <KeepInMind content={keepInMind} />}
                    
                    {(keepInMind && formulasUsed) && <div className="h-px bg-hairline my-3 w-16 opacity-50"></div>}
                    
                    {formulasUsed && <FormulasUsed content={formulasUsed} />}
                    
                    {(formulasUsed && working) && <div className="h-px bg-hairline my-3 w-16 opacity-50"></div>}
                    
                    {working && <WorkingBlock label="Working" content={working} />}
                    
                    {alternativeWorking && Array.isArray(alternativeWorking) && alternativeWorking.map((alt, idx) => (
                        <WorkingBlock key={idx} label="Alternative working" content={alt} isAlt={true} />
                    ))}
                </div>
            );
        };

        // Solution Block (Answer + Toggle + Details)
        const SolutionBlock = ({ data, expanded, onToggle }) => {
            if (!data) return null;
            const { answer, solutionDetails } = data;
            const hasDetails = !!solutionDetails;

            return (
                <div className="mt-4">
                    {/* Answer (Stage 5.6.3) */}
                    {answer && (
                        <div className="mb-3">
                            <span className="text-xs font-bold text-secondary uppercase tracking-wide block mb-1">Answer</span>
                            <div className="text-primary font-medium">
                                <MarkdownContent content={answer} />
                            </div>
                        </div>
                    )}

                    {/* Disclosure Control (Stage 5.7) */}
                    {hasDetails && (
                        <div>
                            <button 
                                onClick={onToggle}
                                className="group flex items-center gap-1.5 text-sm text-accent font-medium hover:text-primary transition-colors focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-1 rounded-sm py-1 pr-2"
                                aria-expanded={expanded}
                            >
                                <span className="text-xs">{expanded ? 'Hide working' : 'Show working'}</span>
                                {expanded ? <ChevronDown size={14} /> : <ChevronRight size={14} />}
                            </button>

                            {/* Expanded Region */}
                            {expanded && <SolutionDetails details={solutionDetails} />}
                        </div>
                    )}
                </div>
            );
        };

        // Question Node
        const QuestionNode = ({ node, depth = 0, paperDefaults, expandedState, setExpandedState, parentId }) => {
            const { id, question, solutionBlock, children } = node;
            const uniqueKey = parentId ? `${parentId}-${id}` : id;
            
            // Determine expansion state
            // Default comes from paper.defaults.expandedAll, user interaction overrides
            const isExpanded = expandedState[uniqueKey] !== undefined 
                ? expandedState[uniqueKey] 
                : (paperDefaults?.expandedAll ?? true);

            const handleToggle = () => {
                setExpandedState(prev => ({
                    ...prev,
                    [uniqueKey]: !isExpanded
                }));
            };

            const hasSolutionBlock = !!solutionBlock;

            // Spacing based on depth (Stage 5.1 / 1.2)
            const nodeClass = depth === 0 ? "mb-16" : "mb-8 mt-6"; 

            return (
                <div id={`q-${id}`} className={`scroll-mt-24 ${nodeClass}`}>
                    {/* Question Body */}
                    <div className="flex gap-4">
                        <div className="flex-shrink-0 w-8 text-secondary font-medium text-sm pt-0.5 select-none text-right">
                            {id}
                        </div>
                        <div className="flex-grow min-w-0">
                            {/* Question Prompt */}
                            <div className="text-primary text-lg leading-relaxed mb-2">
                                <MarkdownContent content={question} />
                            </div>

                            {/* Solution Block */}
                            {hasSolutionBlock && (
                                <SolutionBlock 
                                    data={solutionBlock} 
                                    expanded={isExpanded} 
                                    onToggle={handleToggle} 
                                />
                            )}
                        </div>
                    </div>

                    {/* Children */}
                    {children && children.length > 0 && (
                        <div className="ml-8 sm:ml-12 border-l border-transparent"> 
                            {children.map((child, idx) => (
                                <QuestionNode 
                                    key={idx} 
                                    node={child} 
                                    depth={depth + 1} 
                                    paperDefaults={paperDefaults}
                                    expandedState={expandedState}
                                    setExpandedState={setExpandedState}
                                    parentId={uniqueKey}
                                />
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        // Section Handling
        const SectionBlock = ({ section, paperDefaults, expandedState, setExpandedState }) => {
            return (
                <div className="mb-12">
                    {section.label && section.label.trim() !== "" && (
                        <div className="mb-8 pb-2 border-b border-hairline">
                            <h2 className="text-lg font-medium text-secondary">{section.label}</h2>
                        </div>
                    )}
                    <div>
                        {section.questions.map((q, idx) => (
                            <QuestionNode 
                                key={idx} 
                                node={q} 
                                depth={0}
                                paperDefaults={paperDefaults}
                                expandedState={expandedState}
                                setExpandedState={setExpandedState}
                            />
                        ))}
                    </div>
                </div>
            );
        };

        // Navigation Item
        const NavItem = ({ id, isActive, depth = 0, onClick }) => {
            // Stage 5.4.5: Flat list, hierarchy via type scale/weight only
            // Depth 0: Normal
            // Depth > 0: Slightly smaller/lighter
            
            const baseClasses = "block w-full text-left py-1 px-2 rounded-sm transition-colors text-sm font-medium focus:outline-none focus:ring-2 focus:ring-accent";
            const activeClasses = isActive ? "text-accent font-bold bg-wash" : "text-secondary hover:text-primary hover:bg-washsub";
            const depthScale = depth > 0 ? "text-xs" : "";

            return (
                <button 
                    onClick={onClick}
                    className={`${baseClasses} ${activeClasses} ${depthScale}`}
                    aria-current={isActive ? "true" : undefined}
                >
                    {id}
                </button>
            );
        };

        // Navigation List Generator (Recursive flattened list for rendering)
        const generateNavItems = (nodes, currentId, onNavigate, depth = 0) => {
            return nodes.map((node, idx) => {
                const isActive = currentId === node.id; // Simple ID matching for prototype
                return (
                    <React.Fragment key={node.id}>
                        <NavItem 
                            id={node.id} 
                            isActive={isActive} 
                            depth={depth} 
                            onClick={() => onNavigate(node.id)} 
                        />
                        {node.children && generateNavItems(node.children, currentId, onNavigate, depth + 1)}
                    </React.Fragment>
                );
            });
        };

        // Navigation Rail/Drawer Content
        const NavigationContent = ({ paper, currentVisibleId, onNavigate }) => {
            if (!paper) return null;

            const isSectioned = paper.sections && paper.sections.length > 0;

            return (
                <nav className="space-y-6 pb-12" aria-label="Question navigation">
                    {isSectioned ? (
                        paper.sections.map((section, sIdx) => (
                            <div key={sIdx}>
                                {section.label && section.label.trim() !== "" && (
                                    <div className="px-2 mb-2 text-xs font-bold text-tertiary uppercase tracking-wider select-none">
                                        {section.label}
                                    </div>
                                )}
                                <div className="space-y-0.5">
                                    {generateNavItems(section.questions, currentVisibleId, onNavigate)}
                                </div>
                            </div>
                        ))
                    ) : (
                        <div className="space-y-0.5">
                            {generateNavItems(paper.questions || [], currentVisibleId, onNavigate)}
                        </div>
                    )}
                </nav>
            );
        };

        // Main App
        const App = () => {
            const [payload, setPayload] = React.useState(null);
            const [loading, setLoading] = React.useState(true);
            const [error, setError] = React.useState(false);
            const [activePaperKey, setActivePaperKey] = React.useState(null);
            const [expandedState, setExpandedState] = React.useState({});
            const [mobileNavOpen, setMobileNavOpen] = React.useState(false);
            const [activeQuestionId, setActiveQuestionId] = React.useState(null);

            // Fetch Payload
            React.useEffect(() => {
                fetch(RTQ_PAPERS_PAYLOAD_PATH)
                    .then(res => {
                        if (!res.ok) throw new Error("Fetch failed");
                        return res.json();
                    })
                    .then(data => {
                        setPayload(data);
                        if (data.papers && data.papers.length > 0) {
                            setActivePaperKey(data.papers[0].key);
                        }
                        setLoading(false);
                    })
                    .catch(err => {
                        console.error(err);
                        setError(true);
                        setLoading(false);
                    });
            }, []);

            // Scroll Handling for Active ID
            React.useEffect(() => {
                const handleScroll = () => {
                    // Simple logic to find top-most visible question
                    // In a real app, IntersectionObserver is better, but this suffices for prototype
                    const questions = document.querySelectorAll('[id^="q-"]');
                    let current = null;
                    for (let q of questions) {
                        const rect = q.getBoundingClientRect();
                        if (rect.top >= 0 && rect.top < window.innerHeight / 2) {
                            current = q.id.replace('q-', '');
                            break;
                        }
                    }
                    if (current) setActiveQuestionId(current);
                };

                window.addEventListener('scroll', handleScroll, { passive: true });
                return () => window.removeEventListener('scroll', handleScroll);
            }, [activePaperKey]);

            // Handlers
            const handlePaperChange = (e) => {
                setActivePaperKey(e.target.value);
                setExpandedState({}); // Reset expansion overrides on paper switch
                setMobileNavOpen(false);
                window.scrollTo(0, 0);
            };

            const handleNavigate = (id) => {
                setMobileNavOpen(false);
                const el = document.getElementById(`q-${id}`);
                if (el) {
                    el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    setActiveQuestionId(id);
                }
            };

            // Render Error
            if (error) {
                return (
                    <div className="flex items-center justify-center min-h-screen text-secondary font-medium">
                        PAPERS PAYLOAD MISSING
                    </div>
                );
            }

            // Render Loading
            if (loading || !payload) return null;

            const activePaper = payload.papers.find(p => p.key === activePaperKey);
            if (!activePaper) return <div>Paper not found</div>;

            return (
                <div className="min-h-screen flex flex-col">
                    {/* Top Controls Surface (Stage 3) */}
                    <header className="sticky top-0 z-40 bg-frame border-b border-hairline/50 backdrop-blur-sm bg-opacity-95">
                        <div className="max-w-7xl mx-auto px-4 md:px-8 h-14 flex items-center justify-between">
                            
                            {/* Paper Selector */}
                            <div className="flex items-center gap-3">
                                <span className="text-xs font-bold text-secondary uppercase tracking-wider hidden sm:inline-block">Paper</span>
                                <select 
                                    className="bg-page border border-hairline rounded-sm px-3 py-1 text-sm text-primary focus:ring-2 focus:ring-accent outline-none"
                                    value={activePaperKey}
                                    onChange={handlePaperChange}
                                >
                                    {payload.papers.map(p => (
                                        <option key={p.key} value={p.key}>{p.label}</option>
                                    ))}
                                </select>
                            </div>

                            {/* Mobile Jump To Trigger */}
                            <button 
                                className="md:hidden flex items-center gap-2 text-sm font-medium text-accent px-3 py-1.5 rounded-sm hover:bg-wash transition-colors"
                                onClick={() => setMobileNavOpen(true)}
                            >
                                <span className="text-xs font-bold uppercase tracking-wide">Jump to</span>
                                <Menu size={16} />
                            </button>
                        </div>
                    </header>

                    {/* DocumentFrameShell (Stage 3) */}
                    <div className="flex-grow bg-frame">
                        <div className="max-w-7xl mx-auto md:grid md:grid-cols-[240px_1fr] md:gap-8 lg:gap-12 min-h-[calc(100vh-3.5rem)]">
                            
                            {/* Desktop Nav Rail (Sticky) */}
                            <aside className="hidden md:block sticky top-14 h-[calc(100vh-3.5rem)] overflow-y-auto scrollbar-hide py-8 pl-4 pr-2">
                                <NavigationContent 
                                    paper={activePaper} 
                                    currentVisibleId={activeQuestionId} 
                                    onNavigate={handleNavigate} 
                                />
                            </aside>

                            {/* Paper Content Column */}
                            <main className="bg-paper min-h-full px-4 py-8 md:px-12 md:py-12 border-x border-hairline/30 shadow-sm shadow-black/5">
                                {/* Sectioned or Flat Rendering */}
                                {activePaper.sections ? (
                                    activePaper.sections.map((section, idx) => (
                                        <SectionBlock 
                                            key={idx} 
                                            section={section} 
                                            paperDefaults={activePaper.defaults}
                                            expandedState={expandedState}
                                            setExpandedState={setExpandedState}
                                        />
                                    ))
                                ) : (
                                    activePaper.questions && activePaper.questions.map((q, idx) => (
                                        <QuestionNode 
                                            key={idx} 
                                            node={q} 
                                            depth={0}
                                            paperDefaults={activePaper.defaults}
                                            expandedState={expandedState}
                                            setExpandedState={setExpandedState}
                                        />
                                    ))
                                )}
                            </main>

                        </div>
                    </div>

                    {/* Mobile Drawer (Stage 3 + 6.0.6) */}
                    {mobileNavOpen && (
                        <div className="fixed inset-0 z-50 flex justify-end md:hidden" role="dialog" aria-modal="true">
                            {/* Scrim */}
                            <div 
                                className="absolute inset-0 bg-black/20 backdrop-blur-[1px]" 
                                onClick={() => setMobileNavOpen(false)}
                            ></div>
                            
                            {/* Drawer Surface */}
                            <div className="relative w-64 bg-page h-full shadow-xl flex flex-col">
                                <div className="flex items-center justify-between p-4 border-b border-hairline">
                                    <span className="text-sm font-bold text-secondary uppercase tracking-wide">Jump to</span>
                                    <button 
                                        onClick={() => setMobileNavOpen(false)}
                                        className="text-secondary hover:text-primary p-1"
                                    >
                                        <X size={20} />
                                    </button>
                                </div>
                                <div className="flex-grow overflow-y-auto p-4">
                                    <NavigationContent 
                                        paper={activePaper} 
                                        currentVisibleId={activeQuestionId} 
                                        onNavigate={handleNavigate} 
                                    />
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById("root"));
        root.render(<App />);
    </script>
</body>
</html>
