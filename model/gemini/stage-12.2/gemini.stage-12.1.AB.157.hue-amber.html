<!DOCTYPE html>
<html lang="en" class="antialiased">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AB","indexWithinVariant":"157","totalWithinVariant":"200","hueFamily":"amber","intensityMode":"","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-08T20:19:45.495Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AB&quot;,&quot;indexWithinVariant&quot;:&quot;157&quot;,&quot;totalWithinVariant&quot;:&quot;200&quot;,&quot;hueFamily&quot;:&quot;amber&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-08T20:19:45.495Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Viewer</title>
    <!-- Tailwind CSS (via CDN for prototype) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // RTQ_COLORLAB_FORCE_HUE_FAMILY = "amber"
                        primary: tailwind.colors.amber, 
                        gray: tailwind.colors.stone,    // Warm neutral base
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', '-apple-system', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    
    <!-- KaTeX CSS & JS (No integrity attributes per Stage 6 baseline) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    
    <!-- Markdown-it -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>
    
    <style>
        /* === STAGE 3/5/6 CSS INVARIANTS === */
        
        body { 
            /* Stage 5.3.1: Soft-warm neutral base */
            @apply bg-gray-50 text-gray-900; 
        }

        /* Nav Scrollbar Hiding (Stage 6 Add-on) */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* KaTeX Containment Invariant (Stage 3/6) */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 4px;
            margin-top: 1em;
            margin-bottom: 1em;
        }
        /* Inline math background invariant (Stage 5.8.4) */
        .katex { background-color: transparent !important; }
        
        /* Markdown Content Reset & Styling */
        .prose p { @apply mb-3 last:mb-0 leading-relaxed; }
        .prose ul { @apply list-disc pl-5 mb-3 space-y-1; }
        .prose ol { @apply list-decimal pl-5 mb-3 space-y-1; }
        
        /* Tables (Stage 5.8.5: Minimal, light gridlines) */
        .prose table { @apply w-full border-collapse border border-gray-200 mb-4 text-sm; }
        .prose th, .prose td { @apply border border-gray-200 px-3 py-2 text-left align-top; }
        .prose th { @apply font-semibold bg-gray-50/50 text-gray-700; }
        
        /* Images/SVG Passthrough */
        .prose img, .prose svg { @apply max-w-full h-auto; }

        /* Focus Visibility (Stage 5.5.2) */
        :focus-visible { 
            @apply outline-none ring-2 ring-primary-500 ring-offset-2; 
        }

        /* Disclosure Transition (Stage 5.5.3) */
        .disclosure-content {
            transition: opacity 0.2s ease-out; 
        }
    </style>
</head>
<body>
    <!-- App Shell -->
    <div id="app" class="min-h-screen flex flex-col">
        
        <!-- Top Controls Region -->
        <header class="sticky top-0 z-40 bg-gray-50/95 backdrop-blur border-b border-gray-200 px-4 h-14 flex items-center justify-between lg:justify-start lg:space-x-6">
            
            <!-- Mobile "Jump to" Trigger (Stage 6.0.6) -->
            <button id="mobile-jump-btn" class="lg:hidden text-sm font-medium text-primary-700 flex items-center gap-1.5 p-2 -ml-2 rounded hover:bg-gray-100 active:bg-gray-200 transition-colors">
                <svg class="w-5 h-5 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
                <span>Jump to</span>
            </button>
            
            <!-- Paper Selector (Top Control) -->
            <div class="flex items-center gap-3">
                <label for="paper-select" class="text-sm font-medium text-gray-500 hidden sm:block">Paper:</label>
                <div class="relative">
                    <select id="paper-select" class="appearance-none bg-white border border-gray-300 hover:border-gray-400 text-gray-900 text-sm rounded focus:ring-primary-500 focus:border-primary-500 block w-full py-1.5 pl-3 pr-8 lg:w-64 transition-colors cursor-pointer">
                        <option value="" disabled selected>Loading papers...</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                    </div>
                </div>
            </div>
        </header>

        <!-- DocumentFrameShell (Desktop: Two Columns) -->
        <div class="flex-1 flex max-w-7xl mx-auto w-full relative">
            
            <!-- Navigation Rail (Desktop) -->
            <!-- Sticky, independent scroll if tall, flat list, quiet -->
            <nav class="hidden lg:block w-64 flex-shrink-0 sticky top-14 h-[calc(100vh-3.5rem)] overflow-y-auto no-scrollbar py-8 pr-6 border-r border-transparent">
                <div id="desktop-nav-list" class="space-y-0.5">
                    <!-- Nav items injected here -->
                </div>
            </nav>

            <!-- Paper Document Column -->
            <main class="flex-1 min-w-0 py-10 px-4 sm:px-6 lg:px-12">
                <div id="paper-content" class="max-w-3xl mx-auto space-y-16">
                    <!-- Paper content injected here -->
                    <div class="flex items-center justify-center h-40 text-gray-400 animate-pulse">Loading payload...</div>
                </div>
            </main>
        </div>
    </div>

    <!-- Mobile Navigation Drawer (Stage 6.0.6) -->
    <div id="mobile-drawer" class="fixed inset-0 z-50 hidden" aria-hidden="true" role="dialog" aria-modal="true">
        <!-- Scrim -->
        <div id="drawer-backdrop" class="absolute inset-0 bg-gray-900/20 backdrop-blur-sm transition-opacity opacity-0"></div>
        
        <!-- Drawer Panel -->
        <div class="absolute inset-y-0 left-0 w-72 bg-white shadow-2xl flex flex-col transform transition-transform duration-300 -translate-x-full" id="drawer-panel">
            <div class="p-4 border-b border-gray-100 flex items-center justify-between bg-gray-50/50">
                <h2 class="text-base font-bold text-gray-900">Jump to</h2>
                <button id="drawer-close" class="p-2 -mr-2 text-gray-500 hover:text-gray-900 rounded-full hover:bg-gray-100 transition-colors">
                    <span class="sr-only">Close navigation</span>
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            <div id="mobile-nav-list" class="flex-1 overflow-y-auto p-4 space-y-0.5">
                <!-- Mobile Nav Items -->
            </div>
        </div>
    </div>

    <script>
        // === STAGE 0: CONSTANTS ===
        // These values are authoritative. Literal strings appear NOWHERE else.
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";
        
        // === MARKDOWN RENDERER SETUP ===
        // Stage 6 add-on requirements: html: true, breaks: false, escape disabled
        const md = window.markdownit ? window.markdownit({
            html: true,    // Allow inline SVG
            linkify: true,
            breaks: false  // MUST be false to prevent <br> in math blocks
        }) : null;

        if (md) {
            md.inline.ruler.disable(['escape']); // Preserve TeX backslashes
        }

        // === STATE ===
        let rawPayload = null;
        let activePaperData = null;

        // === DOM REFERENCES ===
        const elApp = document.getElementById('app');
        const elPaperSelect = document.getElementById('paper-select');
        const elPaperContent = document.getElementById('paper-content');
        const elDesktopNav = document.getElementById('desktop-nav-list');
        const elMobileNav = document.getElementById('mobile-nav-list');
        const elMobileDrawer = document.getElementById('mobile-drawer');
        const elDrawerPanel = document.getElementById('drawer-panel');
        const elDrawerBackdrop = document.getElementById('drawer-backdrop');
        const elMobileJumpBtn = document.getElementById('mobile-jump-btn');
        const elDrawerClose = document.getElementById('drawer-close');

        // === INITIALIZATION ===
        async function init() {
            try {
                // Deterministic load from constant
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Fetch failed");
                rawPayload = await response.json();
                
                if (!rawPayload || !rawPayload.papers) throw new Error("Invalid schema");

                // Populate Selector
                renderSelector();

                // Load first paper by default
                if (rawPayload.papers.length > 0) {
                    loadPaper(rawPayload.papers[0].key);
                } else {
                    elPaperContent.innerHTML = `<div class="text-center text-gray-500 py-20">No papers found in payload.</div>`;
                }

            } catch (err) {
                console.error("Payload Error:", err);
                // Stage 3 Failure Mode
                elPaperContent.innerHTML = `<div class="p-6 text-center text-red-700 bg-red-50 border border-red-100 rounded font-mono text-sm font-bold">PAPERS PAYLOAD MISSING</div>`;
                elPaperSelect.innerHTML = `<option>Error</option>`;
                elPaperSelect.disabled = true;
            }
        }

        function renderSelector() {
            elPaperSelect.innerHTML = rawPayload.papers.map(p => 
                `<option value="${p.key}">${p.label}</option>`
            ).join('');
            
            elPaperSelect.addEventListener('change', (e) => loadPaper(e.target.value));
        }

        // === CORE RENDER LOGIC ===
        function loadPaper(paperKey) {
            activePaperData = rawPayload.papers.find(p => p.key === paperKey);
            if (!activePaperData) return;

            // 1. Reset View
            window.scrollTo(0,0);
            
            // 2. Render Content
            const defaults = activePaperData.defaults || { expandedAll: true };
            const renderContext = { expandedAll: defaults.expandedAll !== false };
            
            let contentHtml = '';
            
            // Handle Sections vs Flat (Stage 5.4.6 / Stage 3)
            if (activePaperData.sections) {
                activePaperData.sections.forEach(section => {
                    // Render section header only if label exists
                    if (section.label && section.label.trim()) {
                        contentHtml += `
                            <div class="mb-6 pt-4 border-b border-gray-200/50 pb-2">
                                <h2 class="text-xl font-bold text-gray-400 font-sans tracking-tight">${section.label}</h2>
                            </div>
                        `;
                    }
                    // Section question group
                    contentHtml += `<div class="space-y-16 mb-16">`;
                    section.questions.forEach(q => contentHtml += renderQuestionNode(q, renderContext));
                    contentHtml += `</div>`;
                });
            } else if (activePaperData.questions) {
                contentHtml += `<div class="space-y-16">`;
                activePaperData.questions.forEach(q => contentHtml += renderQuestionNode(q, renderContext));
                contentHtml += `</div>`;
            }

            elPaperContent.innerHTML = contentHtml;

            // 3. Render Navigation
            renderNavigation();

            // 4. Render Math (KaTeX)
            if (window.renderMathInElement) {
                renderMathInElement(document.body, {
                    delimiters: [
                        {left: "$$", right: "$$", display: true},
                        {left: "$", right: "$", display: false},
                        {left: "\\(", right: "\\)", display: false},
                        {left: "\\[", right: "\\]", display: true}
                    ],
                    throwOnError: false
                });
            }
        }

        function renderQuestionNode(node, ctx, depth = 0) {
            // Stage 3 Canonical Layout Structure
            const qIdSafe = `q-${node.id.replace(/[^a-zA-Z0-9]/g, '-')}`;
            
            // Content processing
            const qBodyHtml = md ? md.render(node.question) : node.question;
            
            const hasSolutionBlock = !!node.solutionBlock;
            const hasAnswer = hasSolutionBlock && !!node.solutionBlock.answer;
            const hasDetails = hasSolutionBlock && !!node.solutionBlock.solutionDetails;
            
            // Render Answer
            let answerHtml = '';
            if (hasAnswer) {
                const ansText = md ? md.render(node.solutionBlock.answer) : node.solutionBlock.answer;
                answerHtml = `
                    <div class="relative group">
                        <div class="text-xs font-bold text-primary-700 uppercase tracking-wide mb-1 opacity-90 select-none">Answer</div>
                        <div class="prose text-gray-800 text-lg leading-relaxed">
                            ${ansText}
                        </div>
                    </div>
                `;
            }

            // Render Solution Details (if exists)
            let detailsHtml = '';
            if (hasDetails) {
                const d = node.solutionBlock.solutionDetails;
                const isExpanded = ctx.expandedAll;
                const toggleId = `toggle-${qIdSafe}`;
                const regionId = `details-${qIdSafe}`;
                
                // Parts
                const keepInMind = d.keepInMind ? `
                    <div class="mb-6">
                        <div class="flex items-center gap-2 mb-2 text-primary-700">
                            <svg class="w-4 h-4 opacity-75" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                            <span class="text-xs font-bold uppercase tracking-wide">Keep in mind</span>
                        </div>
                        <div class="prose text-gray-700 text-sm bg-gray-50/50 p-0 rounded-sm">
                            ${md ? md.render(d.keepInMind) : d.keepInMind}
                        </div>
                    </div>` : '';

                const formulas = d.formulasUsed ? `
                    <div class="mb-6">
                        <div class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Formulas used</div>
                        <div class="prose text-gray-600 text-sm">
                            ${md ? md.render(d.formulasUsed) : d.formulasUsed}
                        </div>
                    </div>` : '';

                const working = d.working ? `
                    <div class="mb-6">
                        <div class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Working</div>
                        <div class="prose text-gray-800">
                            ${md ? md.render(d.working) : d.working}
                        </div>
                    </div>` : '';

                // Handle Alt working (array or string robustly)
                let altWorking = '';
                const alts = Array.isArray(d.alternativeWorking) ? d.alternativeWorking : (d.alternativeWorking ? [d.alternativeWorking] : []);
                alts.forEach((alt, idx) => {
                    altWorking += `
                        <div class="mt-8 pt-6 border-t border-gray-100/80">
                            <div class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Alternative working</div>
                            <div class="prose text-gray-800">
                                ${md ? md.render(alt) : alt}
                            </div>
                        </div>
                    `;
                });

                detailsHtml = `
                    <div class="mt-3">
                        <button 
                            id="${toggleId}"
                            class="text-sm font-medium text-primary-700 hover:text-primary-800 hover:underline focus:outline-none focus-visible:ring-2 focus-visible:ring-primary-500 rounded px-1 -ml-1 flex items-center gap-1 transition-colors select-none"
                            onclick="toggleSolution('${regionId}', '${toggleId}')"
                            aria-expanded="${isExpanded}"
                            aria-controls="${regionId}"
                        >
                            <span class="label-text">${isExpanded ? 'Hide working' : 'Show working'}</span>
                        </button>
                        
                        <div id="${regionId}" class="disclosure-content mt-4 pl-4 lg:pl-6 border-l-2 border-gray-100 ${isExpanded ? '' : 'hidden'}">
                            ${keepInMind}
                            ${formulas}
                            ${working}
                            ${altWorking}
                        </div>
                    </div>
                `;
            }

            // Solution Block Wrapper (only if content exists)
            const solutionBlockHtml = (hasAnswer || hasDetails) 
                ? `<div class="mt-6 pt-0 space-y-4 max-w-2xl">${answerHtml}${detailsHtml}</div>` 
                : '';

            // Children recursion
            let childrenHtml = '';
            if (node.children && node.children.length > 0) {
                childrenHtml = `<div class="mt-6 pl-4 lg:pl-8 border-l border-gray-100/60 space-y-8">`;
                node.children.forEach(child => {
                    childrenHtml += renderQuestionNode(child, ctx, depth + 1);
                });
                childrenHtml += `</div>`;
            }

            return `
                <div id="${qIdSafe}" class="group relative scroll-mt-24">
                    <div class="flex gap-3 lg:gap-5">
                        <div class="flex-shrink-0 w-8 lg:w-10 pt-1 text-right font-medium text-gray-400 group-hover:text-gray-500 transition-colors text-lg lg:text-xl select-none">
                            ${node.id}
                        </div>
                        <div class="flex-1 min-w-0 pt-1">
                            <div class="prose text-gray-900 text-lg lg:text-xl leading-relaxed font-medium">
                                ${qBodyHtml}
                            </div>
                            ${solutionBlockHtml}
                            ${childrenHtml}
                        </div>
                    </div>
                </div>
            `;
        }

        // === INTERACTION LOGIC ===
        window.toggleSolution = function(regionId, btnId) {
            const region = document.getElementById(regionId);
            const btn = document.getElementById(btnId);
            const label = btn.querySelector('.label-text');
            
            const isHidden = region.classList.contains('hidden');
            
            if (isHidden) {
                region.classList.remove('hidden');
                label.textContent = "Hide working";
                btn.setAttribute('aria-expanded', "true");
            } else {
                region.classList.add('hidden');
                label.textContent = "Show working";
                btn.setAttribute('aria-expanded', "false");
            }
        }

        // === NAVIGATION RENDERER ===
        function renderNavigation() {
            let navHtml = '';
            
            // Helper to traverse questions for flat list
            const traverse = (nodes) => {
                nodes.forEach(n => {
                    const qIdSafe = `q-${n.id.replace(/[^a-zA-Z0-9]/g, '-')}`;
                    // Hierarchy via type scale only (Stage 5.4.5)
                    // Depth isn't tracked perfectly here but we can infer slightly or just keep it flat.
                    // The brief says "flat list... hierarchy via type scale/quietness".
                    // We'll treat all as flat items sharing left edge.
                    navHtml += `
                        <a href="#${qIdSafe}" 
                           class="nav-item block px-3 py-1 text-sm text-gray-500 hover:text-gray-900 hover:bg-gray-100/80 rounded transition-colors truncate"
                           onclick="handleNavClick(event, '${qIdSafe}')"
                           data-target="${qIdSafe}"
                        >
                            ${n.id}
                        </a>
                    `;
                    if (n.children) traverse(n.children);
                });
            };

            if (activePaperData.sections) {
                activePaperData.sections.forEach(sec => {
                    if (sec.label && sec.label.trim()) {
                        navHtml += `<div class="px-3 mt-4 mb-1 text-xs font-bold text-gray-400 uppercase tracking-wider select-none">${sec.label}</div>`;
                    } else if (navHtml.length > 0) {
                         navHtml += `<div class="mt-4"></div>`;
                    }
                    traverse(sec.questions);
                });
            } else {
                traverse(activePaperData.questions);
            }

            elDesktopNav.innerHTML = navHtml;
            elMobileNav.innerHTML = navHtml;
            
            updateActiveNav();
        }

        function handleNavClick(e, targetId) {
            e.preventDefault();
            const target = document.getElementById(targetId);
            if (target) {
                closeDrawer();
                target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                history.pushState(null, null, `#${targetId}`);
                setActiveNav(targetId);
            }
        }

        function setActiveNav(targetId) {
            document.querySelectorAll('.nav-item').forEach(el => {
                const isActive = el.dataset.target === targetId;
                if (isActive) {
                    // Active state: weight + subtle color (Stage 6.0.2 / 5.4.3)
                    el.classList.add('text-primary-700', 'font-bold', 'bg-primary-50/50');
                    el.classList.remove('text-gray-500');
                } else {
                    el.classList.remove('text-primary-700', 'font-bold', 'bg-primary-50/50');
                    el.classList.add('text-gray-500');
                }
            });
        }

        function updateActiveNav() {
            // Simple scrollspy
            const questions = Array.from(document.querySelectorAll('[id^="q-"]'));
            if (questions.length === 0) return;

            let current = questions[0].id;
            const viewCenter = window.innerHeight / 3;

            for (const q of questions) {
                const rect = q.getBoundingClientRect();
                if (rect.top <= viewCenter) {
                    current = q.id;
                } else {
                    break;
                }
            }
            setActiveNav(current);
        }

        // Scroll listener (throttled slightly by browser usually, but debounce is better)
        let scrollTimeout;
        window.addEventListener('scroll', () => {
            if (scrollTimeout) return;
            scrollTimeout = setTimeout(() => {
                updateActiveNav();
                scrollTimeout = null;
            }, 100);
        });

        // === DRAWER LOGIC ===
        function openDrawer() {
            elMobileDrawer.classList.remove('hidden');
            // Force reflow
            elMobileDrawer.offsetHeight; 
            elDrawerBackdrop.classList.remove('opacity-0');
            elDrawerPanel.classList.remove('-translate-x-full');
            document.body.style.overflow = 'hidden';
        }

        function closeDrawer() {
            elDrawerBackdrop.classList.add('opacity-0');
            elDrawerPanel.classList.add('-translate-x-full');
            setTimeout(() => {
                elMobileDrawer.classList.add('hidden');
                document.body.style.overflow = '';
            }, 300);
        }

        elMobileJumpBtn.addEventListener('click', openDrawer);
        elDrawerClose.addEventListener('click', closeDrawer);
        elDrawerBackdrop.addEventListener('click', closeDrawer);

        // Start
        init();

    </script>
</body>
</html>
