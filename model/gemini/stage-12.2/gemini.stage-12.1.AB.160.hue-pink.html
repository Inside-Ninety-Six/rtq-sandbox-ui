<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AB","indexWithinVariant":"160","totalWithinVariant":"200","hueFamily":"pink","intensityMode":"","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-08T20:27:12.414Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AB&quot;,&quot;indexWithinVariant&quot;:&quot;160&quot;,&quot;totalWithinVariant&quot;:&quot;200&quot;,&quot;hueFamily&quot;:&quot;pink&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-08T20:27:12.414Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- KaTeX CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <!-- Markdown-it -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <!-- KaTeX JS & Auto-render -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Base typography and smooth scrolling */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fafaf9; /* stone-50 */
            color: #1c1917; /* stone-900 */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* KaTeX Containment Invariant */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding-bottom: 4px; /* Space for scrollbar if needed */
            -webkit-overflow-scrolling: touch;
        }
        
        /* Hide scrollbars for nav but keep functionality */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Markdown Content Reset & Typography */
        .md-content p {
            margin-bottom: 0.75rem;
            line-height: 1.6;
        }
        .md-content p:last-child {
            margin-bottom: 0;
        }
        .md-content ul {
            list-style-type: disc;
            padding-left: 1.25em;
            margin-bottom: 0.75rem;
        }
        .md-content ol {
            list-style-type: decimal;
            padding-left: 1.25em;
            margin-bottom: 0.75rem;
        }
        .md-content table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 1rem;
            font-size: 0.95em;
        }
        .md-content th, .md-content td {
            border: 1px solid #e7e5e4; /* stone-200 */
            padding: 0.5rem;
            text-align: left;
        }
        .md-content th {
            font-weight: 600;
            background-color: #fafaf9; /* stone-50 */
        }
        
        /* Table overflow handling for mobile */
        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-bottom: 1rem;
        }

        /* Focus styles */
        *:focus-visible {
            outline: 2px solid #db2777; /* pink-600 */
            outline-offset: 2px;
        }
    </style>

    <script>
        // Tailwind Configuration for ColorLab B (Forced Hue: Pink)
        // Using Stone as the neutral base for a paper-like feel.
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#fdf2f8',
                            100: '#fce7f3',
                            200: '#fbcfe8',
                            300: '#f9a8d4',
                            400: '#f472b6',
                            500: '#ec4899',
                            600: '#db2777', // Accent Main
                            700: '#be185d',
                            800: '#9d174d',
                            900: '#831843',
                        },
                        neutral: {
                            50: '#fafaf9',  // stone-50
                            100: '#f5f5f4', // stone-100
                            200: '#e7e5e4', // stone-200
                            300: '#d6d3d1', // stone-300
                            400: '#a8a29e', // stone-400
                            500: '#78716c', // stone-500
                            600: '#57534e', // stone-600
                            700: '#44403c', // stone-700
                            800: '#292524', // stone-800
                            900: '#1c1917', // stone-900
                        }
                    }
                }
            }
        }
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        /**
         * STAGE 0: CONSTANTS
         */
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        /**
         * MARKDOWN CONFIGURATION
         */
        const md = window.markdownit ? window.markdownit({
            html: true,
            linkify: true,
            breaks: false, // Must be false to support Math delimiters
        }) : null;

        if (md) {
            // Disable escape rule to preserve TeX backslashes
            md.inline.ruler.disable(['escape']);
        }

        /**
         * ICONS
         */
        const { ChevronDown, ChevronRight, Menu, X, Check } = lucide;

        /**
         * UTILS
         */
        // Component to render Markdown with KaTeX post-processing
        const MarkdownRenderer = ({ content, className = "" }) => {
            const containerRef = React.useRef(null);

            React.useEffect(() => {
                if (containerRef.current) {
                    // KaTeX auto-render
                    renderMathInElement(containerRef.current, {
                        delimiters: [
                            { left: "$$", right: "$$", display: true },
                            { left: "$", right: "$", display: false },
                            { left: "\\(", right: "\\)", display: false },
                            { left: "\\[", right: "\\]", display: true }
                        ],
                        throwOnError: false,
                        trust: true // Allow basic HTML in math if needed
                    });
                }
            }, [content]);

            if (!content) return null;

            // Render markdown to HTML
            const htmlContent = md ? md.render(content) : content;

            return (
                <div 
                    ref={containerRef}
                    className={`md-content ${className}`}
                    dangerouslySetInnerHTML={{ __html: htmlContent }}
                />
            );
        };

        // Recursive function to flatten questions for navigation
        const flattenQuestions = (questions, depth = 0) => {
            let flat = [];
            questions.forEach(q => {
                flat.push({ id: q.id, depth, type: 'question' });
                if (q.children && q.children.length > 0) {
                    flat = flat.concat(flattenQuestions(q.children, depth + 1));
                }
            });
            return flat;
        };

        const buildNavigationList = (paper) => {
            if (!paper) return [];
            
            if (paper.sections) {
                // Sectioned paper
                let list = [];
                paper.sections.forEach(section => {
                    if (section.label && section.label.trim() !== "") {
                        list.push({ id: section.label, type: 'section' });
                    }
                    if (section.questions) {
                        list = list.concat(flattenQuestions(section.questions));
                    }
                });
                return list;
            } else if (paper.questions) {
                // Flat paper
                return flattenQuestions(paper.questions);
            }
            return [];
        };

        /**
         * COMPONENTS
         */

        // Navigation Item
        const NavigationItem = ({ item, isActive, onClick }) => {
            // Stage 5.4.5: Hierarchy via type scale/quietness only. Same left edge.
            // Stage 5.4.3: Active state weight + marker.
            
            if (item.type === 'section') {
                return (
                    <div className="pt-4 pb-2 text-xs font-semibold text-neutral-400 uppercase tracking-wider select-none">
                        {item.id}
                    </div>
                );
            }

            const isSub = item.depth > 0;
            const isDeepSub = item.depth > 1;

            return (
                <button
                    onClick={() => onClick(item.id)}
                    className={`
                        w-full text-left py-1.5 px-0 group flex items-center
                        transition-colors duration-200
                        ${isActive ? 'font-bold text-primary-700' : 'font-normal text-neutral-500 hover:text-neutral-800'}
                        ${isSub ? 'text-sm' : 'text-base'} 
                        ${isDeepSub ? 'text-xs' : ''}
                    `}
                >
                    {/* Active Marker (ColorLab B: Pink) */}
                    <div className={`w-1 h-4 mr-2 rounded-full transition-opacity ${isActive ? 'bg-primary-600 opacity-100' : 'bg-transparent opacity-0'}`} />
                    <span>{item.id}</span>
                </button>
            );
        };

        // Navigation Rail/Drawer Content
        const NavigationContent = ({ list, activeId, onJump }) => {
            return (
                <nav className="flex flex-col pb-10">
                    {list.map((item, idx) => (
                        <NavigationItem 
                            key={`${item.type}-${item.id}-${idx}`} 
                            item={item} 
                            isActive={activeId === item.id}
                            onClick={(id) => onJump(id)} 
                        />
                    ))}
                </nav>
            );
        };

        // Solution Details Block
        const SolutionDetails = ({ details, isExpanded }) => {
            if (!isExpanded || !details) return null;

            return (
                <div className="mt-4 animate-in fade-in slide-in-from-top-1 duration-200">
                    {/* Keep in mind */}
                    {details.keepInMind && (
                        <div className="mb-6">
                            <h4 className="text-xs font-bold text-neutral-800 mb-1 uppercase tracking-wide">Keep in mind</h4>
                            <div className="text-neutral-700 text-sm">
                                <MarkdownRenderer content={details.keepInMind} />
                            </div>
                        </div>
                    )}

                    {/* Formulas Used */}
                    {details.formulasUsed && (
                        <div className="mb-6">
                            <h4 className="text-xs font-bold text-neutral-800 mb-1 uppercase tracking-wide">Formulas used</h4>
                            <div className="text-neutral-600 text-sm">
                                <MarkdownRenderer content={details.formulasUsed} />
                            </div>
                        </div>
                    )}

                    {/* Working */}
                    {details.working && (
                        <div className="mb-6">
                            <h4 className="text-xs font-bold text-neutral-800 mb-2 uppercase tracking-wide">Working</h4>
                            <div className="text-neutral-800 text-base">
                                <MarkdownRenderer content={details.working} />
                            </div>
                        </div>
                    )}

                    {/* Alternative Working */}
                    {details.alternativeWorking && Array.isArray(details.alternativeWorking) && details.alternativeWorking.map((alt, idx) => (
                        <div key={idx} className="mt-8 pt-4 border-t border-neutral-200">
                            <h4 className="text-xs font-bold text-neutral-800 mb-2 uppercase tracking-wide">Alternative working</h4>
                            <div className="text-neutral-800 text-base">
                                <MarkdownRenderer content={alt} />
                            </div>
                        </div>
                    ))}
                </div>
            );
        };

        // Question Node Component
        const QuestionNode = ({ node, level = 0, paperDefaults }) => {
            // Determine if Solution Block exists
            const hasSolutionBlock = !!node.solutionBlock;
            const hasAnswer = hasSolutionBlock && !!node.solutionBlock.answer;
            const hasDetails = hasSolutionBlock && !!node.solutionBlock.solutionDetails;
            
            // State for expansion. Default is expanded unless paper defaults say false.
            // Stage 3: "Solution Details are expanded by default when present." unless paper.defaults.expandedAll = false.
            const defaultExpanded = paperDefaults?.expandedAll !== false;
            const [isExpanded, setIsExpanded] = React.useState(defaultExpanded);

            const toggleWorking = () => setIsExpanded(!isExpanded);

            // Spacing based on nesting
            const isTopLevel = level === 0;
            const containerClass = isTopLevel ? "mb-16" : "mb-8 mt-4";
            
            // Sub-question hierarchy cues (Stage 3 E)
            // Using indentation adapts by viewport via padding
            const indentClass = level > 0 ? "pl-0 md:pl-6 border-l-0 md:border-l-2 border-transparent md:border-neutral-100" : "";

            return (
                <div id={node.id} className={`${containerClass} ${indentClass} scroll-mt-24`}>
                    {/* Question Body */}
                    <div className="mb-4">
                        <div className="flex flex-row items-baseline gap-3">
                            <span className="text-neutral-500 font-medium shrink-0 select-none">{node.id}</span>
                            <div className="text-lg text-neutral-900 font-medium leading-relaxed w-full">
                                <MarkdownRenderer content={node.question} />
                            </div>
                        </div>
                    </div>

                    {/* Solution Block (Optional) */}
                    {hasSolutionBlock && (
                        <div className="ml-0 md:ml-10">
                            {/* Answer */}
                            {hasAnswer && (
                                <div className="mb-3">
                                    <div className="text-sm font-bold text-neutral-500 mb-1">Answer</div>
                                    <div className="text-base text-neutral-800">
                                        <MarkdownRenderer content={node.solutionBlock.answer} />
                                    </div>
                                </div>
                            )}

                            {/* Solution Details Toggle & Content */}
                            {hasDetails && (
                                <div className="mt-4">
                                    <button 
                                        onClick={toggleWorking}
                                        className="text-primary-600 hover:text-primary-700 text-sm font-medium flex items-center gap-1 transition-colors focus:outline-none"
                                        aria-expanded={isExpanded}
                                    >
                                        <span>{isExpanded ? "Hide working" : "Show working"}</span>
                                        {isExpanded ? <ChevronDown size={16} /> : <ChevronRight size={16} />}
                                    </button>

                                    <SolutionDetails 
                                        details={node.solutionBlock.solutionDetails} 
                                        isExpanded={isExpanded} 
                                    />
                                </div>
                            )}
                        </div>
                    )}

                    {/* Children */}
                    {node.children && node.children.length > 0 && (
                        <div className="mt-4">
                            {node.children.map((child, idx) => (
                                <QuestionNode 
                                    key={idx} 
                                    node={child} 
                                    level={level + 1} 
                                    paperDefaults={paperDefaults} 
                                />
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        // Main App
        const App = () => {
            const [loading, setLoading] = React.useState(true);
            const [error, setError] = React.useState(false);
            const [papers, setPapers] = React.useState([]);
            const [currentPaperKey, setCurrentPaperKey] = React.useState(null);
            const [mobileNavOpen, setMobileNavOpen] = React.useState(false);

            // Fetch Payload
            React.useEffect(() => {
                fetch(RTQ_PAPERS_PAYLOAD_PATH)
                    .then(res => {
                        if (!res.ok) throw new Error("Missing");
                        return res.json();
                    })
                    .then(data => {
                        if (data && data.papers && Array.isArray(data.papers)) {
                            setPapers(data.papers);
                            if (data.papers.length > 0) {
                                setCurrentPaperKey(data.papers[0].key);
                            }
                        } else {
                            throw new Error("Invalid Format");
                        }
                        setLoading(false);
                    })
                    .catch(err => {
                        console.error(err);
                        setError(true);
                        setLoading(false);
                    });
            }, []);

            // Scroll helper
            const scrollToId = (id) => {
                const el = document.getElementById(id);
                if (el) {
                    el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    setMobileNavOpen(false); // Close drawer on mobile
                }
            };

            if (loading) return (
                <div className="min-h-screen flex items-center justify-center text-neutral-400">
                    Loading...
                </div>
            );

            if (error) return (
                <div className="min-h-screen flex flex-col items-center justify-center p-8 text-center">
                    <div className="text-neutral-900 font-bold text-xl mb-2">PAPERS PAYLOAD MISSING</div>
                    <p className="text-neutral-500 max-w-md">
                        Please ensure the payload is available at <code>{RTQ_PAPERS_PAYLOAD_PATH}</code>
                    </p>
                </div>
            );

            const activePaper = papers.find(p => p.key === currentPaperKey);
            const navList = buildNavigationList(activePaper);

            // Paper Content Renderer
            const PaperContent = () => {
                if (!activePaper) return null;

                if (activePaper.sections) {
                    return (
                        <>
                            {activePaper.sections.map((section, sIdx) => (
                                <div key={sIdx} className="mb-12">
                                    {section.label && (
                                        <div className="text-sm font-bold text-neutral-400 uppercase tracking-widest mb-8 border-b border-neutral-200 pb-2">
                                            Section {section.label}
                                        </div>
                                    )}
                                    {section.questions.map((q, qIdx) => (
                                        <QuestionNode 
                                            key={q.id} 
                                            node={q} 
                                            level={0} 
                                            paperDefaults={activePaper.defaults} 
                                        />
                                    ))}
                                </div>
                            ))}
                        </>
                    );
                } else if (activePaper.questions) {
                    return (
                        <>
                            {activePaper.questions.map((q, qIdx) => (
                                <QuestionNode 
                                    key={q.id} 
                                    node={q} 
                                    level={0} 
                                    paperDefaults={activePaper.defaults} 
                                />
                            ))}
                        </>
                    );
                }
                return null;
            };

            // Observer for active nav state
            const [activeNavId, setActiveNavId] = React.useState(null);

            // Simple intersection observer logic for active state
            React.useEffect(() => {
                if (!activePaper) return;
                
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            setActiveNavId(entry.target.id);
                        }
                    });
                }, { rootMargin: '-10% 0px -80% 0px' });

                // Observe all top-level and sub-questions
                const ids = navList.filter(i => i.type === 'question').map(i => i.id);
                ids.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) observer.observe(el);
                });

                return () => observer.disconnect();
            }, [activePaper, navList]);


            return (
                <div className="min-h-screen flex flex-col max-w-7xl mx-auto bg-neutral-50">
                    {/* Top Controls Region */}
                    <div className="sticky top-0 z-40 bg-neutral-50/95 backdrop-blur-sm border-b border-neutral-200 px-4 md:px-8 h-16 flex items-center justify-between">
                        {/* Paper Selector */}
                        <div className="flex items-center gap-4">
                            <label className="text-sm font-medium text-neutral-500 hidden sm:block">Paper:</label>
                            <div className="relative">
                                <select 
                                    value={currentPaperKey}
                                    onChange={(e) => setCurrentPaperKey(e.target.value)}
                                    className="appearance-none bg-white border border-neutral-300 hover:border-neutral-400 text-neutral-900 text-sm rounded py-2 pl-3 pr-8 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-shadow"
                                >
                                    {papers.map(p => (
                                        <option key={p.key} value={p.key}>{p.label}</option>
                                    ))}
                                </select>
                                <ChevronDown className="absolute right-2 top-2.5 text-neutral-400 pointer-events-none" size={14} />
                            </div>
                        </div>

                        {/* Mobile Jump To Trigger */}
                        <button 
                            className="md:hidden flex items-center gap-2 text-primary-600 font-medium text-sm"
                            onClick={() => setMobileNavOpen(true)}
                        >
                            <span>Jump to</span>
                            <Menu size={18} />
                        </button>
                    </div>

                    {/* DocumentFrameShell */}
                    <div className="flex flex-1 relative">
                        {/* Desktop Navigation Rail */}
                        <aside className="hidden md:block w-48 lg:w-64 shrink-0 sticky top-16 h-[calc(100vh-4rem)] overflow-y-auto no-scrollbar py-8 pl-4 pr-6 border-r border-transparent">
                            <NavigationContent list={navList} activeId={activeNavId} onJump={scrollToId} />
                        </aside>

                        {/* Paper Document Column */}
                        <main className="flex-1 min-w-0 py-8 px-4 md:px-12 lg:px-16 max-w-4xl">
                            <PaperContent />
                            {/* Bottom padding */}
                            <div className="h-32"></div> 
                        </main>
                    </div>

                    {/* Mobile Navigation Drawer */}
                    {mobileNavOpen && (
                        <div className="fixed inset-0 z-50 flex justify-end">
                            {/* Scrim */}
                            <div 
                                className="absolute inset-0 bg-neutral-900/20 backdrop-blur-sm"
                                onClick={() => setMobileNavOpen(false)}
                            />
                            
                            {/* Drawer */}
                            <div className="relative w-64 h-full bg-white shadow-xl flex flex-col animate-in slide-in-from-right duration-300">
                                <div className="flex items-center justify-between p-4 border-b border-neutral-100">
                                    <span className="font-semibold text-neutral-900">Jump to</span>
                                    <button 
                                        onClick={() => setMobileNavOpen(false)}
                                        className="text-neutral-500 hover:text-neutral-900"
                                    >
                                        <X size={20} />
                                    </button>
                                </div>
                                <div className="flex-1 overflow-y-auto p-4">
                                    <NavigationContent list={navList} activeId={activeNavId} onJump={scrollToId} />
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById("root"));
        root.render(<App />);
    </script>
</body>
</html>
