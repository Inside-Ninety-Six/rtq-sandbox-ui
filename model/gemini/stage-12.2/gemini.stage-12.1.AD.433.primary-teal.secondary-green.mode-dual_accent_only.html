<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AD","indexWithinVariant":"433","totalWithinVariant":"440","hueFamily":"","intensityMode":"","primaryHueFamily":"teal","secondaryHueFamily":"green","dualIntensityMode":"dual_accent_only","timestamp":"2026-01-11T01:44:18.934Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AD&quot;,&quot;indexWithinVariant&quot;:&quot;433&quot;,&quot;totalWithinVariant&quot;:&quot;440&quot;,&quot;hueFamily&quot;:&quot;&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;primaryHueFamily&quot;:&quot;teal&quot;,&quot;secondaryHueFamily&quot;:&quot;green&quot;,&quot;dualIntensityMode&quot;:&quot;dual_accent_only&quot;,&quot;timestamp&quot;:&quot;2026-01-11T01:44:18.934Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Viewer</title>

    <!-- 
    STAGE 6 ADD-ON: Real KaTeX Rendering 
    Baseline Lock: Enabled. No SRI/Integrity attributes.
    -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Markdown-it for content rendering -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <style>
        /* 
        ================================================================
        COLORLAB D: DUAL-ACCENT PALETTE (QUANTIFIED, LIGHT-ONLY)
        Mode: dual_accent_only
        Primary Hue: Blue (250)
        Secondary Hue: Amber (85)
        ================================================================
        */
        :root {
            /* 
            Surfaces (C <= 0.015) 
            */
            --color-surface-page: oklch(0.99 0.005 250);
            --color-surface-paper: oklch(1.0 0 0); /* Pure white */
            --color-surface-wash: oklch(0.98 0.008 250); /* Very subtle wash for expanded details */
            
            /* 
            Text (C <= 0.010) 
            */
            --color-text-primary: oklch(0.20 0.01 250);
            --color-text-secondary: oklch(0.45 0.01 250);
            --color-text-quiet: oklch(0.60 0.005 250);

            /* 
            Primary Accent - Blue (Links, Focus, Disclosure)
            Mode Band: C [0.08 .. 0.14]
            */
            --color-accent-primary: oklch(0.55 0.13 250);
            --color-accent-primary-hover: oklch(0.45 0.13 250);
            --color-focus-ring: oklch(0.55 0.13 250);

            /* 
            Secondary Accent - Amber (Supplementary: Current Nav Marker)
            Mode Band: C [0.06 .. 0.12]
            */
            --color-accent-secondary: oklch(0.75 0.11 85);

            /* 
            Borders / Dividers 
            */
            --color-border-hairline: oklch(0.92 0.005 250);
            
            /* 
            Spacing & Layout 
            */
            --space-unit: 4px;
            --space-xs: calc(var(--space-unit) * 2);  /* 8px */
            --space-s:  calc(var(--space-unit) * 3);  /* 12px */
            --space-m:  calc(var(--space-unit) * 4);  /* 16px */
            --space-l:  calc(var(--space-unit) * 6);  /* 24px */
            --space-xl: calc(var(--space-unit) * 10); /* 40px - Top level separation */
            
            --nav-width: 240px;
            --max-width-paper: 800px;
        }

        /* Reset & Base */
        * { box-sizing: border-box; }
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--color-surface-page);
            color: var(--color-text-primary);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        button {
            font-family: inherit;
            border: none;
            background: none;
            cursor: pointer;
            padding: 0;
            margin: 0;
        }

        /* 
        Stage 3: Layout Architecture 
        DocumentFrameShell 
        */
        .shell {
            max-width: 1200px;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Top Controls */
        .top-controls {
            padding: var(--space-m);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--color-surface-page);
            position: sticky;
            top: 0;
            z-index: 50; /* Above content */
        }
        
        .paper-selector {
            font-size: 1rem;
            padding: var(--space-xs) var(--space-s);
            border: 1px solid var(--color-border-hairline);
            border-radius: 4px;
            background-color: var(--color-surface-paper);
            color: var(--color-text-primary);
        }

        .jump-to-trigger {
            display: none; /* Desktop default */
            font-weight: 500;
            color: var(--color-accent-primary);
        }

        /* Main Content Columns */
        .main-columns {
            display: flex;
            flex: 1;
            position: relative;
        }

        /* 
        Navigation Rail (Desktop) 
        */
        .nav-rail {
            width: var(--nav-width);
            flex-shrink: 0;
            padding: var(--space-l) var(--space-m) var(--space-l) 0;
            display: none; /* Mobile default */
            /* Sticky Logic */
            position: sticky;
            top: 60px; /* Offset for top controls */
            height: calc(100vh - 60px);
            overflow-y: auto;
            /* Scrollbar hiding */
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .nav-rail::-webkit-scrollbar { display: none; }

        @media (min-width: 768px) {
            .nav-rail { display: block; }
            .jump-to-trigger { display: none; }
        }
        @media (max-width: 767px) {
            .jump-to-trigger { display: block; }
        }

        .nav-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .nav-section-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--color-text-quiet);
            font-weight: 600;
            margin-top: var(--space-l);
            margin-bottom: var(--space-s);
            padding-left: var(--space-xs);
        }
        .nav-section-label:first-child { margin-top: 0; }

        .nav-item {
            display: block;
            padding: var(--space-xs);
            color: var(--color-text-secondary);
            text-decoration: none;
            font-size: 0.9rem;
            border-left: 2px solid transparent;
            transition: color 0.1s ease;
        }
        .nav-item:hover {
            color: var(--color-text-primary);
        }
        .nav-item.active {
            font-weight: 600;
            color: var(--color-text-primary);
            /* ColorLab D: Secondary Accent allowed for supplementary role (nav marker) */
            border-left-color: var(--color-accent-secondary); 
        }

        /* Hierarchy via type scale (Stage 3/4) */
        .nav-item[data-depth="0"] { font-size: 0.95rem; }
        .nav-item[data-depth="1"] { font-size: 0.9rem; }
        .nav-item[data-depth="2"] { font-size: 0.85rem; color: var(--color-text-quiet); }

        /* 
        Paper Content Column 
        */
        .paper-column {
            flex: 1;
            max-width: var(--max-width-paper);
            padding: var(--space-l) var(--space-m) 100px var(--space-m); /* Bottom padding for scroll room */
        }

        .paper-surface {
            background-color: var(--color-surface-paper);
            /* No cards/shadows per brief */
        }

        /* 
        Section Header (In Paper)
        */
        .section-header-block {
            margin-top: var(--space-xl);
            margin-bottom: var(--space-l);
            padding-bottom: var(--space-s);
            border-bottom: 1px solid var(--color-border-hairline);
        }
        .section-header-text {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--color-text-primary);
        }

        /* 
        Question Node Structure 
        */
        .question-node {
            position: relative;
            /* Top level separation */
            margin-bottom: var(--space-xl);
        }
        
        /* Nested questions separation */
        .question-node .children-container .question-node {
            margin-bottom: var(--space-l); /* Tighter than top level */
        }
        
        /* Indentation for children */
        .children-container {
            margin-top: var(--space-m);
            padding-left: var(--space-l); /* Indent */
        }
        @media (max-width: 480px) {
            .children-container { padding-left: var(--space-s); } /* Adaptive indentation */
        }

        /* Question Body */
        .question-body {
            margin-bottom: var(--space-m);
        }
        .question-identifier {
            font-weight: 600;
            color: var(--color-text-secondary);
            margin-right: var(--space-xs);
            float: left; /* Run-in style or simple flex */
        }
        .question-prompt {
            color: var(--color-text-primary);
            /* Ensure math doesn't overflow */
            overflow-wrap: break-word;
        }

        /* Solution Block */
        .solution-block {
            margin-top: var(--space-m);
            /* Boundary clarity */
        }

        /* Answer */
        .answer-region {
            margin-bottom: var(--space-s);
            display: flex;
            align-items: baseline;
            gap: var(--space-s);
        }
        .answer-label {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--color-text-secondary);
        }
        .answer-content {
            font-weight: 500;
        }

        /* Solution Details */
        .solution-details-control {
            font-size: 0.9rem;
            color: var(--color-accent-primary);
            display: flex;
            align-items: center;
            gap: 4px;
            margin-bottom: var(--space-s);
            width: fit-content;
        }
        .solution-details-control:hover {
            color: var(--color-accent-primary-hover);
            text-decoration: underline;
        }
        .chevron {
            transition: transform 0.2s ease;
            width: 16px;
            height: 16px;
            fill: currentColor;
        }
        .solution-details-control[aria-expanded="true"] .chevron {
            transform: rotate(180deg);
        }

        .solution-details-region {
            display: none;
            /* Subordinate surface */
            background-color: var(--color-surface-wash); 
            padding: var(--space-m);
            /* Optional hairline top boundary if density requires */
            border-top: 1px solid var(--color-border-hairline);
        }
        .solution-details-region.expanded {
            display: block;
            animation: fadeIn 0.2s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-4px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Subsections */
        .sd-subsection {
            margin-bottom: var(--space-m);
        }
        .sd-subsection:last-child { margin-bottom: 0; }

        .sd-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--color-text-secondary);
            margin-bottom: var(--space-xs);
            display: block;
        }

        .sd-body {
            font-size: 0.95rem;
            color: var(--color-text-secondary); /* Subordinate text */
        }

        /* Keep In Mind specific */
        .keep-in-mind .sd-label {
            color: var(--color-text-primary); /* Slightly higher prominence */
        }
        
        /* Alternative Working Separation */
        .alternative-working {
            margin-top: var(--space-l);
            padding-top: var(--space-m);
            border-top: 1px solid var(--color-border-hairline); /* Required separator */
        }

        /* 
        Mobile Drawer 
        */
        .drawer-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.2);
            z-index: 100;
            display: none;
        }
        .drawer {
            position: fixed;
            top: 0; left: 0; bottom: 0;
            width: 80%;
            max-width: 300px;
            background: var(--color-surface-page);
            z-index: 101;
            transform: translateX(-100%);
            transition: transform 0.2s ease-out;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 8px rgba(0,0,0,0.05);
        }
        .drawer.open { transform: translateX(0); }
        .drawer-overlay.open { display: block; }
        
        .drawer-header {
            padding: var(--space-m);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--color-border-hairline);
        }
        .drawer-title { font-weight: 600; }
        .close-drawer { font-size: 1.5rem; line-height: 1; color: var(--color-text-secondary); }
        
        .drawer-content {
            overflow-y: auto;
            flex: 1;
            padding: var(--space-m);
        }

        /* 
        Markdown Content Styles 
        */
        .md-content p { margin-top: 0; margin-bottom: 0.75em; }
        .md-content ul, .md-content ol { padding-left: 1.5em; margin-bottom: 0.75em; }
        .md-content li { margin-bottom: 0.25em; }
        
        /* Tables */
        .md-content table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1em;
            font-size: 0.9em;
        }
        .md-content th, .md-content td {
            border: 1px solid var(--color-border-hairline);
            padding: var(--space-xs) var(--space-s);
            text-align: left;
        }
        .md-content th { font-weight: 600; }

        /* KaTeX Containment Invariant */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding: 0.5em 0;
            margin: 0.5em 0;
            -webkit-overflow-scrolling: touch;
            /* Scrollbar hiding for cleaner look, functional on touch */
            scrollbar-width: none; 
        }
        .katex-display::-webkit-scrollbar { display: none; }
        
        /* KaTeX Underlay (Stage 3 locked) */
        .katex-display > .katex {
            /* Optional subtle underlay for display math if needed, keeping it transparent per general rule 5.8.4
               Wait, 5.8.4 says INLINE math must be transparent. Block math allowed underlay.
               Let's keep it simple/clean for now. */
        }
        
        /* Inline math background forbidden */
        .katex { background-color: transparent !important; }

        /* Failure Message */
        .error-message {
            padding: var(--space-xl);
            text-align: center;
            color: var(--color-text-secondary);
            font-weight: 600;
            letter-spacing: 0.05em;
        }

        /* Accessibility Focus */
        :focus-visible {
            outline: 2px solid var(--color-focus-ring);
            outline-offset: 2px;
        }

    </style>
</head>
<body>

    <div class="shell">
        <!-- Top Controls -->
        <header class="top-controls">
            <!-- Paper Selector -->
            <select id="paper-selector" class="paper-selector" aria-label="Select paper">
                <option value="" disabled selected>Loading...</option>
            </select>

            <!-- Mobile Jump To -->
            <button id="jump-to-trigger" class="jump-to-trigger" aria-label="Open navigation">
                Jump to question
            </button>
        </header>

        <!-- Main Layout -->
        <div class="main-columns">
            <!-- Desktop Nav Rail -->
            <nav id="desktop-nav" class="nav-rail" aria-label="Paper navigation">
                <!-- Injected via JS -->
            </nav>

            <!-- Paper Content -->
            <main id="paper-content" class="paper-column">
                <div id="paper-render-target">
                    <!-- Content injected via JS -->
                </div>
            </main>
        </div>
    </div>

    <!-- Mobile Drawer -->
    <div id="drawer-overlay" class="drawer-overlay"></div>
    <div id="drawer" class="drawer" aria-hidden="true">
        <div class="drawer-header">
            <span class="drawer-title">Jump to</span>
            <button id="close-drawer" class="close-drawer" aria-label="Close navigation">&times;</button>
        </div>
        <div id="drawer-nav-content" class="drawer-content">
            <!-- Cloned Nav injected here -->
        </div>
    </div>

    <script>
        // ================================================================
        // STAGE 0: CONSTANTS
        // ================================================================
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // ================================================================
        // CONFIG & STATE
        // ================================================================
        const state = {
            papers: [],
            currentPaperId: null,
            activeObserver: null
        };

        // ================================================================
        // MARKDOWN & KATEX SETUP
        // ================================================================
        // Configure markdown-it per Stage 6 requirements
        const md = window.markdownit ? window.markdownit({
            html: true,     // Allow inline SVG
            linkify: true,
            breaks: false   // CRITICAL: false prevents <br> in math blocks
        }) : null;

        if (md) {
            // Disable escape rule to preserve TeX backslashes
            md.inline.ruler.disable(['escape']);
        }

        // ================================================================
        // APP LOGIC
        // ================================================================

        async function init() {
            try {
                // Load Payload (Stage 6 Deterministic)
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Payload not found");
                
                const payload = await response.json();
                state.papers = payload.papers || [];

                if (state.papers.length === 0) {
                    renderError("NO PAPERS FOUND");
                    return;
                }

                populatePaperSelector();
                
                // Select first paper by default
                loadPaper(state.papers[0].key);

            } catch (err) {
                console.error(err);
                renderError("PAPERS PAYLOAD MISSING");
            }
            
            setupMobileDrawer();
        }

        function renderError(msg) {
            const target = document.getElementById('paper-render-target');
            target.innerHTML = `<div class="error-message">${msg}</div>`;
            document.getElementById('paper-selector').disabled = true;
        }

        function populatePaperSelector() {
            const selector = document.getElementById('paper-selector');
            selector.innerHTML = '';
            
            state.papers.forEach(paper => {
                const opt = document.createElement('option');
                opt.value = paper.key;
                opt.textContent = paper.label || paper.key;
                selector.appendChild(opt);
            });

            selector.addEventListener('change', (e) => {
                loadPaper(e.target.value);
            });
        }

        function loadPaper(paperKey) {
            state.currentPaperId = paperKey;
            const paper = state.papers.find(p => p.key === paperKey);
            if (!paper) return;

            // Render Paper
            const container = document.getElementById('paper-render-target');
            container.innerHTML = ''; // Clear previous

            // Handle Sectioned vs Flat
            let nodesHtml = '';
            
            // Collect nav items linearly
            const navItems = [];

            if (paper.sections && paper.sections.length > 0) {
                paper.sections.forEach(section => {
                    // Render Section Header if label exists
                    const hasLabel = section.label && section.label.trim().length > 0;
                    if (hasLabel) {
                        nodesHtml += `
                            <div class="section-header-block">
                                <div class="section-header-text">${section.label}</div>
                            </div>
                        `;
                        navItems.push({ type: 'section', label: section.label });
                    }
                    
                    // Render Questions
                    section.questions.forEach(q => {
                        nodesHtml += renderQuestionNode(q, paper.defaults || {}, 0);
                        collectNavItems(q, navItems, 0);
                    });
                });
            } else if (paper.questions) {
                paper.questions.forEach(q => {
                    nodesHtml += renderQuestionNode(q, paper.defaults || {}, 0);
                    collectNavItems(q, navItems, 0);
                });
            }

            container.innerHTML = nodesHtml;

            // Render Navigation
            renderNavigation(navItems);

            // Post-Process: KaTeX
            renderMathInElement(container, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false}
                ],
                throwOnError: false
            });

            // Setup Intersection Observer for Nav active state
            setupScrollObserver(navItems);
        }

        // Recursive Nav Item Collector
        function collectNavItems(node, list, depth) {
            list.push({ type: 'item', id: node.id, depth: depth });
            if (node.children && node.children.length > 0) {
                node.children.forEach(child => collectNavItems(child, list, depth + 1));
            }
        }

        // Recursive Question Renderer
        function renderQuestionNode(node, defaults, depth) {
            const questionHtml = md ? md.render(node.question || '') : (node.question || '');
            
            // Check Solution Block
            const sb = node.solutionBlock;
            let solutionBlockHtml = '';
            
            if (sb) {
                // Answer
                let answerHtml = '';
                if (sb.answer) {
                    const ansContent = md ? md.render(sb.answer) : sb.answer;
                    answerHtml = `
                        <div class="answer-region">
                            <span class="answer-label">Answer</span>
                            <div class="answer-content md-content">${ansContent}</div>
                        </div>
                    `;
                }

                // Solution Details
                let detailsHtml = '';
                let toggleHtml = '';
                
                if (sb.solutionDetails) {
                    const sd = sb.solutionDetails;
                    const isExpanded = (defaults.expandedAll !== false); // Default true unless explicitly false
                    const expandedClass = isExpanded ? 'expanded' : '';
                    const expandedAttr = isExpanded ? 'true' : 'false';
                    const toggleText = isExpanded ? 'Hide working' : 'Show working';

                    // Subsections
                    let subsections = '';
                    
                    if (sd.keepInMind) {
                        subsections += `
                            <div class="sd-subsection keep-in-mind">
                                <span class="sd-label">Keep in mind</span>
                                <div class="sd-body md-content">${md ? md.render(sd.keepInMind) : sd.keepInMind}</div>
                            </div>
                        `;
                    }
                    if (sd.formulasUsed) {
                        subsections += `
                            <div class="sd-subsection formulas-used">
                                <span class="sd-label">Formulas used</span>
                                <div class="sd-body md-content">${md ? md.render(sd.formulasUsed) : sd.formulasUsed}</div>
                            </div>
                        `;
                    }
                    if (sd.working) {
                        subsections += `
                            <div class="sd-subsection working">
                                <span class="sd-label">Working</span>
                                <div class="sd-body md-content">${md ? md.render(sd.working) : sd.working}</div>
                            </div>
                        `;
                    }
                    if (sd.alternativeWorking) {
                        // Assuming string array per schema or single string logic? 
                        // Brief says: "alternativeWorking: string[] (Markdown; 0+)"
                        // BUT brief also says in schema "alternativeWorking: string[]".
                        // However, let's robustly handle array or string just in case, though Add-on schema says array.
                        const alts = Array.isArray(sd.alternativeWorking) ? sd.alternativeWorking : (sd.alternativeWorking ? [sd.alternativeWorking] : []);
                        alts.forEach((alt, idx) => {
                            subsections += `
                                <div class="sd-subsection alternative-working">
                                    <span class="sd-label">Alternative working</span>
                                    <div class="sd-body md-content">${md ? md.render(alt) : alt}</div>
                                </div>
                            `;
                        });
                    }

                    // Build Region
                    if (subsections) {
                        // Unique ID for toggle
                        const regionId = `sd-${node.id.replace(/[^a-zA-Z0-9]/g, '-')}`;
                        
                        toggleHtml = `
                            <button class="solution-details-control" 
                                    aria-expanded="${expandedAttr}" 
                                    aria-controls="${regionId}"
                                    onclick="toggleSolutionDetails(this)">
                                <span>${toggleText}</span>
                                <svg class="chevron" viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>
                            </button>
                        `;

                        detailsHtml = `
                            <div id="${regionId}" class="solution-details-region ${expandedClass}">
                                ${subsections}
                            </div>
                        `;
                    }
                }

                if (answerHtml || detailsHtml) {
                    solutionBlockHtml = `
                        <div class="solution-block">
                            ${answerHtml}
                            ${toggleHtml}
                            ${detailsHtml}
                        </div>
                    `;
                }
            }

            // Children
            let childrenHtml = '';
            if (node.children && node.children.length > 0) {
                let childNodes = '';
                node.children.forEach(child => {
                    childNodes += renderQuestionNode(child, defaults, depth + 1);
                });
                childrenHtml = `<div class="children-container">${childNodes}</div>`;
            }

            // Assemble Node
            // ID must be clean for anchor links
            const anchorId = `q-${node.id}`;
            
            return `
                <div id="${anchorId}" class="question-node" data-id="${node.id}">
                    <div class="question-body">
                        <span class="question-identifier">${node.id}</span>
                        <div class="question-prompt md-content">${questionHtml}</div>
                    </div>
                    ${solutionBlockHtml}
                    ${childrenHtml}
                </div>
            `;
        }

        function renderNavigation(items) {
            const navHtml = items.map(item => {
                if (item.type === 'section') {
                    return `<li class="nav-section-label">${item.label}</li>`;
                } else {
                    return `
                        <li>
                            <a href="#q-${item.id}" 
                               class="nav-item" 
                               data-target="q-${item.id}"
                               data-depth="${item.depth}">
                                ${item.id}
                            </a>
                        </li>
                    `;
                }
            }).join('');
            
            const ul = `<ul class="nav-list">${navHtml}</ul>`;
            
            document.getElementById('desktop-nav').innerHTML = ul;
            document.getElementById('drawer-nav-content').innerHTML = ul;

            // Bind click events for smooth scroll / drawer close
            document.querySelectorAll('.nav-item').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetId = link.getAttribute('data-target');
                    const targetEl = document.getElementById(targetId);
                    if (targetEl) {
                        targetEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        closeDrawer();
                    }
                });
            });
        }

        // ================================================================
        // INTERACTIONS
        // ================================================================

        // Toggle Expand/Collapse
        window.toggleSolutionDetails = function(btn) {
            const regionId = btn.getAttribute('aria-controls');
            const region = document.getElementById(regionId);
            const isExpanded = btn.getAttribute('aria-expanded') === 'true';
            
            if (isExpanded) {
                region.classList.remove('expanded');
                btn.setAttribute('aria-expanded', 'false');
                btn.querySelector('span').textContent = 'Show working';
            } else {
                region.classList.add('expanded');
                btn.setAttribute('aria-expanded', 'true');
                btn.querySelector('span').textContent = 'Hide working';
            }
        };

        // Mobile Drawer
        function setupMobileDrawer() {
            const trigger = document.getElementById('jump-to-trigger');
            const drawer = document.getElementById('drawer');
            const overlay = document.getElementById('drawer-overlay');
            const closeBtn = document.getElementById('close-drawer');

            function open() {
                drawer.classList.add('open');
                overlay.classList.add('open');
                drawer.setAttribute('aria-hidden', 'false');
            }

            function close() {
                drawer.classList.remove('open');
                overlay.classList.remove('open');
                drawer.setAttribute('aria-hidden', 'true');
            }

            trigger.addEventListener('click', open);
            closeBtn.addEventListener('click', close);
            overlay.addEventListener('click', close);
            window.closeDrawer = close;
        }

        // Scroll Spy for Nav
        function setupScrollObserver(navItems) {
            if (state.activeObserver) state.activeObserver.disconnect();

            const questionIds = navItems
                .filter(i => i.type === 'item')
                .map(i => `q-${i.id}`);

            if (questionIds.length === 0) return;

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const id = entry.target.id;
                        // Update active state
                        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                        const activeLinks = document.querySelectorAll(`.nav-item[data-target="${id}"]`);
                        activeLinks.forEach(el => {
                            el.classList.add('active');
                            // Ensure visible in scrollable nav
                            if (el.scrollIntoViewIfNeeded) {
                                // Only auto-scroll nav if not user interaction driven? 
                                // Keep it simple: don't auto-scroll nav aggressively to avoid jumpiness.
                            }
                        });
                    }
                });
            }, {
                rootMargin: '-10% 0px -80% 0px' // Active zone near top
            });

            questionIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) observer.observe(el);
            });

            state.activeObserver = observer;
        }

        // Boot
        init();

    </script>
</body>
</html>
