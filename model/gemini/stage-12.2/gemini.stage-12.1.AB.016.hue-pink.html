<!DOCTYPE html>
<html lang="en" class="antialiased">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AB","indexWithinVariant":"16","totalWithinVariant":"200","hueFamily":"pink","intensityMode":"","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-08T14:08:03.343Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AB&quot;,&quot;indexWithinVariant&quot;:&quot;16&quot;,&quot;totalWithinVariant&quot;:&quot;200&quot;,&quot;hueFamily&quot;:&quot;pink&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-08T14:08:03.343Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Viewer - Prototype</title>
    
    <!-- Tailwind CSS (via CDN for prototype speed/styling) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // ColorLab B: Forced Hue "Pink"
                        // Neutrals: Zinc (modern, slight warmth possible but keeping distinct from hue)
                        neutral: {
                            50: '#fafafa',
                            100: '#f4f4f5',
                            200: '#e4e4e7',
                            300: '#d4d4d8',
                            400: '#a1a1aa',
                            500: '#71717a',
                            600: '#52525b',
                            700: '#3f3f46',
                            800: '#27272a',
                            900: '#18181b',
                        },
                        // Brand/Accent: Pink (Restrained usage per rules)
                        brand: {
                            50: '#fdf2f8',
                            100: '#fce7f3',
                            200: '#fbcfe8',
                            300: '#f9a8d4',
                            400: '#f472b6',
                            500: '#ec4899',
                            600: '#db2777',
                            700: '#be185d',
                            800: '#9d174d',
                            900: '#831843',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <!-- KaTeX CSS (No SRI/Integrity per Stage 6.0.7b) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <!-- Styles -->
    <style>
        /* Base typography settings */
        body {
            font-family: 'Inter', system-ui, sans-serif;
            background-color: #fafafa; /* Zinc-50 equivalent */
            color: #18181b; /* Zinc-900 */
        }

        /* Scrollbar hiding for Nav (Stage 6 Add-on) */
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* KaTeX Containment Invariant (Locked) */
        /* Display math must scroll internally if overflow occurs */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 4px; /* Space for scrollbar if needed */
        }
        
        /* Inline math must never have background */
        .katex {
            background-color: transparent !important;
        }
        
        /* Prevent page-level horizontal scroll */
        html, body {
            overflow-x: hidden;
        }

        /* Markdown Content Styling */
        .markdown-body p {
            margin-bottom: 0.75em;
            line-height: 1.6;
        }
        .markdown-body p:last-child {
            margin-bottom: 0;
        }
        /* Tables in Markdown */
        .markdown-body table {
            width: 100%;
            border-collapse: collapse;
            margin: 1em 0;
            font-size: 0.95em;
        }
        .markdown-body th, .markdown-body td {
            border: 1px solid #e4e4e7; /* Zinc-200 */
            padding: 0.5em 0.75em;
            text-align: left;
        }
        .markdown-body th {
            font-weight: 600;
            background-color: transparent;
        }
        .markdown-body td {
            background-color: transparent;
        }
        /* Lists */
        .markdown-body ul {
            list-style-type: disc;
            padding-left: 1.5em;
            margin-bottom: 0.75em;
        }
        .markdown-body ol {
            list-style-type: decimal;
            padding-left: 1.5em;
            margin-bottom: 0.75em;
        }

        /* Focus Styles (Stage 5.5.2) */
        :focus-visible {
            outline: 2px solid #ec4899; /* Pink-500 */
            outline-offset: 2px;
        }

        /* Print styles */
        @media print {
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col text-neutral-900">

    <!-- Loading State / Error Container -->
    <div id="loading-container" class="flex items-center justify-center min-h-screen">
        <div class="text-neutral-500 animate-pulse">Loading payload...</div>
    </div>

    <!-- Main App Root (Hidden until loaded) -->
    <div id="app-root" class="hidden flex-col min-h-screen">
        
        <!-- Top Controls Region -->
        <header class="sticky top-0 z-40 w-full border-b border-neutral-200 bg-neutral-50/95 backdrop-blur supports-[backdrop-filter]:bg-neutral-50/80">
            <div class="max-w-7xl mx-auto flex items-center h-14 px-4 sm:px-6 lg:px-8 gap-4">
                
                <!-- Mobile Jump To Trigger -->
                <button id="mobile-menu-trigger" class="lg:hidden text-sm font-medium text-brand-600 hover:text-brand-700 flex items-center gap-1">
                    <span class="sr-only">Open navigation</span>
                    <span>Jump to</span>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>

                <!-- Paper Selector -->
                <div class="flex items-center gap-2">
                    <label for="paper-select" class="sr-only">Select Paper</label>
                    <select id="paper-select" class="form-select text-sm py-1 pl-2 pr-8 border-neutral-300 rounded-md bg-white focus:border-brand-500 focus:ring-brand-500">
                        <!-- Options injected via JS -->
                    </select>
                </div>
            </div>
        </header>

        <!-- Document Frame Shell -->
        <div class="flex-1 max-w-7xl mx-auto w-full flex flex-col lg:flex-row relative">
            
            <!-- Desktop Navigation Rail (Sticky) -->
            <aside class="hidden lg:block w-64 flex-shrink-0 border-r border-transparent">
                <div class="sticky top-14 h-[calc(100vh-3.5rem)] overflow-y-auto no-scrollbar py-8 pr-6 pl-4 sm:pl-6 lg:pl-8">
                    <nav id="desktop-nav" aria-label="Paper navigation" class="flex flex-col gap-1">
                        <!-- Nav Items Injected JS -->
                    </nav>
                </div>
            </aside>

            <!-- Paper Content Column -->
            <main class="flex-1 min-w-0 py-8 px-4 sm:px-6 lg:px-8 focus:outline-none" id="main-content" tabindex="-1">
                <div id="paper-content" class="max-w-3xl mx-auto space-y-12">
                    <!-- Paper Content Injected JS -->
                </div>
            </main>

        </div>

        <!-- Mobile Navigation Drawer -->
        <div id="mobile-drawer-backdrop" class="fixed inset-0 bg-neutral-900/20 backdrop-blur-sm z-50 hidden" aria-hidden="true"></div>
        <div id="mobile-drawer" class="fixed inset-y-0 left-0 w-64 bg-white shadow-xl transform -translate-x-full transition-transform duration-300 ease-in-out z-50 flex flex-col" role="dialog" aria-modal="true">
            <div class="flex items-center justify-between px-4 h-14 border-b border-neutral-200">
                <span class="font-medium text-neutral-900">Jump to</span>
                <button id="mobile-drawer-close" class="text-neutral-500 hover:text-neutral-700 p-2">
                    <span class="sr-only">Close navigation</span>
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto p-4">
                <nav id="mobile-nav" class="flex flex-col gap-1">
                    <!-- Mobile Nav Items Injected JS -->
                </nav>
            </div>
        </div>

    </div>

    <!-- Scripts -->
    <!-- Markdown-it (No SRI) -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@13.0.1/dist/markdown-it.min.js"></script>
    <!-- KaTeX JS (No SRI) -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <script>
        // =================================================================
        // STAGE 0: CONSTANTS (Canonical)
        // =================================================================
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // =================================================================
        // STATE MANAGEMENT
        // =================================================================
        let state = {
            papers: [],
            currentPaperId: null,
            mobileDrawerOpen: false
        };

        // =================================================================
        // MARKDOWN CONFIGURATION (Stage 6 Baseline)
        // =================================================================
        const md = window.markdownit ? window.markdownit({
            html: true,       // Allow inline SVG/HTML from payload
            linkify: true,
            breaks: false     // MUST stay false: prevents <br> inside KaTeX delimiters
        }) : null;

        if (md) {
            // Disable escape rule to preserve TeX backslashes
            md.inline.ruler.disable(['escape']);
        }

        // =================================================================
        // DOM ELEMENTS
        // =================================================================
        const loadingContainer = document.getElementById('loading-container');
        const appRoot = document.getElementById('app-root');
        const paperSelect = document.getElementById('paper-select');
        const desktopNav = document.getElementById('desktop-nav');
        const mobileNav = document.getElementById('mobile-nav');
        const paperContent = document.getElementById('paper-content');
        const mobileMenuTrigger = document.getElementById('mobile-menu-trigger');
        const mobileDrawer = document.getElementById('mobile-drawer');
        const mobileDrawerBackdrop = document.getElementById('mobile-drawer-backdrop');
        const mobileDrawerClose = document.getElementById('mobile-drawer-close');

        // =================================================================
        // INITIALIZATION
        // =================================================================
        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error('Payload not found');
                
                const payload = await response.json();
                state.papers = payload.papers || [];

                if (state.papers.length === 0) {
                    throw new Error('No papers in payload');
                }

                // Render Paper Selector
                state.papers.forEach(paper => {
                    const option = document.createElement('option');
                    option.value = paper.key;
                    option.textContent = paper.label || paper.key;
                    paperSelect.appendChild(option);
                });

                // Set initial paper
                state.currentPaperId = state.papers[0].key;
                paperSelect.value = state.currentPaperId;

                // Event Listeners
                paperSelect.addEventListener('change', (e) => loadPaper(e.target.value));
                mobileMenuTrigger.addEventListener('click', openDrawer);
                mobileDrawerClose.addEventListener('click', closeDrawer);
                mobileDrawerBackdrop.addEventListener('click', closeDrawer);

                // Initial Render
                loadPaper(state.currentPaperId);

                // Reveal App
                loadingContainer.classList.add('hidden');
                appRoot.classList.remove('hidden');
                appRoot.classList.add('flex');

            } catch (error) {
                console.error('Initialization failed:', error);
                loadingContainer.innerHTML = `<div class="text-red-600 font-medium">PAPERS PAYLOAD MISSING</div>`;
            }
        }

        // =================================================================
        // CORE LOGIC
        // =================================================================
        function loadPaper(paperId) {
            state.currentPaperId = paperId;
            const paper = state.papers.find(p => p.key === paperId);
            if (!paper) return;

            // Clear previous content
            desktopNav.innerHTML = '';
            mobileNav.innerHTML = '';
            paperContent.innerHTML = '';

            // 1. Build Navigation List
            const navItems = buildNavItems(paper);
            renderNavList(navItems, desktopNav);
            renderNavList(navItems, mobileNav);

            // 2. Build Paper Content
            if (paper.sections && paper.sections.length > 0) {
                paper.sections.forEach((section, index) => {
                    // Render Section Header if label exists
                    if (section.label && section.label.trim() !== '') {
                        const sectionEl = document.createElement('div');
                        sectionEl.className = "mb-8 pb-2 border-b border-neutral-200";
                        sectionEl.innerHTML = `<h2 class="text-lg font-semibold text-neutral-500">${escapeHtml(section.label)}</h2>`;
                        paperContent.appendChild(sectionEl);
                    }
                    // Render Questions
                    if (section.questions) {
                        section.questions.forEach(q => {
                            paperContent.appendChild(renderQuestionNode(q, paper.defaults));
                        });
                        // Add spacing between sections
                        if (index < paper.sections.length - 1) {
                            const spacer = document.createElement('div');
                            spacer.className = "h-12"; // Spacing between sections
                            paperContent.appendChild(spacer);
                        }
                    }
                });
            } else if (paper.questions && paper.questions.length > 0) {
                paper.questions.forEach(q => {
                    paperContent.appendChild(renderQuestionNode(q, paper.defaults));
                });
            } else {
                paperContent.innerHTML = '<p class="text-neutral-500 italic">No questions in this paper.</p>';
            }

            // 3. Render Math
            if (window.renderMathInElement) {
                renderMathInElement(document.body, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false},
                        {left: '\\(', right: '\\)', display: false},
                        {left: '\\[', right: '\\]', display: true}
                    ],
                    throwOnError: false
                });
            }

            // Scroll to top
            window.scrollTo(0, 0);
        }

        // =================================================================
        // RENDERING: NAVIGATION
        // =================================================================
        function buildNavItems(paper) {
            let items = [];
            
            if (paper.sections) {
                paper.sections.forEach(section => {
                    if (section.label && section.label.trim() !== '') {
                        items.push({ type: 'section', label: section.label });
                    }
                    if (section.questions) {
                        section.questions.forEach(q => collectQuestionIds(q, items));
                    }
                });
            } else if (paper.questions) {
                paper.questions.forEach(q => collectQuestionIds(q, items));
            }
            return items;
        }

        function collectQuestionIds(node, list) {
            list.push({ type: 'question', id: node.id, depth: 0 }); // Flat list, depth handled via style nuance
            if (node.children) {
                node.children.forEach(child => collectQuestionIds(child, list));
            }
        }

        function renderNavList(items, container) {
            items.forEach(item => {
                if (item.type === 'section') {
                    const el = document.createElement('div');
                    el.className = "pt-4 pb-2 text-xs font-semibold text-neutral-400 uppercase tracking-wider select-none";
                    el.textContent = item.label;
                    container.appendChild(el);
                } else {
                    const btn = document.createElement('a');
                    btn.href = `#q-${item.id}`;
                    btn.className = "block py-1 text-sm text-neutral-600 hover:text-brand-600 hover:bg-neutral-100 rounded px-2 -ml-2 transition-colors duration-150";
                    
                    // Simple logic for hierarchy visual cue (sub-questions slightly quieter)
                    // Note: Payload structure is flat in nav build, but we could infer. 
                    // For simplicity in this flat build, we trust ID. 
                    // If ID contains parens like (a) or (i), make it slightly smaller visually?
                    // Or keep strictly flat per "Flat list" requirement.
                    // Stage 5.4.5: "All question identifiers share the same left alignment".
                    
                    btn.textContent = item.id;
                    
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        const target = document.getElementById(`q-${item.id}`);
                        if (target) {
                            target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            // Close mobile drawer if open
                            if (state.mobileDrawerOpen) closeDrawer();
                            
                            // Visual focus feedback
                            history.replaceState(null, null, `#q-${item.id}`);
                        }
                    });
                    container.appendChild(btn);
                }
            });
        }

        // =================================================================
        // RENDERING: CONTENT NODES
        // =================================================================
        function renderQuestionNode(node, paperDefaults) {
            const defaults = paperDefaults || { expandedAll: true };
            const wrapper = document.createElement('div');
            wrapper.id = `q-${node.id}`;
            wrapper.className = "group relative mb-12 last:mb-0"; // Top level spacing

            // 1. Question Body
            const qBody = document.createElement('div');
            qBody.className = "mb-4";
            
            // Identifier
            const idEl = document.createElement('div');
            idEl.className = "text-brand-600 font-semibold text-sm mb-1 select-none";
            idEl.textContent = node.id;
            qBody.appendChild(idEl);

            // Prompt (Markdown)
            const promptEl = document.createElement('div');
            promptEl.className = "markdown-body text-neutral-900 text-lg leading-relaxed";
            promptEl.innerHTML = renderMarkdown(node.question);
            qBody.appendChild(promptEl);
            
            wrapper.appendChild(qBody);

            // 2. Solution Block (Optional)
            if (node.solutionBlock) {
                const sb = node.solutionBlock;
                const solutionWrapper = document.createElement('div');
                solutionWrapper.className = "mt-4 pl-0"; // No left border to avoid framing, rely on spacing

                // 2a. Answer (Optional)
                if (sb.answer) {
                    const answerEl = document.createElement('div');
                    answerEl.className = "mb-4";
                    const label = document.createElement('div');
                    label.className = "text-xs font-bold text-neutral-500 uppercase tracking-wide mb-1";
                    label.textContent = "Answer";
                    
                    const val = document.createElement('div');
                    val.className = "markdown-body text-neutral-800 font-medium";
                    val.innerHTML = renderMarkdown(sb.answer);
                    
                    answerEl.appendChild(label);
                    answerEl.appendChild(val);
                    solutionWrapper.appendChild(answerEl);
                }

                // 2b. Solution Details (Optional)
                if (sb.solutionDetails) {
                    const sd = sb.solutionDetails;
                    const detailsId = `sd-${node.id}`;
                    
                    // State
                    let isExpanded = defaults.expandedAll !== false;

                    // Toggle Control
                    const toggleBtn = document.createElement('button');
                    toggleBtn.className = "flex items-center gap-2 text-sm font-medium text-brand-600 hover:text-brand-700 focus:outline-none transition-colors mb-3";
                    toggleBtn.setAttribute('aria-expanded', isExpanded);
                    toggleBtn.setAttribute('aria-controls', detailsId);
                    
                    const updateToggleText = () => {
                        toggleBtn.innerHTML = `
                            <span>${isExpanded ? 'Hide working' : 'Show working'}</span>
                            <svg class="w-4 h-4 transform transition-transform ${isExpanded ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        `;
                    };
                    updateToggleText();

                    // Details Container
                    const detailsContainer = document.createElement('div');
                    detailsContainer.id = detailsId;
                    detailsContainer.className = isExpanded ? "block" : "hidden";
                    
                    // Inner Content (Markdown) - Anti-faded: using text-neutral-700 (good readability)
                    const contentInner = document.createElement('div');
                    contentInner.className = "space-y-6 pt-2 pb-2 text-neutral-700";

                    // Keep in mind
                    if (sd.keepInMind) {
                        const block = createDetailsBlock("Keep in mind", sd.keepInMind, "list-disc pl-4", "text-neutral-800");
                        contentInner.appendChild(block);
                    }

                    // Formulas used
                    if (sd.formulasUsed) {
                        const block = createDetailsBlock("Formulas used", sd.formulasUsed, "space-y-1", "text-neutral-600 text-sm");
                        contentInner.appendChild(block);
                    }

                    // Working
                    if (sd.working) {
                        const block = createDetailsBlock("Working", sd.working, "markdown-body", "");
                        contentInner.appendChild(block);
                    }

                    // Alternative Working
                    if (sd.alternativeWorking && Array.isArray(sd.alternativeWorking)) {
                        sd.alternativeWorking.forEach((alt, idx) => {
                            const block = createDetailsBlock("Alternative working", alt, "markdown-body", "");
                            // Demarcation: Separator from main working
                            block.classList.add("border-t", "border-neutral-100", "pt-4", "mt-4");
                            contentInner.appendChild(block);
                        });
                    }

                    detailsContainer.appendChild(contentInner);

                    // Toggle Logic
                    toggleBtn.addEventListener('click', () => {
                        isExpanded = !isExpanded;
                        detailsContainer.className = isExpanded ? "block" : "hidden";
                        toggleBtn.setAttribute('aria-expanded', isExpanded);
                        updateToggleText();
                    });

                    solutionWrapper.appendChild(toggleBtn);
                    solutionWrapper.appendChild(detailsContainer);
                }
                
                wrapper.appendChild(solutionWrapper);
            }

            // 3. Children (Sub-questions)
            if (node.children && node.children.length > 0) {
                const childrenContainer = document.createElement('div');
                // Indentation handled via padding/margin.
                // Stage 3 permits indentation spacing. 
                // Adapt for mobile: less indentation.
                childrenContainer.className = "mt-6 ml-0 pl-4 border-l-2 border-neutral-100 sm:pl-6 sm:ml-2 sm:border-l-0";
                
                node.children.forEach(child => {
                    childrenContainer.appendChild(renderQuestionNode(child, paperDefaults));
                });
                wrapper.appendChild(childrenContainer);
            }

            return wrapper;
        }

        function createDetailsBlock(label, markdown, bodyClass = "", labelClassExtra = "") {
            const block = document.createElement('div');
            
            const labelEl = document.createElement('h4');
            labelEl.className = "text-xs font-bold text-neutral-500 uppercase tracking-wide mb-2 " + labelClassExtra;
            labelEl.textContent = label;
            
            const bodyEl = document.createElement('div');
            bodyEl.className = bodyClass;
            bodyEl.innerHTML = renderMarkdown(markdown);
            
            block.appendChild(labelEl);
            block.appendChild(bodyEl);
            return block;
        }

        // =================================================================
        // UTILS
        // =================================================================
        function renderMarkdown(text) {
            if (!md) return escapeHtml(text || ''); // Fallback
            return md.render(text || '');
        }

        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function openDrawer() {
            state.mobileDrawerOpen = true;
            mobileDrawer.classList.remove('-translate-x-full');
            mobileDrawerBackdrop.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeDrawer() {
            state.mobileDrawerOpen = false;
            mobileDrawer.classList.add('-translate-x-full');
            mobileDrawerBackdrop.classList.add('hidden');
            document.body.style.overflow = '';
        }

        // =================================================================
        // START
        // =================================================================
        window.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
