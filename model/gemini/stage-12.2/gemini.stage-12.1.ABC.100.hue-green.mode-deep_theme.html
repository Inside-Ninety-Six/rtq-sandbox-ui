<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"ABC","indexWithinVariant":"100","totalWithinVariant":"320","hueFamily":"green","intensityMode":"deep_theme","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-09T14:34:25.486Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;ABC&quot;,&quot;indexWithinVariant&quot;:&quot;100&quot;,&quot;totalWithinVariant&quot;:&quot;320&quot;,&quot;hueFamily&quot;:&quot;green&quot;,&quot;intensityMode&quot;:&quot;deep_theme&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-09T14:34:25.486Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>
    
    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- KaTeX CSS (CDN) - No integrity, no crossorigin per instructions -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    
    <!-- KaTeX JS (CDN) -->
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    
    <!-- Markdown-it (CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- CSS Variables & Base Styles -->
    <style>
        /* 
           COLORLAB CONFIG: 
           Hue: Green (approx 150)
           Mode: Deep Theme (Light Only)
           
           OKLCH Values derived from constraints:
           Page BG: L 0.94, C 0.10, H 150
           Frame BG: L 0.92, C 0.10, H 150
           Paper BG: L 0.97, C 0.07, H 150
           Text Primary: L 0.20, C 0.015, H 150
           Text Secondary: L 0.35, C 0.02, H 150
           Accent: L 0.55, C 0.20, H 150
           Border/Divider: L 0.85, C 0.02, H 150
           Wash: L 0.96, C 0.05, H 150
        */
        :root {
            --color-page-bg: oklch(0.94 0.10 150);
            --color-frame-bg: oklch(0.92 0.10 150);
            --color-paper-bg: oklch(0.97 0.07 150);
            
            --color-text-primary: oklch(0.20 0.015 150);
            --color-text-secondary: oklch(0.35 0.02 150);
            --color-text-quiet: oklch(0.45 0.02 150);
            
            --color-accent: oklch(0.55 0.20 150);
            
            --color-border: oklch(0.85 0.02 150);
            --color-border-quiet: oklch(0.90 0.01 150);
            
            --color-wash: oklch(0.96 0.05 150);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-page-bg);
            color: var(--color-text-primary);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        /* Utility: Hide Scrollbar but keep functionality */
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* Math Overflow Handling - Block Math Only */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            padding-bottom: 0.5em; /* Space for scrollbar if needed */
            max-width: 100%;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Typography overrides for KaTeX integration */
        .katex {
            font-size: 1.1em;
        }

        /* Focus styles */
        :focus-visible {
            outline: 2px solid var(--color-accent);
            outline-offset: 2px;
        }

        /* Markdown Content Styling */
        .md-content p {
            margin-bottom: 0.75rem;
        }
        .md-content p:last-child {
            margin-bottom: 0;
        }
        /* Tables */
        .md-content table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
            font-size: 0.95em;
        }
        .md-content th, .md-content td {
            border: 1px solid var(--color-border);
            padding: 0.5rem;
            text-align: left;
        }
        .md-content th {
            font-weight: 600;
        }
        /* Lists */
        .md-content ul {
            list-style-type: disc;
            padding-left: 1.5rem;
            margin-bottom: 0.75rem;
        }
        .md-content ol {
            list-style-type: decimal;
            padding-left: 1.5rem;
            margin-bottom: 0.75rem;
        }

        /* Deep Theme Surface Utilities */
        .bg-page { background-color: var(--color-page-bg); }
        .bg-frame { background-color: var(--color-frame-bg); }
        .bg-paper { background-color: var(--color-paper-bg); }
        .bg-wash { background-color: var(--color-wash); }
        
        .text-primary { color: var(--color-text-primary); }
        .text-secondary { color: var(--color-text-secondary); }
        .text-quiet { color: var(--color-text-quiet); }
        .text-accent { color: var(--color-accent); }
        
        .border-theme { border-color: var(--color-border); }
        .border-quiet { border-color: var(--color-border-quiet); }
    </style>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        accent: 'var(--color-accent)',
                    }
                }
            }
        }
    </script>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Top Controls Region -->
    <div id="top-controls" class="w-full max-w-7xl mx-auto px-4 md:px-8 py-4 flex items-center justify-between z-20 bg-page md:bg-transparent">
        <div class="flex items-center gap-4">
            <!-- Paper Selector -->
            <div class="relative">
                <select id="paper-selector" class="appearance-none bg-paper border border-theme text-primary text-sm font-medium py-2 pl-3 pr-8 rounded shadow-sm focus:outline-none focus:ring-1 focus:ring-accent cursor-pointer">
                    <option disabled selected>Loading papers...</option>
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-secondary">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </div>
            </div>
        </div>
        
        <!-- Mobile Jump To Trigger -->
        <button id="mobile-jump-trigger" class="md:hidden text-sm font-medium text-accent flex items-center gap-1">
            <span>Jump to</span>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
        </button>
    </div>

    <!-- DocumentFrameShell -->
    <div id="doc-shell" class="flex-1 w-full max-w-7xl mx-auto flex bg-frame shadow-sm min-h-[calc(100vh-80px)] md:min-h-0">
        
        <!-- Navigation Rail (Desktop) -->
        <aside id="nav-rail" class="hidden md:block w-64 flex-shrink-0 sticky top-0 h-screen overflow-y-auto no-scrollbar py-6 pl-8 pr-4 border-r border-quiet">
            <nav id="desktop-nav-list" class="space-y-1" aria-label="Document navigation"></nav>
        </aside>

        <!-- Paper Content Column -->
        <main id="paper-content" class="flex-1 w-full py-8 px-4 md:px-12 lg:px-16 bg-paper min-h-screen">
            <div id="paper-body" class="max-w-3xl mx-auto space-y-12">
                <!-- Content injected here -->
                <div class="text-secondary text-center mt-20">Loading payload...</div>
            </div>
        </main>

    </div>

    <!-- Mobile Navigation Drawer -->
    <div id="mobile-drawer-backdrop" class="fixed inset-0 bg-black/20 z-40 hidden transition-opacity opacity-0" aria-hidden="true"></div>
    <div id="mobile-drawer" class="fixed inset-y-0 right-0 w-64 bg-paper z-50 transform translate-x-full transition-transform duration-200 ease-in-out shadow-xl flex flex-col">
        <div class="p-4 border-b border-theme flex justify-between items-center bg-frame">
            <h2 class="text-sm font-semibold text-secondary uppercase tracking-wide">Jump to</h2>
            <button id="close-drawer" class="text-secondary hover:text-primary p-1">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <nav id="mobile-nav-list" class="flex-1 overflow-y-auto p-4 space-y-1"></nav>
    </div>

    <!-- MAIN SCRIPT -->
    <script>
        // --- STAGE 0: CONSTANTS ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // --- STATE ---
        const state = {
            papers: [],
            currentPaper: null,
            expandedState: new Map(), // questionId -> boolean
            activeNavId: null
        };

        // --- MARKDOWN SETUP ---
        let md = null;
        if (window.markdownit) {
            md = window.markdownit({
                html: true,
                linkify: true,
                breaks: false
            });
            // Disable inline escape to preserve TeX backslashes
            md.inline.ruler.disable(['escape']);
        }

        // --- DOM ELEMENTS ---
        const els = {
            paperSelector: document.getElementById('paper-selector'),
            paperBody: document.getElementById('paper-body'),
            desktopNav: document.getElementById('desktop-nav-list'),
            mobileNav: document.getElementById('mobile-nav-list'),
            mobileJumpBtn: document.getElementById('mobile-jump-trigger'),
            mobileDrawer: document.getElementById('mobile-drawer'),
            drawerBackdrop: document.getElementById('mobile-drawer-backdrop'),
            closeDrawerBtn: document.getElementById('close-drawer')
        };

        // --- INIT ---
        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error('Payload fetch failed');
                const data = await response.json();
                
                if (!data.papers || !Array.isArray(data.papers)) {
                    throw new Error('Invalid payload structure');
                }

                state.papers = data.papers;
                renderSelector();
                
                // Load first paper by default
                if (state.papers.length > 0) {
                    loadPaper(state.papers[0].key);
                }
            } catch (err) {
                console.error(err);
                renderFailure();
            }
        }

        function renderFailure() {
            els.paperBody.innerHTML = `
                <div class="flex flex-col items-center justify-center py-20 text-center">
                    <p class="text-lg font-semibold text-secondary uppercase tracking-widest">Papers Payload Missing</p>
                </div>
            `;
            els.paperSelector.innerHTML = '<option disabled>Error</option>';
        }

        function renderSelector() {
            els.paperSelector.innerHTML = state.papers.map(p => 
                `<option value="${p.key}">${p.label}</option>`
            ).join('');
            
            els.paperSelector.addEventListener('change', (e) => {
                loadPaper(e.target.value);
            });
        }

        function loadPaper(key) {
            const paper = state.papers.find(p => p.key === key);
            if (!paper) return;

            state.currentPaper = paper;
            state.expandedState.clear();
            
            // Set defaults
            const defaultExpand = paper.defaults?.expandedAll !== false;
            
            // Recursive function to initialize expanded state
            function initDefaults(nodes) {
                if (!nodes) return;
                nodes.forEach(node => {
                    if (node.solutionBlock?.solutionDetails) {
                        state.expandedState.set(node.id, defaultExpand);
                    }
                    if (node.children) initDefaults(node.children);
                });
            }

            if (paper.sections) {
                paper.sections.forEach(sec => initDefaults(sec.questions));
            } else if (paper.questions) {
                initDefaults(paper.questions);
            }

            renderPaperContent();
            renderNavigation();
            
            // Reset Scroll
            window.scrollTo(0,0);
            document.getElementById('nav-rail').scrollTop = 0;
        }

        // --- RENDERING ---

        function renderPaperContent() {
            const p = state.currentPaper;
            let html = '';

            if (p.sections) {
                html = p.sections.map(section => {
                    const labelHtml = section.label && section.label.trim() !== '' 
                        ? `<div class="mb-6 pb-2 border-b border-theme text-lg font-medium text-secondary">${section.label}</div>` 
                        : '';
                    
                    const questionsHtml = section.questions.map(q => renderQuestionNode(q, 0)).join('<div class="h-12 md:h-16"></div>'); // Top level spacing
                    
                    return `<section class="mb-16">${labelHtml}${questionsHtml}</section>`;
                }).join('<div class="h-12"></div>');
            } else if (p.questions) {
                html = p.questions.map(q => renderQuestionNode(q, 0)).join('<div class="h-12 md:h-16"></div>'); // Top level spacing
            }

            els.paperBody.innerHTML = html;
            
            // Post-render: KaTeX
            if (window.renderMathInElement) {
                renderMathInElement(els.paperBody, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false},
                        {left: '\\(', right: '\\)', display: false},
                        {left: '\\[', right: '\\]', display: true}
                    ],
                    throwOnError: false
                });
            }
        }

        function renderQuestionNode(node, depth) {
            const isExpanded = state.expandedState.get(node.id);
            const hasSolution = !!node.solutionBlock;
            const hasAnswer = hasSolution && !!node.solutionBlock.answer;
            const hasDetails = hasSolution && !!node.solutionBlock.solutionDetails;
            
            // Markdown rendering helper
            const renderMD = (content) => md ? md.render(content || '') : (content || '');

            let detailsHtml = '';
            if (hasDetails) {
                const details = node.solutionBlock.solutionDetails;
                const displayStyle = isExpanded ? 'block' : 'none';
                
                // Subsections
                const keepInMind = details.keepInMind ? `
                    <div class="mb-4">
                        <div class="text-xs font-bold text-secondary uppercase tracking-wide mb-1">Keep in mind</div>
                        <div class="md-content text-secondary text-sm bg-transparent pl-0">${renderMD(details.keepInMind)}</div>
                    </div>` : '';

                const formulas = details.formulasUsed ? `
                    <div class="mb-4">
                        <div class="text-xs font-bold text-secondary uppercase tracking-wide mb-1">Formulas used</div>
                        <div class="md-content text-secondary text-sm">${renderMD(details.formulasUsed)}</div>
                    </div>` : '';

                const working = details.working ? `
                    <div class="mb-6">
                        <div class="text-xs font-bold text-secondary uppercase tracking-wide mb-2">Working</div>
                        <div class="md-content text-primary">${renderMD(details.working)}</div>
                    </div>` : '';

                const alternatives = details.alternativeWorking ? details.alternativeWorking.map((alt, i) => `
                    <div class="mt-6 pt-4 border-t border-quiet">
                        <div class="text-xs font-bold text-secondary uppercase tracking-wide mb-2">Alternative working ${details.alternativeWorking.length > 1 ? i + 1 : ''}</div>
                        <div class="md-content text-primary">${renderMD(alt)}</div>
                    </div>
                `).join('') : '';

                detailsHtml = `
                    <div id="details-${node.id}" class="mt-4 pl-4 border-l border-quiet ${displayStyle}">
                        <div class="bg-wash rounded-sm p-4 -ml-4">
                            ${keepInMind}
                            ${formulas}
                            ${working}
                            ${alternatives}
                        </div>
                    </div>
                `;
            }

            // Disclosure Control
            let toggleHtml = '';
            if (hasDetails) {
                const label = isExpanded ? 'Hide working' : 'Show working';
                toggleHtml = `
                    <button onclick="toggleWorking('${node.id}')" class="text-sm font-medium text-accent hover:underline focus:outline-none mt-2 flex items-center gap-1 select-none">
                        ${label}
                        <svg class="w-3 h-3 transform transition-transform ${isExpanded ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                `;
            }

            // Answer
            let answerHtml = '';
            if (hasAnswer) {
                answerHtml = `
                    <div class="mt-3">
                        <span class="text-xs font-bold text-secondary uppercase tracking-wide block mb-1">Answer</span>
                        <div class="md-content text-primary font-medium">${renderMD(node.solutionBlock.answer)}</div>
                    </div>
                `;
            }

            // Children
            let childrenHtml = '';
            if (node.children && node.children.length > 0) {
                childrenHtml = `
                    <div class="mt-4 space-y-6">
                        ${node.children.map(child => renderQuestionNode(child, depth + 1)).join('')}
                    </div>
                `;
            }

            // Indentation logic (Spacing only)
            const indentClass = depth > 0 ? (depth === 1 ? 'ml-0 md:ml-4' : 'ml-0 md:ml-8') : '';

            // Question Body
            // Render MD for question text.
            const qText = renderMD(node.question);

            return `
                <div id="q-${node.id}" class="scroll-mt-24 ${indentClass} group">
                    <div class="flex gap-3 md:gap-4">
                        <div class="flex-shrink-0 w-8 md:w-10 text-right">
                            <span class="text-secondary font-medium text-sm md:text-base">${node.id}</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <!-- Question -->
                            <div class="md-content text-primary text-base md:text-lg leading-relaxed">${qText}</div>
                            
                            <!-- Solution Block -->
                            ${hasSolution ? `
                                <div class="mt-2">
                                    ${answerHtml}
                                    ${toggleHtml}
                                    ${detailsHtml}
                                </div>
                            ` : ''}
                            
                            <!-- Children -->
                            ${childrenHtml}
                        </div>
                    </div>
                </div>
            `;
        }

        window.toggleWorking = function(id) {
            const current = state.expandedState.get(id);
            state.expandedState.set(id, !current);
            
            // Re-render strategy: simpler than fine-grained DOM manipulation for this prototype
            renderPaperContent();
        };

        function renderNavigation() {
            const p = state.currentPaper;
            let navHtml = '';

            // Helper to build nav items
            const buildItems = (nodes, depth) => {
                let html = '';
                nodes.forEach(node => {
                    const textSize = depth === 0 ? 'text-sm' : 'text-xs';
                    const weight = depth === 0 ? 'font-medium' : 'font-normal';
                    const color = depth === 0 ? 'text-secondary' : 'text-quiet';
                    
                    html += `
                        <a href="#q-${node.id}" class="block py-1 ${textSize} ${weight} ${color} hover:text-primary hover:bg-black/5 rounded px-2 -mx-2 transition-colors duration-100 truncate" onclick="handleNavClick(event, '${node.id}')">
                            ${node.id}
                        </a>
                    `;
                    if (node.children) html += buildItems(node.children, depth + 1);
                });
                return html;
            };

            if (p.sections) {
                navHtml = p.sections.map(sec => {
                    const label = sec.label && sec.label.trim() !== '' 
                        ? `<div class="mt-4 first:mt-0 mb-1 px-2 -mx-2 text-xs font-semibold text-secondary uppercase tracking-wider select-none">${sec.label}</div>` 
                        : '';
                    return `<div>${label}${buildItems(sec.questions, 0)}</div>`;
                }).join('<div class="my-2 border-t border-quiet mx-2 opacity-50"></div>');
            } else if (p.questions) {
                navHtml = buildItems(p.questions, 0);
            }

            els.desktopNav.innerHTML = navHtml;
            els.mobileNav.innerHTML = navHtml;
        }

        window.handleNavClick = function(e, id) {
            e.preventDefault();
            const el = document.getElementById(`q-${id}`);
            if (el) {
                // Smooth scroll
                el.scrollIntoView({ behavior: 'smooth' });
                // Update active state (basic impl)
                state.activeNavId = id;
            }
            // Close mobile drawer if open
            toggleDrawer(false);
        };

        // --- MOBILE DRAWER ---
        function toggleDrawer(show) {
            if (show) {
                els.mobileDrawer.classList.remove('translate-x-full');
                els.drawerBackdrop.classList.remove('hidden');
                // Force reflow for transition
                void els.drawerBackdrop.offsetWidth;
                els.drawerBackdrop.classList.remove('opacity-0');
            } else {
                els.mobileDrawer.classList.add('translate-x-full');
                els.drawerBackdrop.classList.add('opacity-0');
                setTimeout(() => {
                    els.drawerBackdrop.classList.add('hidden');
                }, 200);
            }
        }

        els.mobileJumpBtn.addEventListener('click', () => toggleDrawer(true));
        els.closeDrawerBtn.addEventListener('click', () => toggleDrawer(false));
        els.drawerBackdrop.addEventListener('click', () => toggleDrawer(false));

        // Start
        init();

    </script>
</body>
</html>
