<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AB","indexWithinVariant":"7","totalWithinVariant":"200","hueFamily":"teal","intensityMode":"","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-08T13:43:37.208Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AB&quot;,&quot;indexWithinVariant&quot;:&quot;7&quot;,&quot;totalWithinVariant&quot;:&quot;200&quot;,&quot;hueFamily&quot;:&quot;teal&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-08T13:43:37.208Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer (Stage 6)</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- KaTeX CSS (No SRI/Integrity per Stage 6 baseline) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <!-- Markdown-it (No SRI) -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <!-- KaTeX JS (No SRI) -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <style>
        /* =========================================
           STAGE 6: COLORLAB B (Teal) + A (Light Only)
           ========================================= */
        :root {
            /* Palette: Teal Family */
            --hue-teal: 175;
            
            /* Base/Neutrals (Tinted with Teal) */
            --c-bg-app: hsl(var(--hue-teal), 10%, 98%); /* Page Background */
            --c-bg-paper: #ffffff; /* Main Paper Surface */
            --c-bg-nav: transparent; /* Nav shares shell surface */
            
            /* Text */
            --c-txt-primary: hsl(var(--hue-teal), 30%, 15%); /* Question Body */
            --c-txt-secondary: hsl(var(--hue-teal), 15%, 35%); /* Identifiers, Sol Details */
            --c-txt-tertiary: hsl(var(--hue-teal), 10%, 50%); /* Nav, Metadata */
            
            /* Borders/Dividers */
            --c-border-hairline: hsl(var(--hue-teal), 10%, 90%);
            --c-border-focus: hsl(var(--hue-teal), 60%, 40%);

            /* Accent (Teal - for interactive/focus only) */
            --c-accent: hsl(var(--hue-teal), 70%, 35%);
            --c-accent-hover: hsl(var(--hue-teal), 70%, 25%);

            /* Surfaces (Subtle) */
            --c-surface-wash: hsl(var(--hue-teal), 20%, 97%); /* Optional Sol Details wash */

            /* Typography */
            --font-stack: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            
            /* Spacing Units */
            --sp-xs: 4px;
            --sp-sm: 8px;
            --sp-md: 16px;
            --sp-lg: 24px;
            --sp-xl: 40px; /* Top level question separation */
            --sp-xxl: 64px;

            /* Layout */
            --w-max: 1100px;
            --w-nav: 220px;
        }

        /* Reset & Base */
        * { box-sizing: border-box; }
        body {
            margin: 0;
            padding: 0;
            background-color: var(--c-bg-app);
            color: var(--c-txt-primary);
            font-family: var(--font-stack);
            -webkit-font-smoothing: antialiased;
            line-height: 1.5;
        }

        button { font-family: inherit; }
        
        /* Focus Styles (Stage 5.5.2) */
        :focus-visible {
            outline: 2px solid var(--c-border-focus);
            outline-offset: 2px;
        }

        /* =========================================
           LAYOUT: DocumentFrameShell
           ========================================= */
        .app-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .top-controls {
            padding: var(--sp-md) var(--sp-lg);
            background: var(--c-bg-app); /* Visual alignment */
            border-bottom: 1px solid transparent; /* Placeholder for hairline if needed */
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: var(--w-max);
            margin: 0 auto;
            width: 100%;
        }

        .document-frame-shell {
            flex: 1;
            display: grid;
            grid-template-columns: var(--w-nav) 1fr; /* Desktop: Nav + Paper */
            gap: var(--sp-lg);
            max-width: var(--w-max);
            margin: 0 auto;
            width: 100%;
            padding: 0 var(--sp-lg) var(--sp-xxl) var(--sp-lg);
            position: relative;
        }

        /* Mobile Layout overrides */
        @media (max-width: 768px) {
            .document-frame-shell {
                display: block; /* Stack */
                padding: 0 var(--sp-md) var(--sp-xl) var(--sp-md);
            }
            .nav-column {
                display: none; /* Hidden on mobile, use Drawer */
            }
        }

        /* =========================================
           NAVIGATION (Desktop Rail)
           ========================================= */
        .nav-column {
            /* Sticky positioning */
            position: sticky;
            top: var(--sp-md);
            height: calc(100vh - var(--sp-xl));
            overflow-y: auto;
            padding-right: var(--sp-md);
            /* Scrollbar hiding (Add-on) */
            scrollbar-width: none; /* Firefox */
        }
        .nav-column::-webkit-scrollbar { display: none; }

        .nav-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .nav-section-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--c-txt-tertiary);
            font-weight: 600;
            margin-top: var(--sp-md);
            margin-bottom: var(--sp-xs);
            padding-left: var(--sp-xs);
            pointer-events: none; /* Non-clickable */
        }

        .nav-item {
            display: block;
            padding: var(--sp-xs) var(--sp-sm);
            font-size: 0.9rem;
            color: var(--c-txt-tertiary);
            text-decoration: none;
            border-left: 2px solid transparent;
            transition: color 0.15s ease, border-color 0.15s ease;
            cursor: pointer;
        }

        .nav-item:hover {
            color: var(--c-accent);
            text-decoration: none;
        }

        .nav-item.active {
            color: var(--c-accent);
            font-weight: 600;
            border-left-color: var(--c-accent); /* Active marker */
        }

        /* Hierarchy via Type Scale Only (Stage 5.4.5) */
        .nav-item[data-depth="0"] { font-size: 0.95rem; }
        .nav-item[data-depth="1"] { font-size: 0.85rem; color: var(--c-txt-tertiary); }
        .nav-item[data-depth="2"] { font-size: 0.8rem; opacity: 0.9; }

        /* =========================================
           PAPER CONTENT
           ========================================= */
        .paper-column {
            min-width: 0; /* Flexbox safety */
        }

        .paper-surface {
            /* Paper surface logic: On desktop, sits on shared base. 
               We can give it a white bg to distinguish from nav if desired, 
               but brief says "share same base surface context". 
               However, strictly following "Paper surface" usually implies white doc. 
               Let's keep it subtle or transparent per "share surface context" instruction.
               Actually, for readability, white is best. */
            background: var(--c-bg-paper);
            padding: var(--sp-xl); /* Internal paper padding */
            min-height: 80vh;
        }

        @media (max-width: 768px) {
            .paper-surface { padding: var(--sp-md); }
        }

        .section-header {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--c-txt-primary);
            border-bottom: 1px solid var(--c-border-hairline);
            padding-bottom: var(--sp-sm);
            margin-bottom: var(--sp-xl);
            margin-top: var(--sp-xl);
        }
        .section-header:first-child { margin-top: 0; }

        /* Question Node */
        .question-node {
            margin-bottom: var(--sp-xl); /* Top level separation */
            scroll-margin-top: var(--sp-xl);
        }

        /* Child Question spacing */
        .children-container {
            margin-top: var(--sp-md);
            /* Adaptive Indentation (Stage 3) */
            padding-left: var(--sp-lg); 
        }
        @media (max-width: 600px) {
            .children-container { padding-left: var(--sp-sm); }
        }

        /* Question Body */
        .question-body {
            display: flex;
            gap: var(--sp-sm);
            align-items: baseline;
        }

        .q-id {
            font-weight: 600;
            color: var(--c-txt-secondary);
            flex-shrink: 0;
            min-width: 1.5em;
        }

        .q-prompt {
            color: var(--c-txt-primary);
            font-size: 1.1rem; /* Primary anchor */
            line-height: 1.6;
        }

        .q-prompt p { margin-top: 0; margin-bottom: 0.75em; }
        .q-prompt p:last-child { margin-bottom: 0; }

        /* Solution Block */
        .solution-block {
            margin-top: var(--sp-md);
            padding-left: calc(1.5em + var(--sp-sm)); /* Align with prompt text */
        }
        @media (max-width: 600px) {
            .solution-block { padding-left: 0; margin-top: var(--sp-sm); }
        }

        /* Answer */
        .answer-region {
            margin-bottom: var(--sp-md);
            display: flex;
            align-items: baseline;
            gap: var(--sp-sm);
            font-size: 1.05rem;
        }
        
        .answer-label {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--c-txt-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .answer-content {
            color: var(--c-txt-primary);
        }

        /* Disclosure Control */
        .disclosure-control {
            background: none;
            border: none;
            padding: 0;
            margin: 0;
            cursor: pointer;
            color: var(--c-accent);
            font-size: 0.95rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: var(--sp-xs);
            transition: color 0.2s;
        }
        .disclosure-control:hover { color: var(--c-accent-hover); }

        /* Solution Details Region */
        .solution-details {
            margin-top: var(--sp-md);
            display: none; /* Default hidden logic controlled by JS */
            /* Stage 3 permitted wash */
            background-color: var(--c-surface-wash);
            padding: var(--sp-md);
            /* Border radius allowed? No heavy framing. 
               Stage 3: "no heavy borders, no rounded corners" -> implies sharp or very subtle. 
               Keep it clean. */
        }
        
        .solution-details.expanded { display: block; animation: reveal 0.2s ease-out; }

        @keyframes reveal {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Internal Sections (Keep in mind, etc) */
        .sd-section {
            margin-bottom: var(--sp-md);
        }
        .sd-section:last-child { margin-bottom: 0; }

        .sd-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--c-txt-secondary);
            margin-bottom: var(--sp-xs);
            display: block;
        }

        .sd-body {
            font-size: 0.95rem;
            color: var(--c-txt-secondary); /* Subordinate */
            line-height: 1.5;
        }
        
        /* Contrast floor guardrail: Ensure readability */
        .sd-body { color: hsl(var(--hue-teal), 20%, 30%); }

        /* Tables */
        table {
            border-collapse: collapse;
            width: 100%;
            margin: var(--sp-sm) 0;
            font-size: 0.9rem;
        }
        th, td {
            border: 1px solid var(--c-border-hairline);
            padding: var(--sp-sm);
            text-align: left;
        }
        th { font-weight: 600; background: rgba(0,0,0,0.02); }

        /* =========================================
           KaTeX & Markdown Overrides
           ========================================= */
        /* Containment Invariant */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding: 0.5em 0;
            /* Scrollbar hiding for cleaner look */
            scrollbar-width: thin;
        }
        
        /* Inline KaTeX: No background */
        .katex { background: transparent !important; }

        /* Markdown lists */
        .sd-body ul, .sd-body ol { margin-top: 0; padding-left: 1.2em; }
        .sd-body li { margin-bottom: 0.25em; }

        /* =========================================
           COMPONENTS: Top Controls
           ========================================= */
        .paper-select {
            padding: var(--sp-sm);
            font-size: 0.9rem;
            border: 1px solid var(--c-border-hairline);
            border-radius: 4px;
            background: var(--c-bg-paper);
            color: var(--c-txt-primary);
            cursor: pointer;
        }

        .mobile-jump-trigger {
            display: none; /* Desktop default */
            background: none;
            border: 1px solid var(--c-border-hairline);
            padding: var(--sp-xs) var(--sp-sm);
            border-radius: 4px;
            color: var(--c-accent);
            font-weight: 500;
            font-size: 0.9rem;
        }
        @media (max-width: 768px) {
            .mobile-jump-trigger { display: inline-block; }
        }

        /* =========================================
           COMPONENT: Drawer (Mobile)
           ========================================= */
        .drawer-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4);
            z-index: 1000;
            display: none;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .drawer-overlay.open { display: block; opacity: 1; }

        .drawer-content {
            position: fixed;
            top: 0; left: 0; bottom: 0;
            width: 80%;
            max-width: 300px;
            background: var(--c-bg-paper);
            z-index: 1001;
            transform: translateX(-100%);
            transition: transform 0.2s ease-out;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }
        .drawer-overlay.open .drawer-content { transform: translateX(0); }

        .drawer-header {
            padding: var(--sp-md);
            border-bottom: 1px solid var(--c-border-hairline);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .drawer-title { font-weight: 600; }
        .drawer-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--c-txt-secondary); }

        .drawer-nav-area {
            flex: 1;
            overflow-y: auto;
            padding: var(--sp-md);
        }

        /* =========================================
           UTILITY
           ========================================= */
        .hidden { display: none !important; }
        .error-message {
            padding: var(--sp-xl);
            text-align: center;
            color: #d00;
            font-weight: 600;
            background: #fff0f0;
            border: 1px solid #ffcccc;
            margin: var(--sp-xl);
        }
    </style>
</head>
<body>

<div id="app-root" class="app-container">
    <!-- Top Controls -->
    <header class="top-controls">
        <select id="paper-selector" class="paper-select" aria-label="Select Paper">
            <option value="" disabled selected>Loading papers...</option>
        </select>
        <button id="mobile-jump" class="mobile-jump-trigger">Jump to...</button>
    </header>

    <!-- Document Shell -->
    <main class="document-frame-shell">
        <!-- Desktop Nav Rail -->
        <nav class="nav-column" aria-label="Document Navigation">
            <div id="desktop-nav-list" class="nav-list">
                <!-- Injected via JS -->
            </div>
        </nav>

        <!-- Paper Content -->
        <div class="paper-column">
            <div id="paper-surface" class="paper-surface">
                <!-- Injected via JS -->
                <div style="padding: 40px; text-align: center; color: var(--c-txt-tertiary);">
                    Loading paper content...
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Mobile Drawer -->
<div id="drawer-overlay" class="drawer-overlay">
    <div class="drawer-content">
        <div class="drawer-header">
            <span class="drawer-title">Jump to</span>
            <button id="drawer-close" class="drawer-close" aria-label="Close navigation">&times;</button>
        </div>
        <div class="drawer-nav-area">
            <div id="mobile-nav-list" class="nav-list">
                <!-- Injected via JS -->
            </div>
        </div>
    </div>
</div>

<script>
    // =========================================
    // STAGE 0: CONSTANTS (Canonical)
    // =========================================
    const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
    const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

    // =========================================
    // STATE & UTILS
    // =========================================
    let papersData = [];
    let activePaperKey = null;
    let expandedMap = new Set(); // Stores IDs of questions with expanded workings

    // Markdown Renderer Setup (Stage 6 Canonical Config)
    const md = window.markdownit ? window.markdownit({
        html: true,       // Enable inline SVG
        linkify: true,
        breaks: false     // Disable <br> on newlines to protect KaTeX
    }) : null;

    if (md) {
        // Disable escape rule to preserve TeX backslashes
        md.inline.ruler.disable(['escape']);
    }

    // =========================================
    // INIT
    // =========================================
    async function init() {
        try {
            const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
            if (!response.ok) throw new Error("Payload not found");
            const data = await response.json();
            
            if (!data.papers || !Array.isArray(data.papers)) throw new Error("Invalid schema");
            
            papersData = data.papers;
            renderSelector();
            
            // Load first paper by default
            if (papersData.length > 0) {
                loadPaper(papersData[0].key);
            }
        } catch (e) {
            console.error(e);
            document.getElementById('paper-surface').innerHTML = `<div class="error-message">PAPERS PAYLOAD MISSING</div>`;
        }
    }

    // =========================================
    // RENDERING
    // =========================================
    function renderSelector() {
        const select = document.getElementById('paper-selector');
        select.innerHTML = '';
        papersData.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.key;
            opt.textContent = p.label || p.key;
            select.appendChild(opt);
        });
        select.addEventListener('change', (e) => loadPaper(e.target.value));
    }

    function loadPaper(key) {
        const paper = papersData.find(p => p.key === key);
        if (!paper) return;

        activePaperKey = key;
        expandedMap.clear();

        // Default expansion state
        const defaults = paper.defaults || {};
        const expandAll = defaults.expandedAll !== false; // Default true unless false

        // Pre-calculate expansion state if needed, or rely on lazy render
        // For simplicity, we just obey the click. 
        // But to support "expanded by default", we need to know what to expand.
        // We'll handle this at render time using a "data-default-expanded" attribute strategy.

        // Render Content
        const container = document.getElementById('paper-surface');
        container.innerHTML = ''; // Clear

        // Handle Sections vs Flat
        const questionNodes = []; // Flat list for nav generation

        if (paper.sections) {
            paper.sections.forEach((section, idx) => {
                // Section Header
                if (section.label && section.label.trim() !== "") {
                    const secHeader = document.createElement('div');
                    secHeader.className = 'section-header';
                    secHeader.textContent = section.label;
                    container.appendChild(secHeader);
                }
                
                // Render Questions
                if (section.questions) {
                    section.questions.forEach(q => {
                        container.appendChild(renderQuestionNode(q, 0, expandAll));
                        collectNavNodes(q, 0, questionNodes, section.label);
                    });
                }
            });
        } else if (paper.questions) {
            paper.questions.forEach(q => {
                container.appendChild(renderQuestionNode(q, 0, expandAll));
                collectNavNodes(q, 0, questionNodes, null);
            });
        }

        // Render Nav
        renderNavigation(questionNodes, paper.sections);

        // Auto-render Math
        renderMath(container);
    }

    function renderQuestionNode(node, depth, defaultExpand) {
        const wrapper = document.createElement('div');
        wrapper.className = 'question-node';
        wrapper.id = `q-${node.id}`; // Anchor ID

        // Question Body
        const body = document.createElement('div');
        body.className = 'question-body';
        
        const idSpan = document.createElement('div');
        idSpan.className = 'q-id';
        idSpan.textContent = node.id;
        
        const promptDiv = document.createElement('div');
        promptDiv.className = 'q-prompt';
        promptDiv.innerHTML = md ? md.render(node.question || '') : (node.question || '');

        body.appendChild(idSpan);
        body.appendChild(promptDiv);
        wrapper.appendChild(body);

        // Solution Block
        if (node.solutionBlock) {
            const sb = node.solutionBlock;
            const blockDiv = document.createElement('div');
            blockDiv.className = 'solution-block';

            // Answer
            if (sb.answer) {
                const ansDiv = document.createElement('div');
                ansDiv.className = 'answer-region';
                
                const ansLabel = document.createElement('span');
                ansLabel.className = 'answer-label';
                ansLabel.textContent = 'Answer';
                
                const ansContent = document.createElement('span');
                ansContent.className = 'answer-content';
                ansContent.innerHTML = md ? md.renderInline(sb.answer) : sb.answer;

                ansDiv.appendChild(ansLabel);
                ansDiv.appendChild(ansContent);
                blockDiv.appendChild(ansDiv);
            }

            // Solution Details (Show/Hide)
            if (sb.solutionDetails) {
                const sdId = `sd-${node.id}`;
                const isExpanded = defaultExpand;

                // Toggle Control
                const toggleBtn = document.createElement('button');
                toggleBtn.className = 'disclosure-control';
                toggleBtn.setAttribute('aria-expanded', isExpanded);
                toggleBtn.setAttribute('aria-controls', sdId);
                toggleBtn.innerHTML = `<span>${isExpanded ? 'Hide' : 'Show'} working</span> 
                                       <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="transform: ${isExpanded ? 'rotate(180deg)' : 'rotate(0deg)'}; transition: transform 0.2s;"><polyline points="6 9 12 15 18 9"></polyline></svg>`;
                
                // Details Region
                const detailsDiv = document.createElement('div');
                detailsDiv.id = sdId;
                detailsDiv.className = `solution-details ${isExpanded ? 'expanded' : ''}`;

                // --- Details Subsections ---
                const details = sb.solutionDetails;

                // 1. Keep in mind
                if (details.keepInMind) {
                    const div = document.createElement('div');
                    div.className = 'sd-section';
                    div.innerHTML = `<span class="sd-label">Keep in mind</span><div class="sd-body">${md.render(details.keepInMind)}</div>`;
                    detailsDiv.appendChild(div);
                }

                // 2. Formulas used
                if (details.formulasUsed) {
                    const div = document.createElement('div');
                    div.className = 'sd-section';
                    div.innerHTML = `<span class="sd-label">Formulas used</span><div class="sd-body">${md.render(details.formulasUsed)}</div>`;
                    detailsDiv.appendChild(div);
                }

                // 3. Working
                if (details.working) {
                    const div = document.createElement('div');
                    div.className = 'sd-section';
                    div.innerHTML = `<span class="sd-label">Working</span><div class="sd-body">${md.render(details.working)}</div>`;
                    detailsDiv.appendChild(div);
                }

                // 4. Alternative Working
                if (details.alternativeWorking && Array.isArray(details.alternativeWorking)) {
                    details.alternativeWorking.forEach(alt => {
                        const div = document.createElement('div');
                        div.className = 'sd-section';
                        div.innerHTML = `<span class="sd-label">Alternative working</span><div class="sd-body">${md.render(alt)}</div>`;
                        detailsDiv.appendChild(div);
                    });
                }

                // Toggle Event
                toggleBtn.onclick = () => {
                    const wasExpanded = detailsDiv.classList.contains('expanded');
                    if (wasExpanded) {
                        detailsDiv.classList.remove('expanded');
                        toggleBtn.setAttribute('aria-expanded', 'false');
                        toggleBtn.innerHTML = `<span>Show working</span> <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="transform: rotate(0deg); transition: transform 0.2s;"><polyline points="6 9 12 15 18 9"></polyline></svg>`;
                    } else {
                        detailsDiv.classList.add('expanded');
                        toggleBtn.setAttribute('aria-expanded', 'true');
                        toggleBtn.innerHTML = `<span>Hide working</span> <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="transform: rotate(180deg); transition: transform 0.2s;"><polyline points="6 9 12 15 18 9"></polyline></svg>`;
                    }
                };

                blockDiv.appendChild(toggleBtn);
                blockDiv.appendChild(detailsDiv);
            }
            
            wrapper.appendChild(blockDiv);
        }

        // Children Recursion
        if (node.children && node.children.length > 0) {
            const childContainer = document.createElement('div');
            childContainer.className = 'children-container';
            node.children.forEach(child => {
                childContainer.appendChild(renderQuestionNode(child, depth + 1, defaultExpand));
            });
            wrapper.appendChild(childContainer);
        }

        return wrapper;
    }

    // Recursively flatten structure for nav
    function collectNavNodes(node, depth, list, currentSection) {
        list.push({ id: node.id, depth: depth, section: currentSection });
        if (node.children) {
            node.children.forEach(c => collectNavNodes(c, depth + 1, list, currentSection));
        }
    }

    function renderNavigation(nodes, sectionsInfo) {
        const desktopNav = document.getElementById('desktop-nav-list');
        const mobileNav = document.getElementById('mobile-nav-list');
        
        const buildList = (container) => {
            container.innerHTML = '';
            let lastSection = null;

            nodes.forEach(n => {
                // Section Label (Only if non-empty and changed)
                if (n.section && n.section !== lastSection && n.section.trim() !== "") {
                    const secLabel = document.createElement('li');
                    secLabel.className = 'nav-section-label';
                    secLabel.textContent = n.section;
                    container.appendChild(secLabel);
                }
                lastSection = n.section;

                const li = document.createElement('li');
                const a = document.createElement('a');
                a.className = 'nav-item';
                a.textContent = n.id;
                a.dataset.depth = Math.min(n.depth, 2); // Cap styling depth
                a.dataset.targetId = `q-${n.id}`;
                
                a.onclick = (e) => {
                    e.preventDefault();
                    const target = document.getElementById(`q-${n.id}`);
                    if (target) {
                        target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        // Close drawer if mobile
                        document.getElementById('drawer-overlay').classList.remove('open');
                        updateActiveNav(a.dataset.targetId);
                    }
                };
                
                li.appendChild(a);
                container.appendChild(li);
            });
        };

        buildList(desktopNav);
        buildList(mobileNav);

        // Setup Intersection Observer for active state
        setupScrollSpy();
    }

    function renderMath(root) {
        if (window.renderMathInElement) {
            renderMathInElement(root, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false}
                ],
                throwOnError: false
            });
        }
    }

    function setupScrollSpy() {
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    updateActiveNav(entry.target.id);
                }
            });
        }, { rootMargin: '-20% 0px -60% 0px' });

        document.querySelectorAll('.question-node').forEach(n => observer.observe(n));
    }

    function updateActiveNav(targetId) {
        document.querySelectorAll('.nav-item').forEach(el => {
            if (el.dataset.targetId === targetId) el.classList.add('active');
            else el.classList.remove('active');
        });
    }

    // =========================================
    // MOBILE DRAWER LOGIC
    // =========================================
    const drawerOverlay = document.getElementById('drawer-overlay');
    document.getElementById('mobile-jump').onclick = () => {
        drawerOverlay.classList.add('open');
    };
    document.getElementById('drawer-close').onclick = () => {
        drawerOverlay.classList.remove('open');
    };
    drawerOverlay.onclick = (e) => {
        if (e.target === drawerOverlay) drawerOverlay.classList.remove('open');
    };

    // =========================================
    // BOOTSTRAP
    // =========================================
    init();

</script>
</body>
</html>
