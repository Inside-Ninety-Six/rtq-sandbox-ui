<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AD","indexWithinVariant":"277","totalWithinVariant":"440","hueFamily":"","intensityMode":"","primaryHueFamily":"blue","secondaryHueFamily":"pink","dualIntensityMode":"dual_accent_only","timestamp":"2026-01-10T15:00:53.619Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AD&quot;,&quot;indexWithinVariant&quot;:&quot;277&quot;,&quot;totalWithinVariant&quot;:&quot;440&quot;,&quot;hueFamily&quot;:&quot;&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;primaryHueFamily&quot;:&quot;blue&quot;,&quot;secondaryHueFamily&quot;:&quot;pink&quot;,&quot;dualIntensityMode&quot;:&quot;dual_accent_only&quot;,&quot;timestamp&quot;:&quot;2026-01-10T15:00:53.619Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Markdown-it -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/13.0.1/markdown-it.min.js"></script>

    <!-- KaTeX -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js"></script>

    <!-- Configuration: ColorLab D (Dual Accent, Mode: dual_accent_only) -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Surfaces (Neutral / Paper-like)
                        page: 'oklch(0.97 0.005 260)',
                        frame: 'oklch(0.97 0.005 260)',
                        paper: 'oklch(1.0 0 0)',
                        
                        // Text (High Legibility, Neutral)
                        txt: {
                            primary: 'oklch(0.20 0.01 260)',
                            secondary: 'oklch(0.45 0.01 260)',
                            tertiary: 'oklch(0.60 0.01 260)',
                        },

                        // Surfaces (Functional)
                        divider: 'oklch(0.90 0.01 260)', // Hairlines
                        wash: 'oklch(0.98 0.002 260)',   // Solution Details wash

                        // Accents (Dual Hue: Primary=Blue, Secondary=Amber)
                        // Mode: dual_accent_only
                        accent: {
                            primary: 'oklch(0.55 0.12 250)',   // Links, Focus, Disclosure, Nav Marker
                            secondary: 'oklch(0.75 0.11 85)',  // Supplementary role (e.g. Keep in mind marker)
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
                    },
                    spacing: {
                        'nav-w': '240px',
                    }
                }
            }
        }
    </script>

    <style>
        /* Base styles & Invariants */
        body {
            @apply bg-page text-txt-primary antialiased font-sans;
            /* Prevent horizontal scroll on body */
            overflow-x: hidden; 
        }

        /* Hide scrollbar utility */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* KaTeX Overflow Containment Invariant */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding-bottom: 4px; /* Space for scrollbar if needed */
            -webkit-overflow-scrolling: touch;
        }
        
        /* Inline KaTeX Transparency Invariant */
        .katex {
            background-color: transparent !important;
        }

        /* Markdown Table Styles (Minimal) */
        .md-content table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
            font-size: 0.95em;
        }
        .md-content th, .md-content td {
            border: 1px solid theme('colors.divider');
            padding: 0.5rem;
            text-align: left;
        }
        .md-content th {
            font-weight: 600;
            color: theme('colors.txt.primary');
        }

        /* Sticky Nav Persistence */
        .nav-sticky {
            position: sticky;
            top: 0;
            max-height: 100vh;
        }

        /* Focus Styles (Accessibility) */
        :focus-visible {
            outline: 2px solid theme('colors.accent.primary');
            outline-offset: 2px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- STAGE 0: CONSTANTS ---
        // Canonical Source of Truth for Payload Path
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // --- MARKDOWN CONFIGURATION (STAGE 6 BASELINE) ---
        // Authoritative config: html: true, linkify: true, breaks: false.
        const md = window.markdownit ? window.markdownit({
            html: true,
            linkify: true,
            breaks: false 
        }) : null;

        if (md) {
            // Disable escape rule to preserve TeX backslashes
            md.inline.ruler.disable(['escape']);
        }

        const { useState, useEffect, useRef, useMemo } = React;

        // --- ICONS ---
        const IconChevronDown = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m6 9 6 6 6-6"/></svg>
        );
        const IconMenu = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>
        );
        const IconClose = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
        );

        // --- UTILS ---
        // Render markdown content safely
        const MarkdownContent = ({ content, className = "" }) => {
            if (!content) return null;
            const html = md ? md.render(content) : content; // Fallback to raw if MD fails
            
            const containerRef = useRef(null);

            useEffect(() => {
                if (containerRef.current && window.renderMathInElement) {
                    window.renderMathInElement(containerRef.current, {
                        delimiters: [
                            {left: '$$', right: '$$', display: true},
                            {left: '$', right: '$', display: false}
                        ],
                        throwOnError: false
                    });
                }
            }, [html]);

            return (
                <div 
                    ref={containerRef}
                    className={`md-content ${className} prose prose-neutral max-w-none prose-p:my-2 prose-ul:my-2 prose-li:my-0 prose-table:my-2`}
                    dangerouslySetInnerHTML={{ __html: html }} 
                />
            );
        };

        // --- COMPONENTS ---

        // 1. Solution Details Subsections
        const KeepInMind = ({ content }) => (
            <div className="mb-4 group">
                <div className="flex items-center gap-2 mb-1 text-accent-secondary font-semibold text-sm">
                    {/* Subtle marker using Secondary Accent */}
                    <span className="w-1.5 h-1.5 rounded-full bg-accent-secondary"></span>
                    <span>Keep in mind</span>
                </div>
                <MarkdownContent content={content} className="text-txt-primary text-sm/relaxed pl-3.5" />
            </div>
        );

        const FormulasUsed = ({ content }) => (
            <div className="mb-4">
                <div className="mb-1 text-txt-secondary font-semibold text-xs uppercase tracking-wide">
                    Formulas used
                </div>
                <MarkdownContent content={content} className="text-txt-primary text-sm/relaxed" />
            </div>
        );

        const WorkingBlock = ({ label, content, isAlt = false }) => (
            <div className={`mb-6 ${isAlt ? 'pt-4 border-t border-divider' : ''}`}>
                {label && (
                    <div className="mb-2 text-txt-secondary font-semibold text-sm">
                        {label}
                    </div>
                )}
                <MarkdownContent content={content} className="text-txt-primary text-base/relaxed" />
            </div>
        );

        // 2. Solution Block (Answer + Toggle + Details)
        const SolutionBlock = ({ answer, details, defaultExpanded }) => {
            const hasDetails = !!details;
            // State: Collapsed/Expanded. Default comes from paper prop.
            const [expanded, setExpanded] = useState(defaultExpanded);

            if (!answer && !hasDetails) return null;

            return (
                <div className="mt-4">
                    {/* Answer (Visible by default if present) */}
                    {answer && (
                        <div className="mb-3">
                            <span className="text-txt-secondary font-bold text-sm mr-2 block mb-1">Answer</span>
                            <div className="text-txt-primary text-lg">
                                <MarkdownContent content={answer} />
                            </div>
                        </div>
                    )}

                    {/* Disclosure Control */}
                    {hasDetails && (
                        <div className="mt-3">
                            <div className="flex items-center">
                                <button 
                                    onClick={() => setExpanded(!expanded)}
                                    className="group flex items-center gap-1.5 text-accent-primary hover:text-accent-primary/80 transition-colors text-sm font-medium focus:outline-none focus-visible:ring-2 focus-visible:ring-accent-primary rounded px-1 -ml-1 py-1"
                                    aria-expanded={expanded}
                                >
                                    <span>{expanded ? "Hide working" : "Show working"}</span>
                                    <IconChevronDown className={`transition-transform duration-200 w-4 h-4 ${expanded ? "rotate-180" : ""}`} />
                                </button>
                            </div>

                            {/* Expanded Region */}
                            {expanded && (
                                <div className="mt-3 pl-4 border-l-2 border-divider bg-wash/50 py-3 pr-2 rounded-r-sm animate-in fade-in slide-in-from-top-1 duration-200">
                                    {/* Order: Keep in mind -> Formulas -> Working -> Alt Working */}
                                    {details.keepInMind && <KeepInMind content={details.keepInMind} />}
                                    {details.formulasUsed && <FormulasUsed content={details.formulasUsed} />}
                                    {details.working && <WorkingBlock label="Working" content={details.working} />}
                                    
                                    {details.alternativeWorking && details.alternativeWorking.map((alt, idx) => (
                                        <WorkingBlock 
                                            key={idx} 
                                            label={idx === 0 && !details.working ? "Working" : "Alternative working"} 
                                            content={alt} 
                                            isAlt={true} 
                                        />
                                    ))}
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        // 3. Question Node (Recursive)
        const QuestionNode = ({ node, depth = 0, defaultExpanded }) => {
            // Determine nesting separation
            const isTopLevel = depth === 0;
            const separationClass = isTopLevel ? "mb-12" : "mb-6";
            
            // Indentation for children (visual hierarchy via spacing)
            // On mobile, reduce indentation to preserve width
            const childContainerClass = depth > 0 ? "pl-3 md:pl-6 border-l border-transparent" : "";

            const hasSolutionBlock = !!node.solutionBlock;
            const answer = node.solutionBlock?.answer;
            const details = node.solutionBlock?.solutionDetails;

            return (
                <div id={`q-${node.id}`} className={`question-node scroll-mt-24 ${separationClass}`}>
                    {/* Question Body */}
                    <div className="group relative">
                        <div className="flex gap-3 md:gap-4">
                            {/* Identifier */}
                            <div className="shrink-0 w-8 md:w-10 text-txt-secondary font-medium text-base pt-0.5 select-none" aria-hidden="true">
                                {node.id}
                            </div>
                            
                            {/* Prompt + Solution Wrapper */}
                            <div className="flex-1 min-w-0">
                                {/* Prompt */}
                                <div className="text-txt-primary font-medium text-lg leading-relaxed mb-1">
                                    <MarkdownContent content={node.question} />
                                </div>

                                {/* Solution Block */}
                                {hasSolutionBlock && (
                                    <SolutionBlock 
                                        answer={answer} 
                                        details={details} 
                                        defaultExpanded={defaultExpanded}
                                    />
                                )}
                            </div>
                        </div>
                    </div>

                    {/* Recursive Children */}
                    {node.children && node.children.length > 0 && (
                        <div className={`mt-4 ${childContainerClass}`}>
                            {node.children.map(child => (
                                <QuestionNode 
                                    key={child.id} 
                                    node={child} 
                                    depth={depth + 1} 
                                    defaultExpanded={defaultExpanded}
                                />
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        // 4. Navigation Component (Desktop Rail + Mobile Drawer Content)
        const NavigationList = ({ items, sections, onItemClick }) => {
            const renderItem = (id, label) => (
                <button
                    key={id}
                    onClick={() => {
                        const el = document.getElementById(`q-${id}`);
                        if (el) {
                            el.scrollIntoView({ behavior: 'smooth' });
                            onItemClick && onItemClick();
                        }
                    }}
                    className="group flex items-center w-full text-left py-1.5 px-2 rounded hover:bg-black/5 focus:outline-none focus-visible:ring-2 focus-visible:ring-accent-primary transition-colors"
                >
                    <span className="text-txt-secondary group-hover:text-txt-primary font-medium text-sm transition-colors">
                        {id}
                    </span>
                </button>
            );

            // Flatten logic for simple list rendering within sections
            if (sections && sections.length > 0) {
                return (
                    <div className="space-y-6 pb-12">
                        {sections.map((section, idx) => (
                            <div key={idx}>
                                {section.label && section.label.trim() !== "" && (
                                    <div className="px-2 mb-2 text-xs font-bold text-txt-tertiary uppercase tracking-wider select-none">
                                        {section.label}
                                    </div>
                                )}
                                <div className="space-y-0.5">
                                    {section.questions.map(q => renderItem(q.id))}
                                </div>
                            </div>
                        ))}
                    </div>
                );
            }

            // Flat paper
            return (
                <div className="space-y-0.5 pb-12">
                    {items.map(q => renderItem(q.id))}
                </div>
            );
        };

        // 5. Main Application Shell
        const App = () => {
            const [payload, setPayload] = useState(null);
            const [status, setStatus] = useState('loading'); // loading, success, error
            const [currentPaperKey, setCurrentPaperKey] = useState(null);
            const [mobileNavOpen, setMobileNavOpen] = useState(false);

            // Fetch Payload
            useEffect(() => {
                fetch(RTQ_PAPERS_PAYLOAD_PATH)
                    .then(res => {
                        if (!res.ok) throw new Error("Failed to load");
                        return res.json();
                    })
                    .then(data => {
                        setPayload(data);
                        if (data.papers && data.papers.length > 0) {
                            setCurrentPaperKey(data.papers[0].key);
                        }
                        setStatus('success');
                    })
                    .catch(err => {
                        console.error(err);
                        setStatus('error');
                    });
            }, []);

            // Handle Paper Switching
            const currentPaper = useMemo(() => {
                if (!payload || !currentPaperKey) return null;
                return payload.papers.find(p => p.key === currentPaperKey);
            }, [payload, currentPaperKey]);

            // Defaults
            const expandedAll = currentPaper?.defaults?.expandedAll !== false; // Default true unless explicitly false

            if (status === 'error') {
                return (
                    <div className="flex items-center justify-center min-h-screen text-txt-secondary font-medium">
                        PAPERS PAYLOAD MISSING
                    </div>
                );
            }

            if (status === 'loading') {
                return <div className="h-screen bg-page"></div>;
            }

            // Render Lists Generation (Helpers)
            const getQuestionsList = (paper) => {
                if (paper.sections) return []; // Handled by sections
                return paper.questions || [];
            };

            return (
                <div className="min-h-screen flex flex-col md:flex-row max-w-7xl mx-auto bg-frame shadow-sm border-x border-divider/50 md:my-4 md:rounded-sm overflow-hidden">
                    
                    {/* Mobile Header */}
                    <div className="md:hidden sticky top-0 z-20 bg-frame border-b border-divider px-4 py-3 flex items-center justify-between">
                        <div className="font-medium text-txt-primary">
                            {currentPaper?.label || "Paper"}
                        </div>
                        <button 
                            onClick={() => setMobileNavOpen(true)}
                            className="flex items-center gap-2 text-sm font-medium text-accent-primary focus:outline-none focus-visible:ring-2 focus-visible:ring-accent-primary rounded px-2 py-1"
                        >
                            <span>Jump to</span>
                            <IconMenu className="w-5 h-5" />
                        </button>
                    </div>

                    {/* Mobile Navigation Drawer */}
                    {mobileNavOpen && (
                        <div className="fixed inset-0 z-50 flex justify-end md:hidden" role="dialog" aria-modal="true">
                            {/* Scrim */}
                            <div 
                                className="absolute inset-0 bg-black/20 backdrop-blur-sm transition-opacity" 
                                onClick={() => setMobileNavOpen(false)}
                            ></div>
                            
                            {/* Drawer Content */}
                            <div className="relative w-64 bg-frame h-full shadow-xl flex flex-col animate-in slide-in-from-right duration-200">
                                <div className="p-4 border-b border-divider flex items-center justify-between">
                                    <h2 className="text-sm font-bold text-txt-secondary uppercase tracking-wide">Jump to</h2>
                                    <button 
                                        onClick={() => setMobileNavOpen(false)}
                                        className="text-txt-secondary hover:text-txt-primary p-1 focus:outline-none focus-visible:ring-2 focus-visible:ring-accent-primary rounded"
                                    >
                                        <IconClose />
                                    </button>
                                </div>
                                <div className="flex-1 overflow-y-auto p-4">
                                    <NavigationList 
                                        items={getQuestionsList(currentPaper)}
                                        sections={currentPaper.sections}
                                        onItemClick={() => setMobileNavOpen(false)}
                                    />
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Desktop Navigation Rail */}
                    <div className="hidden md:block w-nav-w shrink-0 border-r border-divider bg-frame">
                        <div className="sticky top-0 h-screen overflow-y-auto no-scrollbar py-8 px-6">
                            {/* Paper Selector */}
                            <div className="mb-8">
                                <label htmlFor="paper-select" className="sr-only">Select Paper</label>
                                <div className="relative">
                                    <select 
                                        id="paper-select"
                                        value={currentPaperKey} 
                                        onChange={(e) => setCurrentPaperKey(e.target.value)}
                                        className="w-full appearance-none bg-white border border-divider hover:border-accent-primary/50 text-txt-primary text-sm font-medium rounded py-2 pl-3 pr-8 focus:outline-none focus:ring-2 focus:ring-accent-primary transition-shadow cursor-pointer shadow-sm"
                                    >
                                        {payload.papers.map(p => (
                                            <option key={p.key} value={p.key}>{p.label}</option>
                                        ))}
                                    </select>
                                    <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-txt-secondary">
                                        <IconChevronDown className="w-4 h-4" />
                                    </div>
                                </div>
                            </div>

                            {/* Nav List */}
                            <nav aria-label="Paper navigation">
                                <NavigationList 
                                    items={getQuestionsList(currentPaper)} 
                                    sections={currentPaper.sections}
                                />
                            </nav>
                        </div>
                    </div>

                    {/* Paper Content Region */}
                    <main className="flex-1 bg-paper min-h-[calc(100vh-60px)] md:min-h-auto">
                        <div className="max-w-3xl mx-auto py-8 px-4 md:px-12 md:py-12">
                            {currentPaper?.sections ? (
                                // Sectioned Paper
                                currentPaper.sections.map((section, sIdx) => (
                                    <div key={sIdx} className="mb-16">
                                        {/* Section Header (Divider-like) */}
                                        {section.label && section.label.trim() !== "" && (
                                            <div className="flex items-center gap-4 mb-8">
                                                <h2 className="text-xl font-bold text-txt-primary">{section.label}</h2>
                                                <div className="h-px bg-divider flex-1"></div>
                                            </div>
                                        )}
                                        {/* Questions */}
                                        <div>
                                            {section.questions.map(q => (
                                                <QuestionNode 
                                                    key={q.id} 
                                                    node={q} 
                                                    defaultExpanded={expandedAll} 
                                                />
                                            ))}
                                        </div>
                                    </div>
                                ))
                            ) : (
                                // Flat Paper
                                <div>
                                    {currentPaper?.questions.map(q => (
                                        <QuestionNode 
                                            key={q.id} 
                                            node={q} 
                                            defaultExpanded={expandedAll} 
                                        />
                                    ))}
                                </div>
                            )}

                            {/* End of Paper Spacer */}
                            <div className="h-32 flex items-center justify-center">
                                <div className="w-16 h-px bg-divider"></div>
                            </div>
                        </div>
                    </main>

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
