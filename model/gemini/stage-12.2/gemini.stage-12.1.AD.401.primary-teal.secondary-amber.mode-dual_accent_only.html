<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AD","indexWithinVariant":"401","totalWithinVariant":"440","hueFamily":"","intensityMode":"","primaryHueFamily":"teal","secondaryHueFamily":"amber","dualIntensityMode":"dual_accent_only","timestamp":"2026-01-11T00:24:42.155Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AD&quot;,&quot;indexWithinVariant&quot;:&quot;401&quot;,&quot;totalWithinVariant&quot;:&quot;440&quot;,&quot;hueFamily&quot;:&quot;&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;primaryHueFamily&quot;:&quot;teal&quot;,&quot;secondaryHueFamily&quot;:&quot;amber&quot;,&quot;dualIntensityMode&quot;:&quot;dual_accent_only&quot;,&quot;timestamp&quot;:&quot;2026-01-11T00:24:42.155Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer (Stage 6 Baseline)</title>

    <!-- 1. Tailwind CSS (Prototyping) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 2. Fonts (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- 3. KaTeX (No Integrity per Stage 6.0.7b) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js"></script>

    <!-- 4. Markdown-it (No Integrity) -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@13.0.1/dist/markdown-it.min.js"></script>

    <script>
        // --- ColorLab D Configuration (Add-on v0.1.0) ---
        // Mode: dual_accent_only (Light Mode)
        // Primary Hue: Blue (approx 260)
        // Secondary Hue: Amber (approx 85)
        
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        // Semantic Palette Mapping (OKLCH via CSS variables)
                        page: 'var(--col-page)',
                        paper: 'var(--col-paper)',
                        frame: 'var(--col-frame)',
                        
                        // Text hierarchy
                        tprimary: 'var(--col-text-pri)',
                        tsecondary: 'var(--col-text-sec)',
                        
                        // Accents (Primary Hue)
                        primary: 'var(--col-acc-pri)', // Link, Focus
                        
                        // Accents (Secondary Hue)
                        secondary: 'var(--col-acc-sec)', // Supplementary role
                        
                        // Lines/Washes
                        line: 'var(--col-line)',
                        wash: 'var(--col-wash)',
                    }
                }
            }
        }
    </script>

    <style>
        /* --- ColorLab D: Mode 1 (dual_accent_only) --- */
        /* Light Mode Only. Constraints: Surfaces C <= 0.015, Text C <= 0.010 */
        :root {
            /* Hues */
            --hue-pri: 260; /* Blue */
            --hue-sec: 85;  /* Amber */

            /* Surfaces (Neutral-ish) */
            --col-page: oklch(0.97 0.005 var(--hue-pri));
            --col-frame: oklch(0.97 0.005 var(--hue-pri)); /* Shared surface context on desktop */
            --col-paper: oklch(1.0 0 0); /* White */
            --col-wash: oklch(0.98 0.008 var(--hue-pri));

            /* Text (High legibility, restrained C) */
            --col-text-pri: oklch(0.20 0.01 var(--hue-pri));
            --col-text-sec: oklch(0.45 0.01 var(--hue-pri));

            /* Lines */
            --col-line: oklch(0.92 0.005 var(--hue-pri));

            /* Accents */
            /* Primary (Links, Focus, Active Nav) - C [0.08..0.14] */
            --col-acc-pri: oklch(0.55 0.14 var(--hue-pri));
            
            /* Secondary (Supplementary) - C [0.06..0.12] */
            --col-acc-sec: oklch(0.65 0.12 var(--hue-sec));
        }

        /* --- Layout & Scroll Handling --- */
        html, body {
            height: 100%;
            margin: 0;
            background-color: var(--col-page);
            color: var(--col-text-pri);
            overflow-y: scroll; /* Single vertical scroll */
            overflow-x: hidden; /* Prevent horizontal scroll */
        }

        /* Hide scrollbar for Nav (Cross-browser) */
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* --- KaTeX Containment Invariant --- */
        /* Block-level math containers handle overflow internally */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 4px; /* Space for scrollbar if needed */
            margin: 0.5em 0;
        }
        /* Inline math - transparent, no background */
        .katex {
            background-color: transparent !important;
        }

        /* --- Typography & Markdown --- */
        .md-content p {
            margin-bottom: 0.75em;
            line-height: 1.6;
        }
        .md-content p:last-child {
            margin-bottom: 0;
        }
        .md-content ul {
            list-style-type: disc;
            padding-left: 1.25em;
            margin-bottom: 0.75em;
        }
        .md-content ol {
            list-style-type: decimal;
            padding-left: 1.25em;
            margin-bottom: 0.75em;
        }
        /* Markdown Tables - Minimal */
        .md-content table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 0.5em;
            margin-bottom: 0.75em;
            font-size: 0.95em;
        }
        .md-content th {
            text-align: left;
            font-weight: 600;
            border-bottom: 1px solid var(--col-line);
            padding: 0.5em 0.25em;
        }
        .md-content td {
            border-bottom: 1px solid var(--col-line);
            padding: 0.5em 0.25em;
            vertical-align: top;
        }
        .md-content tr:last-child td {
            border-bottom: none;
        }

        /* --- Focus Styles (ColorLab D - Primary Accent) --- */
        :focus-visible {
            outline: 2px solid var(--col-acc-pri);
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* --- Animations --- */
        .reveal-anim {
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            max-height: 2000px; /* Arbitrary large max */
            opacity: 1;
            overflow: hidden;
        }
        .reveal-anim.collapsed {
            max-height: 0;
            opacity: 0;
        }

        /* --- Print/PDF tweaks if needed --- */
        @media print {
            .no-print { display: none; }
            body { background: white; }
        }
    </style>
</head>
<body class="font-sans antialiased selection:bg-primary/10 selection:text-primary">

    <!-- Top Controls Region -->
    <div id="top-controls" class="w-full flex justify-center bg-page border-b border-line sticky top-0 z-30">
        <div class="w-full max-w-6xl flex items-center justify-between px-4 sm:px-6 py-3 h-14">
            
            <!-- Paper Selector -->
            <div class="flex items-center gap-3">
                <label for="paper-select" class="text-sm font-medium text-tsecondary">Paper</label>
                <select id="paper-select" class="bg-paper border border-line rounded-md text-sm text-tprimary py-1 px-2 focus:border-primary focus:ring-0 cursor-pointer">
                    <option value="">Loading...</option>
                </select>
            </div>

            <!-- Mobile Jump To Trigger -->
            <button id="mobile-jump-trigger" class="lg:hidden text-sm font-medium text-primary hover:text-primary/80 focus:outline-none flex items-center gap-1">
                <span>Jump to</span>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
        </div>
    </div>

    <!-- Document Frame Shell -->
    <div class="w-full min-h-[calc(100vh-3.5rem)] flex justify-center bg-frame">
        <div class="w-full max-w-6xl grid grid-cols-1 lg:grid-cols-[240px_1fr] gap-0 lg:gap-8 px-0 lg:px-6 relative">

            <!-- Navigation Rail (Desktop) -->
            <nav id="desktop-nav" class="hidden lg:block sticky top-14 h-[calc(100vh-3.5rem)] overflow-y-auto no-scrollbar py-8 pl-1 pr-4 border-r border-transparent">
                <!-- Injected via JS -->
            </nav>

            <!-- Paper Content Region -->
            <main id="paper-region" class="w-full min-w-0 py-6 lg:py-8 px-4 sm:px-6 lg:px-0 pb-32">
                <!-- Injected via JS -->
                <div id="paper-content" class="flex flex-col gap-12">
                    <div class="animate-pulse flex space-x-4">
                        <div class="flex-1 space-y-4 py-1">
                            <div class="h-4 bg-line rounded w-3/4"></div>
                            <div class="space-y-2">
                                <div class="h-4 bg-line rounded"></div>
                                <div class="h-4 bg-line rounded w-5/6"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

        </div>
    </div>

    <!-- Mobile Drawer (Navigation) -->
    <div id="mobile-drawer-backdrop" class="fixed inset-0 bg-black/20 z-40 hidden transition-opacity opacity-0" aria-hidden="true"></div>
    <div id="mobile-drawer" class="fixed inset-y-0 right-0 z-50 w-64 bg-paper shadow-xl transform translate-x-full transition-transform duration-300 ease-out flex flex-col" aria-hidden="true">
        <div class="flex items-center justify-between px-4 py-3 border-b border-line">
            <h2 class="text-sm font-medium text-tsecondary uppercase tracking-wide">Jump to</h2>
            <button id="drawer-close" class="text-tsecondary hover:text-tprimary p-1">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <div id="drawer-nav-list" class="flex-1 overflow-y-auto p-4 space-y-1">
            <!-- Injected via JS -->
        </div>
    </div>

    <!-- JavaScript Logic -->
    <script>
        // --- STAGE 0: CONSTANTS (Canonical) ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // --- State Management ---
        const state = {
            papers: [],
            currentPaperId: null,
            expandedStates: {}, // Map<questionId, boolean>
            currentNavId: null
        };

        // --- Markdown & KaTeX Setup ---
        const md = window.markdownit ? window.markdownit({
            html: true,
            linkify: true,
            breaks: false // Must stay false per Stage 6
        }) : null;

        if (md) {
            // Disable inline escape to preserve TeX backslashes
            md.inline.ruler.disable(['escape']);
        }

        // --- Fetch & Init ---
        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Payload missing");
                const payload = await response.json();
                
                state.papers = payload.papers || [];
                
                if (state.papers.length === 0) {
                    renderError("No papers found in payload.");
                    return;
                }

                populatePaperSelector();
                
                // Select first paper by default
                switchPaper(state.papers[0].key);

            } catch (err) {
                console.error(err);
                renderError("PAPERS PAYLOAD MISSING");
            }
        }

        function renderError(msg) {
            const container = document.getElementById('paper-content');
            container.innerHTML = `<div class="p-8 text-center text-tsecondary font-medium border border-dashed border-line rounded">${msg}</div>`;
            document.getElementById('paper-select').innerHTML = '<option>Error</option>';
        }

        // --- Paper Selection ---
        function populatePaperSelector() {
            const select = document.getElementById('paper-select');
            select.innerHTML = '';
            state.papers.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.key;
                opt.textContent = p.label || p.key;
                select.appendChild(opt);
            });
            select.addEventListener('change', (e) => switchPaper(e.target.value));
        }

        function switchPaper(paperKey) {
            const paper = state.papers.find(p => p.key === paperKey);
            if (!paper) return;

            state.currentPaperId = paperKey;
            state.expandedStates = {}; // Reset expansion states
            
            // Set defaults
            const expandAll = paper.defaults?.expandedAll !== false;
            
            // Render Content
            const container = document.getElementById('paper-content');
            container.innerHTML = ''; // Clear

            // Handle Sections vs Flat
            let questionList = [];
            let navStructure = [];

            if (paper.sections) {
                // Sectioned Paper
                paper.sections.forEach(section => {
                    // Create section header block if label exists
                    if (section.label && section.label.trim().length > 0) {
                        const secHeader = document.createElement('div');
                        secHeader.className = "pb-2 pt-8 mb-4 border-b border-line text-lg font-semibold text-tprimary";
                        secHeader.textContent = section.label; // Plain text per brief
                        // Only add header if not empty. 
                        // Note: Brief says section surface is optional, headers are dividers.
                        // Impl: Simple header text + spacing.
                        // We push a "Section Node" to render list, but brief says sections are separators.
                        // Render structure:
                        // Section Header
                        // Questions...
                        container.appendChild(secHeader);
                        
                        navStructure.push({ type: 'section', label: section.label });
                    }
                    
                    section.questions.forEach(q => {
                        container.appendChild(renderQuestionNode(q, 0, expandAll));
                        navStructure.push({ type: 'question', id: q.id, label: q.id });
                    });
                });
            } else if (paper.questions) {
                // Flat Paper
                paper.questions.forEach(q => {
                    container.appendChild(renderQuestionNode(q, 0, expandAll));
                    navStructure.push({ type: 'question', id: q.id, label: q.id });
                });
            }

            // Post-render: KaTeX
            renderMathInElement(container, {
                delimiters: [
                    {left: "$$", right: "$$", display: true},
                    {left: "$", right: "$", display: false}
                ],
                throwOnError: false,
                output: 'html' // Ensure accessible mathml isn't breaking layout
            });

            // Render Nav
            renderNavigation(navStructure);
            
            // Scroll to top
            window.scrollTo(0, 0);
        }

        // --- Render Logic (Recursive) ---
        function renderQuestionNode(node, depth, defaultExpanded) {
            const wrapper = document.createElement('div');
            wrapper.className = `question-node flex flex-col ${depth === 0 ? 'mb-12' : 'mb-6 mt-4'}`;
            wrapper.id = `q-${node.id}`; // Anchor

            // 1. Question Body
            const bodyDiv = document.createElement('div');
            bodyDiv.className = "flex flex-col gap-1";

            // Identifier
            const idSpan = document.createElement('span');
            idSpan.className = "text-sm font-semibold text-tsecondary block mb-1";
            idSpan.textContent = node.id; // Plain identifier
            bodyDiv.appendChild(idSpan);

            // Prompt (Markdown)
            const promptDiv = document.createElement('div');
            promptDiv.className = "text-lg text-tprimary leading-relaxed md-content";
            promptDiv.innerHTML = md ? md.render(node.question || "") : (node.question || "");
            bodyDiv.appendChild(promptDiv);

            wrapper.appendChild(bodyDiv);

            // 2. Solution Block (Optional)
            if (node.solutionBlock) {
                const sb = node.solutionBlock;
                const solBlockDiv = document.createElement('div');
                solBlockDiv.className = "mt-4 flex flex-col gap-4"; // Spacing from question

                // A. Answer (Optional)
                if (sb.answer) {
                    const ansDiv = document.createElement('div');
                    ansDiv.className = "flex flex-col gap-1";
                    
                    const ansLabel = document.createElement('span');
                    ansLabel.className = "text-xs font-bold uppercase tracking-wide text-tsecondary";
                    ansLabel.textContent = "Answer";
                    ansDiv.appendChild(ansLabel);

                    const ansContent = document.createElement('div');
                    ansContent.className = "text-base font-medium text-tprimary md-content";
                    ansContent.innerHTML = md ? md.render(sb.answer) : sb.answer;
                    ansDiv.appendChild(ansContent);

                    solBlockDiv.appendChild(ansDiv);
                }

                // B. Solution Details (Optional)
                if (sb.solutionDetails) {
                    const sd = sb.solutionDetails;
                    const sdId = `sd-${node.id}`;
                    
                    // Determine initial state
                    // If paper default is expanded, expand. Unless overridden? Brief says check paper.defaults
                    let isExpanded = defaultExpanded;
                    state.expandedStates[node.id] = isExpanded;

                    // Disclosure Control
                    const toggleBtn = document.createElement('button');
                    toggleBtn.className = "text-left text-sm font-medium text-primary hover:text-primary/80 focus:outline-none flex items-center gap-2 mt-2 w-max";
                    toggleBtn.setAttribute('aria-expanded', isExpanded);
                    toggleBtn.setAttribute('aria-controls', sdId);
                    
                    const updateToggleText = () => {
                        const showing = state.expandedStates[node.id];
                        toggleBtn.innerHTML = `
                            <span>${showing ? "Hide working" : "Show working"}</span>
                            <svg class="w-4 h-4 transform transition-transform ${showing ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        `;
                    };
                    updateToggleText();

                    // Solution Details Region
                    const sdRegion = document.createElement('div');
                    sdRegion.id = sdId;
                    sdRegion.className = `reveal-anim flex flex-col gap-6 pl-4 border-l-2 border-line bg-wash rounded-r-sm ${isExpanded ? '' : 'collapsed'}`;
                    // Added subtle padding/border/bg per allowed demarcation under density
                    if (isExpanded) sdRegion.style.paddingTop = '1rem';
                    if (isExpanded) sdRegion.style.paddingBottom = '1rem';

                    // Internal Content
                    const renderSection = (label, markdown, isList = false) => {
                        if (!markdown) return null;
                        const block = document.createElement('div');
                        block.className = "flex flex-col gap-1";
                        const lbl = document.createElement('span');
                        lbl.className = "text-xs font-bold text-tsecondary uppercase tracking-wide";
                        lbl.textContent = label;
                        block.appendChild(lbl);
                        const body = document.createElement('div');
                        body.className = "text-sm text-tsecondary leading-relaxed md-content"; // Subordinate text
                        body.innerHTML = md ? md.render(markdown) : markdown;
                        block.appendChild(body);
                        return block;
                    };

                    // Keep in mind
                    const kim = renderSection("Keep in mind", sd.keepInMind);
                    if (kim) sdRegion.appendChild(kim);

                    // Formulas
                    const formulas = renderSection("Formulas used", sd.formulasUsed);
                    if (formulas) sdRegion.appendChild(formulas);

                    // Working
                    const working = renderSection("Working", sd.working);
                    if (working) sdRegion.appendChild(working);

                    // Alt working (Array)
                    if (sd.alternativeWorking && Array.isArray(sd.alternativeWorking)) {
                        sd.alternativeWorking.forEach(alt => {
                            const altBlock = renderSection("Alternative working", alt);
                            if (altBlock) sdRegion.appendChild(altBlock);
                        });
                    }

                    // Toggle Logic
                    toggleBtn.onclick = () => {
                        const nowExpanded = !state.expandedStates[node.id];
                        state.expandedStates[node.id] = nowExpanded;
                        
                        if (nowExpanded) {
                            sdRegion.classList.remove('collapsed');
                            sdRegion.style.paddingTop = '1rem';
                            sdRegion.style.paddingBottom = '1rem';
                        } else {
                            sdRegion.classList.add('collapsed');
                            // Wait for anim to clear padding? Simple CSS handles visibility, but padding remains if not careful.
                            // For simplicity in prototype, keep padding on class or animate max-height.
                            // With max-height, padding needs to be inside the wrapper or handled.
                            // Let's rely on collapsed class doing standard hide.
                            sdRegion.style.paddingTop = '0';
                            sdRegion.style.paddingBottom = '0';
                        }
                        
                        toggleBtn.setAttribute('aria-expanded', nowExpanded);
                        updateToggleText();
                    };

                    solBlockDiv.appendChild(toggleBtn);
                    solBlockDiv.appendChild(sdRegion);
                }

                wrapper.appendChild(solBlockDiv);
            }

            // 3. Children (Recursion)
            if (node.children && node.children.length > 0) {
                const childContainer = document.createElement('div');
                childContainer.className = "ml-0 pl-4 mt-4 border-l border-transparent"; // Indentation via padding only (Stage 3)
                // Actually Stage 3 allows Indentation (Spacing)
                
                node.children.forEach(child => {
                    childContainer.appendChild(renderQuestionNode(child, depth + 1, defaultExpanded));
                });
                wrapper.appendChild(childContainer);
            }

            return wrapper;
        }

        // --- Navigation Rendering ---
        function renderNavigation(structure) {
            const desktopNav = document.getElementById('desktop-nav');
            const mobileNavList = document.getElementById('drawer-nav-list');
            
            const createNavHTML = (isMobile) => {
                const div = document.createElement('div');
                div.className = "flex flex-col gap-1";

                structure.forEach(item => {
                    if (item.type === 'section') {
                        const sec = document.createElement('div');
                        sec.className = "mt-6 mb-2 text-xs font-bold text-tsecondary uppercase tracking-wider select-none";
                        sec.textContent = item.label;
                        div.appendChild(sec);
                    } else {
                        const btn = document.createElement('button');
                        btn.className = `text-left text-sm py-1 px-2 rounded-sm transition-colors nav-item-${item.id}`;
                        // Hierarchy via type scale/quietness?
                        // If ID contains brackets (e.g. (a)), it's a sub.
                        // Rough heuristic for prototype: length > 3 implies sub? Or strictly use tree logic?
                        // Since structure is flattened here, we don't know depth easily without passing it.
                        // Brief says: "Hierarchy expressed only via typographic scale/quietness while keeping same left edge."
                        // We'll keep it simple: tsecondary for all, active becomes tprimary+bold.
                        
                        btn.classList.add("text-tsecondary", "hover:text-tprimary", "hover:bg-black/5");
                        btn.textContent = item.label;
                        
                        btn.onclick = () => {
                            const el = document.getElementById(`q-${item.id}`);
                            if (el) {
                                // Smooth scroll
                                const offset = 80; // top header
                                const bodyRect = document.body.getBoundingClientRect().top;
                                const elementRect = el.getBoundingClientRect().top;
                                const elementPosition = elementRect - bodyRect;
                                const offsetPosition = elementPosition - offset;

                                window.scrollTo({
                                    top: offsetPosition,
                                    behavior: "smooth"
                                });

                                if (isMobile) closeDrawer();
                            }
                        };
                        div.appendChild(btn);
                    }
                });
                return div;
            };

            desktopNav.innerHTML = '';
            desktopNav.appendChild(createNavHTML(false));

            mobileNavList.innerHTML = '';
            mobileNavList.appendChild(createNavHTML(true));

            // Setup Intersection Observer for Active State
            setupScrollSpy(structure);
        }

        function setupScrollSpy(structure) {
            const ids = structure.filter(i => i.type === 'question').map(i => i.id);
            
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        setActiveNav(entry.target.id.replace('q-', ''));
                    }
                });
            }, {
                rootMargin: '-20% 0px -60% 0px' // Active zone near top
            });

            ids.forEach(id => {
                const el = document.getElementById(`q-${id}`);
                if (el) observer.observe(el);
            });
        }

        function setActiveNav(id) {
            if (state.currentNavId === id) return;
            
            // Clear old
            if (state.currentNavId) {
                document.querySelectorAll(`.nav-item-${state.currentNavId}`).forEach(el => {
                    el.classList.remove('font-bold', 'text-primary'); // Primary color allowed for active nav per Stage 5.4.3 Override
                    el.classList.add('text-tsecondary');
                });
            }

            // Set new
            state.currentNavId = id;
            document.querySelectorAll(`.nav-item-${id}`).forEach(el => {
                el.classList.remove('text-tsecondary');
                el.classList.add('font-bold', 'text-primary');
            });
        }

        // --- Mobile Drawer Logic ---
        const drawer = document.getElementById('mobile-drawer');
        const backdrop = document.getElementById('mobile-drawer-backdrop');
        const jumpTrigger = document.getElementById('mobile-jump-trigger');
        const closeBtn = document.getElementById('drawer-close');

        function openDrawer() {
            drawer.classList.remove('translate-x-full');
            backdrop.classList.remove('hidden');
            setTimeout(() => backdrop.classList.remove('opacity-0'), 10);
            document.body.style.overflow = 'hidden'; // Lock scroll
        }

        function closeDrawer() {
            drawer.classList.add('translate-x-full');
            backdrop.classList.add('opacity-0');
            setTimeout(() => backdrop.classList.add('hidden'), 300);
            document.body.style.overflow = ''; // Unlock
        }

        jumpTrigger.addEventListener('click', openDrawer);
        closeBtn.addEventListener('click', closeDrawer);
        backdrop.addEventListener('click', closeDrawer);

        // --- Boot ---
        init();

    </script>
</body>
</html>
