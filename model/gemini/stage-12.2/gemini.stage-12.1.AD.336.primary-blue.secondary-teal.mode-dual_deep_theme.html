<!DOCTYPE html>
<html lang="en-GB">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AD","indexWithinVariant":"336","totalWithinVariant":"440","hueFamily":"","intensityMode":"","primaryHueFamily":"blue","secondaryHueFamily":"teal","dualIntensityMode":"dual_deep_theme","timestamp":"2026-01-10T19:28:27.694Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AD&quot;,&quot;indexWithinVariant&quot;:&quot;336&quot;,&quot;totalWithinVariant&quot;:&quot;440&quot;,&quot;hueFamily&quot;:&quot;&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;primaryHueFamily&quot;:&quot;blue&quot;,&quot;secondaryHueFamily&quot;:&quot;teal&quot;,&quot;dualIntensityMode&quot;:&quot;dual_deep_theme&quot;,&quot;timestamp&quot;:&quot;2026-01-10T19:28:27.694Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>
    
    <!-- Libraries -->
    <!-- Markdown-it -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/13.0.1/markdown-it.min.js"></script>
    
    <!-- KaTeX -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/contrib/auto-render.min.js"></script>

    <!-- Lucide Icons (Minimal usage) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* 
         * STAGE 6 BASELINE + COLORLAB D (Dual Deep Theme)
         * Palette: Blue (Primary) / Amber (Secondary)
         * Mode: dual_deep_theme (Light Only)
         */
        :root {
            /* Hues */
            --hue-primary: 250;   /* Blue/Indigo */
            --hue-secondary: 70;  /* Amber */

            /* Surfaces (Deep Theme Bands) */
            /* Page: L[0.92..0.98] C[0.08..0.16] */
            --color-surface-page: oklch(0.93 0.09 var(--hue-primary));
            /* Frame: L[0.90..0.96] C[0.08..0.16] */
            --color-surface-frame: oklch(0.91 0.10 var(--hue-primary));
            /* Paper: L[0.94..0.99] C[0.06..0.14] */
            --color-surface-paper: oklch(0.96 0.06 var(--hue-primary));
            
            /* Solution Details Wash (Primary derived) */
            --color-surface-wash: oklch(0.94 0.07 var(--hue-primary));

            /* Drawer */
            --color-surface-drawer: var(--color-surface-paper);

            /* Text (High Legibility, Neutral-ish) */
            /* Primary: L[0.15..0.25] C<=0.015 */
            --color-text-primary: oklch(0.20 0.015 var(--hue-primary));
            /* Secondary: L[0.25..0.40] C<=0.020 */
            --color-text-secondary: oklch(0.35 0.020 var(--hue-primary));
            /* Quietest (Nav): L~0.45 */
            --color-text-tertiary: oklch(0.45 0.020 var(--hue-primary));

            /* Accents */
            /* Primary (Link, Focus, Disclosure): L[0.45..0.65] C[0.16..0.26] */
            --color-accent-primary: oklch(0.55 0.22 var(--hue-primary));
            /* Secondary (Supplementary Role - Nav marker?): L[0.45..0.70] C[0.12..0.22] */
            --color-accent-secondary: oklch(0.65 0.18 var(--hue-secondary));

            /* Lines/Borders */
            /* Hairline: C <= 0.02 */
            --color-border-hairline: oklch(0.85 0.02 var(--hue-primary));
            --color-focus-ring: var(--color-accent-primary);

            /* Spacing Scale */
            --space-xs: 0.25rem;
            --space-sm: 0.5rem;
            --space-md: 1rem;
            --space-lg: 1.5rem;
            --space-xl: 2.5rem;
            --space-2xl: 4rem;

            /* Typography */
            --font-family-base: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            --font-size-nav: 0.875rem;
            --font-size-body: 1rem;
            --font-size-h3: 1.125rem;
            --line-height-base: 1.5;
            --line-height-loose: 1.6;
            --line-height-tight: 1.3;
        }

        /* Reset & Base */
        *, *::before, *::after {
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            padding: 0;
            font-family: var(--font-family-base);
            background-color: var(--color-surface-page);
            color: var(--color-text-primary);
            line-height: var(--line-height-base);
            -webkit-font-smoothing: antialiased;
        }

        button {
            font-family: inherit;
            border: none;
            background: none;
            cursor: pointer;
            padding: 0;
            color: inherit;
        }

        a {
            color: var(--color-accent-primary);
            text-decoration: none;
        }
        
        a:hover {
            text-decoration: underline;
        }

        /* Focus States (Stage 5.5.2) */
        :focus-visible {
            outline: 2px solid var(--color-focus-ring);
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* 
         * LAYOUT ARCHITECTURE (Stage 3 + 6)
         * DocumentFrameShell with Top Controls and 2-column Desktop Grid
         */
        .layout-root {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .top-controls-region {
            /* Aligned to frame via max-width wrapper */
            width: 100%;
            background-color: var(--color-surface-frame); /* Visual continuation */
            padding-top: var(--space-md);
            padding-bottom: var(--space-md);
            border-bottom: 1px solid var(--color-border-hairline);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .top-controls-inner {
            max-width: 64rem; /* Matching shell width */
            margin: 0 auto;
            padding: 0 var(--space-md);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .paper-selector {
            font-size: var(--font-size-nav);
            padding: var(--space-xs) var(--space-sm);
            border: 1px solid var(--color-border-hairline);
            border-radius: 4px;
            background-color: var(--color-surface-paper);
            color: var(--color-text-primary);
        }

        .mobile-jump-trigger {
            display: none; /* Desktop default */
            font-size: var(--font-size-nav);
            font-weight: 600;
            color: var(--color-accent-primary);
            align-items: center;
            gap: var(--space-xs);
        }

        /* DocumentFrameShell */
        .document-frame-shell {
            flex: 1;
            width: 100%;
            max-width: 64rem;
            margin: 0 auto;
            background-color: var(--color-surface-frame); /* Shared base surface desktop */
            display: grid;
            grid-template-columns: 12rem 1fr; /* Nav Rail | Paper */
            /* On desktop, nav and paper sit on same surface, no visual gap */
            min-height: calc(100vh - 60px); 
        }

        /* Navigation Rail (Desktop) */
        .nav-rail {
            position: sticky;
            top: 4rem; /* Below top controls */
            height: calc(100vh - 4rem);
            overflow-y: auto;
            padding: var(--space-lg) var(--space-md);
            /* Hide scrollbar visually */
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .nav-rail::-webkit-scrollbar {
            display: none;
        }

        /* Navigation List Semantics (Stage 5.4) */
        .nav-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: var(--space-xs);
        }

        .nav-section-label {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--color-text-tertiary);
            margin-top: var(--space-md);
            margin-bottom: var(--space-xs);
            padding-left: 0; /* Flat */
            letter-spacing: 0.05em;
        }
        
        .nav-item {
            font-size: var(--font-size-nav);
            color: var(--color-text-tertiary);
            padding: 2px 0;
            text-align: left;
            transition: color 0.1s ease;
            /* Flat alignment - hierarchy via type scale/opacity handled by class mod if needed, 
               but specs say flat list with restrained type scale. 
               We will use generic styling for all, deeper items naturally look distinct by ID length 
            */
            display: block;
            width: 100%;
        }

        .nav-item:hover {
            color: var(--color-text-primary);
            text-decoration: none;
        }
        
        .nav-item.active {
            font-weight: 700;
            color: var(--color-accent-primary); /* Allowed by Override */
        }
        
        /* Hierarchy cues via class (optional, payload derived) */
        .nav-item.depth-1 { font-size: 0.8rem; opacity: 0.9; }
        .nav-item.depth-2 { font-size: 0.75rem; opacity: 0.8; }

        /* Paper Content Region */
        .paper-column {
            background-color: var(--color-surface-paper);
            padding: var(--space-xl) var(--space-xl) var(--space-2xl);
            min-height: 100%;
        }

        .paper-error-message {
            padding: var(--space-2xl);
            text-align: center;
            color: var(--color-text-secondary);
            font-weight: 600;
        }

        /* Section Header (In Paper) */
        .paper-section-header {
            font-size: var(--font-size-h3);
            font-weight: 700;
            color: var(--color-text-primary);
            margin-bottom: var(--space-lg);
            margin-top: var(--space-2xl);
            padding-bottom: var(--space-sm);
            border-bottom: 1px solid var(--color-border-hairline);
        }

        /* Question Node Structure */
        .question-node {
            margin-bottom: var(--space-2xl); /* Top level spacing */
            position: relative;
        }

        .question-node.child-node {
            margin-bottom: var(--space-md);
            margin-top: var(--space-md);
        }

        /* Question Body */
        .question-body {
            display: flex;
            gap: var(--space-sm);
            margin-bottom: var(--space-md);
            color: var(--color-text-primary);
            font-size: var(--font-size-body);
            line-height: var(--line-height-loose);
        }

        .question-id {
            font-weight: 700;
            min-width: 2rem; /* Align text */
            flex-shrink: 0;
        }

        .question-prompt {
            flex: 1;
        }

        /* Solution Block (Answer + Details) */
        .solution-block {
            margin-left: 2.5rem; /* Indent to align with prompt start roughly */
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }

        /* Answer */
        .answer-region {
            display: flex;
            flex-direction: column;
            gap: var(--space-xs);
        }
        
        .answer-label {
            font-weight: 700;
            font-size: 0.875rem;
            color: var(--color-text-secondary);
        }

        .answer-content {
            font-weight: 500;
        }

        /* Solution Details & Disclosure */
        .disclosure-control {
            font-size: 0.875rem;
            color: var(--color-accent-primary);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            width: fit-content;
            user-select: none;
        }

        .disclosure-control:hover {
            text-decoration: underline;
        }

        .solution-details-region {
            /* Separator logic handled by flex gap */
            background-color: var(--color-surface-wash); /* Permitted wash */
            padding: var(--space-md);
            border-radius: 2px; /* Soft structure, not card */
            display: none; /* Default hidden */
            flex-direction: column;
            gap: var(--space-lg);
            margin-top: var(--space-xs);
        }

        .solution-details-region.expanded {
            display: flex;
        }

        /* Subsections inside Solution Details */
        .sd-subsection {
            display: flex;
            flex-direction: column;
            gap: var(--space-xs);
        }

        .sd-label {
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--color-text-secondary);
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }

        .sd-body {
            font-size: 0.9375rem; /* Slightly smaller than Q */
            color: var(--color-text-primary); /* Readable! */
            line-height: var(--line-height-base);
        }
        
        /* List styles within Markdown */
        .sd-body ul, .sd-body ol {
            padding-left: 1.25rem;
            margin: 0.5rem 0;
        }
        
        .sd-body p {
            margin: 0.5rem 0;
        }

        /* Keep in mind */
        .sd-keep-in-mind .sd-label {
            color: var(--color-text-primary); /* Slightly stronger */
        }
        
        /* Alternative Working Separation */
        .sd-alternative-working {
            border-top: 1px solid var(--color-border-hairline);
            padding-top: var(--space-md);
        }

        /* Math Containment Invariants */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            padding: 0.5em 0;
            max-width: 100%;
            /* Underlay permitted for block math */
            /* background-color: rgba(0,0,0,0.02); -- subtle underlay if desired, but not strictly mandated */
        }
        
        .katex {
            font-size: 1.1em;
        }

        /* Tables (Minimal) */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9375rem;
            margin: 1rem 0;
        }
        th, td {
            border: 1px solid var(--color-border-hairline);
            padding: 0.5rem;
            text-align: left;
        }
        th {
            font-weight: 600;
        }

        /* Mobile / Small Screen Styles */
        @media (max-width: 768px) {
            .document-frame-shell {
                display: block; /* Stack */
                background-color: var(--color-surface-paper); /* Simplify to paper surface */
            }
            
            .nav-rail {
                display: none; /* Hide rail, use Drawer */
            }
            
            .mobile-jump-trigger {
                display: flex;
            }

            .paper-column {
                padding: var(--space-lg) var(--space-md) var(--space-2xl);
            }
            
            .solution-block {
                margin-left: 0; /* Align left on mobile */
                padding-left: var(--space-md);
                border-left: 2px solid var(--color-border-hairline); /* Indent cue */
            }
        }

        /* Drawer (Mobile) */
        .drawer-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 50;
            display: none;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .drawer-overlay.open {
            display: flex;
            opacity: 1;
        }

        .drawer-panel {
            background-color: var(--color-surface-drawer);
            width: 80%;
            max-width: 300px;
            height: 100%;
            display: flex;
            flex-direction: column;
            transform: translateX(-100%);
            transition: transform 0.2s ease;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        .drawer-overlay.open .drawer-panel {
            transform: translateX(0);
        }

        .drawer-header {
            padding: var(--space-md);
            border-bottom: 1px solid var(--color-border-hairline);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 700;
        }

        .drawer-content {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-md);
        }

        /* Child Indentation Visuals (No nested borders) */
        .children-container {
            margin-left: 1.5rem;
        }
        
    </style>
</head>
<body>

<!-- Layout Root -->
<div class="layout-root">
    
    <!-- Top Controls -->
    <div class="top-controls-region">
        <div class="top-controls-inner">
            <select id="paper-selector" class="paper-selector" aria-label="Select Paper">
                <option value="" disabled selected>Loading papers...</option>
            </select>
            
            <button id="jump-to-trigger" class="mobile-jump-trigger" aria-label="Open Navigation">
                <i data-lucide="menu" size="18"></i>
                <span>Jump to</span>
            </button>
        </div>
    </div>

    <!-- Document Frame -->
    <main class="document-frame-shell">
        
        <!-- Desktop Nav Rail -->
        <nav class="nav-rail" aria-label="Paper Navigation">
            <ul id="desktop-nav-list" class="nav-list">
                <!-- Injected via JS -->
            </ul>
        </nav>

        <!-- Paper Content -->
        <div id="paper-content" class="paper-column">
            <!-- Injected via JS -->
            <div class="paper-error-message">Loading...</div>
        </div>

    </main>

</div>

<!-- Mobile Drawer -->
<div id="drawer-overlay" class="drawer-overlay" aria-hidden="true">
    <div class="drawer-panel">
        <div class="drawer-header">
            <span>Jump to Question</span>
            <button id="drawer-close" aria-label="Close Navigation">
                <i data-lucide="x"></i>
            </button>
        </div>
        <div class="drawer-content">
            <ul id="mobile-nav-list" class="nav-list">
                <!-- Injected via JS -->
            </ul>
        </div>
    </div>
</div>

<script>
    // --- STAGE 0: CONSTANTS ---
    const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
    const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

    // --- MARKDOWN CONFIGURATION (STAGE 6 BASELINE) ---
    const md = window.markdownit
        ? window.markdownit({
            html: true,     // Inline SVG passthrough
            linkify: true,
            breaks: false   // CRITICAL: prevents <br> in math
          })
        : null;

    if (md) {
        // Disable escape rule to preserve TeX backslashes
        md.inline.ruler.disable(['escape']);
    }

    // --- STATE ---
    let appState = {
        papers: [],
        currentPaper: null,
        expandedAllDefaults: true
    };

    // --- DOM ELEMENTS ---
    const paperSelector = document.getElementById('paper-selector');
    const desktopNavList = document.getElementById('desktop-nav-list');
    const mobileNavList = document.getElementById('mobile-nav-list');
    const paperContent = document.getElementById('paper-content');
    const drawerOverlay = document.getElementById('drawer-overlay');
    const jumpToTrigger = document.getElementById('jump-to-trigger');
    const drawerClose = document.getElementById('drawer-close');

    // --- INITIALIZATION ---
    async function init() {
        lucide.createIcons();
        setupInteraction();
        
        try {
            const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
            if (!response.ok) throw new Error("Fetch failed");
            const payload = await response.json();
            
            if (!payload.papers || !Array.isArray(payload.papers)) {
                throw new Error("Invalid payload format");
            }
            
            appState.papers = payload.papers;
            renderSelector();
            
            // Load first paper by default
            if (appState.papers.length > 0) {
                loadPaper(appState.papers[0].key);
            }
        } catch (error) {
            console.error(error);
            renderError();
        }
    }

    function renderError() {
        paperContent.innerHTML = `<div class="paper-error-message">PAPERS PAYLOAD MISSING</div>`;
        paperSelector.innerHTML = `<option>Error loading payload</option>`;
        paperSelector.disabled = true;
    }

    function renderSelector() {
        paperSelector.innerHTML = '';
        appState.papers.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.key;
            opt.textContent = p.label || p.key;
            paperSelector.appendChild(opt);
        });
        paperSelector.disabled = false;
    }

    function loadPaper(key) {
        const paper = appState.papers.find(p => p.key === key);
        if (!paper) return;

        appState.currentPaper = paper;
        appState.expandedAllDefaults = paper.defaults?.expandedAll ?? true;
        
        // Update Selector UI
        paperSelector.value = key;

        // Render Content
        renderPaperContent(paper);
        
        // Render Nav
        renderNavigation(paper);

        // Apply Math Rendering
        renderMath();
        
        // Refresh Icons
        lucide.createIcons();
        
        // Reset scroll
        window.scrollTo(0,0);
    }

    // --- RENDERING LOGIC ---

    function renderPaperContent(paper) {
        let html = '';
        
        // Check structure: Flat questions vs Sections
        if (paper.sections && paper.sections.length > 0) {
            paper.sections.forEach(section => {
                // Section Header (only if label exists)
                if (section.label && section.label.trim().length > 0) {
                    html += `<div class="paper-section-header">${section.label}</div>`;
                }
                html += `<div class="question-list">`;
                section.questions.forEach(q => {
                    html += renderQuestionNode(q, 0);
                });
                html += `</div>`;
            });
        } else if (paper.questions && paper.questions.length > 0) {
            html += `<div class="question-list">`;
            paper.questions.forEach(q => {
                html += renderQuestionNode(q, 0);
            });
            html += `</div>`;
        } else {
            html = `<div class="paper-error-message">No questions in this paper.</div>`;
        }

        paperContent.innerHTML = html;
    }

    function renderQuestionNode(node, depth) {
        const hasChildren = node.children && node.children.length > 0;
        
        // Process Markdown Fields
        const questionHtml = md ? md.render(node.question || "") : node.question;
        
        let solutionBlockHtml = '';
        if (node.solutionBlock) {
            const sb = node.solutionBlock;
            const hasAnswer = !!sb.answer;
            const hasDetails = !!sb.solutionDetails;
            
            // Answer
            let answerHtml = '';
            if (hasAnswer) {
                const answerContent = md ? md.render(sb.answer) : sb.answer;
                answerHtml = `
                    <div class="answer-region">
                        <div class="answer-label">Answer</div>
                        <div class="answer-content">${answerContent}</div>
                    </div>
                `;
            }

            // Details
            let detailsHtml = '';
            let toggleHtml = '';
            if (hasDetails) {
                const sd = sb.solutionDetails;
                const isExpanded = appState.expandedAllDefaults;
                const displayStyle = isExpanded ? 'flex' : 'none';
                const toggleText = isExpanded ? 'Hide working' : 'Show working';
                const chevronIcon = isExpanded ? 'chevron-up' : 'chevron-down';

                toggleHtml = `
                    <button class="disclosure-control" onclick="toggleWorking(this)">
                        <span class="toggle-text">${toggleText}</span>
                        <i data-lucide="${chevronIcon}" width="16" height="16"></i>
                    </button>
                `;

                // Build subsections
                let subsections = '';
                
                // Keep in mind
                if (sd.keepInMind) {
                    subsections += `
                        <div class="sd-subsection sd-keep-in-mind">
                            <div class="sd-label"><i data-lucide="lightbulb" width="14"></i> Keep in mind</div>
                            <div class="sd-body">${md ? md.render(sd.keepInMind) : sd.keepInMind}</div>
                        </div>
                    `;
                }
                
                // Formulas
                if (sd.formulasUsed) {
                    subsections += `
                        <div class="sd-subsection sd-formulas">
                            <div class="sd-label">Formulas used</div>
                            <div class="sd-body">${md ? md.render(sd.formulasUsed) : sd.formulasUsed}</div>
                        </div>
                    `;
                }
                
                // Working
                if (sd.working) {
                    subsections += `
                        <div class="sd-subsection sd-working">
                            <div class="sd-label">Working</div>
                            <div class="sd-body">${md ? md.render(sd.working) : sd.working}</div>
                        </div>
                    `;
                }

                // Alt Working
                if (sd.alternativeWorking && Array.isArray(sd.alternativeWorking)) {
                    sd.alternativeWorking.forEach(alt => {
                        subsections += `
                            <div class="sd-subsection sd-alternative-working">
                                <div class="sd-label">Alternative working</div>
                                <div class="sd-body">${md ? md.render(alt) : alt}</div>
                            </div>
                        `;
                    });
                }

                detailsHtml = `
                    <div class="solution-details-region ${isExpanded ? 'expanded' : ''}" style="display:${displayStyle}">
                        ${subsections}
                    </div>
                `;
            }

            solutionBlockHtml = `
                <div class="solution-block">
                    ${answerHtml}
                    ${toggleHtml}
                    ${detailsHtml}
                </div>
            `;
        }

        const childClass = depth > 0 ? 'child-node' : '';
        const idAttribute = node.id ? `id="q-${node.id}"` : '';
        
        // Children
        let childrenHtml = '';
        if (hasChildren) {
            childrenHtml = `<div class="children-container">`;
            node.children.forEach(child => {
                childrenHtml += renderQuestionNode(child, depth + 1);
            });
            childrenHtml += `</div>`;
        }

        return `
            <div class="question-node ${childClass}" ${idAttribute}>
                <div class="question-body">
                    <div class="question-id">${node.id}</div>
                    <div class="question-prompt">${questionHtml}</div>
                </div>
                ${solutionBlockHtml}
                ${childrenHtml}
            </div>
        `;
    }

    function renderNavigation(paper) {
        // Flatten list for display
        const items = [];
        
        const processNode = (node, depth) => {
            items.push({ id: node.id, depth });
            if (node.children) {
                node.children.forEach(c => processNode(c, depth + 1));
            }
        };

        const createListHtml = (sourceItems, isMobile) => {
            return sourceItems.map(item => {
                if (item.isSection) {
                    return `<li class="nav-section-label">${item.label}</li>`;
                }
                const indentClass = `depth-${Math.min(item.depth, 2)}`;
                return `<li><a href="#q-${item.id}" class="nav-item ${indentClass}" onclick="handleNavClick(event, 'q-${item.id}', ${isMobile})">${item.id}</a></li>`;
            }).join('');
        };

        // Build flat render list with sections injected
        const renderList = [];
        if (paper.sections) {
            paper.sections.forEach(sec => {
                if (sec.label && sec.label.trim() !== "") {
                    renderList.push({ isSection: true, label: sec.label });
                }
                sec.questions.forEach(q => processNode(q, 0));
            });
        } else if (paper.questions) {
            paper.questions.forEach(q => processNode(q, 0));
        }

        const html = createListHtml(renderList, false); // Desktop
        const mobileHtml = createListHtml(renderList, true); // Mobile
        
        desktopNavList.innerHTML = html;
        mobileNavList.innerHTML = mobileHtml;
        
        setupScrollSpy();
    }

    // --- INTERACTIONS ---

    function setupInteraction() {
        // Paper Selector
        paperSelector.addEventListener('change', (e) => {
            loadPaper(e.target.value);
        });

        // Mobile Drawer
        jumpToTrigger.addEventListener('click', () => {
            drawerOverlay.classList.add('open');
            drawerOverlay.setAttribute('aria-hidden', 'false');
        });

        drawerClose.addEventListener('click', closeDrawer);
        drawerOverlay.addEventListener('click', (e) => {
            if (e.target === drawerOverlay) closeDrawer();
        });

        // Global functions for inline HTML event handlers
        window.toggleWorking = toggleWorking;
        window.handleNavClick = handleNavClick;
    }

    function closeDrawer() {
        drawerOverlay.classList.remove('open');
        drawerOverlay.setAttribute('aria-hidden', 'true');
    }

    function toggleWorking(btn) {
        const container = btn.parentElement; // solution-block
        const region = container.querySelector('.solution-details-region');
        const textSpan = btn.querySelector('.toggle-text');
        const icon = btn.querySelector('i'); // lucide svg or i tag
        
        if (!region) return;

        const isHidden = region.style.display === 'none';
        
        if (isHidden) {
            region.style.display = 'flex';
            setTimeout(() => region.classList.add('expanded'), 10);
            textSpan.textContent = 'Hide working';
            // Lucide icons are replaced with SVG, so we might need to re-render or just swap class if we weren't using the library dynamically.
            // Simplest way with lucide auto-replace: clear and recreate
            // But since lucide replaces <i> with <svg>, let's just re-inject the icon HTML for simplicity in vanilla JS
            btn.innerHTML = `<span class="toggle-text">Hide working</span> <i data-lucide="chevron-up" width="16"></i>`;
        } else {
            region.classList.remove('expanded');
            region.style.display = 'none';
            textSpan.textContent = 'Show working';
            btn.innerHTML = `<span class="toggle-text">Show working</span> <i data-lucide="chevron-down" width="16"></i>`;
        }
        lucide.createIcons();
    }

    function handleNavClick(e, targetId, isMobile) {
        e.preventDefault();
        const el = document.getElementById(targetId);
        if (el) {
            // Offset for sticky header
            const headerOffset = 80;
            const elementPosition = el.getBoundingClientRect().top;
            const offsetPosition = elementPosition + window.pageYOffset - headerOffset;

            window.scrollTo({
                top: offsetPosition,
                behavior: "smooth"
            });
            
            // Highlight active manually immediately
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            e.target.classList.add('active');
        }
        if (isMobile) closeDrawer();
    }

    // --- MATH RENDERING ---
    function renderMath() {
        if (window.renderMathInElement) {
            renderMathInElement(paperContent, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false}
                ],
                throwOnError: false
            });
        }
    }

    // --- SCROLL SPY (Basic Active State) ---
    function setupScrollSpy() {
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const id = entry.target.id.replace('q-', '');
                    // Find nav link
                    document.querySelectorAll('.nav-item').forEach(link => {
                        if (link.textContent === id) {
                            // clear others
                            // document.querySelectorAll('.nav-item').forEach(l => l.classList.remove('active'));
                            // link.classList.add('active');
                            // Actually, with many elements on screen, this flickers.
                            // A real scrollspy needs logic to pick the "top-most" intersecting.
                            // For this prototype, click-to-active is sufficient, relying on simple InteractionObserver often highlights multiple or bottom ones.
                            // We will leave the click handler as the primary active setter for stability.
                        }
                    });
                }
            });
        }, { threshold: 0.1, rootMargin: "-20% 0px -60% 0px" });

        document.querySelectorAll('.question-node').forEach(node => {
            if (node.id) observer.observe(node);
        });
    }

    // Boot
    document.addEventListener('DOMContentLoaded', init);

</script>
</body>
</html>
