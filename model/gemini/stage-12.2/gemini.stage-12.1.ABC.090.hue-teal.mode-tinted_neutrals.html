<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"ABC","indexWithinVariant":"90","totalWithinVariant":"320","hueFamily":"teal","intensityMode":"tinted_neutrals","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-09T14:07:26.031Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;ABC&quot;,&quot;indexWithinVariant&quot;:&quot;90&quot;,&quot;totalWithinVariant&quot;:&quot;320&quot;,&quot;hueFamily&quot;:&quot;teal&quot;,&quot;intensityMode&quot;:&quot;tinted_neutrals&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-09T14:07:26.031Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ – Maths Paper Solution Viewer (Stage 6 Baseline)</title>

    <!-- 
      STAGE 0: CONSTANTS 
      These values are authoritative. 
    -->
    <script>
        // CANONICAL CONSTANT — PAPERS PAYLOAD PATH (v1.0)
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        
        // CANONICAL CONSTANT — SHADCN TOKEN PROFILES PATH (v1.0)
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";
    </script>

    <!-- Tailwind CSS (via CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React & ReactDOM (via CDN) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (for JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Lucide React (Icons) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/lucide-react@latest/dist/lucide-react.min.js"></script>

    <!-- KaTeX -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Markdown-it -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <!-- 
      COLORLAB CONFIGURATION (Stage 6 Add-on)
      Mode: tinted_neutrals
      Hue: teal (approx 175 OKLCH)
      Theme: Light Only
    -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Tinted Neutrals / Teal (Hue ~175)
                        page: 'oklch(0.97 0.02 175)',
                        frame: 'oklch(0.96 0.025 175)',
                        paper: 'oklch(0.98 0.015 175)',
                        wash: 'oklch(0.94 0.03 175)',
                        
                        // Text (High Legibility)
                        primary: 'oklch(0.20 0.01 175)',
                        secondary: 'oklch(0.45 0.012 175)',
                        
                        // Accents & UI
                        accent: 'oklch(0.60 0.14 175)', // Link, Focus, Active Nav
                        divider: 'oklch(0.88 0.02 175)',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        /* Baseline Reset & Typography */
        body {
            background-color: theme('colors.page');
            color: theme('colors.primary');
            font-family: theme('fontFamily.sans');
            -webkit-font-smoothing: antialiased;
        }

        /* KaTeX Containment Invariant */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding: 0.5rem 0;
            /* Scrollbar hiding for cleaner math blocks */
            scrollbar-width: thin;
        }
        
        /* Markdown Table Minimalist Styling */
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 1rem 0;
            font-size: 0.95em;
        }
        th, td {
            border: 1px solid theme('colors.divider');
            padding: 0.5rem 0.75rem;
            text-align: left;
        }
        th {
            font-weight: 600;
            background-color: transparent; /* No fill */
        }

        /* Nav Scrollbar Hiding */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        /* Focus Outline (Accessibility) */
        *:focus-visible {
            outline: 2px solid theme('colors.accent');
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* Layout Utilities */
        .layout-grid {
            display: grid;
            grid-template-columns: 240px 1fr; /* Nav Rail | Paper */
            min-height: 100vh;
        }
        
        @media (max-width: 1024px) {
            .layout-grid {
                display: block; /* Stack or just paper */
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        const { Menu, X, ChevronDown, ChevronRight, Info } = lucideReact;

        // --- Markdown Renderer Setup (Stage 6 Baseline) ---
        const md = window.markdownit ? window.markdownit({
            html: true, // Allow inline SVG
            linkify: true,
            breaks: false // Critical: prevents <br> inside KaTeX delimiters
        }) : null;

        if (md) {
            // Preserve TeX backslashes
            md.inline.ruler.disable(['escape']);
        }

        // --- Components ---

        // 1. Markdown Content Component (Handles KaTeX)
        const MarkdownContent = ({ content, className = "" }) => {
            const containerRef = useRef(null);

            useEffect(() => {
                if (containerRef.current && window.renderMathInElement) {
                    window.renderMathInElement(containerRef.current, {
                        delimiters: [
                            {left: '$$', right: '$$', display: true},
                            {left: '$', right: '$', display: false}
                        ],
                        throwOnError: false
                    });
                }
            }, [content]);

            if (!content) return null;

            // Render Markdown to HTML
            const html = md ? md.render(content) : content;

            return (
                <div 
                    ref={containerRef}
                    className={`prose prose-neutral max-w-none ${className} [&>p]:mb-3 [&>p:last-child]:mb-0 [&_ul]:list-disc [&_ul]:pl-5 [&_ol]:list-decimal [&_ol]:pl-5`}
                    dangerouslySetInnerHTML={{ __html: html }}
                />
            );
        };

        // 2. Navigation Components
        const NavItem = ({ id, activeId, onClick, depth = 0 }) => {
            const isActive = activeId === id;
            // Hierarchy via type scale/quietness (Stage 5.4.5)
            // No indentation allowed.
            const isSub = depth > 0;
            
            return (
                <button
                    onClick={() => onClick(id)}
                    className={`
                        w-full text-left py-1.5 px-3 block transition-colors
                        border-l-2
                        ${isActive 
                            ? 'border-accent font-bold text-primary' 
                            : 'border-transparent font-normal text-secondary hover:text-primary hover:bg-black/5'}
                        ${isSub ? 'text-sm' : 'text-base'}
                    `}
                >
                    {id}
                </button>
            );
        };

        const NavSectionLabel = ({ label }) => {
            if (!label || label.trim() === "") return null;
            return (
                <div className="px-3 pt-6 pb-2 text-xs font-bold uppercase tracking-wider text-secondary select-none">
                    {label}
                </div>
            );
        };

        const NavigationList = ({ items, activeId, onJump }) => {
            return (
                <div className="pb-10">
                    {items.map((item, idx) => {
                        if (item.type === 'section') {
                            return <NavSectionLabel key={`sec-${idx}`} label={item.label} />;
                        }
                        return (
                            <NavItem 
                                key={item.id} 
                                id={item.id} 
                                activeId={activeId} 
                                onClick={onJump} 
                                depth={item.depth} 
                            />
                        );
                    })}
                </div>
            );
        };

        // 3. Content Components
        const KeepInMind = ({ content }) => (
            <div className="mb-4">
                <div className="flex items-center gap-2 mb-1 text-sm font-bold text-secondary">
                    <Info size={14} className="stroke-[2.5]" />
                    <span>Keep in mind</span>
                </div>
                <MarkdownContent content={content} className="text-sm text-secondary" />
            </div>
        );

        const FormulasUsed = ({ content }) => (
            <div className="mb-4">
                <div className="text-xs font-bold text-secondary mb-1 uppercase tracking-wide">Formulas used</div>
                <MarkdownContent content={content} className="text-sm text-secondary" />
            </div>
        );

        const WorkingBlock = ({ label, content, isAlt = false }) => (
            <div className={`mt-4 ${isAlt ? "pt-4 border-t border-divider" : ""}`}>
                <div className="text-sm font-bold text-secondary mb-2">{label}</div>
                <MarkdownContent content={content} className="text-base text-primary leading-relaxed" />
            </div>
        );

        const SolutionDetails = ({ details }) => {
            const { keepInMind, formulasUsed, working, alternativeWorking } = details;
            
            return (
                <div className="mt-3 pt-4 pl-4 border-l-2 border-divider bg-wash rounded-r-sm pr-4 pb-4">
                    {keepInMind && <KeepInMind content={keepInMind} />}
                    
                    {/* Separator via spacing */}
                    {formulasUsed && <div className={keepInMind ? "mt-4" : ""}><FormulasUsed content={formulasUsed} /></div>}
                    
                    {working && <WorkingBlock label="Working" content={working} />}
                    
                    {alternativeWorking && Array.isArray(alternativeWorking) && alternativeWorking.map((alt, idx) => (
                        <WorkingBlock key={idx} label="Alternative working" content={alt} isAlt={true} />
                    ))}
                </div>
            );
        };

        const SolutionBlock = ({ answer, solutionDetails, isExpandedDefault }) => {
            // Logic: Show/Hide toggle only exists if solutionDetails exists.
            // If only answer exists, answer is visible by default.
            
            const [isExpanded, setIsExpanded] = useState(isExpandedDefault);
            const hasDetails = !!solutionDetails;

            return (
                <div className="mt-4">
                    {/* Answer (Visible by default when present) */}
                    {answer && (
                        <div className="mb-3">
                            <span className="text-sm font-bold text-secondary block mb-1">Answer</span>
                            <MarkdownContent content={answer} className="text-base font-medium text-primary" />
                        </div>
                    )}

                    {/* Disclosure Control */}
                    {hasDetails && (
                        <div>
                            <button 
                                onClick={() => setIsExpanded(!isExpanded)}
                                className="flex items-center gap-1 text-sm font-medium text-accent hover:underline focus:underline select-none mt-2"
                                aria-expanded={isExpanded}
                            >
                                {isExpanded ? "Hide working" : "Show working"}
                                {isExpanded ? <ChevronDown size={14} /> : <ChevronRight size={14} />}
                            </button>

                            {/* Solution Details Region */}
                            {isExpanded && (
                                <SolutionDetails details={solutionDetails} />
                            )}
                        </div>
                    )}
                </div>
            );
        };

        const QuestionNode = ({ node, defaults, depth = 0 }) => {
            // Recursive rendering for children
            // Determine defaults
            const expandedAll = defaults?.expandedAll ?? true; // Default to true per brief unless specified

            const hasSolutionBlock = !!node.solutionBlock;
            const { answer, solutionDetails } = node.solutionBlock || {};

            // Determine indent style (spacing only)
            const indentClass = depth > 0 ? "ml-4 md:ml-8 border-l border-transparent" : "";
            // Top level separation
            const containerClass = depth === 0 ? "py-8 border-b border-divider last:border-0" : "pt-6 pb-2";

            return (
                <div id={`q-${node.id}`} className={`${containerClass} ${indentClass} scroll-mt-24`}>
                    {/* Question Body */}
                    <div className="flex gap-3">
                        <div className="shrink-0 w-8 md:w-12 text-sm md:text-base font-bold text-secondary pt-0.5">
                            {node.id}
                        </div>
                        <div className="grow min-w-0">
                            {/* Prompt */}
                            <MarkdownContent content={node.question} className="text-base md:text-lg text-primary font-medium" />

                            {/* Solution Block (Optional) */}
                            {hasSolutionBlock && (
                                <SolutionBlock 
                                    answer={answer} 
                                    solutionDetails={solutionDetails} 
                                    isExpandedDefault={expandedAll} 
                                />
                            )}
                        </div>
                    </div>

                    {/* Recursive Children */}
                    {node.children && node.children.length > 0 && (
                        <div className="mt-2">
                            {node.children.map((child, idx) => (
                                <QuestionNode key={idx} node={child} defaults={defaults} depth={depth + 1} />
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        // 4. Main App Shell
        const App = () => {
            const [papersData, setPapersData] = useState(null);
            const [selectedPaperKey, setSelectedPaperKey] = useState(null);
            const [error, setError] = useState(null);
            const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
            const [activeId, setActiveId] = useState(null);

            // Fetch Payload
            useEffect(() => {
                fetch(RTQ_PAPERS_PAYLOAD_PATH)
                    .then(res => {
                        if (!res.ok) throw new Error("Payload not found");
                        return res.json();
                    })
                    .then(data => {
                        if (data && data.papers && data.papers.length > 0) {
                            setPapersData(data);
                            setSelectedPaperKey(data.papers[0].key);
                        } else {
                            setError("Invalid payload structure");
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        setError("PAPERS PAYLOAD MISSING");
                    });
            }, []);

            // Handle Navigation Flattening
            const currentPaper = useMemo(() => {
                if (!papersData || !selectedPaperKey) return null;
                return papersData.papers.find(p => p.key === selectedPaperKey);
            }, [papersData, selectedPaperKey]);

            const navItems = useMemo(() => {
                if (!currentPaper) return [];
                
                const flatten = (nodes, depth = 0) => {
                    let acc = [];
                    nodes.forEach(node => {
                        acc.push({ id: node.id, type: 'item', depth });
                        if (node.children) {
                            acc = acc.concat(flatten(node.children, depth + 1));
                        }
                    });
                    return acc;
                };

                if (currentPaper.sections) {
                    let items = [];
                    currentPaper.sections.forEach(sec => {
                        if (sec.label) {
                            items.push({ label: sec.label, type: 'section' });
                        }
                        items = items.concat(flatten(sec.questions));
                    });
                    return items;
                } else if (currentPaper.questions) {
                    return flatten(currentPaper.questions);
                }
                return [];
            }, [currentPaper]);

            const handleJump = (id) => {
                const el = document.getElementById(`q-${id}`);
                if (el) {
                    el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    setActiveId(id);
                    setMobileMenuOpen(false);
                }
            };

            // Intersection Observer for Active State
            useEffect(() => {
                if (!navItems.length) return;
                
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const id = entry.target.id.replace('q-', '');
                            setActiveId(id);
                        }
                    });
                }, { rootMargin: '-10% 0px -80% 0px' });

                navItems.forEach(item => {
                    if (item.type === 'item') {
                        const el = document.getElementById(`q-${item.id}`);
                        if (el) observer.observe(el);
                    }
                });

                return () => observer.disconnect();
            }, [navItems]);


            if (error) {
                return (
                    <div className="min-h-screen flex items-center justify-center text-xl font-bold text-secondary">
                        {error}
                    </div>
                );
            }

            if (!papersData || !currentPaper) return null; // Loading

            return (
                <div className="bg-frame min-h-screen text-primary">
                    
                    {/* Top Controls Region */}
                    <div className="sticky top-0 z-30 bg-frame/95 backdrop-blur border-b border-divider">
                        <div className="max-w-7xl mx-auto px-4 h-14 flex items-center justify-between">
                            {/* Paper Selector */}
                            <div className="flex items-center gap-2">
                                <label className="text-sm font-medium text-secondary">Paper:</label>
                                <select 
                                    className="bg-transparent text-sm font-bold text-primary border border-divider rounded px-2 py-1 focus:border-accent"
                                    value={selectedPaperKey}
                                    onChange={(e) => setSelectedPaperKey(e.target.value)}
                                >
                                    {papersData.papers.map(p => (
                                        <option key={p.key} value={p.key}>{p.label}</option>
                                    ))}
                                </select>
                            </div>

                            {/* Mobile "Jump to" Trigger */}
                            <button 
                                className="lg:hidden flex items-center gap-2 text-sm font-medium text-accent"
                                onClick={() => setMobileMenuOpen(true)}
                            >
                                <Menu size={18} />
                                Jump to
                            </button>
                        </div>
                    </div>

                    {/* DocumentFrameShell */}
                    <div className="max-w-7xl mx-auto px-4 layout-grid">
                        
                        {/* Desktop Navigation Rail */}
                        <aside className="hidden lg:block sticky top-14 h-[calc(100vh-3.5rem)] overflow-y-auto no-scrollbar py-8 pr-6 border-r border-transparent">
                            <NavigationList items={navItems} activeId={activeId} onJump={handleJump} />
                        </aside>

                        {/* Paper Content Column */}
                        <main className="bg-paper min-h-[calc(100vh-3.5rem)] px-4 md:px-12 pb-24 border-l border-r border-frame shadow-sm mx-auto w-full max-w-4xl">
                            {currentPaper.sections ? (
                                currentPaper.sections.map((sec, idx) => (
                                    <div key={idx} className="mb-8">
                                        {sec.label && (
                                            <div className="py-8 text-center text-2xl font-bold text-secondary border-b border-divider mb-4">
                                                Section {sec.label}
                                            </div>
                                        )}
                                        {sec.questions.map((q, qIdx) => (
                                            <QuestionNode key={qIdx} node={q} defaults={currentPaper.defaults} />
                                        ))}
                                    </div>
                                ))
                            ) : (
                                currentPaper.questions.map((q, qIdx) => (
                                    <QuestionNode key={qIdx} node={q} defaults={currentPaper.defaults} />
                                ))
                            )}
                        </main>

                    </div>

                    {/* Mobile Navigation Drawer */}
                    {mobileMenuOpen && (
                        <div className="fixed inset-0 z-50 flex justify-end">
                            {/* Scrim */}
                            <div 
                                className="absolute inset-0 bg-black/20 backdrop-blur-sm"
                                onClick={() => setMobileMenuOpen(false)}
                            />
                            
                            {/* Drawer */}
                            <div className="relative w-72 bg-paper h-full shadow-xl flex flex-col">
                                <div className="p-4 border-b border-divider flex items-center justify-between">
                                    <span className="font-bold text-lg">Jump to</span>
                                    <button onClick={() => setMobileMenuOpen(false)} className="p-1 hover:bg-black/5 rounded">
                                        <X size={20} />
                                    </button>
                                </div>
                                <div className="flex-1 overflow-y-auto p-2">
                                    <NavigationList items={navItems} activeId={activeId} onJump={handleJump} />
                                </div>
                            </div>
                        </div>
                    )}

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
