<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"ABC","indexWithinVariant":"116","totalWithinVariant":"320","hueFamily":"amber","intensityMode":"deep_theme","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-09T15:17:58.050Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;ABC&quot;,&quot;indexWithinVariant&quot;:&quot;116&quot;,&quot;totalWithinVariant&quot;:&quot;320&quot;,&quot;hueFamily&quot;:&quot;amber&quot;,&quot;intensityMode&quot;:&quot;deep_theme&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-09T15:17:58.050Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>
    
    <!-- Tailwind CSS (via CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- KaTeX CSS (via CDN, no integrity) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    
    <!-- KaTeX JS (via CDN, no integrity) -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    
    <!-- Markdown-it (via CDN, no integrity) -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <!-- Phosphor Icons (via CDN) -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <script>
        // --- STAGE 0: CONSTANTS ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // --- COLORLAB CONFIG (Amber + Deep Theme) ---
        // Hue: 80 (Amber)
        // Intensity Mode: deep_theme
        // Page: L 0.95, C 0.10
        // Frame: L 0.92, C 0.12
        // Paper: L 0.98, C 0.08
        // Accent: L 0.55, C 0.22
        // Text: L 0.20, C 0.015 / L 0.35, C 0.02
        
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        page: 'oklch(0.95 0.10 80)',
                        frame: 'oklch(0.92 0.12 80)',
                        paper: 'oklch(0.98 0.08 80)',
                        wash: 'oklch(0.96 0.07 80)',
                        
                        txt: {
                            primary: 'oklch(0.20 0.015 80)',
                            secondary: 'oklch(0.35 0.02 80)',
                            tertiary: 'oklch(0.50 0.02 80)',
                        },
                        
                        accent: 'oklch(0.55 0.22 80)',
                        hairline: 'oklch(0.85 0.03 80)',
                        
                        focus: 'oklch(0.55 0.22 80)',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        /* Base Reset & Typography */
        body {
            background-color: oklch(0.95 0.10 80); /* page */
            color: oklch(0.20 0.015 80); /* txt-primary */
            -webkit-font-smoothing: antialiased;
            overflow-y: scroll; /* Force scrollbar to prevent shift */
        }

        /* Focus Ring */
        *:focus-visible {
            outline: 2px solid oklch(0.55 0.22 80); /* accent */
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* KaTeX Containment Invariant */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding: 0.5em 0;
            margin: 0.5em 0;
            /* Hide scrollbar visually but keep functionality */
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .katex-display::-webkit-scrollbar {
            display: none;
        }

        /* Inline KaTeX Transparency */
        .katex {
            background-color: transparent !important;
        }

        /* Table Styling (Minimal/Structural) */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            font-size: 0.95em;
        }
        th, td {
            padding: 0.5rem;
            text-align: left;
            border-bottom: 1px solid oklch(0.85 0.03 80); /* hairline */
        }
        th {
            font-weight: 600;
            color: oklch(0.20 0.015 80);
        }
        
        /* Mobile Table Overflow Wrapper */
        .table-wrapper {
            overflow-x: auto;
            width: 100%;
            scrollbar-width: none;
        }
        .table-wrapper::-webkit-scrollbar {
            display: none;
        }

        /* Nav Scrollbar Hiding */
        .nav-scroll-region {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .nav-scroll-region::-webkit-scrollbar {
            display: none;
        }

        /* Utility */
        .hidden-accessible {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Markdown Spacing */
        .md-content p {
            margin-bottom: 0.75em;
        }
        .md-content p:last-child {
            margin-bottom: 0;
        }
        .md-content ul {
            list-style-type: disc;
            padding-left: 1.25em;
            margin-bottom: 0.75em;
        }
        .md-content ol {
            list-style-type: decimal;
            padding-left: 1.25em;
            margin-bottom: 0.75em;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4 sm:p-6 lg:p-8">

    <!-- TOP CONTROLS REGION -->
    <!-- Aligned to DocumentFrameShell via max-w -->
    <div class="w-full max-w-5xl mb-6 flex items-center justify-between">
        
        <!-- Paper Selector -->
        <div class="flex items-center gap-3">
            <label for="paper-select" class="text-sm font-medium text-txt-secondary">Paper</label>
            <div class="relative">
                <select id="paper-select" class="appearance-none bg-paper border border-hairline rounded px-3 py-1.5 pr-8 text-sm text-txt-primary font-medium focus:border-accent hover:border-accent/50 transition-colors cursor-pointer min-w-[200px]">
                    <option>Loading papers...</option>
                </select>
                <i class="ph ph-caret-down absolute right-2.5 top-1/2 -translate-y-1/2 text-txt-secondary pointer-events-none text-xs"></i>
            </div>
        </div>

        <!-- Mobile Jump To Trigger -->
        <button id="mobile-jump-trigger" class="lg:hidden flex items-center gap-2 text-accent font-medium text-sm px-3 py-1.5 hover:bg-black/5 rounded transition-colors" aria-label="Open navigation">
            <span class="text-txt-primary">Jump to</span>
            <i class="ph ph-list text-lg"></i>
        </button>
    </div>

    <!-- DOCUMENT FRAME SHELL -->
    <main class="w-full max-w-5xl bg-frame rounded-sm shadow-sm min-h-[80vh] flex flex-col lg:flex-row overflow-hidden relative">
        
        <!-- DESKTOP NAVIGATION RAIL (Left Column) -->
        <!-- Visually shares surface with paper content on desktop (bg-frame base) -->
        <nav class="hidden lg:block w-48 xl:w-56 flex-shrink-0 sticky top-0 h-screen overflow-y-auto nav-scroll-region py-8 pl-6 pr-2 border-r border-transparent">
            <div id="desktop-nav-list" class="space-y-1">
                <!-- Nav items generated here -->
            </div>
        </nav>

        <!-- SEPARATOR (Desktop) -->
        <div class="hidden lg:block w-px bg-hairline my-8 mx-0"></div>

        <!-- PAPER CONTENT COLUMN (Right/Main) -->
        <div class="flex-1 bg-frame">
            <!-- Paper Surface Wrapper -->
            <!-- The paper content sits on 'paper' surface for reading focus, distinct from frame -->
            <div class="max-w-3xl mx-auto py-8 px-4 sm:px-8 lg:px-12">
                <div id="paper-content" class="min-h-[500px]">
                    <div class="flex items-center justify-center h-64 text-txt-secondary">
                        Loading content...
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- MOBILE NAVIGATION DRAWER -->
    <div id="mobile-drawer-backdrop" class="fixed inset-0 bg-black/20 z-40 hidden transition-opacity opacity-0" aria-hidden="true"></div>
    <div id="mobile-drawer" class="fixed inset-y-0 right-0 w-64 bg-paper z-50 transform translate-x-full transition-transform duration-300 shadow-xl flex flex-col">
        <div class="p-4 border-b border-hairline flex items-center justify-between">
            <span class="font-medium text-txt-primary">Jump to</span>
            <button id="mobile-drawer-close" class="p-2 text-txt-secondary hover:text-txt-primary transition-colors">
                <i class="ph ph-x text-lg"></i>
            </button>
        </div>
        <div id="mobile-nav-list" class="flex-1 overflow-y-auto p-4 space-y-1">
            <!-- Nav items generated here -->
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- RUNTIME STATE ---
        let rawPayload = null;
        let currentPaperKey = null;
        let expandedStates = {}; // key: questionId, value: boolean
        let md = null;

        // --- DOM ELEMENTS ---
        const els = {
            paperSelect: document.getElementById('paper-select'),
            content: document.getElementById('paper-content'),
            desktopNav: document.getElementById('desktop-nav-list'),
            mobileNav: document.getElementById('mobile-nav-list'),
            mobileTrigger: document.getElementById('mobile-jump-trigger'),
            mobileDrawer: document.getElementById('mobile-drawer'),
            mobileBackdrop: document.getElementById('mobile-drawer-backdrop'),
            drawerClose: document.getElementById('mobile-drawer-close')
        };

        // --- MARKDOWN SETUP (Authoritative) ---
        if (window.markdownit) {
            md = window.markdownit({
                html: true, // Allow inline SVG
                linkify: true,
                breaks: false // MUST be false
            });
            // Disable escape rule to preserve TeX backslashes
            md.inline.ruler.disable(['escape']);
        }

        // --- INITIALIZATION ---
        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Fetch failed");
                rawPayload = await response.json();
                
                if (!rawPayload || !rawPayload.papers) throw new Error("Invalid payload");

                setupPaperSelector();
                
                // Select first paper by default
                if (rawPayload.papers.length > 0) {
                    loadPaper(rawPayload.papers[0].key);
                }
            } catch (e) {
                console.error(e);
                renderError();
            }
        }

        function renderError() {
            els.content.innerHTML = `
                <div class="flex flex-col items-center justify-center py-20 text-txt-secondary">
                    <p class="font-semibold text-lg tracking-wide">PAPERS PAYLOAD MISSING</p>
                </div>
            `;
            els.paperSelect.innerHTML = "<option>Error loading papers</option>";
            els.paperSelect.disabled = true;
        }

        function setupPaperSelector() {
            els.paperSelect.innerHTML = "";
            rawPayload.papers.forEach(p => {
                const opt = document.createElement("option");
                opt.value = p.key;
                opt.textContent = p.label;
                els.paperSelect.appendChild(opt);
            });

            els.paperSelect.addEventListener("change", (e) => {
                loadPaper(e.target.value);
            });
        }

        function loadPaper(key) {
            currentPaperKey = key;
            const paper = rawPayload.papers.find(p => p.key === key);
            if (!paper) return;

            // Reset Expansion States based on defaults
            expandedStates = {};
            const defaultExpanded = paper.defaults?.expandedAll !== false; // Default true unless explicitly false

            // Flatten questions to set defaults (recursive)
            function initDefaults(nodes) {
                if (!nodes) return;
                nodes.forEach(node => {
                    if (node.solutionBlock?.solutionDetails) {
                        expandedStates[node.id] = defaultExpanded;
                    }
                    if (node.children) initDefaults(node.children);
                });
            }
            
            const rootNodes = paper.questions || (paper.sections ? paper.sections.flatMap(s => s.questions) : []);
            // Note: If sections exist, we process them for defaults. 
            if (paper.sections) {
                paper.sections.forEach(s => initDefaults(s.questions));
            } else {
                initDefaults(paper.questions);
            }

            renderNav(paper);
            renderContent(paper);
            
            // Re-run math rendering
            renderMath();
        }

        // --- NAVIGATION RENDERING ---
        function renderNav(paper) {
            const generateNavHTML = (isMobile) => {
                let html = "";
                
                // Helper for nav items
                const renderItem = (q, depth) => {
                    // Visual hierarchy via type scale/opacity, NO indentation
                    const hierarchyClass = depth === 0 ? "font-medium text-txt-primary text-sm" 
                                         : depth === 1 ? "text-xs text-txt-secondary" 
                                         : "text-[10px] text-txt-secondary/80";
                    
                    const activeClass = ""; // We can add active state logic dynamically if needed, baseline weight only
                    
                    return `
                        <button onclick="scrollToQuestion('${q.id}')" 
                                class="w-full text-left py-1 px-2 hover:bg-black/5 rounded transition-colors ${hierarchyClass} block truncate"
                                title="Question ${q.id}">
                            ${q.id}
                        </button>
                    `;
                };

                const traverse = (nodes, depth) => {
                    let str = "";
                    nodes.forEach(node => {
                        str += renderItem(node, depth);
                        if (node.children && node.children.length > 0) {
                            str += traverse(node.children, depth + 1);
                        }
                    });
                    return str;
                };

                if (paper.sections) {
                    paper.sections.forEach(section => {
                        // Section label (only if non-empty)
                        if (section.label && section.label.trim().length > 0) {
                            html += `
                                <div class="mt-4 mb-2 first:mt-0 px-2 text-[10px] uppercase tracking-wider font-bold text-txt-tertiary select-none">
                                    ${section.label}
                                </div>
                            `;
                        }
                        html += traverse(section.questions, 0);
                        // Separation between sections
                        html += `<div class="h-2"></div>`;
                    });
                } else if (paper.questions) {
                    html += traverse(paper.questions, 0);
                }

                return html;
            };

            const markup = generateNavHTML();
            els.desktopNav.innerHTML = markup;
            els.mobileNav.innerHTML = markup;
        }

        window.scrollToQuestion = (id) => {
            const target = document.getElementById(`q-${id}`);
            if (target) {
                // Smooth scroll
                target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                // Update active state visual (simple implementation)
                updateActiveNav(id);
                // Mobile: close drawer
                closeDrawer();
            }
        };

        function updateActiveNav(id) {
            // Find all nav buttons and reset
            const buttons = document.querySelectorAll('nav button, #mobile-nav-list button');
            buttons.forEach(b => {
                // Reset to default weight based on depth (approximated by checking current class)
                if (b.classList.contains('font-bold')) {
                    b.classList.remove('font-bold');
                    // restore medium if top level? simplistic approach:
                    // just remove the active bold marker.
                }
                // Add bold to current
                if (b.getAttribute('onclick') === `scrollToQuestion('${id}')`) {
                    b.classList.add('font-bold');
                    if (id.length < 3) b.classList.add('text-accent'); // Optional marker for top level
                } else {
                    b.classList.remove('text-accent');
                }
            });
        }

        // --- CONTENT RENDERING ---
        function renderContent(paper) {
            let html = `<div class="bg-paper rounded-sm shadow-sm min-h-full pb-20">`; // Surface SURF__PAPER

            if (paper.sections) {
                paper.sections.forEach(section => {
                    if (section.label && section.label.trim()) {
                        // SURF__SECTION_HEADER
                        html += `
                            <div class="border-b border-hairline pt-8 pb-4 mb-8 px-4 sm:px-8">
                                <h2 class="text-xl font-bold text-txt-primary">${section.label}</h2>
                            </div>
                        `;
                    }
                    html += `<div class="px-4 sm:px-8 space-y-12">`; // Question List Container
                    section.questions.forEach((q, idx) => {
                        html += renderQuestionNode(q, 0, idx === 0);
                    });
                    html += `</div>`;
                    // Spacing between sections
                    html += `<div class="h-16"></div>`;
                });
            } else {
                html += `<div class="px-4 sm:px-8 pt-8 space-y-12">`;
                paper.questions.forEach((q, idx) => {
                    html += renderQuestionNode(q, 0, idx === 0);
                });
                html += `</div>`;
            }
            
            html += `</div>`;
            els.content.innerHTML = html;
        }

        function renderQuestionNode(node, depth, isFirst) {
            // Spacing logic: Top level gets largest spacing (space-y-12 on container).
            // Children get indentation and tighter vertical rhythm.
            
            const indentClass = depth > 0 ? "ml-4 sm:ml-8 mt-6 border-l-2 border-hairline pl-4" : "";
            
            let html = `
                <div id="q-${node.id}" class="relative group ${indentClass}">
            `;
            
            // Question Body (Identifier + Prompt)
            // Layout: Identifier left, Prompt right (flex)
            html += `
                <div class="flex items-start gap-3 sm:gap-4 mb-3">
                    <span class="flex-shrink-0 font-bold text-txt-secondary text-base sm:text-lg select-none min-w-[1.5em]">${node.id}</span>
                    <div class="flex-1 text-base sm:text-lg text-txt-primary leading-relaxed md-content">
                        ${renderMarkdown(node.question)}
                    </div>
                </div>
            `;

            // Solution Block (Optional)
            if (node.solutionBlock) {
                // Wrapper with spacing from question
                html += `<div class="ml-8 sm:ml-12 mt-2 space-y-3">`;

                // Answer (if present)
                if (node.solutionBlock.answer) {
                    html += `
                        <div class="text-base text-txt-primary">
                            <span class="font-bold text-xs uppercase tracking-wide text-txt-tertiary mr-2 select-none">Answer</span>
                            <span class="md-content inline-block align-top font-medium text-txt-primary">
                                ${renderMarkdown(node.solutionBlock.answer)}
                            </span>
                        </div>
                    `;
                }

                // Solution Details (if present)
                if (node.solutionBlock.solutionDetails) {
                    const isExpanded = expandedStates[node.id];
                    const details = node.solutionBlock.solutionDetails;
                    
                    // Disclosure Control
                    html += `
                        <div>
                            <button onclick="toggleWorking('${node.id}')" 
                                    class="text-accent hover:text-accent/80 font-medium text-sm flex items-center gap-1.5 transition-colors focus:outline-none select-none group/btn">
                                <span>${isExpanded ? 'Hide working' : 'Show working'}</span>
                                <i class="ph ${isExpanded ? 'ph-caret-up' : 'ph-caret-down'} text-xs"></i>
                            </button>
                        </div>
                    `;

                    // Expanded Region
                    if (isExpanded) {
                        html += `
                            <div class="mt-2 pl-4 border-l border-hairline bg-wash rounded-r-sm py-4 pr-4 animate-in fade-in slide-in-from-top-1 duration-200">
                        `;

                        // Keep in mind
                        if (details.keepInMind) {
                            html += `
                                <div class="mb-4 text-sm">
                                    <div class="flex items-center gap-2 mb-1 text-txt-secondary font-bold text-xs uppercase tracking-wide">
                                        <i class="ph ph-lightbulb"></i> Keep in mind
                                    </div>
                                    <div class="text-txt-primary/90 md-content">
                                        ${renderMarkdown(details.keepInMind)}
                                    </div>
                                </div>
                            `;
                        }

                        // Formulas Used
                        if (details.formulasUsed) {
                            html += `
                                <div class="mb-4 text-sm">
                                    <div class="mb-1 text-txt-secondary font-bold text-xs uppercase tracking-wide">Formulas used</div>
                                    <div class="text-txt-primary/90 md-content">
                                        ${renderMarkdown(details.formulasUsed)}
                                    </div>
                                </div>
                            `;
                        }

                        // Working (Primary)
                        if (details.working) {
                            html += `
                                <div class="mb-4">
                                    <div class="mb-2 text-txt-secondary font-bold text-xs uppercase tracking-wide">Working</div>
                                    <div class="text-txt-primary md-content text-sm sm:text-base leading-relaxed">
                                        ${renderMarkdown(details.working)}
                                    </div>
                                </div>
                            `;
                        }

                        // Alternative Working (Array)
                        if (details.alternativeWorking && details.alternativeWorking.length > 0) {
                            // Separator
                            html += `<div class="h-px bg-hairline my-4"></div>`;
                            
                            details.alternativeWorking.forEach((alt, i) => {
                                html += `
                                    <div class="mb-4 last:mb-0">
                                        <div class="mb-2 text-txt-secondary font-bold text-xs uppercase tracking-wide">Alternative working ${i > 0 ? i + 1 : ''}</div>
                                        <div class="text-txt-primary md-content text-sm sm:text-base leading-relaxed">
                                            ${renderMarkdown(alt)}
                                        </div>
                                    </div>
                                `;
                            });
                        }

                        html += `</div>`; // End Expanded Region
                    }
                }

                html += `</div>`; // End Solution Block Wrapper
            }

            // Children Recursive
            if (node.children && node.children.length > 0) {
                html += `<div class="mt-2">`;
                node.children.forEach(child => {
                    html += renderQuestionNode(child, depth + 1, false);
                });
                html += `</div>`;
            }

            html += `</div>`; // End Node
            return html;
        }

        function renderMarkdown(text) {
            if (!text) return "";
            if (!md) return text; // Fallback
            // Render MD to HTML
            return md.render(text);
        }

        window.toggleWorking = (id) => {
            // Toggle state
            expandedStates[id] = !expandedStates[id];
            
            // Re-render ONLY content? For this prototype, re-rendering the whole paper is acceptable 
            // but might reset scroll. Better to find the specific node and re-render.
            // For simplicity and robustness in a single-file prototype, we'll re-render full paper content
            // but preserve scroll position carefully.
            
            const scrollPos = els.content.scrollTop; // Wait, content is inside window scroll
            const windowScroll = window.scrollY;
            
            const currentPaper = rawPayload.papers.find(p => p.key === currentPaperKey);
            renderContent(currentPaper);
            renderMath();
            
            // Restore scroll?
            window.scrollTo(0, windowScroll);
        };

        function renderMath() {
            if (window.renderMathInElement) {
                renderMathInElement(els.content, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false}
                    ],
                    throwOnError: false
                });
            }
        }

        // --- MOBILE DRAWER LOGIC ---
        function openDrawer() {
            els.mobileBackdrop.classList.remove('hidden');
            // Trigger reflow for transition
            void els.mobileBackdrop.offsetWidth; 
            els.mobileBackdrop.classList.remove('opacity-0');
            
            els.mobileDrawer.classList.remove('translate-x-full');
        }

        function closeDrawer() {
            els.mobileDrawer.classList.add('translate-x-full');
            els.mobileBackdrop.classList.add('opacity-0');
            setTimeout(() => {
                els.mobileBackdrop.classList.add('hidden');
            }, 300);
        }

        els.mobileTrigger.addEventListener('click', openDrawer);
        els.drawerClose.addEventListener('click', closeDrawer);
        els.mobileBackdrop.addEventListener('click', closeDrawer);

        // --- START ---
        init();

    </script>
</body>
</html>
