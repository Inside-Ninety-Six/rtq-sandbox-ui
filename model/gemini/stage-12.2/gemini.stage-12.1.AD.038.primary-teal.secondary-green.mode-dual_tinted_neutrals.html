<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AD","indexWithinVariant":"38","totalWithinVariant":"440","hueFamily":"","intensityMode":"","primaryHueFamily":"teal","secondaryHueFamily":"green","dualIntensityMode":"dual_tinted_neutrals","timestamp":"2026-01-10T03:49:04.457Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AD&quot;,&quot;indexWithinVariant&quot;:&quot;38&quot;,&quot;totalWithinVariant&quot;:&quot;440&quot;,&quot;hueFamily&quot;:&quot;&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;primaryHueFamily&quot;:&quot;teal&quot;,&quot;secondaryHueFamily&quot;:&quot;green&quot;,&quot;dualIntensityMode&quot;:&quot;dual_tinted_neutrals&quot;,&quot;timestamp&quot;:&quot;2026-01-10T03:49:04.457Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer (Stage 6 Baseline)</title>

    <!-- 
        STAGE 6 BASELINE: LIBRARIES
        SRI disabled per Stage 6.0.7b.
        No integrity attributes.
    -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <style>
        /* 
         * STAGE 6 ADD-ON: COLORLAB D (Dual-Accent, Light Only)
         * Mode: dual_tinted_neutrals
         * Primary Hue: Blue (Fallback) -> approx 260
         * Secondary Hue: Amber (Fallback) -> approx 85
         * 
         * Logic:
         * 1. Core surfaces tinted with Primary.
         * 2. Text near-neutral.
         * 3. Two hues only for accents.
         */
        :root {
            /* --- Hues --- */
            --hue-primary: 260;
            --hue-secondary: 85;

            /* --- Surfaces (Mode 2: dual_tinted_neutrals) --- */
            /* Page Bg: L ~0.97, C ~0.02 */
            --color-surface-page: oklch(0.97 0.02 var(--hue-primary));
            /* Frame Base: L ~0.95, C ~0.025 */
            --color-surface-frame: oklch(0.95 0.025 var(--hue-primary));
            /* Paper Surface: L ~0.99, C ~0.015 */
            --color-surface-paper: oklch(0.99 0.015 var(--hue-primary));
            /* Solution Wash: L ~0.96, C ~0.03 */
            --color-surface-wash: oklch(0.96 0.03 var(--hue-primary));
            /* Drawer Overlay Scrim */
            --color-scrim: oklch(0 0 0 / 0.4);

            /* --- Text (Near-neutral) --- */
            /* Primary: L ~0.25, C ~0.01 */
            --color-text-primary: oklch(0.25 0.01 var(--hue-primary));
            /* Secondary: L ~0.45, C ~0.012 */
            --color-text-secondary: oklch(0.45 0.012 var(--hue-primary));
            /* Quietest (Nav/Labels): L ~0.55 */
            --color-text-tertiary: oklch(0.55 0.012 var(--hue-primary));

            /* --- Accents (Dual Hue Discipline) --- */
            /* Primary Accent (Links, Focus, Active Nav): C ~0.14 */
            --color-accent-primary: oklch(0.55 0.14 var(--hue-primary));
            /* Secondary Accent (Supplementary - e.g. Callout/Icon): C ~0.12 */
            --color-accent-secondary: oklch(0.65 0.12 var(--hue-secondary));

            /* --- Lines / Dividers --- */
            --color-hairline: oklch(0.88 0.005 var(--hue-primary));

            /* --- Spacing System (Paper-like rhythm) --- */
            --space-xs: 0.25rem;
            --space-sm: 0.5rem;   /* Internal semantic grouping */
            --space-md: 1rem;     /* Standard separation */
            --space-lg: 1.5rem;   /* Section separation */
            --space-xl: 2.5rem;   /* Top-level question separation */
            
            /* --- Layout --- */
            --max-width-paper: 48rem; /* ~768px for readable line length */
            --nav-width: 12rem;
            
            /* --- Typography --- */
            --font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            --font-size-base: 1rem;
            --font-size-sm: 0.875rem;
            --font-size-xs: 0.75rem;
        }

        /* --- Reset & Base --- */
        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--color-surface-page);
            color: var(--color-text-primary);
            font-family: var(--font-family);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        button {
            font: inherit;
            color: inherit;
            border: none;
            background: none;
            cursor: pointer;
            padding: 0;
        }

        /* Focus Visibility (Stage 5.5.2) */
        :focus-visible {
            outline: 2px solid var(--color-accent-primary);
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* --- Structure: DocumentFrameShell --- */
        .shell-container {
            max-width: 80rem;
            margin: 0 auto;
            min-height: 100vh;
            background-color: var(--color-surface-frame);
            display: flex;
            flex-direction: column;
        }

        /* Top Controls Region */
        .top-controls {
            padding: var(--space-md);
            border-bottom: 1px solid var(--color-hairline);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--color-surface-frame); /* Matches shell */
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .paper-selector {
            font-size: var(--font-size-sm);
            padding: var(--space-xs) var(--space-sm);
            border: 1px solid var(--color-hairline);
            border-radius: 4px;
            background-color: var(--color-surface-paper);
            color: var(--color-text-primary);
        }

        .jump-to-trigger {
            font-size: var(--font-size-sm);
            color: var(--color-accent-primary);
            font-weight: 500;
            display: none; /* Desktop default */
        }

        /* Main Content Grid */
        .main-grid {
            display: flex;
            flex: 1;
        }

        /* --- Navigation Rail (Desktop) --- */
        .nav-rail {
            width: var(--nav-width);
            flex-shrink: 0;
            padding: var(--space-md) 0 var(--space-md) var(--space-md);
            /* Sticky Logic */
            position: sticky;
            top: 4rem; /* Offset for top controls */
            height: calc(100vh - 4rem);
            overflow-y: auto;
            display: none; /* Mobile default */
            
            /* Hide Scrollbars (Stage 6 Add-on) */
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE/Edge */
        }
        .nav-rail::-webkit-scrollbar {
            display: none;
        }

        /* --- Paper Column --- */
        .paper-column {
            flex: 1;
            padding: var(--space-md);
            display: flex;
            justify-content: center;
        }

        .paper-region {
            width: 100%;
            max-width: var(--max-width-paper);
            background-color: var(--color-surface-paper);
            min-height: 50vh;
            /* Paper surface is distinct but quiet */
        }

        /* --- Navigation Components --- */
        .nav-list {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .nav-section-label {
            font-size: var(--font-size-xs);
            color: var(--color-text-tertiary);
            font-weight: 600;
            text-transform: uppercase;
            padding: var(--space-sm) 0 var(--space-xs) 0;
            margin-top: var(--space-sm);
            border-bottom: 1px solid transparent; /* Placeholder for spacing */
            cursor: default;
        }

        .nav-item {
            text-align: left;
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
            padding: var(--space-xs) 0;
            cursor: pointer;
            transition: color 0.1s ease;
        }

        .nav-item:hover {
            color: var(--color-accent-primary);
            text-decoration: underline;
            text-decoration-color: var(--color-hairline);
        }

        .nav-item.active {
            color: var(--color-accent-primary);
            font-weight: 700;
        }

        /* --- Question Nodes --- */
        .question-node {
            margin-bottom: var(--space-xl); /* Top-level spacing */
            scroll-margin-top: 5rem; /* Anchor offset */
        }

        .question-node .question-node {
            margin-bottom: var(--space-md); /* Child spacing */
            margin-top: var(--space-md);
        }

        .question-body {
            /* Anchor for reading */
            color: var(--color-text-primary);
        }
        
        .question-identifier {
            font-weight: 600;
            margin-right: var(--space-sm);
        }

        .question-content {
            display: inline;
        }

        .children-container {
            margin-left: var(--space-md); /* Indentation for children */
            margin-top: var(--space-md);
        }

        /* --- Solution Block --- */
        .solution-block {
            margin-top: var(--space-md);
        }

        .answer-region {
            margin-bottom: var(--space-sm);
            font-weight: 500;
            color: var(--color-text-primary);
        }
        
        .answer-label {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
            margin-right: var(--space-xs);
            font-weight: 700;
        }

        /* --- Solution Details --- */
        .disclosure-control {
            font-size: var(--font-size-sm);
            color: var(--color-accent-primary);
            margin-bottom: var(--space-sm);
            display: inline-flex;
            align-items: center;
            gap: var(--space-xs);
        }
        
        .disclosure-control:hover {
            text-decoration: underline;
        }

        .solution-details-region {
            background-color: var(--color-surface-wash);
            padding: var(--space-md);
            border-radius: 2px; /* Minimal softness */
            /* Quiet hairline boundary for density resilience */
            border-left: 2px solid var(--color-hairline); 
            display: none; /* Collapsed by default */
        }

        .solution-details-region.expanded {
            display: block;
            animation: slideDown 0.2s ease-out;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Subsections */
        .sd-subsection {
            margin-bottom: var(--space-md);
        }
        .sd-subsection:last-child {
            margin-bottom: 0;
        }

        .sd-label {
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: var(--space-xs);
            display: block;
        }

        /* Specific visual tweaks for subsection types */
        .sd-keep-in-mind .sd-label {
            color: var(--color-accent-secondary); /* Hint of secondary accent */
        }

        .sd-body {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary); /* Slightly subordinate */
        }
        
        /* Markdown Content Styling */
        .markdown-content p {
            margin-top: 0;
            margin-bottom: 0.75em;
        }
        .markdown-content p:last-child {
            margin-bottom: 0;
        }
        .markdown-content ul, .markdown-content ol {
            margin-top: 0;
            margin-bottom: 0.75em;
            padding-left: 1.25em;
        }
        .markdown-content table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 0.75em;
            font-size: var(--font-size-sm);
        }
        .markdown-content th, .markdown-content td {
            border: 1px solid var(--color-hairline);
            padding: var(--space-xs) var(--space-sm);
            text-align: left;
        }
        
        /* KaTeX Containment Invariant (Locked) */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding: 0.5em 0;
            /* Underlay rule: Only block math gets background if needed, but here we use transparency 
               unless specifically targeting block math containers. 
               Stage 5.8.4 says inline math transparent. Block math allowed subtle underlay.
               We stick to transparent to keep it clean in ColorLab D Mode 2. 
            */
            background: transparent; 
        }
        
        /* --- Mobile Drawer (Option A) --- */
        .drawer-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--color-scrim);
            z-index: 100;
            display: none;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .drawer-overlay.open {
            display: block;
            opacity: 1;
        }

        .drawer-panel {
            position: absolute;
            top: 0; bottom: 0; right: 0; /* Right side drawer per typical mobile patterns or Left? Brief says "Jump to" trigger... usually implies quick access. Let's do Right for thumb access. */
            width: 80%;
            max-width: 20rem;
            background-color: var(--color-surface-frame);
            box-shadow: -2px 0 8px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.2s ease;
        }
        .drawer-overlay.open .drawer-panel {
            transform: translateX(0);
        }

        .drawer-header {
            padding: var(--space-md);
            border-bottom: 1px solid var(--color-hairline);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .drawer-title {
            font-weight: 700;
            color: var(--color-text-primary);
        }
        .drawer-close {
            font-size: 1.5rem;
            line-height: 1;
            padding: var(--space-xs);
        }

        .drawer-content {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-md);
        }

        /* --- Responsive Rules --- */
        @media (min-width: 768px) {
            .nav-rail {
                display: block;
            }
            .jump-to-trigger {
                display: none;
            }
        }
        @media (max-width: 767px) {
            .main-grid {
                flex-direction: column;
            }
            .jump-to-trigger {
                display: block;
            }
            .nav-rail {
                display: none; /* Stick to drawer on mobile */
            }
            .paper-column {
                padding: var(--space-md) var(--space-sm);
            }
            .children-container {
                margin-left: var(--space-sm); /* Reduce indent on mobile */
            }
        }
        
        /* Loading/Error State */
        .status-message {
            text-align: center;
            padding: var(--space-xl);
            color: var(--color-text-secondary);
            font-weight: 500;
        }

    </style>
</head>
<body>

<div class="shell-container">
    <!-- Top Controls -->
    <header class="top-controls">
        <select id="paperSelector" class="paper-selector" aria-label="Select Paper">
            <option value="" disabled selected>Loading papers...</option>
        </select>
        <button id="jumpToTrigger" class="jump-to-trigger">Jump to</button>
    </header>

    <!-- Main Grid -->
    <div class="main-grid">
        <!-- Desktop Nav Rail -->
        <nav class="nav-rail" id="desktopNav" aria-label="Document Navigation">
            <!-- Injected by JS -->
        </nav>

        <!-- Paper Content Column -->
        <main class="paper-column" id="paperScrollContainer">
            <div id="paperContent" class="paper-region">
                <div class="status-message">Loading payload...</div>
            </div>
        </main>
    </div>
</div>

<!-- Mobile Navigation Drawer -->
<div id="drawerOverlay" class="drawer-overlay" aria-hidden="true">
    <div class="drawer-panel" role="dialog" aria-modal="true" aria-label="Navigation">
        <div class="drawer-header">
            <span class="drawer-title">Jump to</span>
            <button id="drawerClose" class="drawer-close" aria-label="Close navigation">&times;</button>
        </div>
        <div class="drawer-content" id="drawerNavList">
            <!-- Injected by JS -->
        </div>
    </div>
</div>

<script>
    /* 
     * STAGE 0: CONSTANTS (Canonical) 
     */
    const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
    const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

    // Application State
    let payload = null;
    let currentPaperKey = null;

    // DOM Elements
    const paperSelector = document.getElementById('paperSelector');
    const desktopNav = document.getElementById('desktopNav');
    const paperContent = document.getElementById('paperContent');
    const jumpToTrigger = document.getElementById('jumpToTrigger');
    const drawerOverlay = document.getElementById('drawerOverlay');
    const drawerClose = document.getElementById('drawerClose');
    const drawerNavList = document.getElementById('drawerNavList');

    /* 
     * MARKDOWN RENDERER CONFIG (Stage 6 Add-on)
     */
    const md = window.markdownit ? window.markdownit({
        html: true,     // Allow inline SVG
        linkify: true,
        breaks: false   // MUST stay false to prevent <br> in math blocks
    }) : null;

    if (md) {
        // Disable inline escape to preserve TeX backslashes
        md.inline.ruler.disable(['escape']);
    }

    /* 
     * INITIALIZATION 
     */
    async function init() {
        try {
            const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
            if (!response.ok) throw new Error('Network error');
            payload = await response.json();
            
            if (!payload || !payload.papers) throw new Error('Invalid payload');

            populateSelector();
            
            // Select first paper by default
            if (payload.papers.length > 0) {
                loadPaper(payload.papers[0].key);
            }
        } catch (error) {
            console.error(error);
            renderError("PAPERS PAYLOAD MISSING");
        }
    }

    function renderError(msg) {
        paperContent.innerHTML = `<div class="status-message">${msg}</div>`;
        paperSelector.innerHTML = '<option disabled>Error</option>';
    }

    function populateSelector() {
        paperSelector.innerHTML = '';
        payload.papers.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.key;
            opt.textContent = p.label;
            paperSelector.appendChild(opt);
        });
        paperSelector.addEventListener('change', (e) => loadPaper(e.target.value));
    }

    /* 
     * PAPER LOADING & RENDERING
     */
    function loadPaper(key) {
        currentPaperKey = key;
        const paper = payload.papers.find(p => p.key === key);
        if (!paper) return;

        // Reset scroll
        window.scrollTo(0, 0);

        // 1. Render Content
        renderPaperContent(paper);

        // 2. Render Navigation
        const navHtml = buildNavigationHtml(paper);
        desktopNav.innerHTML = navHtml;
        drawerNavList.innerHTML = navHtml; // Re-use html structure for drawer

        // 3. KaTeX Auto-Render
        renderMathInElement(paperContent, {
            delimiters: [
                {left: "$$", right: "$$", display: true},
                {left: "$", right: "$", display: false}
            ],
            throwOnError: false
        });

        // 4. Bind Events (Nav clicks, Toggles)
        bindInteractionEvents();
    }

    function renderPaperContent(paper) {
        // Clear container
        paperContent.innerHTML = '';

        // Flatten logic for rendering: 
        // Payload can have questions[] OR sections[].
        // We render linearly.
        
        let html = '';

        if (paper.sections) {
            paper.sections.forEach(section => {
                // Section Header (only if label exists)
                if (section.label && section.label.trim()) {
                    html += `<div class="question-node" style="border-bottom: 1px solid var(--color-hairline); margin-bottom: var(--space-lg); padding-bottom: var(--space-xs);">
                                <span style="font-weight:700; color:var(--color-text-secondary); font-size:1.25rem;">${section.label}</span>
                             </div>`;
                }
                section.questions.forEach(q => {
                    html += renderQuestionNode(q, paper.defaults || {}, 0);
                });
            });
        } else if (paper.questions) {
            paper.questions.forEach(q => {
                html += renderQuestionNode(q, paper.defaults || {}, 0);
            });
        } else {
            html = '<div class="status-message">No questions found.</div>';
        }

        paperContent.innerHTML = html;
    }

    function renderQuestionNode(node, defaults, depth) {
        // Recursive rendering
        // IDs: use node.id for display, and sanitize for HTML id attribute
        const safeId = `q-${node.id.replace(/[^a-zA-Z0-9-]/g, '_')}`;
        
        // Solution Block Logic
        const sb = node.solutionBlock;
        const hasSolutionDetails = sb && sb.solutionDetails;
        const hasAnswer = sb && sb.answer;
        
        // Expansion Default
        const isExpanded = defaults.expandedAll !== false; 
        const expandedClass = isExpanded ? 'expanded' : '';
        const toggleText = isExpanded ? 'Hide working' : 'Show working';

        let html = `<div class="question-node" id="${safeId}" data-depth="${depth}">`;
        
        // Question Body
        html += `<div class="question-body">
                    <span class="question-identifier">${node.id}</span>
                    <div class="question-content markdown-content">${renderMarkdown(node.question)}</div>
                 </div>`;

        // Solution Block (Optional)
        if (sb) {
            html += `<div class="solution-block">`;
            
            // Answer
            if (hasAnswer) {
                html += `<div class="answer-region">
                            <span class="answer-label">Answer</span>
                            <span class="markdown-content" style="display:inline;">${renderMarkdown(sb.answer)}</span>
                         </div>`;
            }

            // Solution Details
            if (hasSolutionDetails) {
                const sd = sb.solutionDetails;
                
                // Toggle
                html += `<button class="disclosure-control" type="button" aria-expanded="${isExpanded}">
                            <span class="toggle-text">${toggleText}</span>
                         </button>`;
                
                // Details Region
                html += `<div class="solution-details-region ${expandedClass}">`;
                
                // Keep in mind
                if (sd.keepInMind) {
                    html += `<div class="sd-subsection sd-keep-in-mind">
                                <span class="sd-label">Keep in mind</span>
                                <div class="sd-body markdown-content">${renderMarkdown(sd.keepInMind)}</div>
                             </div>`;
                }

                // Formulas used
                if (sd.formulasUsed) {
                    html += `<div class="sd-subsection sd-formulas-used">
                                <span class="sd-label">Formulas used</span>
                                <div class="sd-body markdown-content">${renderMarkdown(sd.formulasUsed)}</div>
                             </div>`;
                }

                // Working (Primary)
                if (sd.working) {
                    html += `<div class="sd-subsection sd-working">
                                <span class="sd-label">Working</span>
                                <div class="sd-body markdown-content">${renderMarkdown(sd.working)}</div>
                             </div>`;
                }

                // Alternative Working (Array)
                if (sd.alternativeWorking && Array.isArray(sd.alternativeWorking)) {
                    sd.alternativeWorking.forEach((alt, idx) => {
                        html += `<div class="sd-subsection sd-alternative-working">
                                    <span class="sd-label">Alternative working</span>
                                    <div class="sd-body markdown-content">${renderMarkdown(alt)}</div>
                                 </div>`;
                    });
                } else if (sd.alternativeWorking && typeof sd.alternativeWorking === 'string') {
                     // Handle single string case gracefully just in case
                     html += `<div class="sd-subsection sd-alternative-working">
                                    <span class="sd-label">Alternative working</span>
                                    <div class="sd-body markdown-content">${renderMarkdown(sd.alternativeWorking)}</div>
                                 </div>`;
                }

                html += `</div>`; // End Details Region
            }

            html += `</div>`; // End Solution Block
        }

        // Recursion for children
        if (node.children && node.children.length > 0) {
            html += `<div class="children-container">`;
            node.children.forEach(child => {
                html += renderQuestionNode(child, defaults, depth + 1);
            });
            html += `</div>`;
        }

        html += `</div>`; // End Node
        return html;
    }

    function renderMarkdown(text) {
        if (!text) return '';
        if (!md) return text; // Fallback
        return md.render(text);
    }

    function buildNavigationHtml(paper) {
        let navHtml = '<div class="nav-list">';
        
        const buildList = (nodes) => {
            let str = '';
            nodes.forEach(node => {
                const safeId = `q-${node.id.replace(/[^a-zA-Z0-9-]/g, '_')}`;
                // Hierarchy via type scale is handled via data attributes or implicit styling if needed.
                // Here we keep it simple flat per Stage 5.4.5, children appear immediately below.
                str += `<div class="nav-item" data-target="${safeId}">${node.id}</div>`;
                
                if (node.children && node.children.length > 0) {
                    str += buildList(node.children);
                }
            });
            return str;
        };

        if (paper.sections) {
            paper.sections.forEach(section => {
                if (section.label && section.label.trim()) {
                    navHtml += `<div class="nav-section-label">${section.label}</div>`;
                }
                navHtml += buildList(section.questions);
            });
        } else if (paper.questions) {
            navHtml += buildList(paper.questions);
        }

        navHtml += '</div>';
        return navHtml;
    }

    /* 
     * INTERACTION HANDLING
     */
    function bindInteractionEvents() {
        // Navigation Clicks (Delegation)
        const handleNavClick = (e) => {
            if (e.target.classList.contains('nav-item')) {
                const targetId = e.target.dataset.target;
                const targetEl = document.getElementById(targetId);
                if (targetEl) {
                    // Update active state
                    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                    // Highlight all nav items pointing to this id (desktop + mobile)
                    document.querySelectorAll(`.nav-item[data-target="${targetId}"]`).forEach(el => el.classList.add('active'));
                    
                    targetEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    
                    // Close drawer if open
                    closeDrawer();
                }
            }
        };

        desktopNav.onclick = handleNavClick;
        drawerNavList.onclick = handleNavClick;

        // Disclosure Toggles (Delegation)
        paperContent.onclick = (e) => {
            const btn = e.target.closest('.disclosure-control');
            if (btn) {
                const region = btn.nextElementSibling; // The .solution-details-region
                const isExpanded = region.classList.contains('expanded');
                
                if (isExpanded) {
                    region.classList.remove('expanded');
                    btn.setAttribute('aria-expanded', 'false');
                    btn.querySelector('.toggle-text').textContent = 'Show working';
                } else {
                    region.classList.add('expanded');
                    btn.setAttribute('aria-expanded', 'true');
                    btn.querySelector('.toggle-text').textContent = 'Hide working';
                }
            }
        };
    }

    /* 
     * DRAWER LOGIC
     */
    function openDrawer() {
        drawerOverlay.classList.add('open');
        drawerOverlay.setAttribute('aria-hidden', 'false');
        // Trap focus logic omitted for brevity in prototype, but structure exists
    }

    function closeDrawer() {
        drawerOverlay.classList.remove('open');
        drawerOverlay.setAttribute('aria-hidden', 'true');
    }

    jumpToTrigger.addEventListener('click', openDrawer);
    drawerClose.addEventListener('click', closeDrawer);
    drawerOverlay.addEventListener('click', (e) => {
        if (e.target === drawerOverlay) closeDrawer();
    });

    // Run Init
    init();

</script>
</body>
</html>
