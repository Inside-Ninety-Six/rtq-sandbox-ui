<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AD","indexWithinVariant":"171","totalWithinVariant":"440","hueFamily":"","intensityMode":"","primaryHueFamily":"teal","secondaryHueFamily":"green","dualIntensityMode":"dual_high_chroma_surfaces","timestamp":"2026-01-10T09:37:28.403Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AD&quot;,&quot;indexWithinVariant&quot;:&quot;171&quot;,&quot;totalWithinVariant&quot;:&quot;440&quot;,&quot;hueFamily&quot;:&quot;&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;primaryHueFamily&quot;:&quot;teal&quot;,&quot;secondaryHueFamily&quot;:&quot;green&quot;,&quot;dualIntensityMode&quot;:&quot;dual_high_chroma_surfaces&quot;,&quot;timestamp&quot;:&quot;2026-01-10T09:37:28.403Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer (Stage 6)</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- KaTeX (SRI disabled per Stage 6.0.7b) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Markdown-it (SRI disabled) -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Custom Styles -->
    <style>
        /* Base typography and scroll behavior */
        html {
            scroll-behavior: smooth;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* 
           COLORLAB D: Mode 3 (dual_high_chroma_surfaces) 
           Primary Hue: 265 (Blue)
           Secondary Hue: 85 (Amber)
        */
        :root {
            /* Surfaces (Primary derived) */
            --color-surface-page: oklch(0.95 0.06 265);    /* High chroma surface 1 */
            --color-surface-frame: oklch(0.93 0.08 265);   /* High chroma surface 2 */
            --color-surface-paper: oklch(0.99 0.03 265);   /* Remaining major surface */
            --color-surface-wash: oklch(0.96 0.05 265);    /* Solution details wash */
            
            /* Text (Neutral-ish) */
            --color-text-primary: oklch(0.20 0.015 265);
            --color-text-secondary: oklch(0.45 0.015 265);

            /* Accents */
            --color-accent-primary: oklch(0.55 0.18 265);  /* Links, Focus, Toggle Text */
            --color-accent-secondary: oklch(0.75 0.16 85); /* Supplementary role */
            
            /* Lines */
            --color-border: oklch(0.85 0.02 265);
        }

        body {
            background-color: var(--color-surface-page);
            color: var(--color-text-primary);
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        /* Focus styles - ColorLab D primary accent */
        :focus-visible {
            outline: 2px solid var(--color-accent-primary);
            outline-offset: 2px;
        }

        /* Hide scrollbar for nav but keep functional */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* KaTeX Containment Invariant */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            padding-bottom: 4px; /* Space for scrollbar */
            max-width: 100%;
        }
        
        /* Inline math background constraint */
        .katex {
            background-color: transparent !important;
        }
        
        /* Markdown tables */
        .md-content table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
            font-size: 0.9em;
        }
        .md-content th, .md-content td {
            border: 1px solid var(--color-border);
            padding: 0.5rem;
            text-align: left;
        }
        .md-content th {
            font-weight: 600;
        }

        /* Layout Utilities */
        .surface-frame { background-color: var(--color-surface-frame); }
        .surface-paper { background-color: var(--color-surface-paper); }
        .surface-wash { background-color: var(--color-surface-wash); }
        
        .text-primary { color: var(--color-text-primary); }
        .text-secondary { color: var(--color-text-secondary); }
        .text-accent-primary { color: var(--color-accent-primary); }
        .text-accent-secondary { color: var(--color-accent-secondary); }
        
        .border-quiet { border-color: var(--color-border); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // ============================================================================
        // STAGE 0: CONSTANTS (Canonical)
        // ============================================================================
        
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // ============================================================================
        // UTILS
        // ============================================================================

        // Initialize Markdown-it with Stage 6 requirements
        const md = window.markdownit ? window.markdownit({
            html: true,     // Allow inline SVG
            linkify: true,
            breaks: false   // Critical: prevents <br> in math
        }) : null;

        if (md) {
            // Disable escape rule to preserve TeX backslashes
            md.inline.ruler.disable(['escape']);
        }

        /**
         * Renders Markdown content and applies KaTeX
         */
        const MarkdownContent = ({ content, className = "" }) => {
            const containerRef = React.useRef(null);

            React.useEffect(() => {
                if (!containerRef.current || !content) return;
                
                // 1. Render Markdown to HTML
                if (md) {
                    containerRef.current.innerHTML = md.render(content);
                } else {
                    containerRef.current.innerText = content; // Fallback
                }

                // 2. Render KaTeX
                if (window.renderMathInElement) {
                    window.renderMathInElement(containerRef.current, {
                        delimiters: [
                            {left: '$$', right: '$$', display: true},
                            {left: '$', right: '$', display: false}
                        ],
                        throwOnError: false,
                        trust: true // Allow basic HTML in math if needed
                    });
                }
                
                // 3. Lucide icons replacement (if any inline icons used)
                if (window.lucide) {
                    window.lucide.createIcons({ root: containerRef.current });
                }

            }, [content]);

            return (
                <div 
                    ref={containerRef} 
                    className={`md-content leading-relaxed max-w-none break-words ${className}`}
                />
            );
        };

        // Helper to flatten question tree for navigation
        const flattenQuestions = (questions, depth = 0) => {
            let flat = [];
            questions.forEach(q => {
                flat.push({ ...q, depth });
                if (q.children && q.children.length > 0) {
                    flat = flat.concat(flattenQuestions(q.children, depth + 1));
                }
            });
            return flat;
        };

        // ============================================================================
        // COMPONENTS
        // ============================================================================

        const PaperSelector = ({ papers, currentPaperKey, onSelect }) => {
            return (
                <div className="flex items-center gap-3">
                    <label htmlFor="paper-select" className="text-sm font-medium text-secondary">
                        Paper:
                    </label>
                    <div className="relative">
                        <select 
                            id="paper-select"
                            value={currentPaperKey}
                            onChange={(e) => onSelect(e.target.value)}
                            className="appearance-none surface-paper border border-quiet rounded px-3 py-1.5 pr-8 text-sm text-primary focus:outline-none focus:ring-2 focus:ring-[var(--color-accent-primary)] cursor-pointer"
                        >
                            {papers.map(p => (
                                <option key={p.key} value={p.key}>
                                    {p.label}
                                </option>
                            ))}
                        </select>
                        <div className="absolute right-2 top-1/2 -translate-y-1/2 pointer-events-none text-secondary">
                            <i data-lucide="chevron-down" className="w-4 h-4"></i>
                        </div>
                    </div>
                </div>
            );
        };

        const NavItem = ({ id, active, onClick, depth }) => {
            // Stage 5.4.5: Hierarchy via type scale only, flat left edge
            const fontSize = depth === 0 ? 'text-sm' : depth === 1 ? 'text-xs' : 'text-[11px]';
            const weight = active ? 'font-bold' : 'font-normal';
            const color = active ? 'text-accent-primary' : (depth === 0 ? 'text-primary' : 'text-secondary');
            
            // Current item cue: Weight only (Stage 6.0.2), optional color accent permitted by override
            return (
                <button
                    onClick={onClick}
                    className={`block w-full text-left py-1.5 ${fontSize} ${weight} ${color} hover:underline decoration-[var(--color-accent-primary)] decoration-1 underline-offset-2 transition-colors duration-200`}
                >
                    {id}
                </button>
            );
        };

        const NavigationList = ({ items, currentQuestionId, onNavigate }) => {
            // Items might be a flat list of questions OR structured sections
            // For this implementation, we handle both via a normalized structure passed in
            return (
                <nav className="space-y-1" aria-label="Paper navigation">
                    {items.map((item, idx) => {
                        if (item.isSectionLabel) {
                            // Section Header (non-clickable)
                            return (
                                <div key={`sec-${idx}`} className="pt-4 pb-2 text-xs font-semibold text-secondary uppercase tracking-wider">
                                    {item.label}
                                </div>
                            );
                        }
                        
                        return (
                            <NavItem 
                                key={item.id}
                                id={item.id}
                                depth={item.depth}
                                active={currentQuestionId === item.id}
                                onClick={() => onNavigate(item.id)}
                            />
                        );
                    })}
                </nav>
            );
        };

        const SolutionDetails = ({ details }) => {
            // Canonical Order: Keep in mind -> Formulas -> Working -> Alternative
            const { keepInMind, formulasUsed, working, alternativeWorking } = details;

            return (
                <div className="pt-4 space-y-6">
                    {/* Keep in mind */}
                    {keepInMind && (
                        <div className="space-y-2">
                            <div className="flex items-center gap-2 text-sm font-bold text-accent-secondary">
                                <i data-lucide="lightbulb" className="w-4 h-4"></i>
                                <span>Keep in mind</span>
                            </div>
                            <MarkdownContent content={keepInMind} className="text-sm text-secondary pl-6" />
                        </div>
                    )}

                    {/* Formulas used */}
                    {formulasUsed && (
                        <div className="space-y-2">
                            <div className="text-sm font-bold text-secondary">Formulas used</div>
                            <MarkdownContent content={formulasUsed} className="text-sm text-secondary" />
                        </div>
                    )}

                    {/* Working (Primary) */}
                    {working && (
                        <div className="space-y-2">
                            <div className="text-sm font-bold text-secondary">Working</div>
                            <MarkdownContent content={working} className="text-base text-primary" />
                        </div>
                    )}

                    {/* Alternative Working (Array) */}
                    {alternativeWorking && alternativeWorking.length > 0 && (
                        <div className="space-y-6 pt-4 border-t border-quiet border-dashed">
                            {alternativeWorking.map((alt, idx) => (
                                <div key={idx} className="space-y-2">
                                    <div className="text-sm font-bold text-secondary">Alternative working</div>
                                    <MarkdownContent content={alt} className="text-base text-primary" />
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        const QuestionNode = ({ node, depth, paperDefaults }) => {
            const [expanded, setExpanded] = React.useState(
                paperDefaults?.expandedAll !== false
            );
            
            const hasAnswer = node.solutionBlock?.answer;
            const hasSolutionDetails = node.solutionBlock?.solutionDetails;
            
            // Toggle Logic: 
            // - If Solution Details exist, we show a toggle.
            // - Interaction affects only this node's solution details region.
            
            return (
                <div 
                    id={`q-${node.id}`} 
                    className={`relative scroll-mt-24 ${depth === 0 ? 'mb-12' : 'mb-6 mt-4 ml-0 md:ml-6'}`}
                >
                    {/* Top Level Separation (only for depth 0) handled by margin-bottom */}
                    
                    {/* Question Body */}
                    <div className="mb-4">
                        <div className="flex items-baseline gap-3">
                            <span className="text-sm font-bold text-secondary shrink-0 select-none">
                                {node.id}
                            </span>
                            <div className="flex-1">
                                <MarkdownContent content={node.question} className="text-lg text-primary" />
                            </div>
                        </div>
                    </div>

                    {/* Solution Block (Optional) */}
                    {(hasAnswer || hasSolutionDetails) && (
                        <div className="ml-0 pl-0 md:ml-[calc(1rem+0.75rem)] border-t border-transparent"> 
                            {/* Alignment: indent to match text start */}
                            
                            {/* Answer (Visible by default) */}
                            {hasAnswer && (
                                <div className="mb-4">
                                    <div className="text-xs font-bold text-secondary mb-1">Answer</div>
                                    <MarkdownContent content={node.solutionBlock.answer} className="text-base font-medium text-primary" />
                                </div>
                            )}

                            {/* Solution Details (Expandable) */}
                            {hasSolutionDetails && (
                                <div>
                                    {/* Disclosure Control */}
                                    <button 
                                        onClick={() => setExpanded(!expanded)}
                                        className="group flex items-center gap-2 text-sm font-medium text-accent-primary hover:text-[oklch(0.45_0.18_265)] transition-colors focus:outline-none focus:ring-2 focus:ring-[var(--color-accent-primary)] rounded px-1 -ml-1 py-1"
                                        aria-expanded={expanded}
                                    >
                                        <span className="transition-transform duration-200 group-aria-expanded:rotate-90">
                                            <i data-lucide="chevron-right" className="w-4 h-4"></i>
                                        </span>
                                        <span>{expanded ? 'Hide working' : 'Show working'}</span>
                                    </button>

                                    {/* Expanded Region */}
                                    {expanded && (
                                        <div className="mt-2 pl-4 border-l-2 border-quiet surface-wash rounded-r-md p-4 animate-in fade-in slide-in-from-top-2 duration-200">
                                            <SolutionDetails details={node.solutionBlock.solutionDetails} />
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    )}

                    {/* Recursive Children */}
                    {node.children && node.children.length > 0 && (
                        <div className="mt-6 border-l border-quiet pl-4 md:pl-0 md:border-none">
                            {node.children.map((child, idx) => (
                                <QuestionNode 
                                    key={child.id} 
                                    node={child} 
                                    depth={depth + 1} 
                                    paperDefaults={paperDefaults} 
                                />
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        const PaperRegion = ({ paper }) => {
            // Determine structure: Sections or Flat Questions
            const isSectioned = paper.sections && paper.sections.length > 0;
            
            return (
                <div className="surface-paper min-h-[80vh] shadow-sm max-w-4xl mx-auto p-6 md:p-12 lg:p-16">
                    {/* Paper Title/Header if needed, though brief says 'single linear document' */}
                    
                    {isSectioned ? (
                        paper.sections.map((section, sIdx) => (
                            <div key={sIdx} className="mb-16">
                                {section.label && (
                                    <div className="mb-8 border-b border-quiet pb-2">
                                        <h2 className="text-lg font-bold text-secondary uppercase tracking-widest">
                                            Section {section.label}
                                        </h2>
                                    </div>
                                )}
                                <div>
                                    {section.questions.map((q) => (
                                        <QuestionNode 
                                            key={q.id} 
                                            node={q} 
                                            depth={0} 
                                            paperDefaults={paper.defaults} 
                                        />
                                    ))}
                                </div>
                            </div>
                        ))
                    ) : (
                        <div>
                            {paper.questions.map((q) => (
                                <QuestionNode 
                                    key={q.id} 
                                    node={q} 
                                    depth={0} 
                                    paperDefaults={paper.defaults} 
                                />
                            ))}
                        </div>
                    )}
                    
                    {/* End of Paper Visual Anchor */}
                    <div className="mt-24 pt-8 border-t border-quiet text-center text-secondary text-sm">
                        End of Paper
                    </div>
                </div>
            );
        };

        const MobileDrawer = ({ isOpen, onClose, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex justify-end sm:justify-start">
                    {/* Scrim */}
                    <div className="absolute inset-0 bg-black/20 backdrop-blur-sm" onClick={onClose}></div>
                    
                    {/* Drawer Content */}
                    <div className="relative w-64 h-full surface-page shadow-xl flex flex-col p-4 animate-in slide-in-from-left duration-200">
                        <div className="flex items-center justify-between mb-6 border-b border-quiet pb-4">
                            <h2 className="text-lg font-bold text-primary">Jump to</h2>
                            <button onClick={onClose} className="p-2 -mr-2 text-secondary hover:text-primary">
                                <i data-lucide="x" className="w-5 h-5"></i>
                            </button>
                        </div>
                        <div className="flex-1 overflow-y-auto no-scrollbar">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        // ============================================================================
        // APP SHELL
        // ============================================================================

        const App = () => {
            const [payload, setPayload] = React.useState(null);
            const [error, setError] = React.useState(false);
            const [currentPaperKey, setCurrentPaperKey] = React.useState(null);
            const [mobileNavOpen, setMobileNavOpen] = React.useState(false);
            const [currentQuestionId, setCurrentQuestionId] = React.useState(null);

            // Load Payload
            React.useEffect(() => {
                fetch(RTQ_PAPERS_PAYLOAD_PATH)
                    .then(res => {
                        if (!res.ok) throw new Error("Failed to load");
                        return res.json();
                    })
                    .then(data => {
                        setPayload(data);
                        if (data.papers && data.papers.length > 0) {
                            setCurrentPaperKey(data.papers[0].key);
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        setError(true);
                    });
            }, []);

            // Lucide icons re-scan on updates
            React.useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            });

            // Intersection Observer for scroll spy
            React.useEffect(() => {
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            // q-{id} -> {id}
                            const id = entry.target.id.replace('q-', '');
                            setCurrentQuestionId(id);
                        }
                    });
                }, { rootMargin: '-10% 0px -80% 0px' });

                const questions = document.querySelectorAll('[id^="q-"]');
                questions.forEach(q => observer.observe(q));

                return () => observer.disconnect();
            });

            if (error) {
                return (
                    <div className="min-h-screen flex items-center justify-center surface-page text-secondary font-bold">
                        PAPERS PAYLOAD MISSING
                    </div>
                );
            }

            if (!payload || !currentPaperKey) {
                return <div className="min-h-screen surface-page"></div>; // Loading
            }

            const activePaper = payload.papers.find(p => p.key === currentPaperKey);

            // Generate Nav Items
            const getNavItems = (paper) => {
                if (paper.sections) {
                    let items = [];
                    paper.sections.forEach(sec => {
                        if (sec.label) {
                            items.push({ isSectionLabel: true, label: sec.label });
                        }
                        sec.questions.forEach(q => {
                            // Flatten top-level questions and their children
                            items = items.concat(flattenQuestions([q]));
                        });
                    });
                    return items;
                } else {
                    return flattenQuestions(paper.questions);
                }
            };
            
            const navItems = getNavItems(activePaper);

            const handleNavigate = (id) => {
                const el = document.getElementById(`q-${id}`);
                if (el) {
                    el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    setMobileNavOpen(false);
                }
            };

            const handlePaperChange = (key) => {
                setCurrentPaperKey(key);
                window.scrollTo(0, 0);
            };

            return (
                <div className="min-h-screen flex flex-col">
                    {/* Top Controls Region - Aligned to DocumentFrameShell via container */}
                    <div className="sticky top-0 z-30 surface-page border-b border-quiet/50 backdrop-blur-md bg-opacity-90">
                        <div className="max-w-[1400px] mx-auto px-4 h-16 flex items-center justify-between">
                            <PaperSelector 
                                papers={payload.papers} 
                                currentPaperKey={currentPaperKey}
                                onSelect={handlePaperChange}
                            />
                            
                            {/* Mobile Jump To Trigger */}
                            <button 
                                className="md:hidden text-sm font-medium text-accent-primary flex items-center gap-1"
                                onClick={() => setMobileNavOpen(true)}
                            >
                                <span>Jump to</span>
                                <i data-lucide="menu" className="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>

                    {/* DocumentFrameShell */}
                    <div className="flex-1 surface-frame">
                        <div className="max-w-[1400px] mx-auto px-4 flex min-h-[calc(100vh-4rem)]">
                            
                            {/* Desktop Nav Rail (Left Column) */}
                            <div className="hidden md:block w-48 shrink-0 py-8 pr-6 sticky top-16 h-[calc(100vh-4rem)] overflow-y-auto no-scrollbar">
                                <NavigationList 
                                    items={navItems} 
                                    currentQuestionId={currentQuestionId}
                                    onNavigate={handleNavigate}
                                />
                            </div>

                            {/* Paper Document Column (Right Column) */}
                            <div className="flex-1 py-8">
                                <PaperRegion paper={activePaper} />
                            </div>

                        </div>
                    </div>

                    {/* Mobile Navigation Drawer */}
                    <MobileDrawer isOpen={mobileNavOpen} onClose={() => setMobileNavOpen(false)}>
                        <NavigationList 
                            items={navItems} 
                            currentQuestionId={currentQuestionId}
                            onNavigate={handleNavigate}
                        />
                    </MobileDrawer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
