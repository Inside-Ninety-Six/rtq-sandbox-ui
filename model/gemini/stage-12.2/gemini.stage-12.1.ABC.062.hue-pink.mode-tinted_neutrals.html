<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"ABC","indexWithinVariant":"62","totalWithinVariant":"320","hueFamily":"pink","intensityMode":"tinted_neutrals","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-09T12:48:25.662Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;ABC&quot;,&quot;indexWithinVariant&quot;:&quot;62&quot;,&quot;totalWithinVariant&quot;:&quot;320&quot;,&quot;hueFamily&quot;:&quot;pink&quot;,&quot;intensityMode&quot;:&quot;tinted_neutrals&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-09T12:48:25.662Z&quot;}'>

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RTQ Maths Paper Solution Viewer</title>

<!-- Libraries (No Integrity Attributes per Stage 6) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

<style>
/* 
    COLORLAB B: Forced Hue = "pink" (H ~ 345 in OKLCH)
    COLORLAB C: Intensity Mode = "tinted_neutrals"
    
    Mode constraints:
    1. Core surfaces: C in [0.015 .. 0.035]
    2. Wash surfaces: C in [0.025 .. 0.045]
    3. Text: Primary C <= 0.010, Secondary C <= 0.012
    4. Accent: C in [0.10 .. 0.16]
*/

:root {
    /* Base Hue: Pink/Rubine */
    --hue: 345;

    /* Surfaces */
    --c-page-bg: oklch(0.97 0.018 var(--hue));
    --c-frame-bg: oklch(0.97 0.018 var(--hue)); /* Shared nav/frame surface */
    --c-paper-bg: oklch(0.99 0.015 var(--hue));
    
    /* Washes & Differentiation */
    --c-wash-solution: oklch(0.96 0.035 var(--hue));
    --c-wash-section: oklch(0.96 0.025 var(--hue));

    /* Text */
    --c-text-primary: oklch(0.20 0.010 var(--hue));
    --c-text-secondary: oklch(0.45 0.012 var(--hue));
    --c-text-quiet: oklch(0.60 0.012 var(--hue));

    /* UI & Accents */
    --c-accent: oklch(0.60 0.14 var(--hue)); /* Links, Focus, Toggles */
    --c-hairline: oklch(0.90 0.025 var(--hue));
    --c-focus-ring: oklch(0.60 0.14 var(--hue));

    /* Spacing System */
    --sp-xs: 0.25rem;
    --sp-s: 0.5rem;
    --sp-m: 1rem;
    --sp-l: 1.5rem;
    --sp-xl: 2.5rem; /* Inter-question spacing */
    --sp-xxl: 4rem;

    /* Typography */
    --font-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    --lh-body: 1.6;
    --lh-tight: 1.4;
    
    /* Layout */
    --w-max: 1024px;
    --w-nav: 200px;
    --w-paper-min: 300px;
}

/* RESET & BASE */
*, *::before, *::after {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

body {
    background-color: var(--c-page-bg);
    color: var(--c-text-primary);
    font-family: var(--font-sans);
    line-height: var(--lh-body);
    font-size: 16px;
    -webkit-font-smoothing: antialiased;
    overflow-y: scroll; /* Force scrollbar */
}

/* UTILS */
.hidden { display: none !important; }
.sr-only {
    position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px;
    overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0;
}
button {
    background: none; border: none; cursor: pointer; font: inherit; color: inherit;
    padding: 0; text-align: left;
}
button:focus-visible, a:focus-visible, [tabindex="0"]:focus-visible {
    outline: 2px solid var(--c-focus-ring);
    outline-offset: 2px;
    border-radius: 2px;
}

/* SHELL */
.app-shell {
    display: flex;
    flex-direction: column;
    min-height: 100vh;
    background-color: var(--c-frame-bg);
    max-width: var(--w-max);
    margin: 0 auto;
    position: relative;
    box-shadow: 0 0 20px oklch(0 0 0 / 0.02); /* Very subtle frame lift */
}

/* TOP CONTROLS */
.top-controls {
    padding: var(--sp-m);
    border-bottom: 1px solid var(--c-hairline);
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky;
    top: 0;
    z-index: 20;
    background-color: var(--c-frame-bg);
}

.paper-selector select {
    padding: var(--sp-s);
    font-size: 0.95rem;
    border: 1px solid var(--c-hairline);
    border-radius: 4px;
    background: var(--c-paper-bg);
    color: var(--c-text-primary);
}

.jump-to-btn {
    display: none; /* Desktop default */
    font-weight: 600;
    color: var(--c-accent);
    padding: var(--sp-s);
}

/* MAIN LAYOUT (DESKTOP) */
.main-content {
    display: flex;
    flex: 1;
    align-items: flex-start; /* Ensure sticky nav works */
}

/* NAVIGATION RAIL */
.nav-col {
    width: var(--w-nav);
    position: sticky;
    top: 70px; /* Offset for top controls */
    max-height: calc(100vh - 70px);
    overflow-y: auto;
    padding: var(--sp-m) var(--sp-s) var(--sp-m) var(--sp-m);
    border-right: 1px solid transparent; /* Separator optional per design */
    scrollbar-width: none; /* Hide scrollbar Firefox */
}
.nav-col::-webkit-scrollbar { display: none; }

.nav-list {
    display: flex;
    flex-direction: column;
    gap: 4px; /* Tight rhythm */
}

.nav-section-label {
    font-size: 0.8rem;
    font-weight: 700;
    color: var(--c-text-secondary);
    text-transform: uppercase;
    margin-top: var(--sp-m);
    margin-bottom: var(--sp-xs);
    padding-left: var(--sp-xs);
}
.nav-section-label:first-child { margin-top: 0; }

.nav-item {
    display: block;
    padding: 2px var(--sp-xs);
    text-decoration: none;
    color: var(--c-text-secondary);
    font-size: 0.9rem;
    border-radius: 2px;
    transition: color 0.1s ease, font-weight 0.1s ease;
}

.nav-item:hover {
    color: var(--c-text-primary);
    background-color: oklch(0 0 0 / 0.03);
}

.nav-item.active {
    font-weight: 700;
    color: var(--c-accent); /* Permitted override */
}

/* Typography scale for hierarchy (Nav) */
.nav-item[data-depth="0"] { font-size: 0.95rem; }
.nav-item[data-depth="1"] { font-size: 0.9rem; }
.nav-item[data-depth="2"] { font-size: 0.85rem; }

/* PAPER COLUMN */
.paper-col {
    flex: 1;
    min-width: 0; /* Prevent flex blowout */
    padding: var(--sp-l) var(--sp-l) var(--sp-xxl) var(--sp-l);
    background-color: var(--c-paper-bg);
}

/* SECTION HEADERS (Paper) */
.section-header {
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--c-text-secondary);
    padding-bottom: var(--sp-m);
    margin-bottom: var(--sp-l);
    border-bottom: 1px solid var(--c-hairline);
    margin-top: var(--sp-l);
}
.section-header:first-child { margin-top: 0; }

/* QUESTION NODES */
.question-node {
    margin-bottom: var(--sp-xl); /* Top level spacing */
    position: relative;
}

.question-node.child-node {
    margin-bottom: var(--sp-m);
    margin-top: var(--sp-m);
}

/* Question Body */
.q-body {
    display: flex;
    gap: var(--sp-s);
    color: var(--c-text-primary);
    margin-bottom: var(--sp-s);
}

.q-id {
    font-weight: 600;
    min-width: 2ch;
    flex-shrink: 0;
}

.q-prompt {
    flex: 1;
}

.q-prompt p { margin-bottom: var(--sp-s); }
.q-prompt p:last-child { margin-bottom: 0; }

/* SOLUTION BLOCK */
.solution-block {
    margin-left: 0; /* Align with layout logic, could indent if needed */
    display: flex;
    flex-direction: column;
    gap: var(--sp-s);
}

.q-body + .solution-block {
    margin-top: var(--sp-s);
}

/* Answer */
.answer-region {
    display: flex;
    gap: var(--sp-s);
    align-items: baseline;
    color: var(--c-text-secondary); /* Subordinate */
    font-size: 0.95em;
}

.lbl-answer {
    font-weight: 700;
    font-size: 0.85em;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    color: var(--c-text-secondary);
    flex-shrink: 0;
}

/* Solution Details */
.sd-control-row {
    margin-top: var(--sp-xs);
}

.sd-toggle {
    display: inline-flex;
    align-items: center;
    gap: var(--sp-xs);
    font-size: 0.9rem;
    font-weight: 500;
    color: var(--c-accent);
    padding: var(--sp-xs) 0;
}
.sd-toggle:hover {
    text-decoration: underline;
}
.sd-toggle svg {
    width: 1em; height: 1em;
    transition: transform 0.2s ease;
}
.sd-toggle[aria-expanded="true"] svg {
    transform: rotate(180deg);
}

.sd-region {
    background-color: var(--c-wash-solution);
    border-radius: 4px; /* Subtle feel, not card */
    padding: var(--sp-m);
    margin-top: var(--sp-xs);
    font-size: 0.95rem;
    color: var(--c-text-secondary); /* Not washed out */
}

/* Solution Subsections */
.sd-section {
    margin-bottom: var(--sp-m);
}
.sd-section:last-child { margin-bottom: 0; }

.sd-lbl {
    font-weight: 700;
    font-size: 0.85rem;
    color: var(--c-text-primary);
    margin-bottom: var(--sp-xs);
    display: block;
}

/* Subsection: Keep in Mind */
.sd-kim ul {
    list-style-type: disc;
    padding-left: 1.2em;
}
.sd-kim li { margin-bottom: 0.25em; }

/* Subsection: Formulas */
.sd-formulas {
    font-family: var(--font-sans);
}

/* Subsection: Alternative Working */
.sd-alt {
    padding-top: var(--sp-m);
    border-top: 1px solid var(--c-hairline);
}

/* Markdown Content Styling */
.md-content p { margin-bottom: 0.75em; }
.md-content p:last-child { margin-bottom: 0; }
.md-content ul, .md-content ol { padding-left: 1.5em; margin-bottom: 0.75em; }
.md-content table {
    width: 100%;
    border-collapse: collapse;
    margin: var(--sp-s) 0;
    font-size: 0.9em;
}
.md-content th, .md-content td {
    border: 1px solid var(--c-hairline);
    padding: var(--sp-s);
    text-align: left;
}
.md-content th { font-weight: 600; background: oklch(0 0 0 / 0.02); }

/* Math Overflow Containment (Authoritative) */
.katex-display {
    overflow-x: auto;
    overflow-y: hidden;
    max-width: 100%;
    padding: 0.5em 0;
    margin: 0.5em 0;
    scrollbar-width: thin;
    /* Optional underlay for display math only */
    background: transparent; 
}
.katex-display::-webkit-scrollbar { height: 4px; }
.katex-display::-webkit-scrollbar-thumb { background: var(--c-hairline); border-radius: 2px; }

/* Inline SVG Passthrough */
svg { max-width: 100%; height: auto; }

/* MOBILE DRAWER */
.drawer-backdrop {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: oklch(0 0 0 / 0.4);
    z-index: 100;
    display: none;
    opacity: 0;
    transition: opacity 0.2s ease;
}
.drawer-backdrop.open {
    display: block;
    opacity: 1;
}

.drawer {
    position: fixed; top: 0; right: 0; bottom: 0;
    width: 85%; max-width: 300px;
    background: var(--c-frame-bg);
    z-index: 101;
    transform: translateX(100%);
    transition: transform 0.25s cubic-bezier(0.16, 1, 0.3, 1);
    display: flex;
    flex-direction: column;
    box-shadow: -5px 0 20px oklch(0 0 0 / 0.1);
}
.drawer.open { transform: translateX(0); }

.drawer-header {
    padding: var(--sp-m);
    border-bottom: 1px solid var(--c-hairline);
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.drawer-title { font-weight: 700; }
.drawer-close { padding: var(--sp-s); font-size: 1.5rem; line-height: 1; }

.drawer-content {
    flex: 1;
    overflow-y: auto;
    padding: var(--sp-m);
}

/* RESPONSIVE */
@media (max-width: 768px) {
    .nav-col { display: none; } /* Hide sticky rail */
    .jump-to-btn { display: block; } /* Show trigger */
    .paper-col { padding: var(--sp-m); }
    .question-node { margin-bottom: var(--sp-l); }
    .q-body { gap: var(--sp-xs); }
}

</style>
</head>
<body>

<div class="app-shell">
    <div class="top-controls">
        <div class="paper-selector">
            <label for="paper-select" class="sr-only">Select Paper</label>
            <select id="paper-select"></select>
        </div>
        <button class="jump-to-btn" id="jump-to-trigger">Jump to</button>
    </div>

    <div class="main-content">
        <!-- Desktop Nav Rail -->
        <nav class="nav-col" aria-label="Paper navigation">
            <div id="desktop-nav-list" class="nav-list"></div>
        </nav>

        <!-- Paper Content -->
        <main class="paper-col" id="paper-content" role="main">
            <!-- Content Injected Here -->
        </main>
    </div>
</div>

<!-- Mobile Drawer -->
<div class="drawer-backdrop" id="drawer-backdrop"></div>
<div class="drawer" id="drawer" role="dialog" aria-modal="true" aria-labelledby="drawer-title">
    <div class="drawer-header">
        <span id="drawer-title" class="drawer-title">Jump to</span>
        <button class="drawer-close" id="drawer-close" aria-label="Close navigation">&times;</button>
    </div>
    <nav class="drawer-content">
        <div id="mobile-nav-list" class="nav-list"></div>
    </nav>
</div>

<script>
// --- STAGE 0: CONSTANTS ---
const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";

// --- STATE ---
let appState = {
    papers: [],
    currentPaper: null,
    expandedState: {} // map of questionId -> boolean
};

// --- MARKDOWN SETUP (Authoritative Config) ---
const md = window.markdownit ? window.markdownit({
    html: true, // Inline SVG
    linkify: true,
    breaks: false // No <br> inside math
}) : null;

if (md) {
    md.inline.ruler.disable(['escape']); // Preserve TeX backslashes
}

// --- INITIALIZATION ---
async function init() {
    try {
        const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
        if (!response.ok) throw new Error("Payload not found");
        const data = await response.json();
        
        if (!data.papers || !Array.isArray(data.papers)) throw new Error("Invalid payload");
        
        appState.papers = data.papers;
        renderPaperSelector();
        
        // Select first paper by default
        if (appState.papers.length > 0) {
            loadPaper(appState.papers[0].key);
        }

    } catch (e) {
        console.error(e);
        document.getElementById('paper-content').innerHTML = `
            <div style="padding: 2rem; text-align: center; color: var(--c-text-secondary);">
                <strong>PAPERS PAYLOAD MISSING</strong>
            </div>
        `;
    }

    setupMobileDrawer();
    setupScrollSpy();
}

function renderPaperSelector() {
    const select = document.getElementById('paper-select');
    select.innerHTML = '';
    appState.papers.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.key;
        opt.textContent = p.label || p.key;
        select.appendChild(opt);
    });
    
    select.addEventListener('change', (e) => {
        loadPaper(e.target.value);
    });
}

function loadPaper(paperKey) {
    const paper = appState.papers.find(p => p.key === paperKey);
    if (!paper) return;

    appState.currentPaper = paper;
    
    // Reset expanded state based on defaults
    const defaultExpanded = paper.defaults?.expandedAll !== false;
    appState.expandedState = {}; 
    // We will populate this lazily or assume default if missing

    renderNavigation(paper);
    renderContent(paper);
    
    // Reset scroll
    window.scrollTo(0, 0);
}

// --- RENDERING: CONTENT ---
function renderContent(paper) {
    const container = document.getElementById('paper-content');
    container.innerHTML = '';

    if (paper.sections) {
        paper.sections.forEach(section => {
            // Render section header if label exists
            if (section.label && section.label.trim().length > 0) {
                const header = document.createElement('div');
                header.className = 'section-header';
                header.textContent = section.label;
                container.appendChild(header);
            }
            // Render questions
            if (section.questions) {
                section.questions.forEach(q => {
                    container.appendChild(renderQuestionNode(q, 0, defaultExpandedState(paper)));
                });
            }
        });
    } else if (paper.questions) {
        paper.questions.forEach(q => {
            container.appendChild(renderQuestionNode(q, 0, defaultExpandedState(paper)));
        });
    }

    // Trigger KaTeX
    renderMathInElement(container, {
        delimiters: [
            {left: '$$', right: '$$', display: true},
            {left: '$', right: '$', display: false}
        ],
        throwOnError: false
    });
}

function defaultExpandedState(paper) {
    return paper.defaults?.expandedAll !== false;
}

function renderQuestionNode(node, depth, isExpandedDefault) {
    const wrapper = document.createElement('div');
    wrapper.className = `question-node ${depth > 0 ? 'child-node' : ''}`;
    wrapper.id = `q-${node.id}`; // Anchor for nav
    wrapper.style.paddingLeft = depth > 0 ? `var(--sp-l)` : '0'; // Indentation via spacing

    // 1. Question Body
    const qBody = document.createElement('div');
    qBody.className = 'q-body';
    
    const qId = document.createElement('div');
    qId.className = 'q-id';
    qId.textContent = node.id;
    
    const qPrompt = document.createElement('div');
    qPrompt.className = 'q-prompt md-content';
    qPrompt.innerHTML = md ? md.render(node.question || '') : (node.question || '');

    qBody.appendChild(qId);
    qBody.appendChild(qPrompt);
    wrapper.appendChild(qBody);

    // 2. Solution Block (Optional)
    if (node.solutionBlock) {
        const sb = document.createElement('div');
        sb.className = 'solution-block';

        // A. Answer (Optional)
        if (node.solutionBlock.answer) {
            const ansRow = document.createElement('div');
            ansRow.className = 'answer-region';
            
            const ansLbl = document.createElement('span');
            ansLbl.className = 'lbl-answer';
            ansLbl.textContent = 'Answer';
            
            const ansContent = document.createElement('div');
            ansContent.className = 'md-content';
            ansContent.innerHTML = md ? md.render(node.solutionBlock.answer) : node.solutionBlock.answer;

            ansRow.appendChild(ansLbl);
            ansRow.appendChild(ansContent);
            sb.appendChild(ansRow);
        }

        // B. Solution Details (Optional)
        if (node.solutionBlock.solutionDetails) {
            // Determine state
            const isExpanded = appState.expandedState[node.id] !== undefined 
                ? appState.expandedState[node.id] 
                : isExpandedDefault;
            
            // Toggle Control
            const ctrlRow = document.createElement('div');
            ctrlRow.className = 'sd-control-row';
            
            const btn = document.createElement('button');
            btn.className = 'sd-toggle';
            btn.setAttribute('aria-expanded', String(isExpanded));
            btn.innerHTML = `
                <span>${isExpanded ? 'Hide working' : 'Show working'}</span>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
            `;
            
            ctrlRow.appendChild(btn);
            sb.appendChild(ctrlRow);

            // Region
            const region = document.createElement('div');
            region.className = `sd-region ${isExpanded ? '' : 'hidden'}`;
            
            const sd = node.solutionBlock.solutionDetails;

            // Keep in mind
            if (sd.keepInMind) {
                const sec = document.createElement('div');
                sec.className = 'sd-section sd-kim';
                sec.innerHTML = `<span class="sd-lbl">Keep in mind</span><div class="md-content">${md ? md.render(sd.keepInMind) : sd.keepInMind}</div>`;
                region.appendChild(sec);
            }
            
            // Formulas used
            if (sd.formulasUsed) {
                const sec = document.createElement('div');
                sec.className = 'sd-section sd-formulas';
                sec.innerHTML = `<span class="sd-lbl">Formulas used</span><div class="md-content">${md ? md.render(sd.formulasUsed) : sd.formulasUsed}</div>`;
                region.appendChild(sec);
            }

            // Working
            if (sd.working) {
                const sec = document.createElement('div');
                sec.className = 'sd-section sd-working';
                sec.innerHTML = `<span class="sd-lbl">Working</span><div class="md-content">${md ? md.render(sd.working) : sd.working}</div>`;
                region.appendChild(sec);
            }

            // Alternative Working
            if (sd.alternativeWorking && Array.isArray(sd.alternativeWorking)) {
                sd.alternativeWorking.forEach(alt => {
                    const sec = document.createElement('div');
                    sec.className = 'sd-section sd-alt';
                    sec.innerHTML = `<span class="sd-lbl">Alternative working</span><div class="md-content">${md ? md.render(alt) : alt}</div>`;
                    region.appendChild(sec);
                });
            }

            sb.appendChild(region);

            // Interaction
            btn.onclick = () => {
                const newState = ! (btn.getAttribute('aria-expanded') === 'true');
                btn.setAttribute('aria-expanded', String(newState));
                btn.querySelector('span').textContent = newState ? 'Hide working' : 'Show working';
                region.classList.toggle('hidden', !newState);
                appState.expandedState[node.id] = newState;
            };
        }

        wrapper.appendChild(sb);
    }

    // 3. Children (Recursive)
    if (node.children && node.children.length > 0) {
        node.children.forEach(child => {
            wrapper.appendChild(renderQuestionNode(child, depth + 1, isExpandedDefault));
        });
    }

    return wrapper;
}

// --- RENDERING: NAVIGATION ---
function renderNavigation(paper) {
    const desktopList = document.getElementById('desktop-nav-list');
    const mobileList = document.getElementById('mobile-nav-list');
    
    desktopList.innerHTML = '';
    mobileList.innerHTML = '';
    
    const itemsFragment = document.createDocumentFragment();

    if (paper.sections) {
        paper.sections.forEach((sec, idx) => {
            // Label
            if (sec.label && sec.label.trim().length > 0) {
                const label = document.createElement('div');
                label.className = 'nav-section-label';
                label.textContent = sec.label;
                itemsFragment.appendChild(label);
            }
            // Items
            if (sec.questions) {
                sec.questions.forEach(q => appendNavItems(q, 0, itemsFragment));
            }
        });
    } else if (paper.questions) {
        paper.questions.forEach(q => appendNavItems(q, 0, itemsFragment));
    }

    // Clone for both views
    desktopList.appendChild(itemsFragment.cloneNode(true));
    mobileList.appendChild(itemsFragment.cloneNode(true));
    
    // Attach click handlers
    attachNavHandlers(desktopList);
    attachNavHandlers(mobileList);
}

function appendNavItems(node, depth, fragment) {
    const a = document.createElement('a');
    a.href = `#q-${node.id}`;
    a.className = 'nav-item';
    a.textContent = node.id;
    a.dataset.depth = depth;
    a.dataset.targetId = `q-${node.id}`;
    fragment.appendChild(a);

    if (node.children) {
        node.children.forEach(child => appendNavItems(child, depth + 1, fragment));
    }
}

function attachNavHandlers(listEl) {
    listEl.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', (e) => {
            e.preventDefault();
            const targetId = item.dataset.targetId;
            const targetEl = document.getElementById(targetId);
            if (targetEl) {
                const offset = 80; // Top header space
                const bodyRect = document.body.getBoundingClientRect().top;
                const elementRect = targetEl.getBoundingClientRect().top;
                const elementPosition = elementRect - bodyRect;
                const offsetPosition = elementPosition - offset;

                window.scrollTo({
                    top: offsetPosition,
                    behavior: "smooth"
                });
                
                // Update active state manually for instant feedback
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                document.querySelectorAll(`.nav-item[data-target-id="${targetId}"]`).forEach(n => n.classList.add('active'));

                // Close drawer if open
                closeDrawer();
            }
        });
    });
}

// --- MOBILE DRAWER LOGIC ---
function setupMobileDrawer() {
    const trigger = document.getElementById('jump-to-trigger');
    const drawer = document.getElementById('drawer');
    const backdrop = document.getElementById('drawer-backdrop');
    const close = document.getElementById('drawer-close');

    function open() {
        drawer.classList.add('open');
        backdrop.classList.add('open');
        document.body.style.overflow = 'hidden'; // Lock scroll
    }

    function close() {
        drawer.classList.remove('open');
        backdrop.classList.remove('open');
        document.body.style.overflow = ''; 
    }

    trigger.onclick = open;
    close.onclick = close;
    backdrop.onclick = close;
    window.closeDrawer = close; // Expose for nav click
}

// --- SCROLL SPY ---
function setupScrollSpy() {
    let ticking = false;
    window.addEventListener('scroll', () => {
        if (!ticking) {
            window.requestAnimationFrame(() => {
                updateActiveNav();
                ticking = false;
            });
            ticking = true;
        }
    });
}

function updateActiveNav() {
    const nodes = document.querySelectorAll('.question-node');
    const scrollPos = window.scrollY + 100; // Offset
    
    let currentId = null;
    
    nodes.forEach(node => {
        if (node.offsetTop <= scrollPos) {
            // Because IDs are like "q-1", derive original id from wrapper id string
            // actually we stored dataset on nav items, let's reverse match
            currentId = node.id;
        }
    });

    if (currentId) {
        document.querySelectorAll('.nav-item').forEach(n => {
            n.classList.toggle('active', n.dataset.targetId === currentId);
        });
    }
}

// Run init
init();

</script>
</body>
</html>
