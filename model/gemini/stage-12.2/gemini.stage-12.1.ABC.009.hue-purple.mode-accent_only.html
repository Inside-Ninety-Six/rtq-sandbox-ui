<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"ABC","indexWithinVariant":"9","totalWithinVariant":"320","hueFamily":"purple","intensityMode":"accent_only","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-09T10:23:50.165Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;ABC&quot;,&quot;indexWithinVariant&quot;:&quot;9&quot;,&quot;totalWithinVariant&quot;:&quot;320&quot;,&quot;hueFamily&quot;:&quot;purple&quot;,&quot;intensityMode&quot;:&quot;accent_only&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-09T10:23:50.165Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer (Stage 6 Baseline)</title>

    <!-- Tailwind CSS (No SRI) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- KaTeX CSS (No SRI) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Markdown-it (No SRI) -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <!-- KaTeX JS (No SRI) -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- React & ReactDOM (No SRI) -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel (No SRI) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Lucide Icons (No SRI) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Stage 0: Constants & Configuration -->
    <script>
        // --- STAGE 0: CANONICAL CONSTANTS ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // --- COLORLAB C: CONFIGURATION (Mode: accent_only, Hue: purple) ---
        // Hue Family: Purple (~295)
        // Intensity Mode: accent_only
        //   Surfaces: C <= 0.015 (Very neutral)
        //   Text: C <= 0.010 (Very neutral)
        //   Accent: C in [0.08 .. 0.14] (Vibrant)

        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        // Surfaces (Lightest hint of purple/neutral)
                        page: 'oklch(0.99 0.005 295)',    // Page background
                        frame: 'oklch(0.98 0.008 295)',   // Frame base surface
                        paper: 'oklch(1.0 0 0)',          // Paper content surface (White)
                        wash: 'oklch(0.985 0.01 295)',    // Solution details wash
                        
                        // Typography (Near neutral)
                        primary: 'oklch(0.20 0.008 295)', // Body text
                        secondary: 'oklch(0.45 0.01 295)', // Metadata / Secondary text
                        
                        // Borders/Dividers
                        hairline: 'oklch(0.92 0.005 295)',

                        // Accent (Vibrant Purple for interaction only)
                        accent: 'oklch(0.55 0.13 295)',
                        'accent-hover': 'oklch(0.50 0.13 295)',
                    }
                }
            }
        }
    </script>

    <style type="text/tailwindcss">
        @layer utilities {
            /* Accessibility Focus */
            .focus-visible-ring {
                @apply focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-accent focus-visible:ring-offset-2;
            }

            /* Hide Scrollbar but keep functionality */
            .no-scrollbar {
                -ms-overflow-style: none;  /* IE and Edge */
                scrollbar-width: none;  /* Firefox */
            }
            .no-scrollbar::-webkit-scrollbar {
                display: none;
            }

            /* Math Containment Invariant */
            .katex-display {
                @apply overflow-x-auto max-w-full py-2;
                scrollbar-width: thin;
            }
            
            /* Markdown Content Styling */
            .md-content p {
                @apply mb-3 last:mb-0 leading-relaxed;
            }
            .md-content ul {
                @apply list-disc list-outside ml-5 mb-3 space-y-1;
            }
            .md-content ol {
                @apply list-decimal list-outside ml-5 mb-3 space-y-1;
            }
            .md-content table {
                @apply border-collapse border border-hairline w-full my-4 text-sm;
            }
            .md-content th, .md-content td {
                @apply border border-hairline p-2 text-left align-top;
            }
            .md-content th {
                @apply font-medium bg-gray-50/50;
            }
        }
    </style>
</head>
<body class="bg-page text-primary antialiased h-screen overflow-hidden selection:bg-accent selection:text-white">
    <div id="root" class="h-full flex flex-col"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;

        // --- MARKDOWN SETUP (Authoritative) ---
        const md = window.markdownit
            ? window.markdownit({
                html: true, // Allow inline SVG
                linkify: true,
                breaks: false, // Must be false to support KaTeX
            })
            : null;
        
        if (md) {
             // Disable inline escape to preserve TeX backslashes
            md.inline.ruler.disable(['escape']);
        }

        // --- ICONS ---
        const IconMenu = () => <i data-lucide="menu" className="w-5 h-5"></i>;
        const IconX = () => <i data-lucide="x" className="w-5 h-5"></i>;
        const IconChevronDown = ({ className }) => <i data-lucide="chevron-down" className={className}></i>;
        const IconChevronUp = ({ className }) => <i data-lucide="chevron-up" className={className}></i>;
        const IconInfo = () => <i data-lucide="info" className="w-4 h-4"></i>;

        // --- COMPONENTS ---

        // 1. Markdown Renderer Component
        const MarkdownView = ({ content, className = "" }) => {
            const containerRef = useRef(null);

            useEffect(() => {
                if (containerRef.current) {
                    // KaTeX Auto-render
                    renderMathInElement(containerRef.current, {
                        delimiters: [
                            {left: '$$', right: '$$', display: true},
                            {left: '$', right: '$', display: false}
                        ],
                        throwOnError: false,
                        trust: true // Allow HTML in math if needed, typically strict mode ok
                    });
                }
            }, [content]);

            if (!content) return null;

            // Step 1: Markdown -> HTML
            let html = content;
            if (md) {
                try {
                    html = md.render(content);
                } catch (e) {
                    console.error("Markdown rendering failed", e);
                }
            }

            return (
                <div 
                    ref={containerRef}
                    className={`md-content ${className}`}
                    dangerouslySetInnerHTML={{ __html: html }}
                />
            );
        };

        // 2. Navigation List
        const NavigationList = ({ items, currentId, onNavigate }) => {
            return (
                <nav className="flex flex-col w-full pb-8">
                    {items.map((item, index) => {
                        if (item.type === 'section') {
                            return (
                                <div key={`sec-${index}`} className="mb-2 mt-4 first:mt-0 px-2">
                                    {item.label && (
                                        <div className="text-xs font-semibold text-secondary uppercase tracking-wider mb-2 select-none">
                                            {item.label}
                                        </div>
                                    )}
                                    {item.questions.map(q => (
                                        <button
                                            key={q.id}
                                            onClick={() => onNavigate(q.id)}
                                            className={`
                                                w-full text-left py-1.5 px-2 rounded-md text-sm transition-colors duration-200 focus-visible-ring
                                                ${currentId === q.id 
                                                    ? 'font-bold text-accent' 
                                                    : 'text-secondary hover:text-primary hover:bg-black/5'
                                                }
                                            `}
                                            style={{
                                                fontSize: q.depth > 0 ? '0.85rem' : '0.9rem',
                                            }}
                                        >
                                            {q.id}
                                        </button>
                                    ))}
                                </div>
                            );
                        } else {
                            // Flat question item (no section wrapper)
                            const q = item;
                            return (
                                <button
                                    key={q.id}
                                    onClick={() => onNavigate(q.id)}
                                    className={`
                                        w-full text-left py-1.5 px-4 rounded-md text-sm transition-colors duration-200 focus-visible-ring
                                        ${currentId === q.id 
                                            ? 'font-bold text-accent' 
                                            : 'text-secondary hover:text-primary hover:bg-black/5'
                                        }
                                    `}
                                    style={{
                                         fontSize: q.depth > 0 ? '0.85rem' : '0.9rem',
                                    }}
                                >
                                    {q.id}
                                </button>
                            );
                        }
                    })}
                </nav>
            );
        };

        // 3. Solution Details Subsections
        const KeepInMind = ({ content }) => {
            if (!content) return null;
            return (
                <div className="mb-4">
                    <div className="flex items-center gap-2 mb-2 text-primary font-semibold text-sm">
                        <IconInfo />
                        <span>Keep in mind</span>
                    </div>
                    <MarkdownView content={content} className="text-sm text-secondary" />
                </div>
            );
        };

        const FormulasUsed = ({ content }) => {
            if (!content) return null;
            return (
                <div className="mb-4">
                    <div className="mb-1 text-xs uppercase font-bold text-secondary tracking-wide">Formulas used</div>
                    <MarkdownView content={content} className="text-sm text-secondary" />
                </div>
            );
        };

        const WorkingBlock = ({ label, content, isAlternative = false }) => {
            if (!content) return null;
            return (
                <div className={`mb-4 ${isAlternative ? 'pt-4 border-t border-hairline mt-4' : ''}`}>
                    <div className="mb-2 text-xs uppercase font-bold text-secondary tracking-wide">
                        {label || (isAlternative ? "Alternative working" : "Working")}
                    </div>
                    <MarkdownView content={content} className="text-base text-primary" />
                </div>
            );
        };

        // 4. Question Node (Recursive)
        const QuestionNode = ({ node, depth = 0, expandedState, toggleExpanded }) => {
            const hasChildren = node.children && node.children.length > 0;
            const sb = node.solutionBlock;
            const hasAnswer = sb && sb.answer;
            const hasDetails = sb && sb.solutionDetails;
            const isExpanded = expandedState[node.id];

            // Render nothing if node is empty (sanity check)
            if (!node) return null;

            return (
                <div 
                    id={`q-${node.id}`} 
                    className={`
                        relative
                        ${depth === 0 ? 'mb-12 scroll-mt-6' : 'mt-6 mb-2 ml-0 scroll-mt-24'}
                    `}
                >
                    {/* Question Surface/Body */}
                    <div className="group relative">
                        {/* Identifier */}
                        <div className="flex items-baseline gap-3">
                            <span className="text-secondary font-medium select-none text-sm min-w-[2rem]">
                                {node.id}
                            </span>
                            <div className="flex-1">
                                {/* Question Prompt */}
                                <MarkdownView content={node.question} className="text-lg text-primary font-medium mb-4" />

                                {/* Solution Block */}
                                {sb && (
                                    <div className="mt-4">
                                        {/* Answer */}
                                        {hasAnswer && (
                                            <div className="mb-3">
                                                <div className="text-xs font-bold text-secondary uppercase tracking-wide mb-1">Answer</div>
                                                <MarkdownView content={sb.answer} className="text-base text-primary font-medium" />
                                            </div>
                                        )}

                                        {/* Solution Details Toggle */}
                                        {hasDetails && (
                                            <div className="mt-4">
                                                <button
                                                    onClick={() => toggleExpanded(node.id)}
                                                    className="flex items-center gap-1 text-sm font-medium text-accent hover:text-accent-hover transition-colors focus-visible-ring rounded py-1 pr-2"
                                                    aria-expanded={isExpanded}
                                                >
                                                    <span>{isExpanded ? "Hide working" : "Show working"}</span>
                                                    {isExpanded 
                                                        ? <IconChevronUp className="w-4 h-4" /> 
                                                        : <IconChevronDown className="w-4 h-4" />
                                                    }
                                                </button>

                                                {/* Expanded Region */}
                                                {isExpanded && (
                                                    <div className="mt-3 pl-4 border-l-2 border-hairline bg-wash/50 rounded-r-sm p-4 animate-in fade-in slide-in-from-top-1 duration-200">
                                                        <KeepInMind content={sb.solutionDetails.keepInMind} />
                                                        <FormulasUsed content={sb.solutionDetails.formulasUsed} />
                                                        <WorkingBlock content={sb.solutionDetails.working} />
                                                        {sb.solutionDetails.alternativeWorking && 
                                                            (Array.isArray(sb.solutionDetails.alternativeWorking) 
                                                                ? sb.solutionDetails.alternativeWorking.map((aw, i) => <WorkingBlock key={i} content={aw} isAlternative={true} />)
                                                                : <WorkingBlock content={sb.solutionDetails.alternativeWorking} isAlternative={true} />
                                                            )
                                                        }
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* Recursive Children */}
                    {hasChildren && (
                        <div className="pl-4 md:pl-8 border-l border-transparent">
                            {node.children.map((child, i) => (
                                <QuestionNode 
                                    key={i} 
                                    node={child} 
                                    depth={depth + 1} 
                                    expandedState={expandedState} 
                                    toggleExpanded={toggleExpanded} 
                                />
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        // 5. Main App Logic
        const App = () => {
            const [payload, setPayload] = useState(null);
            const [status, setStatus] = useState('loading'); // loading, error, ready
            const [currentPaperKey, setCurrentPaperKey] = useState(null);
            const [expandedStates, setExpandedStates] = useState({});
            const [mobileNavOpen, setMobileNavOpen] = useState(false);
            const [currentViewId, setCurrentViewId] = useState(null);

            // Data Fetching
            useEffect(() => {
                fetch(RTQ_PAPERS_PAYLOAD_PATH)
                    .then(res => {
                        if (!res.ok) throw new Error("Failed to load");
                        return res.json();
                    })
                    .then(data => {
                        if (!data.papers || data.papers.length === 0) throw new Error("Invalid payload");
                        setPayload(data);
                        // Select first paper by default
                        const firstPaper = data.papers[0];
                        setCurrentPaperKey(firstPaper.key);
                        initializeDefaults(firstPaper, data);
                        setStatus('ready');
                    })
                    .catch(err => {
                        console.error(err);
                        setStatus('error');
                    });
            }, []);

            // Lucide icons re-scan
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            });

            // Helper to flatten questions for nav
            const flattenQuestions = (nodes, depth = 0) => {
                let list = [];
                nodes.forEach(node => {
                    list.push({ id: node.id, depth });
                    if (node.children) {
                        list = list.concat(flattenQuestions(node.children, depth + 1));
                    }
                });
                return list;
            };

            // Initialize expanded states based on paper defaults
            const initializeDefaults = (paper) => {
                const defaultExpanded = paper.defaults?.expandedAll !== false;
                const newStates = {};
                
                const traverse = (nodes) => {
                    nodes.forEach(node => {
                        if (node.solutionBlock?.solutionDetails) {
                            newStates[node.id] = defaultExpanded;
                        }
                        if (node.children) traverse(node.children);
                    });
                };

                if (paper.sections) {
                    paper.sections.forEach(sec => traverse(sec.questions));
                } else if (paper.questions) {
                    traverse(paper.questions);
                }
                setExpandedStates(newStates);
            };

            const handlePaperChange = (key) => {
                const paper = payload.papers.find(p => p.key === key);
                if (paper) {
                    setCurrentPaperKey(key);
                    initializeDefaults(paper);
                    window.scrollTo(0, 0);
                    setMobileNavOpen(false);
                }
            };

            const toggleExpanded = (id) => {
                setExpandedStates(prev => ({
                    ...prev,
                    [id]: !prev[id]
                }));
            };

            const handleNavigate = (id) => {
                setMobileNavOpen(false);
                const el = document.getElementById(`q-${id}`);
                if (el) {
                    el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    setCurrentViewId(id);
                }
            };

            // Intersection Observer for Current Nav Item
            const observerRef = useRef(null);
            useEffect(() => {
                if (status !== 'ready') return;
                
                const options = { root: null, rootMargin: '-10% 0px -80% 0px', threshold: 0 };
                
                observerRef.current = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            // format is q-ID
                            const id = entry.target.id.substring(2);
                            setCurrentViewId(id);
                        }
                    });
                }, options);

                const ids = document.querySelectorAll('[id^="q-"]');
                ids.forEach(el => observerRef.current.observe(el));

                return () => {
                    if (observerRef.current) observerRef.current.disconnect();
                }
            }, [status, currentPaperKey]);


            if (status === 'error') {
                return (
                    <div className="flex items-center justify-center h-full text-secondary font-mono">
                        PAPERS PAYLOAD MISSING
                    </div>
                );
            }

            if (status === 'loading') {
                return <div className="h-full bg-page"></div>;
            }

            const currentPaper = payload.papers.find(p => p.key === currentPaperKey);
            
            // Build Navigation Data Structure
            let navItems = [];
            if (currentPaper.sections) {
                navItems = currentPaper.sections.map(sec => ({
                    type: 'section',
                    label: sec.label,
                    questions: flattenQuestions(sec.questions)
                }));
            } else {
                navItems = flattenQuestions(currentPaper.questions); // flat list of objects
            }

            return (
                <div className="flex flex-col h-full bg-frame">
                    
                    {/* Top Controls Area (Frame Aligned) */}
                    <div className="w-full bg-frame z-30 shrink-0 border-b border-hairline md:border-none">
                         <div className="max-w-6xl mx-auto px-4 lg:px-8 py-3 flex items-center justify-between">
                            {/* Paper Selector */}
                            <div className="flex items-center gap-3">
                                <label htmlFor="paper-select" className="sr-only">Select Paper</label>
                                <select
                                    id="paper-select"
                                    value={currentPaperKey}
                                    onChange={(e) => handlePaperChange(e.target.value)}
                                    className="bg-paper border border-hairline text-primary text-sm rounded px-3 py-1.5 focus-visible-ring hover:border-secondary/30 transition-colors shadow-sm"
                                >
                                    {payload.papers.map(p => (
                                        <option key={p.key} value={p.key}>{p.label}</option>
                                    ))}
                                </select>
                            </div>

                            {/* Mobile Jump To Trigger */}
                            <button 
                                className="md:hidden flex items-center gap-2 text-sm font-medium text-accent px-3 py-1.5 hover:bg-black/5 rounded focus-visible-ring"
                                onClick={() => setMobileNavOpen(true)}
                            >
                                <span>Jump to</span>
                                <IconMenu />
                            </button>
                        </div>
                    </div>

                    {/* DocumentFrameShell */}
                    <div className="flex-1 overflow-hidden relative">
                         <div className="h-full max-w-6xl mx-auto px-4 lg:px-8 flex items-start gap-8 relative">
                            
                            {/* Desktop Navigation Rail (Sticky) */}
                            <div className="hidden md:block w-48 lg:w-56 shrink-0 h-full overflow-y-auto no-scrollbar py-6 sticky top-0">
                                <NavigationList 
                                    items={navItems} 
                                    currentId={currentViewId} 
                                    onNavigate={handleNavigate} 
                                />
                            </div>

                            {/* Divider Line */}
                            <div className="hidden md:block w-px h-full bg-hairline shrink-0" />

                            {/* Paper Content Column */}
                            <main className="flex-1 h-full overflow-y-auto w-full">
                                <div className="bg-paper min-h-full py-8 md:px-8 max-w-3xl">
                                    {/* Questions Render Loop */}
                                    {currentPaper.sections ? (
                                        currentPaper.sections.map((sec, idx) => (
                                            <div key={idx} className="mb-12">
                                                {sec.label && (
                                                    <div className="text-xl font-bold text-primary mb-8 pb-2 border-b border-hairline">
                                                        Section {sec.label}
                                                    </div>
                                                )}
                                                {sec.questions.map(q => (
                                                    <QuestionNode 
                                                        key={q.id} 
                                                        node={q} 
                                                        expandedState={expandedStates} 
                                                        toggleExpanded={toggleExpanded} 
                                                    />
                                                ))}
                                            </div>
                                        ))
                                    ) : (
                                        currentPaper.questions.map(q => (
                                            <QuestionNode 
                                                key={q.id} 
                                                node={q} 
                                                expandedState={expandedStates} 
                                                toggleExpanded={toggleExpanded} 
                                            />
                                        ))
                                    )}
                                    
                                    {/* Bottom padding for scroll comfort */}
                                    <div className="h-32"></div>
                                </div>
                            </main>
                        </div>
                    </div>

                    {/* Mobile Navigation Drawer */}
                    {mobileNavOpen && (
                        <div className="fixed inset-0 z-50 md:hidden flex justify-end" role="dialog" aria-modal="true">
                            {/* Backdrop */}
                            <div className="absolute inset-0 bg-black/20 backdrop-blur-sm" onClick={() => setMobileNavOpen(false)}></div>
                            
                            {/* Drawer Surface */}
                            <div className="relative w-[85%] max-w-sm bg-paper h-full shadow-xl flex flex-col animate-in slide-in-from-right duration-200">
                                <div className="flex items-center justify-between p-4 border-b border-hairline bg-page">
                                    <h2 className="text-lg font-semibold text-primary">Jump to</h2>
                                    <button 
                                        onClick={() => setMobileNavOpen(false)}
                                        className="p-2 text-secondary hover:text-primary rounded focus-visible-ring"
                                    >
                                        <IconX />
                                    </button>
                                </div>
                                <div className="flex-1 overflow-y-auto p-4">
                                     <NavigationList 
                                        items={navItems} 
                                        currentId={currentViewId} 
                                        onNavigate={handleNavigate} 
                                    />
                                </div>
                            </div>
                        </div>
                    )}

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
