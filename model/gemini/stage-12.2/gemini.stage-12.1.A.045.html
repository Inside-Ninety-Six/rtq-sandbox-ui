<!DOCTYPE html>
<html lang="en" class="light">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"A","indexWithinVariant":"45","totalWithinVariant":"50","hueFamily":"","intensityMode":"","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-08T13:11:26.057Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;A&quot;,&quot;indexWithinVariant&quot;:&quot;45&quot;,&quot;totalWithinVariant&quot;:&quot;50&quot;,&quot;hueFamily&quot;:&quot;&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-08T13:11:26.057Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ â€“ Maths Paper Solution Viewer</title>
    
    <!-- Fonts: Inter for a clean, modern, neutral look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- KaTeX CSS (No integrity, per Stage 6 instructions) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <!-- Tailwind CSS (via CDN for prototype speed) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class', // Light mode only enforced by "class" strategy and hardcoded 'light'
            theme: {
                fontFamily: {
                    sans: ['Inter', 'sans-serif'],
                },
                extend: {
                    colors: {
                        // Colorlab A: Palette Freedom (Light Only).
                        // Using a sophisticated Slate + Indigo palette for a calm, modern educational tone.
                        background: '#f8fafc', // Slate-50
                        surface: '#ffffff',
                        
                        // Text hierarchy
                        primary: '#0f172a',   // Slate-900
                        secondary: '#475569', // Slate-600
                        tertiary: '#94a3b8',  // Slate-400
                        
                        // Interactive / Focus (Restrained Accent)
                        accent: '#4f46e5',    // Indigo-600 (used sparingly for active states/focus)
                        'accent-subtle': '#e0e7ff', // Indigo-100

                        // Structural borders
                        border: '#e2e8f0',    // Slate-200
                        divider: '#f1f5f9',   // Slate-100
                    },
                    spacing: {
                        'nav-w': '240px',
                    }
                }
            }
        }
    </script>

    <style>
        /* Scrollbar hiding for Nav */
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* KaTeX Containment Invariant */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 4px; /* Space for scrollbar if needed */
        }
        /* Ensure KaTeX doesn't force width */
        .katex-display > .katex {
            white-space: normal;
        }
        
        /* Markdown Content Styling */
        .markdown-body p {
            margin-bottom: 0.75em;
            line-height: 1.6;
        }
        .markdown-body p:last-child {
            margin-bottom: 0;
        }
        .markdown-body ul {
            list-style-type: disc;
            padding-left: 1.25em;
            margin-bottom: 0.75em;
        }
        .markdown-body ol {
            list-style-type: decimal;
            padding-left: 1.25em;
            margin-bottom: 0.75em;
        }
        
        /* Minimal Structural Table */
        .markdown-body table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1em;
            font-size: 0.95em;
        }
        .markdown-body th, .markdown-body td {
            border: 1px solid #e2e8f0;
            padding: 0.5em 0.75em;
            text-align: left;
        }
        .markdown-body th {
            font-weight: 600;
            background-color: transparent;
        }
        
        /* Sticky Nav Active State Indicator - Left Border transition */
        .nav-item-active {
            color: #4f46e5; /* text-accent */
            font-weight: 600;
            border-left-color: #4f46e5;
        }
    </style>
</head>
<body class="bg-background text-primary antialiased selection:bg-accent-subtle selection:text-accent overflow-y-scroll">

    <!-- Dependencies Scripts -->
    <!-- Markdown-it -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>
    <!-- KaTeX JS -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- App Root -->
    <div id="app" class="flex flex-col min-h-screen">
        
        <!-- Top Controls Region -->
        <header class="sticky top-0 z-40 w-full bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/80 border-b border-border">
            <div class="max-w-[1200px] mx-auto px-4 h-14 flex items-center justify-between">
                <!-- Paper Selector -->
                <div class="flex items-center gap-4">
                    <label for="paper-select" class="text-sm font-medium text-secondary hidden sm:block">Paper</label>
                    <select id="paper-select" class="h-9 px-3 rounded-md border border-border bg-surface text-sm focus:outline-none focus:ring-2 focus:ring-accent focus:border-accent w-48 sm:w-64">
                        <option value="" disabled selected>Loading papers...</option>
                    </select>
                </div>

                <!-- Mobile Jump To Trigger -->
                <button id="mobile-menu-trigger" class="lg:hidden flex items-center gap-2 text-sm font-medium text-secondary hover:text-primary transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-accent rounded px-2 py-1">
                    <span>Jump to</span>
                    <i data-lucide="menu" class="w-4 h-4"></i>
                </button>
            </div>
        </header>

        <!-- DocumentFrameShell -->
        <main class="flex-1 max-w-[1200px] w-full mx-auto px-4 grid lg:grid-cols-[240px_1fr] gap-8 py-8 relative">
            
            <!-- Desktop Navigation Rail (Sticky) -->
            <aside class="hidden lg:block h-[calc(100vh-6rem)] sticky top-20">
                <nav id="desktop-nav" class="h-full overflow-y-auto no-scrollbar pr-4" aria-label="Paper navigation">
                    <!-- Nav items injected here -->
                </nav>
            </aside>

            <!-- Paper Content Column -->
            <div id="paper-content" class="min-w-0 pb-32">
                <!-- Content injected here -->
                <div class="flex items-center justify-center h-64 text-secondary animate-pulse">
                    Loading payload...
                </div>
            </div>

        </main>
    </div>

    <!-- Mobile Navigation Drawer -->
    <div id="mobile-drawer-overlay" class="fixed inset-0 bg-black/50 z-50 hidden transition-opacity opacity-0" aria-hidden="true"></div>
    <div id="mobile-drawer" class="fixed inset-y-0 right-0 z-50 w-72 bg-surface shadow-xl transform translate-x-full transition-transform duration-300 flex flex-col" role="dialog" aria-modal="true" aria-label="Jump to question">
        <div class="p-4 border-b border-border flex items-center justify-between">
            <h2 class="font-semibold text-lg">Jump to</h2>
            <button id="mobile-drawer-close" class="p-2 text-secondary hover:text-primary rounded focus:outline-none focus:ring-2 focus:ring-accent">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>
        <nav id="mobile-nav-list" class="flex-1 overflow-y-auto p-4 space-y-1">
            <!-- Mobile nav items injected here -->
        </nav>
    </div>

    <!-- MAIN LOGIC -->
    <script>
        // --- STAGE 0: CONSTANTS ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // --- STATE & CONFIG ---
        let payload = null;
        let currentPaper = null;
        let expandedStates = {}; // key: questionId, value: boolean
        
        // --- MARKDOWN INIT ---
        const md = window.markdownit ? window.markdownit({
            html: true,
            linkify: true,
            breaks: false, // Invariant
        }) : null;

        if (md) {
            md.inline.ruler.disable(['escape']); // Preserve TeX backslashes
        }

        // --- DOM ELEMENTS ---
        const els = {
            select: document.getElementById('paper-select'),
            content: document.getElementById('paper-content'),
            desktopNav: document.getElementById('desktop-nav'),
            mobileNav: document.getElementById('mobile-nav-list'),
            mobileTrigger: document.getElementById('mobile-menu-trigger'),
            mobileDrawer: document.getElementById('mobile-drawer'),
            mobileDrawerOverlay: document.getElementById('mobile-drawer-overlay'),
            mobileDrawerClose: document.getElementById('mobile-drawer-close'),
        };

        // --- INIT ---
        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error('Payload fetch failed');
                payload = await response.json();
                
                if (!payload.papers || payload.papers.length === 0) {
                    throw new Error('Invalid payload');
                }

                populateSelector();
                loadPaper(payload.papers[0].key);

            } catch (err) {
                console.error(err);
                renderError();
            }
        }

        function renderError() {
            els.content.innerHTML = `
                <div class="p-8 border-2 border-dashed border-red-200 rounded-lg bg-red-50 text-center text-red-800">
                    <h2 class="text-xl font-bold mb-2">PAPERS PAYLOAD MISSING</h2>
                    <p class="text-sm">Unable to load content from canonical path.</p>
                </div>
            `;
            els.select.innerHTML = '<option disabled>Error loading papers</option>';
        }

        function populateSelector() {
            els.select.innerHTML = '';
            payload.papers.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.key;
                opt.textContent = p.label || p.key;
                els.select.appendChild(opt);
            });

            els.select.addEventListener('change', (e) => {
                loadPaper(e.target.value);
            });
        }

        function loadPaper(paperKey) {
            currentPaper = payload.papers.find(p => p.key === paperKey);
            if (!currentPaper) return;

            // Initialize expanded states based on defaults
            // If expandedAll is missing, default to true per brief (unless explicit logic says otherwise)
            // Brief: "Answer visible by default when present. Solution Details expanded by default when present (unless defaults.expandedAll=false)"
            const defaultExpanded = currentPaper.defaults?.expandedAll !== false;
            
            // We don't need to pre-fill expandedStates for every ID, we can treat undefined as default
            expandedStates = { __default: defaultExpanded };

            // Render
            renderContent();
            renderNavigation();
            
            // Post-render Effects
            requestAnimationFrame(() => {
                renderMath();
                lucide.createIcons();
                setupInteractions();
                setupIntersectionObserver();
            });
        }

        // --- CONTENT RENDERING ---

        function renderContent() {
            const isSectioned = !!currentPaper.sections;
            let html = '';

            if (isSectioned) {
                currentPaper.sections.forEach(section => {
                    const label = (section.label || '').trim();
                    if (label) {
                        html += `
                            <div class="mb-8 pt-4">
                                <div class="text-lg font-semibold text-secondary border-b border-border pb-2 mb-6">${escapeHtml(label)}</div>
                                <div class="space-y-12">
                                    ${renderQuestionList(section.questions)}
                                </div>
                            </div>
                        `;
                    } else {
                        // Section without label
                        html += `
                            <div class="mb-8 pt-4 space-y-12">
                                ${renderQuestionList(section.questions)}
                            </div>
                        `;
                    }
                });
            } else if (currentPaper.questions) {
                html += `
                    <div class="pt-4 space-y-12">
                        ${renderQuestionList(currentPaper.questions)}
                    </div>
                `;
            }

            els.content.innerHTML = html;
        }

        function renderQuestionList(questions) {
            return questions.map(q => renderQuestionNode(q)).join('');
        }

        function renderQuestionNode(node, depth = 0) {
            const hasChildren = node.children && node.children.length > 0;
            const hasSolutionBlock = !!node.solutionBlock;
            const hasAnswer = hasSolutionBlock && !!node.solutionBlock.answer;
            const hasSolutionDetails = hasSolutionBlock && !!node.solutionBlock.solutionDetails;
            
            // ID for anchor
            const nodeId = `q-${node.id.replace(/[^a-zA-Z0-9-]/g, '_')}`;

            // Check expansion state
            const isExpanded = expandedStates[node.id] !== undefined 
                ? expandedStates[node.id] 
                : expandedStates.__default;

            // Styles based on depth/nesting
            // Top level separation is handled by parent container space-y-12
            // Children separation handled by internal logic
            
            let html = `
                <div id="${nodeId}" class="group relative question-node" data-qid="${node.id}">
                    <!-- Question Body -->
                    <div class="flex gap-3 md:gap-4">
                        <div class="flex-none w-8 md:w-10 pt-1">
                            <span class="text-base font-semibold text-secondary block sticky top-20">${node.id}</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <!-- Prompt -->
                            <div class="text-lg text-primary font-medium markdown-body">
                                ${mdRender(node.question)}
                            </div>

                            <!-- Solution Block -->
                            ${hasSolutionBlock ? renderSolutionBlock(node, hasAnswer, hasSolutionDetails, isExpanded) : ''}
                        </div>
                    </div>

                    <!-- Children -->
                    ${hasChildren ? `
                        <div class="mt-6 ml-4 md:ml-10 border-l border-divider pl-4 md:pl-6 space-y-6">
                            ${node.children.map(c => renderQuestionNode(c, depth + 1)).join('')}
                        </div>
                    ` : ''}
                </div>
            `;

            return html;
        }

        function renderSolutionBlock(node, hasAnswer, hasSolutionDetails, isExpanded) {
            const detailsId = `details-${node.id.replace(/[^a-zA-Z0-9-]/g, '_')}`;
            
            return `
                <div class="mt-4 space-y-4">
                    <!-- Separator (Quiet) -->
                    <!-- <hr class="border-t border-divider w-full" /> -->

                    <!-- Answer -->
                    ${hasAnswer ? `
                        <div class="relative">
                            <span class="text-xs font-bold uppercase tracking-wider text-secondary mb-1 block">Answer</span>
                            <div class="text-primary markdown-body">
                                ${mdRender(node.solutionBlock.answer)}
                            </div>
                        </div>
                    ` : ''}

                    <!-- Solution Details -->
                    ${hasSolutionDetails ? `
                        <div class="pt-2">
                            <!-- Disclosure Control -->
                            <button 
                                class="toggle-btn text-sm font-medium text-accent hover:text-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-accent rounded px-1 -ml-1 flex items-center gap-1 transition-colors"
                                aria-expanded="${isExpanded}"
                                aria-controls="${detailsId}"
                                data-target-id="${node.id}"
                            >
                                <span class="toggle-text">${isExpanded ? 'Hide working' : 'Show working'}</span>
                                <i data-lucide="${isExpanded ? 'chevron-up' : 'chevron-down'}" class="w-4 h-4"></i>
                            </button>

                            <!-- Expandable Region -->
                            <div id="${detailsId}" class="${isExpanded ? 'block' : 'hidden'} mt-3 pl-4 border-l-2 border-accent/20 bg-slate-50/50 rounded-r-sm">
                                ${renderSolutionDetailsContent(node.solutionBlock.solutionDetails)}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderSolutionDetailsContent(details) {
            let parts = [];
            
            // 1. Keep in mind
            if (details.keepInMind) {
                parts.push(`
                    <div class="mb-6">
                        <div class="flex items-center gap-2 mb-2 text-secondary">
                            <i data-lucide="lightbulb" class="w-4 h-4"></i>
                            <span class="text-xs font-bold uppercase tracking-wider">Keep in mind</span>
                        </div>
                        <div class="text-secondary text-sm markdown-body">
                            ${mdRender(details.keepInMind)}
                        </div>
                    </div>
                `);
            }

            // 2. Formulas Used
            if (details.formulasUsed) {
                parts.push(`
                    <div class="mb-6">
                        <span class="text-xs font-bold uppercase tracking-wider text-secondary mb-2 block">Formulas used</span>
                        <div class="text-secondary text-sm markdown-body font-mono text-xs bg-white p-2 rounded border border-border inline-block">
                            ${mdRender(details.formulasUsed)}
                        </div>
                    </div>
                `);
            }

            // 3. Working
            if (details.working) {
                parts.push(`
                    <div class="mb-6">
                        <span class="text-xs font-bold uppercase tracking-wider text-secondary mb-2 block">Working</span>
                        <div class="text-slate-700 markdown-body">
                            ${mdRender(details.working)}
                        </div>
                    </div>
                `);
            }

            // 4. Alternative Working
            if (details.alternativeWorking && details.alternativeWorking.length > 0) {
                details.alternativeWorking.forEach((alt, idx) => {
                    parts.push(`
                        <div class="pt-4 mt-4 border-t border-divider">
                            <span class="text-xs font-bold uppercase tracking-wider text-secondary mb-2 block">Alternative working ${details.alternativeWorking.length > 1 ? idx + 1 : ''}</span>
                            <div class="text-slate-700 markdown-body">
                                ${mdRender(alt)}
                            </div>
                        </div>
                    `);
                });
            }

            return `<div class="py-3 pr-2">${parts.join('')}</div>`;
        }

        function mdRender(content) {
            if (!content) return '';
            if (!md) return content; // Fallback
            return md.render(content);
        }

        // --- NAVIGATION RENDERING ---

        function renderNavigation() {
            // Flatten the list for rendering
            const items = [];
            
            if (currentPaper.sections) {
                currentPaper.sections.forEach(sec => {
                    if (sec.label) {
                        items.push({ type: 'section', label: sec.label });
                    }
                    flattenQuestions(sec.questions, items);
                });
            } else {
                flattenQuestions(currentPaper.questions, items);
            }

            const html = items.map(item => {
                if (item.type === 'section') {
                    return `
                        <div class="pt-6 pb-2 text-xs font-bold text-tertiary uppercase tracking-widest pl-3 select-none">
                            ${escapeHtml(item.label)}
                        </div>
                    `;
                } else {
                    // Question Item
                    // Hierarchy via type scale: depth 0 = normal, depth > 0 = smaller/quieter
                    const isSub = item.depth > 0;
                    const fontSize = isSub ? 'text-sm' : 'text-[15px]';
                    const color = isSub ? 'text-secondary' : 'text-secondary';
                    const paddingV = isSub ? 'py-1' : 'py-1.5';
                    const anchor = `#q-${item.id.replace(/[^a-zA-Z0-9-]/g, '_')}`;
                    
                    return `
                        <a href="${anchor}" 
                           class="nav-item block pl-3 border-l-2 border-transparent hover:text-primary hover:border-border transition-colors ${fontSize} ${color} ${paddingV}"
                           data-target="${item.id}"
                           onclick="handleNavClick(event, '${anchor}')"
                        >
                            ${item.id}
                        </a>
                    `;
                }
            }).join('');

            els.desktopNav.innerHTML = html;
            els.mobileNav.innerHTML = html;
        }

        function flattenQuestions(list, acc, depth = 0) {
            list.forEach(q => {
                acc.push({ type: 'question', id: q.id, depth });
                if (q.children) {
                    flattenQuestions(q.children, acc, depth + 1);
                }
            });
        }

        // --- INTERACTIONS ---

        function setupInteractions() {
            // Toggles
            document.querySelectorAll('.toggle-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation(); // prevent bubbling issues
                    const targetId = btn.dataset.targetId;
                    const region = document.getElementById(btn.getAttribute('aria-controls'));
                    const isExpanded = btn.getAttribute('aria-expanded') === 'true';
                    
                    // Toggle state
                    const newState = !isExpanded;
                    btn.setAttribute('aria-expanded', newState);
                    region.classList.toggle('hidden');
                    region.classList.toggle('block');
                    
                    // Update Text & Icon
                    const textSpan = btn.querySelector('.toggle-text');
                    const icon = btn.querySelector('[data-lucide]');
                    textSpan.textContent = newState ? 'Hide working' : 'Show working';
                    
                    // Manually replace icon attributes for quick update (Lucide normally needs re-run)
                    // But simpler to just re-run lucide on this container or specific elements
                    // Or swap innerHTML if we want to be fast
                    btn.innerHTML = `
                        <span class="toggle-text">${newState ? 'Hide working' : 'Show working'}</span>
                        <i data-lucide="${newState ? 'chevron-up' : 'chevron-down'}" class="w-4 h-4"></i>
                    `;
                    lucide.createIcons({ root: btn });

                    // Persist state
                    expandedStates[targetId] = newState;
                });
            });

            // Mobile Drawer Logic
            els.mobileTrigger.addEventListener('click', () => {
                els.mobileDrawerOverlay.classList.remove('hidden', 'opacity-0');
                els.mobileDrawer.classList.remove('translate-x-full');
                document.body.style.overflow = 'hidden'; // Lock scroll
            });

            const closeDrawer = () => {
                els.mobileDrawerOverlay.classList.add('opacity-0');
                els.mobileDrawer.classList.add('translate-x-full');
                setTimeout(() => {
                    els.mobileDrawerOverlay.classList.add('hidden');
                    document.body.style.overflow = '';
                }, 300);
            };

            els.mobileDrawerClose.addEventListener('click', closeDrawer);
            els.mobileDrawerOverlay.addEventListener('click', closeDrawer);
        }

        window.handleNavClick = function(e, anchor) {
            e.preventDefault();
            const target = document.querySelector(anchor);
            if (target) {
                // Smooth scroll with offset for header
                const headerOffset = 80;
                const elementPosition = target.getBoundingClientRect().top;
                const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
                
                window.scrollTo({
                    top: offsetPosition,
                    behavior: 'smooth'
                });

                // Close drawer if open
                if (!els.mobileDrawer.classList.contains('translate-x-full')) {
                    els.mobileDrawerOverlay.click();
                }
            }
        };

        // --- SCROLL SPY (INTERSECTION OBSERVER) ---
        function setupIntersectionObserver() {
            const observerOptions = {
                root: null,
                rootMargin: '-80px 0px -70% 0px', // Trigger when element hits top area
                threshold: 0
            };

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const id = entry.target.getAttribute('data-qid');
                        updateActiveNav(id);
                    }
                });
            }, observerOptions);

            document.querySelectorAll('.question-node').forEach(node => {
                observer.observe(node);
            });
        }

        function updateActiveNav(id) {
            // Remove active class from all
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('nav-item-active');
                el.classList.add('border-transparent');
            });

            // Add to current (Desktop & Mobile)
            const targets = document.querySelectorAll(`.nav-item[data-target="${id}"]`);
            targets.forEach(t => {
                t.classList.add('nav-item-active');
                t.classList.remove('border-transparent');
                
                // Scroll nav rail to keep active item in view if needed
                if (t.parentElement.id === 'desktop-nav') {
                   // Simple scroll into view logic if out of bounds could go here
                }
            });
        }

        // --- MATH RENDERING ---
        function renderMath() {
            if (window.renderMathInElement) {
                renderMathInElement(els.content, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false}
                    ],
                    throwOnError: false
                });
            }
        }

        // --- UTILS ---
        function escapeHtml(text) {
            if (!text) return '';
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // --- START ---
        document.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
