<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"ABC","indexWithinVariant":"257","totalWithinVariant":"320","hueFamily":"green","intensityMode":"accent_only","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-09T22:17:32.860Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;ABC&quot;,&quot;indexWithinVariant&quot;:&quot;257&quot;,&quot;totalWithinVariant&quot;:&quot;320&quot;,&quot;hueFamily&quot;:&quot;green&quot;,&quot;intensityMode&quot;:&quot;accent_only&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-09T22:17:32.860Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer (Stress Test)</title>
    
    <!-- KaTeX CSS (No integrity, SRI disabled per Stage 6 baseline) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <style>
        /* =========================================
           STAGE 6 ADD-ON: COLORLAB CONFIG
           Mode: accent_only
           Hue: green (Hardcoded default per instructions)
           ========================================= */
        :root {
            /* Core Palette - OKLCH */
            --hue: 146; /* Green */
            
            /* Surfaces (C <= 0.015 for accent_only) */
            --bg-page: oklch(0.985 0.005 var(--hue)); 
            --bg-frame: oklch(1.0 0 0); /* White base for shell */
            --bg-paper: oklch(1.0 0 0); /* White paper */
            --bg-nav: oklch(1.0 0 0);   /* Nav shares surface */
            
            /* Washes (Solution Details) */
            --bg-wash-sd: oklch(0.975 0.012 var(--hue));
            
            /* Text (C <= 0.010 for accent_only) */
            --text-primary: oklch(0.20 0.01 var(--hue));
            --text-secondary: oklch(0.45 0.01 var(--hue));
            --text-tertiary: oklch(0.60 0.005 var(--hue)); /* Navigation/Quiet */

            /* Accent (C in [0.08 .. 0.14] for accent_only) */
            /* Used for: Links, Focus, Disclosure, Nav Marker */
            --color-accent: oklch(0.55 0.13 var(--hue)); 
            
            /* Separators */
            --border-hairline: oklch(0.92 0.005 var(--hue));
            --border-focus: var(--color-accent);

            /* Spacing Scale (Rhythm) */
            --sp-xs: 0.25rem;
            --sp-sm: 0.5rem;
            --sp-md: 1rem;
            --sp-lg: 1.5rem;
            --sp-xl: 2.5rem; /* Top level separation */
            --sp-xxl: 4rem;

            /* Dimensions */
            --nav-width: 200px;
            --frame-max-width: 1024px;
            --header-height: 60px;
        }

        /* Reset & Base */
        *, *::before, *::after { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-page);
            color: var(--text-primary);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        button {
            font-family: inherit;
            border: none;
            background: none;
            cursor: pointer;
            padding: 0;
            color: inherit;
        }

        /* Focus Visibility (Stage 5.5.2) */
        :focus-visible {
            outline: 2px solid var(--border-focus);
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* =========================================
           LAYOUT ARCHITECTURE (STAGE 3)
           ========================================= */
        
        /* Top Controls Region */
        .top-controls {
            position: sticky;
            top: 0;
            z-index: 50;
            height: var(--header-height);
            background-color: var(--bg-frame); /* Matches shell base */
            border-bottom: 1px solid var(--border-hairline);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 var(--sp-md);
        }

        .top-controls-inner {
            width: 100%;
            max-width: var(--frame-max-width);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .paper-selector {
            font-size: 0.9rem;
            padding: var(--sp-sm);
            border: 1px solid var(--border-hairline);
            border-radius: 4px;
            color: var(--text-primary);
            background: transparent;
        }

        /* Mobile Jump To Trigger */
        .jump-to-trigger {
            display: none; /* Desktop default */
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--color-accent);
            display: flex;
            align-items: center;
            gap: var(--sp-xs);
        }
        
        @media (min-width: 769px) {
            .jump-to-trigger { display: none !important; }
        }

        /* DocumentFrameShell */
        .document-shell {
            max-width: var(--frame-max-width);
            margin: 0 auto;
            background-color: var(--bg-frame);
            min-height: calc(100vh - var(--header-height));
            display: flex;
            border-left: 1px solid transparent; /* Optical balancing */
            border-right: 1px solid transparent;
        }

        /* Desktop Columns */
        .nav-column {
            width: var(--nav-width);
            flex-shrink: 0;
            padding: var(--sp-lg) var(--sp-md) var(--sp-lg) 0;
            position: sticky;
            top: var(--header-height);
            height: calc(100vh - var(--header-height));
            overflow-y: auto;
            /* Scrollbar hiding (Add-on) */
            scrollbar-width: none;
            -ms-overflow-style: none;
            display: none; /* Hidden on mobile */
        }
        .nav-column::-webkit-scrollbar { display: none; }

        @media (min-width: 769px) {
            .nav-column { display: block; }
        }

        .paper-column {
            flex-grow: 1;
            padding: var(--sp-lg) var(--sp-md) var(--sp-xxl) var(--sp-lg);
            min-width: 0; /* Critical for flex child overflow */
        }

        /* =========================================
           NAVIGATION (STAGE 3 & 5.4)
           ========================================= */
        .nav-list {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        /* Section Label (Non-clickable) */
        .nav-section-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-tertiary);
            margin-top: var(--sp-md);
            margin-bottom: var(--sp-xs);
            padding-left: var(--sp-sm);
            font-weight: 600;
            pointer-events: none;
        }
        .nav-section-label:first-child { margin-top: 0; }

        /* Nav Item */
        .nav-item {
            display: block;
            text-decoration: none;
            font-size: 0.85rem;
            color: var(--text-secondary);
            padding: var(--sp-xs) var(--sp-sm);
            border-radius: 4px;
            transition: color 0.15s ease, font-weight 0.15s ease;
            /* Flat list visual - no indentation */
        }

        .nav-item:hover {
            color: var(--text-primary);
            background-color: rgba(0,0,0,0.02); /* Very subtle hover */
        }

        .nav-item.active {
            font-weight: 600;
            color: var(--color-accent); /* Permitted override Stage 6 */
        }
        
        /* Hierarchy via Type Scale (Sub-questions quieter) */
        .nav-item[data-depth="1"] { font-size: 0.8rem; opacity: 0.9; }
        .nav-item[data-depth="2"] { font-size: 0.75rem; opacity: 0.85; }

        /* =========================================
           PAPER CONTENT (STAGE 3, 4, 5)
           ========================================= */
        
        /* Section Header in Paper */
        .section-header {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            padding-bottom: var(--sp-sm);
            border-bottom: 1px solid var(--border-hairline);
            margin-bottom: var(--sp-xl);
            margin-top: var(--sp-xl);
        }
        .section-header:first-child { margin-top: 0; }

        /* Question Node */
        .question-node {
            display: flex;
            flex-direction: column;
            /* No borders, no cards */
        }

        /* Top Level Separation */
        .question-node[data-depth="0"] {
            margin-bottom: var(--sp-xl);
        }

        /* Child Separation */
        .children-container {
            margin-top: var(--sp-md);
            padding-left: var(--sp-md); /* Indentation for structure */
            display: flex;
            flex-direction: column;
            gap: var(--sp-lg);
        }
        
        @media (max-width: 480px) {
            .children-container { padding-left: var(--sp-sm); }
        }

        /* Question Body */
        .question-body {
            display: flex;
            gap: var(--sp-sm);
            margin-bottom: var(--sp-sm);
        }

        .question-id {
            font-weight: 600;
            color: var(--text-primary);
            flex-shrink: 0;
            min-width: 1.5rem;
        }

        .question-prompt {
            color: var(--text-primary);
            font-weight: 400;
        }

        /* Solution Block (Supporting Material) */
        .solution-block {
            margin-left: 2rem; /* Indent relative to ID */
            display: flex;
            flex-direction: column;
            gap: var(--sp-md);
        }
        
        @media (max-width: 480px) {
            .solution-block { margin-left: 0; }
        }

        /* Answer */
        .answer-region {
            color: var(--text-primary);
            font-weight: 500;
            display: flex;
            gap: var(--sp-sm);
            align-items: baseline;
        }
        .answer-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Solution Details Control */
        .sd-control {
            display: inline-flex;
            align-items: center;
            gap: var(--sp-xs);
            font-size: 0.9rem;
            color: var(--color-accent);
            font-weight: 500;
            align-self: flex-start;
            padding: var(--sp-xs) 0;
        }
        .sd-control:hover {
            text-decoration: underline;
        }
        .sd-chevron {
            width: 16px;
            height: 16px;
            transition: transform 0.2s ease;
        }
        .sd-control[aria-expanded="true"] .sd-chevron {
            transform: rotate(180deg);
        }

        /* Solution Details Region */
        .solution-details {
            display: none;
            flex-direction: column;
            gap: var(--sp-md);
            padding: var(--sp-md);
            background-color: var(--bg-wash-sd); /* Permitted wash */
            border-radius: 4px; /* Softness, not card */
            font-size: 0.95rem;
            color: var(--text-secondary); /* Subordinate */
        }
        .solution-details[data-visible="true"] {
            display: flex;
            animation: fadeIn 0.2s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-4px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Subsection Grammar */
        .sd-subsection {
            display: flex;
            flex-direction: column;
            gap: var(--sp-xs);
        }
        
        .sd-label {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-tertiary);
            letter-spacing: 0.05em;
            margin-bottom: var(--sp-xs);
        }
        
        .sd-content {
            /* Body text constraints */
            line-height: 1.6;
        }

        /* Internal Separators */
        .sd-separator {
            height: 1px;
            background-color: var(--border-hairline);
            margin: var(--sp-xs) 0;
            width: 100%;
        }

        /* Keep in mind */
        .keep-in-mind .sd-label { color: var(--color-accent); } /* Restrained accent allowed for emphasis */
        
        /* Alternative Working */
        .alt-working {
            margin-top: var(--sp-sm);
        }

        /* =========================================
           MARKDOWN & KATEX CONTENT STYLES
           ========================================= */
        .md-content p { margin: 0 0 0.75em 0; }
        .md-content p:last-child { margin-bottom: 0; }
        
        /* Tables (Minimal) */
        .md-content table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
            margin: var(--sp-sm) 0;
        }
        .md-content th, .md-content td {
            text-align: left;
            padding: var(--sp-xs) var(--sp-sm);
            border-bottom: 1px solid var(--border-hairline);
        }
        .md-content th { font-weight: 600; color: var(--text-primary); }

        /* Lists */
        .md-content ul, .md-content ol {
            padding-left: 1.25em;
            margin: 0 0 0.75em 0;
        }
        .md-content li { margin-bottom: 0.25em; }

        /* KaTeX Containment (Invariant) */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            padding: 0.5em 0;
            max-width: 100%;
            -webkit-overflow-scrolling: touch;
        }
        /* Hide scrollbar on math if possible but allow scroll */
        .katex-display::-webkit-scrollbar { height: 4px; }
        .katex-display::-webkit-scrollbar-thumb { background: var(--text-tertiary); border-radius: 2px; }

        /* Inline SVG */
        svg { max-width: 100%; height: auto; }

        /* =========================================
           MOBILE DRAWER (STAGE 3)
           ========================================= */
        .drawer-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }
        .drawer {
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            width: 280px;
            background: var(--bg-frame);
            z-index: 101;
            transform: translateX(-100%);
            transition: transform 0.25s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 8px rgba(0,0,0,0.05);
        }
        
        .drawer-open .drawer-overlay { opacity: 1; pointer-events: auto; }
        .drawer-open .drawer { transform: translateX(0); }

        .drawer-header {
            height: var(--header-height);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 var(--sp-md);
            border-bottom: 1px solid var(--border-hairline);
        }
        .drawer-title { font-weight: 600; color: var(--text-primary); }
        .drawer-close { font-size: 1.5rem; color: var(--text-secondary); line-height: 1; }
        
        .drawer-content {
            flex: 1;
            overflow-y: auto;
            padding: var(--sp-md);
        }

        /* Error / Empty State */
        .error-message {
            padding: var(--sp-xl);
            text-align: center;
            color: var(--text-secondary);
            font-weight: 500;
            letter-spacing: 0.05em;
        }
    </style>
</head>
<body>

    <!-- Top Controls -->
    <header class="top-controls">
        <div class="top-controls-inner">
            <select id="paperSelector" class="paper-selector" aria-label="Select paper">
                <option value="" disabled selected>Loading papers...</option>
            </select>
            
            <button class="jump-to-trigger" id="jumpToBtn" aria-label="Open navigation">
                <span>Jump to</span>
                <svg width="16" height="16" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1.5 3C1.22386 3 1 3.22386 1 3.5C1 3.77614 1.22386 4 1.5 4H13.5C13.7761 4 14 3.77614 14 3.5C14 3.22386 13.7761 3 13.5 3H1.5ZM1 7.5C1 7.22386 1.22386 7 1.5 7H13.5C13.7761 7 14 7.22386 14 7.5C14 7.77614 13.7761 8 13.5 8H1.5C1.22386 8 1 7.77614 1 7.5ZM1 11.5C1 11.2239 1.22386 11 1.5 11H13.5C13.7761 11 14 11.2239 14 11.5C14 11.7761 13.7761 12 13.5 12H1.5C1.22386 12 1 11.7761 1 11.5Z" fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
            </button>
        </div>
    </header>

    <!-- Main Shell -->
    <div class="document-shell">
        <!-- Desktop Nav Column -->
        <nav class="nav-column" id="desktopNav" aria-label="Question navigation">
            <!-- Nav content injected via JS -->
        </nav>

        <!-- Paper Content Column -->
        <main class="paper-column" id="paperContent">
            <!-- Paper content injected via JS -->
            <div class="error-message">Select a paper to begin.</div>
        </main>
    </div>

    <!-- Mobile Drawer -->
    <div class="drawer-overlay" id="drawerOverlay"></div>
    <div class="drawer" id="drawer" role="dialog" aria-modal="true" aria-label="Navigation">
        <div class="drawer-header">
            <span class="drawer-title">Jump to</span>
            <button class="drawer-close" id="drawerClose" aria-label="Close navigation">&times;</button>
        </div>
        <div class="drawer-content" id="drawerNavContent">
            <!-- Cloned Nav content injected via JS -->
        </div>
    </div>

    <!-- Scripts -->
    <!-- Markdown-it (CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>
    <!-- KaTeX JS (CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <!-- Auto-render KaTeX -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <script>
        // =========================================
        // CONSTANTS (STAGE 0 & 6)
        // =========================================
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";

        // =========================================
        // STATE & DOM ELEMENTS
        // =========================================
        let allPapers = [];
        let currentPaper = null;

        const paperSelector = document.getElementById('paperSelector');
        const paperContent = document.getElementById('paperContent');
        const desktopNav = document.getElementById('desktopNav');
        const drawerNavContent = document.getElementById('drawerNavContent');
        
        // Mobile Drawer Logic
        const jumpToBtn = document.getElementById('jumpToBtn');
        const drawerClose = document.getElementById('drawerClose');
        const drawerOverlay = document.getElementById('drawerOverlay');
        const drawer = document.getElementById('drawer');

        function toggleDrawer(open) {
            if (open) {
                document.body.classList.add('drawer-open');
                drawer.setAttribute('aria-hidden', 'false');
                drawerClose.focus();
            } else {
                document.body.classList.remove('drawer-open');
                drawer.setAttribute('aria-hidden', 'true');
            }
        }

        jumpToBtn.addEventListener('click', () => toggleDrawer(true));
        drawerClose.addEventListener('click', () => toggleDrawer(false));
        drawerOverlay.addEventListener('click', () => toggleDrawer(false));

        // =========================================
        // MARKDOWN & KATEX CONFIG (STAGE 6)
        // =========================================
        const md = window.markdownit ? window.markdownit({
            html: true,       // Enable inline SVG passthrough
            linkify: true,
            breaks: false     // MUST be false to prevent <br> in math
        }) : null;

        if (md) {
            // Disable escape rule to preserve TeX backslashes
            md.inline.ruler.disable(['escape']);
        }

        const renderMath = (element) => {
            if (window.renderMathInElement) {
                renderMathInElement(element, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false}
                    ],
                    throwOnError: false
                });
            }
        };

        // =========================================
        // PAYLOAD LOADING
        // =========================================
        async function loadPayload() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error('Fetch failed');
                const data = await response.json();
                
                if (!data.papers || !Array.isArray(data.papers)) throw new Error('Invalid schema');
                
                allPapers = data.papers;
                initSelector();
                
                // Load first paper by default
                if (allPapers.length > 0) {
                    loadPaper(allPapers[0].key);
                }
            } catch (err) {
                console.error(err);
                paperContent.innerHTML = '<div class="error-message">PAPERS PAYLOAD MISSING</div>';
                paperSelector.innerHTML = '<option disabled>Error loading papers</option>';
            }
        }

        function initSelector() {
            paperSelector.innerHTML = '';
            allPapers.forEach(paper => {
                const opt = document.createElement('option');
                opt.value = paper.key;
                opt.textContent = paper.label || paper.key;
                paperSelector.appendChild(opt);
            });
            
            paperSelector.addEventListener('change', (e) => {
                loadPaper(e.target.value);
            });
        }

        function loadPaper(paperKey) {
            const paper = allPapers.find(p => p.key === paperKey);
            if (!paper) return;
            currentPaper = paper;

            // 1. Render Navigation
            const navHTML = buildNavigation(paper);
            desktopNav.innerHTML = navHTML;
            drawerNavContent.innerHTML = navHTML; // Clone for mobile

            // 2. Render Content
            renderPaperContent(paper);

            // 3. Setup Interactions
            setupScrollSpy();
            setupInteractions();
            
            // 4. Reset Scroll
            window.scrollTo(0,0);
        }

        // =========================================
        // CONTENT RENDERING
        // =========================================
        
        // Helper: Convert Markdown to HTML safely
        const mdRender = (text) => {
            if (!text) return '';
            return md ? md.render(text) : text; // Fallback to plain if md missing
        };

        function renderPaperContent(paper) {
            const defaults = paper.defaults || {};
            const expandAll = defaults.expandedAll !== false; // Default true unless false

            let html = '<div class="question-list">';

            // Helper to render a recursive question node
            const renderNode = (node, depth) => {
                const hasChildren = node.children && node.children.length > 0;
                const sb = node.solutionBlock;
                
                // Determine structure existence
                const hasAnswer = sb && sb.answer;
                const hasDetails = sb && sb.solutionDetails;
                
                let nodeHTML = `
                    <div class="question-node" id="q-${node.id}" data-depth="${depth}">
                        <div class="question-body">
                            <div class="question-id">${node.id}</div>
                            <div class="question-prompt md-content">${mdRender(node.question)}</div>
                        </div>
                `;

                // Solution Block (if exists)
                if (sb) {
                    nodeHTML += `<div class="solution-block">`;
                    
                    // Answer
                    if (hasAnswer) {
                        nodeHTML += `
                            <div class="answer-region">
                                <span class="answer-label">Answer</span>
                                <div class="answer-content md-content">${mdRender(sb.answer)}</div>
                            </div>
                        `;
                    }

                    // Solution Details
                    if (hasDetails) {
                        const sd = sb.solutionDetails;
                        // Determine default state
                        const isExpanded = expandAll; 

                        nodeHTML += `
                            <button class="sd-control" aria-expanded="${isExpanded}" aria-controls="sd-${node.id}">
                                <span class="sd-text">${isExpanded ? 'Hide working' : 'Show working'}</span>
                                <svg class="sd-chevron" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.13523 6.15803C3.3241 5.95657 3.64052 5.94637 3.84197 6.13523L7.5 9.56464L11.158 6.13523C11.3595 5.94637 11.6759 5.95657 11.8648 6.15803C12.0536 6.35949 12.0434 6.67591 11.842 6.86477L7.84197 10.6148C7.64964 10.7951 7.35036 10.7951 7.15803 10.6148L3.15803 6.86477C2.95657 6.67591 2.94637 6.35949 3.13523 6.15803Z" fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
                            </button>
                            <div id="sd-${node.id}" class="solution-details" data-visible="${isExpanded}">
                        `;

                        // Order: Keep in mind, Formulas, Working, Alt Working
                        
                        // Keep in mind
                        if (sd.keepInMind) {
                            nodeHTML += `
                                <div class="sd-subsection keep-in-mind">
                                    <div class="sd-label">Keep in mind</div>
                                    <div class="sd-content md-content">${mdRender(sd.keepInMind)}</div>
                                </div>
                                <div class="sd-separator"></div>
                            `;
                        }

                        // Formulas
                        if (sd.formulasUsed) {
                            nodeHTML += `
                                <div class="sd-subsection">
                                    <div class="sd-label">Formulas used</div>
                                    <div class="sd-content md-content">${mdRender(sd.formulasUsed)}</div>
                                </div>
                                <div class="sd-separator"></div>
                            `;
                        }

                        // Working (Primary)
                        if (sd.working) {
                            nodeHTML += `
                                <div class="sd-subsection">
                                    <div class="sd-label">Working</div>
                                    <div class="sd-content md-content">${mdRender(sd.working)}</div>
                                </div>
                            `;
                        }

                        // Alternative Working
                        if (sd.alternativeWorking && Array.isArray(sd.alternativeWorking)) {
                            sd.alternativeWorking.forEach((alt, idx) => {
                                nodeHTML += `
                                    <div class="sd-separator"></div>
                                    <div class="sd-subsection alt-working">
                                        <div class="sd-label">Alternative working</div>
                                        <div class="sd-content md-content">${mdRender(alt)}</div>
                                    </div>
                                `;
                            });
                        }

                        nodeHTML += `</div>`; // End solution-details
                    }
                    
                    nodeHTML += `</div>`; // End solution-block
                }

                // Recursion for children
                if (hasChildren) {
                    nodeHTML += `<div class="children-container">`;
                    node.children.forEach(child => {
                        nodeHTML += renderNode(child, depth + 1);
                    });
                    nodeHTML += `</div>`;
                }

                nodeHTML += `</div>`; // End question-node
                return nodeHTML;
            };

            // Main rendering loop (Sections vs Flat)
            if (paper.sections) {
                paper.sections.forEach(section => {
                    if (section.label && section.label.trim() !== '') {
                        html += `<div class="section-header">Section ${section.label}</div>`;
                    }
                    section.questions.forEach(q => {
                        html += renderNode(q, 0);
                    });
                });
            } else if (paper.questions) {
                paper.questions.forEach(q => {
                    html += renderNode(q, 0);
                });
            }

            html += '</div>';
            paperContent.innerHTML = html;

            // Post-render: Apply KaTeX
            renderMath(paperContent);
        }

        // =========================================
        // NAVIGATION GENERATION
        // =========================================
        function buildNavigation(paper) {
            let html = '<div class="nav-list">';
            
            const renderNavItem = (node, depth) => {
                // Flat list, hierarchy via data-depth/styles only
                return `<a href="#q-${node.id}" class="nav-item" data-id="${node.id}" data-depth="${depth}">${node.id}</a>`;
            };

            const traverseQuestions = (questions) => {
                let chunk = '';
                questions.forEach(q => {
                    chunk += renderNavItem(q, 0);
                    if (q.children) {
                        const traverseChildren = (children, d) => {
                            children.forEach(c => {
                                chunk += renderNavItem(c, d + 1);
                                if (c.children) traverseChildren(c.children, d + 1);
                            });
                        };
                        traverseChildren(q.children, 0);
                    }
                });
                return chunk;
            };

            if (paper.sections) {
                paper.sections.forEach(section => {
                    if (section.label && section.label.trim() !== '') {
                        html += `<div class="nav-section-label">${section.label}</div>`;
                    }
                    html += traverseQuestions(section.questions);
                });
            } else if (paper.questions) {
                html += traverseQuestions(paper.questions);
            }

            html += '</div>';
            return html;
        }

        // =========================================
        // INTERACTIONS
        // =========================================
        function setupInteractions() {
            // Show/Hide Working
            paperContent.querySelectorAll('.sd-control').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const expanded = btn.getAttribute('aria-expanded') === 'true';
                    const targetId = btn.getAttribute('aria-controls');
                    const target = document.getElementById(targetId);
                    const textSpan = btn.querySelector('.sd-text');

                    // Toggle State
                    const newState = !expanded;
                    btn.setAttribute('aria-expanded', newState);
                    target.setAttribute('data-visible', newState);
                    textSpan.textContent = newState ? 'Hide working' : 'Show working';
                });
            });

            // Nav Clicks (Smooth Scroll & Mobile Drawer Close)
            document.querySelectorAll('.nav-item').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetId = link.getAttribute('href').substring(1);
                    const target = document.getElementById(targetId);
                    if (target) {
                        // Desktop: sticky nav needs offset considerations? 
                        // With layout, simple scrollIntoView usually works well enough, 
                        // but let's do window scroll minus header
                        const headerOffset = 80;
                        const elementPosition = target.getBoundingClientRect().top;
                        const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
                        
                        window.scrollTo({
                            top: offsetPosition,
                            behavior: 'smooth'
                        });

                        // Set active
                        setActiveNav(link.getAttribute('data-id'));
                        
                        // Close drawer on mobile
                        if (document.body.classList.contains('drawer-open')) {
                            toggleDrawer(false);
                        }
                    }
                });
            });
        }

        function setActiveNav(id) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            // Select in both desktop and mobile navs
            const matches = document.querySelectorAll(`.nav-item[data-id="${id}"]`);
            matches.forEach(m => m.classList.add('active'));
        }

        // =========================================
        // SCROLL SPY
        // =========================================
        function setupScrollSpy() {
            const observerOptions = {
                root: null,
                rootMargin: '-10% 0px -80% 0px', // Active when near top
                threshold: 0
            };

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        // Get ID from q-ID
                        const id = entry.target.id.replace('q-', '');
                        setActiveNav(id);
                    }
                });
            }, observerOptions);

            document.querySelectorAll('.question-node').forEach(node => {
                observer.observe(node);
            });
        }

        // Init
        window.addEventListener('DOMContentLoaded', loadPayload);

    </script>
</body>
</html>
