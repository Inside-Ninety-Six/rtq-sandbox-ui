<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"ABC","indexWithinVariant":"68","totalWithinVariant":"320","hueFamily":"green","intensityMode":"deep_theme","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-09T13:05:00.666Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;ABC&quot;,&quot;indexWithinVariant&quot;:&quot;68&quot;,&quot;totalWithinVariant&quot;:&quot;320&quot;,&quot;hueFamily&quot;:&quot;green&quot;,&quot;intensityMode&quot;:&quot;deep_theme&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-09T13:05:00.666Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer (Stage 6 Baseline)</title>

    <!-- 1. Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- 2. KaTeX (No Integrity/SRI per Stage 6.0.7b) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- 3. Markdown-it (No Integrity) -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <!-- 4. Tailwind (Prototyping) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        // Semantic mapping to CSS variables defined in <style>
                        page: 'var(--bg-page)',
                        frame: 'var(--bg-frame)',
                        paper: 'var(--bg-paper)',
                        wash: 'var(--bg-wash)',
                        'txt-primary': 'var(--text-primary)',
                        'txt-secondary': 'var(--text-secondary)',
                        accent: 'var(--accent)',
                        hairline: 'var(--border-hairline)',
                        focus: 'var(--focus-ring)',
                    }
                }
            }
        }
    </script>

    <style>
        /* 
         * STAGE 6 ADD-ON: COLORLAB C - DEEP THEME (LIGHT ONLY)
         * STAGE 6 ADD-ON: COLORLAB B - FORCED HUE: GREEN
         * Hue: 146 (Green)
         */
        :root {
            /* DEEP THEME: All surfaces chromatic. 
               Page (Darkest tint) -> Frame (Mid tint) -> Paper (Lightest tint) 
            */
            --bg-page: oklch(0.92 0.08 146);
            --bg-frame: oklch(0.94 0.09 146);
            --bg-paper: oklch(0.98 0.06 146); 
            
            /* Wash for Solution Details (slightly darker than paper) */
            --bg-wash: oklch(0.95 0.08 146); 

            /* Text: Dark Green-Grey */
            --text-primary: oklch(0.20 0.015 146);
            --text-secondary: oklch(0.35 0.02 146);

            /* Accent: Vibrant Green (L 0.55, C 0.20) */
            --accent: oklch(0.55 0.20 146);
            
            /* Focus: Same as accent or derived */
            --focus-ring: var(--accent);

            /* Hairline: Low chroma green */
            --border-hairline: oklch(0.85 0.03 146);
        }

        body {
            background-color: var(--bg-page);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            overflow-y: scroll; /* Force scrollbar to prevent layout shift */
        }

        /* Focus Management (Stage 5.5.2) */
        *:focus-visible {
            outline: 2px solid var(--focus-ring);
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* Layout Shell */
        .doc-shell {
            max-width: 1200px;
            margin: 0 auto;
            min-height: 100vh;
            background-color: var(--bg-frame);
            /* Desktop: 2 columns */
            display: grid;
            grid-template-columns: 1fr; /* Mobile default */
        }

        @media (min-width: 1024px) {
            .doc-shell {
                grid-template-columns: 240px 1fr;
                /* Stage 3: Frame Gutter Spacing */
                padding-left: 24px; 
                padding-right: 24px;
            }
        }

        /* Navigation Rail (Desktop Sticky) */
        .nav-rail {
            display: none; /* Hidden on mobile */
        }
        @media (min-width: 1024px) {
            .nav-rail {
                display: block;
                position: sticky;
                top: 0;
                height: 100vh;
                overflow-y: auto;
                padding-top: 2rem;
                padding-bottom: 2rem;
                /* Hide scrollbar visually but allow scroll */
                scrollbar-width: none; 
                -ms-overflow-style: none;
            }
            .nav-rail::-webkit-scrollbar { 
                display: none; 
            }
        }

        /* Paper Region */
        .paper-column {
            background-color: var(--bg-frame); /* Visually shares frame surface */
            padding-top: 1rem;
            padding-bottom: 4rem;
        }

        /* The actual Paper Surface (Stage 3) */
        .paper-surface {
            background-color: var(--bg-paper);
            min-height: 80vh;
            /* No shadows, no borders, just surface diff */
            padding: 1.5rem; /* Mobile padding */
        }
        @media (min-width: 768px) {
            .paper-surface {
                padding: 3rem 4rem;
            }
        }

        /* KaTeX Containment (Stage 6.0.8) */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding-bottom: 0.5rem; /* Space for scrollbar */
            -webkit-overflow-scrolling: touch;
        }
        /* Block math underlay allowed (Stage 5.8) - subtle */
        .katex-display > .katex {
            background-color: rgba(255,255,255,0.4); /* Very subtle tint over paper */
            padding: 0.25em 0;
            border-radius: 4px;
            display: inline-block;
            min-width: 100%; /* Ensure background spans width */
        }
        
        /* Markdown Tables */
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 1rem 0;
            font-size: 0.95em;
        }
        th, td {
            border: 1px solid var(--border-hairline);
            padding: 0.5rem 0.75rem;
            text-align: left;
        }
        th {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        /* Typography Hierarchy (Stage 4.2) */
        .q-id {
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.9em;
            margin-right: 0.5rem;
        }
        .q-prompt p {
            display: inline;
        }
        
        /* Utility */
        .btn-reset {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            font: inherit;
        }
        
        /* Transitions */
        .reveal-content {
            transition: all 0.2s ease-out;
        }
        
        /* Navigation List */
        .nav-item {
            display: block;
            padding: 0.25rem 0;
            color: var(--text-secondary);
            font-size: 0.9rem;
            text-decoration: none;
            border-left: 2px solid transparent;
            padding-left: 1rem;
            transition: color 0.1s;
        }
        .nav-item:hover {
            color: var(--accent);
            text-decoration: underline;
            text-decoration-color: var(--border-hairline);
        }
        .nav-item.active {
            color: var(--text-primary);
            font-weight: 600;
            border-left-color: var(--accent); /* Stage 6.0.11 - Accent allowed for Nav marker */
        }
        .nav-section-label {
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            padding-left: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            opacity: 0.8;
        }

        /* Mobile Drawer */
        .drawer-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.2);
            z-index: 40;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }
        .drawer-overlay.open {
            opacity: 1;
            pointer-events: auto;
        }
        .drawer-content {
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            width: 85%;
            max-width: 320px;
            background: var(--bg-frame);
            z-index: 50;
            transform: translateX(-100%);
            transition: transform 0.2s cubic-bezier(0.16, 1, 0.3, 1);
            overflow-y: auto;
            box-shadow: 2px 0 12px rgba(0,0,0,0.05);
        }
        .drawer-content.open {
            transform: translateX(0);
        }

        /* Solution Details Wash */
        .solution-details-region {
            background-color: var(--bg-wash);
            padding: 1rem;
            margin-top: 0.75rem;
            border-radius: 2px;
        }
        @media (min-width: 768px) {
            .solution-details-region {
                padding: 1.5rem;
            }
        }
        
        /* Prose in details */
        .prose p {
            margin-bottom: 0.75em;
        }
        .prose p:last-child {
            margin-bottom: 0;
        }
    </style>
</head>
<body>

    <script>
        // --- STAGE 0: CONSTANTS ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";
    </script>

    <div id="app" class="doc-shell">
        <!-- App Content Injected Here -->
    </div>

    <!-- MAIN SCRIPT -->
    <script>
        // --- STATE ---
        const state = {
            papers: [],
            activePaperId: null,
            expandedNodes: new Set(), // Set of node IDs where solution details are expanded
            mobileNavOpen: false,
            activeNavId: null, // For scroll spy
            loading: true,
            error: false
        };

        // --- MARKDOWN CONFIG (Stage 6.0.7) ---
        // md instance configured strictly per instructions
        let md = null;
        if (window.markdownit) {
            md = window.markdownit({
                html: true,     // Allow inline SVG
                linkify: true,
                breaks: false,  // CRITICAL: false to prevent <br> in math blocks
            });
            // Disable escape rule to preserve TeX backslashes
            md.inline.ruler.disable(['escape']);
        }

        // --- INIT ---
        async function init() {
            try {
                // Determine loading source from canonical constant (via script tag above)
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Payload not found");
                const data = await response.json();
                
                state.papers = data.papers || [];
                if (state.papers.length > 0) {
                    // Load first paper by default
                    loadPaper(state.papers[0].key);
                } else {
                    state.error = true;
                }
            } catch (e) {
                console.error(e);
                state.error = true;
            } finally {
                state.loading = false;
                render();
            }
        }

        function loadPaper(paperId) {
            const paper = state.papers.find(p => p.key === paperId);
            if (!paper) return;
            state.activePaperId = paperId;
            state.expandedNodes.clear();
            state.mobileNavOpen = false;
            
            // Apply defaults
            const expandAll = paper.defaults?.expandedAll !== false; // Default to true if undefined
            if (expandAll) {
                // We need to traverse to find all IDs with solution details to expand them
                const traverse = (nodes) => {
                    nodes.forEach(node => {
                        if (node.solutionBlock?.solutionDetails) {
                            state.expandedNodes.add(node.id);
                        }
                        if (node.children) traverse(node.children);
                    });
                };
                if (paper.questions) traverse(paper.questions);
                if (paper.sections) paper.sections.forEach(s => traverse(s.questions));
            }
            render();
            
            // Reset Scroll
            window.scrollTo(0,0);
        }

        // --- ACTIONS ---
        function toggleMobileNav() {
            state.mobileNavOpen = !state.mobileNavOpen;
            render();
        }

        function toggleSolution(nodeId) {
            if (state.expandedNodes.has(nodeId)) {
                state.expandedNodes.delete(nodeId);
            } else {
                state.expandedNodes.add(nodeId);
            }
            render(); // Re-render to update state
            renderMath(); // Re-run KaTeX on new DOM
        }

        function switchPaper(key) {
            loadPaper(key);
        }

        function jumpTo(id) {
            const el = document.getElementById(`q-${id}`);
            if (el) {
                // Close mobile nav if open
                state.mobileNavOpen = false;
                render(); 
                // Smooth scroll
                el.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // --- RENDERING ---
        function render() {
            const app = document.getElementById('app');
            if (state.loading) {
                app.innerHTML = `<div class="p-8 text-txt-secondary">Loading papers...</div>`;
                return;
            }
            if (state.error || state.papers.length === 0) {
                app.innerHTML = `<div class="p-8 text-txt-primary font-bold">PAPERS PAYLOAD MISSING</div>`;
                return;
            }

            const activePaper = state.papers.find(p => p.key === state.activePaperId);
            
            // 1. Generate Navigation HTML
            const navHtml = renderNav(activePaper);

            // 2. Generate Paper Content HTML
            const paperHtml = renderPaperContent(activePaper);

            // 3. Assemble Shell
            app.innerHTML = `
                <!-- LEFT NAV RAIL (Desktop) -->
                <nav class="nav-rail text-sm">
                    <div class="mb-6 px-4">
                        ${renderPaperSelector()}
                    </div>
                    <div class="px-4">
                        ${navHtml}
                    </div>
                </nav>

                <!-- RIGHT CONTENT COLUMN -->
                <main class="paper-column relative">
                    <!-- MOBILE HEADER -->
                    <div class="lg:hidden flex items-center justify-between px-4 py-3 mb-4 border-b border-hairline bg-frame sticky top-0 z-20">
                         ${renderPaperSelector()}
                         <button onclick="toggleMobileNav()" class="text-sm font-medium text-accent flex items-center gap-1">
                            <span>Jump to</span>
                            <i data-lucide="menu" class="w-4 h-4"></i>
                         </button>
                    </div>

                    <!-- PAPER SURFACE -->
                    <div class="paper-surface mx-auto max-w-3xl shadow-sm">
                         <div class="mb-12 border-b border-hairline pb-4">
                            <h1 class="text-2xl font-semibold text-txt-primary">${activePaper.label}</h1>
                         </div>
                         ${paperHtml}
                    </div>
                </main>

                <!-- MOBILE DRAWER -->
                <div class="drawer-overlay ${state.mobileNavOpen ? 'open' : ''}" onclick="toggleMobileNav()"></div>
                <div class="drawer-content ${state.mobileNavOpen ? 'open' : ''}">
                    <div class="flex items-center justify-between p-4 border-b border-hairline bg-frame">
                        <span class="font-semibold text-txt-primary">Jump to</span>
                        <button onclick="toggleMobileNav()" class="text-txt-secondary hover:text-txt-primary">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <div class="p-4">
                        ${navHtml}
                    </div>
                </div>
            `;

            // Post-render: Icons & Math
            lucide.createIcons();
            renderMath();
            setupScrollSpy();
        }

        function renderPaperSelector() {
            return `
                <div class="relative inline-block w-full max-w-[200px]">
                    <select 
                        onchange="switchPaper(this.value)"
                        class="appearance-none w-full bg-page border border-hairline text-txt-primary py-2 pl-3 pr-8 rounded text-sm focus:border-accent focus:ring-1 focus:ring-accent outline-none cursor-pointer"
                    >
                        ${state.papers.map(p => `
                            <option value="${p.key}" ${p.key === state.activePaperId ? 'selected' : ''}>
                                ${p.label}
                            </option>
                        `).join('')}
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-txt-secondary">
                        <i data-lucide="chevron-down" class="w-4 h-4"></i>
                    </div>
                </div>
            `;
        }

        function renderNav(paper) {
            if (!paper) return '';
            
            let html = '';
            
            // Helper to render a list of questions
            const renderQList = (questions) => {
                return questions.map(q => {
                    // Flatten hierarchy visual logic: Identifiers only.
                    // Sub-questions handled by rendering them recursively but flatly in the nav list?
                    // Stage 5.4.5: "Flat list... sub-questions quieter/smaller... same left edge"
                    // We need to flatten the tree for navigation or just render recursively with distinct style.
                    // Let's recurse but maintain flat DOM structure if possible, or simple nested divs.
                    
                    const recurse = (node, depth) => {
                        let itemHtml = '';
                        // Render self
                        const isActive = state.activeNavId === node.id;
                        const fontSizeClass = depth === 0 ? 'text-sm' : 'text-xs opacity-90'; // Hierarchy via scale
                        
                        itemHtml += `
                            <a href="#" onclick="jumpTo('${node.id}'); return false;" 
                               class="nav-item ${isActive ? 'active' : ''} ${fontSizeClass}"
                            >
                                ${node.id}
                            </a>
                        `;
                        // Render children
                        if (node.children && node.children.length > 0) {
                            node.children.forEach(child => {
                                itemHtml += recurse(child, depth + 1);
                            });
                        }
                        return itemHtml;
                    };
                    return recurse(q, 0);
                }).join('');
            };

            if (paper.sections) {
                paper.sections.forEach(section => {
                    if (section.label && section.label.trim().length > 0) {
                        html += `<div class="nav-section-label">${section.label}</div>`;
                    }
                    html += renderQList(section.questions);
                    // Add spacing between sections (Stage 5.4.6)
                    html += `<div class="h-4"></div>`; 
                });
            } else if (paper.questions) {
                html += renderQList(paper.questions);
            }
            
            return html;
        }

        function renderPaperContent(paper) {
            if (!paper) return '';
            let html = '';

            const renderNode = (node, depth) => {
                // Spacing logic (Stage 5.1 / 5.8)
                // Top-level questions: SPC__TOP_LEVEL_INTER_QUESTION_SPACING
                const topLevelClass = depth === 0 ? 'mb-16 border-b border-hairline pb-12 last:border-0' : 'mt-6';
                
                // Question Body
                const qBodyHtml = `
                    <div class="flex items-baseline gap-2 mb-4">
                        <span class="q-id shrink-0 select-none">${node.id}</span>
                        <div class="q-prompt prose text-txt-primary leading-relaxed max-w-none">
                            ${renderMarkdown(node.question)}
                        </div>
                    </div>
                `;

                // Solution Block
                let solutionBlockHtml = '';
                if (node.solutionBlock) {
                    const sb = node.solutionBlock;
                    const hasAnswer = sb.answer && sb.answer.trim().length > 0;
                    const hasDetails = !!sb.solutionDetails;
                    
                    // Answer
                    let answerHtml = '';
                    if (hasAnswer) {
                        answerHtml = `
                            <div class="mb-3">
                                <span class="text-xs font-bold text-txt-secondary uppercase tracking-wide mr-2">Answer</span>
                                <div class="inline-block prose text-txt-primary font-medium">
                                    ${renderMarkdown(sb.answer)}
                                </div>
                            </div>
                        `;
                    }

                    // Solution Details
                    let detailsHtml = '';
                    if (hasDetails) {
                        const isExpanded = state.expandedNodes.has(node.id);
                        const toggleText = isExpanded ? 'Hide working' : 'Show working';
                        const toggleIcon = isExpanded ? 'chevron-up' : 'chevron-down';
                        
                        // Details Content (only render if expanded to keep DOM light, or render hidden? 
                        // Prompt says "revealed/hidden", usually implies DOM presence. 
                        // But for "Hide working", we need it in DOM. 
                        // Let's render but use display toggling or re-render. 
                        // Re-rendering (this function) is safer for KaTeX init.)
                        
                        let expandedContent = '';
                        if (isExpanded) {
                            const sd = sb.solutionDetails;
                            
                            // 1. Keep in mind
                            if (sd.keepInMind) {
                                expandedContent += `
                                    <div class="mb-4">
                                        <div class="flex items-center gap-2 mb-1 text-accent">
                                            <i data-lucide="lightbulb" class="w-4 h-4"></i>
                                            <span class="text-xs font-bold uppercase tracking-wide">Keep in mind</span>
                                        </div>
                                        <div class="prose text-sm text-txt-secondary">
                                            ${renderMarkdown(sd.keepInMind)}
                                        </div>
                                    </div>
                                `;
                            }
                            
                            // 2. Formulas Used
                            if (sd.formulasUsed) {
                                expandedContent += `
                                    <div class="mb-4">
                                        <span class="text-xs font-bold text-txt-secondary uppercase tracking-wide block mb-1">Formulas used</span>
                                        <div class="prose text-sm text-txt-secondary">
                                            ${renderMarkdown(sd.formulasUsed)}
                                        </div>
                                    </div>
                                `;
                            }

                            // 3. Working
                            if (sd.working) {
                                expandedContent += `
                                    <div class="mb-4">
                                        <span class="text-xs font-bold text-txt-secondary uppercase tracking-wide block mb-1">Working</span>
                                        <div class="prose text-txt-primary">
                                            ${renderMarkdown(sd.working)}
                                        </div>
                                    </div>
                                `;
                            }

                            // 4. Alternative Working
                            if (sd.alternativeWorking && Array.isArray(sd.alternativeWorking)) {
                                sd.alternativeWorking.forEach((alt, idx) => {
                                    expandedContent += `
                                        <div class="mt-6 pt-4 border-t border-hairline border-dashed">
                                            <span class="text-xs font-bold text-txt-secondary uppercase tracking-wide block mb-1">Alternative working</span>
                                            <div class="prose text-txt-primary">
                                                ${renderMarkdown(alt)}
                                            </div>
                                        </div>
                                    `;
                                });
                            }
                            
                            expandedContent = `
                                <div class="solution-details-region reveal-content">
                                    ${expandedContent}
                                </div>
                            `;
                        }

                        detailsHtml = `
                            <div class="mt-2">
                                <button onclick="toggleSolution('${node.id}')" class="btn-reset text-sm text-accent font-medium flex items-center gap-1 hover:underline decoration-hairline">
                                    <span>${toggleText}</span>
                                    <i data-lucide="${toggleIcon}" class="w-4 h-4"></i>
                                </button>
                                ${expandedContent}
                            </div>
                        `;
                    }
                    
                    if (hasAnswer || hasDetails) {
                        solutionBlockHtml = `
                            <div class="ml-0 md:ml-8 mt-3"> <!-- Indent supporting material slightly on desktop? No, stage 3 says vertical stack primarily. Using margin-top. -->
                                ${answerHtml}
                                ${detailsHtml}
                            </div>
                        `;
                    }
                }

                // Children recursion
                let childrenHtml = '';
                if (node.children && node.children.length > 0) {
                    childrenHtml = `
                        <div class="ml-4 md:ml-8 mt-4 pl-4 border-l border-hairline">
                            ${node.children.map(child => renderNode(child, depth + 1)).join('')}
                        </div>
                    `;
                }

                return `
                    <div id="q-${node.id}" class="${topLevelClass} scroll-mt-20">
                        ${qBodyHtml}
                        ${solutionBlockHtml}
                        ${childrenHtml}
                    </div>
                `;
            };

            if (paper.sections) {
                paper.sections.forEach(section => {
                    if (section.label) {
                        html += `
                            <div class="mb-8 mt-12 first:mt-0">
                                <span class="inline-block py-1 px-3 text-xs font-bold text-txt-secondary bg-frame rounded border border-hairline mb-6">
                                    SECTION ${section.label}
                                </span>
                                ${section.questions.map(q => renderNode(q, 0)).join('')}
                            </div>
                        `;
                    } else {
                         html += section.questions.map(q => renderNode(q, 0)).join('');
                    }
                });
            } else if (paper.questions) {
                html += paper.questions.map(q => renderNode(q, 0)).join('');
            }

            return html;
        }

        // --- UTILS ---
        function renderMarkdown(text) {
            if (!text || !md) return text || '';
            // markdown-it renders to HTML. KaTeX will auto-render later.
            return md.render(text);
        }

        function renderMath() {
            // Stage 6.0.8: KaTeX containment
            // We use the auto-render extension
            renderMathInElement(document.body, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false},
                    {left: '\\(', right: '\\)', display: false},
                    {left: '\\[', right: '\\]', display: true}
                ],
                throwOnError: false,
                output: 'html' // Use HTML output
            });
        }

        function setupScrollSpy() {
            // Simple Intersection Observer to highlight nav items
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        // find id
                        const id = entry.target.id.replace('q-', '');
                        // We only want to highlight top-level or close children. 
                        // For simplicity, just set active.
                        state.activeNavId = id;
                        
                        // Update UI classes manually to avoid full re-render
                        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                        // Find link
                        const link = Array.from(document.querySelectorAll('.nav-item')).find(el => el.innerText.trim() === id);
                        if (link) link.classList.add('active');
                    }
                });
            }, {
                rootMargin: '-10% 0px -80% 0px' // Active when near top
            });

            document.querySelectorAll('[id^="q-"]').forEach(el => observer.observe(el));
        }

        // Start
        init();

    </script>
</body>
</html>
