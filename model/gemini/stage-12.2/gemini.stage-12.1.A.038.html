<!DOCTYPE html>
<html lang="en-GB">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"A","indexWithinVariant":"38","totalWithinVariant":"50","hueFamily":"","intensityMode":"","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-08T12:52:26.351Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;A&quot;,&quot;indexWithinVariant&quot;:&quot;38&quot;,&quot;totalWithinVariant&quot;:&quot;50&quot;,&quot;hueFamily&quot;:&quot;&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-08T12:52:26.351Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>
    
    <!-- Fonts: Inter for modern, friendly sans-serif -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- KaTeX CSS (No integrity, per Stage 6 instructions) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <style>
        /* 
         * STAGE 6 ADD-ON: COLORLAB A (LIGHT-ONLY)
         * Palette Freedom enabled. 
         * Theme: Modern Slate & Indigo (Calm, Professional, Friendly).
         * Light Mode Only enforced.
         */
        :root {
            /* Palette: Slate (Neutrals) */
            --c-bg-page: #f8fafc;        /* Slate 50 */
            --c-bg-paper: #ffffff;       /* White */
            --c-bg-surface-subtle: #f1f5f9; /* Slate 100 - for differentiation if needed */
            
            /* Typography Colors */
            --c-text-primary: #0f172a;   /* Slate 900 - Question Body */
            --c-text-secondary: #334155; /* Slate 700 - Answer */
            --c-text-tertiary: #475569;  /* Slate 600 - Explanatory / Nav */
            --c-text-quiet: #64748b;     /* Slate 500 - Metadata / Nav inactive */

            /* Accent (Interactive/Focus - No semantic meaning for correctness) */
            --c-accent: #4f46e5;         /* Indigo 600 */
            --c-accent-hover: #4338ca;   /* Indigo 700 */
            --c-focus-ring: rgba(79, 70, 229, 0.4);

            /* Structural Lines */
            --c-divider: #e2e8f0;        /* Slate 200 */
            --c-divider-subtle: #f1f5f9; /* Slate 100 */

            /* Spacing Scale (Stage 5 Rhythm) */
            --sp-xs: 0.25rem;
            --sp-sm: 0.5rem;
            --sp-md: 1rem;
            --sp-lg: 1.5rem;
            --sp-xl: 2.5rem; /* Top-level question separation */
            --sp-xxl: 4rem;

            /* Layout */
            --w-max-width: 1024px; /* Document shell max width */
            --w-nav-rail: 240px;
        }

        /* Resets & Base */
        *, *::before, *::after { box-sizing: border-box; }
        html, body { margin: 0; padding: 0; height: 100%; }
        
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--c-bg-page);
            color: var(--c-text-primary);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            overflow-y: scroll; /* Page scroll */
        }

        /* Focus Styling (Stage 5.5.2) */
        :focus-visible {
            outline: 2px solid var(--c-accent);
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* === TOP CONTROLS REGION === */
        .top-controls {
            position: sticky;
            top: 0;
            z-index: 50;
            background-color: var(--c-bg-page); /* Matches page bg per Stage 3 */
            border-bottom: 1px solid var(--c-divider);
            padding: var(--sp-sm) var(--sp-md);
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 60px;
        }

        .top-controls-inner {
            max-width: var(--w-max-width);
            width: 100%;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .paper-selector {
            font-family: inherit;
            font-size: 0.9375rem;
            padding: var(--sp-xs) var(--sp-sm);
            border: 1px solid var(--c-divider);
            border-radius: 4px;
            background-color: var(--c-bg-paper);
            color: var(--c-text-primary);
            min-width: 200px;
        }

        /* Mobile Jump To Trigger */
        .jump-to-trigger {
            display: none; /* Desktop default */
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--c-accent);
            background: none;
            border: none;
            cursor: pointer;
            padding: var(--sp-xs) var(--sp-sm);
        }

        /* === DOCUMENT FRAME SHELL === */
        .document-frame-shell {
            max-width: var(--w-max-width);
            margin: 0 auto;
            min-height: calc(100vh - 60px);
            display: grid;
            grid-template-columns: var(--w-nav-rail) 1fr;
            /* Shared surface context - nav sits on same bg as page */
        }

        /* === NAVIGATION RAIL (Desktop) === */
        .nav-rail {
            position: sticky;
            top: 60px; /* Below top controls */
            height: calc(100vh - 60px);
            overflow-y: auto; /* Scroll independent if needed */
            padding: var(--sp-lg) var(--sp-md) var(--sp-lg) 0;
            scrollbar-width: none; /* Hide scrollbar Firefox */
        }
        .nav-rail::-webkit-scrollbar { display: none; } /* Hide scrollbar Webkit */

        .nav-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: var(--sp-xs);
        }

        /* Flat list hierarchy via type scale (Stage 5.4.5) */
        .nav-item {
            display: block;
            text-decoration: none;
            color: var(--c-text-tertiary);
            font-size: 0.875rem; /* Base size */
            padding: 2px 0;
            border-left: 2px solid transparent;
            padding-left: var(--sp-sm);
            transition: color 0.2s ease, font-weight 0.2s ease;
            cursor: pointer;
        }

        /* Sub-questions quieter */
        .nav-item[data-depth="1"], .nav-item[data-depth="2"] {
            font-size: 0.8125rem;
            color: var(--c-text-quiet);
        }

        .nav-item:hover {
            color: var(--c-accent);
        }

        .nav-item.active {
            color: var(--c-accent); /* Permitted override Stage 5.4.3 */
            font-weight: 600; /* Weight indication */
            border-left-color: var(--c-accent); /* Marker */
        }

        .nav-section-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--c-text-quiet);
            font-weight: 600;
            margin-top: var(--sp-md);
            margin-bottom: var(--sp-xs);
            padding-left: var(--sp-sm);
            pointer-events: none;
        }

        /* === PAPER REGION === */
        .paper-column {
            padding: var(--sp-lg) 0 var(--sp-xxl) var(--sp-lg);
            /* Sibling to nav, primary content */
        }

        /* Section Headers in Paper */
        .paper-section-header {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--c-text-primary);
            margin-bottom: var(--sp-lg);
            margin-top: var(--sp-xl);
            padding-bottom: var(--sp-sm);
            border-bottom: 1px solid var(--c-divider);
        }
        .paper-section-header:first-child { margin-top: 0; }

        /* === QUESTION NODE STRUCTURE === */
        .question-node {
            margin-bottom: var(--sp-xl); /* Top-level separation */
            position: relative;
        }

        /* Nested Spacing Logic */
        .children-container {
            margin-top: var(--sp-md);
            padding-left: 0; /* No visual indentation via padding, use spacing/scale */
        }
        /* Sub-questions use indendation via padding for readability, distinct from Nav flat list */
        .children-container .question-node {
            margin-bottom: var(--sp-lg);
            padding-left: var(--sp-md); 
            /* Subtle border to guide eye for deep nesting if needed, purely spacing favored */
        }

        /* Content Typography */
        .question-body {
            /* Anchor */
            font-size: 1rem;
            color: var(--c-text-primary);
            margin-bottom: var(--sp-sm);
        }

        .question-id {
            font-weight: 700;
            margin-right: var(--sp-xs);
            color: var(--c-text-primary);
        }

        .question-prompt {
            display: inline;
        }
        
        .question-prompt p { margin: 0 0 var(--sp-sm) 0; display: inline; }
        .question-prompt p:last-child { margin-bottom: 0; }

        /* === SOLUTION BLOCK === */
        .solution-block {
            margin-top: var(--sp-sm);
            /* Grouped tightly with question */
        }

        /* Answer */
        .answer-region {
            margin-bottom: var(--sp-sm);
            font-size: 1rem;
            color: var(--c-text-secondary);
        }
        .answer-label {
            font-weight: 600;
            font-size: 0.875rem;
            margin-right: var(--sp-xs);
            color: var(--c-text-tertiary);
        }

        /* Disclosure Control */
        .disclosure-control {
            display: inline-flex;
            align-items: center;
            gap: var(--sp-xs);
            font-size: 0.875rem;
            color: var(--c-accent);
            background: none;
            border: none;
            padding: 0;
            cursor: pointer;
            font-weight: 500;
            margin-bottom: var(--sp-sm);
        }
        .disclosure-control:hover {
            color: var(--c-accent-hover);
            text-decoration: underline;
        }
        .disclosure-icon {
            transition: transform 0.2s ease;
            width: 16px;
            height: 16px;
        }
        .disclosure-control[aria-expanded="true"] .disclosure-icon {
            transform: rotate(180deg);
        }

        /* Solution Details Region */
        .solution-details {
            display: none; /* Hidden by default state */
            margin-top: var(--sp-xs);
            padding-left: 0;
            color: var(--c-text-tertiary);
            font-size: 0.9375rem;
        }
        .solution-details[data-visible="true"] {
            display: block;
            /* Animation for expand handled via simple display toggle for calm feel */
        }

        /* Subsections within Solution Details */
        .sd-subsection {
            margin-bottom: var(--sp-md);
        }
        .sd-subsection:last-child { margin-bottom: 0; }

        .sd-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 700;
            color: var(--c-text-quiet);
            margin-bottom: var(--sp-xs);
            display: block;
        }

        /* Keep in Mind */
        .keep-in-mind-body ul {
            margin: 0;
            padding-left: var(--sp-lg);
            list-style-type: disc;
        }
        
        /* Working / Alternative Working */
        .working-body {
            /* Rhythm for mixed math/prose */
        }

        /* Separator: Alternative Working */
        .sep-alternative {
            height: 1px;
            background-color: var(--c-divider);
            margin: var(--sp-lg) 0;
        }

        /* === MARKDOWN & KATEX CONTENT === */
        /* Basic Markdown resets */
        .md-content p { margin-top: 0; margin-bottom: var(--sp-sm); }
        .md-content p:last-child { margin-bottom: 0; }
        
        /* Tables */
        .md-content table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: var(--sp-md);
            font-size: 0.875rem;
        }
        .md-content th, .md-content td {
            border: 1px solid var(--c-divider);
            padding: var(--sp-sm);
            text-align: left;
        }
        .md-content th {
            font-weight: 600;
            background-color: var(--c-bg-surface-subtle);
        }

        /* KaTeX Containment Invariant (Locked) */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding: 0.5em 0;
            -webkit-overflow-scrolling: touch;
            /* Scrollbar hiding logic */
            scrollbar-width: none;
        }
        .katex-display::-webkit-scrollbar { display: none; }
        
        /* Block Math Background (Permitted for display math only) */
        .katex-display > .katex {
            /* No background on the katex root itself to avoid clipping issues, 
               but containment wrapper handles scroll. 
               Stage 5.8.2 says "no framing", "standard spacing". 
               Stage 6.0.8 says "Horizontal scrolling permitted only inside block-level math". */
        }

        /* Inline SVG */
        .md-content svg {
            max-width: 100%;
            height: auto;
            display: block;
            margin: var(--sp-sm) 0;
        }

        /* === MOBILE DRAWER === */
        .drawer-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4);
            z-index: 100;
            display: none;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .drawer-overlay.open { display: block; opacity: 1; }

        .drawer {
            position: fixed;
            top: 0; left: 0; bottom: 0;
            width: 280px;
            background: var(--c-bg-page);
            z-index: 101;
            transform: translateX(-100%);
            transition: transform 0.2s ease;
            box-shadow: 2px 0 8px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }
        .drawer.open { transform: translateX(0); }

        .drawer-header {
            padding: var(--sp-md);
            border-bottom: 1px solid var(--c-divider);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .drawer-title { font-weight: 600; font-size: 1rem; }
        .drawer-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--c-text-tertiary);
            cursor: pointer;
            line-height: 1;
        }

        .drawer-content {
            flex: 1;
            overflow-y: auto;
            padding: var(--sp-md);
        }

        /* === RESPONSIVE === */
        @media (max-width: 768px) {
            .document-frame-shell {
                display: block; /* Stacked */
                padding: 0 var(--sp-md);
            }
            .nav-rail { display: none; } /* Hide rail on mobile */
            .jump-to-trigger { display: block; } /* Show Jump To */
            .paper-column {
                padding: var(--sp-md) 0 var(--sp-xxl) 0;
            }
            .paper-selector {
                flex: 1;
                margin-right: var(--sp-md);
            }
        }
    </style>
</head>
<body>

    <!-- STAGE 0: CONSTANTS (Runtime Definition) -->
    <script>
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";
    </script>

    <!-- Top Controls -->
    <header class="top-controls">
        <div class="top-controls-inner">
            <select id="paper-selector" class="paper-selector" aria-label="Select Paper">
                <option value="" disabled selected>Loading papers...</option>
            </select>
            <button id="jump-to-trigger" class="jump-to-trigger">Jump to</button>
        </div>
    </header>

    <!-- Main Shell -->
    <div class="document-frame-shell">
        <!-- Desktop Nav Rail -->
        <nav class="nav-rail" aria-label="Paper Navigation">
            <div id="nav-list-container" class="nav-list">
                <!-- Nav Items Injected Here -->
            </div>
        </nav>

        <!-- Paper Content -->
        <main class="paper-column" id="paper-content">
            <!-- Paper Content Injected Here -->
            <div style="color: var(--c-text-tertiary); padding: var(--sp-lg);">
                Select a paper to begin.
            </div>
        </main>
    </div>

    <!-- Mobile Navigation Drawer -->
    <div id="drawer-overlay" class="drawer-overlay"></div>
    <div id="drawer" class="drawer" aria-hidden="true">
        <div class="drawer-header">
            <span class="drawer-title">Jump to</span>
            <button id="drawer-close" class="drawer-close" aria-label="Close navigation">&times;</button>
        </div>
        <div class="drawer-content">
            <div id="drawer-nav-list" class="nav-list">
                <!-- Mobile Nav Items Injected Here -->
            </div>
        </div>
    </div>

    <!-- Scripts: Markdown-it, KaTeX, App Logic -->
    
    <!-- Load Markdown-it -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>
    
    <!-- Load KaTeX JS (No integrity) -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <script>
        // --- Markdown renderer (authoritative config) ---
        const md = window.markdownit
          ? window.markdownit({
              html: true, // allow inline SVG and other inline HTML in payload Markdown
              linkify: true,
              breaks: false, // MUST stay false: prevents <br> inside $...$ / $$...$$
            })
          : null;

        if (md) {
          // Preserve TeX backslashes: do not let markdown-it escape them before KaTeX runs
          md.inline.ruler.disable(["escape"]);
        }

        // --- Application State ---
        let papersData = [];
        let currentPaper = null;
        let navItemsMap = new Map(); // id -> element

        // --- Init ---
        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Fetch failed");
                const payload = await response.json();
                
                if (!payload || !payload.papers) throw new Error("Invalid payload");
                
                papersData = payload.papers;
                populateSelector();
                
                // Load first paper by default if available
                if (papersData.length > 0) {
                    loadPaper(papersData[0].key);
                }
            } catch (e) {
                console.error(e);
                renderError("PAPERS PAYLOAD MISSING");
            }
        }

        function renderError(msg) {
            document.getElementById('paper-content').innerHTML = 
                `<div style="padding: 2rem; font-weight: bold; color: var(--c-text-primary);">${msg}</div>`;
            document.getElementById('paper-selector').innerHTML = `<option>Error</option>`;
            document.getElementById('paper-selector').disabled = true;
        }

        function populateSelector() {
            const selector = document.getElementById('paper-selector');
            selector.innerHTML = '';
            papersData.forEach(paper => {
                const opt = document.createElement('option');
                opt.value = paper.key;
                opt.textContent = paper.label;
                selector.appendChild(opt);
            });
            selector.addEventListener('change', (e) => {
                loadPaper(e.target.value);
            });
        }

        function loadPaper(paperKey) {
            currentPaper = papersData.find(p => p.key === paperKey);
            if (!currentPaper) return;

            // Render Nav
            renderNavigation(currentPaper);

            // Render Content
            const container = document.getElementById('paper-content');
            container.innerHTML = ''; // clear

            // Determine if flat or sectioned
            if (currentPaper.sections) {
                currentPaper.sections.forEach(section => {
                    // Render Section Header if label exists
                    if (section.label && section.label.trim() !== "") {
                        const secHeader = document.createElement('div');
                        secHeader.className = 'paper-section-header';
                        secHeader.textContent = section.label;
                        container.appendChild(secHeader);
                    }
                    // Render Questions
                    renderQuestionList(section.questions, container, 0);
                });
            } else if (currentPaper.questions) {
                renderQuestionList(currentPaper.questions, container, 0);
            }

            // Post-render: KaTeX
            renderMath(container);

            // Update Selector
            document.getElementById('paper-selector').value = paperKey;
            
            // Scroll to top
            window.scrollTo(0, 0);
        }

        // --- Navigation Rendering ---
        function renderNavigation(paper) {
            const desktopNav = document.getElementById('nav-list-container');
            const mobileNav = document.getElementById('drawer-nav-list');
            desktopNav.innerHTML = '';
            mobileNav.innerHTML = '';
            navItemsMap.clear();

            const createNavItem = (id, depth, targetId) => {
                const item = document.createElement('a');
                item.className = 'nav-item';
                item.textContent = id;
                item.dataset.depth = depth; // Hierarchy via type scale styling
                item.onclick = (e) => {
                    e.preventDefault();
                    const el = document.getElementById(targetId);
                    if (el) {
                        // Smooth scroll
                        const y = el.getBoundingClientRect().top + window.pageYOffset - 80; // offset for sticky header
                        window.scrollTo({top: y, behavior: 'smooth'});
                        closeDrawer();
                    }
                };
                return item;
            };

            const processQuestions = (questions, container, depth) => {
                questions.forEach(q => {
                    const targetId = `q-${q.id}`; // Generated DOM ID
                    const navItem = createNavItem(q.id, depth, targetId);
                    
                    // Track for ScrollSpy
                    navItemsMap.set(targetId, { desktop: navItem, mobile: null }); // Will update mobile clone
                    container.appendChild(navItem);

                    if (q.children && q.children.length > 0) {
                        processQuestions(q.children, container, depth + 1);
                    }
                });
            };

            if (paper.sections) {
                paper.sections.forEach(section => {
                    // Section Label (Non-clickable)
                    if (section.label && section.label.trim() !== "") {
                        const secLabelD = document.createElement('div');
                        secLabelD.className = 'nav-section-label';
                        secLabelD.textContent = section.label;
                        desktopNav.appendChild(secLabelD);
                        
                        const secLabelM = secLabelD.cloneNode(true);
                        mobileNav.appendChild(secLabelM);
                    }
                    processQuestions(section.questions, desktopNav, 0);
                });
            } else if (paper.questions) {
                processQuestions(paper.questions, desktopNav, 0);
            }

            // Clone desktop items to mobile to ensure references for spy work
            // Simpler: Just re-render logic or copy HTML. 
            // Better: Re-run processQuestions for mobileNav or deep clone.
            // Let's rely on scrollSpy finding elements by ID or class.
            // Actually, let's just copy the innerHTML for structure and re-attach events? 
            // No, better to keep it clean.
            // Re-render for mobile to ensure clean DOM nodes.
            if (paper.sections) {
                paper.sections.forEach(section => {
                    if (section.label && section.label.trim() !== "") {
                        const l = document.createElement('div');
                        l.className = 'nav-section-label';
                        l.textContent = section.label;
                        mobileNav.appendChild(l);
                    }
                    renderNavListRecursive(section.questions, mobileNav, 0);
                });
            } else if (paper.questions) {
                renderNavListRecursive(paper.questions, mobileNav, 0);
            }
        }

        function renderNavListRecursive(questions, container, depth) {
             questions.forEach(q => {
                const targetId = `q-${q.id}`;
                const item = document.createElement('a');
                item.className = 'nav-item';
                item.textContent = q.id;
                item.dataset.depth = depth;
                item.onclick = (e) => {
                    e.preventDefault();
                    const el = document.getElementById(targetId);
                    if (el) {
                        const y = el.getBoundingClientRect().top + window.pageYOffset - 80;
                        window.scrollTo({top: y, behavior: 'smooth'});
                        closeDrawer();
                    }
                };
                // Register mobile node in map
                if (navItemsMap.has(targetId)) {
                    navItemsMap.get(targetId).mobile = item;
                }
                container.appendChild(item);
                if (q.children) renderNavListRecursive(q.children, container, depth + 1);
            });
        }

        // --- Paper Content Rendering ---
        function renderQuestionList(questions, container, depth) {
            questions.forEach(q => {
                const node = document.createElement('div');
                node.className = 'question-node';
                node.id = `q-${q.id}`; // Anchor ID

                // 1. Question Body
                const body = document.createElement('div');
                body.className = 'question-body';
                
                const idSpan = document.createElement('span');
                idSpan.className = 'question-id';
                idSpan.textContent = q.id;
                
                const promptDiv = document.createElement('div');
                promptDiv.className = 'question-prompt md-content';
                promptDiv.innerHTML = md ? md.render(q.question) : q.question;
                
                // Prepend ID to first paragraph if possible, else just stick it in front
                if (promptDiv.firstChild && promptDiv.firstChild.tagName === 'P') {
                    promptDiv.firstChild.prepend(idSpan);
                    promptDiv.firstChild.innerHTML = promptDiv.firstChild.innerHTML.replace(/^/, '&nbsp;'); // spacing
                } else {
                    body.appendChild(idSpan);
                }
                body.appendChild(promptDiv);
                node.appendChild(body);

                // 2. Solution Block (Optional)
                if (q.solutionBlock) {
                    renderSolutionBlock(q.solutionBlock, node);
                }

                // 3. Children
                if (q.children && q.children.length > 0) {
                    const childrenCont = document.createElement('div');
                    childrenCont.className = 'children-container';
                    renderQuestionList(q.children, childrenCont, depth + 1);
                    node.appendChild(childrenCont);
                }

                container.appendChild(node);
            });
        }

        function renderSolutionBlock(sb, container) {
            const block = document.createElement('div');
            block.className = 'solution-block';

            // Answer
            if (sb.answer) {
                const ansDiv = document.createElement('div');
                ansDiv.className = 'answer-region';
                const label = document.createElement('span');
                label.className = 'answer-label';
                label.textContent = "Answer";
                
                const content = document.createElement('span');
                content.className = 'md-content';
                content.innerHTML = md ? md.renderInline(sb.answer) : sb.answer;
                
                ansDiv.appendChild(label);
                ansDiv.appendChild(content);
                block.appendChild(ansDiv);
            }

            // Solution Details
            if (sb.solutionDetails) {
                // Determine default state
                const isExpanded = currentPaper.defaults && currentPaper.defaults.expandedAll === false ? false : true;

                // Toggle Control
                const toggle = document.createElement('button');
                toggle.className = 'disclosure-control';
                toggle.setAttribute('aria-expanded', isExpanded);
                toggle.innerHTML = `
                    <span class="btn-text">${isExpanded ? 'Hide working' : 'Show working'}</span>
                    <svg class="disclosure-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                `;

                // Details Region
                const details = document.createElement('div');
                details.className = 'solution-details';
                details.dataset.visible = isExpanded;

                toggle.onclick = () => {
                    const expanded = details.dataset.visible === 'true';
                    details.dataset.visible = !expanded;
                    toggle.setAttribute('aria-expanded', !expanded);
                    toggle.querySelector('.btn-text').textContent = !expanded ? 'Hide working' : 'Show working';
                };

                // Fill Details
                const sd = sb.solutionDetails;
                
                // Keep in mind
                if (sd.keepInMind) {
                    const sub = document.createElement('div');
                    sub.className = 'sd-subsection';
                    sub.innerHTML = `<span class="sd-label">Keep in mind</span><div class="md-content keep-in-mind-body">${md ? md.render(sd.keepInMind) : sd.keepInMind}</div>`;
                    details.appendChild(sub);
                }

                // Formulas used
                if (sd.formulasUsed) {
                    const sub = document.createElement('div');
                    sub.className = 'sd-subsection';
                    sub.innerHTML = `<span class="sd-label">Formulas used</span><div class="md-content">${md ? md.render(sd.formulasUsed) : sd.formulasUsed}</div>`;
                    details.appendChild(sub);
                }

                // Working
                if (sd.working) {
                    const sub = document.createElement('div');
                    sub.className = 'sd-subsection';
                    sub.innerHTML = `<span class="sd-label">Working</span><div class="md-content working-body">${md ? md.render(sd.working) : sd.working}</div>`;
                    details.appendChild(sub);
                }

                // Alternative Working
                if (sd.alternativeWorking && Array.isArray(sd.alternativeWorking)) {
                    sd.alternativeWorking.forEach(aw => {
                        const sep = document.createElement('div');
                        sep.className = 'sep-alternative';
                        details.appendChild(sep);

                        const sub = document.createElement('div');
                        sub.className = 'sd-subsection';
                        sub.innerHTML = `<span class="sd-label">Alternative working</span><div class="md-content working-body">${md ? md.render(aw) : aw}</div>`;
                        details.appendChild(sub);
                    });
                }

                block.appendChild(toggle);
                block.appendChild(details);
            }

            container.appendChild(block);
        }

        function renderMath(container) {
            if (window.renderMathInElement) {
                renderMathInElement(container, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false}
                    ],
                    throwOnError: false
                });
            }
        }

        // --- Mobile Drawer Logic ---
        const drawer = document.getElementById('drawer');
        const overlay = document.getElementById('drawer-overlay');
        const jumpToBtn = document.getElementById('jump-to-trigger');
        const closeBtn = document.getElementById('drawer-close');

        function openDrawer() {
            drawer.classList.add('open');
            overlay.classList.add('open');
            drawer.setAttribute('aria-hidden', 'false');
            closeBtn.focus();
        }

        function closeDrawer() {
            drawer.classList.remove('open');
            overlay.classList.remove('open');
            drawer.setAttribute('aria-hidden', 'true');
            jumpToBtn.focus();
        }

        jumpToBtn.addEventListener('click', openDrawer);
        closeBtn.addEventListener('click', closeDrawer);
        overlay.addEventListener('click', closeDrawer);

        // --- ScrollSpy for Active Nav ---
        // Simple IntersectionObserver approach
        const observerOptions = {
            root: null,
            rootMargin: '-10% 0px -80% 0px', // Active when near top
            threshold: 0
        };

        const observerCallback = (entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    // Remove active from all
                    navItemsMap.forEach(v => {
                        if(v.desktop) v.desktop.classList.remove('active');
                        if(v.mobile) v.mobile.classList.remove('active');
                    });
                    
                    // Add active to current
                    const ref = navItemsMap.get(entry.target.id);
                    if (ref) {
                        if(ref.desktop) {
                            ref.desktop.classList.add('active');
                            // Ensure visible in rail
                            ref.desktop.scrollIntoView({block: 'nearest', behavior: 'smooth'});
                        }
                        if(ref.mobile) ref.mobile.classList.add('active');
                    }
                }
            });
        };

        const observer = new IntersectionObserver(observerCallback, observerOptions);

        // MutationObserver to observe when content changes to re-attach scrollspy
        const contentObserver = new MutationObserver(() => {
            observer.disconnect();
            document.querySelectorAll('.question-node').forEach(node => observer.observe(node));
        });
        
        contentObserver.observe(document.getElementById('paper-content'), { childList: true, subtree: true });

        // --- Boot ---
        init();

    </script>
</body>
</html>
