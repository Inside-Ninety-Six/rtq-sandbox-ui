<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AD","indexWithinVariant":"317","totalWithinVariant":"440","hueFamily":"","intensityMode":"","primaryHueFamily":"purple","secondaryHueFamily":"amber","dualIntensityMode":"dual_accent_only","timestamp":"2026-01-10T17:57:24.125Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AD&quot;,&quot;indexWithinVariant&quot;:&quot;317&quot;,&quot;totalWithinVariant&quot;:&quot;440&quot;,&quot;hueFamily&quot;:&quot;&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;primaryHueFamily&quot;:&quot;purple&quot;,&quot;secondaryHueFamily&quot;:&quot;amber&quot;,&quot;dualIntensityMode&quot;:&quot;dual_accent_only&quot;,&quot;timestamp&quot;:&quot;2026-01-10T17:57:24.125Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Viewer (Stage 6 Baseline)</title>

    <!-- FONTS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- LIBRARIES (CDN, SRI disabled per Stage 6 instructions) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/13.0.1/markdown-it.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- STAGE 0 CONSTANTS -->
    <script>
        // CANONICAL CONSTANT — PAPERS PAYLOAD PATH (v1.0)
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        
        // CANONICAL CONSTANT — SHADCN TOKEN PROFILES PATH (v1.0)
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // COLORLAB D CONFIG (Defaults: Blue / Amber / Mode 2)
        const RTQ_COLORLAB_DUAL_HUE_PRIMARY = "260"; // Blue
        const RTQ_COLORLAB_DUAL_HUE_SECONDARY = "80"; // Amber
        // Mode 2: dual_tinted_neutrals
    </script>

    <style>
        /* COLORLAB D - MODE 2: dual_tinted_neutrals (Light Mode Only) */
        :root {
            /* Surfaces - Derived from Primary Hue (260) */
            /* C in [0.015 .. 0.035] */
            --col-page-bg: oklch(0.97 0.015 260);
            --col-frame-bg: oklch(0.95 0.02 260);
            --col-paper-bg: oklch(0.99 0.015 260);
            
            /* Wash Surface (Solution Details) - Primary Derived */
            /* C in [0.025 .. 0.045] */
            --col-wash-bg: oklch(0.96 0.03 260);

            /* Text - Near Neutral */
            /* C <= 0.010 */
            --col-text-primary: oklch(0.20 0.01 260);
            /* C <= 0.012 */
            --col-text-secondary: oklch(0.45 0.012 260);
            --col-text-tertiary: oklch(0.60 0.01 260);

            /* Accents */
            /* Primary: C in [0.10 .. 0.16] */
            --col-accent-primary: oklch(0.55 0.14 260); 
            /* Secondary: C in [0.08 .. 0.14] - Used sparingly */
            --col-accent-secondary: oklch(0.70 0.12 80);

            /* Lines/Borders */
            --col-divider: oklch(0.90 0.02 260);
            --col-focus-ring: var(--col-accent-primary);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--col-page-bg);
            color: var(--col-text-primary);
            -webkit-font-smoothing: antialiased;
            overflow-y: scroll; /* Force scrollbar to avoid layout shift */
        }

        /* UTILITIES */
        .text-primary { color: var(--col-text-primary); }
        .text-secondary { color: var(--col-text-secondary); }
        .text-accent { color: var(--col-accent-primary); }
        .bg-paper { background-color: var(--col-paper-bg); }
        .bg-frame { background-color: var(--col-frame-bg); }
        .bg-wash { background-color: var(--col-wash-bg); }
        .border-quiet { border-color: var(--col-divider); }

        /* KaTeX Overrides & Containment */
        .katex-display {
            margin: 1em 0;
            overflow-x: auto;
            overflow-y: hidden;
            width: 100%;
            padding-bottom: 4px; /* Space for scrollbar */
        }
        .katex-display > .katex {
            display: inline-block;
            white-space: nowrap;
            max-width: 100%;
            text-align: left; /* Left align long equations usually better for reading flow */
        }
        /* Inline math: transparent background */
        .katex { background-color: transparent !important; }

        /* Markdown Styles */
        .md-content p { margin-bottom: 0.75em; line-height: 1.6; }
        .md-content p:last-child { margin-bottom: 0; }
        .md-content ul { list-style-type: disc; padding-left: 1.25em; margin-bottom: 0.75em; }
        .md-content ol { list-style-type: decimal; padding-left: 1.25em; margin-bottom: 0.75em; }
        .md-content table { width: 100%; border-collapse: collapse; margin: 1em 0; font-size: 0.95em; }
        .md-content th, .md-content td { border: 1px solid var(--col-divider); padding: 0.5em; text-align: left; }
        .md-content th { font-weight: 600; background-color: rgba(0,0,0,0.02); }

        /* Navigation Scrollbar Hiding */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Focus Styles */
        :focus-visible {
            outline: 2px solid var(--col-focus-ring);
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* Disclosure Transition */
        .details-wrapper {
            display: grid;
            grid-template-rows: 0fr;
            transition: grid-template-rows 0.25s ease-out;
            opacity: 0;
        }
        .details-wrapper.expanded {
            grid-template-rows: 1fr;
            opacity: 1;
        }
        .details-inner {
            overflow: hidden;
        }
        
        /* Drawer Transition */
        .drawer-overlay {
            transition: opacity 0.3s ease;
        }
        .drawer-content {
            transition: transform 0.3s ease;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- APP SHELL -->
    <div id="app" class="flex flex-col flex-1">
        
        <!-- TOP CONTROLS (Aligned to DocumentFrameShell) -->
        <header class="w-full bg-frame border-b border-quiet sticky top-0 z-20">
            <div class="max-w-7xl mx-auto px-4 md:px-8 h-14 flex items-center justify-between">
                <!-- Paper Selector -->
                <div class="flex items-center gap-3">
                    <span class="text-sm font-medium text-secondary hidden sm:inline">Paper:</span>
                    <select id="paper-selector" class="text-sm bg-transparent border border-quiet rounded px-2 py-1 text-primary focus:border-accent outline-none">
                        <option value="" disabled selected>Loading papers...</option>
                    </select>
                </div>

                <!-- Mobile Jump To Trigger -->
                <button id="mobile-jump-trigger" class="md:hidden flex items-center gap-2 text-sm font-medium text-accent px-3 py-1.5 rounded hover:bg-black/5 transition-colors">
                    <i data-lucide="menu" class="w-4 h-4"></i>
                    <span>Jump to</span>
                </button>
            </div>
        </header>

        <!-- DOCUMENT FRAME SHELL -->
        <div class="flex-1 w-full max-w-7xl mx-auto flex flex-col md:flex-row bg-frame min-h-[calc(100vh-3.5rem)]">
            
            <!-- DESKTOP NAV RAIL -->
            <nav class="hidden md:block w-64 flex-shrink-0 border-r border-quiet sticky top-14 h-[calc(100vh-3.5rem)] overflow-y-auto no-scrollbar py-6 pl-4 pr-4">
                <div id="desktop-nav-list" class="flex flex-col gap-1">
                    <!-- Injected by JS -->
                </div>
            </nav>

            <!-- PAPER CONTENT COLUMN -->
            <main class="flex-1 bg-paper px-4 sm:px-8 py-8 md:py-12 min-w-0">
                <div id="paper-content" class="max-w-3xl mx-auto flex flex-col gap-12">
                    <!-- Content injected by JS -->
                    <div class="animate-pulse flex flex-col gap-4">
                        <div class="h-4 bg-gray-200 rounded w-3/4"></div>
                        <div class="h-4 bg-gray-200 rounded w-1/2"></div>
                    </div>
                </div>
            </main>

        </div>
    </div>

    <!-- MOBILE DRAWER -->
    <div id="mobile-drawer" class="fixed inset-0 z-50 pointer-events-none opacity-0 transition-opacity duration-300" aria-hidden="true">
        <!-- Backdrop -->
        <div id="drawer-backdrop" class="absolute inset-0 bg-black/20 backdrop-blur-sm"></div>
        <!-- Content -->
        <div id="drawer-panel" class="absolute right-0 top-0 bottom-0 w-72 bg-paper shadow-xl transform translate-x-full transition-transform duration-300 flex flex-col">
            <div class="h-14 flex items-center justify-between px-4 border-b border-quiet flex-shrink-0">
                <span class="font-medium text-primary">Jump to</span>
                <button id="drawer-close" class="p-2 text-secondary hover:text-primary">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div id="mobile-nav-list" class="flex-1 overflow-y-auto p-4 flex flex-col gap-1">
                <!-- Injected by JS -->
            </div>
        </div>
    </div>

    <!-- MAIN SCRIPT -->
    <script>
        // --- 1. SETUP & UTILS ---
        
        // Markdown Renderer Configuration (Authoritative Stage 6 Config)
        const md = window.markdownit ? window.markdownit({
            html: true,       // Enable inline SVG passthrough
            linkify: true,
            breaks: false     // MUST be false to prevent <br> in math
        }) : null;

        if (md) {
            // Disable escape to preserve TeX backslashes
            md.inline.ruler.disable(['escape']);
        }

        const state = {
            papers: [],
            currentPaperKey: null,
            loading: true,
            error: null,
            expandedWorkings: {} // Map<questionId, boolean>
        };

        const els = {
            selector: document.getElementById('paper-selector'),
            content: document.getElementById('paper-content'),
            desktopNav: document.getElementById('desktop-nav-list'),
            mobileNav: document.getElementById('mobile-nav-list'),
            drawer: document.getElementById('mobile-drawer'),
            drawerPanel: document.getElementById('drawer-panel'),
            drawerTrigger: document.getElementById('mobile-jump-trigger'),
            drawerClose: document.getElementById('drawer-close'),
            drawerBackdrop: document.getElementById('drawer-backdrop')
        };

        // --- 2. DATA LOADING ---

        async function init() {
            try {
                // Deterministic Load via Constant
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error('Network error');
                
                const data = await response.json();
                state.papers = data.papers || [];
                
                if (state.papers.length === 0) throw new Error('No papers found');

                renderSelector();
                
                // Select first paper by default
                if (state.papers.length > 0) {
                    loadPaper(state.papers[0].key);
                }
            } catch (err) {
                console.error(err);
                els.content.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-64 text-center">
                        <div class="text-xl font-semibold text-secondary mb-2">PAPERS PAYLOAD MISSING</div>
                        <p class="text-sm text-secondary opacity-70">Ensure RTQ_PAPERS_PAYLOAD_PATH resolves correctly.</p>
                    </div>
                `;
                els.selector.innerHTML = '<option>Error loading payload</option>';
            }
        }

        function renderSelector() {
            els.selector.innerHTML = state.papers.map(p => 
                `<option value="${p.key}">${p.label}</option>`
            ).join('');

            els.selector.addEventListener('change', (e) => {
                loadPaper(e.target.value);
            });
        }

        function loadPaper(key) {
            const paper = state.papers.find(p => p.key === key);
            if (!paper) return;

            state.currentPaperKey = key;
            
            // Set defaults
            const expandAll = paper.defaults?.expandedAll !== false;
            state.expandedWorkings = {}; // Reset local state on switch, relies on render defaults
            
            // Build Flat Question List for Navigation & Rendering
            const flatList = [];
            
            if (paper.sections) {
                paper.sections.forEach(sec => {
                    flatList.push({ type: 'section', label: sec.label });
                    sec.questions.forEach(q => traverse(q, flatList, 0));
                });
            } else if (paper.questions) {
                paper.questions.forEach(q => traverse(q, flatList, 0));
            }

            // Render Nav
            renderNav(flatList);

            // Render Content
            renderContent(flatList, expandAll);

            // Scroll to top
            window.scrollTo(0, 0);
            
            // Re-run icons & KaTeX
            lucide.createIcons();
            renderMathInElement(document.body, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false},
                    {left: '\\(', right: '\\)', display: false},
                    {left: '\\[', right: '\\]', display: true}
                ],
                throwOnError: false
            });
        }

        function traverse(node, list, depth) {
            list.push({ type: 'question', data: node, depth: depth });
            if (node.children) {
                node.children.forEach(child => traverse(child, list, depth + 1));
            }
        }

        // --- 3. RENDERING ---

        function renderNav(flatList) {
            const createNavHTML = (isMobile) => flatList.map(item => {
                if (item.type === 'section') {
                    if (!item.label || item.label.trim() === '') return ''; // Omit empty sections
                    return `
                        <div class="mt-4 mb-2 first:mt-0">
                            <span class="text-xs font-semibold text-secondary uppercase tracking-wider block px-2 select-none">${item.label}</span>
                        </div>
                    `;
                } else {
                    const q = item.data;
                    // Hierarchy via type scale/opacity, flat left align
                    const classes = item.depth === 0 ? 'font-medium text-primary' : 
                                    item.depth === 1 ? 'text-sm text-secondary' : 
                                    'text-xs text-tertiary';
                    
                    return `
                        <button onclick="scrollToQuestion('${q.id}')" 
                            class="text-left w-full py-1 px-2 rounded hover:bg-black/5 focus-visible:bg-black/5 transition-colors ${classes}">
                            ${q.id}
                        </button>
                    `;
                }
            }).join('');

            els.desktopNav.innerHTML = createNavHTML(false);
            els.mobileNav.innerHTML = createNavHTML(true);
        }

        function renderContent(flatList, defaultExpand) {
            // We reconstruct the render structure. 
            // Since we flattened it for Nav, we need to handle the nesting in UI structure correctly.
            // Actually, for the Paper View, we should render from the paper object structure to preserve 'children container' DOM structure.
            
            const paper = state.papers.find(p => p.key === state.currentPaperKey);
            let html = '';

            if (paper.sections) {
                html = paper.sections.map(sec => `
                    <section class="mb-12">
                        ${sec.label && sec.label.trim() !== '' ? `
                            <div class="border-b border-quiet pb-2 mb-8">
                                <h2 class="text-xl font-bold text-primary">${sec.label}</h2>
                            </div>
                        ` : ''}
                        <div class="flex flex-col gap-12">
                            ${sec.questions.map(q => renderQuestionNode(q, defaultExpand, 0)).join('')}
                        </div>
                    </section>
                `).join('');
            } else {
                html = paper.questions.map(q => renderQuestionNode(q, defaultExpand, 0)).join('');
            }

            els.content.innerHTML = html;
        }

        function renderQuestionNode(node, defaultExpand, depth) {
            // Determine if expanded: check local state first, then default
            const isExpanded = state.expandedWorkings[node.id] !== undefined 
                ? state.expandedWorkings[node.id] 
                : defaultExpand;

            const hasSolutionBlock = !!node.solutionBlock;
            const hasAnswer = hasSolutionBlock && !!node.solutionBlock.answer;
            const hasSolutionDetails = hasSolutionBlock && !!node.solutionBlock.solutionDetails;

            const indentClass = depth > 0 ? 'ml-4 md:ml-8 border-l border-quiet pl-4 md:pl-6' : '';
            const separatorClass = depth === 0 ? 'border-b border-quiet pb-12 mb-12 last:border-0 last:pb-0 last:mb-0' : 'mt-8';

            // Safe ID for scrolling (escape special chars if needed)
            const safeId = node.id.replace(/[()]/g, '');

            return `
                <div id="q-${node.id}" class="question-node ${indentClass} ${separatorClass} group">
                    <!-- Question Body -->
                    <div class="mb-4">
                        <div class="flex gap-3 items-baseline">
                            <span class="text-secondary font-medium select-none flex-shrink-0" style="font-size: 0.9em;">${node.id}</span>
                            <div class="md-content text-primary text-lg leading-relaxed flex-1">
                                ${md ? md.render(node.question) : node.question}
                            </div>
                        </div>
                    </div>

                    <!-- Solution Block (Optional) -->
                    ${hasSolutionBlock ? `
                        <div class="ml-0 md:ml-8 pl-0"> <!-- Solution alignment -->
                            
                            <!-- Answer -->
                            ${hasAnswer ? `
                                <div class="mb-3 flex gap-3 items-baseline">
                                    <span class="text-xs font-bold uppercase tracking-wider text-secondary select-none pt-1">Answer</span>
                                    <div class="md-content text-primary font-medium">
                                        ${md ? md.render(node.solutionBlock.answer) : node.solutionBlock.answer}
                                    </div>
                                </div>
                            ` : ''}

                            <!-- Solution Details Disclosure -->
                            ${hasSolutionDetails ? `
                                <div>
                                    <button 
                                        onclick="toggleWorking('${node.id}')"
                                        class="text-sm font-medium text-accent hover:underline flex items-center gap-1 mb-2 focus-visible:ring-2 focus-visible:ring-accent focus-visible:ring-offset-2 rounded"
                                        aria-expanded="${isExpanded}"
                                    >
                                        <span id="label-${node.id}">${isExpanded ? 'Hide working' : 'Show working'}</span>
                                        <i data-lucide="chevron-down" class="w-4 h-4 transition-transform duration-200 ${isExpanded ? 'rotate-180' : ''}" id="icon-${node.id}"></i>
                                    </button>

                                    <!-- Expandable Region -->
                                    <div id="details-${node.id}" class="details-wrapper ${isExpanded ? 'expanded' : ''}">
                                        <div class="details-inner bg-wash rounded-sm px-4 py-4 md:px-6 md:py-5 border border-quiet/50">
                                            
                                            <!-- Keep in mind -->
                                            ${node.solutionBlock.solutionDetails.keepInMind ? `
                                                <div class="mb-6">
                                                    <div class="flex items-center gap-2 mb-2">
                                                        <span class="text-xs font-bold text-secondary uppercase">Keep in mind</span>
                                                    </div>
                                                    <div class="md-content text-sm text-primary">
                                                        ${md ? md.render(node.solutionBlock.solutionDetails.keepInMind) : ''}
                                                    </div>
                                                </div>
                                            ` : ''}

                                            <!-- Formulas -->
                                            ${node.solutionBlock.solutionDetails.formulasUsed ? `
                                                <div class="mb-6">
                                                    <div class="text-xs font-bold text-secondary uppercase mb-2">Formulas used</div>
                                                    <div class="md-content text-sm text-secondary">
                                                        ${md ? md.render(node.solutionBlock.solutionDetails.formulasUsed) : ''}
                                                    </div>
                                                </div>
                                            ` : ''}

                                            <!-- Working (Primary) -->
                                            ${node.solutionBlock.solutionDetails.working ? `
                                                <div class="mb-6 last:mb-0">
                                                    <div class="text-xs font-bold text-secondary uppercase mb-2">Working</div>
                                                    <div class="md-content text-primary">
                                                        ${md ? md.render(node.solutionBlock.solutionDetails.working) : ''}
                                                    </div>
                                                </div>
                                            ` : ''}

                                            <!-- Alt Working -->
                                            ${node.solutionBlock.solutionDetails.alternativeWorking && node.solutionBlock.solutionDetails.alternativeWorking.length > 0 ? 
                                                node.solutionBlock.solutionDetails.alternativeWorking.map(alt => `
                                                    <div class="mt-8 pt-6 border-t border-quiet">
                                                        <div class="text-xs font-bold text-secondary uppercase mb-2">Alternative working</div>
                                                        <div class="md-content text-primary">
                                                            ${md ? md.render(alt) : ''}
                                                        </div>
                                                    </div>
                                                `).join('')
                                            : ''}
                                            
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}

                    <!-- Recursive Children -->
                    ${node.children && node.children.length > 0 ? `
                        <div class="mt-6">
                            ${node.children.map(child => renderQuestionNode(child, defaultExpand, depth + 1)).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // --- 4. INTERACTIONS ---

        window.toggleWorking = function(id) {
            const wrapper = document.getElementById(`details-${id}`);
            const label = document.getElementById(`label-${id}`);
            const icon = document.getElementById(`icon-${id}`);
            
            if (!wrapper) return;

            const isNowExpanded = !wrapper.classList.contains('expanded');
            
            if (isNowExpanded) {
                wrapper.classList.add('expanded');
                label.innerText = 'Hide working';
                icon.classList.add('rotate-180');
            } else {
                wrapper.classList.remove('expanded');
                label.innerText = 'Show working';
                icon.classList.remove('rotate-180');
            }

            state.expandedWorkings[id] = isNowExpanded;
        };

        window.scrollToQuestion = function(id) {
            closeDrawer();
            const el = document.getElementById(`q-${id}`);
            if (el) {
                // Offset for sticky header (14 * 4 = 56px) + some breathing room
                const offset = 80; 
                const elementPosition = el.getBoundingClientRect().top;
                const offsetPosition = elementPosition + window.pageYOffset - offset;
                
                window.scrollTo({
                    top: offsetPosition,
                    behavior: "smooth"
                });
            }
        };

        // Mobile Drawer Logic
        function openDrawer() {
            els.drawer.classList.remove('pointer-events-none', 'opacity-0');
            els.drawerPanel.classList.remove('translate-x-full');
            // Trap focus roughly
            els.drawerClose.focus();
        }

        function closeDrawer() {
            els.drawer.classList.add('pointer-events-none');
            setTimeout(() => els.drawer.classList.add('opacity-0'), 300); // fade out after slide
            els.drawerPanel.classList.add('translate-x-full');
        }

        els.drawerTrigger.addEventListener('click', openDrawer);
        els.drawerClose.addEventListener('click', closeDrawer);
        els.drawerBackdrop.addEventListener('click', closeDrawer);

        // Escape key to close drawer
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeDrawer();
        });

        // Initialize
        init();

    </script>
</body>
</html>
