<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"ABC","indexWithinVariant":"150","totalWithinVariant":"320","hueFamily":"cyan","intensityMode":"tinted_neutrals","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-09T17:02:18.630Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;ABC&quot;,&quot;indexWithinVariant&quot;:&quot;150&quot;,&quot;totalWithinVariant&quot;:&quot;320&quot;,&quot;hueFamily&quot;:&quot;cyan&quot;,&quot;intensityMode&quot;:&quot;tinted_neutrals&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-09T17:02:18.630Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Viewer (Stage 6 Baseline)</title>

    <!-- 
        STAGE 6 BASELINE: 
        - Real KaTeX enabled (No SRI/integrity).
        - Tailwind for styling.
        - Markdown-it for payload rendering.
        - ColorLab C (Tinted Neutrals) + ColorLab B (Cyan) applied via CSS variables.
    -->

    <!-- Fonts: Inter for a clean, modern, friendly sans-serif -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- KaTeX CSS (No Integrity) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <!-- Tailwind CSS (Script for prototyping) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Tailwind Config for OKLCH Palette (Cyan + Tinted Neutrals) -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        // COLORLAB C: TINTED NEUTRALS (Light Mode)
                        // COLORLAB B: CYAN (Hue ~200)
                        
                        // Surfaces
                        page: 'oklch(0.97 0.02 200)',   // High L, Low C, Cyan H
                        frame: 'oklch(0.95 0.025 200)',  // Distinct from page
                        paper: 'oklch(0.99 0.015 200)',  // Near white, slight cool tint
                        
                        // Washes / Demarcation
                        wash: 'oklch(0.96 0.03 200)',    // Solution details background
                        hairline: 'oklch(0.88 0.02 200)', // Quiet dividers
                        
                        // Text
                        primary: 'oklch(0.20 0.01 200)',   // Deep grey-cyan
                        secondary: 'oklch(0.40 0.012 200)', // Muted grey-cyan
                        
                        // Accents (Restrained)
                        accent: {
                            DEFAULT: 'oklch(0.55 0.14 200)', // Link/Focus/Active
                            hover: 'oklch(0.50 0.14 200)',
                            subtle: 'oklch(0.90 0.05 200)' // Selection backgrounds if needed
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* GLOBAL RESET & BASELINE */
        body {
            background-color: theme('colors.page');
            color: theme('colors.primary');
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            overflow-y: scroll; /* Force vertical scrollbar to prevent layout shift */
        }

        /* KATEX CONTAINMENT INVARIANT (LOCKED) */
        /* Prevent page-level horizontal scroll, allow math-level scroll */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding-bottom: 4px; /* Space for scrollbar */
            -webkit-overflow-scrolling: touch;
            margin: 1em 0;
        }
        
        /* Inline math must have no background */
        .katex {
            font-size: 1.1em; /* Slight bump for readability */
        }
        
        /* HIDE SCROLLBARS FOR NAV (Add-on) */
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* MOTION (Reduced Motion Respect) */
        @media (prefers-reduced-motion: no-preference) {
            .reveal-content {
                transition: all 0.25s ease-out;
            }
        }

        /* FOCUS STYLES (Stage 5.5.2) */
        *:focus-visible {
            outline: 2px solid theme('colors.accent.DEFAULT');
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* MARKDOWN STYLES (Subordinate to Payload) */
        .md-content p {
            margin-bottom: 0.75em;
            line-height: 1.6;
        }
        .md-content p:last-child {
            margin-bottom: 0;
        }
        /* Minimal tables per Stage 5.8.5 */
        .md-content table {
            border-collapse: collapse;
            width: 100%; /* Or auto, depending on content */
            margin: 1em 0;
            font-size: 0.95em;
        }
        .md-content th, .md-content td {
            border: 1px solid theme('colors.hairline');
            padding: 8px 12px;
            text-align: left;
        }
        .md-content th {
            font-weight: 600;
        }
        /* Inline SVG passthrough support */
        .md-content svg {
            max-width: 100%;
            height: auto;
            display: inline-block;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center">

    <!-- APPLICATION ROOT -->
    <div id="app" class="w-full max-w-[1400px] h-full flex flex-col md:flex-row">
        <!-- JS renders content here -->
        <div class="p-10 text-center w-full text-secondary animate-pulse">Loading Papers Payload...</div>
    </div>

    <!-- SCRIPTS -->
    <!-- Markdown-it (No Integrity) -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>
    <!-- KaTeX JS (No Integrity) -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <script>
        // --- STAGE 0: CONSTANTS ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // --- GLOBAL STATE ---
        let appState = {
            papers: [],
            currentPaperKey: null,
            expandedMap: {}, // key: questionId, value: boolean
            mobileNavOpen: false
        };

        // --- MARKDOWN SETUP (Stage 6 Invariants) ---
        const md = window.markdownit ? window.markdownit({
            html: true,    // Allow inline SVG
            linkify: true,
            breaks: false  // MUST be false for KaTeX
        }) : null;

        if (md) {
            // Disable escape rule to preserve TeX backslashes
            md.inline.ruler.disable(['escape']);
        }

        // --- MAIN INITIALIZATION ---
        async function init() {
            const appEl = document.getElementById('app');

            try {
                // Deterministic Load
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Payload not found");
                
                const payload = await response.json();
                appState.papers = payload.papers || [];

                if (appState.papers.length > 0) {
                    // Initialize with first paper
                    switchPaper(appState.papers[0].key);
                } else {
                    renderError("NO PAPERS FOUND IN PAYLOAD");
                }

            } catch (err) {
                console.error(err);
                renderError("PAPERS PAYLOAD MISSING");
            }
        }

        function renderError(msg) {
            const appEl = document.getElementById('app');
            appEl.innerHTML = `
                <div class="w-full min-h-screen flex items-center justify-center bg-page text-primary font-bold">
                    ${msg}
                </div>
            `;
        }

        // --- LOGIC: STATE MANAGEMENT ---

        function switchPaper(key) {
            appState.currentPaperKey = key;
            appState.expandedMap = {};
            appState.mobileNavOpen = false;

            const paper = getCurrentPaper();
            const defaultExpanded = paper.defaults?.expandedAll !== false;

            // Pre-calculate expanded state based on defaults
            // We need to traverse all questions to set this
            const setDefaults = (nodes) => {
                nodes.forEach(node => {
                    if (node.solutionBlock?.solutionDetails) {
                        appState.expandedMap[node.id] = defaultExpanded;
                    }
                    if (node.children) setDefaults(node.children);
                });
            };
            
            if (paper.questions) setDefaults(paper.questions);
            if (paper.sections) {
                paper.sections.forEach(s => setDefaults(s.questions));
            }

            renderApp();
            
            // Scroll to top
            window.scrollTo(0, 0);
        }

        function getCurrentPaper() {
            return appState.papers.find(p => p.key === appState.currentPaperKey);
        }

        function toggleSolution(questionId) {
            appState.expandedMap[questionId] = !appState.expandedMap[questionId];
            
            // Re-render only the specific solution block would be ideal, 
            // but for this baseline prototype, full render is safer for consistency
            // We preserve scroll position implicitly by not forcing scroll top
            renderApp(); 
        }

        function toggleMobileNav() {
            appState.mobileNavOpen = !appState.mobileNavOpen;
            renderApp();
        }

        function jumpToQuestion(id) {
            appState.mobileNavOpen = false;
            renderApp(); // Close drawer
            
            setTimeout(() => {
                const el = document.getElementById(`q-${id}`);
                if (el) {
                    el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    // Set focus for accessibility
                    el.focus({ preventScroll: true });
                }
            }, 50);
        }

        // --- RENDERING: SHELL ---

        function renderApp() {
            const paper = getCurrentPaper();
            if (!paper) return;

            const appEl = document.getElementById('app');
            
            // Clear current
            appEl.innerHTML = '';

            // 1. Desktop Nav Rail (Left Column)
            const desktopNav = renderNavigation(paper, false);
            
            // 2. Paper Content (Right Column)
            const paperColumn = document.createElement('main');
            paperColumn.className = "flex-1 flex flex-col bg-frame min-h-screen w-full"; // Frame background

            // 2a. Top Controls (Paper Selector + Mobile Trigger)
            const topControls = renderTopControls();
            paperColumn.appendChild(topControls);

            // 2b. Paper Surface
            const paperSurface = renderPaperSurface(paper);
            paperColumn.appendChild(paperSurface);

            // 3. Mobile Nav Drawer
            const mobileDrawer = renderMobileDrawer(paper);

            // Assembly
            appEl.appendChild(desktopNav);
            appEl.appendChild(paperColumn);
            appEl.appendChild(mobileDrawer);

            // 4. KaTeX Auto-Render (Post-Process)
            renderMathInElement(appEl, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false}
                ],
                throwOnError: false
            });
        }

        // --- RENDERING: TOP CONTROLS ---

        function renderTopControls() {
            const container = document.createElement('div');
            container.className = "sticky top-0 z-20 bg-frame border-b border-hairline px-4 py-3 flex items-center justify-between h-16";

            // Paper Selector
            const select = document.createElement('select');
            select.className = "bg-page border border-hairline rounded px-3 py-1.5 text-sm text-primary focus:border-accent shadow-sm";
            select.onchange = (e) => switchPaper(e.target.value);

            appState.papers.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.key;
                opt.textContent = p.label;
                opt.selected = p.key === appState.currentPaperKey;
                select.appendChild(opt);
            });

            container.appendChild(select);

            // Mobile Jump To Trigger
            const jumpBtn = document.createElement('button');
            jumpBtn.className = "md:hidden text-sm font-medium text-accent hover:text-accent-hover";
            jumpBtn.textContent = "Jump to";
            jumpBtn.onclick = toggleMobileNav;
            
            container.appendChild(jumpBtn);

            return container;
        }

        // --- RENDERING: NAVIGATION ---

        function renderNavigation(paper, isMobile) {
            const nav = document.createElement('nav');
            
            if (!isMobile) {
                // Desktop Rail Styles
                // Sticky within the frame, sharing frame bg, quiet
                nav.className = "hidden md:block w-64 flex-shrink-0 bg-frame border-r border-hairline h-screen sticky top-0 overflow-y-auto no-scrollbar py-6 px-4";
            } else {
                // Mobile Drawer List Styles
                nav.className = "flex-1 overflow-y-auto py-4 px-4";
            }

            // Flat List Container
            const ul = document.createElement('ul');
            ul.className = "space-y-0.5";

            // Helper to generate items
            const createNavItem = (qId, isHeader = false) => {
                const li = document.createElement('li');
                
                if (isHeader) {
                    // Section Label (A/B/C) - Non-clickable signpost
                    li.className = "mt-6 mb-2 text-xs font-bold text-secondary uppercase tracking-wider select-none";
                    li.textContent = qId;
                } else {
                    // Question ID
                    const btn = document.createElement('button');
                    btn.className = "w-full text-left py-1.5 px-2 rounded text-sm text-secondary hover:text-primary hover:bg-black/5 transition-colors focus:bg-accent-subtle";
                    
                    // Hierarchy via type scale only (quiet sub-questions)
                    // We detect depth by simple length or pattern matching for baseline simplicity
                    // or ideally we pass depth. For now, flat list.
                    
                    // Active State
                    // (Just visual weight, no accent color per Stage 5.4.3 Override allowed only for marker)
                    // Actually Override 5.4.3 says: "Accent permitted... in navigation and non-content UI"
                    // Let's use a subtle left border or font weight
                    // ColorLab C permits accent for "nav current marker"
                    
                    // Simple weight indication
                    btn.style.fontWeight = "400";
                    btn.innerHTML = `<span>${qId}</span>`;
                    
                    btn.onclick = () => jumpToQuestion(qId);
                    li.appendChild(btn);
                }
                return li;
            };

            // Recursively Flatten Items
            const traverse = (nodes, depth = 0) => {
                nodes.forEach(node => {
                    const li = createNavItem(node.id);
                    
                    // Type scale nuance for depth (Stage 5.4.5)
                    const btn = li.firstChild;
                    if (depth > 0) {
                        btn.classList.add('text-xs'); // Quieter
                        btn.classList.remove('text-sm');
                    }
                    
                    ul.appendChild(li);
                    
                    if (node.children) traverse(node.children, depth + 1);
                });
            };

            if (paper.sections) {
                paper.sections.forEach(section => {
                    if (section.label && section.label.trim() !== "") {
                        ul.appendChild(createNavItem(section.label, true));
                    }
                    traverse(section.questions);
                    
                    // Separator between sections
                    const sep = document.createElement('li');
                    sep.className = "h-4"; // Spacing
                    ul.appendChild(sep);
                });
            } else if (paper.questions) {
                traverse(paper.questions);
            }

            nav.appendChild(ul);
            return nav;
        }

        function renderMobileDrawer(paper) {
            if (!appState.mobileNavOpen) return document.createElement('div');

            const overlay = document.createElement('div');
            overlay.className = "fixed inset-0 z-50 flex justify-end md:hidden";

            // Scrim
            const scrim = document.createElement('div');
            scrim.className = "absolute inset-0 bg-primary/20 backdrop-blur-sm";
            scrim.onclick = toggleMobileNav;
            overlay.appendChild(scrim);

            // Drawer
            const drawer = document.createElement('div');
            drawer.className = "relative bg-page w-64 h-full shadow-xl flex flex-col transform transition-transform";
            
            // Header
            const header = document.createElement('div');
            header.className = "flex items-center justify-between p-4 border-b border-hairline";
            header.innerHTML = `<span class="font-semibold text-primary">Jump to</span>`;
            
            const close = document.createElement('button');
            close.className = "text-secondary hover:text-primary p-2";
            close.innerHTML = "&times;"; // Simple X
            close.onclick = toggleMobileNav;
            header.appendChild(close);
            
            drawer.appendChild(header);

            // Nav List
            drawer.appendChild(renderNavigation(paper, true));

            overlay.appendChild(drawer);
            return overlay;
        }

        // --- RENDERING: PAPER CONTENT ---

        function renderPaperSurface(paper) {
            const container = document.createElement('div');
            container.className = "flex-1 w-full max-w-4xl mx-auto p-4 md:p-8 lg:p-12 space-y-12"; 

            // Sections or Flat
            if (paper.sections) {
                paper.sections.forEach((section, idx) => {
                    // Section Wrapper
                    const sectionWrapper = document.createElement('div');
                    sectionWrapper.className = "space-y-8";

                    // Section Header (if present)
                    if (section.label && section.label.trim() !== "") {
                        const header = document.createElement('h2');
                        header.className = "text-xl font-bold text-primary pb-4 border-b border-hairline";
                        header.textContent = section.label; // e.g., "Section A"
                        sectionWrapper.appendChild(header);
                    }

                    // Questions
                    section.questions.forEach(q => {
                        sectionWrapper.appendChild(renderQuestionNode(q, 0));
                    });

                    container.appendChild(sectionWrapper);
                    
                    // Spacing between sections
                    if (idx < paper.sections.length - 1) {
                        const spacer = document.createElement('div');
                        spacer.className = "h-12"; 
                        container.appendChild(spacer);
                    }
                });
            } else if (paper.questions) {
                paper.questions.forEach(q => {
                    container.appendChild(renderQuestionNode(q, 0));
                });
            }

            // Bottom padding
            const bottomPad = document.createElement('div');
            bottomPad.className = "h-32";
            container.appendChild(bottomPad);

            return container;
        }

        // --- NODE RENDERING (Recursive) ---

        function renderQuestionNode(node, depth) {
            const wrapper = document.createElement('div');
            // ID anchor
            wrapper.id = `q-${node.id}`;
            wrapper.className = "group focus:outline-none";
            wrapper.tabIndex = -1; // Allow programmatic focus

            // Top-level spacing vs Child spacing
            if (depth === 0) {
                wrapper.classList.add("mb-16"); // Large gap for top-level
            } else {
                wrapper.classList.add("mt-6", "ml-0", "md:ml-4"); // Vertical gap + Indent logic (responsive)
                // Stage 3: Child indentation adapted by viewport (handled by md:ml-4)
            }

            // --- 1. Question Body ---
            const qBody = document.createElement('div');
            qBody.className = "mb-4";

            // Identifier + Prompt
            // Structure: Identifier is prefix.
            // Visually: Identifier secondary, Prompt primary.
            const idLabel = `<span class="text-secondary font-medium mr-2 select-none">${node.id}</span>`;
            
            const promptHtml = md ? md.render(node.question || "") : node.question;
            
            const qContent = document.createElement('div');
            qContent.className = "text-lg text-primary leading-relaxed md-content font-medium";
            qContent.innerHTML = idLabel + `<span class="inline-block align-top">${promptHtml}</span>`; // Simple alignment

            qBody.appendChild(qContent);
            wrapper.appendChild(qBody);

            // --- 2. Solution Block (Optional) ---
            if (node.solutionBlock) {
                const sb = node.solutionBlock;
                const solutionWrapper = document.createElement('div');
                solutionWrapper.className = "ml-2 md:ml-6 pl-4 border-l-2 border-hairline/50"; // Visual association line (subtle)

                // 2a. Answer (Optional)
                if (sb.answer) {
                    const ansDiv = document.createElement('div');
                    ansDiv.className = "mb-4";
                    
                    const ansLabel = document.createElement('div');
                    ansLabel.className = "text-xs uppercase tracking-wide font-bold text-secondary mb-1";
                    ansLabel.textContent = "Answer";
                    
                    const ansBody = document.createElement('div');
                    ansBody.className = "text-base text-primary md-content";
                    ansBody.innerHTML = md ? md.render(sb.answer) : sb.answer;

                    ansDiv.appendChild(ansLabel);
                    ansDiv.appendChild(ansBody);
                    solutionWrapper.appendChild(ansDiv);
                }

                // 2b. Solution Details (Optional, Collapsible)
                if (sb.solutionDetails) {
                    const isExpanded = appState.expandedMap[node.id];
                    const details = sb.solutionDetails;

                    // Toggle Control
                    const toggleBtn = document.createElement('button');
                    toggleBtn.className = "text-sm font-medium text-accent hover:text-accent-hover flex items-center mb-2 focus:outline-none focus:ring-2 focus:ring-accent/20 rounded px-1 -ml-1";
                    toggleBtn.onclick = () => toggleSolution(node.id);
                    
                    const iconState = isExpanded ? "rotate-180" : "";
                    toggleBtn.innerHTML = `
                        <span class="mr-1">${isExpanded ? "Hide working" : "Show working"}</span>
                        <svg class="w-4 h-4 transform transition-transform ${iconState}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    `;
                    solutionWrapper.appendChild(toggleBtn);

                    // Expanded Region
                    if (isExpanded) {
                        const region = document.createElement('div');
                        // Wash surface for expanded region (Stage 3 + ColorLab C Tinted Neutral)
                        region.className = "bg-wash rounded-sm p-4 md:p-6 mt-2 reveal-content space-y-6";

                        // Order: Keep in mind -> Formulas -> Working -> Alt Working

                        // Keep in mind
                        if (details.keepInMind) {
                            region.appendChild(renderSubSection("Keep in mind", details.keepInMind, true)); // true = emphasis
                        }

                        // Formulas used
                        if (details.formulasUsed) {
                            region.appendChild(renderSubSection("Formulas used", details.formulasUsed));
                        }

                        // Working (Primary)
                        if (details.working) {
                            region.appendChild(renderSubSection("Working", details.working));
                        }

                        // Alternative working (Array)
                        if (details.alternativeWorking && Array.isArray(details.alternativeWorking)) {
                            details.alternativeWorking.forEach((alt, idx) => {
                                region.appendChild(renderSubSection("Alternative working", alt));
                            });
                        }

                        solutionWrapper.appendChild(region);
                    }
                }

                wrapper.appendChild(solutionWrapper);
            }

            // --- 3. Children (Recursion) ---
            if (node.children && node.children.length > 0) {
                const childrenContainer = document.createElement('div');
                childrenContainer.className = "mt-6"; 
                
                node.children.forEach(child => {
                    childrenContainer.appendChild(renderQuestionNode(child, depth + 1));
                });
                
                wrapper.appendChild(childrenContainer);
            }

            return wrapper;
        }

        function renderSubSection(label, markdown, emphasized = false) {
            const container = document.createElement('div');
            
            const lbl = document.createElement('h4');
            // Stage 5.9: Label bold. 
            lbl.className = "text-xs font-bold text-secondary mb-2 uppercase tracking-wide";
            lbl.textContent = label;
            container.appendChild(lbl);

            const body = document.createElement('div');
            // Stage 6.0.10: Anti-faded. Text must be readable.
            // Using 'text-secondary' for working body is common, but let's ensure it's not too light.
            // In ColorLab C, secondary is oklch(0.40...) which is mid-grey. Readable.
            // KeepInMind (emphasized) gets darker text.
            body.className = `text-sm md:text-base leading-relaxed md-content ${emphasized ? 'text-primary' : 'text-secondary'}`;
            body.innerHTML = md ? md.render(markdown) : markdown;
            
            container.appendChild(body);
            return container;
        }

        // --- BOOTSTRAP ---
        init();

    </script>
</body>
</html>
