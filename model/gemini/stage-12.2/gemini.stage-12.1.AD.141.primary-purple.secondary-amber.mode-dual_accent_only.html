<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AD","indexWithinVariant":"141","totalWithinVariant":"440","hueFamily":"","intensityMode":"","primaryHueFamily":"purple","secondaryHueFamily":"amber","dualIntensityMode":"dual_accent_only","timestamp":"2026-01-10T08:16:50.127Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AD&quot;,&quot;indexWithinVariant&quot;:&quot;141&quot;,&quot;totalWithinVariant&quot;:&quot;440&quot;,&quot;hueFamily&quot;:&quot;&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;primaryHueFamily&quot;:&quot;purple&quot;,&quot;secondaryHueFamily&quot;:&quot;amber&quot;,&quot;dualIntensityMode&quot;:&quot;dual_accent_only&quot;,&quot;timestamp&quot;:&quot;2026-01-10T08:16:50.127Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Viewer</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- KaTeX CSS (No SRI) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <!-- Tailwind CSS (Prototyping) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Markdown-it (No SRI) -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <!-- KaTeX JS (No SRI) -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- ColorLab D Configuration & Tailwind Theme -->
    <style>
        /* 
         * COLORLAB D: DUAL-ACCENT PALETTE (Mode 1: dual_accent_only)
         * Primary: Blue (Links, Focus, Active Nav)
         * Secondary: Amber (Supplementary role)
         * Light Mode Only. 
         */
        :root {
            /* Palette Primitives (OKLCH) */
            /* Neutral Surfaces (Warm/Soft) */
            --bg-page: 0.985 0.002 250;     /* Very light cool/neutral tint */
            --bg-frame: 1.0 0 0;            /* White */
            --bg-paper: 1.0 0 0;            /* White */
            --bg-wash: 0.975 0.005 250;     /* Subtle wash for solution details */
            
            /* Text (High legibility, near neutral) */
            --txt-primary: 0.20 0.01 250;   /* Deep charcoal */
            --txt-secondary: 0.45 0.015 250; /* Medium grey */
            --txt-tertiary: 0.60 0.01 250;   /* Lighter grey (nav) */

            /* Borders */
            --border-hairline: 0.92 0.005 250;

            /* Accents - Mode 1 (Restrained) */
            /* Primary (Blue) - C between 0.08 and 0.14 */
            --accent-primary: 0.55 0.13 250; 
            
            /* Secondary (Amber) - C between 0.06 and 0.12 */
            --accent-secondary: 0.75 0.11 85;

            /* Focus Ring */
            --focus-ring: var(--accent-primary);
        }

        body {
            background-color: oklch(var(--bg-page));
            color: oklch(var(--txt-primary));
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        /* Utility Classes for Dynamic Colors */
        .bg-page { background-color: oklch(var(--bg-page)); }
        .bg-frame { background-color: oklch(var(--bg-frame)); }
        .bg-paper { background-color: oklch(var(--bg-paper)); }
        .bg-wash { background-color: oklch(var(--bg-wash)); }
        
        .text-primary { color: oklch(var(--txt-primary)); }
        .text-secondary { color: oklch(var(--txt-secondary)); }
        .text-tertiary { color: oklch(var(--txt-tertiary)); }
        
        .text-accent-primary { color: oklch(var(--accent-primary)); }
        .text-accent-secondary { color: oklch(var(--accent-secondary)); }

        .border-hairline { border-color: oklch(var(--border-hairline)); }

        .ring-accent { --tw-ring-color: oklch(var(--focus-ring)); }

        /* KaTeX Containment & Formatting */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding: 0.5rem 0;
            margin: 0.5rem 0;
            /* Scrollbar hiding for clean look */
            scrollbar-width: thin;
            scrollbar-color: oklch(var(--border-hairline)) transparent;
        }
        
        /* Markdown Content Styles */
        .md-content p { margin-bottom: 0.75em; line-height: 1.6; }
        .md-content p:last-child { margin-bottom: 0; }
        .md-content ul { list-style-type: disc; padding-left: 1.25em; margin-bottom: 0.75em; }
        .md-content ol { list-style-type: decimal; padding-left: 1.25em; margin-bottom: 0.75em; }
        .md-content table { width: 100%; border-collapse: collapse; margin-bottom: 1em; font-size: 0.95em; }
        .md-content th, .md-content td { border: 1px solid oklch(var(--border-hairline)); padding: 0.5em; text-align: left; }
        .md-content th { font-weight: 600; }
        
        /* Navigation Scrollbar Hiding */
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* Focus Styles */
        :focus-visible {
            outline: 2px solid oklch(var(--focus-ring));
            outline-offset: 2px;
            border-radius: 2px;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Mapped in CSS variables
                    },
                    spacing: {
                        '18': '4.5rem',
                    }
                }
            }
        }
    </script>
</head>
<body>

<div id="app" class="min-h-screen flex flex-col items-center">
    <!-- Shell/Content rendered here -->
</div>

<script>
// =============================================================================
// STAGE 0: CONSTANTS & CONFIG
// =============================================================================

const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

// =============================================================================
// MARKDOWN & KATEX SETUP
// =============================================================================

const md = window.markdownit ? window.markdownit({
    html: true,       // Enable inline HTML (SVG)
    linkify: true,
    breaks: false,    // MUST be false to prevent <br> in math blocks
}) : null;

if (md) {
    // Disable escape rule to preserve TeX backslashes
    md.inline.ruler.disable(['escape']);
}

const renderMath = (element) => {
    if (window.renderMathInElement) {
        renderMathInElement(element, {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false},
                {left: '\\(', right: '\\)', display: false},
                {left: '\\[', right: '\\]', display: true}
            ],
            throwOnError: false,
            output: 'html' // Use HTML output for better accessibility/layout
        });
    }
};

// =============================================================================
// STATE MANAGEMENT
// =============================================================================

const state = {
    papers: [],
    currentPaper: null,
    expandedQs: new Set(), // Set of question IDs where solution is expanded
    mobileNavOpen: false,
    navActiveId: null // For scrollspy
};

// =============================================================================
// DATA FETCHING
// =============================================================================

async function init() {
    const app = document.getElementById('app');
    
    try {
        const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
        if (!response.ok) throw new Error("Payload not found");
        
        const data = await response.json();
        
        if (!data.papers || !Array.isArray(data.papers)) {
            throw new Error("Invalid payload format");
        }

        state.papers = data.papers;
        // Select first paper by default
        if (state.papers.length > 0) {
            selectPaper(state.papers[0].key);
        } else {
            renderFailure("NO PAPERS IN PAYLOAD");
        }

    } catch (error) {
        console.error(error);
        renderFailure("PAPERS PAYLOAD MISSING");
    }
}

function selectPaper(key) {
    const paper = state.papers.find(p => p.key === key);
    if (!paper) return;

    state.currentPaper = paper;
    
    // Reset expanded state based on defaults
    state.expandedQs.clear();
    const defaultExpanded = paper.defaults?.expandedAll !== false;
    
    if (defaultExpanded) {
        // We handle logic: if default is expanded, we track collapsed IDs instead? 
        // Or simpler: just track explicit state. 
        // For prototype simplicity: if expandedAll is true, we assume everything is expanded unless tracked as collapsed.
        // Let's invert: state.expandedQs tracks overrides if needed, or we just init all.
        // Let's traverse to find all IDs with solutionDetails and add to Set if default is true.
        const traverse = (nodes) => {
            nodes.forEach(node => {
                if (node.solutionBlock?.solutionDetails) {
                    state.expandedQs.add(node.id);
                }
                if (node.children) traverse(node.children);
            });
        };
        
        // Handle flat or sectioned
        let allQuestions = [];
        if (paper.questions) allQuestions = paper.questions;
        else if (paper.sections) paper.sections.forEach(s => allQuestions.push(...s.questions));
        
        traverse(allQuestions);
    }

    state.mobileNavOpen = false;
    renderApp();
    // Scroll to top
    window.scrollTo(0,0);
}

// =============================================================================
// RENDERING SYSTEM
// =============================================================================

function renderFailure(msg) {
    document.getElementById('app').innerHTML = `
        <div class="flex items-center justify-center min-h-screen text-primary font-bold text-lg tracking-wide uppercase">
            ${msg}
        </div>
    `;
}

function renderApp() {
    const app = document.getElementById('app');
    
    // Shell Structure
    app.innerHTML = `
        <div class="w-full max-w-7xl mx-auto px-4 md:px-8 bg-frame min-h-screen shadow-sm">
            ${renderTopControls()}
            
            <div class="flex flex-col md:flex-row relative">
                <!-- Desktop Nav Rail -->
                <aside class="hidden md:block w-48 lg:w-64 flex-shrink-0 relative">
                    <div class="sticky top-0 pt-6 pb-12 max-h-screen overflow-y-auto no-scrollbar">
                        ${renderNavList(false)}
                    </div>
                </aside>

                <!-- Paper Content -->
                <main class="flex-1 w-full min-w-0 pt-6 pb-24 md:pl-12 lg:pl-16">
                    ${renderPaperBody()}
                </main>
            </div>
        </div>
        
        ${renderMobileDrawer()}
    `;

    // Post-Render Effects
    // 1. KaTeX
    renderMath(document.body);
    
    // 2. Event Listeners
    attachEventListeners();

    // 3. Scrollspy init
    initScrollSpy();
}

function renderTopControls() {
    if (!state.currentPaper) return '';
    
    const options = state.papers.map(p => 
        `<option value="${p.key}" ${p.key === state.currentPaper.key ? 'selected' : ''}>${p.label}</option>`
    ).join('');

    return `
        <div class="w-full py-4 border-b border-hairline flex items-center justify-between bg-frame sticky top-0 z-20 md:static">
            <div class="flex items-center gap-4">
                <div class="relative">
                    <select id="paper-selector" 
                        class="appearance-none bg-transparent font-medium text-primary py-2 pr-8 pl-1 cursor-pointer focus:outline-none focus-visible:ring-2 focus-visible:ring-accent rounded-sm">
                        ${options}
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-secondary">
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                </div>
            </div>

            <!-- Mobile Jump To Trigger -->
            <button id="mobile-nav-trigger" class="md:hidden text-accent-primary font-medium text-sm flex items-center gap-1 py-2 px-3 rounded-sm focus:outline-none focus-visible:ring-2 focus-visible:ring-accent">
                <span>Jump to</span>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
            </button>
        </div>
    `;
}

function renderNavList(isMobile) {
    if (!state.currentPaper) return '';
    
    const paper = state.currentPaper;
    let html = '<nav class="flex flex-col gap-6" aria-label="Question navigation">';

    // Helper to render items
    const renderItems = (questions) => {
        let out = '<div class="flex flex-col gap-1">'; // Gap-1 for items
        
        const traverse = (nodes) => {
            nodes.forEach(node => {
                const isActive = node.id === state.navActiveId;
                const isSub = node.id.length > 2; // Rough heuristic for hierarchy visual scale via typography
                
                // Typography hierarchy via scale/color, FLAT layout (no indent)
                const baseClass = "text-left py-1 px-1 rounded-sm block w-full truncate transition-colors duration-200 focus:outline-none focus-visible:ring-2 focus-visible:ring-accent";
                const activeClass = isActive ? "text-accent-primary font-bold" : "text-tertiary hover:text-primary font-medium";
                const sizeClass = isSub ? "text-xs" : "text-sm";
                
                // Add active marker if active (ColorLab D - Secondary allowed for nav marker)
                const marker = isActive ? `<span class="inline-block w-1 h-3 rounded-full bg-accent-secondary mr-2 align-middle"></span>` : '';

                out += `
                    <button 
                        data-target="${node.id}" 
                        class="nav-item ${baseClass} ${activeClass} ${sizeClass}"
                    >
                        ${marker}${node.id}
                    </button>
                `;
                
                if (node.children && node.children.length > 0) {
                    traverse(node.children);
                }
            });
        };
        
        traverse(questions);
        out += '</div>';
        return out;
    };

    if (paper.sections) {
        paper.sections.forEach(section => {
            // Render section label if present
            if (section.label && section.label.trim() !== "") {
                html += `
                    <div class="flex flex-col gap-2">
                        <div class="text-[10px] uppercase tracking-wider font-bold text-tertiary select-none px-1">
                            ${section.label}
                        </div>
                        ${renderItems(section.questions)}
                    </div>
                `;
            } else {
                // Section exists but no label
                html += renderItems(section.questions);
            }
        });
    } else if (paper.questions) {
        html += renderItems(paper.questions);
    }

    html += '</nav>';
    return html;
}

function renderMobileDrawer() {
    if (!state.mobileNavOpen) return '';
    
    return `
        <div class="fixed inset-0 z-50 flex justify-end">
            <!-- Scrim -->
            <div id="drawer-backdrop" class="absolute inset-0 bg-black/20 backdrop-blur-sm"></div>
            
            <!-- Drawer Surface -->
            <div class="relative w-64 h-full bg-page shadow-xl flex flex-col transform transition-transform">
                <div class="flex items-center justify-between p-4 border-b border-hairline bg-frame">
                    <h2 class="text-sm font-bold text-primary">Jump to</h2>
                    <button id="drawer-close" class="p-2 text-secondary hover:text-primary rounded-sm focus:outline-none focus-visible:ring-2 focus-visible:ring-accent">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <div class="flex-1 overflow-y-auto p-4 no-scrollbar">
                    ${renderNavList(true)}
                </div>
            </div>
        </div>
    `;
}

function renderPaperBody() {
    if (!state.currentPaper) return '';
    const paper = state.currentPaper;
    
    let html = '<div class="flex flex-col gap-16">'; // Top-level Question spacing (Largest unit)

    if (paper.sections) {
        paper.sections.forEach((section, idx) => {
            let sectionHtml = `<div class="flex flex-col gap-12">`;
            
            // Section Header (Structural Divider)
            if (section.label && section.label.trim() !== "") {
                sectionHtml += `
                    <div class="border-b border-hairline pb-2 mb-8">
                        <h2 class="text-xl font-bold text-primary">${section.label}</h2>
                    </div>
                `;
            }
            
            sectionHtml += section.questions.map(q => renderQuestionNode(q, 0)).join('<div class="h-px bg-hairline my-12 w-full md:w-1/2"></div>'); // Separator between top levels
            sectionHtml += `</div>`;
            html += sectionHtml;
            
            // Separator between sections
            if (idx < paper.sections.length - 1) {
                html += `<div class="h-12"></div>`; 
            }
        });
    } else {
        html += paper.questions.map(q => renderQuestionNode(q, 0)).join('<div class="my-16"></div>'); // Pure spacing
    }
    
    html += '</div>';
    return html;
}

function renderQuestionNode(node, depth) {
    const isTopLevel = depth === 0;
    const paddingLeft = depth > 0 ? 'pl-4 md:pl-8' : ''; // Indentation for children
    
    // Markdown rendering
    const qBody = md ? md.render(node.question || '') : node.question;
    
    // Check components
    const hasSolBlock = !!node.solutionBlock;
    const hasAnswer = hasSolBlock && !!node.solutionBlock.answer;
    const hasDetails = hasSolBlock && !!node.solutionBlock.solutionDetails;
    const isExpanded = state.expandedQs.has(node.id);
    
    let answerHtml = '';
    if (hasAnswer) {
        const answerBody = md ? md.render(node.solutionBlock.answer || '') : node.solutionBlock.answer;
        answerHtml = `
            <div class="mt-6 mb-2">
                <span class="text-xs font-bold text-tertiary uppercase tracking-wide block mb-1">Answer</span>
                <div class="text-base text-primary font-medium md-content">${answerBody}</div>
            </div>
        `;
    }

    let detailsHtml = '';
    let toggleHtml = '';

    if (hasDetails) {
        const sd = node.solutionBlock.solutionDetails;
        const btnText = isExpanded ? "Hide working" : "Show working";
        
        toggleHtml = `
            <div class="mt-4">
                <button 
                    onclick="toggleQuestion('${node.id}')"
                    class="text-sm font-medium text-accent-primary hover:text-primary transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-accent rounded-sm flex items-center gap-1 group"
                >
                    <span>${btnText}</span>
                    <svg class="w-4 h-4 transform transition-transform duration-200 ${isExpanded ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
            </div>
        `;

        if (isExpanded) {
            // Render sub-sections
            let content = '';
            
            // Keep in mind
            if (sd.keepInMind) {
                content += `
                    <div class="mb-6">
                        <div class="flex items-center gap-2 mb-2">
                            <svg class="w-4 h-4 text-tertiary" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            <h4 class="text-xs font-bold text-secondary uppercase tracking-wide">Keep in mind</h4>
                        </div>
                        <div class="md-content text-sm text-secondary">${md ? md.render(sd.keepInMind) : sd.keepInMind}</div>
                    </div>
                `;
            }
            
            // Formulas used
            if (sd.formulasUsed) {
                content += `
                    <div class="mb-6">
                        <h4 class="text-xs font-bold text-secondary uppercase tracking-wide mb-2">Formulas used</h4>
                        <div class="md-content text-sm text-secondary">${md ? md.render(sd.formulasUsed) : sd.formulasUsed}</div>
                    </div>
                `;
            }
            
            // Working (Primary)
            if (sd.working) {
                content += `
                    <div class="mb-6">
                        <h4 class="text-xs font-bold text-secondary uppercase tracking-wide mb-2">Working</h4>
                        <div class="md-content text-base text-secondary">${md ? md.render(sd.working) : sd.working}</div>
                    </div>
                `;
            }
            
            // Alternative Working
            if (sd.alternativeWorking && Array.isArray(sd.alternativeWorking)) {
                sd.alternativeWorking.forEach((alt, idx) => {
                    content += `
                        <div class="mt-8 pt-6 border-t border-hairline">
                            <h4 class="text-xs font-bold text-secondary uppercase tracking-wide mb-2">Alternative Working ${sd.alternativeWorking.length > 1 ? idx+1 : ''}</h4>
                            <div class="md-content text-base text-secondary">${md ? md.render(alt) : alt}</div>
                        </div>
                    `;
                });
            }

            // Solution Details Region (with Wash surface)
            detailsHtml = `
                <div class="mt-4 pt-4 pb-4 px-4 -mx-4 rounded-sm bg-wash border-l-2 border-hairline/50 animate-in fade-in slide-in-from-top-1 duration-200">
                    ${content}
                </div>
            `;
        }
    }

    // Children
    let childrenHtml = '';
    if (node.children && node.children.length > 0) {
        childrenHtml = `
            <div class="flex flex-col gap-6 mt-8 border-l border-hairline/50 ml-1">
                ${node.children.map(child => renderQuestionNode(child, depth + 1)).join('')}
            </div>
        `;
    }

    return `
        <article id="q-${node.id}" class="question-node scroll-mt-24 ${paddingLeft}">
            <!-- Question Body -->
            <div class="flex gap-4">
                <div class="flex-shrink-0 w-8 pt-1">
                    <span class="text-sm font-bold text-secondary select-none">${node.id}</span>
                </div>
                <div class="flex-1 min-w-0">
                    <div class="text-lg text-primary md-content leading-relaxed">${qBody}</div>
                    
                    <!-- Solution Block -->
                    ${hasSolBlock ? `
                        <div class="mt-2">
                            ${answerHtml}
                            ${toggleHtml}
                            ${detailsHtml}
                        </div>
                    ` : ''}
                </div>
            </div>

            <!-- Children -->
            ${childrenHtml}
        </article>
    `;
}

// =============================================================================
// INTERACTION LOGIC
// =============================================================================

function attachEventListeners() {
    // Paper Selector
    const selector = document.getElementById('paper-selector');
    if (selector) {
        selector.addEventListener('change', (e) => {
            selectPaper(e.target.value);
        });
    }

    // Mobile Nav
    const trigger = document.getElementById('mobile-nav-trigger');
    const close = document.getElementById('drawer-close');
    const backdrop = document.getElementById('drawer-backdrop');

    if (trigger) {
        trigger.addEventListener('click', () => {
            state.mobileNavOpen = true;
            renderApp(); // Re-render to show drawer
        });
    }
    
    // Close actions
    if (close) {
        close.addEventListener('click', closeDrawer);
    }
    if (backdrop) {
        backdrop.addEventListener('click', closeDrawer);
    }

    // Nav Links (Event Delegation)
    document.querySelectorAll('.nav-item').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.preventDefault();
            const targetId = btn.getAttribute('data-target');
            const el = document.getElementById(`q-${targetId}`);
            if (el) {
                closeDrawer();
                // Smooth scroll
                el.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        });
    });
}

function closeDrawer() {
    state.mobileNavOpen = false;
    const drawer = document.querySelector('.bg-page.shadow-xl'); // drawer surface
    if (drawer) {
        // Optional: wait for animation? For prototype, just re-render
    }
    renderApp();
}

// Global Toggle Function
window.toggleQuestion = (id) => {
    if (state.expandedQs.has(id)) {
        state.expandedQs.delete(id);
    } else {
        state.expandedQs.add(id);
    }
    
    // Re-render ONLY the specific node would be optimal, but full app re-render is safer for prototype simplicity 
    // to update DOM correctly with Markdown/KaTeX logic.
    // To prevent scroll jumping, we grab position?
    // Browser usually handles scroll conservation on re-render if height changes naturally.
    // However, full innerHTML replacement destroys scroll position.
    
    // Better strategy for Toggle: Re-render is tricky. 
    // Let's rely on scroll retention or use specific DOM updating.
    // For this prototype, let's use a "smart" re-render that replaces content but tries to restore scroll?
    // Or just re-render the specific question node's solution block?
    
    // Simplest robust prototype method: Save scroll Y, Render, Restore Scroll Y.
    const scrollY = window.scrollY;
    renderApp();
    window.scrollTo(0, scrollY);
};

// =============================================================================
// SCROLL SPY
// =============================================================================

function initScrollSpy() {
    if (!state.currentPaper) return;
    
    const observer = new IntersectionObserver((entries) => {
        // Find the visible entry closest to top
        // IntersectionObserver fires for all changes. We want the one that is currently "most" visible or top-most.
        
        // Simple logic: If an element is intersecting, make it active.
        // With nested questions, multiple intersect. We want the most specific (deepest) or top-most?
        // Let's just highlight the first intersecting one.
        
        const visible = entries.filter(e => e.isIntersecting).sort((a,b) => a.target.getBoundingClientRect().top - b.target.getBoundingClientRect().top);
        
        if (visible.length > 0) {
            const id = visible[0].target.id.replace('q-', '');
            if (state.navActiveId !== id) {
                state.navActiveId = id;
                updateNavHighlight();
            }
        }
    }, {
        rootMargin: '-10% 0px -80% 0px' // Active zone near top
    });

    document.querySelectorAll('.question-node').forEach(node => observer.observe(node));
}

function updateNavHighlight() {
    // We can do DOM manipulation here without full re-render
    document.querySelectorAll('.nav-item').forEach(btn => {
        const id = btn.getAttribute('data-target');
        const isActive = id === state.navActiveId;
        const markerSpan = `<span class="inline-block w-1 h-3 rounded-full bg-accent-secondary mr-2 align-middle"></span>`;
        
        if (isActive) {
            btn.classList.remove('text-tertiary', 'font-medium');
            btn.classList.add('text-accent-primary', 'font-bold');
            if (!btn.innerHTML.includes('span')) {
                btn.innerHTML = markerSpan + btn.innerText;
            }
        } else {
            btn.classList.add('text-tertiary', 'font-medium');
            btn.classList.remove('text-accent-primary', 'font-bold');
            // Remove marker
            const txt = btn.innerText; // strips html
            btn.innerHTML = txt; // Reset
        }
    });
}

// Start
init();

</script>
</body>
</html>
