<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AB","indexWithinVariant":"117","totalWithinVariant":"200","hueFamily":"amber","intensityMode":"","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-08T18:37:57.034Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AB&quot;,&quot;indexWithinVariant&quot;:&quot;117&quot;,&quot;totalWithinVariant&quot;:&quot;200&quot;,&quot;hueFamily&quot;:&quot;amber&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-08T18:37:57.034Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Viewer (Amber Lab)</title>
    
    <!-- TAILWIND CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- REACT & BABEL -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- LUCIDE ICONS -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- KATEX (No Integrity/SRI per instructions) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- MARKDOWN-IT (No Integrity/SRI per instructions) -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <!-- RUNTIME CONSTANTS & CONFIG -->
    <script>
        // --- STAGE 0: CONSTANTS ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // --- COLORLAB B PARAMETERS (Amber Hue Force) ---
        const RTQ_COLORLAB_FORCE_HUE_FAMILY = "amber";

        // --- MARKDOWN RENDERER CONFIGURATION ---
        // html: true (SVG passthrough), breaks: false (critical for KaTeX), linkify: true
        const md = window.markdownit ? window.markdownit({
            html: true,
            linkify: true,
            breaks: false 
        }) : null;

        if (md) {
            // Disable escape rule to preserve TeX backslashes
            md.inline.ruler.disable(['escape']);
        }

        // --- TAILWIND CONFIG (Amber Theme) ---
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Amber Hue Family forced for ColorLab B
                        accent: {
                            50: '#fffbeb',
                            100: '#fef3c7', // Selection / light washes
                            200: '#fde68a', // Dividers
                            300: '#fcd34d',
                            400: '#fbbf24',
                            500: '#f59e0b', // Focus ring
                            600: '#d97706', // Primary interactions
                            700: '#b45309', // Strong text / active states
                            800: '#92400e',
                            900: '#78350f',
                            950: '#451a03',
                        },
                        // Warm neutrals (Stone) to complement Amber
                        neutral: {
                            50: '#fafaf9',
                            100: '#f5f5f4',
                            200: '#e7e5e4',
                            300: '#d6d3d1',
                            400: '#a8a29e',
                            500: '#78716c',
                            600: '#57534e',
                            700: '#44403c', // Body text
                            800: '#292524', // Headings
                            900: '#1c1917', // Primary anchor
                            950: '#0c0a09',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    }
                }
            }
        };
    </script>

    <style>
        /* BASE STYLES & KATEX CONTAINMENT */
        body {
            background-color: #fafaf9; /* neutral-50 */
            color: #44403c; /* neutral-700 */
            -webkit-font-smoothing: antialiased;
        }

        /* Hide scrollbars for navigation but allow scrolling */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* MATH CONTAINMENT INVARIANT */
        /* Page-level overflow prevention */
        html, body {
            overflow-x: hidden;
            width: 100%;
        }

        /* Display Math Overflow */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding-bottom: 4px; /* Space for scrollbar if needed */
            margin-top: 0.5em;
            margin-bottom: 0.5em;
            /* Scrollbar styling for math */
            scrollbar-width: thin;
            scrollbar-color: #d6d3d1 transparent;
        }

        /* Inline Math Transparency */
        .katex {
            background-color: transparent !important;
        }

        /* Table Styling (Minimal) */
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.95em;
        }
        th, td {
            border: 1px solid #e7e5e4; /* neutral-200 */
            padding: 0.5rem;
            text-align: left;
        }
        th {
            font-weight: 600;
            color: #292524; /* neutral-800 */
        }

        /* Focus Visibility (Accessibility) */
        *:focus-visible {
            outline: 2px solid #f59e0b; /* accent-500 */
            outline-offset: 2px;
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;
        const { ChevronDown, ChevronRight, Menu, X, ArrowRight, Info } = lucide;

        // --- UTILS ---

        // Safe Markdown Rendering Component
        const MarkdownContent = ({ content, className = "", inline = false }) => {
            const containerRef = useRef(null);

            useEffect(() => {
                if (containerRef.current) {
                    // 1. Render Markdown to HTML
                    const rawHtml = md ? md.render(content || "") : (content || "");
                    containerRef.current.innerHTML = rawHtml;

                    // 2. Render KaTeX
                    renderMathInElement(containerRef.current, {
                        delimiters: [
                            {left: '$$', right: '$$', display: true},
                            {left: '$', right: '$', display: false},
                            {left: '\\(', right: '\\)', display: false},
                            {left: '\\[', right: '\\]', display: true}
                        ],
                        throwOnError: false,
                        trust: true // For html in math if needed, though mostly using Markdown's HTML
                    });
                }
            }, [content]);

            return <div ref={containerRef} className={`markdown-body ${className}`} />;
        };

        // --- COMPONENTS ---

        // 1. Navigation (Desktop Rail & Mobile Drawer)
        const Navigation = ({ 
            paper, 
            activeId, 
            onNavigate, 
            isMobile, 
            isOpen, 
            onClose 
        }) => {
            
            // Flatten logic for navigation rendering
            const renderNavItems = useMemo(() => {
                if (!paper) return [];

                const items = [];
                
                // Helper to determine text hierarchy via opacity/size, NOT indentation
                const getItemStyle = (depth) => {
                    if (depth === 0) return "text-sm font-medium";
                    if (depth === 1) return "text-sm font-normal text-neutral-600";
                    return "text-xs text-neutral-500";
                };

                const traverse = (nodes, depth = 0) => {
                    nodes.forEach(node => {
                        items.push({
                            id: node.id,
                            depth: depth,
                            style: getItemStyle(depth)
                        });
                        if (node.children) traverse(node.children, depth + 1);
                    });
                };

                if (paper.sections) {
                    paper.sections.forEach(section => {
                        if (section.label && section.label.trim() !== "") {
                            items.push({ type: 'section', label: section.label });
                        }
                        traverse(section.questions);
                    });
                } else if (paper.questions) {
                    traverse(paper.questions);
                }
                return items;
            }, [paper]);

            const NavContent = () => (
                <div className="flex flex-col gap-1 pb-20">
                    {renderNavItems.map((item, idx) => {
                        if (item.type === 'section') {
                            return (
                                <div key={`sec-${idx}`} className="mt-4 mb-2 first:mt-0 px-3">
                                    <span className="text-xs font-bold text-accent-800 uppercase tracking-wider select-none">
                                        Section {item.label}
                                    </span>
                                </div>
                            );
                        }

                        const isActive = activeId === item.id;
                        return (
                            <button
                                key={item.id}
                                onClick={() => {
                                    onNavigate(item.id);
                                    if (isMobile) onClose();
                                }}
                                className={`
                                    group flex items-center w-full px-3 py-1.5 text-left transition-colors duration-150 rounded-md
                                    ${isActive 
                                        ? "bg-accent-100 text-accent-900 font-semibold" 
                                        : "text-neutral-600 hover:bg-neutral-100 hover:text-neutral-900"}
                                `}
                            >
                                <span className={`${item.style} ${isActive ? 'text-accent-900' : ''}`}>
                                    {item.id}
                                </span>
                                {isActive && (
                                    <span className="ml-auto w-1.5 h-1.5 rounded-full bg-accent-500 block" aria-hidden="true" />
                                )}
                            </button>
                        );
                    })}
                </div>
            );

            if (isMobile) {
                if (!isOpen) return null;
                return (
                    <div className="fixed inset-0 z-50 flex flex-col bg-neutral-50/95 backdrop-blur-sm">
                        <div className="flex items-center justify-between p-4 border-b border-neutral-200">
                            <span className="font-semibold text-neutral-900">Jump to</span>
                            <button onClick={onClose} className="p-2 -mr-2 text-neutral-600">
                                <X size={24} />
                            </button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4">
                            <NavContent />
                        </div>
                    </div>
                );
            }

            // Desktop Sticky Rail
            return (
                <nav className="hidden lg:block w-64 h-[calc(100vh-4rem)] sticky top-16 overflow-y-auto no-scrollbar pr-4 border-r border-transparent">
                    <NavContent />
                </nav>
            );
        };

        // 2. Solution Details Components
        const SolutionDetailsRegion = ({ details, isExpanded }) => {
            if (!isExpanded || !details) return null;

            return (
                <div className="mt-4 animate-in fade-in slide-in-from-top-2 duration-200">
                    {/* Keep In Mind (Optional) */}
                    {details.keepInMind && (
                        <div className="mb-6">
                            <div className="flex items-baseline gap-2 mb-1 text-accent-800">
                                <span className="text-sm font-bold uppercase tracking-wide">Keep in mind</span>
                            </div>
                            <MarkdownContent 
                                content={details.keepInMind} 
                                className="text-neutral-700 text-sm leading-relaxed" 
                            />
                        </div>
                    )}

                    {/* Formulas Used (Optional) */}
                    {details.formulasUsed && (
                        <div className="mb-6">
                             <div className="mb-1 text-neutral-500">
                                <span className="text-xs font-bold uppercase tracking-wide">Formulas used</span>
                            </div>
                            <MarkdownContent 
                                content={details.formulasUsed} 
                                className="text-neutral-600 text-sm" 
                            />
                        </div>
                    )}

                    {/* Primary Working (Primary) */}
                    {details.working && (
                        <div className="mb-8">
                             <div className="mb-2 text-neutral-500">
                                <span className="text-xs font-bold uppercase tracking-wide">Working</span>
                            </div>
                            <div className="space-y-4">
                                <MarkdownContent 
                                    content={details.working} 
                                    className="text-neutral-800 text-base leading-relaxed" 
                                />
                            </div>
                        </div>
                    )}

                    {/* Alternative Working (0+) */}
                    {details.alternativeWorking && details.alternativeWorking.map((alt, idx) => (
                        <div key={idx} className="mt-8 pt-6 border-t border-accent-200">
                             <div className="mb-2 text-neutral-500">
                                <span className="text-xs font-bold uppercase tracking-wide">Alternative working</span>
                            </div>
                            <MarkdownContent 
                                content={alt} 
                                className="text-neutral-800 text-base leading-relaxed" 
                            />
                        </div>
                    ))}
                </div>
            );
        };

        // 3. Question Node (Recursive)
        const QuestionNode = ({ node, defaults, level = 0 }) => {
            const [isExpanded, setIsExpanded] = useState(
                defaults?.expandedAll !== false
            );
            
            const hasSolutionDetails = !!node.solutionBlock?.solutionDetails;
            const hasAnswer = !!node.solutionBlock?.answer;
            const hasSolutionBlock = hasAnswer || hasSolutionDetails;

            // Spacing rhythm hierarchy
            const verticalSpacing = level === 0 ? "mb-16" : "mb-8";
            const indentClass = level > 0 ? "lg:ml-8 ml-4 border-l-2 border-neutral-100 pl-4" : "";

            return (
                <div id={`q-${node.id}`} className={`${verticalSpacing} ${indentClass} scroll-mt-24`}>
                    
                    {/* Question Body */}
                    <div className="mb-4">
                        <div className="flex flex-row items-baseline gap-3">
                            <span className="text-neutral-500 font-medium text-sm select-none shrink-0 w-8">
                                {node.id}
                            </span>
                            <div className="flex-1 min-w-0">
                                <MarkdownContent 
                                    content={node.question} 
                                    className="text-neutral-900 font-medium text-lg leading-relaxed" 
                                />
                            </div>
                        </div>
                    </div>

                    {/* Solution Block */}
                    {hasSolutionBlock && (
                        <div className="ml-11"> {/* Align with question text */}
                            
                            {/* Answer */}
                            {hasAnswer && (
                                <div className="mb-3">
                                    <span className="text-xs font-bold text-neutral-500 uppercase tracking-wide mr-2">
                                        Answer
                                    </span>
                                    <div className="inline-block">
                                        <MarkdownContent 
                                            content={node.solutionBlock.answer} 
                                            className="text-neutral-800 font-semibold" 
                                            inline={true}
                                        />
                                    </div>
                                </div>
                            )}

                            {/* Show/Hide Toggle */}
                            {hasSolutionDetails && (
                                <div className="mt-2">
                                    <button 
                                        onClick={() => setIsExpanded(!isExpanded)}
                                        className="
                                            group flex items-center gap-1.5 text-sm font-medium text-accent-700 
                                            hover:text-accent-800 focus:outline-none rounded
                                        "
                                        aria-expanded={isExpanded}
                                        aria-controls={`details-${node.id}`}
                                    >
                                        <span className="group-hover:underline">
                                            {isExpanded ? "Hide working" : "Show working"}
                                        </span>
                                        {isExpanded ? <ChevronDown size={14} /> : <ChevronRight size={14} />}
                                    </button>

                                    {/* Collapsible Region */}
                                    <div id={`details-${node.id}`}>
                                        <SolutionDetailsRegion 
                                            details={node.solutionBlock.solutionDetails} 
                                            isExpanded={isExpanded} 
                                        />
                                    </div>
                                </div>
                            )}
                        </div>
                    )}

                    {/* Recursive Children */}
                    {node.children && node.children.length > 0 && (
                        <div className="mt-6">
                            {node.children.map(child => (
                                <QuestionNode key={child.id} node={child} defaults={defaults} level={level + 1} />
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        // 4. Main App
        const App = () => {
            const [payload, setPayload] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(false);
            const [activePaperKey, setActivePaperKey] = useState(null);
            const [activeNavId, setActiveNavId] = useState(null);
            const [isMobileNavOpen, setIsMobileNavOpen] = useState(false);

            useEffect(() => {
                fetch(RTQ_PAPERS_PAYLOAD_PATH)
                    .then(res => {
                        if (!res.ok) throw new Error("Missing payload");
                        return res.json();
                    })
                    .then(data => {
                        setPayload(data);
                        if (data.papers && data.papers.length > 0) {
                            setActivePaperKey(data.papers[0].key);
                        }
                        setLoading(false);
                    })
                    .catch(err => {
                        console.error(err);
                        setError(true);
                        setLoading(false);
                    });
            }, []);

            const activePaper = useMemo(() => {
                return payload?.papers?.find(p => p.key === activePaperKey);
            }, [payload, activePaperKey]);

            const handleNavigate = (id) => {
                setActiveNavId(id);
                const element = document.getElementById(`q-${id}`);
                if (element) {
                    element.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            };

            // Intersection Observer for Scroll Spy
            useEffect(() => {
                if (!activePaper) return;
                
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            // Extract 'q-' prefix
                            setActiveNavId(entry.target.id.substring(2));
                        }
                    });
                }, { rootMargin: '-10% 0px -80% 0px' });

                // Flatten IDs to observe
                const collectIds = (nodes) => {
                    nodes.forEach(n => {
                        const el = document.getElementById(`q-${n.id}`);
                        if (el) observer.observe(el);
                        if (n.children) collectIds(n.children);
                    });
                };

                if (activePaper.sections) {
                    activePaper.sections.forEach(s => collectIds(s.questions));
                } else if (activePaper.questions) {
                    collectIds(activePaper.questions);
                }

                return () => observer.disconnect();
            }, [activePaper]);


            if (loading) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-neutral-50 text-neutral-500">
                        Loading...
                    </div>
                );
            }

            if (error || !payload) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-neutral-50">
                        <div className="text-center">
                            <h1 className="text-2xl font-bold text-neutral-800 mb-2">PAPERS PAYLOAD MISSING</h1>
                            <p className="text-neutral-500">Could not load from {RTQ_PAPERS_PAYLOAD_PATH}</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen flex flex-col font-sans bg-neutral-50 text-neutral-900">
                    
                    {/* Top Controls / Header */}
                    <header className="sticky top-0 z-40 bg-neutral-50/95 backdrop-blur border-b border-neutral-200">
                        <div className="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
                            <div className="flex items-center gap-4">
                                {/* Mobile Toggle */}
                                <button 
                                    className="lg:hidden p-2 -ml-2 text-neutral-600"
                                    onClick={() => setIsMobileNavOpen(true)}
                                >
                                    <Menu size={24} />
                                </button>
                                
                                {/* Paper Selector */}
                                <div className="flex items-center gap-3">
                                    <label htmlFor="paper-select" className="sr-only">Select Paper</label>
                                    <select 
                                        id="paper-select"
                                        value={activePaperKey}
                                        onChange={(e) => setActivePaperKey(e.target.value)}
                                        className="
                                            bg-white border border-neutral-300 text-neutral-900 text-sm rounded-md 
                                            focus:ring-accent-500 focus:border-accent-500 block p-2
                                            shadow-sm
                                        "
                                    >
                                        {payload.papers.map(p => (
                                            <option key={p.key} value={p.key}>{p.label}</option>
                                        ))}
                                    </select>
                                </div>
                            </div>
                            
                            <div className="lg:hidden">
                                {/* Optional Right Header Item (e.g. Logo placeholder) */}
                            </div>
                        </div>
                    </header>

                    {/* DocumentFrameShell */}
                    <div className="flex-1 max-w-7xl mx-auto w-full flex items-start gap-8 px-4 pt-8 pb-32">
                        
                        {/* Left Column: Navigation (Desktop) */}
                        <Navigation 
                            paper={activePaper} 
                            activeId={activeNavId} 
                            onNavigate={handleNavigate}
                            isMobile={false}
                        />

                        {/* Mobile Drawer (Overlay) */}
                        <Navigation 
                            paper={activePaper} 
                            activeId={activeNavId} 
                            onNavigate={handleNavigate}
                            isMobile={true}
                            isOpen={isMobileNavOpen}
                            onClose={() => setIsMobileNavOpen(false)}
                        />

                        {/* Right Column: Paper Content */}
                        <main className="flex-1 min-w-0 max-w-3xl">
                            {/* Render Questions */}
                            {activePaper && (
                                <div className="space-y-16">
                                    {activePaper.sections ? (
                                        activePaper.sections.map((section, idx) => (
                                            <div key={idx}>
                                                {section.label && section.label.trim() !== "" && (
                                                    <div className="mb-8 pb-2 border-b border-neutral-200">
                                                        <h2 className="text-xl font-bold text-neutral-800">
                                                            Section {section.label}
                                                        </h2>
                                                    </div>
                                                )}
                                                <div>
                                                    {section.questions.map(q => (
                                                        <QuestionNode key={q.id} node={q} defaults={activePaper.defaults} />
                                                    ))}
                                                </div>
                                            </div>
                                        ))
                                    ) : (
                                        <div>
                                            {activePaper.questions.map(q => (
                                                <QuestionNode key={q.id} node={q} defaults={activePaper.defaults} />
                                            ))}
                                        </div>
                                    )}
                                </div>
                            )}
                        </main>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
