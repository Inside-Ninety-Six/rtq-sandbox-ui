<!DOCTYPE html>
<html lang="en" class="light">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AB","indexWithinVariant":"103","totalWithinVariant":"200","hueFamily":"teal","intensityMode":"","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-08T18:02:16.965Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AB&quot;,&quot;indexWithinVariant&quot;:&quot;103&quot;,&quot;totalWithinVariant&quot;:&quot;200&quot;,&quot;hueFamily&quot;:&quot;teal&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-08T18:02:16.965Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>

    <!-- Libraries via CDN (No SRI integrity as per Stage 6 instructions) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    
    <!-- KaTeX -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Markdown-it -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Tailwind Config for ColorLab B (Teal) + Light Mode Only -->
    <script>
        // RTQ_COLORLAB_FORCE_HUE_FAMILY = "teal" (Derived default)
        tailwind.config = {
            darkMode: 'class', // We will force 'light' class on html, effectively disabling dark mode
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    colors: {
                        // Semantic mapping to TEAL hue family
                        accent: {
                            50: '#f0fdfa',
                            100: '#ccfbf1',
                            200: '#99f6e4',
                            300: '#5eead4',
                            400: '#2dd4bf',
                            500: '#14b8a6',
                            600: '#0d9488', // Primary interaction
                            700: '#0f766e', // Hover / Focus
                            800: '#115e59',
                            900: '#134e4a',
                        },
                        // Surface / Neutrals (Soft-warm neutral base per Stage 5)
                        paper: {
                            bg: '#ffffff',
                            surface: '#ffffff', 
                            subtle: '#fafafa', // Very subtle differentiation
                            border: '#e2e8f0',
                        },
                        content: {
                            primary: '#0f172a', // Slate 900
                            secondary: '#334155', // Slate 700
                            tertiary: '#475569', // Slate 600
                            quiet: '#64748b', // Slate 500
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* CSS Reset & Functional Utilities */
        html, body {
            height: 100%;
            background-color: #f8fafc; /* Page background */
            color: #0f172a;
            -webkit-font-smoothing: antialiased;
        }

        /* Hide scrollbars for Nav but keep functionality */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* KaTeX Containment Invariant */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 4px; /* Space for scrollbar if needed */
        }
        
        /* Inline math background invariant */
        .katex {
            background-color: transparent !important;
        }

        /* Focus styles */
        .focus-ring {
            outline: none;
        }
        .focus-ring:focus-visible {
            outline: 2px solid #14b8a6; /* Accent 500 */
            outline-offset: 2px;
        }

        /* Markdown Content Styling */
        .md-content p {
            margin-bottom: 0.75em;
            line-height: 1.6;
        }
        .md-content p:last-child {
            margin-bottom: 0;
        }
        .md-content ul {
            list-style-type: disc;
            padding-left: 1.25em;
            margin-bottom: 0.75em;
        }
        .md-content ol {
            list-style-type: decimal;
            padding-left: 1.25em;
            margin-bottom: 0.75em;
        }
        .md-content table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 1em;
            font-size: 0.95em;
        }
        .md-content th, .md-content td {
            border: 1px solid #e2e8f0;
            padding: 0.5em;
            text-align: left;
        }
        .md-content th {
            font-weight: 600;
            background-color: transparent;
        }
        /* Tables inside Working overflow handling */
        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        /**
         * STAGE 0: CONSTANTS
         */
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        /**
         * Markdown Renderer Instance (Stage 6 Add-on)
         */
        const md = window.markdownit ? window.markdownit({
            html: true, // Allow inline SVG
            linkify: true,
            breaks: false, // Critical: MUST stay false for KaTeX
        }) : null;

        if (md) {
            // Disable inline escape to preserve TeX backslashes
            md.inline.ruler.disable(['escape']);
        }

        /**
         * React Components
         */
        const { useState, useEffect, useLayoutEffect, useRef, useMemo } = React;

        // Icon Components
        const ChevronRight = () => <i data-lucide="chevron-right" className="w-4 h-4"></i>;
        const ChevronDown = () => <i data-lucide="chevron-down" className="w-4 h-4"></i>;
        const MenuIcon = () => <i data-lucide="menu" className="w-5 h-5"></i>;
        const XIcon = () => <i data-lucide="x" className="w-5 h-5"></i>;
        const InfoIcon = () => <i data-lucide="info" className="w-4 h-4"></i>;

        // --- Utils ---

        function renderMarkdown(content) {
            if (!content) return { __html: '' };
            if (!md) return { __html: content }; // Fallback
            return { __html: md.render(content) };
        }

        // --- Payload Fetch Hook ---

        function usePayload() {
            const [data, setData] = useState(null);
            const [error, setError] = useState(false);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                fetch(RTQ_PAPERS_PAYLOAD_PATH)
                    .then(res => {
                        if (!res.ok) throw new Error("Network response not ok");
                        return res.json();
                    })
                    .then(jsonData => {
                        setData(jsonData);
                        setLoading(false);
                    })
                    .catch(err => {
                        console.error("Failed to load payload", err);
                        setError(true);
                        setLoading(false);
                    });
            }, []);

            return { data, error, loading };
        }

        // --- Components ---

        // 1. Markdown + KaTeX Container
        const MarkdownBlock = ({ content, className = "" }) => {
            const containerRef = useRef(null);

            useLayoutEffect(() => {
                if (containerRef.current && window.renderMathInElement) {
                    window.renderMathInElement(containerRef.current, {
                        delimiters: [
                            { left: "$$", right: "$$", display: true },
                            { left: "$", right: "$", display: false }
                        ],
                        throwOnError: false
                    });
                }
                lucide.createIcons();
            }, [content]);

            return (
                <div 
                    ref={containerRef}
                    className={`md-content ${className}`}
                    dangerouslySetInnerHTML={renderMarkdown(content)}
                />
            );
        };

        // 2. Navigation Components
        const Navigation = ({ paper, activeId, onItemClick, className = "" }) => {
            
            const renderNavItem = (question, depth = 0) => {
                const isActive = activeId === question.id;
                
                // Hierarchy via type scale/weight only (Stage 5.4.5)
                const fontSizeClass = depth === 0 ? "text-sm" : depth === 1 ? "text-xs" : "text-[11px]";
                const colorClass = isActive 
                    ? "text-accent-700 font-bold" 
                    : depth === 0 ? "text-content-secondary" : "text-content-tertiary";
                
                return (
                    <React.Fragment key={question.id}>
                        <button
                            onClick={() => onItemClick(question.id)}
                            className={`
                                w-full text-left py-1 px-3 mb-0.5 rounded
                                focus-ring transition-colors duration-150
                                ${fontSizeClass} ${colorClass}
                                hover:text-accent-700 hover:bg-accent-50
                            `}
                        >
                            {question.id}
                        </button>
                        {question.children && question.children.map(child => renderNavItem(child, depth + 1))}
                    </React.Fragment>
                );
            };

            const renderSection = (section, index) => {
                const showLabel = section.label && section.label.trim().length > 0;
                return (
                    <div key={index} className="mb-4">
                        {showLabel && (
                            <div className="px-3 py-1 mb-1 text-xs font-semibold text-content-quiet uppercase tracking-wider select-none border-b border-paper-border/50 pb-1">
                                {section.label}
                            </div>
                        )}
                        <div className="flex flex-col">
                            {section.questions.map(q => renderNavItem(q))}
                        </div>
                    </div>
                );
            };

            const renderFlatList = (questions) => (
                <div className="flex flex-col">
                    {questions.map(q => renderNavItem(q))}
                </div>
            );

            return (
                <nav className={`h-full overflow-y-auto no-scrollbar py-4 ${className}`}>
                    {paper.sections 
                        ? paper.sections.map((s, i) => renderSection(s, i))
                        : renderFlatList(paper.questions)
                    }
                </nav>
            );
        };

        // 3. Solution Details Subsections
        const KeepInMind = ({ content }) => {
            if (!content) return null;
            return (
                <div className="mb-4">
                    <div className="flex items-center gap-2 mb-1 text-accent-700 font-semibold text-sm">
                        <InfoIcon />
                        <span>Keep in mind</span>
                    </div>
                    <MarkdownBlock content={content} className="text-content-secondary text-sm" />
                </div>
            );
        };

        const FormulasUsed = ({ content }) => {
            if (!content) return null;
            return (
                <div className="mb-4">
                    <div className="mb-1 text-content-secondary font-semibold text-sm">Formulas used</div>
                    <MarkdownBlock content={content} className="text-content-tertiary text-sm" />
                </div>
            );
        };

        const WorkingBlock = ({ content }) => {
            if (!content) return null;
            return (
                <div className="mb-4">
                    <div className="mb-1 text-content-secondary font-semibold text-sm">Working</div>
                    <MarkdownBlock content={content} className="text-content-secondary text-sm" />
                </div>
            );
        };

        const AlternativeWorking = ({ workings }) => {
            if (!workings || workings.length === 0) return null;
            return (
                <div className="pt-2">
                    {workings.map((content, idx) => (
                        <div key={idx} className="mt-4 pt-4 border-t border-paper-border border-dashed">
                            <div className="mb-1 text-content-secondary font-semibold text-sm">Alternative working</div>
                            <MarkdownBlock content={content} className="text-content-secondary text-sm" />
                        </div>
                    ))}
                </div>
            );
        };

        // 4. Content Components
        const SolutionDetails = ({ details }) => {
            return (
                <div className="pt-2"> 
                    {/* Optional non-semantic wash or spacing could go here, keeping it minimal per Stage 5 */}
                    <KeepInMind content={details.keepInMind} />
                    <FormulasUsed content={details.formulasUsed} />
                    <WorkingBlock content={details.working} />
                    <AlternativeWorking workings={details.alternativeWorking} />
                </div>
            );
        };

        const SolutionBlock = ({ data, defaultExpanded }) => {
            // Logic: Toggle state
            const [isExpanded, setIsExpanded] = useState(defaultExpanded);
            const hasDetails = !!data.solutionDetails;
            const hasAnswer = !!data.answer;

            // Effect to reset state if prop changes (paper switch) would be handled by key at parent
            
            return (
                <div className="mt-4">
                    {/* Boundary: Question -> Solution Block (Spacing handled by mt-4) */}
                    
                    {hasAnswer && (
                        <div className="mb-3">
                            <span className="text-xs font-bold text-content-quiet uppercase tracking-wide mr-2">Answer</span>
                            <div className="inline-block align-top">
                                <MarkdownBlock content={data.answer} className="text-content-primary font-medium" />
                            </div>
                        </div>
                    )}

                    {hasDetails && (
                        <div className="mt-2">
                            <button 
                                onClick={() => setIsExpanded(!isExpanded)}
                                className="flex items-center gap-1 text-sm text-accent-600 hover:text-accent-700 font-medium focus-ring rounded px-1 -ml-1 py-1 transition-colors"
                                aria-expanded={isExpanded}
                            >
                                <span>{isExpanded ? "Hide working" : "Show working"}</span>
                                {isExpanded ? <ChevronDown /> : <ChevronRight />}
                            </button>

                            {isExpanded && (
                                <div className="mt-3 pl-0 animate-in fade-in slide-in-from-top-1 duration-200">
                                    <SolutionDetails details={data.solutionDetails} />
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        const QuestionNode = ({ node, level = 0, paperDefaults }) => {
            const hasSolutionBlock = !!node.solutionBlock;
            const shouldExpandAll = paperDefaults?.expandedAll !== false; // Default true unless false

            // Spacing rhythm based on level
            const verticalSpacing = level === 0 ? "mb-12" : level === 1 ? "mb-6" : "mb-4";
            
            return (
                <div id={node.id} className={`group ${verticalSpacing}`}>
                    {/* Question Body */}
                    <div className="flex flex-row gap-3">
                        <div className="flex-shrink-0 w-8 md:w-10 text-content-secondary font-semibold text-base md:text-lg select-none pt-0.5">
                            {node.id}
                        </div>
                        <div className="flex-grow min-w-0">
                            {/* Question Prompt */}
                            <div className="text-content-primary text-base md:text-lg leading-relaxed">
                                <MarkdownBlock content={node.question} />
                            </div>

                            {/* Solution Block */}
                            {hasSolutionBlock && (
                                <SolutionBlock 
                                    data={node.solutionBlock} 
                                    defaultExpanded={shouldExpandAll} 
                                />
                            )}

                            {/* Children */}
                            {node.children && node.children.length > 0 && (
                                <div className="mt-4 pl-0 md:pl-0"> 
                                    {/* Indentation handled via typography scale in Nav, 
                                        here we keep left alignment or minimal offset if strictly needed. 
                                        Stage 3 allows indentation spacing. We'll use minimal indent for children visual grouping. */}
                                    <div className="ml-0 md:ml-4 border-l-0 border-paper-border">
                                        {node.children.map(child => (
                                            <QuestionNode 
                                                key={child.id} 
                                                node={child} 
                                                level={level + 1} 
                                                paperDefaults={paperDefaults} 
                                            />
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                    {/* Top Level Separator (Stage 3 Option: Spacing is primary) */}
                    {level === 0 && <div className="h-px bg-transparent mt-12" />} 
                </div>
            );
        };

        const PaperView = ({ paper }) => {
            // Helper to flatten render list if needed, but we can iterate normally
            // Support Flat or Sectioned
            
            const renderQuestions = (questions) => (
                questions.map(q => (
                    <QuestionNode key={q.id} node={q} level={0} paperDefaults={paper.defaults} />
                ))
            );

            return (
                <div className="max-w-3xl mx-auto pb-32">
                    {/* Optional Paper Title if we wanted it, but brief says continuous doc. 
                        Top controls show selector. Here just content. */}
                    
                    {paper.sections ? (
                        paper.sections.map((section, idx) => (
                            <div key={idx} className="mb-16">
                                {section.label && section.label.trim() && (
                                    <div className="text-xl font-bold text-content-secondary mb-8 pb-2 border-b border-paper-border">
                                        Section {section.label}
                                    </div>
                                )}
                                {renderQuestions(section.questions)}
                            </div>
                        ))
                    ) : (
                        renderQuestions(paper.questions)
                    )}
                </div>
            );
        };

        // 5. Main App Shell
        const App = () => {
            const { data, error, loading } = usePayload();
            const [currentPaperIndex, setCurrentPaperIndex] = useState(0);
            const [mobileNavOpen, setMobileNavOpen] = useState(false);
            const [activeNavId, setActiveNavId] = useState(null);

            // Scroll to element helper
            const handleJump = (id) => {
                setMobileNavOpen(false);
                setActiveNavId(id);
                const el = document.getElementById(id);
                if (el) {
                    // Smooth scroll with offset for sticky headers if any
                    el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            };

            // Error State
            if (error) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-paper-bg text-content-primary font-sans">
                        <div className="text-center">
                            <h1 className="text-2xl font-bold mb-2">Error</h1>
                            <p>PAPERS PAYLOAD MISSING</p>
                        </div>
                    </div>
                );
            }

            // Loading State
            if (loading || !data) {
                return <div className="min-h-screen bg-paper-bg"></div>;
            }

            const currentPaper = data.papers[currentPaperIndex];

            return (
                <div className="flex flex-col h-screen bg-paper-bg font-sans text-content-primary overflow-hidden">
                    
                    {/* Top Controls Region */}
                    <div className="flex-none border-b border-paper-border bg-paper-surface z-20">
                        <div className="max-w-7xl mx-auto px-4 h-14 flex items-center justify-between">
                            
                            {/* Paper Selector */}
                            <div className="flex items-center gap-4">
                                <label htmlFor="paper-select" className="sr-only">Select Paper</label>
                                <select 
                                    id="paper-select"
                                    className="bg-transparent text-sm font-medium text-content-primary focus-ring rounded border border-paper-border py-1 px-2"
                                    value={currentPaperIndex}
                                    onChange={(e) => {
                                        setCurrentPaperIndex(Number(e.target.value));
                                        window.scrollTo(0,0);
                                        setActiveNavId(null);
                                    }}
                                >
                                    {data.papers.map((p, idx) => (
                                        <option key={p.key} value={idx}>{p.label}</option>
                                    ))}
                                </select>
                            </div>

                            {/* Mobile Nav Trigger */}
                            <div className="md:hidden">
                                <button 
                                    onClick={() => setMobileNavOpen(true)}
                                    className="flex items-center gap-2 text-sm font-medium text-accent-600 focus-ring rounded px-2 py-1"
                                >
                                    <span>Jump to</span>
                                    <MenuIcon />
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* DocumentFrameShell */}
                    <div className="flex-1 flex overflow-hidden max-w-7xl mx-auto w-full">
                        
                        {/* Desktop Navigation Rail (Sticky) */}
                        <aside className="hidden md:block w-64 flex-none border-r border-paper-border/50 bg-paper-surface h-full overflow-hidden">
                             <div className="h-full py-6 px-4">
                                <Navigation 
                                    paper={currentPaper} 
                                    activeId={activeNavId} 
                                    onItemClick={handleJump} 
                                />
                             </div>
                        </aside>

                        {/* Paper Content Column */}
                        <main className="flex-1 h-full overflow-y-auto bg-paper-surface scroll-smooth">
                            <div className="px-4 md:px-12 py-8 md:py-12 min-h-full">
                                <PaperView key={currentPaper.key} paper={currentPaper} />
                            </div>
                        </main>

                    </div>

                    {/* Mobile Navigation Drawer */}
                    {mobileNavOpen && (
                        <div className="fixed inset-0 z-50 flex justify-end md:hidden" role="dialog" aria-modal="true">
                            {/* Scrim */}
                            <div 
                                className="absolute inset-0 bg-black/20 backdrop-blur-sm transition-opacity" 
                                onClick={() => setMobileNavOpen(false)}
                            ></div>
                            
                            {/* Drawer */}
                            <div className="relative w-64 h-full bg-paper-surface shadow-2xl flex flex-col animate-in slide-in-from-right duration-200">
                                <div className="flex items-center justify-between p-4 border-b border-paper-border">
                                    <h2 className="text-lg font-bold text-content-primary">Jump to</h2>
                                    <button 
                                        onClick={() => setMobileNavOpen(false)}
                                        className="p-1 rounded-md text-content-secondary hover:bg-slate-100 focus-ring"
                                    >
                                        <XIcon />
                                    </button>
                                </div>
                                <div className="flex-1 overflow-y-auto p-4">
                                    <Navigation 
                                        paper={currentPaper} 
                                        activeId={activeNavId} 
                                        onItemClick={handleJump} 
                                    />
                                </div>
                            </div>
                        </div>
                    )}

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
