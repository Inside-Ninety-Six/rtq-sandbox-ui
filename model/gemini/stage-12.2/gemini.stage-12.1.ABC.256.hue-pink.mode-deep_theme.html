<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"ABC","indexWithinVariant":"256","totalWithinVariant":"320","hueFamily":"pink","intensityMode":"deep_theme","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-09T22:14:55.987Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;ABC&quot;,&quot;indexWithinVariant&quot;:&quot;256&quot;,&quot;totalWithinVariant&quot;:&quot;320&quot;,&quot;hueFamily&quot;:&quot;pink&quot;,&quot;intensityMode&quot;:&quot;deep_theme&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-09T22:14:55.987Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer (Stage 6 Baseline - ColorLab B/C)</title>

    <!-- 1. External Libraries (No Integrity Attributes per Stage 6.0.7b) -->
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- KaTeX -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Markdown-it -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <!-- 2. ColorLab & Tailwind Config -->
    <script>
        // RTQ_COLORLAB_FORCE_HUE_FAMILY = "pink"
        // RTQ_COLORLAB_INTENSITY_MODE = "deep_theme"
        // Target OKLCH values derived from Deep Theme constraints (Light Mode)

        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Deep Theme: Strong chroma + surface separation
                        // Hue: 350 (Pink)
                        page: 'oklch(0.94 0.12 350)',    // L[0.92-0.98], C[0.08-0.16]
                        frame: 'oklch(0.91 0.12 350)',   // L[0.90-0.96], C[0.08-0.16], distinguishable from page
                        paper: 'oklch(0.97 0.09 350)',   // L[0.94-0.99], C[0.06-0.14]
                        
                        // Text: High legibility, mostly neutral
                        primary: 'oklch(0.20 0.015 350)',   // L[0.15-0.25], C<=0.015
                        secondary: 'oklch(0.35 0.02 350)',  // L[0.25-0.40], C<=0.020
                        
                        // Accent: Restrained usage (links, focus, toggles)
                        accent: 'oklch(0.55 0.22 350)',     // L[0.45-0.65], C[0.16-0.26]
                        
                        // Surfaces
                        wash: 'oklch(0.95 0.06 350)',       // Solution Details wash
                        divider: 'oklch(0.85 0.04 350)',    // Low chroma
                    },
                    fontFamily: {
                        sans: ['system-ui', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif'],
                    },
                    spacing: {
                        'q-gap': '3rem', // Top level question gap
                    }
                }
            }
        }
    </script>

    <style>
        /* CSS Reset & Utilities */
        body {
            /* Enforce base color semantics */
            background-color: theme('colors.page');
            color: theme('colors.primary');
        }

        /* Scrollbar hiding for navigation (Stage 6 Add-on) */
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* KaTeX Containment Invariant (Stage 5.8 / 6.0.8) */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding: 0.5em 0;
            /* Scrollbar styling for math blocks */
            scrollbar-width: thin;
            scrollbar-color: theme('colors.divider') transparent;
        }
        
        /* Math block scrollbar webkit */
        .katex-display::-webkit-scrollbar {
            height: 4px;
        }
        .katex-display::-webkit-scrollbar-thumb {
            background-color: theme('colors.divider');
            border-radius: 4px;
        }

        /* Focus Ring Customization */
        *:focus-visible {
            outline: 2px solid theme('colors.accent');
            outline-offset: 2px;
        }

        /* Markdown Table Minimal Styling */
        table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 1em;
            font-size: 0.95em;
        }
        th, td {
            border: 1px solid theme('colors.divider');
            padding: 0.5rem;
            text-align: left;
        }
        th {
            font-weight: 600;
            color: theme('colors.primary');
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // ----------------------------------------------------------------------
        // STAGE 0: CONSTANTS (Canonical)
        // ----------------------------------------------------------------------
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // ----------------------------------------------------------------------
        // Utilities & Markdown Setup
        // ----------------------------------------------------------------------
        
        // Setup Markdown-it (Stage 6.1 config)
        const md = window.markdownit ? window.markdownit({
            html: true,     // Allow inline SVG passthrough
            linkify: true,
            breaks: false,  // CRITICAL: Must be false to preserve math
        }) : null;

        if (md) {
            // Disable escape rule to preserve TeX backslashes
            md.inline.ruler.disable(['escape']);
        }

        // ----------------------------------------------------------------------
        // Components
        // ----------------------------------------------------------------------

        // --- Layout Shell ---
        
        const DocumentFrameShell = ({ children }) => {
            return (
                <div className="min-h-screen w-full flex flex-col items-center py-6 px-4 md:px-6">
                    {/* The Shell Container */}
                    <div className="w-full max-w-[1024px] bg-frame rounded-sm min-h-[90vh] shadow-sm flex flex-col md:flex-row relative">
                        {children}
                    </div>
                </div>
            );
        };

        const TopControls = ({ papers, selectedPaperKey, onSelectPaper, onOpenNav }) => {
            return (
                <div className="md:absolute md:top-0 md:left-0 md:w-[240px] w-full p-4 z-20 flex justify-between items-center md:block border-b md:border-b-0 border-divider">
                    <select 
                        className="bg-paper border border-divider rounded px-2 py-1 text-sm text-primary w-full max-w-[200px] focus:outline-none focus-visible:ring-2 focus-visible:ring-accent"
                        value={selectedPaperKey || ""}
                        onChange={(e) => onSelectPaper(e.target.value)}
                        aria-label="Select paper"
                    >
                        {papers.map(p => (
                            <option key={p.key} value={p.key}>{p.label}</option>
                        ))}
                    </select>

                    {/* Mobile Jump To Trigger */}
                    <button 
                        className="md:hidden text-sm font-medium text-accent hover:underline px-2"
                        onClick={onOpenNav}
                    >
                        Jump to
                    </button>
                </div>
            );
        };

        // --- Navigation ---

        const NavigationRail = ({ items, sections, currentId }) => {
            // Desktop sticky rail
            return (
                <div className="hidden md:block w-[240px] flex-shrink-0 border-r border-divider relative">
                    <div className="sticky top-0 max-h-screen overflow-y-auto no-scrollbar pt-20 pb-10 px-4">
                        <NavList items={items} sections={sections} currentId={currentId} />
                    </div>
                </div>
            );
        };

        const NavigationDrawer = ({ isOpen, onClose, items, sections, currentId }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex justify-end md:hidden">
                    {/* Scrim */}
                    <div className="absolute inset-0 bg-primary/20 backdrop-blur-sm" onClick={onClose}></div>
                    
                    {/* Drawer Content */}
                    <div className="relative w-[280px] h-full bg-frame shadow-xl flex flex-col">
                        <div className="p-4 border-b border-divider flex justify-between items-center">
                            <span className="font-bold text-sm text-secondary">Jump to</span>
                            <button onClick={onClose} className="text-accent text-sm font-medium p-2">Close</button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4">
                            <NavList items={items} sections={sections} currentId={currentId} onItemClick={onClose} />
                        </div>
                    </div>
                </div>
            );
        };

        const NavList = ({ items, sections, currentId, onItemClick }) => {
            // Flatten list based on sections if present
            // Logic: If sections exist, render Section Label -> Items. 
            // If no sections, just render Items.
            
            const handleJump = (id) => {
                const el = document.getElementById(`q-${id}`);
                if (el) {
                    el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    if (onItemClick) onItemClick();
                }
            };

            const isCurrent = (id) => currentId === id;

            // Helper to render a flat list of items
            const RenderItems = ({ questionList }) => (
                <ul className="space-y-1">
                    {questionList.map(q => (
                        <li key={q.id}>
                            <button
                                onClick={() => handleJump(q.id)}
                                className={`text-left w-full text-sm py-0.5 transition-colors
                                    ${isCurrent(q.id) ? 'font-bold text-accent' : 'text-secondary hover:text-primary'}
                                    ${q.depth > 0 ? 'text-xs opacity-90' : ''} 
                                `}
                                style={{
                                    // Visual hierarchy via type scale/weight only, NO indentation (Stage 5.4.5)
                                    fontSize: q.depth > 0 ? '0.85em' : '1em',
                                    paddingLeft: 0 
                                }}
                            >
                                {q.id}
                            </button>
                        </li>
                    ))}
                </ul>
            );

            if (sections && sections.length > 0) {
                return (
                    <div className="space-y-6">
                        {sections.map((sec, idx) => (
                            <div key={idx}>
                                {sec.label && (
                                    <div className="text-xs font-bold text-secondary uppercase tracking-wider mb-2 opacity-70">
                                        {sec.label}
                                    </div>
                                )}
                                <RenderItems questionList={flattenQuestions(sec.questions)} />
                            </div>
                        ))}
                    </div>
                );
            }

            return <RenderItems questionList={items} />;
        };

        // --- Paper Content ---

        const PaperView = ({ paperData, currentPaper }) => {
            // Derive flat list for rendering or render recursively?
            // The Grammar requires recursive structure for nesting.
            
            const questions = paperData.questions || [];
            const sections = paperData.sections || [];

            // Effect: KaTeX Auto-render after paint
            React.useEffect(() => {
                if (window.renderMathInElement) {
                    window.renderMathInElement(document.getElementById('paper-content'), {
                        delimiters: [
                            {left: '$$', right: '$$', display: true},
                            {left: '$', right: '$', display: false}
                        ],
                        throwOnError: false
                    });
                }
            });

            return (
                <div id="paper-content" className="flex-1 bg-paper p-6 md:p-12 min-h-full">
                    {paperData.questions ? (
                        <QuestionList questions={paperData.questions} defaults={paperData.defaults} />
                    ) : (
                        <div className="space-y-12">
                            {paperData.sections.map((sec, i) => (
                                <div key={i} className="space-y-8">
                                    {sec.label && (
                                        <div className="border-b border-divider pb-2 mb-8">
                                            <h2 className="text-lg font-bold text-secondary">{sec.label}</h2>
                                        </div>
                                    )}
                                    <QuestionList questions={sec.questions} defaults={paperData.defaults} />
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        const QuestionList = ({ questions, defaults }) => {
            return (
                <div className="space-y-q-gap">
                    {questions.map((q, i) => (
                        <QuestionNode key={q.id} node={q} defaults={defaults} isTopLevel={true} />
                    ))}
                </div>
            );
        };

        const QuestionNode = ({ node, defaults, isTopLevel }) => {
            // Determine if Solution Block exists
            const hasSolutionBlock = !!node.solutionBlock;
            const hasAnswer = hasSolutionBlock && !!node.solutionBlock.answer;
            const hasDetails = hasSolutionBlock && !!node.solutionBlock.solutionDetails;

            // State for expansion
            // Default: expanded unless paper.defaults.expandedAll === false
            const [expanded, setExpanded] = React.useState(() => {
                if (!hasDetails) return false;
                if (defaults && defaults.expandedAll === false) return false;
                return true;
            });

            const toggle = () => setExpanded(!expanded);

            // Render Markdown Safe
            const renderMD = (content) => {
                if (!md || !content) return { __html: content || "" };
                return { __html: md.render(content) };
            };

            return (
                <div id={`q-${node.id}`} className="group scroll-mt-24">
                    {/* Question Body */}
                    <div className="mb-4">
                        <div className="flex flex-row items-baseline gap-3">
                            <span className="font-bold text-secondary text-sm select-none flex-shrink-0">{node.id}</span>
                            <div 
                                className="prose prose-p:my-2 prose-ul:my-2 prose-table:my-2 max-w-none text-primary leading-relaxed"
                                dangerouslySetInnerHTML={renderMD(node.question)}
                            />
                        </div>
                    </div>

                    {/* Solution Block (Optional) */}
                    {hasSolutionBlock && (
                        <div className="ml-0 pl-0 md:ml-[2.5rem] mt-3">
                            
                            {/* Answer (Visible by default) */}
                            {hasAnswer && (
                                <div className="mb-3">
                                    <div className="text-xs font-bold text-secondary uppercase tracking-wide mb-1">Answer</div>
                                    <div 
                                        className="text-primary font-medium"
                                        dangerouslySetInnerHTML={renderMD(node.solutionBlock.answer)}
                                    />
                                </div>
                            )}

                            {/* Solution Details (Expandable) */}
                            {hasDetails && (
                                <div className="mt-4">
                                    {/* Toggle */}
                                    <button 
                                        onClick={toggle}
                                        className="text-sm font-medium text-accent hover:text-accent/80 focus:outline-none focus-visible:ring-2 focus-visible:ring-accent rounded px-1 -ml-1 flex items-center gap-1 transition-colors"
                                        aria-expanded={expanded}
                                    >
                                        <span>{expanded ? "Hide working" : "Show working"}</span>
                                        <svg className={`w-4 h-4 transform transition-transform ${expanded ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" /></svg>
                                    </button>

                                    {/* Content Region */}
                                    {expanded && (
                                        <div className="mt-3 pl-4 border-l border-divider bg-wash rounded-sm py-3 pr-3 text-sm animate-in fade-in slide-in-from-top-1 duration-200">
                                            <SolutionDetailsContent details={node.solutionBlock.solutionDetails} renderMD={renderMD} />
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    )}

                    {/* Children Container */}
                    {node.children && node.children.length > 0 && (
                        <div className="mt-4 ml-4 md:ml-8 space-y-6 border-l border-transparent">
                            {node.children.map(child => (
                                <QuestionNode key={child.id} node={child} defaults={defaults} isTopLevel={false} />
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        const SolutionDetailsContent = ({ details, renderMD }) => {
            const { keepInMind, formulasUsed, working, alternativeWorking } = details;

            return (
                <div className="space-y-5">
                    {/* Keep in mind */}
                    {keepInMind && (
                        <div className="space-y-1">
                            <h4 className="font-bold text-secondary text-xs uppercase">Keep in mind</h4>
                            <div className="prose prose-sm max-w-none text-secondary" dangerouslySetInnerHTML={renderMD(keepInMind)} />
                        </div>
                    )}

                    {/* Formulas used */}
                    {formulasUsed && (
                        <div className="space-y-1">
                            <h4 className="font-bold text-secondary text-xs uppercase">Formulas used</h4>
                            <div className="prose prose-sm max-w-none text-secondary opacity-90" dangerouslySetInnerHTML={renderMD(formulasUsed)} />
                        </div>
                    )}

                    {/* Working (Primary) */}
                    {working && (
                        <div className="space-y-2">
                             <h4 className="font-bold text-secondary text-xs uppercase">Working</h4>
                             <div className="prose prose-sm max-w-none text-primary" dangerouslySetInnerHTML={renderMD(working)} />
                        </div>
                    )}

                    {/* Alternative Working */}
                    {alternativeWorking && (
                        <div className="pt-2 border-t border-divider/50 mt-4">
                            <h4 className="font-bold text-secondary text-xs uppercase mb-2">Alternative working</h4>
                            {Array.isArray(alternativeWorking) ? (
                                alternativeWorking.map((alt, idx) => (
                                    <div key={idx} className="mb-4 prose prose-sm max-w-none text-primary" dangerouslySetInnerHTML={renderMD(alt)} />
                                ))
                            ) : (
                                <div className="prose prose-sm max-w-none text-primary" dangerouslySetInnerHTML={renderMD(alternativeWorking)} />
                            )}
                        </div>
                    )}
                </div>
            );
        };


        // --- Helper: Flatten Tree for Nav ---
        const flattenQuestions = (nodes, depth = 0) => {
            let list = [];
            nodes.forEach(node => {
                list.push({ id: node.id, depth });
                if (node.children) {
                    list = list.concat(flattenQuestions(node.children, depth + 1));
                }
            });
            return list;
        };

        const getNavItemsFromPaper = (paper) => {
            if (!paper) return { items: [], sections: [] };
            if (paper.sections) {
                // Return sections as is, inner questions needed flattening for display? 
                // NavList handles sections array.
                return { items: [], sections: paper.sections };
            }
            return { items: flattenQuestions(paper.questions), sections: [] };
        };


        // --- Main App ---

        const App = () => {
            const [payload, setPayload] = React.useState(null);
            const [loading, setLoading] = React.useState(true);
            const [error, setError] = React.useState(false);
            const [selectedPaperKey, setSelectedPaperKey] = React.useState(null);
            const [isNavOpen, setIsNavOpen] = React.useState(false);

            React.useEffect(() => {
                fetch(RTQ_PAPERS_PAYLOAD_PATH)
                    .then(res => {
                        if (!res.ok) throw new Error("Fetch failed");
                        return res.json();
                    })
                    .then(data => {
                        setPayload(data);
                        if (data.papers && data.papers.length > 0) {
                            setSelectedPaperKey(data.papers[0].key);
                        }
                        setLoading(false);
                    })
                    .catch(err => {
                        console.error(err);
                        setError(true);
                        setLoading(false);
                    });
            }, []);

            if (loading) return <div className="flex h-screen items-center justify-center text-secondary">Loading Paper...</div>;
            if (error || !payload) return <div className="flex h-screen items-center justify-center text-accent font-bold">PAPERS PAYLOAD MISSING</div>;

            const currentPaper = payload.papers.find(p => p.key === selectedPaperKey);
            const { items: navItems, sections: navSections } = getNavItemsFromPaper(currentPaper);

            return (
                <DocumentFrameShell>
                    {/* Top Controls (Paper Selector + Mobile Jump) */}
                    <TopControls 
                        papers={payload.papers} 
                        selectedPaperKey={selectedPaperKey} 
                        onSelectPaper={setSelectedPaperKey}
                        onOpenNav={() => setIsNavOpen(true)}
                    />

                    {/* Desktop Nav Rail */}
                    <NavigationRail items={navItems} sections={navSections} currentId={null} />

                    {/* Mobile Nav Drawer */}
                    <NavigationDrawer 
                        isOpen={isNavOpen} 
                        onClose={() => setIsNavOpen(false)} 
                        items={navItems} 
                        sections={navSections}
                        currentId={null}
                    />

                    {/* Main Content */}
                    <PaperView paperData={currentPaper} />

                </DocumentFrameShell>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
