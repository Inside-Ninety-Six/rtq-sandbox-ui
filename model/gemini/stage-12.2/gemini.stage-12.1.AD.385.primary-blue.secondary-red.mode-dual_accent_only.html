<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AD","indexWithinVariant":"385","totalWithinVariant":"440","hueFamily":"","intensityMode":"","primaryHueFamily":"blue","secondaryHueFamily":"red","dualIntensityMode":"dual_accent_only","timestamp":"2026-01-10T23:44:51.254Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AD&quot;,&quot;indexWithinVariant&quot;:&quot;385&quot;,&quot;totalWithinVariant&quot;:&quot;440&quot;,&quot;hueFamily&quot;:&quot;&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;primaryHueFamily&quot;:&quot;blue&quot;,&quot;secondaryHueFamily&quot;:&quot;red&quot;,&quot;dualIntensityMode&quot;:&quot;dual_accent_only&quot;,&quot;timestamp&quot;:&quot;2026-01-10T23:44:51.254Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>

    <!-- FONTS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- LIBRARIES (SRI Disabled per Stage 6.0.7b) -->
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- KaTeX -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Markdown-it -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* --- STAGE 0: CONSTANTS & COLORLAB D VARIABLES --- */
        :root {
            /* COLORLAB D: DUAL-ACCENT PALETTE (LIGHT ONLY) */
            /* Mode: dual_accent_only */
            /* Hues: Primary=Blue, Secondary=Amber (Defaults picked per instructions) */

            /* PRIMARY HUE (Blue): 250deg */
            /* SECONDARY HUE (Amber): 85deg */

            /* Surfaces (C <= 0.015) */
            --col-surface-page: oklch(0.97 0.005 250);
            --col-surface-frame: oklch(0.97 0.005 250); /* Shared base surface desktop */
            --col-surface-paper: oklch(1.0 0 0);
            --col-surface-wash: oklch(0.98 0.01 250); /* Subtle wash for expanded details */
            
            /* Text (C <= 0.010) */
            --col-text-primary: oklch(0.20 0.01 250);
            --col-text-secondary: oklch(0.45 0.01 250);
            --col-text-tertiary: oklch(0.60 0.005 250); /* Nav quiet */

            /* Lines */
            --col-line-hairline: oklch(0.90 0.005 250);
            --col-line-border: oklch(0.85 0.01 250);

            /* Accents (Primary: Blue) */
            --col-accent-primary: oklch(0.50 0.14 250); /* Links, Focus, Toggles */
            --col-accent-primary-hover: oklch(0.45 0.14 250);
            
            /* Accents (Secondary: Amber) - Single supplementary role (Nav marker) */
            --col-accent-secondary: oklch(0.70 0.14 85); 
        }

        /* --- BASE STYLES --- */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--col-surface-page);
            color: var(--col-text-primary);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        /* --- LAYOUT UTILS --- */
        .hide-scrollbar {
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none;  /* IE 10+ */
        }
        .hide-scrollbar::-webkit-scrollbar { 
            display: none; /* Chrome/Safari */
        }

        /* --- KATEX CONTAINMENT INVARIANT (Stage 6.0.8) --- */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 4px; /* Space for scrollbar */
        }
        
        /* Block math underlay allowed per Stage 3 */
        .katex-display > .katex {
            background-color: transparent; /* No background by default */
        }

        /* Inline math: NO background, NO overflow */
        .katex {
            font-size: 1.1em;
        }

        /* Markdown Content Styling */
        .md-content p {
            margin-bottom: 1rem;
        }
        .md-content p:last-child {
            margin-bottom: 0;
        }
        .md-content ul {
            list-style-type: disc;
            padding-left: 1.5rem;
            margin-bottom: 1rem;
        }
        .md-content ol {
            list-style-type: decimal;
            padding-left: 1.5rem;
            margin-bottom: 1rem;
        }
        /* Tables (Stage 5.8.5 - Minimal) */
        .md-content table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
            display: block;
            overflow-x: auto;
        }
        .md-content th, .md-content td {
            border: 1px solid var(--col-line-hairline);
            padding: 0.5rem;
            text-align: left;
        }
        .md-content th {
            font-weight: 600;
        }

        /* Navigation Active State */
        .nav-item.active {
            font-weight: 700;
            color: var(--col-text-primary);
            position: relative;
        }
        /* Secondary Accent Marker */
        .nav-item.active::before {
            content: '';
            position: absolute;
            left: -12px;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background-color: var(--col-accent-secondary);
        }

        /* Focus Styles (Stage 5.5.2) */
        :focus-visible {
            outline: 2px solid var(--col-accent-primary);
            outline-offset: 2px;
        }

        /* Disclosure Control */
        .disclosure-control {
            color: var(--col-accent-primary);
            cursor: pointer;
            user-select: none;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-weight: 500;
            font-size: 0.875rem;
        }
        .disclosure-control:hover {
            color: var(--col-accent-primary-hover);
            text-decoration: underline;
        }

    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- TOP CONTROLS REGION -->
    <div id="top-controls" class="w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex items-center justify-between z-40 relative">
        <!-- Paper Selector -->
        <div class="flex items-center">
            <label for="paper-select" class="sr-only">Select Paper</label>
            <select id="paper-select" class="bg-transparent border border-[var(--col-line-border)] text-[var(--col-text-primary)] text-sm rounded px-3 py-2 focus:ring-1 focus:ring-[var(--col-accent-primary)] outline-none cursor-pointer">
                <option value="" disabled selected>Loading papers...</option>
            </select>
        </div>

        <!-- Mobile Jump To Trigger -->
        <button id="mobile-jump-trigger" class="lg:hidden text-[var(--col-accent-primary)] text-sm font-medium flex items-center gap-2">
            <span>Jump to</span>
            <i data-lucide="menu" class="w-5 h-5"></i>
        </button>
    </div>

    <!-- DOCUMENT FRAME SHELL -->
    <div class="flex-1 w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex relative">
        
        <!-- NAVIGATION RAIL (Desktop) -->
        <!-- Sticky, scrollable if too long, hide scrollbar -->
        <aside class="hidden lg:block w-48 shrink-0 sticky top-4 h-[calc(100vh-2rem)] overflow-y-auto hide-scrollbar pr-4 pb-10">
            <nav id="desktop-nav" class="flex flex-col gap-1 text-sm text-[var(--col-text-secondary)]">
                <!-- Injected via JS -->
            </nav>
        </aside>

        <!-- PAPER CONTENT COLUMN -->
        <main id="paper-region" class="flex-1 w-full lg:pl-12 pb-20">
            <!-- Paper Container -->
            <div id="paper-surface" class="bg-[var(--col-surface-paper)] min-h-[500px] w-full max-w-3xl">
                <div id="paper-content" class="flex flex-col">
                    <!-- Questions injected via JS -->
                    <div class="p-10 text-[var(--col-text-secondary)] text-center">Loading content...</div>
                </div>
            </div>
        </main>

    </div>

    <!-- MOBILE DRAWER (Jump to) -->
    <div id="mobile-drawer-backdrop" class="fixed inset-0 bg-black/20 backdrop-blur-sm z-50 hidden transition-opacity opacity-0" aria-hidden="true"></div>
    <div id="mobile-drawer" class="fixed inset-y-0 right-0 w-64 bg-[var(--col-surface-page)] z-50 transform translate-x-full transition-transform duration-300 ease-in-out shadow-xl flex flex-col" aria-hidden="true">
        <div class="p-4 flex items-center justify-between border-b border-[var(--col-line-hairline)]">
            <h2 class="text-sm font-semibold text-[var(--col-text-primary)]">Jump to</h2>
            <button id="drawer-close" class="text-[var(--col-text-secondary)] hover:text-[var(--col-text-primary)] p-1">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>
        <div class="flex-1 overflow-y-auto p-4">
            <nav id="mobile-nav" class="flex flex-col gap-2 text-sm text-[var(--col-text-secondary)]">
                <!-- Injected via JS -->
            </nav>
        </div>
    </div>

    <script>
        // --- STAGE 0: CONSTANTS (AUTHORITATIVE) ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // --- STATE ---
        let rawPayload = null;
        let activePaperKey = null;
        let activePaperData = null;
        
        // --- DOM ELEMENTS ---
        const els = {
            paperSelect: document.getElementById('paper-select'),
            paperContent: document.getElementById('paper-content'),
            desktopNav: document.getElementById('desktop-nav'),
            mobileNav: document.getElementById('mobile-nav'),
            mobileJumpTrigger: document.getElementById('mobile-jump-trigger'),
            mobileDrawer: document.getElementById('mobile-drawer'),
            mobileDrawerBackdrop: document.getElementById('mobile-drawer-backdrop'),
            drawerClose: document.getElementById('drawer-close')
        };

        // --- MARKDOWN INIT (Stage 6 Add-on) ---
        const md = window.markdownit ? window.markdownit({
            html: true,
            linkify: true,
            breaks: false // MUST be false for KaTeX
        }) : null;

        if (md) {
            md.inline.ruler.disable(['escape']); // Preserve TeX backslashes
        }

        // --- INITIALIZATION ---
        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Payload missing");
                
                rawPayload = await response.json();
                
                if (!rawPayload || !rawPayload.papers || rawPayload.papers.length === 0) {
                    throw new Error("Invalid payload structure");
                }

                populatePaperSelector();
                
                // Load first paper by default
                loadPaper(rawPayload.papers[0].key);
                
                // Initialize Icons
                lucide.createIcons();

            } catch (err) {
                console.error(err);
                els.paperContent.innerHTML = `
                    <div class="py-20 text-center">
                        <h2 class="text-lg font-bold text-red-600 mb-2">PAPERS PAYLOAD MISSING</h2>
                        <p class="text-sm text-[var(--col-text-secondary)]">Could not load content from ${RTQ_PAPERS_PAYLOAD_PATH}</p>
                    </div>
                `;
            }

            setupInteractions();
        }

        function populatePaperSelector() {
            els.paperSelect.innerHTML = '';
            rawPayload.papers.forEach(paper => {
                const opt = document.createElement('option');
                opt.value = paper.key;
                opt.textContent = paper.label;
                els.paperSelect.appendChild(opt);
            });
        }

        function setupInteractions() {
            // Paper Switch
            els.paperSelect.addEventListener('change', (e) => {
                loadPaper(e.target.value);
            });

            // Mobile Drawer
            const openDrawer = () => {
                els.mobileDrawer.classList.remove('translate-x-full');
                els.mobileDrawerBackdrop.classList.remove('hidden');
                requestAnimationFrame(() => els.mobileDrawerBackdrop.classList.remove('opacity-0'));
                els.mobileDrawer.setAttribute('aria-hidden', 'false');
            };
            
            const closeDrawer = () => {
                els.mobileDrawer.classList.add('translate-x-full');
                els.mobileDrawerBackdrop.classList.add('opacity-0');
                els.mobileDrawer.setAttribute('aria-hidden', 'true');
                setTimeout(() => els.mobileDrawerBackdrop.classList.add('hidden'), 300);
            };

            els.mobileJumpTrigger.addEventListener('click', openDrawer);
            els.drawerClose.addEventListener('click', closeDrawer);
            els.mobileDrawerBackdrop.addEventListener('click', closeDrawer);
        }

        function loadPaper(paperKey) {
            activePaperKey = paperKey;
            activePaperData = rawPayload.papers.find(p => p.key === paperKey);
            
            if (!activePaperData) return;

            // Render Nav
            renderNavigation();

            // Render Content
            renderPaperContent();

            // Setup Intersection Observer for Nav Highlighting
            setupScrollSpy();
        }

        // --- NAVIGATION RENDERING ---
        function renderNavigation() {
            const createNavHTML = () => {
                let html = '';
                const isSectioned = activePaperData.sections && activePaperData.sections.length > 0;

                const renderItem = (qId) => `
                    <a href="#q-${cleanId(qId)}" class="nav-item block py-1 px-2 rounded hover:text-[var(--col-text-primary)] hover:bg-black/5 transition-colors" data-target="q-${cleanId(qId)}">
                        ${qId}
                    </a>
                `;

                const traverseQuestions = (questions) => {
                    let fragment = '';
                    questions.forEach(q => {
                        fragment += renderItem(q.id);
                        if (q.children && q.children.length > 0) {
                            fragment += traverseQuestions(q.children);
                        }
                    });
                    return fragment;
                };

                if (isSectioned) {
                    activePaperData.sections.forEach(section => {
                        // Render Section Label only if non-empty
                        if (section.label && section.label.trim().length > 0) {
                            html += `
                                <div class="mt-4 mb-1 px-2 text-xs font-semibold text-[var(--col-text-tertiary)] uppercase tracking-wider select-none">
                                    ${section.label}
                                </div>
                            `;
                        } else {
                            // Spacing only if section label omitted
                             html += `<div class="mt-4"></div>`;
                        }
                        html += traverseQuestions(section.questions);
                    });
                } else {
                    html += traverseQuestions(activePaperData.questions);
                }
                return html;
            };

            const navHTML = createNavHTML();
            els.desktopNav.innerHTML = navHTML;
            els.mobileNav.innerHTML = navHTML;

            // Add Click Handlers for Smooth Scroll & Drawer Close
            document.querySelectorAll('.nav-item').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetId = link.getAttribute('href').substring(1);
                    const targetEl = document.getElementById(targetId);
                    if (targetEl) {
                        // Offset for sticky header/spacing
                        const y = targetEl.getBoundingClientRect().top + window.scrollY - 20;
                        window.scrollTo({ top: y, behavior: 'smooth' });
                        
                        // Close drawer on mobile
                        if (window.innerWidth < 1024) {
                            els.drawerClose.click();
                        }
                    }
                });
            });
        }

        // --- PAPER CONTENT RENDERING ---
        function renderPaperContent() {
            els.paperContent.innerHTML = '';
            
            const isSectioned = activePaperData.sections && activePaperData.sections.length > 0;
            const fragment = document.createDocumentFragment();

            if (isSectioned) {
                activePaperData.sections.forEach((section, idx) => {
                    // Section Wrapper
                    const secDiv = document.createElement('div');
                    secDiv.className = 'section-block mb-12';
                    
                    // Section Header (structural divider)
                    if (section.label && section.label.trim().length > 0) {
                        const header = document.createElement('div');
                        header.className = 'text-lg font-bold text-[var(--col-text-primary)] mb-6 pt-4 border-t border-[var(--col-line-hairline)]';
                        header.textContent = `Section ${section.label}`;
                        secDiv.appendChild(header);
                    } else if (idx > 0) {
                         // Divider if no label but not first
                         const div = document.createElement('div');
                         div.className = 'h-px bg-[var(--col-line-hairline)] mb-6';
                         secDiv.appendChild(div);
                    }

                    // Questions
                    section.questions.forEach(q => {
                        secDiv.appendChild(createQuestionNode(q, 0));
                    });
                    fragment.appendChild(secDiv);
                });
            } else {
                activePaperData.questions.forEach(q => {
                    fragment.appendChild(createQuestionNode(q, 0));
                });
            }

            els.paperContent.appendChild(fragment);

            // Re-run KaTeX auto-render
            renderMathInElement(els.paperContent, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false},
                    {left: '\\(', right: '\\)', display: false},
                    {left: '\\[', right: '\\]', display: true}
                ],
                throwOnError: false
            });
            
            // Re-init Lucide icons in new content
            lucide.createIcons();
        }

        function createQuestionNode(qNode, depth) {
            const wrapper = document.createElement('div');
            wrapper.id = `q-${cleanId(qNode.id)}`;
            // Vertical separation logic
            // Top level: large gap. Children: moderate gap.
            const verticalSpacing = depth === 0 ? 'mb-12' : 'mb-6 mt-4';
            // Indentation for children
            const paddingLeft = depth > 0 ? 'pl-4 sm:pl-6 border-l border-transparent' : ''; // Stage 3: Indentation optional/spacing only
            
            wrapper.className = `question-node relative ${verticalSpacing} ${paddingLeft}`;

            // --- 1. Question Body ---
            const qBody = document.createElement('div');
            qBody.className = 'question-body mb-4';
            
            // Identifier
            const qId = document.createElement('div');
            qId.className = 'text-sm font-semibold text-[var(--col-text-secondary)] mb-1';
            qId.textContent = qNode.id;
            qBody.appendChild(qId);

            // Prompt
            const qPrompt = document.createElement('div');
            qPrompt.className = 'text-lg text-[var(--col-text-primary)] md-content';
            qPrompt.innerHTML = md ? md.render(qNode.question || '') : (qNode.question || '');
            qBody.appendChild(qPrompt);
            wrapper.appendChild(qBody);

            // --- 2. Solution Block (Optional) ---
            if (qNode.solutionBlock) {
                const solBlock = document.createElement('div');
                solBlock.className = 'solution-block mt-4 pl-0'; 

                // A. Answer (Optional)
                if (qNode.solutionBlock.answer) {
                    const ansDiv = document.createElement('div');
                    ansDiv.className = 'answer-region mb-4';
                    
                    const ansLabel = document.createElement('div');
                    ansLabel.className = 'text-xs font-bold text-[var(--col-text-secondary)] uppercase tracking-wide mb-1';
                    ansLabel.textContent = 'Answer';
                    ansDiv.appendChild(ansLabel);

                    const ansContent = document.createElement('div');
                    ansContent.className = 'text-base font-medium text-[var(--col-text-primary)] md-content';
                    ansContent.innerHTML = md ? md.render(qNode.solutionBlock.answer) : qNode.solutionBlock.answer;
                    ansDiv.appendChild(ansContent);
                    
                    solBlock.appendChild(ansDiv);
                }

                // B. Solution Details (Optional)
                const sdData = qNode.solutionBlock.solutionDetails;
                if (sdData) {
                    // Check paper defaults
                    const isExpandedDefault = activePaperData.defaults?.expandedAll !== false;

                    // Container
                    const sdContainer = document.createElement('div');
                    sdContainer.className = 'solution-details-container';

                    // Toggle Control
                    const toggleBtn = document.createElement('button');
                    toggleBtn.className = 'disclosure-control mb-2 focus:outline-none';
                    toggleBtn.innerHTML = `
                        <span class="btn-text">${isExpandedDefault ? 'Hide working' : 'Show working'}</span>
                        <i data-lucide="chevron-down" class="w-4 h-4 transition-transform duration-200 ${isExpandedDefault ? 'rotate-180' : ''}"></i>
                    `;

                    // Details Region
                    const detailsRegion = document.createElement('div');
                    detailsRegion.className = `solution-details-region transition-all duration-300 overflow-hidden ${isExpandedDefault ? 'max-h-[5000px] opacity-100' : 'max-h-0 opacity-0'}`;
                    
                    // Surface wash (Stage 5.3.3)
                    const detailsInner = document.createElement('div');
                    detailsInner.className = 'p-4 rounded-sm bg-[var(--col-surface-wash)] mt-2 text-[var(--col-text-secondary)] text-base';

                    // --- Internal Subsections ---
                    
                    // Keep in mind
                    if (sdData.keepInMind) {
                        const div = document.createElement('div');
                        div.className = 'mb-4';
                        div.innerHTML = `
                            <div class="text-xs font-bold mb-1 flex items-center gap-1 text-[var(--col-text-primary)]">
                                <i data-lucide="lightbulb" class="w-3 h-3"></i> Keep in mind
                            </div>
                            <div class="md-content text-sm">${md.render(sdData.keepInMind)}</div>
                        `;
                        detailsInner.appendChild(div);
                    }

                    // Formulas used
                    if (sdData.formulasUsed) {
                        const div = document.createElement('div');
                        div.className = 'mb-4 pt-2 border-t border-[var(--col-line-hairline)]'; // Separator
                        div.innerHTML = `
                            <div class="text-xs font-bold mb-1">Formulas used</div>
                            <div class="md-content text-sm">${md.render(sdData.formulasUsed)}</div>
                        `;
                        detailsInner.appendChild(div);
                    }

                    // Working
                    if (sdData.working) {
                        const div = document.createElement('div');
                        div.className = 'mb-4 pt-2 border-t border-[var(--col-line-hairline)]';
                        div.innerHTML = `
                            <div class="text-xs font-bold mb-2">Working</div>
                            <div class="md-content">${md.render(sdData.working)}</div>
                        `;
                        detailsInner.appendChild(div);
                    }

                    // Alternative Working
                    if (sdData.alternativeWorking && Array.isArray(sdData.alternativeWorking)) {
                        sdData.alternativeWorking.forEach(alt => {
                            const div = document.createElement('div');
                            div.className = 'mt-6 pt-4 border-t border-[var(--col-line-border)]'; // Stronger separator
                            div.innerHTML = `
                                <div class="text-xs font-bold mb-2">Alternative working</div>
                                <div class="md-content">${md.render(alt)}</div>
                            `;
                            detailsInner.appendChild(div);
                        });
                    }

                    detailsRegion.appendChild(detailsInner);
                    sdContainer.appendChild(toggleBtn);
                    sdContainer.appendChild(detailsRegion);
                    solBlock.appendChild(sdContainer);

                    // Interaction Logic
                    toggleBtn.addEventListener('click', () => {
                        const isHidden = detailsRegion.classList.contains('max-h-0');
                        const icon = toggleBtn.querySelector('i');
                        const text = toggleBtn.querySelector('.btn-text');

                        if (isHidden) {
                            // Expand
                            detailsRegion.classList.remove('max-h-0', 'opacity-0');
                            detailsRegion.classList.add('max-h-[5000px]', 'opacity-100');
                            text.textContent = 'Hide working';
                            icon.classList.add('rotate-180');
                        } else {
                            // Collapse
                            detailsRegion.classList.remove('max-h-[5000px]', 'opacity-100');
                            detailsRegion.classList.add('max-h-0', 'opacity-0');
                            text.textContent = 'Show working';
                            icon.classList.remove('rotate-180');
                        }
                    });
                }

                wrapper.appendChild(solBlock);
            }

            // --- 3. Children Container ---
            if (qNode.children && qNode.children.length > 0) {
                const childrenContainer = document.createElement('div');
                childrenContainer.className = 'children-container mt-6';
                qNode.children.forEach(child => {
                    childrenContainer.appendChild(createQuestionNode(child, depth + 1));
                });
                wrapper.appendChild(childrenContainer);
            }

            return wrapper;
        }

        // --- UTILS ---
        function cleanId(id) {
            return id.replace(/[^a-zA-Z0-9]/g, '-');
        }

        function setupScrollSpy() {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const id = entry.target.id;
                        updateActiveNav(id);
                    }
                });
            }, {
                rootMargin: '-20% 0px -60% 0px', // Trigger when element is near top
                threshold: 0
            });

            // Observe all question nodes
            document.querySelectorAll('.question-node').forEach(node => observer.observe(node));
        }

        function updateActiveNav(activeId) {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('href') === '#' + activeId) {
                    item.classList.add('active');
                }
            });
        }

        // --- RUN ---
        init();

    </script>
</body>
</html>
