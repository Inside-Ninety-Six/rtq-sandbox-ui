<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AB","indexWithinVariant":"13","totalWithinVariant":"200","hueFamily":"amber","intensityMode":"","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-08T13:59:55.392Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AB&quot;,&quot;indexWithinVariant&quot;:&quot;13&quot;,&quot;totalWithinVariant&quot;:&quot;200&quot;,&quot;hueFamily&quot;:&quot;amber&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-08T13:59:55.392Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ â€“ Maths Paper Solution Viewer</title>

    <!-- Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- KaTeX CSS (SRI disabled per Stage 6) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <!-- Tailwind CSS (via CDN for prototyping) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Tailwind Config for Amber Theme (ColorLab B) -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        // ColorLab B: Forced Hue "Amber"
                        // Base neutral: Warm gray / Stone
                        neutral: {
                            50: '#fafaf9',
                            100: '#f5f5f4',
                            200: '#e7e5e4',
                            300: '#d6d3d1',
                            400: '#a8a29e',
                            500: '#78716c',
                            600: '#57534e',
                            700: '#44403c',
                            800: '#292524',
                            900: '#1c1917',
                        },
                        // Accent: Amber
                        accent: {
                            50: '#fffbeb',
                            100: '#fef3c7',
                            200: '#fde68a',
                            300: '#fcd34d',
                            400: '#fbbf24',
                            500: '#f59e0b', // Primary focus/brand
                            600: '#d97706', // Text links/interactive
                            700: '#b45309',
                            800: '#92400e',
                            900: '#78350f',
                        }
                    }
                }
            }
        }
    </script>

    <!-- Custom CSS -->
    <style>
        /* Base Reset & Typography */
        body {
            @apply bg-neutral-50 text-neutral-900 antialiased;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* 
           KaTeX Containment Invariant (Stage 3/6) 
           Horizontal scrolling permitted only within block-level math containers.
        */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding-bottom: 0.25rem; /* space for scrollbar */
            margin: 1em 0;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Hide scrollbars in nav but allow scroll */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Focus States (Stage 5.5.2) */
        :focus-visible {
            outline: 2px solid theme('colors.accent.500');
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* Table minimal styling */
        table {
            @apply w-full text-left border-collapse my-4 text-sm;
        }
        th, td {
            @apply border-b border-neutral-200 py-2 pr-4 align-top;
        }
        th {
            @apply font-semibold text-neutral-700;
        }

        /* Markdown Content Reset */
        .markdown-content p {
            @apply mb-3 leading-relaxed;
        }
        .markdown-content p:last-child {
            @apply mb-0;
        }
        .markdown-content ul {
            @apply list-disc list-outside ml-5 mb-3;
        }
        .markdown-content ol {
            @apply list-decimal list-outside ml-5 mb-3;
        }
        /* Inline KaTeX background rule: transparent */
        .katex {
            background-color: transparent !important; 
        }
        /* Display math underlay (optional per system, keeping minimal/transparent for safety unless mandated) */
        
        /* Navigation Active State Marker */
        .nav-item.active {
            @apply font-bold text-neutral-900;
        }
        /* Nav item hover */
        .nav-item:hover {
            @apply text-neutral-900;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Markdown & KaTeX Libraries (Stage 6 Add-on: No SRI) -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Top Controls Region -->
    <div class="sticky top-0 z-40 bg-neutral-50 border-b border-neutral-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-14 flex items-center justify-between">
            
            <!-- Paper Selector -->
            <div class="flex items-center gap-3">
                <label for="paper-select" class="text-sm font-medium text-neutral-600 hidden sm:block">Paper</label>
                <select id="paper-select" class="form-select bg-white border border-neutral-300 text-neutral-900 text-sm rounded-md focus:ring-accent-500 focus:border-accent-500 block w-full sm:w-64 p-2">
                    <option disabled selected>Loading papers...</option>
                </select>
            </div>

            <!-- Mobile "Jump to" Trigger -->
            <button id="mobile-jump-trigger" class="lg:hidden text-sm font-medium text-accent-600 hover:text-accent-800 focus:outline-none px-3 py-1.5 rounded hover:bg-neutral-100 transition-colors">
                Jump to
            </button>
        </div>
    </div>

    <!-- DocumentFrameShell -->
    <div class="flex-1 max-w-7xl mx-auto w-full flex flex-row relative">
        
        <!-- Desktop Navigation Rail (Sticky) -->
        <nav id="desktop-nav" class="hidden lg:block w-48 xl:w-56 shrink-0 border-r border-transparent py-8 pr-4 sticky top-14 self-start h-[calc(100vh-3.5rem)] overflow-y-auto no-scrollbar">
            <div id="desktop-nav-list" class="flex flex-col gap-1">
                <!-- Nav items generated here -->
            </div>
        </nav>

        <!-- Paper Content Column -->
        <main id="paper-region" class="flex-1 min-w-0 py-8 px-4 sm:px-6 lg:px-12 bg-white lg:bg-transparent">
            <!-- Paper content generated here -->
            <div id="content-loading" class="text-neutral-500 animate-pulse mt-8">Loading paper content...</div>
        </main>

    </div>

    <!-- Mobile Navigation Drawer -->
    <div id="mobile-drawer-backdrop" class="fixed inset-0 bg-neutral-900/50 z-50 hidden transition-opacity" aria-hidden="true"></div>
    <div id="mobile-drawer" class="fixed inset-y-0 right-0 z-50 w-64 bg-white shadow-xl transform translate-x-full transition-transform duration-300 ease-in-out flex flex-col" aria-modal="true" role="dialog">
        <div class="p-4 border-b border-neutral-200 flex items-center justify-between bg-neutral-50">
            <h2 class="text-sm font-bold text-neutral-900">Jump to</h2>
            <button id="mobile-drawer-close" class="text-neutral-500 hover:text-neutral-900 p-1 rounded focus:ring-2 focus:ring-accent-500">
                <span class="sr-only">Close navigation</span>
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <div class="flex-1 overflow-y-auto p-4">
            <div id="mobile-nav-list" class="flex flex-col gap-2">
                <!-- Mobile nav items generated here -->
            </div>
        </div>
    </div>

    <!-- Application Logic -->
    <script>
        // --- STAGE 0: CONSTANTS ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // --- GLOBAL STATE ---
        let currentPayload = null;
        let currentPaper = null;
        let activeNavId = null;

        // --- MARKDOWN SETUP (STAGE 6) ---
        const md = window.markdownit ? window.markdownit({
            html: true,    // allow inline SVG
            linkify: true,
            breaks: false, // MUST be false
        }) : null;

        if (md) {
            // Disable escape rule to preserve TeX backslashes
            md.inline.ruler.disable(['escape']);
        }

        // --- DOM ELEMENTS ---
        const els = {
            paperSelect: document.getElementById('paper-select'),
            paperRegion: document.getElementById('paper-region'),
            desktopNavList: document.getElementById('desktop-nav-list'),
            mobileNavList: document.getElementById('mobile-nav-list'),
            mobileDrawer: document.getElementById('mobile-drawer'),
            mobileBackdrop: document.getElementById('mobile-drawer-backdrop'),
            mobileTrigger: document.getElementById('mobile-jump-trigger'),
            mobileClose: document.getElementById('mobile-drawer-close'),
        };

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', init);

        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Fetch failed");
                const json = await response.json();
                currentPayload = json;
                
                if (!currentPayload.papers || currentPayload.papers.length === 0) {
                    throw new Error("No papers in payload");
                }

                renderPaperSelector();
                loadPaper(currentPayload.papers[0].key);

            } catch (err) {
                console.error(err);
                els.paperRegion.innerHTML = '<div class="text-lg font-bold text-neutral-900 tracking-tight">PAPERS PAYLOAD MISSING</div>';
                els.paperSelect.innerHTML = '<option disabled>Error loading payload</option>';
            }

            setupMobileDrawer();
        }

        // --- RENDERERS ---

        function renderPaperSelector() {
            els.paperSelect.innerHTML = currentPayload.papers.map(p => 
                `<option value="${p.key}">${p.label}</option>`
            ).join('');

            els.paperSelect.addEventListener('change', (e) => {
                loadPaper(e.target.value);
            });
        }

        function loadPaper(paperKey) {
            const paper = currentPayload.papers.find(p => p.key === paperKey);
            if (!paper) return;
            currentPaper = paper;

            // Clear previous
            els.paperRegion.innerHTML = '';
            els.desktopNavList.innerHTML = '';
            els.mobileNavList.innerHTML = '';

            // Determine if sectioned or flat
            const isSectioned = !!paper.sections;
            const expandedDefault = paper.defaults?.expandedAll !== false;

            // Render Content & Nav
            if (isSectioned) {
                paper.sections.forEach((section, index) => {
                    const sectionLabel = (section.label || "").trim();
                    
                    // Render Section Header in Content
                    if (sectionLabel) {
                        const headerEl = document.createElement('div');
                        headerEl.className = "mb-8 pt-4 pb-2 border-b border-neutral-200";
                        headerEl.innerHTML = `<h2 class="text-xl font-bold text-neutral-900">${sectionLabel}</h2>`;
                        els.paperRegion.appendChild(headerEl);

                        // Nav Section Label
                        renderNavSectionHeader(sectionLabel);
                    }

                    // Render Questions
                    renderQuestionList(section.questions, els.paperRegion, expandedDefault);
                    
                    // Spacer between sections
                    if (index < paper.sections.length - 1) {
                         const spacer = document.createElement('div');
                         spacer.className = "h-12"; // Spacing between sections
                         els.paperRegion.appendChild(spacer);
                         
                         // Nav spacer
                         renderNavSpacer();
                    }
                });
            } else {
                renderQuestionList(paper.questions, els.paperRegion, expandedDefault);
            }

            // Post-render: KaTeX
            if (window.renderMathInElement) {
                renderMathInElement(els.paperRegion, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false}
                    ],
                    throwOnError: false,
                    // Prevent page scroll by constraining display math
                    strict: false
                });
            }

            // Scroll to top
            window.scrollTo(0,0);
        }

        function renderNavSectionHeader(label) {
            const createItem = (container) => {
                const el = document.createElement('div');
                el.className = "px-2 py-1 text-xs font-bold text-neutral-400 uppercase tracking-wider select-none";
                el.textContent = label;
                container.appendChild(el);
            };
            createItem(els.desktopNavList);
            createItem(els.mobileNavList);
        }

        function renderNavSpacer() {
            const createSpacer = (container) => {
                const el = document.createElement('div');
                el.className = "h-4";
                container.appendChild(el);
            };
            createSpacer(els.desktopNavList);
            createSpacer(els.mobileNavList);
        }

        function renderQuestionList(questions, container, expandedDefault) {
            questions.forEach((q, index) => {
                // Determine spacing based on depth? 
                // Top level has max spacing.
                const wrapper = document.createElement('div');
                wrapper.className = "mb-12 last:mb-0 scroll-mt-20"; // Top-level vertical spacing
                wrapper.id = `q-${q.id}`; // Anchor for nav

                renderQuestionNode(q, wrapper, expandedDefault, 0);
                container.appendChild(wrapper);

                // Divider (optional/quiet) - using only spacing per Stage 5 preference, 
                // but if density requires, Stage 3 allows hairline. Keeping it clean with spacing.
            });
        }

        function renderQuestionNode(node, container, expandedDefault, depth) {
            // -- Nav Item Generation --
            // Generate nav item for this node
            const createNavItem = (listContainer, isDesktop) => {
                const btn = document.createElement('a');
                btn.href = `#q-${node.id}`;
                btn.className = `nav-item block px-2 py-1 text-sm text-neutral-500 transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-accent-500 rounded`;
                // Hierarchy via type scale/opacity (Stage 5.4.5)
                if (depth > 0) {
                    btn.classList.add('text-xs', 'text-neutral-400');
                }
                btn.textContent = node.id;
                
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    // Smooth scroll
                    const target = document.getElementById(`q-${node.id}`);
                    if(target) {
                        const y = target.getBoundingClientRect().top + window.scrollY - 80; // offset for sticky header
                        window.scrollTo({top: y, behavior: 'smooth'});
                        // Close mobile drawer if open
                        if (!isDesktop) closeMobileDrawer();
                    }
                });
                
                listContainer.appendChild(btn);
            };
            createNavItem(els.desktopNavList, true);
            createNavItem(els.mobileNavList, false);


            // -- Content Rendering --
            const contentWrapper = document.createElement('div');
            // Nesting indentation for children via Left Border or Padding?
            // Stage 3: "Vertical separation (required), horizontal indentation (optional)"
            if (depth > 0) {
                contentWrapper.className = "mt-6 ml-4 sm:ml-8 border-l-2 border-neutral-100 pl-4"; 
            }

            // 1. Question Body
            const qBody = document.createElement('div');
            qBody.className = "mb-4";
            
            // Question Identifier
            const qId = document.createElement('span');
            qId.className = "inline-block font-bold text-neutral-500 mr-2 select-none";
            qId.textContent = node.id;
            
            // Question Prompt
            const qPrompt = document.createElement('div');
            qPrompt.className = "inline text-neutral-900 font-medium text-lg leading-relaxed markdown-content";
            qPrompt.innerHTML = renderMarkdown(node.question);
            
            qBody.appendChild(qId);
            qBody.appendChild(qPrompt);
            contentWrapper.appendChild(qBody);

            // 2. Solution Block (Optional)
            if (node.solutionBlock) {
                const sb = node.solutionBlock;
                const hasAnswer = !!sb.answer;
                const hasDetails = !!sb.solutionDetails;

                // Wrapper for solution block logic
                const solutionBlockEl = document.createElement('div');
                solutionBlockEl.className = "mt-4"; // Separation from question

                // Answer (Visible by default)
                if (hasAnswer) {
                    const ansEl = document.createElement('div');
                    ansEl.className = "mb-3 text-neutral-800";
                    ansEl.innerHTML = `<span class="font-bold text-xs uppercase tracking-wide text-neutral-500 mr-2">Answer</span><span class="font-semibold markdown-content inline">${renderMarkdown(sb.answer)}</span>`;
                    solutionBlockEl.appendChild(ansEl);
                }

                // Solution Details (Toggleable)
                if (hasDetails) {
                    const details = sb.solutionDetails;
                    
                    // Toggle Control
                    const toggleBtn = document.createElement('button');
                    // Stage 5.7: Text-first label. Subordinate to Answer.
                    toggleBtn.className = "group flex items-center gap-1.5 text-sm font-medium text-accent-600 hover:text-accent-800 transition-colors focus:outline-none mb-2";
                    
                    const isExpanded = expandedDefault;
                    
                    const updateToggleText = (expanded) => {
                        toggleBtn.innerHTML = `
                            <span>${expanded ? 'Hide working' : 'Show working'}</span>
                            <svg class="w-4 h-4 transform transition-transform ${expanded ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        `;
                    };
                    updateToggleText(isExpanded);

                    // Details Region
                    const region = document.createElement('div');
                    region.className = isExpanded ? "block" : "hidden";
                    // Stage 5.3.3: Permitted surface differentiation (very subtle wash)
                    // But Stage 6 baseline prefers spacing first. Let's stick to simple spacing + optional left marker or subtle wash if needed for density.
                    // "Constraint: No card/panel framing."
                    // Let's use a very subtle wash for the region to bound it, as permitted.
                    // "A very subtle, non-semantic background wash may be applied to the Solution Details region only"
                    region.classList.add("pl-4", "border-l", "border-neutral-200", "py-2", "mt-2");

                    // Render Subsections
                    // Order: Keep in mind -> Formulas -> Working -> Alternative
                    
                    // Keep In Mind
                    if (details.keepInMind) {
                        const kimEl = document.createElement('div');
                        kimEl.className = "mb-4 text-sm text-neutral-600";
                        kimEl.innerHTML = `<div class="font-bold text-neutral-700 mb-1 flex items-center gap-2">
                            <svg class="w-4 h-4 text-neutral-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            Keep in mind
                        </div><div class="markdown-content">${renderMarkdown(details.keepInMind)}</div>`;
                        region.appendChild(kimEl);
                    }

                    // Formulas Used
                    if (details.formulasUsed) {
                        const formEl = document.createElement('div');
                        formEl.className = "mb-4 text-sm text-neutral-600";
                        formEl.innerHTML = `<div class="font-bold text-neutral-700 mb-1">Formulas used</div><div class="markdown-content">${renderMarkdown(details.formulasUsed)}</div>`;
                        region.appendChild(formEl);
                    }

                    // Working
                    if (details.working) {
                        const workEl = document.createElement('div');
                        workEl.className = "mb-6 text-base text-neutral-700";
                        // Working label is optional in structure but good for clarity.
                        workEl.innerHTML = `<div class="font-bold text-xs uppercase tracking-wide text-neutral-400 mb-2">Working</div><div class="markdown-content space-y-4">${renderMarkdown(details.working)}</div>`;
                        region.appendChild(workEl);
                    }

                    // Alternative Working
                    if (details.alternativeWorking && Array.isArray(details.alternativeWorking)) {
                        details.alternativeWorking.forEach((alt, idx) => {
                            const altEl = document.createElement('div');
                            altEl.className = "mt-6 pt-6 border-t border-neutral-100 text-base text-neutral-700";
                            altEl.innerHTML = `<div class="font-bold text-xs uppercase tracking-wide text-neutral-400 mb-2">Alternative working ${details.alternativeWorking.length > 1 ? idx + 1 : ''}</div><div class="markdown-content space-y-4">${renderMarkdown(alt)}</div>`;
                            region.appendChild(altEl);
                        });
                    }

                    // Interaction
                    toggleBtn.onclick = () => {
                        const expanding = region.classList.contains('hidden');
                        region.classList.toggle('hidden');
                        updateToggleText(expanding);
                    };

                    solutionBlockEl.appendChild(toggleBtn);
                    solutionBlockEl.appendChild(region);
                }
                
                contentWrapper.appendChild(solutionBlockEl);
            }

            container.appendChild(contentWrapper);

            // 3. Children Recursion
            if (node.children && node.children.length > 0) {
                const childrenContainer = document.createElement('div');
                // render children with incremented depth
                node.children.forEach(child => {
                    renderQuestionNode(child, childrenContainer, expandedDefault, depth + 1);
                });
                container.appendChild(childrenContainer);
            }
        }

        function renderMarkdown(text) {
            if (!text) return '';
            if (md) return md.render(text);
            return text; // Fallback plain text
        }

        // --- MOBILE DRAWER ---
        function setupMobileDrawer() {
            const toggle = () => {
                const isClosed = els.mobileDrawer.classList.contains('translate-x-full');
                if (isClosed) {
                    els.mobileDrawer.classList.remove('translate-x-full');
                    els.mobileBackdrop.classList.remove('hidden');
                    setTimeout(() => els.mobileBackdrop.classList.remove('opacity-0'), 10);
                } else {
                    closeMobileDrawer();
                }
            };

            els.mobileTrigger.addEventListener('click', toggle);
            els.mobileClose.addEventListener('click', closeMobileDrawer);
            els.mobileBackdrop.addEventListener('click', closeMobileDrawer);
        }

        function closeMobileDrawer() {
            els.mobileDrawer.classList.add('translate-x-full');
            els.mobileBackdrop.classList.add('opacity-0');
            setTimeout(() => els.mobileBackdrop.classList.add('hidden'), 300);
        }

        // --- SCROLL SPY FOR NAV ---
        // Simple Intersection Observer approach to highlight active nav item
        // Note: With many questions, we just use a simplified viewport check or intersection observer
        const observerOptions = {
            root: null,
            rootMargin: '-10% 0px -80% 0px', // Active when near top
            threshold: 0
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    updateActiveNav(entry.target.id);
                }
            });
        }, observerOptions);

        // Re-attach observer when paper changes is complex with raw DOM, 
        // easier to attach to all rendered question wrappers.
        // We'll hack this by re-querying inside render.
        // Actually, let's just use a scroll event for simplicity in prototype.
        
        let scrollTimeout;
        window.addEventListener('scroll', () => {
            if (scrollTimeout) return;
            scrollTimeout = setTimeout(() => {
                // Find visible question
                // Strategy: Find element closest to top 100px
                const ids = Array.from(document.querySelectorAll('[id^="q-"]'));
                let currentId = null;
                for (let el of ids) {
                    const rect = el.getBoundingClientRect();
                    if (rect.top < 200) {
                        currentId = el.id;
                    } else {
                        break;
                    }
                }
                // If we are at top of page
                if (window.scrollY < 50 && ids.length > 0) currentId = ids[0].id;
                
                if (currentId) {
                    // strip q- prefix
                    const rawId = currentId.substring(2);
                    // Match against nav items text content or href
                    updateActiveNav(rawId);
                }
                scrollTimeout = null;
            }, 100);
        });

        function updateActiveNav(id) {
            if (activeNavId === id) return;
            activeNavId = id;
            
            // Desktop
            document.querySelectorAll('.nav-item').forEach(el => {
                // Check if href ends with #q-ID
                if (el.getAttribute('href') === `#q-${id}`) {
                    el.classList.add('active', 'text-neutral-900', 'font-bold');
                    el.classList.remove('text-neutral-500', 'text-neutral-400');
                    
                    // Auto-scroll nav rail
                    if (el.offsetParent && el.offsetParent.id === 'desktop-nav') {
                         const navContainer = document.getElementById('desktop-nav');
                         const top = el.offsetTop - navContainer.offsetTop;
                         if (top < navContainer.scrollTop || top > navContainer.scrollTop + navContainer.clientHeight) {
                             el.scrollIntoView({block: 'center'});
                         }
                    }

                } else {
                    el.classList.remove('active', 'text-neutral-900', 'font-bold');
                    // Reset to default hierarchy colors
                    // This is tricky because we lost depth context. 
                    // For prototype, just reset to base.
                    el.classList.add('text-neutral-500');
                }
            });
        }

    </script>
</body>
</html>
