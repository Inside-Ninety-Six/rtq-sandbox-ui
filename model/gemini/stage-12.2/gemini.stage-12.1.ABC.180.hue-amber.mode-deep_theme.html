<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"ABC","indexWithinVariant":"180","totalWithinVariant":"320","hueFamily":"amber","intensityMode":"deep_theme","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-09T18:24:44.190Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;ABC&quot;,&quot;indexWithinVariant&quot;:&quot;180&quot;,&quot;totalWithinVariant&quot;:&quot;320&quot;,&quot;hueFamily&quot;:&quot;amber&quot;,&quot;intensityMode&quot;:&quot;deep_theme&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-09T18:24:44.190Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>
    
    <!-- Libraries (No Integrity Attributes) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        page: 'var(--color-page-bg)',
                        frame: 'var(--color-frame-bg)',
                        paper: 'var(--color-paper-bg)',
                        wash: 'var(--color-solution-wash)',
                        primary: 'var(--color-text-primary)',
                        secondary: 'var(--color-text-secondary)',
                        accent: 'var(--color-accent)',
                        divider: 'var(--color-divider)',
                    },
                    fontFamily: {
                        sans: 'var(--font-sans)',
                    },
                    typography: {
                        DEFAULT: {
                            css: {
                                maxWidth: 'none',
                                color: 'var(--color-text-primary)',
                                p: { marginTop: '0.75em', marginBottom: '0.75em' },
                            }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* 
           COLORLAB CONFIGURATION
           Add-on B: Forced Hue = Amber (H=85 approx)
           Add-on C: Intensity Mode = Deep Theme (Light Only)
        */
        :root {
            --font-sans: system-ui, -apple-system, sans-serif;

            /* DEEP THEME: Amber (H=85) */
            
            /* Surfaces: All major surfaces chromatic */
            /* Page: L [0.92..0.98], C [0.08..0.16] */
            --color-page-bg: oklch(0.96 0.09 85);
            
            /* Frame: L [0.90..0.96], C [0.08..0.16] */
            --color-frame-bg: oklch(0.94 0.10 85);
            
            /* Paper: L [0.94..0.99], C [0.06..0.14] */
            --color-paper-bg: oklch(0.98 0.07 85);

            /* Wash: Distinct from paper */
            --color-solution-wash: oklch(0.95 0.09 85);

            /* Text: mostly neutral but legibly dark */
            /* Primary: L [0.15..0.25], C <= 0.015 */
            --color-text-primary: oklch(0.20 0.015 85);
            
            /* Secondary: L [0.25..0.40], C <= 0.020 */
            --color-text-secondary: oklch(0.40 0.020 85);

            /* Accent: Strong Amber */
            /* L [0.45..0.65], C [0.16..0.26] */
            --color-accent: oklch(0.55 0.20 85);

            /* Divider: Neutral-leaning, low chroma */
            --color-divider: oklch(0.88 0.02 85);

            /* Focus Ring */
            --color-focus: var(--color-accent);
        }

        body {
            background-color: var(--color-page-bg);
            color: var(--color-text-primary);
            font-family: var(--font-sans);
            overflow: hidden; /* App shell manages scrolling */
            -webkit-font-smoothing: antialiased;
        }

        /* KaTeX Overrides for Containment Invariant */
        .katex-display {
            margin: 1em 0;
            overflow-x: auto;
            overflow-y: hidden;
            padding-bottom: 2px;
            max-width: 100%;
        }
        
        /* Inline KaTeX: Transparent background strictly enforced */
        .katex { 
            background-color: transparent !important; 
        }

        /* Utility: Hide Scrollbar but keep functional */
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* Accessibility: Focus Visibility */
        *:focus-visible {
            outline: 2px solid var(--color-focus);
            outline-offset: 2px;
        }

        /* Markdown Table Minimal Styling */
        table {
            border-collapse: collapse;
            width: 100%;
            font-size: 0.9em;
            margin: 1em 0;
        }
        th {
            border-bottom: 1px solid var(--color-divider);
            text-align: left;
            padding: 0.5em;
            font-weight: 600;
        }
        td {
            border-bottom: 1px solid var(--color-divider);
            padding: 0.5em;
            vertical-align: top;
        }

        /* Transitions */
        .drawer-overlay { transition: opacity 0.2s; }
        .drawer-content { transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .fade-in { animation: fadeIn 0.2s ease-out forwards; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-4px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div id="app-root" class="h-screen w-full flex flex-col">
        <!-- Application Rendered Here -->
    </div>

    <script>
        // --- STAGE 0: CONSTANTS ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // --- STATE MANAGEMENT ---
        const state = {
            papers: [],
            activePaperKey: null,
            expandedMap: {}, // key: questionId -> boolean
            drawerOpen: false,
            loading: true,
            error: false
        };

        // --- MARKDOWN CONFIGURATION (Authoritative) ---
        const md = window.markdownit ? window.markdownit({
            html: true,       // Inline SVG passthrough
            linkify: true,
            breaks: false     // Critical: prevents <br> in math blocks
        }) : null;

        if (md) {
            // Preserve TeX backslashes
            md.inline.ruler.disable(['escape']);
        }

        // --- INITIALIZATION ---
        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Payload load failed");
                const data = await response.json();
                state.papers = data.papers || [];
                
                if (state.papers.length > 0) {
                    selectPaper(state.papers[0].key);
                } else {
                    state.loading = false;
                    render();
                }
            } catch (err) {
                console.error(err);
                state.error = true;
                state.loading = false;
                render();
            }
        }

        function selectPaper(key) {
            state.activePaperKey = key;
            state.expandedMap = {};
            state.loading = false;
            state.drawerOpen = false;
            
            // Set defaults based on payload
            const paper = state.papers.find(p => p.key === key);
            if (paper && paper.defaults && paper.defaults.expandedAll === false) {
                // If default is collapsed, we don't need to do anything as map lookup defaults to 'default' logic
            }
            
            render();
            
            // Scroll reset
            const container = document.getElementById('paper-scroll-content');
            if (container) container.scrollTop = 0;
        }

        // --- ACTIONS ---
        window.handlePaperSelect = (e) => {
            selectPaper(e.target.value);
        };

        window.toggleDrawer = (isOpen) => {
            state.drawerOpen = isOpen;
            render(); // Simple re-render for prototype
        };

        window.toggleWorking = (id) => {
            const paper = state.papers.find(p => p.key === state.activePaperKey);
            const defaultExpanded = paper?.defaults?.expandedAll !== false;
            const current = state.expandedMap[id] !== undefined ? state.expandedMap[id] : defaultExpanded;
            state.expandedMap[id] = !current;
            render();
        };

        window.jumpToQuestion = (id) => {
            state.drawerOpen = false;
            render();
            // Allow render cycle to complete
            setTimeout(() => {
                const el = document.getElementById(`qnode-${id}`);
                if (el) {
                    el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 10);
        };

        // --- RENDERING ---
        function render() {
            const root = document.getElementById('app-root');
            
            if (state.error) {
                root.innerHTML = `
                    <div class="w-full h-full flex items-center justify-center text-secondary font-bold tracking-wide">
                        PAPERS PAYLOAD MISSING
                    </div>
                `;
                return;
            }

            if (state.loading) {
                root.innerHTML = `<div class="w-full h-full flex items-center justify-center text-secondary">Loading...</div>`;
                return;
            }

            const activePaper = state.papers.find(p => p.key === state.activePaperKey);
            if (!activePaper) return;

            const navItems = buildNavItems(activePaper);

            root.innerHTML = `
                <!-- Top Controls (Visually aligned to Frame) -->
                <div class="flex-none w-full bg-frame border-b border-divider z-20">
                    <div class="max-w-[1200px] mx-auto px-4 h-14 flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <label for="paper-picker" class="text-xs font-bold text-secondary uppercase tracking-wider">Paper</label>
                            <select id="paper-picker" onchange="handlePaperSelect(event)" 
                                class="bg-paper border border-divider text-primary text-sm rounded py-1 px-2 focus:border-accent focus:ring-1 focus:ring-accent outline-none">
                                ${state.papers.map(p => `
                                    <option value="${p.key}" ${p.key === state.activePaperKey ? 'selected' : ''}>${p.label}</option>
                                `).join('')}
                            </select>
                        </div>
                        <button class="md:hidden text-sm font-semibold text-accent" onclick="toggleDrawer(true)">
                            Jump to
                        </button>
                    </div>
                </div>

                <!-- DocumentFrameShell -->
                <div class="flex-1 w-full max-w-[1200px] mx-auto flex overflow-hidden bg-frame md:px-4">
                    
                    <!-- Desktop Nav Rail -->
                    <aside class="hidden md:block w-48 flex-none py-6 pr-4 overflow-y-auto hide-scrollbar sticky top-0 h-full">
                        ${renderNavContent(navItems)}
                    </aside>

                    <!-- Paper Content Column -->
                    <main id="paper-scroll-content" class="flex-1 bg-paper h-full overflow-y-auto relative shadow-sm md:border-x md:border-divider scroll-smooth">
                        <div class="max-w-[800px] mx-auto p-4 md:p-8 lg:p-12 min-h-full pb-32">
                            ${renderPaperBody(activePaper)}
                        </div>
                    </main>

                </div>

                <!-- Mobile Drawer -->
                ${renderDrawer(navItems)}
            `;

            // Post-render Math
            renderMathInElement(document.body, {
                delimiters: [
                    {left: "$$", right: "$$", display: true},
                    {left: "$", right: "$", display: false}
                ],
                throwOnError: false
            });
        }

        // --- VIEW HELPERS ---

        function buildNavItems(paper) {
            let items = [];
            if (paper.sections) {
                paper.sections.forEach(sec => {
                    if (sec.label && sec.label.trim()) {
                        items.push({ type: 'section', label: sec.label });
                    }
                    if (sec.questions) {
                        items.push(...flattenQuestions(sec.questions));
                    }
                });
            } else if (paper.questions) {
                items.push(...flattenQuestions(paper.questions));
            }
            return items;
        }

        function flattenQuestions(qs) {
            let list = [];
            qs.forEach(q => {
                list.push({ type: 'item', id: q.id });
                if (q.children) list.push(...flattenQuestions(q.children));
            });
            return list;
        }

        function renderNavContent(items) {
            return `
                <nav class="flex flex-col gap-1 text-sm">
                    ${items.map(item => {
                        if (item.type === 'section') {
                            return `
                                <div class="mt-4 mb-2 first:mt-0 px-2 text-xs font-bold text-secondary uppercase tracking-wider border-b border-divider pb-1 select-none">
                                    ${item.label}
                                </div>
                            `;
                        }
                        return `
                            <button onclick="jumpToQuestion('${item.id}')" 
                                class="text-left px-2 py-1 rounded text-secondary hover:text-primary hover:bg-black/5 transition-colors duration-100 focus:text-accent font-normal">
                                ${item.id}
                            </button>
                        `;
                    }).join('')}
                </nav>
            `;
        }

        function renderDrawer(items) {
            if (!state.drawerOpen) return '';
            return `
                <div class="fixed inset-0 z-50 flex justify-end md:hidden" role="dialog" aria-modal="true">
                    <div class="absolute inset-0 bg-black/20 drawer-overlay" onclick="toggleDrawer(false)"></div>
                    <div class="relative w-64 bg-paper h-full shadow-xl flex flex-col drawer-content">
                        <div class="flex items-center justify-between p-4 border-b border-divider">
                            <span class="font-bold text-primary">Jump to</span>
                            <button onclick="toggleDrawer(false)" class="p-2 -mr-2 text-secondary hover:text-primary">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                            </button>
                        </div>
                        <div class="flex-1 overflow-y-auto p-4">
                            ${renderNavContent(items)}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderPaperBody(paper) {
            if (paper.sections) {
                return paper.sections.map(sec => `
                    <div class="mb-10">
                        ${sec.label && sec.label.trim() ? `
                            <div class="text-xl font-bold text-secondary border-b border-divider pb-2 mb-8 select-none">
                                ${sec.label}
                            </div>
                        ` : ''}
                        <div class="flex flex-col gap-10 md:gap-14">
                            ${sec.questions.map(q => renderQuestionNode(q, paper)).join('')}
                        </div>
                    </div>
                `).join('');
            } else {
                return `
                    <div class="flex flex-col gap-10 md:gap-14">
                        ${paper.questions.map(q => renderQuestionNode(q, paper)).join('')}
                    </div>
                `;
            }
        }

        function renderQuestionNode(node, paper, depth = 0) {
            const hasSolutionBlock = !!node.solutionBlock;
            const answer = node.solutionBlock?.answer;
            const solutionDetails = node.solutionBlock?.solutionDetails;
            const hasDetails = !!solutionDetails;
            
            // Expand logic: default is true unless paper says false
            const defaultExpanded = paper.defaults?.expandedAll !== false;
            const isExpanded = state.expandedMap[node.id] !== undefined ? state.expandedMap[node.id] : defaultExpanded;

            const safeMd = (content) => md ? md.render(content || '') : (content || '');

            return `
                <div id="qnode-${node.id}" class="group relative flex gap-3 md:gap-5">
                    <!-- Identifier -->
                    <div class="flex-none w-8 md:w-10 pt-1 text-right">
                        <span class="text-secondary font-semibold text-sm md:text-base select-none">${node.id}</span>
                    </div>

                    <!-- Body -->
                    <div class="flex-1 min-w-0">
                        <!-- Question Prompt -->
                        <div class="prose text-primary leading-relaxed mb-4">
                            ${safeMd(node.question)}
                        </div>

                        ${hasSolutionBlock ? `
                            <div class="flex flex-col gap-5">
                                
                                <!-- Answer -->
                                ${answer ? `
                                    <div class="flex flex-col gap-1">
                                        <span class="text-[10px] font-bold text-secondary uppercase tracking-wider select-none">Answer</span>
                                        <div class="text-primary font-medium text-lg leading-normal">
                                            ${safeMd(answer)}
                                        </div>
                                    </div>
                                ` : ''}

                                ${hasDetails ? `
                                    <!-- Toggle -->
                                    <div>
                                        <button onclick="toggleWorking('${node.id}')" class="group/btn flex items-center gap-1.5 text-sm font-medium text-accent hover:opacity-80 focus:outline-none transition-opacity select-none">
                                            <span>${isExpanded ? 'Hide working' : 'Show working'}</span>
                                            <svg class="w-4 h-4 transition-transform duration-200 ${isExpanded ? 'rotate-180' : ''}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                                        </button>
                                    </div>

                                    <!-- Details Region -->
                                    ${isExpanded ? `
                                        <div class="bg-wash border-l-2 border-divider/60 rounded-sm p-5 md:p-6 mt-1 fade-in">
                                            
                                            ${solutionDetails.keepInMind ? `
                                                <div class="mb-6">
                                                    <div class="text-[10px] font-bold text-secondary uppercase tracking-wider mb-2 select-none">Keep in mind</div>
                                                    <div class="prose text-sm text-secondary">
                                                        ${safeMd(solutionDetails.keepInMind)}
                                                    </div>
                                                </div>
                                            ` : ''}

                                            ${solutionDetails.formulasUsed ? `
                                                <div class="mb-6">
                                                    <div class="text-[10px] font-bold text-secondary uppercase tracking-wider mb-2 select-none">Formulas used</div>
                                                    <div class="prose text-xs text-secondary/80 font-mono">
                                                        ${safeMd(solutionDetails.formulasUsed)}
                                                    </div>
                                                </div>
                                            ` : ''}

                                            ${solutionDetails.working ? `
                                                <div class="mb-6 last:mb-0">
                                                    <div class="text-[10px] font-bold text-secondary uppercase tracking-wider mb-2 select-none">Working</div>
                                                    <div class="prose text-primary">
                                                        ${safeMd(solutionDetails.working)}
                                                    </div>
                                                </div>
                                            ` : ''}

                                            ${solutionDetails.alternativeWorking && solutionDetails.alternativeWorking.length > 0 ? 
                                                solutionDetails.alternativeWorking.map(aw => `
                                                    <div class="mt-8 pt-6 border-t border-divider border-dashed">
                                                        <div class="text-[10px] font-bold text-secondary uppercase tracking-wider mb-2 select-none">Alternative working</div>
                                                        <div class="prose text-primary">
                                                            ${safeMd(aw)}
                                                        </div>
                                                    </div>
                                                `).join('')
                                            : ''}
                                        </div>
                                    ` : ''}
                                ` : ''}
                            </div>
                        ` : ''}

                        <!-- Recursion for Children -->
                        ${node.children && node.children.length > 0 ? `
                            <div class="mt-8 md:mt-10 flex flex-col gap-8 md:gap-10">
                                ${node.children.map(child => renderQuestionNode(child, paper, depth + 1)).join('')}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // --- BOOTSTRAP ---
        init();

    </script>
</body>
</html>
