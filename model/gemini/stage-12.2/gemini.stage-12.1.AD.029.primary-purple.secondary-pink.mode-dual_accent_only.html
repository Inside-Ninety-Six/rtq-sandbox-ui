<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AD","indexWithinVariant":"29","totalWithinVariant":"440","hueFamily":"","intensityMode":"","primaryHueFamily":"purple","secondaryHueFamily":"pink","dualIntensityMode":"dual_accent_only","timestamp":"2026-01-10T03:26:12.684Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AD&quot;,&quot;indexWithinVariant&quot;:&quot;29&quot;,&quot;totalWithinVariant&quot;:&quot;440&quot;,&quot;hueFamily&quot;:&quot;&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;primaryHueFamily&quot;:&quot;purple&quot;,&quot;secondaryHueFamily&quot;:&quot;pink&quot;,&quot;dualIntensityMode&quot;:&quot;dual_accent_only&quot;,&quot;timestamp&quot;:&quot;2026-01-10T03:26:12.684Z&quot;}'>

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RTQ Maths Paper Solution Viewer</title>

<!-- PRECONNECT (Optimization) -->
<link rel="preconnect" href="https://cdn.jsdelivr.net">

<!-- KATEX CSS (No integrity, no SRI) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

<!-- MARKDOWN-IT & KATEX JS (No integrity, no SRI) -->
<script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

<style>
/* ==========================================================================
   COLORLAB D: DUAL-ACCENT PALETTE (QUANTIFIED, LIGHT-ONLY)
   Mode: dual_tinted_neutrals
   Primary Hue: Blue (approx 250)
   Secondary Hue: Amber (approx 85)
   ========================================================================== */
:root {
  /* HUES */
  --hue-primary: 250;
  --hue-secondary: 85;

  /* SURFACES (Tinted with Primary Hue, C: 0.015 - 0.035) */
  --srf-page: oklch(0.96 0.02 var(--hue-primary));
  --srf-frame: oklch(0.96 0.02 var(--hue-primary)); /* Unified context */
  --srf-paper: oklch(0.98 0.015 var(--hue-primary));
  
  /* WASH (Primary Hue derived, C: 0.025 - 0.045) */
  --srf-solution-wash: oklch(0.95 0.03 var(--hue-primary));

  /* TEXT (Near neutral, C <= 0.012) */
  --txt-primary: oklch(0.20 0.01 var(--hue-primary));
  --txt-secondary: oklch(0.45 0.012 var(--hue-primary));
  --txt-tertiary: oklch(0.55 0.01 var(--hue-primary));

  /* ACCENTS */
  /* Primary (Blue): C [0.10 .. 0.16] */
  --acc-primary: oklch(0.55 0.15 var(--hue-primary));
  --acc-primary-hover: oklch(0.45 0.15 var(--hue-primary));
  
  /* Secondary (Amber): C [0.08 .. 0.14] - Supplementary Role Only */
  --acc-secondary: oklch(0.70 0.14 var(--hue-secondary));

  /* LINES */
  --line-hairline: oklch(0.90 0.015 var(--hue-primary));
  --focus-ring: var(--acc-primary);
}

/* ==========================================================================
   RESET & BASE
   ========================================================================== */
*, *::before, *::after {
  box-sizing: border-box;
}

body {
  margin: 0;
  padding: 0;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  background-color: var(--srf-page);
  color: var(--txt-primary);
  line-height: 1.5;
  -webkit-font-smoothing: antialiased;
}

/* Utility for hiding scrollbars */
.no-scrollbar {
  scrollbar-width: none; /* Firefox */
  -ms-overflow-style: none;  /* IE 10+ */
}
.no-scrollbar::-webkit-scrollbar { 
  display: none; /* Chrome/Safari */
}

/* ==========================================================================
   LAYOUT SHELL
   ========================================================================== */
#app {
  display: flex;
  flex-direction: column;
  min-height: 100vh;
}

/* TOP CONTROLS */
.top-controls {
  position: sticky;
  top: 0;
  z-index: 50;
  background-color: var(--srf-page); /* Matches page bg per Stage 3 */
  border-bottom: 1px solid var(--line-hairline);
  height: 60px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.top-controls-inner {
  width: 100%;
  max-width: 1200px; /* Aligned with DocumentFrameShell width */
  padding: 0 20px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.paper-selector {
  font-size: 0.95rem;
  padding: 6px 12px;
  border: 1px solid var(--line-hairline);
  border-radius: 4px;
  background: var(--srf-paper);
  color: var(--txt-primary);
  cursor: pointer;
}

.jump-to-trigger {
  display: none; /* Desktop default */
  background: none;
  border: 1px solid var(--line-hairline);
  border-radius: 4px;
  padding: 6px 12px;
  font-size: 0.9rem;
  color: var(--txt-primary);
  cursor: pointer;
}

/* DOCUMENT FRAME SHELL */
.document-frame-shell {
  flex: 1;
  display: flex;
  width: 100%;
  max-width: 1200px;
  margin: 0 auto;
  position: relative;
  background-color: var(--srf-frame);
}

/* NAVIGATION RAIL (Desktop) */
.nav-rail {
  width: 240px;
  flex-shrink: 0;
  position: sticky;
  top: 60px; /* Height of top controls */
  height: calc(100vh - 60px);
  overflow-y: auto;
  padding: 32px 16px 32px 0; /* Right padding creates gutter */
  border-right: 1px solid transparent; /* Optical separation via spacing */
}

/* NAV CONTENT */
.nav-list {
  list-style: none;
  padding: 0;
  margin: 0;
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.nav-section-label {
  font-size: 0.8rem;
  font-weight: 600;
  color: var(--txt-tertiary);
  margin-top: 16px;
  margin-bottom: 8px;
  padding-left: 12px;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.nav-item {
  display: block;
  padding: 6px 12px;
  font-size: 0.9rem;
  color: var(--txt-secondary);
  text-decoration: none;
  border-radius: 4px;
  transition: color 0.1s, background-color 0.1s;
  cursor: pointer;
  
  /* Flat list, hierarchy via type scale logic implemented in JS rendering */
}

.nav-item:hover {
  background-color: rgba(0,0,0,0.03);
  color: var(--txt-primary);
}

.nav-item.active {
  color: var(--acc-primary);
  font-weight: 600;
  background-color: rgba(0,0,0,0.03); /* Subtle marker */
  position: relative;
}

.nav-item.active::before {
  content: '';
  position: absolute;
  left: 0;
  top: 50%;
  transform: translateY(-50%);
  width: 3px;
  height: 16px;
  background-color: var(--acc-primary);
  border-radius: 0 2px 2px 0;
}

/* PAPER COLUMN */
.paper-column {
  flex: 1;
  padding: 40px 0 100px 40px; /* Left padding is gutter from nav */
  max-width: 800px; /* Content readability limit */
}

.paper-surface {
  background-color: var(--srf-paper);
  /* Pure surface, no shadows/cards per Stage 5 */
  min-height: 500px;
  padding: 0; /* Content padding handled by children */
}

/* ==========================================================================
   CONTENT TYPOGRAPHY & SPACING
   ========================================================================== */
.section-header {
  font-size: 1.5rem;
  font-weight: 600;
  color: var(--txt-primary);
  margin: 60px 0 30px 0;
  padding-bottom: 10px;
  border-bottom: 1px solid var(--line-hairline);
}

/* QUESTION NODE STRUCTURE */
.question-node {
  margin-bottom: 48px; /* Top level spacing */
  position: relative;
}

/* Recursive nesting indentation managed via CSS custom property or class */
.question-node .children-container {
  margin-top: 24px;
  display: flex;
  flex-direction: column;
  gap: 24px; /* Sibling sub-questions */
}

/* Indentation logic: adapt per depth */
.child-node {
  margin-left: 24px; /* Standard indent */
  margin-bottom: 0;
}

.question-body {
  font-size: 1.125rem;
  line-height: 1.6;
  color: var(--txt-primary);
  margin-bottom: 16px;
}

.question-identifier {
  font-weight: 700;
  margin-right: 8px;
}

/* SOLUTION BLOCK */
.solution-block {
  margin-top: 16px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

/* ANSWER */
.answer-region {
  display: flex;
  align-items: baseline;
  gap: 8px;
  font-size: 1.05rem;
}

.answer-label {
  font-weight: 600;
  font-size: 0.9rem;
  color: var(--txt-secondary);
  text-transform: uppercase;
  letter-spacing: 0.03em;
}

.answer-content {
  color: var(--txt-primary);
  font-weight: 500;
}

/* DISCLOSURE CONTROL */
.disclosure-control {
  align-self: flex-start;
  background: none;
  border: none;
  padding: 0;
  font-size: 0.95rem;
  color: var(--acc-primary);
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  font-weight: 500;
  margin-bottom: 8px;
}

.disclosure-control:hover {
  text-decoration: underline;
  color: var(--acc-primary-hover);
}

.disclosure-icon {
  width: 16px;
  height: 16px;
  transition: transform 0.2s ease;
  fill: currentColor;
}

.disclosure-control[aria-expanded="true"] .disclosure-icon {
  transform: rotate(180deg);
}

/* SOLUTION DETAILS REGION */
.solution-details {
  display: none; /* Toggled via JS */
  margin-top: 8px;
  padding: 24px 24px;
  background-color: var(--srf-solution-wash);
  border-radius: 4px; /* Subtle rounding allowed, no heavy cards */
  font-size: 1rem;
}

.solution-details.expanded {
  display: block;
  animation: fadeIn 0.2s ease-out;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-4px); }
  to { opacity: 1; transform: translateY(0); }
}

/* SOLUTION SUBSECTIONS */
.sd-subsection {
  margin-bottom: 24px;
}
.sd-subsection:last-child {
  margin-bottom: 0;
}

.sd-label {
  font-size: 0.85rem;
  font-weight: 700;
  color: var(--txt-secondary);
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 6px;
  text-transform: uppercase;
  letter-spacing: 0.02em;
}

/* Sub-specific styling */
.sd-keep-in-mind .sd-label {
  color: var(--acc-primary); /* Slight emphasis via colour per Stage 5 permissions */
}

/* Secondary accent usage: supplementary icon */
.sd-icon-marker {
  color: var(--acc-secondary); 
}

/* Alternative Working Separation */
.alt-working-separator {
  height: 1px;
  background-color: var(--line-hairline);
  margin: 24px 0;
}

/* MATHS & MARKDOWN CONTENT */
.md-content p {
  margin-bottom: 1em;
}
.md-content p:last-child {
  margin-bottom: 0;
}

/* Table styles */
.md-content table {
  width: 100%;
  border-collapse: collapse;
  margin: 16px 0;
  font-size: 0.95em;
}
.md-content th, .md-content td {
  border: 1px solid var(--line-hairline);
  padding: 8px 12px;
  text-align: left;
}
.md-content th {
  font-weight: 600;
  color: var(--txt-secondary);
}

/* KATEX OVERRIDES (Containment Invariant) */
.katex-display {
  overflow-x: auto;
  overflow-y: hidden;
  max-width: 100%;
  padding: 0.5em 0;
  -webkit-overflow-scrolling: touch;
}

/* Underlay logic (Stage 3/5 allowed block underlay) */
.katex-display > .katex {
  /* No full-width background forced, keeps it clean */
}

/* Inline katex transparency */
.katex {
  background-color: transparent !important;
}

/* Diagram / SVG handling */
.md-content svg {
  max-width: 100%;
  height: auto;
  display: block;
  margin: 16px 0;
}

/* ==========================================================================
   MOBILE DRAWER
   ========================================================================== */
.mobile-drawer-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.2);
  z-index: 100;
  display: none;
  opacity: 0;
  transition: opacity 0.2s;
}

.mobile-drawer {
  position: fixed;
  top: 0;
  left: 0;
  bottom: 0;
  width: 280px;
  background: var(--srf-frame);
  z-index: 101;
  transform: translateX(-100%);
  transition: transform 0.25s cubic-bezier(0.16, 1, 0.3, 1);
  display: flex;
  flex-direction: column;
  box-shadow: 2px 0 8px rgba(0,0,0,0.05);
}

.drawer-open .mobile-drawer-overlay {
  display: block;
  opacity: 1;
}

.drawer-open .mobile-drawer {
  transform: translateX(0);
}

.drawer-header {
  height: 60px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 20px;
  border-bottom: 1px solid var(--line-hairline);
}

.drawer-title {
  font-weight: 600;
  color: var(--txt-primary);
}

.drawer-close {
  background: none;
  border: none;
  font-size: 1.5rem;
  color: var(--txt-secondary);
  cursor: pointer;
}

.drawer-content {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
}

/* ==========================================================================
   RESPONSIVE
   ========================================================================== */
@media (max-width: 768px) {
  .nav-rail {
    display: none; /* Hide sticky rail on mobile */
  }
  
  .jump-to-trigger {
    display: block; /* Show drawer trigger */
  }

  .paper-column {
    padding: 20px; /* Reduced padding */
    max-width: 100%;
  }

  .child-node {
    margin-left: 12px; /* Reduced indentation */
  }

  .question-body {
    font-size: 1rem;
  }
}

/* UTILITY: Focus */
:focus-visible {
  outline: 2px solid var(--focus-ring);
  outline-offset: 2px;
}
</style>
</head>
<body>

<!-- APP ROOT -->
<div id="app">
  <!-- Top Controls -->
  <header class="top-controls">
    <div class="top-controls-inner">
      <div class="brand" style="font-weight:700; font-size:1.1rem; color:var(--txt-primary);">RTQ Viewer</div>
      <select id="paper-selector" class="paper-selector" aria-label="Select Paper"></select>
      <button id="jump-to-trigger" class="jump-to-trigger">Jump to</button>
    </div>
  </header>

  <!-- Document Shell -->
  <div class="document-frame-shell">
    <!-- Nav Rail (Desktop) -->
    <aside class="nav-rail no-scrollbar">
      <nav id="desktop-nav" class="nav-list" aria-label="Document Navigation"></nav>
    </aside>

    <!-- Paper Content -->
    <main class="paper-column">
      <div id="paper-content" class="paper-surface">
        <!-- Dynamic Content Injected Here -->
        <div style="padding: 40px; color: var(--txt-secondary);">Loading payload...</div>
      </div>
    </main>
  </div>

  <!-- Mobile Drawer -->
  <div id="drawer-overlay" class="mobile-drawer-overlay"></div>
  <div id="drawer" class="mobile-drawer" aria-hidden="true">
    <div class="drawer-header">
      <span class="drawer-title">Jump to</span>
      <button id="drawer-close" class="drawer-close">&times;</button>
    </div>
    <div class="drawer-content no-scrollbar">
      <nav id="mobile-nav" class="nav-list"></nav>
    </div>
  </div>
</div>

<script>
/**
 * STAGE 0: CONSTANTS
 * Single Source of Truth
 */
const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

// --- Markdown renderer (authoritative config) ---
const md = window.markdownit
  ? window.markdownit({
      html: true, // allow inline SVG and other inline HTML in payload Markdown
      linkify: true,
      breaks: false, // MUST stay false: prevents <br> inside $...$ / $$...$$
    })
  : null;

if (md) {
  // Preserve TeX backslashes: do not let markdown-it escape them before KaTeX runs
  md.inline.ruler.disable(["escape"]);
}

/**
 * STATE MANAGEMENT
 */
const state = {
  papers: [],
  currentPaper: null,
  expandedMap: {}, // Map<questionId, boolean>
  mobileDrawerOpen: false
};

/**
 * DOM ELEMENTS
 */
const els = {
  paperSelector: document.getElementById('paper-selector'),
  desktopNav: document.getElementById('desktop-nav'),
  mobileNav: document.getElementById('mobile-nav'),
  paperContent: document.getElementById('paper-content'),
  jumpTrigger: document.getElementById('jump-to-trigger'),
  drawer: document.getElementById('drawer'),
  drawerOverlay: document.getElementById('drawer-overlay'),
  drawerClose: document.getElementById('drawer-close'),
  body: document.body
};

/**
 * INITIALIZATION
 */
async function init() {
  try {
    const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
    if (!response.ok) throw new Error("Payload not found");
    const payload = await response.json();
    
    if (!payload.papers || payload.papers.length === 0) {
      throw new Error("No papers in payload");
    }

    state.papers = payload.papers;
    renderSelector();
    loadPaper(state.papers[0].key);

  } catch (err) {
    console.error(err);
    els.paperContent.innerHTML = `
      <div style="padding:40px; text-align:center; color: var(--txt-secondary);">
        <h2 style="color:var(--txt-primary)">PAPERS PAYLOAD MISSING</h2>
        <p>Could not load from ${RTQ_PAPERS_PAYLOAD_PATH}</p>
      </div>
    `;
  }

  setupEventListeners();
}

/**
 * CORE LOGIC
 */

function renderSelector() {
  els.paperSelector.innerHTML = state.papers.map(p => 
    `<option value="${p.key}">${p.label}</option>`
  ).join('');
}

function loadPaper(paperKey) {
  const paper = state.papers.find(p => p.key === paperKey);
  if (!paper) return;

  state.currentPaper = paper;
  
  // Reset expanded map based on defaults
  state.expandedMap = {};
  const defaultExpanded = paper.defaults?.expandedAll !== false;
  
  // Helper to init state
  const traverse = (nodes) => {
    nodes.forEach(n => {
      if (n.solutionBlock?.solutionDetails) {
        state.expandedMap[n.id] = defaultExpanded;
      }
      if (n.children) traverse(n.children);
    });
  };

  if (paper.questions) traverse(paper.questions);
  if (paper.sections) paper.sections.forEach(s => traverse(s.questions));

  renderPaperContent();
  renderNavigation();
  
  // Trigger KaTeX
  if (window.renderMathInElement) {
    window.renderMathInElement(els.paperContent, {
      delimiters: [
        {left: '$$', right: '$$', display: true},
        {left: '$', right: '$', display: false}
      ],
      throwOnError: false
    });
  }
}

/**
 * RENDERING: PAPER CONTENT
 */
function renderPaperContent() {
  const paper = state.currentPaper;
  let html = '';

  if (paper.sections) {
    paper.sections.forEach(section => {
      // Section Header (only if label present)
      if (section.label && section.label.trim().length > 0) {
        html += `<div class="section-header">${escapeHtml(section.label)}</div>`;
      }
      html += renderQuestionList(section.questions);
    });
  } else {
    html += renderQuestionList(paper.questions);
  }

  els.paperContent.innerHTML = html;
}

function renderQuestionList(questions) {
  return questions.map(q => renderQuestionNode(q, 0)).join('');
}

function renderQuestionNode(node, depth) {
  const hasChildren = node.children && node.children.length > 0;
  const isExpanded = state.expandedMap[node.id];
  const hasSolutionBlock = !!node.solutionBlock;
  const hasAnswer = hasSolutionBlock && !!node.solutionBlock.answer;
  const hasDetails = hasSolutionBlock && !!node.solutionBlock.solutionDetails;

  // Render children recursively
  let childrenHtml = '';
  if (hasChildren) {
    childrenHtml = `
      <div class="children-container">
        ${node.children.map(child => renderQuestionNode(child, depth + 1)).join('')}
      </div>
    `;
  }

  // Question Body
  const qHtml = renderMarkdown(node.question);

  // Answer
  let answerHtml = '';
  if (hasAnswer) {
    answerHtml = `
      <div class="answer-region">
        <span class="answer-label">Answer</span>
        <div class="answer-content md-content">${renderMarkdown(node.solutionBlock.answer)}</div>
      </div>
    `;
  }

  // Solution Details
  let detailsHtml = '';
  let toggleHtml = '';

  if (hasDetails) {
    const details = node.solutionBlock.solutionDetails;
    const expandedClass = isExpanded ? 'expanded' : '';
    const ariaExpanded = isExpanded ? 'true' : 'false';
    const labelText = isExpanded ? 'Hide working' : 'Show working';

    toggleHtml = `
      <button class="disclosure-control" data-id="${node.id}" aria-expanded="${ariaExpanded}">
        <span class="disclosure-label">${labelText}</span>
        <svg class="disclosure-icon" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
      </button>
    `;

    // Construct internal blocks
    let internalHtml = '';

    // Keep in mind
    if (details.keepInMind) {
      internalHtml += `
        <div class="sd-subsection sd-keep-in-mind">
          <div class="sd-label"><svg class="sd-icon-marker" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg> Keep in mind</div>
          <div class="md-content">${renderMarkdown(details.keepInMind)}</div>
        </div>
      `;
    }

    // Formulas used
    if (details.formulasUsed) {
      internalHtml += `
        <div class="sd-subsection sd-formulas-used">
          <div class="sd-label">Formulas used</div>
          <div class="md-content">${renderMarkdown(details.formulasUsed)}</div>
        </div>
      `;
    }

    // Working
    if (details.working) {
      internalHtml += `
        <div class="sd-subsection sd-working">
          <div class="sd-label">Working</div>
          <div class="md-content">${renderMarkdown(details.working)}</div>
        </div>
      `;
    }

    // Alternative Working
    if (details.alternativeWorking && Array.isArray(details.alternativeWorking)) {
      details.alternativeWorking.forEach((alt, idx) => {
        internalHtml += `
          <div class="alt-working-separator"></div>
          <div class="sd-subsection sd-alt-working">
            <div class="sd-label">Alternative working</div>
            <div class="md-content">${renderMarkdown(alt)}</div>
          </div>
        `;
      });
    }

    detailsHtml = `
      <div class="solution-details ${expandedClass}" id="details-${node.id}">
        ${internalHtml}
      </div>
    `;
  }

  // Wrapper class for indentation logic
  const wrapperClass = depth > 0 ? 'question-node child-node' : 'question-node';

  // Construct final node HTML
  // Note: Solution Block renders conditionally
  let solutionBlockHtml = '';
  if (hasSolutionBlock) {
    solutionBlockHtml = `
      <div class="solution-block">
        ${answerHtml}
        ${toggleHtml}
        ${detailsHtml}
      </div>
    `;
  }

  return `
    <div class="${wrapperClass}" id="q-${node.id}">
      <div class="question-body">
        <span class="question-identifier">${node.id}</span>
        <span class="md-content">${qHtml}</span>
      </div>
      ${solutionBlockHtml}
      ${childrenHtml}
    </div>
  `;
}

/**
 * RENDERING: NAVIGATION
 */
function renderNavigation() {
  const paper = state.currentPaper;
  let html = '';

  const renderItem = (q, depth) => {
    // Stage 5.4.5: Hierarchy via type scale/weight, flat list
    // We use a simpler data attribute for potential CSS styling, but strictly flat DOM structure
    let style = '';
    if (depth === 1) style = 'font-size: 0.85em; color: var(--txt-tertiary);';
    if (depth > 1) style = 'font-size: 0.8em; color: var(--txt-tertiary); opacity: 0.9;';

    let itemHtml = `<a class="nav-item" data-target="q-${q.id}" style="${style}">${q.id}</a>`;
    
    if (q.children) {
      itemHtml += q.children.map(c => renderItem(c, depth + 1)).join('');
    }
    return itemHtml;
  };

  if (paper.sections) {
    paper.sections.forEach(section => {
      if (section.label && section.label.trim().length > 0) {
        html += `<div class="nav-section-label">${escapeHtml(section.label)}</div>`;
      }
      html += section.questions.map(q => renderItem(q, 0)).join('');
    });
  } else {
    html += paper.questions.map(q => renderItem(q, 0)).join('');
  }

  // Populate both navigations
  els.desktopNav.innerHTML = html;
  els.mobileNav.innerHTML = html;
}

/**
 * UTILS
 */
function renderMarkdown(text) {
  if (!text) return '';
  if (!md) return text; // Fallback
  return md.render(text);
}

function escapeHtml(str) {
  if (!str) return '';
  return str.replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
}

function toggleDrawer(isOpen) {
  state.mobileDrawerOpen = isOpen;
  if (isOpen) {
    els.body.classList.add('drawer-open');
    els.drawer.setAttribute('aria-hidden', 'false');
  } else {
    els.body.classList.remove('drawer-open');
    els.drawer.setAttribute('aria-hidden', 'true');
  }
}

/**
 * EVENT LISTENERS
 */
function setupEventListeners() {
  // Paper Switching
  els.paperSelector.addEventListener('change', (e) => {
    loadPaper(e.target.value);
  });

  // Mobile Drawer Triggers
  els.jumpTrigger.addEventListener('click', () => toggleDrawer(true));
  els.drawerClose.addEventListener('click', () => toggleDrawer(false));
  els.drawerOverlay.addEventListener('click', () => toggleDrawer(false));

  // Navigation Click Delegation (Desktop & Mobile)
  const handleNavClick = (e) => {
    if (e.target.classList.contains('nav-item')) {
      e.preventDefault();
      const targetId = e.target.getAttribute('data-target');
      const targetEl = document.getElementById(targetId);
      
      if (targetEl) {
        // Smooth scroll
        targetEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
        
        // Update Active State
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        // Activate all instances of this item (desktop & mobile)
        document.querySelectorAll(`.nav-item[data-target="${targetId}"]`).forEach(el => el.classList.add('active'));

        // Close drawer if open
        if (state.mobileDrawerOpen) toggleDrawer(false);
      }
    }
  };

  els.desktopNav.addEventListener('click', handleNavClick);
  els.mobileNav.addEventListener('click', handleNavClick);

  // Content Interactions (Show/Hide Working)
  els.paperContent.addEventListener('click', (e) => {
    const btn = e.target.closest('.disclosure-control');
    if (btn) {
      const qId = btn.getAttribute('data-id');
      const current = state.expandedMap[qId];
      state.expandedMap[qId] = !current;
      
      // Re-render is expensive, better to just toggle DOM classes for performance and stability
      // BUT for prototype simplicity/correctness with HTML injection, we could re-render content partially.
      // Better approach: toggle class and update text manually to avoid KaTeX re-flow issues.
      
      const detailsEl = document.getElementById(`details-${qId}`);
      if (detailsEl) {
        if (!current) {
          detailsEl.classList.add('expanded');
          btn.setAttribute('aria-expanded', 'true');
          btn.querySelector('.disclosure-label').textContent = 'Hide working';
        } else {
          detailsEl.classList.remove('expanded');
          btn.setAttribute('aria-expanded', 'false');
          btn.querySelector('.disclosure-label').textContent = 'Show working';
        }
      }
    }
  });

  // Scroll Spy for Nav Active State
  let scrollTimeout;
  window.addEventListener('scroll', () => {
    if (scrollTimeout) return;
    scrollTimeout = setTimeout(() => {
      scrollTimeout = null;
      // Simple spy logic: find first question near top
      const questions = document.querySelectorAll('.question-node');
      let activeId = null;
      for (let q of questions) {
        const rect = q.getBoundingClientRect();
        if (rect.top >= 0 && rect.top < window.innerHeight / 2) {
          activeId = q.id;
          break;
        }
      }
      if (activeId) {
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.querySelectorAll(`.nav-item[data-target="${activeId}"]`).forEach(el => el.classList.add('active'));
      }
    }, 100);
  });
}

// Start
init();

</script>
</body>
</html>
