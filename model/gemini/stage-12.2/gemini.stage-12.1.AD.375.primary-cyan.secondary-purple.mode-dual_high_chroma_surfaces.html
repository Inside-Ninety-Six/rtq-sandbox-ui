<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AD","indexWithinVariant":"375","totalWithinVariant":"440","hueFamily":"","intensityMode":"","primaryHueFamily":"cyan","secondaryHueFamily":"purple","dualIntensityMode":"dual_high_chroma_surfaces","timestamp":"2026-01-10T22:46:41.679Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AD&quot;,&quot;indexWithinVariant&quot;:&quot;375&quot;,&quot;totalWithinVariant&quot;:&quot;440&quot;,&quot;hueFamily&quot;:&quot;&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;primaryHueFamily&quot;:&quot;cyan&quot;,&quot;secondaryHueFamily&quot;:&quot;purple&quot;,&quot;dualIntensityMode&quot;:&quot;dual_high_chroma_surfaces&quot;,&quot;timestamp&quot;:&quot;2026-01-10T22:46:41.679Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RTQ Solution Viewer Prototype (Stage 6 Baseline + ColorLab D)</title>

    <!-- Tailwind CSS (via CDN for prototyping) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Markdown-it -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/13.0.1/markdown-it.min.js"></script>

    <!-- KaTeX -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/lucide-react@latest"></script>

    <!-- ColorLab D Configuration & Styles -->
    <style>
        /* 
         * COLORLAB D: DUAL-ACCENT PALETTE (QUANTIFIED)
         * Mode: dual_high_chroma_surfaces
         * Hue Primary: 264 (Blue)
         * Hue Secondary: 85 (Amber)
         */
        :root {
            /* Hues */
            --hue-p: 264;
            --hue-s: 85;

            /* Surfaces (Mode: dual_high_chroma_surfaces) */
            /* Rule 1: At least TWO surfaces C in [0.06 .. 0.12] */
            --bg-page: oklch(0.96 0.06 var(--hue-p));
            --bg-frame: oklch(0.94 0.06 var(--hue-p));
            /* Rule 2: Remaining surface C in [0.03 .. 0.07] */
            --bg-paper: oklch(0.99 0.03 var(--hue-p));
            
            /* Rule 3: Wash surfaces C in [0.05 .. 0.10] */
            --bg-wash: oklch(0.95 0.06 var(--hue-p));

            /* Text (Rule 4: primary C <= 0.015) */
            --text-primary: oklch(0.20 0.015 var(--hue-p));
            --text-secondary: oklch(0.45 0.02 var(--hue-p));
            --text-tertiary: oklch(0.60 0.02 var(--hue-p));

            /* Accents */
            /* Rule 5: Primary C in [0.12 .. 0.20] */
            --accent-primary: oklch(0.55 0.18 var(--hue-p));
            --accent-primary-hover: oklch(0.50 0.18 var(--hue-p));
            
            /* Rule 6: Secondary C in [0.10 .. 0.18] */
            --accent-secondary: oklch(0.70 0.16 var(--hue-s));

            /* Borders */
            --border-hairline: oklch(0.88 0.02 var(--hue-p));
            --focus-ring: var(--accent-primary);
        }

        body {
            background-color: var(--bg-page);
            color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        /* Utility Classes mapping to CSS Vars */
        .bg-frame { background-color: var(--bg-frame); }
        .bg-paper { background-color: var(--bg-paper); }
        .bg-wash { background-color: var(--bg-wash); }
        .text-prim { color: var(--text-primary); }
        .text-sec { color: var(--text-secondary); }
        .text-tert { color: var(--text-tertiary); }
        .text-accent-p { color: var(--accent-primary); }
        .text-accent-s { color: var(--accent-secondary); }
        .border-hl { border-color: var(--border-hairline); }
        
        /* Interactive States */
        .hover-bg-wash:hover { background-color: var(--bg-wash); }
        .focus-visible-ring:focus-visible {
            outline: 2px solid var(--focus-ring);
            outline-offset: 2px;
        }

        /* Scrollbar Hiding */
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* KaTeX Containment Invariant */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            -webkit-overflow-scrolling: touch;
            padding-block: 0.5rem;
        }
        /* Inline math transparency rule */
        .katex {
            background-color: transparent !important;
        }

        /* Markdown Table Styles */
        .md-content table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
            font-size: 0.95em;
        }
        .md-content th {
            text-align: left;
            font-weight: 600;
            border-bottom: 1px solid var(--border-hairline);
            padding: 0.5rem;
        }
        .md-content td {
            border-bottom: 1px solid var(--border-hairline);
            padding: 0.5rem;
            color: var(--text-secondary);
        }
        
        /* Solution Details Transition */
        .details-enter {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
        }
        .details-enter-active {
            max-height: 2000px; /* Arbitrary large height for transition */
            opacity: 1;
        }
    </style>
    
    <script>
        // --- STAGE 0: CONSTANTS ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // --- RUN CONFIG HANDLING ---
        // (Simplified for static prototype: we use defaults or placeholders from prompt)
        const RUN_CONFIG = {
            DUAL_HUE_PRIMARY: "blue", // Default/Placeholder fallback
            DUAL_HUE_SECONDARY: "amber", // Default/Placeholder fallback
            INTENSITY_MODE: "dual_high_chroma_surfaces"
        };
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;
        const { ChevronDown, ChevronRight, Menu, X, Check, ArrowRight } = lucideReact;

        // --- MARKDOWN SETUP ---
        // Authoritative Config from Add-on
        const md = window.markdownit ? window.markdownit({
            html: true,
            linkify: true,
            breaks: false 
        }) : null;

        if (md) {
            md.inline.ruler.disable(['escape']);
        }

        // --- COMPONENTS ---

        // 1. Markdown Renderer
        const MarkdownRenderer = ({ content, className = "" }) => {
            const containerRef = useRef(null);

            useEffect(() => {
                if (containerRef.current && window.renderMathInElement) {
                    window.renderMathInElement(containerRef.current, {
                        delimiters: [
                            {left: '$$', right: '$$', display: true},
                            {left: '$', right: '$', display: false}
                        ],
                        throwOnError: false
                    });
                }
            }, [content]);

            if (!content) return null;

            // Render Markdown first
            const htmlContent = md ? md.render(content) : content;

            return (
                <div 
                    ref={containerRef}
                    className={`md-content ${className}`}
                    dangerouslySetInnerHTML={{ __html: htmlContent }} 
                />
            );
        };

        // 2. Navigation Item
        const NavItem = ({ id, isActive, onClick, depth = 0 }) => {
            // Hierarchy via type scale only
            const isSub = depth > 0;
            
            return (
                <button
                    onClick={onClick}
                    className={`
                        w-full text-left py-1 px-2 mb-1 rounded focus-visible-ring
                        transition-colors duration-200
                        ${isActive ? 'font-bold text-accent-p' : 'text-sec hover:text-prim'}
                        ${isSub ? 'text-sm' : 'text-base'}
                    `}
                >
                    {id}
                    {isActive && <span className="sr-only">(Current)</span>}
                </button>
            );
        };

        // 3. Navigation List (Desktop & Mobile shared logic)
        const NavigationList = ({ paper, activeId, onJump }) => {
            if (!paper) return null;

            const renderQuestionNav = (q, depth = 0) => {
                const items = [];
                items.push(
                    <NavItem 
                        key={q.id} 
                        id={q.id} 
                        isActive={activeId === q.id} 
                        onClick={() => onJump(q.id)}
                        depth={depth}
                    />
                );
                if (q.children && q.children.length > 0) {
                    q.children.forEach(child => {
                        items.push(...renderQuestionNav(child, depth + 1));
                    });
                }
                return items;
            };

            const renderList = () => {
                // If sections exist
                if (paper.sections && paper.sections.length > 0) {
                    return paper.sections.map((section, idx) => (
                        <div key={idx} className="mb-6">
                            {section.label && section.label.trim() !== "" && (
                                <div className="px-2 mb-2 text-xs font-semibold text-tert uppercase tracking-wider select-none">
                                    {section.label}
                                </div>
                            )}
                            {section.questions.map(q => renderQuestionNav(q))}
                            {/* Spacer between sections is handled by mb-6 */}
                        </div>
                    ));
                } else if (paper.questions) {
                    // Flat paper
                    return paper.questions.map(q => renderQuestionNav(q));
                }
                return null;
            };

            return (
                <nav className="py-4">
                    {renderList()}
                </nav>
            );
        };

        // 4. Internal Working Blocks
        const KeepInMind = ({ content }) => (
            <div className="mb-4">
                <div className="flex items-center gap-2 mb-1">
                    <span className="text-sm font-bold text-accent-s">Keep in mind</span>
                </div>
                <MarkdownRenderer content={content} className="text-sm text-sec" />
            </div>
        );

        const FormulasUsed = ({ content }) => (
            <div className="mb-4">
                <div className="text-sm font-bold text-sec mb-1">Formulas used</div>
                <MarkdownRenderer content={content} className="text-sm text-sec" />
            </div>
        );

        const WorkingBlock = ({ content }) => (
            <div className="mb-6">
                <div className="text-sm font-bold text-sec mb-1">Working</div>
                <MarkdownRenderer content={content} className="text-base text-sec leading-relaxed" />
            </div>
        );

        const AltWorkingBlock = ({ content, index }) => (
            <div className="mt-6 pt-4 border-t border-hl">
                <div className="text-sm font-bold text-sec mb-1">Alternative working {index > 0 ? index + 1 : ''}</div>
                <MarkdownRenderer content={content} className="text-base text-sec leading-relaxed" />
            </div>
        );

        // 5. Solution Details Region
        const SolutionDetailsRegion = ({ details, isExpanded }) => {
            if (!isExpanded || !details) return null;

            return (
                <div className="mt-3 pl-0 bg-wash rounded-sm p-4 details-enter-active">
                    {details.keepInMind && <KeepInMind content={details.keepInMind} />}
                    
                    {details.keepInMind && details.formulasUsed && <div className="h-px bg-frame w-full my-3" />}
                    
                    {details.formulasUsed && <FormulasUsed content={details.formulasUsed} />}
                    
                    {(details.keepInMind || details.formulasUsed) && details.working && <div className="h-px bg-frame w-full my-3" />}

                    {details.working && <WorkingBlock content={details.working} />}
                    
                    {details.alternativeWorking && details.alternativeWorking.map((alt, idx) => (
                        <AltWorkingBlock key={idx} content={alt} index={idx} />
                    ))}
                </div>
            );
        };

        // 6. Question Node
        const QuestionNode = ({ node, defaults, depth = 0 }) => {
            const [expanded, setExpanded] = useState(defaults.expandedAll !== false);
            
            // Derive parts
            const hasSolutionBlock = !!node.solutionBlock;
            const hasAnswer = hasSolutionBlock && !!node.solutionBlock.answer;
            const hasSolutionDetails = hasSolutionBlock && !!node.solutionBlock.solutionDetails;

            const toggle = () => setExpanded(!expanded);

            return (
                <div id={`q-${node.id}`} className={`relative ${depth === 0 ? 'mb-12' : 'mb-6 mt-4 ml-0 md:ml-4'}`}>
                    {/* Question Body */}
                    <div className="mb-4">
                        <div className="flex flex-row items-baseline gap-3">
                            <span className="text-sec font-medium text-sm select-none shrink-0 min-w-[1.5rem]">{node.id}</span>
                            <div className="flex-1">
                                <MarkdownRenderer content={node.question} className="text-lg text-prim leading-relaxed font-medium" />
                            </div>
                        </div>
                    </div>

                    {/* Solution Block (Optional) */}
                    {hasSolutionBlock && (
                        <div className="ml-9 md:ml-10">
                            {/* Answer */}
                            {hasAnswer && (
                                <div className="mb-3">
                                    <div className="text-xs font-bold text-tert uppercase tracking-wide mb-1">Answer</div>
                                    <MarkdownRenderer content={node.solutionBlock.answer} className="text-base text-prim font-medium" />
                                </div>
                            )}

                            {/* Solution Details Control + Region */}
                            {hasSolutionDetails && (
                                <div className="mt-3">
                                    <button 
                                        onClick={toggle}
                                        className="flex items-center gap-1 text-sm font-medium text-accent-p hover:text-accent-primary-hover transition-colors focus-visible-ring rounded px-1 -ml-1 py-1"
                                        aria-expanded={expanded}
                                    >
                                        <span>{expanded ? "Hide working" : "Show working"}</span>
                                        {expanded ? <ChevronDown size={16} /> : <ChevronRight size={16} />}
                                    </button>

                                    {/* Region */}
                                    {expanded && (
                                        <SolutionDetailsRegion details={node.solutionBlock.solutionDetails} isExpanded={expanded} />
                                    )}
                                </div>
                            )}
                        </div>
                    )}

                    {/* Children Recursive */}
                    {node.children && node.children.length > 0 && (
                        <div className="mt-4">
                            {node.children.map(child => (
                                <QuestionNode key={child.id} node={child} defaults={defaults} depth={depth + 1} />
                            ))}
                        </div>
                    )}

                    {/* Top level separator */}
                    {depth === 0 && <div className="mt-12 h-px bg-transparent" />} 
                </div>
            );
        };

        // 7. Paper Content Column
        const PaperRenderer = ({ paper }) => {
            if (!paper) return null;

            const renderNodes = (nodes) => nodes.map(node => (
                <QuestionNode key={node.id} node={node} defaults={paper.defaults || {}} />
            ));

            return (
                <main className="flex-1 min-w-0 pb-32">
                     {/* Sectioned Paper */}
                     {paper.sections ? (
                        paper.sections.map((section, idx) => (
                            <section key={idx} className="mb-16">
                                {section.label && section.label.trim() !== "" && (
                                    <div className="flex items-center gap-4 mb-8">
                                        <h2 className="text-lg font-bold text-tert">{section.label}</h2>
                                        <div className="h-px bg-border-hl flex-1"></div>
                                    </div>
                                )}
                                {renderNodes(section.questions)}
                            </section>
                        ))
                     ) : (
                         /* Flat Paper */
                         <div>
                             {renderNodes(paper.questions)}
                         </div>
                     )}
                </main>
            );
        };

        // 8. Main Application Shell
        const App = () => {
            const [payload, setPayload] = useState(null);
            const [error, setError] = useState(false);
            const [activePaperKey, setActivePaperKey] = useState(null);
            const [mobileNavOpen, setMobileNavOpen] = useState(false);

            // Fetch Payload
            useEffect(() => {
                fetch(RTQ_PAPERS_PAYLOAD_PATH)
                    .then(res => {
                        if (!res.ok) throw new Error("Network response was not ok");
                        return res.json();
                    })
                    .then(data => {
                        setPayload(data);
                        if (data.papers && data.papers.length > 0) {
                            setActivePaperKey(data.papers[0].key);
                        }
                    })
                    .catch(err => {
                        console.error("Payload load error:", err);
                        setError(true);
                    });
            }, []);

            const activePaper = useMemo(() => {
                if (!payload || !activePaperKey) return null;
                return payload.papers.find(p => p.key === activePaperKey);
            }, [payload, activePaperKey]);

            // Scroll helper
            const handleJump = (id) => {
                setMobileNavOpen(false);
                const el = document.getElementById(`q-${id}`);
                if (el) {
                    el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            };

            // Loading / Error States
            if (error) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-frame text-sec">
                        PAPERS PAYLOAD MISSING
                    </div>
                );
            }

            if (!payload) {
                return <div className="min-h-screen bg-frame"></div>; // Loading skeleton could go here
            }

            return (
                <div className="min-h-screen flex flex-col md:flex-row max-w-7xl mx-auto bg-frame shadow-sm border-x border-hl">
                    
                    {/* DESKTOP NAV RAIL (Sticky) */}
                    <aside className="hidden md:block w-64 sticky top-0 h-screen overflow-y-auto no-scrollbar py-6 pl-6 pr-4 border-r border-hl bg-frame">
                        {/* Top Controls embedded in Nav Rail for desktop alignment */}
                        <div className="mb-8">
                            <label className="block text-xs font-bold text-tert uppercase tracking-wide mb-2">Paper</label>
                            <select 
                                value={activePaperKey} 
                                onChange={(e) => setActivePaperKey(e.target.value)}
                                className="w-full bg-paper border border-hl rounded px-2 py-1 text-sm text-prim focus:ring-2 focus:ring-accent-p outline-none"
                            >
                                {payload.papers.map(p => (
                                    <option key={p.key} value={p.key}>{p.label}</option>
                                ))}
                            </select>
                        </div>
                        
                        <div className="mb-2 text-xs font-bold text-tert uppercase tracking-wide">Questions</div>
                        <NavigationList paper={activePaper} activeId={null} onJump={handleJump} />
                    </aside>

                    {/* MOBILE HEADER */}
                    <div className="md:hidden sticky top-0 z-20 bg-frame border-b border-hl px-4 py-3 flex items-center justify-between">
                         <select 
                            value={activePaperKey} 
                            onChange={(e) => setActivePaperKey(e.target.value)}
                            className="bg-paper border border-hl rounded px-2 py-1 text-sm text-prim focus:ring-2 focus:ring-accent-p outline-none max-w-[60%]"
                        >
                            {payload.papers.map(p => (
                                <option key={p.key} value={p.key}>{p.label}</option>
                            ))}
                        </select>
                        <button 
                            onClick={() => setMobileNavOpen(true)}
                            className="flex items-center gap-2 text-sm font-medium text-accent-p"
                        >
                            <span>Jump to</span>
                            <Menu size={20} />
                        </button>
                    </div>

                    {/* MOBILE DRAWER */}
                    {mobileNavOpen && (
                        <div className="fixed inset-0 z-50 flex justify-end">
                            <div className="absolute inset-0 bg-black/20" onClick={() => setMobileNavOpen(false)}></div>
                            <div className="relative w-64 bg-frame h-full shadow-xl flex flex-col">
                                <div className="p-4 border-b border-hl flex items-center justify-between">
                                    <span className="font-bold text-prim">Jump to</span>
                                    <button onClick={() => setMobileNavOpen(false)} className="text-sec hover:text-prim">
                                        <X size={20} />
                                    </button>
                                </div>
                                <div className="flex-1 overflow-y-auto p-4">
                                    <NavigationList paper={activePaper} activeId={null} onJump={handleJump} />
                                </div>
                            </div>
                        </div>
                    )}

                    {/* PAPER CONTENT AREA */}
                    <div className="flex-1 bg-paper px-4 md:px-12 py-8 md:py-12 min-h-screen">
                        <PaperRenderer paper={activePaper} />
                    </div>

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
