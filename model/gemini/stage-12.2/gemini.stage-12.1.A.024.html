<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"A","indexWithinVariant":"24","totalWithinVariant":"50","hueFamily":"","intensityMode":"","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-08T12:15:38.172Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;A&quot;,&quot;indexWithinVariant&quot;:&quot;24&quot;,&quot;totalWithinVariant&quot;:&quot;50&quot;,&quot;hueFamily&quot;:&quot;&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-08T12:15:38.172Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Viewer</title>

    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 2. KaTeX CSS & JS (No SRI, No Integrity) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- 3. Markdown-it -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <!-- 4. Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* BASE SETTINGS - ColorLab A: Light Mode Palette Freedom */
        :root {
            /* Using a crisp, professional slate/indigo palette */
            --color-bg-page: #f8fafc; /* slate-50 */
            --color-bg-paper: #ffffff; /* white */
            --color-text-primary: #0f172a; /* slate-900 */
            --color-text-secondary: #475569; /* slate-600 */
            --color-text-tertiary: #94a3b8; /* slate-400 */
            --color-border-hairline: #e2e8f0; /* slate-200 */
            --color-accent: #4f46e5; /* indigo-600 */
            --color-accent-subtle: #e0e7ff; /* indigo-100 */
            --color-focus-ring: #6366f1; /* indigo-500 */
        }

        body {
            background-color: var(--color-bg-page);
            color: var(--color-text-primary);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* UTILITIES */
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* KATEX CONTAINMENT INVARIANT */
        /* Ensure display math never overflows page, scrolls internally */
        .katex-display {
            max-width: 100%;
            overflow-x: auto;
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
            padding-top: 0.5em;
            padding-bottom: 0.5em;
        }
        /* No background on inline math */
        .katex {
            font-size: 1.1em;
        }
        
        /* TABLE STYLES (Minimal/Structural) */
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 0.75rem;
            margin-bottom: 0.75rem;
            font-size: 0.95em;
        }
        th, td {
            border: 1px solid var(--color-border-hairline);
            padding: 0.5rem;
            text-align: left;
            vertical-align: top;
        }
        th {
            font-weight: 600;
            background-color: transparent; /* No fill */
        }

        /* FOCUS VISIBILITY (Accessibility) */
        *:focus-visible {
            outline: 2px solid var(--color-focus-ring);
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* MARKDOWN ELEMENTS */
        .md-content p {
            margin-bottom: 0.75em;
            line-height: 1.6;
        }
        .md-content p:last-child {
            margin-bottom: 0;
        }
        .md-content ul {
            list-style-type: disc;
            padding-left: 1.25em;
            margin-bottom: 0.75em;
        }
        .md-content ol {
            list-style-type: decimal;
            padding-left: 1.25em;
            margin-bottom: 0.75em;
        }

        /* SUBTLE ANIMATIONS (Continuity) */
        .details-enter-active, .details-leave-active {
            transition: all 0.2s ease-out;
            overflow: hidden;
        }
        
        /* LAYOUT HELPERS */
        .sticky-nav-container {
            position: sticky;
            top: 1rem;
            max-height: calc(100vh - 2rem);
            overflow-y: auto;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- APP ROOT -->
    <div id="root" class="w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex-grow flex flex-col">
        <!-- JS will render content here -->
        <div class="py-12 text-center text-slate-500">
            <span class="animate-pulse">Loading Papers Payload...</span>
        </div>
    </div>

    <!-- MAIN SCRIPT -->
    <script>
        // --- STAGE 0: CONSTANTS ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // --- STATE & CONFIG ---
        const state = {
            papers: [],
            currentPaperId: null,
            loading: true,
            error: null,
            expandedStates: {}, // Map<questionId, boolean>
            mobileNavOpen: false
        };

        // --- MARKDOWN SETUP ---
        // Configured per Stage 6 baseline requirements: html: true, breaks: false
        const md = window.markdownit ? window.markdownit({
            html: true,
            linkify: true,
            breaks: false 
        }) : null;

        if (md) {
            // Disable escape rule to preserve TeX backslashes
            md.inline.ruler.disable(['escape']);
        }

        // --- DOM ELEMENTS ---
        const root = document.getElementById('root');

        // --- UTILS ---
        function getPaper(id) {
            return state.papers.find(p => p.key === id);
        }

        function setPaper(id) {
            const paper = getPaper(id);
            if (!paper) return;

            state.currentPaperId = id;
            
            // Reset expansion states based on paper defaults
            state.expandedStates = {};
            const defaultExpanded = paper.defaults?.expandedAll !== false;
            
            // Helper to recursively set default state only for questions with solutionDetails
            const initExpanded = (nodes) => {
                if (!nodes) return;
                nodes.forEach(node => {
                    if (node.solutionBlock?.solutionDetails) {
                        state.expandedStates[node.id] = defaultExpanded;
                    }
                    if (node.children) initExpanded(node.children);
                });
            };

            if (paper.sections) {
                paper.sections.forEach(s => initExpanded(s.questions));
            } else if (paper.questions) {
                initExpanded(paper.questions);
            }
            
            render();
            // Scroll to top
            window.scrollTo(0, 0);
        }

        function toggleWorking(qId) {
            state.expandedStates[qId] = !state.expandedStates[qId];
            render(); // Re-render to update DOM
        }

        function toggleMobileNav() {
            state.mobileNavOpen = !state.mobileNavOpen;
            render();
        }

        function closeMobileNav() {
            state.mobileNavOpen = false;
            render();
        }

        function scrollToQuestion(qId) {
            const el = document.getElementById(`q-${qId}`);
            if (el) {
                // Smooth scroll with offset for sticky headers if any (none in this design, but good practice)
                const y = el.getBoundingClientRect().top + window.scrollY - 20; 
                window.scrollTo({top: y, behavior: 'smooth'});
                closeMobileNav();
            }
        }

        // --- RENDERERS ---

        // Render Markdown content safely
        function renderMd(content) {
            if (!content) return '';
            if (!md) return content; // Fallback
            return md.render(content);
        }

        // --- COMPONENT: PAPER SELECTOR ---
        function renderTopControls() {
            const papers = state.papers;
            const current = getPaper(state.currentPaperId);

            return `
                <div class="flex items-center justify-between py-6 border-b border-slate-200 mb-8 sticky top-0 bg-[var(--color-bg-page)] z-20">
                    <div class="flex items-center gap-4">
                        <label for="paper-select" class="text-sm font-medium text-slate-500">Paper</label>
                        <div class="relative">
                            <select 
                                id="paper-select" 
                                onchange="setPaper(this.value)"
                                class="appearance-none bg-white border border-slate-300 text-slate-900 text-sm rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5 pr-8 transition-shadow cursor-pointer hover:border-slate-400"
                            >
                                ${papers.map(p => `<option value="${p.key}" ${p.key === state.currentPaperId ? 'selected' : ''}>${p.label}</option>`).join('')}
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-500">
                                <i data-lucide="chevron-down" class="w-4 h-4"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Mobile Jump To Trigger -->
                    <button 
                        onclick="toggleMobileNav()"
                        class="lg:hidden flex items-center gap-2 text-sm font-medium text-indigo-600 hover:text-indigo-800 transition-colors px-3 py-2 rounded-md hover:bg-indigo-50"
                    >
                        <i data-lucide="menu" class="w-4 h-4"></i>
                        Jump to
                    </button>
                </div>
            `;
        }

        // --- COMPONENT: NAVIGATION (DESKTOP RAIL + MOBILE DRAWER) ---
        function renderNavList(isMobile = false) {
            const paper = getPaper(state.currentPaperId);
            if (!paper) return '';

            let html = '<nav class="space-y-1" aria-label="Question navigation">';

            const renderItem = (q) => {
                // Flatten children for navigation list? 
                // Brief says: "Navigation displays identifiers only. Visually flat. Hierarchy via type scale."
                // Since this is a list, we just render them in order.
                
                // We need a helper to iterate the tree into a flat list for the nav
                // or render recursively but style flatly. 
                // Brief: "Navigation must render as a flat list... no indentation".
                
                // Let's create a flat array of {id, depth, label} first for easier rendering
                const flatItems = [];
                const traverse = (nodes, depth = 0) => {
                    nodes.forEach(node => {
                        flatItems.push({ id: node.id, depth });
                        if (node.children) traverse(node.children, depth + 1);
                    });
                };
                
                if (paper.sections) {
                    paper.sections.forEach(section => {
                        // Section Header
                        if (section.label && section.label.trim() !== '') {
                            flatItems.push({ type: 'section', label: section.label });
                        }
                        traverse(section.questions);
                    });
                } else {
                    traverse(paper.questions);
                }

                return flatItems.map(item => {
                    if (item.type === 'section') {
                        return `
                            <div class="pt-4 pb-2 text-xs font-semibold text-slate-400 uppercase tracking-wider px-2 select-none">
                                ${item.label}
                            </div>
                        `;
                    }
                    
                    // Hierarchy via type scale/quietness (Depth 0 = normal, Depth > 0 = lighter/smaller)
                    // No indentation.
                    const isSub = item.depth > 0;
                    const baseClasses = "group flex items-center w-full px-2 py-1.5 text-sm font-medium rounded-md cursor-pointer transition-colors";
                    const activeClasses = "text-indigo-700 bg-indigo-50 font-semibold"; // Active logic would go here if we tracked scroll
                    const inactiveClasses = isSub 
                        ? "text-slate-500 hover:text-slate-900 hover:bg-slate-100" 
                        : "text-slate-700 hover:text-slate-900 hover:bg-slate-100";
                    
                    return `
                        <a 
                            onclick="scrollToQuestion('${item.id}'); return false;"
                            href="#q-${item.id}"
                            class="${baseClasses} ${inactiveClasses}"
                        >
                            <span class="${isSub ? 'opacity-80 text-xs' : ''}">${item.id}</span>
                        </a>
                    `;
                }).join('');
            };

            html += renderItem();
            html += '</nav>';
            return html;
        }

        function renderDesktopNav() {
            return `
                <div class="hidden lg:block w-64 flex-shrink-0 mr-12">
                    <div class="sticky-nav-container hide-scrollbar pl-1">
                        ${renderNavList(false)}
                    </div>
                </div>
            `;
        }

        function renderMobileNavDrawer() {
            if (!state.mobileNavOpen) return '';

            return `
                <div class="fixed inset-0 z-50 lg:hidden" role="dialog" aria-modal="true">
                    <!-- Backdrop -->
                    <div class="fixed inset-0 bg-slate-900/20 backdrop-blur-sm" onclick="toggleMobileNav()"></div>
                    
                    <!-- Drawer -->
                    <div class="fixed inset-y-0 right-0 w-full max-w-xs bg-white shadow-xl flex flex-col animate-in slide-in-from-right duration-200">
                        <div class="flex items-center justify-between px-4 py-4 border-b border-slate-100">
                            <h2 class="text-lg font-semibold text-slate-900">Jump to</h2>
                            <button onclick="closeMobileNav()" class="p-2 -mr-2 text-slate-500 hover:text-slate-900 rounded-md">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                        <div class="flex-1 overflow-y-auto p-4">
                            ${renderNavList(true)}
                        </div>
                    </div>
                </div>
            `;
        }

        // --- COMPONENT: SOLUTION DETAILS SUBSECTIONS ---
        
        function renderKeepInMind(content) {
            if (!content) return '';
            return `
                <div class="mb-4">
                    <div class="flex items-center gap-2 mb-2 text-indigo-600 font-bold text-sm uppercase tracking-wide">
                        <i data-lucide="lightbulb" class="w-4 h-4"></i>
                        <span>Keep in mind</span>
                    </div>
                    <div class="md-content text-slate-700 text-sm pl-0">
                        ${renderMd(content)}
                    </div>
                </div>
                <div class="h-px bg-slate-100 my-4"></div>
            `;
        }

        function renderFormulas(content) {
            if (!content) return '';
            return `
                <div class="mb-4">
                    <div class="text-slate-500 font-bold text-xs uppercase tracking-wide mb-2">Formulas used</div>
                    <div class="md-content text-slate-600 text-sm">
                        ${renderMd(content)}
                    </div>
                </div>
                <div class="h-px bg-slate-100 my-4"></div>
            `;
        }

        function renderWorking(content, label = "Working") {
            if (!content) return '';
            return `
                <div class="mb-6">
                    <div class="text-slate-900 font-semibold text-sm mb-3">${label}</div>
                    <div class="md-content text-slate-700 text-base leading-relaxed">
                        ${renderMd(content)}
                    </div>
                </div>
            `;
        }

        function renderAlternativeWorkings(workings) {
            if (!workings || workings.length === 0) return '';
            
            return workings.map((w, i) => `
                <div class="h-px bg-slate-200 my-6"></div> <!-- Separator from previous working -->
                ${renderWorking(w, "Alternative working")}
            `).join('');
        }

        // --- COMPONENT: QUESTION NODE ---
        function renderQuestionNode(node, depth = 0) {
            const isChild = depth > 0;
            const hasSolutionDetails = !!node.solutionBlock?.solutionDetails;
            const hasAnswer = !!node.solutionBlock?.answer;
            const isExpanded = state.expandedStates[node.id];
            
            // Indentation/Styling for children
            // Brief: "Vertical separation... Horizontal indentation (spacing only)"
            const indentClass = isChild ? 'ml-0 pl-4 border-l-2 border-slate-100' : ''; 
            const spacingClass = isChild ? 'mt-6' : 'mt-16 first:mt-0';
            const separatorClass = (!isChild && depth === 0) ? 'border-t border-slate-200 pt-12' : '';

            // Question Body
            const questionBody = `
                <div class="flex items-baseline gap-3 mb-4">
                    <span class="flex-shrink-0 font-bold text-slate-400 select-none text-sm font-mono pt-1">${node.id}</span>
                    <div class="md-content text-lg text-slate-900 font-medium flex-grow min-w-0">
                        ${renderMd(node.question)}
                    </div>
                </div>
            `;

            let solutionBlockHtml = '';
            
            if (node.solutionBlock) {
                // 1. Answer (Visible by default if present)
                let answerHtml = '';
                if (hasAnswer) {
                    answerHtml = `
                        <div class="flex items-baseline gap-3 mb-3">
                            <span class="flex-shrink-0 text-xs font-bold text-slate-500 uppercase tracking-wide w-12 text-right">Answer</span>
                            <div class="md-content text-slate-800 font-medium">
                                ${renderMd(node.solutionBlock.answer)}
                            </div>
                        </div>
                    `;
                }

                // 2. Disclosure Control (Only if details exist)
                let disclosureHtml = '';
                let detailsRegionHtml = '';
                
                if (hasSolutionDetails) {
                    const sd = node.solutionBlock.solutionDetails;
                    
                    disclosureHtml = `
                        <div class="flex items-center gap-3 mb-2">
                            <div class="w-12"></div> <!-- Spacer alignment with Answer label -->
                            <button 
                                onclick="toggleWorking('${node.id}')"
                                class="flex items-center gap-1.5 text-sm font-medium text-indigo-600 hover:text-indigo-700 transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-indigo-500 rounded-sm"
                                aria-expanded="${isExpanded}"
                                aria-controls="details-${node.id}"
                            >
                                <span class="hover:underline">${isExpanded ? 'Hide working' : 'Show working'}</span>
                                <i data-lucide="${isExpanded ? 'chevron-up' : 'chevron-down'}" class="w-4 h-4 transition-transform ${isExpanded ? '' : '-rotate-90'}"></i>
                            </button>
                        </div>
                    `;

                    if (isExpanded) {
                        detailsRegionHtml = `
                            <div id="details-${node.id}" class="mt-4 ml-12 pl-4 border-l border-indigo-100 animate-in fade-in slide-in-from-top-2 duration-200">
                                <!-- Solution Details Region -->
                                <div class="bg-slate-50/50 rounded-sm p-4 -ml-4"> <!-- Subtle surface wash -->
                                    ${renderKeepInMind(sd.keepInMind)}
                                    ${renderFormulas(sd.formulasUsed)}
                                    ${renderWorking(sd.working)}
                                    ${renderAlternativeWorkings(sd.alternativeWorking)}
                                </div>
                            </div>
                        `;
                    }
                }

                if (hasAnswer || hasSolutionDetails) {
                    solutionBlockHtml = `
                        <div class="mt-4">
                            ${answerHtml}
                            ${disclosureHtml}
                            ${detailsRegionHtml}
                        </div>
                    `;
                }
            }

            // Children
            let childrenHtml = '';
            if (node.children && node.children.length > 0) {
                childrenHtml = `
                    <div class="mt-6 flex flex-col gap-6">
                        ${node.children.map(child => renderQuestionNode(child, depth + 1)).join('')}
                    </div>
                `;
            }

            return `
                <div id="q-${node.id}" class="relative ${spacingClass} ${indentClass} ${separatorClass}">
                    ${questionBody}
                    ${solutionBlockHtml}
                    ${childrenHtml}
                </div>
            `;
        }

        // --- RENDER MAIN PAPER AREA ---
        function renderPaperContent() {
            const paper = getPaper(state.currentPaperId);
            if (!paper) return '';

            let contentHtml = '';

            if (paper.sections) {
                contentHtml = paper.sections.map((section, idx) => {
                    const headerHtml = (section.label && section.label.trim()) 
                        ? `<div class="text-xl font-bold text-slate-300 mb-8 border-b border-slate-100 pb-2">${section.label}</div>`
                        : '';
                    
                    const questionsHtml = section.questions.map(q => renderQuestionNode(q)).join('');
                    
                    return `
                        <div class="mb-16">
                            ${headerHtml}
                            ${questionsHtml}
                        </div>
                    `;
                }).join('');
            } else if (paper.questions) {
                contentHtml = paper.questions.map(q => renderQuestionNode(q)).join('');
            }

            return `
                <main class="w-full pb-32">
                    <div class="bg-white rounded-none lg:rounded-sm min-h-[50vh]">
                        ${contentHtml}
                    </div>
                </main>
            `;
        }

        // --- MAIN RENDER ---
        function render() {
            if (state.loading) {
                root.innerHTML = `<div class="py-20 text-center text-slate-500 animate-pulse">Loading paper data...</div>`;
                return;
            }

            if (state.error) {
                root.innerHTML = `
                    <div class="py-20 text-center">
                        <div class="text-red-600 font-bold mb-2">Error</div>
                        <div class="text-slate-600">${state.error}</div>
                    </div>
                `;
                return;
            }

            // RENDER SHELL
            root.innerHTML = `
                ${renderTopControls()}
                ${renderMobileNavDrawer()}
                
                <div class="flex flex-row relative items-start">
                    ${renderDesktopNav()}
                    ${renderPaperContent()}
                </div>
            `;

            // POST-RENDER EFFECTS
            // 1. Icons
            lucide.createIcons();

            // 2. KaTeX
            renderMathInElement(document.body, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false},
                    {left: '\\(', right: '\\)', display: false},
                    {left: '\\[', right: '\\]', display: true}
                ],
                throwOnError: false,
                output: 'html', // Accessible HTML
            });
        }

        // --- INIT ---
        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Failed to load payload");
                
                const data = await response.json();
                
                if (!data.papers || data.papers.length === 0) {
                    throw new Error("No papers found in payload");
                }

                state.papers = data.papers;
                
                // Set initial paper (first one)
                setPaper(data.papers[0].key);
                state.loading = false;
                
            } catch (err) {
                console.error(err);
                state.loading = false;
                state.error = "PAPERS PAYLOAD MISSING"; // Deterministic failure message
                render();
            }
        }

        init();

    </script>
</body>
</html>
