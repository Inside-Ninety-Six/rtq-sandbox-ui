<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"ABC","indexWithinVariant":"153","totalWithinVariant":"320","hueFamily":"teal","intensityMode":"accent_only","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-09T17:11:20.249Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;ABC&quot;,&quot;indexWithinVariant&quot;:&quot;153&quot;,&quot;totalWithinVariant&quot;:&quot;320&quot;,&quot;hueFamily&quot;:&quot;teal&quot;,&quot;intensityMode&quot;:&quot;accent_only&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-09T17:11:20.249Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Viewer</title>
    <!-- 
      Stage 6 Add-on: Real KaTeX Rendering & Markdown
      - No SRI (integrity) attributes per Stage 6.0.7b 
    -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>
    
    <style>
        /* 
          COLORLAB IMPLEMENTATION
          Add-on B: Force Hue Family = "teal"
          Add-on C: Intensity Mode = "accent_only" (Light Mode Only)
          
          Hue: 175 (Teal)
          Rules:
          - Backgrounds C <= 0.015
          - Text C <= 0.010
          - Accent C in [0.08 .. 0.14]
        */
        :root {
            /* Base Hue */
            --hue-primary: 175;
            
            /* Surfaces (Mode 1: accent_only compliance) */
            --color-page-bg: oklch(0.985 0.005 var(--hue-primary));
            --color-frame-bg: oklch(0.985 0.005 var(--hue-primary)); /* Shared surface */
            --color-paper-bg: oklch(1.0 0 0); /* Pure white (C=0) */
            
            /* Solution Details Wash (Subtle) */
            --color-sd-wash: oklch(0.98 0.008 var(--hue-primary));

            /* Text (Mode 1: C <= 0.010) */
            --color-text-primary: oklch(0.15 0.01 var(--hue-primary));
            --color-text-secondary: oklch(0.40 0.01 var(--hue-primary));
            --color-text-quiet: oklch(0.55 0.01 var(--hue-primary));

            /* Accent (Mode 1: C in [0.08 .. 0.14]) - Links, Focus, Disclosure, Nav Marker */
            --color-accent: oklch(0.45 0.11 var(--hue-primary)); 
            --color-accent-hover: oklch(0.40 0.11 var(--hue-primary));
            --color-focus-ring: oklch(0.45 0.11 var(--hue-primary) / 0.5);

            /* Borders */
            --color-border: oklch(0.92 0.005 var(--hue-primary));
            --color-border-hairline: oklch(0.94 0.005 var(--hue-primary));

            /* Spacing & Layout Constants */
            --nav-width: 240px;
            --max-width-paper: 800px;
            --space-unit: 8px;
            
            /* Global Contrast Ceiling Guardrail applied via specific color choices above */
        }

        /* Reset & Base */
        * { box-sizing: border-box; }
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--color-page-bg);
            color: var(--color-text-primary);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        /* Focus Visibility (Stage 5.5.2) */
        :focus-visible {
            outline: 2px solid var(--color-focus-ring);
            outline-offset: 2px;
        }

        /* Document Shell (Stage 3 Grammar) */
        .doc-shell {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            max-width: 1200px;
            margin: 0 auto;
            background: var(--color-frame-bg);
        }

        /* Top Controls (Shared Frame Alignment) */
        .top-controls {
            padding: 1rem;
            border-bottom: 1px solid var(--color-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            background: var(--color-frame-bg);
            z-index: 20;
        }

        /* Sibling Columns Wrapper */
        .main-columns {
            display: flex;
            flex: 1;
            align-items: flex-start;
        }

        /* Navigation Rail (Desktop) - Sticky, Scrollable if needed */
        .nav-rail {
            width: var(--nav-width);
            position: sticky;
            top: 73px; /* Header height offset approx */
            max-height: calc(100vh - 73px);
            overflow-y: auto;
            padding: 1rem 1rem 2rem 1rem;
            display: none; /* Hidden on mobile */
            font-size: 0.9rem;
            /* Hide Scrollbars visually (Stage 6.0.9) */
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .nav-rail::-webkit-scrollbar { display: none; }
        
        @media (min-width: 768px) {
            .nav-rail { display: block; }
        }

        /* Paper Content Region (Right Column) */
        .paper-region {
            flex: 1;
            padding: 2rem 1rem 5rem 1rem;
            max-width: var(--max-width-paper);
            background: var(--color-frame-bg); /* Desktop: share surface */
        }
        
        /* Mobile Drawer (Stage 6.0.6) */
        .drawer-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.4); 
            z-index: 50; display: none;
        }
        .drawer {
            position: fixed; top: 0; bottom: 0; left: 0; width: 85%; max-width: 320px;
            background: var(--color-page-bg); z-index: 51;
            transform: translateX(-100%); transition: transform 0.25s ease-out;
            padding: 1rem; display: flex; flex-direction: column;
            box-shadow: 2px 0 8px rgba(0,0,0,0.05);
        }
        .drawer.open { transform: translateX(0); }

        /* Question Node Structure */
        .q-node { margin-bottom: 3.5rem; scroll-margin-top: 100px; }
        
        /* Indentation for Children (Visual only via spacing) */
        .children-container {
            padding-left: 1rem; /* Adaptive indentation */
            margin-top: 1.5rem;
        }
        @media (min-width: 768px) { .children-container { padding-left: 2rem; } }

        /* Typography Hierarchy */
        .q-body { font-size: 1.125rem; margin-bottom: 1rem; color: var(--color-text-primary); }
        .q-body p { margin-top: 0; margin-bottom: 0.5em; }
        
        .q-id { 
            font-weight: 700; 
            margin-right: 0.5em; 
            color: var(--color-text-primary); /* Hierarchy via weight + position */
        }

        /* Solution Block */
        .solution-block { 
            margin-top: 1.25rem; 
            /* Demarcation via spacing (Stage 5.1.1) */
        }

        /* Answer */
        .answer-block { 
            margin-bottom: 1rem; 
            color: var(--color-text-secondary); /* Tertiary emphasis */
        }
        .answer-label { 
            font-weight: 700; font-size: 0.85em; 
            text-transform: uppercase; letter-spacing: 0.05em; 
            color: var(--color-text-secondary); 
            margin-right: 0.5em; 
        }

        /* Solution Details Control */
        .sd-control {
            background: none; border: none; padding: 0;
            color: var(--color-accent); cursor: pointer;
            font-size: 1rem; font-family: inherit;
            display: inline-flex; align-items: center; gap: 0.35rem;
            margin-bottom: 0.5rem;
        }
        .sd-control:hover { color: var(--color-accent-hover); text-decoration: underline; }
        
        /* Solution Details Region */
        .sd-region {
            display: none;
            margin-top: 0.5rem;
            padding: 1.25rem;
            background: var(--color-sd-wash); /* Surface Differentiation */
            /* No border-radius per Paper feel (Stage 3.C guardrails against "cards") - Square/clean */
        }
        .sd-region.expanded { display: block; }

        /* Solution Details Subsections */
        .sd-section { margin-bottom: 1.5rem; }
        .sd-section:last-child { margin-bottom: 0; }
        
        .sd-sub-label {
            font-weight: 700; font-size: 0.9em; 
            margin-bottom: 0.5rem; 
            color: var(--color-text-primary);
        }
        
        /* Subordination (Anti-faded guardrail: Text must be readable) */
        .sd-content {
            color: var(--color-text-secondary); /* Contrast floor respected */
            font-size: 0.95rem;
            line-height: 1.5;
        }

        /* Lists in Markdown */
        .sd-content ul, .sd-content ol { padding-left: 1.25rem; margin: 0.5rem 0; }
        .sd-content li { margin-bottom: 0.25rem; }

        /* Math Containment (Stage 6.0.8) */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            padding: 0.5rem 0;
            max-width: 100%;
            text-align: left !important; /* Preference for left-aligned working */
            margin: 0.5em 0 !important;
        }
        /* No background on inline math (Stage 5.8.4) */
        .katex { font-size: 1.05em; }

        /* Navigation Styles (Flat list, hierarchy via type scale) */
        .nav-item {
            display: block; padding: 0.35rem 0;
            color: var(--color-text-secondary);
            text-decoration: none;
            cursor: pointer;
            border-left: 2px solid transparent; /* Alignment edge */
            padding-left: 0.75rem;
            margin-left: -2px;
        }
        .nav-item:hover { color: var(--color-text-primary); }
        
        /* Active State (Stage 6.0.2 - Weight only, no fills) */
        .nav-item.active { 
            font-weight: 700; 
            color: var(--color-accent); /* Permitted accent use in Nav */
            border-left-color: var(--color-accent);
        }

        /* Hierarchy via type scale (Stage 5.4.5) */
        .nav-item.level-0 { font-size: 1rem; margin-top: 0.25rem; }
        .nav-item.level-1 { font-size: 0.9rem; color: var(--color-text-quiet); }
        .nav-item.level-2 { font-size: 0.85rem; color: var(--color-text-quiet); }

        /* Section Labels */
        .nav-section-label {
            margin-top: 1.5rem; margin-bottom: 0.5rem;
            font-weight: 700; font-size: 0.8rem;
            text-transform: uppercase; letter-spacing: 0.05em;
            color: var(--color-text-primary);
            padding-left: 0.75rem;
        }

        /* Error Message */
        .payload-error {
            text-align: center; font-weight: 700; 
            color: var(--color-text-secondary); margin-top: 3rem;
            padding: 2rem; border: 1px dashed var(--color-border);
        }

        /* Controls */
        select {
            padding: 0.5rem; font-size: 1rem; border: 1px solid var(--color-border);
            border-radius: 4px; background: var(--color-page-bg); color: var(--color-text-primary);
        }
        button.primary-trig {
            padding: 0.5rem 1rem; background: transparent; border: 1px solid var(--color-accent);
            color: var(--color-accent); border-radius: 4px; font-weight: 600; cursor: pointer;
        }

    </style>
</head>
<body>

<div class="doc-shell">
    
    <!-- Top Controls -->
    <header class="top-controls">
        <div style="display:flex; gap:1rem; align-items:center;">
            <select id="paper-selector" aria-label="Select Paper">
                <option disabled selected>Loading papers...</option>
            </select>
        </div>
        <!-- Mobile Jump To (Stage 6.0.6) -->
        <button id="jump-to-btn" class="primary-trig" style="display:none;">Jump to</button>
    </header>

    <div class="main-columns">
        <!-- Navigation Rail (Left Column) -->
        <nav class="nav-rail" id="desktop-nav" role="navigation" aria-label="Paper Questions">
            <!-- Content injected by JS -->
        </nav>

        <!-- Paper Content (Right Column) -->
        <main class="paper-region" id="paper-content">
            <!-- Content injected by JS -->
        </main>
    </div>

</div>

<!-- Mobile Navigation Drawer -->
<div class="drawer-overlay" id="drawer-overlay"></div>
<div class="drawer" id="drawer">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem; padding-bottom:0.5rem; border-bottom:1px solid var(--color-border);">
        <span style="font-weight:700; color:var(--color-text-primary);">Jump to</span>
        <button id="close-drawer" class="sd-control" style="font-size:0.9rem;">Close</button>
    </div>
    <div id="drawer-nav-list" style="overflow-y:auto; flex:1;"></div>
</div>

<script>
    /**
     * STAGE 0: CONSTANTS
     * The single source of truth for paths.
     */
    const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
    const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

    /**
     * Runtime State & Config
     */
    let papersData = [];
    let currentPaper = null;
    let md = null;

    // --- Markdown renderer (authoritative config per Stage 6 add-on) ---
    function initMarkdown() {
        if (window.markdownit) {
            md = window.markdownit({
                html: true,  // allow inline SVG (Stage 6.1b)
                linkify: true,
                breaks: false // MUST stay false: prevents <br> inside $...$
            });
            // Preserve TeX backslashes
            md.inline.ruler.disable(['escape']);
        }
    }

    /**
     * Core App Logic
     */
    async function initApp() {
        initMarkdown();
        
        try {
            const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
            if (!response.ok) throw new Error("Payload fetch failed");
            
            const data = await response.json();
            papersData = data.papers || [];
            
            setupUI();
        } catch (error) {
            console.error(error);
            renderFailureMode();
        }
    }

    function renderFailureMode() {
        document.getElementById('paper-content').innerHTML = `<div class="payload-error">PAPERS PAYLOAD MISSING</div>`;
        document.getElementById('paper-selector').innerHTML = `<option>Error</option>`;
    }

    function setupUI() {
        const selector = document.getElementById('paper-selector');
        selector.innerHTML = '';
        
        papersData.forEach((paper, idx) => {
            const opt = document.createElement('option');
            opt.value = idx;
            opt.textContent = paper.label || paper.key;
            selector.appendChild(opt);
        });

        selector.addEventListener('change', (e) => {
            loadPaper(papersData[e.target.value]);
        });

        // Mobile Nav Logic
        const jumpBtn = document.getElementById('jump-to-btn');
        const overlay = document.getElementById('drawer-overlay');
        const drawer = document.getElementById('drawer');
        const closeBtn = document.getElementById('close-drawer');

        const toggleMobileBtn = () => {
            jumpBtn.style.display = window.innerWidth < 768 ? 'inline-block' : 'none';
            if (window.innerWidth >= 768) closeDrawer();
        };
        
        window.addEventListener('resize', toggleMobileBtn);
        toggleMobileBtn();

        jumpBtn.onclick = openDrawer;
        closeBtn.onclick = closeDrawer;
        overlay.onclick = closeDrawer;

        function openDrawer() {
            overlay.style.display = 'block';
            requestAnimationFrame(() => drawer.classList.add('open'));
        }
        function closeDrawer() {
            drawer.classList.remove('open');
            setTimeout(() => overlay.style.display = 'none', 250);
        }

        // Load Initial
        if (papersData.length > 0) loadPaper(papersData[0]);
    }

    function loadPaper(paper) {
        currentPaper = paper;
        const container = document.getElementById('paper-content');
        container.innerHTML = '';
        
        // --- 1. Render Navigation ---
        renderNavigation(paper);

        // --- 2. Render Questions ---
        const listWrapper = document.createElement('div');
        
        if (paper.sections) {
            paper.sections.forEach(sec => {
                // Render Section Label in content? 
                // Brief Stage 3 Paper Region: "Section block (optional)... Section header"
                if (sec.label && sec.label.trim()) {
                    const header = document.createElement('div');
                    header.style.marginBottom = '2rem';
                    header.style.marginTop = '1rem';
                    header.style.borderBottom = '1px solid var(--color-border)';
                    header.style.paddingBottom = '0.5rem';
                    header.style.fontWeight = '700';
                    header.style.color = 'var(--color-text-primary)';
                    header.textContent = sec.label;
                    listWrapper.appendChild(header);
                }
                sec.questions.forEach(q => renderQuestionNode(q, listWrapper, 0));
            });
        } else if (paper.questions) {
            paper.questions.forEach(q => renderQuestionNode(q, listWrapper, 0));
        }

        container.appendChild(listWrapper);

        // --- 3. KaTeX Auto-Render ---
        // Render order: Markdown -> DOM -> KaTeX
        renderMathInElement(container, {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false},
                {left: '\\(', right: '\\)', display: false},
                {left: '\\[', right: '\\]', display: true}
            ],
            throwOnError: false,
            trust: true // Trust HTML in math if needed, though strictly markdown handles inline HTML
        });
    }

    // Recursive Question Renderer
    function renderQuestionNode(node, parent, depth) {
        const wrapper = document.createElement('div');
        wrapper.className = 'q-node';
        wrapper.id = 'q-' + node.id;

        // Question Body
        const body = document.createElement('div');
        body.className = 'q-body';
        const qHtml = md ? md.render(node.question || '') : (node.question || '');
        // ID + Prompt
        body.innerHTML = `<span class="q-id">${node.id}</span> ${qHtml}`;
        wrapper.appendChild(body);

        // Solution Block (Optional)
        if (node.solutionBlock) {
            const sb = node.solutionBlock;
            const sbContainer = document.createElement('div');
            sbContainer.className = 'solution-block';

            // Answer (Visible by default if present)
            if (sb.answer) {
                const ansDiv = document.createElement('div');
                ansDiv.className = 'answer-block';
                const ansHtml = md ? md.render(sb.answer) : sb.answer;
                // Render as Label + Content inline-block wrapper to keep label semantic
                ansDiv.innerHTML = `<span class="answer-label">Answer</span> <span style="display:inline">${ansHtml}</span>`;
                sbContainer.appendChild(ansDiv);
            }

            // Solution Details (Collapsible)
            if (sb.solutionDetails) {
                const sd = sb.solutionDetails;
                
                // Toggle Control
                const toggle = document.createElement('button');
                toggle.className = 'sd-control';
                
                // Region
                const region = document.createElement('div');
                region.className = 'sd-region';
                
                // Default expanded? 
                // Brief: "Solution Details are expanded by default when present" unless paper defaults say no.
                let expanded = true;
                if (currentPaper.defaults && currentPaper.defaults.expandedAll === false) {
                    expanded = false;
                }

                const updateState = () => {
                    if (expanded) {
                        region.classList.add('expanded');
                        // Text-first disclosure + chevron
                        toggle.innerHTML = `Hide working <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M18 15l-6-6-6 6"/></svg>`;
                    } else {
                        region.classList.remove('expanded');
                        toggle.innerHTML = `Show working <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9l6 6 6-6"/></svg>`;
                    }
                };

                toggle.onclick = () => { expanded = !expanded; updateState(); };
                updateState(); // Init

                // Render Subsections (Keep in mind -> Formulas -> Working -> Alt)
                const renderSub = (label, contentMd) => {
                    if (!contentMd) return;
                    const secDiv = document.createElement('div');
                    secDiv.className = 'sd-section';
                    
                    const lblDiv = document.createElement('div');
                    lblDiv.className = 'sd-sub-label';
                    lblDiv.textContent = label;
                    secDiv.appendChild(lblDiv);
                    
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'sd-content';
                    contentDiv.innerHTML = md ? md.render(contentMd) : contentMd;
                    secDiv.appendChild(contentDiv);
                    
                    region.appendChild(secDiv);
                };

                renderSub('Keep in mind', sd.keepInMind);
                renderSub('Formulas used', sd.formulasUsed);
                renderSub('Working', sd.working);
                if (sd.alternativeWorking && Array.isArray(sd.alternativeWorking)) {
                    sd.alternativeWorking.forEach(alt => renderSub('Alternative working', alt));
                }

                sbContainer.appendChild(toggle);
                sbContainer.appendChild(region);
            }
            wrapper.appendChild(sbContainer);
        }

        parent.appendChild(wrapper);

        // Recursion for Children
        if (node.children && node.children.length > 0) {
            const childContainer = document.createElement('div');
            childContainer.className = 'children-container';
            node.children.forEach(child => renderQuestionNode(child, childContainer, depth + 1));
            parent.appendChild(childContainer);
        }
    }

    function renderNavigation(paper) {
        const buildList = (targetContainer) => {
            const createLink = (node, depth) => {
                const a = document.createElement('a');
                a.className = `nav-item level-${Math.min(depth, 2)}`;
                a.textContent = node.id;
                a.dataset.target = 'q-' + node.id;
                
                a.onclick = (e) => {
                    e.preventDefault();
                    const el = document.getElementById(a.dataset.target);
                    if (el) {
                        el.scrollIntoView({behavior: 'smooth', block: 'start'});
                        // Set Active
                        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                        // Sync all nav items pointing to this ID (desktop + mobile)
                        document.querySelectorAll(`.nav-item[data-target="${a.dataset.target}"]`).forEach(n => n.classList.add('active'));
                        // Mobile close
                        if (window.innerWidth < 768) {
                            document.getElementById('drawer').classList.remove('open');
                            setTimeout(() => document.getElementById('drawer-overlay').style.display = 'none', 200);
                        }
                    }
                };
                targetContainer.appendChild(a);
                
                if (node.children) node.children.forEach(c => createLink(c, depth + 1));
            };

            if (paper.sections) {
                paper.sections.forEach(sec => {
                    if (sec.label && sec.label.trim()) {
                        const l = document.createElement('div');
                        l.className = 'nav-section-label';
                        l.textContent = sec.label;
                        targetContainer.appendChild(l);
                    }
                    sec.questions.forEach(q => createLink(q, 0));
                });
            } else if (paper.questions) {
                paper.questions.forEach(q => createLink(q, 0));
            }
        };

        const desktopNav = document.getElementById('desktop-nav');
        desktopNav.innerHTML = '';
        buildList(desktopNav);

        const mobileNav = document.getElementById('drawer-nav-list');
        mobileNav.innerHTML = '';
        buildList(mobileNav);
    }

    // Boot
    initApp();

</script>
</body>
</html>
