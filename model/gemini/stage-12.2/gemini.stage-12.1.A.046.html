<!DOCTYPE html>
<html lang="en" class="light">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"A","indexWithinVariant":"46","totalWithinVariant":"50","hueFamily":"","intensityMode":"","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-08T13:13:54.546Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;A&quot;,&quot;indexWithinVariant&quot;:&quot;46&quot;,&quot;totalWithinVariant&quot;:&quot;50&quot;,&quot;hueFamily&quot;:&quot;&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-08T13:13:54.546Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Viewer</title>
    
    <!-- Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS (via CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class', // Light mode enforced per Colorlab A
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        // Colorlab A Palette: Clean, Modern, Academic (Slate/Indigo)
                        page: '#F8FAFC',    // Slate 50
                        surface: '#FFFFFF', // White
                        ink: {
                            primary: '#0F172A',   // Slate 900
                            secondary: '#475569', // Slate 600
                            tertiary: '#94A3B8',  // Slate 400
                        },
                        accent: {
                            DEFAULT: '#4F46E5', // Indigo 600
                            hover: '#4338CA',   // Indigo 700
                            subtle: '#E0E7FF',  // Indigo 100
                        },
                        divider: '#E2E8F0',     // Slate 200
                        wash: '#F1F5F9',        // Slate 100 (Solution Details wash if needed)
                    },
                    spacing: {
                        'nav-width': '240px',
                    }
                }
            }
        }
    </script>

    <!-- Markdown-it (No SRI) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/13.0.1/markdown-it.min.js"></script>

    <!-- KaTeX (No SRI) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/katex/0.16.8/katex.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/katex/0.16.8/katex.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/katex/0.16.8/contrib/auto-render.min.js"></script>

    <style>
        /* Base Reset & Typography */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            background-color: theme('colors.page');
            color: theme('colors.ink.primary');
            overflow-y: scroll; /* Force vertical scrollbar to avoid layout shift */
        }

        /* Focus styles - Accessible & visible */
        :focus-visible {
            outline: 2px solid theme('colors.accent.DEFAULT');
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* Hide Scrollbar for Nav (Cross-browser) */
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* KaTeX Containment Invariant */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding-block: 0.5em;
            margin: 1em 0;
            -webkit-overflow-scrolling: touch;
        }
        /* Inline Math Transparency */
        .katex {
            background-color: transparent !important;
        }
        
        /* Markdown Content Styling */
        .md-content p {
            margin-bottom: 0.75em;
            line-height: 1.6;
        }
        .md-content p:last-child {
            margin-bottom: 0;
        }
        /* Minimal Table Styling */
        .md-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 1em 0;
            font-size: 0.95em;
        }
        .md-content th, .md-content td {
            border: 1px solid theme('colors.divider');
            padding: 0.5rem 0.75rem;
            text-align: left;
        }
        .md-content th {
            font-weight: 600;
            color: theme('colors.ink.primary');
        }
        .md-content td {
            color: theme('colors.ink.secondary');
        }
        /* Lists */
        .md-content ul {
            list-style-type: disc;
            padding-left: 1.5em;
            margin-bottom: 0.75em;
        }
        .md-content ol {
            list-style-type: decimal;
            padding-left: 1.5em;
            margin-bottom: 0.75em;
        }
    </style>
</head>
<body>

    <!-- App Root -->
    <div id="app" class="w-full min-h-screen flex flex-col items-center pb-32">
        <!-- Content injected by JS -->
    </div>

    <!-- Scripts -->
    <script>
        // --- CONSTANTS (AUTHORITATIVE) ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // --- STATE ---
        const state = {
            papers: [],
            currentPaperKey: null,
            expandedNodes: new Set(), // Set of Question IDs
            isMobileNavOpen: false,
            loading: true,
            error: false
        };

        // --- MARKDOWN SETUP ---
        const md = window.markdownit ? window.markdownit({
            html: true,   // Allow inline SVG passthrough
            linkify: true,
            breaks: false // CRITICAL: false to prevent <br> breaking KaTeX
        }) : null;

        if (md) {
            md.inline.ruler.disable(['escape']); // Preserve TeX backslashes
        }

        // --- INITIALIZATION ---
        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Payload missing");
                const payload = await response.json();
                
                state.papers = payload.papers || [];
                if (state.papers.length > 0) {
                    selectPaper(state.papers[0].key);
                } else {
                    state.loading = false;
                }
            } catch (e) {
                console.error(e);
                state.error = true;
                state.loading = false;
            }
            render();
        }

        // --- ACTIONS ---
        function selectPaper(key) {
            const paper = state.papers.find(p => p.key === key);
            if (!paper) return;

            state.currentPaperKey = key;
            state.expandedNodes.clear();
            state.isMobileNavOpen = false;

            // Apply defaults
            const expandAll = paper.defaults?.expandedAll !== false;
            
            // Recursive helper to set default expanded state
            function initDefaults(nodes) {
                if (!nodes) return;
                nodes.forEach(node => {
                    // Only nodes with solutionDetails are expandable
                    if (node.solutionBlock?.solutionDetails && expandAll) {
                        state.expandedNodes.add(node.id);
                    }
                    if (node.children) initDefaults(node.children);
                });
            }

            if (paper.questions) initDefaults(paper.questions);
            if (paper.sections) {
                paper.sections.forEach(s => initDefaults(s.questions));
            }

            state.loading = false;
            render();
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'auto' });
        }

        function toggleNode(id) {
            if (state.expandedNodes.has(id)) {
                state.expandedNodes.delete(id);
            } else {
                state.expandedNodes.add(id);
            }
            render();
        }

        function toggleMobileNav() {
            state.isMobileNavOpen = !state.isMobileNavOpen;
            render();
        }

        function scrollToQuestion(id) {
            const el = document.getElementById(`q-${id}`);
            if (el) {
                // Smooth scroll with offset for sticky headers/top controls if any
                const y = el.getBoundingClientRect().top + window.pageYOffset - 80;
                window.scrollTo({top: y, behavior: 'smooth'});
                state.isMobileNavOpen = false;
                render();
            }
        }

        // --- RENDERERS ---

        function render() {
            const app = document.getElementById('app');
            
            if (state.error) {
                app.innerHTML = `
                    <div class="flex items-center justify-center h-screen w-full text-ink-secondary font-medium tracking-wide">
                        PAPERS PAYLOAD MISSING
                    </div>
                `;
                return;
            }

            if (state.loading) {
                app.innerHTML = `<div class="mt-20 text-ink-tertiary">Loading...</div>`;
                return;
            }

            const currentPaper = state.papers.find(p => p.key === state.currentPaperKey);
            if (!currentPaper) return;

            // Generate Shell
            app.innerHTML = `
                <!-- Top Controls Region -->
                <div class="w-full max-w-[1024px] px-4 md:px-6 lg:px-8 mt-6 mb-8 flex justify-between items-center z-20 relative">
                    <div class="flex items-center gap-4">
                        <label class="sr-only" for="paper-select">Select Paper</label>
                        <div class="relative group">
                            <select id="paper-select" class="appearance-none bg-surface border border-divider text-ink-primary text-sm font-medium py-2 pl-3 pr-8 rounded shadow-sm hover:border-accent-DEFAULT focus:border-accent-DEFAULT focus:ring-1 focus:ring-accent-DEFAULT transition-colors cursor-pointer" onchange="selectPaper(this.value)">
                                ${state.papers.map(p => `<option value="${p.key}" ${p.key === state.currentPaperKey ? 'selected' : ''}>${p.label}</option>`).join('')}
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-ink-tertiary">
                                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                        </div>
                    </div>

                    <!-- Mobile Jump To -->
                    <button class="md:hidden text-sm font-medium text-accent-DEFAULT hover:text-accent-hover" onclick="toggleMobileNav()">
                        Jump to
                    </button>
                </div>

                <!-- DocumentFrameShell -->
                <div class="w-full max-w-[1024px] flex flex-row items-start px-4 md:px-6 lg:px-8 gap-8 relative">
                    
                    <!-- Desktop Nav Rail -->
                    <nav class="hidden md:block w-48 lg:w-56 flex-shrink-0 sticky top-8 max-h-[calc(100vh-4rem)] overflow-y-auto no-scrollbar pr-4">
                        ${renderNavList(currentPaper)}
                    </nav>

                    <!-- Paper Document Column -->
                    <main class="flex-1 min-w-0 w-full bg-surface shadow-sm border border-divider rounded-sm p-8 md:p-12 mb-12">
                        ${renderPaperContent(currentPaper)}
                    </main>

                </div>

                <!-- Mobile Nav Drawer -->
                ${renderMobileDrawer(currentPaper)}
            `;

            // Post-render: KaTeX
            renderMathInElement(document.body, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false}
                ],
                throwOnError: false
            });
        }

        // --- COMPONENT RENDERERS ---

        function renderNavList(paper) {
            let html = `<ul class="space-y-1">`;
            
            if (paper.sections) {
                paper.sections.forEach((section, index) => {
                    // Section Label (if exists)
                    if (section.label && section.label.trim().length > 0) {
                        html += `
                            <li class="pt-4 pb-2 first:pt-0">
                                <span class="text-xs font-semibold text-ink-tertiary uppercase tracking-wider block mb-1 select-none">
                                    ${section.label}
                                </span>
                            </li>
                        `;
                    } else if (index > 0) {
                         // Spacing between implicit sections
                         html += `<li class="h-4"></li>`;
                    }
                    
                    section.questions.forEach(q => {
                        html += renderNavItem(q);
                    });
                });
            } else if (paper.questions) {
                paper.questions.forEach(q => {
                    html += renderNavItem(q);
                });
            }
            
            html += `</ul>`;
            return html;
        }

        function renderNavItem(node, depth = 0) {
            // Flatten navigation logic: Recursively extract all IDs
            let output = '';
            
            // Render current node
            // Hierarchy cue via typography: Top level = normal, deeper = lighter/smaller
            const isTopLevel = depth === 0;
            const classes = isTopLevel 
                ? "text-sm text-ink-secondary hover:text-ink-primary font-medium" 
                : "text-xs text-ink-tertiary hover:text-ink-secondary font-normal";

            // Active indicator logic (simplified for prototype: relying on hover/focus mainly, 
            // but we could track 'current' based on scroll in a real app. Here strictly static per brief interaction rules)
            
            output += `
                <li>
                    <button onclick="scrollToQuestion('${node.id}')" class="block w-full text-left py-1 transition-colors ${classes} focus:outline-none focus-visible:ring-2 focus-visible:ring-accent-DEFAULT rounded-sm">
                        ${node.id}
                    </button>
                </li>
            `;

            // Children
            if (node.children && node.children.length > 0) {
                node.children.forEach(child => {
                    output += renderNavItem(child, depth + 1);
                });
            }
            
            return output;
        }

        function renderMobileDrawer(paper) {
            if (!state.isMobileNavOpen) return '';
            
            return `
                <div class="fixed inset-0 z-50 flex justify-end md:hidden" role="dialog" aria-modal="true">
                    <!-- Scrim -->
                    <div class="absolute inset-0 bg-ink-primary/20 backdrop-blur-sm transition-opacity" onclick="toggleMobileNav()"></div>
                    
                    <!-- Drawer -->
                    <div class="relative w-64 bg-surface h-full shadow-xl flex flex-col overflow-hidden animate-in slide-in-from-right duration-200">
                        <div class="p-4 border-b border-divider flex justify-between items-center bg-page">
                            <h2 class="text-sm font-semibold text-ink-primary">Jump to</h2>
                            <button onclick="toggleMobileNav()" class="text-ink-tertiary hover:text-ink-primary p-1">
                                <span class="sr-only">Close</span>
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </button>
                        </div>
                        <div class="flex-1 overflow-y-auto p-4 no-scrollbar">
                            ${renderNavList(paper)}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderPaperContent(paper) {
            let html = '';
            
            if (paper.sections) {
                paper.sections.forEach((section, idx) => {
                    html += `<div class="mb-12 last:mb-0">`;
                    if (section.label && section.label.trim().length > 0) {
                        html += `
                            <div class="mb-8 border-b border-divider pb-2">
                                <h2 class="text-lg font-semibold text-ink-primary">${section.label}</h2>
                            </div>
                        `;
                    }
                    html += `<div class="space-y-12">`; // Top level spacing
                    section.questions.forEach(q => {
                        html += renderQuestionNode(q, 0);
                    });
                    html += `</div></div>`;
                });
            } else if (paper.questions) {
                html += `<div class="space-y-12">`; // Top level spacing
                paper.questions.forEach(q => {
                    html += renderQuestionNode(q, 0);
                });
                html += `</div>`;
            }
            
            return html;
        }

        function renderQuestionNode(node, depth) {
            // Determine structure
            const hasSolutionBlock = !!node.solutionBlock;
            const hasAnswer = hasSolutionBlock && !!node.solutionBlock.answer;
            const hasSolutionDetails = hasSolutionBlock && !!node.solutionBlock.solutionDetails;
            const isExpanded = state.expandedNodes.has(node.id);

            // Indentation for children (Subtle visual hierarchy)
            // Depth 0: No indent. Depth > 0: Indent.
            const indentClass = depth > 0 ? 'ml-0 pl-4 md:pl-6 border-l border-transparent' : ''; // Keeping it structural mostly via spacing as per brief
            // Actually brief says "Horizontal indentation... optional... spacing only".
            // Let's use padding.
            const wrapperClass = depth > 0 ? `mt-6 pl-4 md:pl-8` : `relative`; 

            // Render components
            const questionHtml = renderMarkdown(node.question);
            
            let solutionBlockHtml = '';
            if (hasSolutionBlock) {
                // Answer
                let answerHtml = '';
                if (hasAnswer) {
                    answerHtml = `
                        <div class="mt-4">
                            <span class="text-xs font-bold text-ink-secondary uppercase tracking-wide block mb-1">Answer</span>
                            <div class="text-ink-primary font-medium md-content">
                                ${renderMarkdown(node.solutionBlock.answer)}
                            </div>
                        </div>
                    `;
                }

                // Solution Details Control & Content
                let detailsHtml = '';
                if (hasSolutionDetails) {
                    const details = node.solutionBlock.solutionDetails;
                    
                    // Toggle Control
                    const toggleLabel = isExpanded ? 'Hide working' : 'Show working';
                    const toggleIcon = isExpanded 
                        ? `<svg class="w-3 h-3 ml-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg>` 
                        : `<svg class="w-3 h-3 ml-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>`;
                    
                    const controlHtml = `
                        <button onclick="toggleNode('${node.id}')" class="mt-4 flex items-center text-sm font-medium text-accent-DEFAULT hover:text-accent-hover transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-accent-DEFAULT rounded-sm select-none">
                            ${toggleLabel}
                            ${toggleIcon}
                        </button>
                    `;

                    // Expanded Region
                    let regionHtml = '';
                    if (isExpanded) {
                        // Subsections
                        const keepInMind = details.keepInMind ? `
                            <div class="mb-6">
                                <div class="text-xs font-bold text-ink-secondary uppercase tracking-wide mb-2 flex items-center gap-1">
                                    Keep in mind
                                </div>
                                <div class="text-ink-secondary text-sm md-content">
                                    ${renderMarkdown(details.keepInMind)}
                                </div>
                            </div>
                        ` : '';

                        const formulas = details.formulasUsed ? `
                            <div class="mb-6">
                                <div class="text-xs font-bold text-ink-secondary uppercase tracking-wide mb-2">Formulas used</div>
                                <div class="text-ink-secondary text-sm md-content">
                                    ${renderMarkdown(details.formulasUsed)}
                                </div>
                            </div>
                        ` : '';

                        const working = details.working ? `
                            <div class="mb-6 last:mb-0">
                                <div class="text-xs font-bold text-ink-secondary uppercase tracking-wide mb-2">Working</div>
                                <div class="text-ink-primary text-base md-content">
                                    ${renderMarkdown(details.working)}
                                </div>
                            </div>
                        ` : '';

                        const alternatives = details.alternativeWorking && Array.isArray(details.alternativeWorking) ? 
                            details.alternativeWorking.map((alt, i) => `
                                <div class="mt-8 pt-6 border-t border-divider border-dashed">
                                    <div class="text-xs font-bold text-ink-secondary uppercase tracking-wide mb-2">Alternative working</div>
                                    <div class="text-ink-primary text-base md-content">
                                        ${renderMarkdown(alt)}
                                    </div>
                                </div>
                            `).join('') : '';

                        // Combine logic
                        regionHtml = `
                            <div class="mt-4 pl-4 border-l-2 border-divider animate-in fade-in duration-200">
                                <div class="py-2">
                                    ${keepInMind}
                                    ${formulas}
                                    ${working}
                                    ${alternatives}
                                </div>
                            </div>
                        `;
                    }

                    detailsHtml = controlHtml + regionHtml;
                }

                solutionBlockHtml = answerHtml + detailsHtml;
            }

            // Children recursion
            let childrenHtml = '';
            if (node.children && node.children.length > 0) {
                childrenHtml = `
                    <div class="children-container">
                        ${node.children.map(child => renderQuestionNode(child, depth + 1)).join('')}
                    </div>
                `;
            }

            // Assembly
            // Question ID + Prompt
            // Top-level questions get ID on left or distinct. 
            // Brief says: "Question body: question identifier + question prompt"
            // Let's render identifier small above or inline. 
            // Design brief suggests "Question identifier is a semantic prefix...".
            
            return `
                <div id="q-${node.id}" class="${wrapperClass} group">
                    <div class="flex flex-col gap-1">
                        <!-- ID -->
                        <span class="text-sm font-semibold text-ink-tertiary select-none">${node.id}</span>
                        <!-- Prompt -->
                        <div class="text-lg text-ink-primary font-medium md-content leading-relaxed">
                            ${questionHtml}
                        </div>
                    </div>
                    
                    <!-- Solution Block -->
                    <div class="ml-0">
                        ${solutionBlockHtml}
                    </div>

                    <!-- Children -->
                    ${childrenHtml}
                </div>
            `;
        }

        function renderMarkdown(content) {
            if (!content) return '';
            // Markdown-it renders inline SVG if present because html: true
            return md.render(content);
        }

        // --- START ---
        init();

    </script>
</body>
</html>
