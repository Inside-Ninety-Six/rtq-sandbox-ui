<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AB","indexWithinVariant":"42","totalWithinVariant":"200","hueFamily":"blue","intensityMode":"","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-08T15:18:52.106Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AB&quot;,&quot;indexWithinVariant&quot;:&quot;42&quot;,&quot;totalWithinVariant&quot;:&quot;200&quot;,&quot;hueFamily&quot;:&quot;blue&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-08T15:18:52.106Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Viewer - Stage 6 Baseline</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Markdown-it -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>
    
    <!-- KaTeX -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Lucide Icons (Development build for browser) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Base Typography & ColorLab B (Blue Family) - Light Mode Only */
        :root {
            --color-base: #f8fafc; /* Slate 50 */
            --color-surface: #ffffff;
            --color-surface-nav: #f8fafc;
            --color-text-primary: #0f172a; /* Slate 900 */
            --color-text-secondary: #475569; /* Slate 600 */
            --color-text-tertiary: #94a3b8; /* Slate 400 */
            --color-border: #e2e8f0; /* Slate 200 */
            --color-border-hairline: #f1f5f9; /* Slate 100 */
            
            /* Accent: Blue Family */
            --color-accent: #2563eb; /* Blue 600 */
            --color-accent-hover: #1d4ed8; /* Blue 700 */
            --color-accent-subtle: #eff6ff; /* Blue 50 */
            
            --font-family-sans: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        body {
            background-color: var(--color-base);
            color: var(--color-text-primary);
            font-family: var(--font-family-sans);
            -webkit-font-smoothing: antialiased;
            overflow-y: scroll; /* Always show vertical scrollbar to avoid layout shift */
        }

        /* Typography Utilities */
        .text-question { font-size: 1.125rem; line-height: 1.75rem; color: var(--color-text-primary); font-weight: 500; }
        .text-answer-label { font-size: 0.875rem; font-weight: 700; color: var(--color-text-secondary); text-transform: uppercase; letter-spacing: 0.025em; }
        .text-answer-body { font-size: 1rem; color: var(--color-text-primary); font-weight: 500; }
        .text-sd-label { font-size: 0.8rem; font-weight: 700; color: var(--color-text-secondary); text-transform: uppercase; letter-spacing: 0.025em; margin-bottom: 0.25rem; }
        .text-sd-body { font-size: 0.95rem; line-height: 1.6; color: var(--color-text-secondary); }
        .text-nav { font-size: 0.875rem; color: var(--color-text-secondary); }
        .text-nav-active { font-weight: 700; color: var(--color-accent); }
        .text-control { font-size: 0.9rem; font-weight: 500; color: var(--color-accent); }

        /* KaTeX Containment Invariants */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            padding: 0.5em 0;
            margin: 1em 0;
            max-width: 100%;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Inline math background forbidden */
        .katex { background-color: transparent !important; }

        /* Scrollbar hiding for nav */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Focus styles */
        *:focus-visible {
            outline: 2px solid var(--color-accent);
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* Markdown Table styles */
        table { border-collapse: collapse; width: 100%; margin: 1rem 0; font-size: 0.95rem; }
        th, td { border: 1px solid var(--color-border); padding: 0.5rem; text-align: left; }
        th { font-weight: 600; background-color: var(--color-base); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        /**
         * STAGE 0: CONSTANTS
         */
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";
        
        // ColorLab B Hue Force (Script Substitution placeholder handling)
        // If {{...}} is present or empty string, default to 'blue'
        const RAW_HUE = "{{RTQ_COLORLAB_FORCE_HUE_FAMILY}}";
        const FORCE_HUE = (RAW_HUE.includes("{{") || !RAW_HUE) ? "blue" : RAW_HUE;

        /**
         * MARKDOWN CONFIGURATION
         */
        const md = window.markdownit ? window.markdownit({
            html: true, // Allow inline SVG
            linkify: true,
            breaks: false // Critical: prevent <br> in math blocks
        }) : null;

        if (md) {
            md.inline.ruler.disable(['escape']); // Preserve TeX backslashes
        }

        /**
         * COMPONENTS
         */

        // --- Icons ---
        const ChevronDown = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m6 9 6 6 6-6"/></svg>
        );
        const ChevronUp = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m18 15-6-6-6 6"/></svg>
        );
        const Menu = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>
        );
        const X = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
        );

        // --- Math/Markdown Renderer ---
        const ContentBlock = ({ content, className = "" }) => {
            const ref = React.useRef(null);

            React.useEffect(() => {
                if (ref.current && window.renderMathInElement) {
                    window.renderMathInElement(ref.current, {
                        delimiters: [
                            {left: '$$', right: '$$', display: true},
                            {left: '$', right: '$', display: false}
                        ],
                        throwOnError: false
                    });
                }
            }, [content]);

            if (!content) return null;

            // Render Markdown first
            const htmlContent = md ? md.render(content) : content;

            return (
                <div 
                    ref={ref}
                    className={`content-block ${className}`}
                    dangerouslySetInnerHTML={{ __html: htmlContent }} 
                />
            );
        };

        // --- Paper Selector ---
        const PaperSelector = ({ papers, activePaperKey, onSelect }) => {
            if (!papers || papers.length === 0) return null;
            return (
                <div className="flex items-center gap-3 py-4">
                    <label htmlFor="paper-select" className="text-sm font-medium text-[var(--color-text-secondary)]">Paper:</label>
                    <select 
                        id="paper-select"
                        value={activePaperKey} 
                        onChange={(e) => onSelect(e.target.value)}
                        className="form-select block w-full max-w-xs rounded-md border-[var(--color-border)] bg-white py-1.5 pl-3 pr-8 text-sm focus:border-[var(--color-accent)] focus:ring-[var(--color-accent)]"
                    >
                        {papers.map(p => (
                            <option key={p.key} value={p.key}>{p.label}</option>
                        ))}
                    </select>
                </div>
            );
        };

        // --- Navigation Items ---
        const NavigationList = ({ structure, onItemClick, activeId }) => {
            // Flatten structure for rendering, handling sections
            const renderItems = (nodes, depth = 0) => {
                return nodes.map(node => {
                    const isSection = node.type === 'section';
                    
                    if (isSection) {
                        return (
                            <div key={`sec-${node.label || Math.random()}`} className="mb-4">
                                {node.label && (
                                    <div className="text-xs font-bold text-[var(--color-text-tertiary)] uppercase tracking-wider mb-2 mt-4 px-2 select-none">
                                        {node.label}
                                    </div>
                                )}
                                {renderItems(node.questions, depth)}
                            </div>
                        );
                    }

                    // Question Node
                    const isActive = activeId === node.id;
                    const isChild = depth > 0;
                    
                    // Hierarchy via type scale/weight, NO indentation
                    const baseClass = "block w-full text-left py-1 px-2 rounded hover:bg-[var(--color-border-hairline)] transition-colors duration-150 ease-in-out cursor-pointer";
                    const activeClass = isActive ? "text-nav-active bg-[var(--color-accent-subtle)]" : "text-nav";
                    const sizeClass = depth === 0 ? "text-sm" : "text-xs";
                    const weightClass = isActive ? "font-bold" : (depth === 0 ? "font-medium" : "font-normal");

                    return (
                        <div key={node.id}>
                            <button 
                                onClick={() => onItemClick(node.id)}
                                className={`${baseClass} ${activeClass} ${sizeClass} ${weightClass}`}
                            >
                                {node.id}
                            </button>
                            {node.children && node.children.length > 0 && (
                                <div>{renderItems(node.children, depth + 1)}</div>
                            )}
                        </div>
                    );
                });
            };

            return (
                <nav className="space-y-0.5">
                    {renderItems(structure)}
                </nav>
            );
        };

        // --- Question Node ---
        const QuestionNode = ({ node, defaultExpanded, depth = 0 }) => {
            const hasSolutionBlock = !!node.solutionBlock;
            const hasAnswer = hasSolutionBlock && !!node.solutionBlock.answer;
            const hasSolutionDetails = hasSolutionBlock && !!node.solutionBlock.solutionDetails;
            
            // Expanded state logic
            // Default expanded unless paper says otherwise. 
            // Control appears only if solutionDetails exists.
            const [isExpanded, setIsExpanded] = React.useState(defaultExpanded);

            // Toggle Handler
            const toggle = () => setIsExpanded(!isExpanded);

            return (
                <div id={`q-${node.id}`} className={`question-node mb-12 scroll-mt-24`}>
                    
                    {/* Question Body */}
                    <div className="mb-4">
                        <div className="flex items-baseline gap-3 mb-1">
                            <span className="text-sm font-bold text-[var(--color-text-secondary)] min-w-[2rem]">{node.id}</span>
                            <div className="flex-1 text-question">
                                <ContentBlock content={node.question} />
                            </div>
                        </div>
                    </div>

                    {/* Solution Block (Optional) */}
                    {hasSolutionBlock && (
                        <div className="pl-[calc(2rem+0.75rem)] border-l-2 border-transparent"> 
                            {/* Indentation matches ID width + gap. Border acts as subtle guide if we added hover, currently transparent */}
                            
                            {/* Answer */}
                            {hasAnswer && (
                                <div className="mb-4">
                                    <div className="text-answer-label mb-1">Answer</div>
                                    <div className="text-answer-body">
                                        <ContentBlock content={node.solutionBlock.answer} />
                                    </div>
                                </div>
                            )}

                            {/* Solution Details Toggle */}
                            {hasSolutionDetails && (
                                <div className="mb-4">
                                    {/* Separator if Answer exists */}
                                    {hasAnswer && <div className="h-px bg-[var(--color-border-hairline)] w-12 my-3"></div>}
                                    
                                    <button 
                                        onClick={toggle}
                                        className="flex items-center gap-2 text-control hover:text-[var(--color-accent-hover)] transition-colors focus:outline-none group"
                                        aria-expanded={isExpanded}
                                        aria-controls={`sd-${node.id}`}
                                    >
                                        <span className="border-b border-transparent group-hover:border-[var(--color-accent-hover)] leading-none pb-0.5">
                                            {isExpanded ? "Hide working" : "Show working"}
                                        </span>
                                        {isExpanded ? <ChevronUp className="w-4 h-4" /> : <ChevronDown className="w-4 h-4" />}
                                    </button>

                                    {/* Expanded Region */}
                                    {isExpanded && (
                                        <div id={`sd-${node.id}`} className="mt-4 animate-in fade-in slide-in-from-top-1 duration-200">
                                            
                                            {/* Keep In Mind */}
                                            {node.solutionBlock.solutionDetails.keepInMind && (
                                                <div className="mb-5">
                                                    <div className="text-sd-label text-[var(--color-text-tertiary)] flex items-center gap-2">
                                                        Keep in mind
                                                    </div>
                                                    <div className="text-sd-body">
                                                        <ContentBlock content={node.solutionBlock.solutionDetails.keepInMind} />
                                                    </div>
                                                </div>
                                            )}

                                            {/* Formulas Used */}
                                            {node.solutionBlock.solutionDetails.formulasUsed && (
                                                <div className="mb-5">
                                                    <div className="text-sd-label text-[var(--color-text-tertiary)]">Formulas used</div>
                                                    <div className="text-sd-body">
                                                        <ContentBlock content={node.solutionBlock.solutionDetails.formulasUsed} />
                                                    </div>
                                                </div>
                                            )}

                                            {/* Working (Primary) */}
                                            {node.solutionBlock.solutionDetails.working && (
                                                <div className="mb-6">
                                                    <div className="text-sd-label">Working</div>
                                                    <div className="text-sd-body">
                                                        <ContentBlock content={node.solutionBlock.solutionDetails.working} />
                                                    </div>
                                                </div>
                                            )}

                                            {/* Alternative Working */}
                                            {node.solutionBlock.solutionDetails.alternativeWorking && 
                                             node.solutionBlock.solutionDetails.alternativeWorking.length > 0 && (
                                                <div className="mt-6 pt-4 border-t border-[var(--color-border-hairline)]">
                                                    {node.solutionBlock.solutionDetails.alternativeWorking.map((alt, idx) => (
                                                        <div key={idx} className="mb-6 last:mb-0">
                                                            <div className="text-sd-label">Alternative working</div>
                                                            <div className="text-sd-body">
                                                                <ContentBlock content={alt} />
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    )}

                    {/* Recursive Children */}
                    {node.children && node.children.length > 0 && (
                        <div className="mt-6 pl-4 md:pl-8 border-l border-[var(--color-border-hairline)] md:border-none">
                            {node.children.map(child => (
                                <QuestionNode 
                                    key={child.id} 
                                    node={child} 
                                    defaultExpanded={defaultExpanded}
                                    depth={depth + 1}
                                />
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        // --- Layout Shell ---
        const DocumentFrameShell = ({ navContent, paperContent, activePaperLabel, onMobileNavOpen }) => {
            return (
                <div className="min-h-screen flex flex-col md:flex-row max-w-7xl mx-auto">
                    
                    {/* Mobile Header */}
                    <div className="md:hidden sticky top-0 z-20 bg-[var(--color-base)]/95 backdrop-blur border-b border-[var(--color-border)] px-4 py-3 flex items-center justify-between">
                        <span className="font-semibold text-sm truncate">{activePaperLabel}</span>
                        <button 
                            onClick={onMobileNavOpen}
                            className="flex items-center gap-2 text-sm font-medium text-[var(--color-accent)]"
                        >
                            Jump to <Menu className="w-5 h-5"/>
                        </button>
                    </div>

                    {/* Desktop Sidebar (Sticky) */}
                    <aside className="hidden md:block w-64 flex-shrink-0 border-r border-transparent sticky top-0 h-screen overflow-y-auto py-8 pl-6 pr-4 no-scrollbar">
                        <div className="mb-6 text-xs font-bold text-[var(--color-text-tertiary)] uppercase tracking-wider">
                            Contents
                        </div>
                        {navContent}
                    </aside>

                    {/* Main Content */}
                    <main className="flex-1 min-w-0 px-4 py-6 md:px-12 md:py-8">
                        {paperContent}
                    </main>

                </div>
            );
        };

        // --- Mobile Drawer ---
        const Drawer = ({ isOpen, onClose, children }) => {
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-50 flex justify-end md:hidden">
                    {/* Scrim */}
                    <div 
                        className="absolute inset-0 bg-black/20 backdrop-blur-sm"
                        onClick={onClose}
                    ></div>
                    
                    {/* Drawer Content */}
                    <div className="relative w-64 bg-[var(--color-surface)] h-full shadow-xl flex flex-col animate-in slide-in-from-right duration-200">
                        <div className="p-4 border-b border-[var(--color-border)] flex items-center justify-between bg-[var(--color-base)]">
                            <h2 className="font-semibold text-sm">Jump to</h2>
                            <button onClick={onClose} className="text-[var(--color-text-secondary)] hover:text-[var(--color-text-primary)]">
                                <X className="w-5 h-5" />
                            </button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        /**
         * MAIN APPLICATION
         */
        const App = () => {
            const [payload, setPayload] = React.useState(null);
            const [loading, setLoading] = React.useState(true);
            const [error, setError] = React.useState(false);
            const [activePaperKey, setActivePaperKey] = React.useState(null);
            const [mobileNavOpen, setMobileNavOpen] = React.useState(false);

            // Fetch Payload
            React.useEffect(() => {
                fetch(RTQ_PAPERS_PAYLOAD_PATH)
                    .then(res => {
                        if (!res.ok) throw new Error("Failed to load payload");
                        return res.json();
                    })
                    .then(data => {
                        setPayload(data);
                        if (data.papers && data.papers.length > 0) {
                            setActivePaperKey(data.papers[0].key);
                        }
                        setLoading(false);
                    })
                    .catch(err => {
                        console.error(err);
                        setError(true);
                        setLoading(false);
                    });
            }, []);

            // Scroll to hash on load or nav click
            const handleScrollTo = (id) => {
                const el = document.getElementById(`q-${id}`);
                if (el) {
                    el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    setMobileNavOpen(false);
                }
            };

            // Derive active paper data
            const activePaper = payload?.papers.find(p => p.key === activePaperKey);
            
            // Build flat structure for Nav rendering logic (helper)
            // Payload can have sections OR questions. 
            // We need a uniform structure for the Nav component.
            const getNavStructure = (paper) => {
                if (!paper) return [];
                if (paper.sections) {
                    return paper.sections.map(sec => ({
                        type: 'section',
                        label: sec.label, // might be empty string
                        questions: sec.questions
                    }));
                }
                return paper.questions; // treat as flat list of questions
            };

            const navStructure = getNavStructure(activePaper);
            const defaultExpanded = activePaper?.defaults?.expandedAll !== false;

            if (loading) return <div className="p-8 text-[var(--color-text-secondary)]">Loading...</div>;
            
            if (error || !payload) {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center p-8 text-center">
                        <div className="text-xl font-bold text-red-600 mb-2">PAPERS PAYLOAD MISSING</div>
                        <p className="text-[var(--color-text-secondary)]">Could not load content from {RTQ_PAPERS_PAYLOAD_PATH}</p>
                    </div>
                );
            }

            // Component for Rendering the list of questions in the main view
            const renderPaperContent = (nodes) => {
                return nodes.map(node => (
                    <QuestionNode 
                        key={node.id} 
                        node={node} 
                        defaultExpanded={defaultExpanded} 
                    />
                ));
            };

            const PaperContent = () => {
                if (!activePaper) return null;
                
                // Sectioned Paper
                if (activePaper.sections) {
                    return (
                        <div className="max-w-3xl">
                            {activePaper.sections.map((section, idx) => (
                                <div key={idx} className="mb-16">
                                    {/* Section Header (Divider) */}
                                    {section.label && (
                                        <div className="flex items-center gap-4 mb-12">
                                            <span className="text-xl font-bold text-[var(--color-text-primary)]">{section.label}</span>
                                            <div className="h-px bg-[var(--color-border)] flex-1"></div>
                                        </div>
                                    )}
                                    {renderPaperContent(section.questions)}
                                </div>
                            ))}
                        </div>
                    );
                }
                
                // Flat Paper
                return (
                    <div className="max-w-3xl">
                        {renderPaperContent(activePaper.questions)}
                    </div>
                );
            };

            return (
                <div className="antialiased selection:bg-[var(--color-accent-subtle)] selection:text-[var(--color-accent)]">
                    <div className="border-b border-[var(--color-border)] bg-[var(--color-base)] px-4 md:px-12">
                        <div className="max-w-7xl mx-auto">
                            <PaperSelector 
                                papers={payload.papers} 
                                activePaperKey={activePaperKey} 
                                onSelect={setActivePaperKey} 
                            />
                        </div>
                    </div>

                    <DocumentFrameShell 
                        activePaperLabel={activePaper?.label}
                        onMobileNavOpen={() => setMobileNavOpen(true)}
                        navContent={
                            <NavigationList 
                                structure={navStructure} 
                                onItemClick={handleScrollTo} 
                                activeId={null} // Optional: Implement active ID tracking
                            />
                        }
                        paperContent={<PaperContent />}
                    />

                    <Drawer isOpen={mobileNavOpen} onClose={() => setMobileNavOpen(false)}>
                        <NavigationList 
                            structure={navStructure} 
                            onItemClick={handleScrollTo} 
                        />
                    </Drawer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
