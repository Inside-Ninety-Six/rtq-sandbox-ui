<!DOCTYPE html>
<html lang="en" class="light">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AD","indexWithinVariant":"61","totalWithinVariant":"440","hueFamily":"","intensityMode":"","primaryHueFamily":"teal","secondaryHueFamily":"purple","dualIntensityMode":"dual_accent_only","timestamp":"2026-01-10T04:47:47.932Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AD&quot;,&quot;indexWithinVariant&quot;:&quot;61&quot;,&quot;totalWithinVariant&quot;:&quot;440&quot;,&quot;hueFamily&quot;:&quot;&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;primaryHueFamily&quot;:&quot;teal&quot;,&quot;secondaryHueFamily&quot;:&quot;purple&quot;,&quot;dualIntensityMode&quot;:&quot;dual_accent_only&quot;,&quot;timestamp&quot;:&quot;2026-01-10T04:47:47.932Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>
    
    <!-- Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- KaTeX CSS (No SRI/Integrity per Stage 6 instructions) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <!-- Tailwind CSS (Script for prototyping) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Tailwind Config for ColorLab D (Dual Accent, Light Mode Only) -->
    <script>
        tailwind.config = {
            darkMode: 'class', // Manual only, but we enforce light
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        // Semantic mapping to CSS variables defined in <style>
                        page: 'var(--color-surface-page)',
                        paper: 'var(--color-surface-paper)',
                        frame: 'var(--color-surface-frame)',
                        nav: 'var(--color-surface-nav)',
                        
                        txt: {
                            primary: 'var(--color-text-primary)',
                            secondary: 'var(--color-text-secondary)',
                            tertiary: 'var(--color-text-tertiary)',
                        },
                        
                        accent: {
                            primary: 'var(--color-accent-primary)',
                            secondary: 'var(--color-accent-secondary)',
                            hover: 'var(--color-accent-hover)', // Derived state
                        },

                        line: {
                            hairline: 'var(--color-line-hairline)',
                            focus: 'var(--color-line-focus)',
                        },

                        wash: {
                            sd: 'var(--color-wash-sd)',
                        }
                    }
                }
            }
        }
    </script>

    <!-- CSS: ColorLab D Implementation (Mode 1: dual_accent_only, Blue/Amber) + Layout Rules -->
    <style>
        :root {
            /* 
               COLORLAB D - MODE 1: dual_accent_only 
               Primary Hue: Blue (~264)
               Secondary Hue: Amber (~85)
               Constraint: Surfaces C <= 0.015, Text C <= 0.010
            */

            /* Surfaces (OKLCH) */
            --color-surface-page: oklch(0.98 0.005 264);
            --color-surface-frame: oklch(0.98 0.005 264); /* Shared base for nav/content on desktop */
            --color-surface-paper: oklch(1.0 0 0);
            --color-surface-nav: oklch(0.98 0.005 264); /* Transparent/Shared */

            /* Text (OKLCH) */
            --color-text-primary: oklch(0.15 0.01 264);
            --color-text-secondary: oklch(0.45 0.01 264);
            --color-text-tertiary: oklch(0.60 0.01 264); /* Quietest */

            /* Accents (OKLCH) - Mode 1 Constraints: Pri C [0.08..0.14], Sec C [0.06..0.12] */
            /* Primary (Blue) - Used for Links, Focus, Toggles */
            --color-accent-primary: oklch(0.50 0.14 264); 
            --color-accent-hover: oklch(0.45 0.14 264);

            /* Secondary (Amber) - Single supplementary role (e.g. Nav Marker or specific label) */
            --color-accent-secondary: oklch(0.65 0.12 85);

            /* Lines */
            --color-line-hairline: oklch(0.90 0.01 264);
            --color-line-focus: var(--color-accent-primary);

            /* Wash (Solution Details - optional/subtle) */
            --color-wash-sd: oklch(0.99 0.005 264);
        }

        body {
            @apply bg-page text-txt-primary antialiased;
        }

        /* Focus Styles (Stage 5.5.2) */
        :focus-visible {
            outline: 2px solid var(--color-line-focus);
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* Scrollbar Hiding for Nav (Stage 6 Add-on) */
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* KaTeX Containment Invariant (Stage 3/6) */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding-bottom: 4px; /* Space for scrollbar if needed */
            -webkit-overflow-scrolling: touch;
        }
        
        /* Inline math background invariant */
        .katex {
            background-color: transparent !important;
        }

        /* Markdown Table Minimal Styles */
        .md-content table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
            font-size: 0.95em;
        }
        .md-content th, .md-content td {
            border: 1px solid var(--color-line-hairline);
            padding: 0.5rem;
            text-align: left;
        }
        .md-content th {
            font-weight: 600;
            color: var(--color-text-primary);
        }

        /* Solution Details Transition */
        details > summary {
            list-style: none;
        }
        details > summary::-webkit-details-marker {
            display: none;
        }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <!-- Top Controls Region -->
    <header class="flex-none w-full bg-frame border-b border-line-hairline z-20">
        <div class="max-w-7xl mx-auto px-4 h-14 flex items-center justify-between">
            <!-- Paper Selector -->
            <div class="flex items-center gap-3">
                <label for="paper-select" class="text-sm font-medium text-txt-secondary sr-only">Select Paper</label>
                <select id="paper-select" class="bg-paper border border-line-hairline text-txt-primary text-sm rounded px-3 py-1.5 focus:border-accent-primary focus:ring-0 cursor-pointer">
                    <option value="" disabled selected>Loading papers...</option>
                </select>
            </div>

            <!-- Mobile Jump To Trigger -->
            <button id="mobile-jump-trigger" class="lg:hidden text-sm font-medium text-accent-primary hover:text-accent-hover flex items-center gap-1">
                Jump to
                <!-- Icon: List -->
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256"><path d="M224,128a8,8,0,0,1-8,8H40a8,8,0,0,1,0-16H216A8,8,0,0,1,224,128ZM40,72H216a8,8,0,0,0,0-16H40a8,8,0,0,0,0,16ZM216,184H40a8,8,0,0,0,0,16H216a8,8,0,0,0,0-16Z"></path></svg>
            </button>
        </div>
    </header>

    <!-- DocumentFrameShell -->
    <div class="flex-1 flex overflow-hidden max-w-7xl mx-auto w-full relative">
        
        <!-- Desktop Navigation Rail (Sticky, Left Column) -->
        <nav class="hidden lg:block w-64 flex-none h-full overflow-y-auto no-scrollbar py-8 pr-6 bg-frame pl-4">
            <div id="desktop-nav-content" class="space-y-6">
                <!-- Nav generated here -->
            </div>
        </nav>

        <!-- Divider (Desktop) -->
        <div class="hidden lg:block w-px bg-line-hairline h-full flex-none mx-2"></div>

        <!-- Paper Content Column (Right, Primary) -->
        <main id="paper-scroll-container" class="flex-1 overflow-y-auto bg-frame relative scroll-smooth">
            <div id="paper-content" class="max-w-3xl mx-auto px-4 py-8 lg:px-12 pb-32">
                <!-- Paper content generated here -->
                <div class="flex items-center justify-center h-64 text-txt-secondary animate-pulse">
                    Loading Payload...
                </div>
            </div>
        </main>
    </div>

    <!-- Mobile Navigation Drawer -->
    <div id="mobile-drawer-backdrop" class="fixed inset-0 bg-black/20 z-40 hidden transition-opacity" aria-hidden="true"></div>
    <div id="mobile-drawer" class="fixed inset-y-0 right-0 w-80 bg-paper shadow-xl z-50 transform translate-x-full transition-transform duration-300 flex flex-col" aria-hidden="true">
        <div class="flex items-center justify-between p-4 border-b border-line-hairline">
            <h2 class="text-lg font-medium text-txt-primary">Jump to</h2>
            <button id="mobile-drawer-close" class="text-txt-secondary hover:text-txt-primary p-2">
                <span class="sr-only">Close navigation</span>
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 256 256"><path d="M205.66,194.34a8,8,0,0,1-11.32,11.32L128,139.31,61.66,205.66a8,8,0,0,1-11.32-11.32L116.69,128,50.34,61.66A8,8,0,0,1,61.66,50.34L128,116.69l66.34-66.35a8,8,0,0,1,11.32,11.32L139.31,128Z"></path></svg>
            </button>
        </div>
        <nav class="flex-1 overflow-y-auto p-4">
            <div id="mobile-nav-content" class="space-y-6">
                <!-- Mobile nav generated here -->
            </div>
        </nav>
    </div>

    <!-- Scripts: Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Main Application Logic -->
    <script>
        // --- STAGE 0: CONSTANTS ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";

        // --- Application State ---
        let papersData = [];
        let currentPaper = null;
        let md = null;

        // --- DOM Elements ---
        const paperSelect = document.getElementById('paper-select');
        const paperContent = document.getElementById('paper-content');
        const desktopNavContent = document.getElementById('desktop-nav-content');
        const mobileNavContent = document.getElementById('mobile-nav-content');
        const mobileJumpTrigger = document.getElementById('mobile-jump-trigger');
        const mobileDrawer = document.getElementById('mobile-drawer');
        const mobileDrawerBackdrop = document.getElementById('mobile-drawer-backdrop');
        const mobileDrawerClose = document.getElementById('mobile-drawer-close');
        const paperScrollContainer = document.getElementById('paper-scroll-container');

        // --- Initialization ---
        async function init() {
            initMarkdown();
            await loadPayload();
            setupEventListeners();
        }

        // --- Markdown & KaTeX Setup ---
        function initMarkdown() {
            if (window.markdownit) {
                md = window.markdownit({
                    html: true,   // SVG passthrough
                    linkify: true,
                    breaks: false // Critical: prevent <br> in math
                });
                // Disable escape to preserve TeX backslashes
                md.inline.ruler.disable(['escape']);
            }
        }

        function renderMath(element) {
            if (window.renderMathInElement) {
                renderMathInElement(element, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false}
                    ],
                    throwOnError: false,
                    output: 'html', // Avoid MathML issues in some contexts, ensure standard look
                    trust: true // Allow basic styling
                });
            }
        }

        // --- Payload Loading ---
        async function loadPayload() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error('Network response was not ok');
                
                const data = await response.json();
                
                if (data && data.papers && Array.isArray(data.papers)) {
                    papersData = data.papers;
                    populateSelector();
                    if (papersData.length > 0) {
                        loadPaper(papersData[0].key);
                    } else {
                        renderError("No papers found in payload.");
                    }
                } else {
                    renderError("Invalid payload format.");
                }
            } catch (error) {
                console.error("Payload load failed:", error);
                renderError("PAPERS PAYLOAD MISSING");
            }
        }

        function renderError(msg) {
            paperContent.innerHTML = `<div class="p-8 text-center text-txt-secondary font-medium border border-line-hairline rounded bg-paper">${msg}</div>`;
            paperSelect.innerHTML = '<option disabled>Error</option>';
            desktopNavContent.innerHTML = '';
            mobileNavContent.innerHTML = '';
        }

        function populateSelector() {
            paperSelect.innerHTML = papersData.map(p => 
                `<option value="${p.key}">${p.label}</option>`
            ).join('');
        }

        // --- Paper Loading & Rendering ---
        function loadPaper(key) {
            currentPaper = papersData.find(p => p.key === key);
            if (!currentPaper) return;
            
            // Reset scroll
            paperScrollContainer.scrollTop = 0;
            
            // Render
            renderPaperContent();
            renderNavigation();
        }

        function renderPaperContent() {
            if (!currentPaper) return;

            // Determine structure: Flat or Sectioned
            let html = '';
            const isSectioned = !!currentPaper.sections;
            const expandedAll = currentPaper.defaults?.expandedAll !== false; // Default true unless false

            if (isSectioned) {
                currentPaper.sections.forEach(section => {
                    // Render Section Header (if label exists)
                    if (section.label && section.label.trim() !== '') {
                        html += `
                            <div class="mb-6 mt-10 first:mt-0 border-b border-line-hairline pb-2">
                                <h2 class="text-lg font-medium text-txt-primary">${section.label}</h2>
                            </div>
                        `;
                    }
                    // Render Questions
                    html += `<div class="space-y-12">`; // Spacing between top-level questions
                    section.questions.forEach(q => {
                        html += renderQuestionNode(q, 0, expandedAll);
                    });
                    html += `</div>`;
                });
            } else if (currentPaper.questions) {
                html += `<div class="space-y-12">`;
                currentPaper.questions.forEach(q => {
                    html += renderQuestionNode(q, 0, expandedAll);
                });
                html += `</div>`;
            }

            paperContent.innerHTML = html;
            
            // Post-render: Typeset Math
            renderMath(paperContent);
        }

        function renderQuestionNode(node, depth, defaultExpanded) {
            // Recursive render
            const indentClass = depth > 0 ? 'ml-6 border-l-2 border-transparent pl-4' : ''; 
            // Note: Design spec says "Horizontal indentation... optional indentation (spacing only)". 
            // We use left margin for child indentation.
            
            const questionBodyHtml = md ? md.render(node.question || '') : node.question;
            const nodeId = `q-${node.id.replace(/[^a-zA-Z0-9]/g, '-')}`;

            let solutionBlockHtml = '';
            
            if (node.solutionBlock) {
                const { answer, solutionDetails } = node.solutionBlock;
                const hasAnswer = !!answer;
                const hasDetails = !!solutionDetails;
                
                let answerHtml = '';
                if (hasAnswer) {
                    const answerContent = md ? md.render(answer) : answer;
                    answerHtml = `
                        <div class="mt-4 mb-2">
                            <span class="text-sm font-bold text-txt-secondary block mb-1">Answer</span>
                            <div class="text-txt-primary md-content bg-paper border border-line-hairline p-3 rounded-sm inline-block min-w-[120px]">
                                ${answerContent}
                            </div>
                        </div>
                    `;
                }

                let detailsHtml = '';
                if (hasDetails) {
                    const { keepInMind, formulasUsed, working, alternativeWorking } = solutionDetails;
                    const isOpen = defaultExpanded ? 'open' : '';
                    
                    // Parts
                    let keepInMindHtml = '';
                    if (keepInMind) {
                        keepInMindHtml = `
                            <div class="mb-4">
                                <h4 class="text-sm font-bold text-txt-primary mb-1 flex items-center gap-2">
                                    <span class="text-accent-secondary">ℹ</span> Keep in mind
                                </h4>
                                <div class="text-txt-secondary text-sm md-content pl-0">
                                    ${md ? md.render(keepInMind) : keepInMind}
                                </div>
                            </div>
                        `;
                    }

                    let formulasHtml = '';
                    if (formulasUsed) {
                        formulasHtml = `
                            <div class="mb-4">
                                <h4 class="text-sm font-bold text-txt-primary mb-1">Formulas used</h4>
                                <div class="text-txt-secondary text-sm md-content">
                                    ${md ? md.render(formulasUsed) : formulasUsed}
                                </div>
                            </div>
                        `;
                    }

                    let workingHtml = '';
                    if (working) {
                        workingHtml = `
                            <div class="mb-4">
                                <h4 class="text-sm font-bold text-txt-primary mb-1">Working</h4>
                                <div class="text-txt-secondary text-base md-content leading-relaxed">
                                    ${md ? md.render(working) : working}
                                </div>
                            </div>
                        `;
                    }

                    let altWorkingHtml = '';
                    if (alternativeWorking && Array.isArray(alternativeWorking)) {
                        altWorkingHtml = alternativeWorking.map((aw, idx) => `
                            <div class="mt-6 pt-4 border-t border-line-hairline border-dashed">
                                <h4 class="text-sm font-bold text-txt-primary mb-1">Alternative working ${alternativeWorking.length > 1 ? (idx + 1) : ''}</h4>
                                <div class="text-txt-secondary text-base md-content leading-relaxed">
                                    ${md ? md.render(aw) : aw}
                                </div>
                            </div>
                        `).join('');
                    }

                    detailsHtml = `
                        <div class="mt-3">
                            <details ${isOpen} class="group">
                                <summary class="cursor-pointer text-sm font-medium text-accent-primary hover:text-accent-hover select-none inline-flex items-center gap-1 mb-2 focus:outline-none focus-visible:ring-2 ring-accent-primary rounded px-1 -ml-1">
                                    <span class="group-open:hidden">Show working</span>
                                    <span class="hidden group-open:inline">Hide working</span>
                                    <span class="text-xs transition-transform duration-200 group-open:rotate-180">▼</span>
                                </summary>
                                <div class="pl-0 mt-2 pt-3 pb-4 bg-wash-sd rounded-sm border-l-2 border-line-hairline px-4 animate-in fade-in slide-in-from-top-1 duration-200">
                                    ${keepInMindHtml}
                                    ${formulasHtml}
                                    ${workingHtml}
                                    ${altWorkingHtml}
                                </div>
                            </details>
                        </div>
                    `;
                }

                if (hasAnswer || hasDetails) {
                    solutionBlockHtml = `
                        <div class="mt-4">
                            ${answerHtml}
                            ${detailsHtml}
                        </div>
                    `;
                }
            }

            // Children recursion
            let childrenHtml = '';
            if (node.children && node.children.length > 0) {
                childrenHtml = `<div class="mt-6 space-y-6">
                    ${node.children.map(child => renderQuestionNode(child, depth + 1, defaultExpanded)).join('')}
                </div>`;
            }

            return `
                <div id="${nodeId}" class="scroll-mt-20 ${indentClass}">
                    <div class="bg-paper rounded-none"> <!-- Question Node Surface (Stage 3 Option) -->
                        <div class="flex flex-col gap-1">
                            <!-- Question Body -->
                            <div class="flex gap-3">
                                <span class="flex-none font-semibold text-txt-secondary w-8 pt-0.5 text-right select-none">${node.id}</span>
                                <div class="flex-1 min-w-0">
                                    <div class="text-txt-primary text-lg leading-relaxed md-content">
                                        ${questionBodyHtml}
                                    </div>
                                    ${solutionBlockHtml}
                                </div>
                            </div>
                        </div>
                    </div>
                    ${childrenHtml}
                </div>
            `;
        }

        // --- Navigation Rendering ---
        function renderNavigation() {
            if (!currentPaper) return;

            const isSectioned = !!currentPaper.sections;
            let navHtml = '';

            if (isSectioned) {
                currentPaper.sections.forEach(section => {
                    const hasLabel = section.label && section.label.trim() !== '';
                    if (hasLabel) {
                        navHtml += `
                            <div class="mb-4">
                                <div class="text-xs font-semibold text-txt-tertiary uppercase tracking-wider mb-2 select-none">${section.label}</div>
                                <div class="space-y-0.5 border-l border-line-hairline ml-1 pl-2">
                                    ${section.questions.map(q => renderNavTree(q)).join('')}
                                </div>
                            </div>
                        `;
                    } else {
                        // Section without label
                        navHtml += `
                            <div class="mb-4 space-y-0.5 border-l border-line-hairline ml-1 pl-2">
                                ${section.questions.map(q => renderNavTree(q)).join('')}
                            </div>
                        `;
                    }
                });
            } else if (currentPaper.questions) {
                navHtml += `<div class="space-y-0.5 border-l border-line-hairline ml-1 pl-2">
                    ${currentPaper.questions.map(q => renderNavTree(q)).join('')}
                </div>`;
            }

            desktopNavContent.innerHTML = navHtml;
            mobileNavContent.innerHTML = navHtml;
            setupNavInteractions();
        }

        function renderNavTree(node) {
            // Flat list, hierarchy via type scale/weight (Stage 5.4.5)
            // But we actually just render the identifiers. Nested children simply follow in the list.
            const targetId = `q-${node.id.replace(/[^a-zA-Z0-9]/g, '-')}`;
            
            let html = `
                <button data-target="${targetId}" class="nav-item block w-full text-left py-1 px-2 text-sm text-txt-secondary hover:text-txt-primary hover:bg-black/5 rounded-sm transition-colors duration-150 focus:outline-none focus-visible:ring-2 focus-visible:ring-accent-primary">
                    ${node.id}
                </button>
            `;

            if (node.children && node.children.length > 0) {
                node.children.forEach(child => {
                    // Sub-questions render smaller/lighter (Stage 5.4.5 Intent)
                    const childTarget = `q-${child.id.replace(/[^a-zA-Z0-9]/g, '-')}`;
                    html += `
                        <button data-target="${childTarget}" class="nav-item block w-full text-left py-0.5 px-2 text-xs text-txt-tertiary hover:text-txt-primary hover:bg-black/5 rounded-sm transition-colors duration-150 focus:outline-none focus-visible:ring-2 focus-visible:ring-accent-primary">
                            ${child.id}
                        </button>
                    `;
                    // Recurse for deeper children
                    if (child.children) {
                        html += renderNavTreeChildrenOnly(child.children);
                    }
                });
            }
            return html;
        }

        function renderNavTreeChildrenOnly(nodes) {
            // Helper for deeper recursion in flat list
            return nodes.map(node => {
                const childTarget = `q-${node.id.replace(/[^a-zA-Z0-9]/g, '-')}`;
                return `
                    <button data-target="${childTarget}" class="nav-item block w-full text-left py-0.5 px-2 text-xs text-txt-tertiary hover:text-txt-primary hover:bg-black/5 rounded-sm transition-colors duration-150 focus:outline-none focus-visible:ring-2 focus-visible:ring-accent-primary">
                        ${node.id}
                    </button>
                    ${node.children ? renderNavTreeChildrenOnly(node.children) : ''}
                `;
            }).join('');
        }

        function setupNavInteractions() {
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    const targetId = e.target.dataset.target;
                    const el = document.getElementById(targetId);
                    if (el) {
                        // Desktop scroll
                        if (window.innerWidth >= 1024) {
                            // Paper container scrolls
                            // Calculate offset relative to container
                            // But scrollIntoView is easier
                            el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        } else {
                            // Mobile
                            closeDrawer();
                            el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                        
                        // Active state logic
                        updateActiveNav(targetId);
                    }
                });
            });
        }

        function updateActiveNav(activeId) {
            document.querySelectorAll('.nav-item').forEach(btn => {
                const isActive = btn.dataset.target === activeId;
                if (isActive) {
                    btn.classList.add('font-bold', 'text-accent-primary');
                    btn.classList.remove('text-txt-secondary', 'text-txt-tertiary');
                    // Add accent marker (ColorLab D Mode 1)
                    btn.style.borderLeft = '2px solid var(--color-accent-primary)';
                    btn.style.paddingLeft = '6px'; // Adjust padding for border
                    btn.style.marginLeft = '-8px'; // Compensate layout
                } else {
                    btn.classList.remove('font-bold', 'text-accent-primary');
                    // Reset based on depth logic (simplified here)
                    btn.classList.add('text-txt-secondary'); 
                    btn.style.borderLeft = 'none';
                    btn.style.paddingLeft = '0.5rem';
                    btn.style.marginLeft = '0';
                }
            });
        }

        // --- Event Listeners ---
        function setupEventListeners() {
            // Paper Switch
            paperSelect.addEventListener('change', (e) => {
                loadPaper(e.target.value);
            });

            // Mobile Drawer
            mobileJumpTrigger.addEventListener('click', openDrawer);
            mobileDrawerClose.addEventListener('click', closeDrawer);
            mobileDrawerBackdrop.addEventListener('click', closeDrawer);
            
            // Scroll Spy (Simple)
            paperScrollContainer.addEventListener('scroll', throttle(handleScrollSpy, 100));
            window.addEventListener('scroll', throttle(handleScrollSpy, 100)); // Mobile window scroll
        }

        function openDrawer() {
            mobileDrawer.classList.remove('translate-x-full');
            mobileDrawerBackdrop.classList.remove('hidden');
            mobileDrawerBackdrop.classList.add('opacity-100');
            // Trap focus roughly
            mobileDrawerClose.focus();
        }

        function closeDrawer() {
            mobileDrawer.classList.add('translate-x-full');
            mobileDrawerBackdrop.classList.remove('opacity-100');
            setTimeout(() => {
                mobileDrawerBackdrop.classList.add('hidden');
            }, 300);
        }

        function handleScrollSpy() {
            // Find the visible question
            // For simplicity, find the first question that is near the top of viewport/container
            const questions = document.querySelectorAll('[id^="q-"]');
            let currentId = null;
            
            for (let q of questions) {
                const rect = q.getBoundingClientRect();
                if (rect.top >= 0 && rect.top < window.innerHeight / 2) {
                    currentId = q.id;
                    break;
                }
            }
            
            if (currentId) {
                updateActiveNav(currentId);
            }
        }

        function throttle(func, limit) {
            let inThrottle;
            return function() {
                const args = arguments;
                const context = this;
                if (!inThrottle) {
                    func.apply(context, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            }
        }

        // Boot
        document.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
