<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"ABC","indexWithinVariant":"242","totalWithinVariant":"320","hueFamily":"amber","intensityMode":"tinted_neutrals","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-09T21:39:20.938Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;ABC&quot;,&quot;indexWithinVariant&quot;:&quot;242&quot;,&quot;totalWithinVariant&quot;:&quot;320&quot;,&quot;hueFamily&quot;:&quot;amber&quot;,&quot;intensityMode&quot;:&quot;tinted_neutrals&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-09T21:39:20.938Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer (Stage 6 Baseline)</title>

    <!-- Tailwind CSS (No integrity) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React & ReactDOM (No integrity) -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>

    <!-- Babel (No integrity) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js" crossorigin></script>

    <!-- KaTeX (No integrity) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Markdown-it (No integrity) -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <!-- Lucide React (No integrity) -->
    <script src="https://unpkg.com/lucide-react@0.344.0/dist/umd/lucide-react.min.js"></script>

    <style>
        /* COLORLAB C: Tinted Neutrals + COLORLAB B: Amber (H=85 approx) */
        :root {
            /* Mode: tinted_neutrals rules
               - Surfaces: C in [0.015 .. 0.035]
               - Text: C <= 0.010/0.012
               - Accent: C in [0.10 .. 0.16]
            */
            --hue-amber: 85;

            /* Page: L=0.98, C=0.015 */
            --color-page-bg: oklch(0.98 0.015 var(--hue-amber));
            
            /* Frame: L=0.965, C=0.02 */
            --color-frame-bg: oklch(0.965 0.02 var(--hue-amber));
            
            /* Paper: L=0.99, C=0.015 */
            --color-paper-bg: oklch(0.99 0.015 var(--hue-amber));
            
            /* Wash (Solution Details): L=0.96, C=0.03 */
            --color-wash-bg: oklch(0.96 0.03 var(--hue-amber));

            /* Text */
            --color-text-primary: oklch(0.20 0.01 var(--hue-amber));
            --color-text-secondary: oklch(0.45 0.012 var(--hue-amber));

            /* Accent (Links, Focus, Active Nav): L=0.55, C=0.14 */
            --color-accent: oklch(0.55 0.14 var(--hue-amber));

            /* Borders/Dividers: Low chroma */
            --color-border: oklch(0.90 0.02 var(--hue-amber));
            --color-divider: oklch(0.92 0.02 var(--hue-amber));

            /* Focus Ring */
            --color-focus: var(--color-accent);
        }

        body {
            background-color: var(--color-page-bg);
            color: var(--color-text-primary);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        /* Utilities */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* KaTeX Containment Invariant */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding: 0.5em 0;
            margin: 0.5em 0;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Table styles per Stage 5.8.5 */
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 1em 0;
            font-size: 0.95em;
        }
        th, td {
            border: 1px solid var(--color-border);
            padding: 0.5em;
            text-align: left;
        }
        th {
            font-weight: 600;
            background-color: transparent;
        }
        .table-wrapper {
            overflow-x: auto;
            margin-bottom: 1em;
        }

        /* Focus styles */
        :focus-visible {
            outline: 2px solid var(--color-focus);
            outline-offset: 2px;
            border-radius: 2px;
        }
    </style>

    <script type="text/babel">
        /**
         * STAGE 0: CONSTANTS - Canonical Paths
         */
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        /**
         * UTILS & CONFIG
         */
        const { useState, useEffect, useMemo, useRef, useCallback } = React;
        const { ChevronDown, ChevronRight, Menu, X, Check } = lucide;

        // Markdown-it Configuration (Stage 6 Baseline)
        const md = window.markdownit ? window.markdownit({
            html: true,
            linkify: true,
            breaks: false, // Authoritative: false
        }) : null;

        if (md) {
            md.inline.ruler.disable(['escape']);
        }

        /**
         * COMPONENTS
         */

        // Simple Markdown Render Component
        const Markdown = ({ content, className = "" }) => {
            const containerRef = useRef(null);
            
            // 1. Render Markdown to HTML
            const htmlContent = useMemo(() => {
                if (!content || !md) return "";
                return md.render(content);
            }, [content]);

            // 2. KaTeX Auto-render Effect
            useEffect(() => {
                if (containerRef.current && window.renderMathInElement) {
                    window.renderMathInElement(containerRef.current, {
                        delimiters: [
                            {left: '$$', right: '$$', display: true},
                            {left: '$', right: '$', display: false},
                            {left: '\\(', right: '\\)', display: false},
                            {left: '\\[', right: '\\]', display: true}
                        ],
                        throwOnError: false
                    });
                }
            }, [htmlContent]);

            return (
                <div 
                    ref={containerRef}
                    className={`prose prose-neutral max-w-none ${className} [&>table]:table-auto [&>p]:mb-3 last:[&>p]:mb-0`}
                    dangerouslySetInnerHTML={{ __html: htmlContent }}
                />
            );
        };

        // Navigation Item
        const NavItem = ({ id, label, depth = 0, isActive, onClick }) => {
            // Stage 5.4.5: Hierarchy via type scale/quietness only. Flat left edge.
            // Depth 0: Base size. Depth > 0: Slightly smaller/quieter.
            const style = depth === 0 
                ? "font-medium text-[var(--color-text-primary)]" 
                : "text-sm text-[var(--color-text-secondary)]";

            const activeStyle = isActive 
                ? "font-bold !text-[var(--color-accent)]" // Stage 6.0.2: Weight-only + Accent (allowed by override)
                : "hover:text-[var(--color-text-primary)]"; // Hover feedback (Stage 5.5.1)

            return (
                <button
                    onClick={onClick}
                    className={`w-full text-left py-1 px-0 transition-colors duration-200 ${style} ${activeStyle}`}
                >
                    {label}
                </button>
            );
        };

        // Navigation Section Label
        const NavSectionLabel = ({ label }) => (
            <div className="pt-4 pb-1 text-xs font-semibold uppercase tracking-wider text-[var(--color-text-secondary)] opacity-80 cursor-default select-none">
                {label}
            </div>
        );

        // Solution Details Block
        const SolutionDetails = ({ details, isExpanded, onToggle }) => {
            // Order: Keep in mind -> Formulas used -> Working -> Alternative working
            return (
                <div className="mt-3">
                    <button 
                        onClick={onToggle}
                        className="flex items-center gap-2 text-sm font-medium text-[var(--color-accent)] hover:underline focus:outline-none focus-visible:ring-2 ring-[var(--color-focus)] mb-2"
                        aria-expanded={isExpanded}
                    >
                        <span>{isExpanded ? "Hide working" : "Show working"}</span>
                        {isExpanded ? <ChevronDown size={14} /> : <ChevronRight size={14} />}
                    </button>

                    {isExpanded && (
                        <div className="bg-[var(--color-wash-bg)] p-4 rounded-sm animate-in fade-in slide-in-from-top-1 duration-200 border-l-2 border-[var(--color-border)]">
                            {/* Keep in mind */}
                            {details.keepInMind && (
                                <div className="mb-4">
                                    <div className="text-xs font-bold text-[var(--color-text-secondary)] mb-1 uppercase tracking-wide">Keep in mind</div>
                                    <Markdown content={details.keepInMind} className="text-sm text-[var(--color-text-primary)]" />
                                </div>
                            )}

                            {/* Formulas used */}
                            {details.formulasUsed && (
                                <div className="mb-4">
                                    <div className="text-xs font-bold text-[var(--color-text-secondary)] mb-1 uppercase tracking-wide">Formulas used</div>
                                    <Markdown content={details.formulasUsed} className="text-sm text-[var(--color-text-primary)]" />
                                </div>
                            )}

                            {/* Working */}
                            {details.working && (
                                <div className="mb-4">
                                    <div className="text-xs font-bold text-[var(--color-text-secondary)] mb-1 uppercase tracking-wide">Working</div>
                                    <Markdown content={details.working} className="text-base text-[var(--color-text-primary)]" />
                                </div>
                            )}

                            {/* Alternative working */}
                            {details.alternativeWorking && Array.isArray(details.alternativeWorking) && details.alternativeWorking.map((alt, idx) => (
                                <div key={idx} className="mt-6 pt-4 border-t border-[var(--color-border)]">
                                    <div className="text-xs font-bold text-[var(--color-text-secondary)] mb-1 uppercase tracking-wide">Alternative working</div>
                                    <Markdown content={alt} className="text-base text-[var(--color-text-primary)]" />
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        // Recursive Question Node
        const QuestionNode = ({ node, defaults, depth = 0 }) => {
            // Derive expanded state from paper defaults unless toggled (simplified for prototype: use defaults initially)
            // Ideally we track state per question ID, but for stress testing wireframe, local state is acceptable if minimal.
            // Using a keyed component to reset state on paper change is safest.
            const [isExpanded, setIsExpanded] = useState(defaults?.expandedAll !== false);
            
            const hasSolutionBlock = !!node.solutionBlock;
            const hasAnswer = hasSolutionBlock && !!node.solutionBlock.answer;
            const hasSolutionDetails = hasSolutionBlock && !!node.solutionBlock.solutionDetails;

            const toggle = () => setIsExpanded(!isExpanded);

            return (
                <div id={`q-${node.id}`} className="scroll-mt-24 mb-12 last:mb-0">
                    {/* Question Body */}
                    <div className="flex flex-col gap-2 mb-4">
                        <div className="flex gap-3">
                            <span className="font-bold text-[var(--color-text-secondary)] select-none shrink-0" style={{ minWidth: '2rem' }}>
                                {node.id}
                            </span>
                            <div className="flex-1 min-w-0">
                                <Markdown content={node.question} className="text-lg leading-relaxed text-[var(--color-text-primary)]" />
                            </div>
                        </div>
                    </div>

                    {/* Solution Block */}
                    {hasSolutionBlock && (
                        <div className="pl-[calc(2rem+0.75rem)]">
                            {/* Answer */}
                            {hasAnswer && (
                                <div className="mb-4">
                                    <div className="text-xs font-bold text-[var(--color-text-secondary)] mb-1 uppercase tracking-wide">Answer</div>
                                    <Markdown content={node.solutionBlock.answer} className="text-base font-medium text-[var(--color-text-primary)]" />
                                </div>
                            )}

                            {/* Solution Details */}
                            {hasSolutionDetails && (
                                <SolutionDetails 
                                    details={node.solutionBlock.solutionDetails} 
                                    isExpanded={isExpanded} 
                                    onToggle={toggle} 
                                />
                            )}
                        </div>
                    )}

                    {/* Children */}
                    {node.children && node.children.length > 0 && (
                        <div className="mt-6 pl-4 md:pl-8 border-l border-[var(--color-border)]">
                            {node.children.map((child, idx) => (
                                <QuestionNode key={`${child.id}-${idx}`} node={child} defaults={defaults} depth={depth + 1} />
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        // Main App
        const App = () => {
            const [payload, setPayload] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(false);
            const [activePaperKey, setActivePaperKey] = useState(null);
            const [mobileNavOpen, setMobileNavOpen] = useState(false);

            // Fetch Payload
            useEffect(() => {
                fetch(RTQ_PAPERS_PAYLOAD_PATH)
                    .then(res => {
                        if (!res.ok) throw new Error("Failed to load payload");
                        return res.json();
                    })
                    .then(data => {
                        setPayload(data);
                        if (data.papers && data.papers.length > 0) {
                            setActivePaperKey(data.papers[0].key);
                        }
                        setLoading(false);
                    })
                    .catch(err => {
                        console.error(err);
                        setError(true);
                        setLoading(false);
                    });
            }, []);

            // Derived Active Paper
            const activePaper = useMemo(() => {
                if (!payload || !activePaperKey) return null;
                return payload.papers.find(p => p.key === activePaperKey);
            }, [payload, activePaperKey]);

            // Helper to traverse questions for Nav
            const getFlatNavItems = useCallback((nodes, depth = 0) => {
                let items = [];
                nodes.forEach(node => {
                    items.push({ id: node.id, label: node.id, depth });
                    if (node.children) {
                        items = items.concat(getFlatNavItems(node.children, depth + 1));
                    }
                });
                return items;
            }, []);

            // Handle Jump
            const handleJump = (id) => {
                const el = document.getElementById(`q-${id}`);
                if (el) {
                    el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    setMobileNavOpen(false);
                }
            };

            if (loading) {
                return (
                    <div className="min-h-screen flex items-center justify-center text-[var(--color-text-secondary)]">
                        Loading...
                    </div>
                );
            }

            if (error || !payload) {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center p-8 text-center">
                        <h1 className="text-xl font-bold text-red-700 mb-4">PAPERS PAYLOAD MISSING</h1>
                        <p className="text-[var(--color-text-secondary)]">
                            Could not load payload from <code className="bg-gray-100 px-1 rounded">{RTQ_PAPERS_PAYLOAD_PATH}</code>
                        </p>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-[var(--color-frame-bg)]">
                    {/* Top Controls Region */}
                    <header className="sticky top-0 z-40 w-full border-b border-[var(--color-border)] bg-[var(--color-page-bg)]/95 backdrop-blur supports-[backdrop-filter]:bg-[var(--color-page-bg)]/60">
                        <div className="max-w-7xl mx-auto px-4 h-14 flex items-center justify-between gap-4">
                            {/* Paper Selector */}
                            <div className="flex items-center gap-2">
                                <label className="text-sm font-medium text-[var(--color-text-secondary)] hidden sm:block">Paper:</label>
                                <select 
                                    value={activePaperKey} 
                                    onChange={(e) => setActivePaperKey(e.target.value)}
                                    className="h-9 px-3 py-1 rounded-sm border border-[var(--color-border)] bg-[var(--color-paper-bg)] text-sm focus:outline-none focus:ring-2 focus:ring-[var(--color-focus)]"
                                >
                                    {payload.papers.map(p => (
                                        <option key={p.key} value={p.key}>{p.label}</option>
                                    ))}
                                </select>
                            </div>

                            {/* Mobile Jump Trigger */}
                            <button 
                                className="md:hidden flex items-center gap-2 text-sm font-medium text-[var(--color-accent)]"
                                onClick={() => setMobileNavOpen(true)}
                            >
                                <span>Jump to</span>
                                <Menu size={18} />
                            </button>
                        </div>
                    </header>

                    {/* DocumentFrameShell */}
                    <div className="max-w-7xl mx-auto flex items-start justify-center">
                        
                        {/* Desktop Navigation Rail */}
                        <aside className="hidden md:block w-48 lg:w-64 sticky top-14 h-[calc(100vh-3.5rem)] overflow-y-auto py-8 pr-6 hide-scrollbar">
                            <nav className="flex flex-col gap-1">
                                {activePaper.sections ? (
                                    // Sectioned Paper Nav
                                    activePaper.sections.map((section, sIdx) => (
                                        <div key={sIdx} className="mb-4 last:mb-0">
                                            {section.label && <NavSectionLabel label={section.label} />}
                                            <div className="flex flex-col gap-1">
                                                {getFlatNavItems(section.questions).map(item => (
                                                    <NavItem 
                                                        key={item.id} 
                                                        {...item} 
                                                        onClick={() => handleJump(item.id)} 
                                                    />
                                                ))}
                                            </div>
                                        </div>
                                    ))
                                ) : (
                                    // Flat Paper Nav
                                    getFlatNavItems(activePaper.questions).map(item => (
                                        <NavItem 
                                            key={item.id} 
                                            {...item} 
                                            onClick={() => handleJump(item.id)} 
                                        />
                                    ))
                                )}
                            </nav>
                        </aside>

                        {/* Paper Content Column */}
                        <main className="flex-1 min-w-0 bg-[var(--color-paper-bg)] min-h-[calc(100vh-3.5rem)] shadow-sm border-x border-[var(--color-border)]">
                            <div className="max-w-3xl mx-auto px-6 py-12 md:px-12 md:py-16">
                                {/* Paper Content Render */}
                                {activePaper.sections ? (
                                    // Sectioned Content
                                    activePaper.sections.map((section, sIdx) => (
                                        <div key={sIdx} className="mb-16 last:mb-0">
                                            {section.label && (
                                                <div className="mb-8 pb-4 border-b border-[var(--color-divider)]">
                                                    <h2 className="text-xl font-bold text-[var(--color-text-secondary)]">{section.label}</h2>
                                                </div>
                                            )}
                                            {section.questions.map((q, qIdx) => (
                                                <QuestionNode key={q.id} node={q} defaults={activePaper.defaults} />
                                            ))}
                                        </div>
                                    ))
                                ) : (
                                    // Flat Content
                                    activePaper.questions.map((q, qIdx) => (
                                        <QuestionNode key={q.id} node={q} defaults={activePaper.defaults} />
                                    ))
                                )}
                            </div>
                        </main>
                        
                        {/* Spacer for centering on wide screens if needed, 
                            but design brief says "two sibling columns". 
                            Flex-start + max-width container handles this naturally. 
                        */}
                    </div>

                    {/* Mobile Navigation Drawer */}
                    {mobileNavOpen && (
                        <div className="fixed inset-0 z-50 flex justify-end">
                            {/* Backdrop */}
                            <div 
                                className="absolute inset-0 bg-black/20 backdrop-blur-sm"
                                onClick={() => setMobileNavOpen(false)}
                            />
                            
                            {/* Drawer */}
                            <div className="relative w-64 bg-[var(--color-paper-bg)] h-full shadow-xl flex flex-col animate-in slide-in-from-right duration-200">
                                <div className="p-4 border-b border-[var(--color-border)] flex items-center justify-between">
                                    <h2 className="font-bold text-[var(--color-text-secondary)]">Jump to</h2>
                                    <button onClick={() => setMobileNavOpen(false)} className="text-[var(--color-text-secondary)]">
                                        <X size={20} />
                                    </button>
                                </div>
                                <div className="flex-1 overflow-y-auto p-4">
                                    <nav className="flex flex-col gap-1">
                                        {activePaper.sections ? (
                                            activePaper.sections.map((section, sIdx) => (
                                                <div key={sIdx} className="mb-4 last:mb-0">
                                                    {section.label && <NavSectionLabel label={section.label} />}
                                                    <div className="flex flex-col gap-1">
                                                        {getFlatNavItems(section.questions).map(item => (
                                                            <NavItem 
                                                                key={item.id} 
                                                                {...item} 
                                                                onClick={() => handleJump(item.id)} 
                                                            />
                                                        ))}
                                                    </div>
                                                </div>
                                            ))
                                        ) : (
                                            getFlatNavItems(activePaper.questions).map(item => (
                                                <NavItem 
                                                    key={item.id} 
                                                    {...item} 
                                                    onClick={() => handleJump(item.id)} 
                                                />
                                            ))
                                        )}
                                    </nav>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</head>
<body>
    <div id="root"></div>
</body>
</html>
