<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"ABC","indexWithinVariant":"178","totalWithinVariant":"320","hueFamily":"amber","intensityMode":"tinted_neutrals","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-09T18:19:01.013Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;ABC&quot;,&quot;indexWithinVariant&quot;:&quot;178&quot;,&quot;totalWithinVariant&quot;:&quot;320&quot;,&quot;hueFamily&quot;:&quot;amber&quot;,&quot;intensityMode&quot;:&quot;tinted_neutrals&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-09T18:19:01.013Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>

    <!-- Fonts: Inter (Modern, Neutral, Sans) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- KaTeX CSS (No Integrity/SRI per requirements) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <!-- Tailwind CSS (via CDN for prototyping layout) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- KaTeX JS -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Markdown-it JS -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <style>
        /* =========================================
           COLORLAB CONFIGURATION
           Mode: tinted_neutrals
           Hue: Amber (Fixed approx 80deg)
           Strict OKLCH compliance
           ========================================= */
        :root {
            /* Palette Definition (Amber + Tinted Neutrals) */
            --hue-amber: 80; 

            /* Surfaces: C in [0.015 .. 0.035] */
            --cl-page-bg: oklch(0.97 0.02 var(--hue-amber));
            --cl-frame-bg: oklch(0.955 0.025 var(--hue-amber)); /* Shared base for nav/paper */
            --cl-paper-surface: oklch(0.985 0.015 var(--hue-amber));
            
            /* Wash Surfaces: C in [0.025 .. 0.045] */
            --cl-wash-bg: oklch(0.96 0.035 var(--hue-amber)); 
            
            /* Typography: Primary C <= 0.010, Secondary C <= 0.012 */
            --cl-text-primary: oklch(0.20 0.01 var(--hue-amber));
            --cl-text-secondary: oklch(0.45 0.012 var(--hue-amber));
            
            /* Accent: C in [0.10 .. 0.16] - Used for links, focus, active states */
            --cl-accent: oklch(0.60 0.14 var(--hue-amber));
            
            /* Dividers/Lines: Neutral-leaning */
            --cl-line: oklch(0.90 0.02 var(--hue-amber));
            
            /* Focus Ring */
            --cl-focus: var(--cl-accent);
        }

        /* Base Reset */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--cl-page-bg);
            color: var(--cl-text-primary);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        /* Focus Management */
        *:focus-visible {
            outline: 2px solid var(--cl-focus);
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* Scrollbar Hiding (Nav) */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* KaTeX Containment Invariant */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding: 0.5em 0;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Inline KaTeX Background Rule */
        .katex {
            background-color: transparent !important;
        }

        /* Markdown Content Styling */
        .md-content p {
            margin-bottom: 0.75em;
        }
        .md-content p:last-child {
            margin-bottom: 0;
        }
        .md-content ul {
            list-style-type: disc;
            padding-left: 1.25em;
            margin-bottom: 0.75em;
        }
        .md-content ol {
            list-style-type: decimal;
            padding-left: 1.25em;
            margin-bottom: 0.75em;
        }
        .md-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 1em 0;
            font-size: 0.95em;
        }
        .md-content th, .md-content td {
            border: 1px solid var(--cl-line);
            padding: 0.5em;
            text-align: left;
        }
        .md-content th {
            font-weight: 600;
            background-color: transparent;
        }

        /* Subordination Helpers */
        .subordinate-text {
            color: var(--cl-text-secondary);
        }

        /* Layout Primitives */
        .frame-shell {
            background-color: var(--cl-frame-bg);
        }
        .paper-surface {
            background-color: var(--cl-paper-surface);
        }
        .wash-surface {
            background-color: var(--cl-wash-bg);
        }
        .divider-line {
            border-color: var(--cl-line);
        }
        
        /* Interactive Text Button */
        .text-btn {
            color: var(--cl-accent);
            cursor: pointer;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 0.25em;
            background: none;
            border: none;
            padding: 0;
            font-size: inherit;
        }
        .text-btn:hover {
            text-decoration: underline;
        }

        /* Navigation */
        .nav-item-active {
            color: var(--cl-text-primary);
            font-weight: 700;
        }
        /* ColorLab C: Optional Nav Current Marker */
        .nav-item-active::before {
            content: '';
            position: absolute;
            left: -12px;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 4px;
            background-color: var(--cl-accent);
            border-radius: 50%;
        }

    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Top Controls (Aligned to frame) -->
    <div class="w-full flex justify-center pt-4 pb-2 px-4 md:px-6 frame-shell z-50">
        <div class="w-full max-w-[1200px] flex items-center justify-between gap-4">
            
            <!-- Paper Selector -->
            <div class="flex items-center gap-3">
                <label for="paper-select" class="text-sm font-medium subordinate-text">Paper:</label>
                <select id="paper-select" class="bg-transparent border border-[var(--cl-line)] rounded px-2 py-1 text-sm text-[var(--cl-text-primary)] focus:border-[var(--cl-accent)] outline-none">
                    <option value="" disabled selected>Loading...</option>
                </select>
            </div>

            <!-- Mobile Jump To Trigger -->
            <button id="mobile-jump-trigger" class="md:hidden text-sm font-medium text-[var(--cl-accent)]">
                Jump to
            </button>
        </div>
    </div>

    <!-- Divider -->
    <div class="w-full h-px bg-[var(--cl-line)]"></div>

    <!-- DocumentFrameShell -->
    <main class="flex-grow flex justify-center frame-shell">
        <div class="w-full max-w-[1200px] flex flex-col md:flex-row relative">
            
            <!-- Desktop Nav Rail (Left Column, Sticky) -->
            <nav class="hidden md:block w-64 flex-shrink-0 pt-8 pb-12 pr-6 sticky top-0 h-screen overflow-y-auto no-scrollbar">
                <div id="desktop-nav-content" class="flex flex-col gap-6">
                    <!-- Nav generated here -->
                </div>
            </nav>

            <!-- Mobile Nav Drawer (Overlay) -->
            <div id="mobile-drawer" class="fixed inset-0 z-[100] hidden" aria-hidden="true">
                <div class="absolute inset-0 bg-black/20 backdrop-blur-sm" id="drawer-backdrop"></div>
                <div class="absolute right-0 top-0 bottom-0 w-64 frame-shell shadow-xl flex flex-col">
                    <div class="p-4 border-b border-[var(--cl-line)] flex justify-between items-center">
                        <span class="font-semibold text-[var(--cl-text-primary)]">Jump to</span>
                        <button id="drawer-close" class="text-[var(--cl-text-secondary)] p-2 hover:text-[var(--cl-text-primary)]">✕</button>
                    </div>
                    <div id="mobile-nav-content" class="flex-1 overflow-y-auto p-4 flex flex-col gap-6">
                        <!-- Nav generated here -->
                    </div>
                </div>
            </div>

            <!-- Paper Content Column (Right, Primary) -->
            <div class="flex-1 pt-8 pb-32 px-4 md:px-8 min-w-0 paper-surface border-l border-r border-[var(--cl-line)] md:border-l-[var(--cl-line)] border-transparent">
                <div id="paper-content-container" class="max-w-3xl mx-auto">
                    <!-- Paper content generated here -->
                    <div class="text-center py-10 subordinate-text">Loading paper...</div>
                </div>
            </div>

        </div>
    </main>

    <script>
        // =========================================================
        // STAGE 0: CONSTANTS definition (Single Source of Truth)
        // =========================================================
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // =========================================================
        // RUN CONFIG PARSING (Optional User Override)
        // =========================================================
        const DEFAULT_CONFIG = {
            RTQ_COLORLAB_FORCE_HUE_FAMILY: 'amber',
            RTQ_COLORLAB_INTENSITY_MODE: 'tinted_neutrals'
        };

        // Note: In a real environment, we would parse the user message for RUN_CONFIG_BEGIN.
        // For this execution context, we rely on the script constants and manual DOM defaults.
        // We will stick to the 'amber' + 'tinted_neutrals' requested in the prompt via defaults.
        
        // =========================================================
        // MARKDOWN CONFIGURATION (Authoritative)
        // =========================================================
        const md = window.markdownit ? window.markdownit({
            html: true,     // Allow inline SVG
            linkify: true,
            breaks: false,  // CRITICAL: Must be false for KaTeX
        }) : null;

        if (md) {
            // Disable escape rule to preserve TeX backslashes
            md.inline.ruler.disable(['escape']);
        }

        // =========================================================
        // STATE MANAGEMENT
        // =========================================================
        const state = {
            papers: [],
            activePaperId: null,
            expandedNodes: new Set(), // Set of question IDs with expanded workings
            questionsMap: new Map(), // Flattened map for navigation lookups
        };

        // =========================================================
        // DOM ELEMENTS
        // =========================================================
        const els = {
            paperSelect: document.getElementById('paper-select'),
            desktopNav: document.getElementById('desktop-nav-content'),
            mobileNav: document.getElementById('mobile-nav-content'),
            paperContainer: document.getElementById('paper-content-container'),
            mobileJumpTrigger: document.getElementById('mobile-jump-trigger'),
            mobileDrawer: document.getElementById('mobile-drawer'),
            drawerClose: document.getElementById('drawer-close'),
            drawerBackdrop: document.getElementById('drawer-backdrop'),
        };

        // =========================================================
        // DATA LOADING
        // =========================================================
        async function loadPayload() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Fetch failed");
                const data = await response.json();
                
                if (!data.papers || !Array.isArray(data.papers)) {
                    throw new Error("Invalid schema");
                }

                state.papers = data.papers;
                initApp();
            } catch (err) {
                console.error("Payload load error:", err);
                renderFailure();
            }
        }

        function renderFailure() {
            els.paperContainer.innerHTML = `
                <div class="text-center py-20">
                    <h2 class="text-xl font-bold mb-2">PAPERS PAYLOAD MISSING</h2>
                    <p class="subordinate-text">Could not load content from ${RTQ_PAPERS_PAYLOAD_PATH}</p>
                </div>
            `;
            els.paperSelect.innerHTML = '<option disabled>Error</option>';
        }

        // =========================================================
        // INITIALIZATION
        // =========================================================
        function initApp() {
            // Populate Selector
            els.paperSelect.innerHTML = '';
            state.papers.forEach(paper => {
                const opt = document.createElement('option');
                opt.value = paper.key;
                opt.textContent = paper.label || paper.key;
                els.paperSelect.appendChild(opt);
            });

            // Listeners
            els.paperSelect.addEventListener('change', (e) => switchPaper(e.target.value));
            els.mobileJumpTrigger.addEventListener('click', openDrawer);
            els.drawerClose.addEventListener('click', closeDrawer);
            els.drawerBackdrop.addEventListener('click', closeDrawer);

            // Set Initial Paper
            if (state.papers.length > 0) {
                switchPaper(state.papers[0].key);
            }
        }

        function switchPaper(paperKey) {
            const paper = state.papers.find(p => p.key === paperKey);
            if (!paper) return;

            state.activePaperId = paperKey;
            state.questionsMap.clear();
            state.expandedNodes.clear();

            // Handle Defaults
            const expandedAll = paper.defaults?.expandedAll !== false; // Default true unless false
            
            // Pre-process for Flattened Map (for Nav) and Defaults
            function traverse(nodes) {
                nodes.forEach(node => {
                    if (node.id) state.questionsMap.set(node.id, node);
                    if (expandedAll && node.solutionBlock?.solutionDetails) {
                        state.expandedNodes.add(node.id);
                    }
                    if (node.children) traverse(node.children);
                });
            }

            if (paper.questions) traverse(paper.questions);
            if (paper.sections) {
                paper.sections.forEach(sec => traverse(sec.questions));
            }

            renderPaperContent(paper);
            renderNavigation(paper);
            renderMath();
            closeDrawer();
        }

        // =========================================================
        // RENDERING: NAVIGATION
        // =========================================================
        function renderNavigation(paper) {
            const createNavHTML = () => {
                let html = '';
                
                const renderItems = (questions) => {
                    let chunk = '';
                    questions.forEach(q => {
                        // Depth logic via ID parsing or just flat list? 
                        // Brief says: derived from children. 
                        // For Nav, brief says "flat list", hierarchy via type scale. 
                        // We will rely on simple flat iteration here for top-level, 
                        // but actually we need to walk the tree to get all IDs.
                        // Let's create a linear walker.
                        
                        function walk(nodes, depth) {
                            nodes.forEach(node => {
                                const isSub = depth > 0;
                                const styleClass = isSub ? 'text-xs opacity-80' : 'text-sm font-medium';
                                
                                chunk += `
                                    <div class="relative pl-2 py-1">
                                        <a href="#q-${node.id}" 
                                           class="block subordinate-text hover:text-[var(--cl-text-primary)] transition-colors ${styleClass}"
                                           onclick="highlightNav('${node.id}')"
                                           data-nav-id="${node.id}">
                                           ${node.id}
                                        </a>
                                    </div>
                                `;
                                if (node.children) walk(node.children, depth + 1);
                            });
                        }
                        walk([q], 0);
                    });
                    return chunk;
                };

                if (paper.sections) {
                    paper.sections.forEach(section => {
                        html += `<div class="mb-4">`;
                        if (section.label && section.label.trim().length > 0) {
                            html += `<div class="text-[11px] uppercase tracking-wider font-semibold subordinate-text mb-2 pl-2 select-none">${section.label}</div>`;
                        }
                        html += renderItems(section.questions);
                        html += `</div>`;
                    });
                } else if (paper.questions) {
                    html += renderItems(paper.questions);
                }
                return html;
            };

            const markup = createNavHTML();
            els.desktopNav.innerHTML = markup;
            els.mobileNav.innerHTML = markup;
        }

        window.highlightNav = (id) => {
            // Simple active state logic
            document.querySelectorAll('[data-nav-id]').forEach(el => {
                el.classList.remove('nav-item-active');
            });
            document.querySelectorAll(`[data-nav-id="${id}"]`).forEach(el => {
                el.classList.add('nav-item-active');
            });
            // Don't prevent default anchor jump behavior
        };

        // =========================================================
        // RENDERING: PAPER CONTENT
        // =========================================================
        function renderPaperContent(paper) {
            let html = '';

            if (paper.sections) {
                paper.sections.forEach(section => {
                    html += `<section class="mb-12">`;
                    if (section.label && section.label.trim().length > 0) {
                        html += `
                            <div class="border-b border-[var(--cl-line)] mb-8 pb-2">
                                <h2 class="text-lg font-semibold text-[var(--cl-text-primary)]">${section.label}</h2>
                            </div>
                        `;
                    }
                    html += renderQuestionList(section.questions);
                    html += `</section>`;
                });
            } else if (paper.questions) {
                html += renderQuestionList(paper.questions);
            }

            els.paperContainer.innerHTML = html;
        }

        function renderQuestionList(questions) {
            return `<div class="flex flex-col gap-12">
                ${questions.map(q => renderQuestionNode(q, 0)).join('')}
            </div>`;
        }

        function renderQuestionNode(node, depth) {
            // Render Markdown content
            const questionHtml = md ? md.render(node.question || '') : node.question;
            const hasChildren = node.children && node.children.length > 0;
            const solutionBlock = node.solutionBlock;
            const hasSolutionDetails = solutionBlock && solutionBlock.solutionDetails;
            const hasAnswer = solutionBlock && solutionBlock.answer;
            const isExpanded = state.expandedNodes.has(node.id);

            // Spacing for nesting
            const indentClass = depth > 0 ? 'ml-0 md:ml-6 pl-4 border-l border-[var(--cl-line)]' : '';
            const spacingClass = depth > 0 ? 'mt-6' : '';

            // Answer HTML
            let answerHtml = '';
            if (hasAnswer) {
                const answerContent = md ? md.render(solutionBlock.answer) : solutionBlock.answer;
                answerHtml = `
                    <div class="mt-4 mb-2">
                        <span class="text-xs font-bold uppercase tracking-wide text-[var(--cl-text-secondary)] block mb-1">Answer</span>
                        <div class="md-content text-[var(--cl-text-primary)]">${answerContent}</div>
                    </div>
                `;
            }

            // Solution Details HTML
            let detailsHtml = '';
            let toggleHtml = '';
            
            if (hasSolutionDetails) {
                const sd = solutionBlock.solutionDetails;
                const displayStyle = isExpanded ? 'block' : 'none';
                const labelText = isExpanded ? 'Hide working' : 'Show working';
                const labelIcon = isExpanded ? '−' : '+'; // Simple text icon

                // Subsections
                const renderSection = (label, content, isList = false) => {
                    if (!content) return '';
                    const body = md ? md.render(content) : content;
                    // Keep in mind / Formulas usually lists. Working is blocks.
                    return `
                        <div class="mb-6 last:mb-0">
                            <div class="text-xs font-bold uppercase tracking-wide text-[var(--cl-text-secondary)] mb-2">${label}</div>
                            <div class="md-content text-sm subordinate-text">${body}</div>
                        </div>
                    `;
                };

                let altsHtml = '';
                if (sd.alternativeWorking && Array.isArray(sd.alternativeWorking)) {
                    altsHtml = sd.alternativeWorking.map(alt => renderSection('Alternative working', alt)).join('');
                }

                detailsHtml = `
                    <div id="sd-${node.id}" class="wash-surface rounded-sm p-4 mt-3 border-l-2 border-[var(--cl-line)]" style="display: ${displayStyle}">
                        ${renderSection('Keep in mind', sd.keepInMind)}
                        ${renderSection('Formulas used', sd.formulasUsed)}
                        ${renderSection('Working', sd.working)}
                        ${altsHtml}
                    </div>
                `;

                toggleHtml = `
                    <div class="mt-3">
                        <button class="text-btn text-sm" onclick="toggleDetails('${node.id}')">
                            <span>${labelText}</span>
                            <span class="text-xs ml-1 opacity-70">${labelIcon}</span>
                        </button>
                    </div>
                `;
            }

            return `
                <div id="q-${node.id}" class="question-node ${indentClass} ${spacingClass} scroll-mt-24">
                    <!-- Question Body -->
                    <div class="flex gap-3">
                        <div class="flex-shrink-0 w-8 pt-1">
                            <span class="text-sm font-semibold subordinate-text">${node.id}</span>
                        </div>
                        <div class="flex-grow min-w-0">
                            <div class="md-content text-base font-medium text-[var(--cl-text-primary)]">
                                ${questionHtml}
                            </div>

                            <!-- Solution Block -->
                            ${hasAnswer || hasSolutionDetails ? `
                                <div class="solution-block mt-2">
                                    ${answerHtml}
                                    ${toggleHtml}
                                    ${detailsHtml}
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Children -->
                    ${hasChildren ? `
                        <div class="children-container mt-4">
                            ${node.children.map(child => renderQuestionNode(child, depth + 1)).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // =========================================================
        // INTERACTION HANDLERS
        // =========================================================
        window.toggleDetails = (nodeId) => {
            const container = document.getElementById(`sd-${nodeId}`);
            const btn = container.previousElementSibling.querySelector('button'); // Fragile DOM walk, strictly controlled by renderQuestionNode structure
            
            if (state.expandedNodes.has(nodeId)) {
                state.expandedNodes.delete(nodeId);
                container.style.display = 'none';
                btn.innerHTML = `<span>Show working</span><span class="text-xs ml-1 opacity-70">+</span>`;
            } else {
                state.expandedNodes.add(nodeId);
                container.style.display = 'block';
                btn.innerHTML = `<span>Hide working</span><span class="text-xs ml-1 opacity-70">−</span>`;
                // Re-render math in revealed section if needed (auto-render usually handles visible on load, but manual triggering is safer)
                renderMathInElement(container);
            }
        };

        function openDrawer() {
            els.mobileDrawer.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeDrawer() {
            els.mobileDrawer.classList.add('hidden');
            document.body.style.overflow = '';
        }

        // =========================================================
        // MATH RENDERING
        // =========================================================
        function renderMath() {
            renderMathInElement(document.body);
        }

        function renderMathInElement(elem) {
            if (window.renderMathInElement) {
                window.renderMathInElement(elem, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false}
                    ],
                    throwOnError: false
                });
            }
        }

        // =========================================================
        // START
        // =========================================================
        // Check for dependencies, then load
        document.addEventListener('DOMContentLoaded', () => {
           loadPayload();
        });

    </script>
</body>
</html>
