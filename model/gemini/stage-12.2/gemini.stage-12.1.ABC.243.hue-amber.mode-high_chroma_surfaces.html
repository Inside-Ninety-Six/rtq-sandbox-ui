<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"ABC","indexWithinVariant":"243","totalWithinVariant":"320","hueFamily":"amber","intensityMode":"high_chroma_surfaces","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-09T21:41:45.424Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;ABC&quot;,&quot;indexWithinVariant&quot;:&quot;243&quot;,&quot;totalWithinVariant&quot;:&quot;320&quot;,&quot;hueFamily&quot;:&quot;amber&quot;,&quot;intensityMode&quot;:&quot;high_chroma_surfaces&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-09T21:41:45.424Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Paper Viewer (Stage 6 Baseline)</title>

    <!-- Tailwind CSS (No SRI) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Lucide Icons (No SRI) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- KaTeX CSS & JS (No SRI) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Markdown-it (No SRI) -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        page: 'var(--bg-page)',
                        frame: 'var(--bg-frame)',
                        paper: 'var(--bg-paper)',
                        wash: 'var(--bg-wash)',
                        primary: 'var(--text-primary)',
                        secondary: 'var(--text-secondary)',
                        accent: 'var(--accent)',
                        border: 'var(--border)',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style type="text/tailwindcss">
        @layer base {
            /* COLORLAB C: Mode 3 (High Chroma Surfaces) + Hue: Amber (75) */
            :root {
                --hue: 75; 
                
                /* Mode 3: Two major surfaces chromatic (0.06-0.12), one tinted (0.03-0.07) */
                --bg-page: oklch(0.93 0.08 var(--hue));  /* Chromatic */
                --bg-frame: oklch(0.91 0.09 var(--hue)); /* Chromatic */
                --bg-paper: oklch(0.98 0.04 var(--hue)); /* Tinted (readability) */
                
                /* Mode 3: Wash 0.05-0.10 */
                --bg-wash: oklch(0.95 0.06 var(--hue));

                /* Text: Primary <= 0.015, Secondary <= 0.020 */
                --text-primary: oklch(0.20 0.015 var(--hue));
                --text-secondary: oklch(0.45 0.02 var(--hue));

                /* Accent: Mode 3 [0.12 .. 0.20] */
                --accent: oklch(0.55 0.16 var(--hue));
                
                /* Divider: Neutral <= 0.02 */
                --border: oklch(0.88 0.02 var(--hue));
            }

            body {
                @apply bg-page text-primary font-sans antialiased;
            }

            /* Scrollbar hiding utilities */
            .no-scrollbar::-webkit-scrollbar {
                display: none;
            }
            .no-scrollbar {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }

            /* KaTeX Overflow Safety */
            .katex-display {
                @apply max-w-full overflow-x-auto overflow-y-hidden py-1;
                -webkit-overflow-scrolling: touch;
            }
            
            /* Markdown Tables */
            table {
                @apply w-full border-collapse my-4 text-sm;
            }
            th, td {
                @apply border border-border px-3 py-2 text-left align-top;
            }
            th {
                @apply font-semibold text-primary bg-transparent;
            }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Top Controls Area -->
    <div id="top-controls-region" class="w-full sticky top-0 z-30 bg-page/90 backdrop-blur-sm border-b border-border/50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-14 flex items-center justify-between">
            <!-- Paper Selector -->
            <div class="flex items-center gap-3">
                <label for="paper-select" class="text-sm font-medium text-secondary">Paper</label>
                <select id="paper-select" class="bg-paper border border-border rounded text-sm text-primary py-1 px-2 focus:ring-2 focus:ring-accent focus:outline-none">
                    <option disabled selected>Loading...</option>
                </select>
            </div>

            <!-- Mobile Jump To Trigger -->
            <button id="mobile-jump-trigger" class="lg:hidden text-sm font-medium text-accent flex items-center gap-1.5 focus:outline-none focus:ring-2 focus:ring-accent rounded px-2 py-1">
                <span>Jump to</span>
                <i data-lucide="menu" class="w-4 h-4"></i>
            </button>
        </div>
    </div>

    <!-- Document Frame Shell -->
    <div id="document-frame-shell" class="flex-1 w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Desktop: 2-Col Grid -->
        <div class="lg:grid lg:grid-cols-[220px_1fr] lg:gap-12 relative items-start">

            <!-- Navigation Rail (Desktop) -->
            <aside class="hidden lg:block sticky top-20 max-h-[calc(100vh-6rem)] overflow-y-auto no-scrollbar py-2">
                <nav id="desktop-nav-list" class="space-y-1" aria-label="Paper navigation">
                    <!-- Nav items injected here -->
                </nav>
            </aside>

            <!-- Paper Content Region -->
            <main id="paper-region" class="bg-paper min-h-[500px] w-full max-w-[800px] shadow-sm rounded-none border border-border/20 p-8 sm:p-12 mx-auto lg:mx-0">
                <!-- Content injected here -->
                <div id="paper-content-loader" class="animate-pulse space-y-4">
                    <div class="h-4 bg-gray-200 rounded w-3/4"></div>
                    <div class="h-4 bg-gray-200 rounded w-1/2"></div>
                </div>
            </main>

        </div>
    </div>

    <!-- Mobile Navigation Drawer -->
    <div id="mobile-drawer-overlay" class="fixed inset-0 bg-black/50 z-40 hidden transition-opacity opacity-0" aria-hidden="true"></div>
    <div id="mobile-drawer" class="fixed inset-y-0 right-0 w-64 bg-paper z-50 transform translate-x-full transition-transform duration-300 shadow-xl flex flex-col" aria-hidden="true">
        <div class="p-4 border-b border-border flex justify-between items-center">
            <h2 class="text-lg font-medium text-primary">Jump to</h2>
            <button id="close-drawer" class="text-secondary hover:text-primary focus:outline-none focus:ring-2 focus:ring-accent rounded p-1">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>
        <nav id="mobile-nav-list" class="flex-1 overflow-y-auto p-4 space-y-1">
            <!-- Mobile nav items injected here -->
        </nav>
    </div>

    <script>
        // --- STAGE 0: CONSTANTS ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // --- MARKDOWN CONFIG (Authoritative) ---
        const md = window.markdownit ? window.markdownit({
            html: true,
            linkify: true,
            breaks: false, // CRITICAL
        }) : null;

        if (md) {
            md.inline.ruler.disable(['escape']);
        }

        // --- STATE ---
        let payload = null;
        let currentPaperKey = null;
        // Map question ID -> boolean (true = expanded)
        const expandedStates = new Map();

        // --- DOM ELEMENTS ---
        const paperSelect = document.getElementById('paper-select');
        const paperRegion = document.getElementById('paper-region');
        const desktopNavList = document.getElementById('desktop-nav-list');
        const mobileNavList = document.getElementById('mobile-nav-list');
        const mobileDrawer = document.getElementById('mobile-drawer');
        const mobileDrawerOverlay = document.getElementById('mobile-drawer-overlay');
        const mobileJumpTrigger = document.getElementById('mobile-jump-trigger');
        const closeDrawerBtn = document.getElementById('close-drawer');

        // --- INITIALIZATION ---
        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Fetch failed");
                payload = await response.json();
                
                if (!payload || !payload.papers) throw new Error("Invalid payload");

                renderSelector();
                
                // Select first paper by default
                if (payload.papers.length > 0) {
                    loadPaper(payload.papers[0].key);
                }

                lucide.createIcons();
            } catch (err) {
                console.error(err);
                renderError();
            }
        }

        function renderError() {
            paperRegion.innerHTML = `
                <div class="flex flex-col items-center justify-center h-64 text-center">
                    <p class="text-lg font-bold text-secondary">PAPERS PAYLOAD MISSING</p>
                    <p class="text-sm text-secondary mt-2">Could not load from RTQ_PAPERS_PAYLOAD_PATH</p>
                </div>
            `;
            paperSelect.innerHTML = '<option disabled>Error</option>';
        }

        function renderSelector() {
            paperSelect.innerHTML = '';
            payload.papers.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.key;
                opt.textContent = p.label;
                paperSelect.appendChild(opt);
            });
            paperSelect.addEventListener('change', (e) => loadPaper(e.target.value));
        }

        // --- PAPER LOADING ---
        function loadPaper(key) {
            currentPaperKey = key;
            const paper = payload.papers.find(p => p.key === key);
            if (!paper) return;

            // Reset state
            expandedStates.clear();
            
            // Set defaults if provided
            if (paper.defaults && paper.defaults.expandedAll === false) {
                // Keep cleared (collapsed by default)
            } else {
                // Mark all as expanded by default (conceptually). 
                // However, our render logic checks Map.has() to determine specific toggle state.
                // We'll treat "missing in map" as "default for this paper".
            }

            // Render Nav
            renderNavigation(paper);

            // Render Content
            renderPaperContent(paper);

            // Trigger math render
            renderMath();
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'instant' });
        }

        // --- NAVIGATION RENDERING ---
        function renderNavigation(paper) {
            const items = [];
            
            if (paper.sections) {
                paper.sections.forEach(section => {
                    if (section.label && section.label.trim() !== "") {
                        items.push({ type: 'section', label: section.label });
                    }
                    if (section.questions) {
                        section.questions.forEach(q => traverseQuestionForNav(q, items));
                    }
                });
            } else if (paper.questions) {
                paper.questions.forEach(q => traverseQuestionForNav(q, items));
            }

            const html = items.map(item => {
                if (item.type === 'section') {
                    return `
                        <div class="pt-4 pb-2 text-xs font-semibold text-secondary uppercase tracking-wider select-none">
                            ${item.label}
                        </div>
                    `;
                } else {
                    // Question Item
                    // Hierarchy cue: scale/opacity based on depth? 
                    // Brief says: "Same left edge", hierarchy via type scale/quietness.
                    // We can assume depth 0 is base, depth > 0 is subordinate.
                    const isSub = item.depth > 0;
                    const classes = isSub 
                        ? "text-secondary text-sm font-normal py-1 hover:text-accent transition-colors block"
                        : "text-primary text-base font-medium py-1.5 hover:text-accent transition-colors block";
                    
                    return `
                        <a href="#q-${item.id}" 
                           class="${classes} focus:outline-none focus:text-accent focus:underline decoration-accent/50 underline-offset-4"
                           onclick="closeMobileDrawer()">
                           ${item.id}
                        </a>
                    `;
                }
            }).join('');

            desktopNavList.innerHTML = html;
            mobileNavList.innerHTML = html;
        }

        function traverseQuestionForNav(node, list, depth = 0) {
            list.push({ type: 'question', id: node.id, depth: depth });
            if (node.children) {
                node.children.forEach(child => traverseQuestionForNav(child, list, depth + 1));
            }
        }

        // --- CONTENT RENDERING ---
        function renderPaperContent(paper) {
            let html = '';
            
            if (paper.sections) {
                paper.sections.forEach((section, idx) => {
                    if (section.label && section.label.trim() !== "") {
                        html += `
                            <div class="mb-8 border-b border-border pb-2">
                                <h2 class="text-xl font-semibold text-primary">${section.label}</h2>
                            </div>
                        `;
                    }
                    html += `<div class="space-y-12 mb-12">`;
                    section.questions.forEach(q => {
                        html += renderQuestionNode(q, 0);
                    });
                    html += `</div>`;
                });
            } else if (paper.questions) {
                html += `<div class="space-y-12">`;
                paper.questions.forEach(q => {
                    html += renderQuestionNode(q, 0);
                });
                html += `</div>`;
            }
            
            paperRegion.innerHTML = html;
            
            // Re-bind listeners
            bindToggleListeners();
        }

        function renderQuestionNode(node, depth) {
            const isTopLevel = depth === 0;
            const hasSolutionBlock = !!node.solutionBlock;
            const hasAnswer = hasSolutionBlock && !!node.solutionBlock.answer;
            const hasDetails = hasSolutionBlock && !!node.solutionBlock.solutionDetails;
            
            // Determine expanded state
            // Default: true unless paper defaults say false.
            // Check Map first.
            let isExpanded = true; 
            // If explicit in map, use it
            if (expandedStates.has(node.id)) {
                isExpanded = expandedStates.get(node.id);
            } else {
                // Fallback to paper default
                // We need access to current paper defaults here, simplified: assume expanded unless specifically false
                // For simplicity in this baseline, default to expanded.
                const paper = payload.papers.find(p => p.key === currentPaperKey);
                if (paper && paper.defaults && paper.defaults.expandedAll === false) {
                    isExpanded = false;
                }
            }

            // Margin/spacing based on depth
            // Top level: largest spacing (handled by space-y-12 container)
            // Children: margin-top
            const indentClass = depth > 0 ? "ml-0 sm:ml-4 lg:ml-6 mt-6 border-l-2 border-transparent pl-0" : "";
            
            // Question Body
            const qBodyHtml = md ? md.render(node.question) : node.question;
            
            let blockHtml = `
                <div id="q-${node.id}" class="group ${indentClass} scroll-mt-24">
                    <!-- Question Body -->
                    <div class="flex gap-3 sm:gap-4">
                        <div class="shrink-0 w-8 sm:w-10 text-right">
                            <span class="text-sm sm:text-base font-semibold text-secondary select-none">${node.id}</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="prose prose-neutral max-w-none text-primary text-base sm:text-lg leading-relaxed">
                                ${qBodyHtml}
                            </div>
                        </div>
                    </div>
            `;

            // Solution Block
            if (hasSolutionBlock) {
                blockHtml += `<div class="ml-11 sm:ml-14 mt-4 space-y-4">`;

                // Answer
                if (hasAnswer) {
                    const ansHtml = md ? md.render(node.solutionBlock.answer) : node.solutionBlock.answer;
                    blockHtml += `
                        <div class="text-primary">
                            <span class="text-xs font-bold text-secondary uppercase tracking-wide block mb-1">Answer</span>
                            <div class="prose prose-neutral max-w-none text-lg font-medium">
                                ${ansHtml}
                            </div>
                        </div>
                    `;
                }

                // Solution Details
                if (hasDetails) {
                    const details = node.solutionBlock.solutionDetails;
                    const displayStyle = isExpanded ? 'block' : 'hidden';
                    const toggleText = isExpanded ? 'Hide working' : 'Show working';
                    
                    blockHtml += `
                        <div class="pt-2">
                            <button class="text-accent hover:text-accent/80 text-sm font-medium flex items-center gap-1 focus:outline-none focus:ring-2 focus:ring-accent rounded px-1 -ml-1 js-toggle-working" 
                                    data-id="${node.id}" 
                                    aria-expanded="${isExpanded}">
                                <span>${toggleText}</span>
                                <i data-lucide="${isExpanded ? 'chevron-up' : 'chevron-down'}" class="w-4 h-4"></i>
                            </button>

                            <div class="mt-3 ${displayStyle} bg-wash rounded-sm p-4 sm:p-5 border-l-2 border-border/50 text-base" id="details-${node.id}">
                    `;

                    // Keep in Mind
                    if (details.keepInMind) {
                        blockHtml += `
                            <div class="mb-5">
                                <div class="flex items-center gap-2 mb-2 text-secondary">
                                    <i data-lucide="lightbulb" class="w-4 h-4"></i>
                                    <span class="text-xs font-bold uppercase tracking-wide">Keep in mind</span>
                                </div>
                                <div class="prose prose-sm max-w-none text-primary/90">
                                    ${md ? md.render(details.keepInMind) : details.keepInMind}
                                </div>
                            </div>
                            <div class="border-t border-border/50 my-4 w-12"></div>
                        `;
                    }

                    // Formulas Used
                    if (details.formulasUsed) {
                        blockHtml += `
                            <div class="mb-5">
                                <span class="text-xs font-bold text-secondary uppercase tracking-wide block mb-2">Formulas used</span>
                                <div class="prose prose-sm max-w-none text-primary/80 italic">
                                    ${md ? md.render(details.formulasUsed) : details.formulasUsed}
                                </div>
                            </div>
                            <div class="border-t border-border/50 my-4 w-12"></div>
                        `;
                    }

                    // Working
                    if (details.working) {
                        blockHtml += `
                            <div class="mb-2">
                                <span class="text-xs font-bold text-secondary uppercase tracking-wide block mb-2">Working</span>
                                <div class="prose prose-neutral max-w-none text-primary space-y-4">
                                    ${md ? md.render(details.working) : details.working}
                                </div>
                            </div>
                        `;
                    }

                    // Alternative Working
                    if (details.alternativeWorking && Array.isArray(details.alternativeWorking)) {
                        details.alternativeWorking.forEach(alt => {
                            blockHtml += `
                                <div class="mt-6 pt-4 border-t border-border/40">
                                    <span class="text-xs font-bold text-secondary uppercase tracking-wide block mb-2">Alternative working</span>
                                    <div class="prose prose-neutral max-w-none text-primary space-y-4">
                                        ${md ? md.render(alt) : alt}
                                    </div>
                                </div>
                            `;
                        });
                    }

                    blockHtml += `</div></div>`; // End details container + wrapper
                }

                blockHtml += `</div>`; // End Solution Block
            }

            // Children
            if (node.children && node.children.length > 0) {
                blockHtml += `<div class="mt-4">`;
                node.children.forEach(child => {
                    blockHtml += renderQuestionNode(child, depth + 1);
                });
                blockHtml += `</div>`;
            }

            blockHtml += `</div>`; // End Node
            return blockHtml;
        }

        // --- INTERACTION ---
        function bindToggleListeners() {
            document.querySelectorAll('.js-toggle-working').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = btn.getAttribute('data-id');
                    const container = document.getElementById(`details-${id}`);
                    const isExpanded = btn.getAttribute('aria-expanded') === 'true';
                    
                    // Toggle state
                    const newState = !isExpanded;
                    expandedStates.set(id, newState);
                    
                    // Update DOM
                    btn.setAttribute('aria-expanded', newState);
                    btn.querySelector('span').textContent = newState ? 'Hide working' : 'Show working';
                    
                    const icon = btn.querySelector('i');
                    // Re-render icon (simple switch)
                    icon.setAttribute('data-lucide', newState ? 'chevron-up' : 'chevron-down');
                    lucide.createIcons({ root: btn });

                    if (newState) {
                        container.classList.remove('hidden');
                        container.classList.add('block');
                    } else {
                        container.classList.add('hidden');
                        container.classList.remove('block');
                    }
                });
            });
            
            // Re-run Lucide on new content
            lucide.createIcons();
            
            // Re-run math on new content (though technically we are hiding/showing DOM nodes, 
            // the content was already rendered by renderMath initially. 
            // However, display:none elements might need layout recalculation for KaTeX? 
            // Usually KaTeX handles it fine. We run renderMath globally after full paper load.)
        }

        function renderMath() {
            renderMathInElement(document.body, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false},
                    {left: '\\(', right: '\\)', display: false},
                    {left: '\\[', right: '\\]', display: true}
                ],
                throwOnError: false,
                output: 'html', // Accessible HTML output
                trust: true // Trust HTML in math for diagrams/color if needed
            });
        }

        // --- MOBILE DRAWER ---
        function openMobileDrawer() {
            mobileDrawerOverlay.classList.remove('hidden');
            // small delay to allow display:block to apply before opacity transition
            setTimeout(() => {
                mobileDrawerOverlay.classList.remove('opacity-0');
                mobileDrawer.classList.remove('translate-x-full');
            }, 10);
        }

        function closeMobileDrawer() {
            mobileDrawer.classList.add('translate-x-full');
            mobileDrawerOverlay.classList.add('opacity-0');
            setTimeout(() => {
                mobileDrawerOverlay.classList.add('hidden');
            }, 300);
        }

        mobileJumpTrigger.addEventListener('click', openMobileDrawer);
        closeDrawerBtn.addEventListener('click', closeMobileDrawer);
        mobileDrawerOverlay.addEventListener('click', closeMobileDrawer);

        // --- RUN ---
        init();

    </script>
</body>
</html>
