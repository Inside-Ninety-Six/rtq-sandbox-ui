<!DOCTYPE html>
<html lang="en" class="antialiased">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"ABC","indexWithinVariant":"165","totalWithinVariant":"320","hueFamily":"blue","intensityMode":"accent_only","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-09T17:43:27.147Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;ABC&quot;,&quot;indexWithinVariant&quot;:&quot;165&quot;,&quot;totalWithinVariant&quot;:&quot;320&quot;,&quot;hueFamily&quot;:&quot;blue&quot;,&quot;intensityMode&quot;:&quot;accent_only&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-09T17:43:27.147Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Viewer (Stage 6)</title>

    <!-- Tailwind CSS (Rapid Prototyping) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- KaTeX CSS & JS (No Integrity, per Stage 6 baseline) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Markdown-it (No Integrity) -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- ColorLab & Typography Config -->
    <style>
        :root {
            /* 
               COLORLAB C: Mode "accent_only" (Light Mode Only)
               COLORLAB B: Hue "blue" (~250 OKLCH)
            */
            
            /* Surfaces - C <= 0.015 */
            --color-page-bg: oklch(0.985 0.005 250); 
            --color-frame-bg: oklch(0.985 0.005 250); /* Shared surface context */
            --color-paper-bg: oklch(1.0 0 0); /* White */
            --color-wash: oklch(0.98 0.01 250); /* Subtle wash for solution details */

            /* Typography - C <= 0.010 */
            --color-text-primary: oklch(0.20 0.01 250);
            --color-text-secondary: oklch(0.45 0.01 250);
            --color-text-tertiary: oklch(0.60 0.005 250);

            /* Interactive / Accent - C [0.08..0.14] */
            --color-accent: oklch(0.60 0.14 250); 
            --color-accent-subtle: oklch(0.94 0.04 250); /* For focus rings/light touches */

            /* Borders / Dividers */
            --color-border: oklch(0.92 0.01 250);
            --color-border-hairline: oklch(0.94 0.005 250);

            /* Spacing Units */
            --space-unit: 1rem;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-page-bg);
            color: var(--color-text-primary);
            overflow-y: scroll; /* Force vertical scrollbar to prevent shifts */
        }

        /* Utility classes mapping to CSS vars */
        .bg-page { background-color: var(--color-page-bg); }
        .bg-frame { background-color: var(--color-frame-bg); }
        .bg-paper { background-color: var(--color-paper-bg); }
        .bg-wash { background-color: var(--color-wash); }
        .text-primary { color: var(--color-text-primary); }
        .text-secondary { color: var(--color-text-secondary); }
        .text-tertiary { color: var(--color-text-tertiary); }
        .text-accent { color: var(--color-accent); }
        .border-base { border-color: var(--color-border); }
        .border-hairline { border-color: var(--color-border-hairline); }

        /* Focus Styles (Stage 5.5.2) */
        :focus-visible {
            outline: 2px solid var(--color-accent);
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* Scrollbar Hiding for Nav (Stage 3 Add-on) */
        .no-scrollbar {
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE/Edge */
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none; /* Chrome/Safari */
        }

        /* KaTeX Containment (Stage 3 Locked) */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 4px; /* Space for scrollbar if needed */
        }
        
        /* Table Styles (Stage 5.8.5) */
        .md-content table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95em;
            margin-bottom: 1em;
        }
        .md-content th, .md-content td {
            border: 1px solid var(--color-border);
            padding: 8px 12px;
            text-align: left;
        }
        .md-content th {
            font-weight: 600;
            color: var(--color-text-primary);
        }
        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-bottom: 1rem;
        }

        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }

        /* Transitions */
        .disclosure-transition {
            transition: all 0.2s ease-out;
        }
    </style>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        page: 'var(--color-page-bg)',
                        frame: 'var(--color-frame-bg)',
                        paper: 'var(--color-paper-bg)',
                        wash: 'var(--color-wash)',
                        primary: 'var(--color-text-primary)',
                        secondary: 'var(--color-text-secondary)',
                        tertiary: 'var(--color-text-tertiary)',
                        accent: 'var(--color-accent)',
                        borderBase: 'var(--color-border)',
                        hairline: 'var(--color-border-hairline)',
                    }
                }
            }
        }
    </script>
</head>
<body class="min-h-screen flex flex-col items-center">

    <!-- Top Controls Region -->
    <header class="w-full max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex items-center justify-between z-10">
        <div id="paper-selector-container">
            <!-- Paper Selector Injected Here -->
        </div>
        <div class="lg:hidden">
            <button id="mobile-jump-trigger" class="text-sm font-medium text-accent hover:underline flex items-center gap-1">
                Jump to <i data-lucide="menu" class="w-4 h-4"></i>
            </button>
        </div>
    </header>

    <!-- DocumentFrameShell -->
    <main id="app-shell" class="w-full max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 pb-20 flex flex-col lg:grid lg:grid-cols-[200px_1fr] gap-8 bg-frame">
        
        <!-- Navigation Rail (Desktop) -->
        <aside class="hidden lg:block relative">
            <div class="sticky top-4 h-[calc(100vh-2rem)] overflow-y-auto no-scrollbar pr-4">
                <nav id="desktop-nav" aria-label="Paper Navigation">
                    <!-- Nav Items Injected Here -->
                </nav>
            </div>
        </aside>

        <!-- Paper Content Column -->
        <section id="paper-content" class="w-full min-h-[50vh]">
            <!-- Paper Content Injected Here -->
            <div id="loading-state" class="text-secondary py-12 text-center">Loading paper content...</div>
        </section>

    </main>

    <!-- Mobile Drawer (Overlay) -->
    <div id="mobile-drawer-backdrop" class="fixed inset-0 bg-black/20 z-40 hidden opacity-0 transition-opacity duration-200" aria-hidden="true"></div>
    <div id="mobile-drawer" class="fixed inset-y-0 right-0 w-64 bg-paper z-50 transform translate-x-full transition-transform duration-200 shadow-xl flex flex-col" aria-hidden="true">
        <div class="p-4 border-b border-borderBase flex justify-between items-center bg-frame">
            <h2 class="font-medium text-primary">Jump to</h2>
            <button id="drawer-close" class="p-2 text-secondary hover:text-primary">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>
        <div class="flex-1 overflow-y-auto p-4 no-scrollbar">
            <nav id="mobile-nav-list" aria-label="Mobile Navigation">
                <!-- Mobile Nav Items Injected Here -->
            </nav>
        </div>
    </div>

    <script>
        // --- STAGE 0: CONSTANTS ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // --- State Management ---
        let state = {
            papers: [],
            currentPaperId: null,
            payload: null,
            expandedStates: {} // Key: questionId, Value: boolean
        };

        // --- Markdown Renderer Config (Stage 6 Add-on) ---
        const md = window.markdownit ? window.markdownit({
            html: true, // Allow inline SVG
            linkify: true,
            breaks: false, // Critical: MUST be false for KaTeX
        }) : null;

        if (md) {
            // Disable escape rule to preserve TeX backslashes
            md.inline.ruler.disable(['escape']);
        }

        // --- Core Application Logic ---

        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Payload missing");
                state.payload = await response.json();
                state.papers = state.payload.papers || [];

                if (state.papers.length > 0) {
                    selectPaper(state.papers[0].key);
                } else {
                    renderError("No papers found in payload.");
                }
            } catch (e) {
                console.error(e);
                renderError("PAPERS PAYLOAD MISSING");
            }
        }

        function renderError(msg) {
            const content = document.getElementById('paper-content');
            content.innerHTML = `<div class="py-20 text-center text-tertiary font-medium">${msg}</div>`;
            document.getElementById('paper-selector-container').innerHTML = '';
        }

        function selectPaper(paperKey) {
            const paper = state.papers.find(p => p.key === paperKey);
            if (!paper) return;

            state.currentPaperId = paperKey;
            
            // Set defaults based on paper config
            const defaultExpanded = paper.defaults?.expandedAll !== false;
            
            // Flatten questions to map IDs for interaction state
            state.expandedStates = {};
            // Note: We don't need to pre-fill unless we want explicit tracking. 
            // We'll rely on reading DOM state or initializing correctly during render.

            renderPaperSelector();
            renderNavigation(paper);
            renderPaperContent(paper, defaultExpanded);
            
            // Render Math
            renderMathInElement(document.body, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false}
                ],
                throwOnError: false
            });

            // Re-initialize Lucide icons
            lucide.createIcons();

            // Reset scroll
            window.scrollTo(0, 0);
        }

        // --- Rendering: Controls ---

        function renderPaperSelector() {
            const container = document.getElementById('paper-selector-container');
            if (state.papers.length <= 1) {
                container.innerHTML = `<span class="font-medium text-primary">${state.papers[0]?.label || 'Paper'}</span>`;
                return;
            }

            const select = document.createElement('select');
            select.className = "bg-frame text-primary text-sm font-medium border border-borderBase rounded px-2 py-1 focus:outline-none focus:ring-2 focus:ring-accent";
            select.ariaLabel = "Select Paper";
            
            state.papers.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.key;
                opt.textContent = p.label;
                opt.selected = p.key === state.currentPaperId;
                select.appendChild(opt);
            });

            select.addEventListener('change', (e) => selectPaper(e.target.value));
            container.innerHTML = '';
            container.appendChild(select);
        }

        // --- Rendering: Navigation ---

        function renderNavigation(paper) {
            const desktopContainer = document.getElementById('desktop-nav');
            const mobileContainer = document.getElementById('mobile-nav-list');
            
            // Helper to generate list items
            let navHTML = '';
            let isSectioned = paper.sections && paper.sections.length > 0;

            const renderItems = (questions) => {
                let html = '';
                questions.forEach(q => {
                    // Check recursion for flatten list
                    html += createNavItem(q);
                    if (q.children && q.children.length > 0) {
                        html += renderItems(q.children);
                    }
                });
                return html;
            };

            const createNavItem = (q) => {
                // Determine hierarchy level via children structure is hard in flat list generation without context.
                // However, the brief says "Flat list, identifiers only". 
                // Visual hierarchy via type scale.
                // We'll simplisticly assume ID length or patterns, OR just render flat.
                // The brief allows "sub-questions quieter".
                
                // Let's deduce depth roughly by simple regex on ID or just treat all eq. 
                // Better: The payload structure implies hierarchy.
                // Since this recursion generates a flat string, we'll assign classes based on a simplistic heuristic
                // or just keep it truly flat per strict requirement.
                // "Hierarchy expressed only via typographic scale/quietness while keeping same left edge"
                
                // We'll assume top level for now.
                const isSub = q.id.length > 3 || q.id.includes('(') || q.id.match(/[a-z]/); 
                const classes = isSub ? "text-secondary font-normal text-xs py-1" : "text-primary font-medium text-sm py-1.5";

                return `<a href="#q-${q.id}" class="block w-full text-left truncate hover:text-accent focus:outline-none focus:text-accent transition-colors ${classes}">${q.id}</a>`;
            };

            if (isSectioned) {
                paper.sections.forEach(section => {
                    if (section.label && section.label.trim().length > 0) {
                        navHTML += `<div class="mt-4 mb-2 text-xs font-bold text-tertiary uppercase tracking-wider select-none">${section.label}</div>`;
                    } else if (navHTML.length > 0) {
                        // Spacing between implicit sections
                         navHTML += `<div class="mt-4"></div>`;
                    }
                    navHTML += renderItems(section.questions);
                });
            } else {
                navHTML += renderItems(paper.questions);
            }

            desktopContainer.innerHTML = navHTML;
            mobileContainer.innerHTML = navHTML;
        }

        // --- Rendering: Paper Content ---

        function renderPaperContent(paper, defaultExpanded) {
            const container = document.getElementById('paper-content');
            container.innerHTML = ''; // Clear

            // Container for vertical rhythm
            const listContainer = document.createElement('div');
            listContainer.className = "space-y-12"; // Top level separation (Stage 5.1: largest unit)

            if (paper.sections) {
                paper.sections.forEach((section, idx) => {
                    const sectionBlock = document.createElement('div');
                    
                    if (section.label && section.label.trim()) {
                        const header = document.createElement('div');
                        header.className = "text-xl font-semibold text-tertiary mb-8 border-b border-borderBase pb-2";
                        header.textContent = section.label; // Pure text
                        sectionBlock.appendChild(header);
                    }

                    const qList = document.createElement('div');
                    qList.className = "space-y-12";
                    section.questions.forEach(q => {
                        qList.appendChild(createQuestionNode(q, defaultExpanded, 0));
                    });
                    
                    sectionBlock.appendChild(qList);
                    listContainer.appendChild(sectionBlock);

                    // Separator between sections if needed
                    if (idx < paper.sections.length - 1) {
                         // Implicit spacing via space-y-12 on parent, but sections might need more.
                         // Keeping simple.
                    }
                });
            } else {
                paper.questions.forEach(q => {
                    listContainer.appendChild(createQuestionNode(q, defaultExpanded, 0));
                });
            }

            container.appendChild(listContainer);
        }

        function createQuestionNode(q, defaultExpanded, depth) {
            const node = document.createElement('div');
            // ID for navigation anchor
            node.id = `q-${q.id}`;
            node.className = "group relative"; 
            
            // QUESTION BODY
            const bodyWrapper = document.createElement('div');
            bodyWrapper.className = "flex gap-4 items-baseline"; // Identifier + Prompt

            const idEl = document.createElement('div');
            idEl.className = "shrink-0 w-8 md:w-12 text-secondary font-medium text-sm select-none";
            idEl.textContent = q.id;

            const promptEl = document.createElement('div');
            promptEl.className = "grow text-primary text-base md:text-lg leading-relaxed space-y-4";
            promptEl.innerHTML = renderMarkdown(q.question);

            bodyWrapper.appendChild(idEl);
            bodyWrapper.appendChild(promptEl);
            node.appendChild(bodyWrapper);

            // SOLUTION BLOCK
            if (q.solutionBlock) {
                const sb = q.solutionBlock;
                const solutionBlockWrapper = document.createElement('div');
                // Indent to align with prompt (skip ID width + gap)
                // Desktop: 12 (3rem) + 4 (1rem) = 4rem (pl-16). Mobile: 8 (2rem) + 4 (1rem) = 3rem (pl-12).
                solutionBlockWrapper.className = "mt-6 pl-12 md:pl-16 space-y-6";

                // ANSWER (Optional)
                if (sb.answer) {
                    const answerDiv = document.createElement('div');
                    answerDiv.className = "relative";
                    const label = document.createElement('div');
                    label.className = "text-xs font-bold text-tertiary uppercase tracking-wide mb-1";
                    label.textContent = "Answer";
                    
                    const content = document.createElement('div');
                    content.className = "text-primary font-medium text-lg";
                    content.innerHTML = renderMarkdown(sb.answer);

                    answerDiv.appendChild(label);
                    answerDiv.appendChild(content);
                    solutionBlockWrapper.appendChild(answerDiv);
                }

                // SOLUTION DETAILS (Optional)
                if (sb.solutionDetails) {
                    const sd = sb.solutionDetails;
                    const detailsId = `sd-${q.id}`;
                    
                    // Toggle Control
                    const toggleBtn = document.createElement('button');
                    toggleBtn.className = "flex items-center gap-2 text-sm font-medium text-accent hover:text-primary transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-accent rounded px-1 -ml-1 py-1";
                    toggleBtn.setAttribute('aria-expanded', defaultExpanded);
                    toggleBtn.setAttribute('aria-controls', detailsId);
                    
                    const updateToggleText = (expanded) => {
                        toggleBtn.innerHTML = `
                            <span class="text-xs font-bold uppercase tracking-wide">${expanded ? 'Hide working' : 'Show working'}</span>
                            <i data-lucide="${expanded ? 'chevron-up' : 'chevron-down'}" class="w-4 h-4"></i>
                        `;
                        lucide.createIcons({ root: toggleBtn });
                    };
                    updateToggleText(defaultExpanded);

                    // Details Region
                    const region = document.createElement('div');
                    region.id = detailsId;
                    region.className = `mt-4 overflow-hidden disclosure-transition ${defaultExpanded ? '' : 'hidden'}`;
                    
                    // Surface Wash (Stage 3/5 permitted)
                    const wash = document.createElement('div');
                    wash.className = "bg-wash border-l-2 border-borderBase pl-4 py-4 pr-4 rounded-r-sm space-y-6";
                    
                    // 1. Keep in mind
                    if (sd.keepInMind) {
                        const block = createSubBlock("Keep in mind", sd.keepInMind, "text-secondary");
                        wash.appendChild(block);
                    }
                    
                    // 2. Formulas Used
                    if (sd.formulasUsed) {
                        const block = createSubBlock("Formulas used", sd.formulasUsed, "text-secondary text-sm font-mono");
                        wash.appendChild(block);
                    }

                    // 3. Working
                    if (sd.working) {
                        const block = createSubBlock("Working", sd.working, "text-primary");
                        wash.appendChild(block);
                    }

                    // 4. Alternative Working
                    if (sd.alternativeWorking && Array.isArray(sd.alternativeWorking)) {
                        sd.alternativeWorking.forEach((alt, idx) => {
                            // Separator
                            const sep = document.createElement('div');
                            sep.className = "h-px bg-hairline my-4 w-full";
                            wash.appendChild(sep);
                            
                            const block = createSubBlock("Alternative working", alt, "text-primary");
                            wash.appendChild(block);
                        });
                    }

                    region.appendChild(wash);

                    // Logic
                    toggleBtn.onclick = () => {
                        const isExpanded = toggleBtn.getAttribute('aria-expanded') === 'true';
                        toggleBtn.setAttribute('aria-expanded', !isExpanded);
                        updateToggleText(!isExpanded);
                        if (isExpanded) {
                            region.classList.add('hidden');
                        } else {
                            region.classList.remove('hidden');
                        }
                    };

                    solutionBlockWrapper.appendChild(toggleBtn);
                    solutionBlockWrapper.appendChild(region);
                }

                node.appendChild(solutionBlockWrapper);
            }

            // CHILDREN (Recursive)
            if (q.children && q.children.length > 0) {
                const childrenContainer = document.createElement('div');
                // Indent children
                // Vertical separation between parent and children
                childrenContainer.className = "mt-6 space-y-6"; 
                // Add left padding to simulate nesting visually? 
                // Stage 3 says: "horizontal indentation ... optional indentation (spacing only)"
                childrenContainer.classList.add("pl-4", "md:pl-8"); // Subtle indent

                q.children.forEach(child => {
                    childrenContainer.appendChild(createQuestionNode(child, defaultExpanded, depth + 1));
                });
                node.appendChild(childrenContainer);
            }

            return node;
        }

        function createSubBlock(label, markdown, bodyClass) {
            const container = document.createElement('div');
            const header = document.createElement('div');
            header.className = "text-xs font-bold text-tertiary uppercase tracking-wide mb-2";
            header.textContent = label;
            
            const body = document.createElement('div');
            body.className = `md-content leading-relaxed space-y-2 ${bodyClass}`;
            body.innerHTML = renderMarkdown(markdown);
            
            container.appendChild(header);
            container.appendChild(body);
            return container;
        }

        function renderMarkdown(text) {
            if (!text) return '';
            if (!md) return text; // Fallback
            // Fix tables: Markdown-it might not wrap tables. We need to handle overflow.
            // A quick fix is to wrap table tags in a div class after render strings, but regex is fragile.
            // Better: use a simple replace after render if safe.
            const html = md.render(text);
            return html.replace(/<table>/g, '<div class="table-wrapper"><table>').replace(/<\/table>/g, '</table></div>');
        }

        // --- Interaction: Mobile Drawer ---
        const drawer = document.getElementById('mobile-drawer');
        const backdrop = document.getElementById('mobile-drawer-backdrop');
        const trigger = document.getElementById('mobile-jump-trigger');
        const closeBtn = document.getElementById('drawer-close');

        function toggleDrawer(show) {
            if (show) {
                backdrop.classList.remove('hidden');
                requestAnimationFrame(() => backdrop.classList.remove('opacity-0'));
                drawer.classList.remove('translate-x-full');
            } else {
                backdrop.classList.add('opacity-0');
                drawer.classList.add('translate-x-full');
                setTimeout(() => backdrop.classList.add('hidden'), 200);
            }
        }

        trigger.onclick = () => toggleDrawer(true);
        closeBtn.onclick = () => toggleDrawer(false);
        backdrop.onclick = () => toggleDrawer(false);
        // Close on nav click
        document.getElementById('mobile-nav-list').addEventListener('click', (e) => {
            if (e.target.tagName === 'A') toggleDrawer(false);
        });


        // --- Boot ---
        window.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
