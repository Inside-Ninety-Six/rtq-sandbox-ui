<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"ABC","indexWithinVariant":"251","totalWithinVariant":"320","hueFamily":"teal","intensityMode":"high_chroma_surfaces","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-09T22:02:09.595Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;ABC&quot;,&quot;indexWithinVariant&quot;:&quot;251&quot;,&quot;totalWithinVariant&quot;:&quot;320&quot;,&quot;hueFamily&quot;:&quot;teal&quot;,&quot;intensityMode&quot;:&quot;high_chroma_surfaces&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-09T22:02:09.595Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer (Stage 6 Baseline)</title>

    <!-- 
      STAGE 6 ADD-ON: REAL KATEX RENDERING
      Note: No integrity/crossorigin attributes per Stage 6.0.7b baseline.
    -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Markdown-it -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <!-- Tailwind CSS (for prototype styling) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- 
       COLORLAB ADD-ON CONFIGURATION
       Mode: ColorLab C (High Chroma Surfaces)
       Hue: ColorLab B (Teal - via RTQ_COLORLAB_FORCE_HUE_FAMILY="teal")
       
       Target OKLCH Values (High Chroma Logic):
       - Surfaces must be effectively colored (C > 0.06 for at least two major surfaces)
       - Light Mode Only
    -->
    <style>
        :root {
            /* 
               Hue: Teal (~175)
               Mode: High Chroma Surfaces 
            */
            
            /* Page Background: High Chroma (L ~0.95, C ~0.08) */
            --bg-page: oklch(0.95 0.08 175);
            
            /* Frame Base: High Chroma (L ~0.92, C ~0.09) */
            --bg-frame: oklch(0.92 0.09 175);
            
            /* Paper Surface: Tinted but readable (L ~0.99, C ~0.04) */
            --bg-paper: oklch(0.99 0.04 175);
            
            /* Solution Details Wash: Distinct Tint (L ~0.96, C ~0.07) */
            --bg-wash: oklch(0.96 0.07 175);
            
            /* Text: Deep Teal, High Legibility */
            --text-primary: oklch(0.20 0.03 175);
            --text-secondary: oklch(0.40 0.04 175);
            
            /* Accent (Links/Focus/Nav Marker): L ~0.55, C ~0.16 */
            --color-accent: oklch(0.55 0.16 175);
            
            /* Hairlines: Low chroma, neutral-ish teal */
            --border-hairline: oklch(0.85 0.04 175);

            /* Focus Ring */
            --focus-ring: var(--color-accent);
        }

        body {
            background-color: var(--bg-page);
            color: var(--text-primary);
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            overflow: hidden; /* App shell handles scroll */
        }

        /* 
           KATEX CONTAINMENT INVARIANT (Stage 6.0.8)
           Block math handles overflow, page never scrolls horizontally.
        */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding-bottom: 0.5rem; /* Space for scrollbar */
            -webkit-overflow-scrolling: touch;
        }
        
        /* Hide scrollbars for Nav but keep functionality */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Typography Helper Classes */
        .prose-content p {
            margin-bottom: 1em;
            line-height: 1.6;
        }
        .prose-content ul {
            list-style-type: disc;
            padding-left: 1.5em;
            margin-bottom: 1em;
        }
        .prose-content ol {
            list-style-type: decimal;
            padding-left: 1.5em;
            margin-bottom: 1em;
        }
        /* Tables per Stage 5.8.5: Minimal, structural */
        .prose-content table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1em;
            display: block;
            overflow-x: auto;
        }
        .prose-content td, .prose-content th {
            border: 1px solid var(--border-hairline);
            padding: 0.5rem;
            text-align: left;
        }
        .prose-content th {
            font-weight: 600;
        }

        /* Focus Styles (Stage 5.5.2) */
        :focus-visible {
            outline: 2px solid var(--focus-ring);
            outline-offset: 2px;
        }

        /* Utility */
        .hairline-b {
            border-bottom: 1px solid var(--border-hairline);
        }
        .hairline-t {
            border-top: 1px solid var(--border-hairline);
        }
        
        /* Drawer animation */
        .drawer-enter { transform: translateX(-100%); }
        .drawer-enter-active { transform: translateX(0); transition: transform 0.3s ease-out; }
        .drawer-exit { transform: translateX(0); }
        .drawer-exit-active { transform: translateX(-100%); transition: transform 0.2s ease-in; }
    </style>
</head>
<body>

    <!-- 
      APP SHELL
      DocumentFrameShell: Centered, shared surface context on Desktop.
    -->
    <div id="app" class="h-screen w-full flex flex-col lg:flex-row overflow-hidden max-w-7xl mx-auto bg-[var(--bg-frame)] shadow-xl lg:my-0 lg:rounded-none">
        
        <!-- LOADING / ERROR STATE -->
        <div id="loader" class="flex items-center justify-center w-full h-full text-lg font-medium animate-pulse">
            Loading Payload...
        </div>

    </div>

<script>
/**
 * STAGE 0: CONSTANTS (Canonical)
 */
const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";

/**
 * STATE MANAGEMENT
 */
const state = {
    papers: [],
    currentPaperKey: null,
    currentPaper: null,
    expandedStates: {}, // Map<questionId, boolean>
    isMobileDrawerOpen: false,
    payloadLoaded: false,
    payloadError: false
};

/**
 * MARKDOWN CONFIGURATION (Stage 6 Baseline)
 * html: true, linkify: true, breaks: false.
 */
const md = window.markdownit ? window.markdownit({
    html: true,
    linkify: true,
    breaks: false
}) : null;

if (md) {
    // Disable escape rule to preserve TeX backslashes
    md.inline.ruler.disable(['escape']);
}

/**
 * UTILITIES
 */
function renderMarkdown(text) {
    if (!text) return '';
    if (!md) return text; // Fallback
    return md.render(text);
}

function toggleDrawer(open) {
    state.isMobileDrawerOpen = open;
    render();
}

function switchPaper(key) {
    state.currentPaperKey = key;
    state.currentPaper = state.papers.find(p => p.key === key);
    
    // Reset expansion based on defaults
    state.expandedStates = {};
    const defaultExpanded = state.currentPaper.defaults?.expandedAll !== false; // Default is true unless explicit false
    
    // Helper to traverse and set defaults
    const traverse = (nodes) => {
        if (!nodes) return;
        nodes.forEach(q => {
            if (q.solutionBlock?.solutionDetails) {
                state.expandedStates[q.id] = defaultExpanded;
            }
            if (q.children) traverse(q.children);
            if (state.currentPaper.sections) {
                // If sectioned, questions are inside sections
            }
        });
    };

    if (state.currentPaper.sections) {
        state.currentPaper.sections.forEach(s => traverse(s.questions));
    } else {
        traverse(state.currentPaper.questions);
    }
    
    toggleDrawer(false);
    render();
}

function toggleSolution(id) {
    state.expandedStates[id] = !state.expandedStates[id];
    render(); // Re-render to show/hide content
    // Note: In a real React app we'd diff, here we just nuke and rebuild for prototype simplicity
    // Scroll position restoration is handled by the browser roughly in this simple model, 
    // but meant to be more robust in prod.
}

function scrollToQuestion(id) {
    const el = document.getElementById(`q-${id}`);
    if (el) {
        el.scrollIntoView({ behavior: 'smooth', block: 'start' });
        // Close drawer on mobile
        if(window.innerWidth < 1024) toggleDrawer(false);
    }
}

/**
 * PAYLOAD LOADING
 */
async function loadPayload() {
    try {
        const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
        if (!response.ok) throw new Error("Fetch failed");
        const data = await response.json();
        
        state.papers = data.papers || [];
        if (state.papers.length > 0) {
            state.payloadLoaded = true;
            // Select first paper by default
            switchPaper(state.papers[0].key); 
        } else {
            throw new Error("No papers");
        }
    } catch (e) {
        state.payloadError = true;
        render();
    }
}

/**
 * RENDERERS
 */

// 1. Navigation (Desktop Rail + Mobile Drawer Content)
function renderNavContent() {
    if (!state.currentPaper) return '';
    
    let html = `<div class="flex flex-col gap-4 py-6 px-4 no-scrollbar h-full overflow-y-auto">`;

    // Sections logic
    if (state.currentPaper.sections) {
        state.currentPaper.sections.forEach(section => {
            // Section Label (if present)
            if (section.label && section.label.trim().length > 0) {
                html += `
                    <div class="text-[var(--text-secondary)] font-medium text-xs uppercase tracking-wider mt-4 first:mt-0 mb-2 select-none">
                        Section ${section.label}
                    </div>
                `;
            }
            // Items
            section.questions.forEach(q => {
                html += renderNavItem(q);
            });
        });
    } else {
        // Flat paper
        state.currentPaper.questions.forEach(q => {
            html += renderNavItem(q);
        });
    }

    html += `</div>`;
    return html;
}

function renderNavItem(q, depth=0) {
    let html = '';
    
    // Indication of nesting via type scale/weight (Stage 5.4.5), but FLAT alignment
    // We do NOT indent.
    const isSub = depth > 0;
    const labelClass = isSub ? 'text-sm opacity-90' : 'text-base font-medium';
    
    html += `
        <button onclick="scrollToQuestion('${q.id}')" 
            class="text-left py-1 block w-full hover:text-[var(--color-accent)] transition-colors ${labelClass} text-[var(--text-secondary)] focus:outline-none focus-visible:text-[var(--color-accent)]">
            ${q.id}
        </button>
    `;

    if (q.children && q.children.length > 0) {
        q.children.forEach(child => {
            html += renderNavItem(child, depth + 1);
        });
    }
    
    return html;
}

// 2. Paper Content
function renderPaperContent() {
    if (!state.currentPaper) return '';
    
    let html = `<div class="bg-[var(--bg-paper)] min-h-full pb-32">`; // Paper surface
    
    // Top Controls (Desktop) inside Paper Column context
    html += `
        <div class="sticky top-0 z-10 bg-[var(--bg-paper)]/95 backdrop-blur border-b border-[var(--border-hairline)] px-6 py-4 flex items-center justify-between lg:justify-start gap-4">
            <!-- Mobile Toggle -->
            <button onclick="toggleDrawer(true)" class="lg:hidden p-2 -ml-2 text-[var(--text-secondary)]">
                <i data-lucide="menu"></i>
            </button>
            
            <!-- Paper Selector -->
            <div class="relative">
                <select onchange="switchPaper(this.value)" class="bg-transparent text-[var(--text-primary)] font-medium text-lg border-none focus:ring-2 focus:ring-[var(--focus-ring)] rounded py-1 pl-0 pr-8 cursor-pointer appearance-none">
                    ${state.papers.map(p => `<option value="${p.key}" ${p.key === state.currentPaperKey ? 'selected' : ''}>${p.label}</option>`).join('')}
                </select>
                <i data-lucide="chevron-down" class="absolute right-0 top-1/2 -translate-y-1/2 w-4 h-4 text-[var(--text-secondary)] pointer-events-none"></i>
            </div>
        </div>
    `;

    // Content Area
    html += `<div class="max-w-3xl mx-auto px-4 sm:px-8 py-8">`;

    if (state.currentPaper.sections) {
        state.currentPaper.sections.forEach(section => {
            // Section Header
            if (section.label && section.label.trim().length > 0) {
                html += `
                    <div class="mt-12 mb-8 border-b border-[var(--border-hairline)] pb-2">
                        <h2 class="text-xl font-bold text-[var(--text-primary)]">Section ${section.label}</h2>
                    </div>
                `;
            }
            // Questions
            html += `<div class="space-y-12">`;
            section.questions.forEach(q => {
                html += renderQuestionNode(q, 0);
            });
            html += `</div>`;
            // Spacer between sections
            html += `<div class="h-16"></div>`;
        });
    } else {
        html += `<div class="space-y-16">`;
        state.currentPaper.questions.forEach(q => {
            html += renderQuestionNode(q, 0);
        });
        html += `</div>`;
    }

    html += `</div></div>`; // End content area, end paper surface
    return html;
}

// 3. Question Node Renderer (Recursive)
function renderQuestionNode(q, depth) {
    const isTopLevel = depth === 0;
    // Stage 3 Spacing: Top level gets largest spacing (handled by space-y-16 in parent).
    // Children get less spacing.
    
    // Indentation for children (Visual nesting)
    const indentClass = depth > 0 ? 'ml-0 pl-4 border-l-2 border-transparent sm:pl-8' : ''; 
    // Note: We avoid heavy border lines for nesting per Stage 5 quietness, using padding.

    let html = `
        <div id="q-${q.id}" class="group ${indentClass} flex flex-col gap-4">
            
            <!-- Question Body -->
            <div class="flex flex-col gap-2">
                <div class="flex items-baseline gap-3">
                    <span class="text-[var(--text-secondary)] font-semibold text-sm select-none shrink-0" aria-hidden="true">${q.id}</span>
                    <div class="prose-content text-[var(--text-primary)] text-lg leading-relaxed flex-1">
                        ${renderMarkdown(q.question)}
                    </div>
                </div>
            </div>

            <!-- Solution Block (Optional) -->
            ${renderSolutionBlock(q)}

            <!-- Children Container -->
            ${q.children && q.children.length > 0 ? 
                `<div class="flex flex-col gap-8 mt-4 pt-4">
                    ${q.children.map(c => renderQuestionNode(c, depth + 1)).join('')}
                 </div>` 
                : ''}
        </div>
    `;
    
    // Divider for top level questions (optional safety net, Stage 3 allowed mechanism)
    // We rely on spacing primarily, but adding a very subtle seam if needed. 
    // Stage 5 prefers whitespace. Let's stick to whitespace as primary.
    
    return html;
}

function renderSolutionBlock(q) {
    if (!q.solutionBlock) return '';
    
    const { answer, solutionDetails } = q.solutionBlock;
    // If neither exist, don't render block
    if (!answer && !solutionDetails) return '';

    const isExpanded = state.expandedStates[q.id];

    let html = `<div class="ml-0 sm:ml-8 pl-0 sm:pl-3 flex flex-col gap-4 mt-2">`;

    // Answer (Visible by default if present)
    if (answer) {
        html += `
            <div class="flex flex-col sm:flex-row sm:items-baseline gap-1 sm:gap-3">
                <span class="text-[var(--text-secondary)] font-bold text-xs uppercase tracking-wide shrink-0 pt-1">Answer</span>
                <div class="prose-content text-[var(--text-primary)] font-medium">
                    ${renderMarkdown(answer)}
                </div>
            </div>
        `;
    }

    // Solution Details (Disclosure)
    if (solutionDetails) {
        html += `
            <div>
                <button onclick="toggleSolution('${q.id}')" 
                    class="group/toggle flex items-center gap-2 text-[var(--color-accent)] hover:underline focus:outline-none text-sm font-medium py-1">
                    <span>${isExpanded ? 'Hide working' : 'Show working'}</span>
                    <i data-lucide="chevron-${isExpanded ? 'up' : 'down'}" class="w-4 h-4"></i>
                </button>

                <!-- Expanded Region -->
                ${isExpanded ? `
                    <div class="mt-3 bg-[var(--bg-wash)] rounded-sm p-4 sm:p-6 animate-in fade-in slide-in-from-top-1 duration-200">
                        
                        <!-- Keep in mind -->
                        ${solutionDetails.keepInMind ? `
                            <div class="mb-6">
                                <div class="flex items-center gap-2 mb-2 text-[var(--text-secondary)]">
                                    <i data-lucide="lightbulb" class="w-4 h-4"></i>
                                    <span class="text-xs font-bold uppercase tracking-wide">Keep in mind</span>
                                </div>
                                <div class="prose-content text-[var(--text-primary)] text-sm">
                                    ${renderMarkdown(solutionDetails.keepInMind)}
                                </div>
                            </div>
                        ` : ''}

                        <!-- Formulas Used -->
                        ${solutionDetails.formulasUsed ? `
                            <div class="mb-6">
                                <span class="block text-xs font-bold uppercase tracking-wide text-[var(--text-secondary)] mb-2">Formulas used</span>
                                <div class="prose-content text-[var(--text-primary)] text-sm">
                                    ${renderMarkdown(solutionDetails.formulasUsed)}
                                </div>
                            </div>
                        ` : ''}

                        <!-- Working -->
                        ${solutionDetails.working ? `
                            <div class="mb-6">
                                <span class="block text-xs font-bold uppercase tracking-wide text-[var(--text-secondary)] mb-2">Working</span>
                                <div class="prose-content text-[var(--text-primary)]">
                                    ${renderMarkdown(solutionDetails.working)}
                                </div>
                            </div>
                        ` : ''}

                        <!-- Alternative Working -->
                        ${solutionDetails.alternativeWorking && solutionDetails.alternativeWorking.length > 0 ? 
                            solutionDetails.alternativeWorking.map((alt, idx) => `
                                <div class="mt-8 pt-6 border-t border-[var(--border-hairline)]">
                                    <span class="block text-xs font-bold uppercase tracking-wide text-[var(--text-secondary)] mb-2">Alternative working</span>
                                    <div class="prose-content text-[var(--text-primary)]">
                                        ${renderMarkdown(alt)}
                                    </div>
                                </div>
                            `).join('')
                        : ''}

                    </div>
                ` : ''}
            </div>
        `;
    }

    html += `</div>`;
    return html;
}

// 4. Main Render Loop
function render() {
    const app = document.getElementById('app');

    // Error State
    if (state.payloadError) {
        app.innerHTML = `
            <div class="flex flex-col items-center justify-center w-full h-full text-[var(--text-secondary)] gap-4">
                <i data-lucide="file-warning" class="w-12 h-12"></i>
                <span class="font-bold tracking-widest uppercase">Papers Payload Missing</span>
            </div>
        `;
        lucide.createIcons();
        return;
    }

    // Waiting for load
    if (!state.payloadLoaded) {
        // Keeps the loader visible
        return;
    }

    // Structure
    // Desktop: Nav Rail | Paper Column
    // Mobile: Paper Column (Nav is Drawer)
    
    app.innerHTML = `
        <!-- DESKTOP NAV RAIL -->
        <nav class="hidden lg:block w-64 shrink-0 h-full border-r border-[var(--border-hairline)] bg-[var(--bg-frame)]">
           ${renderNavContent()}
        </nav>

        <!-- PAPER COLUMN -->
        <main class="flex-1 h-full overflow-y-auto bg-[var(--bg-paper)] relative scroll-smooth">
            ${renderPaperContent()}
        </main>

        <!-- MOBILE DRAWER OVERLAY -->
        ${state.isMobileDrawerOpen ? `
            <div class="fixed inset-0 z-50 lg:hidden flex">
                <!-- Scrim -->
                <div class="absolute inset-0 bg-black/20 backdrop-blur-sm" onclick="toggleDrawer(false)"></div>
                
                <!-- Drawer -->
                <div class="relative w-4/5 max-w-xs h-full bg-[var(--bg-frame)] shadow-2xl flex flex-col animate-in slide-in-from-left duration-200">
                    <div class="p-4 border-b border-[var(--border-hairline)] flex items-center justify-between">
                        <span class="font-bold text-[var(--text-primary)]">Jump to question</span>
                        <button onclick="toggleDrawer(false)" class="p-2 -mr-2 text-[var(--text-secondary)]">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <div class="flex-1 overflow-y-auto p-0">
                         ${renderNavContent()}
                    </div>
                </div>
            </div>
        ` : ''}
    `;

    // Post-render effects
    lucide.createIcons();
    
    // KaTeX Auto-render
    // Note: We render entire body or main. Main is safer.
    renderMathInElement(document.body, {
        delimiters: [
            {left: '$$', right: '$$', display: true},
            {left: '$', right: '$', display: false}
        ],
        throwOnError: false
    });
}

/**
 * INIT
 */
loadPayload();

</script>
</body>
</html>
