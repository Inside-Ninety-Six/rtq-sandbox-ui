<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"ABC","indexWithinVariant":"230","totalWithinVariant":"320","hueFamily":"blue","intensityMode":"tinted_neutrals","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-09T21:07:32.212Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;ABC&quot;,&quot;indexWithinVariant&quot;:&quot;230&quot;,&quot;totalWithinVariant&quot;:&quot;320&quot;,&quot;hueFamily&quot;:&quot;blue&quot;,&quot;intensityMode&quot;:&quot;tinted_neutrals&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-09T21:07:32.212Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>
    
    <!-- External Libraries (No SRI/Integrity per Stage 6.0.7b) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <style>
        /* 
         * STAGE 6 - COLORLAB CONFIGURATION 
         * Mode: ColorLab B (Blue) + ColorLab C (Tinted Neutrals)
         * Light Mode Only. OKLCH values.
         */
        :root {
            /* HUE: Blue (~260) */
            --hue: 260;

            /* CORE SURFACES (Tinted Neutrals Mode) 
             * C in [0.015 .. 0.035]
             */
            --color-page-bg: oklch(0.97 0.02 var(--hue));
            --color-frame-bg: oklch(0.95 0.025 var(--hue));
            --color-paper-surface: oklch(0.99 0.015 var(--hue));

            /* WASH SURFACES
             * Solution Details: C in [0.025 .. 0.045]
             */
            --color-solution-wash: oklch(0.96 0.03 var(--hue));
            
            /* TEXT (Near Neutral)
             * Primary C <= 0.010, Secondary C <= 0.012
             */
            --color-text-primary: oklch(0.25 0.01 var(--hue));
            --color-text-secondary: oklch(0.45 0.012 var(--hue));

            /* ACCENT (Restrained)
             * C in [0.10 .. 0.16]
             * Used for: Links, Focus, Disclosure, Nav Marker
             */
            --color-accent: oklch(0.60 0.14 var(--hue));

            /* BORDERS / DIVIDERS */
            --color-hairline: oklch(0.90 0.02 var(--hue));

            /* SPACING SYSTEM */
            --space-xs: 0.25rem;
            --space-sm: 0.5rem;
            --space-md: 1rem;
            --space-lg: 1.5rem;
            --space-xl: 2.5rem; /* Top-level question separation */
            
            /* TYPOGRAPHY */
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            --font-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
        }

        /* RESET & BASE */
        * { box-sizing: border-box; }
        body {
            margin: 0;
            padding: 0;
            font-family: var(--font-family);
            background-color: var(--color-page-bg);
            color: var(--color-text-primary);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }
        button { font-family: inherit; }

        /* LAYOUT SHELL */
        .viewport {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .top-controls {
            flex-shrink: 0;
            background-color: var(--color-frame-bg); /* Match shell alignment */
            padding: var(--space-md);
            border-bottom: 1px solid var(--color-hairline);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .document-frame-shell {
            flex: 1;
            display: flex;
            background-color: var(--color-frame-bg);
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        /* NAVIGATION RAIL (Desktop) */
        .nav-column {
            width: 240px;
            flex-shrink: 0;
            position: sticky;
            top: 73px; /* Approximate top control height */
            height: calc(100vh - 73px);
            overflow-y: auto;
            padding: var(--space-md) var(--space-md) var(--space-xl) var(--space-md);
            border-right: 1px solid var(--color-hairline);
            /* Hide scrollbars visually but keep functional */
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .nav-column::-webkit-scrollbar { display: none; }

        .nav-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        /* Flat list, no indentation */
        .nav-item {
            display: block;
            padding: 4px 8px;
            text-decoration: none;
            color: var(--color-text-secondary);
            font-size: 0.9rem;
            border-radius: 4px;
            cursor: pointer;
            text-align: left;
            border: none;
            background: none;
            width: 100%;
        }
        .nav-item:hover {
            color: var(--color-text-primary);
            background-color: rgba(0,0,0,0.03); /* Subtle hover */
        }
        .nav-item.active {
            font-weight: 700;
            color: var(--color-text-primary);
            /* Optional accent marker allowed by overrides */
            border-left: 3px solid var(--color-accent); 
            padding-left: 5px; /* Adjust for border */
        }
        /* Hierarchy via scale only */
        .nav-item[data-depth="1"] { font-size: 0.85rem; color: var(--color-text-secondary); }
        .nav-item[data-depth="2"] { font-size: 0.8rem; opacity: 0.9; }

        .nav-section-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--color-text-secondary);
            font-weight: 600;
            margin-top: var(--space-md);
            margin-bottom: var(--space-xs);
            padding-left: 8px;
            pointer-events: none;
        }

        /* PAPER CONTENT COLUMN */
        .paper-column {
            flex: 1;
            padding: var(--space-xl);
            background-color: var(--color-paper-surface);
            min-width: 0; /* Prevent flex blowout */
        }

        /* QUESTION NODE GRAMMAR */
        .question-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-xl);
        }

        .question-node {
            display: flex;
            flex-direction: column;
            scroll-margin-top: 100px;
        }

        .question-node.child-node {
            margin-top: var(--space-md);
            padding-left: var(--space-lg); /* Indentation for children */
        }

        .question-body {
            display: flex;
            gap: var(--space-sm);
            margin-bottom: var(--space-sm);
        }

        .question-identifier {
            font-weight: 600;
            min-width: 1.5rem;
            color: var(--color-text-secondary);
            flex-shrink: 0;
        }

        .question-prompt {
            color: var(--color-text-primary);
            font-size: 1.05rem;
        }

        /* SOLUTION BLOCK */
        .solution-block {
            margin-left: 2rem; /* Indent to align with text usually */
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }

        /* ANSWER */
        .answer-region {
            display: flex;
            gap: var(--space-sm);
            align-items: baseline;
            margin-top: var(--space-xs);
        }
        .answer-label {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--color-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }
        .answer-content {
            font-weight: 500;
        }

        /* SOLUTION DETAILS */
        .solution-details-control {
            appearance: none;
            background: none;
            border: none;
            padding: 0;
            font-size: 0.9rem;
            color: var(--color-accent);
            cursor: pointer;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-top: var(--space-xs);
            width: fit-content;
        }
        .solution-details-control:hover {
            text-decoration: underline;
        }
        .solution-details-control:focus-visible {
            outline: 2px solid var(--color-accent);
            outline-offset: 2px;
            border-radius: 2px;
        }

        .solution-details-wrapper {
            /* Transition for continuity */
            display: grid;
            grid-template-rows: 0fr;
            transition: grid-template-rows 0.2s ease-out;
        }
        .solution-details-wrapper.expanded {
            grid-template-rows: 1fr;
        }
        .solution-details-inner {
            overflow: hidden;
        }

        .solution-details-content {
            background-color: var(--color-solution-wash);
            padding: var(--space-md);
            margin-top: var(--space-xs);
            border-radius: 4px; /* Subtle local corner, no card feel */
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }

        /* INTERNAL SUBSECTIONS */
        .sd-subsection-label {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--color-text-secondary);
            margin-bottom: var(--space-xs);
            display: block;
        }

        .sd-keep-in-mind-body { font-size: 0.95rem; }
        .sd-keep-in-mind-body ul { margin: 0; padding-left: 1.2em; }
        
        .sd-working-body, .sd-alt-working-body {
            font-size: 1rem;
        }

        /* SEPARATORS */
        .hairline {
            height: 1px;
            background-color: var(--color-hairline);
            border: none;
            margin: var(--space-md) 0;
        }

        /* MOBILE DRAWER */
        .drawer-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.2);
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }
        .drawer-overlay.open { opacity: 1; pointer-events: auto; }
        
        .drawer-panel {
            position: fixed;
            top: 0; left: 0; bottom: 0;
            width: 80%;
            max-width: 300px;
            background: var(--color-frame-bg);
            transform: translateX(-100%);
            transition: transform 0.2s;
            z-index: 101;
            display: flex;
            flex-direction: column;
            padding: var(--space-md);
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
        }
        .drawer-overlay.open .drawer-panel { transform: translateX(0); }

        .drawer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-md);
            border-bottom: 1px solid var(--color-hairline);
            padding-bottom: var(--space-sm);
        }
        .drawer-title { font-weight: 700; color: var(--color-text-secondary); }
        .drawer-close {
            background: none; border: none; font-size: 1.5rem; line-height: 1;
            color: var(--color-text-secondary); cursor: pointer;
        }

        /* KATEX & MATH */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            padding: 0.5em 0;
            /* Underlay allowed for block math only */
            background-color: rgba(0,0,0,0.015); 
            border-radius: 4px;
        }
        .katex-display > .katex {
            white-space: normal; /* Allow wrap inside container if needed */
        }
        /* No scroll on main page */
        img, svg { max-width: 100%; height: auto; }
        
        /* TABLES in Markdown */
        table {
            border-collapse: collapse;
            width: 100%;
            font-size: 0.95rem;
            margin: var(--space-sm) 0;
        }
        th, td {
            border: 1px solid var(--color-hairline);
            padding: 6px 10px;
            text-align: left;
        }
        th { font-weight: 600; background-color: rgba(0,0,0,0.02); }

        /* UTILITIES */
        .hidden { display: none !important; }
        .mobile-only { display: none; }

        @media (max-width: 768px) {
            .nav-column { display: none; }
            .mobile-only { display: block; }
            .document-frame-shell { flex-direction: column; }
            .paper-column { padding: var(--space-md); }
            .question-node.child-node { padding-left: var(--space-md); }
            .solution-block { margin-left: 0.5rem; }
        }
    </style>
</head>
<body>

<div class="viewport">
    <div class="top-controls">
        <div style="display:flex; gap: 1rem; align-items: center;">
            <button class="mobile-only" id="btn-jump-to" aria-label="Jump to question">
                <svg width="20" height="20" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg" color="currentColor"><path d="M1.5 3C1.22386 3 1 3.22386 1 3.5C1 3.77614 1.22386 4 1.5 4H13.5C13.7761 4 14 3.77614 14 3.5C14 3.22386 13.7761 3 13.5 3H1.5ZM1 7.5C1 7.22386 1.22386 7 1.5 7H13.5C13.7761 7 14 7.22386 14 7.5C14 7.77614 13.7761 8 13.5 8H1.5C1.22386 8 1 7.77614 1 7.5ZM1 11.5C1 11.2239 1.22386 11 1.5 11H13.5C13.7761 11 14 11.2239 14 11.5C14 11.7761 13.7761 12 13.5 12H1.5C1.22386 12 1 11.7761 1 11.5Z" fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
            </button>
            <select id="paper-selector" aria-label="Select Paper" style="font-size: 0.9rem; padding: 4px 8px;">
                <option value="" disabled selected>Loading papers...</option>
            </select>
        </div>
        <div style="font-size: 0.8rem; font-weight: 600; color: var(--color-text-secondary);">RTQ Viewer v11.3</div>
    </div>

    <div class="document-frame-shell">
        <!-- Desktop Nav Rail -->
        <nav class="nav-column" aria-label="Paper navigation">
            <div id="nav-list-container" class="nav-list"></div>
        </nav>

        <!-- Paper Content -->
        <main class="paper-column" id="paper-content">
            <div style="text-align: center; color: var(--color-text-secondary); margin-top: 2rem;">
                Select a paper to begin.
            </div>
        </main>
    </div>
</div>

<!-- Mobile Drawer -->
<div class="drawer-overlay" id="mobile-drawer">
    <div class="drawer-panel">
        <div class="drawer-header">
            <span class="drawer-title">Jump to</span>
            <button class="drawer-close" id="btn-drawer-close">&times;</button>
        </div>
        <div class="nav-list" id="drawer-nav-list" style="overflow-y: auto;"></div>
    </div>
</div>

<script>
    // --- STAGE 0: CONSTANTS (Runtime Definitions) ---
    const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
    const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

    // --- State ---
    let payload = null;
    let currentPaperKey = null;

    // --- Markdown Renderer Configuration (Authoritative) ---
    const md = window.markdownit ? window.markdownit({
        html: true,     // Inline SVG/HTML passthrough
        linkify: true,
        breaks: false   // Critical: Prevents <br> in KaTeX
    }) : null;

    if (md) {
        md.inline.ruler.disable(['escape']); // Preserve TeX backslashes
    }

    // --- Elements ---
    const paperSelector = document.getElementById('paper-selector');
    const paperContent = document.getElementById('paper-content');
    const navListContainer = document.getElementById('nav-list-container');
    const drawerNavList = document.getElementById('drawer-nav-list');
    const mobileDrawer = document.getElementById('mobile-drawer');
    const btnJumpTo = document.getElementById('btn-jump-to');
    const btnDrawerClose = document.getElementById('btn-drawer-close');

    // --- Initialization ---
    async function init() {
        try {
            const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
            if (!response.ok) throw new Error("Payload not found");
            payload = await response.json();
            
            if (!payload.papers || payload.papers.length === 0) {
                throw new Error("No papers in payload");
            }
            
            populatePaperSelector();
            
            // Load first paper by default
            switchPaper(payload.papers[0].key);

        } catch (error) {
            console.error(error);
            renderError();
        }
    }

    function renderError() {
        paperContent.innerHTML = `<div style="padding: 2rem; text-align: center; font-weight: 700; color: #888;">PAPERS PAYLOAD MISSING</div>`;
        paperSelector.innerHTML = `<option>Error loading payload</option>`;
        paperSelector.disabled = true;
    }

    function populatePaperSelector() {
        paperSelector.innerHTML = '';
        payload.papers.forEach(paper => {
            const opt = document.createElement('option');
            opt.value = paper.key;
            opt.textContent = paper.label || paper.key;
            paperSelector.appendChild(opt);
        });
        paperSelector.addEventListener('change', (e) => switchPaper(e.target.value));
    }

    function switchPaper(key) {
        const paper = payload.papers.find(p => p.key === key);
        if (!paper) return;
        currentPaperKey = key;
        
        // Render Content
        paperContent.innerHTML = '';
        const isSectioned = paper.sections && paper.sections.length > 0;
        
        const questionListWrapper = document.createElement('div');
        questionListWrapper.className = 'question-list';

        // Flatten questions for nav generation while rendering
        const allQuestionsFlat = [];

        if (isSectioned) {
            paper.sections.forEach(section => {
                if (section.label && section.label.trim() !== "") {
                    // Render Section Header
                    const header = document.createElement('div');
                    header.style.cssText = "font-weight: 700; font-size: 1.2rem; margin-top: 1rem; margin-bottom: 0.5rem; color: var(--color-text-primary); border-bottom: 1px solid var(--color-hairline); padding-bottom: 0.25rem;";
                    header.textContent = `Section ${section.label}`;
                    questionListWrapper.appendChild(header);
                }
                section.questions.forEach(q => {
                    questionListWrapper.appendChild(renderQuestionNode(q, 0, paper.defaults));
                    collectQuestionsForNav(q, allQuestionsFlat, section.label);
                });
            });
        } else {
            paper.questions.forEach(q => {
                questionListWrapper.appendChild(renderQuestionNode(q, 0, paper.defaults));
                collectQuestionsForNav(q, allQuestionsFlat, null);
            });
        }

        paperContent.appendChild(questionListWrapper);
        
        // Render Navigation
        renderNavigation(allQuestionsFlat, isSectioned);
        
        // Apply KaTeX
        renderMathInElement(paperContent, {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false}
            ],
            throwOnError: false
        });

        // Scroll to top
        window.scrollTo(0, 0);
    }

    // --- Rendering Logic ---

    function collectQuestionsForNav(node, list, sectionLabel) {
        list.push({ id: node.id, depth: 0, section: sectionLabel, elementId: `q-${node.id}` }); // Simplified depth tracking for nav
        if (node.children) {
            node.children.forEach(child => collectNavRecursive(child, list, sectionLabel, 1));
        }
    }

    function collectNavRecursive(node, list, sectionLabel, depth) {
        list.push({ id: node.id, depth: depth, section: sectionLabel, elementId: `q-${node.id}` });
        if (node.children) {
            node.children.forEach(child => collectNavRecursive(child, list, sectionLabel, depth + 1));
        }
    }

    function renderQuestionNode(node, depth, defaults) {
        const wrapper = document.createElement('div');
        wrapper.className = `question-node ${depth > 0 ? 'child-node' : ''}`;
        wrapper.id = `q-${node.id}`;

        // Question Body
        const qBody = document.createElement('div');
        qBody.className = 'question-body';
        
        const qId = document.createElement('div');
        qId.className = 'question-identifier';
        qId.textContent = node.id;
        
        const qPrompt = document.createElement('div');
        qPrompt.className = 'question-prompt';
        qPrompt.innerHTML = md ? md.render(node.question || '') : (node.question || '');

        qBody.append(qId, qPrompt);
        wrapper.appendChild(qBody);

        // Solution Block
        if (node.solutionBlock) {
            const block = document.createElement('div');
            block.className = 'solution-block';

            // Answer
            if (node.solutionBlock.answer) {
                const ansRegion = document.createElement('div');
                ansRegion.className = 'answer-region';
                const ansLabel = document.createElement('div');
                ansLabel.className = 'answer-label';
                ansLabel.textContent = 'Answer';
                const ansContent = document.createElement('div');
                ansContent.className = 'answer-content';
                ansContent.innerHTML = md ? md.renderInline(node.solutionBlock.answer) : node.solutionBlock.answer;
                
                ansRegion.append(ansLabel, ansContent);
                block.appendChild(ansRegion);
            }

            // Solution Details
            const sd = node.solutionBlock.solutionDetails;
            if (sd) {
                // Determine default expanded state
                const defaultExpanded = (defaults && defaults.expandedAll === false) ? false : true;

                // Control
                const toggleBtn = document.createElement('button');
                toggleBtn.className = 'solution-details-control';
                toggleBtn.setAttribute('aria-expanded', defaultExpanded);
                
                const updateToggleText = (isExpanded) => {
                    toggleBtn.innerHTML = `${isExpanded ? 'Hide' : 'Show'} working 
                    <svg width="12" height="12" viewBox="0 0 15 15" fill="none" style="transform: ${isExpanded ? 'rotate(180deg)' : 'rotate(0deg)'}; transition: transform 0.2s;"><path d="M3.13523 6.15803C3.3241 5.95657 3.64052 5.94637 3.84197 6.13523L7.5 9.56464L11.158 6.13523C11.3595 5.94637 11.6759 5.95657 11.8648 6.15803C12.0536 6.35949 12.0434 6.67591 11.842 6.86477L7.84197 10.6148C7.64964 10.7951 7.35036 10.7951 7.15803 10.6148L3.15803 6.86477C2.95657 6.67591 2.94637 6.35949 3.13523 6.15803Z" fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"></path></svg>`;
                };
                updateToggleText(defaultExpanded);

                // Wrapper for height transition
                const sdWrapper = document.createElement('div');
                sdWrapper.className = `solution-details-wrapper ${defaultExpanded ? 'expanded' : ''}`;
                
                const sdInner = document.createElement('div');
                sdInner.className = 'solution-details-inner';
                
                const sdContent = document.createElement('div');
                sdContent.className = 'solution-details-content';

                // Keep in mind
                if (sd.keepInMind) {
                    const kimDiv = document.createElement('div');
                    const label = document.createElement('span');
                    label.className = 'sd-subsection-label';
                    label.textContent = 'Keep in mind';
                    const body = document.createElement('div');
                    body.className = 'sd-keep-in-mind-body';
                    body.innerHTML = md ? md.render(sd.keepInMind) : sd.keepInMind;
                    kimDiv.append(label, body);
                    sdContent.appendChild(kimDiv);
                    sdContent.appendChild(createHairline());
                }

                // Formulas used
                if (sd.formulasUsed) {
                    const formDiv = document.createElement('div');
                    const label = document.createElement('span');
                    label.className = 'sd-subsection-label';
                    label.textContent = 'Formulas used';
                    const body = document.createElement('div');
                    body.innerHTML = md ? md.render(sd.formulasUsed) : sd.formulasUsed;
                    formDiv.append(label, body);
                    sdContent.appendChild(formDiv);
                    sdContent.appendChild(createHairline());
                }

                // Working (Primary)
                if (sd.working) {
                    const workDiv = document.createElement('div');
                    const label = document.createElement('span');
                    label.className = 'sd-subsection-label';
                    label.textContent = 'Working';
                    const body = document.createElement('div');
                    body.className = 'sd-working-body';
                    body.innerHTML = md ? md.render(sd.working) : sd.working;
                    workDiv.append(label, body);
                    sdContent.appendChild(workDiv);
                }

                // Alternative Working
                if (sd.alternativeWorking && Array.isArray(sd.alternativeWorking)) {
                    sd.alternativeWorking.forEach(alt => {
                        sdContent.appendChild(createHairline());
                        const altDiv = document.createElement('div');
                        const label = document.createElement('span');
                        label.className = 'sd-subsection-label';
                        label.textContent = 'Alternative working';
                        const body = document.createElement('div');
                        body.className = 'sd-alt-working-body';
                        body.innerHTML = md ? md.render(alt) : alt;
                        altDiv.append(label, body);
                        sdContent.appendChild(altDiv);
                    });
                }

                sdInner.appendChild(sdContent);
                sdWrapper.appendChild(sdInner);

                toggleBtn.onclick = () => {
                    const isExpanded = sdWrapper.classList.toggle('expanded');
                    toggleBtn.setAttribute('aria-expanded', isExpanded);
                    updateToggleText(isExpanded);
                };

                block.appendChild(toggleBtn);
                block.appendChild(sdWrapper);
            }
            
            wrapper.appendChild(block);
        }

        // Recursion
        if (node.children) {
            node.children.forEach(child => {
                wrapper.appendChild(renderQuestionNode(child, depth + 1, defaults));
            });
        }

        return wrapper;
    }

    function createHairline() {
        const hr = document.createElement('hr');
        hr.className = 'hairline';
        return hr;
    }

    function renderNavigation(flatQuestions, isSectioned) {
        const createNavHTML = (isDrawer) => {
            let html = '';
            let lastSection = null;
            
            flatQuestions.forEach(item => {
                // Section Headers
                if (isSectioned && item.section && item.section !== lastSection) {
                    html += `<div class="nav-section-label">${item.section}</div>`;
                    lastSection = item.section;
                }
                
                // Nav Item
                html += `<button class="nav-item" data-id="${item.id}" data-target="${item.elementId}" data-depth="${item.depth}">
                    ${item.id}
                </button>`;
            });
            return html;
        };

        navListContainer.innerHTML = createNavHTML(false);
        drawerNavList.innerHTML = createNavHTML(true);

        const attachListeners = (container) => {
            const buttons = container.querySelectorAll('.nav-item');
            buttons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const targetId = btn.getAttribute('data-target');
                    const el = document.getElementById(targetId);
                    if (el) {
                        el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        // Update active state
                        document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
                        // Mark active in both lists matching data-id
                        const id = btn.getAttribute('data-id');
                        document.querySelectorAll(`.nav-item[data-id="${id}"]`).forEach(b => b.classList.add('active'));
                        // Close drawer if open
                        closeDrawer();
                    }
                });
            });
        };

        attachListeners(navListContainer);
        attachListeners(drawerNavList);
        
        // Scroll spy logic could go here, but simple click-active is baseline sufficient.
    }

    // --- Mobile Drawer ---
    function openDrawer() {
        mobileDrawer.classList.add('open');
        document.body.style.overflow = 'hidden'; // Prevent body scroll
    }
    function closeDrawer() {
        mobileDrawer.classList.remove('open');
        document.body.style.overflow = '';
    }

    btnJumpTo.addEventListener('click', openDrawer);
    btnDrawerClose.addEventListener('click', closeDrawer);
    mobileDrawer.addEventListener('click', (e) => {
        if (e.target === mobileDrawer) closeDrawer();
    });

    // Run
    init();

</script>
</body>
</html>
