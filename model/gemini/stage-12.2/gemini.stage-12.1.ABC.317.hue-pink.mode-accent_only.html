<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"ABC","indexWithinVariant":"317","totalWithinVariant":"320","hueFamily":"pink","intensityMode":"accent_only","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-10T01:15:43.195Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;ABC&quot;,&quot;indexWithinVariant&quot;:&quot;317&quot;,&quot;totalWithinVariant&quot;:&quot;320&quot;,&quot;hueFamily&quot;:&quot;pink&quot;,&quot;intensityMode&quot;:&quot;accent_only&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-10T01:15:43.195Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>

    <!-- Tailwind CSS (via CDN for prototyping) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- KaTeX CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <!-- Markdown-it -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <!-- KaTeX JS & Auto-render -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <style>
        /* 
         * COLORLAB CONFIGURATION:
         * Family: PINK (Hue approx 350)
         * Intensity Mode: ACCENT_ONLY
         * 
         * Constraints:
         * - Surfaces C <= 0.015
         * - Body Text C <= 0.010
         * - Accent C [0.08 .. 0.14]
         */
        :root {
            /* HUE: 350 (Pink) */
            
            /* Surfaces - Extremely neutral per accent_only rules */
            --color-bg-page: oklch(0.99 0.005 350);
            --color-bg-frame: oklch(0.99 0.005 350);
            --color-bg-paper: oklch(1.0 0 0); /* Pure white or effectively neutral */
            --color-bg-wash: oklch(0.98 0.008 350); /* Very subtle wash for expanded solutions */
            
            /* Typography - Near neutral */
            --color-text-primary: oklch(0.20 0.01 350);
            --color-text-secondary: oklch(0.45 0.01 350);
            
            /* Accent - Restrained pink */
            --color-accent: oklch(0.60 0.14 350); /* Within 0.08-0.14 range */
            
            /* Borders */
            --color-border-hairline: oklch(0.92 0.01 350);

            /* Focus Ring */
            --color-focus: var(--color-accent);
        }

        body {
            background-color: var(--color-bg-page);
            color: var(--color-text-primary);
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Focus States */
        *:focus-visible {
            outline: 2px solid var(--color-focus);
            outline-offset: 2px;
        }

        /* Typography Utilities */
        .text-primary { color: var(--color-text-primary); }
        .text-secondary { color: var(--color-text-secondary); }
        .text-accent { color: var(--color-accent); }
        .bg-wash { background-color: var(--color-bg-wash); }
        
        .border-hairline { border-color: var(--color-border-hairline); }

        /* KaTeX Containment Invariant */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 4px; /* Space for scrollbar */
        }
        
        /* Hide scrollbars in nav but allow scroll */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Layout Utilities */
        .layout-shell {
            max-width: 1280px;
            margin: 0 auto;
            background-color: var(--color-bg-frame);
            min-height: 100vh;
        }

        /* Table Resets for Markdown */
        table {
            border-collapse: collapse;
            width: 100%;
            font-size: 0.95em;
            margin-bottom: 1em;
        }
        th, td {
            border: 1px solid var(--color-border-hairline);
            padding: 0.5rem;
            text-align: left;
            vertical-align: top;
        }
        th {
            font-weight: 600;
        }

        /* Disclosure Control */
        .disclosure-control {
            cursor: pointer;
            user-select: none;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            color: var(--color-accent);
            font-weight: 500;
            font-size: 0.9375rem; /* 15px */
            background: none;
            border: none;
            padding: 0;
            margin: 0;
        }
        .disclosure-control:hover {
            text-decoration: underline;
        }
        
        /* Utility */
        .hidden-content {
            display: none;
        }
        
        /* Mobile Drawer Transitions */
        .drawer-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.2);
            z-index: 40;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }
        .drawer-backdrop.open {
            opacity: 1;
            pointer-events: auto;
        }
        .drawer-panel {
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            width: 80%; /* max width */
            max-width: 300px;
            background: var(--color-bg-page);
            z-index: 50;
            transform: translateX(-100%);
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            border-right: 1px solid var(--color-border-hairline);
            display: flex;
            flex-direction: column;
        }
        .drawer-panel.open {
            transform: translateX(0);
        }
        
        /* Spacing Hierarchy */
        .space-y-question { row-gap: 3.5rem; } /* Top level */
        .space-y-sub { row-gap: 1.5rem; } /* Parent to child */
        .space-y-internal { row-gap: 1rem; } /* Question to solution block */
        .space-y-solution { row-gap: 1.25rem; } /* Inside solution details */

        /* Responsive indents */
        .pl-responsive { padding-left: 0.5rem; }
        @media (min-width: 640px) { .pl-responsive { padding-left: 1.5rem; } }

        /* Icon rotation */
        .chevron { transition: transform 0.2s ease; }
        .disclosure-control[aria-expanded="true"] .chevron { transform: rotate(180deg); }

    </style>
</head>
<body>

    <!-- App Root -->
    <div id="app" class="layout-shell flex flex-col md:flex-row relative">
        <!-- Content injected by JS -->
    </div>

    <!-- Scripts -->
    <script>
        // --- STAGE 0: CONSTANTS ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";

        // --- State ---
        let state = {
            papers: [],
            currentPaperId: null,
            payloadLoaded: false,
            error: null,
            mobileNavOpen: false
        };

        // --- Markdown Renderer Setup ---
        // Config: html: true, linkify: true, breaks: false (CRITICAL)
        const md = window.markdownit ? window.markdownit({
            html: true,
            linkify: true,
            breaks: false
        }) : null;

        if (md) {
            // Disable escape rule to preserve TeX backslashes
            md.inline.ruler.disable(['escape']);
        }

        // --- Icons ---
        const Icons = {
            menu: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" x2="20" y1="12"/><line x1="4" x2="20" y1="6"/><line x1="4" x2="20" y1="18"/></svg>`,
            close: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>`,
            chevron: `<svg class="chevron" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>`,
            info: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>`
        };

        // --- Main Initialization ---
        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error('Failed to load payload');
                const data = await response.json();
                
                state.papers = data.papers || [];
                if (state.papers.length > 0) {
                    state.currentPaperId = state.papers[0].key;
                }
                state.payloadLoaded = true;
                renderApp();
            } catch (err) {
                console.error(err);
                state.error = "PAPERS PAYLOAD MISSING";
                renderApp();
            }
        }

        // --- Render Functions ---

        function renderApp() {
            const app = document.getElementById('app');
            
            if (state.error) {
                app.innerHTML = `
                    <div class="flex items-center justify-center min-h-screen w-full text-secondary font-medium">
                        ${state.error}
                    </div>
                `;
                return;
            }

            if (!state.payloadLoaded) {
                app.innerHTML = `<div class="p-8">Loading...</div>`;
                return;
            }

            const currentPaper = state.papers.find(p => p.key === state.currentPaperId);
            
            // Generate Desktop Structure: Nav (Left) + Paper (Right)
            // Generate Mobile Structure: Top Bar + Paper + Drawer
            
            // We use a shared shell. 
            // Desktop: Grid/Flex row. 
            // Mobile: Col.

            app.innerHTML = `
                <!-- Mobile Header -->
                <div class="md:hidden sticky top-0 z-30 bg-page border-b border-hairline px-4 h-14 flex items-center justify-between" style="background-color: var(--color-bg-page);">
                    <div class="font-medium text-primary truncate mr-4">${currentPaper ? currentPaper.label : 'Paper'}</div>
                    <div class="flex items-center gap-4">
                        ${renderPaperSelector(true)}
                        <button class="flex items-center gap-2 text-accent text-sm font-medium focus:outline-none" onclick="toggleMobileNav(true)">
                            <span class="sr-only">Open navigation</span>
                            Jump to ${Icons.menu}
                        </button>
                    </div>
                </div>

                <!-- Desktop Navigation Rail (Sticky) -->
                <aside class="hidden md:block w-64 flex-shrink-0 border-r border-hairline sticky top-0 h-screen overflow-hidden flex flex-col" style="height: 100vh;">
                    <div class="p-6 pb-2">
                        ${renderPaperSelector(false)}
                    </div>
                    <nav class="flex-1 overflow-y-auto no-scrollbar px-6 py-4 pb-12" tabindex="-1">
                         ${renderNavList(currentPaper)}
                    </nav>
                </aside>

                <!-- Mobile Navigation Drawer -->
                <div class="md:hidden drawer-backdrop ${state.mobileNavOpen ? 'open' : ''}" onclick="toggleMobileNav(false)"></div>
                <div class="md:hidden drawer-panel ${state.mobileNavOpen ? 'open' : ''}">
                    <div class="h-14 border-b border-hairline flex items-center justify-between px-4 flex-shrink-0">
                        <span class="font-medium text-primary">Jump to</span>
                        <button class="text-secondary p-1" onclick="toggleMobileNav(false)">${Icons.close}</button>
                    </div>
                    <nav class="flex-1 overflow-y-auto px-4 py-4 pb-8">
                        ${renderNavList(currentPaper, true)}
                    </nav>
                </div>

                <!-- Main Paper Content -->
                <main class="flex-1 min-w-0" style="background-color: var(--color-bg-paper);">
                    <div class="max-w-3xl mx-auto px-4 sm:px-8 py-8 md:py-12">
                        ${renderPaperContent(currentPaper)}
                    </div>
                </main>
            `;

            // Post-render actions
            applyMathRendering(app);
            setupInteractions(app);
        }

        function renderPaperSelector(isMobile) {
            // Simple select dropdown
            return `
                <div class="relative">
                    <label for="paper-select-${isMobile ? 'm' : 'd'}" class="sr-only">Select Paper</label>
                    <select id="paper-select-${isMobile ? 'm' : 'd'}" 
                        class="bg-transparent text-sm font-medium text-primary border-none focus:ring-0 cursor-pointer pr-8 py-1 truncate max-w-[140px] md:max-w-full"
                        onchange="switchPaper(this.value)"
                    >
                        ${state.papers.map(p => `
                            <option value="${p.key}" ${p.key === state.currentPaperId ? 'selected' : ''}>${p.label}</option>
                        `).join('')}
                    </select>
                </div>
            `;
        }

        function renderNavList(paper, isMobile = false) {
            if (!paper) return '';
            
            // Flatten logic handled during render loop
            // Structure: 
            // Flat list of identifiers.
            // Section Headers (A, B) as separators.
            
            let html = `<ul class="space-y-1">`;
            
            // Helper to render nav item
            const renderItem = (q) => `
                <li>
                    <a href="#q-${q.id}" 
                       class="block py-1 text-sm text-secondary hover:text-primary transition-colors duration-150 truncate rounded-sm"
                       onclick="${isMobile ? 'toggleMobileNav(false)' : ''}"
                    >
                        ${q.id}
                    </a>
                </li>
            `;

            const processNodes = (nodes) => {
                let items = '';
                nodes.forEach(node => {
                    items += renderItem(node);
                    if (node.children && node.children.length > 0) {
                        items += processNodes(node.children);
                    }
                });
                return items;
            };

            if (paper.sections) {
                paper.sections.forEach((section, idx) => {
                    const hasLabel = section.label && section.label.trim().length > 0;
                    if (idx > 0) {
                        html += `<li class="h-4" aria-hidden="true"></li>`; // Spacing between sections
                    }
                    if (hasLabel) {
                        html += `
                            <li class="pt-2 pb-1 text-xs font-bold text-secondary uppercase tracking-wider select-none border-b border-hairline mb-2">
                                ${section.label}
                            </li>
                        `;
                    }
                    html += processNodes(section.questions);
                });
            } else if (paper.questions) {
                html += processNodes(paper.questions);
            }

            html += `</ul>`;
            return html;
        }

        function renderPaperContent(paper) {
            if (!paper) return '';

            // Handle Sectioned vs Flat
            let content = '';

            if (paper.sections) {
                paper.sections.forEach((section, index) => {
                    const hasLabel = section.label && section.label.trim().length > 0;
                    content += `<section class="mb-16">`;
                    if (hasLabel) {
                        content += `
                            <div class="mb-8 border-b border-hairline pb-2">
                                <h2 class="text-xl font-semibold text-primary">${section.label}</h2>
                            </div>
                        `;
                    }
                    content += `<div class="flex flex-col space-y-question">`;
                    section.questions.forEach(q => {
                        content += renderQuestionNode(q, paper.defaults, 0);
                    });
                    content += `</div>`;
                    content += `</section>`;
                });
            } else if (paper.questions) {
                content += `<div class="flex flex-col space-y-question">`;
                paper.questions.forEach(q => {
                    content += renderQuestionNode(q, paper.defaults, 0);
                });
                content += `</div>`;
            }

            return content;
        }

        function renderQuestionNode(node, defaults, depth) {
            const hasChildren = node.children && node.children.length > 0;
            const sb = node.solutionBlock;
            const hasAnswer = sb && sb.answer;
            const hasDetails = sb && sb.solutionDetails;
            
            // Defaults
            const expandedAll = defaults ? defaults.expandedAll : true;
            const isExpanded = expandedAll; // Default state on load

            // Render Markdown content
            const questionHtml = md ? md.render(node.question || '') : (node.question || '');
            
            let html = `
                <div id="q-${node.id}" class="question-node scroll-mt-24 w-full">
                    <!-- Question Body -->
                    <div class="mb-4">
                        <div class="flex items-baseline gap-3">
                            <span class="flex-shrink-0 font-bold text-secondary text-sm select-none pt-0.5 w-8 md:w-10 text-right -ml-8 md:-ml-10 pr-2 md:pr-0 inline-block md:inline">${node.id}</span>
                            <div class="text-primary text-lg leading-relaxed md:leading-relaxed flex-1">
                                ${questionHtml}
                            </div>
                        </div>
                    </div>
            `;

            // Solution Block
            if (sb) {
                html += `<div class="ml-0 md:ml-3 pl-3 md:pl-4 border-l border-transparent md:border-hairline/50 space-y-internal">`;
                
                // Answer
                if (hasAnswer) {
                    const answerHtml = md ? md.render(sb.answer) : sb.answer;
                    html += `
                        <div class="text-base">
                            <span class="text-xs font-bold text-secondary uppercase tracking-wide block mb-1">Answer</span>
                            <div class="text-primary font-medium">${answerHtml}</div>
                        </div>
                    `;
                }

                // Solution Details
                if (hasDetails) {
                    html += `
                        <div class="solution-details-wrapper group">
                            <!-- Toggle Control -->
                            <button class="disclosure-control js-toggle-working" aria-expanded="${isExpanded}" aria-controls="sd-${node.id}">
                                <span class="js-toggle-text">${isExpanded ? 'Hide working' : 'Show working'}</span>
                                ${Icons.chevron}
                            </button>

                            <!-- Expandable Region -->
                            <div id="sd-${node.id}" class="mt-3 ${isExpanded ? '' : 'hidden-content'}">
                                <div class="bg-wash rounded-sm p-4 md:p-6 text-base space-y-solution">
                                    ${renderSolutionDetails(sb.solutionDetails)}
                                </div>
                            </div>
                        </div>
                    `;
                }
                html += `</div>`; // End Solution Block Wrapper
            }

            // Children
            if (hasChildren) {
                html += `
                    <div class="mt-6 flex flex-col space-y-sub pl-responsive">
                        ${node.children.map(child => renderQuestionNode(child, defaults, depth + 1)).join('')}
                    </div>
                `;
            }

            html += `</div>`; // End Question Node
            return html;
        }

        function renderSolutionDetails(sd) {
            let html = '';

            // 1. Keep in mind
            if (sd.keepInMind) {
                const kimHtml = md ? md.render(sd.keepInMind) : sd.keepInMind;
                html += `
                    <div class="mb-4">
                        <div class="flex items-center gap-2 text-secondary mb-1">
                            ${Icons.info}
                            <span class="text-xs font-bold uppercase tracking-wide">Keep in mind</span>
                        </div>
                        <div class="text-secondary text-sm leading-relaxed">${kimHtml}</div>
                    </div>
                `;
            }

            // 2. Formulas used
            if (sd.formulasUsed) {
                const formHtml = md ? md.render(sd.formulasUsed) : sd.formulasUsed;
                html += `
                    <div class="mb-4">
                        <span class="text-xs font-bold text-secondary uppercase tracking-wide block mb-1">Formulas used</span>
                        <div class="text-secondary text-sm">${formHtml}</div>
                    </div>
                `;
            }

            // 3. Working
            if (sd.working) {
                const workHtml = md ? md.render(sd.working) : sd.working;
                html += `
                    <div>
                        <span class="text-xs font-bold text-secondary uppercase tracking-wide block mb-2">Working</span>
                        <div class="text-primary space-y-2 leading-relaxed">${workHtml}</div>
                    </div>
                `;
            }

            // 4. Alternative Working
            if (sd.alternativeWorking && Array.isArray(sd.alternativeWorking)) {
                sd.alternativeWorking.forEach((alt, idx) => {
                    const altHtml = md ? md.render(alt) : alt;
                    html += `
                        <div class="pt-4 mt-4 border-t border-hairline/50">
                            <span class="text-xs font-bold text-secondary uppercase tracking-wide block mb-2">Alternative working</span>
                            <div class="text-primary space-y-2 leading-relaxed">${altHtml}</div>
                        </div>
                    `;
                });
            }

            return html;
        }

        // --- Interaction Logic ---

        function switchPaper(paperId) {
            state.currentPaperId = paperId;
            state.mobileNavOpen = false;
            renderApp();
            // Scroll to top
            window.scrollTo(0, 0);
        }

        function toggleMobileNav(isOpen) {
            state.mobileNavOpen = isOpen;
            
            // Manually toggle classes to avoid full re-render on mobile nav
            const backdrop = document.querySelector('.drawer-backdrop');
            const panel = document.querySelector('.drawer-panel');
            
            if (backdrop && panel) {
                if (isOpen) {
                    backdrop.classList.add('open');
                    panel.classList.add('open');
                    document.body.style.overflow = 'hidden';
                } else {
                    backdrop.classList.remove('open');
                    panel.classList.remove('open');
                    document.body.style.overflow = '';
                }
            }
        }

        function setupInteractions(container) {
            // Delegation for Show/Hide working
            container.addEventListener('click', (e) => {
                const toggleBtn = e.target.closest('.js-toggle-working');
                if (toggleBtn) {
                    e.preventDefault();
                    const isExpanded = toggleBtn.getAttribute('aria-expanded') === 'true';
                    const targetId = toggleBtn.getAttribute('aria-controls');
                    const targetEl = document.getElementById(targetId);
                    const textSpan = toggleBtn.querySelector('.js-toggle-text');

                    if (targetEl) {
                        if (isExpanded) {
                            // Collapse
                            targetEl.classList.add('hidden-content');
                            toggleBtn.setAttribute('aria-expanded', 'false');
                            if (textSpan) textSpan.textContent = 'Show working';
                        } else {
                            // Expand
                            targetEl.classList.remove('hidden-content');
                            toggleBtn.setAttribute('aria-expanded', 'true');
                            if (textSpan) textSpan.textContent = 'Hide working';
                        }
                    }
                }
            });
        }

        function applyMathRendering(container) {
            if (window.renderMathInElement) {
                renderMathInElement(container, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false}
                    ],
                    throwOnError: false
                });
            }
        }

        // --- Init ---
        // Ensure DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }

    </script>
</body>
</html>
