<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"ABC","indexWithinVariant":"189","totalWithinVariant":"320","hueFamily":"pink","intensityMode":"accent_only","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-09T18:47:50.502Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;ABC&quot;,&quot;indexWithinVariant&quot;:&quot;189&quot;,&quot;totalWithinVariant&quot;:&quot;320&quot;,&quot;hueFamily&quot;:&quot;pink&quot;,&quot;intensityMode&quot;:&quot;accent_only&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-09T18:47:50.502Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- KaTeX CSS (No SRI per instructions) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <!-- Remix Icon -->
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

    <!-- Markdown-it -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@13.0.1/dist/markdown-it.min.js"></script>

    <!-- KaTeX JS (No SRI per instructions) -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Tailwind CSS (CDN for prototyping) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        // Tailwind Configuration with ColorLab Mode 1 (accent_only) + Hue Pink
        // Hue: 350 (Pink)
        // Mode: accent_only (Surfaces C <= 0.015, Text C <= 0.010, Accent C [0.08..0.14])
        tailwind.config = {
            darkMode: 'class', // Disabled (Light only enforcement)
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        // OKLCH Values
                        background: 'oklch(var(--background) / <alpha-value>)', 
                        frame: 'oklch(var(--frame) / <alpha-value>)',
                        paper: 'oklch(var(--paper) / <alpha-value>)',
                        foreground: 'oklch(var(--foreground) / <alpha-value>)',
                        muted: {
                            DEFAULT: 'oklch(var(--muted) / <alpha-value>)',
                            foreground: 'oklch(var(--muted-foreground) / <alpha-value>)',
                        },
                        border: 'oklch(var(--border) / <alpha-value>)',
                        primary: { // Accent
                            DEFAULT: 'oklch(var(--primary) / <alpha-value>)',
                            foreground: 'oklch(var(--primary-foreground) / <alpha-value>)',
                        },
                        details: { // Solution Details Wash
                            DEFAULT: 'oklch(var(--details-wash) / <alpha-value>)',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* 
           COLORLAB CONFIGURATION
           Hue Family: Pink (approx h=350)
           Intensity Mode: accent_only 
        */
        :root {
            /* 
               Surfaces (C <= 0.015) 
               - Page/Frame: Very subtle warm tint
               - Paper: White
            */
            --background: 0.98 0.005 350;     /* Page background */
            --frame: 0.98 0.005 350;          /* Frame base surface (same as page in this mode) */
            --paper: 1.0 0 0;                 /* Paper surface (Pure white) */
            
            /* 
               Text (C <= 0.010)
               - High legibility, near neutral
            */
            --foreground: 0.20 0.01 350;      /* Primary text */
            --muted-foreground: 0.45 0.01 350;/* Secondary text */
            
            /* 
               Borders / Hairlines 
            */
            --border: 0.92 0.005 350;         /* Quiet dividers */

            /* 
               Accent (C in [0.08 .. 0.14])
               - Used for Links, Focus, Toggles
            */
            --primary: 0.65 0.12 350;         /* Pink accent */
            --primary-foreground: 1.0 0 0;
            
            /* 
               Solution Details Wash (Optional/Subtle)
               - In accent_only mode, surfaces must be low chroma.
            */
            --details-wash: 0.99 0.002 350;   /* Very subtle wash */
            
            /* Focus Ring */
            --focus-ring: 0.65 0.12 350;
        }

        body {
            background-color: oklch(var(--background));
            color: oklch(var(--foreground));
            -webkit-font-smoothing: antialiased;
        }

        /* Scrollbar Hiding for Navigation */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Focus Styles */
        :focus-visible {
            outline: 2px solid oklch(var(--focus-ring));
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* KaTeX Containment Invariant */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding-bottom: 4px; /* Space for scrollbar */
            -webkit-overflow-scrolling: touch;
        }
        
        /* Markdown Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
            font-size: 0.95em;
        }
        th {
            font-weight: 500;
            text-align: left;
            border-bottom: 1px solid oklch(var(--border));
            padding: 0.5rem;
        }
        td {
            padding: 0.5rem;
            border-bottom: 1px solid oklch(var(--border));
        }
        tr:last-child td {
            border-bottom: none;
        }

        /* Typography spacing for Markdown content */
        .markdown-body p {
            margin-bottom: 0.75rem;
            line-height: 1.6;
        }
        .markdown-body p:last-child {
            margin-bottom: 0;
        }
        .markdown-body ul {
            list-style-type: disc;
            padding-left: 1.5rem;
            margin-bottom: 0.75rem;
        }
        .markdown-body ol {
            list-style-type: decimal;
            padding-left: 1.5rem;
            margin-bottom: 0.75rem;
        }

        /* Mobile Drawer Transitions */
        .drawer-enter {
            transform: translateX(-100%);
            transition: transform 0.3s ease-out;
        }
        .drawer-enter-active {
            transform: translateX(0);
        }
        .drawer-exit {
            transform: translateX(0);
            transition: transform 0.2s ease-in;
        }
        .drawer-exit-active {
            transform: translateX(-100%);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Application Root -->
    <div id="app" class="flex-1 flex flex-col max-w-7xl mx-auto w-full px-4 sm:px-6 lg:px-8">
        <!-- Content injected by JS -->
    </div>

    <!-- Scripts -->
    <script>
        // --- STAGE 0: CONSTANTS ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // --- MARKDOWN CONFIGURATION (STAGE 6) ---
        // html: true (SVG passthrough), linkify: true, breaks: false (critical for KaTeX)
        const md = window.markdownit ? window.markdownit({
            html: true,
            linkify: true,
            breaks: false, 
        }) : null;

        if (md) {
            // Disable escape rule to preserve TeX backslashes
            md.inline.ruler.disable(['escape']);
        }

        // --- STATE ---
        const state = {
            papers: [],
            currentPaperId: null,
            loading: true,
            error: null,
            expandedWorkings: {}, // Map questionId -> boolean
            drawerOpen: false,
            activeNavId: null
        };

        // --- DOM ELEMENTS & RENDERERS ---

        async function init() {
            try {
                // Determine Payload Load Strategy
                // Using RTQ_PAPERS_PAYLOAD_PATH per instructions
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Payload not found");
                
                const data = await response.json();
                state.papers = data.papers || [];
                
                // Set default paper
                if (state.papers.length > 0) {
                    selectPaper(state.papers[0].key);
                } else {
                    state.error = "No papers in payload";
                }
                state.loading = false;
            } catch (e) {
                console.error(e);
                state.error = "PAPERS PAYLOAD MISSING";
                state.loading = false;
            }
            renderApp();
        }

        function selectPaper(paperKey) {
            const paper = state.papers.find(p => p.key === paperKey);
            if (!paper) return;

            state.currentPaperId = paperKey;
            state.expandedWorkings = {};
            
            // Apply paper defaults
            // Assuming defaults object structure { expandedAll: boolean }
            const defaultExpanded = paper.defaults?.expandedAll !== false; // Default to true unless explicitly false

            // We need to traverse all questions to set initial state if necessary
            // Or just default to true in the render logic if key is missing.
            // Let's implement lazy initialization in toggle logic.
            
            renderApp();
            
            // Scroll to top
            window.scrollTo(0, 0);
        }

        function toggleWorking(questionId, forceState = null) {
            const paper = getCurrentPaper();
            const defaultExpanded = paper.defaults?.expandedAll !== false;
            
            const currentState = state.expandedWorkings[questionId] !== undefined 
                ? state.expandedWorkings[questionId] 
                : defaultExpanded;

            const newState = forceState !== null ? forceState : !currentState;
            state.expandedWorkings[questionId] = newState;
            
            renderPaperContent(); // Re-render paper content to reflect change
        }

        function setDrawerOpen(isOpen) {
            state.drawerOpen = isOpen;
            renderDrawer();
        }

        function getCurrentPaper() {
            return state.papers.find(p => p.key === state.currentPaperId);
        }

        // --- RENDERERS ---

        function renderApp() {
            const app = document.getElementById('app');
            if (!app) return;

            if (state.loading) {
                app.innerHTML = '<div class="p-8 text-muted-foreground">Loading payload...</div>';
                return;
            }

            if (state.error) {
                app.innerHTML = `
                    <div class="flex flex-col items-center justify-center min-h-[50vh] text-center">
                        <h1 class="text-xl font-semibold mb-2">Error</h1>
                        <p class="text-muted-foreground uppercase tracking-widest">${state.error}</p>
                    </div>
                `;
                return;
            }

            // Shell Structure: Top Controls + DocumentFrameShell
            app.innerHTML = `
                <!-- Top Controls Region -->
                <header class="py-4 flex items-center justify-between border-b border-border/50 bg-background sticky top-0 z-20">
                    <div class="flex items-center gap-4">
                        ${renderPaperSelector()}
                    </div>
                    
                    <!-- Mobile Jump To Trigger -->
                    <button class="md:hidden text-sm font-medium text-primary hover:text-primary/80 focus-visible:outline-none flex items-center gap-1"
                        onclick="setDrawerOpen(true)">
                        <span>Jump to</span>
                        <i class="ri-menu-line"></i>
                    </button>
                </header>

                <!-- DocumentFrameShell -->
                <div class="flex-1 grid grid-cols-1 md:grid-cols-[200px_1fr] lg:grid-cols-[240px_1fr] gap-8 py-8 relative">
                    
                    <!-- Desktop Nav Rail -->
                    <aside class="hidden md:block sticky top-24 h-[calc(100vh-8rem)] overflow-y-auto no-scrollbar pr-4 border-r border-border/40">
                        ${renderNavigationList(false)}
                    </aside>

                    <!-- Paper Content Column -->
                    <main class="min-w-0 pb-20">
                        <div id="paper-content">
                            <!-- Paper rendered here -->
                        </div>
                    </main>
                </div>

                <!-- Mobile Drawer Container -->
                <div id="drawer-container"></div>
            `;

            renderPaperContent();
            renderDrawer();
        }

        function renderPaperSelector() {
            if (state.papers.length <= 1) return '';
            
            const options = state.papers.map(p => 
                `<option value="${p.key}" ${p.key === state.currentPaperId ? 'selected' : ''}>${p.label}</option>`
            ).join('');

            return `
                <div class="relative">
                    <select onchange="selectPaper(this.value)" 
                        class="appearance-none bg-transparent font-medium text-foreground pr-8 py-1 focus:outline-none focus-visible:ring-2 focus-visible:ring-primary rounded cursor-pointer">
                        ${options}
                    </select>
                    <i class="ri-arrow-down-s-line absolute right-0 top-1/2 -translate-y-1/2 pointer-events-none text-muted-foreground"></i>
                </div>
            `;
        }

        function renderNavigationList(isDrawer) {
            const paper = getCurrentPaper();
            if (!paper) return '';

            let html = '<nav class="flex flex-col gap-1 text-sm" aria-label="Question navigation">';
            
            // Flatten logic for section handling
            const items = [];
            
            if (paper.sections) {
                paper.sections.forEach(section => {
                    if (section.label && section.label.trim() !== "") {
                        items.push({ type: 'section', label: section.label });
                    }
                    if (section.questions) {
                        section.questions.forEach(q => traverseQuestionsForNav(q, items));
                    }
                });
            } else if (paper.questions) {
                paper.questions.forEach(q => traverseQuestionsForNav(q, items));
            }

            items.forEach(item => {
                if (item.type === 'section') {
                    html += `
                        <div class="mt-4 mb-2 first:mt-0 text-xs font-semibold text-muted-foreground uppercase tracking-wider select-none">
                            ${item.label}
                        </div>
                    `;
                } else {
                    const isActive = state.activeNavId === item.id;
                    // Hierarchy via opacity/size, strictly flat alignment per specs
                    const isSub = item.depth > 0;
                    const styleClass = isSub ? 'text-muted-foreground font-normal' : 'text-foreground font-medium';
                    const activeClass = isActive ? 'text-primary font-bold' : '';
                    
                    html += `
                        <button 
                            onclick="scrollToQuestion('${item.id}'); ${isDrawer ? 'setDrawerOpen(false);' : ''}"
                            class="text-left py-1 px-0 hover:text-primary transition-colors ${styleClass} ${activeClass} focus-visible:outline-none focus-visible:text-primary">
                            ${item.id}
                        </button>
                    `;
                }
            });

            html += '</nav>';
            return html;
        }

        function traverseQuestionsForNav(node, list, depth = 0) {
            list.push({ type: 'item', id: node.id, depth });
            if (node.children && node.children.length > 0) {
                node.children.forEach(child => traverseQuestionsForNav(child, list, depth + 1));
            }
        }

        function renderDrawer() {
            const container = document.getElementById('drawer-container');
            if (!container) return;

            if (!state.drawerOpen) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = `
                <div class="fixed inset-0 z-50 flex justify-end" role="dialog" aria-modal="true">
                    <!-- Scrim -->
                    <div class="absolute inset-0 bg-black/20 backdrop-blur-sm" onclick="setDrawerOpen(false)"></div>
                    
                    <!-- Drawer Panel -->
                    <div class="relative w-64 bg-background h-full shadow-xl flex flex-col animate-[drawer-enter_0.3s_ease-out]">
                        <div class="p-4 border-b border-border flex items-center justify-between">
                            <span class="font-semibold">Jump to</span>
                            <button onclick="setDrawerOpen(false)" class="text-muted-foreground hover:text-foreground p-1">
                                <i class="ri-close-line text-xl"></i>
                            </button>
                        </div>
                        <div class="flex-1 overflow-y-auto p-4">
                            ${renderNavigationList(true)}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderPaperContent() {
            const container = document.getElementById('paper-content');
            if (!container) return;

            const paper = getCurrentPaper();
            if (!paper) {
                container.innerHTML = '';
                return;
            }

            let html = '<div class="flex flex-col gap-12">'; // Top level question gap

            if (paper.sections) {
                paper.sections.forEach((section, idx) => {
                    html += '<div class="flex flex-col gap-8">'; // Section wrapper
                    if (section.label && section.label.trim() !== "") {
                        html += `
                            <div class="border-b border-border pb-2 mb-4">
                                <span class="text-lg font-semibold text-foreground">${section.label}</span>
                            </div>
                        `;
                    }
                    html += `<div class="flex flex-col gap-12">`; // Question list in section
                    section.questions.forEach(q => {
                        html += renderQuestionNode(q, 0);
                    });
                    html += `</div></div>`;
                });
            } else if (paper.questions) {
                paper.questions.forEach(q => {
                    html += renderQuestionNode(q, 0);
                });
            }

            html += '</div>';
            container.innerHTML = html;
            
            // Post-render: Typeset Math
            if (window.renderMathInElement) {
                renderMathInElement(container, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false}
                    ],
                    throwOnError: false,
                    // Security note: We trust the payload per instructions
                });
            }
        }

        function renderQuestionNode(node, depth) {
            const isTopLevel = depth === 0;
            const indentClass = depth > 0 ? 'pl-4 sm:pl-6 border-l-2 border-transparent' : ''; // Adaptive indentation
            const spacingClass = depth > 0 ? 'mt-6' : ''; // Child spacing
            
            // Solution Block Logic
            const hasSolutionBlock = !!node.solutionBlock;
            const hasSolutionDetails = hasSolutionBlock && !!node.solutionBlock.solutionDetails;
            const hasAnswer = hasSolutionBlock && !!node.solutionBlock.answer;
            
            // Expand State
            const paper = getCurrentPaper();
            const defaultExpanded = paper.defaults?.expandedAll !== false;
            const isExpanded = state.expandedWorkings[node.id] !== undefined 
                ? state.expandedWorkings[node.id] 
                : defaultExpanded;

            // Render Parts
            const questionBody = renderMarkdown(node.question);
            
            let solutionBlockHtml = '';
            if (hasSolutionBlock) {
                let answerHtml = '';
                if (hasAnswer) {
                    answerHtml = `
                        <div class="mb-4 text-foreground/90">
                            <span class="text-sm font-bold text-muted-foreground mr-2 select-none">Answer</span>
                            <span class="font-medium">${renderMarkdownInline(node.solutionBlock.answer)}</span>
                        </div>
                    `;
                }

                let detailsHtml = '';
                if (hasSolutionDetails) {
                    const details = node.solutionBlock.solutionDetails;
                    
                    // Toggle
                    const toggleLabel = isExpanded ? "Hide working" : "Show working";
                    const toggleIcon = isExpanded ? "ri-arrow-up-s-line" : "ri-arrow-down-s-line";
                    
                    const toggleBtn = `
                        <button onclick="toggleWorking('${node.id}')" 
                            class="text-sm font-medium text-primary hover:text-primary/80 mb-2 flex items-center gap-1 focus-visible:outline-none focus-visible:underline decoration-primary decoration-2 underline-offset-4">
                            <span>${toggleLabel}</span>
                            <i class="${toggleIcon}"></i>
                        </button>
                    `;

                    let expandedContent = '';
                    if (isExpanded) {
                        // Order: Keep in mind -> Formulas -> Working -> Alt Working
                        // Apply Wash Surface for Expanded Region
                        
                        let sections = '';

                        // Keep in mind
                        if (details.keepInMind) {
                            sections += `
                                <div class="mb-6">
                                    <div class="flex items-center gap-2 mb-1 text-sm font-bold text-muted-foreground">
                                        <i class="ri-lightbulb-line"></i>
                                        <span>Keep in mind</span>
                                    </div>
                                    <div class="markdown-body text-sm text-foreground/90">
                                        ${renderMarkdown(details.keepInMind)}
                                    </div>
                                </div>
                            `;
                        }

                        // Formulas used
                        if (details.formulasUsed) {
                            sections += `
                                <div class="mb-6">
                                    <div class="mb-1 text-sm font-bold text-muted-foreground">Formulas used</div>
                                    <div class="markdown-body text-sm text-foreground/90">
                                        ${renderMarkdown(details.formulasUsed)}
                                    </div>
                                </div>
                            `;
                        }

                        // Working (Primary)
                        if (details.working) {
                            sections += `
                                <div class="mb-6 last:mb-0">
                                    <div class="mb-2 text-sm font-bold text-muted-foreground">Working</div>
                                    <div class="markdown-body text-base text-foreground/90">
                                        ${renderMarkdown(details.working)}
                                    </div>
                                </div>
                            `;
                        }

                        // Alternative working
                        if (details.alternativeWorking && Array.isArray(details.alternativeWorking)) {
                            details.alternativeWorking.forEach((alt, idx) => {
                                sections += `
                                    <div class="mt-8 pt-6 border-t border-border/50">
                                        <div class="mb-2 text-sm font-bold text-muted-foreground">Alternative working</div>
                                        <div class="markdown-body text-base text-foreground/90">
                                            ${renderMarkdown(alt)}
                                        </div>
                                    </div>
                                `;
                            });
                        }
                        
                        // We do NOT use heavy frames. Wash is subtle.
                        expandedContent = `
                            <div class="bg-details p-4 sm:p-5 rounded-sm mt-2 animate-in fade-in duration-200">
                                ${sections}
                            </div>
                        `;
                    }

                    detailsHtml = `
                        <div class="mt-2">
                            ${toggleBtn}
                            ${expandedContent}
                        </div>
                    `;
                }

                if (answerHtml || detailsHtml) {
                    solutionBlockHtml = `
                        <div class="mt-4 pt-1">
                            ${answerHtml}
                            ${detailsHtml}
                        </div>
                    `;
                }
            }

            // Children Recursive
            let childrenHtml = '';
            if (node.children && node.children.length > 0) {
                childrenHtml = `
                    <div class="flex flex-col">
                        ${node.children.map(child => renderQuestionNode(child, depth + 1)).join('')}
                    </div>
                `;
            }

            return `
                <div id="q-${node.id}" class="flex flex-col ${indentClass} ${spacingClass} scroll-mt-24 group">
                    <!-- Question Body -->
                    <div class="flex gap-3 items-baseline">
                        <span class="font-medium text-muted-foreground shrink-0 select-none text-lg leading-relaxed">${node.id}</span>
                        <div class="markdown-body text-lg leading-relaxed text-foreground flex-1 min-w-0">
                            ${questionBody}
                        </div>
                    </div>

                    <!-- Solution Block -->
                    <div class="pl-[2rem] sm:pl-[2.5rem]"> 
                        ${solutionBlockHtml}
                    </div>

                    <!-- Children -->
                    ${childrenHtml}
                </div>
            `;
        }

        // --- UTILS ---

        function renderMarkdown(text) {
            if (!text || !md) return text || '';
            return md.render(text);
        }

        function renderMarkdownInline(text) {
            if (!text || !md) return text || '';
            return md.renderInline(text);
        }

        function scrollToQuestion(id) {
            const el = document.getElementById(`q-${id}`);
            if (el) {
                // Smooth scroll
                el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                state.activeNavId = id;
                // Re-render nav to update active state (desktop mainly)
                const nav = document.querySelector('aside nav');
                if (nav) nav.parentElement.innerHTML = renderNavigationList(false);
            }
        }

        // --- INIT ---
        window.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
