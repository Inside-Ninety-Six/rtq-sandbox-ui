<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AB","indexWithinVariant":"26","totalWithinVariant":"200","hueFamily":"blue","intensityMode":"","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-08T14:35:52.251Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AB&quot;,&quot;indexWithinVariant&quot;:&quot;26&quot;,&quot;totalWithinVariant&quot;:&quot;200&quot;,&quot;hueFamily&quot;:&quot;blue&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-08T14:35:52.251Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>
    
    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    colors: {
                        // ColorLab B: Forced Hue Family = Blue
                        brand: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',  // Primary Accent
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                        }
                    }
                }
            }
        }
    </script>

    <!-- KaTeX CSS & JS (CDN - No Integrity/SRI) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Markdown-it (CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <!-- Lucide Icons (CDN) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Document & Scroll Behavior */
        html {
            scroll-behavior: smooth;
        }
        
        /* KaTeX Containment Invariant (Stage 3/6) */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 2px; /* Scrollbar breathing room */
        }
        
        /* Hide scrollbar for Nav but keep functionality */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Markdown Content Styling */
        .md-content p {
            margin-bottom: 0.75rem;
            line-height: 1.6;
        }
        .md-content p:last-child {
            margin-bottom: 0;
        }
        .md-content ul {
            list-style-type: disc;
            padding-left: 1.25rem;
            margin-bottom: 0.75rem;
        }
        .md-content ol {
            list-style-type: decimal;
            padding-left: 1.25rem;
            margin-bottom: 0.75rem;
        }
        /* Tables within Markdown */
        .md-content table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.95em;
        }
        .md-content th, .md-content td {
            border: 1px solid #e2e8f0; /* slate-200 */
            padding: 0.5rem;
            text-align: left;
        }
        .md-content th {
            font-weight: 600;
            background-color: #f8fafc; /* slate-50 */
        }
        
        /* Interactive States */
        button:focus-visible, a:focus-visible, summary:focus-visible, select:focus-visible {
            outline: 2px solid #60a5fa; /* blue-400 */
            outline-offset: 2px;
        }
    </style>
</head>
<body class="bg-white text-slate-900 antialiased min-h-screen flex flex-col">

    <!-- Top Controls Region -->
    <div id="top-controls" class="border-b border-slate-100 bg-white sticky top-0 z-20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-14 flex items-center justify-between">
            <!-- Paper Selector -->
            <div class="flex items-center gap-3">
                <span class="text-sm font-medium text-slate-500 hidden sm:inline">Paper:</span>
                <select id="paper-selector" class="bg-slate-50 border border-slate-200 text-slate-900 text-sm rounded-md focus:ring-brand-500 focus:border-brand-500 block w-full sm:w-64 p-2 transition-colors">
                    <option>Loading...</option>
                </select>
            </div>

            <!-- Mobile Jump To Trigger -->
            <button id="mobile-menu-trigger" class="lg:hidden p-2 text-slate-600 hover:text-brand-600 transition-colors" aria-label="Jump to question">
                <span class="flex items-center gap-2 text-sm font-medium">
                    <i data-lucide="list" class="w-4 h-4"></i>
                    Jump to
                </span>
            </button>
        </div>
    </div>

    <!-- DocumentFrameShell -->
    <div class="flex-1 max-w-7xl mx-auto w-full flex flex-col lg:flex-row relative">
        
        <!-- Desktop Navigation Rail (Left Column) -->
        <aside class="hidden lg:block w-64 flex-shrink-0 sticky top-14 h-[calc(100vh-3.5rem)] overflow-y-auto no-scrollbar py-8 pl-4 pr-6 border-r border-transparent">
            <nav id="desktop-nav" class="space-y-1" aria-label="Desktop Navigation">
                <!-- Injected via JS -->
            </nav>
        </aside>

        <!-- Paper Document Column (Right Column - Primary) -->
        <main id="paper-content" class="flex-1 py-8 px-4 sm:px-8 lg:px-12 min-w-0">
            <!-- Content Injected via JS -->
            <div id="paper-body" class="max-w-3xl mx-auto space-y-16">
                <!-- Questions go here -->
            </div>
        </main>

    </div>

    <!-- Mobile Navigation Drawer -->
    <div id="mobile-drawer-overlay" class="fixed inset-0 bg-slate-900/20 backdrop-blur-sm z-30 hidden transition-opacity opacity-0" aria-hidden="true"></div>
    <div id="mobile-drawer" class="fixed inset-y-0 right-0 z-40 w-72 bg-white shadow-xl transform translate-x-full transition-transform duration-300 ease-in-out flex flex-col" aria-hidden="true">
        <div class="p-4 border-b border-slate-100 flex items-center justify-between">
            <h2 class="text-lg font-semibold text-slate-900">Jump to</h2>
            <button id="mobile-drawer-close" class="p-2 text-slate-500 hover:text-slate-900 transition-colors">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>
        <nav id="mobile-nav" class="flex-1 overflow-y-auto p-4 space-y-1">
            <!-- Injected via JS -->
        </nav>
    </div>

    <!-- App Logic -->
    <script>
        // --- STAGE 0: CONSTANTS ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // --- STATE & UTILS ---
        let payload = null;
        let currentPaperKey = null;
        let md = null;

        // --- MARKDOWN SETUP (Stage 6 Add-on) ---
        function initMarkdown() {
            if (window.markdownit) {
                md = window.markdownit({
                    html: true,       // Allow inline SVG
                    linkify: true,
                    breaks: false     // Critical: prevent <br> in math blocks
                });
                // Disable escape rule to preserve TeX backslashes
                md.inline.ruler.disable(['escape']);
            }
        }

        // --- FETCHING ---
        async function loadPayload() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Network response was not ok");
                payload = await response.json();
                initApp();
            } catch (error) {
                console.error("Failed to load payload:", error);
                renderError();
            }
        }

        function renderError() {
            const container = document.getElementById('paper-body');
            container.innerHTML = `
                <div class="flex flex-col items-center justify-center py-20 text-center">
                    <div class="text-slate-300 mb-4">
                        <i data-lucide="file-warning" class="w-12 h-12"></i>
                    </div>
                    <h2 class="text-xl font-bold text-slate-900 mb-2">PAPERS PAYLOAD MISSING</h2>
                    <p class="text-slate-500 max-w-md">
                        Unable to load content from <code class="bg-slate-100 px-1 py-0.5 rounded text-xs">${RTQ_PAPERS_PAYLOAD_PATH}</code>.
                        Please ensure the payload file exists at the canonical path.
                    </p>
                </div>
            `;
            lucide.createIcons();
            // Clear selector
            document.getElementById('paper-selector').innerHTML = '<option disabled selected>Error loading papers</option>';
        }

        // --- INITIALIZATION ---
        function initApp() {
            // Populate Selector
            const selector = document.getElementById('paper-selector');
            selector.innerHTML = '';
            
            if (!payload.papers || payload.papers.length === 0) {
                renderError();
                return;
            }

            payload.papers.forEach(paper => {
                const option = document.createElement('option');
                option.value = paper.key;
                option.textContent = paper.label || paper.key;
                selector.appendChild(option);
            });

            // Set initial paper
            currentPaperKey = payload.papers[0].key;
            selector.value = currentPaperKey;

            // Event Listeners
            selector.addEventListener('change', (e) => {
                currentPaperKey = e.target.value;
                renderPaper(currentPaperKey);
            });

            // Mobile Drawer Logic
            setupMobileDrawer();

            // Initial Render
            renderPaper(currentPaperKey);
        }

        function setupMobileDrawer() {
            const trigger = document.getElementById('mobile-menu-trigger');
            const drawer = document.getElementById('mobile-drawer');
            const overlay = document.getElementById('mobile-drawer-overlay');
            const closeBtn = document.getElementById('mobile-drawer-close');

            function open() {
                drawer.classList.remove('translate-x-full');
                overlay.classList.remove('hidden');
                // slight delay for opacity transition
                setTimeout(() => overlay.classList.remove('opacity-0'), 10);
                document.body.style.overflow = 'hidden';
            }

            function close() {
                drawer.classList.add('translate-x-full');
                overlay.classList.add('opacity-0');
                setTimeout(() => overlay.classList.add('hidden'), 300);
                document.body.style.overflow = '';
            }

            trigger.addEventListener('click', open);
            closeBtn.addEventListener('click', close);
            overlay.addEventListener('click', close);
            
            // Close on nav click
            drawer.addEventListener('click', (e) => {
                if (e.target.closest('a')) close();
            });
        }

        // --- RENDERING CORE ---

        function renderPaper(paperKey) {
            const paper = payload.papers.find(p => p.key === paperKey);
            if (!paper) return;

            const container = document.getElementById('paper-body');
            container.innerHTML = ''; // Clear previous

            // Scroll to top
            window.scrollTo(0, 0);

            // 1. Build Question List
            // Handle structure: Flat (questions[]) or Sectioned (sections[])
            let nodes = [];
            let isSectioned = false;

            if (paper.sections && paper.sections.length > 0) {
                isSectioned = true;
                // We will iterate sections during rendering
            } else if (paper.questions) {
                nodes = paper.questions;
            }

            // 2. Render Content
            if (isSectioned) {
                paper.sections.forEach((section, index) => {
                    // Render Section Header if label exists
                    if (section.label && section.label.trim().length > 0) {
                        const sectionHeader = document.createElement('div');
                        sectionHeader.className = "mb-8 pb-2 border-b border-slate-100";
                        sectionHeader.innerHTML = `<h2 class="text-xl font-bold text-slate-400 font-sans tracking-tight">${section.label}</h2>`;
                        container.appendChild(sectionHeader);
                    }
                    
                    // Render Questions in Section
                    const listContainer = document.createElement('div');
                    listContainer.className = "space-y-16 mb-16"; // Top-level inter-question spacing
                    section.questions.forEach(q => {
                        listContainer.appendChild(renderQuestionNode(q, paper.defaults));
                    });
                    container.appendChild(listContainer);
                });
            } else {
                const listContainer = document.createElement('div');
                listContainer.className = "space-y-16"; 
                nodes.forEach(q => {
                    listContainer.appendChild(renderQuestionNode(q, paper.defaults));
                });
                container.appendChild(listContainer);
            }

            // 3. Render Navigation
            renderNavigation(paper);

            // 4. Post-Render: KaTeX & Icons
            requestAnimationFrame(() => {
                renderMathInElement(container, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false}
                    ],
                    throwOnError: false
                });
                lucide.createIcons();
                updateActiveNavOnScroll();
            });
        }

        // --- RECURSIVE QUESTION RENDERER ---
        
        function renderQuestionNode(node, defaults, depth = 0) {
            const wrapper = document.createElement('div');
            wrapper.id = `q-${node.id}`;
            wrapper.className = "flex flex-col group"; 

            // --- A) Question Body ---
            const body = document.createElement('div');
            body.className = "mb-4"; // Spacing between question and solution block

            // Identifier
            const idLabel = document.createElement('div');
            idLabel.className = "text-slate-500 font-bold text-sm mb-1";
            idLabel.textContent = node.id;
            
            // Prompt (Markdown)
            const prompt = document.createElement('div');
            prompt.className = "text-slate-900 text-lg md-content leading-relaxed";
            prompt.innerHTML = renderMarkdown(node.question || "");

            body.appendChild(idLabel);
            body.appendChild(prompt);
            wrapper.appendChild(body);

            // --- B) Solution Block (Optional) ---
            if (node.solutionBlock) {
                const sb = node.solutionBlock;
                const hasAnswer = !!sb.answer;
                const hasDetails = !!sb.solutionDetails;

                if (hasAnswer || hasDetails) {
                    const blockWrapper = document.createElement('div');
                    // Structural separator: Spacing + Optional Hairline
                    // Using spacing primarily. Hairline for density resilience if needed.
                    blockWrapper.className = "mt-2 pt-1"; 

                    // 1. Answer (Visible by default if present)
                    if (hasAnswer) {
                        const answerDiv = document.createElement('div');
                        answerDiv.className = "mb-4";
                        
                        const ansLabel = document.createElement('div');
                        ansLabel.className = "text-xs font-bold text-slate-400 uppercase tracking-wider mb-1";
                        ansLabel.textContent = "Answer";
                        
                        const ansContent = document.createElement('div');
                        ansContent.className = "text-slate-800 font-medium md-content";
                        ansContent.innerHTML = renderMarkdown(sb.answer);

                        answerDiv.appendChild(ansLabel);
                        answerDiv.appendChild(ansContent);
                        blockWrapper.appendChild(answerDiv);
                    }

                    // 2. Solution Details (Expandable)
                    if (hasDetails) {
                        const details = sb.solutionDetails;
                        // Determine default state
                        const isExpanded = defaults && defaults.expandedAll === false ? false : true;

                        const detailsContainer = document.createElement('div');
                        detailsContainer.className = "mt-2";

                        // Disclosure Control
                        const toggleBtn = document.createElement('button');
                        toggleBtn.className = "flex items-center gap-1 text-sm font-medium text-brand-600 hover:text-brand-700 transition-colors focus:outline-none";
                        toggleBtn.setAttribute('aria-expanded', isExpanded);
                        
                        const btnText = document.createElement('span');
                        btnText.textContent = isExpanded ? "Hide working" : "Show working";
                        
                        const btnIcon = document.createElement('i');
                        btnIcon.setAttribute('data-lucide', isExpanded ? "chevron-up" : "chevron-down");
                        btnIcon.className = "w-4 h-4";

                        toggleBtn.appendChild(btnText);
                        toggleBtn.appendChild(btnIcon);

                        // Content Region
                        const contentRegion = document.createElement('div');
                        contentRegion.className = `mt-3 pl-4 border-l-2 border-brand-100 space-y-6 ${isExpanded ? '' : 'hidden'}`;
                        
                        // Optional surface wash (subtle)
                        contentRegion.classList.add("bg-brand-50/30", "py-4", "rounded-r-sm", "pr-4");

                        // --- Keep in Mind ---
                        if (details.keepInMind) {
                            const section = document.createElement('div');
                            section.innerHTML = `
                                <div class="flex items-center gap-2 mb-2 text-brand-700 font-bold text-sm">
                                    <i data-lucide="lightbulb" class="w-4 h-4"></i>
                                    Keep in mind
                                </div>
                                <div class="text-slate-700 text-sm md-content">${renderMarkdown(details.keepInMind)}</div>
                            `;
                            contentRegion.appendChild(section);
                        }

                        // --- Formulas Used ---
                        if (details.formulasUsed) {
                            const section = document.createElement('div');
                            section.innerHTML = `
                                <div class="mb-2 text-slate-500 font-bold text-xs uppercase tracking-wide">Formulas used</div>
                                <div class="text-slate-600 text-sm md-content">${renderMarkdown(details.formulasUsed)}</div>
                            `;
                            contentRegion.appendChild(section);
                        }

                        // --- Working ---
                        if (details.working) {
                            const section = document.createElement('div');
                            section.innerHTML = `
                                <div class="mb-2 text-slate-500 font-bold text-xs uppercase tracking-wide">Working</div>
                                <div class="text-slate-800 md-content space-y-4">${renderMarkdown(details.working)}</div>
                            `;
                            contentRegion.appendChild(section);
                        }

                        // --- Alternative Working ---
                        if (details.alternativeWorking && Array.isArray(details.alternativeWorking)) {
                            details.alternativeWorking.forEach(alt => {
                                const section = document.createElement('div');
                                section.className = "pt-4 border-t border-slate-200/60"; // Demarcation
                                section.innerHTML = `
                                    <div class="mb-2 text-slate-500 font-bold text-xs uppercase tracking-wide">Alternative working</div>
                                    <div class="text-slate-800 md-content space-y-4">${renderMarkdown(alt)}</div>
                                `;
                                contentRegion.appendChild(section);
                            });
                        }

                        // Toggle Logic
                        toggleBtn.onclick = () => {
                            const expanded = toggleBtn.getAttribute('aria-expanded') === 'true';
                            toggleBtn.setAttribute('aria-expanded', !expanded);
                            btnText.textContent = !expanded ? "Hide working" : "Show working";
                            
                            // Icon update hack for lucide (re-render or just replace class)
                            // Simpler: just clear innerHTML and rebuild or toggle classes
                            // Since we use lucide.createIcons(), we need to handle SVG swap or just rely on CSS rotate.
                            // Let's just rebuild button inner content for simplicity in prototype
                            toggleBtn.innerHTML = '';
                            toggleBtn.appendChild(btnText);
                            const newIcon = document.createElement('i');
                            newIcon.setAttribute('data-lucide', !expanded ? "chevron-up" : "chevron-down");
                            newIcon.className = "w-4 h-4";
                            toggleBtn.appendChild(newIcon);
                            lucide.createIcons({ root: toggleBtn });

                            contentRegion.classList.toggle('hidden');
                        };

                        detailsContainer.appendChild(toggleBtn);
                        detailsContainer.appendChild(contentRegion);
                        blockWrapper.appendChild(detailsContainer);
                    }
                    
                    wrapper.appendChild(blockWrapper);
                }
            }

            // --- C) Children (Recursive) ---
            if (node.children && node.children.length > 0) {
                const childrenContainer = document.createElement('div');
                childrenContainer.className = "mt-6 ml-0 pl-0 space-y-6"; 
                // Note: Design brief says "No nested visual indentation" for NAV, but for CONTENT indentation is permitted to show hierarchy.
                // Stage 3 E: "Horizontal indentation (spacing only)".
                childrenContainer.classList.add("md:ml-6"); // Responsive indentation

                node.children.forEach(child => {
                    childrenContainer.appendChild(renderQuestionNode(child, defaults, depth + 1));
                });
                wrapper.appendChild(childrenContainer);
            }

            return wrapper;
        }

        function renderMarkdown(text) {
            if (!text) return "";
            return md ? md.render(text) : text;
        }

        // --- NAVIGATION ---

        function renderNavigation(paper) {
            const desktopNav = document.getElementById('desktop-nav');
            const mobileNav = document.getElementById('mobile-nav');
            
            // Build list items
            const fragment = document.createDocumentFragment();

            function createNavItem(id, label, isSectionLabel = false) {
                if (isSectionLabel) {
                    const div = document.createElement('div');
                    div.className = "mt-6 mb-2 text-xs font-bold text-slate-400 uppercase tracking-wider px-3 select-none";
                    div.textContent = label;
                    return div;
                }

                const a = document.createElement('a');
                a.href = `#q-${id}`;
                a.dataset.target = `q-${id}`;
                a.className = "nav-item block py-1.5 px-3 text-sm rounded-md transition-colors text-slate-500 hover:text-slate-900 hover:bg-slate-50 border-l-2 border-transparent";
                a.textContent = id;
                
                // Visual hierarchy via type scale/opacity (simulated via text color classes above)
                // Sub-questions could have lighter weight if needed, but 'flat' is requested.
                
                a.onclick = (e) => {
                    e.preventDefault();
                    document.getElementById(`q-${id}`).scrollIntoView({behavior: 'smooth', block: 'start'});
                    // Update active state manually for instant feedback
                    document.querySelectorAll('.nav-item').forEach(el => updateNavState(el, false));
                    updateNavState(a, true);
                    
                    // Close mobile drawer if open
                    if (window.innerWidth < 1024) {
                        document.getElementById('mobile-drawer-close').click();
                    }
                };
                return a;
            }

            // Iterate logic
            if (paper.sections) {
                paper.sections.forEach(section => {
                    if (section.label) {
                        fragment.appendChild(createNavItem(null, section.label, true));
                    }
                    section.questions.forEach(q => traverseTreeForNav(q, fragment));
                });
            } else {
                if (paper.questions) {
                    paper.questions.forEach(q => traverseTreeForNav(q, fragment));
                }
            }

            // Clone for mobile
            const mobileFragment = fragment.cloneNode(true);
            
            // Re-attach listeners for mobile clones (cloning strips listeners)
            // Simpler: rebuild or just use a helper that generates string. 
            // We will just clear and rebuild for both to ensure listeners work.
            
            desktopNav.innerHTML = '';
            mobileNav.innerHTML = '';

            // We need to re-run generation to attach listeners properly to two places
            // Optimization: Generate HTML string -> inject -> attach delegation? 
            // Stick to simple loop for prototype.
            
            [[desktopNav], [mobileNav]].forEach(([container]) => {
                if (paper.sections) {
                    paper.sections.forEach(section => {
                        if (section.label) container.appendChild(createNavItem(null, section.label, true));
                        section.questions.forEach(q => traverseTreeForNav(q, container, createNavItem));
                    });
                } else if (paper.questions) {
                    paper.questions.forEach(q => traverseTreeForNav(q, container, createNavItem));
                }
            });
        }

        function traverseTreeForNav(node, container, creator) {
            container.appendChild(creator(node.id));
            if (node.children) {
                node.children.forEach(child => traverseTreeForNav(child, container, creator));
            }
        }

        function updateNavState(el, isActive) {
            if (isActive) {
                el.classList.remove('text-slate-500', 'border-transparent');
                el.classList.add('text-brand-700', 'font-bold', 'border-brand-600', 'bg-brand-50');
            } else {
                el.classList.add('text-slate-500', 'border-transparent');
                el.classList.remove('text-brand-700', 'font-bold', 'border-brand-600', 'bg-brand-50');
            }
        }

        // --- SCROLL SPY ---
        function updateActiveNavOnScroll() {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting && entry.intersectionRatio > 0) {
                        const id = entry.target.id.replace('q-', '');
                        // Find nav links
                        const links = document.querySelectorAll(`a[data-target="q-${id}"]`);
                        if (links.length > 0) {
                            document.querySelectorAll('.nav-item').forEach(el => updateNavState(el, false));
                            links.forEach(l => updateNavState(l, true));
                        }
                    }
                });
            }, {
                rootMargin: '-10% 0px -80% 0px', // Focus on top area
                threshold: 0
            });

            document.querySelectorAll('[id^="q-"]').forEach(el => observer.observe(el));
        }

        // --- BOOTSTRAP ---
        initMarkdown();
        loadPayload();

    </script>
</body>
</html>
