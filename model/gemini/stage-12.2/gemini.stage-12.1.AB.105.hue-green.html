<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AB","indexWithinVariant":"105","totalWithinVariant":"200","hueFamily":"green","intensityMode":"","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-08T18:07:38.711Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AB&quot;,&quot;indexWithinVariant&quot;:&quot;105&quot;,&quot;totalWithinVariant&quot;:&quot;200&quot;,&quot;hueFamily&quot;:&quot;green&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-08T18:07:38.711Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ â€“ Maths Paper Solution Viewer</title>

    <!-- 1. Tailwind CSS (Theme Configuration: ColorLab B "Green") -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // ColorLab B: Forced Hue Family = "green"
                        // Mapping standard green palette to semantic names for easier reference
                        brand: {
                            50: '#f0fdf4',
                            100: '#dcfce7',
                            200: '#bbf7d0',
                            300: '#86efac',
                            400: '#4ade80',
                            500: '#22c55e', // Focus
                            600: '#16a34a', // Primary interactions
                            700: '#15803d', // Darker text/links
                            800: '#166534', // Hover states
                            900: '#14532d',
                            950: '#052e16',
                        },
                        // Surface & Text Neutrals (Warm/Calm per Stage 5)
                        surface: {
                            bg: '#fdfdfc',       // Page background (very subtle warm white)
                            paper: '#ffffff',    // Main paper surface
                            subtle: '#f5f5f4',   // Demarcation washes
                        },
                        ink: {
                            primary: '#1c1917',   // Question text
                            secondary: '#44403c', // Answers, Solution Details
                            tertiary: '#78716c',  // Metadata, Navigation
                            quaternary: '#a8a29e' // Dividers
                        }
                    },
                    fontFamily: {
                        sans: ['ui-sans-serif', 'system-ui', 'sans-serif', "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji"],
                    },
                    spacing: {
                        'rhythm-lg': '3.5rem', // Between top-level questions
                        'rhythm-md': '2rem',   // Parent to children
                        'rhythm-sm': '1.25rem', // Within question node
                        'rhythm-xs': '0.75rem', // Tight grouping
                    }
                }
            }
        }
    </script>

    <!-- 2. KaTeX CSS (No SRI, No Integrity) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <!-- 3. KaTeX JS (No SRI, No Integrity) -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- 4. Markdown-it (No SRI, No Integrity) -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <!-- 5. Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Base styles & Reset overrides */
        body {
            background-color: #fdfdfc; /* surface.bg */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* 
           KaTeX Containment Invariant (Locked)
           Horizontal scrolling permitted ONLY within math block containers.
           Never page-level horizontal scroll.
        */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding-bottom: 0.25rem; /* Space for scrollbar */
            -webkit-overflow-scrolling: touch;
        }
        
        /* Hide scrollbars for navigation but keep functional */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Markdown Table Minimal Styling */
        table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 1rem;
            font-size: 0.95em;
        }
        th, td {
            border: 1px solid #e7e5e4; /* stone-200 */
            padding: 0.5rem 0.75rem;
            text-align: left;
            vertical-align: top;
        }
        th {
            font-weight: 600;
            background-color: transparent;
            color: #44403c;
        }

        /* Focus Ring Customization (ColorLab Green) */
        *:focus-visible {
            outline: 2px solid #22c55e; /* brand-500 */
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* Utility for content fade-in */
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(4px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="text-stone-900">

    <!-- Application Root -->
    <div id="app" class="min-h-screen flex flex-col">
        
        <!-- Top Controls Region (Aligned to Frame) -->
        <header class="w-full border-b border-stone-200 bg-white/80 backdrop-blur-sm sticky top-0 z-30">
            <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
                <!-- Paper Selector -->
                <div class="flex items-center gap-3">
                    <label for="paper-select" class="text-xs font-bold uppercase tracking-wide text-stone-500 hidden sm:block">Paper</label>
                    <select id="paper-select" class="bg-stone-50 border border-stone-300 text-stone-900 text-sm rounded-md focus:ring-brand-500 focus:border-brand-500 block w-full p-2.5 min-w-[200px]">
                        <option value="" disabled selected>Loading papers...</option>
                    </select>
                </div>

                <!-- Mobile "Jump to" Trigger -->
                <button id="mobile-jump-trigger" class="lg:hidden flex items-center gap-2 text-stone-600 hover:text-brand-700 px-3 py-2 rounded-md transition-colors" aria-label="Open navigation">
                    <span class="text-sm font-medium">Jump to</span>
                    <i data-lucide="menu" class="w-5 h-5"></i>
                </button>
            </div>
        </header>

        <!-- DocumentFrameShell (Desktop: Two Sibling Columns) -->
        <div class="flex-1 max-w-6xl mx-auto w-full px-4 sm:px-6 lg:px-8 flex items-start relative">
            
            <!-- Navigation Rail (Desktop) -->
            <nav id="desktop-nav" class="hidden lg:block w-48 shrink-0 sticky top-20 max-h-[calc(100vh-6rem)] overflow-y-auto no-scrollbar py-6 pr-6 mr-8 border-r border-transparent">
                <!-- Nav content injected via JS -->
            </nav>

            <!-- Paper Document Column -->
            <main id="paper-content" class="flex-1 min-w-0 py-8 pb-32">
                <!-- Content injected via JS -->
                <div id="loading-state" class="text-center py-20 text-stone-400">
                    <p class="animate-pulse">Loading paper content...</p>
                </div>
                <div id="error-state" class="hidden text-center py-20 text-stone-500 font-medium">
                    PAPERS PAYLOAD MISSING
                </div>
            </main>

        </div>

        <!-- Mobile Navigation Drawer -->
        <div id="mobile-drawer-backdrop" class="fixed inset-0 bg-stone-900/20 backdrop-blur-[1px] z-40 hidden transition-opacity opacity-0" aria-hidden="true"></div>
        <div id="mobile-drawer" class="fixed inset-y-0 right-0 w-64 bg-white shadow-xl transform translate-x-full transition-transform duration-300 ease-out z-50 flex flex-col" aria-hidden="true">
            <div class="p-4 border-b border-stone-100 flex items-center justify-between bg-stone-50/50">
                <h2 class="text-sm font-bold uppercase tracking-wide text-stone-500">Jump to Question</h2>
                <button id="close-drawer" class="text-stone-400 hover:text-stone-700 p-1">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div id="mobile-nav-list" class="flex-1 overflow-y-auto p-4">
                <!-- Mobile nav content injected via JS -->
            </div>
        </div>

    </div>

    <!-- Logic -->
    <script>
        // --- STAGE 0: CONSTANTS ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // --- GLOBAL STATE ---
        let state = {
            papers: [],
            currentPaper: null,
            expandedWorkings: new Set(), // Set of question IDs with expanded workings
            isDrawerOpen: false
        };

        // --- MARKDOWN CONFIGURATION (STAGE 6.1 HARDENED) ---
        const md = window.markdownit ? window.markdownit({
            html: true,       // Enable inline SVG passthrough
            linkify: true,
            breaks: false     // MUST be false to prevent <br> in math blocks
        }) : null;

        if (md) {
            // Disable escaping to preserve TeX backslashes
            md.inline.ruler.disable(['escape']);
        }

        // --- DOM ELEMENTS ---
        const els = {
            paperSelect: document.getElementById('paper-select'),
            paperContent: document.getElementById('paper-content'),
            desktopNav: document.getElementById('desktop-nav'),
            mobileNavList: document.getElementById('mobile-nav-list'),
            loadingState: document.getElementById('loading-state'),
            errorState: document.getElementById('error-state'),
            mobileJumpTrigger: document.getElementById('mobile-jump-trigger'),
            mobileDrawer: document.getElementById('mobile-drawer'),
            mobileDrawerBackdrop: document.getElementById('mobile-drawer-backdrop'),
            closeDrawer: document.getElementById('close-drawer')
        };

        // --- INITIALIZATION ---
        async function init() {
            try {
                // Deterministic Load via Canonical Constant
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error('Payload fetch failed');
                
                const payload = await response.json();
                
                if (!payload.papers || !Array.isArray(payload.papers)) {
                    throw new Error('Invalid payload structure');
                }

                state.papers = payload.papers;
                
                // Populate Selector
                populatePaperSelector();
                
                // Load Initial Paper (first one)
                if (state.papers.length > 0) {
                    loadPaper(state.papers[0].key);
                } else {
                    renderError();
                }

            } catch (error) {
                console.error("Initialization Error:", error);
                renderError();
            }
        }

        function renderError() {
            els.loadingState.classList.add('hidden');
            els.errorState.classList.remove('hidden');
            els.paperSelect.disabled = true;
            els.paperSelect.innerHTML = '<option>Error loading papers</option>';
        }

        function populatePaperSelector() {
            els.paperSelect.innerHTML = '';
            state.papers.forEach(paper => {
                const option = document.createElement('option');
                option.value = paper.key;
                option.textContent = paper.label || paper.key;
                els.paperSelect.appendChild(option);
            });

            els.paperSelect.addEventListener('change', (e) => {
                loadPaper(e.target.value);
            });
        }

        // --- PAPER LOADING & RENDERING ---
        function loadPaper(paperKey) {
            const paper = state.papers.find(p => p.key === paperKey);
            if (!paper) return;

            state.currentPaper = paper;
            
            // Reset state
            state.expandedWorkings.clear();
            const defaults = paper.defaults || {};
            
            // If defaults say expandedAll is true (or undefined/default), we respect that later during render
            // Actually, spec says: "Default state: expanded unless paper.defaults.expandedAll=false"
            // We'll handle this logic dynamically during rendering checks.

            // Render Layout
            renderContent(paper);
            renderNavigation(paper);
            
            // Math Rendering (KaTeX Auto-render)
            // Render math in the main content area
            renderMathInElement(els.paperContent, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false},
                    {left: '\\(', right: '\\)', display: false},
                    {left: '\\[', right: '\\]', display: true}
                ],
                throwOnError: false,
                output: 'html' // Use HTML output for better accessibility/performance match
            });

            // Icons
            lucide.createIcons();
            
            // Scroll to top
            window.scrollTo(0, 0);
        }

        // --- CONTENT RENDERING ENGINE ---
        function renderContent(paper) {
            els.loadingState.classList.add('hidden');
            els.errorState.classList.add('hidden');
            
            // Clear current content (keeping state elements hidden)
            // We rebuild the tree.
            const container = document.createElement('div');
            container.className = 'space-y-14 fade-in'; // Rhythm-lg

            // Handle Sectioned vs Flat Papers
            if (paper.sections) {
                paper.sections.forEach((section, idx) => {
                    const sectionBlock = document.createElement('div');
                    
                    // Section Header (only if label is present)
                    if (section.label && section.label.trim() !== '') {
                        const header = document.createElement('div');
                        header.className = 'mb-8 border-b border-stone-200 pb-2';
                        header.innerHTML = `<h2 class="text-xl font-semibold text-stone-800">${escapeHtml(section.label)}</h2>`;
                        sectionBlock.appendChild(header);
                    }

                    // Question List
                    const list = document.createElement('div');
                    list.className = 'space-y-14'; // Rhythm-lg between top-level questions
                    section.questions.forEach(q => {
                        list.appendChild(createQuestionNode(q, 0));
                    });
                    
                    sectionBlock.appendChild(list);
                    container.appendChild(sectionBlock);
                    
                    // Spacer between sections if not last
                    if (idx < paper.sections.length - 1) {
                        const spacer = document.createElement('div');
                        spacer.className = 'h-8';
                        container.appendChild(spacer);
                    }
                });
            } else if (paper.questions) {
                paper.questions.forEach(q => {
                    container.appendChild(createQuestionNode(q, 0));
                });
            }

            // Replace content
            // Remove all children except loading/error
            Array.from(els.paperContent.children).forEach(child => {
                if (child.id !== 'loading-state' && child.id !== 'error-state') {
                    child.remove();
                }
            });
            els.paperContent.appendChild(container);
        }

        // Recursive Question Node Creator
        function createQuestionNode(q, depth) {
            const node = document.createElement('div');
            node.id = `q-${q.id}`;
            node.className = `flex flex-col group scroll-mt-24 ${depth > 0 ? 'mt-8' : ''}`; // Rhythm-md for children

            // 1. Question Body
            const bodyRow = document.createElement('div');
            bodyRow.className = 'flex flex-row gap-4';

            // Identifier
            const idCol = document.createElement('div');
            idCol.className = 'shrink-0 w-8 pt-1'; // Align with first line of text
            idCol.innerHTML = `<span class="text-stone-500 font-medium text-sm select-none">${escapeHtml(q.id)}</span>`;
            bodyRow.appendChild(idCol);

            // Prompt
            const promptCol = document.createElement('div');
            promptCol.className = 'flex-1 min-w-0';
            
            const questionText = document.createElement('div');
            // Typography: Primary Anchor
            questionText.className = 'text-base font-medium text-stone-900 leading-relaxed mb-4 markdown-body'; 
            questionText.innerHTML = renderMarkdown(q.question);
            promptCol.appendChild(questionText);

            // 2. Solution Block (Optional)
            if (q.solutionBlock) {
                const sb = q.solutionBlock;
                const blockWrapper = document.createElement('div');
                blockWrapper.className = 'mt-2'; // Tight grouping to question

                // Answer (Optional)
                if (sb.answer) {
                    const answerDiv = document.createElement('div');
                    answerDiv.className = 'mb-4';
                    answerDiv.innerHTML = `
                        <div class="text-xs font-bold text-stone-400 uppercase tracking-wide mb-1">Answer</div>
                        <div class="text-stone-800 markdown-body">${renderMarkdown(sb.answer)}</div>
                    `;
                    blockWrapper.appendChild(answerDiv);
                }

                // Solution Details (Optional)
                if (sb.solutionDetails) {
                    const details = sb.solutionDetails;
                    const detailsId = `details-${q.id}`;
                    
                    // Defaults check
                    const defaults = state.currentPaper.defaults || {};
                    const isExpandedDefault = defaults.expandedAll !== false; 
                    
                    // Initialize state if not present (only if not already set by interaction)
                    if (!state.expandedWorkings.has(q.id) && isExpandedDefault) {
                        state.expandedWorkings.add(q.id);
                    }
                    
                    const isExpanded = state.expandedWorkings.has(q.id);

                    // Disclosure Control
                    const toggleBtn = document.createElement('button');
                    toggleBtn.className = 'flex items-center gap-1.5 text-sm font-medium text-brand-600 hover:text-brand-800 transition-colors focus:outline-none rounded-sm py-1 pr-2';
                    toggleBtn.setAttribute('aria-expanded', isExpanded);
                    toggleBtn.setAttribute('aria-controls', detailsId);
                    
                    const updateToggleUI = () => {
                        const open = state.expandedWorkings.has(q.id);
                        toggleBtn.innerHTML = `
                            <span class="text-brand-600">${open ? 'Hide working' : 'Show working'}</span>
                            <i data-lucide="chevron-${open ? 'up' : 'down'}" class="w-4 h-4 text-brand-400"></i>
                        `;
                        // Re-run icons immediately for this button
                        if (window.lucide) lucide.createIcons({ root: toggleBtn });
                    };
                    
                    updateToggleUI();

                    toggleBtn.onclick = () => {
                        if (state.expandedWorkings.has(q.id)) {
                            state.expandedWorkings.delete(q.id);
                        } else {
                            state.expandedWorkings.add(q.id);
                        }
                        updateToggleUI();
                        const region = document.getElementById(detailsId);
                        if (region) {
                            region.hidden = !state.expandedWorkings.has(q.id);
                            toggleBtn.setAttribute('aria-expanded', state.expandedWorkings.has(q.id));
                        }
                    };

                    blockWrapper.appendChild(toggleBtn);

                    // Details Region
                    const detailsRegion = document.createElement('div');
                    detailsRegion.id = detailsId;
                    detailsRegion.hidden = !isExpanded;
                    // Styling: Subordinate, indented slightly relative to prompt, distinct visual hierarchy
                    // Note: No heavy border, no card. Just spacing and type hierarchy.
                    detailsRegion.className = 'mt-3 pl-0 border-l-2 border-brand-100 pl-4 py-1 space-y-6 text-stone-700';

                    // Order: Keep in mind -> Formulas -> Working -> Alternative
                    
                    // Keep in mind
                    if (details.keepInMind) {
                        const kim = document.createElement('div');
                        kim.innerHTML = `
                            <div class="flex items-center gap-2 mb-1">
                                <i data-lucide="lightbulb" class="w-4 h-4 text-brand-500"></i>
                                <span class="text-xs font-bold text-brand-700 uppercase tracking-wide">Keep in mind</span>
                            </div>
                            <div class="text-sm leading-relaxed text-stone-600 markdown-body">${renderMarkdown(details.keepInMind)}</div>
                        `;
                        detailsRegion.appendChild(kim);
                    }

                    // Formulas used
                    if (details.formulasUsed) {
                        const formulas = document.createElement('div');
                        formulas.innerHTML = `
                            <div class="text-xs font-bold text-stone-500 uppercase tracking-wide mb-1">Formulas used</div>
                            <div class="text-sm text-stone-600 font-mono bg-stone-50/50 p-2 rounded-sm markdown-body">${renderMarkdown(details.formulasUsed)}</div>
                        `;
                        detailsRegion.appendChild(formulas);
                    }

                    // Working
                    if (details.working) {
                        const work = document.createElement('div');
                        work.innerHTML = `
                            <div class="text-xs font-bold text-stone-500 uppercase tracking-wide mb-2">Working</div>
                            <div class="space-y-4 markdown-body text-stone-800">${renderMarkdown(details.working)}</div>
                        `;
                        detailsRegion.appendChild(work);
                    }

                    // Alternative Working
                    if (details.alternativeWorking && Array.isArray(details.alternativeWorking)) {
                        details.alternativeWorking.forEach((alt, idx) => {
                            const altDiv = document.createElement('div');
                            // Demarcation: Separator (permitted by Stage 3 internal separators)
                            altDiv.className = "pt-4 border-t border-stone-100 mt-4";
                            altDiv.innerHTML = `
                                <div class="text-xs font-bold text-stone-400 uppercase tracking-wide mb-2">Alternative working</div>
                                <div class="space-y-4 markdown-body text-stone-800">${renderMarkdown(alt)}</div>
                            `;
                            detailsRegion.appendChild(altDiv);
                        });
                    }

                    blockWrapper.appendChild(detailsRegion);
                }

                promptCol.appendChild(blockWrapper);
            }

            bodyRow.appendChild(promptCol);
            node.appendChild(bodyRow);

            // 3. Children Container
            if (q.children && q.children.length > 0) {
                const childrenContainer = document.createElement('div');
                childrenContainer.className = 'ml-0 mt-2 pl-8 border-l border-transparent'; // Indentation for hierarchy (Layout Tree E)
                // Use explicit spacing only, border transparent to avoid "lines everywhere"
                
                q.children.forEach(child => {
                    childrenContainer.appendChild(createQuestionNode(child, depth + 1));
                });
                node.appendChild(childrenContainer);
            }

            return node;
        }


        // --- NAVIGATION GENERATION ---
        function renderNavigation(paper) {
            // Build flat list of identifiers
            let navHTML = '';
            
            const buildItem = (id, depth) => {
                // Stage 5.4.5: Hierarchy via type scale only, no indent.
                const scaleClass = depth === 0 ? 'text-sm font-medium' : 'text-xs font-normal text-stone-500';
                return `
                    <button onclick="scrollToId('q-${id}')" 
                            class="w-full text-left py-1.5 px-2 rounded-md hover:bg-stone-100 hover:text-brand-700 transition-colors focus:bg-stone-50 ${scaleClass} text-stone-600 block truncate"
                            data-nav-target="q-${id}">
                        ${escapeHtml(id)}
                    </button>
                `;
            };

            const traverse = (nodes, depth) => {
                let html = '';
                nodes.forEach(q => {
                    html += buildItem(q.id, depth);
                    if (q.children) {
                        html += traverse(q.children, depth + 1);
                    }
                });
                return html;
            };

            if (paper.sections) {
                paper.sections.forEach(sec => {
                    if (sec.label && sec.label.trim() !== '') {
                        // Section Header as Separator
                        navHTML += `
                            <div class="mt-4 mb-2 px-2 text-[10px] font-bold uppercase tracking-wider text-stone-400 select-none">
                                ${escapeHtml(sec.label)}
                            </div>
                        `;
                    } else if (navHTML !== '') {
                         // Spacing between implicit sections
                         navHTML += '<div class="h-4"></div>';
                    }
                    navHTML += traverse(sec.questions, 0);
                });
            } else if (paper.questions) {
                navHTML += traverse(paper.questions, 0);
            }

            els.desktopNav.innerHTML = navHTML;
            els.mobileNavList.innerHTML = navHTML;
            
            setupScrollSpy();
        }

        function scrollToId(id) {
            const el = document.getElementById(id);
            if (el) {
                el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                closeMobileDrawer();
            }
        }

        // --- MOBILE DRAWER LOGIC ---
        els.mobileJumpTrigger.addEventListener('click', openMobileDrawer);
        els.closeDrawer.addEventListener('click', closeMobileDrawer);
        els.mobileDrawerBackdrop.addEventListener('click', closeMobileDrawer);

        function openMobileDrawer() {
            state.isDrawerOpen = true;
            els.mobileDrawerBackdrop.classList.remove('hidden');
            // Force reflow for transition
            void els.mobileDrawerBackdrop.offsetWidth;
            els.mobileDrawerBackdrop.classList.remove('opacity-0');
            
            els.mobileDrawer.classList.remove('hidden');
            // Force reflow
            void els.mobileDrawer.offsetWidth;
            els.mobileDrawer.classList.remove('translate-x-full');
            document.body.style.overflow = 'hidden'; // Lock body scroll
        }

        function closeMobileDrawer() {
            state.isDrawerOpen = false;
            els.mobileDrawerBackdrop.classList.add('opacity-0');
            els.mobileDrawer.classList.add('translate-x-full');
            
            setTimeout(() => {
                els.mobileDrawerBackdrop.classList.add('hidden');
                els.mobileDrawer.classList.add('hidden');
                document.body.style.overflow = '';
            }, 300);
        }

        // --- UTILS ---
        function renderMarkdown(text) {
            if (!text) return '';
            if (!md) return escapeHtml(text); // Fallback
            return md.render(text);
        }

        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // --- SCROLL SPY & NAV HIGHLIGHTING ---
        function setupScrollSpy() {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const id = entry.target.id;
                        highlightNav(id);
                    }
                });
            }, { rootMargin: '-10% 0px -80% 0px' }); // Highlight when near top

            document.querySelectorAll('[id^="q-"]').forEach(el => observer.observe(el));
        }

        function highlightNav(activeId) {
            // Reset all
            document.querySelectorAll('[data-nav-target]').forEach(el => {
                el.classList.remove('text-brand-700', 'font-bold', 'bg-stone-100');
                el.classList.add('text-stone-600', 'font-normal');
            });

            // Set active
            const activeEls = document.querySelectorAll(`[data-nav-target="${activeId}"]`);
            activeEls.forEach(el => {
                el.classList.remove('text-stone-600', 'font-normal');
                el.classList.add('text-brand-700', 'font-bold', 'bg-stone-100'); // Active state per Stage 5.4.3 + ColorLab B
            });
        }

        // --- START ---
        init();

    </script>
</body>
</html>
