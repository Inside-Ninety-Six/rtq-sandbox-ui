<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"ABC","indexWithinVariant":"78","totalWithinVariant":"320","hueFamily":"red","intensityMode":"tinted_neutrals","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-09T13:32:56.646Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;ABC&quot;,&quot;indexWithinVariant&quot;:&quot;78&quot;,&quot;totalWithinVariant&quot;:&quot;320&quot;,&quot;hueFamily&quot;:&quot;red&quot;,&quot;intensityMode&quot;:&quot;tinted_neutrals&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-09T13:32:56.646Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer (Stage 6)</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- KaTeX (No SRI as per Stage 6 instructions) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Markdown-it (No SRI) -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <style>
        /* =========================================
           STAGE 6 ADD-ON: COLORLAB CONFIGURATION
           Add-on B: Forced Hue "red"
           Add-on C: Intensity Mode "tinted_neutrals"
           Light Mode Only. OKLCH System.
           ========================================= */
        :root {
            /* HUE FAMILY: RED (approx 25deg) */
            --hue: 25;

            /* MODE: tinted_neutrals 
               - Surfaces: C [0.015 .. 0.035]
               - Wash: C [0.025 .. 0.045]
               - Text: Primary C <= 0.010, Secondary C <= 0.012
               - Accent: C [0.10 .. 0.16]
            */

            /* Surfaces */
            --c-page-bg: oklch(0.98 0.015 var(--hue));
            --c-frame-bg: oklch(0.96 0.02 var(--hue));
            --c-paper-bg: oklch(0.99 0.015 var(--hue));
            
            /* Washes */
            --c-solution-wash: oklch(0.96 0.035 var(--hue));
            
            /* Text */
            --c-text-primary: oklch(0.20 0.01 var(--hue));
            --c-text-secondary: oklch(0.45 0.012 var(--hue));
            --c-text-nav: oklch(0.40 0.01 var(--hue));
            
            /* Borders / Dividers */
            --c-divider: oklch(0.90 0.02 var(--hue));
            --c-divider-strong: oklch(0.85 0.03 var(--hue));

            /* Accent (Links, Focus, Toggle) */
            --c-accent: oklch(0.55 0.14 var(--hue)); 
            
            /* Focus Ring */
            --c-focus: oklch(0.55 0.14 var(--hue));

            /* Spacing Scale */
            --sp-xs: 0.25rem;
            --sp-sm: 0.5rem;
            --sp-md: 1rem;
            --sp-lg: 1.5rem;
            --sp-xl: 2.5rem; /* Inter-question spacing */
            
            /* Typography */
            --font-family: 'Inter', sans-serif;
            --font-size-base: 1rem;
            --font-size-sm: 0.875rem;
            --font-size-xs: 0.75rem;
            --font-weight-regular: 400;
            --font-weight-medium: 500;
            --font-weight-bold: 600;

            /* Widths */
            --w-frame-max: 1200px;
            --w-nav-rail: 240px;
        }

        /* =========================================
           RESET & BASE
           ========================================= */
        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: var(--font-family);
            background-color: var(--c-page-bg);
            color: var(--c-text-primary);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        button {
            font-family: inherit;
            border: none;
            background: none;
            cursor: pointer;
            padding: 0;
            color: inherit;
        }

        a {
            color: var(--c-accent);
            text-decoration: none;
        }
        
        a:hover {
            text-decoration: underline;
        }

        /* Focus States (Stage 5.5.2) */
        :focus-visible {
            outline: 2px solid var(--c-focus);
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* Scrollbar Hiding utility */
        .hide-scrollbar {
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE 10+ */
        }
        .hide-scrollbar::-webkit-scrollbar {
            display: none; /* Chrome/Safari */
        }

        /* =========================================
           LAYOUT SHELL
           ========================================= */
        .app-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .top-controls {
            padding: var(--sp-md) var(--sp-lg);
            background-color: var(--c-page-bg); /* Match context */
            border-bottom: 1px solid var(--c-divider);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 20;
        }
        
        /* Align controls with shell content */
        .top-controls-inner {
            width: 100%;
            max-width: var(--w-frame-max);
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .document-frame-shell {
            flex: 1;
            display: flex;
            width: 100%;
            max-width: var(--w-frame-max);
            margin: 0 auto;
            background-color: var(--c-frame-bg); /* Shared base surface */
        }

        /* Desktop Nav Rail */
        .nav-rail {
            width: var(--w-nav-rail);
            flex-shrink: 0;
            padding: var(--sp-lg) var(--sp-md);
            border-right: 1px solid var(--c-divider); /* Separator */
            position: sticky;
            top: 60px; /* Offset for top controls */
            height: calc(100vh - 60px);
            overflow-y: auto;
            display: none; /* Hidden on mobile */
        }
        
        @media (min-width: 768px) {
            .nav-rail {
                display: block;
            }
            .mobile-jump-trigger {
                display: none;
            }
        }

        .paper-column {
            flex: 1;
            padding: var(--sp-xl) var(--sp-lg);
            background-color: var(--c-paper-bg); /* Distinct paper surface */
            min-width: 0; /* Prevent flex blowout */
        }

        /* =========================================
           NAVIGATION
           ========================================= */
        .nav-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .nav-section-label {
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-bold);
            color: var(--c-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: var(--sp-md);
            margin-bottom: var(--sp-sm);
            padding-left: var(--sp-xs);
            pointer-events: none;
        }

        .nav-item {
            display: block;
            padding: var(--sp-xs) 0;
            color: var(--c-text-nav);
            font-size: var(--font-size-sm);
            cursor: pointer;
            transition: color 0.1s ease;
            text-align: left;
            width: 100%;
        }

        .nav-item:hover {
            color: var(--c-text-primary);
            text-decoration: underline;
            text-decoration-color: var(--c-divider-strong);
        }

        /* Active State - Weight only */
        .nav-item.active {
            font-weight: var(--font-weight-bold);
            color: var(--c-accent); /* Permitted override Stage 6.0.11 */
        }

        /* Hierarchy via Type Scale (Stage 5.4.5) */
        .nav-item[data-depth="0"] { font-size: var(--font-size-sm); }
        .nav-item[data-depth="1"] { font-size: 0.8125rem; } /* Slightly smaller */
        .nav-item[data-depth="2"] { font-size: 0.75rem; }

        /* =========================================
           PAPER CONTENT
           ========================================= */
        .paper-selector {
            font-family: inherit;
            font-size: var(--font-size-sm);
            padding: var(--sp-xs) var(--sp-sm);
            border: 1px solid var(--c-divider-strong);
            border-radius: 4px;
            background-color: var(--c-paper-bg);
            color: var(--c-text-primary);
        }

        .question-list {
            display: flex;
            flex-direction: column;
            gap: var(--sp-xl); /* Top level spacing */
        }

        .question-node {
            display: flex;
            flex-direction: column;
            /* No card styles */
        }
        
        /* Anchor for scroll jumps */
        .scroll-anchor {
            scroll-margin-top: 100px;
        }

        /* Header for sections in content (if present) */
        .content-section-header {
            font-size: var(--font-size-md);
            font-weight: var(--font-weight-bold);
            color: var(--c-text-secondary);
            margin-bottom: var(--sp-md);
            border-bottom: 1px solid var(--c-divider);
            padding-bottom: var(--sp-xs);
        }

        /* Question Body */
        .question-body {
            margin-bottom: var(--sp-md);
        }

        .question-identifier {
            font-weight: var(--font-weight-bold);
            color: var(--c-text-secondary);
            margin-right: var(--sp-sm);
            float: left; /* Inline with first line of prompt */
        }

        .question-prompt {
            color: var(--c-text-primary);
            /* Markdown content styles applied via general rules below */
        }

        /* Solution Block */
        .solution-block {
            display: flex;
            flex-direction: column;
            gap: var(--sp-sm);
        }

        .sb-separator {
            /* Minimal spacing provided by flex gap, optional hairline if dense */
        }

        /* Answer */
        .answer-region {
            margin-bottom: var(--sp-xs);
        }
        
        .answer-label {
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-bold);
            color: var(--c-text-secondary);
            display: block;
            margin-bottom: var(--sp-xs);
        }

        .answer-content {
            /* Inherits body font */
            font-weight: var(--font-weight-medium);
        }

        /* Disclosure Control */
        .disclosure-control {
            display: flex;
            align-items: center;
            gap: var(--sp-xs);
            font-size: var(--font-size-sm);
            color: var(--c-accent);
            font-weight: var(--font-weight-medium);
            margin-top: var(--sp-sm);
            user-select: none;
            width: fit-content;
        }
        
        .disclosure-icon {
            width: 16px;
            height: 16px;
            transition: transform 0.2s ease;
        }
        
        .disclosure-control[aria-expanded="true"] .disclosure-icon {
            transform: rotate(180deg);
        }

        /* Solution Details Region */
        .solution-details {
            margin-top: var(--sp-sm);
            padding: var(--sp-md);
            background-color: var(--c-solution-wash); /* Surface Differentiation */
            /* No borders, no radius per strict paper intent */
            display: none; /* Hidden by default via class toggle */
        }
        
        .solution-details.expanded {
            display: block;
            animation: reveal 0.2s ease-out;
        }

        @keyframes reveal {
            from { opacity: 0; transform: translateY(-4px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Solution Details Subsections */
        .sd-subsection {
            margin-bottom: var(--sp-md);
        }
        .sd-subsection:last-child {
            margin-bottom: 0;
        }

        .sd-label {
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-bold);
            color: var(--c-text-secondary);
            margin-bottom: var(--sp-xs);
            display: block;
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }

        .sd-body {
            font-size: var(--font-size-sm);
            color: var(--c-text-primary);
            /* Anti-fade guardrail: Must remain comfortably readable */
        }

        /* Children (Sub-questions) */
        .children-container {
            margin-top: var(--sp-md);
            display: flex;
            flex-direction: column;
            gap: var(--sp-md);
            /* Visual indentation via padding, adaptive */
            padding-left: var(--sp-md);
        }
        
        @media (max-width: 480px) {
            .children-container {
                padding-left: var(--sp-sm); /* Reduce indent on mobile */
            }
        }

        /* =========================================
           MARKDOWN & KATEX CONTENT STYLES
           ========================================= */
        /* Basic Markdown Reset within content areas */
        .md-content p {
            margin-top: 0;
            margin-bottom: var(--sp-sm);
        }
        .md-content p:last-child {
            margin-bottom: 0;
        }
        .md-content ul, .md-content ol {
            padding-left: 1.25rem;
            margin-bottom: var(--sp-sm);
        }
        .md-content table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: var(--sp-sm);
            font-size: var(--font-size-sm);
        }
        .md-content th, .md-content td {
            border: 1px solid var(--c-divider);
            padding: var(--sp-xs) var(--sp-sm);
            text-align: left;
        }
        .md-content th {
            font-weight: var(--font-weight-bold);
        }
        
        /* KaTeX Overflow Protection (Stage 3 Locked) */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding: var(--sp-xs) 0;
            /* Scrollbar hiding for clean look, functional */
            scrollbar-width: thin;
            scrollbar-color: var(--c-divider-strong) transparent;
        }
        
        /* Block math underlay allowed by Stage 5.8.3? 
           Only "subtle differentiation". 
           Stage 6.0.4 clarification: "Mixed prose + math: subtle differentiation for block-level math only" 
           Let's apply very subtle background to block math if needed, but strict paper intent prefers whitespace.
           We will leave transparent for now unless "math callout" logic is strictly required. 
           Stage 5.8.4 says Inline KaTeX must be transparent.
        */

        img, svg {
            max-width: 100%;
            height: auto;
        }

        /* =========================================
           MOBILE DRAWER
           ========================================= */
        .drawer-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0,0,0,0.5); /* Scrim */
            z-index: 50;
            display: none;
        }
        
        .drawer {
            position: fixed;
            top: 0; bottom: 0; left: 0;
            width: 85%;
            max-width: 320px;
            background-color: var(--c-page-bg);
            z-index: 51;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 12px rgba(0,0,0,0.1);
        }
        
        .drawer.open {
            transform: translateX(0);
        }
        
        .drawer-overlay.open {
            display: block;
        }

        .drawer-header {
            padding: var(--sp-md);
            border-bottom: 1px solid var(--c-divider);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .drawer-title {
            font-weight: var(--font-weight-bold);
            font-size: var(--font-size-md);
        }
        
        .drawer-close {
            font-size: 1.5rem;
            line-height: 1;
            padding: var(--sp-xs);
        }

        .drawer-content {
            flex: 1;
            overflow-y: auto;
            padding: var(--sp-md);
        }

        /* =========================================
           UTILITIES
           ========================================= */
        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        .text-error {
            color: var(--c-text-primary);
            font-weight: var(--font-weight-bold);
            text-align: center;
            padding: var(--sp-xl);
        }

    </style>
</head>
<body>

<div id="app" class="app-container">
    <!-- Top Controls -->
    <header class="top-controls">
        <div class="top-controls-inner">
            <select id="paper-selector" class="paper-selector" aria-label="Select paper">
                <!-- Options populated by JS -->
            </select>
            
            <button id="mobile-jump-trigger" class="mobile-jump-trigger" aria-label="Jump to question">
                <span style="font-weight: var(--font-weight-bold); font-size: var(--font-size-sm); color: var(--c-accent);">Jump to</span>
            </button>
        </div>
    </header>

    <!-- Main Shell -->
    <main class="document-frame-shell">
        <!-- Navigation Rail (Desktop) -->
        <nav class="nav-rail hide-scrollbar" aria-label="Document navigation">
            <div id="desktop-nav-content">
                <!-- Nav items populated by JS -->
            </div>
        </nav>

        <!-- Paper Column -->
        <div class="paper-column">
            <div id="paper-content" class="question-list">
                <!-- Content populated by JS -->
            </div>
        </div>
    </main>

    <!-- Mobile Drawer -->
    <div id="drawer-overlay" class="drawer-overlay"></div>
    <div id="drawer" class="drawer" aria-modal="true" role="dialog" aria-label="Navigation">
        <div class="drawer-header">
            <span class="drawer-title">Jump to</span>
            <button id="drawer-close" class="drawer-close" aria-label="Close navigation">&times;</button>
        </div>
        <div id="drawer-nav-content" class="drawer-content">
            <!-- Mobile nav items populated by JS -->
        </div>
    </div>
</div>

<script>
    /**
     * STAGE 0: CONSTANTS
     */
    const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
    const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

    /**
     * APP STATE
     */
    const state = {
        papers: [],
        currentPaperKey: null,
        expandedMap: {}, // Key: questionId, Value: boolean
        navOpen: false
    };

    /**
     * MARKDOWN RENDERER CONFIGURATION (Stage 6 Baseline)
     */
    let md = null;
    if (window.markdownit) {
        md = window.markdownit({
            html: true,     // Enable HTML for inline SVG
            linkify: true,
            breaks: false   // MUST be false to prevent <br> in math
        });
        // Disable escape rule to preserve TeX backslashes
        md.inline.ruler.disable(['escape']);
    }

    /**
     * INITIALIZATION
     */
    async function init() {
        try {
            const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
            if (!response.ok) throw new Error("Payload missing");
            const payload = await response.json();
            
            if (!payload.papers || payload.papers.length === 0) throw new Error("No papers");
            
            state.papers = payload.papers;
            
            // Set initial paper
            state.currentPaperKey = state.papers[0].key;
            
            // Initial Render
            renderApp();
            
        } catch (e) {
            console.error(e);
            document.getElementById('paper-content').innerHTML = `
                <div class="text-error">PAPERS PAYLOAD MISSING</div>
            `;
        }
    }

    /**
     * RENDERING
     */
    function renderApp() {
        renderPaperSelector();
        const currentPaper = state.papers.find(p => p.key === state.currentPaperKey);
        if (currentPaper) {
            initPaperState(currentPaper);
            renderNav(currentPaper);
            renderPaperContent(currentPaper);
        }
    }

    function initPaperState(paper) {
        // Initialize expanded map based on defaults if not already set for this paper
        // If switching back to a paper, we usually want to preserve state, 
        // but for simplicity in this prototype, we reset or preserve loosely.
        // Let's preserve if exists, else init.
        // Actually, "Switching papers must hide/show content and rebuild navigation... must NOT auto-expand beyond defaults"
        // We will simple check if we have data, if not, set defaults.
        
        // Flatten questions to find all IDs with solutionDetails
        const nodes = flattenQuestions(paper);
        const shouldExpandAll = paper.defaults?.expandedAll !== false;

        nodes.forEach(node => {
            if (node.solutionBlock?.solutionDetails) {
                if (!(node.id in state.expandedMap)) {
                    state.expandedMap[node.id] = shouldExpandAll;
                }
            }
        });
    }

    function flattenQuestions(paper) {
        const list = [];
        const recurse = (qs) => {
            qs.forEach(q => {
                list.push(q);
                if (q.children) recurse(q.children);
            });
        };

        if (paper.sections) {
            paper.sections.forEach(s => recurse(s.questions));
        } else if (paper.questions) {
            recurse(paper.questions);
        }
        return list;
    }

    function renderPaperSelector() {
        const select = document.getElementById('paper-selector');
        select.innerHTML = state.papers.map(p => 
            `<option value="${p.key}" ${p.key === state.currentPaperKey ? 'selected' : ''}>${p.label}</option>`
        ).join('');
        
        select.onchange = (e) => {
            state.currentPaperKey = e.target.value;
            // Clear expanded map for new paper to reset to defaults (or keep per session? spec implies "switching ... must not auto-expand")
            // A simple approach is to clear map so defaults re-apply.
            state.expandedMap = {};
            renderApp();
            window.scrollTo(0, 0);
        };
    }

    function renderNav(paper) {
        const desktopNav = document.getElementById('desktop-nav-content');
        const mobileNav = document.getElementById('drawer-nav-content');
        
        const html = generateNavHTML(paper);
        
        desktopNav.innerHTML = `<ul class="nav-list">${html}</ul>`;
        mobileNav.innerHTML = `<ul class="nav-list">${html}</ul>`;
        
        // Setup click handlers
        const handleNavClick = (e) => {
            const targetId = e.currentTarget.getAttribute('data-target');
            const el = document.getElementById(`q-${targetId}`);
            if (el) {
                // Smooth scroll
                el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                // Set active state visually (simple implementation)
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                document.querySelectorAll(`.nav-item[data-target="${targetId}"]`).forEach(n => n.classList.add('active'));
                
                // Close drawer if open
                closeDrawer();
            }
        };

        document.querySelectorAll('.nav-item').forEach(btn => {
            btn.onclick = handleNavClick;
        });
    }

    function generateNavHTML(paper) {
        let html = '';
        
        if (paper.sections) {
            paper.sections.forEach(section => {
                // Section Label
                if (section.label && section.label.trim().length > 0) {
                    html += `<li class="nav-section-label">${section.label}</li>`;
                }
                // Questions
                html += generateNavItemsRecursive(section.questions, 0);
            });
        } else {
            html += generateNavItemsRecursive(paper.questions, 0);
        }
        return html;
    }

    function generateNavItemsRecursive(questions, depth) {
        let html = '';
        questions.forEach(q => {
            html += `<li>
                <button class="nav-item" data-target="${q.id}" data-depth="${depth}">
                    ${q.id}
                </button>
            </li>`;
            if (q.children && q.children.length > 0) {
                html += generateNavItemsRecursive(q.children, depth + 1);
            }
        });
        return html;
    }

    function renderPaperContent(paper) {
        const container = document.getElementById('paper-content');
        let html = '';
        
        if (paper.sections) {
            paper.sections.forEach(section => {
                if (section.label && section.label.trim().length > 0) {
                    html += `<div class="content-section-header">${section.label}</div>`;
                }
                html += renderQuestionList(section.questions);
                // Separator between sections handled by margin
            });
        } else {
            html += renderQuestionList(paper.questions);
        }
        
        container.innerHTML = html;
        
        // Hydrate interactivity
        hydrateDisclosureControls();
        
        // Render Math
        if (window.renderMathInElement) {
            window.renderMathInElement(container, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false}
                ],
                throwOnError: false
            });
        }
    }

    function renderQuestionList(questions) {
        return questions.map(q => renderQuestionNode(q, 0)).join('');
    }

    function renderQuestionNode(node, depth) {
        // Safe check for solution block existence
        const hasSolutionBlock = !!node.solutionBlock;
        const answer = node.solutionBlock?.answer;
        const details = node.solutionBlock?.solutionDetails;
        const hasDetails = !!details;
        const isExpanded = state.expandedMap[node.id] || false;
        
        // Classes
        // Top level questions get extra spacing
        const wrapperClass = depth === 0 ? 'question-node scroll-anchor' : 'question-node scroll-anchor';
        // Add specific spacing for top level vs nested?
        // Using CSS child selectors on .question-list > .question-node for top level spacing.
        
        let html = `<div id="q-${node.id}" class="${wrapperClass}">`;
        
        // 1. Question Body
        const qContent = renderMarkdown(node.question);
        html += `
            <div class="question-body md-content">
                <span class="question-identifier">${node.id}</span>
                <div class="question-prompt">${qContent}</div>
            </div>
        `;
        
        // 2. Solution Block (Optional)
        if (hasSolutionBlock) {
            html += `<div class="solution-block">`;
            
            // Answer (Optional)
            if (answer) {
                html += `
                    <div class="answer-region">
                        <span class="answer-label">Answer</span>
                        <div class="answer-content md-content">${renderMarkdown(answer)}</div>
                    </div>
                `;
            }
            
            // Solution Details Toggle (Only if details exist)
            if (hasDetails) {
                const buttonText = isExpanded ? "Hide working" : "Show working";
                const expandedAttr = isExpanded ? "true" : "false";
                const detailsClass = isExpanded ? "solution-details expanded" : "solution-details";
                
                html += `
                    <button class="disclosure-control" aria-expanded="${expandedAttr}" data-id="${node.id}">
                        <span>${buttonText}</span>
                        <svg class="disclosure-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                    </button>
                    
                    <div class="${detailsClass}" id="details-${node.id}">
                `;
                
                // Keep In Mind
                if (details.keepInMind) {
                    html += `
                        <div class="sd-subsection">
                            <span class="sd-label">Keep in mind</span>
                            <div class="sd-body md-content">${renderMarkdown(details.keepInMind)}</div>
                        </div>
                    `;
                }
                
                // Formulas Used
                if (details.formulasUsed) {
                    html += `
                        <div class="sd-subsection">
                            <span class="sd-label">Formulas used</span>
                            <div class="sd-body md-content">${renderMarkdown(details.formulasUsed)}</div>
                        </div>
                    `;
                }
                
                // Working
                if (details.working) {
                    html += `
                        <div class="sd-subsection">
                            <span class="sd-label">Working</span>
                            <div class="sd-body md-content">${renderMarkdown(details.working)}</div>
                        </div>
                    `;
                }
                
                // Alternative Working (Array)
                if (details.alternativeWorking && Array.isArray(details.alternativeWorking)) {
                    details.alternativeWorking.forEach((alt, idx) => {
                        html += `
                            <div class="sd-subsection">
                                <span class="sd-label">Alternative working</span>
                                <div class="sd-body md-content">${renderMarkdown(alt)}</div>
                            </div>
                        `;
                    });
                }
                
                html += `</div>`; // End solution-details
            }
            
            html += `</div>`; // End solution-block
        }
        
        // 3. Children
        if (node.children && node.children.length > 0) {
            html += `<div class="children-container">`;
            node.children.forEach(child => {
                html += renderQuestionNode(child, depth + 1);
            });
            html += `</div>`;
        }
        
        html += `</div>`; // End wrapper
        return html;
    }

    function renderMarkdown(text) {
        if (!text) return '';
        if (md) return md.render(text);
        return text; // Fallback
    }

    function hydrateDisclosureControls() {
        document.querySelectorAll('.disclosure-control').forEach(btn => {
            btn.onclick = (e) => {
                // Prevent bubbling issues
                e.stopPropagation();
                
                const id = btn.getAttribute('data-id');
                const isExpanded = state.expandedMap[id];
                const newState = !isExpanded;
                state.expandedMap[id] = newState;
                
                // Update DOM directly to avoid full re-render & scroll jump
                const detailsEl = document.getElementById(`details-${id}`);
                const textSpan = btn.querySelector('span');
                
                if (newState) {
                    detailsEl.classList.add('expanded');
                    btn.setAttribute('aria-expanded', 'true');
                    textSpan.textContent = "Hide working";
                } else {
                    detailsEl.classList.remove('expanded');
                    btn.setAttribute('aria-expanded', 'false');
                    textSpan.textContent = "Show working";
                }
            };
        });
    }

    /**
     * DRAWER LOGIC
     */
    const drawer = document.getElementById('drawer');
    const overlay = document.getElementById('drawer-overlay');
    const jumpTrigger = document.getElementById('mobile-jump-trigger');
    const closeTrigger = document.getElementById('drawer-close');

    function openDrawer() {
        drawer.classList.add('open');
        overlay.classList.add('open');
        state.navOpen = true;
    }

    function closeDrawer() {
        drawer.classList.remove('open');
        overlay.classList.remove('open');
        state.navOpen = false;
    }

    jumpTrigger.onclick = openDrawer;
    closeTrigger.onclick = closeDrawer;
    overlay.onclick = closeDrawer;

    // Start
    init();

</script>
</body>
</html>
