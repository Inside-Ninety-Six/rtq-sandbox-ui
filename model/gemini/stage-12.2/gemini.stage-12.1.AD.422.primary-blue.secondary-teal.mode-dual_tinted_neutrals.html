<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AD","indexWithinVariant":"422","totalWithinVariant":"440","hueFamily":"","intensityMode":"","primaryHueFamily":"blue","secondaryHueFamily":"teal","dualIntensityMode":"dual_tinted_neutrals","timestamp":"2026-01-11T01:16:56.180Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AD&quot;,&quot;indexWithinVariant&quot;:&quot;422&quot;,&quot;totalWithinVariant&quot;:&quot;440&quot;,&quot;hueFamily&quot;:&quot;&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;primaryHueFamily&quot;:&quot;blue&quot;,&quot;secondaryHueFamily&quot;:&quot;teal&quot;,&quot;dualIntensityMode&quot;:&quot;dual_tinted_neutrals&quot;,&quot;timestamp&quot;:&quot;2026-01-11T01:16:56.180Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Viewer (Prototype)</title>

    <!-- Tailwind CSS (Prototype Mode) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- KaTeX CSS (No integrity) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- Markdown-it (No integrity) -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>
    
    <!-- KaTeX JS (No integrity) -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <script>
        // --- STAGE 0 CONSTANTS & CONFIG ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // --- COLORLAB D CONFIG (Fallback Applied: Blue/Amber) ---
        // Mode: dual_tinted_neutrals
        // Primary Hue: Blue (approx 260)
        // Secondary Hue: Amber (approx 85)
        
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        // OKLCH Palette Definition
                        // Surfaces (Tinted Blue)
                        page: 'oklch(0.97 0.02 260)',
                        frame: 'oklch(0.95 0.03 260)', 
                        paper: 'oklch(0.99 0.015 260)',
                        wash: 'oklch(0.96 0.03 260)',

                        // Text (Near Neutral)
                        primary: 'oklch(0.20 0.01 260)',
                        secondary: 'oklch(0.45 0.01 260)',
                        tertiary: 'oklch(0.60 0.01 260)', // Nav inactive

                        // Accents
                        accent: {
                            DEFAULT: 'oklch(0.55 0.14 260)', // Primary (Blue)
                            hover: 'oklch(0.45 0.14 260)',
                            focus: 'oklch(0.55 0.14 260)',
                        },
                        supp: {
                            DEFAULT: 'oklch(0.65 0.14 85)', // Secondary (Amber) - Used for specific cues
                        },
                        
                        // Dividers
                        border: {
                            DEFAULT: 'oklch(0.90 0.02 260)',
                            subtle: 'oklch(0.94 0.015 260)',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Base Reset & Typography */
        body {
            background-color: theme('colors.page');
            color: theme('colors.primary');
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            overflow-y: scroll; /* Force vertical scrollbar to prevent layout shift */
        }

        /* Focus Styles (ColorLab D - Primary Accent) */
        :focus-visible {
            outline: 2px solid theme('colors.accent.focus');
            outline-offset: 2px;
        }

        /* Nav Scrollbar Hiding */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* KaTeX & Math Containment Invariants */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            padding-bottom: 0.5rem; /* Space for scrollbar if needed */
            max-width: 100%;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Prevent layout widening from math */
        .math-block-wrapper {
            max-width: 100%;
            overflow-x: auto;
        }

        /* Table Styling (Minimal/Structural) */
        .md-table table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
            font-size: 0.95em;
        }
        .md-table th {
            text-align: left;
            font-weight: 600;
            padding: 0.5rem;
            border-bottom: 1px solid theme('colors.border.DEFAULT');
        }
        .md-table td {
            padding: 0.5rem;
            border-bottom: 1px solid theme('colors.border.subtle');
            vertical-align: top;
        }
        .md-table-wrapper {
            overflow-x: auto;
            max-width: 100%;
        }

        /* Utility: Text Balance */
        .text-balance {
            text-wrap: balance;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center">

    <!-- Top Controls Region -->
    <div class="w-full max-w-7xl mx-auto px-4 md:px-8 py-4 flex items-center justify-between z-10 sticky top-0 bg-page/95 backdrop-blur-sm md:static md:bg-transparent">
        <div class="flex items-center gap-4">
            <!-- Paper Selector -->
            <select id="paper-selector" class="bg-paper border border-border/50 text-primary text-sm rounded-md px-3 py-2 shadow-sm focus:border-accent hover:border-accent/50 transition-colors cursor-pointer min-w-[200px]">
                <option disabled selected>Loading papers...</option>
            </select>
        </div>

        <!-- Mobile "Jump to" Trigger -->
        <button id="mobile-nav-trigger" class="md:hidden text-sm font-medium text-accent hover:text-accent-hover flex items-center gap-1">
            Jump to
            <span class="sr-only">Open navigation</span>
        </button>
    </div>

    <!-- DocumentFrameShell -->
    <main class="w-full max-w-7xl mx-auto flex flex-col md:flex-row flex-1 relative bg-frame/30 md:bg-frame min-h-[calc(100vh-80px)] md:rounded-t-xl overflow-hidden border-x border-t border-border/0 md:border-border/40 shadow-sm">
        
        <!-- Navigation Rail (Desktop) -->
        <aside class="hidden md:block w-64 flex-shrink-0 sticky top-0 h-[calc(100vh-2rem)] pt-6 pl-8 pr-4 overflow-y-auto no-scrollbar border-r border-border/40">
            <nav aria-label="Paper navigation" id="desktop-nav" class="pb-12">
                <!-- Nav items injected here -->
            </nav>
        </aside>

        <!-- Paper Content Column -->
        <section class="flex-1 min-w-0 bg-paper relative">
            <div id="paper-content" class="px-4 py-8 md:px-12 md:py-10 max-w-3xl mx-auto min-h-[500px]">
                <!-- Content injected here -->
                <div class="animate-pulse space-y-4 pt-10">
                    <div class="h-4 bg-border/30 rounded w-3/4"></div>
                    <div class="h-4 bg-border/30 rounded w-1/2"></div>
                </div>
            </div>
        </section>

    </main>

    <!-- Mobile Navigation Drawer -->
    <div id="mobile-drawer-backdrop" class="fixed inset-0 bg-black/20 z-40 hidden transition-opacity opacity-0" aria-hidden="true"></div>
    <div id="mobile-drawer" class="fixed inset-y-0 right-0 w-64 bg-paper z-50 transform translate-x-full transition-transform duration-300 ease-out shadow-xl flex flex-col" aria-modal="true" role="dialog">
        <div class="p-4 border-b border-border/50 flex justify-between items-center bg-frame/50">
            <h2 class="text-sm font-semibold text-secondary">Jump to</h2>
            <button id="close-drawer" class="text-secondary hover:text-primary p-2">
                <span class="sr-only">Close</span>
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <nav id="mobile-nav-list" class="flex-1 overflow-y-auto p-4 space-y-1">
            <!-- Mobile nav items injected here -->
        </nav>
    </div>

    <!-- JS Application Logic -->
    <script>
        // --- Markdown Renderer Setup (Authoritative) ---
        const md = window.markdownit ? window.markdownit({
            html: true,     // Inline SVG passthrough
            linkify: true,
            breaks: false   // STRICT: Prevents <br> in math blocks
        }) : null;

        if (md) {
            // Disable escaping of TeX backslashes
            md.inline.ruler.disable(['escape']);
        }

        // --- State ---
        let state = {
            papers: [],
            activePaper: null,
            expandedWorkings: new Set(), // Set of Question IDs
            isMobileDrawerOpen: false
        };

        // --- Elements ---
        const els = {
            selector: document.getElementById('paper-selector'),
            content: document.getElementById('paper-content'),
            desktopNav: document.getElementById('desktop-nav'),
            mobileNavTrigger: document.getElementById('mobile-nav-trigger'),
            mobileDrawer: document.getElementById('mobile-drawer'),
            mobileDrawerBackdrop: document.getElementById('mobile-drawer-backdrop'),
            closeDrawer: document.getElementById('close-drawer'),
            mobileNavList: document.getElementById('mobile-nav-list')
        };

        // --- Core Functions ---

        async function init() {
            try {
                // Deterministic load via Constant
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Payload not found");
                const payload = await response.json();
                
                if (!payload.papers || payload.papers.length === 0) {
                    throw new Error("No papers in payload");
                }

                state.papers = payload.papers;
                renderSelector();
                
                // Load first paper by default
                loadPaper(state.papers[0].key);

            } catch (e) {
                console.error(e);
                renderError();
            }
        }

        function renderError() {
            els.content.innerHTML = `
                <div class="flex flex-col items-center justify-center h-64 text-secondary">
                    <p class="font-medium">PAPERS PAYLOAD MISSING</p>
                    <p class="text-sm mt-2 opacity-70">Ensure payload exists at ${RTQ_PAPERS_PAYLOAD_PATH}</p>
                </div>
            `;
            els.selector.innerHTML = '<option disabled>Error loading papers</option>';
        }

        function renderSelector() {
            els.selector.innerHTML = state.papers.map(p => 
                `<option value="${p.key}">${p.label}</option>`
            ).join('');

            els.selector.addEventListener('change', (e) => {
                loadPaper(e.target.value);
            });
        }

        function loadPaper(key) {
            const paper = state.papers.find(p => p.key === key);
            if (!paper) return;

            state.activePaper = paper;
            
            // Reset state based on paper defaults
            state.expandedWorkings.clear();
            const defaults = paper.defaults || {};
            const expandAll = defaults.expandedAll !== false; // Default true unless explicitly false

            if (expandAll) {
                // We'll calculate which IDs to add during render traversal if needed, 
                // but for simple logic we can just check the flag in the renderer.
                // However, interaction requires ID tracking. 
                // Let's rely on a specific "isExpanded" check that defaults to `expandAll` 
                // unless the ID is explicitly toggled off (or vice versa).
                // Simpler: Pre-populate or use a hybrid check. 
                // Hybrid: state.expandedWorkings tracks EXCEPTIONS if we assume default, 
                // or tracks STATE if we assume explicitly.
                // Decision: Track explicit state. Walk tree to populate if default is true.
                const collectIds = (nodes) => {
                    nodes.forEach(n => {
                        if (n.solutionBlock?.solutionDetails) {
                            state.expandedWorkings.add(n.id);
                        }
                        if (n.children) collectIds(n.children);
                    });
                };
                
                const rootNodes = paper.questions || (paper.sections ? paper.sections.flatMap(s => s.questions) : []);
                collectIds(rootNodes);
            }

            renderPaper();
            renderNavigation();
            
            // Reset scroll
            window.scrollTo(0, 0);
            els.desktopNav.scrollTop = 0;
        }

        function renderPaper() {
            const p = state.activePaper;
            let html = '';

            // Optional Section Headers or Flat List
            if (p.sections) {
                p.sections.forEach(sec => {
                    // Render Section Header if label exists
                    if (sec.label && sec.label.trim().length > 0) {
                        html += `
                            <div class="mb-6 mt-10 first:mt-0 border-b border-border pb-2">
                                <h2 class="text-lg font-semibold text-secondary">${sec.label}</h2>
                            </div>
                        `;
                    }
                    html += renderQuestionList(sec.questions);
                });
            } else if (p.questions) {
                html += renderQuestionList(p.questions);
            }

            els.content.innerHTML = html;

            // Trigger KaTeX
            renderMathInElement(els.content, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false}
                ],
                throwOnError: false
            });

            // Re-bind listeners
            bindInteractions();
        }

        function renderQuestionList(questions) {
            return `<div class="space-y-12">
                ${questions.map(q => renderQuestionNode(q)).join('')}
            </div>`;
        }

        function renderQuestionNode(node, depth = 0) {
            const hasSolutionBlock = !!node.solutionBlock;
            const hasAnswer = hasSolutionBlock && !!node.solutionBlock.answer;
            const hasDetails = hasSolutionBlock && !!node.solutionBlock.solutionDetails;
            const isExpanded = state.expandedWorkings.has(node.id);

            // Indentation logic: Stage 3 says "Children container ... Vertical separation ... Horizontal indentation (optional spacing only)"
            // Using padding-left for children.
            // Note: Top level depth=0. 
            
            const indentClass = depth > 0 ? 'pl-4 md:pl-8 border-l-2 border-transparent hover:border-border/30 transition-colors' : '';
            const spacingClass = depth > 0 ? 'mt-6' : ''; // Tighter for children

            let html = `
                <div id="q-${node.id}" class="group/node ${indentClass} ${spacingClass} scroll-mt-24">
                    <!-- Question Body -->
                    <div class="mb-4">
                        <div class="flex gap-3">
                            <span class="flex-shrink-0 font-medium text-secondary text-base select-none w-8 md:w-10 pt-[2px]" aria-hidden="true">${node.id}</span>
                            <div class="flex-1 min-w-0">
                                <div class="prose prose-neutral max-w-none text-primary text-base/relaxed md-render">
                                    ${safeMd(node.question)}
                                </div>
                            </div>
                        </div>
                    </div>
            `;

            if (hasSolutionBlock) {
                html += `<div class="ml-8 md:ml-10 space-y-4">`;

                // Answer (Visible by default if present)
                if (hasAnswer) {
                    html += `
                        <div class="relative">
                            <dt class="text-xs font-bold text-secondary uppercase tracking-wider mb-1">Answer</dt>
                            <dd class="text-primary font-medium md-render">${safeMd(node.solutionBlock.answer)}</dd>
                        </div>
                    `;
                }

                // Solution Details
                if (hasDetails) {
                    const details = node.solutionBlock.solutionDetails;
                    const btnText = isExpanded ? 'Hide working' : 'Show working';
                    
                    html += `
                        <div class="pt-1">
                            <button 
                                type="button" 
                                data-action="toggle-working" 
                                data-id="${node.id}"
                                class="text-sm font-medium text-accent hover:text-accent-hover focus:outline-none focus-visible transition-colors flex items-center gap-1 group/btn"
                                aria-expanded="${isExpanded}"
                            >
                                <span>${btnText}</span>
                                <svg class="w-4 h-4 transform transition-transform ${isExpanded ? 'rotate-180' : ''}" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                </svg>
                            </button>

                            <div class="${isExpanded ? 'block' : 'hidden'} mt-3 animate-in fade-in slide-in-from-top-1 duration-200">
                                <div class="bg-wash rounded-sm p-4 md:p-5 border-l-2 border-accent/20 text-sm space-y-5">
                                    
                                    ${renderDetailsSection(details.keepInMind, 'Keep in mind', 'supp')}
                                    ${renderDetailsSection(details.formulasUsed, 'Formulas used', 'secondary')}
                                    ${renderDetailsSection(details.working, 'Working', 'secondary')}
                                    
                                    ${details.alternativeWorking && details.alternativeWorking.length > 0 ? 
                                        details.alternativeWorking.map((aw, idx) => 
                                            renderDetailsSection(aw, 'Alternative working', 'secondary')
                                        ).join('') : ''
                                    }

                                </div>
                            </div>
                        </div>
                    `;
                }

                html += `</div>`; // End Solution Block Wrapper
            }

            // Recursion for Children
            if (node.children && node.children.length > 0) {
                html += `<div class="mt-6">
                    ${node.children.map(child => renderQuestionNode(child, depth + 1)).join('')}
                </div>`;
            }

            html += `</div>`; // End Node
            return html;
        }

        function renderDetailsSection(content, label, labelColorRole = 'secondary') {
            if (!content) return '';
            const labelClass = label === 'Keep in mind' ? 'text-accent font-semibold' : 'text-secondary font-semibold';
            
            return `
                <div>
                    <h4 class="${labelClass} text-xs uppercase tracking-wide mb-2 select-none">${label}</h4>
                    <div class="prose prose-sm max-w-none text-primary/90 md-render md-table">
                        ${safeMd(content)}
                    </div>
                </div>
            `;
        }

        // Markdown safe render wrapper
        function safeMd(raw) {
            if (!raw) return '';
            if (!md) return raw; // Fallback to raw text if no MD renderer
            return md.render(raw);
        }

        // --- Navigation Builder ---

        function renderNavigation() {
            const p = state.activePaper;
            let navHtml = '';

            const renderItem = (q, depth) => {
                // Flat list, hierarchy via type scale/opacity
                const isSub = depth > 0;
                // Type scale: Top level normal, subs smaller/lighter
                const classes = isSub 
                    ? "text-xs text-secondary py-1" 
                    : "text-sm text-primary font-medium py-1.5 mt-1";
                
                return `
                    <a href="#q-${q.id}" 
                       data-id="${q.id}"
                       class="block ${classes} hover:text-accent transition-colors pl-0 border-l-2 border-transparent hover:border-accent/30 focus:outline-none focus-visible -ml-px"
                    >
                       ${q.id}
                    </a>
                `;
            };

            const traverse = (nodes, depth) => {
                let out = '';
                nodes.forEach(n => {
                    out += renderItem(n, depth);
                    if (n.children) out += traverse(n.children, depth + 1);
                });
                return out;
            };

            if (p.sections) {
                p.sections.forEach(sec => {
                    if (sec.label && sec.label.trim().length > 0) {
                        navHtml += `
                            <div class="mb-2 mt-4 first:mt-0">
                                <span class="text-[10px] font-bold text-tertiary uppercase tracking-wider block mb-1 select-none">${sec.label}</span>
                                ${traverse(sec.questions, 0)}
                            </div>
                        `;
                    } else {
                        // Section without label, just dump items
                        navHtml += traverse(sec.questions, 0);
                        navHtml += `<div class="h-4"></div>`; // Spacing between implicit sections
                    }
                });
            } else if (p.questions) {
                navHtml += traverse(p.questions, 0);
            }

            els.desktopNav.innerHTML = navHtml;
            els.mobileNavList.innerHTML = navHtml; // Re-use html for mobile
            
            updateActiveNav();
        }

        // --- Interactions ---

        function bindInteractions() {
            // Event delegation for Show/Hide working
            els.content.onclick = (e) => {
                const btn = e.target.closest('button[data-action="toggle-working"]');
                if (btn) {
                    const id = btn.dataset.id;
                    if (state.expandedWorkings.has(id)) {
                        state.expandedWorkings.delete(id);
                    } else {
                        state.expandedWorkings.add(id);
                    }
                    // Re-render ONLY the specific node would be optimal, but full re-render is safer for prototype simplicity 
                    // provided scroll stability is maintained. 
                    // To keep scroll stable, we should ideally just toggle DOM, but generating HTML is easiest.
                    // Let's settle for full re-render and restore scroll? 
                    // No, that jumps. Let's do DOM manipulation for toggling.
                    
                    toggleDomNode(id, btn);
                }
            };
        }

        function toggleDomNode(id, btn) {
            const isNowExpanded = state.expandedWorkings.has(id);
            
            // Update Button Text & Icon
            const textSpan = btn.querySelector('span');
            const icon = btn.querySelector('svg');
            
            textSpan.textContent = isNowExpanded ? 'Hide working' : 'Show working';
            btn.setAttribute('aria-expanded', isNowExpanded);
            
            if (isNowExpanded) {
                icon.classList.add('rotate-180');
            } else {
                icon.classList.remove('rotate-180');
            }

            // Find the panel
            const panel = btn.nextElementSibling;
            if (panel) {
                if (isNowExpanded) {
                    panel.classList.remove('hidden');
                } else {
                    panel.classList.add('hidden');
                }
            }
        }

        // --- Scroll Spy / Active Nav ---
        // Simple IntersectionObserver for active state
        
        function updateActiveNav() {
            // Using IntersectionObserver to detect which question is in view
            // This is a nicety, not strict req, but helps orientation
            
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const id = entry.target.id.replace('q-', '');
                        highlightNav(id);
                    }
                });
            }, { rootMargin: '-10% 0px -80% 0px' });

            const nodes = document.querySelectorAll('[id^="q-"]');
            nodes.forEach(n => observer.observe(n));
        }

        function highlightNav(id) {
            // Remove active from all
            const allLinks = document.querySelectorAll('nav a');
            allLinks.forEach(l => {
                l.classList.remove('text-accent', 'font-bold', 'border-accent');
                l.classList.add('border-transparent');
                // restore base colors based on depth logic? 
                // Hard to restore exact class state without complexity. 
                // Let's just toggle the 'active' classes.
            });

            // Add active to current
            const activeLinks = document.querySelectorAll(`nav a[data-id="${id}"]`);
            activeLinks.forEach(l => {
                l.classList.add('text-accent', 'font-bold', 'border-accent');
                l.classList.remove('text-secondary', 'text-primary', 'border-transparent');
            });
        }

        // --- Mobile Drawer Logic ---
        els.mobileNavTrigger.addEventListener('click', () => {
            state.isMobileDrawerOpen = true;
            els.mobileDrawer.classList.remove('translate-x-full');
            els.mobileDrawerBackdrop.classList.remove('hidden');
            setTimeout(() => els.mobileDrawerBackdrop.classList.remove('opacity-0'), 10);
            document.body.style.overflow = 'hidden';
        });

        const closeDrawer = () => {
            state.isMobileDrawerOpen = false;
            els.mobileDrawer.classList.add('translate-x-full');
            els.mobileDrawerBackdrop.classList.add('opacity-0');
            setTimeout(() => els.mobileDrawerBackdrop.classList.add('hidden'), 300);
            document.body.style.overflow = '';
        };

        els.closeDrawer.addEventListener('click', closeDrawer);
        els.mobileDrawerBackdrop.addEventListener('click', closeDrawer);
        
        // Close drawer on nav click
        els.mobileNavList.addEventListener('click', (e) => {
            if (e.target.tagName === 'A') {
                closeDrawer();
            }
        });

        // Initialize
        init();

    </script>
</body>
</html>
