<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AD","indexWithinVariant":"102","totalWithinVariant":"440","hueFamily":"","intensityMode":"","primaryHueFamily":"blue","secondaryHueFamily":"pink","dualIntensityMode":"dual_tinted_neutrals","timestamp":"2026-01-10T06:33:15.441Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AD&quot;,&quot;indexWithinVariant&quot;:&quot;102&quot;,&quot;totalWithinVariant&quot;:&quot;440&quot;,&quot;hueFamily&quot;:&quot;&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;primaryHueFamily&quot;:&quot;blue&quot;,&quot;secondaryHueFamily&quot;:&quot;pink&quot;,&quot;dualIntensityMode&quot;:&quot;dual_tinted_neutrals&quot;,&quot;timestamp&quot;:&quot;2026-01-10T06:33:15.441Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer (Stage 6 Baseline)</title>

    <!-- 
      LIBRARIES 
      - Tailwind CSS (via CDN script for prototyping)
      - KaTeX (CSS + JS)
      - Markdown-it (JS)
      - Lucide Icons (JS)
      NO INTEGRITY ATTRIBUTES (Stage 6.0.7b)
    -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- COLORLAB D: DUAL-ACCENT PALETTE (dual_tinted_neutrals) CONFIGURATION -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    colors: {
                        // ColorLab D: dual_tinted_neutrals (Light Mode)
                        // Primary Hue: Blue (260), Secondary Hue: Amber (85)
                        page: 'oklch(0.97 0.02 260)',
                        paper: 'oklch(0.99 0.015 260)', 
                        frame: 'oklch(0.97 0.02 260)', // Matches page for seamless frame base
                        
                        txt: {
                            primary: 'oklch(0.20 0.01 260)',
                            secondary: 'oklch(0.45 0.012 260)',
                            tertiary: 'oklch(0.60 0.012 260)',
                        },

                        accent: {
                            primary: 'oklch(0.55 0.14 260)', // Link, Focus, Controls
                            secondary: 'oklch(0.70 0.12 85)', // Supplementary (Nav marker)
                        },

                        ui: {
                            wash: 'oklch(0.96 0.025 260)', // Solution Details Wash
                            divider: 'oklch(0.90 0.02 260)',
                            hover: 'oklch(0.94 0.02 260)',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* BASE & TYPOGRAPHY */
        body {
            background-color: theme('colors.page');
            color: theme('colors.txt.primary');
            /* Prevent horizontal scroll globally */
            overflow-x: hidden; 
        }

        /* KATEX CONTAINMENT INVARIANT (Stage 6.0.8) */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            /* Minimal visual containment for scrollable areas */
            padding-bottom: 4px;
            /* No background for math blocks in general, unless overflow triggers */
        }
        
        /* Inline KaTeX background rule (Stage 5.8.4) */
        .katex {
            background-color: transparent !important;
        }

        /* NAVIGATION SCROLLBAR HIDING (Stage 6.0.9) */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* FOCUS STATES (Stage 5.5.2) */
        *:focus-visible {
            outline: 2px solid theme('colors.accent.primary');
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* MARKDOWN STYLES */
        .md-content p {
            margin-bottom: 1em;
            line-height: 1.6;
        }
        .md-content p:last-child {
            margin-bottom: 0;
        }
        .md-content ul {
            list-style-type: disc;
            padding-left: 1.5em;
            margin-bottom: 1em;
        }
        .md-content ol {
            list-style-type: decimal;
            padding-left: 1.5em;
            margin-bottom: 1em;
        }
        /* Minimal tables */
        .md-content table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1em;
            font-size: 0.95em;
        }
        .md-content th, .md-content td {
            border: 1px solid theme('colors.ui.divider');
            padding: 0.5em 0.75em;
            text-align: left;
        }
        .md-content th {
            font-weight: 600;
            color: theme('colors.txt.primary');
        }

        /* DRAWER ANIMATION */
        .drawer-overlay {
            transition: opacity 0.2s ease-in-out;
        }
        .drawer-content {
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- TOP CONTROLS REGION -->
    <div id="top-controls-region" class="sticky top-0 z-30 w-full bg-page/95 backdrop-blur-sm border-b border-ui-divider">
        <div class="max-w-6xl mx-auto px-4 md:px-8 h-14 flex items-center justify-between">
            
            <!-- Paper Selector -->
            <div class="flex items-center gap-3">
                <label for="paper-select" class="text-sm font-medium text-txt-secondary sr-only">Select Paper</label>
                <select id="paper-select" class="bg-transparent text-sm font-medium text-txt-primary border border-ui-divider rounded px-2 py-1.5 focus:border-accent-primary cursor-pointer hover:border-txt-secondary transition-colors min-w-[200px]">
                    <option value="" disabled selected>Loading papers...</option>
                </select>
            </div>

            <!-- Mobile "Jump to" Trigger -->
            <button id="mobile-jump-trigger" class="md:hidden flex items-center gap-2 text-sm font-medium text-accent-primary hover:text-txt-primary transition-colors py-1.5 px-2 rounded">
                <span class="text-txt-secondary">Jump to</span>
                <i data-lucide="menu" class="w-5 h-5"></i>
            </button>
        </div>
    </div>

    <!-- DOCUMENT FRAME SHELL -->
    <div id="document-frame-shell" class="flex-1 max-w-6xl mx-auto w-full flex items-start px-0 md:px-8">
        
        <!-- NAVIGATION RAIL (Desktop) -->
        <nav id="desktop-nav" class="hidden md:block w-48 lg:w-56 sticky top-14 h-[calc(100vh-3.5rem)] overflow-y-auto no-scrollbar py-8 pr-6 border-r border-transparent">
            <!-- Nav content injected here -->
        </nav>

        <!-- PAPER DOCUMENT COLUMN -->
        <main id="paper-region" class="flex-1 w-full min-w-0 py-8 px-4 md:px-8 md:pl-12">
            <!-- Paper content injected here -->
            <div id="paper-content-container" class="space-y-16 pb-32">
                <!-- Empty State / Loading -->
                <div class="text-txt-secondary text-center mt-20">Initializing...</div>
            </div>
        </main>

    </div>

    <!-- MOBILE NAVIGATION DRAWER -->
    <div id="nav-drawer" class="fixed inset-0 z-50 hidden pointer-events-none" aria-hidden="true">
        <!-- Scrim -->
        <div id="nav-drawer-scrim" class="absolute inset-0 bg-black/20 opacity-0 drawer-overlay pointer-events-auto" onclick="closeDrawer()"></div>
        <!-- Drawer Panel -->
        <div id="nav-drawer-panel" class="absolute right-0 top-0 bottom-0 w-[80%] max-w-xs bg-paper border-l border-ui-divider shadow-xl transform translate-x-full drawer-content pointer-events-auto flex flex-col">
            <div class="flex items-center justify-between p-4 border-b border-ui-divider">
                <h2 class="text-sm font-bold text-txt-primary">Jump to</h2>
                <button onclick="closeDrawer()" class="p-2 text-txt-secondary hover:text-txt-primary rounded">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div id="drawer-nav-content" class="flex-1 overflow-y-auto p-4">
                <!-- Mobile nav items injected here -->
            </div>
        </div>
    </div>

    <!-- MAIN SCRIPT -->
    <script>
        // --- STAGE 0: CONSTANTS ---
        // Authoritative path for payload
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";

        // --- MARKDOWN SETUP (Stage 6 Add-on) ---
        const md = window.markdownit ? window.markdownit({
            html: true,       // Enable inline SVG
            linkify: true,
            breaks: false     // CRITICAL: Must be false to preserve math
        }) : null;

        if (md) {
            // Disable inline escape to preserve TeX backslashes
            md.inline.ruler.disable(['escape']);
        }

        // --- STATE ---
        let state = {
            papers: [],
            currentPaperId: null,
            currentPaper: null,
            expandedStates: {}, // Map<QuestionId, boolean>
            // Cache flattened nav items for quick access: { id, label, isSection }
            navItems: [] 
        };

        // --- DOM ELEMENTS ---
        const els = {
            paperSelect: document.getElementById('paper-select'),
            desktopNav: document.getElementById('desktop-nav'),
            mobileNav: document.getElementById('drawer-nav-content'),
            paperContainer: document.getElementById('paper-content-container'),
            drawer: document.getElementById('nav-drawer'),
            drawerScrim: document.getElementById('nav-drawer-scrim'),
            drawerPanel: document.getElementById('nav-drawer-panel'),
            mobileTrigger: document.getElementById('mobile-jump-trigger')
        };

        // --- INITIALIZATION ---
        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error('Payload missing');
                const payload = await response.json();
                
                state.papers = payload.papers || [];
                
                if (state.papers.length === 0) {
                    renderError("No papers found in payload.");
                    return;
                }

                populatePaperSelector();
                
                // Load first paper by default
                loadPaper(state.papers[0].key);

            } catch (e) {
                console.error(e);
                renderError("PAPERS PAYLOAD MISSING");
            }
        }

        function renderError(msg) {
            els.paperContainer.innerHTML = `<div class="p-8 text-center text-txt-secondary font-medium tracking-wide uppercase text-sm border border-dashed border-ui-divider rounded-lg">${msg}</div>`;
            els.paperSelect.innerHTML = `<option>Error</option>`;
            els.paperSelect.disabled = true;
        }

        // --- PAPER SELECTOR ---
        function populatePaperSelector() {
            els.paperSelect.innerHTML = state.papers.map(p => 
                `<option value="${p.key}">${p.label}</option>`
            ).join('');
            
            els.paperSelect.addEventListener('change', (e) => {
                loadPaper(e.target.value);
            });
        }

        // --- LOAD PAPER ---
        function loadPaper(paperKey) {
            const paper = state.papers.find(p => p.key === paperKey);
            if (!paper) return;

            state.currentPaper = paper;
            state.currentPaperId = paperKey;
            
            // Reset expanded states based on defaults
            state.expandedStates = {};
            // Default is expandedAll unless explicitly false
            const defaultExpanded = paper.defaults?.expandedAll !== false;
            
            // Rebuild View
            renderNavigation();
            renderPaperContent(defaultExpanded);
            
            // Initialize Icons
            lucide.createIcons();
            
            // Trigger KaTeX
            renderMathInElement(document.body, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false},
                    {left: '\\(', right: '\\)', display: false},
                    {left: '\\[', right: '\\]', display: true}
                ],
                throwOnError: false
            });

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'auto' });
        }

        // --- RENDERING HELPERS ---
        function renderMarkdown(text) {
            if (!text) return '';
            if (!md) return text; // Fallback
            return md.render(text);
        }

        // --- NAVIGATION RENDERING ---
        function renderNavigation() {
            const paper = state.currentPaper;
            let navHtml = '';
            state.navItems = [];

            // Helper to generate list items
            const generateNavItems = (questions, depth = 0) => {
                let html = '';
                questions.forEach(q => {
                    // Item HTML
                    const indentClass = ''; // Flat list per visual rules, hierarchy via type scale/weight only if needed.
                    // Stage 5.4.5: Flat list. Sub-questions quieter.
                    const isSub = depth > 0;
                    const styleClass = isSub 
                        ? "text-txt-secondary text-xs py-1" 
                        : "text-txt-primary text-sm font-medium py-1.5";
                    
                    html += `
                        <div class="nav-item-wrapper">
                            <a href="#q-${q.id}" onclick="handleNavClick(event, 'q-${q.id}')" 
                               class="block ${styleClass} hover:text-accent-primary hover:underline decoration-accent-primary/50 underline-offset-4 transition-colors truncate"
                               data-id="${q.id}">
                               ${q.id}
                            </a>
                        </div>
                    `;
                    
                    state.navItems.push({ id: q.id, elId: `q-${q.id}` });

                    if (q.children && q.children.length > 0) {
                        html += generateNavItems(q.children, depth + 1);
                    }
                });
                return html;
            };

            if (paper.sections) {
                paper.sections.forEach(section => {
                    // Section Label (only if not empty)
                    if (section.label && section.label.trim() !== '') {
                        navHtml += `
                            <div class="mt-4 mb-2 first:mt-0">
                                <span class="text-xs font-bold text-txt-tertiary uppercase tracking-wider select-none block pb-1 border-b border-ui-divider/50 w-8">
                                    ${section.label}
                                </span>
                            </div>
                        `;
                    } else if (navHtml !== '') {
                         // Spacing if no label but implies separation
                         navHtml += `<div class="h-4"></div>`;
                    }
                    navHtml += generateNavItems(section.questions);
                });
            } else if (paper.questions) {
                navHtml += generateNavItems(paper.questions);
            }

            els.desktopNav.innerHTML = navHtml;
            els.mobileNav.innerHTML = navHtml;
        }

        // --- CONTENT RENDERING ---
        function renderPaperContent(defaultExpanded) {
            const paper = state.currentPaper;
            let contentHtml = '';

            const renderQuestionNode = (q, depth = 0, parentId = null) => {
                const uniqueId = `q-${q.id}`;
                const isTopLevel = depth === 0;
                
                // Initialize expansion state if solution details exist
                const hasSolutionDetails = q.solutionBlock && q.solutionBlock.solutionDetails;
                if (hasSolutionDetails && state.expandedStates[uniqueId] === undefined) {
                    state.expandedStates[uniqueId] = defaultExpanded;
                }

                // Vertical Rhythm classes
                // Top-level: large spacing. Child: medium spacing.
                const containerClass = isTopLevel ? "mb-16 md:mb-20 scroll-mt-20" : "mt-6 md:mt-8";
                // Indentation for children (Stage 3E) - Spacing only, adaptive
                const indentClass = depth > 0 ? "pl-4 md:pl-8 border-l border-transparent" : "";

                // --- 1. Question Body ---
                let html = `
                    <div id="${uniqueId}" class="${containerClass} ${indentClass} group">
                        <!-- Question Prompt -->
                        <div class="flex gap-3 md:gap-4 items-baseline">
                            <span class="text-txt-secondary font-medium text-sm md:text-base shrink-0 select-none">${q.id}</span>
                            <div class="text-txt-primary font-medium text-base md:text-lg leading-relaxed md-content max-w-none">
                                ${renderMarkdown(q.question)}
                            </div>
                        </div>
                `;

                // --- 2. Solution Block (Optional) ---
                if (q.solutionBlock) {
                    const { answer, solutionDetails } = q.solutionBlock;
                    const hasAnswer = !!answer;
                    const hasDetails = !!solutionDetails;
                    
                    html += `<div class="ml-0 pl-0 mt-3 md:mt-4 space-y-4">`; // Wrapper for solution components

                    // --- A. Answer (Visible by default if present) ---
                    if (hasAnswer) {
                        html += `
                            <div class="flex gap-3 md:gap-4 items-baseline">
                                <span class="text-xs font-bold text-accent-secondary uppercase tracking-wider shrink-0 mt-1 select-none w-10 md:w-auto text-right md:text-left">Answer</span>
                                <div class="text-txt-primary md-content">
                                    ${renderMarkdown(answer)}
                                </div>
                            </div>
                        `;
                    }

                    // --- B. Solution Details (Expandable) ---
                    if (hasDetails) {
                        const isExpanded = state.expandedStates[uniqueId];
                        const btnText = isExpanded ? "Hide working" : "Show working";
                        const iconRot = isExpanded ? "rotate-180" : "";
                        
                        html += `
                            <div class="flex flex-col gap-2">
                                <!-- Disclosure Control -->
                                <button onclick="toggleSolution('${uniqueId}')" 
                                    class="flex items-center gap-1.5 text-sm font-medium text-accent-primary hover:text-txt-primary transition-colors w-fit group/btn focus:outline-none">
                                    <span>${btnText}</span>
                                    <i data-lucide="chevron-down" class="w-4 h-4 transition-transform duration-200 ${iconRot}"></i>
                                </button>

                                <!-- Expandable Region -->
                                <div id="details-${uniqueId}" class="${isExpanded ? 'block' : 'hidden'} origin-top">
                                    <!-- Wash Surface for Solution Details -->
                                    <div class="bg-ui-wash rounded-sm p-4 md:p-6 mt-2 text-txt-secondary text-sm md:text-base space-y-6 border border-transparent">
                                        
                                        <!-- Keep in Mind -->
                                        ${solutionDetails.keepInMind ? `
                                            <div class="space-y-2">
                                                <div class="flex items-center gap-2 text-accent-secondary font-bold text-xs uppercase tracking-wide">
                                                    <i data-lucide="lightbulb" class="w-3.5 h-3.5"></i>
                                                    <span>Keep in mind</span>
                                                </div>
                                                <div class="md-content text-txt-secondary">
                                                    ${renderMarkdown(solutionDetails.keepInMind)}
                                                </div>
                                            </div>
                                        ` : ''}

                                        <!-- Formulas Used -->
                                        ${solutionDetails.formulasUsed ? `
                                            <div class="space-y-2">
                                                <div class="text-txt-tertiary font-bold text-xs uppercase tracking-wide">Formulas used</div>
                                                <div class="md-content text-txt-secondary">
                                                    ${renderMarkdown(solutionDetails.formulasUsed)}
                                                </div>
                                            </div>
                                        ` : ''}

                                        <!-- Working (Primary) -->
                                        ${solutionDetails.working ? `
                                            <div class="space-y-2">
                                                <div class="text-txt-tertiary font-bold text-xs uppercase tracking-wide">Working</div>
                                                <div class="md-content text-txt-primary">
                                                    ${renderMarkdown(solutionDetails.working)}
                                                </div>
                                            </div>
                                        ` : ''}

                                        <!-- Alternative Working (Array) -->
                                        ${solutionDetails.alternativeWorking && solutionDetails.alternativeWorking.length > 0 ? 
                                            solutionDetails.alternativeWorking.map(alt => `
                                                <div class="pt-4 border-t border-ui-divider space-y-2">
                                                    <div class="text-txt-tertiary font-bold text-xs uppercase tracking-wide">Alternative working</div>
                                                    <div class="md-content text-txt-primary">
                                                        ${renderMarkdown(alt)}
                                                    </div>
                                                </div>
                                            `).join('') 
                                        : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    html += `</div>`; // End Solution wrapper
                }

                // --- 3. Children ---
                if (q.children && q.children.length > 0) {
                    html += `<div class="children-container">`;
                    q.children.forEach(child => {
                        html += renderQuestionNode(child, depth + 1, uniqueId);
                    });
                    html += `</div>`;
                }

                html += `</div>`; // End Node
                return html;
            };

            // Main loop
            if (paper.sections) {
                paper.sections.forEach(section => {
                    if (section.label) {
                        contentHtml += `
                            <div class="mb-12 border-b border-ui-divider pb-2">
                                <h2 class="text-lg font-bold text-txt-primary">${section.label}</h2>
                            </div>
                        `;
                    }
                    section.questions.forEach(q => contentHtml += renderQuestionNode(q));
                });
            } else if (paper.questions) {
                paper.questions.forEach(q => contentHtml += renderQuestionNode(q));
            }

            els.paperContainer.innerHTML = contentHtml;
        }

        // --- INTERACTION HANDLERS ---
        window.toggleSolution = (id) => {
            state.expandedStates[id] = !state.expandedStates[id];
            
            // Re-render only text/icon and toggle visibility to preserve scroll/math
            // Note: For prototype simplicity, we assume DOM stability. 
            // In a real app we'd bind state better. Here we manually toggle classes.
            const detailsEl = document.getElementById(`details-${id}`);
            const btnEl = detailsEl.previousElementSibling;
            const iconEl = btnEl.querySelector('i');
            const spanEl = btnEl.querySelector('span');

            const isExpanded = state.expandedStates[id];
            
            if (isExpanded) {
                detailsEl.classList.remove('hidden');
                detailsEl.classList.add('block');
                iconEl.classList.add('rotate-180');
                spanEl.textContent = "Hide working";
            } else {
                detailsEl.classList.add('hidden');
                detailsEl.classList.remove('block');
                iconEl.classList.remove('rotate-180');
                spanEl.textContent = "Show working";
            }
        };

        window.handleNavClick = (e, targetId) => {
            e.preventDefault();
            const target = document.getElementById(targetId);
            if (target) {
                // Desktop sticky nav offset calculation
                const offset = 80; // Top header height + buffer
                const bodyRect = document.body.getBoundingClientRect().top;
                const elementRect = target.getBoundingClientRect().top;
                const elementPosition = elementRect - bodyRect;
                const offsetPosition = elementPosition - offset;

                window.scrollTo({
                    top: offsetPosition,
                    behavior: "smooth"
                });

                // Update URL hash without jump
                history.pushState(null, null, `#${targetId}`);
            }
            closeDrawer();
        };

        // --- MOBILE DRAWER LOGIC ---
        els.mobileTrigger.addEventListener('click', openDrawer);

        function openDrawer() {
            els.drawer.classList.remove('hidden');
            // Trigger reflow
            void els.drawer.offsetWidth;
            els.drawerScrim.classList.remove('opacity-0');
            els.drawerPanel.classList.remove('translate-x-full');
            document.body.style.overflow = 'hidden'; // Lock body scroll
        }

        window.closeDrawer = function() {
            els.drawerScrim.classList.add('opacity-0');
            els.drawerPanel.classList.add('translate-x-full');
            setTimeout(() => {
                els.drawer.classList.add('hidden');
                document.body.style.overflow = '';
            }, 300); // Match transition duration
        };

        // --- START ---
        init();

    </script>
</body>
</html>
