<!DOCTYPE html>
<html lang="en" class="light">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AB","indexWithinVariant":"47","totalWithinVariant":"200","hueFamily":"teal","intensityMode":"","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-08T15:32:24.035Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AB&quot;,&quot;indexWithinVariant&quot;:&quot;47&quot;,&quot;totalWithinVariant&quot;:&quot;200&quot;,&quot;hueFamily&quot;:&quot;teal&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-08T15:32:24.035Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RTQ Maths Paper Solution Viewer (Stage 6 Prototype)</title>

    <!-- Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Tailwind CSS (via CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class', // Forced light mode per instruction, but setting up for config
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        // COLORLAB B: Forced Hue Family = TEAL
                        accent: {
                            50: '#f0fdfa',
                            100: '#ccfbf1',
                            200: '#99f6e4',
                            300: '#5eead4',
                            400: '#2dd4bf',
                            500: '#14b8a6', // Primary focus/ring
                            600: '#0d9488', // Text accent
                            700: '#0f766e',
                            800: '#115e59',
                            900: '#134e4a',
                        },
                        neutral: {
                            850: '#1f2937',
                        }
                    }
                }
            }
        }
    </script>

    <!-- KaTeX CSS (No SRI, No integrity) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <!-- Icons: Lucide (via CDN) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Markdown-it (via CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <!-- KaTeX JS (No SRI, No integrity) -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <style>
        /* Base Reset & Typography */
        body {
            background-color: #fafafa; /* Soft warm neutral base */
            color: #1e293b; /* Slate 800 */
            overflow-x: hidden; /* Constraint: No page-level horizontal scroll */
            -webkit-font-smoothing: antialiased;
        }

        /* Scrollbar hiding for Nav */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* KaTeX Containment Invariant */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding: 0.5em 0;
            margin: 0.5em 0;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Prevent inline math backgrounds */
        .katex {
            background-color: transparent !important;
        }

        /* Table styles per Stage 5.8.5 */
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 1em 0;
            font-size: 0.95em;
        }
        th, td {
            border: 1px solid #e2e8f0; /* Light gridlines */
            padding: 0.5rem 0.75rem;
            text-align: left;
            vertical-align: top;
        }
        th {
            font-weight: 600;
            background-color: transparent; /* No header background */
        }
        
        /* Wrapper for tables to allow scrolling on mobile if needed */
        .table-wrapper {
            overflow-x: auto;
            margin-bottom: 1rem;
            -webkit-overflow-scrolling: touch;
        }

        /* Interaction States */
        .interactive-text:hover {
            color: #0d9488; /* teal-600 */
            text-decoration: underline;
            text-decoration-thickness: 1px;
            text-underline-offset: 2px;
        }
        
        /* Focus styles - Custom but restrained */
        *:focus-visible {
            outline: 2px solid #14b8a6; /* teal-500 */
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* Hide KaTeX HTML fallback if using MathML/HTML combo usually, 
           but since we use standard render, we let KaTeX handle it. 
           Just ensuring overflow safety. */
        
        /* Utility for sticky nav calculation */
        .sticky-nav {
            position: sticky;
            top: 4rem; /* Offset for top controls */
            max-height: calc(100vh - 4rem);
        }

        /* Navigation Drawer Transition */
        .drawer-overlay {
            transition: opacity 0.2s ease-out;
        }
        .drawer-content {
            transition: transform 0.25s cubic-bezier(0.16, 1, 0.3, 1);
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- STAGE 0: CONSTANTS & RUNTIME -->
    <script>
        // CANONICAL CONSTANT â€” PAPERS PAYLOAD PATH (v1.0)
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        
        // ADD-ON PARAMETERS (ColorLab B)
        const RTQ_COLORLAB_FORCE_HUE_FAMILY = "teal";
    </script>

    <!-- Top Controls Region -->
    <header class="sticky top-0 z-30 w-full bg-[#fafafa]/95 backdrop-blur border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 md:px-8 h-14 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <!-- Mobile "Jump to" Trigger -->
                <button id="mobile-menu-trigger" class="md:hidden p-2 -ml-2 text-slate-600 hover:text-slate-900 interactive-text" aria-label="Jump to question">
                    <i data-lucide="menu" class="w-5 h-5"></i>
                </button>
                
                <!-- Paper Selector -->
                <div class="flex items-center gap-2">
                    <label for="paper-select" class="text-sm font-medium text-slate-500 hidden sm:block">Paper</label>
                    <select id="paper-select" class="bg-transparent border border-gray-300 text-slate-900 text-sm rounded-md focus:ring-accent-500 focus:border-accent-500 block p-1.5 pl-2 pr-8 cursor-pointer hover:border-gray-400 transition-colors">
                        <option value="" disabled selected>Loading papers...</option>
                    </select>
                </div>
            </div>
        </div>
    </header>

    <!-- DocumentFrameShell -->
    <div class="flex-1 w-full max-w-7xl mx-auto md:grid md:grid-cols-[240px_1fr]">
        
        <!-- Desktop Navigation Rail (Sticky) -->
        <aside class="hidden md:block border-r border-transparent pr-6 py-8 sticky-nav overflow-y-auto no-scrollbar" id="desktop-nav">
            <!-- Nav Content Rendered via JS -->
            <div id="desktop-nav-content" class="space-y-1"></div>
        </aside>

        <!-- Paper Document Column -->
        <main id="paper-region" class="py-8 px-4 sm:px-6 md:px-12 min-w-0">
            <!-- Paper Content Rendered via JS -->
            <div id="paper-content" class="max-w-3xl mx-auto">
                <div class="animate-pulse flex space-x-4">
                    <div class="flex-1 space-y-6 py-1">
                        <div class="h-4 bg-slate-200 rounded w-3/4"></div>
                        <div class="space-y-3">
                            <div class="h-4 bg-slate-200 rounded"></div>
                            <div class="h-4 bg-slate-200 rounded w-5/6"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

    </div>

    <!-- Mobile Navigation Drawer -->
    <div id="mobile-drawer" class="fixed inset-0 z-50 hidden" aria-modal="true" role="dialog">
        <!-- Scrim -->
        <div id="mobile-drawer-scrim" class="absolute inset-0 bg-slate-900/20 backdrop-blur-sm opacity-0 drawer-overlay"></div>
        
        <!-- Drawer Panel -->
        <div id="mobile-drawer-panel" class="absolute inset-y-0 left-0 w-3/4 max-w-xs bg-white shadow-xl transform -translate-x-full drawer-content flex flex-col">
            <div class="flex items-center justify-between px-4 h-14 border-b border-gray-100">
                <h2 class="text-sm font-semibold text-slate-900">Jump to</h2>
                <button id="mobile-drawer-close" class="p-2 -mr-2 text-slate-500 hover:text-slate-800">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div id="mobile-nav-content" class="flex-1 overflow-y-auto p-4 space-y-1">
                <!-- Nav Items Rendered JS -->
            </div>
        </div>
    </div>

    <!-- MAIN APP LOGIC -->
    <script>
        // --- Markdown Renderer Setup (Authoritative) ---
        // Config: html: true, linkify: true, breaks: false. Escape disabled.
        const md = window.markdownit ? window.markdownit({
            html: true,
            linkify: true,
            breaks: false
        }) : null;

        if (md) {
            md.inline.ruler.disable(['escape']);
        }

        // --- State Management ---
        const state = {
            papers: [],
            currentPaper: null,
            expandedStates: {}, // key: questionId, value: boolean
            activeQuestionId: null
        };

        // --- DOM Elements ---
        const els = {
            paperSelect: document.getElementById('paper-select'),
            paperContent: document.getElementById('paper-content'),
            desktopNavContent: document.getElementById('desktop-nav-content'),
            mobileNavContent: document.getElementById('mobile-nav-content'),
            mobileDrawer: document.getElementById('mobile-drawer'),
            mobileDrawerScrim: document.getElementById('mobile-drawer-scrim'),
            mobileDrawerPanel: document.getElementById('mobile-drawer-panel'),
            mobileTrigger: document.getElementById('mobile-menu-trigger'),
            mobileClose: document.getElementById('mobile-drawer-close')
        };

        // --- Fetch & Init ---
        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error('Network response was not ok');
                
                const data = await response.json();
                if (!data.papers || !Array.isArray(data.papers)) throw new Error('Invalid payload format');
                
                state.papers = data.papers;
                
                if (state.papers.length > 0) {
                    populateSelector();
                    loadPaper(state.papers[0].key);
                } else {
                    renderError("No papers found in payload.");
                }
            } catch (error) {
                console.error("Payload loading failed:", error);
                renderError("PAPERS PAYLOAD MISSING");
            }
        }

        function renderError(msg) {
            els.paperContent.innerHTML = `<div class="p-8 text-center text-slate-500 font-medium">${msg}</div>`;
            els.paperSelect.innerHTML = `<option disabled selected>Error</option>`;
        }

        function populateSelector() {
            els.paperSelect.innerHTML = state.papers.map(p => 
                `<option value="${p.key}">${p.label}</option>`
            ).join('');
            
            els.paperSelect.addEventListener('change', (e) => {
                loadPaper(e.target.value);
            });
        }

        function loadPaper(paperKey) {
            const paper = state.papers.find(p => p.key === paperKey);
            if (!paper) return;

            state.currentPaper = paper;
            state.expandedStates = {}; // Reset expansion state
            
            // Set default expansion based on paper defaults
            // Need to traverse all questions to init state if expandedAll is true
            const defaultExpanded = paper.defaults?.expandedAll !== false; // Default to true if undefined
            
            // Helper to init state
            const initExpanded = (nodes) => {
                if (!nodes) return;
                nodes.forEach(node => {
                    if (node.solutionBlock?.solutionDetails) {
                        state.expandedStates[node.id] = defaultExpanded;
                    }
                    if (node.children) initExpanded(node.children);
                });
            };
            
            if (paper.questions) initExpanded(paper.questions);
            if (paper.sections) paper.sections.forEach(s => initExpanded(s.questions));

            renderPaper();
            renderNavigation();
            
            // Post-render: Scroll to top
            window.scrollTo(0, 0);
            
            // KaTeX Render
            renderMath();
            // Icons
            lucide.createIcons();
            // Update Active Nav
            updateActiveNav();
        }

        // --- Rendering Logic ---

        function renderPaper() {
            const p = state.currentPaper;
            let html = '';

            // Optional Top-level Sections or Flat List
            if (p.sections) {
                html += p.sections.map(section => {
                    const sectionHeader = (section.label && section.label.trim() !== "") 
                        ? `<div class="mb-6 pt-4 pb-2 border-b border-gray-200 text-lg font-bold text-slate-800">${section.label}</div>`
                        : '';
                    const questionsHtml = renderQuestionList(section.questions, 0);
                    return `<section class="mb-12">${sectionHeader}${questionsHtml}</section>`;
                }).join('');
            } else if (p.questions) {
                html += renderQuestionList(p.questions, 0);
            }

            els.paperContent.innerHTML = html;
        }

        function renderQuestionList(questions, depth) {
            if (!questions || questions.length === 0) return '';
            // Spacing rules: Top-level gets largest.
            const spacingClass = depth === 0 ? 'space-y-16' : 'space-y-6 mt-6';
            
            return `<div class="${spacingClass}">
                ${questions.map(q => renderQuestionNode(q, depth)).join('')}
            </div>`;
        }

        function renderQuestionNode(node, depth) {
            const hasChildren = node.children && node.children.length > 0;
            const hasSolutionBlock = !!node.solutionBlock;
            const hasAnswer = hasSolutionBlock && !!node.solutionBlock.answer;
            const hasSolutionDetails = hasSolutionBlock && !!node.solutionBlock.solutionDetails;
            
            // ID
            const idHtml = `<span class="text-slate-500 font-semibold mr-2 select-none" id="q-${node.id}">${node.id}</span>`;
            
            // Question Prompt
            const questionHtml = `<div class="text-lg text-slate-900 leading-relaxed font-medium">
                ${idHtml}
                <span class="inline-markdown">${renderMarkdown(node.question)}</span>
            </div>`;

            // Solution Block
            let solutionBlockHtml = '';
            if (hasSolutionBlock) {
                // Answer
                let answerHtml = '';
                if (hasAnswer) {
                    answerHtml = `
                        <div class="mt-4 text-slate-800">
                            <span class="text-xs font-bold uppercase tracking-wider text-slate-500 mb-1 block">Answer</span>
                            <div class="text-base font-medium inline-markdown">${renderMarkdown(node.solutionBlock.answer)}</div>
                        </div>
                    `;
                }

                // Solution Details
                let detailsHtml = '';
                if (hasSolutionDetails) {
                    const isExpanded = state.expandedStates[node.id];
                    const toggleText = isExpanded ? 'Hide working' : 'Show working';
                    const chevronClass = isExpanded ? 'rotate-180' : '';
                    
                    // Details Content (only render if expanded to keep DOM clean, or hide via CSS? Instruction says "Progressive disclosure... without removing content from the paper". 
                    // However, standard accordion usually toggles display or height. 
                    // Given the constraint "do not remove content... keep ... understandable even when collapsed", 
                    // I will render it hidden to allow searching/pre-loading, or simpler JS re-render.
                    // Re-rendering implies "removing". Let's use CSS display toggle for smoothness if permitted, or re-render.
                    // "Expanding or collapsing content in one question must not automatically expand... others". 
                    // "Default folded states... explicitly defined".
                    // I'll re-render the node or toggle a class. Re-rendering the whole list is expensive but safe for prototype. 
                    // Let's use inline onclick handlers to specific IDs for atomic updates.
                    
                    let expandedContent = '';
                    if (isExpanded) {
                        const sd = node.solutionBlock.solutionDetails;
                        
                        // Keep in mind
                        const kimHtml = sd.keepInMind ? `
                            <div class="mb-4">
                                <div class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-1 flex items-center gap-1">
                                    <i data-lucide="lightbulb" class="w-3 h-3"></i> Keep in mind
                                </div>
                                <div class="text-sm text-slate-700 leading-relaxed inline-markdown bg-slate-50/50 rounded-sm p-0">
                                    ${renderMarkdown(sd.keepInMind)}
                                </div>
                            </div>
                        ` : '';

                        // Formulas
                        const formulasHtml = sd.formulasUsed ? `
                            <div class="mb-4">
                                <div class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Formulas used</div>
                                <div class="text-sm text-slate-700 leading-relaxed inline-markdown font-mono text-xs">
                                    ${renderMarkdown(sd.formulasUsed)}
                                </div>
                            </div>
                        ` : '';

                        // Working
                        const workingHtml = sd.working ? `
                            <div class="mb-4">
                                <div class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Working</div>
                                <div class="text-sm text-slate-700 leading-relaxed space-y-2 inline-markdown">
                                    ${renderMarkdown(sd.working)}
                                </div>
                            </div>
                        ` : '';

                        // Alternatives
                        let altsHtml = '';
                        if (sd.alternativeWorking && Array.isArray(sd.alternativeWorking)) {
                            altsHtml = sd.alternativeWorking.map((alt, idx) => `
                                <div class="mt-6 pt-4 border-t border-slate-100">
                                    <div class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Alternative working</div>
                                    <div class="text-sm text-slate-700 leading-relaxed inline-markdown">
                                        ${renderMarkdown(alt)}
                                    </div>
                                </div>
                            `).join('');
                        }

                        // Combine subsections
                        // Demarcation: Stage 3 permits internal separators.
                        // Using spacing mostly.
                        expandedContent = `
                            <div class="mt-4 pl-0 sm:pl-0 pt-2 animate-in fade-in slide-in-from-top-1 duration-200">
                                <!-- Boundary Clarity via Spacing + Hairline -->
                                <div class="border-t border-slate-100 pt-4">
                                    ${kimHtml}
                                    ${formulasHtml}
                                    ${workingHtml}
                                    ${altsHtml}
                                </div>
                            </div>
                        `;
                    }

                    detailsHtml = `
                        <div class="mt-3">
                            <button onclick="toggleDetails('${node.id}')" 
                                class="group flex items-center text-sm font-medium text-accent-600 hover:text-accent-700 transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-accent-500 rounded px-1 -ml-1 py-1">
                                <span class="mr-1">${toggleText}</span>
                                <i data-lucide="chevron-down" class="w-4 h-4 transition-transform duration-200 ${chevronClass}"></i>
                            </button>
                            ${expandedContent}
                        </div>
                    `;
                }

                if (hasAnswer || hasSolutionDetails) {
                    // Stage 5.1: Subordination. 
                    solutionBlockHtml = `
                        <div class="mt-2 pl-0 md:pl-0">
                            ${answerHtml}
                            ${detailsHtml}
                        </div>
                    `;
                }
            }

            // Children
            let childrenHtml = '';
            if (hasChildren) {
                // Indentation handled via padding/margin on container. 
                // Small indentation on mobile to preserve width.
                childrenHtml = `<div class="ml-4 md:ml-8 border-l border-transparent">
                    ${renderQuestionList(node.children, depth + 1)}
                </div>`;
            }

            return `
                <article class="relative group" data-id="${node.id}">
                    <!-- Question Body + Solution Block -->
                    <div class="relative z-10">
                        ${questionHtml}
                        ${solutionBlockHtml}
                    </div>
                    <!-- Children -->
                    ${childrenHtml}
                </article>
            `;
        }

        // --- Toggle Action ---
        window.toggleDetails = function(nodeId) {
            state.expandedStates[nodeId] = !state.expandedStates[nodeId];
            
            // Re-render only this node is hard because recursion. 
            // For prototype simplicity, re-render whole paper.
            // Save scroll position relative to the element?
            // "Expanding must not intentionally reposition... beyond natural layout shift"
            // Re-rendering whole list might jump. 
            // Better: Find the container in DOM and replace HTML.
            
            // Actually, we can just re-render the whole view and use `scrollRestoration = 'manual'` logic?
            // Or simpler: Just re-render. Since it's a prototype, full re-render is acceptable if fast.
            // But let's try to be nicer. We can find the specific ARTICLE by data-id and swap it?
            // But that might break structure if it has children.
            // Re-render All is safest for consistency.
            
            const scrollY = window.scrollY;
            renderPaper();
            renderMath(); // Re-run KaTeX
            lucide.createIcons();
            // Don't force scroll, let browser handle layout shift naturally (which usually keeps viewport top stable-ish)
        };

        // --- Navigation Rendering ---
        
        function renderNavigation() {
            const p = state.currentPaper;
            let navHtml = '';

            const renderNavItem = (node, depth) => {
                const isActive = state.activeQuestionId === node.id;
                // Hierarchy via type scale/quietness. Flat left edge.
                // Sub-questions: smaller font, lighter color.
                const baseClasses = "block w-full text-left py-1 px-3 border-l-2 transition-colors duration-150 focus:outline-none focus-visible:bg-slate-100";
                
                // Active State: Accent Color Marker + Font Weight
                const activeClasses = isActive 
                    ? "border-accent-500 font-bold text-slate-900 bg-accent-50/50" 
                    : "border-transparent text-slate-600 hover:text-slate-900 hover:border-slate-300";
                
                // Typography scale based on depth
                const typeScale = depth === 0 ? "text-sm" : depth === 1 ? "text-xs" : "text-[10px] uppercase tracking-wide";
                const labelColor = (depth > 0 && !isActive) ? "text-slate-500" : "";

                let html = `<button onclick="scrollToQuestion('${node.id}')" 
                    class="${baseClasses} ${activeClasses} ${typeScale} ${labelColor}">
                    ${node.id}
                </button>`;

                if (node.children) {
                    html += node.children.map(c => renderNavItem(c, depth + 1)).join('');
                }
                return html;
            };

            if (p.sections) {
                navHtml += p.sections.map((sec, idx) => {
                    // Section Separator
                    const labelHtml = (sec.label && sec.label.trim()) 
                        ? `<div class="px-3 pt-4 pb-1 text-xs font-bold text-slate-400 uppercase tracking-wider select-none">${sec.label}</div>` 
                        : (idx > 0 ? `<div class="h-4"></div>` : ''); // Spacing if no label but distinct section
                    
                    const itemsHtml = sec.questions.map(q => renderNavItem(q, 0)).join('');
                    return `<div>${labelHtml}${itemsHtml}</div>`;
                }).join('');
            } else if (p.questions) {
                navHtml += p.questions.map(q => renderNavItem(q, 0)).join('');
            }

            els.desktopNavContent.innerHTML = navHtml;
            els.mobileNavContent.innerHTML = navHtml;
        }

        window.scrollToQuestion = function(id) {
            const target = document.getElementById(`q-${id}`); // The span inside the question
            if (target) {
                // Close mobile drawer if open
                closeMobileDrawer();
                
                // Scroll with offset for sticky header
                const headerOffset = 80;
                const elementPosition = target.getBoundingClientRect().top;
                const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
                
                window.scrollTo({
                    top: offsetPosition,
                    behavior: "smooth"
                });
                
                // Update active state manually immediately for feedback
                state.activeQuestionId = id;
                renderNavigation();
            }
        };

        // --- Active Nav Spy ---
        function updateActiveNav() {
            // Find all question articles
            const articles = document.querySelectorAll('article[data-id]');
            let currentId = null;
            
            // Simple intersection check or check center of viewport
            // We want the top-most visible question.
            const triggerLine = window.innerHeight * 0.2 + 80; // Top 20% + Header
            
            for (let i = 0; i < articles.length; i++) {
                const rect = articles[i].getBoundingClientRect();
                if (rect.top <= triggerLine) {
                    currentId = articles[i].getAttribute('data-id');
                } else {
                    break; 
                }
            }
            
            if (currentId && currentId !== state.activeQuestionId) {
                state.activeQuestionId = currentId;
                renderNavigation();
            }
        }
        
        // Throttled Scroll Listener
        let isScrolling = false;
        window.addEventListener('scroll', () => {
            if (!isScrolling) {
                window.requestAnimationFrame(() => {
                    updateActiveNav();
                    isScrolling = false;
                });
                isScrolling = true;
            }
        });

        // --- Markdown & Math Helpers ---
        function renderMarkdown(text) {
            if (!text) return '';
            if (!md) return text; // Fallback
            // Render MD
            return md.render(text);
        }

        function renderMath() {
            // Auto-render KaTeX on the body (or paper region)
            if (window.renderMathInElement) {
                renderMathInElement(document.getElementById('paper-region'), {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false},
                        {left: '\\(', right: '\\)', display: false},
                        {left: '\\[', right: '\\]', display: true}
                    ],
                    throwOnError: false,
                    // Ensure macros or specific settings if needed
                    macros: {
                        "\\RR": "\\mathbb{R}"
                    }
                });
            }
        }

        // --- Mobile Drawer Logic ---
        function openMobileDrawer() {
            els.mobileDrawer.classList.remove('hidden');
            // Force reflow for transition
            requestAnimationFrame(() => {
                els.mobileDrawerScrim.classList.remove('opacity-0');
                els.mobileDrawerPanel.classList.remove('-translate-x-full');
            });
            document.body.style.overflow = 'hidden'; // Lock body scroll
        }

        function closeMobileDrawer() {
            els.mobileDrawerScrim.classList.add('opacity-0');
            els.mobileDrawerPanel.classList.add('-translate-x-full');
            
            setTimeout(() => {
                els.mobileDrawer.classList.add('hidden');
                document.body.style.overflow = '';
            }, 300); // Match transition duration
        }

        els.mobileTrigger.addEventListener('click', openMobileDrawer);
        els.mobileClose.addEventListener('click', closeMobileDrawer);
        els.mobileDrawerScrim.addEventListener('click', closeMobileDrawer);

        // --- Initialization ---
        init();

    </script>
</body>
</html>
