<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"ABC","indexWithinVariant":"42","totalWithinVariant":"320","hueFamily":"purple","intensityMode":"tinted_neutrals","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-09T11:52:23.773Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;ABC&quot;,&quot;indexWithinVariant&quot;:&quot;42&quot;,&quot;totalWithinVariant&quot;:&quot;320&quot;,&quot;hueFamily&quot;:&quot;purple&quot;,&quot;intensityMode&quot;:&quot;tinted_neutrals&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-09T11:52:23.773Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>

    <!-- 
      STAGE 6 ADD-ON: ColorLab B & C (Purple, Tinted Neutrals, Light Only)
      Using Tailwind via CDN for prototyping. 
    -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 
      STAGE 6 ADD-ON: Real KaTeX Rendering
      Loading without integrity attributes as per strict requirement.
    -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- 
      Markdown-it for payload rendering 
      Loading without integrity attributes.
    -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <style>
        /* 
           STAGE 6 ADD-ON: ColorLab C - Intensity Mode: tinted_neutrals
           Hue Family: Purple (Hue ~290-300)
           Strict OKLCH constraints applied.
        */
        :root {
            /* Purple Hue Base: 295 */
            --hue-base: 295;

            /* Page Background: C [0.015..0.035] -> 0.02 */
            --bg-page: oklch(0.97 0.02 var(--hue-base));
            
            /* Frame Base: C [0.015..0.035] -> 0.025 */
            --bg-frame: oklch(0.95 0.025 var(--hue-base));
            
            /* Paper Surface: C [0.015..0.035] -> 0.015 */
            --bg-paper: oklch(0.99 0.015 var(--hue-base));
            
            /* Wash Surface (Solution Details): C [0.025..0.045] -> 0.03 */
            --bg-wash: oklch(0.96 0.03 var(--hue-base));

            /* Keep in mind / Formulas wash (if surfaced): C [0.025..0.050] -> 0.035 */
            --bg-sub: oklch(0.95 0.035 var(--hue-base));

            /* Text Primary: C <= 0.010 -> 0.01 */
            --text-primary: oklch(0.25 0.01 var(--hue-base));
            
            /* Text Secondary: C <= 0.012 -> 0.012 */
            --text-secondary: oklch(0.45 0.012 var(--hue-base));
            
            /* Accent (Link/Focus/Disclosure): C [0.10..0.16] -> 0.14 */
            --color-accent: oklch(0.55 0.14 var(--hue-base));

            /* Dividers/Hairlines: Neutral-ish */
            --border-hairline: oklch(0.90 0.015 var(--hue-base));
        }

        body {
            background-color: var(--bg-page);
            color: var(--text-primary);
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        /* Utility classes mapping to variables */
        .bg-page { background-color: var(--bg-page); }
        .bg-frame { background-color: var(--bg-frame); }
        .bg-paper { background-color: var(--bg-paper); }
        .bg-wash { background-color: var(--bg-wash); }
        .bg-sub { background-color: var(--bg-sub); }
        
        .text-primary { color: var(--text-primary); }
        .text-secondary { color: var(--text-secondary); }
        .text-accent { color: var(--color-accent); }
        
        .border-hairline { border-color: var(--border-hairline); }
        .border-accent { border-color: var(--color-accent); }
        
        .focus-ring:focus-visible {
            outline: 2px solid var(--color-accent);
            outline-offset: 2px;
        }

        /* 
           STAGE 3/6: KaTeX Containment Invariant 
           No page-level horizontal scroll. Scroll only within block math.
        */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 4px; /* Space for scrollbar */
        }
        
        /* Hide scrollbars for navigation but allow scroll */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Markdown Table Styling - Minimal */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
            font-size: 0.95em;
        }
        th, td {
            border: 1px solid var(--border-hairline);
            padding: 0.5rem;
            text-align: left;
        }
        th {
            font-weight: 600;
        }

        /* Utility for content spacing */
        .prose p { margin-bottom: 0.75em; line-height: 1.6; }
        .prose ul { list-style-type: disc; padding-left: 1.25em; margin-bottom: 0.75em; }
        .prose ol { list-style-type: decimal; padding-left: 1.25em; margin-bottom: 0.75em; }
        
        /* Inline KaTeX background rule: Transparent only */
        .katex { background-color: transparent !important; }

        /* Icon styling */
        .icon-chevron { transition: transform 0.2s ease; }
        .expanded .icon-chevron { transform: rotate(180deg); }
    </style>
</head>
<body class="overflow-y-scroll min-h-screen flex flex-col items-center">

    <!-- App Container -->
    <div id="app" class="w-full max-w-[1400px] flex flex-col flex-grow">
        
        <!-- STAGE 3: Top Controls Region (Aligned to Frame) -->
        <div class="w-full px-4 py-4 md:py-6 flex items-center justify-between border-b border-hairline md:border-none bg-frame z-20 sticky top-0 md:static">
            <!-- Paper Selector -->
            <div class="flex items-center gap-3">
                <label for="paper-select" class="text-secondary text-sm font-medium hidden sm:block">Paper</label>
                <select id="paper-select" class="bg-paper border border-hairline rounded px-3 py-2 text-sm text-primary focus-ring cursor-pointer min-w-[200px]">
                    <option disabled selected>Loading papers...</option>
                </select>
            </div>

            <!-- Mobile "Jump to" Trigger -->
            <button id="mobile-jump-trigger" class="md:hidden text-accent text-sm font-medium focus-ring px-3 py-2 rounded">
                Jump to
            </button>
        </div>

        <!-- STAGE 3: DocumentFrameShell -->
        <!-- Desktop: Two sibling columns. Mobile: Single column. -->
        <div class="flex flex-grow w-full bg-frame relative">
            
            <!-- STAGE 3: Navigation Rail (Desktop) -->
            <!-- Sticky, shared surface, visually quiet -->
            <nav class="hidden md:block w-64 flex-shrink-0 sticky top-0 h-screen overflow-y-auto no-scrollbar py-6 pl-4 pr-6 border-r border-transparent">
                <div id="desktop-nav-list" class="flex flex-col gap-1">
                    <!-- Nav items injected here -->
                </div>
            </nav>

            <!-- STAGE 3: Paper Document Column -->
            <main class="flex-grow w-full px-4 py-6 md:px-8 md:py-8 max-w-4xl mx-auto">
                <div id="paper-content" class="bg-paper rounded-none md:rounded-sm shadow-sm min-h-[80vh] p-6 md:p-12 border border-hairline">
                    <!-- Paper Content Injected Here -->
                    <div class="text-center text-secondary py-20">Select a paper to begin</div>
                </div>
            </main>

        </div>
    </div>

    <!-- STAGE 3: Mobile Navigation Drawer -->
    <div id="mobile-drawer" class="fixed inset-0 z-50 hidden" aria-modal="true" role="dialog">
        <!-- Scrim -->
        <div id="drawer-scrim" class="absolute inset-0 bg-black/20 backdrop-blur-sm transition-opacity"></div>
        <!-- Drawer Panel -->
        <div class="absolute right-0 top-0 bottom-0 w-[80%] max-w-xs bg-paper shadow-xl flex flex-col">
            <div class="p-4 border-b border-hairline flex justify-between items-center">
                <h2 class="text-sm font-bold text-primary">Jump to</h2>
                <button id="drawer-close" class="text-secondary p-2 -mr-2 focus-ring rounded">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="flex-grow overflow-y-auto p-4">
                <div id="mobile-nav-list" class="flex flex-col gap-2">
                    <!-- Mobile items injected here -->
                </div>
            </div>
        </div>
    </div>

    <!-- JS Runtime -->
    <script>
        // =================================================================
        // STAGE 0: CONSTANTS (Canonical)
        // =================================================================
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // =================================================================
        // CONFIGURATION & STATE
        // =================================================================
        const state = {
            papers: [],
            currentPaper: null,
            payloadLoaded: false
        };

        // Initialize Markdown-it (Authoritative Config)
        const md = window.markdownit ? window.markdownit({
            html: true,       // Allow inline SVG
            linkify: true,
            breaks: false     // MUST stay false to prevent <br> breaking Math
        }) : null;

        if (md) {
            // Preserve TeX backslashes
            md.inline.ruler.disable(['escape']);
        }

        // =================================================================
        // CORE RENDERERS
        // =================================================================

        function renderApp() {
            // Load Payload
            fetch(RTQ_PAPERS_PAYLOAD_PATH)
                .then(res => {
                    if (!res.ok) throw new Error("Payload not found");
                    return res.json();
                })
                .then(data => {
                    state.papers = data.papers || [];
                    state.payloadLoaded = true;
                    initPaperSelector();
                    // Default to first paper if exists
                    if (state.papers.length > 0) {
                        loadPaper(state.papers[0].key);
                    } else {
                        renderError("No papers found in payload.");
                    }
                })
                .catch(err => {
                    console.error(err);
                    renderError("PAPERS PAYLOAD MISSING");
                });
        }

        function renderError(msg) {
            const container = document.getElementById('paper-content');
            container.innerHTML = `<div class="text-center text-red-800 font-mono font-bold mt-10">${msg}</div>`;
            document.getElementById('paper-select').innerHTML = `<option>Error</option>`;
            document.getElementById('paper-select').disabled = true;
        }

        function initPaperSelector() {
            const selector = document.getElementById('paper-select');
            selector.innerHTML = state.papers.map(p => 
                `<option value="${p.key}">${p.label || p.key}</option>`
            ).join('');
            
            selector.addEventListener('change', (e) => {
                loadPaper(e.target.value);
            });
        }

        function loadPaper(paperKey) {
            const paper = state.papers.find(p => p.key === paperKey);
            if (!paper) return;
            state.currentPaper = paper;

            // Render Content
            const container = document.getElementById('paper-content');
            container.innerHTML = ''; // Clear

            // Determine questions list
            let questions = [];
            let sections = [];

            if (paper.sections) {
                sections = paper.sections;
            } else if (paper.questions) {
                questions = paper.questions;
            }

            // Render Structure
            if (sections.length > 0) {
                sections.forEach(sec => {
                    if (sec.label && sec.label.trim().length > 0) {
                        // Section Header
                        const secHeader = document.createElement('div');
                        secHeader.className = "text-secondary font-bold text-lg mb-6 mt-8 pb-2 border-b border-hairline";
                        secHeader.textContent = sec.label;
                        container.appendChild(secHeader);
                    }
                    renderQuestionList(container, sec.questions, paper);
                });
            } else {
                renderQuestionList(container, questions, paper);
            }

            // Render Navigation
            renderNavigation(paper);

            // Post-Render: KaTeX
            renderMathInElement(container, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false},
                    {left: '\\(', right: '\\)', display: false},
                    {left: '\\[', right: '\\]', display: true}
                ],
                throwOnError: false
            });
            
            // Scroll top
            window.scrollTo(0,0);
        }

        function renderQuestionList(container, questions, paper) {
            if (!questions) return;
            questions.forEach(q => {
                container.appendChild(renderQuestionNode(q, paper, 0));
                
                // Top level spacer
                const spacer = document.createElement('div');
                spacer.className = "h-16 md:h-24"; // Large vertical spacing between top-level questions
                container.appendChild(spacer);
            });
        }

        // Recursive Question Node Renderer
        function renderQuestionNode(node, paper, depth) {
            const wrapper = document.createElement('div');
            wrapper.className = "question-node group";
            wrapper.id = `q-${node.id}`;

            // QUESTION BODY
            const qBody = document.createElement('div');
            qBody.className = "mb-4";
            
            // ID
            const qId = document.createElement('span');
            qId.className = "text-secondary font-bold text-sm md:text-base mr-3 select-none";
            qId.textContent = node.id;
            
            // Prompt (Markdown)
            const qPrompt = document.createElement('div');
            qPrompt.className = "inline prose text-primary text-base md:text-lg leading-relaxed";
            qPrompt.innerHTML = md ? md.renderInline(node.question || "") : node.question;
            
            // Combine ID + Prompt inline-block style or flex?
            // Prompt usually follows ID. Let's use a flex row for alignment.
            const qHeader = document.createElement('div');
            qHeader.className = "flex flex-row items-baseline";
            qHeader.appendChild(qId);
            qHeader.appendChild(qPrompt);
            qBody.appendChild(qHeader);
            
            wrapper.appendChild(qBody);

            // SOLUTION BLOCK
            if (node.solutionBlock) {
                const sb = node.solutionBlock;
                const solutionBlockDiv = document.createElement('div');
                solutionBlockDiv.className = "ml-0 md:ml-8 mt-4"; // Indent supporting material

                // ANSWER (Optional)
                if (sb.answer) {
                    const ansDiv = document.createElement('div');
                    ansDiv.className = "mb-4 text-primary";
                    const ansLabel = document.createElement('span');
                    ansLabel.className = "text-xs font-bold uppercase tracking-wider text-secondary mr-2";
                    ansLabel.textContent = "Answer";
                    const ansContent = document.createElement('span');
                    ansContent.className = "font-medium";
                    ansContent.innerHTML = md ? md.renderInline(sb.answer) : sb.answer;
                    
                    ansDiv.appendChild(ansLabel);
                    ansDiv.appendChild(ansContent);
                    solutionBlockDiv.appendChild(ansDiv);
                }

                // SOLUTION DETAILS (Optional)
                if (sb.solutionDetails) {
                    const sd = sb.solutionDetails;
                    const detailsId = `sd-${node.id}`;
                    
                    // Determine default state
                    const expanded = paper.defaults && paper.defaults.expandedAll === false ? false : true;

                    // Toggle Control
                    const toggleBtn = document.createElement('button');
                    toggleBtn.className = "flex items-center gap-2 text-accent text-sm font-medium hover:underline focus-ring rounded py-1 mb-2";
                    toggleBtn.setAttribute('aria-expanded', expanded);
                    toggleBtn.setAttribute('aria-controls', detailsId);
                    
                    const btnText = document.createElement('span');
                    btnText.textContent = expanded ? "Hide working" : "Show working";
                    
                    const icon = document.createElement('span');
                    icon.innerHTML = `<svg class="w-4 h-4 icon-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>`;
                    
                    toggleBtn.appendChild(btnText);
                    toggleBtn.appendChild(icon);
                    
                    // Details Region
                    const region = document.createElement('div');
                    region.id = detailsId;
                    region.className = `solution-details-region transition-all overflow-hidden ${expanded ? 'expanded' : 'hidden'}`;
                    
                    // Surface Wash (Permitted by Stage 3/5/6)
                    const wash = document.createElement('div');
                    wash.className = "bg-wash p-4 rounded-sm border-l-2 border-hairline mt-2 text-sm md:text-base";
                    
                    // Content Order: Keep in mind -> Formulas -> Working -> Alt
                    
                    // Keep in Mind
                    if (sd.keepInMind) {
                        const kim = document.createElement('div');
                        kim.className = "mb-6 bg-sub p-3 rounded-sm";
                        kim.innerHTML = `<div class="font-bold text-xs uppercase tracking-wider text-secondary mb-2">Keep in mind</div><div class="prose text-secondary">${md.render(sd.keepInMind)}</div>`;
                        wash.appendChild(kim);
                    }

                    // Formulas Used
                    if (sd.formulasUsed) {
                        const form = document.createElement('div');
                        form.className = "mb-6";
                        form.innerHTML = `<div class="font-bold text-xs uppercase tracking-wider text-secondary mb-2">Formulas used</div><div class="prose text-secondary">${md.render(sd.formulasUsed)}</div>`;
                        wash.appendChild(form);
                    }

                    // Working
                    if (sd.working) {
                        const work = document.createElement('div');
                        work.className = "mb-6";
                        // Working label usually implied or explicit? Stage 3 says "Working (primary)".
                        work.innerHTML = `<div class="font-bold text-xs uppercase tracking-wider text-secondary mb-2">Working</div><div class="prose text-primary">${md.render(sd.working)}</div>`;
                        wash.appendChild(work);
                    }

                    // Alternative Working
                    if (sd.alternativeWorking && Array.isArray(sd.alternativeWorking)) {
                        sd.alternativeWorking.forEach((alt, idx) => {
                            const altDiv = document.createElement('div');
                            altDiv.className = "mt-6 pt-6 border-t border-hairline";
                            altDiv.innerHTML = `<div class="font-bold text-xs uppercase tracking-wider text-secondary mb-2">Alternative working</div><div class="prose text-primary">${md.render(alt)}</div>`;
                            wash.appendChild(altDiv);
                        });
                    } else if (sd.alternativeWorking && typeof sd.alternativeWorking === 'string') {
                         const altDiv = document.createElement('div');
                            altDiv.className = "mt-6 pt-6 border-t border-hairline";
                            altDiv.innerHTML = `<div class="font-bold text-xs uppercase tracking-wider text-secondary mb-2">Alternative working</div><div class="prose text-primary">${md.render(sd.alternativeWorking)}</div>`;
                            wash.appendChild(altDiv);
                    }

                    region.appendChild(wash);
                    
                    // Toggle Logic
                    toggleBtn.onclick = () => {
                        const isExp = toggleBtn.getAttribute('aria-expanded') === 'true';
                        toggleBtn.setAttribute('aria-expanded', !isExp);
                        btnText.textContent = !isExp ? "Hide working" : "Show working";
                        region.classList.toggle('hidden');
                        region.classList.toggle('expanded');
                    };

                    solutionBlockDiv.appendChild(toggleBtn);
                    solutionBlockDiv.appendChild(region);
                }
                wrapper.appendChild(solutionBlockDiv);
            }

            // CHILDREN
            if (node.children && node.children.length > 0) {
                const childContainer = document.createElement('div');
                childContainer.className = "mt-6 ml-0 md:ml-6 pl-0 md:pl-4 border-l-0 md:border-l border-transparent"; // Visual indentation logic
                
                node.children.forEach(child => {
                    childContainer.appendChild(renderQuestionNode(child, paper, depth + 1));
                    // Child spacer
                    const spacer = document.createElement('div');
                    spacer.className = "h-8"; 
                    childContainer.appendChild(spacer);
                });
                wrapper.appendChild(childContainer);
            }

            return wrapper;
        }

        // Navigation Renderer
        function renderNavigation(paper) {
            // Collect all identifiers flat
            const items = [];
            
            function traverse(nodes, sectionLabel = null) {
                if(!nodes) return;
                nodes.forEach(n => {
                    items.push({ id: n.id, depth: 0, section: sectionLabel }); // We can calculate real depth if needed, but stage 5 says flat list.
                    if (n.children) traverse(n.children, sectionLabel);
                });
            }

            if (paper.sections) {
                paper.sections.forEach(s => {
                    // Push Section Label Object
                    if (s.label && s.label.trim()) {
                         items.push({ type: 'section', label: s.label });
                    }
                    // Traverse questions
                     const sectionQuestions = [];
                     const extractIds = (list) => {
                         if (!list) return;
                         list.forEach(q => {
                             items.push({ id: q.id, type: 'item' });
                             if (q.children) extractIds(q.children);
                         });
                     }
                     extractIds(s.questions);
                });
            } else {
                 const extractIds = (list) => {
                     if (!list) return;
                     list.forEach(q => {
                         items.push({ id: q.id, type: 'item' });
                         if (q.children) extractIds(q.children);
                     });
                 }
                 extractIds(paper.questions);
            }

            // Render Desktop Nav
            const dList = document.getElementById('desktop-nav-list');
            dList.innerHTML = '';
            
            // Render Mobile Nav
            const mList = document.getElementById('mobile-nav-list');
            mList.innerHTML = '';

            items.forEach(item => {
                if (item.type === 'section') {
                    // Section Label
                    const secEl = document.createElement('div');
                    secEl.className = "text-xs font-bold text-secondary uppercase tracking-wider mt-4 mb-2 pl-2 select-none";
                    secEl.textContent = item.label;
                    
                    dList.appendChild(secEl.cloneNode(true));
                    mList.appendChild(secEl.cloneNode(true));
                } else {
                    // Link
                    const link = document.createElement('a');
                    link.href = `#q-${item.id}`;
                    // Stage 5.4.5: Flat list, hierarchy via type scale/quietness.
                    // Simple heuristic: If ID is long (e.g. 18(a)(ii)), make it smaller? 
                    // Or just uniform flat per prompt "all identifiers share same left edge".
                    // Let's stick to uniform flat list but quiet text.
                    link.className = "block py-1 px-2 text-sm text-secondary hover:text-primary hover:bg-black/5 rounded transition-colors duration-150 decoration-0";
                    link.textContent = item.id;
                    
                    link.onclick = (e) => {
                        e.preventDefault();
                        const target = document.getElementById(`q-${item.id}`);
                        if (target) {
                            target.scrollIntoView({behavior: 'smooth', block: 'start'});
                            // Close mobile drawer
                            document.getElementById('mobile-drawer').classList.add('hidden');
                        }
                    };

                    dList.appendChild(link.cloneNode(true));
                    
                    // Mobile link needs distinct onclick
                    const mLink = link.cloneNode(true);
                    mLink.onclick = (e) => {
                        e.preventDefault();
                        const target = document.getElementById(`q-${item.id}`);
                        if (target) {
                            target.scrollIntoView({behavior: 'smooth', block: 'start'});
                            document.getElementById('mobile-drawer').classList.add('hidden');
                        }
                    };
                    mList.appendChild(mLink);
                }
            });
        }

        // =================================================================
        // INTERACTIONS
        // =================================================================
        
        // Mobile Drawer
        const drawer = document.getElementById('mobile-drawer');
        const jumpBtn = document.getElementById('mobile-jump-trigger');
        const closeBtn = document.getElementById('drawer-close');
        const scrim = document.getElementById('drawer-scrim');

        jumpBtn.onclick = () => drawer.classList.remove('hidden');
        closeBtn.onclick = () => drawer.classList.add('hidden');
        scrim.onclick = () => drawer.classList.add('hidden');

        // Nav Active State Observer (Intersection Observer)
        // Highlight current question in nav
        const observerOptions = {
            root: null,
            rootMargin: '-10% 0px -80% 0px', // Active when near top
            threshold: 0
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const id = entry.target.id.replace('q-', '');
                    updateActiveNav(id);
                }
            });
        }, observerOptions);

        function updateActiveNav(id) {
            // Clear active classes
            document.querySelectorAll('nav a, #mobile-nav-list a').forEach(a => {
                a.classList.remove('text-accent', 'font-bold', 'bg-wash');
                a.classList.add('text-secondary');
            });
            // Set active
            document.querySelectorAll(`nav a[href="#q-${id}"], #mobile-nav-list a[href="#q-${id}"]`).forEach(a => {
                a.classList.remove('text-secondary');
                a.classList.add('text-accent', 'font-bold'); // Weight + Color (ColorLab permitted)
            });
        }

        // We need to attach observer to question nodes after render.
        // This is done via a MutationObserver on paper-content to re-attach whenever content changes.
        const contentNode = document.getElementById('paper-content');
        const mutationObserver = new MutationObserver(() => {
            observer.disconnect();
            document.querySelectorAll('.question-node').forEach(n => observer.observe(n));
        });
        mutationObserver.observe(contentNode, { childList: true, subtree: true });

        // =================================================================
        // BOOTSTRAP
        // =================================================================
        window.addEventListener('DOMContentLoaded', renderApp);

    </script>
</body>
</html>
