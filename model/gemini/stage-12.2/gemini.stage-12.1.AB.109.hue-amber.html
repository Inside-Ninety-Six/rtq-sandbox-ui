<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AB","indexWithinVariant":"109","totalWithinVariant":"200","hueFamily":"amber","intensityMode":"","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-08T18:17:51.779Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AB&quot;,&quot;indexWithinVariant&quot;:&quot;109&quot;,&quot;totalWithinVariant&quot;:&quot;200&quot;,&quot;hueFamily&quot;:&quot;amber&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-08T18:17:51.779Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer (Stage 6 Baseline)</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Amber Hue Family Enforced by ColorLab B
                        brand: {
                            50: '#fffbeb',
                            100: '#fef3c7',
                            200: '#fde68a',
                            300: '#fcd34d',
                            400: '#fbbf24',
                            500: '#f59e0b',
                            600: '#d97706',
                            700: '#b45309',
                            800: '#92400e',
                            900: '#78350f',
                        },
                        // Soft warm neutrals (Stone) for base
                        neutral: {
                            50: '#fafaf9',
                            100: '#f5f5f4',
                            200: '#e7e5e4',
                            300: '#d6d3d1',
                            400: '#a8a29e',
                            500: '#78716c',
                            600: '#57534e',
                            700: '#44403c',
                            800: '#292524',
                            900: '#1c1917',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Markdown-it -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/13.0.1/markdown-it.min.js"></script>

    <!-- KaTeX (No Integrity per Stage 6 rules) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js"></script>

    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Hide scrollbar for Chrome, Safari and Opera */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        /* Hide scrollbar for IE, Edge and Firefox */
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        /* KaTeX Containment Invariant */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            padding-bottom: 4px; /* Space for scrollbar if needed */
            max-width: 100%;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Markdown Content Styling */
        .markdown-body p {
            margin-bottom: 0.75em;
            line-height: 1.6;
        }
        .markdown-body ul {
            list-style-type: disc;
            padding-left: 1.25em;
            margin-bottom: 0.75em;
        }
        .markdown-body ol {
            list-style-type: decimal;
            padding-left: 1.25em;
            margin-bottom: 0.75em;
        }
        .markdown-body table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1em;
            font-size: 0.95em;
        }
        .markdown-body th, .markdown-body td {
            border: 1px solid #e7e5e4; /* neutral-200 */
            padding: 0.5em;
            text-align: left;
        }
        .markdown-body th {
            font-weight: 600;
            background-color: #fafaf9; /* neutral-50 */
        }
        
        /* Focus styles */
        :focus-visible {
            outline: 2px solid #f59e0b; /* brand-500 */
            outline-offset: 2px;
        }
    </style>
</head>
<body class="bg-neutral-50 text-neutral-900 font-sans antialiased selection:bg-brand-200 selection:text-brand-900">
    <div id="root"></div>

    <script type="text/babel">
        // --- STAGE 0: CONSTANTS ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // --- MARKDOWN INIT ---
        const md = window.markdownit ? window.markdownit({
            html: true,
            linkify: true,
            breaks: false, // Must be false per constraints
        }) : null;

        if (md) {
            md.inline.ruler.disable(['escape']);
        }

        // --- COMPONENTS ---

        // Icon Components (using Lucide names via SVG)
        const IconChevronDown = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m6 9 6 6 6-6"/></svg>
        );
        const IconChevronRight = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m9 18 6-6-6-6"/></svg>
        );
        const IconMenu = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>
        );
        const IconX = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
        );

        // Markdown Renderer Component
        const MarkdownRenderer = ({ content, className }) => {
            const containerRef = React.useRef(null);

            React.useEffect(() => {
                if (containerRef.current && content) {
                    // 1. Render Markdown
                    const rawHtml = md ? md.render(content) : content;
                    containerRef.current.innerHTML = rawHtml;

                    // 2. Render KaTeX
                    if (window.renderMathInElement) {
                        window.renderMathInElement(containerRef.current, {
                            delimiters: [
                                {left: '$$', right: '$$', display: true},
                                {left: '$', right: '$', display: false}
                            ],
                            throwOnError: false
                        });
                    }
                }
            }, [content]);

            return <div ref={containerRef} className={`markdown-body ${className || ''}`} />;
        };

        // Navigation Item
        const NavigationItem = ({ id, label, isActive, onClick, isSectionLabel }) => {
            if (isSectionLabel) {
                return (
                    <div className="pt-4 pb-1 text-xs font-semibold text-neutral-400 uppercase tracking-wider px-3 select-none">
                        {label}
                    </div>
                );
            }

            // Hierarchy via type scale/weight (Stage 5.4.5)
            // Derived from ID structure roughly (length of string often correlates with depth)
            const isSub = id.length > 3 || id.includes('(');
            
            return (
                <button
                    onClick={() => onClick(id)}
                    className={`
                        w-full text-left px-3 py-1.5 transition-colors duration-200
                        ${isActive 
                            ? 'text-brand-700 font-bold bg-brand-50/50' 
                            : 'text-neutral-500 hover:text-neutral-900 hover:bg-neutral-100'
                        }
                        ${isSub ? 'text-sm' : 'text-base'}
                    `}
                >
                    {id}
                </button>
            );
        };

        // Solution Details Block
        const SolutionDetails = ({ details, expanded }) => {
            if (!expanded) return null;

            return (
                <div className="mt-3 pl-0 animate-in fade-in duration-200">
                    {/* Optional Wash Surface for Solution Details (Stage 3 permit) */}
                    <div className="p-4 bg-neutral-100/50 rounded-sm border-l-2 border-brand-200">
                        
                        {/* Keep In Mind */}
                        {details.keepInMind && (
                            <div className="mb-4">
                                <div className="text-xs font-bold text-brand-700 uppercase tracking-wide mb-1">
                                    Keep in mind
                                </div>
                                <MarkdownRenderer content={details.keepInMind} className="text-sm text-neutral-700" />
                            </div>
                        )}

                        {/* Formulas Used */}
                        {details.formulasUsed && (
                            <div className="mb-4">
                                <div className="text-xs font-bold text-brand-700 uppercase tracking-wide mb-1">
                                    Formulas used
                                </div>
                                <MarkdownRenderer content={details.formulasUsed} className="text-sm text-neutral-600 font-mono text-xs" />
                            </div>
                        )}

                        {/* Working */}
                        {details.working && (
                            <div className="mb-4">
                                <div className="text-xs font-bold text-brand-700 uppercase tracking-wide mb-2">
                                    Working
                                </div>
                                <MarkdownRenderer content={details.working} className="text-base text-neutral-800" />
                            </div>
                        )}

                        {/* Alternative Working */}
                        {details.alternativeWorking && details.alternativeWorking.length > 0 && (
                            <div className="mt-6 pt-4 border-t border-neutral-200">
                                {details.alternativeWorking.map((alt, idx) => (
                                    <div key={idx} className="mb-4">
                                        <div className="text-xs font-bold text-brand-700 uppercase tracking-wide mb-2">
                                            Alternative working {details.alternativeWorking.length > 1 ? idx + 1 : ''}
                                        </div>
                                        <MarkdownRenderer content={alt} className="text-base text-neutral-800" />
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // Question Node
        const QuestionNode = ({ node, depth = 0, paperDefaults }) => {
            // Determine if we have toggleable content
            const hasSolutionDetails = !!(node.solutionBlock && node.solutionBlock.solutionDetails);
            const hasAnswer = !!(node.solutionBlock && node.solutionBlock.answer);
            
            // State for expansion
            // Default expanded unless overridden by paper config (Paper defaults: expandedAll)
            const [isExpanded, setIsExpanded] = React.useState(
                paperDefaults?.expandedAll !== false
            );

            const toggle = () => setIsExpanded(!isExpanded);

            // Separation logic (Stage 5.1): top-level is largest, children tighter
            const containerClass = depth === 0 ? "mb-16" : "mb-8 mt-6";
            
            // Indentation for children (Stage 3 option E)
            const indentClass = depth > 0 ? "pl-4 md:pl-8 border-l border-neutral-200" : "";

            return (
                <div id={node.id} className={`${containerClass} ${indentClass} scroll-mt-24`}>
                    {/* Question Body */}
                    <div className="mb-4">
                        <div className="flex items-baseline gap-3 mb-2">
                            <span className="text-neutral-400 font-semibold text-sm select-none shrink-0 w-8 text-right">
                                {node.id}
                            </span>
                            <div className="flex-1">
                                <MarkdownRenderer 
                                    content={node.question} 
                                    className="text-lg text-neutral-900 font-medium leading-relaxed" 
                                />
                            </div>
                        </div>
                    </div>

                    {/* Solution Block */}
                    {node.solutionBlock && (
                        <div className="ml-11">
                            {/* Answer (Visible by default if present) */}
                            {hasAnswer && (
                                <div className="mb-3">
                                    <span className="text-xs font-bold text-brand-700 uppercase mr-2 select-none">
                                        Answer
                                    </span>
                                    <div className="inline-block text-neutral-800 font-medium">
                                        <MarkdownRenderer content={node.solutionBlock.answer} className="inline-block" />
                                    </div>
                                </div>
                            )}

                            {/* Disclosure Control */}
                            {hasSolutionDetails && (
                                <div>
                                    <button 
                                        onClick={toggle}
                                        className="flex items-center gap-1.5 text-sm font-medium text-brand-600 hover:text-brand-800 transition-colors focus:outline-none"
                                        aria-expanded={isExpanded}
                                    >
                                        <span>{isExpanded ? "Hide working" : "Show working"}</span>
                                        {isExpanded ? <IconChevronDown className="w-4 h-4" /> : <IconChevronRight className="w-4 h-4" />}
                                    </button>

                                    {/* Solution Details Region */}
                                    <SolutionDetails 
                                        details={node.solutionBlock.solutionDetails} 
                                        expanded={isExpanded} 
                                    />
                                </div>
                            )}
                        </div>
                    )}

                    {/* Recursion for Children */}
                    {node.children && node.children.length > 0 && (
                        <div className="mt-4">
                            {node.children.map(child => (
                                <QuestionNode 
                                    key={child.id} 
                                    node={child} 
                                    depth={depth + 1} 
                                    paperDefaults={paperDefaults} 
                                />
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        // Main App
        const App = () => {
            const [payload, setPayload] = React.useState(null);
            const [error, setError] = React.useState(false);
            const [currentPaperIndex, setCurrentPaperIndex] = React.useState(0);
            const [isDrawerOpen, setIsDrawerOpen] = React.useState(false);

            React.useEffect(() => {
                fetch(RTQ_PAPERS_PAYLOAD_PATH)
                    .then(res => {
                        if (!res.ok) throw new Error("Missing payload");
                        return res.json();
                    })
                    .then(data => setPayload(data))
                    .catch(err => {
                        console.error(err);
                        setError(true);
                    });
            }, []);

            if (error) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-neutral-50 text-neutral-400 font-mono">
                        PAPERS PAYLOAD MISSING
                    </div>
                );
            }

            if (!payload) {
                return <div className="min-h-screen bg-neutral-50"></div>; // Loading
            }

            const currentPaper = payload.papers[currentPaperIndex];

            // Flatten questions for navigation
            const flattenQuestions = (nodes) => {
                let list = [];
                nodes.forEach(node => {
                    list.push({ id: node.id }); // Simplified for Nav list
                    if (node.children) {
                        list = list.concat(flattenQuestions(node.children));
                    }
                });
                return list;
            };

            // Build Navigation Data
            let navItems = [];
            if (currentPaper.sections) {
                currentPaper.sections.forEach(section => {
                    if (section.label && section.label.trim() !== "") {
                        navItems.push({ isSection: true, label: section.label });
                    }
                    navItems = navItems.concat(flattenQuestions(section.questions));
                });
            } else if (currentPaper.questions) {
                navItems = flattenQuestions(currentPaper.questions);
            }

            const handlePaperChange = (e) => {
                setCurrentPaperIndex(Number(e.target.value));
                window.scrollTo(0, 0);
            };

            const scrollToQuestion = (id) => {
                const el = document.getElementById(id);
                if (el) {
                    el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    setIsDrawerOpen(false); // Close mobile drawer if open
                }
            };

            // Render content: Handle Sectioned vs Flat papers
            const renderContent = () => {
                if (currentPaper.sections) {
                    return currentPaper.sections.map((section, idx) => (
                        <div key={idx} className="mb-12">
                            {section.label && section.label.trim() !== "" && (
                                <div className="text-2xl font-bold text-neutral-300 mb-8 pb-2 border-b border-neutral-200">
                                    Section {section.label}
                                </div>
                            )}
                            {section.questions.map(q => (
                                <QuestionNode 
                                    key={q.id} 
                                    node={q} 
                                    paperDefaults={currentPaper.defaults} 
                                />
                            ))}
                        </div>
                    ));
                } else {
                    return currentPaper.questions.map(q => (
                        <QuestionNode 
                            key={q.id} 
                            node={q} 
                            paperDefaults={currentPaper.defaults} 
                        />
                    ));
                }
            };

            return (
                <div className="min-h-screen flex flex-col md:flex-row max-w-7xl mx-auto bg-white shadow-2xl shadow-neutral-200/50 my-0 md:my-8 rounded-none md:rounded-lg overflow-hidden border border-neutral-200">
                    
                    {/* Header / Top Controls (Mobile & Desktop shared visual alignment) */}
                    <div className="md:hidden sticky top-0 z-50 bg-white/95 backdrop-blur border-b border-neutral-200 p-4 flex items-center justify-between">
                        <div className="flex items-center gap-4">
                            <select 
                                className="bg-neutral-100 border-none text-sm font-medium py-1.5 pl-3 pr-8 rounded-md focus:ring-2 focus:ring-brand-500"
                                value={currentPaperIndex}
                                onChange={handlePaperChange}
                            >
                                {payload.papers.map((p, i) => (
                                    <option key={p.key} value={i}>{p.label}</option>
                                ))}
                            </select>
                        </div>
                        <button 
                            onClick={() => setIsDrawerOpen(true)}
                            className="text-sm font-bold text-brand-700 flex items-center gap-2 px-3 py-1.5 rounded hover:bg-brand-50"
                        >
                            <span>Jump to</span>
                            <IconMenu className="w-5 h-5" />
                        </button>
                    </div>

                    {/* Desktop Navigation Rail (Left Column) */}
                    <aside className="hidden md:block w-64 bg-neutral-50/50 border-r border-neutral-200 shrink-0 sticky top-0 h-[calc(100vh-4rem)] md:h-auto self-start">
                        <div className="p-6 sticky top-0 max-h-screen flex flex-col h-full">
                            {/* Paper Selector Desktop */}
                            <div className="mb-8 shrink-0">
                                <label className="block text-xs font-semibold text-neutral-400 uppercase tracking-wider mb-2">Paper</label>
                                <select 
                                    className="w-full bg-white border border-neutral-200 text-sm font-medium py-2 px-3 rounded-md focus:ring-2 focus:ring-brand-500 outline-none shadow-sm"
                                    value={currentPaperIndex}
                                    onChange={handlePaperChange}
                                >
                                    {payload.papers.map((p, i) => (
                                        <option key={p.key} value={i}>{p.label}</option>
                                    ))}
                                </select>
                            </div>

                            {/* Nav List */}
                            <nav className="flex-1 overflow-y-auto no-scrollbar pr-2 space-y-0.5 pb-12">
                                {navItems.map((item, i) => (
                                    <NavigationItem 
                                        key={i} 
                                        id={item.isSection ? null : item.id}
                                        label={item.label}
                                        isSectionLabel={item.isSection}
                                        onClick={scrollToQuestion}
                                        isActive={false} // Would implement IntersectionObserver for true scroll spy, simplified for prototype
                                    />
                                ))}
                            </nav>
                        </div>
                    </aside>

                    {/* Mobile Navigation Drawer */}
                    {isDrawerOpen && (
                        <div className="fixed inset-0 z-[60] flex justify-end md:hidden">
                            <div 
                                className="absolute inset-0 bg-neutral-900/20 backdrop-blur-sm"
                                onClick={() => setIsDrawerOpen(false)}
                            ></div>
                            <div className="relative w-64 bg-white h-full shadow-2xl flex flex-col animate-in slide-in-from-right duration-200">
                                <div className="p-4 border-b border-neutral-200 flex items-center justify-between">
                                    <span className="font-bold text-neutral-900">Jump to</span>
                                    <button onClick={() => setIsDrawerOpen(false)} className="text-neutral-500">
                                        <IconX className="w-6 h-6" />
                                    </button>
                                </div>
                                <div className="flex-1 overflow-y-auto p-4 space-y-1">
                                    {navItems.map((item, i) => (
                                        <NavigationItem 
                                            key={i} 
                                            id={item.isSection ? null : item.id}
                                            label={item.label}
                                            isSectionLabel={item.isSection}
                                            onClick={scrollToQuestion}
                                        />
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Paper Content (Right Column) */}
                    <main className="flex-1 bg-white min-h-[800px]">
                        <div className="max-w-3xl mx-auto py-8 px-4 md:py-12 md:px-12">
                            {renderContent()}
                        </div>
                        {/* Footer space */}
                        <div className="h-32"></div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
