<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"ABC","indexWithinVariant":"18","totalWithinVariant":"320","hueFamily":"amber","intensityMode":"tinted_neutrals","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-09T10:47:37.927Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;ABC&quot;,&quot;indexWithinVariant&quot;:&quot;18&quot;,&quot;totalWithinVariant&quot;:&quot;320&quot;,&quot;hueFamily&quot;:&quot;amber&quot;,&quot;intensityMode&quot;:&quot;tinted_neutrals&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-09T10:47:37.927Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>

    <!-- Tailwind CSS (via CDN for prototyping) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- KaTeX CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <!-- KaTeX JS -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Markdown-it -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <!-- ColorLab C: Tinted Neutrals + Amber (Hue 80) Configuration -->
    <style>
        :root {
            /* COLORLAB C: TINTED NEUTRALS (Amber Hue ~80) */
            /* Core Surfaces: C in [0.015 .. 0.035] */
            --clr-page-bg: oklch(0.97 0.02 80);
            --clr-frame-bg: oklch(0.97 0.02 80); /* Shared with page/nav on desktop */
            --clr-paper-bg: oklch(0.99 0.015 80);
            
            /* Wash Surfaces: C in [0.025 .. 0.045] */
            --clr-wash-bg: oklch(0.96 0.035 80);
            
            /* Text: Low chroma */
            --clr-text-pri: oklch(0.20 0.01 80);
            --clr-text-sec: oklch(0.45 0.012 80);
            
            /* Accent: C in [0.10 .. 0.16] - Used for links, focus, nav marker */
            --clr-accent: oklch(0.62 0.14 80);
            
            /* Dividers/Lines: Low chroma */
            --clr-divider: oklch(0.88 0.02 80);

            /* Typography */
            --font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        body {
            background-color: var(--clr-page-bg);
            color: var(--clr-text-pri);
            font-family: var(--font-family);
            -webkit-font-smoothing: antialiased;
        }

        /* Scrollbar hiding for Nav (Stage 6 Add-on) */
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* Focus styles (Stage 5.5.2) */
        :focus-visible {
            outline: 2px solid var(--clr-accent);
            outline-offset: 2px;
        }

        /* KaTeX Containment (Stage 6.0.8) */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding-bottom: 4px; /* Space for scrollbar */
            -webkit-overflow-scrolling: touch;
        }
        
        /* Inline math background invariant */
        .katex {
            background-color: transparent !important;
        }

        /* Markdown Table Minimalist Styling */
        table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 1em;
            font-size: 0.95em;
        }
        th, td {
            border: 1px solid var(--clr-divider);
            padding: 8px 12px;
            text-align: left;
        }
        th {
            font-weight: 600;
        }
        /* Mobile table scroll handling */
        .table-wrapper {
            overflow-x: auto;
            margin-bottom: 1em;
            -ms-overflow-style: none; 
            scrollbar-width: none;
        }
        .table-wrapper::-webkit-scrollbar { display: none; }

        /* DocumentFrameShell Layout */
        .doc-shell {
            max-width: 1200px;
            margin: 0 auto;
            /* Desktop grid: 240px nav + 1fr paper */
            display: grid;
            grid-template-columns: 1fr; /* Mobile default */
        }
        @media (min-width: 1024px) {
            .doc-shell {
                grid-template-columns: 240px minmax(0, 1fr);
                gap: 48px; /* SPC__NAV_TO_PAPER_COLUMN_GAP_SPACING */
                padding: 0 32px;
            }
        }

        /* Navigation Typography & Hierarchy */
        .nav-item {
            display: block;
            padding: 4px 0;
            color: var(--clr-text-sec);
            font-size: 0.9rem;
            text-decoration: none;
            border-left: 2px solid transparent;
            padding-left: 12px;
            transition: color 0.15s ease, border-color 0.15s ease;
        }
        .nav-item:hover {
            color: var(--clr-text-pri);
        }
        .nav-item.active {
            font-weight: 600;
            color: var(--clr-text-pri);
            border-left-color: var(--clr-accent); /* Accent used for current marker */
        }
        /* Sub-question hierarchy via type scale/quietness only */
        .nav-item.depth-1 { font-size: 0.85rem; color: var(--clr-text-sec); opacity: 0.9; }
        .nav-item.depth-2 { font-size: 0.8rem; color: var(--clr-text-sec); opacity: 0.8; }

        .nav-section-label {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--clr-text-sec);
            padding: 16px 0 8px 14px; /* Align text with items */
            margin-top: 8px;
        }

        /* Paper Styles */
        .paper-surface {
            background-color: var(--clr-paper-bg);
            /* Visual containment only via spacing/color, no card borders per strict interpretation of Stage 5 paper-like feel */
            min-height: 100vh;
            padding-bottom: 100px;
        }

        /* Disclosure Control */
        .disclosure-btn {
            appearance: none;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--clr-accent);
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 0;
            margin-top: 12px;
        }
        .disclosure-btn:hover {
            text-decoration: underline;
        }
        .chevron {
            transition: transform 0.2s ease;
        }
        .disclosure-btn[aria-expanded="true"] .chevron {
            transform: rotate(180deg);
        }

        /* Solution Details Wash */
        .solution-wash {
            background-color: var(--clr-wash-bg);
            padding: 16px;
            margin-top: 12px;
            border-radius: 4px; /* Minimal radius */
        }
        
        /* Internal Separators */
        .internal-hairline {
            height: 1px;
            background-color: var(--clr-divider);
            margin: 16px 0;
            border: none;
        }
    </style>
</head>
<body class="overflow-y-scroll">

    <!-- RUNTIME CONSTANTS -->
    <script>
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";
    </script>

    <div id="app">
        <!-- Loading State -->
        <div id="loading-view" class="flex items-center justify-center h-screen text-sm text-[var(--clr-text-sec)]">
            Loading Paper...
        </div>

        <!-- Error State -->
        <div id="error-view" class="hidden flex items-center justify-center h-screen text-sm font-bold text-[var(--clr-text-pri)]">
            PAPERS PAYLOAD MISSING
        </div>

        <!-- Main Interface -->
        <div id="main-view" class="hidden">
            
            <!-- Top Controls (Aligned to Frame) -->
            <div class="sticky top-0 z-20 bg-[var(--clr-page-bg)]/95 backdrop-blur-sm border-b border-[var(--clr-divider)]">
                <div class="doc-shell py-3 flex items-center justify-between lg:justify-start">
                    <!-- Mobile Menu Trigger -->
                    <button id="mobile-menu-btn" class="lg:hidden p-2 -ml-2 text-[var(--clr-text-pri)]" aria-label="Jump to question">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="3" y1="12" x2="21" y2="12"></line>
                            <line x1="3" y1="6" x2="21" y2="6"></line>
                            <line x1="3" y1="18" x2="21" y2="18"></line>
                        </svg>
                    </button>

                    <!-- Paper Selector -->
                    <div class="flex items-center gap-3">
                        <label for="paper-select" class="text-sm font-medium text-[var(--clr-text-sec)]">Paper:</label>
                        <select id="paper-select" class="bg-transparent text-sm font-medium text-[var(--clr-text-pri)] border border-[var(--clr-divider)] rounded px-2 py-1 focus:ring-1 focus:ring-[var(--clr-accent)] outline-none">
                            <!-- Options populated via JS -->
                        </select>
                    </div>

                    <!-- Mobile Jump Label -->
                    <span class="lg:hidden text-sm font-medium text-[var(--clr-text-sec)] ml-auto">Jump to</span>
                </div>
            </div>

            <!-- Content Area -->
            <div class="doc-shell pt-6 lg:pt-8">
                
                <!-- Navigation Rail (Desktop) -->
                <aside class="hidden lg:block">
                    <div class="sticky top-24 max-h-[calc(100vh-8rem)] overflow-y-auto hide-scrollbar pb-8">
                        <nav id="desktop-nav" class="flex flex-col">
                            <!-- Populated via JS -->
                        </nav>
                    </div>
                </aside>

                <!-- Paper Content -->
                <main id="paper-content" class="paper-surface pb-24">
                    <!-- Questions populated via JS -->
                </main>
            </div>

            <!-- Mobile Drawer Overlay -->
            <div id="mobile-drawer-backdrop" class="fixed inset-0 bg-black/20 z-40 hidden" aria-hidden="true"></div>
            <div id="mobile-drawer" class="fixed inset-y-0 left-0 w-64 bg-[var(--clr-frame-bg)] z-50 transform -translate-x-full transition-transform duration-200 ease-out shadow-lg flex flex-col">
                <div class="p-4 border-b border-[var(--clr-divider)] flex items-center justify-between">
                    <h2 class="text-sm font-bold text-[var(--clr-text-pri)]">Jump to</h2>
                    <button id="close-drawer-btn" class="p-2 -mr-2 text-[var(--clr-text-sec)]">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>
                <div class="flex-1 overflow-y-auto p-4">
                    <nav id="mobile-nav" class="flex flex-col gap-1">
                        <!-- Populated via JS -->
                    </nav>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- State ---
        let payload = null;
        let currentPaperKey = null;
        let expandedNodes = new Set(); // Stores IDs of questions with expanded workings
        let activeNavId = null;

        // --- DOM Elements ---
        const els = {
            loading: document.getElementById('loading-view'),
            error: document.getElementById('error-view'),
            main: document.getElementById('main-view'),
            paperSelect: document.getElementById('paper-select'),
            paperContent: document.getElementById('paper-content'),
            desktopNav: document.getElementById('desktop-nav'),
            mobileNav: document.getElementById('mobile-nav'),
            mobileMenuBtn: document.getElementById('mobile-menu-btn'),
            closeDrawerBtn: document.getElementById('close-drawer-btn'),
            mobileDrawer: document.getElementById('mobile-drawer'),
            drawerBackdrop: document.getElementById('mobile-drawer-backdrop'),
        };

        // --- Markdown Setup (Strict Config per Stage 6) ---
        // md.inline.ruler.disable(['escape']) is CRITICAL for TeX backslash preservation
        const md = window.markdownit ? window.markdownit({
            html: true,
            linkify: true,
            breaks: false, // Must be false for KaTeX
            typographer: false
        }) : null;

        if (md) {
            md.inline.ruler.disable(['escape']);
        }

        // --- Initialization ---
        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Payload not found");
                payload = await response.json();
                
                if (!payload || !payload.papers || payload.papers.length === 0) {
                    throw new Error("Invalid payload");
                }

                renderSelector();
                switchPaper(payload.papers[0].key);

                els.loading.classList.add('hidden');
                els.main.classList.remove('hidden');
                
                setupInteractions();

            } catch (err) {
                console.error(err);
                els.loading.classList.add('hidden');
                els.error.classList.remove('hidden');
            }
        }

        // --- Rendering ---

        function renderSelector() {
            els.paperSelect.innerHTML = payload.papers.map(p => 
                `<option value="${p.key}">${p.label}</option>`
            ).join('');
        }

        function switchPaper(key) {
            currentPaperKey = key;
            const paper = payload.papers.find(p => p.key === key);
            
            // Reset state
            expandedNodes.clear();
            const defaultExpand = paper.defaults?.expandedAll !== false;
            
            // Generate content HTML
            let contentHtml = '';
            
            // Helper to recursively collect IDs for default state
            const collectIds = (nodes) => {
                nodes.forEach(node => {
                    if (node.solutionBlock?.solutionDetails && defaultExpand) {
                        expandedNodes.add(node.id);
                    }
                    if (node.children) collectIds(node.children);
                });
            };

            if (paper.sections) {
                paper.sections.forEach(section => {
                    collectIds(section.questions);
                });
            } else if (paper.questions) {
                collectIds(paper.questions);
            }

            // Render Nav
            renderNavigation(paper);

            // Render Content
            if (paper.sections) {
                contentHtml = paper.sections.map(section => `
                    <section class="mb-12">
                        ${section.label && section.label.trim() !== '' ? `
                            <div class="text-[var(--clr-text-sec)] font-bold text-lg mb-8 border-b border-[var(--clr-divider)] pb-2">
                                Section ${section.label}
                            </div>
                        ` : ''}
                        <div class="flex flex-col gap-16"> <!-- SPC__TOP_LEVEL_INTER_QUESTION_SPACING -->
                            ${section.questions.map(q => renderQuestionNode(q, 0)).join('')}
                        </div>
                    </section>
                `).join('');
            } else {
                contentHtml = `<div class="flex flex-col gap-16">
                    ${paper.questions.map(q => renderQuestionNode(q, 0)).join('')}
                </div>`;
            }

            els.paperContent.innerHTML = contentHtml;

            // Post-render: KaTeX
            renderMathInElement(els.paperContent, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false}
                ],
                throwOnError: false
            });
            
            // Reset scroll
            window.scrollTo(0, 0);
        }

        function renderNavigation(paper) {
            const generateNavItems = (nodes, depth = 0) => {
                return nodes.map(node => `
                    <a href="#q-${node.id}" 
                       class="nav-item depth-${Math.min(depth, 2)}"
                       data-target="q-${node.id}">
                        ${node.id}
                    </a>
                    ${node.children ? generateNavItems(node.children, depth + 1) : ''}
                `).join('');
            };

            let navHtml = '';

            if (paper.sections) {
                navHtml = paper.sections.map(section => `
                    ${section.label && section.label.trim() !== '' ? `<div class="nav-section-label">${section.label}</div>` : ''}
                    ${generateNavItems(section.questions)}
                    <div class="h-4"></div> <!-- SPC__NAV_BETWEEN_SECTIONS_SPACING -->
                `).join('');
            } else {
                navHtml = generateNavItems(paper.questions);
            }

            els.desktopNav.innerHTML = navHtml;
            els.mobileNav.innerHTML = navHtml;
        }

        function renderQuestionNode(node, depth) {
            const hasChildren = node.children && node.children.length > 0;
            const hasSolutionBlock = !!node.solutionBlock;
            const hasAnswer = hasSolutionBlock && !!node.solutionBlock.answer;
            const hasDetails = hasSolutionBlock && !!node.solutionBlock.solutionDetails;
            const isExpanded = expandedNodes.has(node.id);

            // Render Markdown content
            const qBody = md.render(node.question || '');
            
            let childrenHtml = '';
            if (hasChildren) {
                childrenHtml = `
                    <div class="mt-6 flex flex-col gap-6 pl-0 md:pl-4 border-l-0 md:border-l-2 md:border-transparent">
                        ${node.children.map(c => renderQuestionNode(c, depth + 1)).join('')}
                    </div>
                `;
            }

            let solutionBlockHtml = '';
            if (hasSolutionBlock) {
                let answerHtml = '';
                if (hasAnswer) {
                    answerHtml = `
                        <div class="mt-4">
                            <div class="text-[0.8rem] font-bold text-[var(--clr-text-sec)] uppercase tracking-wide mb-1">Answer</div>
                            <div class="text-[var(--clr-text-pri)] font-medium">
                                ${md.render(node.solutionBlock.answer)}
                            </div>
                        </div>
                    `;
                }

                let detailsHtml = '';
                if (hasDetails) {
                    const d = node.solutionBlock.solutionDetails;
                    
                    const keepInMind = d.keepInMind ? `
                        <div class="mb-4">
                            <div class="text-[0.85rem] font-bold text-[var(--clr-text-sec)] mb-1">Keep in mind</div>
                            <div class="text-sm text-[var(--clr-text-pri)] prose-ul:list-disc prose-ul:pl-4">
                                ${md.render(d.keepInMind)}
                            </div>
                        </div>
                        <hr class="internal-hairline"/>
                    ` : '';

                    const formulas = d.formulasUsed ? `
                        <div class="mb-4">
                            <div class="text-[0.85rem] font-bold text-[var(--clr-text-sec)] mb-1">Formulas used</div>
                            <div class="text-sm text-[var(--clr-text-pri)]">
                                ${md.render(d.formulasUsed)}
                            </div>
                        </div>
                        <hr class="internal-hairline"/>
                    ` : '';

                    const working = d.working ? `
                        <div class="mb-4">
                            <div class="text-[0.85rem] font-bold text-[var(--clr-text-sec)] mb-1">Working</div>
                            <div class="text-sm text-[var(--clr-text-pri)] space-y-2">
                                ${md.render(d.working)}
                            </div>
                        </div>
                    ` : '';

                    const altWorking = d.alternativeWorking ? d.alternativeWorking.map((aw, idx) => `
                        <hr class="internal-hairline"/>
                        <div class="mb-4">
                            <div class="text-[0.85rem] font-bold text-[var(--clr-text-sec)] mb-1">Alternative working ${idx > 0 ? idx + 1 : ''}</div>
                            <div class="text-sm text-[var(--clr-text-pri)] space-y-2">
                                ${md.render(aw)}
                            </div>
                        </div>
                    `).join('') : '';

                    detailsHtml = `
                        <div class="mt-3">
                            <button class="disclosure-btn" 
                                    onclick="toggleSolution('${node.id}')"
                                    aria-expanded="${isExpanded}">
                                <span>${isExpanded ? 'Hide working' : 'Show working'}</span>
                                <svg class="chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </button>
                            
                            <div id="sol-${node.id}" class="${isExpanded ? 'block' : 'hidden'} solution-wash">
                                ${keepInMind}
                                ${formulas}
                                ${working}
                                ${altWorking}
                            </div>
                        </div>
                    `;
                }

                solutionBlockHtml = `
                    <div class="solution-block">
                        ${answerHtml}
                        ${detailsHtml}
                    </div>
                `;
            }

            return `
                <div id="q-${node.id}" class="question-node scroll-mt-32">
                    <div class="flex gap-4">
                        <div class="flex-shrink-0 text-[var(--clr-text-sec)] font-medium text-lg w-8 pt-1 leading-relaxed text-right md:text-left">
                            ${node.id}
                        </div>
                        <div class="flex-grow min-w-0">
                            <div class="prose prose-neutral max-w-none text-[var(--clr-text-pri)] text-lg leading-relaxed mb-2">
                                ${qBody}
                            </div>
                            ${solutionBlockHtml}
                            ${childrenHtml}
                        </div>
                    </div>
                </div>
            `;
        }

        // --- Interaction Logic ---

        window.toggleSolution = (id) => {
            if (expandedNodes.has(id)) expandedNodes.delete(id);
            else expandedNodes.add(id);

            // Re-render just the disclosure button area implies state change, 
            // but for simple prototype we can just toggle visibility and text directly to avoid full re-render
            const contentEl = document.getElementById(`sol-${id}`);
            const btnEl = document.querySelector(`button[onclick="toggleSolution('${id}')"]`);
            
            if (contentEl && btnEl) {
                const isNowExpanded = expandedNodes.has(id);
                contentEl.classList.toggle('hidden', !isNowExpanded);
                contentEl.classList.toggle('block', isNowExpanded);
                btnEl.setAttribute('aria-expanded', isNowExpanded);
                btnEl.querySelector('span').textContent = isNowExpanded ? 'Hide working' : 'Show working';
            }
        };

        function setupInteractions() {
            // Paper Selector
            els.paperSelect.addEventListener('change', (e) => switchPaper(e.target.value));

            // Mobile Drawer
            const toggleDrawer = (show) => {
                els.mobileDrawer.classList.toggle('-translate-x-full', !show);
                els.drawerBackdrop.classList.toggle('hidden', !show);
                document.body.style.overflow = show ? 'hidden' : '';
            };
            
            els.mobileMenuBtn.addEventListener('click', () => toggleDrawer(true));
            els.closeDrawerBtn.addEventListener('click', () => toggleDrawer(false));
            els.drawerBackdrop.addEventListener('click', () => toggleDrawer(false));
            
            // Mobile nav click
            els.mobileNav.addEventListener('click', (e) => {
                if (e.target.tagName === 'A') toggleDrawer(false);
            });

            // Scroll Spy
            const observerOptions = {
                root: null,
                rootMargin: '-15% 0px -70% 0px', // Active roughly near top
                threshold: 0
            };

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        updateActiveNav(entry.target.id);
                    }
                });
            }, observerOptions);

            // Re-observe on paper switch
            const observeAll = () => {
                document.querySelectorAll('.question-node').forEach(el => observer.observe(el));
            };
            
            // Hook into switchPaper (hacky via proxy or just mutation observer, simpler here to poll or re-run)
            // We'll just call observeAll after switchPaper logic (in switchPaper function: no, async render)
            // Actually, we called render inside switchPaper synchronously.
            
            // Override switchPaper to include observation
            const originalSwitch = switchPaper;
            switchPaper = (key) => {
                originalSwitch(key);
                setTimeout(observeAll, 50); // Small delay for DOM paint
            };

        }

        function updateActiveNav(targetId) {
            // Remove active class from all
            document.querySelectorAll('.nav-item').forEach(l => l.classList.remove('active'));
            
            // Add to current (desktop and mobile)
            const selector = `a[data-target="${targetId}"]`;
            document.querySelectorAll(selector).forEach(l => {
                l.classList.add('active');
                // Scroll nav into view if needed
                if (l.parentElement.id === 'desktop-nav') {
                   // logic to keep nav visible could go here
                }
            });
        }

        // --- Run ---
        init();

    </script>
</body>
</html>
