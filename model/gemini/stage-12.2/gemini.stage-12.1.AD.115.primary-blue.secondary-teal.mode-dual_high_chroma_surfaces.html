<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AD","indexWithinVariant":"115","totalWithinVariant":"440","hueFamily":"","intensityMode":"","primaryHueFamily":"blue","secondaryHueFamily":"teal","dualIntensityMode":"dual_high_chroma_surfaces","timestamp":"2026-01-10T07:07:08.335Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AD&quot;,&quot;indexWithinVariant&quot;:&quot;115&quot;,&quot;totalWithinVariant&quot;:&quot;440&quot;,&quot;hueFamily&quot;:&quot;&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;primaryHueFamily&quot;:&quot;blue&quot;,&quot;secondaryHueFamily&quot;:&quot;teal&quot;,&quot;dualIntensityMode&quot;:&quot;dual_high_chroma_surfaces&quot;,&quot;timestamp&quot;:&quot;2026-01-10T07:07:08.335Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>
    
    <!-- Fonts: Inter (Modern, Friendly, Neutral) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- KaTeX CSS (No integrity, no SRI) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <!-- Markdown-it & KaTeX JS (No integrity, no SRI) -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <style>
        /* =========================================
           STAGE 0-6: CSS VARIABLES & RESET
           ColorLab D: dual_high_chroma_surfaces
           Primary: Blue (250) | Secondary: Amber (85)
           Light Mode ONLY
           ========================================= */
        :root {
            /* Hues */
            --hue-p: 250; /* Blue */
            --hue-s: 85;  /* Amber */

            /* Surfaces (Mode: dual_high_chroma_surfaces) 
               Requires at least 2 major surfaces to be [0.06..0.12] 
               Remaining major surface [0.03..0.07]
            */
            --surf-viewport: oklch(0.93 0.06 var(--hue-p)); /* Major 1 */
            --surf-frame:    oklch(0.95 0.04 var(--hue-p)); /* Remaining */
            --surf-paper:    oklch(0.97 0.06 var(--hue-p)); /* Major 2 (Subtle chromatic tint) */
            
            /* Wash (Solution Details) [0.05..0.10] */
            --surf-wash:     oklch(0.96 0.05 var(--hue-p));

            /* Text (Primary <= 0.015) */
            --txt-primary:   oklch(0.20 0.015 var(--hue-p));
            --txt-secondary: oklch(0.45 0.015 var(--hue-p));
            --txt-tertiary:  oklch(0.60 0.010 var(--hue-p));

            /* Accents (Primary [0.12..0.20], Secondary [0.10..0.18]) */
            --accent-p:      oklch(0.55 0.18 var(--hue-p)); /* Link, Focus, Controls */
            --accent-s:      oklch(0.70 0.14 var(--hue-s)); /* Supplementary (Nav marker, etc) */

            /* Dividers */
            --div-hairline:  oklch(0.88 0.02 var(--hue-p));
            --focus-ring:    var(--accent-p);

            /* Spacing */
            --sp-xs: 0.25rem;
            --sp-sm: 0.5rem;
            --sp-md: 1rem;
            --sp-lg: 1.5rem;
            --sp-xl: 2.5rem; /* Top level separation */
            --sp-xxl: 4rem;

            /* Dimensions */
            --nav-width: 240px;
            --frame-max-width: 1000px;
            --header-height: 60px;
        }

        /* Reset & Base */
        * { box-sizing: border-box; }
        body {
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
            background-color: var(--surf-viewport);
            color: var(--txt-primary);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        /* Utils */
        .hidden { display: none !important; }
        .visually-hidden {
            position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px;
            overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0;
        }
        button { font-family: inherit; cursor: pointer; }

        /* KaTeX Overrides & Containment (Locked) */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding: 0.5em 0;
            /* No background on math by default */
        }
        /* Scrollbar hiding for math */
        .katex-display::-webkit-scrollbar { height: 4px; }
        .katex-display::-webkit-scrollbar-thumb { background: var(--txt-tertiary); border-radius: 2px; }

        /* =========================================
           LAYOUT ARCHITECTURE
           ========================================= */
        #root {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Top Controls (Aligned with shell) */
        .top-controls-region {
            width: 100%;
            background-color: var(--surf-frame); /* Visually part of frame context */
            border-bottom: 1px solid var(--div-hairline);
            position: sticky;
            top: 0;
            z-index: 20;
        }
        .top-controls-inner {
            max-width: var(--frame-max-width);
            margin: 0 auto;
            padding: 0 var(--sp-md);
            height: var(--header-height);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        /* Document Frame Shell */
        .document-frame-shell {
            flex: 1;
            width: 100%;
            max-width: var(--frame-max-width);
            margin: 0 auto;
            background-color: var(--surf-frame); /* Shared base surface */
            display: flex;
            position: relative;
        }

        /* Navigation Column (Desktop) */
        .nav-column {
            width: var(--nav-width);
            flex-shrink: 0;
            border-right: 1px solid var(--div-hairline);
            display: none; /* Mobile default */
        }
        @media (min-width: 768px) {
            .nav-column { display: block; }
        }

        .nav-rail {
            position: sticky;
            top: var(--header-height);
            height: calc(100vh - var(--header-height));
            overflow-y: auto;
            padding: var(--sp-lg) var(--sp-md);
            /* Scrollbar hiding */
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .nav-rail::-webkit-scrollbar { display: none; }

        /* Navigation List */
        .nav-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .nav-section-label {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--txt-tertiary);
            margin-top: var(--sp-md);
            margin-bottom: var(--sp-xs);
            padding-left: var(--sp-sm);
            letter-spacing: 0.05em;
        }
        .nav-item {
            display: block;
            padding: var(--sp-xs) var(--sp-sm);
            font-size: 0.875rem;
            color: var(--txt-secondary);
            text-decoration: none;
            border-radius: 4px;
            transition: color 0.2s, background-color 0.2s;
            cursor: pointer;
        }
        .nav-item:hover {
            color: var(--txt-primary);
            background-color: rgba(0,0,0,0.03);
        }
        .nav-item.active {
            font-weight: 600;
            color: var(--accent-p);
            /* Secondary cue: Marker */
            border-left: 2px solid var(--accent-s); 
            padding-left: calc(var(--sp-sm) - 2px);
        }
        /* Hierarchy via type scale only */
        .nav-item[data-depth="0"] { font-size: 0.9rem; }
        .nav-item[data-depth="1"] { font-size: 0.85rem; color: var(--txt-tertiary); }
        .nav-item[data-depth="2"] { font-size: 0.8rem;  color: var(--txt-tertiary); }

        /* Paper Column */
        .paper-column {
            flex: 1;
            min-width: 0; /* Prevent flex blowout */
        }
        .paper-surface {
            background-color: var(--surf-paper);
            min-height: 100%;
            padding: var(--sp-xl) var(--sp-lg) var(--sp-xxl) var(--sp-lg);
        }

        /* Mobile Drawer */
        .mobile-jump-trigger {
            display: flex;
            align-items: center;
            gap: var(--sp-sm);
            background: none;
            border: none;
            color: var(--accent-p);
            font-weight: 500;
            font-size: 0.9rem;
        }
        @media (min-width: 768px) {
            .mobile-jump-trigger { display: none; }
        }

        .drawer-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.2);
            z-index: 100;
            backdrop-filter: blur(2px);
        }
        .drawer-content {
            position: absolute;
            top: 0; left: 0; bottom: 0;
            width: 80%;
            max-width: 300px;
            background: var(--surf-frame);
            box-shadow: 2px 0 12px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }
        .drawer-header {
            padding: var(--sp-md);
            border-bottom: 1px solid var(--div-hairline);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .drawer-title { font-weight: 600; font-size: 1rem; }
        .drawer-close { background: none; border: none; font-size: 1.2rem; color: var(--txt-secondary); padding: var(--sp-xs); }
        .drawer-nav-region { overflow-y: auto; flex: 1; padding: var(--sp-md); }

        /* =========================================
           CONTENT STYLING
           ========================================= */
        
        /* Section Header */
        .section-header-block {
            margin-bottom: var(--sp-xl);
            border-bottom: 1px solid var(--div-hairline);
            padding-bottom: var(--sp-sm);
        }
        .section-header-text {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--txt-secondary);
        }

        /* Question Node */
        .question-node {
            margin-bottom: var(--sp-xl); /* Top level separation */
            position: relative;
        }
        /* Child spacing */
        .question-children {
            margin-top: var(--sp-lg);
            padding-left: 0; /* No visual indent via padding on desktop for layout tree alignment, but distinct via spacing */
        }
        @media (min-width: 768px) {
            .question-children {
                margin-left: var(--sp-md); /* Subtle indent permitted by Stage 3 */
            }
        }

        /* Question Body */
        .question-body {
            display: flex;
            gap: var(--sp-sm);
            color: var(--txt-primary);
        }
        .question-id {
            font-weight: 600;
            min-width: 2rem;
            flex-shrink: 0;
            color: var(--txt-secondary);
        }
        .question-prompt {
            flex: 1;
            font-size: 1.05rem;
        }
        .question-prompt p { margin-top: 0; margin-bottom: var(--sp-sm); }
        .question-prompt img, .question-prompt svg { max-width: 100%; height: auto; display: block; margin: var(--sp-sm) 0; }

        /* Solution Block */
        .solution-block {
            margin-top: var(--sp-md);
            margin-left: 2rem; /* Align with prompt roughly */
        }
        @media (max-width: 480px) { .solution-block { margin-left: 0; } }

        /* Answer */
        .answer-region {
            margin-bottom: var(--sp-md);
        }
        .answer-label {
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--txt-tertiary);
            letter-spacing: 0.05em;
            display: block;
            margin-bottom: var(--sp-xs);
        }
        .answer-content {
            font-weight: 500;
            color: var(--txt-primary);
        }

        /* Solution Details Control */
        .sd-control-wrapper {
            margin-bottom: var(--sp-sm);
        }
        .sd-toggle {
            background: none;
            border: none;
            padding: 0;
            color: var(--accent-p);
            font-size: 0.9rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: var(--sp-xs);
        }
        .sd-toggle:hover { text-decoration: underline; }
        .sd-toggle:focus-visible { outline: 2px solid var(--focus-ring); border-radius: 2px; }
        .sd-icon { transition: transform 0.2s; }
        .sd-toggle[aria-expanded="true"] .sd-icon { transform: rotate(180deg); }

        /* Solution Details Region */
        .solution-details-region {
            /* Separator: Spacing required. Hairline optional. */
            /* Using spacing + subtle wash surface as permitted by Stage 3/5/6 */
            margin-top: var(--sp-sm);
            background-color: var(--surf-wash);
            padding: var(--sp-md) var(--sp-md);
            border-radius: 4px; /* Soft structure, not card */
            display: none;
        }
        .solution-details-region.expanded { display: block; animation: fadeIn 0.2s ease-out; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(-4px); } to { opacity: 1; transform: translateY(0); } }

        /* Subsections (Keep in mind, Formulas, Working, Alt) */
        .sd-subsection { margin-bottom: var(--sp-lg); }
        .sd-subsection:last-child { margin-bottom: 0; }

        .sd-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--txt-secondary);
            margin-bottom: var(--sp-xs);
            display: flex;
            align-items: center;
            gap: var(--sp-xs);
        }
        .sd-body {
            font-size: 0.95rem;
            color: var(--txt-primary); /* Not washed out */
        }
        .sd-body ul { padding-left: 1.2rem; margin: 0; }
        .sd-body li { margin-bottom: var(--sp-xs); }
        .sd-body p { margin-top: 0; margin-bottom: var(--sp-sm); }

        /* Working Internal Grammar */
        .working-phase {
            margin-bottom: var(--sp-md); /* Between phases */
        }
        /* Tables inside working */
        table {
            border-collapse: collapse;
            width: 100%;
            font-size: 0.9rem;
            margin: var(--sp-sm) 0;
        }
        th, td {
            border: 1px solid var(--div-hairline);
            padding: var(--sp-xs) var(--sp-sm);
            text-align: left;
        }
        th { font-weight: 600; color: var(--txt-secondary); }

        /* Paper Selector */
        .paper-select {
            padding: var(--sp-xs) var(--sp-sm);
            border: 1px solid var(--div-hairline);
            border-radius: 4px;
            background: var(--surf-viewport);
            color: var(--txt-primary);
            font-size: 0.9rem;
        }

        /* Error Message */
        .error-message {
            color: var(--txt-secondary);
            font-weight: 600;
            text-align: center;
            margin-top: var(--sp-xl);
        }

    </style>
</head>
<body>

<div id="root">
    <!-- CONSTANT DEFINITION FOR RUNTIME -->
    <script>
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";
    </script>

    <!-- Top Controls -->
    <header class="top-controls-region">
        <div class="top-controls-inner">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <button class="mobile-jump-trigger" id="mobileJumpBtn">
                    <span>Jump to...</span>
                    <svg width="16" height="16" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.13523 6.15803C3.3241 5.95657 3.64052 5.94637 3.84197 6.13523L7.5 9.56464L11.158 6.13523C11.3595 5.94637 11.6759 5.95657 11.8648 6.15803C12.0536 6.35949 12.0434 6.67591 11.842 6.86477L7.84197 10.6148C7.64964 10.7951 7.35036 10.7951 7.15803 10.6148L3.15803 6.86477C2.95657 6.67591 2.94637 6.35949 3.13523 6.15803Z" fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
                </button>
                <div style="font-weight: 600; font-size: 0.9rem; color: var(--txt-secondary);">RTQ Viewer</div>
            </div>
            
            <select id="paperSelector" class="paper-select" aria-label="Select paper">
                <option value="" disabled selected>Loading...</option>
            </select>
        </div>
    </header>

    <!-- Document Shell -->
    <div class="document-frame-shell">
        <!-- Desktop Nav -->
        <nav class="nav-column" aria-label="Paper navigation">
            <div class="nav-rail" id="desktopNavList">
                <!-- Nav items generated here -->
            </div>
        </nav>

        <!-- Paper Content -->
        <main class="paper-column">
            <div class="paper-surface" id="paperContent">
                <!-- Content generated here -->
                <div style="text-align: center; color: var(--txt-tertiary); margin-top: 4rem;">Loading paper...</div>
            </div>
        </main>
    </div>

    <!-- Mobile Drawer -->
    <div id="mobileDrawer" class="hidden">
        <div class="drawer-overlay" id="drawerOverlay"></div>
        <div class="drawer-content">
            <div class="drawer-header">
                <span class="drawer-title">Jump to</span>
                <button class="drawer-close" id="drawerClose" aria-label="Close navigation">âœ•</button>
            </div>
            <div class="drawer-nav-region" id="mobileNavList">
                <!-- Cloned nav items here -->
            </div>
        </div>
    </div>
</div>

<script>
    /* =========================================
       LOGIC: Paper Payload Loading & Rendering
       ========================================= */

    // --- Markdown Init (Authoritative) ---
    const md = window.markdownit ? window.markdownit({
        html: true,
        linkify: true,
        breaks: false // MUST be false
    }) : null;

    if (md) {
        md.inline.ruler.disable(['escape']);
    }

    // --- State ---
    let papersData = [];
    let currentPaper = null;
    let expandedStates = new Set(); // Stores IDs of questions with expanded workings
    let activeNavId = null;

    // --- DOM Elements ---
    const paperSelector = document.getElementById('paperSelector');
    const paperContent = document.getElementById('paperContent');
    const desktopNavList = document.getElementById('desktopNavList');
    const mobileNavList = document.getElementById('mobileNavList');
    const mobileJumpBtn = document.getElementById('mobileJumpBtn');
    const mobileDrawer = document.getElementById('mobileDrawer');
    const drawerClose = document.getElementById('drawerClose');
    const drawerOverlay = document.getElementById('drawerOverlay');

    // --- Lifecycle ---
    init();

    async function init() {
        try {
            const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
            if (!response.ok) throw new Error("Payload not found");
            const data = await response.json();
            
            if (!data.papers || !Array.isArray(data.papers)) throw new Error("Invalid schema");
            
            papersData = data.papers;
            populateSelector();
            
            // Load first paper by default
            if (papersData.length > 0) {
                loadPaper(papersData[0].key);
            }
        } catch (e) {
            console.error(e);
            paperContent.innerHTML = `<div class="error-message">PAPERS PAYLOAD MISSING</div>`;
            paperSelector.innerHTML = `<option disabled>Error</option>`;
        }
    }

    function populateSelector() {
        paperSelector.innerHTML = '';
        papersData.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.key;
            opt.textContent = p.label || p.key;
            paperSelector.appendChild(opt);
        });

        paperSelector.addEventListener('change', (e) => {
            loadPaper(e.target.value);
        });
    }

    function loadPaper(key) {
        const paper = papersData.find(p => p.key === key);
        if (!paper) return;

        currentPaper = paper;
        
        // Reset state
        expandedStates.clear();
        
        // Default expansion logic
        // If defaults.expandedAll is false, keep empty. If true/undefined, we might populate later or handle in render.
        // Stage 3 constraint: "Solution Details are expanded by default when present (unless defaults explicitly set expandedAll=false)"
        // We will handle this lazily during render or simply track *collapsed* states. 
        // Better: Track expanded states. If default is true, we consider untracked as expanded.
        // Actually, easiest is to let the 'render' function decide initial DOM state based on config.
        
        renderPaper(paper);
        renderNavigation(paper);
        
        // Scroll to top
        window.scrollTo(0, 0);
        updateActiveNav();
    }

    // --- Rendering Content ---

    function renderPaper(paper) {
        paperContent.innerHTML = '';

        // Handling Sections vs Flat
        if (paper.sections) {
            paper.sections.forEach((section, idx) => {
                // Render Section Header if label exists
                if (section.label && section.label.trim().length > 0) {
                    const secBlock = document.createElement('div');
                    secBlock.className = 'section-block';
                    secBlock.innerHTML = `
                        <div class="section-header-block" id="sec-${idx}">
                            <div class="section-header-text">${section.label}</div>
                        </div>
                    `;
                    paperContent.appendChild(secBlock);
                }
                
                // Render Questions
                const qList = document.createElement('div');
                qList.className = 'question-list';
                section.questions.forEach(q => {
                    qList.appendChild(createQuestionNode(q, 0, paper));
                });
                paperContent.appendChild(qList);
            });
        } else if (paper.questions) {
            const qList = document.createElement('div');
            qList.className = 'question-list';
            paper.questions.forEach(q => {
                qList.appendChild(createQuestionNode(q, 0, paper));
            });
            paperContent.appendChild(qList);
        }

        // Trigger KaTeX
        renderMathInElement(paperContent, {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false}
            ],
            throwOnError: false
        });
    }

    function createQuestionNode(node, depth, paper) {
        const wrapper = document.createElement('div');
        wrapper.className = 'question-node';
        wrapper.id = `q-${node.id}`;
        wrapper.setAttribute('data-id', node.id);

        // 1. Question Body
        const qBody = document.createElement('div');
        qBody.className = 'question-body';
        
        const qId = document.createElement('div');
        qId.className = 'question-id';
        qId.textContent = node.id;
        
        const qPrompt = document.createElement('div');
        qPrompt.className = 'question-prompt';
        qPrompt.innerHTML = md ? md.render(node.question || '') : (node.question || '');

        qBody.appendChild(qId);
        qBody.appendChild(qPrompt);
        wrapper.appendChild(qBody);

        // 2. Solution Block (Optional)
        if (node.solutionBlock) {
            const solBlock = document.createElement('div');
            solBlock.className = 'solution-block';

            // A) Answer
            if (node.solutionBlock.answer) {
                const ansRegion = document.createElement('div');
                ansRegion.className = 'answer-region';
                ansRegion.innerHTML = `
                    <span class="answer-label">Answer</span>
                    <div class="answer-content">${md ? md.render(node.solutionBlock.answer) : node.solutionBlock.answer}</div>
                `;
                solBlock.appendChild(ansRegion);
            }

            // B) Solution Details
            const details = node.solutionBlock.solutionDetails;
            if (details) {
                // Determine default state
                const defaultExpanded = paper.defaults?.expandedAll !== false;
                const isExpanded = expandedStates.has(node.id) || (defaultExpanded && !expandedStates.has('collapsed-' + node.id));
                
                // Toggle
                const toggleWrapper = document.createElement('div');
                toggleWrapper.className = 'sd-control-wrapper';
                const btn = document.createElement('button');
                btn.className = 'sd-toggle';
                btn.setAttribute('aria-expanded', isExpanded);
                btn.innerHTML = `
                    <span class="sd-text">${isExpanded ? 'Hide working' : 'Show working'}</span>
                    <svg class="sd-icon" width="12" height="12" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.13523 6.15803C3.3241 5.95657 3.64052 5.94637 3.84197 6.13523L7.5 9.56464L11.158 6.13523C11.3595 5.94637 11.6759 5.95657 11.8648 6.15803C12.0536 6.35949 12.0434 6.67591 11.842 6.86477L7.84197 10.6148C7.64964 10.7951 7.35036 10.7951 7.15803 10.6148L3.15803 6.86477C2.95657 6.67591 2.94637 6.35949 3.13523 6.15803Z" fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
                `;
                
                // Region
                const region = document.createElement('div');
                region.className = `solution-details-region ${isExpanded ? 'expanded' : ''}`;
                
                // Content Generation
                let regionHTML = '';

                // Keep in mind
                if (details.keepInMind) {
                    regionHTML += `
                        <div class="sd-subsection">
                            <div class="sd-label">
                                <svg width="14" height="14" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M7.49991 0.876892C3.84222 0.876892 0.877075 3.84204 0.877075 7.49972C0.877075 11.1574 3.84222 14.1226 7.49991 14.1226C11.1576 14.1226 14.1227 11.1574 14.1227 7.49972C14.1227 3.84204 11.1576 0.876892 7.49991 0.876892ZM1.82707 7.49972C1.82707 4.36671 4.36689 1.82689 7.49991 1.82689C10.6329 1.82689 13.1727 4.36671 13.1727 7.49972C13.1727 10.6327 10.6329 13.1726 7.49991 13.1726C4.36689 13.1726 1.82707 10.6327 1.82707 7.49972ZM8.24992 4.49999C8.24992 4.9142 7.91413 5.24999 7.49992 5.24999C7.08571 5.24999 6.74992 4.9142 6.74992 4.49999C6.74992 4.08577 7.08571 3.74999 7.49992 3.74999C7.91413 3.74999 8.24992 4.08577 8.24992 4.49999ZM6.00003 5.99999H6.50003H7.50003C7.77618 5.99999 8.00003 6.22385 8.00003 6.49999V9.99999H8.50003H9.00003V11H8.50003H7.50003H6.50003H6.00003V9.99999H6.50003H7.00003V6.99999H6.50003H6.00003V5.99999Z" fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
                                Keep in mind
                            </div>
                            <div class="sd-body">${md ? md.render(details.keepInMind) : details.keepInMind}</div>
                        </div>
                    `;
                }
                
                // Formulas used
                if (details.formulasUsed) {
                    regionHTML += `
                        <div class="sd-subsection">
                            <div class="sd-label">Formulas used</div>
                            <div class="sd-body">${md ? md.render(details.formulasUsed) : details.formulasUsed}</div>
                        </div>
                    `;
                }

                // Working
                if (details.working) {
                    regionHTML += `
                        <div class="sd-subsection">
                            <div class="sd-label">Working</div>
                            <div class="sd-body">${md ? md.render(details.working) : details.working}</div>
                        </div>
                    `;
                }

                // Alternative Working
                if (details.alternativeWorking && Array.isArray(details.alternativeWorking)) {
                    details.alternativeWorking.forEach((alt, idx) => {
                         regionHTML += `
                            <div class="sd-subsection">
                                <div class="sd-label">Alternative working ${details.alternativeWorking.length > 1 ? (idx+1) : ''}</div>
                                <div class="sd-body">${md ? md.render(alt) : alt}</div>
                            </div>
                        `;
                    });
                }

                region.innerHTML = regionHTML;

                // Wire up click
                btn.addEventListener('click', () => {
                    const expanding = !region.classList.contains('expanded');
                    if (expanding) {
                        region.classList.add('expanded');
                        btn.setAttribute('aria-expanded', 'true');
                        btn.querySelector('.sd-text').textContent = 'Hide working';
                        // Tracking state (optional but nice)
                        expandedStates.add(node.id);
                        if (defaultExpanded) expandedStates.delete('collapsed-' + node.id);
                    } else {
                        region.classList.remove('expanded');
                        btn.setAttribute('aria-expanded', 'false');
                        btn.querySelector('.sd-text').textContent = 'Show working';
                        expandedStates.delete(node.id);
                        if (defaultExpanded) expandedStates.add('collapsed-' + node.id);
                    }
                });

                toggleWrapper.appendChild(btn);
                solBlock.appendChild(toggleWrapper);
                solBlock.appendChild(region);
            }

            wrapper.appendChild(solBlock);
        }

        // 3. Children (Recursion)
        if (node.children && node.children.length > 0) {
            const childrenContainer = document.createElement('div');
            childrenContainer.className = 'question-children';
            node.children.forEach(child => {
                childrenContainer.appendChild(createQuestionNode(child, depth + 1, paper));
            });
            wrapper.appendChild(childrenContainer);
        }

        return wrapper;
    }

    // --- Rendering Navigation ---

    function renderNavigation(paper) {
        // Clear both lists
        desktopNavList.innerHTML = '';
        mobileNavList.innerHTML = '';

        const list = document.createElement('ul');
        list.className = 'nav-list';

        if (paper.sections) {
            paper.sections.forEach(sec => {
                // Section Label (if exists)
                if (sec.label && sec.label.trim().length > 0) {
                    const li = document.createElement('li');
                    li.className = 'nav-section-label';
                    li.textContent = sec.label;
                    list.appendChild(li);
                }
                // Items
                sec.questions.forEach(q => buildNavTree(q, list, 0));
            });
        } else if (paper.questions) {
            paper.questions.forEach(q => buildNavTree(q, list, 0));
        }

        // Clone for Mobile
        const mobileList = list.cloneNode(true);

        desktopNavList.appendChild(list);
        mobileNavList.appendChild(mobileList);

        setupNavInteractions(desktopNavList);
        setupNavInteractions(mobileNavList);
    }

    function buildNavTree(node, container, depth) {
        const li = document.createElement('li');
        const a = document.createElement('a');
        a.className = 'nav-item';
        a.textContent = node.id;
        a.setAttribute('data-target', `q-${node.id}`);
        a.setAttribute('data-depth', depth);
        
        li.appendChild(a);
        container.appendChild(li);

        if (node.children) {
            node.children.forEach(child => buildNavTree(child, container, depth + 1));
        }
    }

    function setupNavInteractions(container) {
        container.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const targetId = item.getAttribute('data-target');
                const target = document.getElementById(targetId);
                if (target) {
                    // Scroll logic with offset
                    const offset = 80; // header + padding
                    const bodyRect = document.body.getBoundingClientRect().top;
                    const elementRect = target.getBoundingClientRect().top;
                    const elementPosition = elementRect - bodyRect;
                    const offsetPosition = elementPosition - offset;

                    window.scrollTo({
                        top: offsetPosition,
                        behavior: "smooth"
                    });
                    
                    // Close mobile drawer if open
                    closeDrawer();
                }
            });
        });
    }

    // --- Scroll Spy / Active Nav ---
    
    window.addEventListener('scroll', throttle(updateActiveNav, 100));

    function updateActiveNav() {
        // Find current question in view
        const questions = document.querySelectorAll('.question-node');
        let current = null;
        
        // Simple logic: first question whose top is above viewport center (or close)
        const threshold = window.innerHeight * 0.3; 
        
        for (const q of questions) {
            const rect = q.getBoundingClientRect();
            if (rect.top < threshold && rect.bottom > 0) {
                current = q.getAttribute('data-id');
                // Don't break immediately, deeper children might be better matches? 
                // Actually the tree order traversal usually puts parents first. 
                // We want the most specific visible one.
                // Let's stick with the last one that satisfies condition (top < threshold).
            }
        }

        if (current && current !== activeNavId) {
            activeNavId = current;
            highlightNav(current);
        }
    }

    function highlightNav(id) {
        [desktopNavList, mobileNavList].forEach(list => {
            if (!list) return;
            // Unset
            list.querySelectorAll('.nav-item.active').forEach(el => el.classList.remove('active'));
            // Set
            // Note: identifiers in payload might have ( ) requiring escape for selectors, 
            // but we search by textContent or data attribute loop to be safe.
            const target = Array.from(list.querySelectorAll('.nav-item')).find(el => el.textContent === id);
            if (target) {
                target.classList.add('active');
                // Optional: Scroll nav rail to keep active in view (Desktop only)
                if (list === desktopNavList) {
                   // simple logic to keep visible
                }
            }
        });
    }

    function throttle(func, limit) {
        let lastFunc;
        let lastRan;
        return function() {
            const context = this;
            const args = arguments;
            if (!lastRan) {
                func.apply(context, args);
                lastRan = Date.now();
            } else {
                clearTimeout(lastFunc);
                lastFunc = setTimeout(function() {
                    if ((Date.now() - lastRan) >= limit) {
                        func.apply(context, args);
                        lastRan = Date.now();
                    }
                }, limit - (Date.now() - lastRan));
            }
        }
    }

    // --- Mobile Drawer Logic ---
    mobileJumpBtn.addEventListener('click', () => {
        mobileDrawer.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    });

    function closeDrawer() {
        mobileDrawer.classList.add('hidden');
        document.body.style.overflow = '';
    }

    drawerClose.addEventListener('click', closeDrawer);
    drawerOverlay.addEventListener('click', closeDrawer);

</script>
</body>
</html>
