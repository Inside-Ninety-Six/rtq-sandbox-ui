<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"ABC","indexWithinVariant":"60","totalWithinVariant":"320","hueFamily":"teal","intensityMode":"deep_theme","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-09T12:42:52.275Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;ABC&quot;,&quot;indexWithinVariant&quot;:&quot;60&quot;,&quot;totalWithinVariant&quot;:&quot;320&quot;,&quot;hueFamily&quot;:&quot;teal&quot;,&quot;intensityMode&quot;:&quot;deep_theme&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-09T12:42:52.275Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Viewer (Stage 6 Baseline)</title>

    <!-- FONTS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- KATEX (No integrity, per Stage 6 instructions) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- MARKDOWN-IT (No integrity) -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <!-- TAILWIND (Prototyping build) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- CONFIGURATION & TOKENS (ColorLab C: Deep Theme + ColorLab B: Teal) -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        // Deep Theme (Light Only) - Teal Family (H=190 approx)
                        // Page: Viewport background (L~0.95, C~0.09)
                        page: 'oklch(0.95 0.09 190)',
                        
                        // Frame: Shell base surface (L~0.92, C~0.11) - Distinct from page and paper
                        frame: 'oklch(0.92 0.11 190)',
                        
                        // Paper: Content surface (L~0.99, C~0.06) - Brightest
                        paper: 'oklch(0.99 0.06 190)',
                        
                        // Text
                        primary: 'oklch(0.20 0.015 190)',
                        secondary: 'oklch(0.35 0.02 190)',
                        tertiary: 'oklch(0.45 0.02 190)', // Navigation inactive
                        
                        // Accent (Links, Focus, Active Nav) - (L~0.50, C~0.22)
                        accent: 'oklch(0.50 0.22 190)',
                        
                        // Surfaces
                        wash: 'oklch(0.96 0.08 190)', // Solution details wash
                        border: 'oklch(0.85 0.02 190)', // Hairlines
                    },
                    spacing: {
                        '18': '4.5rem',
                    }
                }
            }
        }
    </script>

    <style>
        /* BASE STYLES & OVERRIDES */
        body {
            background-color: theme('colors.page');
            color: theme('colors.primary');
            -webkit-font-smoothing: antialiased;
        }

        /* SCROLLBAR HIDING for Navigation */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* KATEX CONTAINMENT INVARIANT */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding-bottom: 4px; /* Space for scrollbar if needed */
            -webkit-overflow-scrolling: touch;
        }
        
        /* Block-level math background only (Deep Theme nuance) */
        .katex-display > .katex {
            background-color: rgba(0,0,0,0.02); /* Very subtle underlay for block math */
            padding: 0.5rem;
            border-radius: 4px;
        }
        
        /* Inline math background forbidden */
        .katex {
            background-color: transparent !important;
        }

        /* TABLE STYLING (Markdown) */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
            font-size: 0.95em;
        }
        th {
            font-weight: 600;
            text-align: left;
            border-bottom: 1px solid theme('colors.border');
            padding: 0.5rem;
        }
        td {
            border-bottom: 1px solid theme('colors.border');
            padding: 0.5rem;
        }
        /* Table scroll wrapper for mobile */
        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* FOCUS STATES (Restrained, Accent) */
        *:focus-visible {
            outline: 2px solid theme('colors.accent');
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* UTILITIES */
        .prose-content p {
            margin-bottom: 0.75rem;
            line-height: 1.6;
        }
        .prose-content p:last-child {
            margin-bottom: 0;
        }
        .prose-content ul {
            list-style-type: disc;
            padding-left: 1.25rem;
            margin-bottom: 0.75rem;
        }
        .prose-content ol {
            list-style-type: decimal;
            padding-left: 1.25rem;
            margin-bottom: 0.75rem;
        }

        /* SVG Passthrough */
        svg {
            max-width: 100%;
            height: auto;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen text-base">

    <!-- TOP CONTROLS REGION -->
    <!-- Aligned to frame via max-w container -->
    <div class="w-full flex justify-center sticky top-0 z-40 bg-page/90 backdrop-blur-sm border-b border-border/50">
        <div class="w-full max-w-[1024px] px-4 md:px-6 h-14 flex items-center justify-between">
            <!-- Paper Selector -->
            <div class="flex items-center gap-2">
                <label for="paper-select" class="text-sm font-medium text-secondary">Paper</label>
                <select id="paper-select" class="bg-frame border border-border text-primary text-sm rounded px-2 py-1 focus:ring-1 focus:ring-accent">
                    <option disabled selected>Loading papers...</option>
                </select>
            </div>

            <!-- Mobile Jump To Trigger -->
            <button id="mobile-jump-trigger" class="md:hidden text-sm font-medium text-accent flex items-center gap-1" aria-label="Jump to question">
                Jump to
                <svg width="16" height="16" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-4 h-4"><path d="M4.18179 6.18181C4.35753 6.00608 4.64245 6.00608 4.81819 6.18181L7.49999 8.86362L10.1818 6.18181C10.3575 6.00608 10.6424 6.00608 10.8182 6.18181C10.9939 6.35755 10.9939 6.64247 10.8182 6.81821L7.81819 9.81821C7.73379 9.9026 7.61934 9.95001 7.49999 9.95001C7.38064 9.95001 7.26618 9.9026 7.18179 9.81821L4.18179 6.81821C4.00605 6.64247 4.00605 6.35755 4.18179 6.18181Z" fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
            </button>
        </div>
    </div>

    <!-- DOCUMENT FRAME SHELL -->
    <main class="flex-grow w-full flex justify-center bg-frame">
        <!-- Frame Base Surface context is 'bg-frame' -->
        <div class="w-full max-w-[1024px] flex relative">
            
            <!-- DESKTOP NAVIGATION RAIL -->
            <nav class="hidden md:block w-64 flex-shrink-0 sticky top-14 h-[calc(100vh-3.5rem)] pt-6 pb-12 pr-6 overflow-y-auto no-scrollbar" aria-label="Paper navigation">
                <ul id="desktop-nav-list" class="flex flex-col gap-1">
                    <!-- Nav items injected here -->
                </ul>
            </nav>

            <!-- PAPER CONTENT COLUMN -->
            <div class="flex-1 min-w-0 pt-6 pb-24 px-4 md:px-0 md:pl-8" id="paper-region">
                <!-- Paper Surface -->
                <article id="paper-content" class="bg-paper shadow-sm min-h-[500px] p-6 md:p-12 md:max-w-[48rem]">
                    <div class="flex items-center justify-center h-64 text-secondary italic">
                        Select a paper to begin.
                    </div>
                </article>
            </div>

        </div>
    </main>

    <!-- MOBILE NAVIGATION DRAWER -->
    <div id="mobile-drawer" class="fixed inset-0 z-50 transform translate-y-full transition-transform duration-300 md:hidden" aria-hidden="true">
        <!-- Scrim -->
        <div id="mobile-drawer-scrim" class="absolute inset-0 bg-primary/20 backdrop-blur-sm opacity-0 transition-opacity duration-300"></div>
        
        <!-- Drawer Content -->
        <div class="absolute bottom-0 left-0 right-0 bg-frame rounded-t-xl max-h-[80vh] flex flex-col shadow-xl">
            <!-- Header -->
            <div class="flex items-center justify-between px-4 py-3 border-b border-border">
                <span class="font-medium text-primary">Jump to</span>
                <button id="mobile-drawer-close" class="text-secondary p-2 hover:text-primary">Close</button>
            </div>
            
            <!-- List -->
            <nav class="overflow-y-auto p-4 flex-1">
                <ul id="mobile-nav-list" class="flex flex-col gap-3">
                    <!-- Nav items injected here -->
                </ul>
            </nav>
        </div>
    </div>

    <!-- RUNTIME CONSTANTS & LOGIC -->
    <script>
        // --- STAGE 0 CONSTANTS (AUTHORITATIVE) ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // --- GLOBAL STATE ---
        let rawPayload = null;
        let activePaperKey = null;
        let activePaperData = null;
        // expandedQuestions maps QuestionNodeID -> boolean
        const expandedQuestions = new Map(); 

        // --- MARKDOWN INIT (STAGE 6 CONFIG) ---
        const md = window.markdownit ? window.markdownit({
            html: true,
            linkify: true,
            breaks: false, // Must be false for KaTeX
        }) : null;

        if (md) {
            md.inline.ruler.disable(['escape']);
        }

        // --- DOM ELEMENTS ---
        const els = {
            paperSelect: document.getElementById('paper-select'),
            paperContent: document.getElementById('paper-content'),
            desktopNavList: document.getElementById('desktop-nav-list'),
            mobileNavList: document.getElementById('mobile-nav-list'),
            mobileJumpTrigger: document.getElementById('mobile-jump-trigger'),
            mobileDrawer: document.getElementById('mobile-drawer'),
            mobileDrawerScrim: document.getElementById('mobile-drawer-scrim'),
            mobileDrawerClose: document.getElementById('mobile-drawer-close'),
        };

        // --- INITIALISATION ---
        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error('Network response was not ok');
                rawPayload = await response.json();
                
                if (!rawPayload || !rawPayload.papers || !Array.isArray(rawPayload.papers)) {
                    throw new Error('Invalid payload structure');
                }

                populatePaperSelector();
                
                // Load first paper by default
                if (rawPayload.papers.length > 0) {
                    loadPaper(rawPayload.papers[0].key);
                }

            } catch (err) {
                console.error("Payload load failed", err);
                renderErrorState();
            }
        }

        function renderErrorState() {
            els.paperContent.innerHTML = `
                <div class="flex items-center justify-center h-64 text-red-700 font-bold border-2 border-red-100 bg-red-50 p-4 text-center">
                    PAPERS PAYLOAD MISSING
                </div>
            `;
            els.paperSelect.innerHTML = '<option disabled>Error loading papers</option>';
        }

        function populatePaperSelector() {
            els.paperSelect.innerHTML = '';
            rawPayload.papers.forEach(paper => {
                const opt = document.createElement('option');
                opt.value = paper.key;
                opt.textContent = paper.label || paper.key;
                els.paperSelect.appendChild(opt);
            });
            els.paperSelect.disabled = false;
            
            els.paperSelect.addEventListener('change', (e) => {
                loadPaper(e.target.value);
            });
        }

        function loadPaper(paperKey) {
            const paper = rawPayload.papers.find(p => p.key === paperKey);
            if (!paper) return;

            activePaperKey = paperKey;
            activePaperData = paper;
            
            // Reset state
            expandedQuestions.clear();
            const defaultExpanded = paper.defaults?.expandedAll !== false;

            // Generate Nav Model & Render Content
            // We need to flatten the structure for navigation while keeping tree for rendering
            const navItems = [];
            
            // Helper to process nodes for nav
            function processNavNodes(nodes, depth = 0) {
                nodes.forEach(node => {
                    navItems.push({ id: node.id, depth: depth });
                    if (node.children) processNavNodes(node.children, depth + 1);
                });
            }

            // Handle Sections vs Flat
            if (paper.sections) {
                paper.sections.forEach(section => {
                    if (section.label && section.label.trim().length > 0) {
                        navItems.push({ type: 'section', label: section.label });
                    }
                    if (section.questions) processNavNodes(section.questions);
                });
            } else if (paper.questions) {
                processNavNodes(paper.questions);
            }

            renderNavigation(navItems);
            renderPaperContent(paper, defaultExpanded);

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'auto' });
        }

        // --- RENDERING: NAVIGATION ---
        function renderNavigation(navItems) {
            const createNavHTML = (isMobile) => {
                return navItems.map(item => {
                    if (item.type === 'section') {
                        // Section Label
                        return `
                            <li class="pt-4 pb-2 text-xs font-semibold text-tertiary uppercase tracking-wider select-none">
                                ${escapeHTML(item.label)}
                            </li>
                        `;
                    }
                    
                    // Question Item
                    // Hierarchy via typographic scale/quietness (opacity/size)
                    // Depth 0: normal
                    // Depth 1+: smaller/lighter
                    const isSub = item.depth > 0;
                    const baseClass = "block py-1 text-left hover:text-primary transition-colors cursor-pointer select-none";
                    const depthClass = isSub ? "text-xs text-secondary font-normal" : "text-sm text-secondary font-medium";
                    
                    return `
                        <li>
                            <a href="#q-${item.id}" 
                               class="${baseClass} ${depthClass}"
                               data-qid="${item.id}"
                               onclick="handleNavClick(event, '${item.id}')"
                            >
                                ${escapeHTML(item.id)}
                            </a>
                        </li>
                    `;
                }).join('');
            };

            els.desktopNavList.innerHTML = createNavHTML(false);
            els.mobileNavList.innerHTML = createNavHTML(true);
            updateActiveNav();
        }

        window.handleNavClick = function(e, id) {
            e.preventDefault();
            const target = document.getElementById(`q-${id}`);
            if (target) {
                // Scroll with offset for sticky header
                const headerOffset = 80; // 3.5rem + gap
                const elementPosition = target.getBoundingClientRect().top;
                const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
                
                window.scrollTo({
                    top: offsetPosition,
                    behavior: 'smooth'
                });
                
                // Flash focus style
                target.classList.add('ring-2', 'ring-accent', 'ring-offset-4');
                setTimeout(() => target.classList.remove('ring-2', 'ring-accent', 'ring-offset-4'), 2000);
            }
            closeMobileDrawer();
        };

        // --- RENDERING: PAPER CONTENT ---
        function renderPaperContent(paper, defaultExpanded) {
            let html = '';

            // Renderer recursive
            function renderNodes(nodes, level) {
                return nodes.map((node, index) => renderQuestionNode(node, level, defaultExpanded, index === 0)).join('');
            }

            if (paper.sections) {
                paper.sections.forEach((section, idx) => {
                    if (section.label && section.label.trim()) {
                        html += `
                            <div class="mb-8 pt-4 border-b border-border">
                                <h2 class="text-lg font-semibold text-secondary mb-2">${escapeHTML(section.label)}</h2>
                            </div>
                        `;
                    }
                    html += `<div class="space-y-12 md:space-y-16">`; // Top level spacing
                    html += renderNodes(section.questions, 0);
                    html += `</div>`;
                    // Spacing between sections
                    if (idx < paper.sections.length - 1) {
                        html += `<div class="h-16 md:h-24"></div>`;
                    }
                });
            } else if (paper.questions) {
                html += `<div class="space-y-12 md:space-y-16">`;
                html += renderNodes(paper.questions, 0);
                html += `</div>`;
            }

            els.paperContent.innerHTML = html;
            
            // Post-render: KaTeX
            renderMathInElement(els.paperContent, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false}
                ],
                throwOnError: false
            });
        }

        function renderQuestionNode(node, level, defaultExpanded, isFirst) {
            const qId = node.id;
            // Check if solution block exists
            const hasSolutionBlock = !!node.solutionBlock;
            const hasAnswer = hasSolutionBlock && !!node.solutionBlock.answer;
            const hasDetails = hasSolutionBlock && !!node.solutionBlock.solutionDetails;

            // Defaults logic: if undefined in map, use paper default
            if (!expandedQuestions.has(qId) && hasDetails) {
                expandedQuestions.set(qId, defaultExpanded);
            }
            const isExpanded = expandedQuestions.get(qId);

            // Separation logic
            // Top level (level 0) handled by parent container space-y
            // Children (level > 0) need indentation and smaller spacing
            const indentClass = level > 0 ? "ml-4 md:ml-8 mt-6 border-l-2 border-border/30 pl-4" : "";
            
            return `
                <div id="q-${qId}" class="group relative ${indentClass}" data-level="${level}">
                    <!-- Question Body -->
                    <div class="mb-4">
                        <div class="flex items-baseline gap-3">
                            <span class="text-sm font-bold text-secondary flex-shrink-0 select-none w-8 md:w-10 text-right mr-1" aria-hidden="true">${qId}</span>
                            <div class="prose-content text-primary text-lg md:text-xl font-medium leading-relaxed max-w-none flex-1">
                                ${renderMarkdown(node.question)}
                            </div>
                        </div>
                    </div>

                    <!-- Solution Block -->
                    ${hasSolutionBlock ? `
                        <div class="pl-12 md:pl-14">
                            <!-- Answer -->
                            ${hasAnswer ? `
                                <div class="mb-3 flex gap-3 items-baseline">
                                    <span class="text-xs font-bold text-tertiary uppercase tracking-wider w-16 flex-shrink-0">Answer</span>
                                    <div class="prose-content text-primary font-medium">
                                        ${renderMarkdown(node.solutionBlock.answer)}
                                    </div>
                                </div>
                            ` : ''}

                            <!-- Disclosure Control -->
                            ${hasDetails ? `
                                <div class="mt-2 mb-4">
                                    <button 
                                        onclick="toggleWorking('${qId}')"
                                        class="text-sm font-medium text-accent hover:underline flex items-center gap-1 focus:outline-none focus-visible:ring-2 focus-visible:ring-accent rounded px-1 -ml-1"
                                        aria-expanded="${isExpanded}"
                                        aria-controls="sd-${qId}"
                                    >
                                        <span>${isExpanded ? 'Hide working' : 'Show working'}</span>
                                        <svg class="w-4 h-4 transform transition-transform ${isExpanded ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                    </button>
                                </div>

                                <!-- Solution Details Region -->
                                <div id="sd-${qId}" class="${isExpanded ? 'block' : 'hidden'}">
                                    <div class="bg-wash rounded-sm p-4 md:p-6 border border-border/50 text-base">
                                        ${renderSolutionDetails(node.solutionBlock.solutionDetails)}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}

                    <!-- Children -->
                    ${node.children && node.children.length > 0 ? `
                        <div class="mt-4">
                            ${node.children.map(child => renderQuestionNode(child, level + 1, defaultExpanded)).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderSolutionDetails(sd) {
            let html = '';
            
            // 1. Keep in mind
            if (sd.keepInMind) {
                html += `
                    <div class="mb-6">
                        <h4 class="text-xs font-bold text-secondary uppercase tracking-wider mb-2">Keep in mind</h4>
                        <div class="prose-content text-secondary text-sm">
                            ${renderMarkdown(sd.keepInMind)}
                        </div>
                    </div>
                `;
            }

            // 2. Formulas used
            if (sd.formulasUsed) {
                html += `
                    <div class="mb-6">
                        <h4 class="text-xs font-bold text-secondary uppercase tracking-wider mb-2">Formulas used</h4>
                        <div class="prose-content text-secondary text-sm">
                            ${renderMarkdown(sd.formulasUsed)}
                        </div>
                    </div>
                `;
            }

            // 3. Working
            if (sd.working) {
                html += `
                    <div class="mb-6">
                        <h4 class="text-xs font-bold text-secondary uppercase tracking-wider mb-3">Working</h4>
                        <div class="prose-content text-primary">
                            ${renderMarkdown(sd.working)}
                        </div>
                    </div>
                `;
            }

            // 4. Alternative working
            if (sd.alternativeWorking && Array.isArray(sd.alternativeWorking)) {
                sd.alternativeWorking.forEach(alt => {
                    html += `
                        <div class="mt-8 pt-6 border-t border-border">
                            <h4 class="text-xs font-bold text-secondary uppercase tracking-wider mb-3">Alternative working</h4>
                            <div class="prose-content text-primary">
                                ${renderMarkdown(alt)}
                            </div>
                        </div>
                    `;
                });
            } else if (sd.alternativeWorking && typeof sd.alternativeWorking === 'string') {
                 html += `
                        <div class="mt-8 pt-6 border-t border-border">
                            <h4 class="text-xs font-bold text-secondary uppercase tracking-wider mb-3">Alternative working</h4>
                            <div class="prose-content text-primary">
                                ${renderMarkdown(sd.alternativeWorking)}
                            </div>
                        </div>
                    `;
            }

            return html;
        }

        function renderMarkdown(text) {
            if (!text) return '';
            if (!md) return text; // Fallback
            // Wrap tables in overflow container
            const html = md.render(text);
            return html.replace(/<table>/g, '<div class="table-wrapper"><table>').replace(/<\/table>/g, '</table></div>');
        }

        function escapeHTML(str) {
            return str.replace(/[&<>'"]/g, 
                tag => ({
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    "'": '&#39;',
                    '"': '&quot;'
                }[tag]));
        }

        window.toggleWorking = function(qId) {
            const current = expandedQuestions.get(qId);
            expandedQuestions.set(qId, !current);
            
            // Re-render button and details area without full page reload
            // In a real app we'd use fine-grained DOM updates. 
            // For this prototype, we'll toggle classes and text manually to preserve scroll.
            
            const btn = document.querySelector(`button[onclick="toggleWorking('${qId}')"]`);
            const region = document.getElementById(`sd-${qId}`);
            
            if (btn && region) {
                const newState = !current;
                
                // Update Button
                btn.setAttribute('aria-expanded', newState);
                const span = btn.querySelector('span');
                const svg = btn.querySelector('svg');
                
                if (span) span.textContent = newState ? 'Hide working' : 'Show working';
                if (svg) {
                    if (newState) svg.classList.add('rotate-180');
                    else svg.classList.remove('rotate-180');
                }
                
                // Update Region
                if (newState) {
                    region.classList.remove('hidden');
                    region.classList.add('block');
                } else {
                    region.classList.remove('block');
                    region.classList.add('hidden');
                }
            }
        };

        // --- SCROLL SPY (Nav Active State) ---
        function updateActiveNav() {
            // Find visible question
            // We use intersection observer or scroll check
            // Simple scroll check
            const questions = document.querySelectorAll('[id^="q-"]');
            let activeId = null;
            
            for (const q of questions) {
                const rect = q.getBoundingClientRect();
                if (rect.top >= 0 && rect.top < window.innerHeight / 2) {
                    activeId = q.id.replace('q-', '');
                    break;
                }
            }
            if (!activeId && questions.length > 0) {
                 // Check if we are at bottom
                 if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 100) {
                     activeId = questions[questions.length - 1].id.replace('q-', '');
                 } else if (window.scrollY < 100) {
                     activeId = questions[0].id.replace('q-', '');
                 }
            }

            // Update UI
            if (activeId) {
                document.querySelectorAll('nav a').forEach(a => {
                    const isTarget = a.getAttribute('data-qid') === activeId;
                    if (isTarget) {
                        a.classList.add('font-bold', 'text-accent');
                        a.classList.remove('font-medium', 'text-secondary');
                        // Ensure visible in nav rail
                        a.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                    } else {
                        a.classList.remove('font-bold', 'text-accent');
                        a.classList.add('text-secondary');
                        if (a.parentElement.classList.contains('text-xs')) {
                             a.classList.add('font-normal');
                        } else {
                             a.classList.add('font-medium');
                        }
                    }
                });
            }
        }
        
        // Throttled scroll listener
        let isScrolling = false;
        window.addEventListener('scroll', () => {
            if (!isScrolling) {
                window.requestAnimationFrame(() => {
                    updateActiveNav();
                    isScrolling = false;
                });
                isScrolling = true;
            }
        });

        // --- MOBILE DRAWER LOGIC ---
        function openMobileDrawer() {
            els.mobileDrawer.classList.remove('translate-y-full');
            els.mobileDrawerScrim.classList.remove('opacity-0');
            document.body.style.overflow = 'hidden';
        }

        function closeMobileDrawer() {
            els.mobileDrawer.classList.add('translate-y-full');
            els.mobileDrawerScrim.classList.add('opacity-0');
            document.body.style.overflow = '';
        }

        els.mobileJumpTrigger.addEventListener('click', openMobileDrawer);
        els.mobileDrawerClose.addEventListener('click', closeMobileDrawer);
        els.mobileDrawerScrim.addEventListener('click', closeMobileDrawer);

        // --- RUN ---
        init();

    </script>
</body>
</html>
