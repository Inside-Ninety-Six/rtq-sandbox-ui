<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"ABC","indexWithinVariant":"120","totalWithinVariant":"320","hueFamily":"cyan","intensityMode":"deep_theme","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-09T15:28:16.498Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;ABC&quot;,&quot;indexWithinVariant&quot;:&quot;120&quot;,&quot;totalWithinVariant&quot;:&quot;320&quot;,&quot;hueFamily&quot;:&quot;cyan&quot;,&quot;intensityMode&quot;:&quot;deep_theme&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-09T15:28:16.498Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>

    <!-- Tailwind CSS (via CDN for prototype) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- KaTeX CSS (No integrity, no crossorigin per Stage 6 instructions) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- CSS Variables & Base Styles (ColorLab C: Deep Theme - Cyan) -->
    <style>
        :root {
            /* 
               COLORLAB C: DEEP THEME (Light Mode Only)
               Hue Family: Cyan (approx h=200)
               
               Numeric Bands Compliance:
               - Page Bg: L[0.92-0.98], C[0.08-0.16]
               - Frame Bg: L[0.90-0.96], C[0.08-0.16]
               - Paper Bg: L[0.94-0.99], C[0.06-0.14]
               - Text Primary: L[0.15-0.25], C<=0.015
               - Text Secondary: L[0.25-0.40], C<=0.020
               - Accent: L[0.45-0.65], C[0.16-0.26]
            */
            
            --hue: 200;

            /* Surfaces */
            --color-page-bg: oklch(0.94 0.12 var(--hue));
            --color-frame-bg: oklch(0.92 0.12 var(--hue));
            --color-paper-bg: oklch(0.97 0.08 var(--hue));
            
            /* Wash Surfaces (Solution Details) */
            /* Must be tinted, C[0.05..0.10] */
            --color-wash: oklch(0.95 0.07 var(--hue));

            /* Text */
            --color-text-primary: oklch(0.20 0.015 var(--hue));
            --color-text-secondary: oklch(0.35 0.02 var(--hue));

            /* Accent (Links, Focus, Nav Marker, Toggle) */
            --color-accent: oklch(0.50 0.20 var(--hue));
            --color-accent-hover: oklch(0.45 0.20 var(--hue));

            /* UI Elements */
            --color-border: oklch(0.85 0.02 var(--hue)); /* Neutral-leaning */
            --color-focus-ring: var(--color-accent);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-page-bg);
            color: var(--color-text-primary);
            -webkit-font-smoothing: antialiased;
            overflow-y: scroll; /* Always show scrollbar to prevent shift */
        }

        /* Utility for hiding scrollbars but keeping functionality */
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* KaTeX Containment Invariant */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 4px; /* Space for scrollbar if needed */
        }
        
        /* Markdown Content Styling */
        .md-content p {
            margin-bottom: 0.75em;
            line-height: 1.6;
        }
        .md-content p:last-child {
            margin-bottom: 0;
        }
        .md-content ul {
            list-style-type: disc;
            padding-left: 1.25em;
            margin-bottom: 0.75em;
        }
        .md-content ol {
            list-style-type: decimal;
            padding-left: 1.25em;
            margin-bottom: 0.75em;
        }
        /* Minimal structural tables */
        .md-content table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1em;
            font-size: 0.95em;
        }
        .md-content th, .md-content td {
            border: 1px solid var(--color-border);
            padding: 0.5em;
            text-align: left;
        }
        .md-content th {
            font-weight: 600;
        }
        
        /* Focus Styles */
        *:focus-visible {
            outline: 2px solid var(--color-focus-ring);
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* Layout Utilities */
        .layout-shell {
            max-width: 1200px; /* Standard constraint */
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        @media (min-width: 1024px) {
            .layout-shell {
                flex-direction: row;
                align-items: flex-start;
                background-color: var(--color-frame-bg); /* Desktop shell background */
            }
        }
    </style>

    <script>
        // Tailwind Configuration to use CSS Variables
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        page: 'var(--color-page-bg)',
                        frame: 'var(--color-frame-bg)',
                        paper: 'var(--color-paper-bg)',
                        wash: 'var(--color-wash)',
                        primary: 'var(--color-text-primary)',
                        secondary: 'var(--color-text-secondary)',
                        accent: 'var(--color-accent)',
                        'accent-hover': 'var(--color-accent-hover)',
                        border: 'var(--color-border)',
                    }
                }
            }
        }
    </script>

    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
</head>
<body class="text-primary text-base">

    <!-- Root App Container -->
    <div id="app"></div>

    <script>
        // --- STAGE 0: CONSTANTS ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json"; // Required by brief, though unused in specific logic

        // --- GLOBAL STATE ---
        let appState = {
            loading: true,
            error: false,
            papers: [],
            currentPaperId: null,
            expandedWorkings: {}, // Map<questionId, boolean>
            mobileNavOpen: false
        };

        // --- MARKDOWN RENDERER CONFIG (Authoritative) ---
        const md = window.markdownit ? window.markdownit({
            html: true, // Allow inline SVG
            linkify: true,
            breaks: false // Critical: prevent <br> in math
        }) : null;

        if (md) {
            // Disable escape rule to preserve TeX backslashes
            md.inline.ruler.disable(['escape']);
        }

        // --- DATA FETCHING ---
        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Payload not found");
                const data = await response.json();
                
                appState.papers = data.papers || [];
                if (appState.papers.length > 0) {
                    selectPaper(appState.papers[0].key);
                } else {
                    appState.error = true;
                }
            } catch (e) {
                console.error(e);
                appState.error = true;
            } finally {
                appState.loading = false;
                render();
            }
        }

        // --- LOGIC ACTIONS ---
        function selectPaper(paperKey) {
            const paper = appState.papers.find(p => p.key === paperKey);
            if (!paper) return;

            appState.currentPaperId = paperKey;
            
            // Reset state
            appState.expandedWorkings = {};
            
            // Apply defaults
            const expandAll = paper.defaults?.expandedAll !== false;
            
            // Recursive function to set default state for all questions with solutionDetails
            const initDefaults = (nodes) => {
                if (!nodes) return;
                nodes.forEach(node => {
                    if (node.solutionBlock?.solutionDetails) {
                        appState.expandedWorkings[node.id] = expandAll;
                    }
                    if (node.children) initDefaults(node.children);
                });
            };
            
            if (paper.questions) initDefaults(paper.questions);
            if (paper.sections) {
                paper.sections.forEach(sec => initDefaults(sec.questions));
            }

            render();
            // Scroll to top
            window.scrollTo(0, 0);
        }

        function toggleWorking(questionId) {
            appState.expandedWorkings[questionId] = !appState.expandedWorkings[questionId];
            render(); 
            // Note: render() is a full re-render for this prototype. 
            // In a reactive framework, this would be fine-grained.
            // Post-render, we re-apply KaTeX.
        }

        function toggleMobileNav() {
            appState.mobileNavOpen = !appState.mobileNavOpen;
            render();
        }

        function scrollToQuestion(qId) {
            appState.mobileNavOpen = false;
            render(); // Close drawer
            setTimeout(() => {
                const el = document.getElementById(`q-${qId}`);
                if (el) {
                    el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 10);
        }

        // --- RENDERERS ---

        function render() {
            const app = document.getElementById('app');
            if (!app) return;

            if (appState.loading) {
                app.innerHTML = `<div class="p-8 text-center text-secondary">Loading...</div>`;
                return;
            }

            if (appState.error) {
                app.innerHTML = `<div class="p-8 text-center font-bold text-red-700">PAPERS PAYLOAD MISSING</div>`;
                return;
            }

            const currentPaper = appState.papers.find(p => p.key === appState.currentPaperId);
            
            // Flatten questions for navigation generation
            let flatNavItems = [];
            let navSections = [];
            
            if (currentPaper.sections) {
                // Sectioned paper
                currentPaper.sections.forEach(sec => {
                    let items = [];
                    const collectIds = (nodes) => {
                        nodes.forEach(n => {
                            items.push({ id: n.id, depth: 0 }); // Depth for nav hierarchy cue if needed
                            if(n.children) collectIds(n.children);
                        });
                    };
                    collectIds(sec.questions);
                    navSections.push({ label: sec.label, items: items });
                });
            } else {
                // Flat paper
                let items = [];
                const collectIds = (nodes, depth) => {
                    nodes.forEach(n => {
                        items.push({ id: n.id, depth: depth });
                        if(n.children) collectIds(n.children, depth + 1);
                    });
                };
                collectIds(currentPaper.questions || [], 0);
                flatNavItems = items;
            }

            // --- TEMPLATE CONSTRUCTION ---
            
            // 1. Mobile Drawer
            const mobileDrawer = appState.mobileNavOpen ? `
                <div class="fixed inset-0 z-50 flex">
                    <!-- Scrim -->
                    <div class="absolute inset-0 bg-black/50" onclick="toggleMobileNav()"></div>
                    <!-- Drawer -->
                    <div class="relative w-64 h-full bg-paper shadow-xl flex flex-col animate-in slide-in-from-left duration-200">
                        <div class="p-4 border-b border-border flex justify-between items-center">
                            <span class="font-semibold text-primary">Jump to</span>
                            <button onclick="toggleMobileNav()" class="text-secondary hover:text-primary p-2">âœ•</button>
                        </div>
                        <div class="flex-1 overflow-y-auto p-4 space-y-1">
                            ${renderNavList(flatNavItems, navSections, true)}
                        </div>
                    </div>
                </div>
            ` : '';

            // 2. Desktop Nav Rail
            const desktopNav = `
                <nav class="hidden lg:block w-64 flex-shrink-0 sticky top-0 h-screen overflow-y-auto no-scrollbar py-8 pl-6 pr-4 border-r border-transparent">
                    <div class="mb-8">
                        <label class="block text-xs font-medium text-secondary mb-2 uppercase tracking-wide">Select Paper</label>
                        <select onchange="selectPaper(this.value)" class="w-full bg-paper border border-border rounded p-2 text-sm text-primary focus:border-accent focus:ring-1 focus:ring-accent">
                            ${appState.papers.map(p => `<option value="${p.key}" ${p.key === appState.currentPaperId ? 'selected' : ''}>${p.label}</option>`).join('')}
                        </select>
                    </div>
                    <div class="space-y-1">
                        ${renderNavList(flatNavItems, navSections, false)}
                    </div>
                </nav>
            `;

            // 3. Main Content
            const mainContent = `
                <main class="flex-1 min-w-0 bg-paper min-h-screen">
                    <!-- Mobile Header / Top Controls -->
                    <div class="lg:hidden sticky top-0 z-30 bg-paper/95 backdrop-blur border-b border-border px-4 py-3 flex items-center justify-between gap-4">
                        <select onchange="selectPaper(this.value)" class="flex-1 max-w-[200px] bg-white border border-border rounded p-2 text-sm text-primary">
                             ${appState.papers.map(p => `<option value="${p.key}" ${p.key === appState.currentPaperId ? 'selected' : ''}>${p.label}</option>`).join('')}
                        </select>
                        <button onclick="toggleMobileNav()" class="text-accent text-sm font-medium hover:text-accent-hover">
                            Jump to
                        </button>
                    </div>

                    <!-- Paper Content -->
                    <div class="max-w-3xl mx-auto px-4 py-8 lg:py-12 lg:px-12">
                        ${renderPaperBody(currentPaper)}
                    </div>
                </main>
            `;

            // Combine
            app.innerHTML = `
                ${mobileDrawer}
                <div class="layout-shell">
                    ${desktopNav}
                    ${mainContent}
                </div>
            `;

            // Post-render: KaTeX
            renderMathInElement(document.body, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false}
                ],
                throwOnError: false
            });
        }

        // --- SUB-RENDERERS ---

        function renderNavList(items, sections, isMobile) {
            // Helper to render an item
            const renderItem = (item) => `
                <button onclick="scrollToQuestion('${item.id}')" 
                    class="block w-full text-left py-1 px-2 text-sm rounded transition-colors
                    ${item.depth > 0 ? 'text-secondary text-xs' : 'text-primary font-medium'}
                    hover:bg-accent/10 hover:text-accent focus:bg-accent/10 focus:text-accent
                    ">
                    ${item.id}
                </button>
            `;

            if (sections && sections.length > 0) {
                return sections.map(sec => `
                    <div class="mb-6">
                        ${sec.label ? `<div class="px-2 mb-2 text-xs font-semibold text-secondary uppercase tracking-wider">${sec.label}</div>` : ''}
                        <div class="space-y-0.5">
                            ${sec.items.map(renderItem).join('')}
                        </div>
                    </div>
                `).join('');
            } else {
                return items.map(renderItem).join('');
            }
        }

        function renderPaperBody(paper) {
            if (paper.sections) {
                return paper.sections.map((sec, idx) => `
                    <div class="mb-12">
                        ${sec.label ? `
                            <div class="mb-8 pb-2 border-b border-border/50">
                                <span class="text-xl font-semibold text-primary">${sec.label}</span>
                            </div>
                        ` : ''}
                        <div class="space-y-12"> <!-- Top-level spacing -->
                            ${sec.questions.map(q => renderQuestionNode(q, 0)).join('')}
                        </div>
                    </div>
                `).join('');
            } else {
                return `
                    <div class="space-y-12"> <!-- Top-level spacing -->
                        ${paper.questions.map(q => renderQuestionNode(q, 0)).join('')}
                    </div>
                `;
            }
        }

        function renderQuestionNode(node, depth) {
            // Determine solution block availability
            const sb = node.solutionBlock;
            const hasAnswer = sb && sb.answer;
            const hasDetails = sb && sb.solutionDetails;
            const isExpanded = appState.expandedWorkings[node.id];

            // Markdown Processing
            const qHtml = md ? md.render(node.question) : node.question;
            const aHtml = (hasAnswer && md) ? md.render(sb.answer) : (sb?.answer || '');

            // Styling based on nesting
            const isTopLevel = depth === 0;
            // Indentation for children
            const indentClass = depth > 0 ? 'ml-0 pl-4 border-l-2 border-transparent lg:pl-8 lg:border-l-0' : ''; 
            // We use simple spacing/padding for hierarchy as requested.

            return `
                <div id="q-${node.id}" class="group ${indentClass}">
                    <!-- Question Body -->
                    <div class="mb-4">
                        <div class="flex items-baseline gap-3">
                            <span class="flex-none font-bold text-secondary text-sm select-none w-8 text-right">${node.id}</span>
                            <div class="flex-1 text-lg text-primary leading-relaxed md-content">
                                ${qHtml}
                            </div>
                        </div>
                    </div>

                    <!-- Solution Block (Optional) -->
                    ${sb ? `
                        <div class="ml-11"> <!-- Aligned with text start -->
                            
                            <!-- Answer -->
                            ${hasAnswer ? `
                                <div class="mb-3">
                                    <div class="text-xs font-bold text-secondary uppercase tracking-wide mb-1">Answer</div>
                                    <div class="text-base text-primary md-content bg-transparent">
                                        ${aHtml}
                                    </div>
                                </div>
                            ` : ''}

                            <!-- Disclosure Control -->
                            ${hasDetails ? `
                                <div class="mb-3">
                                    <button onclick="toggleWorking('${node.id}')" 
                                        class="inline-flex items-center text-accent hover:text-accent-hover font-medium text-sm focus:outline-none focus:ring-2 focus:ring-accent rounded px-1 -ml-1 py-1">
                                        <span>${isExpanded ? 'Hide working' : 'Show working'}</span>
                                        <svg class="w-4 h-4 ml-1 transform transition-transform ${isExpanded ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                    </button>
                                </div>

                                <!-- Solution Details Region -->
                                ${isExpanded ? renderSolutionDetails(sb.solutionDetails) : ''}
                            ` : ''}
                        </div>
                    ` : ''}

                    <!-- Children -->
                    ${node.children && node.children.length > 0 ? `
                        <div class="mt-6 space-y-6">
                            ${node.children.map(child => renderQuestionNode(child, depth + 1)).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderSolutionDetails(details) {
            // details: { keepInMind, formulasUsed, working, alternativeWorking[] }
            
            const renderPart = (label, contentMarkdown, isList = false) => {
                if (!contentMarkdown) return '';
                const html = md ? md.render(contentMarkdown) : contentMarkdown;
                return `
                    <div class="mb-6 last:mb-0">
                        <div class="text-xs font-bold text-secondary uppercase tracking-wide mb-2">${label}</div>
                        <div class="text-sm text-primary md-content ${isList ? 'list-block' : ''}">
                            ${html}
                        </div>
                    </div>
                `;
            };

            const alts = details.alternativeWorking || [];

            return `
                <div class="bg-wash rounded p-4 border border-transparent animate-in fade-in duration-200">
                    ${renderPart('Keep in mind', details.keepInMind)}
                    ${renderPart('Formulas used', details.formulasUsed)}
                    ${renderPart('Working', details.working)}
                    ${alts.map((alt, i) => renderPart('Alternative working', alt)).join('')}
                </div>
            `;
        }

        // --- BOOTSTRAP ---
        document.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
