<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AB","indexWithinVariant":"95","totalWithinVariant":"200","hueFamily":"teal","intensityMode":"","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-08T17:42:11.230Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AB&quot;,&quot;indexWithinVariant&quot;:&quot;95&quot;,&quot;totalWithinVariant&quot;:&quot;200&quot;,&quot;hueFamily&quot;:&quot;teal&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-08T17:42:11.230Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>

    <!-- 1. Fonts (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- 2. KaTeX CSS (No SRI per Stage 6.0.7b) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <!-- 3. Tailwind CSS (CDN for prototype) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 4. Markdown-it -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <!-- 5. Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Configuration: ColorLab B (Teal) -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        // Forced Hue: Teal
                        brand: {
                            50: '#f0fdfa',
                            100: '#ccfbf1',
                            200: '#99f6e4',
                            300: '#5eead4',
                            400: '#2dd4bf',
                            500: '#14b8a6',
                            600: '#0d9488',
                            700: '#0f766e',
                            800: '#115e59',
                            900: '#134e4a',
                            950: '#042f2e',
                        },
                        // Paper-like Neutrals (Stone/Slate mix)
                        paper: {
                            bg: '#fafaf9', // stone-50
                            surface: '#ffffff',
                            text: '#1e293b', // slate-800
                            muted: '#64748b', // slate-500
                            border: '#e2e8f0', // slate-200
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Baseline Reset & Smooth Scroll */
        html {
            scroll-behavior: smooth;
        }
        body {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Nav Scrollbar Hiding */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* KaTeX Containment Invariant (Stage 6.0.8) */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            /* Minimal scrollbar for math overflow */
            scrollbar-width: thin; 
            padding-bottom: 4px;
        }
        
        /* Markdown Table Minimal Styling */
        table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 1rem;
            font-size: 0.95em;
        }
        th, td {
            border: 1px solid #e2e8f0; /* slate-200 */
            padding: 0.5rem;
            text-align: left;
        }
        th {
            font-weight: 600;
            background-color: transparent;
        }

        /* Focus Visibility (Stage 5.5.2) */
        *:focus-visible {
            outline: 2px solid #14b8a6; /* brand-500 */
            outline-offset: 2px;
        }
        
        /* Hide content logic */
        .hidden-content {
            display: none;
        }
        
        /* Drawer Transition */
        .drawer {
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .drawer-closed {
            transform: translateX(-100%);
        }
        .drawer-open {
            transform: translateX(0);
        }
    </style>
</head>
<body class="bg-paper-bg text-paper-text min-h-screen flex flex-col">

    <!-- STAGE 0 CONSTANTS -->
    <script>
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        // RTQ_SHADCN_TOKEN_PROFILES_PATH defined but unused in this vanilla prototype
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";
    </script>

    <!-- KaTeX JS (No SRI) -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- APP SHELL -->
    <div id="app-root" class="flex-1 flex flex-col md:flex-row max-w-7xl mx-auto w-full md:px-6 lg:px-8 relative">
        <!-- Loading State -->
        <div id="loading" class="p-12 text-center w-full text-paper-muted">Loading Paper...</div>
    </div>

    <!-- MAIN SCRIPT -->
    <script>
        // --- Markdown Renderer Config (Stage 6) ---
        const md = window.markdownit ? window.markdownit({
            html: true,
            linkify: true,
            breaks: false // Critical: prevent <br> in math
        }) : null;

        if (md) {
            md.inline.ruler.disable(['escape']); // Preserve TeX backslashes
        }

        // --- State Management ---
        let state = {
            papers: [],
            currentPaperIndex: 0,
            expandedNodes: new Set(), // Set of Question IDs
            isDrawerOpen: false
        };

        // --- Init ---
        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Network response was not ok");
                const payload = await response.json();
                
                if (!payload.papers || !Array.isArray(payload.papers)) throw new Error("Invalid payload format");

                state.papers = payload.papers;
                state.currentPaperIndex = 0;
                
                // Initialize default expansion states based on paper defaults
                initializeExpansionState();

                renderApp();
            } catch (error) {
                console.error(error);
                document.getElementById('app-root').innerHTML = `
                    <div class="p-12 w-full flex flex-col items-center justify-center text-red-700">
                        <div class="text-xl font-bold mb-2">PAPERS PAYLOAD MISSING</div>
                        <div class="text-sm opacity-75">Ensure RTQ_PAPERS_PAYLOAD_PATH resolves correctly.</div>
                    </div>
                `;
            }
        }

        function initializeExpansionState() {
            state.expandedNodes.clear();
            const currentPaper = state.papers[state.currentPaperIndex];
            const expandAll = currentPaper.defaults?.expandedAll !== false; // Default true unless explicitly false
            
            if (expandAll) {
                // Recursively mark all solution blocks as expanded
                const traverse = (nodes) => {
                    nodes.forEach(node => {
                        if (node.solutionBlock?.solutionDetails) {
                            state.expandedNodes.add(node.id);
                        }
                        if (node.children) traverse(node.children);
                    });
                };
                
                if (currentPaper.questions) traverse(currentPaper.questions);
                if (currentPaper.sections) {
                    currentPaper.sections.forEach(s => traverse(s.questions));
                }
            }
        }

        function renderApp() {
            const root = document.getElementById('app-root');
            root.innerHTML = '';
            
            // 1. Mobile Drawer Overlay/Container
            const mobileNav = renderMobileNav();
            root.appendChild(mobileNav);

            // 2. Desktop Nav Rail
            const desktopNav = renderDesktopNav();
            root.appendChild(desktopNav);

            // 3. Main Content Area (Paper)
            const mainCol = document.createElement('main');
            mainCol.className = "flex-1 min-w-0 py-6 px-4 md:pl-12 md:pr-0 md:py-8";
            
            // Top Controls (Paper Selector + Jump To Trigger)
            const topControls = renderTopControls();
            mainCol.appendChild(topControls);

            // Paper Content
            const paperContent = renderPaperContent();
            mainCol.appendChild(paperContent);

            root.appendChild(mainCol);

            // Post-Render: Icons & Math
            lucide.createIcons();
            renderMathInElement(root, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false}
                ],
                throwOnError: false
            });
        }

        // --- Renderers: Structure ---

        function renderTopControls() {
            const container = document.createElement('div');
            container.className = "flex items-center justify-between mb-8 pb-4 border-b border-paper-border";

            // Paper Selector
            const selectWrapper = document.createElement('div');
            selectWrapper.className = "relative";
            const select = document.createElement('select');
            select.className = "appearance-none bg-white border border-paper-border text-paper-text text-sm font-medium py-2 pl-3 pr-8 rounded-md shadow-sm focus:border-brand-500 focus:ring-1 focus:ring-brand-500 cursor-pointer";
            select.onchange = (e) => {
                state.currentPaperIndex = parseInt(e.target.value);
                initializeExpansionState();
                renderApp();
            };

            state.papers.forEach((p, idx) => {
                const opt = document.createElement('option');
                opt.value = idx;
                opt.text = p.label;
                opt.selected = idx === state.currentPaperIndex;
                select.appendChild(opt);
            });
            
            // Chevron down icon for select
            const icon = document.createElement('div');
            icon.className = "pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-paper-muted";
            icon.innerHTML = `<i data-lucide="chevron-down" class="w-4 h-4"></i>`;

            selectWrapper.appendChild(select);
            selectWrapper.appendChild(icon);
            container.appendChild(selectWrapper);

            // Mobile Jump To Trigger
            const jumpBtn = document.createElement('button');
            jumpBtn.className = "md:hidden flex items-center text-sm font-medium text-brand-700 hover:text-brand-800";
            jumpBtn.onclick = () => toggleDrawer(true);
            jumpBtn.innerHTML = `
                <span class="mr-2">Jump to</span>
                <i data-lucide="menu" class="w-5 h-5"></i>
            `;
            container.appendChild(jumpBtn);

            return container;
        }

        function renderDesktopNav() {
            const container = document.createElement('aside');
            // Sticky Desktop Rail
            container.className = "hidden md:block w-48 lg:w-56 flex-shrink-0 h-screen sticky top-0 py-8 overflow-y-auto no-scrollbar";
            
            const list = renderNavList();
            container.appendChild(list);
            return container;
        }

        function renderMobileNav() {
            const wrapper = document.createElement('div');
            // Z-index high for overlay
            wrapper.className = `fixed inset-0 z-50 md:hidden ${state.isDrawerOpen ? 'pointer-events-auto' : 'pointer-events-none'}`;
            
            // Scrim
            const scrim = document.createElement('div');
            scrim.className = `absolute inset-0 bg-slate-900/20 backdrop-blur-sm transition-opacity duration-300 ${state.isDrawerOpen ? 'opacity-100' : 'opacity-0'}`;
            scrim.onclick = () => toggleDrawer(false);
            wrapper.appendChild(scrim);

            // Drawer
            const drawer = document.createElement('div');
            drawer.className = `drawer absolute top-0 left-0 bottom-0 w-64 bg-white shadow-xl flex flex-col ${state.isDrawerOpen ? 'drawer-open' : 'drawer-closed'}`;
            
            // Header
            const header = document.createElement('div');
            header.className = "flex items-center justify-between p-4 border-b border-paper-border";
            header.innerHTML = `<span class="font-semibold text-paper-text">Jump to</span>`;
            
            const closeBtn = document.createElement('button');
            closeBtn.className = "text-paper-muted hover:text-paper-text p-1";
            closeBtn.onclick = () => toggleDrawer(false);
            closeBtn.innerHTML = `<i data-lucide="x" class="w-5 h-5"></i>`;
            header.appendChild(closeBtn);
            drawer.appendChild(header);

            // List
            const listContainer = document.createElement('div');
            listContainer.className = "flex-1 overflow-y-auto p-4";
            listContainer.appendChild(renderNavList(true));
            drawer.appendChild(listContainer);

            wrapper.appendChild(drawer);
            return wrapper;
        }

        function toggleDrawer(isOpen) {
            state.isDrawerOpen = isOpen;
            // Update DOM directly for drawer transition to avoid full re-render
            const wrapper = document.querySelector('.fixed.z-50');
            const scrim = wrapper.querySelector('.absolute.bg-slate-900\\/20');
            const drawer = wrapper.querySelector('.drawer');
            
            if (wrapper && scrim && drawer) {
                wrapper.classList.toggle('pointer-events-none', !isOpen);
                wrapper.classList.toggle('pointer-events-auto', isOpen);
                
                scrim.classList.toggle('opacity-0', !isOpen);
                scrim.classList.toggle('opacity-100', isOpen);
                
                drawer.classList.toggle('drawer-closed', !isOpen);
                drawer.classList.toggle('drawer-open', isOpen);
            }
        }

        function renderNavList(isMobile = false) {
            const nav = document.createElement('nav');
            nav.className = "flex flex-col space-y-4"; // Spacing between sections
            
            const paper = state.papers[state.currentPaperIndex];
            
            // Helper to render items
            const createItem = (qNode, depth) => {
                const item = document.createElement('a');
                item.href = `#q-${qNode.id}`;
                // Hierarchy via type scale/quietness (Stage 5.4.5) - Flat left edge
                const isTopLevel = depth === 0;
                item.className = `block py-1 text-sm border-l-2 border-transparent pl-3 transition-colors duration-200 
                    ${isTopLevel ? 'text-paper-text font-medium' : 'text-paper-muted font-normal text-xs'} 
                    hover:text-brand-700 hover:border-brand-300 focus:outline-none focus-visible:ring-2 focus-visible:ring-brand-500`;
                
                item.textContent = qNode.id;
                
                item.onclick = (e) => {
                    e.preventDefault();
                    document.getElementById(`q-${qNode.id}`)?.scrollIntoView({block: 'start'});
                    if (isMobile) toggleDrawer(false);
                    
                    // Set active visual state manually for prototype
                    nav.querySelectorAll('a').forEach(a => {
                        a.classList.remove('border-brand-500', 'text-brand-700', 'font-bold');
                        a.classList.add('border-transparent');
                    });
                    item.classList.remove('border-transparent');
                    item.classList.add('border-brand-500', 'text-brand-700', 'font-bold');
                };

                const container = document.createElement('div');
                container.appendChild(item);
                
                if (qNode.children && qNode.children.length > 0) {
                    qNode.children.forEach(child => {
                        container.appendChild(createItem(child, depth + 1));
                    });
                }
                return container;
            };

            if (paper.sections) {
                paper.sections.forEach(section => {
                    const sectionBlock = document.createElement('div');
                    if (section.label && section.label.trim() !== "") {
                        const label = document.createElement('div');
                        label.className = "px-3 text-xs font-bold text-paper-muted uppercase tracking-wider mb-2 select-none";
                        label.textContent = section.label;
                        sectionBlock.appendChild(label);
                    }
                    section.questions.forEach(q => sectionBlock.appendChild(createItem(q, 0)));
                    nav.appendChild(sectionBlock);
                });
            } else {
                const listBlock = document.createElement('div');
                paper.questions.forEach(q => listBlock.appendChild(createItem(q, 0)));
                nav.appendChild(listBlock);
            }

            return nav;
        }

        // --- Renderers: Content ---

        function renderPaperContent() {
            const container = document.createElement('div');
            container.className = "max-w-3xl space-y-12 pb-24"; // Max width for readability
            
            const paper = state.papers[state.currentPaperIndex];

            if (paper.sections) {
                paper.sections.forEach((section, idx) => {
                    const sectionEl = document.createElement('div');
                    sectionEl.className = "space-y-8";
                    
                    // Section Header
                    if (section.label && section.label.trim() !== "") {
                        const header = document.createElement('div');
                        header.className = "border-b border-paper-border pb-2 mb-6";
                        header.innerHTML = `<h2 class="text-xl font-bold text-paper-text">${section.label}</h2>`;
                        sectionEl.appendChild(header);
                    }
                    
                    section.questions.forEach(q => sectionEl.appendChild(renderQuestionNode(q, 0)));
                    
                    container.appendChild(sectionEl);
                    
                    // Section Divider (if not last)
                    if (idx < paper.sections.length - 1) {
                         const divider = document.createElement('div');
                         divider.className = "h-px bg-paper-border my-12";
                         container.appendChild(divider);
                    }
                });
            } else {
                paper.questions.forEach(q => container.appendChild(renderQuestionNode(q, 0)));
            }

            return container;
        }

        function renderQuestionNode(node, depth) {
            // Region: Question Node
            const wrapper = document.createElement('div');
            wrapper.id = `q-${node.id}`;
            wrapper.className = "scroll-mt-24"; // Scroll margin for sticky header

            // 1. Question Body
            const body = document.createElement('div');
            // Visual separation based on depth (Stage 5.2)
            // Top level gets no extra left pad, children get indent via spacing
            body.className = `flex gap-4 ${depth > 0 ? 'ml-0 mt-6' : 'mt-8'}`;
            
            // Identifier
            const ident = document.createElement('div');
            ident.className = `flex-shrink-0 text-paper-text font-bold select-none ${depth === 0 ? 'text-lg' : 'text-base'}`;
            ident.textContent = node.id;
            body.appendChild(ident);

            // Prompt content wrapper
            const contentCol = document.createElement('div');
            contentCol.className = "flex-1 min-w-0 space-y-4"; // Space between Prompt -> Answer -> Details

            // Prompt
            const prompt = document.createElement('div');
            prompt.className = `prose max-w-none text-paper-text leading-relaxed ${depth === 0 ? 'text-lg' : 'text-base'}`;
            if (md) prompt.innerHTML = md.render(node.question);
            else prompt.textContent = node.question;
            contentCol.appendChild(prompt);
            
            body.appendChild(contentCol);
            wrapper.appendChild(body);

            // 2. Solution Block (Optional)
            if (node.solutionBlock) {
                // Separator: Question -> Solution Block (Spacing)
                const solutionBlockWrapper = document.createElement('div');
                solutionBlockWrapper.className = `mt-4 ${depth === 0 ? 'ml-10' : 'ml-0'}`; // Align with content, accounting for ID width roughly if top level

                // Answer (Optional)
                if (node.solutionBlock.answer) {
                    const answerRegion = document.createElement('div');
                    answerRegion.className = "mb-4";
                    
                    const label = document.createElement('div');
                    label.className = "text-sm font-bold text-paper-muted uppercase tracking-wide mb-1";
                    label.textContent = "Answer";
                    
                    const answerContent = document.createElement('div');
                    answerContent.className = "text-lg font-medium text-paper-text";
                    if (md) answerContent.innerHTML = md.render(node.solutionBlock.answer);
                    else answerContent.textContent = node.solutionBlock.answer;
                    
                    answerRegion.appendChild(label);
                    answerRegion.appendChild(answerContent);
                    solutionBlockWrapper.appendChild(answerRegion);
                }

                // Solution Details (Optional)
                if (node.solutionBlock.solutionDetails) {
                    const details = node.solutionBlock.solutionDetails;
                    
                    // Disclosure Control
                    const isExpanded = state.expandedNodes.has(node.id);
                    const toggleBtn = document.createElement('button');
                    toggleBtn.className = "flex items-center gap-2 text-sm font-medium text-brand-700 hover:text-brand-800 focus:outline-none mb-3 transition-colors";
                    toggleBtn.onclick = () => {
                        if (state.expandedNodes.has(node.id)) state.expandedNodes.delete(node.id);
                        else state.expandedNodes.add(node.id);
                        
                        // Re-render just this node's details container would be complex without framework.
                        // For prototype: re-render app to update state (simplest, robust).
                        // To preserve scroll, we rely on browser, but 'scroll-behavior: smooth' might fight.
                        // Better: Toggle locally.
                        const container = document.getElementById(`details-${node.id}`);
                        const txt = toggleBtn.querySelector('span');
                        const icon = toggleBtn.querySelector('i');
                        
                        if (container.classList.contains('hidden-content')) {
                            container.classList.remove('hidden-content');
                            txt.textContent = "Hide working";
                            icon.parentElement.style.transform = "rotate(180deg)";
                            state.expandedNodes.add(node.id);
                        } else {
                            container.classList.add('hidden-content');
                            txt.textContent = "Show working";
                            icon.parentElement.style.transform = "rotate(0deg)";
                            state.expandedNodes.delete(node.id);
                        }
                    };

                    toggleBtn.innerHTML = `
                        <span>${isExpanded ? "Hide working" : "Show working"}</span>
                        <div style="transition: transform 0.2s; transform: ${isExpanded ? 'rotate(180deg)' : 'rotate(0deg)'}">
                            <i data-lucide="chevron-down" class="w-4 h-4"></i>
                        </div>
                    `;
                    solutionBlockWrapper.appendChild(toggleBtn);

                    // Details Region
                    const detailsRegion = document.createElement('div');
                    detailsRegion.id = `details-${node.id}`;
                    // Border-l used as quiet alignment cue, not a heavy frame
                    detailsRegion.className = `${isExpanded ? '' : 'hidden-content'} pl-4 border-l border-paper-border space-y-6 py-2`;

                    // Keep in mind
                    if (details.keepInMind) {
                        const block = renderDetailBlock("Keep in mind", details.keepInMind, "bg-transparent text-paper-text", "list-disc pl-5");
                        detailsRegion.appendChild(block);
                    }

                    // Formulas used
                    if (details.formulasUsed) {
                        const block = renderDetailBlock("Formulas used", details.formulasUsed, "bg-transparent text-paper-text", "space-y-1");
                        detailsRegion.appendChild(block);
                    }

                    // Working
                    if (details.working) {
                        const block = renderDetailBlock("Working", details.working, "bg-transparent text-paper-text", "");
                        detailsRegion.appendChild(block);
                    }

                    // Alternative Working (Array)
                    if (details.alternativeWorking && Array.isArray(details.alternativeWorking)) {
                        details.alternativeWorking.forEach((alt, idx) => {
                            // Separator: Working -> Alt
                            const sep = document.createElement('div');
                            sep.className = "h-px bg-paper-border w-16 my-4"; // Quiet separator
                            detailsRegion.appendChild(sep);
                            
                            const block = renderDetailBlock("Alternative working", alt, "bg-transparent text-paper-text", "");
                            detailsRegion.appendChild(block);
                        });
                    }

                    solutionBlockWrapper.appendChild(detailsRegion);
                }

                // Append solution block to content column (under prompt)
                contentCol.appendChild(solutionBlockWrapper);
            }

            // 3. Children
            if (node.children && node.children.length > 0) {
                const childrenContainer = document.createElement('div');
                // Indentation handled via spacing (Stage 3E)
                // Use margin-left on children container to visually indent sub-questions
                // Responsive indent: smaller on mobile
                childrenContainer.className = "mt-4 ml-4 md:ml-8 border-l border-transparent"; 
                
                node.children.forEach(child => {
                    childrenContainer.appendChild(renderQuestionNode(child, depth + 1));
                });
                wrapper.appendChild(childrenContainer);
            }

            return wrapper;
        }

        function renderDetailBlock(labelTitle, markdownContent, textColorClass, listClass) {
            const block = document.createElement('div');
            
            const label = document.createElement('div');
            label.className = "text-sm font-bold text-paper-muted mb-2";
            label.textContent = labelTitle;
            block.appendChild(label);

            const body = document.createElement('div');
            body.className = `prose max-w-none text-base leading-snug ${textColorClass} ${listClass}`;
            if (md) body.innerHTML = md.render(markdownContent);
            else body.textContent = markdownContent;
            
            block.appendChild(body);
            return block;
        }

        // Start
        init();
    </script>
</body>
</html>
