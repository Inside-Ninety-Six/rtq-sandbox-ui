<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AD","indexWithinVariant":"257","totalWithinVariant":"440","hueFamily":"","intensityMode":"","primaryHueFamily":"teal","secondaryHueFamily":"green","dualIntensityMode":"dual_accent_only","timestamp":"2026-01-10T13:56:46.171Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AD&quot;,&quot;indexWithinVariant&quot;:&quot;257&quot;,&quot;totalWithinVariant&quot;:&quot;440&quot;,&quot;hueFamily&quot;:&quot;&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;primaryHueFamily&quot;:&quot;teal&quot;,&quot;secondaryHueFamily&quot;:&quot;green&quot;,&quot;dualIntensityMode&quot;:&quot;dual_accent_only&quot;,&quot;timestamp&quot;:&quot;2026-01-10T13:56:46.171Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>

    <!-- Tailwind CSS (Styling) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- KaTeX CSS (Maths) - No Integrity -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    
    <!-- KaTeX JS (Maths) - No Integrity -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Markdown-it (Content) - No Integrity -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                fontFamily: {
                    sans: ['Inter', 'system-ui', 'sans-serif'],
                },
                extend: {
                    colors: {
                        // ColorLab D: Mode 1 (dual_accent_only) - Light
                        // Fallback: Primary=Blue, Secondary=Amber
                        page: 'var(--color-surface-page)',
                        paper: 'var(--color-surface-paper)',
                        frame: 'var(--color-surface-frame)',
                        
                        txt: {
                            primary: 'var(--color-text-primary)',
                            secondary: 'var(--color-text-secondary)',
                        },
                        
                        border: {
                            hairline: 'var(--color-border-hairline)',
                        },
                        
                        accent: {
                            primary: 'var(--color-accent-primary)',     // Links, Focus, Disclosure
                            secondary: 'var(--color-accent-secondary)', // Supplementary (Nav Marker)
                        },
                        
                        sd: {
                            wash: 'var(--color-sd-wash)', // Solution Details Wash
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* --- ColorLab D: Mode 1 Definition (OKLCH) --- */
        :root {
            /* Mode 1: dual_accent_only 
               Goal: Neutral surfaces, restrained accents.
            */
            
            /* Surfaces: C <= 0.015 */
            --color-surface-page: oklch(0.985 0.005 250); 
            --color-surface-frame: oklch(0.985 0.005 250);
            --color-surface-paper: oklch(1.0 0 0);
            --color-sd-wash: oklch(0.99 0.002 250); /* Very subtle wash if used */

            /* Text: C <= 0.010 */
            --color-text-primary: oklch(0.20 0.01 250);
            --color-text-secondary: oklch(0.45 0.01 250);

            /* Hairlines */
            --color-border-hairline: oklch(0.92 0.005 250);

            /* Primary Accent (Blue): C [0.08 .. 0.14] 
               Used for: Links, Focus, Disclosure Text */
            --color-accent-primary: oklch(0.55 0.13 260);

            /* Secondary Accent (Amber): C [0.06 .. 0.12] 
               Used for: Single role (Active Nav Marker) */
            --color-accent-secondary: oklch(0.70 0.12 85);
        }

        /* --- Global Reset & Typography --- */
        body {
            background-color: var(--color-surface-page);
            color: var(--color-text-primary);
            -webkit-font-smoothing: antialiased;
        }

        /* --- Scrollbar Hiding (Nav) --- */
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        /* --- KaTeX Containment Invariant --- */
        /* Block math must allow horizontal scroll only within itself */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            padding-top: 0.5em;
            padding-bottom: 0.5em;
            max-width: 100%;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Inline math: No background */
        .katex {
            background-color: transparent !important;
        }
        
        /* Math background/wash override per Stage 6 baseline (Solution Details Internal) 
           Only block-level math gets subtle differentiation if needed. 
           Here we keep it clean per Mode 1 defaults. */

        /* --- Markdown Content Styling --- */
        .md-content p {
            margin-bottom: 1em;
            line-height: 1.6;
        }
        .md-content p:last-child {
            margin-bottom: 0;
        }
        
        /* Lists */
        .md-content ul {
            list-style-type: disc;
            padding-left: 1.5em;
            margin-bottom: 1em;
        }
        .md-content ol {
            list-style-type: decimal;
            padding-left: 1.5em;
            margin-bottom: 1em;
        }
        .md-content li {
            margin-bottom: 0.5em;
        }

        /* Tables (Minimal, structural) */
        .md-content table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1.5em;
            font-size: 0.95em;
        }
        .md-content th, .md-content td {
            border: 1px solid var(--color-border-hairline);
            padding: 0.75em;
            text-align: left;
        }
        .md-content th {
            font-weight: 600;
            color: var(--color-text-primary);
        }
        
        /* Images/SVG */
        .md-content img, .md-content svg {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 1em 0;
        }

        /* --- Focus Styles --- */
        :focus-visible {
            outline: 2px solid var(--color-accent-primary);
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* --- Transitions --- */
        .transition-height {
            transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
        }

        /* --- Utilities --- */
        .text-accent {
            color: var(--color-accent-primary);
        }
        .text-accent-secondary {
            color: var(--color-accent-secondary);
        }
    </style>
</head>
<body class="flex flex-col min-h-screen text-base">

    <!-- App Root -->
    <div id="app" class="w-full max-w-[1400px] mx-auto flex flex-col flex-grow">
        <!-- Content injected by JS -->
    </div>

    <!-- JS Logic -->
    <script>
        // =================================================================
        // STAGE 0: CONSTANTS (AUTHORITATIVE)
        // =================================================================
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // =================================================================
        // GLOBAL STATE & SETUP
        // =================================================================
        const state = {
            payload: null,
            currentPaperKey: null,
            expandedWorkings: new Map(), // key: questionId, value: boolean
            mobileMenuOpen: false,
            activeNavId: null,
            observer: null
        };

        // Markdown Renderer Setup (Stage 6 Baseline Invariant)
        const md = window.markdownit ? window.markdownit({
            html: true,   // Allow inline SVG passthrough
            linkify: true,
            breaks: false // MUST be false to prevent <br> in math blocks
        }) : null;

        if (md) {
            md.inline.ruler.disable(['escape']); // Preserve TeX backslashes
        }

        // =================================================================
        // INITIALIZATION
        // =================================================================
        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Fetch failed");
                state.payload = await response.json();
                
                // Set initial paper
                if (state.payload.papers && state.payload.papers.length > 0) {
                    selectPaper(state.payload.papers[0].key);
                } else {
                    renderError("No papers found in payload.");
                }
            } catch (e) {
                console.error(e);
                renderError("PAPERS PAYLOAD MISSING");
            }
        }

        // =================================================================
        // RENDERING: CORE
        // =================================================================
        function renderError(msg) {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="flex items-center justify-center min-h-[50vh] text-txt-secondary font-medium">
                    ${msg}
                </div>
            `;
        }

        function selectPaper(key) {
            state.currentPaperKey = key;
            const paper = getCurrentPaper();
            
            // Handle defaults
            const defaultExpanded = paper.defaults?.expandedAll !== false; // Default true unless explicitly false
            state.expandedWorkings.clear(); 
            // We lazily set expanded state. If not in Map, fallback to default.
            
            // Re-render
            renderApp();
            
            // Initial Math Render
            requestAnimationFrame(() => {
                renderMathInContent();
                setupIntersectionObserver();
            });
        }

        function getCurrentPaper() {
            return state.payload.papers.find(p => p.key === state.currentPaperKey);
        }

        function renderApp() {
            const paper = getCurrentPaper();
            const app = document.getElementById('app');
            
            app.innerHTML = `
                ${renderTopControls()}
                ${renderDocumentFrame(paper)}
                ${renderMobileDrawer(paper)}
            `;

            // Attach listeners
            attachEventHandlers();
        }

        // =================================================================
        // RENDERING: COMPONENTS
        // =================================================================

        // 1. Top Controls (Paper Selector, Mobile Trigger)
        function renderTopControls() {
            const papers = state.payload.papers;
            const options = papers.map(p => 
                `<option value="${p.key}" ${p.key === state.currentPaperKey ? 'selected' : ''}>${p.label}</option>`
            ).join('');

            return `
                <div class="sticky top-0 z-40 bg-page/95 backdrop-blur-sm border-b border-border-hairline px-4 h-14 flex items-center justify-between lg:justify-start">
                    <!-- Paper Selector -->
                    <div class="flex items-center">
                        <select id="paper-selector" class="bg-transparent text-txt-primary font-medium text-sm focus:outline-none focus:ring-2 focus:ring-accent-primary rounded px-2 py-1 cursor-pointer">
                            ${options}
                        </select>
                    </div>

                    <!-- Mobile Jump To Trigger -->
                    <button id="mobile-menu-trigger" class="lg:hidden text-accent-primary text-sm font-medium px-2 py-1">
                        Jump to
                    </button>
                </div>
            `;
        }

        // 2. Document Frame (Shell)
        function renderDocumentFrame(paper) {
            return `
                <div class="flex-grow flex flex-col lg:flex-row relative">
                    <!-- Left: Navigation Rail (Desktop) -->
                    <nav class="hidden lg:block w-64 flex-shrink-0 relative border-r border-transparent">
                        <div class="sticky top-14 max-h-[calc(100vh-3.5rem)] overflow-y-auto scrollbar-hide py-8 px-6">
                           ${renderNavList(paper, false)} 
                        </div>
                    </nav>

                    <!-- Right: Paper Content -->
                    <main class="flex-grow w-full max-w-4xl px-4 py-8 lg:px-12 lg:py-12 bg-paper min-h-screen border-l border-border-hairline/30">
                        ${renderPaperContent(paper)}
                    </main>
                </div>
            `;
        }

        // 3. Navigation List
        function renderNavList(paper, isMobile) {
            let html = `<ul class="space-y-4 text-sm">`;
            
            // Handle Sectioned vs Flat Papers
            if (paper.sections) {
                paper.sections.forEach(section => {
                    const hasLabel = section.label && section.label.trim().length > 0;
                    
                    html += `<li>`;
                    if (hasLabel) {
                        html += `<div class="text-txt-secondary font-bold mb-2 uppercase text-xs tracking-wider select-none">${section.label}</div>`;
                    }
                    
                    html += `<ul class="space-y-1">`;
                    section.questions.forEach(q => {
                        html += renderNavItemRecursive(q);
                    });
                    html += `</ul></li>`;
                });
            } else if (paper.questions) {
                html += `<li><ul class="space-y-1">`;
                paper.questions.forEach(q => {
                    html += renderNavItemRecursive(q);
                });
                html += `</ul></li>`;
            }
            
            html += `</ul>`;
            return html;
        }

        function renderNavItemRecursive(question) {
            const depth = getDepth(question); 
            // Note: Stage 3/5 says FLAT list, hierarchy via type scale/weight, NO indentation.
            // But we need to traverse children to show them in the linear list.
            
            let html = renderNavItem(question);
            
            if (question.children && question.children.length > 0) {
                question.children.forEach(child => {
                    html += renderNavItemRecursive(child);
                });
            }
            return html;
        }

        // Helper to flatten/render item
        function renderNavItem(q) {
            // Identifier only
            // Active state handling via data attribute, class toggled by JS
            return `
                <li>
                    <a href="#q-${q.id}" 
                       data-nav-id="${q.id}"
                       class="nav-item block py-1 px-2 -ml-2 rounded text-txt-secondary hover:text-txt-primary hover:bg-black/5 transition-colors duration-150 border-l-2 border-transparent">
                       ${q.id}
                    </a>
                </li>
            `;
        }

        // 4. Mobile Drawer
        function renderMobileDrawer(paper) {
            const isOpen = state.mobileMenuOpen;
            const translateClass = isOpen ? 'translate-x-0' : 'translate-x-full';
            
            return `
                <div id="mobile-drawer-overlay" class="fixed inset-0 z-50 bg-black/20 backdrop-blur-sm transition-opacity duration-300 ${isOpen ? 'opacity-100 pointer-events-auto' : 'opacity-0 pointer-events-none'}" aria-hidden="${!isOpen}">
                    <div class="absolute right-0 top-0 h-full w-64 bg-page shadow-xl transform transition-transform duration-300 ease-out ${translateClass}">
                        <div class="flex items-center justify-between p-4 border-b border-border-hairline">
                            <span class="font-bold text-txt-primary">Jump to</span>
                            <button id="mobile-menu-close" class="p-2 text-txt-secondary hover:text-txt-primary">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </button>
                        </div>
                        <div class="overflow-y-auto h-[calc(100%-4rem)] p-4 scrollbar-hide">
                            ${renderNavList(paper, true)}
                        </div>
                    </div>
                </div>
            `;
        }

        // 5. Paper Content Renderers
        function renderPaperContent(paper) {
            if (paper.sections) {
                return paper.sections.map(section => {
                    const hasLabel = section.label && section.label.trim().length > 0;
                    return `
                        <section class="mb-12">
                            ${hasLabel ? `<div class="text-txt-secondary font-bold text-lg mb-6 border-b border-border-hairline pb-2">${section.label}</div>` : ''}
                            <div class="space-y-12">
                                ${section.questions.map(q => renderQuestionNode(q)).join('')}
                            </div>
                        </section>
                    `;
                }).join('');
            } else if (paper.questions) {
                return `
                    <div class="space-y-12">
                        ${paper.questions.map(q => renderQuestionNode(q)).join('')}
                    </div>
                `;
            }
            return '';
        }

        function renderQuestionNode(question, depth = 0) {
            // Render this node
            const qBody = renderQuestionBody(question);
            const solutionBlock = renderSolutionBlock(question);
            
            // Children
            let childrenHtml = '';
            if (question.children && question.children.length > 0) {
                const childSpacing = depth === 0 ? 'space-y-8 mt-8 pl-0' : 'space-y-6 mt-6 pl-4 lg:pl-8';
                childrenHtml = `
                    <div class="${childSpacing} border-l border-transparent">
                        ${question.children.map(c => renderQuestionNode(c, depth + 1)).join('')}
                    </div>
                `;
            }

            // Wrapper
            // Top-level uses larger spacing (handled by parent space-y-12), nested uses margin/padding
            const wrapperClass = depth === 0 ? 'relative scroll-mt-20' : 'relative scroll-mt-20';

            return `
                <div id="q-${question.id}" class="${wrapperClass}" data-observe-id="${question.id}">
                    ${qBody}
                    ${solutionBlock}
                    ${childrenHtml}
                </div>
            `;
        }

        function renderQuestionBody(question) {
            const promptHtml = md ? md.render(question.question) : question.question;
            return `
                <div class="flex items-start gap-3 lg:gap-4 group">
                    <span class="flex-shrink-0 font-bold text-txt-secondary min-w-[1.5rem] mt-[0.1rem] select-none">${question.id}</span>
                    <div class="flex-grow text-txt-primary text-lg md-content leading-relaxed">
                        ${promptHtml}
                    </div>
                </div>
            `;
        }

        function renderSolutionBlock(question) {
            if (!question.solutionBlock) return '';
            
            const sb = question.solutionBlock;
            const hasAnswer = !!sb.answer;
            const hasDetails = !!sb.solutionDetails;
            
            if (!hasAnswer && !hasDetails) return '';

            let html = `<div class="ml-9 lg:ml-10 mt-4 max-w-3xl">`;

            // Answer
            if (hasAnswer) {
                const answerContent = md ? md.render(sb.answer) : sb.answer;
                html += `
                    <div class="mb-3">
                        <span class="text-xs font-bold uppercase tracking-wider text-txt-secondary block mb-1">Answer</span>
                        <div class="text-txt-primary font-medium md-content text-base">
                            ${answerContent}
                        </div>
                    </div>
                `;
            }

            // Solution Details
            if (hasDetails) {
                const isExpanded = getExpandedState(question.id);
                const buttonText = isExpanded ? "Hide working" : "Show working";
                const contentClass = isExpanded ? "max-h-[5000px] opacity-100 mt-4" : "max-h-0 opacity-0 mt-0 overflow-hidden";
                const chevronRotate = isExpanded ? "rotate-180" : "rotate-0";

                html += `
                    <div class="mt-2">
                        <button class="toggle-working flex items-center gap-1.5 text-accent-primary hover:text-accent-primary/80 font-medium text-sm focus:outline-none transition-colors" data-id="${question.id}">
                            <span>${buttonText}</span>
                            <svg class="w-4 h-4 transform transition-transform duration-300 ${chevronRotate}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        
                        <div class="solution-content transition-height ${contentClass} border-l-2 border-border-hairline pl-4 py-1">
                             ${renderSolutionDetailsContent(sb.solutionDetails)}
                        </div>
                    </div>
                `;
            }

            html += `</div>`;
            return html;
        }

        function renderSolutionDetailsContent(details) {
            let html = '';
            
            // 1. Keep in Mind
            if (details.keepInMind) {
                const content = md ? md.render(details.keepInMind) : details.keepInMind;
                html += `
                    <div class="mb-6 text-sm">
                        <div class="font-bold text-txt-secondary mb-1 flex items-center gap-2">
                            Keep in mind
                        </div>
                        <div class="md-content text-txt-secondary leading-relaxed">
                            ${content}
                        </div>
                    </div>
                `;
            }

            // 2. Formulas Used
            if (details.formulasUsed) {
                const content = md ? md.render(details.formulasUsed) : details.formulasUsed;
                html += `
                    <div class="mb-6 text-sm">
                        <div class="font-bold text-txt-secondary mb-1">Formulas used</div>
                        <div class="md-content text-txt-secondary/90 leading-relaxed font-mono text-xs">
                            ${content}
                        </div>
                    </div>
                `;
            }

            // 3. Working
            if (details.working) {
                const content = md ? md.render(details.working) : details.working;
                html += `
                    <div class="mb-6">
                        <div class="font-bold text-txt-secondary mb-2 text-xs uppercase tracking-wider">Working</div>
                        <div class="md-content text-txt-primary text-base">
                            ${content}
                        </div>
                    </div>
                `;
            }

            // 4. Alternative Working
            if (details.alternativeWorking && Array.isArray(details.alternativeWorking)) {
                details.alternativeWorking.forEach((alt, idx) => {
                    const content = md ? md.render(alt) : alt;
                    html += `
                        <div class="mt-8 pt-6 border-t border-border-hairline">
                            <div class="font-bold text-txt-secondary mb-2 text-xs uppercase tracking-wider">Alternative working ${idx > 0 ? idx + 1 : ''}</div>
                            <div class="md-content text-txt-primary text-base">
                                ${content}
                            </div>
                        </div>
                    `;
                });
            }

            return html;
        }

        // =================================================================
        // HELPERS & EVENTS
        // =================================================================
        
        // Defaults logic: If paper.defaults.expandedAll is false, default collapsed. Else expanded.
        function getExpandedState(questionId) {
            if (state.expandedWorkings.has(questionId)) {
                return state.expandedWorkings.get(questionId);
            }
            const paper = getCurrentPaper();
            const defaultExpanded = paper.defaults?.expandedAll !== false;
            return defaultExpanded;
        }

        function getDepth(question) {
            // Helper if needed for recursive logic, though we passed depth param
            return 0; 
        }

        function attachEventHandlers() {
            // 1. Paper Selector
            const selector = document.getElementById('paper-selector');
            if (selector) {
                selector.addEventListener('change', (e) => {
                    selectPaper(e.target.value);
                });
            }

            // 2. Mobile Drawer Toggles
            const trigger = document.getElementById('mobile-menu-trigger');
            const closeBtn = document.getElementById('mobile-menu-close');
            const overlay = document.getElementById('mobile-drawer-overlay');

            if (trigger) trigger.addEventListener('click', () => toggleMobileDrawer(true));
            if (closeBtn) closeBtn.addEventListener('click', () => toggleMobileDrawer(false));
            if (overlay) overlay.addEventListener('click', (e) => {
                if (e.target === overlay) toggleMobileDrawer(false);
            });

            // 3. Solution Toggles (Delegation)
            const app = document.getElementById('app');
            app.addEventListener('click', (e) => {
                const btn = e.target.closest('.toggle-working');
                if (btn) {
                    const id = btn.dataset.id;
                    const currentState = getExpandedState(id);
                    state.expandedWorkings.set(id, !currentState);
                    
                    // Efficiently update just this block or re-render?
                    // For prototype robustness, re-rendering the whole solution block is safest for math,
                    // but simple DOM manipulation is smoother.
                    // Let's modify DOM classes directly for smoothness, then trigger math render if needed (though invisible math usually renders fine).
                    
                    const container = btn.parentElement;
                    const contentDiv = container.querySelector('.solution-content');
                    const svg = btn.querySelector('svg');
                    const textSpan = btn.querySelector('span');

                    if (!currentState) {
                        // Expanding
                        contentDiv.classList.remove('max-h-0', 'opacity-0', 'mt-0', 'overflow-hidden');
                        contentDiv.classList.add('max-h-[5000px]', 'opacity-100', 'mt-4');
                        svg.classList.add('rotate-180');
                        textSpan.textContent = "Hide working";
                    } else {
                        // Collapsing
                        contentDiv.classList.remove('max-h-[5000px]', 'opacity-100', 'mt-4');
                        contentDiv.classList.add('max-h-0', 'opacity-0', 'mt-0', 'overflow-hidden');
                        svg.classList.remove('rotate-180');
                        textSpan.textContent = "Show working";
                    }
                }
                
                // 4. Nav Link Clicks (Mobile close)
                const navLink = e.target.closest('a.nav-item');
                if (navLink && state.mobileMenuOpen) {
                    toggleMobileDrawer(false);
                }
            });
        }

        function toggleMobileDrawer(open) {
            state.mobileMenuOpen = open;
            const overlay = document.getElementById('mobile-drawer-overlay');
            if (!overlay) return;
            
            const drawer = overlay.firstElementChild;
            
            if (open) {
                overlay.classList.remove('opacity-0', 'pointer-events-none');
                overlay.classList.add('opacity-100', 'pointer-events-auto');
                drawer.classList.remove('translate-x-full');
                drawer.classList.add('translate-x-0');
            } else {
                overlay.classList.remove('opacity-100', 'pointer-events-auto');
                overlay.classList.add('opacity-0', 'pointer-events-none');
                drawer.classList.remove('translate-x-0');
                drawer.classList.add('translate-x-full');
            }
        }

        function renderMathInContent() {
            if (window.renderMathInElement) {
                renderMathInElement(document.body, {
                    delimiters: [
                        {left: "$$", right: "$$", display: true},
                        {left: "$", right: "$", display: false}
                    ],
                    throwOnError: false
                });
            }
        }

        // =================================================================
        // SCROLL SPY (NAV HIGHLIGHT)
        // =================================================================
        function setupIntersectionObserver() {
            if (state.observer) state.observer.disconnect();

            const options = {
                root: null,
                rootMargin: '-10% 0px -80% 0px', // Active when near top
                threshold: 0
            };

            state.observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const id = entry.target.dataset.observeId;
                        updateActiveNav(id);
                    }
                });
            }, options);

            const questions = document.querySelectorAll('[data-observe-id]');
            questions.forEach(q => state.observer.observe(q));
        }

        function updateActiveNav(id) {
            // Remove active from all
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('text-accent-primary', 'font-bold', 'border-accent-secondary');
                el.classList.add('text-txt-secondary', 'border-transparent');
            });

            // Add to current (in both desktop and mobile lists)
            const activeLinks = document.querySelectorAll(`[data-nav-id="${id}"]`);
            activeLinks.forEach(el => {
                el.classList.remove('text-txt-secondary', 'border-transparent');
                // ColorLab D Mode 1: Primary Accent for text, Secondary Accent for marker (border)
                el.classList.add('text-accent-primary', 'font-bold', 'border-accent-secondary');
            });
        }

        // =================================================================
        // START
        // =================================================================
        document.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
