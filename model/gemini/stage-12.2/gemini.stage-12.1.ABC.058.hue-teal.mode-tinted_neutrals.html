<!DOCTYPE html>
<html lang="en" class="antialiased">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"ABC","indexWithinVariant":"58","totalWithinVariant":"320","hueFamily":"teal","intensityMode":"tinted_neutrals","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-09T12:37:18.832Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;ABC&quot;,&quot;indexWithinVariant&quot;:&quot;58&quot;,&quot;totalWithinVariant&quot;:&quot;320&quot;,&quot;hueFamily&quot;:&quot;teal&quot;,&quot;intensityMode&quot;:&quot;tinted_neutrals&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-09T12:37:18.832Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>

    <!-- Tailwind CSS (via CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Vue 3 (via CDN) -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <!-- Markdown-it (via CDN, no SRI) -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <!-- KaTeX CSS & JS (via CDN, no SRI) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    colors: {
                        // ColorLab C: Tinted Neutrals + ColorLab B: Teal (Hue ~185)
                        // Using OKLCH values converted to CSS variables for runtime tweaking if needed, 
                        // but hardcoded here for the prototype.
                        
                        // Surface Palette (Tinted Neutrals Mode)
                        page: 'oklch(0.985 0.015 185)',      // Very light teal tint
                        frame: 'oklch(0.975 0.02 185)',     // Base surface for doc shell
                        paper: 'oklch(0.99 0.01 185)',      // Paper surface
                        wash: 'oklch(0.96 0.03 185)',       // Solution details wash
                        
                        // Text Palette
                        primary: 'oklch(0.25 0.01 185)',    // Deep teal-gray
                        secondary: 'oklch(0.45 0.015 185)', // Mid teal-gray
                        tertiary: 'oklch(0.60 0.015 185)',  // Light teal-gray (nav)

                        // UI & Accents (Teal)
                        accent: 'oklch(0.55 0.13 185)',     // Interactive teal
                        divider: 'oklch(0.92 0.02 185)',    // Hairline
                        focus: 'oklch(0.55 0.13 185)',      // Focus ring
                    }
                }
            }
        }
    </script>

    <style>
        /* Base styles & Reset overrides */
        body {
            background-color: theme('colors.page');
            color: theme('colors.primary');
        }

        /* Scrollbar hiding utility */
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* KaTeX Containment Invariant */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            -webkit-overflow-scrolling: touch;
            padding-top: 0.5em;
            padding-bottom: 0.5em;
            /* Scrollbar hiding for math blocks (optional, but keeps it clean) */
            scrollbar-width: thin;
        }
        
        /* Inline math background restriction */
        .katex {
            background-color: transparent !important;
        }
        
        /* Markdown Content Styles */
        .prose p {
            margin-bottom: 0.75em;
            line-height: 1.6;
        }
        .prose ul {
            list-style-type: disc;
            padding-left: 1.25em;
            margin-bottom: 0.75em;
        }
        .prose ol {
            list-style-type: decimal;
            padding-left: 1.25em;
            margin-bottom: 0.75em;
        }
        .prose table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1em;
            font-size: 0.95em;
        }
        .prose th, .prose td {
            border: 1px solid theme('colors.divider');
            padding: 0.5em;
            text-align: left;
        }
        .prose th {
            font-weight: 600;
            color: theme('colors.primary');
        }

        /* Solution Details Wash Area - only subtle background */
        .solution-wash {
            background-color: theme('colors.wash');
        }

        /* Navigation Active/Hover States */
        .nav-item:hover {
            color: theme('colors.primary');
        }
        .nav-item.active {
            font-weight: 700;
            color: theme('colors.accent'); /* Navigation active marker allowed per Override */
        }
        
        /* Focus Styles */
        :focus-visible {
            outline: 2px solid theme('colors.focus');
            outline-offset: 2px;
            border-radius: 2px;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col font-sans">

    <div id="app" class="flex flex-col min-h-screen">
        
        <!-- Top Controls (Aligned to Shell) -->
        <header class="w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex items-center justify-between z-20 relative">
            
            <!-- Paper Selector -->
            <div class="flex items-center gap-3">
                <label for="paper-select" class="text-sm font-medium text-secondary hidden sm:block">Paper:</label>
                <select 
                    id="paper-select" 
                    v-model="currentPaperKey" 
                    @change="handlePaperChange"
                    class="bg-frame border border-divider rounded px-3 py-1.5 text-sm text-primary focus:border-accent focus:ring-0"
                    :disabled="loading || error"
                >
                    <option v-for="p in papers" :key="p.key" :value="p.key">{{ p.label }}</option>
                </select>
            </div>

            <!-- Mobile Jump To Trigger -->
            <button 
                @click="mobileNavOpen = true"
                class="lg:hidden text-sm font-medium text-accent hover:text-primary flex items-center gap-1"
                :disabled="loading || error"
            >
                Jump to
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
            </button>
        </header>

        <!-- Main Document Shell -->
        <main class="flex-grow w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex relative">
            
            <!-- Error State -->
            <div v-if="error" class="w-full py-12 text-center text-red-700 font-bold">
                PAPERS PAYLOAD MISSING
            </div>

            <!-- Loading State -->
            <div v-else-if="loading" class="w-full py-12 text-center text-secondary">
                Loading paper...
            </div>

            <!-- Content -->
            <template v-else-if="currentPaper">
                
                <!-- Desktop Navigation Rail (Sticky) -->
                <nav class="hidden lg:block w-48 flex-shrink-0 mr-12 pt-2 pb-12 sticky top-4 h-[calc(100vh-2rem)] overflow-y-auto no-scrollbar">
                    <div class="flex flex-col gap-1">
                        <template v-for="(item, index) in navItems" :key="index">
                            
                            <!-- Section Header -->
                            <div v-if="item.type === 'section'" class="mt-4 mb-2 first:mt-0">
                                <span class="text-xs font-bold text-secondary uppercase tracking-wider select-none">
                                    {{ item.label }}
                                </span>
                            </div>

                            <!-- Question Item -->
                            <a 
                                v-else 
                                :href="'#q-' + item.id"
                                @click.prevent="scrollToQuestion(item.id)"
                                class="nav-item block py-0.5 text-sm text-tertiary transition-colors duration-200"
                                :class="{ 'active': activeQuestionId === item.id, 'text-xs': item.depth > 0, 'pl-0': true }"
                                :style="{ opacity: item.depth > 0 ? 0.85 : 1 }"
                            >
                                {{ item.label }}
                            </a>
                        </template>
                    </div>
                </nav>

                <!-- Paper Content Column -->
                <div class="flex-1 min-w-0 pb-32">
                    
                    <div v-if="isSectionedPaper">
                        <div v-for="section in currentPaper.sections" :key="section.label || 'no-label'">
                            <!-- Section Header (Only if label exists) -->
                            <div v-if="section.label && section.label.trim().length > 0" class="pt-8 pb-6 border-b border-divider mb-8">
                                <h2 class="text-xl font-bold text-primary">{{ section.label }}</h2>
                            </div>
                            
                            <!-- Questions List -->
                            <div class="flex flex-col gap-12 sm:gap-16">
                                <question-node 
                                    v-for="q in section.questions" 
                                    :key="q.id" 
                                    :node="q" 
                                    :defaults="currentPaper.defaults"
                                    :depth="0"
                                ></question-node>
                            </div>
                            
                            <!-- Spacing between sections -->
                            <div class="h-16"></div>
                        </div>
                    </div>

                    <div v-else class="flex flex-col gap-12 sm:gap-16 pt-2">
                        <question-node 
                            v-for="q in currentPaper.questions" 
                            :key="q.id" 
                            :node="q" 
                            :defaults="currentPaper.defaults"
                            :depth="0"
                        ></question-node>
                    </div>

                </div>

            </template>
        </main>

        <!-- Mobile Navigation Drawer -->
        <div v-if="mobileNavOpen" class="fixed inset-0 z-50 lg:hidden" role="dialog" aria-modal="true">
            <!-- Backdrop -->
            <div class="absolute inset-0 bg-black/20 backdrop-blur-sm" @click="mobileNavOpen = false"></div>
            
            <!-- Drawer -->
            <div class="absolute right-0 top-0 bottom-0 w-64 bg-frame shadow-xl flex flex-col">
                <div class="p-4 border-b border-divider flex justify-between items-center">
                    <span class="font-bold text-primary">Jump to</span>
                    <button @click="mobileNavOpen = false" class="text-secondary p-1">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
                <div class="flex-1 overflow-y-auto p-4 no-scrollbar">
                    <div class="flex flex-col gap-1">
                        <template v-for="(item, index) in navItems" :key="index">
                            <div v-if="item.type === 'section'" class="mt-4 mb-2 first:mt-0">
                                <span class="text-xs font-bold text-secondary uppercase tracking-wider">
                                    {{ item.label }}
                                </span>
                            </div>
                            <a 
                                v-else 
                                href="#"
                                @click.prevent="scrollToQuestion(item.id); mobileNavOpen = false"
                                class="nav-item block py-1 text-sm text-tertiary"
                                :class="{ 'active': activeQuestionId === item.id, 'text-xs': item.depth > 0 }"
                                :style="{ opacity: item.depth > 0 ? 0.85 : 1 }"
                            >
                                {{ item.label }}
                            </a>
                        </template>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Vue Template for Recursive Question Node -->
    <script type="text/x-template" id="question-node-template">
        <div :id="'q-' + node.id" class="flex flex-col w-full group">
            
            <!-- Question Node Surface (Implicit via layout, but kept visually clean) -->
            <div class="relative">
                
                <!-- Question Body -->
                <div class="flex gap-4">
                    <!-- Identifier -->
                    <div class="flex-shrink-0 w-8 sm:w-10 pt-0.5">
                        <span class="text-base font-semibold text-secondary block">{{ node.id }}</span>
                    </div>
                    
                    <!-- Content Column -->
                    <div class="flex-1 min-w-0">
                        <!-- Prompt -->
                        <div class="prose text-primary text-lg leading-relaxed mb-6" v-html="renderedQuestion"></div>

                        <!-- Solution Block -->
                        <div v-if="hasSolutionBlock" class="mt-4 border-t border-transparent"> <!-- Top spacing structural -->
                            
                            <!-- Answer -->
                            <div v-if="node.solutionBlock && node.solutionBlock.answer" class="mb-5">
                                <span class="block text-xs font-bold text-secondary uppercase tracking-wide mb-1">Answer</span>
                                <div class="prose text-primary font-medium" v-html="renderedAnswer"></div>
                            </div>

                            <!-- Solution Details Region -->
                            <div v-if="hasSolutionDetails" class="mt-4">
                                
                                <!-- Disclosure Control -->
                                <button 
                                    @click="toggleDetails"
                                    class="text-sm font-medium text-accent hover:text-primary flex items-center gap-1 mb-2 select-none focus:outline-none focus-visible:ring-2 focus-visible:ring-focus rounded px-1 -ml-1"
                                >
                                    <span>{{ isExpanded ? 'Hide working' : 'Show working' }}</span>
                                    <svg 
                                        class="transform transition-transform duration-200" 
                                        :class="{ 'rotate-180': isExpanded }"
                                        xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                    >
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </button>

                                <!-- Expanded Content -->
                                <div v-show="isExpanded" class="solution-wash rounded-sm -ml-3 -mr-3 p-3 sm:ml-0 sm:mr-0 sm:p-0 sm:bg-transparent sm:pl-0 sm:border-l-2 sm:border-divider sm:pl-4 transition-all duration-300 ease-in-out">
                                    <div class="flex flex-col gap-6 py-2">
                                        
                                        <!-- Keep in Mind -->
                                        <div v-if="node.solutionBlock.solutionDetails.keepInMind" class="relative">
                                            <span class="block text-xs font-bold text-secondary mb-1">Keep in mind</span>
                                            <div class="prose text-sm text-secondary" v-html="renderMd(node.solutionBlock.solutionDetails.keepInMind)"></div>
                                        </div>

                                        <!-- Formulas Used -->
                                        <div v-if="node.solutionBlock.solutionDetails.formulasUsed" class="relative">
                                            <span class="block text-xs font-bold text-secondary mb-1">Formulas used</span>
                                            <div class="prose text-sm text-secondary" v-html="renderMd(node.solutionBlock.solutionDetails.formulasUsed)"></div>
                                        </div>

                                        <!-- Working -->
                                        <div v-if="node.solutionBlock.solutionDetails.working" class="relative">
                                            <span class="block text-xs font-bold text-secondary mb-1">Working</span>
                                            <div class="prose text-sm text-secondary" v-html="renderMd(node.solutionBlock.solutionDetails.working)"></div>
                                        </div>

                                        <!-- Alternative Working(s) -->
                                        <div v-if="node.solutionBlock.solutionDetails.alternativeWorking && node.solutionBlock.solutionDetails.alternativeWorking.length" class="flex flex-col gap-6 pt-4 border-t border-divider/50">
                                            <div v-for="(alt, idx) in node.solutionBlock.solutionDetails.alternativeWorking" :key="idx">
                                                <span class="block text-xs font-bold text-secondary mb-1">Alternative working</span>
                                                <div class="prose text-sm text-secondary" v-html="renderMd(alt)"></div>
                                            </div>
                                        </div>

                                    </div>
                                </div>

                            </div>
                        </div>

                        <!-- Children Container -->
                        <div v-if="node.children && node.children.length > 0" class="mt-8 flex flex-col gap-6">
                             <question-node 
                                v-for="child in node.children" 
                                :key="child.id" 
                                :node="child" 
                                :defaults="defaults"
                                :depth="depth + 1"
                            ></question-node>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </script>

    <script>
        // --- CONSTANTS ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // --- MARKDOWN SETUP ---
        const md = window.markdownit ? window.markdownit({
            html: true,
            linkify: true,
            breaks: false, // Authoritative: false
        }) : null;

        if (md) {
            md.inline.ruler.disable(['escape']);
        }

        // --- VUE COMPONENT: Question Node ---
        const QuestionNode = {
            template: '#question-node-template',
            name: 'question-node',
            props: ['node', 'defaults', 'depth'],
            data() {
                return {
                    isExpanded: true // Default
                }
            },
            created() {
                // Determine default state based on payload paper defaults
                if (this.defaults && this.defaults.expandedAll === false) {
                    this.isExpanded = false;
                }
            },
            computed: {
                hasSolutionBlock() {
                    return !!this.node.solutionBlock;
                },
                hasSolutionDetails() {
                    return this.hasSolutionBlock && !!this.node.solutionBlock.solutionDetails;
                },
                renderedQuestion() {
                    return md ? md.render(this.node.question || '') : (this.node.question || '');
                },
                renderedAnswer() {
                    if (!this.node.solutionBlock || !this.node.solutionBlock.answer) return '';
                    return md ? md.render(this.node.solutionBlock.answer) : this.node.solutionBlock.answer;
                }
            },
            methods: {
                toggleDetails() {
                    this.isExpanded = !this.isExpanded;
                    // Render math after DOM update if expanding
                    if (this.isExpanded) {
                        this.$nextTick(() => {
                            if (window.renderMathInElement) {
                                renderMathInElement(this.$el, {
                                    delimiters: [
                                        {left: '$$', right: '$$', display: true},
                                        {left: '$', right: '$', display: false}
                                    ],
                                    throwOnError: false
                                });
                            }
                        });
                    }
                },
                renderMd(text) {
                    return md ? md.render(text || '') : (text || '');
                }
            },
            mounted() {
                this.$nextTick(() => {
                    if (window.renderMathInElement) {
                        renderMathInElement(this.$el, {
                            delimiters: [
                                {left: '$$', right: '$$', display: true},
                                {left: '$', right: '$', display: false}
                            ],
                            throwOnError: false
                        });
                    }
                });
            }
        };

        // --- VUE APP ---
        const { createApp } = Vue;

        createApp({
            components: {
                'question-node': QuestionNode
            },
            data() {
                return {
                    papers: [],
                    currentPaperKey: null,
                    currentPaper: null,
                    loading: true,
                    error: false,
                    mobileNavOpen: false,
                    activeQuestionId: null,
                    observer: null
                }
            },
            computed: {
                isSectionedPaper() {
                    return this.currentPaper && !!this.currentPaper.sections;
                },
                navItems() {
                    if (!this.currentPaper) return [];
                    const items = [];

                    const traverse = (nodes, depth) => {
                        nodes.forEach(node => {
                            items.push({
                                type: 'question',
                                id: node.id,
                                label: node.id,
                                depth: depth
                            });
                            if (node.children) {
                                traverse(node.children, depth + 1);
                            }
                        });
                    };

                    if (this.isSectionedPaper) {
                        this.currentPaper.sections.forEach(section => {
                            if (section.label && section.label.trim()) {
                                items.push({
                                    type: 'section',
                                    label: section.label
                                });
                            }
                            traverse(section.questions, 0);
                        });
                    } else {
                        traverse(this.currentPaper.questions, 0);
                    }
                    return items;
                }
            },
            methods: {
                async fetchPayload() {
                    try {
                        const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                        if (!response.ok) throw new Error("Payload not found");
                        const data = await response.json();
                        
                        this.papers = data.papers || [];
                        if (this.papers.length > 0) {
                            this.currentPaperKey = this.papers[0].key;
                            this.selectPaper(this.currentPaperKey);
                        } else {
                            throw new Error("No papers in payload");
                        }
                        this.loading = false;
                    } catch (err) {
                        console.error(err);
                        this.error = true;
                        this.loading = false;
                    }
                },
                handlePaperChange() {
                    this.selectPaper(this.currentPaperKey);
                },
                selectPaper(key) {
                    const paper = this.papers.find(p => p.key === key);
                    if (paper) {
                        this.currentPaper = paper;
                        this.$nextTick(() => {
                            window.scrollTo(0, 0);
                            this.setupIntersectionObserver();
                        });
                    }
                },
                scrollToQuestion(id) {
                    const el = document.getElementById('q-' + id);
                    if (el) {
                        // Offset for sticky header/top padding
                        const offset = 20; 
                        const elementPosition = el.getBoundingClientRect().top;
                        const offsetPosition = elementPosition + window.pageYOffset - offset;
                        
                        window.scrollTo({
                            top: offsetPosition,
                            behavior: "smooth"
                        });
                    }
                },
                setupIntersectionObserver() {
                    if (this.observer) this.observer.disconnect();

                    const options = {
                        root: null,
                        rootMargin: '-10% 0px -80% 0px', // Active zone near top
                        threshold: 0
                    };

                    this.observer = new IntersectionObserver((entries) => {
                        entries.forEach(entry => {
                            if (entry.isIntersecting) {
                                // Extract id from "q-ID"
                                const id = entry.target.id.substring(2);
                                this.activeQuestionId = id;
                            }
                        });
                    }, options);

                    // Observe all question nodes
                    document.querySelectorAll('[id^="q-"]').forEach(el => {
                        this.observer.observe(el);
                    });
                }
            },
            mounted() {
                this.fetchPayload();
            }
        }).mount('#app');
    </script>
</body>
</html>
