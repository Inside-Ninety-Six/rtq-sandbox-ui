<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"ABC","indexWithinVariant":"71","totalWithinVariant":"320","hueFamily":"blue","intensityMode":"high_chroma_surfaces","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-09T13:13:23.555Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;ABC&quot;,&quot;indexWithinVariant&quot;:&quot;71&quot;,&quot;totalWithinVariant&quot;:&quot;320&quot;,&quot;hueFamily&quot;:&quot;blue&quot;,&quot;intensityMode&quot;:&quot;high_chroma_surfaces&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-09T13:13:23.555Z&quot;}'>

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RTQ Maths Paper Solution Viewer</title>

<!-- KaTeX CSS (SRI disabled per Stage 6 baseline) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

<!-- KaTeX JS (SRI disabled per Stage 6 baseline) -->
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

<!-- Markdown-it (SRI disabled per Stage 6 baseline) -->
<script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

<style>
  /* 
   * ==========================================
   * COLORLAB CONFIGURATION (Blue, High Chroma)
   * ==========================================
   * Forced Hue: Blue (approx 264deg in OKLCH)
   * Intensity Mode: high_chroma_surfaces
   * L: Lightness (0-1), C: Chroma (0-0.4), H: Hue (0-360)
   */
  :root {
    /* Hues */
    --hue-primary: 264; /* Blue */

    /* Surfaces (Mode: high_chroma_surfaces) */
    /* Rule: At least TWO major surfaces C in [0.06 .. 0.12]. Remaining C in [0.03 .. 0.07] */
    
    /* Page Background: Stronger chroma */
    --color-page-bg: oklch(0.93 0.07 var(--hue-primary));
    
    /* Frame Base: Medium chroma */
    --color-frame-bg: oklch(0.96 0.04 var(--hue-primary)); 
    
    /* Paper Surface: Low chroma for readability, but kept tinted (paper-like) */
    --color-paper-surface: oklch(0.99 0.015 var(--hue-primary));

    /* Wash Surfaces */
    /* Rule: Wash C in [0.05 .. 0.10] */
    --color-wash-surface: oklch(0.95 0.06 var(--hue-primary));
    --color-wash-sub-surface: oklch(0.94 0.07 var(--hue-primary));

    /* Typography */
    /* Primary C <= 0.015, Secondary C <= 0.020 */
    --color-text-primary: oklch(0.20 0.015 var(--hue-primary));
    --color-text-secondary: oklch(0.45 0.02 var(--hue-primary));
    --color-text-quiet: oklch(0.55 0.02 var(--hue-primary));

    /* Accents (Link/Focus/Active) */
    /* C in [0.12 .. 0.20] */
    --color-accent: oklch(0.50 0.18 var(--hue-primary));
    --color-accent-subtle: oklch(0.60 0.14 var(--hue-primary));
    
    /* Dividers */
    --color-divider: oklch(0.88 0.02 var(--hue-primary));

    /* Layout Spacing */
    --space-unit: 8px;
    --space-xs: 4px;
    --space-sm: 8px;
    --space-md: 16px;
    --space-lg: 24px;
    --space-xl: 40px;
    --space-xxl: 64px; /* Top-level question separation */

    /* Typography Defaults */
    --font-family-base: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
    --font-size-base: 16px;
    --font-size-sm: 14px;
    --font-size-xs: 12px;
    --line-height-base: 1.5;
    --line-height-tight: 1.3;
  }

  /* RESET & BASE */
  *, *::before, *::after { box-sizing: border-box; }
  body {
    margin: 0;
    padding: 0;
    font-family: var(--font-family-base);
    font-size: var(--font-size-base);
    line-height: var(--line-height-base);
    background-color: var(--color-page-bg);
    color: var(--color-text-primary);
    -webkit-font-smoothing: antialiased;
  }
  button { font-family: inherit; }
  
  /* UTILITIES */
  .visually-hidden {
    position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px;
    overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0;
  }

  /* SHELL STRUCTURE */
  #app-root {
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }

  /* Top Controls */
  .top-controls {
    padding: var(--space-md);
    background-color: var(--color-frame-bg); /* Match frame base context */
    border-bottom: 1px solid var(--color-divider);
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: relative;
    z-index: 20;
  }
  
  .paper-selector {
    padding: var(--space-xs) var(--space-sm);
    font-size: var(--font-size-sm);
    border: 1px solid var(--color-divider);
    border-radius: 4px;
    background: var(--color-paper-surface);
    color: var(--color-text-primary);
  }

  /* Mobile Jump Trigger */
  .mobile-jump-trigger {
    display: none; /* Desktop default */
    background: none;
    border: none;
    color: var(--color-accent);
    font-weight: 600;
    font-size: var(--font-size-sm);
    cursor: pointer;
  }

  /* Document Frame Shell */
  .document-frame-shell {
    flex: 1;
    display: flex;
    flex-direction: row;
    max-width: 1200px;
    margin: 0 auto;
    background-color: var(--color-frame-bg);
    width: 100%;
    /* No box shadow or elevation per constraints */
  }

  /* Navigation Rail (Desktop) */
  .nav-rail {
    width: 240px;
    flex-shrink: 0;
    position: sticky;
    top: 0;
    height: 100vh;
    overflow-y: auto;
    padding: var(--space-md);
    border-right: 1px solid transparent; /* Separator optional */
    /* Scrollbar hiding */
    scrollbar-width: none;
    -ms-overflow-style: none;
  }
  .nav-rail::-webkit-scrollbar { display: none; }

  /* Paper Column */
  .paper-column {
    flex: 1;
    padding: var(--space-xl) var(--space-lg);
    background-color: var(--color-paper-surface); /* Distinct surface */
    /* To ensure we don't overflow horizontally at page level */
    min-width: 0; 
  }

  /* NAVIGATION STYLES */
  .nav-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
  }
  .nav-item {
    display: block;
    padding: var(--space-xs) 0;
    color: var(--color-text-secondary);
    text-decoration: none;
    font-size: var(--font-size-sm);
    cursor: pointer;
    border-left: 2px solid transparent;
    padding-left: var(--space-sm);
    transition: color 0.1s ease, border-color 0.1s ease;
  }
  .nav-item:hover {
    color: var(--color-text-primary);
    border-left-color: var(--color-divider);
  }
  .nav-item.active {
    color: var(--color-text-primary);
    font-weight: 600;
    border-left-color: var(--color-accent); /* Accent marker allowed in nav */
  }
  .nav-section-label {
    margin-top: var(--space-md);
    margin-bottom: var(--space-xs);
    font-size: var(--font-size-xs);
    font-weight: 700;
    text-transform: uppercase;
    color: var(--color-text-quiet);
    padding-left: var(--space-sm);
    pointer-events: none;
  }
  /* Hierarchy via type scale only - Sub-questions */
  .nav-item.depth-1 { font-size: 0.9em; color: var(--color-text-quiet); }
  .nav-item.depth-2 { font-size: 0.85em; color: var(--color-text-quiet); }

  /* PAPER CONTENT STYLES */
  .paper-section-header {
    font-size: var(--font-size-base);
    font-weight: 700;
    color: var(--color-text-secondary);
    margin-bottom: var(--space-lg);
    border-bottom: 1px solid var(--color-divider);
    padding-bottom: var(--space-xs);
  }

  .question-node {
    /* Top-level spacing */
    margin-bottom: var(--space-xxl);
    position: relative;
  }
  
  /* Children handling */
  .children-container {
    margin-top: var(--space-md);
    /* Indentation via spacing only */
    padding-left: var(--space-md); 
    border-left: 1px solid transparent; /* No heavy borders */
  }
  .children-container .question-node {
    margin-bottom: var(--space-lg); /* Tighter spacing for children */
  }

  /* Question Body */
  .question-body {
    display: flex;
    gap: var(--space-sm);
    margin-bottom: var(--space-md);
    color: var(--color-text-primary);
  }
  .q-id {
    font-weight: 600;
    min-width: 2em;
    flex-shrink: 0;
    color: var(--color-text-secondary);
  }
  .q-prompt {
    flex: 1;
    font-weight: 500; /* Primary anchor */
  }

  /* Solution Block */
  .solution-block {
    margin-left: calc(2em + var(--space-sm)); /* Align with prompt */
  }

  /* Answer */
  .answer-region {
    margin-bottom: var(--space-sm);
    color: var(--color-text-secondary); /* Subordinate */
  }
  .answer-label {
    font-weight: 700;
    font-size: var(--font-size-xs);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-right: var(--space-xs);
    color: var(--color-text-quiet);
  }

  /* Disclosure Control */
  .disclosure-control {
    background: none;
    border: none;
    padding: 0;
    margin: var(--space-sm) 0;
    color: var(--color-accent);
    font-size: var(--font-size-sm);
    font-weight: 500;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: var(--space-xs);
  }
  .disclosure-control:hover {
    text-decoration: underline;
  }
  .disclosure-icon {
    transition: transform 0.2s ease;
  }
  .disclosure-control[aria-expanded="true"] .disclosure-icon {
    transform: rotate(180deg);
  }

  /* Solution Details Region */
  .solution-details-region {
    display: none; /* Hidden by default */
    margin-top: var(--space-sm);
    background-color: var(--color-wash-surface);
    padding: var(--space-md);
    /* Subordination via surface + spacing, no heavy borders */
    border-radius: 4px; /* Slight softening allowed, not card-like */
  }
  .solution-details-region[data-expanded="true"] {
    display: block;
    animation: fadeIn 0.2s ease-out;
  }

  @keyframes fadeIn { from { opacity: 0; transform: translateY(-4px); } to { opacity: 1; transform: translateY(0); } }

  /* Solution Details Subsections */
  .sd-section {
    margin-bottom: var(--space-md);
  }
  .sd-section:last-child { margin-bottom: 0; }
  
  .sd-label {
    font-size: var(--font-size-xs);
    font-weight: 700;
    color: var(--color-text-secondary);
    margin-bottom: var(--space-xs);
    display: block;
  }
  
  /* Keep in mind */
  .sd-keep-in-mind {
    color: var(--color-text-secondary);
  }
  .sd-keep-in-mind .sd-body ul {
    margin: 0; padding-left: 1.2em;
  }

  /* Formulas */
  .sd-formulas {
    background-color: var(--color-wash-sub-surface);
    padding: var(--space-sm);
    border-radius: 2px;
  }

  /* Working */
  .sd-working .sd-body {
    color: var(--color-text-secondary);
    line-height: 1.6;
  }
  
  /* Alternative Working */
  .sd-alt-working {
    border-top: 1px solid var(--color-divider);
    padding-top: var(--space-md);
    margin-top: var(--space-md);
  }

  /* MARKDOWN & KATEX CONTENT STYLES */
  .md-content p { margin: 0 0 var(--space-sm) 0; }
  .md-content p:last-child { margin-bottom: 0; }
  
  /* Table minimal styling */
  .md-content table {
    width: 100%;
    border-collapse: collapse;
    margin: var(--space-sm) 0;
    font-size: var(--font-size-sm);
  }
  .md-content th, .md-content td {
    text-align: left;
    padding: var(--space-xs);
    border-bottom: 1px solid var(--color-divider);
  }
  .md-content th { font-weight: 600; }

  /* KaTeX Containment Invariant */
  /* Block math containers */
  .katex-display {
    overflow-x: auto;
    overflow-y: hidden;
    max-width: 100%;
    padding: var(--space-xs) 0;
    margin: var(--space-sm) 0;
    /* Hide scrollbar visually but allow scroll */
    scrollbar-width: none; 
    -ms-overflow-style: none;
  }
  .katex-display::-webkit-scrollbar { display: none; }
  
  /* Inline SVG passthrough */
  svg { max-width: 100%; height: auto; }

  /* MOBILE / RESPONSIVE */
  @media (max-width: 768px) {
    .document-frame-shell { flex-direction: column; }
    .nav-rail { display: none; } /* Hide rail, switch to drawer */
    .mobile-jump-trigger { display: block; }
    
    .children-container { padding-left: var(--space-sm); }
    .solution-block { margin-left: 0; margin-top: var(--space-xs); }
    
    .paper-column { padding: var(--space-md) var(--space-md); }
  }

  /* DRAWER (Mobile) */
  .drawer-backdrop {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.2);
    z-index: 999;
    display: none;
  }
  .drawer-backdrop.open { display: block; }
  
  .drawer {
    position: fixed; top: 0; left: 0; bottom: 0;
    width: 280px;
    background: var(--color-frame-bg);
    z-index: 1000;
    transform: translateX(-100%);
    transition: transform 0.2s ease-out;
    display: flex; flex-direction: column;
    box-shadow: 2px 0 8px rgba(0,0,0,0.05);
  }
  .drawer.open { transform: translateX(0); }
  
  .drawer-header {
    padding: var(--space-md);
    border-bottom: 1px solid var(--color-divider);
    display: flex; justify-content: space-between; align-items: center;
  }
  .drawer-title { font-weight: 700; color: var(--color-text-primary); }
  .drawer-close { background: none; border: none; font-size: 1.5rem; color: var(--color-text-secondary); cursor: pointer; }
  
  .drawer-content {
    flex: 1; overflow-y: auto; padding: var(--space-md);
  }

  /* LOADING / ERROR STATE */
  .status-message {
    padding: var(--space-xl);
    text-align: center;
    color: var(--color-text-quiet);
    font-weight: 600;
  }

</style>
</head>
<body>

<div id="app-root">
  <header class="top-controls">
    <select id="paper-selector" class="paper-selector" aria-label="Select Paper">
      <option value="" disabled selected>Loading papers...</option>
    </select>
    <button id="mobile-jump" class="mobile-jump-trigger" aria-label="Jump to Question">
      Jump to
    </button>
  </header>

  <div class="document-frame-shell">
    <!-- Desktop Nav Rail -->
    <nav id="nav-rail" class="nav-rail" aria-label="Document Navigation"></nav>

    <!-- Paper Content -->
    <main id="paper-column" class="paper-column">
      <div id="paper-region"></div>
    </main>
  </div>
</div>

<!-- Mobile Drawer -->
<div id="drawer-backdrop" class="drawer-backdrop"></div>
<div id="drawer" class="drawer" role="dialog" aria-modal="true" aria-label="Navigation">
  <div class="drawer-header">
    <span class="drawer-title">Jump to</span>
    <button id="drawer-close" class="drawer-close" aria-label="Close navigation">&times;</button>
  </div>
  <div id="drawer-nav-container" class="drawer-content"></div>
</div>

<script>
/**
 * CANONICAL CONSTANTS
 */
const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

// --- Markdown renderer (authoritative config) ---
// Config: html:true, linkify:true, breaks:false
const md = window.markdownit
  ? window.markdownit({
      html: true, 
      linkify: true,
      breaks: false, // Must stay false
    })
  : null;

if (md) {
  // Disable escape rule to preserve TeX backslashes
  md.inline.ruler.disable(["escape"]);
}

/**
 * STATE & LOGIC
 */
let payloadData = null;
let currentPaperKey = null;
let expandedMap = new Map(); // questionId -> boolean

// DOM Elements
const paperSelector = document.getElementById('paper-selector');
const navRail = document.getElementById('nav-rail');
const paperRegion = document.getElementById('paper-region');
const drawer = document.getElementById('drawer');
const drawerBackdrop = document.getElementById('drawer-backdrop');
const drawerNavContainer = document.getElementById('drawer-nav-container');

async function init() {
  try {
    const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
    if (!response.ok) throw new Error("Payload not found");
    
    payloadData = await response.json();
    
    if (!payloadData || !payloadData.papers) {
      throw new Error("Invalid payload");
    }

    populateSelector();
    
    // Default to first paper
    if (payloadData.papers.length > 0) {
      loadPaper(payloadData.papers[0].key);
    }

  } catch (e) {
    console.error(e);
    paperRegion.innerHTML = `<div class="status-message">PAPERS PAYLOAD MISSING</div>`;
  }
}

function populateSelector() {
  paperSelector.innerHTML = '';
  payloadData.papers.forEach(p => {
    const opt = document.createElement('option');
    opt.value = p.key;
    opt.textContent = p.label || p.key;
    paperSelector.appendChild(opt);
  });
  
  paperSelector.addEventListener('change', (e) => {
    loadPaper(e.target.value);
  });
}

function loadPaper(key) {
  currentPaperKey = key;
  paperSelector.value = key;
  const paper = payloadData.papers.find(p => p.key === key);
  
  if (!paper) return;

  // Reset State
  expandedMap.clear();
  // Init defaults
  const expandedAll = paper.defaults?.expandedAll !== false; // Default true unless false
  // We don't need to pre-fill expandedMap since we treat 'undefined' as default
  
  renderPaperContent(paper, expandedAll);
  renderNavigation(paper);
  
  // Mobile drawer content sync
  drawerNavContainer.innerHTML = '';
  const cloneNav = navRail.cloneNode(true);
  cloneNav.id = 'drawer-nav-list';
  cloneNav.className = ''; // remove desktop class
  drawerNavContainer.appendChild(cloneNav);

  // Setup Observer for Scroll Spy
  setupScrollSpy();
}

/**
 * RENDERERS
 */

function renderPaperContent(paper, defaultExpanded) {
  paperRegion.innerHTML = '';
  
  let contentHtml = '';

  if (paper.sections) {
    paper.sections.forEach(section => {
      // Section Header (only if label exists)
      if (section.label && section.label.trim().length > 0) {
        contentHtml += `<div class="paper-section-header">${escapeHtml(section.label)}</div>`;
      }
      contentHtml += renderQuestionList(section.questions, defaultExpanded, 0);
    });
  } else if (paper.questions) {
    contentHtml += renderQuestionList(paper.questions, defaultExpanded, 0);
  } else {
    contentHtml = '<div class="status-message">No questions found.</div>';
  }

  paperRegion.innerHTML = contentHtml;

  // Post-render: KaTeX
  if (window.renderMathInElement) {
    renderMathInElement(paperRegion, {
      delimiters: [
        {left: '$$', right: '$$', display: true},
        {left: '$', right: '$', display: false}
      ],
      throwOnError: false
    });
  }
  
  // Attach Event Listeners for Toggles
  const toggles = paperRegion.querySelectorAll('.disclosure-control');
  toggles.forEach(btn => {
    btn.addEventListener('click', () => {
      const qId = btn.getAttribute('data-qid');
      const region = document.getElementById(`sd-${qId}`);
      const isExpanded = btn.getAttribute('aria-expanded') === 'true';
      
      if (isExpanded) {
        btn.setAttribute('aria-expanded', 'false');
        btn.innerHTML = `Show working <span class="disclosure-icon">▼</span>`;
        region.setAttribute('data-expanded', 'false');
      } else {
        btn.setAttribute('aria-expanded', 'true');
        btn.innerHTML = `Hide working <span class="disclosure-icon">▼</span>`;
        region.setAttribute('data-expanded', 'true');
      }
    });
  });
}

function renderQuestionList(questions, defaultExpanded, depth) {
  if (!questions) return '';
  return questions.map(q => renderQuestionNode(q, defaultExpanded, depth)).join('');
}

function renderQuestionNode(node, defaultExpanded, depth) {
  // Safe ID for DOM
  const safeId = node.id.replace(/[^a-zA-Z0-9-_]/g, '_');
  
  // Markdown Rendering
  const qBodyHtml = md ? md.render(node.question || '') : (node.question || '');
  
  let solutionBlockHtml = '';
  const sb = node.solutionBlock;
  
  if (sb) {
    // Answer
    let answerHtml = '';
    if (sb.answer) {
      const ansMd = md ? md.render(sb.answer) : sb.answer;
      answerHtml = `
        <div class="answer-region">
          <span class="answer-label">Answer</span>
          <span class="answer-content md-content">${ansMd}</span>
        </div>
      `;
    }

    // Solution Details
    let detailsHtml = '';
    if (sb.solutionDetails) {
      const sd = sb.solutionDetails;
      const isExpanded = defaultExpanded; 
      
      // Subsections
      let subHtml = '';
      
      if (sd.keepInMind) {
        subHtml += `
          <div class="sd-section sd-keep-in-mind">
            <span class="sd-label">Keep in mind</span>
            <div class="sd-body md-content">${md ? md.render(sd.keepInMind) : sd.keepInMind}</div>
          </div>
        `;
      }
      
      if (sd.formulasUsed) {
        subHtml += `
          <div class="sd-section sd-formulas">
            <span class="sd-label">Formulas used</span>
            <div class="sd-body md-content">${md ? md.render(sd.formulasUsed) : sd.formulasUsed}</div>
          </div>
        `;
      }
      
      if (sd.working) {
        subHtml += `
          <div class="sd-section sd-working">
            <span class="sd-label">Working</span>
            <div class="sd-body md-content">${md ? md.render(sd.working) : sd.working}</div>
          </div>
        `;
      }
      
      if (sd.alternativeWorking && Array.isArray(sd.alternativeWorking)) {
        sd.alternativeWorking.forEach((aw, idx) => {
           subHtml += `
            <div class="sd-section sd-alt-working">
              <span class="sd-label">Alternative working</span>
              <div class="sd-body md-content">${md ? md.render(aw) : aw}</div>
            </div>
          `;
        });
      }
      
      // If we have any details content
      if (subHtml) {
        detailsHtml = `
          <button class="disclosure-control" data-qid="${safeId}" aria-expanded="${isExpanded}">
            ${isExpanded ? 'Hide working' : 'Show working'} <span class="disclosure-icon">▼</span>
          </button>
          <div id="sd-${safeId}" class="solution-details-region" data-expanded="${isExpanded}">
            ${subHtml}
          </div>
        `;
      }
    }

    if (answerHtml || detailsHtml) {
      solutionBlockHtml = `<div class="solution-block">${answerHtml}${detailsHtml}</div>`;
    }
  }

  // Children
  let childrenHtml = '';
  if (node.children && node.children.length > 0) {
    childrenHtml = `<div class="children-container">${renderQuestionList(node.children, defaultExpanded, depth + 1)}</div>`;
  }

  return `
    <div id="q-${safeId}" class="question-node" data-id="${node.id}">
      <div class="question-body">
        <div class="q-id">${node.id}</div>
        <div class="q-prompt md-content">${qBodyHtml}</div>
      </div>
      ${solutionBlockHtml}
      ${childrenHtml}
    </div>
  `;
}

function renderNavigation(paper) {
  navRail.innerHTML = '';
  const list = document.createElement('ul');
  list.className = 'nav-list';
  
  const createNavItem = (q, depth) => {
    const li = document.createElement('li');
    const a = document.createElement('a');
    a.className = `nav-item depth-${depth}`;
    a.textContent = q.id;
    a.dataset.target = q.id.replace(/[^a-zA-Z0-9-_]/g, '_');
    
    a.addEventListener('click', (e) => {
      e.preventDefault();
      const targetEl = document.getElementById(`q-${a.dataset.target}`);
      if (targetEl) {
        targetEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
        closeDrawer();
      }
    });
    
    li.appendChild(a);
    list.appendChild(li);
    
    if (q.children) {
      q.children.forEach(child => createNavItem(child, depth + 1));
    }
  };

  if (paper.sections) {
    paper.sections.forEach((sec, idx) => {
      // Section Label (non-clickable)
      if (sec.label && sec.label.trim()) {
        const label = document.createElement('div');
        label.className = 'nav-section-label';
        label.textContent = sec.label;
        list.appendChild(label);
      } else if (idx > 0) {
        // Spacing separator if no label but distinct section
        const sep = document.createElement('li');
        sep.style.height = '8px'; 
        list.appendChild(sep);
      }
      
      sec.questions.forEach(q => createNavItem(q, 0));
    });
  } else if (paper.questions) {
    paper.questions.forEach(q => createNavItem(q, 0));
  }
  
  navRail.appendChild(list);
}

// Scroll Spy Logic
function setupScrollSpy() {
  const options = {
    root: null,
    rootMargin: '-10% 0px -80% 0px', // Active zone near top
    threshold: 0
  };

  const callback = (entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        const id = entry.target.getAttribute('data-id');
        setActiveNav(id);
      }
    });
  };

  const observer = new IntersectionObserver(callback, options);
  document.querySelectorAll('.question-node').forEach(node => observer.observe(node));
}

function setActiveNav(id) {
  // Both desktop and mobile navs
  const safeId = id.replace(/[^a-zA-Z0-9-_]/g, '_');
  document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
  
  const activeEls = document.querySelectorAll(`.nav-item[data-target="${safeId}"]`);
  activeEls.forEach(el => {
    el.classList.add('active');
    // simple scroll into view for nav rail
    if (el.scrollIntoViewIfNeeded) el.scrollIntoViewIfNeeded();
  });
}

// Drawer Logic
const drawerJumpBtn = document.getElementById('mobile-jump');
const drawerCloseBtn = document.getElementById('drawer-close');

function openDrawer() {
  drawer.classList.add('open');
  drawerBackdrop.classList.add('open');
}
function closeDrawer() {
  drawer.classList.remove('open');
  drawerBackdrop.classList.remove('open');
}

drawerJumpBtn.addEventListener('click', openDrawer);
drawerCloseBtn.addEventListener('click', closeDrawer);
drawerBackdrop.addEventListener('click', closeDrawer);

// Escape html helper
function escapeHtml(text) {
  const map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  };
  return text.replace(/[&<>"']/g, function(m) { return map[m]; });
}

// Init
init();

</script>
</body>
</html>
