<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"ABC","indexWithinVariant":"59","totalWithinVariant":"320","hueFamily":"teal","intensityMode":"high_chroma_surfaces","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-09T12:40:03.714Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;ABC&quot;,&quot;indexWithinVariant&quot;:&quot;59&quot;,&quot;totalWithinVariant&quot;:&quot;320&quot;,&quot;hueFamily&quot;:&quot;teal&quot;,&quot;intensityMode&quot;:&quot;high_chroma_surfaces&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-09T12:40:03.714Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>

    <!-- 
      STAGE 6 ADD-ON: REAL KATEX RENDERING 
      Note: Integrity attributes disabled per Stage 6.0.7b to prevent CDN hash mismatches.
    -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    
    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <style>
        /* 
          STAGE 6 ADD-ON: COLORLAB C (High Chroma Surfaces - Teal)
          Mode: high_chroma_surfaces
          Hue: Teal (approx H=195)
          Light Mode Only.
        */
        :root {
            /* 
               Palette Logic (High Chroma Surfaces):
               - 2 Major surfaces must be chromatic (C 0.06 - 0.12)
               - 1 Major surface must be tinted (C 0.03 - 0.07)
               - Wash surfaces C 0.05 - 0.10
               - Text mostly neutral (C <= 0.015)
               - Accent C 0.12 - 0.20
            */
            
            /* Major Surfaces */
            --surf-page: oklch(0.94 0.08 195);  /* Chromatic 1 */
            --surf-frame: oklch(0.91 0.09 195); /* Chromatic 2 */
            --surf-paper: oklch(0.98 0.03 195); /* Tinted (Paper needs to be readable) */

            /* Functional Surfaces */
            --surf-wash: oklch(0.95 0.06 195); /* Solution Details Wash */
            --surf-nav-marker: oklch(0.55 0.16 195); 

            /* Typography */
            --text-primary: oklch(0.20 0.015 195);
            --text-secondary: oklch(0.40 0.015 195);
            --text-tertiary: oklch(0.55 0.02 195); /* For quiet labels */

            /* Accents (Restrained) */
            --accent-primary: oklch(0.50 0.16 195); /* Links, Focus */
            --accent-focus-ring: oklch(0.50 0.16 195 / 0.4);

            /* Borders / Dividers */
            --divider-hairline: oklch(0.0 0.0 0 / 0.08);

            /* Layout Metrics */
            --space-unit: 1rem;
            --max-paper-width: 800px;
            --nav-width: 240px;
            --frame-gutter: 2rem;
        }

        /* RESET & BASE */
        *, *::before, *::after { box-sizing: border-box; }
        body {
            margin: 0;
            padding: 0;
            font-family: system-ui, -apple-system, sans-serif;
            background-color: var(--surf-page);
            color: var(--text-primary);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            overflow-y: scroll; /* Force scrollbar to avoid jumping */
        }

        /* KATE X CONTAINMENT (LOCKED) */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding-block: 0.5em;
            /* Scrollbar hiding for math */
            scrollbar-width: thin;
            scrollbar-color: var(--text-secondary) transparent;
        }
        .katex-display::-webkit-scrollbar {
            height: 4px;
        }
        .katex-display::-webkit-scrollbar-thumb {
            background: var(--text-secondary);
            border-radius: 2px;
        }

        /* LAYOUT SHELL */
        .app-shell {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background-color: var(--surf-frame);
            /* Align with frame concept */
            max-width: 1280px;
            margin: 0 auto;
            box-shadow: 0 0 40px oklch(0 0 0 / 0.05);
        }

        /* TOP CONTROLS */
        .top-controls {
            padding: 1rem var(--frame-gutter);
            border-bottom: 1px solid var(--divider-hairline);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: var(--surf-frame);
            position: sticky;
            top: 0;
            z-index: 20;
        }
        
        .paper-selector {
            font-family: inherit;
            font-size: 0.95rem;
            padding: 0.5rem 2rem 0.5rem 0.75rem;
            border: 1px solid var(--divider-hairline);
            border-radius: 4px;
            background-color: var(--surf-paper);
            color: var(--text-primary);
            cursor: pointer;
        }

        .mobile-jump-trigger {
            display: none; /* Desktop default */
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--accent-primary);
            background: none;
            border: none;
            padding: 0.5rem;
            cursor: pointer;
        }

        /* MAIN CONTENT COLUMNS */
        .document-body {
            display: flex;
            flex: 1;
        }

        /* NAVIGATION RAIL (DESKTOP) */
        .nav-column {
            width: var(--nav-width);
            flex-shrink: 0;
            padding: 2rem 1rem 2rem var(--frame-gutter);
            position: sticky;
            top: 4rem; /* Below top controls */
            height: calc(100vh - 4rem);
            overflow-y: auto;
            /* Hide scrollbar visually */
            scrollbar-width: none;
        }
        .nav-column::-webkit-scrollbar { display: none; }

        .nav-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        /* Section Label in Nav */
        .nav-section-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-tertiary);
            font-weight: 700;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            padding-left: 0.5rem;
            pointer-events: none;
        }
        .nav-section-label:first-child { margin-top: 0; }

        .nav-item {
            display: block;
            padding: 0.35rem 0.5rem;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.9rem;
            border-radius: 4px;
            transition: color 0.1s ease, background-color 0.1s ease;
            cursor: pointer;
            text-align: left;
            background: none;
            border: none;
            width: 100%;
        }

        /* Hierarchy via Type Scale Only (Flat List) */
        .nav-item[data-depth="0"] { font-size: 0.95rem; }
        .nav-item[data-depth="1"] { font-size: 0.85rem; }
        .nav-item[data-depth="2"] { font-size: 0.8rem; }

        .nav-item:hover {
            color: var(--text-primary);
            background-color: oklch(0 0 0 / 0.03);
        }

        .nav-item.active {
            font-weight: 700;
            color: var(--accent-primary);
            /* Optional Nav Marker */
            box-shadow: inset 3px 0 0 var(--accent-primary); 
        }

        /* PAPER CONTENT */
        .paper-column {
            flex: 1;
            padding: 2rem var(--frame-gutter) 4rem 2rem;
            min-width: 0; /* Flexbox overflow fix */
        }

        .paper-surface {
            background-color: var(--surf-paper);
            min-height: 80vh; /* Visual anchor */
            padding: 3rem;
            max-width: var(--max-paper-width);
            margin: 0 auto; /* Centered in column if wide, but column aligns left */
            /* Paper is left-aligned in column per brief? 
               Brief: "Navigation and paper content must coexist... as parallel columns. The paper content column must visually dominate."
               Brief: "The paper content column must not be centered as if standalone while the navigation exists."
               Implementation: We align the paper surface to the left of the paper column or center it slightly within the column if very wide. 
               Let's keep margin-left: 0 for strict 2-col feel, or margin: 0 auto for reading comfort inside the column. 
               Given "DocumentFrameShell", usually centers the whole frame. Inside frame, nav is left, paper is right. 
               Let's just fill the column with the surface essentially.
            */
            margin-left: 0;
            border-radius: 2px; /* Very subtle */
        }

        /* SECTION HEADERS (IN PAPER) */
        .section-header-block {
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--divider-hairline);
            padding-bottom: 0.5rem;
        }
        .section-header-text {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* QUESTION NODES */
        .question-node {
            margin-bottom: 3rem; /* Top Level Spacing */
            position: relative;
        }
        
        /* Nesting Spacing */
        .children-container {
            margin-top: 1.5rem;
            /* Indentation for sub-questions */
            padding-left: 0; /* Brief: Indentation permitted. */
        }
        @media (min-width: 768px) {
            .children-container { padding-left: 2rem; }
        }

        .question-node[data-has-parent="true"] {
            margin-bottom: 1.5rem; /* Tighter for children */
        }

        /* Question Body */
        .question-body {
            display: flex;
            gap: 1rem;
            color: var(--text-primary);
            margin-bottom: 1rem;
        }
        .question-id {
            font-weight: 700;
            color: var(--text-secondary);
            flex-shrink: 0;
            width: 2.5rem; /* Fixed width for alignment */
        }
        .question-prompt {
            flex: 1;
        }
        .question-prompt p { margin-top: 0; }

        /* Solution Block */
        .solution-block {
            margin-left: 3.5rem; /* Align with text start */
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        @media (max-width: 768px) {
            .solution-block { margin-left: 0; padding-left: 1rem; border-left: 2px solid var(--divider-hairline); }
        }

        /* Answer */
        .answer-region {
            font-weight: 500;
            color: var(--text-primary);
            display: flex;
            gap: 0.5rem;
            align-items: baseline;
        }
        .answer-label {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Disclosure Control */
        .disclosure-control {
            background: none;
            border: none;
            padding: 0;
            font-size: 0.9rem;
            color: var(--accent-primary);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
            width: fit-content;
        }
        .disclosure-control:hover {
            text-decoration: underline;
        }
        .disclosure-control:focus-visible {
            outline: 2px solid var(--accent-focus-ring);
            outline-offset: 2px;
            border-radius: 2px;
        }
        .chevron {
            transition: transform 0.2s ease;
            width: 1em; height: 1em;
            fill: currentColor;
        }
        .disclosure-control[aria-expanded="true"] .chevron {
            transform: rotate(180deg);
        }

        /* Solution Details Region */
        .solution-details-region {
            display: none;
            background-color: var(--surf-wash);
            padding: 1.5rem;
            border-radius: 4px; /* Subtle */
            margin-top: 0.5rem;
        }
        .solution-details-region[data-expanded="true"] {
            display: block;
            animation: fadeIn 0.2s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Subsections */
        .sd-subsection {
            margin-bottom: 1.5rem;
        }
        .sd-subsection:last-child { margin-bottom: 0; }

        .sd-label {
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-tertiary);
            margin-bottom: 0.5rem;
            display: block;
        }

        .sd-body {
            color: var(--text-secondary); /* Subordinate */
            font-size: 0.95rem;
        }
        .sd-body p { margin: 0 0 0.75rem 0; }
        .sd-body p:last-child { margin: 0; }
        
        /* Keep in mind specifics */
        .sd-keep-in-mind .sd-body ul {
            padding-left: 1.25rem;
            margin: 0;
        }
        
        /* Working Math Styling */
        /* Inline math: no background */
        .katex { font-size: 1.1em; }
        
        /* Markdown Tables */
        table {
            border-collapse: collapse;
            width: 100%;
            font-size: 0.9rem;
            margin: 1rem 0;
        }
        th, td {
            border: 1px solid var(--divider-hairline);
            padding: 0.5rem;
            text-align: left;
        }
        th { font-weight: 600; background-color: oklch(0 0 0 / 0.02); }

        /* MOBILE DRAWER */
        .mobile-drawer-overlay {
            position: fixed;
            inset: 0;
            background: oklch(0 0 0 / 0.2);
            z-index: 40;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }
        .mobile-drawer {
            position: fixed;
            top: 0; bottom: 0; left: 0;
            width: 85%;
            max-width: 320px;
            background: var(--surf-frame);
            z-index: 50;
            transform: translateX(-100%);
            transition: transform 0.25s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex;
            flex-direction: column;
            box-shadow: 10px 0 20px oklch(0 0 0 / 0.1);
        }
        .drawer-open .mobile-drawer-overlay { opacity: 1; pointer-events: auto; }
        .drawer-open .mobile-drawer { transform: translateX(0); }

        .drawer-header {
            padding: 1rem;
            border-bottom: 1px solid var(--divider-hairline);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .drawer-title { font-weight: 700; }
        .drawer-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
        }
        .drawer-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .nav-column { display: none; }
            .mobile-jump-trigger { display: block; }
            .paper-column { padding: 1.5rem 1rem; }
            .paper-surface { padding: 1.5rem 1rem; }
            .question-id { width: 2rem; }
        }

        /* ERROR STATE */
        .error-message {
            color: var(--text-primary);
            text-align: center;
            margin-top: 4rem;
            font-weight: 700;
            letter-spacing: 0.05em;
        }

        /* Accessibility focus ring */
        :focus-visible {
            outline: 2px solid var(--accent-focus-ring);
            outline-offset: 2px;
        }
    </style>
</head>
<body>

    <!-- STAGE 0: CONSTANT DEFINITION (Runtime) -->
    <script>
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
    </script>

    <div class="app-shell">
        <!-- TOP CONTROLS -->
        <header class="top-controls">
            <!-- Paper Selector (Populated dynamically) -->
            <select id="paperSelector" class="paper-selector" aria-label="Select Paper">
                <option disabled selected>Loading papers...</option>
            </select>

            <!-- Mobile Jump Trigger -->
            <button id="mobileJumpBtn" class="mobile-jump-trigger" aria-label="Jump to question">
                Jump to...
            </button>
        </header>

        <div class="document-body">
            <!-- NAVIGATION COLUMN (Desktop) -->
            <nav class="nav-column" aria-label="Paper navigation">
                <ul id="desktopNavList" class="nav-list">
                    <!-- Generated Nav Items -->
                </ul>
            </nav>

            <!-- PAPER CONTENT -->
            <main class="paper-column">
                <div id="paperSurface" class="paper-surface">
                    <div id="paperContent" role="article">
                        <!-- Content goes here -->
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- MOBILE DRAWER -->
    <div id="drawerOverlay" class="mobile-drawer-overlay" aria-hidden="true"></div>
    <div id="mobileDrawer" class="mobile-drawer" aria-hidden="true">
        <div class="drawer-header">
            <span class="drawer-title">Jump to</span>
            <button id="drawerCloseBtn" class="drawer-close" aria-label="Close navigation">&times;</button>
        </div>
        <div class="drawer-content">
            <ul id="mobileNavList" class="nav-list">
                <!-- Cloned Nav Items -->
            </ul>
        </div>
    </div>

    <script>
        /**
         * RTQ Maths Paper Viewer - Stage 6 Baseline Prototype
         */

        // --- Markdown configuration (Stage 6 Add-on) ---
        const md = window.markdownit ? window.markdownit({
            html: true,
            linkify: true,
            breaks: false 
        }) : null;

        if (md) {
            md.inline.ruler.disable(['escape']);
        }

        // --- State ---
        let payloadData = null;
        let activePaperKey = null;

        // --- Elements ---
        const paperSelector = document.getElementById('paperSelector');
        const desktopNavList = document.getElementById('desktopNavList');
        const mobileNavList = document.getElementById('mobileNavList');
        const paperContent = document.getElementById('paperContent');
        const mobileJumpBtn = document.getElementById('mobileJumpBtn');
        const drawerOverlay = document.getElementById('drawerOverlay');
        const mobileDrawer = document.getElementById('mobileDrawer');
        const drawerCloseBtn = document.getElementById('drawerCloseBtn');

        // --- Initialization ---
        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Fetch failed");
                payloadData = await response.json();
                
                if (!payloadData || !payloadData.papers || payloadData.papers.length === 0) {
                    throw new Error("Invalid payload");
                }

                populatePaperSelector();
                // Select first paper by default
                switchPaper(payloadData.papers[0].key);

            } catch (err) {
                console.error(err);
                renderErrorState();
            }
        }

        function renderErrorState() {
            paperContent.innerHTML = `<div class="error-message">PAPERS PAYLOAD MISSING</div>`;
            paperSelector.innerHTML = `<option disabled>Error</option>`;
        }

        function populatePaperSelector() {
            paperSelector.innerHTML = '';
            payloadData.papers.forEach(paper => {
                const opt = document.createElement('option');
                opt.value = paper.key;
                opt.textContent = paper.label;
                paperSelector.appendChild(opt);
            });

            paperSelector.addEventListener('change', (e) => {
                switchPaper(e.target.value);
            });
        }

        function switchPaper(key) {
            activePaperKey = key;
            const paper = payloadData.papers.find(p => p.key === key);
            if (!paper) return;

            // Render content
            renderPaperContent(paper);
            
            // Build Nav
            const navItems = generateNavStructure(paper);
            renderNav(desktopNavList, navItems);
            renderNav(mobileNavList, navItems);

            // Reset scroll
            window.scrollTo(0, 0);
            document.querySelector('.nav-column').scrollTo(0, 0);
        }

        // --- Content Rendering ---

        function renderPaperContent(paper) {
            paperContent.innerHTML = '';
            
            const defaults = paper.defaults || { expandedAll: true };

            if (paper.sections && paper.sections.length > 0) {
                paper.sections.forEach(section => {
                    // Render Section Header if label exists
                    if (section.label && section.label.trim() !== '') {
                        const header = document.createElement('div');
                        header.className = 'section-header-block';
                        header.innerHTML = `<div class="section-header-text">${escapeHtml(section.label)}</div>`;
                        paperContent.appendChild(header);
                    }
                    // Render Questions
                    if (section.questions) {
                        section.questions.forEach(q => {
                            paperContent.appendChild(createQuestionNode(q, 0, defaults));
                        });
                    }
                });
            } else if (paper.questions) {
                paper.questions.forEach(q => {
                    paperContent.appendChild(createQuestionNode(q, 0, defaults));
                });
            }

            // Post-render: Typeset Math
            if (window.renderMathInElement) {
                renderMathInElement(paperContent, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false}
                    ],
                    throwOnError: false
                });
            }
        }

        function createQuestionNode(node, depth, defaults) {
            const wrapper = document.createElement('div');
            wrapper.className = 'question-node';
            wrapper.dataset.hasParent = depth > 0;
            wrapper.id = `q-${node.id}`; // For navigation anchors

            // 1. Question Body
            const bodyDiv = document.createElement('div');
            bodyDiv.className = 'question-body';
            
            const idSpan = document.createElement('div');
            idSpan.className = 'question-id';
            idSpan.textContent = node.id;
            
            const promptDiv = document.createElement('div');
            promptDiv.className = 'question-prompt';
            promptDiv.innerHTML = renderMarkdown(node.question);

            bodyDiv.appendChild(idSpan);
            bodyDiv.appendChild(promptDiv);
            wrapper.appendChild(bodyDiv);

            // 2. Solution Block (Optional)
            if (node.solutionBlock) {
                const solBlock = document.createElement('div');
                solBlock.className = 'solution-block';

                const { answer, solutionDetails } = node.solutionBlock;
                const hasDetails = !!solutionDetails;

                // Answer
                if (answer) {
                    const ansDiv = document.createElement('div');
                    ansDiv.className = 'answer-region';
                    ansDiv.innerHTML = `<span class="answer-label">Answer</span> <div class="answer-content">${renderMarkdown(answer)}</div>`;
                    solBlock.appendChild(ansDiv);
                }

                // Solution Details Control & Region
                if (hasDetails) {
                    // Control
                    const toggleBtn = document.createElement('button');
                    toggleBtn.className = 'disclosure-control';
                    toggleBtn.setAttribute('aria-expanded', defaults.expandedAll ? 'true' : 'false');
                    
                    const labelSpan = document.createElement('span');
                    labelSpan.className = 'label-text';
                    labelSpan.textContent = defaults.expandedAll ? 'Hide working' : 'Show working';
                    
                    const chevron = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                    chevron.setAttribute("class", "chevron");
                    chevron.setAttribute("viewBox", "0 0 24 24");
                    chevron.innerHTML = `<path d="M7 10l5 5 5-5z" />`;

                    toggleBtn.appendChild(labelSpan);
                    toggleBtn.appendChild(chevron);

                    // Region
                    const detailsRegion = document.createElement('div');
                    detailsRegion.className = 'solution-details-region';
                    detailsRegion.dataset.expanded = defaults.expandedAll ? 'true' : 'false';

                    // Interaction
                    toggleBtn.onclick = () => {
                        const isExpanded = detailsRegion.dataset.expanded === 'true';
                        detailsRegion.dataset.expanded = !isExpanded;
                        toggleBtn.setAttribute('aria-expanded', !isExpanded);
                        labelSpan.textContent = !isExpanded ? 'Hide working' : 'Show working';
                    };

                    // Populate Details Subsections
                    // Order: Keep in mind, Formulas used, Working, Alternative working
                    
                    if (solutionDetails.keepInMind) {
                        detailsRegion.appendChild(createSdSubsection('Keep in mind', solutionDetails.keepInMind, 'sd-keep-in-mind'));
                    }
                    if (solutionDetails.formulasUsed) {
                        detailsRegion.appendChild(createSdSubsection('Formulas used', solutionDetails.formulasUsed, 'sd-formulas'));
                    }
                    if (solutionDetails.working) {
                        detailsRegion.appendChild(createSdSubsection('Working', solutionDetails.working, 'sd-working'));
                    }
                    if (solutionDetails.alternativeWorking && Array.isArray(solutionDetails.alternativeWorking)) {
                        solutionDetails.alternativeWorking.forEach(alt => {
                            detailsRegion.appendChild(createSdSubsection('Alternative working', alt, 'sd-alt-working'));
                        });
                    } else if (solutionDetails.alternativeWorking) {
                        // Handle string case if schema varies, though brief says array
                        detailsRegion.appendChild(createSdSubsection('Alternative working', solutionDetails.alternativeWorking, 'sd-alt-working'));
                    }

                    solBlock.appendChild(toggleBtn);
                    solBlock.appendChild(detailsRegion);
                }

                wrapper.appendChild(solBlock);
            }

            // 3. Children (Recursion)
            if (node.children && node.children.length > 0) {
                const childContainer = document.createElement('div');
                childContainer.className = 'children-container';
                node.children.forEach(child => {
                    childContainer.appendChild(createQuestionNode(child, depth + 1, defaults));
                });
                wrapper.appendChild(childContainer);
            }

            return wrapper;
        }

        function createSdSubsection(label, markdownContent, extraClass) {
            const div = document.createElement('div');
            div.className = `sd-subsection ${extraClass || ''}`;
            div.innerHTML = `<span class="sd-label">${label}</span><div class="sd-body">${renderMarkdown(markdownContent)}</div>`;
            return div;
        }

        function renderMarkdown(text) {
            if (!text) return '';
            if (md) return md.render(text);
            // Fallback if MD fails or not loaded
            return `<p>${escapeHtml(text)}</p>`;
        }

        function escapeHtml(unsafe) {
            return unsafe
                 .replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
        }

        // --- Navigation Logic ---

        function generateNavStructure(paper) {
            const items = [];
            
            function processNode(node, depth) {
                items.push({ type: 'item', id: node.id, depth: depth });
                if (node.children) {
                    node.children.forEach(c => processNode(c, depth + 1));
                }
            }

            if (paper.sections && paper.sections.length > 0) {
                paper.sections.forEach(sec => {
                    if (sec.label && sec.label.trim() !== '') {
                        items.push({ type: 'section', label: sec.label });
                    }
                    if (sec.questions) {
                        sec.questions.forEach(q => processNode(q, 0));
                    }
                });
            } else if (paper.questions) {
                paper.questions.forEach(q => processNode(q, 0));
            }
            return items;
        }

        function renderNav(container, items) {
            container.innerHTML = '';
            items.forEach(item => {
                const li = document.createElement('li');
                
                if (item.type === 'section') {
                    li.className = 'nav-section-label';
                    li.textContent = item.label;
                } else {
                    const btn = document.createElement('button');
                    btn.className = 'nav-item';
                    btn.textContent = item.id;
                    btn.dataset.depth = Math.min(item.depth, 2); // Cap visual depth attributes
                    btn.onclick = () => {
                        scrollToQuestion(item.id);
                        closeDrawer();
                    };
                    li.appendChild(btn);
                }
                container.appendChild(li);
            });
        }

        function scrollToQuestion(id) {
            const el = document.getElementById(`q-${id}`);
            if (el) {
                // Scroll with offset for sticky header
                const offset = 80;
                const top = el.getBoundingClientRect().top + window.scrollY - offset;
                window.scrollTo({ top, behavior: 'smooth' });
                updateActiveNav(id);
            }
        }

        function updateActiveNav(activeId) {
            [desktopNavList, mobileNavList].forEach(list => {
                const prev = list.querySelector('.active');
                if (prev) prev.classList.remove('active');
                
                // Find button by text content (id)
                const buttons = Array.from(list.querySelectorAll('.nav-item'));
                const match = buttons.find(b => b.textContent === activeId);
                if (match) match.classList.add('active');
            });
        }

        // --- Intersection Observer for Scroll Spy ---
        const observer = new IntersectionObserver((entries) => {
            // Find the visible entry closest to top
            // This is basic; for robust spy we might want to check all visible.
            // Simplified: check intersecting
            const visible = entries.filter(e => e.isIntersecting);
            if (visible.length > 0) {
                // Pick the first one
                const id = visible[0].target.id.replace('q-', '');
                updateActiveNav(id);
            }
        }, { rootMargin: '-10% 0px -80% 0px' }); // Trigger when near top

        // Observer needs to re-attach when content changes
        const observerConfig = { childList: true, subtree: true };
        const contentObserver = new MutationObserver(() => {
            observer.disconnect();
            const nodes = document.querySelectorAll('.question-node');
            nodes.forEach(n => observer.observe(n));
        });
        contentObserver.observe(paperContent, observerConfig);


        // --- Mobile Drawer Logic ---
        function openDrawer() {
            document.body.classList.add('drawer-open');
            mobileDrawer.setAttribute('aria-hidden', 'false');
            drawerOverlay.setAttribute('aria-hidden', 'false');
            // trap focus logic omitted for brevity in prototype, but required for production
        }

        function closeDrawer() {
            document.body.classList.remove('drawer-open');
            mobileDrawer.setAttribute('aria-hidden', 'true');
            drawerOverlay.setAttribute('aria-hidden', 'true');
        }

        mobileJumpBtn.onclick = openDrawer;
        drawerCloseBtn.onclick = closeDrawer;
        drawerOverlay.onclick = closeDrawer;

        // Run Init
        init();

    </script>
</body>
</html>
