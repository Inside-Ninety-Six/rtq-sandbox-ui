<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"ABC","indexWithinVariant":"16","totalWithinVariant":"320","hueFamily":"red","intensityMode":"deep_theme","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-09T10:42:28.963Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;ABC&quot;,&quot;indexWithinVariant&quot;:&quot;16&quot;,&quot;totalWithinVariant&quot;:&quot;320&quot;,&quot;hueFamily&quot;:&quot;red&quot;,&quot;intensityMode&quot;:&quot;deep_theme&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-09T10:42:28.963Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>

    <!-- Tailwind CSS (via CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- KaTeX CSS (No Integrity/SRI per requirements) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <!-- KaTeX JS (No Integrity/SRI) -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Markdown-it (No Integrity/SRI) -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* 
         * STAGE 6 ADD-ON: COLORLAB C - DEEP THEME (Red Hue Force)
         * Hue Family: Red (approx hue 29 in OKLCH)
         * Intensity Mode: deep_theme
         * Light Mode Only.
         */
        :root {
            /* Palette Definition (OKLCH) */
            
            /* Page Background: L[0.92-0.98], C[0.08-0.16] */
            --color-page-bg: oklch(0.96 0.09 29);
            
            /* Frame Base Surface: L[0.90-0.96], C[0.08-0.16] */
            --color-frame-bg: oklch(0.93 0.11 29);
            
            /* Paper Surface: L[0.94-0.99], C[0.06-0.14] */
            --color-paper-bg: oklch(0.98 0.07 29);
            
            /* Text Primary: L[0.15-0.25], C<=0.015 */
            --color-text-primary: oklch(0.25 0.015 29);
            
            /* Text Secondary: L[0.25-0.40], C<=0.020 */
            --color-text-secondary: oklch(0.40 0.02 29);
            
            /* Accent (Link/Focus/Controls): L[0.45-0.65], C[0.16-0.26] */
            --color-accent: oklch(0.55 0.22 29);
            
            /* Solution Details Wash: C[0.05-0.10] */
            --color-solution-wash: oklch(0.96 0.06 29);
            
            /* Dividers: C<=0.02 */
            --color-divider: oklch(0.85 0.02 29);
            
            /* Keep In Mind / Formulas surface (derived from band) */
            --color-surface-sub: oklch(0.95 0.07 29);

            /* Focus Ring */
            --color-focus: var(--color-accent);
        }

        body {
            background-color: var(--color-page-bg);
            color: var(--color-text-primary);
            font-family: ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            -webkit-font-smoothing: antialiased;
            overflow-y: scroll; /* Force vertical scrollbar to prevent layout shifts */
        }

        /* Utility: Hide Scrollbar but keep functionality */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* KaTeX Overflow Handling - Containment Invariant */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 4px; /* Space for scrollbar if needed */
        }
        
        /* Markdown Content Styling */
        .md-content p {
            margin-bottom: 0.75em;
            line-height: 1.6;
        }
        .md-content p:last-child {
            margin-bottom: 0;
        }
        .md-content ul {
            list-style-type: disc;
            padding-left: 1.5em;
            margin-bottom: 0.75em;
        }
        .md-content ol {
            list-style-type: decimal;
            padding-left: 1.5em;
            margin-bottom: 0.75em;
        }
        /* Tables */
        .md-content table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1em;
            font-size: 0.95em;
        }
        .md-content th, .md-content td {
            border: 1px solid var(--color-divider);
            padding: 0.5em 0.75em;
            text-align: left;
        }
        .md-content th {
            font-weight: 600;
            color: var(--color-text-primary);
        }

        /* Focus Styles */
        :focus-visible {
            outline: 2px solid var(--color-focus);
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* Drawer Transition */
        .drawer-enter {
            transform: translateX(-100%);
        }
        .drawer-enter-active {
            transform: translateX(0);
            transition: transform 0.3s ease-out;
        }
        .drawer-exit {
            transform: translateX(0);
        }
        .drawer-exit-active {
            transform: translateX(-100%);
            transition: transform 0.2s ease-in;
        }
        
        /* Nav Sticky Adjustment */
        .nav-sticky-col {
            position: sticky;
            top: 1rem;
            max-height: calc(100vh - 2rem);
            overflow-y: auto;
        }

        /* Smooth Scroll */
        html {
            scroll-behavior: smooth;
        }
        @media (prefers-reduced-motion: reduce) {
            html {
                scroll-behavior: auto;
            }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center">

    <!-- 
      STAGE 3 STRUCTURE: 
      Viewport -> Top Controls -> DocumentFrameShell -> (Nav Col + Paper Col)
    -->

    <!-- Top Controls Region -->
    <div id="top-controls" class="w-full max-w-[1200px] px-4 md:px-8 py-4 flex items-center justify-between shrink-0 z-10">
        <!-- Paper Selector -->
        <div class="flex items-center gap-3">
            <label for="paper-select" class="text-sm font-medium text-[var(--color-text-secondary)]">Paper:</label>
            <select id="paper-select" class="bg-[var(--color-frame-bg)] border border-[var(--color-divider)] text-[var(--color-text-primary)] text-sm rounded px-3 py-1.5 focus:border-[var(--color-accent)] focus:ring-1 focus:ring-[var(--color-accent)] outline-none cursor-pointer">
                <option>Loading...</option>
            </select>
        </div>

        <!-- Mobile Jump Trigger (Visible on small screens) -->
        <button id="mobile-jump-trigger" class="md:hidden flex items-center gap-2 text-[var(--color-accent)] font-medium text-sm px-3 py-1.5 rounded hover:bg-[var(--color-solution-wash)] transition-colors" aria-label="Open navigation">
            <span>Jump to</span>
            <i data-lucide="menu" class="w-4 h-4"></i>
        </button>
    </div>

    <!-- DocumentFrameShell -->
    <div id="doc-shell" class="w-full max-w-[1200px] flex-1 flex flex-col md:flex-row px-0 md:px-8 pb-12 gap-0 md:gap-8 bg-[var(--color-frame-bg)] md:bg-transparent">
        
        <!-- Desktop Navigation Column (Left) -->
        <nav id="nav-col" class="hidden md:block w-48 shrink-0 nav-sticky-col no-scrollbar pr-4">
            <div id="desktop-nav-list" class="flex flex-col gap-1">
                <!-- Nav items generated here -->
            </div>
        </nav>

        <!-- Paper Document Column (Right/Main) -->
        <main id="paper-column" class="flex-1 min-w-0 bg-[var(--color-paper-bg)] md:rounded-sm shadow-sm md:shadow-none p-4 md:p-12 min-h-[80vh]">
            <div id="paper-content" class="flex flex-col gap-10">
                <!-- Questions generated here -->
                <div class="text-center py-20 text-[var(--color-text-secondary)]">
                    Loading paper content...
                </div>
            </div>
        </main>
    </div>

    <!-- Mobile Navigation Drawer -->
    <div id="mobile-drawer-overlay" class="fixed inset-0 bg-black/20 z-40 hidden" aria-hidden="true"></div>
    <div id="mobile-drawer" class="fixed inset-y-0 left-0 w-64 bg-[var(--color-paper-bg)] z-50 transform -translate-x-full transition-transform duration-300 shadow-xl flex flex-col" aria-modal="true" role="dialog">
        <div class="p-4 border-b border-[var(--color-divider)] flex justify-between items-center">
            <h2 class="font-bold text-[var(--color-text-primary)]">Jump to</h2>
            <button id="close-drawer" class="p-2 text-[var(--color-text-secondary)] hover:text-[var(--color-text-primary)]">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>
        <div id="mobile-nav-list" class="flex-1 overflow-y-auto p-4 flex flex-col gap-1">
            <!-- Mobile nav items generated here -->
        </div>
    </div>

    <script>
        /**
         * STAGE 0: CONSTANTS (Canonical)
         */
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // Global State
        let state = {
            papers: [],
            activePaper: null,
            expandedWorkings: {}, // Map of questionId -> boolean
            mobileNavOpen: false
        };

        // --- Markdown Renderer Configuration (Authoritative Stage 6) ---
        const md = window.markdownit ? window.markdownit({
            html: true,    // Allow inline SVG
            linkify: true,
            breaks: false  // MUST be false to prevent <br> in math
        }) : null;

        if (md) {
            // Disable inline escape to preserve TeX backslashes
            md.inline.ruler.disable(['escape']);
        }

        // --- Initialization ---

        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Payload not found");
                const payload = await response.json();
                
                state.papers = payload.papers || [];
                
                if (state.papers.length === 0) {
                    renderError("NO PAPERS FOUND IN PAYLOAD");
                    return;
                }

                // Render Paper Selector
                renderPaperSelector();

                // Select first paper by default
                switchPaper(state.papers[0].key);

                // Event Listeners
                setupEventListeners();
                
            } catch (error) {
                console.error(error);
                renderError("PAPERS PAYLOAD MISSING");
            }
        }

        function renderError(msg) {
            const content = document.getElementById('paper-content');
            content.innerHTML = `<div class="p-12 text-center text-[var(--color-accent)] font-bold text-lg">${msg}</div>`;
            document.getElementById('paper-select').innerHTML = '<option>Error</option>';
            document.getElementById('paper-select').disabled = true;
        }

        function renderPaperSelector() {
            const select = document.getElementById('paper-select');
            select.innerHTML = state.papers.map(p => 
                `<option value="${p.key}">${p.label || p.key}</option>`
            ).join('');
            select.disabled = false;
        }

        function setupEventListeners() {
            // Paper Switch
            document.getElementById('paper-select').addEventListener('change', (e) => {
                switchPaper(e.target.value);
            });

            // Mobile Drawer
            const drawer = document.getElementById('mobile-drawer');
            const overlay = document.getElementById('mobile-drawer-overlay');
            const trigger = document.getElementById('mobile-jump-trigger');
            const close = document.getElementById('close-drawer');

            function toggleDrawer(show) {
                state.mobileNavOpen = show;
                if (show) {
                    overlay.classList.remove('hidden');
                    drawer.classList.remove('-translate-x-full');
                    drawer.classList.add('translate-x-0');
                    document.body.style.overflow = 'hidden'; // Lock scroll
                    close.focus();
                } else {
                    overlay.classList.add('hidden');
                    drawer.classList.remove('translate-x-0');
                    drawer.classList.add('-translate-x-full');
                    document.body.style.overflow = '';
                    trigger.focus();
                }
            }

            trigger.addEventListener('click', () => toggleDrawer(true));
            close.addEventListener('click', () => toggleDrawer(false));
            overlay.addEventListener('click', () => toggleDrawer(false));

            // Keyboard Escape to close drawer
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && state.mobileNavOpen) toggleDrawer(false);
            });
        }

        function switchPaper(key) {
            const paper = state.papers.find(p => p.key === key);
            if (!paper) return;

            state.activePaper = paper;
            
            // Reset expanded states based on defaults
            state.expandedWorkings = {};
            const defaultExpanded = paper.defaults?.expandedAll !== false; // Default true unless explicitly false

            // Flatten questions to set initial state if needed, though we handle "undefined" as defaultExpanded in render
            // But let's keep state clean.
            
            renderPaper();
        }

        // --- Rendering Logic ---

        function renderPaper() {
            const container = document.getElementById('paper-content');
            container.innerHTML = ''; // Clear

            // Determine if sectioned or flat
            const isSectioned = !!state.activePaper.sections;
            const contentSource = isSectioned ? state.activePaper.sections : state.activePaper.questions;

            if (!contentSource) {
                container.innerHTML = '<div class="text-center text-[var(--color-text-secondary)]">Empty paper</div>';
                return;
            }

            // Generate Nav Items & Paper Content
            let navHtml = '';
            let contentHtml = '';

            // Helper to process question list
            function processQuestionList(questions, parentId = null) {
                let html = '';
                questions.forEach((q, index) => {
                    const isTopLevel = !parentId;
                    html += renderQuestionNode(q, isTopLevel, 0);
                });
                return html;
            }

            // Helper to process nav
            // Returns array of { id, label, isHeader, depth }
            function buildNavData() {
                let items = [];
                
                if (isSectioned) {
                    state.activePaper.sections.forEach(sec => {
                        if (sec.label && sec.label.trim().length > 0) {
                            items.push({ type: 'section', label: sec.label });
                        }
                        processNavQuestions(sec.questions, items, 0);
                    });
                } else {
                    processNavQuestions(state.activePaper.questions, items, 0);
                }
                return items;
            }

            function processNavQuestions(questions, list, depth) {
                if (!questions) return;
                questions.forEach(q => {
                    list.push({ type: 'item', id: q.id, depth: depth });
                    if (q.children) {
                        processNavQuestions(q.children, list, depth + 1);
                    }
                });
            }

            // 1. Build Navigation
            const navItems = buildNavData();
            navHtml = navItems.map(item => {
                if (item.type === 'section') {
                    return `
                        <div class="mt-4 mb-2 text-xs font-bold text-[var(--color-text-secondary)] uppercase tracking-wider select-none px-2">
                            ${item.label}
                        </div>
                    `;
                } else {
                    // Stage 5.4.5: Hierarchy via type scale/quietness ONLY. No indentation.
                    // Depth 0: normal. Depth > 0: smaller/lighter.
                    const isSub = item.depth > 0;
                    const classes = isSub 
                        ? 'text-xs text-[var(--color-text-secondary)] font-normal' 
                        : 'text-sm text-[var(--color-text-primary)] font-medium';
                    
                    return `
                        <a href="#q-${item.id}" 
                           class="block py-1 px-2 rounded hover:text-[var(--color-accent)] focus:outline-none focus-visible:ring-2 focus-visible:ring-[var(--color-focus)] transition-colors ${classes}"
                           onclick="closeMobileNav()"
                        >
                            ${item.id}
                        </a>
                    `;
                }
            }).join('');

            document.getElementById('desktop-nav-list').innerHTML = navHtml;
            document.getElementById('mobile-nav-list').innerHTML = navHtml;

            // 2. Build Paper Content
            if (isSectioned) {
                state.activePaper.sections.forEach(section => {
                    contentHtml += `<section class="mb-12">`;
                    if (section.label && section.label.trim().length > 0) {
                        contentHtml += `
                            <div class="mb-6 pb-2 border-b border-[var(--color-divider)]">
                                <h2 class="text-xl font-bold text-[var(--color-text-primary)]">${section.label}</h2>
                            </div>
                        `;
                    }
                    contentHtml += processQuestionList(section.questions);
                    contentHtml += `</section>`;
                });
            } else {
                contentHtml += processQuestionList(state.activePaper.questions);
            }

            container.innerHTML = contentHtml;

            // 3. Render Math
            renderMath(container);

            // 4. Initialize Lucide icons
            lucide.createIcons();
        }

        function closeMobileNav() {
            if (state.mobileNavOpen) {
                document.getElementById('close-drawer').click();
            }
        }

        function renderQuestionNode(q, isTopLevel, depth) {
            // Unique ID for DOM
            const domId = `q-${q.id}`;
            const questionHtml = md ? md.render(q.question || '') : q.question;
            
            // Check Solution Block existence
            const hasSolutionBlock = !!q.solutionBlock;
            const hasAnswer = hasSolutionBlock && !!q.solutionBlock.answer;
            const hasDetails = hasSolutionBlock && !!q.solutionBlock.solutionDetails;

            // Expand state
            const defaultExpanded = state.activePaper.defaults?.expandedAll !== false;
            const isExpanded = state.expandedWorkings[q.id] !== undefined 
                ? state.expandedWorkings[q.id] 
                : defaultExpanded;

            // Separation classes based on depth (Stage 5.1 Rules)
            const nodeMargin = isTopLevel ? 'mb-12' : 'mb-6';
            
            let html = `
                <div id="${domId}" class="question-node scroll-mt-20 ${nodeMargin}">
                    <!-- Surface for question node (optional per Stage 3, keeping clean) -->
                    
                    <!-- Question Body -->
                    <div class="flex gap-4">
                        <div class="shrink-0 w-8 md:w-12 pt-1">
                            <span class="text-[var(--color-text-secondary)] font-bold text-sm md:text-base select-none">${q.id}</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="md-content text-[var(--color-text-primary)] text-base md:text-lg">
                                ${questionHtml}
                            </div>
                        </div>
                    </div>
            `;

            if (hasSolutionBlock) {
                html += `<div class="solution-block mt-4 pl-8 md:pl-12">`;

                // Answer
                if (hasAnswer) {
                    const answerMd = md ? md.render(q.solutionBlock.answer) : q.solutionBlock.answer;
                    html += `
                        <div class="answer-region mb-3">
                            <span class="text-xs font-bold text-[var(--color-accent)] uppercase tracking-wide block mb-1">Answer</span>
                            <div class="md-content text-[var(--color-text-primary)] font-medium">
                                ${answerMd}
                            </div>
                        </div>
                    `;
                }

                // Solution Details Control
                if (hasDetails) {
                    const btnLabel = isExpanded ? 'Hide working' : 'Show working';
                    const iconRot = isExpanded ? 'rotate-180' : '';
                    
                    html += `
                        <div class="details-control mb-2">
                            <button 
                                onclick="toggleWorking('${q.id}')"
                                class="text-sm font-medium text-[var(--color-accent)] hover:underline focus:outline-none focus-visible:ring-2 focus-visible:ring-[var(--color-focus)] flex items-center gap-1"
                                aria-expanded="${isExpanded}"
                            >
                                <span>${btnLabel}</span>
                                <i data-lucide="chevron-down" class="w-4 h-4 transition-transform duration-200 ${iconRot}"></i>
                            </button>
                        </div>
                    `;

                    // Solution Details Content
                    if (isExpanded) {
                        const sd = q.solutionBlock.solutionDetails;
                        html += `
                            <div class="solution-details-region bg-[var(--color-solution-wash)] p-4 rounded-sm mt-2 border-l-2 border-[var(--color-divider)] animate-in fade-in slide-in-from-top-1 duration-200">
                                
                                ${sd.keepInMind ? renderSubBlock('Keep in mind', sd.keepInMind, 'lightbulb') : ''}
                                ${sd.formulasUsed ? renderSubBlock('Formulas used', sd.formulasUsed) : ''}
                                ${sd.working ? renderSubBlock('Working', sd.working) : ''}
                                
                                ${sd.alternativeWorking && Array.isArray(sd.alternativeWorking) 
                                    ? sd.alternativeWorking.map(aw => renderSubBlock('Alternative working', aw)).join('')
                                    : ''}

                            </div>
                        `;
                    }
                }

                html += `</div>`; // End solution-block
            }

            // Children
            if (q.children && q.children.length > 0) {
                html += `
                    <div class="children-container mt-4 pl-4 md:pl-8 border-l border-transparent">
                        ${q.children.map(child => renderQuestionNode(child, false, depth + 1)).join('')}
                    </div>
                `;
            }

            html += `</div>`; // End question-node
            return html;
        }

        function renderSubBlock(label, contentRaw, iconName = null) {
            const contentMd = md ? md.render(contentRaw) : contentRaw;
            let iconHtml = '';
            if (iconName) {
                iconHtml = `<i data-lucide="${iconName}" class="w-4 h-4 text-[var(--color-text-secondary)] mr-2 inline-block align-text-bottom"></i>`;
            }

            // Determine specific styling based on sub-type (Stage 5.9)
            // Keep in Mind: slightly higher contrast body permitted.
            // Formulas: quieter.
            // Working: standard.
            
            let labelClass = "text-xs font-bold text-[var(--color-text-secondary)] uppercase tracking-wide mb-2 block";
            let bodyClass = "md-content text-[var(--color-text-secondary)] text-sm";
            let wrapperClass = "mb-6 last:mb-0";
            let surfaceClass = ""; // Optional inner surface

            if (label === 'Keep in mind') {
                bodyClass = "md-content text-[var(--color-text-primary)] text-sm"; // Slightly higher contrast
            } else if (label === 'Formulas used') {
                bodyClass = "md-content text-[var(--color-text-secondary)] text-sm italic";
            }

            return `
                <div class="${wrapperClass}">
                    <div class="${labelClass}">
                        ${iconHtml}${label}
                    </div>
                    <div class="${bodyClass}">
                        ${contentMd}
                    </div>
                </div>
            `;
        }

        function toggleWorking(id) {
            const defaultExpanded = state.activePaper.defaults?.expandedAll !== false;
            const current = state.expandedWorkings[id] !== undefined ? state.expandedWorkings[id] : defaultExpanded;
            
            state.expandedWorkings[id] = !current;
            
            // Re-render efficiently? For prototype, full re-render of paper column preserves scroll usually if ID matches.
            // To prevent scroll jumps, we grab scroll position.
            // Actually, simplest for vanilla prototype is re-render list.
            const scrollPos = window.scrollY;
            renderPaper(); // This is brute force but safest for "Show/Hide" logic correctness in vanilla JS
            window.scrollTo(0, scrollPos);
        }

        function renderMath(element) {
            if (window.renderMathInElement) {
                renderMathInElement(element, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false}
                    ],
                    throwOnError: false,
                    output: 'html', // Use HTML output for better accessibility/layout
                });
            }
        }

        // Start
        init();

    </script>
</body>
</html>
