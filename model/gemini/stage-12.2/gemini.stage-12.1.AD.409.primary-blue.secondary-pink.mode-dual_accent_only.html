<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AD","indexWithinVariant":"409","totalWithinVariant":"440","hueFamily":"","intensityMode":"","primaryHueFamily":"blue","secondaryHueFamily":"pink","dualIntensityMode":"dual_accent_only","timestamp":"2026-01-11T00:44:05.867Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AD&quot;,&quot;indexWithinVariant&quot;:&quot;409&quot;,&quot;totalWithinVariant&quot;:&quot;440&quot;,&quot;hueFamily&quot;:&quot;&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;primaryHueFamily&quot;:&quot;blue&quot;,&quot;secondaryHueFamily&quot;:&quot;pink&quot;,&quot;dualIntensityMode&quot;:&quot;dual_accent_only&quot;,&quot;timestamp&quot;:&quot;2026-01-11T00:44:05.867Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>
    
    <!-- KaTeX CSS (No integrity, per instructions) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <!-- Fonts: Inter for a clean, modern, neutral sans-serif -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <style>
        /* =========================================
           STAGE 0 & 6: COLORLAB D (Dual-Accent Only)
           Mode: dual_accent_only
           Primary Hue: Blue (approx 264)
           Secondary Hue: Amber (approx 85)
           Format: OKLCH
           ========================================= */
        :root {
            /* Hues */
            --hue-p: 264;
            --hue-s: 85;

            /* Surfaces (C <= 0.015) */
            --bg-page: oklch(0.985 0.005 var(--hue-p));
            --bg-paper: oklch(1.0 0 0); /* Pure white for paper surface */
            --bg-nav-drawer: oklch(1.0 0 0);
            --bg-wash-solution: oklch(0.98 0.008 var(--hue-p)); /* Very subtle wash */

            /* Typography (C <= 0.010 for legibility) */
            --txt-primary: oklch(0.20 0.01 var(--hue-p));
            --txt-secondary: oklch(0.45 0.01 var(--hue-p));
            --txt-tertiary: oklch(0.60 0.01 var(--hue-p));
            --txt-nav: oklch(0.40 0.01 var(--hue-p));

            /* Accents */
            /* Primary (C 0.08..0.14) - Links, focus, disclosure text */
            --accent-primary: oklch(0.50 0.14 var(--hue-p));
            
            /* Secondary (C 0.06..0.12) - Supplementary (Nav active marker) */
            --accent-secondary: oklch(0.70 0.12 var(--hue-s));

            /* Borders / Dividers */
            --border-hairline: oklch(0.92 0.005 var(--hue-p));
            --border-focus: var(--accent-primary);

            /* Spacing Units */
            --sp-xs: 4px;
            --sp-sm: 8px;
            --sp-md: 16px;
            --sp-lg: 24px;
            --sp-xl: 32px;
            --sp-xxl: 48px; /* Largest unit for top-level questions */

            /* Layout */
            --nav-width: 240px;
            --max-paper-width: 800px;
        }

        /* =========================================
           RESET & BASE
           ========================================= */
        * { box-sizing: border-box; }
        body {
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-page);
            color: var(--txt-primary);
            -webkit-font-smoothing: antialiased;
            line-height: 1.5;
        }

        button {
            font-family: inherit;
            border: none;
            background: none;
            cursor: pointer;
            padding: 0;
            margin: 0;
        }

        a { color: var(--accent-primary); text-decoration: none; }
        a:hover { text-decoration: underline; }

        /* Focus Management */
        :focus-visible {
            outline: 2px solid var(--accent-primary);
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* =========================================
           LAYOUT SHELL (DocumentFrameShell)
           ========================================= */
        .shell {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            max-width: 1200px; /* Constrain total width on very large screens */
            margin: 0 auto;
        }

        /* Top Controls */
        .top-controls {
            padding: var(--sp-md) var(--sp-lg);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 20;
            background-color: var(--bg-page); /* Match page bg for calm feel */
            border-bottom: 1px solid transparent; /* Optional seam */
        }

        .paper-selector {
            font-size: 0.95rem;
            padding: var(--sp-sm);
            border: 1px solid var(--border-hairline);
            border-radius: 4px;
            background: var(--bg-paper);
            color: var(--txt-primary);
        }

        .jump-to-trigger {
            display: none; /* Desktop hidden */
            font-size: 0.9rem;
            color: var(--accent-primary);
            font-weight: 500;
        }

        /* Main Content Grid */
        .main-frame {
            display: flex;
            flex: 1;
            position: relative;
        }

        /* Navigation Rail (Desktop) */
        .nav-rail {
            width: var(--nav-width);
            flex-shrink: 0;
            padding: var(--sp-lg) 0 var(--sp-lg) var(--sp-lg);
            position: sticky;
            top: 60px; /* Offset for top controls if needed, or 0 */
            height: calc(100vh - 60px);
            overflow-y: auto;
            scrollbar-width: none; /* Hide scrollbar Firefox */
            display: none; /* Hidden on mobile by default */
        }
        .nav-rail::-webkit-scrollbar { display: none; } /* Hide scrollbar Webkit */

        /* Paper Region */
        .paper-column {
            flex: 1;
            padding: var(--sp-lg);
            max-width: var(--max-paper-width);
            /* Center the paper content relative to remaining space on desktop? 
               Design brief says: "Paper content column must visually dominate... 
               not centered as if standalone while nav exists."
               We keep it left-aligned to the nav, but max-width constrained.
            */
        }

        /* =========================================
           NAVIGATION STYLES
           ========================================= */
        .nav-list {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .nav-section-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--txt-tertiary);
            margin-top: var(--sp-md);
            margin-bottom: var(--sp-xs);
            padding-left: var(--sp-sm);
            font-weight: 600;
        }

        .nav-item {
            display: block;
            padding: var(--sp-xs) var(--sp-sm);
            font-size: 0.9rem;
            color: var(--txt-nav);
            border-left: 2px solid transparent;
            text-align: left;
            transition: color 0.1s ease;
        }

        .nav-item:hover {
            color: var(--accent-primary);
            background-color: rgba(0,0,0,0.02); /* Very subtle hover */
        }

        .nav-item.active {
            color: var(--txt-primary);
            font-weight: 600;
            border-left-color: var(--accent-secondary); /* Dual accent usage: Nav Marker */
        }

        /* Hierarchy via type scale only - applied dynamically via classes if needed, 
           or logic. Brief says "Hierarchy via type scale only".
           We will apply .nav-depth-1 classes.
        */
        .nav-item.depth-0 { font-size: 0.9rem; }
        .nav-item.depth-1 { font-size: 0.85rem; color: var(--txt-secondary); }
        .nav-item.depth-2 { font-size: 0.8rem; color: var(--txt-secondary); }

        /* =========================================
           PAPER CONTENT STYLES
           ========================================= */
        .paper-surface {
            background-color: var(--bg-paper);
            padding: 0; /* Let content breathe via margins or internal padding? 
                           Brief: "Paper as single linear document". 
                           We'll apply padding to the container or nodes. 
                           Let's put the white surface on the paper column or nodes?
                           "Surface differentiation... quiet". 
                           Let's keep paper surface simple. */
            min-height: 80vh;
        }

        .section-header {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--txt-primary);
            margin-top: var(--sp-xxl);
            margin-bottom: var(--sp-lg);
            padding-bottom: var(--sp-sm);
            border-bottom: 1px solid var(--border-hairline);
        }
        
        .section-header:first-child { margin-top: 0; }

        /* Question Nodes */
        .question-node {
            margin-bottom: var(--sp-xxl); /* Top level spacing */
        }

        .question-node.child-node {
            margin-bottom: var(--sp-md);
            margin-top: var(--sp-md);
            padding-left: var(--sp-md); /* Indentation */
            border-left: 1px solid transparent; /* Placeholder for potential guide */
        }

        /* Question Body */
        .question-body {
            display: flex;
            gap: var(--sp-sm);
            margin-bottom: var(--sp-md);
        }

        .question-id {
            font-weight: 600;
            color: var(--txt-secondary);
            min-width: 2em;
            flex-shrink: 0;
        }

        .question-prompt {
            color: var(--txt-primary);
            flex: 1;
        }

        /* Solution Block */
        .solution-block {
            margin-left: 2.5em; /* Align with prompt text approximately */
            display: flex;
            flex-direction: column;
            gap: var(--sp-md);
        }

        /* Answer */
        .answer-region {
            /* Visually subordinate to question */
        }
        .answer-label {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--txt-tertiary);
            text-transform: uppercase;
            margin-bottom: var(--sp-xs);
            display: block;
        }
        .answer-content {
            font-weight: 500;
            color: var(--txt-primary);
        }

        /* Solution Details Toggle */
        .disclosure-control {
            align-self: flex-start;
            font-size: 0.9rem;
            color: var(--accent-primary);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: var(--sp-xs);
            margin-top: var(--sp-xs);
        }
        .disclosure-icon {
            transition: transform 0.2s ease;
        }
        .disclosure-control[aria-expanded="true"] .disclosure-icon {
            transform: rotate(180deg);
        }

        /* Solution Details Region */
        .solution-details {
            background-color: var(--bg-wash-solution); /* Allowed surface wash */
            padding: var(--sp-md);
            border-radius: 4px; /* Slight radius, strictly quiet */
            display: none; /* Toggled via JS */
            flex-direction: column;
            gap: var(--sp-lg);
            margin-top: var(--sp-xs);
            border: 1px solid transparent; /* Prevents visual merging */
        }
        .solution-details.expanded {
            display: flex;
        }

        /* Internal grammar of solution details */
        .sd-section {
            display: flex;
            flex-direction: column;
            gap: var(--sp-xs);
        }
        .sd-label {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--txt-secondary);
            margin-bottom: var(--sp-xs);
        }
        
        .sd-body {
            font-size: 0.95rem;
            color: var(--txt-secondary); /* Subordinate text */
        }

        /* Keep in mind specifics */
        .sd-section.keep-in-mind .sd-label {
            color: var(--txt-primary); /* Slightly more prominent per Stage 5.9.2 */
        }
        .sd-section.keep-in-mind .sd-body {
            color: var(--txt-primary);
        }

        /* Alternative working separator */
        .alt-working-separator {
            height: 1px;
            background-color: var(--border-hairline);
            margin: var(--sp-sm) 0;
        }

        /* =========================================
           MOBILE DRAWER
           ========================================= */
        .drawer-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.2);
            z-index: 100;
            display: none;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .drawer-overlay.open {
            display: block;
            opacity: 1;
        }

        .drawer {
            position: fixed;
            top: 0; bottom: 0; left: 0;
            width: 85%;
            max-width: 320px;
            background: var(--bg-nav-drawer);
            z-index: 101;
            transform: translateX(-100%);
            transition: transform 0.2s ease-out;
            box-shadow: 2px 0 8px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
        }
        .drawer.open {
            transform: translateX(0);
        }

        .drawer-header {
            padding: var(--sp-md);
            border-bottom: 1px solid var(--border-hairline);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .drawer-title { font-weight: 600; }
        .drawer-close { font-size: 1.5rem; color: var(--txt-secondary); padding: var(--sp-sm); }
        .drawer-content { overflow-y: auto; padding: var(--sp-md); }

        /* =========================================
           MARKDOWN & KATEX UTILS
           ========================================= */
        /* Table styles per Stage 5.8.5 */
        .md-content table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            margin: var(--sp-sm) 0;
        }
        .md-content th, .md-content td {
            border: 1px solid var(--border-hairline);
            padding: var(--sp-sm);
            text-align: left;
        }
        .md-content th {
            font-weight: 600;
            color: var(--txt-primary);
        }
        
        /* KaTeX Overflow Protection (Invariant) */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding-bottom: 4px; /* Scrollbar space */
            -webkit-overflow-scrolling: touch;
        }
        .katex { font-size: 1.1em; } /* Adjustment for readability */
        
        /* Diagrams (Inline SVG) */
        .md-content svg {
            max-width: 100%;
            height: auto;
            display: block;
            margin: var(--sp-sm) 0;
        }

        /* Markdown Paragraphs */
        .md-content p {
            margin-top: 0;
            margin-bottom: var(--sp-sm);
        }
        .md-content p:last-child { margin-bottom: 0; }
        
        /* Lists */
        .md-content ul, .md-content ol {
            margin-top: 0;
            margin-bottom: var(--sp-sm);
            padding-left: 1.5em;
        }

        /* Error Message */
        .error-message {
            padding: var(--sp-xxl);
            text-align: center;
            color: var(--txt-secondary);
            font-weight: 600;
            border: 1px dashed var(--border-hairline);
            margin: var(--sp-xxl);
        }

        /* =========================================
           RESPONSIVE
           ========================================= */
        @media (min-width: 768px) {
            .nav-rail { display: block; }
            .jump-to-trigger { display: none; }
            .shell { flex-direction: row; }
            .top-controls { display: none; } /* On desktop, maybe move selector to Nav or keep top? 
               Brief: "Top controls region (aligned to frame)... Desktop: nav + paper share base surface"
               Usually Paper Selector is in Top Controls. 
               Let's keep Top Controls visible on Desktop but aligned. */
            .top-controls { display: flex; position: sticky; top: 0; width: 100%; border-bottom: 1px solid var(--border-hairline); z-index: 50; }
            
            /* Align top controls content with shell gutters */
            .top-controls-inner {
                width: 100%; max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between;
                padding-left: var(--sp-lg); padding-right: var(--sp-lg);
            }
            .shell { padding-top: 0; } /* Top controls are outside shell or inside? Brief says "Top controls region... aligned to frame". */
        }

        @media (max-width: 767px) {
            .shell { display: block; }
            .top-controls { display: flex; }
            .top-controls-inner { width: 100%; display: flex; justify-content: space-between; }
            .jump-to-trigger { display: block; }
            .nav-rail { display: none; } /* Use drawer */
            .paper-column { padding: var(--sp-md); }
            .question-node { margin-bottom: var(--sp-xl); }
            .solution-block { margin-left: 0; border-left: 2px solid var(--border-hairline); padding-left: var(--sp-md); }
        }

    </style>
</head>
<body>

    <!-- Top Controls -->
    <div class="top-controls">
        <div class="top-controls-inner">
            <select id="paper-selector" class="paper-selector" aria-label="Select Paper">
                <option value="" disabled selected>Loading papers...</option>
            </select>
            <button id="jump-to-btn" class="jump-to-trigger">Jump to</button>
        </div>
    </div>

    <div class="shell">
        <!-- Desktop Nav Rail -->
        <nav class="nav-rail" aria-label="Paper Navigation">
            <div id="desktop-nav-list" class="nav-list">
                <!-- Injected via JS -->
            </div>
        </nav>

        <!-- Paper Content -->
        <main class="paper-column">
            <div id="paper-content" class="paper-surface">
                <!-- Injected via JS -->
                <div class="error-message" style="display:none;" id="loading-error">PAPERS PAYLOAD MISSING</div>
            </div>
        </main>
    </div>

    <!-- Mobile Drawer -->
    <div id="drawer-overlay" class="drawer-overlay"></div>
    <div id="drawer" class="drawer" aria-hidden="true">
        <div class="drawer-header">
            <span class="drawer-title">Jump to</span>
            <button id="drawer-close" class="drawer-close" aria-label="Close navigation">&times;</button>
        </div>
        <div id="drawer-nav-list" class="drawer-content nav-list">
            <!-- Injected via JS -->
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <script>
        // =========================================
        // STAGE 0: CONSTANTS (Canonical)
        // =========================================
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // =========================================
        // STATE & CONFIG
        // =========================================
        let globalPapers = [];
        let currentPaper = null;
        
        // Markdown-it Config (Authoritative)
        const md = window.markdownit ? window.markdownit({
            html: true,     // Allow inline SVG
            linkify: true,
            breaks: false   // Critical: prevents <br> in math blocks
        }) : null;

        if (md) {
            // Disable escape rule to preserve TeX backslashes
            md.inline.ruler.disable(['escape']);
        }

        // =========================================
        // INITIALIZATION
        // =========================================
        document.addEventListener('DOMContentLoaded', async () => {
            initInteraction();
            await loadPayload();
        });

        async function loadPayload() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Payload missing");
                
                const data = await response.json();
                if (!data.papers || !Array.isArray(data.papers)) throw new Error("Invalid schema");
                
                globalPapers = data.papers;
                populateSelector();
                
                // Load first paper by default
                if (globalPapers.length > 0) {
                    loadPaper(globalPapers[0].key);
                }
            } catch (err) {
                console.error(err);
                document.getElementById('loading-error').style.display = 'block';
                document.getElementById('paper-selector').innerHTML = '<option>Error loading payload</option>';
            }
        }

        function populateSelector() {
            const select = document.getElementById('paper-selector');
            select.innerHTML = '';
            globalPapers.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.key;
                opt.textContent = p.label;
                select.appendChild(opt);
            });
            select.addEventListener('change', (e) => {
                loadPaper(e.target.value);
            });
        }

        function loadPaper(paperKey) {
            currentPaper = globalPapers.find(p => p.key === paperKey);
            if (!currentPaper) return;

            renderPaperContent(currentPaper);
            renderNavigation(currentPaper);
            
            // Scroll to top
            window.scrollTo(0, 0);
        }

        // =========================================
        // RENDERING LOGIC
        // =========================================
        function renderPaperContent(paper) {
            const container = document.getElementById('paper-content');
            container.innerHTML = '';

            // Handle Sections vs Flat
            if (paper.sections) {
                paper.sections.forEach(section => {
                    // Optional Section Header
                    if (section.label && section.label.trim().length > 0) {
                        const header = document.createElement('div');
                        header.className = 'section-header';
                        header.textContent = section.label;
                        container.appendChild(header);
                    }
                    // Render Questions
                    renderQuestionList(section.questions, container, 0, paper.defaults);
                });
            } else if (paper.questions) {
                renderQuestionList(paper.questions, container, 0, paper.defaults);
            }

            // Trigger KaTeX
            if (window.renderMathInElement) {
                renderMathInElement(container, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false},
                        {left: '\\(', right: '\\)', display: false},
                        {left: '\\[', right: '\\]', display: true}
                    ],
                    throwOnError: false
                });
            }
        }

        function renderQuestionList(questions, container, depth, defaults) {
            if (!questions) return;
            questions.forEach(q => {
                const node = createQuestionNode(q, depth, defaults);
                container.appendChild(node);
            });
        }

        function createQuestionNode(q, depth, defaults) {
            const node = document.createElement('div');
            node.className = `question-node ${depth > 0 ? 'child-node' : ''}`;
            node.id = `q-${q.id}`; // Anchor for nav

            // 1. Question Body
            const body = document.createElement('div');
            body.className = 'question-body';
            
            const idEl = document.createElement('div');
            idEl.className = 'question-id';
            idEl.textContent = q.id;
            
            const promptEl = document.createElement('div');
            promptEl.className = 'question-prompt md-content';
            promptEl.innerHTML = md ? md.render(q.question || '') : (q.question || '');

            body.appendChild(idEl);
            body.appendChild(promptEl);
            node.appendChild(body);

            // 2. Solution Block (Optional)
            if (q.solutionBlock) {
                const block = document.createElement('div');
                block.className = 'solution-block';

                // Answer (Optional, Visible by default)
                if (q.solutionBlock.answer) {
                    const ansRegion = document.createElement('div');
                    ansRegion.className = 'answer-region';
                    
                    const label = document.createElement('span');
                    label.className = 'answer-label';
                    label.textContent = 'Answer';
                    
                    const content = document.createElement('div');
                    content.className = 'answer-content md-content';
                    content.innerHTML = md ? md.render(q.solutionBlock.answer) : q.solutionBlock.answer;
                    
                    ansRegion.appendChild(label);
                    ansRegion.appendChild(content);
                    block.appendChild(ansRegion);
                }

                // Solution Details (Optional, Expandable)
                if (q.solutionBlock.solutionDetails) {
                    const sdData = q.solutionBlock.solutionDetails;
                    const isExpanded = defaults && defaults.expandedAll !== false;

                    // Toggle
                    const toggle = document.createElement('button');
                    toggle.className = 'disclosure-control';
                    toggle.setAttribute('aria-expanded', isExpanded);
                    toggle.innerHTML = `
                        <span class="disclosure-text">${isExpanded ? 'Hide working' : 'Show working'}</span>
                        <svg class="disclosure-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                    `;
                    
                    // Details Container
                    const details = document.createElement('div');
                    details.className = `solution-details ${isExpanded ? 'expanded' : ''}`;

                    // Content Order: Keep in mind -> Formulas -> Working -> Alt
                    if (sdData.keepInMind) details.appendChild(createSDSection('Keep in mind', sdData.keepInMind, 'keep-in-mind'));
                    if (sdData.formulasUsed) details.appendChild(createSDSection('Formulas used', sdData.formulasUsed, 'formulas'));
                    if (sdData.working) details.appendChild(createSDSection('Working', sdData.working, 'working'));
                    
                    if (sdData.alternativeWorking && Array.isArray(sdData.alternativeWorking)) {
                        sdData.alternativeWorking.forEach(alt => {
                            const sep = document.createElement('div');
                            sep.className = 'alt-working-separator';
                            details.appendChild(sep);
                            details.appendChild(createSDSection('Alternative working', alt, 'alt-working'));
                        });
                    }

                    // Toggle Logic
                    toggle.onclick = () => {
                        const expanded = toggle.getAttribute('aria-expanded') === 'true';
                        toggle.setAttribute('aria-expanded', !expanded);
                        toggle.querySelector('.disclosure-text').textContent = !expanded ? 'Hide working' : 'Show working';
                        details.classList.toggle('expanded');
                    };

                    block.appendChild(toggle);
                    block.appendChild(details);
                }

                node.appendChild(block);
            }

            // 3. Children (Recursive)
            if (q.children && q.children.length > 0) {
                renderQuestionList(q.children, node, depth + 1, defaults);
            }

            return node;
        }

        function createSDSection(labelTxt, mdContent, typeClass) {
            const wrap = document.createElement('div');
            wrap.className = `sd-section ${typeClass}`;
            
            const label = document.createElement('div');
            label.className = 'sd-label';
            label.textContent = labelTxt;
            
            const body = document.createElement('div');
            body.className = 'sd-body md-content';
            body.innerHTML = md ? md.render(mdContent) : mdContent;
            
            wrap.appendChild(label);
            wrap.appendChild(body);
            return wrap;
        }

        // =========================================
        // NAVIGATION LOGIC
        // =========================================
        function renderNavigation(paper) {
            const deskList = document.getElementById('desktop-nav-list');
            const mobList = document.getElementById('drawer-nav-list');
            deskList.innerHTML = '';
            mobList.innerHTML = '';

            const fragment = document.createDocumentFragment();

            if (paper.sections) {
                paper.sections.forEach(sec => {
                    if (sec.label && sec.label.trim().length > 0) {
                        const secLabel = document.createElement('div');
                        secLabel.className = 'nav-section-label';
                        secLabel.textContent = sec.label;
                        fragment.appendChild(secLabel);
                    }
                    buildNavItems(sec.questions, fragment, 0);
                });
            } else {
                buildNavItems(paper.questions, fragment, 0);
            }

            deskList.appendChild(fragment.cloneNode(true));
            mobList.appendChild(fragment); // Moves it, which is fine, fragment is empty after append
        }

        function buildNavItems(questions, container, depth) {
            if (!questions) return;
            questions.forEach(q => {
                const a = document.createElement('a');
                a.href = `#q-${q.id}`;
                a.className = `nav-item depth-${Math.min(depth, 2)}`;
                a.textContent = q.id;
                a.onclick = (e) => {
                    e.preventDefault();
                    document.getElementById(`q-${q.id}`).scrollIntoView({behavior: 'smooth'});
                    closeDrawer();
                    updateActiveNav(a.getAttribute('href'));
                };
                container.appendChild(a);

                if (q.children) {
                    buildNavItems(q.children, container, depth + 1);
                }
            });
        }

        function updateActiveNav(hash) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            // Find in desktop and mobile
            const selector = `.nav-item[href="${hash}"]`;
            document.querySelectorAll(selector).forEach(el => el.classList.add('active'));
        }

        // =========================================
        // INTERACTIONS (Drawer, Observers)
        // =========================================
        function initInteraction() {
            const drawer = document.getElementById('drawer');
            const overlay = document.getElementById('drawer-overlay');
            const jumpBtn = document.getElementById('jump-to-btn');
            const closeBtn = document.getElementById('drawer-close');

            const open = () => {
                drawer.classList.add('open');
                drawer.setAttribute('aria-hidden', 'false');
                overlay.classList.add('open');
            };
            
            const close = () => {
                drawer.classList.remove('open');
                drawer.setAttribute('aria-hidden', 'true');
                overlay.classList.remove('open');
            };

            jumpBtn.onclick = open;
            closeBtn.onclick = close;
            overlay.onclick = close;
            window.closeDrawer = close; // Global hook for internal links

            // Scroll Observer for Active Nav
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const id = entry.target.id;
                        if (id) updateActiveNav(`#${id}`);
                    }
                });
            }, { rootMargin: '-10% 0px -80% 0px' }); // Trigger near top

            // We need to attach observer dynamically after render.
            // A MutationObserver on paper-content could trigger this, 
            // or just call logic after render.
            // Simplified: re-attach logic inside render.
            const originalRender = renderPaperContent;
            renderPaperContent = function(paper) {
                originalRender(paper);
                document.querySelectorAll('.question-node').forEach(el => observer.observe(el));
            }
        }

    </script>
</body>
</html>
