<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"ABC","indexWithinVariant":"177","totalWithinVariant":"320","hueFamily":"amber","intensityMode":"accent_only","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-09T18:16:29.558Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;ABC&quot;,&quot;indexWithinVariant&quot;:&quot;177&quot;,&quot;totalWithinVariant&quot;:&quot;320&quot;,&quot;hueFamily&quot;:&quot;amber&quot;,&quot;intensityMode&quot;:&quot;accent_only&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-09T18:16:29.558Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>

    <!-- Libraries -->
    <!-- Tailwind CSS for rapid structural styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- KaTeX (SRI Disabled per requirements) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    
    <!-- Markdown-it -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* 
           STAGE 6 ADD-ON: COLORLAB C 
           Mode: accent_only
           Hue: amber (forced via Add-on B)
        */
        :root {
            /* 
               OKLCH Palette Definition 
               Hue ~75 (Amber)
               Mode Rules: Surfaces C<=0.015, Text C<=0.010, Accent C [0.08..0.14]
            */
            --hue-fam: 75;

            /* Surfaces */
            --c-page-bg: oklch(0.985 0.01 var(--hue-fam));
            --c-frame-bg: oklch(1.0 0 0); /* Pure white base for cleanliness */
            --c-paper-bg: oklch(1.0 0 0);
            
            /* Solution Details Wash (very subtle warm tint) */
            --c-wash: oklch(0.975 0.015 var(--hue-fam));

            /* Text */
            --c-text-primary: oklch(0.20 0.01 var(--hue-fam));
            --c-text-secondary: oklch(0.45 0.01 var(--hue-fam));
            --c-text-quiet: oklch(0.60 0.01 var(--hue-fam));

            /* Borders / Dividers */
            --c-border: oklch(0.92 0.01 var(--hue-fam));
            --c-border-quiet: oklch(0.96 0.005 var(--hue-fam));

            /* Accent (Amber) - Used for Links, Focus, Nav Marker */
            --c-accent: oklch(0.62 0.14 var(--hue-fam));
            --c-accent-hover: oklch(0.57 0.14 var(--hue-fam));
            
            /* Focus Ring */
            --c-focus: var(--c-accent);
        }

        body {
            background-color: var(--c-page-bg);
            color: var(--c-text-primary);
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            overflow-y: scroll; /* Always show scrollbar to prevent shifts */
        }

        /* Layout Structure */
        .frame-shell {
            max-width: 1200px;
            margin: 0 auto;
            min-height: 100vh;
            background-color: var(--c-frame-bg);
            display: flex;
            flex-direction: column;
        }

        @media (min-width: 1024px) {
            .frame-shell {
                flex-direction: row;
                box-shadow: 0 0 40px -10px oklch(0 0 0 / 0.05); /* Subtle lift on desktop */
            }
        }

        /* Scrollbar Hiding for Nav */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Typography & Markdown */
        .prose-question {
            font-size: 1.125rem;
            line-height: 1.6;
            color: var(--c-text-primary);
            font-weight: 500;
        }
        
        .prose-answer {
            color: var(--c-text-primary);
            font-weight: 500;
        }

        .prose-solution {
            font-size: 1rem;
            line-height: 1.6;
            color: var(--c-text-secondary);
        }

        /* Markdown Internal Elements */
        .md-content p { margin-bottom: 0.85em; }
        .md-content p:last-child { margin-bottom: 0; }
        
        .md-content ul { list-style-type: disc; padding-left: 1.25em; margin-bottom: 0.85em; }
        .md-content ol { list-style-type: decimal; padding-left: 1.25em; margin-bottom: 0.85em; }
        
        .md-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 1em 0;
            font-size: 0.95em;
        }
        .md-content th, .md-content td {
            border: 1px solid var(--c-border);
            padding: 0.5em 0.75em;
            text-align: left;
        }
        .md-content th {
            font-weight: 600;
            background-color: oklch(0.98 0 0);
        }

        /* KaTeX Handling (Containment Invariant) */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding: 0.5em 0;
            margin: 0.75em 0;
            -webkit-overflow-scrolling: touch;
        }
        .katex-display > .katex {
            white-space: normal; /* Allow flow */
        }
        /* Inline KaTeX: No backgrounds allowed */
        .katex { font-size: 1.05em; }

        /* Focus & Interaction */
        :focus-visible {
            outline: 2px solid var(--c-focus);
            outline-offset: 2px;
            border-radius: 2px;
        }
        
        .btn-text {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            color: var(--c-accent);
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 0.25em;
            transition: color 0.15s ease;
        }
        .btn-text:hover { color: var(--c-accent-hover); }

        /* Nav Sticky */
        .nav-sticky {
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
        }
        
        /* Animation */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-4px); } to { opacity: 1; transform: translateY(0); } }
        .animate-reveal { animation: fadeIn 0.2s ease-out forwards; }

    </style>
</head>
<body>

    <div id="app">
        <!-- App mounted here -->
    </div>

    <script>
        // --- STAGE 0: CONSTANTS (Authoritative) ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // --- GLOBAL STATE ---
        let papers = [];
        let currentPaperId = null;
        let expandedNodes = new Set(); // Stores IDs of expanded nodes

        // --- MARKDOWN SETUP (Authoritative Config) ---
        const md = window.markdownit ? window.markdownit({
            html: true,    // Inline SVG passthrough
            linkify: true,
            breaks: false  // MUST be false to prevent <br> in math
        }) : null;

        if (md) {
            // Disable escape rule to preserve TeX backslashes
            md.inline.ruler.disable(['escape']);
        }

        // --- INIT ---
        async function init() {
            const app = document.getElementById('app');
            
            try {
                // Deterministic Payload Load
                const res = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!res.ok) throw new Error("Failed to load payload");
                
                const data = await res.json();
                papers = data.papers || [];

                if (papers.length === 0) {
                    renderError("PAPERS PAYLOAD EMPTY");
                    return;
                }

                // Initial Paper Select (First available)
                selectPaper(papers[0].key);

            } catch (err) {
                console.error(err);
                renderError("PAPERS PAYLOAD MISSING");
            }
        }

        function renderError(msg) {
            document.getElementById('app').innerHTML = `
                <div class="flex items-center justify-center min-h-screen bg-[var(--c-page-bg)]">
                    <div class="p-8 border border-[var(--c-border)] bg-[var(--c-frame-bg)]">
                        <h1 class="font-bold text-[var(--c-text-primary)] tracking-wide">${msg}</h1>
                    </div>
                </div>
            `;
        }

        // --- LOGIC ---

        function selectPaper(key) {
            currentPaperId = key;
            const paper = papers.find(p => p.key === key);
            
            if (!paper) return;

            // Reset Expansion State based on defaults
            expandedNodes.clear();
            const defaultExpanded = paper.defaults?.expandedAll !== false;
            
            // Recursively set default state for all nodes with solution details
            const traverse = (nodes) => {
                nodes.forEach(node => {
                    if (node.solutionBlock?.solutionDetails) {
                        if (defaultExpanded) expandedNodes.add(node.id);
                    }
                    if (node.children) traverse(node.children);
                });
            };

            const allNodes = paper.questions || (paper.sections ? paper.sections.flatMap(s => s.questions) : []);
            traverse(allNodes);

            render();
        }

        function toggleNode(id) {
            if (expandedNodes.has(id)) {
                expandedNodes.delete(id);
            } else {
                expandedNodes.add(id);
            }
            // Re-render efficiently? For prototype, full re-render + scroll preservation is acceptable
            // provided we don't jump. Since we use ID-based expansion, simple innerHTML replacement works fast enough.
            const scrollPos = window.scrollY;
            render();
            window.scrollTo(0, scrollPos);
        }

        function scrollToId(id) {
            const el = document.getElementById('q-' + id);
            if (el) {
                el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                // Close mobile drawer if open
                const drawer = document.getElementById('mobile-drawer');
                if (drawer) drawer.classList.add('hidden');
            }
        }

        // --- RENDERING ---

        function render() {
            const paper = papers.find(p => p.key === currentPaperId);
            if (!paper) return;

            const app = document.getElementById('app');
            
            // Generate Nav Items
            const navContent = renderNavList(paper);
            
            // Generate Paper Body
            const paperContent = renderPaperContent(paper);

            // Paper Selector HTML
            const selectorHtml = renderPaperSelector();

            app.innerHTML = `
                <div class="frame-shell">
                    
                    <!-- Desktop Nav Rail (Sticky) -->
                    <aside class="hidden lg:block w-64 flex-shrink-0 border-r border-[var(--c-border)] bg-[var(--c-frame-bg)] nav-sticky no-scrollbar px-6 py-8">
                        <div class="mb-8">
                            ${selectorHtml}
                        </div>
                        <nav class="space-y-1">
                            ${navContent}
                        </nav>
                    </aside>

                    <!-- Mobile Header -->
                    <header class="lg:hidden sticky top-0 z-20 bg-[var(--c-frame-bg)] border-b border-[var(--c-border)] p-4 flex justify-between items-center shadow-sm">
                        <div class="w-48">${selectorHtml}</div>
                        <button onclick="document.getElementById('mobile-drawer').classList.remove('hidden')" class="btn-text text-sm">
                            Jump to <i class="ph ph-list text-lg"></i>
                        </button>
                    </header>

                    <!-- Mobile Drawer -->
                    <div id="mobile-drawer" class="hidden fixed inset-0 z-50 lg:hidden">
                        <div class="absolute inset-0 bg-black/20 backdrop-blur-sm" onclick="this.parentElement.classList.add('hidden')"></div>
                        <div class="absolute right-0 top-0 bottom-0 w-64 bg-[var(--c-frame-bg)] shadow-xl flex flex-col">
                            <div class="p-4 border-b border-[var(--c-border)] flex justify-between items-center">
                                <span class="font-medium text-[var(--c-text-primary)]">Jump to</span>
                                <button onclick="this.closest('#mobile-drawer').classList.add('hidden')" class="p-2 text-[var(--c-text-secondary)]">
                                    <i class="ph ph-x text-lg"></i>
                                </button>
                            </div>
                            <nav class="flex-1 overflow-y-auto p-4 space-y-1">
                                ${navContent}
                            </nav>
                        </div>
                    </div>

                    <!-- Main Paper Area -->
                    <main class="flex-1 bg-[var(--c-paper-bg)] min-w-0">
                        <div class="max-w-3xl mx-auto px-4 sm:px-8 py-10 lg:py-16">
                            ${paperContent}
                        </div>
                        <!-- Footer Spacer -->
                        <div class="h-32"></div>
                    </main>
                </div>
            `;

            // Render KaTeX
            if (window.renderMathInElement) {
                renderMathInElement(document.body, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false},
                        {left: '\\(', right: '\\)', display: false},
                        {left: '\\[', right: '\\]', display: true}
                    ],
                    throwOnError: false,
                    trust: true // Allow basic styling
                });
            }
        }

        function renderPaperSelector() {
            return `
                <div class="relative group">
                    <select onchange="selectPaper(this.value)" class="w-full appearance-none bg-transparent border border-[var(--c-border)] rounded-sm py-2 pl-3 pr-8 text-sm text-[var(--c-text-primary)] focus:border-[var(--c-focus)] focus:ring-1 focus:ring-[var(--c-focus)] outline-none cursor-pointer transition-colors hover:border-[var(--c-accent)]">
                        ${papers.map(p => `<option value="${p.key}" ${p.key === currentPaperId ? 'selected' : ''}>${p.label}</option>`).join('')}
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-[var(--c-text-secondary)]">
                        <i class="ph ph-caret-down"></i>
                    </div>
                </div>
            `;
        }

        function renderNavList(paper) {
            let html = '';
            
            // Helper for recursive items
            const item = (node, depth) => {
                const isSub = depth > 0;
                // Hierarchy via type scale & weight only (no indent)
                const classes = isSub 
                    ? "text-sm text-[var(--c-text-quiet)] font-normal" 
                    : "text-sm text-[var(--c-text-primary)] font-medium";
                
                return `
                    <div class="py-[2px]">
                        <button onclick="scrollToId('${node.id}')" class="w-full text-left btn-reset ${classes} hover:text-[var(--c-accent)] block truncate">
                            ${node.id}
                        </button>
                    </div>
                `;
            };

            const traverse = (nodes, depth = 0) => {
                nodes.forEach(n => {
                    html += item(n, depth);
                    if (n.children) traverse(n.children, depth + 1);
                });
            };

            if (paper.sections) {
                paper.sections.forEach(s => {
                    if (s.label && s.label.trim()) {
                        html += `
                            <div class="pt-4 pb-1">
                                <span class="text-xs font-bold text-[var(--c-text-secondary)] uppercase tracking-wider select-none">${s.label}</span>
                            </div>
                        `;
                    }
                    traverse(s.questions);
                });
            } else {
                traverse(paper.questions || []);
            }

            return html;
        }

        function renderPaperContent(paper) {
            let html = '';

            const renderNodes = (nodes, depth) => {
                nodes.forEach(n => {
                    html += renderQuestionNode(n, depth);
                });
            };

            if (paper.sections) {
                paper.sections.forEach((s, idx) => {
                    if (s.label && s.label.trim()) {
                        html += `
                            <div class="mb-8 pt-6 border-b border-[var(--c-border)] pb-2">
                                <h2 class="text-lg font-semibold text-[var(--c-text-primary)]">${s.label}</h2>
                            </div>
                        `;
                    }
                    renderNodes(s.questions, 0);
                    // Separator between sections
                    if (idx < paper.sections.length - 1) html += `<div class="h-16"></div>`;
                });
            } else {
                renderNodes(paper.questions || [], 0);
            }

            return html;
        }

        function renderQuestionNode(node, depth) {
            // Stage 3 Spacing Hierarchy
            // Top Level: Largest spacing
            // Children: Indented, closer vertical spacing
            const isTop = depth === 0;
            const mt = isTop ? "mt-16 first:mt-0" : "mt-8";
            const ml = depth > 0 ? "ml-4 md:ml-8 border-l-2 border-transparent" : ""; // minimal visual indent for children

            const hasSolutionBlock = !!node.solutionBlock;
            const hasAnswer = hasSolutionBlock && !!node.solutionBlock.answer;
            const hasDetails = hasSolutionBlock && !!node.solutionBlock.solutionDetails;
            
            const isExpanded = expandedNodes.has(node.id);

            // Render content
            const qText = md ? md.render(node.question) : node.question;
            const aText = (hasAnswer && md) ? md.render(node.solutionBlock.answer) : (node.solutionBlock?.answer);

            return `
                <div id="q-${node.id}" class="question-node ${mt} ${ml} group">
                    <!-- Question Body -->
                    <div class="flex gap-4">
                        <div class="flex-shrink-0 w-8 pt-[2px]">
                            <span class="text-sm font-bold text-[var(--c-text-secondary)] select-none">${node.id}</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="prose-question md-content">
                                ${qText}
                            </div>
                        </div>
                    </div>

                    <!-- Solution Block -->
                    ${hasSolutionBlock ? `
                        <div class="mt-4 pl-12">
                            ${hasAnswer ? `
                                <div class="mb-3">
                                    <span class="text-xs font-bold text-[var(--c-text-secondary)] uppercase tracking-wide mr-2 select-none">Answer</span>
                                    <div class="inline-block prose-answer md-content align-top">
                                        ${aText}
                                    </div>
                                </div>
                            ` : ''}

                            ${hasDetails ? `
                                <div class="mt-3">
                                    <button onclick="toggleNode('${node.id}')" class="btn-text text-sm select-none">
                                        ${isExpanded ? 'Hide working' : 'Show working'}
                                        <i class="ph ${isExpanded ? 'ph-caret-up' : 'ph-caret-down'}"></i>
                                    </button>
                                    
                                    ${isExpanded ? `
                                        <div class="mt-3 pt-4 pb-4 px-5 -ml-5 rounded-sm bg-[var(--c-wash)] border-t border-[var(--c-border-quiet)] animate-reveal">
                                            ${renderSolutionDetails(node.solutionBlock.solutionDetails)}
                                        </div>
                                    ` : ''}
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}

                    <!-- Recursive Children -->
                    ${node.children ? `
                        <div class="children-wrapper">
                            ${node.children.map(c => renderQuestionNode(c, depth + 1)).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderSolutionDetails(details) {
            const { keepInMind, formulasUsed, working, alternativeWorking } = details;
            let html = '<div class="space-y-6 prose-solution">';

            const renderSection = (label, content, icon = null) => `
                <div>
                    <div class="mb-1 text-xs font-bold text-[var(--c-text-primary)] uppercase tracking-wide flex items-center gap-2">
                        ${icon ? `<i class="ph ${icon} text-lg"></i>` : ''}
                        ${label}
                    </div>
                    <div class="md-content">
                        ${md ? md.render(content) : content}
                    </div>
                </div>
            `;

            if (keepInMind) {
                html += renderSection('Keep in mind', keepInMind, 'ph-lightbulb');
            }
            if (formulasUsed) {
                html += renderSection('Formulas used', formulasUsed);
            }
            if (working) {
                html += renderSection('Working', working);
            }
            
            // Alternative Working
            if (alternativeWorking) {
                const alts = Array.isArray(alternativeWorking) ? alternativeWorking : [alternativeWorking];
                alts.forEach(alt => {
                    html += `
                        <div class="pt-4 border-t border-[var(--c-border-quiet)]">
                             ${renderSection('Alternative working', alt)}
                        </div>
                    `;
                });
            }

            html += '</div>';
            return html;
        }

        // Start
        init();

    </script>
</body>
</html>
