<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"ABC","indexWithinVariant":"298","totalWithinVariant":"320","hueFamily":"purple","intensityMode":"tinted_neutrals","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-10T00:01:41.464Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;ABC&quot;,&quot;indexWithinVariant&quot;:&quot;298&quot;,&quot;totalWithinVariant&quot;:&quot;320&quot;,&quot;hueFamily&quot;:&quot;purple&quot;,&quot;intensityMode&quot;:&quot;tinted_neutrals&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-10T00:01:41.464Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>
    
    <!-- Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- KaTeX CSS (No Integrity/SRI per requirements) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <!-- Tailwind (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Markdown-it & KaTeX JS (No Integrity/SRI) -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Configuration -->
    <script>
        // RTQ CONSTANTS (Canonical Sources)
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // ColorLab Parameters (Add-on B & C)
        // Hue Family: Purple (300)
        // Intensity Mode: Tinted Neutrals
        
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        page: 'var(--bg-page)',
                        frame: 'var(--bg-frame)',
                        paper: 'var(--bg-paper)',
                        wash: 'var(--bg-wash)',
                        primary: 'var(--text-primary)',
                        secondary: 'var(--text-secondary)',
                        accent: 'var(--accent)',
                        hairline: 'var(--hairline)',
                    }
                }
            }
        }
    </script>

    <style>
        /* ColorLab C: Tinted Neutrals, Purple (Hue 300) */
        :root {
            --hue: 300;
            
            /* OKLCH Values calculated based on Tinted Neutrals spec */
            /* Page: C [0.015..0.035] -> 0.02 */
            --bg-page: oklch(0.97 0.02 var(--hue));
            
            /* Frame: C [0.015..0.035] -> 0.015 */
            --bg-frame: oklch(0.98 0.015 var(--hue));
            
            /* Paper: C [0.015..0.035] -> 0.01 */
            --bg-paper: oklch(0.99 0.01 var(--hue));
            
            /* Wash: C [0.025..0.045] -> 0.03 */
            --bg-wash: oklch(0.96 0.03 var(--hue));
            
            /* Text: Primary C <= 0.010, Secondary C <= 0.012 */
            --text-primary: oklch(0.25 0.01 var(--hue));
            --text-secondary: oklch(0.45 0.012 var(--hue));
            
            /* Accent: C [0.10..0.16] -> 0.14 */
            --accent: oklch(0.55 0.14 var(--hue));
            
            /* Hairline: C <= 0.02 */
            --hairline: oklch(0.90 0.02 var(--hue));
        }

        body {
            background-color: var(--bg-page);
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
        }

        /* Scrollbar Hiding */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* KaTeX Containment Invariant */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding-bottom: 4px; /* Space for scrollbar if needed */
        }
        
        /* Inline KaTeX Transparency */
        .katex {
            background-color: transparent !important;
        }

        /* Focus States (Stage 5.5.2) */
        *:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }
        
        /* Utility for markdown tables */
        .md-content table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
            font-size: 0.95em;
        }
        .md-content th {
            font-weight: 600;
            text-align: left;
            border-bottom: 1px solid var(--hairline);
            padding: 0.5rem;
        }
        .md-content td {
            border-bottom: 1px solid var(--hairline);
            padding: 0.5rem;
        }
        .md-content p {
            margin-bottom: 0.75rem;
            line-height: 1.6;
        }
        .md-content ul {
            list-style-type: disc;
            padding-left: 1.5rem;
            margin-bottom: 0.75rem;
        }
        .md-content ol {
            list-style-type: decimal;
            padding-left: 1.5rem;
            margin-bottom: 0.75rem;
        }
        
        /* Navigation Drawer Transition */
        .drawer-enter { transform: translateX(0); }
        .drawer-exit { transform: translateX(-100%); }
    </style>
</head>
<body class="flex flex-col items-center min-h-screen">

    <!-- Top Controls Area (Frame Aligned) -->
    <header class="w-full max-w-[1024px] px-4 md:px-0 mt-4 mb-2 flex items-center justify-between z-10">
        <!-- Paper Selector -->
        <div class="relative">
            <select id="paper-selector" class="appearance-none bg-frame border border-hairline text-primary text-sm font-medium py-2 pl-3 pr-8 rounded shadow-sm focus:border-accent">
                <option value="" disabled selected>Loading papers...</option>
            </select>
            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-secondary">
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </div>
        </div>

        <!-- Mobile Jump To Trigger -->
        <button id="mobile-jump-trigger" class="md:hidden text-accent text-sm font-medium flex items-center gap-1">
            <span>Jump to</span>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
        </button>
    </header>

    <!-- DocumentFrameShell -->
    <div id="document-shell" class="w-full max-w-[1024px] bg-frame flex-1 grid md:grid-cols-[200px_1fr] relative shadow-sm min-h-[80vh]">
        
        <!-- Desktop Navigation Rail -->
        <aside class="hidden md:block border-r border-hairline relative">
            <div class="sticky top-0 h-[calc(100vh-2rem)] overflow-y-auto no-scrollbar py-6 px-4">
                <nav id="desktop-nav-list" class="flex flex-col gap-1">
                    <!-- Nav Items Generated Here -->
                </nav>
            </div>
        </aside>

        <!-- Paper Content Column -->
        <main id="paper-content" class="min-w-0 py-8 px-4 md:px-12 bg-frame">
            <!-- Content Generated Here -->
            <div id="loading-state" class="text-secondary text-center mt-20">Initialize...</div>
        </main>

    </div>

    <!-- Mobile Navigation Drawer -->
    <div id="drawer-overlay" class="fixed inset-0 bg-black/20 z-40 hidden" aria-hidden="true"></div>
    <div id="drawer-panel" class="fixed inset-y-0 left-0 w-64 bg-frame z-50 transform -translate-x-full transition-transform duration-200 ease-out shadow-lg flex flex-col">
        <div class="flex items-center justify-between p-4 border-b border-hairline">
            <h2 class="text-primary font-medium">Jump to</h2>
            <button id="drawer-close" class="text-secondary hover:text-primary">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <div class="flex-1 overflow-y-auto p-4">
            <nav id="mobile-nav-list" class="flex flex-col gap-2">
                <!-- Nav Items Generated Here -->
            </nav>
        </div>
    </div>

    <!-- Application Logic -->
    <script>
        // --- Markdown & KaTeX Setup ---
        const md = window.markdownit ? window.markdownit({
            html: true,
            linkify: true,
            breaks: false // REQUIRED: false to prevent <br> in math blocks
        }) : null;

        if (md) {
            md.inline.ruler.disable(['escape']); // Preserve TeX backslashes
        }

        // --- State ---
        const state = {
            papers: [],
            activePaperKey: null,
            expandedNodes: new Set(), // Set of question IDs
            activePaperData: null
        };

        // --- DOM Elements ---
        const els = {
            selector: document.getElementById('paper-selector'),
            content: document.getElementById('paper-content'),
            desktopNav: document.getElementById('desktop-nav-list'),
            mobileNav: document.getElementById('mobile-nav-list'),
            drawerOverlay: document.getElementById('drawer-overlay'),
            drawerPanel: document.getElementById('drawer-panel'),
            mobileTrigger: document.getElementById('mobile-jump-trigger'),
            drawerClose: document.getElementById('drawer-close')
        };

        // --- Core Logic ---

        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Fetch failed");
                const payload = await response.json();
                
                if (!payload.papers || !Array.isArray(payload.papers)) {
                    throw new Error("Invalid payload");
                }

                state.papers = payload.papers;
                renderSelector();
                
                // Load first paper by default
                if (state.papers.length > 0) {
                    loadPaper(state.papers[0].key);
                }
            } catch (e) {
                console.error(e);
                els.content.innerHTML = `<div class="text-center text-red-800 font-medium mt-10">PAPERS PAYLOAD MISSING</div>`;
                els.selector.innerHTML = `<option>Error loading payload</option>`;
                els.selector.disabled = true;
            }
        }

        function renderSelector() {
            els.selector.innerHTML = state.papers.map(p => 
                `<option value="${p.key}">${p.label}</option>`
            ).join('');
            els.selector.onchange = (e) => loadPaper(e.target.value);
        }

        function loadPaper(key) {
            const paper = state.papers.find(p => p.key === key);
            if (!paper) return;

            state.activePaperKey = key;
            state.activePaperData = paper;
            
            // Handle defaults
            state.expandedNodes.clear();
            const expandAll = paper.defaults?.expandedAll !== false; // Default true unless false
            // Note: We don't pre-fill state.expandedNodes because logic checks 'has(id)' vs default.
            // Simpler: Store explicit collapsed/expanded state.
            // Let's store EXPLICITLY EXPANDED set. If expandAll is true, we treat empty set as "use default", but toggles need logic.
            // Better: We will determine "isExpanded" at render time based on default + set overrides.
            // Actually, simpler to just start fresh. The interaction handles state.
            // We will add all IDs to set if defaults.expandedAll is true.
            if (expandAll) {
                // We need to traverse to find all IDs with solutionDetails to expand them.
                // For this prototype, let's just use a "check default" approach in render.
                state.defaultExpanded = true;
            } else {
                state.defaultExpanded = false;
            }
            // Explicit user toggles override defaults.
            state.userToggles = new Map(); // id -> boolean

            renderNav(paper);
            renderContent(paper);
            
            // Scroll top
            window.scrollTo({ top: 0, behavior: 'auto' });
        }

        // --- Navigation Rendering ---

        function renderNav(paper) {
            const createNavHTML = (nodes, isMobile) => {
                let html = '';
                
                // Helper to flatten logic
                const processNode = (node, depth) => {
                    // Item
                    const indentClass = depth > 0 ? 'text-xs opacity-80' : 'text-sm font-medium';
                    const activeClass = ''; // Logic handled via intersection observer or click
                    
                    html += `
                        <button onclick="scrollToQuestion('${node.id}')" 
                                class="text-left py-1 px-2 w-full hover:text-accent focus-visible:text-accent transition-colors ${indentClass} text-secondary block truncate">
                            ${node.id}
                        </button>
                    `;
                    if (node.children) {
                        node.children.forEach(child => processNode(child, depth + 1));
                    }
                };

                if (paper.sections) {
                    paper.sections.forEach(section => {
                        if (section.label && section.label.trim().length > 0) {
                            html += `<div class="mt-4 mb-1 px-2 text-xs font-semibold text-secondary uppercase tracking-wider select-none">${section.label}</div>`;
                        }
                        section.questions.forEach(q => processNode(q, 0));
                    });
                } else if (paper.questions) {
                    paper.questions.forEach(q => processNode(q, 0));
                }
                
                return html;
            };

            els.desktopNav.innerHTML = createNavHTML(paper.questions || paper.sections, false);
            els.mobileNav.innerHTML = createNavHTML(paper.questions || paper.sections, true);
        }

        window.scrollToQuestion = (id) => {
            const el = document.getElementById(`q-${id}`);
            if (el) {
                const headerOffset = 20;
                const elementPosition = el.getBoundingClientRect().top;
                const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
                
                window.scrollTo({
                    top: offsetPosition,
                    behavior: "smooth"
                });
                closeDrawer();
            }
        };

        // --- Content Rendering ---

        function renderContent(paper) {
            const container = els.content;
            container.innerHTML = ''; // Clear

            // Section or Flat handling
            if (paper.sections) {
                paper.sections.forEach((section, idx) => {
                    const sectionEl = document.createElement('section');
                    sectionEl.className = "mb-12";
                    
                    if (section.label && section.label.trim().length > 0) {
                        const header = document.createElement('h2');
                        header.className = "text-xl font-semibold text-primary mb-6 border-b border-hairline pb-2";
                        header.textContent = `Section ${section.label}`;
                        sectionEl.appendChild(header);
                    }
                    
                    const qList = document.createElement('div');
                    qList.className = "flex flex-col gap-12"; // Top-level spacing
                    section.questions.forEach(q => {
                        qList.appendChild(createQuestionNode(q, 0));
                    });
                    sectionEl.appendChild(qList);
                    container.appendChild(sectionEl);
                });
            } else if (paper.questions) {
                const qList = document.createElement('div');
                qList.className = "flex flex-col gap-12";
                paper.questions.forEach(q => {
                    qList.appendChild(createQuestionNode(q, 0));
                });
                container.appendChild(qList);
            }

            // After Render: Math Typesetting
            renderMathInElement(container, {
                delimiters: [
                    {left: "$$", right: "$$", display: true},
                    {left: "$", right: "$", display: false}
                ],
                throwOnError: false
            });
        }

        function createQuestionNode(node, depth) {
            const wrapper = document.createElement('article');
            wrapper.id = `q-${node.id}`;
            wrapper.className = "flex flex-col gap-4"; // Rhythm within node

            // 1. Question Body
            const body = document.createElement('div');
            body.className = "bg-paper p-4 md:p-6 rounded-sm"; // Surface differentiation for question? 
            // Brief says: "Question node surface (optional)... subtle". 
            // ColorLab C says "Paper: C ~0.015". 
            // Actually, text shouldn't be boxed heavily. Let's keep it simple.
            // Stage 5.1: "Whitespace is the primary grouping mechanism."
            // Let's use clean layout.
            body.innerHTML = `
                <div class="flex flex-row gap-3">
                    <span class="text-secondary font-medium shrink-0 pt-0.5 select-none text-sm md:text-base">${node.id}</span>
                    <div class="md-content text-primary text-base md:text-lg leading-relaxed flex-1 min-w-0">
                        ${renderMarkdown(node.question)}
                    </div>
                </div>
            `;
            wrapper.appendChild(body);

            // 2. Solution Block (Optional)
            if (node.solutionBlock) {
                const solutionWrapper = document.createElement('div');
                solutionWrapper.className = "ml-8 md:ml-12 flex flex-col gap-4"; // Indented relative to question ID

                // Answer
                if (node.solutionBlock.answer) {
                    const answerEl = document.createElement('div');
                    answerEl.className = "text-primary";
                    answerEl.innerHTML = `
                        <div class="text-xs font-bold text-secondary uppercase tracking-wider mb-1">Answer</div>
                        <div class="md-content text-lg">
                            ${renderMarkdown(node.solutionBlock.answer)}
                        </div>
                    `;
                    solutionWrapper.appendChild(answerEl);
                }

                // Solution Details (Show Working)
                if (node.solutionBlock.solutionDetails) {
                    const details = node.solutionBlock.solutionDetails;
                    const detailsContainer = document.createElement('div');
                    
                    // Determine state
                    const isExpanded = state.userToggles.has(node.id) 
                        ? state.userToggles.get(node.id) 
                        : state.defaultExpanded;

                    // Toggle
                    const toggleBtn = document.createElement('button');
                    toggleBtn.className = "text-accent font-medium text-sm flex items-center gap-1 hover:underline focus-visible:outline-none";
                    toggleBtn.innerHTML = `
                        <span>${isExpanded ? 'Hide working' : 'Show working'}</span>
                        <svg class="w-4 h-4 transform transition-transform ${isExpanded ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    `;
                    
                    // Expanded Region
                    const region = document.createElement('div');
                    region.className = `mt-3 border-l-2 border-hairline pl-4 py-2 ${isExpanded ? 'block' : 'hidden'}`;
                    // Optional Wash Surface per Stage 3/ColorLab
                    region.style.backgroundColor = isExpanded ? 'var(--bg-wash)' : 'transparent';
                    if(isExpanded) region.classList.add('rounded-r-sm', 'pr-4');

                    if (isExpanded) {
                        // Keep in mind
                        if (details.keepInMind) {
                            const kim = document.createElement('div');
                            kim.className = "mb-4";
                            kim.innerHTML = `
                                <div class="text-sm font-bold text-primary mb-1">Keep in mind</div>
                                <div class="md-content text-secondary text-sm">
                                    ${renderMarkdown(details.keepInMind)}
                                </div>
                            `;
                            region.appendChild(kim);
                        }
                        
                        // Formulas Used
                        if (details.formulasUsed) {
                            const formulas = document.createElement('div');
                            formulas.className = "mb-4";
                            formulas.innerHTML = `
                                <div class="text-sm font-bold text-primary mb-1">Formulas used</div>
                                <div class="md-content text-secondary text-sm">
                                    ${renderMarkdown(details.formulasUsed)}
                                </div>
                            `;
                            region.appendChild(formulas);
                        }

                        // Working
                        if (details.working) {
                            const working = document.createElement('div');
                            working.className = "mb-4";
                            working.innerHTML = `
                                <div class="text-sm font-bold text-primary mb-1">Working</div>
                                <div class="md-content text-secondary">
                                    ${renderMarkdown(details.working)}
                                </div>
                            `;
                            region.appendChild(working);
                        }

                        // Alternative Working
                        if (details.alternativeWorking && Array.isArray(details.alternativeWorking)) {
                            details.alternativeWorking.forEach((alt, i) => {
                                const altEl = document.createElement('div');
                                altEl.className = "mt-6 pt-4 border-t border-hairline";
                                altEl.innerHTML = `
                                    <div class="text-sm font-bold text-primary mb-1">Alternative working</div>
                                    <div class="md-content text-secondary">
                                        ${renderMarkdown(alt)}
                                    </div>
                                `;
                                region.appendChild(altEl);
                            });
                        }
                    }

                    // Toggle Handler
                    toggleBtn.onclick = () => {
                        state.userToggles.set(node.id, !isExpanded);
                        // Re-render this specific solution block or whole paper? 
                        // For simplicity and correctness with math rendering, simplest is re-render whole content or just swap this node.
                        // Re-rendering whole content is easiest to ensure KaTeX runs correctly on new content.
                        // Performance is fine for prototype.
                        const scrollY = window.scrollY;
                        renderContent(state.activePaperData);
                        window.scrollTo(0, scrollY);
                    };

                    detailsContainer.appendChild(toggleBtn);
                    detailsContainer.appendChild(region);
                    solutionWrapper.appendChild(detailsContainer);
                }
                wrapper.appendChild(solutionWrapper);
            }

            // 3. Children (Sub-questions)
            if (node.children && node.children.length > 0) {
                const childrenContainer = document.createElement('div');
                childrenContainer.className = "ml-4 md:ml-8 mt-4 flex flex-col gap-6"; // Indentation and spacing
                node.children.forEach(child => {
                    childrenContainer.appendChild(createQuestionNode(child, depth + 1));
                });
                wrapper.appendChild(childrenContainer);
            }

            return wrapper;
        }

        function renderMarkdown(text) {
            if (!text) return '';
            if (!md) return text; // Fallback
            return md.render(text);
        }

        // --- Mobile Drawer Logic ---
        function openDrawer() {
            els.drawerOverlay.classList.remove('hidden');
            els.drawerPanel.classList.remove('-translate-x-full');
            document.body.style.overflow = 'hidden';
        }
        function closeDrawer() {
            els.drawerOverlay.classList.add('hidden');
            els.drawerPanel.classList.add('-translate-x-full');
            document.body.style.overflow = '';
        }
        els.mobileTrigger.onclick = openDrawer;
        els.drawerClose.onclick = closeDrawer;
        els.drawerOverlay.onclick = closeDrawer;

        // --- Init ---
        init();

    </script>
</body>
</html>
