<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AD","indexWithinVariant":"315","totalWithinVariant":"440","hueFamily":"","intensityMode":"","primaryHueFamily":"teal","secondaryHueFamily":"amber","dualIntensityMode":"dual_high_chroma_surfaces","timestamp":"2026-01-10T17:52:04.530Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AD&quot;,&quot;indexWithinVariant&quot;:&quot;315&quot;,&quot;totalWithinVariant&quot;:&quot;440&quot;,&quot;hueFamily&quot;:&quot;&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;primaryHueFamily&quot;:&quot;teal&quot;,&quot;secondaryHueFamily&quot;:&quot;amber&quot;,&quot;dualIntensityMode&quot;:&quot;dual_high_chroma_surfaces&quot;,&quot;timestamp&quot;:&quot;2026-01-10T17:52:04.530Z&quot;}'>

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RTQ Maths Paper Solution Viewer</title>

<!-- PRELOAD FONTS -->
<link rel="preconnect" href="https://rsms.me/">
<link rel="stylesheet" href="https://rsms.me/inter/inter.css">

<!-- DEPENDENCIES (SRI DISABLED PER STAGE 6.0.7b) -->
<!-- KaTeX -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
<!-- Markdown-it -->
<script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

<style>
/* ==========================================================================
   STAGE 0 & COLORLAB D (MODE 3: DUAL_HIGH_CHROMA_SURFACES)
   ========================================================================== */

:root {
    /* 
       COLORLAB D - DYNAMIC HUES
       Default Fallbacks: Blue (250) + Amber (80)
       These get updated by JS based on placeholders/config.
    */
    --hue-p: 250; 
    --hue-s: 80;

    /* PALETTE GENERATION (OKLCH) - MODE 3 (High Chroma Surfaces) */
    
    /* Surfaces */
    /* Page: Chroma ~0.06 */
    --c-surf-page: oklch(0.96 0.06 var(--hue-p));
    /* Frame: Chroma ~0.07 */
    --c-surf-frame: oklch(0.93 0.07 var(--hue-p));
    /* Paper: Chroma ~0.03 (slightly cleaner for reading) */
    --c-surf-paper: oklch(0.99 0.03 var(--hue-p));
    /* Wash: Chroma ~0.05 */
    --c-surf-wash: oklch(0.95 0.05 var(--hue-p));
    /* Nav Hover */
    --c-surf-nav-hover: oklch(0.90 0.04 var(--hue-p));

    /* Typography */
    /* Primary Text: Dark, low chroma */
    --c-text-primary: oklch(0.20 0.015 var(--hue-p));
    /* Secondary Text: Lighter, low chroma */
    --c-text-secondary: oklch(0.45 0.02 var(--hue-p));
    /* Tertiary/Quiet */
    --c-text-tertiary: oklch(0.55 0.02 var(--hue-p));

    /* Accents */
    /* Primary Accent (Links, Focus, Show/Hide): High Chroma */
    --c-accent-primary: oklch(0.55 0.18 var(--hue-p));
    /* Secondary Accent (Nav Marker/Highlight): Distinct Hue */
    --c-accent-secondary: oklch(0.70 0.16 var(--hue-s));

    /* Dividers */
    --c-divider: oklch(0.85 0.02 var(--hue-p));
    --c-table-border: oklch(0.90 0.02 var(--hue-p));

    /* SPACING SYSTEM (Linear Scale) */
    --sp-xs: 0.25rem;
    --sp-sm: 0.5rem;
    --sp-md: 1rem;
    --sp-lg: 1.5rem;
    --sp-xl: 2.5rem;  /* Top-level question gap */
    --sp-2xl: 4rem;

    /* TYPOGRAPHY TOKENS */
    --font-base: 'Inter', sans-serif;
    --text-xs: 0.75rem;
    --text-sm: 0.875rem;
    --text-base: 1rem;
    --text-lg: 1.125rem;
    --text-xl: 1.25rem;
    
    --leading-tight: 1.2;
    --leading-base: 1.5;
    --leading-relaxed: 1.6;

    /* LAYOUT DIMENSIONS */
    --nav-width: 240px;
    --paper-max-width: 800px;
    --header-height: 60px;
}

/* ==========================================================================
   RESET & BASE
   ========================================================================== */

*, *::before, *::after {
    box-sizing: border-box;
}

body {
    margin: 0;
    padding: 0;
    font-family: var(--font-base);
    background-color: var(--c-surf-page);
    color: var(--c-text-primary);
    line-height: var(--leading-base);
    -webkit-font-smoothing: antialiased;
    overflow-y: scroll; /* Force vertical scrollbar to avoid layout shift */
}

button {
    font-family: inherit;
    border: none;
    background: none;
    cursor: pointer;
    padding: 0;
    margin: 0;
    color: inherit;
}

button:focus-visible, a:focus-visible, [tabindex]:focus-visible {
    outline: 2px solid var(--c-accent-primary);
    outline-offset: 2px;
    border-radius: 2px;
}

/* ==========================================================================
   LAYOUT SHELL (Stage 3 & 6)
   ========================================================================== */

.app-container {
    display: flex;
    flex-direction: column;
    min-height: 100vh;
}

/* Top Controls */
.top-controls {
    background-color: var(--c-surf-frame); /* Matches frame */
    border-bottom: 1px solid var(--c-divider);
    height: var(--header-height);
    display: flex;
    align-items: center;
    justify-content: center; /* Center content to align with frame */
    padding: 0 var(--sp-md);
    position: sticky;
    top: 0;
    z-index: 50;
}

.top-controls-inner {
    width: 100%;
    max-width: calc(var(--nav-width) + var(--paper-max-width) + var(--sp-xl)); /* Align with shell */
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.paper-selector {
    font-size: var(--text-sm);
    padding: var(--sp-xs) var(--sp-sm);
    border: 1px solid var(--c-divider);
    border-radius: 4px;
    background-color: var(--c-surf-paper);
    color: var(--c-text-primary);
}

.mobile-jump-trigger {
    display: none; /* Desktop default */
    font-size: var(--text-sm);
    color: var(--c-accent-primary);
    font-weight: 500;
}

/* Document Frame Shell */
.document-frame-shell {
    flex: 1;
    display: flex;
    justify-content: center;
    background-color: var(--c-surf-frame);
    padding-top: var(--sp-lg);
    padding-bottom: var(--sp-2xl);
}

.shell-inner {
    display: flex;
    width: 100%;
    max-width: calc(var(--nav-width) + var(--paper-max-width) + var(--sp-xl));
    gap: var(--sp-xl); /* Gap between nav and paper */
    padding: 0 var(--sp-md);
}

/* Nav Rail (Desktop) */
.nav-rail {
    width: var(--nav-width);
    flex-shrink: 0;
    position: sticky;
    top: calc(var(--header-height) + var(--sp-lg));
    height: calc(100vh - var(--header-height) - var(--sp-lg) * 2);
    overflow-y: auto;
    /* Hide scrollbar visually but keep functional */
    scrollbar-width: none; 
    -ms-overflow-style: none;
}
.nav-rail::-webkit-scrollbar { 
    display: none; 
}

/* Paper Column */
.paper-column {
    flex: 1;
    max-width: var(--paper-max-width);
    min-width: 0; /* CSS Grid/Flex containment fix */
}

/* Paper Surface */
.paper-surface {
    background-color: var(--c-surf-paper);
    min-height: 80vh;
    /* No heavy borders or shadows per Stage 4/5 */
    padding: var(--sp-xl); /* Internal padding */
}

/* ==========================================================================
   NAVIGATION COMPONENTS
   ========================================================================== */

.nav-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.nav-section-label {
    font-size: var(--text-xs);
    font-weight: 600;
    color: var(--c-text-tertiary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding: var(--sp-sm) 0 var(--sp-xs) 0;
    margin-top: var(--sp-md);
    border-bottom: 1px solid var(--c-divider); /* Quiet hairline */
}

.nav-item {
    display: block;
    font-size: var(--text-sm);
    color: var(--c-text-secondary);
    padding: var(--sp-xs) var(--sp-sm);
    text-decoration: none;
    border-radius: 4px;
    transition: color 0.1s, background-color 0.1s;
    /* Flat alignment */
    padding-left: 0; 
}

.nav-item:hover {
    color: var(--c-text-primary);
    text-decoration: underline;
    text-decoration-color: var(--c-divider);
}

.nav-item.active {
    font-weight: 700;
    color: var(--c-text-primary);
}

/* Nav hierarchy via type scale only */
.nav-item[data-depth="0"] { font-size: var(--text-sm); }
.nav-item[data-depth="1"] { font-size: 0.8rem; }
.nav-item[data-depth="2"] { font-size: 0.75rem; color: var(--c-text-tertiary); }

/* Current Indicator (ColorLab D - Secondary Hue allowed for this role) */
.nav-item.active::before {
    content: '';
    display: inline-block;
    width: 4px;
    height: 4px;
    background-color: var(--c-accent-secondary); /* Restrained usage */
    border-radius: 50%;
    margin-right: 8px;
    vertical-align: middle;
}

/* ==========================================================================
   PAPER CONTENT (Questions)
   ========================================================================== */

.section-header {
    font-size: var(--text-xl);
    font-weight: 700;
    color: var(--c-text-primary);
    border-bottom: 1px solid var(--c-divider);
    padding-bottom: var(--sp-sm);
    margin-top: var(--sp-2xl);
    margin-bottom: var(--sp-lg);
}

.question-node {
    margin-bottom: var(--sp-xl); /* Inter-question spacing */
}

/* Question Body */
.q-body {
    margin-bottom: var(--sp-md);
}

.q-identifier {
    font-weight: 700;
    color: var(--c-text-secondary);
    margin-right: var(--sp-sm);
    float: left; /* Run-in style or flex */
}

.q-text {
    color: var(--c-text-primary);
}

/* Solution Block */
.solution-block {
    /* Optional: very subtle divider if needed for density */
    /* border-top: 1px solid var(--c-divider); */
    margin-top: var(--sp-md);
    padding-top: var(--sp-sm);
}

/* Answer */
.answer-region {
    margin-bottom: var(--sp-sm);
    font-weight: 500;
}
.answer-label {
    font-size: var(--text-sm);
    color: var(--c-text-tertiary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-right: var(--sp-sm);
    font-weight: 700;
}
.answer-content {
    color: var(--c-text-primary);
}

/* Disclosure Control */
.disclosure-control {
    font-size: var(--text-sm);
    color: var(--c-accent-primary);
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: var(--sp-xs);
    margin-bottom: var(--sp-sm);
    user-select: none;
}
.disclosure-control:hover {
    text-decoration: underline;
}
.chevron {
    transition: transform 0.2s ease;
    width: 1em;
    height: 1em;
}
.disclosure-control[aria-expanded="true"] .chevron {
    transform: rotate(180deg);
}

/* Solution Details Region */
.solution-details {
    display: none;
    margin-top: var(--sp-sm);
    padding: var(--sp-md);
    background-color: var(--c-surf-wash); /* Surface Differentiation */
    border-radius: 4px; /* Slight softening, not full card */
}
.solution-details.expanded {
    display: block;
    animation: reveal 0.2s ease-out;
}

@keyframes reveal {
    from { opacity: 0; transform: translateY(-4px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Solution Details Subsections */
.sd-section {
    margin-bottom: var(--sp-lg);
}
.sd-section:last-child {
    margin-bottom: 0;
}

.sd-label {
    font-size: var(--text-xs);
    font-weight: 700;
    color: var(--c-text-tertiary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: var(--sp-xs);
    display: block;
}

/* Specific sub-section tweaks */
.sd-keep-in-mind .sd-body {
    font-size: var(--text-sm);
    color: var(--c-text-secondary);
}
.sd-keep-in-mind ul {
    padding-left: var(--sp-lg);
    margin: 0;
}

.sd-formulas .sd-body {
    font-family: var(--font-base); /* KaTeX handles math font */
    color: var(--c-text-secondary);
}

.sd-working .sd-body, .sd-alt-working .sd-body {
    color: var(--c-text-secondary); /* Subordinate to question */
}

/* Internal Spacing Logic for Workings */
.sd-body p {
    margin-bottom: var(--sp-sm);
}
.sd-body .katex-display {
    margin: var(--sp-sm) 0;
    overflow-x: auto;
    overflow-y: hidden;
    padding-bottom: 2px; /* Scrollbar breathing room */
}

/* Children */
.children-container {
    margin-top: var(--sp-md);
    padding-left: var(--sp-md); /* Indentation for structure */
    border-left: 2px solid transparent; /* Visual anchor placeholder */
}
/* No lines per Stage 3/5, relying on indentation + spacing */

/* ==========================================================================
   MOBILE & RESPONSIVE
   ========================================================================== */

/* Drawer (Mobile Nav) */
.mobile-drawer-overlay {
    position: fixed;
    inset: 0;
    background-color: rgba(0,0,0,0.2);
    z-index: 99;
    display: none;
}
.mobile-drawer {
    position: fixed;
    top: 0;
    left: 0;
    bottom: 0;
    width: 85%;
    max-width: 320px;
    background-color: var(--c-surf-paper);
    z-index: 100;
    transform: translateX(-100%);
    transition: transform 0.25s ease-out;
    display: flex;
    flex-direction: column;
    box-shadow: 2px 0 8px rgba(0,0,0,0.05);
}
.mobile-drawer.open {
    transform: translateX(0);
}
.drawer-header {
    height: var(--header-height);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 var(--sp-md);
    border-bottom: 1px solid var(--c-divider);
    font-weight: 700;
}
.drawer-content {
    flex: 1;
    overflow-y: auto;
    padding: var(--sp-md);
}

/* Responsive Queries */
@media (max-width: 800px) {
    .nav-rail {
        display: none;
    }
    .mobile-jump-trigger {
        display: block;
    }
    .shell-inner {
        flex-direction: column;
    }
    .paper-surface {
        padding: var(--sp-md);
    }
    .document-frame-shell {
        padding-top: var(--sp-md);
    }
}

/* ==========================================================================
   KATEX & MARKDOWN OVERRIDES (Locked)
   ========================================================================== */

/* Containment Invariant */
.katex-display {
    max-width: 100%;
    overflow-x: auto !important;
    overflow-y: hidden;
    -webkit-overflow-scrolling: touch;
}
/* No background on inline math */
.katex {
    background-color: transparent !important;
}
/* Block math allowed background if needed, but per Stage 5.8.2 we keep it clean unless dense.
   Stage 5.8.4 says transparent for inline. 
   Display math is block. We leave it transparent to match paper. */

/* Tables */
table {
    border-collapse: collapse;
    width: 100%;
    margin: var(--sp-sm) 0;
    font-size: var(--text-sm);
}
th, td {
    border: 1px solid var(--c-table-border);
    padding: var(--sp-sm);
    text-align: left;
    vertical-align: top;
}
th {
    font-weight: 600;
    background-color: transparent;
}

/* Images/SVG */
img, svg {
    max-width: 100%;
    height: auto;
}

</style>
</head>
<body>

<!-- APP SHELL -->
<div id="app" class="app-container">
    
    <!-- TOP CONTROLS -->
    <header class="top-controls">
        <div class="top-controls-inner">
            <!-- Paper Selector -->
            <select id="paper-selector" class="paper-selector" aria-label="Select Paper">
                <option value="" disabled selected>Loading papers...</option>
            </select>

            <!-- Mobile Jump Trigger -->
            <button id="mobile-jump-btn" class="mobile-jump-trigger">
                Jump to question
            </button>
        </div>
    </header>

    <!-- DOCUMENT FRAME -->
    <main class="document-frame-shell">
        <div class="shell-inner">
            
            <!-- DESKTOP NAV RAIL -->
            <nav class="nav-rail" aria-label="Paper Navigation">
                <div id="desktop-nav-content" class="nav-content">
                    <!-- Nav generated here -->
                </div>
            </nav>

            <!-- PAPER CONTENT COLUMN -->
            <div class="paper-column">
                <div id="paper-surface" class="paper-surface">
                    <div id="paper-content">
                        <!-- Content generated here -->
                        <div style="text-align:center; color: var(--c-text-tertiary); padding: 4rem;">
                            Select a paper to begin.
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- MOBILE DRAWER -->
    <div id="drawer-overlay" class="mobile-drawer-overlay"></div>
    <div id="mobile-drawer" class="mobile-drawer" role="dialog" aria-modal="true" aria-label="Navigation">
        <div class="drawer-header">
            <span>Jump to</span>
            <button id="drawer-close-btn" aria-label="Close navigation">âœ•</button>
        </div>
        <div id="drawer-nav-content" class="drawer-content">
            <!-- Cloned Nav generated here -->
        </div>
    </div>

</div>

<!-- RUNTIME SCRIPT -->
<script>
// ==========================================================================
// STAGE 0: CONSTANTS & COLORLAB D LOGIC
// ==========================================================================

const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";

// --- ColorLab D: Hue Resolution ---
// Template variables. If not replaced (still has curly braces), use defaults.
// Default: Blue (250) + Amber (80)
const RAW_PRIMARY = "{{RTQ_COLORLAB_DUAL_HUE_PRIMARY}}";
const RAW_SECONDARY = "{{RTQ_COLORLAB_DUAL_HUE_SECONDARY}}";

const HUE_MAP = {
    'green': 145,
    'blue': 250,
    'purple': 290,
    'red': 25,
    'amber': 80,
    'cyan': 195,
    'teal': 175,
    'pink': 330
};

// RUN CONFIG PARSER (Optional Override)
function parseRunConfig() {
    // This function simulates checking a provided config block in a real chat context.
    // Since this is a generated file, we just return empty overrides unless hardcoded.
    // In a real runner, we'd parse the instruction text. Here we rely on JS variables.
    return {}; 
}

function resolveHues() {
    // 1. Check placeholders
    let p = HUE_MAP['blue'];
    let s = HUE_MAP['amber'];

    const clean = (str) => str.replace(/[{}]/g, '').trim().toLowerCase();
    
    const pInput = clean(RAW_PRIMARY);
    const sInput = clean(RAW_SECONDARY);

    if (HUE_MAP[pInput]) p = HUE_MAP[pInput];
    if (HUE_MAP[sInput]) s = HUE_MAP[sInput];

    // 2. Override Logic: If same, force Secondary
    if (p === s) {
        s = (p + 180) % 360; // simple shift if collision
    }

    // Apply to CSS
    document.documentElement.style.setProperty('--hue-p', p);
    document.documentElement.style.setProperty('--hue-s', s);
}

resolveHues();

// ==========================================================================
// MARKDOWN & KATEX SETUP (Stage 6.0.7 & Add-on)
// ==========================================================================

const md = window.markdownit ? window.markdownit({
    html: true, // Allow SVG passthrough
    linkify: true,
    breaks: false // Critical: prevents <br> in math
}) : null;

if (md) {
    // Disable escape rule to preserve TeX backslashes
    md.inline.ruler.disable(['escape']);
}

// ==========================================================================
// APP STATE & LOGIC
// ==========================================================================

const state = {
    papers: [],
    currentPaper: null,
    navItems: [] // Flat list for navigation
};

const dom = {
    selector: document.getElementById('paper-selector'),
    content: document.getElementById('paper-content'),
    desktopNav: document.getElementById('desktop-nav-content'),
    mobileNav: document.getElementById('drawer-nav-content'),
    mobileDrawer: document.getElementById('mobile-drawer'),
    drawerOverlay: document.getElementById('drawer-overlay'),
    jumpBtn: document.getElementById('mobile-jump-btn'),
    closeBtn: document.getElementById('drawer-close-btn')
};

async function init() {
    try {
        const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
        if (!response.ok) throw new Error("Payload fetch failed");
        
        const payload = await response.json();
        if (!payload || !payload.papers) throw new Error("Invalid payload");

        state.papers = payload.papers;
        renderSelector();
        
        // Auto-load first paper if available
        if (state.papers.length > 0) {
            loadPaper(state.papers[0].key);
        }

    } catch (e) {
        console.error(e);
        dom.content.innerHTML = `<div style="text-align:center; padding: 4rem; font-weight:700; color: var(--c-text-primary);">PAPERS PAYLOAD MISSING</div>`;
        dom.selector.innerHTML = `<option>Error loading payload</option>`;
    }
}

function renderSelector() {
    dom.selector.innerHTML = state.papers.map(p => 
        `<option value="${p.key}">${p.label}</option>`
    ).join('');
    
    dom.selector.addEventListener('change', (e) => {
        loadPaper(e.target.value);
    });
}

function loadPaper(key) {
    const paper = state.papers.find(p => p.key === key);
    if (!paper) return;

    state.currentPaper = paper;
    dom.selector.value = key;
    
    // Reset Scroll
    window.scrollTo(0,0);
    
    // Generate Flat Nav Model first
    state.navItems = [];
    if (paper.sections) {
        paper.sections.forEach(sec => {
            if (sec.label && sec.label.trim().length > 0) {
                state.navItems.push({ type: 'section', label: sec.label });
            }
            traverseQuestionsForNav(sec.questions, 0);
        });
        renderContent(paper.sections.flatMap(s => s.questions), true); // Pass sections flat for rendering loop? No, render supports sections.
    } else {
        traverseQuestionsForNav(paper.questions, 0);
        renderContent(paper.questions, false);
    }
    
    renderNav();
}

function traverseQuestionsForNav(nodes, depth) {
    if (!nodes) return;
    nodes.forEach(node => {
        state.navItems.push({ 
            type: 'item', 
            id: node.id, 
            depth: depth 
        });
        if (node.children) {
            traverseQuestionsForNav(node.children, depth + 1);
        }
    });
}

// ==========================================================================
// RENDERERS
// ==========================================================================

function renderContent(rootNodes, hasSections) {
    // If hasSections is true, rootNodes passed here are actually raw questions? 
    // Wait, let's handle the top level loop properly.
    
    let html = '';
    
    if (state.currentPaper.sections) {
        state.currentPaper.sections.forEach(sec => {
            if (sec.label && sec.label.trim()) {
                html += `<div class="section-header">${sec.label}</div>`;
            }
            html += renderQuestionList(sec.questions, 0);
        });
    } else {
        html += renderQuestionList(state.currentPaper.questions, 0);
    }
    
    dom.content.innerHTML = html;
    
    // Post-render: KaTeX
    renderMathInElement(dom.content, {
        delimiters: [
            {left: '$$', right: '$$', display: true},
            {left: '$', right: '$', display: false}
        ],
        throwOnError: false,
        trust: true
    });

    // Post-render: Add event listeners for toggles
    addToggleListeners();
    // Setup intersection observer for scroll spy
    setupScrollSpy();
}

function renderQuestionList(nodes, depth) {
    if (!nodes || nodes.length === 0) return '';
    
    return nodes.map(node => renderQuestionNode(node, depth)).join('');
}

function renderQuestionNode(node, depth) {
    const qId = node.id;
    // Render Markdown
    const qHtml = md ? md.render(node.question || '') : (node.question || '');
    
    let solutionBlock = '';
    const hasSolution = !!node.solutionBlock;
    
    if (hasSolution) {
        const sb = node.solutionBlock;
        const hasAns = !!sb.answer;
        const hasDetails = !!sb.solutionDetails;
        
        let answerHtml = '';
        if (hasAns) {
            const ansContent = md ? md.render(sb.answer) : sb.answer;
            answerHtml = `
                <div class="answer-region">
                    <span class="answer-label">Answer</span>
                    <span class="answer-content">${ansContent}</span>
                </div>
            `;
        }
        
        let detailsHtml = '';
        if (hasDetails) {
            const sd = sb.solutionDetails;
            const isExpanded = state.currentPaper.defaults?.expandedAll !== false; // Default expanded
            
            // Subsections
            const keepInMind = sd.keepInMind ? `
                <div class="sd-section sd-keep-in-mind">
                    <span class="sd-label">Keep in mind</span>
                    <div class="sd-body">${md.render(sd.keepInMind)}</div>
                </div>` : '';

            const formulas = sd.formulasUsed ? `
                <div class="sd-section sd-formulas">
                    <span class="sd-label">Formulas used</span>
                    <div class="sd-body">${md.render(sd.formulasUsed)}</div>
                </div>` : '';

            const working = sd.working ? `
                <div class="sd-section sd-working">
                    <span class="sd-label">Working</span>
                    <div class="sd-body">${md.render(sd.working)}</div>
                </div>` : '';

            const alts = (sd.alternativeWorking && Array.isArray(sd.alternativeWorking)) ? 
                sd.alternativeWorking.map((alt, i) => `
                    <div class="sd-section sd-alt-working">
                        <span class="sd-label">Alternative working</span>
                        <div class="sd-body">${md.render(alt)}</div>
                    </div>
                `).join('') : '';

            detailsHtml = `
                <div class="solution-details-wrapper">
                    <button class="disclosure-control" aria-expanded="${isExpanded}" aria-controls="sd-${qId}">
                        <span class="btn-text">${isExpanded ? 'Hide working' : 'Show working'}</span>
                        <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                    </button>
                    <div id="sd-${qId}" class="solution-details ${isExpanded ? 'expanded' : ''}">
                        ${keepInMind}
                        ${formulas}
                        ${working}
                        ${alts}
                    </div>
                </div>
            `;
        }
        
        if (hasAns || hasDetails) {
            solutionBlock = `<div class="solution-block">${answerHtml}${detailsHtml}</div>`;
        }
    }

    const childrenHtml = node.children && node.children.length > 0 
        ? `<div class="children-container">${renderQuestionList(node.children, depth + 1)}</div>` 
        : '';

    return `
        <div class="question-node" id="q-${qId}" data-id="${qId}">
            <div class="q-body">
                <span class="q-identifier">${qId}</span>
                <div class="q-text">${qHtml}</div>
            </div>
            ${solutionBlock}
            ${childrenHtml}
        </div>
    `;
}

function renderNav() {
    const generateList = () => state.navItems.map(item => {
        if (item.type === 'section') {
            return `<li class="nav-section-label">${item.label}</li>`;
        } else {
            return `<li><a href="#q-${item.id}" class="nav-item" data-id="${item.id}" data-depth="${item.depth}">${item.id}</a></li>`;
        }
    }).join('');

    const html = `<ul class="nav-list">${generateList()}</ul>`;
    dom.desktopNav.innerHTML = html;
    dom.mobileNav.innerHTML = html;
    
    // Bind clicks for smooth scrolling and drawer closing
    const handleNavClick = (e) => {
        const link = e.target.closest('a');
        if (link) {
            e.preventDefault();
            const id = link.getAttribute('data-id');
            const target = document.getElementById(`q-${id}`);
            if (target) {
                // Scroll accounting for sticky header
                const headerOffset = 80;
                const elementPosition = target.getBoundingClientRect().top;
                const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
                window.scrollTo({ top: offsetPosition, behavior: "smooth" });
                
                // Close drawer if open
                closeDrawer();
                
                // Set active manually immediate feedback
                updateActiveNav(id);
            }
        }
    };
    
    dom.desktopNav.addEventListener('click', handleNavClick);
    dom.mobileNav.addEventListener('click', handleNavClick);
}

// ==========================================================================
// INTERACTION & LISTENERS
// ==========================================================================

function addToggleListeners() {
    const toggles = dom.content.querySelectorAll('.disclosure-control');
    toggles.forEach(btn => {
        btn.addEventListener('click', () => {
            const isExpanded = btn.getAttribute('aria-expanded') === 'true';
            const newState = !isExpanded;
            btn.setAttribute('aria-expanded', newState);
            
            const textSpan = btn.querySelector('.btn-text');
            if (textSpan) textSpan.textContent = newState ? 'Hide working' : 'Show working';
            
            const targetId = btn.getAttribute('aria-controls');
            const target = document.getElementById(targetId);
            if (target) {
                target.classList.toggle('expanded', newState);
            }
        });
    });
}

function closeDrawer() {
    dom.mobileDrawer.classList.remove('open');
    dom.drawerOverlay.style.display = 'none';
    document.body.style.overflow = '';
}

function openDrawer() {
    dom.mobileDrawer.classList.add('open');
    dom.drawerOverlay.style.display = 'block';
    document.body.style.overflow = 'hidden'; // Lock body scroll
}

dom.jumpBtn.addEventListener('click', openDrawer);
dom.closeBtn.addEventListener('click', closeDrawer);
dom.drawerOverlay.addEventListener('click', closeDrawer);

// ==========================================================================
// SCROLL SPY (Nav Active State)
// ==========================================================================

function updateActiveNav(id) {
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    document.querySelectorAll(`.nav-item[data-id="${id}"]`).forEach(el => el.classList.add('active'));
}

function setupScrollSpy() {
    // Basic IntersectionObserver for scrolling
    // We observe all question nodes
    const observer = new IntersectionObserver((entries) => {
        // Find the first intersecting entry from top
        const visible = entries.find(e => e.isIntersecting);
        if (visible) {
            updateActiveNav(visible.target.getAttribute('data-id'));
        }
    }, {
        rootMargin: '-10% 0px -80% 0px', // Trigger when near top
        threshold: 0
    });
    
    document.querySelectorAll('.question-node').forEach(node => observer.observe(node));
}

// ==========================================================================
// BOOT
// ==========================================================================
init();

</script>
</body>
</html>
