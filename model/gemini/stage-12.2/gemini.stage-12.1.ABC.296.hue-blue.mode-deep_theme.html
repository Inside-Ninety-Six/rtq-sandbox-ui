<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"ABC","indexWithinVariant":"296","totalWithinVariant":"320","hueFamily":"blue","intensityMode":"deep_theme","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-09T23:56:31.895Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;ABC&quot;,&quot;indexWithinVariant&quot;:&quot;296&quot;,&quot;totalWithinVariant&quot;:&quot;320&quot;,&quot;hueFamily&quot;:&quot;blue&quot;,&quot;intensityMode&quot;:&quot;deep_theme&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-09T23:56:31.895Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>

    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- KaTeX CSS & JS (CDN - No Integrity) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Markdown-it (CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <!-- Color Lab C: Deep Theme + Color Lab B: Blue (Hardcoded Configuration based on Add-ons) -->
    <style>
        :root {
            /* 
               COLOR LAB CONFIGURATION
               Hue: Blue (approx 264 in OKLCH)
               Mode: deep_theme (Light Only)
            */
            
            /* Surfaces - Deep Theme Bands: Page L[92-98] C[0.08-0.16], Frame L[90-96], Paper L[94-99] */
            --hue: 264;
            --color-page: 0.93 0.1 var(--hue);   /* Deep tinted background */
            --color-frame: 0.91 0.11 var(--hue); /* Slightly darker frame base */
            --color-paper: 0.96 0.08 var(--hue); /* Lightest content surface */
            
            /* Text - mostly neutral but tinted */
            --color-text-primary: 0.25 0.015 var(--hue);   /* L[0.15-0.25] */
            --color-text-secondary: 0.40 0.02 var(--hue);  /* L[0.25-0.40] */
            
            /* Accent - L[0.45-0.65] C[0.16-0.26] */
            --color-accent: 0.55 0.22 var(--hue);
            
            /* Wash Surfaces (Solution Details) */
            --color-wash: 0.95 0.07 var(--hue); 
            
            /* Borders/Dividers */
            --color-border: 0.85 0.02 var(--hue);

            /* Focus */
            --color-focus: 0.55 0.22 var(--hue);
        }

        /* Base utility mapping for Tailwind integration via CSS vars */
        body {
            background-color: oklch(var(--color-page));
            color: oklch(var(--color-text-primary));
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        /* Scrollbar hiding for Nav */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* KaTeX Containment Invariant */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding-bottom: 4px; /* Space for scrollbar if needed */
            margin-top: 0.5em;
            margin-bottom: 0.5em;
        }
        
        /* Deep theme surface classes */
        .bg-frame { background-color: oklch(var(--color-frame)); }
        .bg-paper { background-color: oklch(var(--color-paper)); }
        .bg-wash { background-color: oklch(var(--color-wash)); }
        .text-primary { color: oklch(var(--color-text-primary)); }
        .text-secondary { color: oklch(var(--color-text-secondary)); }
        .text-accent { color: oklch(var(--color-accent)); }
        .border-theme { border-color: oklch(var(--color-border)); }
        .ring-focus { outline-color: oklch(var(--color-focus)); }
        
        /* Focus styles */
        .focus-visible-ring:focus-visible {
            outline: 2px solid oklch(var(--color-focus));
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* Typography spacing helper */
        .prose-content p { margin-bottom: 0.75em; line-height: 1.6; }
        .prose-content p:last-child { margin-bottom: 0; }
        .prose-content ul { list-style-type: disc; padding-left: 1.2em; margin-bottom: 0.75em; }
        .prose-content ol { list-style-type: decimal; padding-left: 1.2em; margin-bottom: 0.75em; }
        
        /* Table styles per Stage 5.8.5 */
        .prose-content table { 
            width: 100%; 
            border-collapse: collapse; 
            font-size: 0.95em; 
            margin: 1em 0;
        }
        .prose-content th, .prose-content td { 
            border: 1px solid oklch(var(--color-border)); 
            padding: 0.5em; 
            text-align: left; 
        }
        .prose-content th { font-weight: 600; }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Managed via CSS vars above
                    }
                }
            }
        }
    </script>
</head>
<body class="min-h-screen flex flex-col items-center">

    <!-- STAGE 0 CONSTANTS (Authoritative) -->
    <script>
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";
    </script>

    <!-- Top Controls Region -->
    <header class="w-full max-w-[1200px] px-4 md:px-8 py-4 flex items-center justify-between shrink-0 z-20">
        <div class="flex items-center gap-4">
            <!-- Paper Selector -->
            <label for="paper-select" class="sr-only">Select Paper</label>
            <select id="paper-select" class="bg-paper border-theme border text-primary text-sm rounded px-3 py-2 focus-visible-ring">
                <option value="" disabled selected>Loading papers...</option>
            </select>
        </div>

        <!-- Mobile Jump To Trigger -->
        <button id="mobile-jump-trigger" class="md:hidden text-sm font-medium text-accent hover:underline focus-visible-ring px-2 py-1">
            Jump to
        </button>
    </header>

    <!-- DocumentFrameShell -->
    <div class="w-full max-w-[1200px] flex-1 flex flex-col md:flex-row bg-frame shadow-sm mx-auto mb-8 min-h-[80vh]">
        
        <!-- Desktop Navigation Rail (Sticky) -->
        <nav class="hidden md:block w-48 lg:w-56 shrink-0 border-r border-theme sticky top-0 h-screen overflow-y-auto no-scrollbar py-6 pl-4 pr-2">
            <div id="desktop-nav-list" class="flex flex-col gap-1">
                <!-- Nav Items injected here -->
            </div>
        </nav>

        <!-- Paper Document Column -->
        <main class="flex-1 min-w-0 bg-paper px-4 sm:px-8 md:px-12 py-8 md:py-12">
            <div id="paper-content" class="max-w-[800px] mx-auto space-y-12">
                <!-- Content injected here -->
                <div class="text-center text-secondary py-12">Select a paper to begin</div>
            </div>
        </main>
    </div>

    <!-- Mobile Navigation Drawer -->
    <div id="mobile-drawer-backdrop" class="fixed inset-0 bg-black/20 z-40 hidden" aria-hidden="true"></div>
    <div id="mobile-drawer" class="fixed inset-y-0 right-0 w-64 bg-paper z-50 transform translate-x-full transition-transform duration-200 ease-out shadow-xl flex flex-col" aria-hidden="true">
        <div class="p-4 border-b border-theme flex justify-between items-center bg-frame">
            <h2 class="text-sm font-bold text-primary">Jump to</h2>
            <button id="drawer-close" class="text-secondary hover:text-primary p-2 focus-visible-ring">
                <span class="sr-only">Close navigation</span>
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
        </div>
        <div class="flex-1 overflow-y-auto p-4">
            <div id="mobile-nav-list" class="flex flex-col gap-1">
                <!-- Nav Items injected here -->
            </div>
        </div>
    </div>

    <script>
        // --- Markdown renderer (authoritative config) ---
        const md = window.markdownit ? window.markdownit({
            html: true, // allow inline SVG and other inline HTML in payload Markdown
            linkify: true,
            breaks: false, // MUST stay false: prevents <br> inside $...$ / $$...$$
        }) : null;

        if (md) {
            // Preserve TeX backslashes
            md.inline.ruler.disable(['escape']);
        }

        // --- State ---
        let state = {
            papers: [],
            activePaperId: null,
            expandedNodes: new Set() // Tracks IDs of expanded solution details
        };

        // --- Elements ---
        const els = {
            select: document.getElementById('paper-select'),
            content: document.getElementById('paper-content'),
            desktopNav: document.getElementById('desktop-nav-list'),
            mobileNav: document.getElementById('mobile-nav-list'),
            mobileTrigger: document.getElementById('mobile-jump-trigger'),
            drawer: document.getElementById('mobile-drawer'),
            drawerBackdrop: document.getElementById('mobile-drawer-backdrop'),
            drawerClose: document.getElementById('drawer-close')
        };

        // --- Initialization ---
        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Payload not found");
                const payload = await response.json();
                
                state.papers = payload.papers || [];
                renderSelector();
                
                // Select first paper by default if available
                if (state.papers.length > 0) {
                    loadPaper(state.papers[0].key);
                } else {
                    renderError("No papers found in payload.");
                }

            } catch (e) {
                console.error(e);
                renderError("PAPERS PAYLOAD MISSING");
            }
        }

        function renderError(msg) {
            els.content.innerHTML = `<div class="p-4 text-red-600 font-mono text-sm border border-red-200 bg-red-50">${msg}</div>`;
            els.select.innerHTML = '<option disabled selected>Error</option>';
        }

        // --- Rendering Logic ---

        function renderSelector() {
            els.select.innerHTML = state.papers.map(p => 
                `<option value="${p.key}">${p.label}</option>`
            ).join('');
            els.select.value = "";
            els.select.addEventListener('change', (e) => loadPaper(e.target.value));
        }

        function loadPaper(key) {
            const paper = state.papers.find(p => p.key === key);
            if (!paper) return;

            state.activePaperId = key;
            
            // Handle defaults
            const expandAll = paper.defaults?.expandedAll !== false; // Default to true unless false
            state.expandedNodes.clear();
            
            // Helper to init default state
            function initDefaults(nodes) {
                if (!nodes) return;
                nodes.forEach(n => {
                    if (n.solutionBlock && n.solutionBlock.solutionDetails) {
                        if (expandAll) state.expandedNodes.add(n.id);
                    }
                    if (n.children) initDefaults(n.children);
                });
            }
            if (paper.questions) initDefaults(paper.questions);
            if (paper.sections) paper.sections.forEach(s => initDefaults(s.questions));

            renderPaperContent(paper);
            renderNavigation(paper);
            els.select.value = key;

            // Trigger KaTeX
            renderMathInElement(document.body, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false}
                ],
                throwOnError: false,
                trust: true // For inline HTML passthrough
            });
        }

        function renderPaperContent(paper) {
            let html = '';

            // Sectioned vs Flat
            if (paper.sections) {
                paper.sections.forEach(section => {
                    if (section.label && section.label.trim().length > 0) {
                        // Section Header
                        html += `
                            <div class="pb-4 mb-8 border-b border-theme border-opacity-30">
                                <h2 class="text-xl font-bold text-primary opacity-80">${section.label}</h2>
                            </div>
                        `;
                    }
                    html += renderQuestionList(section.questions);
                });
            } else {
                html += renderQuestionList(paper.questions);
            }
            
            els.content.innerHTML = html;
            attachEventHandlers();
        }

        function renderQuestionList(questions) {
            if (!questions) return '';
            return `<div class="space-y-12">
                ${questions.map(q => renderQuestionNode(q, 0)).join('')}
            </div>`;
        }

        function renderQuestionNode(node, depth) {
            // Determine structure
            const hasSolution = !!node.solutionBlock;
            const hasAnswer = hasSolution && !!node.solutionBlock.answer;
            const hasDetails = hasSolution && !!node.solutionBlock.solutionDetails;
            const isExpanded = state.expandedNodes.has(node.id);

            // Indentation (only recursive spacing, no visual container)
            // Stage 3 constraint: Sub-questions use children container vertical separation
            // We'll handle recursion in the children block.

            // Render content through Markdown
            const qBody = md ? md.render(node.question) : node.question;

            // Build Solution Block HTML
            let solutionBlockHtml = '';
            if (hasSolution) {
                // Answer
                let answerHtml = '';
                if (hasAnswer) {
                    const ansBody = md ? md.render(node.solutionBlock.answer) : node.solutionBlock.answer;
                    answerHtml = `
                        <div class="mt-4 mb-2">
                            <span class="text-xs font-bold text-secondary uppercase tracking-wider block mb-1">Answer</span>
                            <div class="text-primary prose-content">${ansBody}</div>
                        </div>
                    `;
                }

                // Details
                let detailsHtml = '';
                if (hasDetails) {
                    const btnLabel = isExpanded ? "Hide working" : "Show working";
                    const chevron = isExpanded 
                        ? `<svg class="w-4 h-4 ml-1 transform rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>`
                        : `<svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>`;
                    
                    const details = node.solutionBlock.solutionDetails;
                    
                    let expandedContent = '';
                    if (isExpanded) {
                        // Subsections: Keep in mind -> Formulas -> Working -> Alt
                        // Keep in mind
                        if (details.keepInMind) {
                            expandedContent += `
                                <div class="mb-6">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="text-xs font-bold text-secondary">Keep in mind</span>
                                    </div>
                                    <div class="text-sm text-secondary prose-content">${md ? md.render(details.keepInMind) : details.keepInMind}</div>
                                </div>
                            `;
                        }
                        // Formulas
                        if (details.formulasUsed) {
                            expandedContent += `
                                <div class="mb-6">
                                    <span class="text-xs font-bold text-secondary block mb-1">Formulas used</span>
                                    <div class="text-sm text-secondary prose-content">${md ? md.render(details.formulasUsed) : details.formulasUsed}</div>
                                </div>
                            `;
                        }
                        // Working
                        if (details.working) {
                            expandedContent += `
                                <div class="mb-6">
                                    <span class="text-xs font-bold text-secondary block mb-1">Working</span>
                                    <div class="text-base text-secondary prose-content">${md ? md.render(details.working) : details.working}</div>
                                </div>
                            `;
                        }
                        // Alt Working
                        if (details.alternativeWorking && Array.isArray(details.alternativeWorking)) {
                            details.alternativeWorking.forEach((alt, idx) => {
                                expandedContent += `
                                    <div class="mt-6 pt-4 border-t border-theme border-dashed">
                                        <span class="text-xs font-bold text-secondary block mb-1">Alternative working</span>
                                        <div class="text-base text-secondary prose-content">${md ? md.render(alt) : alt}</div>
                                    </div>
                                `;
                            });
                        }

                        expandedContent = `
                            <div class="mt-4 pt-4 bg-wash rounded-sm px-4 py-4 border-l-2 border-theme animate-fade-in">
                                ${expandedContent}
                            </div>
                        `;
                    }

                    detailsHtml = `
                        <div class="mt-4">
                            <button data-id="${node.id}" class="toggle-working flex items-center text-sm font-medium text-accent hover:underline focus-visible-ring">
                                ${btnLabel} ${chevron}
                            </button>
                            ${expandedContent}
                        </div>
                    `;
                }

                if (answerHtml || detailsHtml) {
                    solutionBlockHtml = `
                        <div class="mt-4 pl-0">
                            ${answerHtml}
                            ${detailsHtml}
                        </div>
                    `;
                }
            }

            // Children
            let childrenHtml = '';
            if (node.children && node.children.length > 0) {
                // Indentation logic via spacing/margin, avoiding heavy nesting visuals
                childrenHtml = `
                    <div class="mt-6 ml-0 pl-4 border-l border-theme border-opacity-0 hover:border-opacity-0 transition-colors"> 
                        <div class="space-y-6">
                            ${node.children.map(c => renderQuestionNode(c, depth + 1)).join('')}
                        </div>
                    </div>
                `;
            }

            // Top-level spacing vs child spacing
            const containerClass = depth === 0 ? "py-4" : "";

            return `
                <div id="q-${node.id}" class="${containerClass} scroll-mt-24">
                    <!-- Question Body -->
                    <div class="flex gap-3">
                        <div class="shrink-0 w-8 text-secondary font-medium text-sm pt-1 select-none">${node.id}</div>
                        <div class="flex-1 min-w-0">
                            <div class="text-primary text-lg prose-content">${qBody}</div>
                            ${solutionBlockHtml}
                        </div>
                    </div>
                    ${childrenHtml}
                </div>
            `;
        }

        function renderNavigation(paper) {
            const buildList = () => {
                let html = '';
                const renderItem = (id, depth) => {
                    // Visual hierarchy via font size/color, flat alignment
                    const sizeClass = depth === 0 ? "text-sm" : "text-xs";
                    const colorClass = depth === 0 ? "text-primary opacity-90" : "text-secondary opacity-80";
                    return `
                        <a href="#q-${id}" class="block py-1 pl-0 hover:text-accent hover:underline transition-colors ${sizeClass} ${colorClass} focus-visible-ring rounded-sm">
                            ${id}
                        </a>
                    `;
                };

                const traverse = (nodes, depth) => {
                    nodes.forEach(n => {
                        html += renderItem(n.id, depth);
                        if (n.children) traverse(n.children, depth + 1);
                    });
                };

                if (paper.sections) {
                    paper.sections.forEach(s => {
                        if (s.label && s.label.trim()) {
                            html += `<div class="mt-4 mb-2 text-xs font-bold text-secondary uppercase tracking-widest opacity-50 select-none">${s.label}</div>`;
                        }
                        traverse(s.questions, 0);
                        // Add spacing separator between sections
                        html += `<div class="h-2"></div>`;
                    });
                } else {
                    traverse(paper.questions, 0);
                }
                return html;
            };

            const navHtml = buildList();
            els.desktopNav.innerHTML = navHtml;
            els.mobileNav.innerHTML = navHtml;

            // Handle anchor clicks for smooth scroll + mobile drawer close
            const handleNavClick = (e) => {
                const link = e.target.closest('a');
                if (link) {
                    e.preventDefault();
                    const targetId = link.getAttribute('href').substring(1);
                    const targetEl = document.getElementById(targetId);
                    if (targetEl) {
                        targetEl.scrollIntoView({ behavior: 'smooth' });
                        closeDrawer();
                        
                        // Set basic active state indication (weight only, no color spam)
                        document.querySelectorAll('nav a, #mobile-nav-list a').forEach(a => a.classList.remove('font-bold'));
                        link.classList.add('font-bold');
                        // Mirror to other nav
                        const mirrorLink = document.querySelector(`a[href="#${targetId}"]`);
                        if (mirrorLink) mirrorLink.classList.add('font-bold');
                    }
                }
            };

            els.desktopNav.addEventListener('click', handleNavClick);
            els.mobileNav.addEventListener('click', handleNavClick);
        }

        function attachEventHandlers() {
            // Toggle Logic
            document.querySelectorAll('.toggle-working').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = btn.getAttribute('data-id');
                    if (state.expandedNodes.has(id)) {
                        state.expandedNodes.delete(id);
                    } else {
                        state.expandedNodes.add(id);
                    }
                    // Re-render just this paper to reflect state
                    // Optimisation: ideally we'd just re-render the node, but for this prototype, re-rendering full paper is safer for structure
                    // To maintain scroll position, we rely on the browser's behavior or re-render
                    // Since re-rendering destroys DOM, we lose scroll. Let's do a smart replace or just re-render content.
                    // For prototype simplicity/robustness: re-render full paper content, then restore scroll?
                    // Better: find the node in DOM and swap it? 
                    // Let's settle on full re-render for now, it's fast enough for text.
                    const currentScroll = window.scrollY;
                    const paper = state.papers.find(p => p.key === state.activePaperId);
                    renderPaperContent(paper);
                    renderMathInElement(document.body, {
                         delimiters: [
                            {left: '$$', right: '$$', display: true},
                            {left: '$', right: '$', display: false}
                        ],
                        trust: true
                    });
                    // Restore scroll approximately? Or just let it jump?
                    // Stage 5.5.3 says "Expand/collapse ... must use short, restrained transitions".
                    // Re-rendering breaks transitions. 
                    // Let's implement partial re-render if possible.
                    // Actually, let's just re-render the specific question node wrapper.
                    const wrapper = document.getElementById(`q-${id}`);
                    // Find node data
                    const findNode = (nodes) => {
                        for (let n of nodes) {
                            if (n.id === id) return n;
                            if (n.children) {
                                const res = findNode(n.children);
                                if (res) return res;
                            }
                        }
                        return null;
                    }
                    // We need to look in sections too
                    let targetNode = null;
                    if (paper.questions) targetNode = findNode(paper.questions);
                    if (paper.sections && !targetNode) {
                        for (let s of paper.sections) {
                            targetNode = findNode(s.questions);
                            if (targetNode) break;
                        }
                    }
                    
                    if (targetNode && wrapper) {
                        // Determine depth by counting parents? Or just grab from existing DOM structure?
                        // Let's re-render the whole paper to be safe about state consistency, 
                        // scroll restoration is the main issue.
                        renderPaperContent(paper);
                        window.scrollTo(0, currentScroll);
                        renderMathInElement(document.body, {
                             delimiters: [
                                {left: '$$', right: '$$', display: true},
                                {left: '$', right: '$', display: false}
                            ],
                            trust: true
                        });
                    }
                });
            });
        }

        // --- Drawer Logic ---
        function openDrawer() {
            els.drawer.classList.remove('translate-x-full');
            els.drawerBackdrop.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeDrawer() {
            els.drawer.classList.add('translate-x-full');
            els.drawerBackdrop.classList.add('hidden');
            document.body.style.overflow = '';
        }

        els.mobileTrigger.addEventListener('click', openDrawer);
        els.drawerClose.addEventListener('click', closeDrawer);
        els.drawerBackdrop.addEventListener('click', closeDrawer);

        // --- Start ---
        init();

    </script>
</body>
</html>
