<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"ABC","indexWithinVariant":"238","totalWithinVariant":"320","hueFamily":"red","intensityMode":"tinted_neutrals","primaryHueFamily":"","secondaryHueFamily":"","dualIntensityMode":"","timestamp":"2026-01-09T21:29:03.848Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;ABC&quot;,&quot;indexWithinVariant&quot;:&quot;238&quot;,&quot;totalWithinVariant&quot;:&quot;320&quot;,&quot;hueFamily&quot;:&quot;red&quot;,&quot;intensityMode&quot;:&quot;tinted_neutrals&quot;,&quot;primaryHueFamily&quot;:&quot;&quot;,&quot;secondaryHueFamily&quot;:&quot;&quot;,&quot;dualIntensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-09T21:29:03.848Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>

    <!-- FONTS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- KaTeX CSS (No Integrity/SRI per instructions) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <!-- CSS: ColorLab C (Tinted Neutrals, Teal Hue) & Layout -->
    <style>
        :root {
            /* 
               COLORLAB C: TINTED_NEUTRALS (Teal Hue Family ~175)
               Rules:
               - Core surfaces C in [0.015 .. 0.035]
               - Wash surfaces C in [0.025 .. 0.045]
               - Text primary C <= 0.010
               - Text secondary C <= 0.012
               - Accent C in [0.10 .. 0.16]
            */
            --hue: 175;
            
            --color-page-bg: oklch(0.98 0.02 var(--hue));
            --color-frame-bg: oklch(0.98 0.02 var(--hue)); /* Nav shares this */
            --color-paper-surface: oklch(0.995 0.015 var(--hue));
            
            --color-text-primary: oklch(0.20 0.01 var(--hue));
            --color-text-secondary: oklch(0.45 0.012 var(--hue));
            --color-text-quiet: oklch(0.60 0.012 var(--hue));

            --color-accent: oklch(0.50 0.13 var(--hue)); /* Links, Focus, Active Nav */
            --color-accent-hover: oklch(0.45 0.13 var(--hue));

            --color-border-subtle: oklch(0.92 0.02 var(--hue));
            --color-divider: oklch(0.94 0.02 var(--hue));

            --color-sd-wash: oklch(0.965 0.03 var(--hue)); /* Solution Details Wash */
            
            /* Spacing & Layout Constants */
            --space-xs: 0.25rem;
            --space-s: 0.5rem;
            --space-m: 1rem;
            --space-l: 1.5rem;
            --space-xl: 2.5rem; /* Top level question separation */
            
            --font-family: 'Inter', system-ui, sans-serif;
            --max-width-paper: 800px;
            --nav-width: 240px;
        }

        /* RESET & BASE */
        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: var(--font-family);
            background-color: var(--color-page-bg);
            color: var(--color-text-primary);
            -webkit-font-smoothing: antialiased;
            overflow-y: scroll; /* Force vertical scrollbar to prevent shift */
        }

        button {
            font-family: inherit;
            border: none;
            background: none;
            cursor: pointer;
            padding: 0;
            margin: 0;
        }

        a {
            color: var(--color-accent);
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }

        /* UTILITIES */
        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0;
        }

        /* LAYOUT: DocumentFrameShell */
        .doc-shell {
            max-width: 1200px;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: var(--color-frame-bg);
        }

        /* TOP CONTROLS */
        .top-controls {
            padding: var(--space-m);
            border-bottom: 1px solid var(--color-divider);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 50;
            background-color: var(--color-frame-bg); /* Match shell */
        }

        .paper-selector {
            font-size: 0.9rem;
            padding: var(--space-s);
            border: 1px solid var(--color-border-subtle);
            border-radius: 4px;
            color: var(--color-text-primary);
            background: var(--color-paper-surface);
        }

        .jump-to-trigger {
            display: none; /* Desktop default */
            font-size: 0.9rem;
            color: var(--color-accent);
            font-weight: 500;
        }

        /* MAIN CONTENT COLUMNS */
        .content-columns {
            display: flex;
            flex: 1;
            position: relative;
        }

        /* NAV RAIL (Desktop) */
        .nav-rail {
            width: var(--nav-width);
            flex-shrink: 0;
            padding: var(--space-l) var(--space-m);
            position: sticky;
            top: 60px; /* Offset for top controls */
            height: calc(100vh - 60px);
            overflow-y: auto;
            /* Hide Scrollbar */
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .nav-rail::-webkit-scrollbar {
            display: none;
        }

        /* PAPER REGION */
        .paper-column {
            flex: 1;
            padding: var(--space-l) var(--space-m) 100px var(--space-m);
            max-width: var(--max-width-paper);
            /* Center visual dominance but keep left-aligned to nav conceptually */
        }

        /* PAPER SURFACE */
        .paper-surface {
            background-color: var(--color-paper-surface);
            min-height: 50vh;
            /* No card chrome: subtle, paper-like */
        }

        /* NAVIGATION LIST STYLES */
        .nav-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .nav-section-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--color-text-quiet);
            margin-top: var(--space-m);
            margin-bottom: var(--space-s);
            font-weight: 600;
            pointer-events: none;
        }

        .nav-item {
            display: block;
            padding: 2px 0;
            color: var(--color-text-secondary);
            font-size: 0.9rem;
            cursor: pointer;
            transition: color 0.1s ease;
        }
        
        .nav-item:hover {
            color: var(--color-text-primary);
        }

        .nav-item.active {
            font-weight: 600;
            color: var(--color-accent); /* Permitted override Stage 5.4.3 */
        }

        /* Nav Hierarchy via type scale only (Stage 5.4.5) */
        .nav-item[data-depth="0"] { font-size: 0.95rem; }
        .nav-item[data-depth="1"] { font-size: 0.85rem; }
        .nav-item[data-depth="2"] { font-size: 0.80rem; }
        
        /* Flattened visual list - same left edge */
        .nav-item { padding-left: 0; }


        /* QUESTION NODES */
        .question-node {
            margin-bottom: var(--space-m);
        }

        .question-node.top-level {
            margin-bottom: var(--space-xl);
            /* Stage 3 C: Spacing is primary top-level separator. */
        }

        .question-body {
            display: flex;
            gap: var(--space-s);
            align-items: baseline;
            margin-bottom: var(--space-s);
        }

        .q-identifier {
            font-weight: 600;
            color: var(--color-text-secondary);
            flex-shrink: 0;
            min-width: 1.5rem;
        }

        .q-prompt {
            color: var(--color-text-primary);
            line-height: 1.6;
            font-size: 1.05rem;
        }

        /* SOLUTION BLOCK */
        .solution-block {
            margin-left: 0; /* Keep aligned with prompt or slightly indented? 
                             Brief 5.6.2 says "direct continuation". 
                             Usually indentation helps associate with parent. 
                             Let's keep flush to body text or slight indent.
                             We'll use slight padding-left to match text start. */
            padding-left: 0; 
            margin-top: var(--space-s);
        }

        /* ANSWER */
        .answer-region {
            margin-bottom: var(--space-s);
            display: flex;
            gap: var(--space-s);
            align-items: baseline;
        }
        .answer-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--color-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }
        .answer-content {
            font-weight: 500;
            color: var(--color-text-primary);
        }

        /* DISCLOSURE CONTROL */
        .disclosure-control {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            font-size: 0.9rem;
            color: var(--color-accent);
            font-weight: 500;
            margin-bottom: var(--space-s);
            padding: var(--space-xs) 0;
            transition: opacity 0.2s;
        }
        .disclosure-control:hover {
            color: var(--color-accent-hover);
            text-decoration: underline;
        }
        .chevron {
            width: 16px;
            height: 16px;
            transition: transform 0.2s;
            fill: currentColor;
        }
        .expanded .chevron {
            transform: rotate(180deg);
        }

        /* SOLUTION DETAILS REGION */
        .solution-details {
            display: none;
            background-color: var(--color-sd-wash);
            padding: var(--space-m);
            border-radius: 4px; /* Permitted minor radius, no heavy card look */
            margin-top: var(--space-xs);
        }
        .solution-details.open {
            display: block;
            animation: fadeIn 0.2s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-4px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .sd-subsection {
            margin-bottom: var(--space-m);
        }
        .sd-subsection:last-child {
            margin-bottom: 0;
        }

        .sd-label {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--color-text-secondary);
            margin-bottom: var(--space-xs);
            display: block;
        }
        .sd-body {
            font-size: 0.95rem;
            line-height: 1.55;
            color: var(--color-text-primary); /* Anti-faded rule */
        }
        
        /* Markdown Content Styling */
        .markdown-content p { margin: 0 0 0.75em 0; }
        .markdown-content p:last-child { margin-bottom: 0; }
        .markdown-content ul, .markdown-content ol { margin: 0.5em 0; padding-left: 1.5em; }
        .markdown-content li { margin-bottom: 0.25em; }
        
        /* Tables (Minimal) */
        .markdown-content table {
            border-collapse: collapse;
            width: 100%;
            margin: var(--space-s) 0;
            font-size: 0.9rem;
        }
        .markdown-content th, .markdown-content td {
            border: 1px solid var(--color-border-subtle);
            padding: var(--space-s);
            text-align: left;
        }
        .markdown-content th {
            font-weight: 600;
            background-color: rgba(0,0,0,0.02);
        }

        /* CHILDREN CONTAINER */
        .children-container {
            margin-top: var(--space-m);
            padding-left: 0; /* Flat align? Or indent? Brief: "subtle indentation" allowed */
            margin-left: var(--space-m); /* Indent for hierarchy */
            border-left: 1px solid transparent; /* Placeholder for alignment */
        }

        /* MOBILE DRAWER */
        .drawer-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4);
            z-index: 100;
            display: none;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .drawer {
            position: fixed;
            top: 0; right: 0; bottom: 0;
            width: 280px;
            background: var(--color-frame-bg);
            z-index: 101;
            transform: translateX(100%);
            transition: transform 0.25s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex;
            flex-direction: column;
            box-shadow: -4px 0 12px rgba(0,0,0,0.1);
        }
        .drawer-header {
            padding: var(--space-m);
            border-bottom: 1px solid var(--color-divider);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .drawer-title { font-weight: 600; }
        .drawer-close { font-size: 1.5rem; line-height: 1; color: var(--color-text-secondary); }
        .drawer-content { overflow-y: auto; padding: var(--space-m); flex: 1; }
        
        .drawer-open .drawer-overlay { display: block; opacity: 1; }
        .drawer-open .drawer { transform: translateX(0); }

        /* KaTeX Containment & Styles */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            padding: 0.5em 0;
            margin: 0.5em 0;
            max-width: 100%;
            /* Block math underlay permitted by Stage 3 */
            background-color: rgba(0,0,0,0.015);
            border-radius: 4px;
        }
        /* Inline math: no background */
        .katex { font-size: 1.1em; } 

        /* Error / Empty State */
        .error-state {
            padding: var(--space-xl);
            text-align: center;
            color: var(--color-text-secondary);
            font-weight: 600;
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .nav-rail { display: none; }
            .jump-to-trigger { display: block; }
            .paper-column { padding-left: var(--space-m); padding-right: var(--space-m); }
            .children-container { margin-left: var(--space-s); } /* Less indent on mobile */
        }
    </style>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
</head>
<body>

<!-- RUNTIME CONSTANTS -->
<script>
    const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
    const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";
</script>

<!-- APP MOUNT -->
<div id="app" class="doc-shell">
    <div class="top-controls">
        <select id="paper-select" class="paper-selector" aria-label="Select paper">
            <option>Loading...</option>
        </select>
        <button id="jump-to-btn" class="jump-to-trigger" aria-label="Jump to question">Jump to</button>
    </div>

    <div class="content-columns">
        <nav class="nav-rail" aria-label="Document navigation">
            <ul id="nav-list" class="nav-list"></ul>
        </nav>

        <main class="paper-column">
            <div id="paper-content" class="paper-surface">
                <!-- Content injected here -->
            </div>
        </main>
    </div>
</div>

<!-- MOBILE DRAWER -->
<div id="drawer-overlay" class="drawer-overlay"></div>
<div id="drawer" class="drawer" aria-hidden="true">
    <div class="drawer-header">
        <span class="drawer-title">Jump to</span>
        <button id="drawer-close" class="drawer-close" aria-label="Close navigation">&times;</button>
    </div>
    <div class="drawer-content">
        <ul id="drawer-nav-list" class="nav-list"></ul>
    </div>
</div>

<script>
    // --- Markdown renderer (authoritative config) ---
    const md = window.markdownit
      ? window.markdownit({
          html: true, // allow inline SVG and other inline HTML in payload Markdown
          linkify: true,
          breaks: false, // MUST stay false: prevents <br> inside $...$ / $$...$$
        })
      : null;

    if (md) {
      // Preserve TeX backslashes: do not let markdown-it escape them before KaTeX runs
      md.inline.ruler.disable(["escape"]);
    }

    // STATE
    let payload = null;
    let currentPaperId = null;
    let expandedSolutionDetails = new Set(); // Stores question IDs where SD is open

    // DOM ELEMENTS
    const paperSelect = document.getElementById('paper-select');
    const paperContent = document.getElementById('paper-content');
    const navList = document.getElementById('nav-list');
    const drawerNavList = document.getElementById('drawer-nav-list');
    const jumpToBtn = document.getElementById('jump-to-btn');
    const drawerOverlay = document.getElementById('drawer-overlay');
    const drawer = document.getElementById('drawer');
    const drawerClose = document.getElementById('drawer-close');

    // INITIALIZATION
    async function init() {
        try {
            const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
            if (!response.ok) throw new Error('Fetch failed');
            payload = await response.json();
            
            if (!payload.papers || payload.papers.length === 0) throw new Error('Invalid payload');
            
            setupSelector();
            // Default to first paper
            switchPaper(payload.papers[0].key);
        } catch (e) {
            console.error(e);
            renderError();
        }
    }

    function renderError() {
        paperContent.innerHTML = '<div class="error-state">PAPERS PAYLOAD MISSING</div>';
        paperSelect.innerHTML = '<option>Error</option>';
        paperSelect.disabled = true;
    }

    function setupSelector() {
        paperSelect.innerHTML = '';
        payload.papers.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.key;
            opt.textContent = p.label || p.key;
            paperSelect.appendChild(opt);
        });

        paperSelect.addEventListener('change', (e) => {
            switchPaper(e.target.value);
        });
    }

    function switchPaper(key) {
        currentPaperId = key;
        const paper = payload.papers.find(p => p.key === key);
        if (!paper) return;

        // Reset Expansion state based on paper default
        const defaultExpand = paper.defaults?.expandedAll !== false;
        // Logic: We don't know all question IDs upfront easily without walking. 
        // We will handle "default state" during render. 
        // If the user hasn't interacted, we use default. 
        // But to support interaction persistence per session, we track "toggled" logic?
        // Brief: "Switching papers must hide/show content... Switching papers must NOT auto-expand beyond paper defaults"
        // Simplest: Clear interaction state on paper switch.
        expandedSolutionDetails.clear();
        if (defaultExpand) {
            // We use a special marker or logic. 
            // Better: during render, if ID not in Set and default=true, treat as expanded. 
            // But we need to support collapsing.
            // Let's store "collapsed" set if default is expanded, or "expanded" set if default is collapsed.
            // To simplify: we will use a property `expansionMode` = 'default-open' or 'default-closed'.
            // And a Map for overrides. 
        }
        // Actually, let's just use the render logic to set initial classes.
        // We'll set a global flag for the current paper's default.
        window.paperDefaultExpanded = (paper.defaults?.expandedAll !== false);
        window.userToggleState = new Map(); // id -> boolean (true=open, false=closed)

        renderPaper(paper);
        renderNavigation(paper);
        
        // Render Math
        if (window.renderMathInElement) {
            renderMathInElement(paperContent, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false}
                ],
                throwOnError: false
            });
        }
    }

    // --- RENDER LOGIC ---

    function renderPaper(paper) {
        paperContent.innerHTML = '';
        
        // If sectioned
        if (paper.sections) {
            paper.sections.forEach(section => {
                // Section Header
                if (section.label && section.label.trim().length > 0) {
                    const secHeader = document.createElement('div');
                    secHeader.className = 'nav-section-label'; // Re-use style style or create new?
                    // Brief 3: Paper surface -> section header (structural divider)
                    secHeader.style.cssText = `
                        font-weight: 600; 
                        color: var(--color-text-primary);
                        border-bottom: 1px solid var(--color-divider);
                        padding-bottom: var(--space-s);
                        margin-top: var(--space-xl);
                        margin-bottom: var(--space-m);
                    `;
                    secHeader.textContent = section.label;
                    paperContent.appendChild(secHeader);
                }
                
                // Question List
                if (section.questions) {
                    section.questions.forEach(q => {
                        paperContent.appendChild(renderQuestionNode(q, 0, true));
                    });
                }
            });
        } else if (paper.questions) {
            // Flat paper
            paper.questions.forEach(q => {
                paperContent.appendChild(renderQuestionNode(q, 0, true));
            });
        }
    }

    function renderQuestionNode(node, depth, isTopLevel) {
        const container = document.createElement('div');
        container.className = `question-node ${isTopLevel ? 'top-level' : ''}`;
        container.id = `q-${node.id}`; // Anchor target

        // 1. Question Body
        const qBody = document.createElement('div');
        qBody.className = 'question-body';
        
        const qId = document.createElement('div');
        qId.className = 'q-identifier';
        qId.textContent = node.id;
        
        const qPrompt = document.createElement('div');
        qPrompt.className = 'q-prompt markdown-content';
        qPrompt.innerHTML = md ? md.render(node.question || '') : (node.question || '');

        qBody.appendChild(qId);
        qBody.appendChild(qPrompt);
        container.appendChild(qBody);

        // 2. Solution Block (Optional)
        if (node.solutionBlock) {
            const solBlock = document.createElement('div');
            solBlock.className = 'solution-block';

            // Answer
            if (node.solutionBlock.answer) {
                const ansRegion = document.createElement('div');
                ansRegion.className = 'answer-region';
                
                const ansLabel = document.createElement('div');
                ansLabel.className = 'answer-label';
                ansLabel.textContent = 'Answer';
                
                const ansContent = document.createElement('div');
                ansContent.className = 'answer-content markdown-content';
                ansContent.innerHTML = md ? md.render(node.solutionBlock.answer) : node.solutionBlock.answer;

                ansRegion.appendChild(ansLabel);
                ansRegion.appendChild(ansContent);
                solBlock.appendChild(ansRegion);
            }

            // Solution Details
            if (node.solutionBlock.solutionDetails) {
                const sd = node.solutionBlock.solutionDetails;
                
                // Determine State
                let isOpen = window.paperDefaultExpanded;
                if (window.userToggleState.has(node.id)) {
                    isOpen = window.userToggleState.get(node.id);
                }

                // Disclosure Control
                const control = document.createElement('button');
                control.className = `disclosure-control ${isOpen ? 'expanded' : ''}`;
                control.setAttribute('aria-expanded', isOpen);
                control.innerHTML = `
                    <span>${isOpen ? 'Hide working' : 'Show working'}</span>
                    <svg class="chevron" viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>
                `;
                
                // SD Container
                const detailsRegion = document.createElement('div');
                detailsRegion.className = `solution-details ${isOpen ? 'open' : ''}`;
                
                // Toggle Logic
                control.onclick = () => {
                    const newState = !detailsRegion.classList.contains('open');
                    if (newState) {
                        detailsRegion.classList.add('open');
                        control.classList.add('expanded');
                        control.querySelector('span').textContent = 'Hide working';
                    } else {
                        detailsRegion.classList.remove('open');
                        control.classList.remove('expanded');
                        control.querySelector('span').textContent = 'Show working';
                    }
                    control.setAttribute('aria-expanded', newState);
                    window.userToggleState.set(node.id, newState);
                };

                // SD Content Parts
                const renderPart = (label, content, isList = false) => {
                    if (!content) return null;
                    const wrapper = document.createElement('div');
                    wrapper.className = 'sd-subsection';
                    
                    const lbl = document.createElement('div');
                    lbl.className = 'sd-label';
                    lbl.textContent = label;
                    
                    const body = document.createElement('div');
                    body.className = 'sd-body markdown-content';
                    body.innerHTML = md ? md.render(content) : content;

                    wrapper.appendChild(lbl);
                    wrapper.appendChild(body);
                    return wrapper;
                };

                // Keep in mind
                if (sd.keepInMind) detailsRegion.appendChild(renderPart('Keep in mind', sd.keepInMind));
                // Formulas
                if (sd.formulasUsed) detailsRegion.appendChild(renderPart('Formulas used', sd.formulasUsed));
                // Working
                if (sd.working) detailsRegion.appendChild(renderPart('Working', sd.working));
                // Alt Workings
                if (sd.alternativeWorking && Array.isArray(sd.alternativeWorking)) {
                    sd.alternativeWorking.forEach(alt => {
                        detailsRegion.appendChild(renderPart('Alternative working', alt));
                    });
                }

                solBlock.appendChild(control);
                solBlock.appendChild(detailsRegion);
            }

            container.appendChild(solBlock);
        }

        // 3. Children
        if (node.children && node.children.length > 0) {
            const childrenCont = document.createElement('div');
            childrenCont.className = 'children-container';
            node.children.forEach(child => {
                childrenCont.appendChild(renderQuestionNode(child, depth + 1, false));
            });
            container.appendChild(childrenCont);
        }

        return container;
    }

    // --- NAV LOGIC ---

    function renderNavigation(paper) {
        // We need to flatten the structure for the Nav
        // Logic: Iterate sections (if any) or questions. 
        // Create <li> items. 
        // Handles "Section Label" as separator.
        
        const buildNavItems = (targetList) => {
            targetList.innerHTML = '';
            
            const addLink = (id, label, depth) => {
                const li = document.createElement('li');
                const a = document.createElement('a');
                a.className = 'nav-item';
                a.dataset.depth = Math.min(depth, 2); // Cap styling depth
                a.textContent = label; // Just ID
                a.onclick = (e) => {
                    e.preventDefault();
                    // Scroll to ID
                    const el = document.getElementById(`q-${id}`);
                    if (el) {
                        el.scrollIntoView({behavior: 'smooth', block: 'start'});
                        // Close drawer on mobile
                        closeDrawer();
                        // Set active state visually (simple version)
                        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                        a.classList.add('active');
                    }
                };
                li.appendChild(a);
                targetList.appendChild(li);
            };

            const addSectionLabel = (label) => {
                const li = document.createElement('li');
                li.className = 'nav-section-label';
                li.textContent = label;
                targetList.appendChild(li);
            };

            const traverse = (nodes, depth) => {
                nodes.forEach(node => {
                    addLink(node.id, node.id, depth);
                    if (node.children) traverse(node.children, depth + 1);
                });
            };

            if (paper.sections) {
                paper.sections.forEach(sec => {
                    if (sec.label && sec.label.trim().length > 0) {
                        addSectionLabel(sec.label);
                    }
                    if (sec.questions) traverse(sec.questions, 0);
                });
            } else if (paper.questions) {
                traverse(paper.questions, 0);
            }
        };

        buildNavItems(navList);
        buildNavItems(drawerNavList);
        
        // Setup Intersection Observer for Active State (Bonus/Polish)
        setupObserver();
    }

    function setupObserver() {
        const observer = new IntersectionObserver((entries) => {
            // Find visible question
            // Logic: take the first one intersecting above 50% or near top
            // Simple: just highlight visible ones.
            // For a robust single active item:
            let activeId = null;
            entries.forEach(e => {
                if (e.isIntersecting) {
                    activeId = e.target.id.replace('q-', '');
                }
            });
            
            if (activeId) {
                document.querySelectorAll('.nav-item').forEach(i => {
                    if (i.textContent === activeId) i.classList.add('active');
                    else i.classList.remove('active');
                });
            }
        }, { threshold: 0.1, rootMargin: "-10% 0px -80% 0px" });

        document.querySelectorAll('.question-node').forEach(n => observer.observe(n));
    }

    // --- DRAWER LOGIC ---
    function openDrawer() {
        drawer.setAttribute('aria-hidden', 'false');
        document.body.classList.add('drawer-open');
    }
    function closeDrawer() {
        drawer.setAttribute('aria-hidden', 'true');
        document.body.classList.remove('drawer-open');
    }

    jumpToBtn.addEventListener('click', openDrawer);
    drawerClose.addEventListener('click', closeDrawer);
    drawerOverlay.addEventListener('click', closeDrawer);

    // Boot
    init();

</script>
</body>
</html>
