<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <style>
        /* =========================================
           STAGE 0-5: DESIGN SYSTEM & RESETS
           ========================================= */
        :root {
            /* Stage 5.3: Colour Semantics (Soft-Warm Neutral Base)
               Stage 5.3.2 Override: Single Restrained Accent
            */
            --c-bg-page: #F9F9F8;
            /* Soft warm neutral */
            --c-bg-paper: #FFFFFF;
            --c-text-primary: #1A1A1A;
            /* Question text */
            --c-text-secondary: #555555;
            /* Answer, Details */
            --c-text-tertiary: #757575;
            /* Labels, Metadata */
            --c-text-quiet: #909090;
            /* Navigation inactive */

            --c-line-hairline: #EAEAEA;
            --c-line-divider: #E0E0E0;

            /* Accent: Restrained Blue (Links, Focus, Active Nav Only) */
            --c-accent: #2D5B8E;

            /* Stage 3/5 Override: Display Math Underlay (Subtle) */
            --c-math-underlay: #F4F4F4;

            /* Spacing Rhythm */
            --s-unit: 8px;
            --s-nav-width: 240px;
            --s-content-width: 720px;
            /* Wide, readable */

            /* Typography */
            --f-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --f-size-base: 16px;
            --f-size-nav: 14px;
            --f-size-sm: 13px;

            /* Transitions */
            --t-fast: 0.2s ease;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--c-bg-page);
            font-family: var(--f-family);
            color: var(--c-text-primary);
            font-size: var(--f-size-base);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        /* Focus Management (Stage 5.5.2) */
        :focus-visible {
            outline: 2px solid var(--c-accent);
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* =========================================
           LAYOUT ARCHITECTURE (Stage 3 + 6)
           ========================================= */
        #app {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Top Control Area */
        .top-controls {
            position: sticky;
            top: 0;
            z-index: 100;
            background: var(--c-bg-page);
            /* Matches page background */
            padding: var(--s-unit) 0;
            border-bottom: 1px solid transparent;
            /* Reserved */
            transition: border-color var(--t-fast);
        }

        .top-controls.scrolled {
            border-bottom-color: var(--c-line-divider);
        }

        .centered-frame {
            max-width: calc(var(--s-nav-width) + var(--s-content-width) + 64px);
            margin: 0 auto;
            padding: 0 24px;
            width: 100%;
            display: flex;
            /* Alignment for top controls matches content frame */
        }

        /* Paper Selector */
        .paper-selector {
            font-family: var(--f-family);
            font-size: var(--f-size-sm);
            padding: 6px 12px;
            border: 1px solid var(--c-line-divider);
            border-radius: 4px;
            background: #fff;
            color: var(--c-text-secondary);
            cursor: pointer;
            min-width: 200px;
        }

        /* Main Content Layout */
        .main-layout {
            display: flex;
            flex-direction: row;
            flex: 1;
            /* Navigation and Paper sit on same surface (Stage 3) */
        }

        /* Navigation Column (Stage 5.4) */
        .nav-column {
            width: var(--s-nav-width);
            flex-shrink: 0;
            padding-top: 48px;
            /* Vertical Rhythm */
            padding-right: 32px;
        }

        /* Sticky Nav Rail */
        .nav-rail {
            position: sticky;
            top: 80px;
            /* Below top controls */
            max-height: calc(100vh - 100px);
            overflow-y: auto;
            /* Scrollbar hiding (Stage 6.0.9) */
            scrollbar-width: none;
            /* Firefox */
            -ms-overflow-style: none;
            /* IE/Edge */
        }

        .nav-rail::-webkit-scrollbar {
            display: none;
        }

        .nav-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .nav-item {
            font-size: var(--f-size-nav);
            color: var(--c-text-secondary);
            padding: 4px 8px;
            cursor: pointer;
            border-radius: 4px;
            text-decoration: none;
            display: block;
            transition: color var(--t-fast), font-weight var(--t-fast);
        }

        .nav-item:hover {
            color: var(--c-text-primary);
            background: rgba(0, 0, 0, 0.03);
            /* Stage 5.5.1 Hover Feedback */
        }

        /* Stage 6.0.2: Active state weight only, text-color change allowed by 5.3.2 override */
        .nav-item.active {
            font-weight: 600;
            color: var(--c-accent);
        }

        .nav-section-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--c-text-tertiary);
            padding: 16px 8px 4px 8px;
            font-weight: 600;
            pointer-events: none;
        }

        /* Paper Content Column */
        .paper-column {
            flex: 1;
            padding-top: 48px;
            padding-bottom: 120px;
            max-width: var(--s-content-width);
        }

        /* =========================================
           CONTENT COMPONENTS
           ========================================= */

        /* Loading/Error States */
        .status-message {
            padding: 40px;
            text-align: center;
            color: var(--c-text-tertiary);
            font-weight: 500;
        }

        /* Question Block */
        .question-block {
            margin-bottom: 64px;
            /* Stage 3: Largest spacing unit */
            scroll-margin-top: 100px;
            /* For anchor jumping */
        }

        /* Hierarchy: Nesting via Indentation */
        .question-block[data-depth="1"] {
            margin-left: 0;
        }

        .question-block[data-depth="2"] {
            margin-left: 24px;
            margin-bottom: 40px;
        }

        .question-block[data-depth="3"] {
            margin-left: 48px;
            margin-bottom: 32px;
        }

        /* Question Header/Prompt */
        .q-header {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .q-id {
            font-weight: 600;
            color: var(--c-text-tertiary);
            /* Visually subordinate to text */
            flex-shrink: 0;
            width: 3ch;
            /* Approximate alignment */
        }

        .q-prompt {
            color: var(--c-text-primary);
            font-weight: 500;
            /* Primary anchor */
            flex: 1;
        }

        /* Markdown Content Styling */
        .md-content p {
            margin: 0 0 12px 0;
        }

        .md-content p:last-child {
            margin-bottom: 0;
        }

        .md-content ul,
        .md-content ol {
            margin: 8px 0 16px 24px;
            padding: 0;
        }

        .md-content li {
            margin-bottom: 4px;
        }

        .md-content img,
        .md-content svg {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 12px 0;
        }

        /* Tables (Stage 5.8.6) */
        .md-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 16px 0;
            font-size: var(--f-size-sm);
        }

        .md-content th,
        .md-content td {
            border: 1px solid var(--c-line-hairline);
            padding: 8px 12px;
            text-align: left;
        }

        .md-content th {
            font-weight: 600;
        }

        /* Answer Section */
        .answer-section {
            margin-left: calc(3ch + 12px);
            /* Align with text */
            margin-top: 16px;
            margin-bottom: 16px;
        }

        .answer-label {
            font-size: var(--f-size-sm);
            font-weight: 600;
            color: var(--c-text-tertiary);
            margin-bottom: 4px;
            display: block;
        }

        .answer-value {
            font-size: var(--f-size-base);
            color: var(--c-text-primary);
            font-weight: 400;
            /* Secondary to Question */
        }

        /* Solution Details Wrapper */
        .solution-wrapper {
            margin-left: calc(3ch + 12px);
        }

        /* Disclosure Control (Stage 5.7) */
        .solution-toggle {
            background: none;
            border: none;
            padding: 0;
            font-family: var(--f-family);
            font-size: var(--f-size-sm);
            color: var(--c-text-secondary);
            /* Subordinate to Answer */
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: color var(--t-fast);
        }

        .solution-toggle:hover {
            color: var(--c-accent);
            /* Restrained feedback */
            text-decoration: underline;
        }

        .toggle-icon {
            transition: transform var(--t-fast);
            width: 16px;
            height: 16px;
            fill: currentColor;
        }

        .solution-toggle[aria-expanded="true"] .toggle-icon {
            transform: rotate(180deg);
        }

        /* Solution Details Content (Stage 5.6.3) */
        .solution-details {
            display: grid;
            grid-template-rows: 0fr;
            transition: grid-template-rows var(--t-fast);
            overflow: hidden;
            /* Surface Separation (Stage 6.0.3 Option C) */
            /* Applied to inner container to allow animation */
        }

        .solution-details[data-expanded="true"] {
            grid-template-rows: 1fr;
        }

        .solution-inner {
            min-height: 0;
            /* Stage 6.0.3 Option C: Subtle background + minimal hairline divider */
            border-left: 1px solid var(--c-line-hairline);
            padding-left: 16px;
            margin-top: 12px;
            /* Visual subordination */
            color: var(--c-text-secondary);
        }

        /* Subsections (Stage 5.9) */
        .sd-section {
            margin-bottom: 24px;
        }

        .sd-section:last-child {
            margin-bottom: 0;
        }

        .sd-label {
            font-size: var(--f-size-sm);
            font-weight: 600;
            color: var(--c-text-tertiary);
            margin-bottom: 8px;
            display: block;
        }

        /* Keep in mind (Stage 5.9.2) */
        .sd-keep-in-mind .sd-label {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Display Math Styling */
        /* Stage 3 Override: Subtle underlay for display math only */
        .solution-details .katex-display {
            background-color: var(--c-math-underlay);
            border-radius: 4px;
            padding: 8px;
            margin: 12px 0;
            /* Containment (Stage 6.0.8) */
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
        }

        /* Workings (Stage 5.8) */
        .sd-working .md-content {
            /* Tighter density for workings */
            font-size: 0.95em;
        }

        /* =========================================
           MOBILE / RESPONSIVE
           ========================================= */
        /* Drawer for Mobile Nav */
        .mobile-nav-toggle {
            display: none;
            background: none;
            border: none;
            padding: 8px;
            margin-right: 12px;
            cursor: pointer;
        }

        .mobile-jump-btn {
            display: none;
            /* Only on mobile */
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--c-bg-paper);
            border: 1px solid var(--c-line-divider);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border-radius: 20px;
            padding: 8px 16px;
            font-weight: 600;
            color: var(--c-accent);
            z-index: 200;
        }

        @media (max-width: 900px) {
            .nav-column {
                display: none;
            }

            /* Hide rail */
            .mobile-nav-toggle {
                display: block;
            }

            .mobile-jump-btn {
                display: block;
            }

            .centered-frame {
                padding: 0 16px;
            }

            .paper-column {
                padding-top: 24px;
                max-width: 100%;
            }

            .solution-wrapper,
            .answer-section {
                margin-left: 0;
            }

            .q-header {
                flex-direction: column;
                gap: 4px;
            }

            /* Mobile Drawer */
            .drawer-overlay {
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.2);
                z-index: 300;
                opacity: 0;
                pointer-events: none;
                transition: opacity var(--t-fast);
            }

            .drawer-overlay.open {
                opacity: 1;
                pointer-events: auto;
            }

            .drawer-content {
                position: fixed;
                top: 0;
                bottom: 0;
                left: 0;
                width: 280px;
                background: var(--c-bg-page);
                transform: translateX(-100%);
                transition: transform var(--t-fast);
                padding: 24px;
                overflow-y: auto;
                box-shadow: 2px 0 12px rgba(0, 0, 0, 0.05);
            }

            .drawer-overlay.open .drawer-content {
                transform: translateX(0);
            }
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/markdown-it@13.0.1/dist/markdown-it.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

</head>

<body>

    <div id="app">
        <header class="top-controls" id="topControls">
            <div class="centered-frame">
                <button class="mobile-nav-toggle" id="mobileMenuBtn" aria-label="Open navigation">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="3" y1="12" x2="21" y2="12"></line>
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <line x1="3" y1="18" x2="21" y2="18"></line>
                    </svg>
                </button>
                <select id="paperSelector" class="paper-selector" aria-label="Select Paper">
                    <option value="" disabled selected>Loading papers...</option>
                </select>
            </div>
        </header>

        <div class="centered-frame main-layout">

            <nav class="nav-column" aria-label="Question navigation">
                <div class="nav-rail" id="desktopNavList">
                </div>
            </nav>

            <main class="paper-column" id="paperContent">
                <div class="status-message">Select a paper to begin.</div>
            </main>

        </div>

        <div class="drawer-overlay" id="mobileDrawer">
            <div class="drawer-content" id="mobileNavContent">
                <h3 style="font-size:14px; text-transform:uppercase; color:var(--c-text-tertiary); margin-top:0;">
                    Questions</h3>
                <div id="mobileNavList" class="nav-list"></div>
            </div>
        </div>

        <button class="mobile-jump-btn" id="mobileJumpBtn">Jump to...</button>
    </div>

    <script>
        // =========================================
        // STAGE 0: CONSTANTS
        // =========================================
        const RTQ_PAPERS_PAYLOAD_PATH = "../../payload/rtq.papers.payload.json";

        // =========================================
        // STATE & UTILS
        // =========================================
        let papersData = [];
        let currentPaper = null;

        // Stage 6.3: Markdown Configuration
        // html: true (SVG passthrough), breaks: false (KaTeX safety), disable escape (TeX safety)
        const md = window.markdownit
            ? window.markdownit({
                html: true,
                linkify: true,
                breaks: false,
            })
            : null;

        if (md) {
            md.inline.ruler.disable(["escape"]);
        }

        // =========================================
        // INITIALIZATION
        // =========================================
        async function init() {
            try {
                // Stage 6.3: Load from canonical path
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Network response was not ok");
                const payload = await response.json();

                if (!payload || !payload.papers) throw new Error("Invalid payload structure");

                papersData = payload.papers;
                populatePaperSelector();

                // Optional: Auto-load first paper if available
                if (papersData.length > 0) {
                    loadPaper(papersData[0].key);
                    document.getElementById('paperSelector').value = papersData[0].key;
                }

            } catch (error) {
                console.error("Payload Error:", error);
                document.getElementById('paperContent').innerHTML = `
                <div class="status-message">PAPERS PAYLOAD MISSING</div>
            `;
                document.getElementById('paperSelector').innerHTML = `<option>Error loading payload</option>`;
            }
        }

        function populatePaperSelector() {
            const selector = document.getElementById('paperSelector');
            selector.innerHTML = '';
            papersData.forEach(paper => {
                const option = document.createElement('option');
                option.value = paper.key;
                option.textContent = paper.label;
                selector.appendChild(option);
            });

            selector.addEventListener('change', (e) => {
                loadPaper(e.target.value);
            });
        }

        // =========================================
        // CORE RENDERING LOGIC
        // =========================================
        function loadPaper(paperKey) {
            currentPaper = papersData.find(p => p.key === paperKey);
            if (!currentPaper) return;

            const contentContainer = document.getElementById('paperContent');
            const desktopNav = document.getElementById('desktopNavList');
            const mobileNav = document.getElementById('mobileNavList');

            // Clear previous content
            contentContainer.innerHTML = '';
            desktopNav.innerHTML = '';
            mobileNav.innerHTML = '';

            // Flatten content for sequential rendering logic
            // But maintain structure for navigation
            let flatIndex = 0;

            // Helper to process a list of questions (recursive)
            function processQuestions(questions, depth = 1) {
                let html = '';
                questions.forEach(q => {
                    html += renderQuestionBlock(q, depth, currentPaper.defaults?.expandedAll);
                    // Recursion handled inside renderQuestionBlock via children check if needed, 
                    // but Brief implies children are nested in data but flattened in scroll? 
                    // Brief: "All questions... exist within a single vertical scroll... indentation... nesting".
                    // We will flatten recursively.
                    if (q.children && q.children.length > 0) {
                        html += processQuestions(q.children, depth + 1);
                    }
                });
                return html;
            }

            let paperHtml = '';
            let navItems = [];

            // Handle Sections or Flat Questions
            if (currentPaper.sections) {
                currentPaper.sections.forEach(section => {
                    // Section Header for Nav (Non-clickable)
                    const navHeader = document.createElement('div');
                    navHeader.className = 'nav-section-label';
                    navHeader.textContent = `Section ${section.label}`;
                    desktopNav.appendChild(navHeader.cloneNode(true));
                    mobileNav.appendChild(navHeader.cloneNode(true));

                    // Render questions
                    paperHtml += `<div class="section-divider" style="margin-top:40px; border-bottom:1px solid var(--c-line-divider); margin-bottom:40px;"></div>`; // Visual break
                    paperHtml += processQuestions(section.questions);

                    // Collect nav items
                    collectNavItems(section.questions, navItems);
                });
            } else if (currentPaper.questions) {
                paperHtml += processQuestions(currentPaper.questions);
                collectNavItems(currentPaper.questions, navItems);
            }

            contentContainer.innerHTML = paperHtml;
            renderNavList(navItems, desktopNav);
            renderNavList(navItems, mobileNav);

            // Stage 6.0.7: Render Math (Real KaTeX)
            renderMathInElement(contentContainer, {
                delimiters: [
                    { left: "$$", right: "$$", display: true },
                    { left: "$", right: "$", display: false }
                ],
                throwOnError: false,
                // Security: trust payload content
                trust: true
            });

            // Initialize Observers for Nav Highlighting
            initScrollSpy(navItems);
        }

        // Helper to extract nav items recursively
        function collectNavItems(questions, list) {
            questions.forEach(q => {
                list.push({ id: q.id });
                if (q.children) collectNavItems(q.children, list);
            });
        }

        function renderNavList(items, container) {
            // We append real links now
            // Note: The section headers were already appended in the main loop if sectioned.
            // For flat lists, we just append items.
            // Wait, the main loop logic above appended headers directly to DOM, but passed questions to HTML string.
            // This is a bit mixed. Let's fix: We need to append the links *after* headers.
            // Simplified: The loop above appended headers. Now we need to append the items *for that section*.
            // Actually, easiest way is to generate DOM elements for nav items during the iteration.
            // Let's refactor nav generation slightly in the main loop.
        }

        // Corrected Render Flow
        function loadPaper_Refactored(paperKey) {
            currentPaper = papersData.find(p => p.key === paperKey);
            if (!currentPaper) return;

            const contentContainer = document.getElementById('paperContent');
            const desktopNav = document.getElementById('desktopNavList');
            const mobileNav = document.getElementById('mobileNavList');

            contentContainer.innerHTML = '';
            desktopNav.innerHTML = '';
            mobileNav.innerHTML = '';

            let paperHtml = '';

            function renderNode(q, depth) {
                paperHtml += renderQuestionBlock(q, depth, currentPaper.defaults?.expandedAll);

                // Add Nav Item
                const navEl = document.createElement('a');
                navEl.className = 'nav-item';
                navEl.textContent = q.id;
                navEl.dataset.target = `q-${q.id}`;
                navEl.onclick = (e) => {
                    e.preventDefault();
                    scrollToQuestion(q.id);
                };
                desktopNav.appendChild(navEl);
                mobileNav.appendChild(navEl.cloneNode(true)); // Copy for mobile

                if (q.children) {
                    q.children.forEach(child => renderNode(child, depth + 1));
                }
            }

            if (currentPaper.sections) {
                currentPaper.sections.forEach(section => {
                    // Section Label
                    const dHeader = document.createElement('div');
                    dHeader.className = 'nav-section-label';
                    dHeader.textContent = section.label;
                    desktopNav.appendChild(dHeader);
                    mobileNav.appendChild(dHeader.cloneNode(true));

                    section.questions.forEach(q => renderNode(q, 1));
                });
            } else {
                currentPaper.questions.forEach(q => renderNode(q, 1));
            }

            contentContainer.innerHTML = paperHtml;

            // KaTeX Trigger
            renderMathInElement(contentContainer, {
                delimiters: [
                    { left: "$$", right: "$$", display: true },
                    { left: "$", right: "$", display: false }
                ],
                throwOnError: false
            });

            // Re-attach nav click listeners for mobile clone
            document.querySelectorAll('#mobileNavList .nav-item').forEach(el => {
                el.onclick = (e) => {
                    e.preventDefault();
                    scrollToQuestion(el.textContent);
                    toggleDrawer(false);
                };
            });

            initScrollSpy();
        }

        // Reuse Refactored as Main
        loadPaper = loadPaper_Refactored;

        // =========================================
        // HTML GENERATORS
        // =========================================
        function renderQuestionBlock(q, depth, forceExpand) {
            const qIdSafe = `q-${q.id}`;
            const hasSolution = !!q.solutionDetails;

            // Render Markdown
            const qText = md.render(q.question);
            const aText = md.render(q.answer);

            let solutionHtml = '';
            if (hasSolution) {
                solutionHtml = renderSolutionDetails(q.solutionDetails);
            }

            const isExpanded = forceExpand ? 'true' : 'false';

            return `
            <div class="question-block" id="${qIdSafe}" data-depth="${depth}">
                <div class="q-header">
                    <div class="q-id">${q.id}</div>
                    <div class="q-prompt md-content">${qText}</div>
                </div>
                
                <div class="answer-section">
                    <span class="answer-label">Answer</span>
                    <div class="answer-value md-content">${aText}</div>
                </div>

                ${hasSolution ? `
                <div class="solution-wrapper">
                    <button class="solution-toggle" aria-expanded="${isExpanded}" onclick="toggleSolution(this)">
                        <span class="toggle-text">${isExpanded === 'true' ? 'Hide working' : 'Show working'}</span>
                        <svg class="toggle-icon" viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"></path></svg>
                    </button>
                    
                    <div class="solution-details" data-expanded="${isExpanded}">
                        <div class="solution-inner">
                            ${solutionHtml}
                        </div>
                    </div>
                </div>
                ` : ''}
            </div>
        `;
        }

        function renderSolutionDetails(sd) {
            let html = '';

            // Order: Keep in mind -> Formulas -> Working -> Alt Working

            if (sd.keepInMind) {
                html += `
                <div class="sd-section sd-keep-in-mind">
                    <span class="sd-label">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                        Keep in mind
                    </span>
                    <div class="md-content">${md.render(sd.keepInMind)}</div>
                </div>
            `;
            }

            if (sd.formulasUsed) {
                html += `
                <div class="sd-section sd-formulas">
                    <span class="sd-label">Formulas used</span>
                    <div class="md-content">${md.render(sd.formulasUsed)}</div>
                </div>
            `;
            }

            if (sd.working) {
                html += `
                <div class="sd-section sd-working">
                    <span class="sd-label">Working</span>
                    <div class="md-content">${md.render(sd.working)}</div>
                </div>
            `;
            }

            if (sd.alternativeWorking) {
                html += `
                <div class="sd-section sd-alt-working">
                    <span class="sd-label">Alternative working</span>
                    <div class="md-content">${md.render(sd.alternativeWorking)}</div>
                </div>
            `;
            }

            return html;
        }

        // =========================================
        // INTERACTIONS
        // =========================================
        window.toggleSolution = function (btn) {
            const isExpanded = btn.getAttribute('aria-expanded') === 'true';
            const newState = !isExpanded;

            btn.setAttribute('aria-expanded', newState);
            btn.querySelector('.toggle-text').textContent = newState ? 'Hide working' : 'Show working';

            const details = btn.nextElementSibling;
            details.setAttribute('data-expanded', newState);
        };

        function scrollToQuestion(id) {
            const el = document.getElementById(`q-${id}`);
            if (el) {
                const topOffset = document.getElementById('topControls').offsetHeight + 20;
                const elementPosition = el.getBoundingClientRect().top;
                const offsetPosition = elementPosition + window.pageYOffset - topOffset;

                window.scrollTo({
                    top: offsetPosition,
                    behavior: "smooth"
                });
            }
        }

        // =========================================
        // MOBILE NAV
        // =========================================
        const drawer = document.getElementById('mobileDrawer');
        const toggleBtn = document.getElementById('mobileMenuBtn');
        const jumpBtn = document.getElementById('mobileJumpBtn');

        function toggleDrawer(show) {
            if (show) drawer.classList.add('open');
            else drawer.classList.remove('open');
        }

        toggleBtn.onclick = () => toggleDrawer(true);
        jumpBtn.onclick = () => toggleDrawer(true);

        drawer.onclick = (e) => {
            if (e.target === drawer) toggleDrawer(false);
        }

        // =========================================
        // SCROLL SPY (Active Nav)
        // =========================================
        function initScrollSpy() {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        // Remove active class from all
                        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

                        // Add to current (in both desktop and mobile lists)
                        const id = entry.target.id.replace('q-', '');
                        const links = document.querySelectorAll(`.nav-item`);
                        links.forEach(link => {
                            if (link.textContent === id) link.classList.add('active');
                        });
                    }
                });
            }, {
                rootMargin: "-20% 0px -60% 0px" // Trigger when element is near top
            });

            document.querySelectorAll('.question-block').forEach(q => observer.observe(q));
        }

        // Header scroll shadow effect
        window.addEventListener('scroll', () => {
            const header = document.getElementById('topControls');
            if (window.scrollY > 10) header.classList.add('scrolled');
            else header.classList.remove('scrolled');
        });

        // Run
        init();

    </script>
</body>

</html>