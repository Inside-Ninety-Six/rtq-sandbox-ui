<!DOCTYPE html>
<html lang="en" class="antialiased">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AB","indexWithinVariant":"39","totalWithinVariant":"200","hueFamily":"teal","intensityMode":"","timestamp":"2026-01-06T21:22:46.214Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AB&quot;,&quot;indexWithinVariant&quot;:&quot;39&quot;,&quot;totalWithinVariant&quot;:&quot;200&quot;,&quot;hueFamily&quot;:&quot;teal&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-06T21:22:46.214Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- KaTeX CSS (No Integrity) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    
    <!-- Markdown-it (No Integrity) -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>
    
    <!-- KaTeX JS (No Integrity) -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        // ColorLab B: Forced Hue "Teal"
                        accent: {
                            50: '#f0fdfa',
                            100: '#ccfbf1',
                            200: '#99f6e4',
                            300: '#5eead4',
                            400: '#2dd4bf',
                            500: '#14b8a6', // Primary interaction
                            600: '#0d9488',
                            700: '#0f766e',
                            800: '#115e59',
                            900: '#134e4a',
                        },
                        paper: {
                            bg: '#fdfbf9', // Soft warm neutral base (Stage 5.3.1)
                            surface: '#ffffff',
                            subtle: '#f7f5f3',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Base styles & Layout resets */
        body {
            background-color: #fdfbf9; /* Soft warm neutral */
            color: #171717; /* Neutral 900 */
        }

        /* Hide scrollbar for nav but keep functionality */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* KaTeX Overrides per Stage 3/6 */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 4px; /* Space for scrollbar if needed */
            margin: 1em 0;
        }
        
        /* Inline math transparent background constraint */
        .katex {
            background-color: transparent !important;
        }

        /* Table styles per Stage 5.8.5 */
        .md-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 1em 0;
            font-size: 0.95em;
        }
        .md-content th, .md-content td {
            border: 1px solid #e5e5e5;
            padding: 8px 12px;
            text-align: left;
        }
        .md-content th {
            font-weight: 600;
            color: #404040;
        }

        /* Markdown Content Rhythm */
        .md-content p {
            margin-bottom: 0.75em;
            line-height: 1.6;
        }
        .md-content p:last-child {
            margin-bottom: 0;
        }
        .md-content ul {
            list-style-type: disc;
            padding-left: 1.5em;
            margin-bottom: 0.75em;
        }
        .md-content ol {
            list-style-type: decimal;
            padding-left: 1.5em;
            margin-bottom: 0.75em;
        }

        /* Focus States (Stage 5.5.2) */
        :focus-visible {
            outline: 2px solid #14b8a6; /* Teal 500 */
            outline-offset: 2px;
        }

        /* Motion (Stage 5.5.3) */
        .details-content {
            transition: opacity 0.2s ease-out, max-height 0.3s ease-out;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Top Controls Region -->
    <div class="sticky top-0 z-30 bg-[#fdfbf9]/95 backdrop-blur-sm border-b border-neutral-200">
        <div class="max-w-7xl mx-auto px-4 md:px-8 h-16 flex items-center justify-between">
            
            <!-- Paper Selector -->
            <div class="flex items-center gap-3">
                <label for="paper-select" class="text-sm font-medium text-neutral-600 hidden sm:block">Paper:</label>
                <select id="paper-select" class="bg-white border border-neutral-300 text-neutral-900 text-sm rounded-md focus:ring-accent-500 focus:border-accent-500 block p-2 min-w-[200px]">
                    <option disabled selected>Loading papers...</option>
                </select>
            </div>

            <!-- Mobile Jump To Trigger -->
            <button id="mobile-jump-trigger" class="lg:hidden text-sm font-medium text-accent-700 hover:text-accent-800 px-3 py-2 rounded hover:bg-accent-50 transition-colors">
                Jump to question
            </button>
        </div>
    </div>

    <!-- DocumentFrameShell -->
    <div class="flex-1 max-w-7xl mx-auto w-full px-4 md:px-8 grid grid-cols-1 lg:grid-cols-[220px_1fr] gap-8 py-8 relative">
        
        <!-- Desktop Navigation Rail (Sticky) -->
        <nav class="hidden lg:block sticky top-24 h-[calc(100vh-8rem)] overflow-y-auto no-scrollbar pr-4" aria-label="Paper navigation">
            <div id="desktop-nav-list" class="flex flex-col space-y-1">
                <!-- Nav items injected here -->
            </div>
        </nav>

        <!-- Paper Document Column -->
        <main id="paper-content" class="min-h-[50vh] pb-32">
            <!-- Content injected here -->
            <div class="flex items-center justify-center h-full text-neutral-400">
                Initializing...
            </div>
        </main>

    </div>

    <!-- Mobile Navigation Drawer (Overlay) -->
    <div id="mobile-drawer-backdrop" class="fixed inset-0 bg-neutral-900/20 backdrop-blur-sm z-40 hidden" aria-hidden="true"></div>
    <div id="mobile-drawer" class="fixed inset-y-0 right-0 w-80 bg-white shadow-xl transform translate-x-full transition-transform duration-300 z-50 flex flex-col" aria-hidden="true">
        <div class="flex items-center justify-between p-4 border-b border-neutral-100">
            <h2 class="text-lg font-semibold text-neutral-900">Jump to</h2>
            <button id="mobile-drawer-close" class="p-2 text-neutral-500 hover:text-neutral-900 rounded-md">
                <span class="sr-only">Close navigation</span>
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <nav class="flex-1 overflow-y-auto p-4">
            <div id="mobile-nav-list" class="flex flex-col space-y-2">
                <!-- Nav items injected here -->
            </div>
        </nav>
    </div>

    <script>
        // --- STAGE 0: CONSTANTS ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";

        // --- MARKDOWN CONFIGURATION (STAGE 6) ---
        const md = window.markdownit ? window.markdownit({
            html: true,
            linkify: true,
            breaks: false // Critical: prevent <br> in math
        }) : null;

        if (md) {
            md.inline.ruler.disable(['escape']); // Preserve TeX backslashes
        }

        // --- STATE ---
        let state = {
            papers: [],
            currentPaperId: null,
            papersMap: {},
            expandedMap: {} // key: questionNodeId (internal), value: boolean
        };

        // --- DOM ELEMENTS ---
        const els = {
            paperSelect: document.getElementById('paper-select'),
            content: document.getElementById('paper-content'),
            desktopNav: document.getElementById('desktop-nav-list'),
            mobileNav: document.getElementById('mobile-nav-list'),
            drawer: document.getElementById('mobile-drawer'),
            backdrop: document.getElementById('mobile-drawer-backdrop'),
            jumpTrigger: document.getElementById('mobile-jump-trigger'),
            drawerClose: document.getElementById('mobile-drawer-close')
        };

        // --- INITIALIZATION ---
        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                
                if (!data.papers || !Array.isArray(data.papers)) throw new Error('Invalid payload');
                
                state.papers = data.papers;
                state.papers.forEach(p => state.papersMap[p.key] = p);
                
                renderPaperSelector();
                
                // Select first paper by default
                if (state.papers.length > 0) {
                    loadPaper(state.papers[0].key);
                }
            } catch (err) {
                console.error(err);
                renderError();
            }
        }

        // --- RENDERING LOGIC ---

        function renderError() {
            els.content.innerHTML = `
                <div class="flex flex-col items-center justify-center pt-20 text-neutral-500">
                    <p class="text-xl font-semibold tracking-tight text-neutral-900 mb-2">PAPERS PAYLOAD MISSING</p>
                    <p class="text-sm">Unable to load content from ${RTQ_PAPERS_PAYLOAD_PATH}</p>
                </div>
            `;
            els.paperSelect.innerHTML = '<option disabled>Error loading papers</option>';
        }

        function renderPaperSelector() {
            els.paperSelect.innerHTML = state.papers.map(p => 
                `<option value="${p.key}">${p.label}</option>`
            ).join('');
            
            els.paperSelect.addEventListener('change', (e) => {
                loadPaper(e.target.value);
            });
        }

        function loadPaper(paperKey) {
            state.currentPaperId = paperKey;
            state.expandedMap = {}; // Reset expanded states on switch
            
            const paper = state.papersMap[paperKey];
            const defaultExpanded = paper.defaults?.expandedAll !== false;

            // Pre-calculate expanded states for this paper's questions based on default
            // This is a simplistic approach; strictly we just use default render time, 
            // but tracking state allows persistence if we added re-renders (not needed for simple switch).
            
            renderPaperContent(paper, defaultExpanded);
            renderNavigation(paper);
            
            // Render Math
            renderMathInElement(els.content, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false},
                    {left: '\\(', right: '\\)', display: false},
                    {left: '\\[', right: '\\]', display: true}
                ],
                throwOnError: false
            });

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'instant' });
        }

        // --- CONTENT BUILDER ---

        function renderPaperContent(paper, defaultExpanded) {
            // Paper Surface
            let html = `<div class="bg-white shadow-sm ring-1 ring-neutral-200/50 rounded-none sm:rounded-sm min-h-screen p-6 md:p-10 lg:p-12 space-y-12">`;

            // Sections or Flat List
            if (paper.sections) {
                paper.sections.forEach((section, index) => {
                    // Render Section Header if label present
                    if (section.label && section.label.trim().length > 0) {
                        html += `
                            <div class="pt-4 first:pt-0">
                                <h2 class="text-neutral-900 font-bold text-lg border-b border-neutral-200 pb-2 mb-8">${section.label}</h2>
                            </div>
                        `;
                    }
                    html += `<div class="space-y-16">`; // Large spacing between top-level questions
                    section.questions.forEach(q => {
                        html += renderQuestionNode(q, defaultExpanded, 0);
                    });
                    html += `</div>`;
                    
                    // Spacer between sections
                    if (index < paper.sections.length - 1) {
                        html += `<div class="h-8"></div>`; 
                    }
                });
            } else if (paper.questions) {
                html += `<div class="space-y-16">`;
                paper.questions.forEach(q => {
                    html += renderQuestionNode(q, defaultExpanded, 0);
                });
                html += `</div>`;
            }

            html += `</div>`;
            els.content.innerHTML = html;
            
            // Attach Event Listeners for Toggles
            document.querySelectorAll('.disclosure-btn').forEach(btn => {
                btn.addEventListener('click', handleToggleWorking);
            });
        }

        function renderQuestionNode(node, defaultExpanded, depth) {
            // Helper to render markdown safely
            const renderMd = (text) => md ? md.render(text || '') : (text || '');
            
            // Unique ID for DOM ops
            const domId = `q-${node.id.replace(/[^a-zA-Z0-9]/g, '-')}`;
            
            // Determine solution block presence
            const sb = node.solutionBlock;
            const hasAnswer = sb && sb.answer;
            const hasDetails = sb && sb.solutionDetails;
            
            // State for expansion
            const isExpanded = state.expandedMap[domId] !== undefined ? state.expandedMap[domId] : defaultExpanded;
            // Record state
            state.expandedMap[domId] = isExpanded;

            // Indentation logic (Stage 3E): Vertical spacing + Horizontal indent
            // Depth 0: Top level. Depth > 0: Sub questions.
            const indentClass = depth > 0 ? 'ml-0 md:ml-6 mt-8' : '';
            const borderClass = depth > 0 ? '' : ''; // No borders allowed

            let html = `
                <div id="${domId}" class="group relative ${indentClass}" data-depth="${depth}">
                    
                    <!-- QUESTION BODY -->
                    <div class="flex gap-4">
                        <div class="flex-none pt-1">
                            <span class="text-neutral-500 font-medium text-sm md:text-base select-none">${node.id}</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="md-content text-neutral-900 text-base md:text-lg leading-relaxed">
                                ${renderMd(node.question)}
                            </div>
                        </div>
                    </div>
            `;

            // SOLUTION BLOCK
            if (sb) {
                html += `<div class="ml-0 md:ml-[calc(1rem+1.5rem)] mt-6 space-y-4">`; // Indent to align with text start

                // ANSWER
                if (hasAnswer) {
                    html += `
                        <div class="relative">
                            <h4 class="text-xs font-bold text-neutral-500 uppercase tracking-wider mb-2">Answer</h4>
                            <div class="md-content text-neutral-900 font-medium">
                                ${renderMd(sb.answer)}
                            </div>
                        </div>
                    `;
                }

                // SOLUTION DETAILS
                if (hasDetails) {
                    const sd = sb.solutionDetails;
                    const expandedClass = isExpanded ? 'block' : 'hidden';
                    const toggleText = isExpanded ? 'Hide working' : 'Show working';
                    
                    html += `
                        <div class="pt-2">
                            <button 
                                type="button" 
                                class="disclosure-btn text-accent-600 hover:text-accent-700 font-medium text-sm flex items-center gap-1 focus:outline-none focus-visible:underline"
                                data-target="${domId}-details"
                                aria-expanded="${isExpanded}"
                                aria-controls="${domId}-details"
                            >
                                <span>${toggleText}</span>
                                <svg class="w-4 h-4 transform transition-transform ${isExpanded ? 'rotate-180' : ''}" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                </svg>
                            </button>
                            
                            <div id="${domId}-details" class="details-content ${expandedClass} mt-4 relative">
                                <!-- Subtle demarcation line -->
                                <div class="absolute left-0 top-0 bottom-0 w-px bg-neutral-200 hidden md:block"></div>
                                
                                <div class="pl-0 md:pl-6 space-y-8">
                                    
                                    ${sd.keepInMind ? `
                                        <div class="space-y-2">
                                            <h5 class="text-xs font-bold text-accent-700 uppercase tracking-wide">Keep in mind</h5>
                                            <div class="md-content text-sm text-neutral-700">
                                                ${renderMd(sd.keepInMind)}
                                            </div>
                                        </div>
                                    ` : ''}

                                    ${sd.formulasUsed ? `
                                        <div class="space-y-2">
                                            <h5 class="text-xs font-bold text-neutral-500 uppercase tracking-wide">Formulas used</h5>
                                            <div class="md-content text-sm text-neutral-600">
                                                ${renderMd(sd.formulasUsed)}
                                            </div>
                                        </div>
                                    ` : ''}

                                    ${sd.working ? `
                                        <div class="space-y-3">
                                            <h5 class="text-xs font-bold text-neutral-500 uppercase tracking-wide">Working</h5>
                                            <div class="md-content text-neutral-800 text-sm md:text-base">
                                                ${renderMd(sd.working)}
                                            </div>
                                        </div>
                                    ` : ''}

                                    ${sd.alternativeWorking && Array.isArray(sd.alternativeWorking) ? sd.alternativeWorking.map((alt, idx) => `
                                        <div class="pt-4 border-t border-neutral-100/50">
                                            <h5 class="text-xs font-bold text-neutral-500 uppercase tracking-wide mb-3">Alternative working</h5>
                                            <div class="md-content text-neutral-800 text-sm md:text-base">
                                                ${renderMd(alt)}
                                            </div>
                                        </div>
                                    `).join('') : ''}

                                </div>
                            </div>
                        </div>
                    `;
                }
                html += `</div>`;
            }

            // RECURSIVE CHILDREN
            if (node.children && node.children.length > 0) {
                // Container for children
                html += `<div class="mt-4">`; 
                node.children.forEach(child => {
                    html += renderQuestionNode(child, defaultExpanded, depth + 1);
                });
                html += `</div>`;
            }

            html += `</div>`;
            return html;
        }

        // --- NAVIGATION BUILDER ---

        function renderNavigation(paper) {
            // Helper to generate list items
            const createNavItem = (node, depth) => {
                const domId = `q-${node.id.replace(/[^a-zA-Z0-9]/g, '-')}`;
                // Depth handled via type scale/opacity, strictly flat alignment
                const styleClass = depth === 0 
                    ? 'text-neutral-700 font-medium' 
                    : 'text-neutral-500 text-sm font-normal';
                
                let html = `
                    <a href="#${domId}" 
                       class="nav-link block py-1.5 px-2 hover:text-accent-700 hover:bg-neutral-100 rounded transition-colors ${styleClass}"
                       data-target="${domId}"
                    >
                        ${node.id}
                    </a>
                `;
                if (node.children) {
                    node.children.forEach(child => {
                        html += createNavItem(child, depth + 1);
                    });
                }
                return html;
            };

            let html = '';
            
            if (paper.sections) {
                paper.sections.forEach((section, index) => {
                    // Section Label (Non-clickable)
                    if (section.label && section.label.trim().length > 0) {
                        html += `
                            <div class="px-2 pt-6 pb-2 first:pt-2">
                                <span class="text-xs font-bold text-neutral-400 uppercase tracking-wider">${section.label}</span>
                            </div>
                        `;
                    } else if (index > 0) {
                        // Spacing if no label but distinct section
                        html += `<div class="h-4"></div>`;
                    }
                    
                    section.questions.forEach(q => {
                        html += createNavItem(q, 0);
                    });
                });
            } else if (paper.questions) {
                paper.questions.forEach(q => {
                    html += createNavItem(q, 0);
                });
            }

            // Inject into both desktop and mobile lists
            els.desktopNav.innerHTML = html;
            els.mobileNav.innerHTML = html;

            // Attach scroll listeners
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetId = e.target.getAttribute('href').substring(1);
                    const targetEl = document.getElementById(targetId);
                    if (targetEl) {
                        // Offset for sticky header
                        const offset = 100;
                        const bodyRect = document.body.getBoundingClientRect().top;
                        const elementRect = targetEl.getBoundingClientRect().top;
                        const elementPosition = elementRect - bodyRect;
                        const offsetPosition = elementPosition - offset;

                        window.scrollTo({
                            top: offsetPosition,
                            behavior: 'smooth'
                        });
                        
                        // Close drawer on mobile
                        closeDrawer();
                    }
                });
            });
        }

        // --- INTERACTIONS ---

        function handleToggleWorking(e) {
            const btn = e.currentTarget;
            const targetId = btn.getAttribute('data-target');
            const targetEl = document.getElementById(targetId);
            const icon = btn.querySelector('svg');
            const textSpan = btn.querySelector('span');
            
            const isExpanded = btn.getAttribute('aria-expanded') === 'true';
            const newState = !isExpanded;
            
            // Toggle State
            btn.setAttribute('aria-expanded', newState);
            if (newState) {
                targetEl.classList.remove('hidden');
                targetEl.classList.add('block');
                textSpan.textContent = 'Hide working';
                icon.classList.add('rotate-180');
            } else {
                targetEl.classList.remove('block');
                targetEl.classList.add('hidden');
                textSpan.textContent = 'Show working';
                icon.classList.remove('rotate-180');
            }
        }

        // Mobile Drawer Logic
        function openDrawer() {
            els.drawer.classList.remove('translate-x-full');
            els.backdrop.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeDrawer() {
            els.drawer.classList.add('translate-x-full');
            els.backdrop.classList.add('hidden');
            document.body.style.overflow = '';
        }

        els.jumpTrigger.addEventListener('click', openDrawer);
        els.drawerClose.addEventListener('click', closeDrawer);
        els.backdrop.addEventListener('click', closeDrawer);

        // --- RUN ---
        init();

    </script>
</body>
</html>
