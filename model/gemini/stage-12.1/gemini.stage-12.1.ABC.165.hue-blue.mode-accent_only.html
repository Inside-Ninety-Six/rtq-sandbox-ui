<!DOCTYPE html>
<html lang="en-GB">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"ABC","indexWithinVariant":"165","totalWithinVariant":"320","hueFamily":"blue","intensityMode":"accent_only","timestamp":"2026-01-07T17:08:14.214Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;ABC&quot;,&quot;indexWithinVariant&quot;:&quot;165&quot;,&quot;totalWithinVariant&quot;:&quot;320&quot;,&quot;hueFamily&quot;:&quot;blue&quot;,&quot;intensityMode&quot;:&quot;accent_only&quot;,&quot;timestamp&quot;:&quot;2026-01-07T17:08:14.214Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer (Stage 6 Baseline)</title>
    
    <!-- KaTeX CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <!-- Libraries (SRI Disabled per Stage 6.0.7b) -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <style>
        /* ==========================================================================
           1. RESET & BASE TOKENS (ColorLab C: Accent Only - Blue)
           Hue: Blue (approx 260). 
           Mode: accent_only (Surfaces C<=0.015, Text C<=0.010, Accent C 0.08-0.14)
           ========================================================================== */
        :root {
            /* Palette - Hue: Blue (260) */
            --hue-primary: 260;

            /* Surfaces (Neutral/Paper-like) */
            --bg-page: oklch(0.99 0.002 var(--hue-primary));
            --bg-frame: oklch(1.0 0 0); /* White base for document frame */
            --bg-paper: oklch(1.0 0 0); 
            --bg-wash-sd: oklch(0.985 0.005 var(--hue-primary)); /* Very subtle wash */
            --bg-drawer: oklch(1.0 0 0);

            /* Text (High contrast but soft) */
            --text-primary: oklch(0.20 0.008 var(--hue-primary));
            --text-secondary: oklch(0.45 0.010 var(--hue-primary));
            --text-quiet: oklch(0.60 0.010 var(--hue-primary));

            /* Accent (Used sparingly: Links, Focus, Current Nav) */
            /* Target C ~0.12 */
            --color-accent: oklch(0.55 0.12 var(--hue-primary));
            
            /* Dividers */
            --border-hairline: oklch(0.92 0.005 var(--hue-primary));

            /* Focus */
            --focus-ring: oklch(0.55 0.12 var(--hue-primary));

            /* Spacing */
            --sp-xs: 4px;
            --sp-sm: 8px;
            --sp-md: 16px;
            --sp-lg: 24px;
            --sp-xl: 32px;
            --sp-xxl: 48px;
            --sp-xxxl: 64px;

            /* Typography */
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --font-size-root: 16px;
            --font-size-sm: 0.875rem;
            --font-size-base: 1rem;
            --font-size-lg: 1.125rem;

            /* Transitions */
            --trans-fast: 150ms ease;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-page);
            color: var(--text-primary);
            font-family: var(--font-family);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            overflow-y: scroll; /* Force scrollbar stability */
        }

        /* Keyboard Focus */
        :focus-visible {
            outline: 2px solid var(--focus-ring);
            outline-offset: 2px;
        }

        /* ==========================================================================
           2. LAYOUT SHELL
           ========================================================================== */
        
        /* Top Controls Region */
        .top-controls-region {
            width: 100%;
            display: flex;
            justify-content: center;
            background-color: var(--bg-page);
            padding: var(--sp-md) var(--sp-md) 0 var(--sp-md);
            /* Align visually with DocumentFrameShell max-width below */
        }

        .top-controls-wrapper {
            width: 100%;
            max-width: 1000px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--sp-md);
        }

        /* Document Frame Shell */
        .document-frame-shell {
            width: 100%;
            max-width: 1000px;
            margin: 0 auto;
            background-color: var(--bg-frame); /* Shared surface context */
            min-height: 100vh;
            display: grid;
            grid-template-columns: 240px 1fr; /* Desktop: Nav + Paper */
            position: relative;
        }

        /* Mobile specific layout adjustments handled in media queries */

        /* ==========================================================================
           3. NAVIGATION (Desktop Rail)
           ========================================================================== */
        .nav-rail {
            grid-column: 1;
            padding: 0 var(--sp-md) var(--sp-xxl) 0;
            border-right: 1px solid transparent; /* Optical separation handled by whitespace */
        }

        .nav-sticky-container {
            position: sticky;
            top: var(--sp-md);
            max-height: calc(100vh - var(--sp-md));
            overflow-y: auto;
            /* Hide scrollbar visually */
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .nav-sticky-container::-webkit-scrollbar {
            display: none;
        }

        .nav-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: var(--sp-xs);
        }

        .nav-item {
            display: block;
            padding: var(--sp-xs) 0;
            text-decoration: none;
            color: var(--text-secondary);
            font-size: var(--font-size-sm);
            transition: color var(--trans-fast);
            cursor: pointer;
            border: none;
            background: none;
            text-align: left;
            width: 100%;
        }

        .nav-item:hover {
            color: var(--text-primary);
        }

        .nav-item.active {
            color: var(--color-accent);
            font-weight: 600; /* Weight-only active state (Stage 6.0.2) */
        }

        /* Sub-question hierarchy via type scale/quietness (Stage 3/5) */
        .nav-item.is-child {
            font-size: 0.8125rem; /* Slightly smaller */
            color: var(--text-quiet);
        }
        .nav-item.is-child.active {
            color: var(--color-accent);
        }

        .nav-section-label {
            margin-top: var(--sp-md);
            margin-bottom: var(--sp-xs);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-quiet);
            font-weight: 600;
            user-select: none;
        }
        
        .nav-section-label:first-child {
            margin-top: 0;
        }

        /* ==========================================================================
           4. PAPER CONTENT
           ========================================================================== */
        .paper-column {
            grid-column: 2;
            padding: 0 var(--sp-lg) var(--sp-xxxl) var(--sp-lg);
            /* Ensure wide readability */
        }

        .paper-content {
            background-color: var(--bg-paper);
        }

        /* Section Header */
        .section-header {
            font-size: 1.5rem;
            font-weight: 600;
            margin: var(--sp-xl) 0 var(--sp-lg) 0;
            padding-bottom: var(--sp-sm);
            border-bottom: 1px solid var(--border-hairline);
            color: var(--text-primary);
        }

        /* Question Node */
        .question-node {
            margin-bottom: var(--sp-xxl); /* Top-level spacing */
            scroll-margin-top: var(--sp-xl);
        }

        .question-node.child-node {
            margin-bottom: var(--sp-lg);
            margin-top: var(--sp-lg);
            /* Visual indentation via padding left? No, strict flat alignment per spec? 
               Spec says: "Indentation may adapt... must not create boxed layouts".
               Stage 3: SPC__CHILD_INDENTATION (optional; spacing-only).
               Let's use moderate left margin for children. */
            margin-left: var(--sp-lg);
            border-left: 1px solid var(--border-hairline); /* Optional visual cue for nesting */
            padding-left: var(--sp-md);
        }

        /* Question Body */
        .question-body {
            font-size: var(--font-size-base);
            color: var(--text-primary);
            margin-bottom: var(--sp-md);
        }

        .question-identifier {
            font-weight: 600;
            margin-right: var(--sp-sm);
            color: var(--text-primary);
        }
        
        .question-text {
            display: inline;
        }
        
        .question-text p {
            display: inline;
            margin: 0;
        }
        .question-text p + p {
            display: block;
            margin-top: var(--sp-sm);
        }

        /* Solution Block */
        .solution-block {
            margin-top: var(--sp-md);
            /* Grouping logic */
        }

        /* Answer */
        .answer-region {
            margin-bottom: var(--sp-sm);
            font-size: var(--font-size-base);
            color: var(--text-secondary); /* Tertiary emphasis */
        }

        .answer-label {
            font-weight: 600;
            font-size: 0.875rem;
            margin-right: var(--sp-sm);
            color: var(--text-secondary);
        }

        /* Solution Details (Expandable) */
        .solution-details-wrapper {
            margin-top: var(--sp-sm);
        }

        .disclosure-control {
            background: none;
            border: none;
            padding: 0;
            font-size: 0.875rem;
            color: var(--color-accent);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: var(--sp-xs);
            font-family: var(--font-family);
        }
        
        .disclosure-control:hover {
            text-decoration: underline;
        }

        .disclosure-icon {
            transition: transform var(--trans-fast);
            width: 16px;
            height: 16px;
            fill: currentColor;
        }

        .disclosure-control[aria-expanded="true"] .disclosure-icon {
            transform: rotate(180deg);
        }

        .solution-details-content {
            display: none; /* Hidden by default */
            margin-top: var(--sp-md);
            padding: var(--sp-md);
            background-color: var(--bg-wash-sd); /* Subtle wash (accent_only compatible) */
            /* No borders, no radius per spec constraints */
        }
        
        .solution-details-content.expanded {
            display: block;
            animation: fadeIn var(--trans-fast);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-4px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Subsections (Keep in mind, Formulas, etc.) */
        .sd-subsection {
            margin-bottom: var(--sp-lg);
        }
        .sd-subsection:last-child {
            margin-bottom: 0;
        }

        .sd-label {
            font-size: 0.8125rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: var(--sp-xs);
            display: block;
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }

        /* Keep in mind specialized style */
        .keep-in-mind-body ul {
            margin: 0;
            padding-left: var(--sp-lg);
            color: var(--text-primary);
        }

        /* Working / Alt Working body */
        .working-body {
            color: var(--text-primary);
            font-size: var(--font-size-base);
        }

        /* ==========================================================================
           5. MATH & CONTENT STYLING
           ========================================================================== */
        
        /* KaTeX Block Containment (Invariant) */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding: var(--sp-sm) 0;
            /* Scrollbar hiding for cleaner look, but functional */
            scrollbar-width: thin; 
        }

        /* Inline Math - No background */
        .katex {
            font-size: 1.1em; /* Slight bump for readability */
        }

        /* Markdown tables */
        table {
            border-collapse: collapse;
            width: 100%;
            margin: var(--sp-md) 0;
            font-size: 0.875rem;
        }
        th, td {
            border: 1px solid var(--border-hairline);
            padding: var(--sp-sm);
            text-align: left;
        }
        th {
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Images / Diagrams */
        img, svg {
            max-width: 100%;
            height: auto;
            display: block;
            margin: var(--sp-md) 0;
        }

        /* ==========================================================================
           6. CONTROLS & MOBILE
           ========================================================================== */
        
        .paper-selector {
            padding: var(--sp-sm);
            font-size: 0.875rem;
            border: 1px solid var(--border-hairline);
            border-radius: 4px; /* Minimal rounding allowed for controls? Spec says "No heavy borders...". Standard select is fine. */
            background-color: var(--bg-page);
            color: var(--text-primary);
            cursor: pointer;
        }

        /* Mobile Jump To Trigger */
        .mobile-jump-trigger {
            display: none; /* Desktop default */
            background: none;
            border: none;
            color: var(--color-accent);
            font-weight: 600;
            cursor: pointer;
            font-size: 0.875rem;
        }

        /* Mobile Navigation Drawer */
        .nav-drawer-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
            z-index: 100;
            display: none;
            opacity: 0;
            transition: opacity var(--trans-fast);
        }
        
        .nav-drawer {
            position: fixed;
            top: 0;
            right: 0; /* Right side drawer per typical mobile pattern? Spec says "Drawer". Left or Right not strictly mandated, let's go Right for "Jump to" feels. Or Left. Let's stick to Left to match desktop rail logic. */
            left: 0; /* Bottom sheet? Spec says "Drawer". Left side standard. */
            width: 85%;
            max-width: 320px;
            height: 100%;
            background-color: var(--bg-drawer);
            z-index: 101;
            transform: translateX(-100%);
            transition: transform var(--trans-fast);
            display: flex;
            flex-direction: column;
            padding: var(--sp-md);
            box-shadow: 2px 0 12px rgba(0,0,0,0.1);
        }

        .nav-drawer.open {
            transform: translateX(0);
        }
        
        .nav-drawer-overlay.open {
            display: block;
            opacity: 1;
        }

        .drawer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--sp-md);
            border-bottom: 1px solid var(--border-hairline);
            padding-bottom: var(--sp-sm);
        }

        .drawer-title {
            font-weight: 600;
            color: var(--text-primary);
        }

        .drawer-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            line-height: 1;
            cursor: pointer;
            padding: var(--sp-xs);
        }

        /* ==========================================================================
           7. MEDIA QUERIES
           ========================================================================== */
        @media (max-width: 768px) {
            .document-frame-shell {
                display: block; /* Stack layout */
            }

            .nav-rail {
                display: none; /* Hide sticky rail on mobile */
            }

            .paper-column {
                padding: 0 var(--sp-md) var(--sp-xxl) var(--sp-md);
            }

            .top-controls-region {
                /* Stick top controls on mobile? */
                /* Spec says "Paper selector... fixed location...". Let's keep it simple doc flow. */
            }

            .mobile-jump-trigger {
                display: block;
            }

            /* Adjust KaTeX for mobile if needed */
            .katex {
                font-size: 1.0em;
            }
        }

    </style>
</head>
<body>

    <!-- Runtime Payload Path Constant (Authoritative) -->
    <script>
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
    </script>

    <!-- Top Controls -->
    <div class="top-controls-region">
        <div class="top-controls-wrapper">
            <select id="paper-selector" class="paper-selector" aria-label="Select paper">
                <option value="" disabled selected>Loading papers...</option>
            </select>
            <button id="mobile-jump-trigger" class="mobile-jump-trigger">Jump to question</button>
        </div>
    </div>

    <!-- Document Frame Shell -->
    <main class="document-frame-shell">
        
        <!-- Desktop Navigation Rail -->
        <nav class="nav-rail" aria-label="Paper navigation">
            <div class="nav-sticky-container" id="desktop-nav-container">
                <!-- Nav Content Injected Here -->
            </div>
        </nav>

        <!-- Paper Content Column -->
        <div class="paper-column">
            <div id="paper-content" class="paper-content" role="article">
                <!-- Paper Content Injected Here -->
                <div style="padding: 2rem; text-align: center; color: var(--text-secondary);">
                    Loading...
                </div>
            </div>
        </div>

    </main>

    <!-- Mobile Navigation Drawer -->
    <div id="nav-drawer-overlay" class="nav-drawer-overlay"></div>
    <div id="nav-drawer" class="nav-drawer" aria-hidden="true">
        <div class="drawer-header">
            <span class="drawer-title">Jump to</span>
            <button id="drawer-close" class="drawer-close" aria-label="Close navigation">&times;</button>
        </div>
        <div id="drawer-nav-list" style="overflow-y: auto; flex: 1;">
            <!-- Mobile Nav Content Injected Here -->
        </div>
    </div>

    <!-- Application Logic -->
    <script>
        (function() {
            // --- Configuration & State ---
            const STATE = {
                papers: [],
                currentPaper: null,
                activeQuestionId: null
            };

            // --- Markdown Renderer Setup (Stage 6 Add-on) ---
            const md = window.markdownit ? window.markdownit({
                html: true,
                linkify: true,
                breaks: false // MUST be false to support KaTeX
            }) : null;

            if (md) {
                // Disable escape rule to preserve TeX backslashes
                md.inline.ruler.disable(['escape']);
            }

            // --- DOM Elements ---
            const elSelector = document.getElementById('paper-selector');
            const elPaperContent = document.getElementById('paper-content');
            const elDesktopNav = document.getElementById('desktop-nav-container');
            const elMobileNav = document.getElementById('drawer-nav-list');
            const elMobileTrigger = document.getElementById('mobile-jump-trigger');
            const elDrawer = document.getElementById('nav-drawer');
            const elOverlay = document.getElementById('nav-drawer-overlay');
            const elDrawerClose = document.getElementById('drawer-close');

            // --- Initialization ---
            async function init() {
                try {
                    const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                    if (!response.ok) throw new Error("Payload missing");
                    const data = await response.json();
                    
                    if (!data.papers || !Array.isArray(data.papers)) {
                        throw new Error("Invalid payload format");
                    }

                    STATE.papers = data.papers;
                    renderSelector();
                    
                    // Load first paper by default
                    if (STATE.papers.length > 0) {
                        loadPaper(STATE.papers[0].key);
                    } else {
                        renderError("No papers found in payload.");
                    }

                } catch (e) {
                    console.error(e);
                    renderError("PAPERS PAYLOAD MISSING");
                }
            }

            function renderError(msg) {
                elPaperContent.innerHTML = `<div style="padding: 2rem; text-align: center; color: var(--text-primary); font-weight: 600;">${msg}</div>`;
                elSelector.innerHTML = `<option disabled>Error</option>`;
            }

            // --- Paper Loading & Rendering ---
            function renderSelector() {
                elSelector.innerHTML = '';
                STATE.papers.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.key;
                    opt.textContent = p.label || p.key;
                    elSelector.appendChild(opt);
                });
                
                elSelector.addEventListener('change', (e) => {
                    loadPaper(e.target.value);
                });
            }

            function loadPaper(key) {
                const paper = STATE.papers.find(p => p.key === key);
                if (!paper) return;

                STATE.currentPaper = paper;
                elSelector.value = key;
                
                // Clear existing
                elPaperContent.innerHTML = '';
                
                // Build Nav Data
                const navItems = buildNavStructure(paper);
                
                // Render Nav
                renderNav(navItems, elDesktopNav);
                renderNav(navItems, elMobileNav, true);

                // Render Paper Body
                if (paper.sections) {
                    paper.sections.forEach(section => {
                        // Section Header (only if label exists)
                        if (section.label && section.label.trim().length > 0) {
                            const header = document.createElement('div');
                            header.className = 'section-header';
                            header.textContent = `Section ${section.label}`; // "Section A" format per typical papers
                            // Actually payload just has "A". Let's use raw label.
                            header.textContent = section.label;
                            elPaperContent.appendChild(header);
                        }
                        // Questions
                        if (section.questions) {
                            section.questions.forEach(q => {
                                elPaperContent.appendChild(renderQuestionNode(q, 0, paper.defaults));
                            });
                        }
                    });
                } else if (paper.questions) {
                    paper.questions.forEach(q => {
                        elPaperContent.appendChild(renderQuestionNode(q, 0, paper.defaults));
                    });
                }

                // KaTeX Auto-Render
                if (window.renderMathInElement) {
                    renderMathInElement(elPaperContent, {
                        delimiters: [
                            {left: '$$', right: '$$', display: true},
                            {left: '$', right: '$', display: false}
                        ],
                        throwOnError: false
                    });
                }

                // Scroll to top
                window.scrollTo(0, 0);
            }

            // --- Node Rendering (Recursive) ---
            function renderQuestionNode(node, depth, defaults) {
                const container = document.createElement('div');
                container.className = `question-node ${depth > 0 ? 'child-node' : ''}`;
                container.id = `q-${sanitizeId(node.id)}`;
                
                // 1. Question Body
                const body = document.createElement('div');
                body.className = 'question-body';
                
                // Identifier
                const idSpan = document.createElement('span');
                idSpan.className = 'question-identifier';
                idSpan.textContent = node.id;
                body.appendChild(idSpan);

                // Prompt
                const textSpan = document.createElement('div');
                textSpan.className = 'question-text';
                textSpan.innerHTML = renderMarkdown(node.question);
                body.appendChild(textSpan);

                container.appendChild(body);

                // 2. Solution Block (Optional)
                if (node.solutionBlock) {
                    const sb = document.createElement('div');
                    sb.className = 'solution-block';

                    // Answer (Optional)
                    if (node.solutionBlock.answer) {
                        const ansRegion = document.createElement('div');
                        ansRegion.className = 'answer-region';
                        
                        const ansLabel = document.createElement('span');
                        ansLabel.className = 'answer-label';
                        ansLabel.textContent = 'Answer';
                        
                        const ansContent = document.createElement('span');
                        ansContent.innerHTML = renderMarkdown(node.solutionBlock.answer);

                        ansRegion.appendChild(ansLabel);
                        ansRegion.appendChild(ansContent);
                        sb.appendChild(ansRegion);
                    }

                    // Solution Details (Optional)
                    if (node.solutionBlock.solutionDetails) {
                        const sdWrapper = document.createElement('div');
                        sdWrapper.className = 'solution-details-wrapper';

                        // Toggle Control
                        const toggle = document.createElement('button');
                        toggle.className = 'disclosure-control';
                        toggle.innerHTML = `
                            <span class="disclosure-label">Show working</span>
                            <svg class="disclosure-icon" viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>
                        `;
                        
                        const content = document.createElement('div');
                        content.className = 'solution-details-content';

                        // Check Default State
                        let isExpanded = (defaults && defaults.expandedAll === false) ? false : true;
                        
                        // Initial State
                        updateToggleState(toggle, content, isExpanded);

                        // Click Handler
                        toggle.onclick = () => {
                            isExpanded = !isExpanded;
                            updateToggleState(toggle, content, isExpanded);
                        };

                        // Render Details Content
                        const details = node.solutionBlock.solutionDetails;
                        
                        // Keep in mind
                        if (details.keepInMind) {
                            const section = document.createElement('div');
                            section.className = 'sd-subsection';
                            section.innerHTML = `<span class="sd-label">Keep in mind</span><div class="keep-in-mind-body">${renderMarkdown(details.keepInMind)}</div>`;
                            content.appendChild(section);
                        }

                        // Formulas used
                        if (details.formulasUsed) {
                            const section = document.createElement('div');
                            section.className = 'sd-subsection';
                            section.innerHTML = `<span class="sd-label">Formulas used</span><div>${renderMarkdown(details.formulasUsed)}</div>`;
                            content.appendChild(section);
                        }

                        // Working
                        if (details.working) {
                            const section = document.createElement('div');
                            section.className = 'sd-subsection';
                            section.innerHTML = `<span class="sd-label">Working</span><div class="working-body">${renderMarkdown(details.working)}</div>`;
                            content.appendChild(section);
                        }

                        // Alternative Working (Array)
                        if (details.alternativeWorking && Array.isArray(details.alternativeWorking)) {
                            details.alternativeWorking.forEach(alt => {
                                const section = document.createElement('div');
                                section.className = 'sd-subsection';
                                section.innerHTML = `<span class="sd-label">Alternative working</span><div class="working-body">${renderMarkdown(alt)}</div>`;
                                content.appendChild(section);
                            });
                        } else if (typeof details.alternativeWorking === 'string') {
                             // Fallback if string
                             const section = document.createElement('div');
                             section.className = 'sd-subsection';
                             section.innerHTML = `<span class="sd-label">Alternative working</span><div class="working-body">${renderMarkdown(details.alternativeWorking)}</div>`;
                             content.appendChild(section);
                        }

                        sdWrapper.appendChild(toggle);
                        sdWrapper.appendChild(content);
                        sb.appendChild(sdWrapper);
                    }

                    container.appendChild(sb);
                }

                // 3. Recursion for Children
                if (node.children && node.children.length > 0) {
                    node.children.forEach(child => {
                        container.appendChild(renderQuestionNode(child, depth + 1, defaults));
                    });
                }

                return container;
            }

            function updateToggleState(btn, content, expanded) {
                const label = btn.querySelector('.disclosure-label');
                if (expanded) {
                    content.classList.add('expanded');
                    btn.setAttribute('aria-expanded', 'true');
                    label.textContent = "Hide working";
                } else {
                    content.classList.remove('expanded');
                    btn.setAttribute('aria-expanded', 'false');
                    label.textContent = "Show working";
                }
            }

            // --- Nav Logic ---
            function buildNavStructure(paper) {
                // Flatten list but keep depth info for visuals (not structure)
                // Also handle sections
                const list = [];
                
                if (paper.sections) {
                    paper.sections.forEach(section => {
                        if (section.label && section.label.trim() !== '') {
                            list.push({ type: 'section', label: section.label });
                        }
                        if (section.questions) {
                            section.questions.forEach(q => traverseNav(q, list, 0));
                        }
                    });
                } else if (paper.questions) {
                    paper.questions.forEach(q => traverseNav(q, list, 0));
                }
                return list;
            }

            function traverseNav(node, list, depth) {
                list.push({ type: 'item', id: node.id, depth: depth, targetId: `q-${sanitizeId(node.id)}` });
                if (node.children) {
                    node.children.forEach(c => traverseNav(c, list, depth + 1));
                }
            }

            function renderNav(items, container, isMobile = false) {
                container.innerHTML = '';
                const ul = document.createElement('ul');
                ul.className = 'nav-list';

                items.forEach(item => {
                    if (item.type === 'section') {
                        const li = document.createElement('li');
                        li.className = 'nav-section-label';
                        li.textContent = item.label;
                        ul.appendChild(li);
                    } else {
                        const li = document.createElement('li');
                        const btn = document.createElement('button');
                        btn.className = `nav-item ${item.depth > 0 ? 'is-child' : ''}`;
                        btn.textContent = item.id;
                        btn.onclick = () => {
                            const target = document.getElementById(item.targetId);
                            if (target) {
                                target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                
                                // Clean up active states (simple)
                                document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
                                btn.classList.add('active'); // This only sets clicked one active, need real intersection observer for perfect sync but this is baseline.
                                
                                if (isMobile) closeDrawer();
                            }
                        };
                        // Store target for IntersectionObserver matching
                        btn.dataset.targetId = item.targetId;
                        
                        li.appendChild(btn);
                        ul.appendChild(li);
                    }
                });
                container.appendChild(ul);
            }

            // --- Helpers ---
            function renderMarkdown(text) {
                if (!text) return '';
                if (!md) return text; // Fallback
                return md.render(text);
            }

            function sanitizeId(id) {
                return id.replace(/[^a-zA-Z0-9-_]/g, '-');
            }

            // --- Mobile Drawer ---
            function openDrawer() {
                elDrawer.classList.add('open');
                elOverlay.classList.add('open');
                elDrawer.setAttribute('aria-hidden', 'false');
            }

            function closeDrawer() {
                elDrawer.classList.remove('open');
                elOverlay.classList.remove('open');
                elDrawer.setAttribute('aria-hidden', 'true');
            }

            elMobileTrigger.onclick = openDrawer;
            elDrawerClose.onclick = closeDrawer;
            elOverlay.onclick = closeDrawer;

            // --- Intersection Observer for Nav Highlighting ---
            const observer = new IntersectionObserver((entries) => {
                // Find visible question nearest top
                // Simple heuristic: first intersecting entry
                const visible = entries.find(e => e.isIntersecting);
                if (visible) {
                    const id = visible.target.id;
                    // Highlight matching nav items
                    document.querySelectorAll('.nav-item').forEach(btn => {
                        if (btn.dataset.targetId === id) {
                            btn.classList.add('active');
                            // Ensure visible in nav rail
                            if (btn.scrollIntoViewIfNeeded) btn.scrollIntoViewIfNeeded();
                        } else {
                            btn.classList.remove('active');
                        }
                    });
                }
            }, { rootMargin: '-10% 0px -80% 0px' }); // Trigger when near top

            // MutationObserver to attach IntersectionObserver to new content
            const mutObserver = new MutationObserver(() => {
                document.querySelectorAll('.question-node').forEach(el => observer.observe(el));
            });
            mutObserver.observe(elPaperContent, { childList: true, subtree: true });

            // Start
            init();

        })();
    </script>
</body>
</html>
