<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AB","indexWithinVariant":"131","totalWithinVariant":"200","hueFamily":"purple","intensityMode":"","timestamp":"2026-01-07T06:15:07.190Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AB&quot;,&quot;indexWithinVariant&quot;:&quot;131&quot;,&quot;totalWithinVariant&quot;:&quot;200&quot;,&quot;hueFamily&quot;:&quot;purple&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-07T06:15:07.190Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>

    <!-- KaTeX CSS (No SRI) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <style>
        /* =========================================
           STAGE 0: CONSTANTS & RESET
           ColorLab B: PURPLE Force Hue Family
           ========================================= */
        :root {
            /* Palette - Purple (Hue 270) - Light Mode Only */
            --hue: 270;
            
            /* Surfaces */
            --c-bg-app: hsl(var(--hue), 20%, 98%);       /* Very light warm-purple tinted grey */
            --c-bg-paper: #ffffff;                       /* Pure white paper */
            --c-bg-nav: transparent;                     /* Nav shares shell surface */
            
            /* Text */
            --c-txt-primary: hsl(var(--hue), 25%, 12%);  /* Deep purple-black */
            --c-txt-secondary: hsl(var(--hue), 15%, 35%);/* Muted purple-grey */
            --c-txt-tertiary: hsl(var(--hue), 10%, 55%); /* Light purple-grey */
            
            /* Accents (ColorLab B + Stage 5 Override) */
            --c-accent: hsl(var(--hue), 80%, 55%);       /* Vibrant Purple */
            --c-accent-focus: hsl(var(--hue), 80%, 55%, 0.2);
            --c-accent-hover: hsl(var(--hue), 80%, 45%);

            /* Separators */
            --c-div-hairline: hsl(var(--hue), 10%, 90%);
            
            /* Spacing Scale */
            --sp-xs: 0.25rem;
            --sp-sm: 0.5rem;
            --sp-md: 1rem;
            --sp-lg: 1.5rem;
            --sp-xl: 2.5rem;
            --sp-xxl: 4rem; /* Top level question separation */

            /* Typography */
            --font-stack: 'Inter', system-ui, sans-serif;
            --fw-reg: 400;
            --fw-med: 500;
            --fw-bold: 600;

            /* Dimensions */
            --w-max: 1024px;
            --w-nav: 240px;
            --h-header: 64px;
        }

        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: var(--font-stack);
            background-color: var(--c-bg-app);
            color: var(--c-txt-primary);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        /* =========================================
           LAYOUT: DocumentFrameShell
           ========================================= */
        .app-shell {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .top-controls {
            height: var(--h-header);
            display: flex;
            align-items: center;
            padding: 0 var(--sp-md);
            background-color: var(--c-bg-app); /* Aligned to shell */
            border-bottom: 1px solid var(--c-div-hairline);
            position: sticky;
            top: 0;
            z-index: 50;
            width: 100%;
            max-width: var(--w-max);
            margin: 0 auto;
        }

        .document-frame {
            display: grid;
            grid-template-columns: var(--w-nav) 1fr;
            gap: var(--sp-lg);
            max-width: var(--w-max);
            margin: 0 auto;
            width: 100%;
            flex: 1;
            padding-bottom: var(--sp-xxl);
        }

        /* Mobile Layout overrides */
        @media (max-width: 768px) {
            .document-frame {
                display: block; /* Stack */
                padding: 0 var(--sp-md);
            }
            .nav-rail {
                display: none; /* Drawer used instead */
            }
        }

        /* =========================================
           NAVIGATION (Desktop Rail)
           ========================================= */
        .nav-rail {
            position: sticky;
            top: var(--h-header);
            height: calc(100vh - var(--h-header));
            padding-top: var(--sp-lg);
            overflow-y: auto;
            /* Scrollbar hiding */
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .nav-rail::-webkit-scrollbar {
            display: none;
        }

        .nav-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .nav-section-label {
            font-size: 0.75rem;
            color: var(--c-txt-tertiary);
            font-weight: var(--fw-bold);
            margin-top: var(--sp-md);
            margin-bottom: var(--sp-xs);
            padding-left: var(--sp-sm); /* Visual alignment */
        }

        .nav-item {
            display: block;
            padding: var(--sp-xs) var(--sp-sm);
            font-size: 0.875rem;
            color: var(--c-txt-secondary);
            text-decoration: none;
            border-radius: 4px;
            cursor: pointer;
            transition: color 0.1s ease, background-color 0.1s ease;
        }

        .nav-item:hover {
            color: var(--c-txt-primary);
            background-color: rgba(0,0,0,0.03);
        }

        /* Active State: Weight + Color (ColorLab B permitted) */
        .nav-item.active {
            font-weight: var(--fw-bold);
            color: var(--c-accent);
            background-color: rgba(126, 34, 206, 0.05); /* Subtle purple tint */
        }

        /* Typography scale for nesting depth (Visual only, list is flat) */
        .nav-item[data-depth="1"] { font-size: 0.8125rem; }
        .nav-item[data-depth="2"] { font-size: 0.75rem; opacity: 0.9; }

        /* =========================================
           MOBILE NAVIGATION (Drawer)
           ========================================= */
        .mobile-jump-trigger {
            display: none; /* Desktop default */
            margin-left: auto;
            background: none;
            border: none;
            color: var(--c-accent);
            font-weight: var(--fw-med);
            font-size: 0.9rem;
            cursor: pointer;
        }
        @media (max-width: 768px) {
            .mobile-jump-trigger { display: block; }
        }

        .nav-drawer-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.2);
            z-index: 100;
            display: none; /* JS toggles */
        }
        .nav-drawer {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 80%;
            max-width: 300px;
            background: var(--c-bg-paper);
            padding: var(--sp-md);
            overflow-y: auto;
            transform: translateX(100%);
            transition: transform 0.2s ease;
        }
        .nav-drawer.open {
            transform: translateX(0);
        }
        .drawer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--sp-lg);
            padding-bottom: var(--sp-sm);
            border-bottom: 1px solid var(--c-div-hairline);
        }
        .drawer-title {
            font-weight: var(--fw-bold);
            font-size: 1rem;
        }
        .drawer-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            line-height: 1;
            color: var(--c-txt-secondary);
            cursor: pointer;
        }

        /* =========================================
           PAPER CONTENT
           ========================================= */
        .paper-column {
            padding-top: var(--sp-lg);
            min-height: 50vh;
        }

        .paper-surface {
            background: var(--c-bg-paper); /* Explicit paper surface if desired, or blend */
            /* Stage 3 says Paper Surface inside Paper Region. For visual simplicity in this shell, we blend. */
            width: 100%;
        }

        .section-header-block {
            margin-bottom: var(--sp-lg);
            padding-bottom: var(--sp-sm);
            border-bottom: 1px solid var(--c-div-hairline);
        }
        .section-header-text {
            font-weight: var(--fw-bold);
            font-size: 1.25rem;
            color: var(--c-txt-primary);
        }

        /* Question Node Structure */
        .question-node {
            margin-bottom: var(--sp-xxl); /* Top level separation */
            scroll-margin-top: calc(var(--h-header) + var(--sp-md));
        }

        /* Children indentation */
        .question-children {
            margin-top: var(--sp-md);
            margin-left: var(--sp-md); /* Adaptive indentation */
            border-left: 1px solid transparent; /* Placeholder for potential guide */
        }
        @media (min-width: 768px) {
            .question-children { margin-left: var(--sp-lg); }
        }

        /* Question Body */
        .question-body {
            display: flex;
            gap: var(--sp-sm);
            margin-bottom: var(--sp-md);
        }
        .q-id {
            font-weight: var(--fw-bold);
            color: var(--c-txt-secondary);
            flex-shrink: 0;
            width: 2rem; /* Fixed width for alignment feel */
        }
        .q-prompt {
            font-size: 1.05rem;
            color: var(--c-txt-primary);
            line-height: 1.6;
            width: 100%;
        }

        /* Solution Block */
        .solution-block {
            margin-left: 2rem; /* Align with text, offset from ID */
            display: flex;
            flex-direction: column;
            gap: var(--sp-md);
        }

        /* Answer */
        .answer-region {
            /* Subordinate to question */
        }
        .answer-label {
            font-size: 0.75rem;
            font-weight: var(--fw-bold);
            color: var(--c-txt-secondary);
            margin-bottom: var(--sp-xs);
            display: block;
        }
        .answer-content {
            font-size: 1rem;
            color: var(--c-txt-primary);
        }

        /* Solution Details (Expandable) */
        .solution-details-wrapper {
            /* wrapper */
        }
        .disclosure-control {
            background: none;
            border: none;
            padding: 0;
            color: var(--c-accent);
            font-size: 0.9rem;
            font-weight: var(--fw-med);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: var(--sp-xs);
            margin-bottom: var(--sp-sm);
        }
        .disclosure-control:hover {
            color: var(--c-accent-hover);
            text-decoration: underline;
        }
        .disclosure-control:focus-visible {
            outline: 2px solid var(--c-accent);
            outline-offset: 2px;
            border-radius: 2px;
        }

        .solution-details-region {
            display: none; /* Collapsed by default via CSS class toggle */
            padding-top: var(--sp-sm);
            /* Optional weak left border for boundary clarity under density */
            border-left: 1px solid var(--c-div-hairline);
            padding-left: var(--sp-md);
        }
        .solution-details-region.expanded {
            display: block;
            animation: slideDown 0.2s ease-out;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Internal Subsections (Keep in mind, Formulas, Working) */
        .sd-subsection {
            margin-bottom: var(--sp-lg);
        }
        .sd-subsection:last-child {
            margin-bottom: 0;
        }
        .sd-label {
            font-size: 0.75rem;
            font-weight: var(--fw-bold);
            color: var(--c-txt-tertiary); /* Quiet label */
            margin-bottom: var(--sp-xs);
            display: block;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .sd-body {
            font-size: 0.95rem; /* Subordinate size */
            color: var(--c-txt-secondary); /* Subordinate contrast */
        }
        
        /* Alternative Working separation */
        .alt-working-separator {
            height: 1px;
            background: var(--c-div-hairline);
            margin: var(--sp-lg) 0;
        }

        /* =========================================
           MARKDOWN & KATEX CONTENT STYLES
           ========================================= */
        .md-content p {
            margin-top: 0;
            margin-bottom: var(--sp-md);
        }
        .md-content p:last-child {
            margin-bottom: 0;
        }
        .md-content ul, .md-content ol {
            margin-top: 0;
            margin-bottom: var(--sp-md);
            padding-left: var(--sp-lg);
        }
        
        /* KaTeX Containment Invariant */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding: var(--sp-xs) 0;
            margin: var(--sp-sm) 0;
            /* Scrollbar hiding for cleaner look */
            scrollbar-width: thin;
            scrollbar-color: var(--c-div-hairline) transparent;
        }
        .katex-html {
            background: transparent !important; /* Force transparent inline */
        }
        
        /* Markdown Tables */
        .md-content table {
            border-collapse: collapse;
            width: 100%;
            font-size: 0.9em;
            margin-bottom: var(--sp-md);
        }
        .md-content th, .md-content td {
            border: 1px solid var(--c-div-hairline);
            padding: var(--sp-sm);
            text-align: left;
        }
        .md-content th {
            font-weight: var(--fw-bold);
            background: rgba(0,0,0,0.02);
        }

        /* Images / Diagrams */
        .md-content img, .md-content svg {
            max-width: 100%;
            height: auto;
            display: block;
            margin: var(--sp-md) 0;
        }

        /* Error State */
        .error-message {
            padding: var(--sp-xl);
            text-align: center;
            color: var(--c-txt-secondary);
            font-weight: var(--fw-bold);
            border: 1px dashed var(--c-div-hairline);
            margin-top: var(--sp-xl);
        }

        /* Controls UI */
        .paper-selector {
            padding: var(--sp-xs) var(--sp-sm);
            border: 1px solid var(--c-div-hairline);
            border-radius: 4px;
            background: var(--c-bg-paper);
            color: var(--c-txt-primary);
            font-family: inherit;
            font-size: 0.9rem;
        }
        .paper-selector:focus {
            outline: 2px solid var(--c-accent);
            border-color: var(--c-accent);
        }

    </style>
    
    <!-- Scripts -->
    <!-- Markdown-it (No SRI) -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>
    <!-- KaTeX JS (No SRI) -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
</head>
<body>

<div class="app-shell">
    <!-- Top Controls -->
    <header class="top-controls">
        <select id="paper-selector" class="paper-selector" aria-label="Select Paper">
            <option value="" disabled selected>Loading papers...</option>
        </select>
        <button id="mobile-jump-trigger" class="mobile-jump-trigger" aria-label="Jump to question">
            Jump to
        </button>
    </header>

    <!-- Document Frame -->
    <main class="document-frame">
        
        <!-- Desktop Nav Rail -->
        <aside class="nav-rail">
            <nav id="nav-list-container" class="nav-list" aria-label="Paper navigation">
                <!-- Nav items generated here -->
            </nav>
        </aside>

        <!-- Paper Content Region -->
        <section class="paper-column">
            <div id="paper-content" class="paper-surface">
                <!-- Paper content generated here -->
                <div class="error-message" style="display:none;" id="loading-indicator">Loading...</div>
            </div>
        </section>

    </main>

    <!-- Mobile Nav Drawer -->
    <div id="nav-drawer-backdrop" class="nav-drawer-backdrop">
        <aside id="nav-drawer" class="nav-drawer">
            <header class="drawer-header">
                <span class="drawer-title">Jump to</span>
                <button id="drawer-close" class="drawer-close" aria-label="Close navigation">&times;</button>
            </header>
            <nav id="drawer-nav-list" class="nav-list">
                <!-- Cloned nav items -->
            </nav>
        </aside>
    </div>
</div>

<script>
/**
 * STAGE 0 CONSTANTS
 */
const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

// State
let payloadData = null;
let currentPaperKey = null;

// Markdown Parser Setup
const md = window.markdownit ? window.markdownit({
    html: true,       // Enable HTML (SVG) passthrough
    linkify: true,
    breaks: false     // Disable <br> on newlines for KaTeX compat
}) : null;

if (md) {
    // Disable escaping to preserve TeX backslashes
    md.inline.ruler.disable(['escape']);
}

/**
 * INIT
 */
document.addEventListener('DOMContentLoaded', async () => {
    initMobileNav();
    await loadPayload();
});

async function loadPayload() {
    const loader = document.getElementById('loading-indicator');
    loader.style.display = 'block';

    try {
        const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
        if (!response.ok) throw new Error('Network response was not ok');
        payloadData = await response.json();
        
        initPaperSelector();
        
        // Load first paper by default
        if (payloadData.papers && payloadData.papers.length > 0) {
            loadPaper(payloadData.papers[0].key);
        }
        loader.style.display = 'none';

    } catch (error) {
        console.error("Payload load failed:", error);
        renderFailureMode();
    }
}

function renderFailureMode() {
    const container = document.getElementById('paper-content');
    container.innerHTML = '<div class="error-message">PAPERS PAYLOAD MISSING</div>';
    document.getElementById('paper-selector').innerHTML = '<option disabled>Unavailable</option>';
}

/**
 * SELECTOR Logic
 */
function initPaperSelector() {
    const selector = document.getElementById('paper-selector');
    selector.innerHTML = '';
    
    payloadData.papers.forEach(paper => {
        const option = document.createElement('option');
        option.value = paper.key;
        option.textContent = paper.label || paper.key;
        selector.appendChild(option);
    });

    selector.addEventListener('change', (e) => {
        loadPaper(e.target.value);
    });
}

/**
 * PAPER RENDERING
 */
function loadPaper(key) {
    currentPaperKey = key;
    const paper = payloadData.papers.find(p => p.key === key);
    if (!paper) return;

    // Reset Content
    const contentContainer = document.getElementById('paper-content');
    contentContainer.innerHTML = '';

    // Collect questions for Navigation
    let flatNavItems = [];

    // Check for sections
    if (paper.sections) {
        paper.sections.forEach(section => {
            // Add Section Header Block to Paper
            if (section.label && section.label.trim() !== "") {
                const sectionHeader = document.createElement('div');
                sectionHeader.className = 'section-header-block';
                sectionHeader.innerHTML = `<div class="section-header-text">${section.label}</div>`;
                contentContainer.appendChild(sectionHeader);
                
                // Add Section Label to Nav (Non-clickable)
                flatNavItems.push({ type: 'section', label: section.label });
            }
            // Render questions in section
            renderQuestionList(section.questions, contentContainer, flatNavItems, 0, paper.defaults);
        });
    } else if (paper.questions) {
        // Flat paper
        renderQuestionList(paper.questions, contentContainer, flatNavItems, 0, paper.defaults);
    }

    // Render Navigation
    renderNavigation(flatNavItems);

    // Trigger Math Rendering
    if (window.renderMathInElement) {
        renderMathInElement(contentContainer, {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false}
            ],
            throwOnError: false
        });
    }

    // Restore scroll
    window.scrollTo(0, 0);
}

function renderQuestionList(questions, container, navAccumulator, depth, defaults) {
    if (!questions) return;
    questions.forEach(q => {
        // Add to nav
        navAccumulator.push({ type: 'item', id: q.id, depth: depth });

        // Create Node
        const node = document.createElement('div');
        node.className = 'question-node';
        node.id = `q-${q.id}`;

        // 1. Question Body
        const qBody = document.createElement('div');
        qBody.className = 'question-body';
        qBody.innerHTML = `
            <div class="q-id">${q.id}</div>
            <div class="q-prompt md-content">${renderMarkdown(q.question)}</div>
        `;
        node.appendChild(qBody);

        // 2. Solution Block (Optional)
        if (q.solutionBlock) {
            const solBlock = document.createElement('div');
            solBlock.className = 'solution-block';

            // Answer
            if (q.solutionBlock.answer) {
                const ansRegion = document.createElement('div');
                ansRegion.className = 'answer-region';
                ansRegion.innerHTML = `
                    <span class="answer-label">Answer</span>
                    <div class="answer-content md-content">${renderMarkdown(q.solutionBlock.answer)}</div>
                `;
                solBlock.appendChild(ansRegion);
            }

            // Solution Details
            const details = q.solutionBlock.solutionDetails;
            if (details) {
                const wrapper = document.createElement('div');
                wrapper.className = 'solution-details-wrapper';

                const isExpandedDefault = defaults?.expandedAll !== false; // Default true unless explicitly false

                // Toggle Control
                const toggleBtn = document.createElement('button');
                toggleBtn.className = 'disclosure-control';
                toggleBtn.innerHTML = `<span>${isExpandedDefault ? 'Hide working' : 'Show working'}</span>`;
                
                // Region
                const region = document.createElement('div');
                region.className = `solution-details-region ${isExpandedDefault ? 'expanded' : ''}`;
                
                // Interaction
                toggleBtn.onclick = () => {
                    const expanded = region.classList.contains('expanded');
                    if (expanded) {
                        region.classList.remove('expanded');
                        toggleBtn.innerHTML = `<span>Show working</span>`;
                    } else {
                        region.classList.add('expanded');
                        toggleBtn.innerHTML = `<span>Hide working</span>`;
                    }
                };

                // Content Construction
                let html = '';
                
                // Keep in mind
                if (details.keepInMind) {
                    html += `
                        <div class="sd-subsection">
                            <span class="sd-label">Keep in mind</span>
                            <div class="sd-body md-content">${renderMarkdown(details.keepInMind)}</div>
                        </div>
                    `;
                }
                
                // Formulas
                if (details.formulasUsed) {
                    html += `
                        <div class="sd-subsection">
                            <span class="sd-label">Formulas used</span>
                            <div class="sd-body md-content">${renderMarkdown(details.formulasUsed)}</div>
                        </div>
                    `;
                }

                // Working
                if (details.working) {
                    html += `
                        <div class="sd-subsection">
                            <span class="sd-label">Working</span>
                            <div class="sd-body md-content">${renderMarkdown(details.working)}</div>
                        </div>
                    `;
                }

                // Alt Working
                if (details.alternativeWorking && Array.isArray(details.alternativeWorking)) {
                    details.alternativeWorking.forEach(alt => {
                        html += `
                            <div class="alt-working-separator"></div>
                            <div class="sd-subsection">
                                <span class="sd-label">Alternative working</span>
                                <div class="sd-body md-content">${renderMarkdown(alt)}</div>
                            </div>
                        `;
                    });
                } else if (details.alternativeWorking) {
                     // Single string fallback if payload structure varies slightly
                     html += `
                        <div class="alt-working-separator"></div>
                        <div class="sd-subsection">
                            <span class="sd-label">Alternative working</span>
                            <div class="sd-body md-content">${renderMarkdown(details.alternativeWorking)}</div>
                        </div>
                    `;
                }

                region.innerHTML = html;
                wrapper.appendChild(toggleBtn);
                wrapper.appendChild(region);
                solBlock.appendChild(wrapper);
            }
            node.appendChild(solBlock);
        }

        // 3. Children
        if (q.children && q.children.length > 0) {
            const childContainer = document.createElement('div');
            childContainer.className = 'question-children';
            renderQuestionList(q.children, childContainer, navAccumulator, depth + 1, defaults);
            node.appendChild(childContainer);
        }

        container.appendChild(node);
    });
}

function renderMarkdown(text) {
    if (!text) return '';
    return md ? md.render(text) : text;
}

/**
 * NAVIGATION
 */
function renderNavigation(items) {
    const desktopList = document.getElementById('nav-list-container');
    const mobileList = document.getElementById('drawer-nav-list');
    
    desktopList.innerHTML = '';
    mobileList.innerHTML = '';

    items.forEach(item => {
        if (item.type === 'section') {
            // Section Label
            const label = document.createElement('div');
            label.className = 'nav-section-label';
            label.textContent = item.label;
            
            desktopList.appendChild(label.cloneNode(true));
            mobileList.appendChild(label.cloneNode(true));
        } else {
            // Link Item
            const link = document.createElement('a');
            link.className = 'nav-item';
            link.href = `#q-${item.id}`;
            link.textContent = item.id;
            link.dataset.depth = item.depth || 0;
            
            link.onclick = (e) => {
                // e.preventDefault();
                // We let anchor click happen for hash, but can close drawer
                closeMobileNav();
                // Highlight logic handled by IntersectionObserver ideally, 
                // but for prototype click-to-active is simpler:
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                e.target.classList.add('active');
            };

            const linkClone = link.cloneNode(true);
            linkClone.onclick = (e) => {
                closeMobileNav();
                // Sync active state to desktop
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                // Find corresponding desktop link
                const dLink = Array.from(desktopList.querySelectorAll('.nav-item')).find(a => a.getAttribute('href') === link.getAttribute('href'));
                if(dLink) dLink.classList.add('active');
                e.target.classList.add('active');
            };

            desktopList.appendChild(link);
            mobileList.appendChild(linkClone);
        }
    });
}

/**
 * MOBILE DRAWER LOGIC
 */
function initMobileNav() {
    const trigger = document.getElementById('mobile-jump-trigger');
    const closeBtn = document.getElementById('drawer-close');
    const backdrop = document.getElementById('nav-drawer-backdrop');
    const drawer = document.getElementById('nav-drawer');

    function open() {
        backdrop.style.display = 'block';
        // Force reflow
        void drawer.offsetWidth; 
        drawer.classList.add('open');
    }

    function close() {
        drawer.classList.remove('open');
        setTimeout(() => {
            backdrop.style.display = 'none';
        }, 200);
    }

    trigger.onclick = open;
    closeBtn.onclick = close;
    backdrop.onclick = (e) => {
        if (e.target === backdrop) close();
    };

    window.closeMobileNav = close;
}

</script>
</body>
</html>
