<!DOCTYPE html>
<html lang="en">
  <head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"ABC","indexWithinVariant":"173","totalWithinVariant":"320","hueFamily":"red","intensityMode":"accent_only","timestamp":"2026-01-07T17:29:01.670Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;ABC&quot;,&quot;indexWithinVariant&quot;:&quot;173&quot;,&quot;totalWithinVariant&quot;:&quot;320&quot;,&quot;hueFamily&quot;:&quot;red&quot;,&quot;intensityMode&quot;:&quot;accent_only&quot;,&quot;timestamp&quot;:&quot;2026-01-07T17:29:01.670Z&quot;}'>

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RTQ â€“ Maths Paper Solution Viewer</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- KaTeX CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"
    />

    <!-- KaTeX JS & Auto-render -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Markdown-it -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Tailwind Config -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              // Soft-warm neutral base (Stone-ish)
              bg: {
                page: "#fcfbf9",
                paper: "#ffffff",
                nav: "#fcfbf9", // Same as page per Stage 5.4.2
                frame: "#fcfbf9",
              },
              border: {
                hairline: "#e7e5e4", // Stone-200
                subtle: "#d6d3d1",   // Stone-300
              },
              text: {
                primary: "#1c1917",   // Stone-900
                secondary: "#57534e", // Stone-600
                tertiary: "#78716c",  // Stone-500
              },
              surface: {
                wash: "#fafaf9", // Very subtle stone-50
              },
              // Restrained accent (Stage 5.3.2 Override + Stage 6.0.11)
              accent: {
                DEFAULT: "#2563eb", // Blue-600
                hover: "#1d4ed8",   // Blue-700
                light: "#eff6ff",   // Blue-50
              }
            },
            fontFamily: {
              sans: ["Inter", "system-ui", "sans-serif"],
            },
          },
        },
      };
    </script>

    <style>
      /* Base Typography & Reset */
      body {
        font-family: 'Inter', system-ui, sans-serif;
        background-color: #fcfbf9;
        color: #1c1917;
      }

      /* Scrollbar hiding for Nav (Stage 6 Add-on) */
      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }

      /* KaTeX Containment Invariant (Stage 6.0.8) */
      .katex-display {
        overflow-x: auto;
        overflow-y: hidden;
        max-width: 100%;
        padding-bottom: 4px; /* Space for scrollbar */
        margin: 0.5em 0;
      }
      
      /* Inline Math background rule (Stage 5.8.4) */
      .katex {
        background-color: transparent !important;
      }

      /* Focus Visibility (Stage 5.5.2) */
      *:focus-visible {
        outline: 2px solid #2563eb;
        outline-offset: 2px;
      }

      /* Markdown Content Styling */
      .markdown-content p {
        margin-bottom: 0.75em;
        line-height: 1.6;
      }
      .markdown-content p:last-child {
        margin-bottom: 0;
      }
      .markdown-content ul {
        list-style-type: disc;
        padding-left: 1.25em;
        margin-bottom: 0.75em;
      }
      .markdown-content ol {
        list-style-type: decimal;
        padding-left: 1.25em;
        margin-bottom: 0.75em;
      }
      .markdown-content table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 0.75em;
        font-size: 0.95em;
      }
      .markdown-content th, .markdown-content td {
        border: 1px solid #e7e5e4;
        padding: 0.5em;
        text-align: left;
      }
      .markdown-content th {
        font-weight: 600;
        background-color: transparent;
      }
      
      /* Keep tables scrollable on mobile */
      .table-wrapper {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      /**
       * STAGE 0: CONSTANTS
       */
      const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
      const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

      // Markdown Configuration (Stage 6 Add-on)
      const md = window.markdownit
        ? window.markdownit({
            html: true, // Allow inline SVG
            linkify: true,
            breaks: false, // Critical: prevents <br> in math
          })
        : null;

      if (md) {
        md.inline.ruler.disable(['escape']); // Preserve TeX backslashes
      }

      /**
       * Utility: Chevron Icon
       */
      const ChevronIcon = ({ expanded, className }) => (
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="16"
          height="16"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          strokeWidth="2"
          strokeLinecap="round"
          strokeLinejoin="round"
          className={`transition-transform duration-200 ${expanded ? "rotate-180" : ""} ${className}`}
        >
          <polyline points="6 9 12 15 18 9"></polyline>
        </svg>
      );

      const MenuIcon = ({ className }) => (
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          strokeWidth="2"
          strokeLinecap="round"
          strokeLinejoin="round"
          className={className}
        >
          <line x1="3" y1="12" x2="21" y2="12"></line>
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
      );

      const CloseIcon = ({ className }) => (
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          strokeWidth="2"
          strokeLinecap="round"
          strokeLinejoin="round"
          className={className}
        >
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      );

      /**
       * Markdown Rendering Component
       * Handles HTML render + KaTeX auto-render
       */
      const MarkdownView = ({ content, className = "", as = "div" }) => {
        const ref = React.useRef(null);

        React.useEffect(() => {
          if (ref.current && window.renderMathInElement) {
            window.renderMathInElement(ref.current, {
              delimiters: [
                { left: "$$", right: "$$", display: true },
                { left: "$", right: "$", display: false },
              ],
              throwOnError: false,
            });
          }
        }, [content]);

        if (!md) return <div className={className}>{content}</div>;

        const html = md.render(content || "");
        const Tag = as;

        return (
          <Tag
            ref={ref}
            className={`markdown-content ${className}`}
            dangerouslySetInnerHTML={{ __html: html }}
          />
        );
      };

      /**
       * Navigation Components
       */
      const NavItem = ({ id, label, isSectionLabel, isActive, onClick }) => {
        if (isSectionLabel) {
          // Section Label: Non-clickable signpost (Stage 5.4.6)
          if (!label || label.trim() === "") return null;
          return (
            <div className="pt-4 pb-2 text-xs font-semibold text-text-tertiary uppercase tracking-wider select-none">
              {label}
            </div>
          );
        }

        // Question Item (Stage 5.4.5: Flat list, identifiers only)
        // Hierarchy via quiet type scale is permitted, but basic spec demands flat list.
        // We stick to a clean flat list with subtle state.
        return (
          <button
            onClick={onClick}
            className={`
              w-full text-left py-1.5 px-0 text-sm transition-colors duration-200
              ${isActive 
                ? "font-semibold text-accent" 
                : "text-text-secondary hover:text-text-primary hover:underline decoration-border-subtle underline-offset-4"
              }
            `}
          >
            {label}
          </button>
        );
      };

      const NavigationList = ({ paper, currentId, onNavigate }) => {
        // Flatten logic for rendering
        // If sections exist, iterate sections. Else questions.
        const renderList = () => {
          if (paper.sections && paper.sections.length > 0) {
            return paper.sections.map((sec, idx) => (
              <React.Fragment key={`sec-${idx}`}>
                <NavItem isSectionLabel label={sec.label} />
                {sec.questions.map((q) => (
                   <NavItem
                     key={q.id}
                     id={q.id}
                     label={q.id}
                     isActive={currentId === q.id}
                     onClick={() => onNavigate(q.id)}
                   />
                ))}
              </React.Fragment>
            ));
          } else if (paper.questions) {
            return paper.questions.map((q) => (
               <NavItem
                 key={q.id}
                 id={q.id}
                 label={q.id}
                 isActive={currentId === q.id}
                 onClick={() => onNavigate(q.id)}
               />
            ));
          }
          return null;
        };

        return <div className="flex flex-col">{renderList()}</div>;
      };

      /**
       * Solution Details Components (Stage 5.9)
       */
      const SolutionSubsection = ({ title, content, type }) => {
        if (!content) return null;

        // Visual Hierarchy Adjustments
        // Keep in mind: More prominent than formulas, subordinate to Answer
        // Formulas: Less prominent
        // Working: Primary derivation
        
        let containerClass = "mt-4";
        let labelClass = "text-sm font-bold text-text-secondary mb-1";
        let contentClass = "text-text-secondary text-sm";
        let wrapper = "div";

        if (type === "keepInMind") {
           labelClass = "text-sm font-bold text-text-secondary mb-1 flex items-center gap-2";
        }

        return (
          <div className={containerClass}>
            <div className={labelClass}>{title}</div>
            <MarkdownView content={content} className={contentClass} />
          </div>
        );
      };

      const SolutionDetailsRegion = ({ details }) => {
        const { keepInMind, formulasUsed, working, alternativeWorking } = details;

        // Stage 5.8: Working and Alternative Working must be demarcated if both exist
        // Order: KeepInMind -> Formulas -> Working -> Alt

        return (
          <div className="pt-2 pb-4 animate-in fade-in slide-in-from-top-1 duration-200">
             {/* Optional: Region Wash (Stage 3 permit) - keeping it clean for now per minimal bias */}
             {keepInMind && (
               <SolutionSubsection title="Keep in mind" content={keepInMind} type="keepInMind" />
             )}
             
             {/* Divider if needed between KiM and Formulas? Spacing is primary. */}
             
             {formulasUsed && (
               <SolutionSubsection title="Formulas used" content={formulasUsed} type="formulasUsed" />
             )}

             {working && (
               <SolutionSubsection title="Working" content={working} type="working" />
             )}

             {/* Alternative Working Array */}
             {alternativeWorking && Array.isArray(alternativeWorking) && alternativeWorking.map((alt, idx) => (
               <div key={idx} className="mt-6 pt-4 border-t border-border-hairline">
                 <div className="text-sm font-bold text-text-secondary mb-1">Alternative working</div>
                 <MarkdownView content={alt} className="text-text-secondary text-sm" />
               </div>
             ))}
          </div>
        );
      };

      /**
       * Core Content Components
       */
      const QuestionNode = ({ node, depth = 0, paperDefaults }) => {
        // Defaults
        const hasSolutionBlock = !!node.solutionBlock;
        const hasAnswer = hasSolutionBlock && !!node.solutionBlock.answer;
        const hasDetails = hasSolutionBlock && !!node.solutionBlock.solutionDetails;
        
        // Expansion state
        const [isExpanded, setIsExpanded] = React.useState(
          paperDefaults?.expandedAll !== false
        );

        const toggleExpanded = () => setIsExpanded(!isExpanded);

        // Separation Logic (Stage 5.1 / 1.2)
        // Top-level: Strong separation
        // Child: Less separation
        // Indentation for children (Stage 3E)
        
        const nodeStyle = depth === 0 ? "mb-12" : "mt-6"; 
        const indentStyle = depth > 0 ? "pl-4 md:pl-6 border-l border-transparent" : "";

        return (
          <div id={node.id} className={`group ${nodeStyle} ${indentStyle}`}>
            {/* Question Body */}
            <div className="mb-3">
              <div className="flex flex-row gap-3">
                <span className="text-text-secondary font-medium shrink-0 select-none" aria-hidden="true">
                  {node.id}
                </span>
                <div className="flex-1">
                  <MarkdownView 
                    content={node.question} 
                    className="text-text-primary text-base font-medium leading-relaxed" 
                  />
                </div>
              </div>
            </div>

            {/* Solution Block */}
            {hasSolutionBlock && (
              <div className="ml-0 pl-0 md:ml-[calc(2em+0.75rem)]">
                {/* Answer */}
                {hasAnswer && (
                  <div className="mb-2">
                     <span className="text-xs font-bold text-text-tertiary uppercase tracking-wide block mb-1">
                       Answer
                     </span>
                     <MarkdownView 
                       content={node.solutionBlock.answer} 
                       className="text-text-primary font-medium" 
                     />
                  </div>
                )}

                {/* Solution Details Toggle */}
                {hasDetails && (
                  <div className="mt-3">
                    <button 
                      onClick={toggleExpanded}
                      className="inline-flex items-center gap-1.5 text-sm font-medium text-accent hover:text-accent-hover transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-1 focus-visible:ring-accent rounded-sm"
                      aria-expanded={isExpanded}
                      aria-controls={`details-${node.id}`}
                    >
                      <span>{isExpanded ? "Hide working" : "Show working"}</span>
                      <ChevronIcon expanded={isExpanded} className="w-4 h-4" />
                    </button>

                    {/* Expandable Region */}
                    {isExpanded && (
                      <div id={`details-${node.id}`} className="mt-2">
                        {/* Optional Surface Wash - permitted by Stage 3/5.3.3 */}
                        <div className="bg-surface-wash rounded-sm px-3 py-1 -mx-3 border border-transparent">
                          <SolutionDetailsRegion details={node.solutionBlock.solutionDetails} />
                        </div>
                      </div>
                    )}
                  </div>
                )}
              </div>
            )}

            {/* Recursion for Children */}
            {node.children && node.children.length > 0 && (
              <div className="mt-2">
                {node.children.map((child, idx) => (
                  <QuestionNode 
                    key={idx} 
                    node={child} 
                    depth={depth + 1} 
                    paperDefaults={paperDefaults} 
                  />
                ))}
              </div>
            )}
          </div>
        );
      };

      /**
       * Main Application Shell
       */
      const App = () => {
        const [payload, setPayload] = React.useState(null);
        const [status, setStatus] = React.useState("loading"); // loading, success, error
        const [currentPaperIndex, setCurrentPaperIndex] = React.useState(0);
        const [isDrawerOpen, setIsDrawerOpen] = React.useState(false);

        // Fetch Payload
        React.useEffect(() => {
          fetch(RTQ_PAPERS_PAYLOAD_PATH)
            .then(res => {
              if (!res.ok) throw new Error("Network response was not ok");
              return res.json();
            })
            .then(data => {
              if (!data || !data.papers) throw new Error("Invalid payload format");
              setPayload(data);
              setStatus("success");
            })
            .catch(err => {
              console.error("Payload loading error:", err);
              setStatus("error");
            });
        }, []);

        const activePaper = payload?.papers?.[currentPaperIndex];

        // Navigation Handler
        const handleNavigate = (id) => {
          const el = document.getElementById(id);
          if (el) {
            el.scrollIntoView({ behavior: "smooth", block: "start" });
            setIsDrawerOpen(false); // Close drawer on mobile
          }
        };

        // Render States
        if (status === "loading") {
          return (
            <div className="min-h-screen flex items-center justify-center text-text-tertiary">
              <span className="animate-pulse">Loading papers...</span>
            </div>
          );
        }

        if (status === "error" || !activePaper) {
          return (
            <div className="min-h-screen flex items-center justify-center text-text-primary font-bold">
              PAPERS PAYLOAD MISSING
            </div>
          );
        }

        // Layout Construction (Stage 3 Shell)
        return (
          <div className="min-h-screen bg-bg-page text-text-primary flex flex-col items-center">
            
            {/* Top Controls Region (Aligned to Shell) */}
            <div className="w-full max-w-5xl px-4 md:px-8 pt-6 pb-4 flex items-center justify-between">
              {/* Paper Selector */}
              <div className="flex items-center gap-3">
                 <label htmlFor="paper-select" className="text-sm font-medium text-text-secondary hidden sm:inline">Paper:</label>
                 <select
                   id="paper-select"
                   className="bg-white border border-border-subtle text-text-primary text-sm rounded px-2 py-1.5 focus:border-accent focus:ring-1 focus:ring-accent outline-none"
                   value={currentPaperIndex}
                   onChange={(e) => setCurrentPaperIndex(Number(e.target.value))}
                 >
                   {payload.papers.map((p, idx) => (
                     <option key={p.key} value={idx}>{p.label}</option>
                   ))}
                 </select>
              </div>

              {/* Mobile Jump To Trigger */}
              <button 
                className="md:hidden flex items-center gap-2 text-sm font-medium text-accent hover:underline"
                onClick={() => setIsDrawerOpen(true)}
              >
                <span>Jump to</span>
                <MenuIcon className="w-4 h-4" />
              </button>
            </div>

            {/* DocumentFrameShell */}
            <div className="w-full max-w-5xl flex-1 flex flex-row items-start gap-8 px-4 md:px-8 pb-12">
              
              {/* Desktop Navigation Rail (Left Column) */}
              <aside className="hidden md:block w-48 shrink-0 sticky top-6 max-h-[calc(100vh-3rem)] overflow-y-auto no-scrollbar py-2">
                <nav aria-label="Paper navigation">
                  <NavigationList 
                    paper={activePaper} 
                    currentId={null} // Active state tracking via intersection obs could go here, omitting for simple harness
                    onNavigate={handleNavigate} 
                  />
                </nav>
              </aside>

              {/* Paper Document Column (Right/Main) */}
              <main className="flex-1 min-w-0 bg-bg-paper">
                {/* Sectioned Paper Handling */}
                {activePaper.sections ? (
                  <div className="space-y-12">
                    {activePaper.sections.map((sec, sIdx) => (
                      <section key={sIdx}>
                        {sec.label && (
                           <div className="border-b border-border-hairline mb-8 pb-2">
                             <h2 className="text-lg font-bold text-text-primary">{sec.label}</h2>
                           </div>
                        )}
                        <div>
                          {sec.questions.map((q, qIdx) => (
                            <QuestionNode 
                              key={q.id} 
                              node={q} 
                              paperDefaults={activePaper.defaults} 
                            />
                          ))}
                        </div>
                      </section>
                    ))}
                  </div>
                ) : (
                  // Flat Paper
                  <div>
                    {activePaper.questions.map((q) => (
                      <QuestionNode 
                        key={q.id} 
                        node={q} 
                        paperDefaults={activePaper.defaults} 
                      />
                    ))}
                  </div>
                )}
              </main>

            </div>

            {/* Mobile Navigation Drawer */}
            {isDrawerOpen && (
              <div className="fixed inset-0 z-50 flex justify-end md:hidden">
                {/* Scrim */}
                <div 
                  className="absolute inset-0 bg-black/20 backdrop-blur-[1px]" 
                  onClick={() => setIsDrawerOpen(false)}
                ></div>
                
                {/* Drawer Content */}
                <div className="relative w-64 h-full bg-bg-nav shadow-xl border-l border-border-hairline flex flex-col animate-in slide-in-from-right duration-200">
                  <div className="p-4 border-b border-border-hairline flex items-center justify-between">
                    <span className="font-semibold text-text-primary">Jump to</span>
                    <button 
                      onClick={() => setIsDrawerOpen(false)}
                      className="text-text-secondary hover:text-text-primary p-1"
                    >
                      <CloseIcon className="w-5 h-5" />
                    </button>
                  </div>
                  <div className="flex-1 overflow-y-auto p-4">
                    <NavigationList 
                      paper={activePaper} 
                      currentId={null} 
                      onNavigate={handleNavigate} 
                    />
                  </div>
                </div>
              </div>
            )}

          </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
