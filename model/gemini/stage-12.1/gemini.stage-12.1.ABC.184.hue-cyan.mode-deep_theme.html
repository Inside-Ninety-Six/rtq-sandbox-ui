<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"ABC","indexWithinVariant":"184","totalWithinVariant":"320","hueFamily":"cyan","intensityMode":"deep_theme","timestamp":"2026-01-07T17:58:59.112Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;ABC&quot;,&quot;indexWithinVariant&quot;:&quot;184&quot;,&quot;totalWithinVariant&quot;:&quot;320&quot;,&quot;hueFamily&quot;:&quot;cyan&quot;,&quot;intensityMode&quot;:&quot;deep_theme&quot;,&quot;timestamp&quot;:&quot;2026-01-07T17:58:59.112Z&quot;}'>

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RTQ Maths Paper Solution Viewer</title>

<!-- Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

<!-- KaTeX CSS (No integrity, per instructions) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

<style>
    /* 
     * STAGE 6 ADD-ON (PARALLEL LAB) — COLORLAB C: DEEP THEME (CYAN)
     * Mode: deep_theme
     * Hue: Cyan (approx 200deg)
     * All major surfaces chromatic. L steps for separation.
     */
    :root {
        /* HUE CONSTANT */
        --h-base: 200;

        /* SURFACES (Deep Theme rules) */
        /* Page: L[0.92-0.98] C[0.08-0.16] */
        --c-page-bg: oklch(0.94 0.1 var(--h-base));
        
        /* Frame: L[0.90-0.96] C[0.08-0.16] */
        --c-frame-bg: oklch(0.92 0.12 var(--h-base));
        
        /* Paper: L[0.94-0.99] C[0.06-0.14] */
        --c-paper-bg: oklch(0.97 0.07 var(--h-base));

        /* Solution Details Wash: C[0.05-0.10] */
        --c-wash-bg: oklch(0.95 0.08 var(--h-base));

        /* TEXT (High Legibility, mostly neutral) */
        /* Primary: L[0.15-0.25] C<=0.015 */
        --c-text-primary: oklch(0.2 0.015 var(--h-base));
        
        /* Secondary: L[0.25-0.40] C<=0.020 */
        --c-text-secondary: oklch(0.35 0.02 var(--h-base));
        
        /* Tertiary / Quietest */
        --c-text-tertiary: oklch(0.50 0.02 var(--h-base));

        /* ACCENT (Links, Focus, Active Nav) */
        /* L[0.45-0.65] C[0.16-0.26] */
        --c-accent: oklch(0.55 0.22 var(--h-base));

        /* BORDERS / DIVIDERS */
        /* C<=0.02 */
        --c-divider: oklch(0.85 0.02 var(--h-base));
        --c-divider-strong: oklch(0.75 0.02 var(--h-base));

        /* SPACING SYSTEM */
        --sp-xs: 0.25rem;
        --sp-sm: 0.5rem;
        --sp-md: 1rem;
        --sp-lg: 1.5rem;
        --sp-xl: 2.5rem;
        --sp-xxl: 4rem;

        /* LAYOUT */
        --w-frame-max: 1200px;
        --w-nav-rail: 240px;
        --h-top-controls: 60px;
    }

    /* RESET & BASE */
    *, *::before, *::after {
        box-sizing: border-box;
    }
    
    body {
        margin: 0;
        padding: 0;
        font-family: 'Inter', system-ui, -apple-system, sans-serif;
        background-color: var(--c-page-bg);
        color: var(--c-text-primary);
        line-height: 1.5;
        height: 100vh;
        overflow: hidden; /* App shell manages scrolling */
    }

    /* TYPOGRAPHY UTILS */
    .txt-h1 { font-size: 1.25rem; font-weight: 600; }
    .txt-h2 { font-size: 1.125rem; font-weight: 600; }
    .txt-body { font-size: 1rem; font-weight: 400; }
    .txt-sm { font-size: 0.875rem; }
    .txt-xs { font-size: 0.75rem; }
    
    .weight-med { font-weight: 500; }
    .weight-bold { font-weight: 600; }

    .clr-secondary { color: var(--c-text-secondary); }
    .clr-accent { color: var(--c-accent); }

    /* LAYOUT SHELL */
    .app-root {
        display: flex;
        flex-direction: column;
        height: 100%;
        max-width: var(--w-frame-max);
        margin: 0 auto;
        background-color: var(--c-frame-bg); /* Shared base surface for Desktop */
    }

    /* TOP CONTROLS */
    .top-controls {
        flex: 0 0 var(--h-top-controls);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 var(--sp-lg);
        border-bottom: 1px solid var(--c-divider);
        background-color: var(--c-frame-bg);
        z-index: 10;
    }

    .paper-selector {
        padding: var(--sp-sm);
        border: 1px solid var(--c-divider-strong);
        border-radius: 4px;
        background-color: var(--c-paper-bg);
        color: var(--c-text-primary);
        font-family: inherit;
        font-size: 0.875rem;
        min-width: 200px;
    }

    .mobile-jump-trigger {
        display: none; /* Desktop default */
        background: none;
        border: 1px solid var(--c-divider-strong);
        border-radius: 4px;
        padding: var(--sp-xs) var(--sp-sm);
        color: var(--c-accent);
        font-weight: 500;
        cursor: pointer;
    }

    /* MAIN CONTENT FRAME */
    .document-frame {
        flex: 1;
        display: flex;
        overflow: hidden; /* Columns scroll independently if needed */
        position: relative;
    }

    /* NAVIGATION RAIL (DESKTOP) */
    .nav-rail {
        flex: 0 0 var(--w-nav-rail);
        overflow-y: auto;
        padding: var(--sp-lg) 0 var(--sp-lg) var(--sp-lg);
        display: flex;
        flex-direction: column;
        /* Scrollbar hiding */
        scrollbar-width: none;
        -ms-overflow-style: none;
    }
    .nav-rail::-webkit-scrollbar { display: none; }

    .nav-list {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .nav-section-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--c-text-tertiary);
        margin-top: var(--sp-md);
        margin-bottom: var(--sp-xs);
        font-weight: 600;
        padding-left: var(--sp-sm); /* visual alignment */
    }
    
    .nav-item {
        display: block;
        padding: 4px 8px;
        text-decoration: none;
        color: var(--c-text-secondary);
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.875rem;
        transition: color 0.1s ease;
        /* Hierarchy via opacity/size logic applied in JS or utility classes */
    }
    .nav-item:hover {
        color: var(--c-text-primary);
        background-color: rgba(0,0,0,0.03);
    }
    .nav-item.active {
        color: var(--c-accent);
        font-weight: 600;
    }
    /* Hierarchy cues */
    .nav-depth-0 { font-size: 0.9375rem; }
    .nav-depth-1 { font-size: 0.875rem; color: var(--c-text-tertiary); }
    .nav-depth-2 { font-size: 0.8125rem; color: var(--c-text-tertiary); }
    
    /* PAPER REGION */
    .paper-region {
        flex: 1;
        overflow-y: auto;
        padding: var(--sp-xl) var(--sp-xxl);
        background-color: var(--c-paper-bg);
        scroll-behavior: smooth;
    }

    .paper-content {
        max-width: 800px;
        margin: 0 auto;
        min-height: 100%;
    }

    .loading-state, .error-state {
        text-align: center;
        padding: var(--sp-xl);
        color: var(--c-text-secondary);
    }

    /* QUESTION NODE */
    .question-node {
        margin-bottom: var(--sp-xl); /* Top level spacing */
        position: relative;
    }
    
    .question-node.child-node {
        margin-bottom: var(--sp-md);
        margin-top: var(--sp-md);
    }

    /* Question Body */
    .question-body {
        margin-bottom: var(--sp-sm);
    }
    
    .question-identifier {
        display: inline-block;
        font-weight: 600;
        color: var(--c-text-secondary);
        margin-right: var(--sp-xs);
        vertical-align: top;
    }

    .question-prompt {
        display: inline;
        color: var(--c-text-primary);
    }
    .question-prompt p { margin: 0 0 var(--sp-sm) 0; display: inline; }
    .question-prompt p:last-child { margin-bottom: 0; }

    /* Solution Block */
    .solution-block {
        margin-top: var(--sp-sm);
        padding-left: 0; /* No heavy indent */
    }

    /* Answer */
    .answer-block {
        margin-bottom: var(--sp-sm);
        display: flex;
        align-items: baseline;
    }
    .answer-label {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--c-text-tertiary);
        margin-right: var(--sp-sm);
        text-transform: uppercase;
        letter-spacing: 0.02em;
    }
    .answer-content {
        font-weight: 500;
        color: var(--c-text-primary);
    }

    /* Disclosure Control */
    .disclosure-control {
        background: none;
        border: none;
        padding: 0;
        font: inherit;
        color: var(--c-accent);
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        margin-bottom: var(--sp-sm);
    }
    .disclosure-control:hover { text-decoration: underline; }
    .disclosure-control:focus-visible { outline: 2px solid var(--c-accent); outline-offset: 2px; border-radius: 2px; }

    /* Solution Details */
    .solution-details {
        display: none;
        background-color: var(--c-wash-bg); /* Surface differentiation */
        padding: var(--sp-md) var(--sp-lg);
        margin-top: var(--sp-xs);
        /* No border radius or card styling */
    }
    .solution-details.expanded {
        display: block;
        animation: slideDown 0.2s ease-out;
    }

    @keyframes slideDown {
        from { opacity: 0; transform: translateY(-5px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .sd-subsection {
        margin-bottom: var(--sp-lg);
    }
    .sd-subsection:last-child { margin-bottom: 0; }

    .sd-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        font-weight: 600;
        color: var(--c-text-tertiary);
        margin-bottom: var(--sp-xs);
        display: block;
    }

    /* Subsections Styling */
    .keep-in-mind .sd-body {
        font-size: 0.9375rem;
        color: var(--c-text-secondary);
    }
    .keep-in-mind ul { padding-left: 1.25em; margin: 0; }
    
    .formulas-used .sd-body {
        font-family: inherit;
        color: var(--c-text-secondary);
    }
    
    .working-block .sd-body, .alt-working-block .sd-body {
        color: var(--c-text-primary);
    }

    /* Divider Logic */
    .divider-hairline {
        height: 1px;
        background-color: var(--c-divider);
        margin: var(--sp-md) 0;
        border: none;
    }

    /* Children Container */
    .children-container {
        margin-top: var(--sp-md);
        margin-left: var(--sp-md); /* Indentation for structure */
        padding-left: var(--sp-md);
        /* Optional hair line on left for structure in deep theme */
        border-left: 1px solid var(--c-divider); 
    }

    /* Section Header within Paper */
    .section-header-block {
        margin-top: var(--sp-xxl);
        margin-bottom: var(--sp-lg);
        border-bottom: 1px solid var(--c-divider);
        padding-bottom: var(--sp-xs);
    }
    .section-header-text {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--c-text-tertiary);
    }

    /* MOBILE DRAWER */
    .mobile-drawer-backdrop {
        display: none;
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(0,0,0,0.4);
        z-index: 100;
    }
    .mobile-drawer {
        position: absolute;
        bottom: 0; left: 0; width: 100%; height: 80%;
        background-color: var(--c-frame-bg);
        border-top-left-radius: 12px;
        border-top-right-radius: 12px;
        display: flex;
        flex-direction: column;
        transform: translateY(100%);
        transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }
    .mobile-drawer.open { transform: translateY(0); }
    
    .drawer-header {
        padding: var(--sp-md);
        border-bottom: 1px solid var(--c-divider);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .drawer-title { font-weight: 600; }
    .drawer-close {
        background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--c-text-secondary);
    }
    .drawer-content {
        flex: 1;
        overflow-y: auto;
        padding: var(--sp-md);
    }

    /* KaTeX & Markdown Overrides */
    .katex-display {
        overflow-x: auto;
        overflow-y: hidden;
        padding: 0.5em 0;
        margin: 0.5em 0;
        /* Scrollbar styling */
        scrollbar-width: thin;
        scrollbar-color: var(--c-divider-strong) transparent;
    }
    /* Block math background check - only strictly block math allowed background, but strictly transparent inline */
    .katex { font-size: 1.1em; } /* adjust size for readability */
    
    img, svg { max-width: 100%; height: auto; }
    
    /* Tables */
    table {
        width: 100%;
        border-collapse: collapse;
        margin: var(--sp-sm) 0;
        font-size: 0.9375rem;
    }
    th, td {
        border: 1px solid var(--c-divider);
        padding: 6px 10px;
        text-align: left;
    }
    th { font-weight: 600; background-color: rgba(0,0,0,0.02); }

    /* RESPONSIVE */
    @media (max-width: 768px) {
        .nav-rail { display: none; }
        .mobile-jump-trigger { display: block; }
        .paper-region { padding: var(--sp-md); }
        .app-root { background-color: var(--c-page-bg); }
        .children-container { margin-left: var(--sp-sm); padding-left: var(--sp-sm); }
    }
</style>
</head>
<body>

<div class="app-root">
    <!-- Top Controls -->
    <header class="top-controls">
        <select id="paper-selector" class="paper-selector" aria-label="Select Paper">
            <option value="" disabled selected>Loading papers...</option>
        </select>
        <button id="jump-trigger" class="mobile-jump-trigger">Jump to...</button>
    </header>

    <!-- Document Frame Shell -->
    <div class="document-frame">
        <!-- Desktop Nav Rail -->
        <nav class="nav-rail" id="desktop-nav" aria-label="Question Navigation">
            <!-- Injected via JS -->
        </nav>

        <!-- Paper Region -->
        <main class="paper-region" id="paper-scroll-container">
            <div id="paper-content" class="paper-content">
                <div class="loading-state">Initializing...</div>
            </div>
        </main>
    </div>
</div>

<!-- Mobile Drawer -->
<div id="drawer-backdrop" class="mobile-drawer-backdrop">
    <div id="mobile-drawer" class="mobile-drawer" role="dialog" aria-modal="true" aria-labelledby="drawer-title">
        <div class="drawer-header">
            <span id="drawer-title" class="drawer-title">Jump to Question</span>
            <button id="drawer-close" class="drawer-close" aria-label="Close navigation">&times;</button>
        </div>
        <div class="drawer-content" id="mobile-nav-content">
            <!-- Cloned Nav Content -->
        </div>
    </div>
</div>

<!-- SCRIPTS -->
<!-- Dependencies (No SRI/Integrity per Stage 6 rules) -->
<script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

<script>
    // --- STAGE 0 CONSTANTS ---
    const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
    const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

    // --- STATE ---
    let payload = null;
    let currentPaper = null;
    let md = null;

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', async () => {
        initMarkdown();
        try {
            const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
            if (!response.ok) throw new Error("Payload not found");
            payload = await response.json();
            
            if (!payload || !payload.papers || payload.papers.length === 0) {
                throw new Error("Invalid payload");
            }

            renderSelector();
            // Load first paper by default
            loadPaper(payload.papers[0].key);

        } catch (e) {
            console.error(e);
            document.getElementById('paper-content').innerHTML = `
                <div class="error-state">
                    <h2 class="txt-h2">PAPERS PAYLOAD MISSING</h2>
                    <p class="txt-body">Could not load content from ${RTQ_PAPERS_PAYLOAD_PATH}</p>
                </div>
            `;
            document.getElementById('paper-selector').innerHTML = '<option disabled>Error loading papers</option>';
        }
    });

    // --- MARKDOWN SETUP ---
    function initMarkdown() {
        if (window.markdownit) {
            md = window.markdownit({
                html: true,    // SVG passthrough
                linkify: true,
                breaks: false, // REQUIRED: false to prevent <br> in math blocks
                typographer: true
            });
            // Disable escape rule to preserve TeX backslashes
            md.inline.ruler.disable(['escape']);
        }
    }

    // --- RENDER LOGIC ---
    function renderSelector() {
        const select = document.getElementById('paper-selector');
        select.innerHTML = payload.papers.map(p => `<option value="${p.key}">${p.label}</option>`).join('');
        
        select.addEventListener('change', (e) => {
            loadPaper(e.target.value);
        });
    }

    function loadPaper(key) {
        currentPaper = payload.papers.find(p => p.key === key);
        if (!currentPaper) return;

        // Reset scroll
        document.getElementById('paper-scroll-container').scrollTop = 0;

        // Render Nav
        const navHTML = buildNavHTML(currentPaper);
        document.getElementById('desktop-nav').innerHTML = '<div class="nav-list">' + navHTML + '</div>';
        document.getElementById('mobile-nav-content').innerHTML = '<div class="nav-list">' + navHTML + '</div>';

        // Render Content
        let contentHTML = '';
        if (currentPaper.questions) {
            contentHTML = renderQuestionList(currentPaper.questions, 0);
        } else if (currentPaper.sections) {
            contentHTML = currentPaper.sections.map(sec => {
                let sectionHeader = '';
                if (sec.label && sec.label.trim().length > 0) {
                    sectionHeader = `
                        <div class="section-header-block">
                            <div class="section-header-text">${escapeHTML(sec.label)}</div>
                        </div>
                    `;
                }
                return sectionHeader + renderQuestionList(sec.questions, 0);
            }).join('');
        }

        document.getElementById('paper-content').innerHTML = contentHTML;

        // Post-Render: KaTeX
        if (window.renderMathInElement) {
            renderMathInElement(document.getElementById('paper-content'), {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false},
                    {left: '\\(', right: '\\)', display: false},
                    {left: '\\[', right: '\\]', display: true}
                ],
                throwOnError: false
            });
        }

        // Apply Defaults (Expand All unless false)
        const expandedAll = currentPaper.defaults?.expandedAll !== false;
        if (expandedAll) {
            document.querySelectorAll('.solution-details').forEach(el => {
                el.classList.add('expanded');
                // update toggle text
                const toggle = el.previousElementSibling.previousElementSibling; // Button is sibling to divider or spacer... 
                // Wait, DOM structure: Control -> Separator -> Details. 
                // Actually in HTML generation: Control -> Spacer/Div -> Details.
                // Let's rely on event handler or direct selection
            });
            // Update buttons text
            document.querySelectorAll('.disclosure-control').forEach(btn => {
                const icon = '<span aria-hidden="true" style="font-size: 0.8em;">▼</span>';
                btn.innerHTML = `Hide working ${icon}`;
                btn.setAttribute('aria-expanded', 'true');
            });
        }
        
        updateActiveNav();
    }

    // --- HTML GENERATORS ---

    // Recursive Question Renderer
    function renderQuestionList(questions, depth) {
        if (!questions || questions.length === 0) return '';
        
        // If depth > 0, wrap in children container
        const listHTML = questions.map(q => renderQuestionNode(q, depth)).join('');
        
        if (depth > 0) {
            return `<div class="children-container">${listHTML}</div>`;
        }
        return listHTML;
    }

    function renderQuestionNode(node, depth) {
        // Safe markdown render
        const renderMD = (text) => md ? md.render(text || '') : (text || '');
        
        // 1. Question Body
        const qBody = `
            <div class="question-body" id="q-${node.id}">
                <div class="question-identifier">${node.id}</div>
                <div class="question-prompt">${renderMD(node.question)}</div>
            </div>
        `;

        // 2. Solution Block (Optional)
        let solutionBlock = '';
        if (node.solutionBlock) {
            const sb = node.solutionBlock;
            let answerHTML = '';
            let detailsHTML = '';
            let controlHTML = '';

            // Answer
            if (sb.answer) {
                answerHTML = `
                    <div class="answer-block">
                        <span class="answer-label">Answer</span>
                        <div class="answer-content">${renderMD(sb.answer)}</div>
                    </div>
                `;
            }

            // Solution Details
            if (sb.solutionDetails) {
                const sd = sb.solutionDetails;
                // Check if any details exist
                const hasDetails = sd.keepInMind || sd.formulasUsed || sd.working || (sd.alternativeWorking && sd.alternativeWorking.length > 0);
                
                if (hasDetails) {
                    // Control
                    const icon = '<span aria-hidden="true" style="font-size: 0.8em;">▶</span>';
                    controlHTML = `
                        <button class="disclosure-control" aria-expanded="false" onclick="toggleDetails(this)">
                            Show working ${icon}
                        </button>
                    `;

                    // Details Content
                    let innerContent = '';
                    
                    if (sd.keepInMind) {
                        innerContent += `
                            <div class="sd-subsection keep-in-mind">
                                <span class="sd-label">Keep in mind</span>
                                <div class="sd-body">${renderMD(sd.keepInMind)}</div>
                            </div>
                            <hr class="divider-hairline">
                        `;
                    }
                    if (sd.formulasUsed) {
                        innerContent += `
                            <div class="sd-subsection formulas-used">
                                <span class="sd-label">Formulas used</span>
                                <div class="sd-body">${renderMD(sd.formulasUsed)}</div>
                            </div>
                            <hr class="divider-hairline">
                        `;
                    }
                    if (sd.working) {
                        innerContent += `
                            <div class="sd-subsection working-block">
                                <span class="sd-label">Working</span>
                                <div class="sd-body">${renderMD(sd.working)}</div>
                            </div>
                        `;
                    }
                    if (sd.alternativeWorking && sd.alternativeWorking.length > 0) {
                        sd.alternativeWorking.forEach((alt, idx) => {
                            innerContent += `
                                <hr class="divider-hairline">
                                <div class="sd-subsection alt-working-block">
                                    <span class="sd-label">Alternative working</span>
                                    <div class="sd-body">${renderMD(alt)}</div>
                                </div>
                            `;
                        });
                    }

                    detailsHTML = `
                        <div class="solution-details">
                            ${innerContent}
                        </div>
                    `;
                }
            }

            if (answerHTML || controlHTML) {
                solutionBlock = `
                    <div class="solution-block">
                        <hr class="divider-hairline" style="margin-top:0;">
                        ${answerHTML}
                        ${controlHTML}
                        ${detailsHTML}
                    </div>
                `;
            }
        }

        // 3. Children
        const childrenHTML = renderQuestionList(node.children, depth + 1);

        const nodeClass = depth === 0 ? 'question-node' : 'question-node child-node';
        
        return `
            <div class="${nodeClass}">
                ${qBody}
                ${solutionBlock}
                ${childrenHTML}
            </div>
        `;
    }

    function buildNavHTML(paper) {
        if (paper.questions) {
            return buildNavTree(paper.questions, 0);
        } else if (paper.sections) {
            return paper.sections.map(sec => {
                let html = '';
                if (sec.label && sec.label.trim()) {
                    html += `<div class="nav-section-label">${escapeHTML(sec.label)}</div>`;
                }
                html += buildNavTree(sec.questions, 0);
                return html;
            }).join('<div style="height:8px"></div>'); // Spacing between sections
        }
        return '';
    }

    function buildNavTree(questions, depth) {
        if (!questions) return '';
        return questions.map(q => {
            const selfHTML = `
                <a class="nav-item nav-depth-${Math.min(depth, 2)}" 
                   onclick="scrollToQuestion('q-${q.id}'); return false;"
                   data-target="q-${q.id}">
                   ${q.id}
                </a>
            `;
            const childrenHTML = buildNavTree(q.children, depth + 1);
            return selfHTML + childrenHTML;
        }).join('');
    }

    // --- INTERACTION ---

    window.toggleDetails = function(btn) {
        const details = btn.nextElementSibling; // The .solution-details div
        const isExpanded = details.classList.contains('expanded');
        
        if (isExpanded) {
            details.classList.remove('expanded');
            btn.innerHTML = 'Show working <span aria-hidden="true" style="font-size: 0.8em;">▶</span>';
            btn.setAttribute('aria-expanded', 'false');
        } else {
            details.classList.add('expanded');
            btn.innerHTML = 'Hide working <span aria-hidden="true" style="font-size: 0.8em;">▼</span>';
            btn.setAttribute('aria-expanded', 'true');
        }
    };

    window.scrollToQuestion = function(id) {
        const el = document.getElementById(id);
        if (el) {
            // Scroll logic
            const container = document.getElementById('paper-scroll-container');
            // Offset logic for sticky headers if any, here just simple scroll
            el.scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            closeDrawer();
            
            // Highlight nav
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.querySelectorAll(`[data-target="${id}"]`).forEach(n => n.classList.add('active'));
        }
    };

    function updateActiveNav() {
        // Simple IntersectionObserver could go here for scroll spy, 
        // strictly not required by brief but "Current item indication" is required.
        // For simplicity in this vanilla implementation, we rely on click-to-set active 
        // or just leave it empty until user interacts.
    }

    function escapeHTML(str) {
        return str.replace(/[&<>'"]/g, 
            tag => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                "'": '&#39;',
                '"': '&quot;'
            }[tag]));
    }

    // --- MOBILE DRAWER ---
    const drawerBackdrop = document.getElementById('drawer-backdrop');
    const mobileDrawer = document.getElementById('mobile-drawer');

    document.getElementById('jump-trigger').addEventListener('click', () => {
        drawerBackdrop.style.display = 'block';
        // force reflow
        void mobileDrawer.offsetWidth;
        mobileDrawer.classList.add('open');
    });

    document.getElementById('drawer-close').addEventListener('click', closeDrawer);
    drawerBackdrop.addEventListener('click', (e) => {
        if (e.target === drawerBackdrop) closeDrawer();
    });

    function closeDrawer() {
        mobileDrawer.classList.remove('open');
        setTimeout(() => {
            drawerBackdrop.style.display = 'none';
        }, 300);
    }

</script>
</body>
</html>
