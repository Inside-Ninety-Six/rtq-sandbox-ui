<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"ABC","indexWithinVariant":"124","totalWithinVariant":"320","hueFamily":"teal","intensityMode":"deep_theme","timestamp":"2026-01-07T15:13:23.972Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;ABC&quot;,&quot;indexWithinVariant&quot;:&quot;124&quot;,&quot;totalWithinVariant&quot;:&quot;320&quot;,&quot;hueFamily&quot;:&quot;teal&quot;,&quot;intensityMode&quot;:&quot;deep_theme&quot;,&quot;timestamp&quot;:&quot;2026-01-07T15:13:23.972Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    
    <!-- KaTeX CSS (No SRI per instructions) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    
    <!-- Tailwind CSS (via CDN for prototype harness) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Tailwind Config for Deep Theme (Teal) -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        // ColorLab C: Deep Theme + ColorLab B: Teal (Hue ~195)
                        page: 'oklch(0.94 0.09 195)',       // L ~0.94, C ~0.09
                        frame: 'oklch(0.91 0.10 195)',      // L ~0.91, C ~0.10
                        paper: 'oklch(0.96 0.06 195)',      // L ~0.96, C ~0.06
                        
                        // Text (Neutral/Teal-tinted, low chroma)
                        primary: 'oklch(0.20 0.01 195)',    // Dark teal-grey
                        secondary: 'oklch(0.40 0.015 195)', // Medium teal-grey
                        
                        // Accent (Strong Teal, L ~0.55, C ~0.18)
                        accent: 'oklch(0.55 0.18 195)',
                        'accent-hover': 'oklch(0.50 0.18 195)',
                        
                        // Structural
                        divider: 'oklch(0.85 0.02 195)',    // Subtle
                        wash: 'oklch(0.93 0.05 195)',       // Solution details wash
                    }
                }
            }
        }
    </script>

    <!-- External Libraries (No SRI) -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <style>
        /* Base styles */
        body {
            background-color: theme('colors.page');
            color: theme('colors.primary');
            -webkit-font-smoothing: antialiased;
        }

        /* Scrollbar hiding for nav */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* KaTeX Containment Invariant */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 4px; /* Space for scrollbar if needed */
        }
        
        /* Markdown Content Styling */
        .prose-content p {
            margin-bottom: 0.75em;
            line-height: 1.6;
        }
        .prose-content p:last-child {
            margin-bottom: 0;
        }
        .prose-content ul {
            list-style-type: disc;
            padding-left: 1.5em;
            margin-bottom: 0.75em;
        }
        .prose-content table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 1em;
            font-size: 0.95em;
        }
        .prose-content th, .prose-content td {
            border: 1px solid theme('colors.divider');
            padding: 0.5em;
            text-align: left;
        }
        .prose-content th {
            font-weight: 600;
        }

        /* Focus styles */
        :focus-visible {
            outline: 2px solid theme('colors.accent');
            outline-offset: 2px;
        }

        /* Solution Details Transition */
        .solution-details-wrapper {
            transition: opacity 0.2s ease-out;
        }
        
        /* Deep Theme Surface Separation */
        .frame-surface {
            background-color: theme('colors.frame');
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); /* Extremely subtle depth */
        }
        
        .paper-surface {
            background-color: theme('colors.paper');
        }

        .nav-active-marker {
            color: theme('colors.accent');
            font-weight: 600;
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- Top Controls (Fixed height) -->
    <header class="flex-none bg-frame border-b border-divider h-14 flex items-center px-4 md:px-6 justify-between z-20">
        <div class="flex items-center gap-4">
            <label for="paper-selector" class="sr-only">Select Paper</label>
            <select id="paper-selector" class="bg-paper border border-divider rounded px-3 py-1.5 text-sm font-medium text-primary focus:border-accent focus:ring-0 cursor-pointer">
                <option value="" disabled selected>Loading papers...</option>
            </select>
        </div>
        
        <!-- Mobile "Jump to" Trigger -->
        <button id="mobile-jump-trigger" class="md:hidden text-sm font-medium text-accent hover:text-accent-hover px-2 py-1">
            Jump to
        </button>
    </header>

    <!-- DocumentFrameShell -->
    <div id="document-frame" class="flex-1 flex overflow-hidden w-full max-w-7xl mx-auto frame-surface md:border-x md:border-divider">
        
        <!-- Desktop Nav Rail (Sticky/Persistent) -->
        <nav id="desktop-nav" class="hidden md:block w-60 flex-none h-full overflow-y-auto no-scrollbar border-r border-divider py-6 pl-6 pr-4">
            <!-- Nav content injected here -->
        </nav>

        <!-- Paper Content Column -->
        <main id="paper-column" class="flex-1 overflow-y-auto relative bg-frame">
            <div class="max-w-3xl mx-auto min-h-full paper-surface shadow-sm border-x border-divider/50 py-10 px-6 md:px-12 lg:px-16">
                <!-- Content injected here -->
                <div id="paper-content">
                    <div class="flex items-center justify-center h-40 text-secondary">
                        Loading...
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Mobile Navigation Drawer -->
    <div id="mobile-drawer" class="fixed inset-0 z-50 transform translate-x-full transition-transform duration-200 ease-in-out md:hidden" aria-hidden="true">
        <!-- Scrim -->
        <div id="drawer-scrim" class="absolute inset-0 bg-black/20 opacity-0 transition-opacity"></div>
        
        <!-- Drawer Panel -->
        <div class="absolute right-0 top-0 bottom-0 w-64 bg-frame shadow-xl flex flex-col h-full border-l border-divider">
            <div class="flex-none h-14 border-b border-divider flex items-center justify-between px-4">
                <span class="font-medium text-primary">Jump to</span>
                <button id="drawer-close" class="text-secondary hover:text-primary p-1">Close</button>
            </div>
            <div id="mobile-nav-content" class="flex-1 overflow-y-auto p-4">
                <!-- Nav content injected here -->
            </div>
        </div>
    </div>

    <script>
        // --- STAGE 0: CONSTANTS ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // --- MARKDOWN CONFIGURATION (Authoritative) ---
        const md = window.markdownit ? window.markdownit({
            html: true,
            linkify: true,
            breaks: false // MUST be false
        }) : null;

        if (md) {
            md.inline.ruler.disable(['escape']);
        }

        // --- STATE ---
        const state = {
            papers: [],
            activePaperKey: null,
            payload: null,
            mobileNavOpen: false
        };

        // --- DOM ELEMENTS ---
        const els = {
            paperSelector: document.getElementById('paper-selector'),
            paperContent: document.getElementById('paper-content'),
            desktopNav: document.getElementById('desktop-nav'),
            mobileNavContent: document.getElementById('mobile-nav-content'),
            mobileJumpTrigger: document.getElementById('mobile-jump-trigger'),
            mobileDrawer: document.getElementById('mobile-drawer'),
            drawerScrim: document.getElementById('drawer-scrim'),
            drawerClose: document.getElementById('drawer-close'),
            paperColumn: document.getElementById('paper-column')
        };

        // --- INITIALIZATION ---
        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error('Fetch failed');
                const data = await response.json();
                
                if (!data.papers || !Array.isArray(data.papers)) {
                    throw new Error('Invalid payload structure');
                }

                state.payload = data;
                state.papers = data.papers;
                
                renderPaperSelector();
                
                // Select first paper by default
                if (state.papers.length > 0) {
                    selectPaper(state.papers[0].key);
                }

            } catch (err) {
                console.error(err);
                els.paperContent.innerHTML = `
                    <div class="flex items-center justify-center h-64 text-red-700 font-medium">
                        PAPERS PAYLOAD MISSING
                    </div>
                `;
                els.paperSelector.innerHTML = '<option>Error loading payload</option>';
            }
        }

        // --- RENDERERS ---

        function renderPaperSelector() {
            els.paperSelector.innerHTML = state.papers.map(p => 
                `<option value="${p.key}">${p.label}</option>`
            ).join('');

            els.paperSelector.addEventListener('change', (e) => {
                selectPaper(e.target.value);
            });
        }

        function selectPaper(key) {
            state.activePaperKey = key;
            const paper = state.papers.find(p => p.key === key);
            
            // Render Content
            els.paperContent.innerHTML = ''; // Clear
            
            // Handle Sections vs Flat
            const questions = paper.questions || [];
            const sections = paper.sections || [];
            
            // Build Question List HTML
            let html = '';
            
            if (sections.length > 0) {
                sections.forEach((section, idx) => {
                    // Render Section Header if label exists
                    if (section.label && section.label.trim().length > 0) {
                        html += `
                            <div class="mb-6 mt-8 first:mt-0 border-b border-divider pb-2">
                                <h2 class="text-xl font-semibold text-primary">${section.label}</h2>
                            </div>
                        `;
                    }
                    // Render Questions in this section
                    if (section.questions) {
                        section.questions.forEach(q => {
                            html += renderQuestionNode(q, paper.defaults);
                            html += renderTopLevelSeparator();
                        });
                    }
                });
            } else {
                questions.forEach(q => {
                    html += renderQuestionNode(q, paper.defaults);
                    html += renderTopLevelSeparator();
                });
            }

            els.paperContent.innerHTML = html;

            // Render Nav
            renderNavigation(paper);

            // Post-render: KaTeX
            renderMathInElement(els.paperContent, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false}
                ],
                throwOnError: false
            });

            // Post-render: Add event listeners for toggles
            setupToggles();

            // Reset Scroll
            els.paperColumn.scrollTop = 0;
        }

        function renderQuestionNode(node, paperDefaults, depth = 0) {
            if (!node) return '';

            // Markdown rendering
            const questionHtml = md ? md.render(node.question || '') : (node.question || '');
            
            // Solution Block Logic
            let solutionBlockHtml = '';
            const sb = node.solutionBlock;
            
            if (sb) {
                const hasAnswer = sb.answer && sb.answer.trim().length > 0;
                const hasDetails = sb.solutionDetails;
                
                let answerHtml = '';
                if (hasAnswer) {
                    const ansContent = md ? md.render(sb.answer) : sb.answer;
                    answerHtml = `
                        <div class="mb-4">
                            <span class="text-sm font-bold text-secondary uppercase tracking-wide block mb-1">Answer</span>
                            <div class="text-primary font-medium prose-content">${ansContent}</div>
                        </div>
                    `;
                }

                let detailsHtml = '';
                if (hasDetails) {
                    // Defaults logic
                    const isExpanded = paperDefaults && paperDefaults.expandedAll !== undefined 
                        ? paperDefaults.expandedAll 
                        : true;
                    
                    const displayStyle = isExpanded ? 'block' : 'none';
                    const labelText = isExpanded ? 'Hide working' : 'Show working';
                    
                    const detailsContent = renderSolutionDetailsContent(sb.solutionDetails);
                    
                    detailsHtml = `
                        <div class="mt-4">
                            <button type="button" class="text-sm font-medium text-accent hover:text-accent-hover focus:outline-none focus-visible js-toggle-working" aria-expanded="${isExpanded}">
                                ${labelText}
                            </button>
                            <div class="mt-3 pl-4 border-l border-divider bg-wash rounded-r-sm p-4 solution-details-wrapper" style="display: ${displayStyle};">
                                ${detailsContent}
                            </div>
                        </div>
                    `;
                }

                solutionBlockHtml = `
                    <div class="mt-4 pt-2">
                        ${answerHtml}
                        ${detailsHtml}
                    </div>
                `;
            }

            // Recursive Children
            let childrenHtml = '';
            if (node.children && node.children.length > 0) {
                childrenHtml = `
                    <div class="mt-4 ml-0 md:ml-6 border-l-0 md:border-l-0">
                        ${node.children.map(child => renderQuestionNode(child, paperDefaults, depth + 1)).join('')}
                    </div>
                `;
            }

            // Node ID for Anchoring
            const nodeId = `q-${node.id}`;

            // Wrapper
            // Top level gets no extra margin from parent, but spacing handled by separators.
            // Nested items get subtle spacing.
            const wrapperClass = depth > 0 ? 'mt-6' : '';

            return `
                <div id="${nodeId}" class="${wrapperClass} group">
                    <!-- Question Body -->
                    <div class="flex flex-col gap-2">
                        <div class="flex items-baseline gap-3">
                            <span class="flex-none font-semibold text-secondary text-base select-none w-8 md:w-10">${node.id}</span>
                            <div class="flex-1 prose-content text-primary text-lg leading-relaxed">
                                ${questionHtml}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Solution Block -->
                    <div class="ml-8 md:ml-10 md:pr-4">
                        ${solutionBlockHtml}
                    </div>

                    <!-- Children -->
                    ${childrenHtml}
                </div>
            `;
        }

        function renderSolutionDetailsContent(sd) {
            let html = '';
            
            // Order: Keep in mind -> Formulas -> Working -> Alternative
            
            if (sd.keepInMind) {
                html += `
                    <div class="mb-4 last:mb-0">
                        <h4 class="text-xs font-bold text-secondary uppercase mb-1">Keep in mind</h4>
                        <div class="prose-content text-sm text-primary/90">${md.render(sd.keepInMind)}</div>
                    </div>
                `;
            }

            if (sd.formulasUsed) {
                html += `
                    <div class="mb-4 last:mb-0">
                        <h4 class="text-xs font-bold text-secondary uppercase mb-1">Formulas used</h4>
                        <div class="prose-content text-sm text-primary/90">${md.render(sd.formulasUsed)}</div>
                    </div>
                `;
            }

            if (sd.working) {
                html += `
                    <div class="mb-4 last:mb-0">
                        <h4 class="text-xs font-bold text-secondary uppercase mb-1">Working</h4>
                        <div class="prose-content text-base text-primary">${md.render(sd.working)}</div>
                    </div>
                `;
            }

            if (sd.alternativeWorking && Array.isArray(sd.alternativeWorking)) {
                sd.alternativeWorking.forEach(alt => {
                    html += `
                        <div class="mt-6 pt-4 border-t border-divider/50">
                            <h4 class="text-xs font-bold text-secondary uppercase mb-2">Alternative working</h4>
                            <div class="prose-content text-base text-primary">${md.render(alt)}</div>
                        </div>
                    `;
                });
            }

            return html;
        }

        function renderTopLevelSeparator() {
            return `<div class="h-16 w-full"></div>`;
        }

        // --- NAVIGATION ---
        function renderNavigation(paper) {
            const listItems = [];
            
            const processQuestions = (qs, sectionLabel = null) => {
                if(sectionLabel) {
                    listItems.push({ type: 'section', label: sectionLabel });
                }
                qs.forEach(q => {
                    extractNavItems(q, listItems, 0);
                });
            };

            const extractNavItems = (node, list, depth) => {
                list.push({ type: 'item', id: node.id, depth: depth });
                if (node.children) {
                    node.children.forEach(child => extractNavItems(child, list, depth + 1));
                }
            };

            if (paper.sections) {
                paper.sections.forEach(s => {
                    if (s.questions) processQuestions(s.questions, s.label);
                });
            } else if (paper.questions) {
                processQuestions(paper.questions);
            }

            const navHtml = buildNavHtml(listItems);
            
            els.desktopNav.innerHTML = navHtml;
            els.mobileNavContent.innerHTML = navHtml;
            
            setupNavClicks();
        }

        function buildNavHtml(items) {
            return `
                <ul class="flex flex-col gap-1 pb-12">
                    ${items.map(item => {
                        if (item.type === 'section') {
                            if (!item.label || item.label.trim() === '') return '';
                            return `<li class="mt-6 mb-2 text-xs font-bold text-secondary uppercase tracking-wider select-none">${item.label}</li>`;
                        }
                        
                        // Hierarchy via type scale only, flat left edge
                        const isSub = item.depth > 0;
                        const fontSizeClass = isSub ? 'text-sm' : 'text-base';
                        const colorClass = isSub ? 'text-secondary hover:text-primary' : 'text-primary hover:text-accent';
                        const weightClass = isSub ? 'font-normal' : 'font-medium';
                        
                        return `
                            <li>
                                <a href="#q-${item.id}" class="block py-1 ${fontSizeClass} ${weightClass} ${colorClass} transition-colors js-nav-link" data-target="q-${item.id}">
                                    ${item.id}
                                </a>
                            </li>
                        `;
                    }).join('')}
                </ul>
            `;
        }

        function setupNavClicks() {
            const links = document.querySelectorAll('.js-nav-link');
            links.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetId = link.getAttribute('data-target');
                    const targetEl = document.getElementById(targetId);
                    
                    if (targetEl) {
                        // Scroll Logic
                        // Desktop: scroll #paper-column
                        // Mobile: scroll window
                        if (window.innerWidth >= 768) {
                            els.paperColumn.scrollTo({
                                top: targetEl.offsetTop - 40, // offset
                                behavior: 'smooth'
                            });
                        } else {
                            const offset = targetEl.getBoundingClientRect().top + window.scrollY - 80;
                            window.scrollTo({ top: offset, behavior: 'smooth' });
                            closeMobileNav();
                        }
                        
                        updateActiveNav(targetId);
                    }
                });
            });
        }

        function updateActiveNav(targetId) {
            // Remove active classes
            document.querySelectorAll('.js-nav-link').forEach(l => {
                l.classList.remove('nav-active-marker');
            });
            // Add to current (all instances, mobile + desktop)
            document.querySelectorAll(`.js-nav-link[data-target="${targetId}"]`).forEach(l => {
                l.classList.add('nav-active-marker');
            });
        }

        // --- INTERACTION ---
        function setupToggles() {
            const toggles = document.querySelectorAll('.js-toggle-working');
            toggles.forEach(btn => {
                btn.addEventListener('click', () => {
                    const container = btn.nextElementSibling;
                    const isHidden = container.style.display === 'none';
                    
                    if (isHidden) {
                        container.style.display = 'block';
                        btn.textContent = 'Hide working';
                        btn.setAttribute('aria-expanded', 'true');
                    } else {
                        container.style.display = 'none';
                        btn.textContent = 'Show working';
                        btn.setAttribute('aria-expanded', 'false');
                    }
                });
            });
        }

        // --- MOBILE DRAWER ---
        function openMobileNav() {
            state.mobileNavOpen = true;
            els.mobileDrawer.classList.remove('translate-x-full');
            els.drawerScrim.classList.remove('opacity-0');
            // Trap focus roughly or just disable body scroll
            document.body.style.overflow = 'hidden';
        }

        function closeMobileNav() {
            state.mobileNavOpen = false;
            els.mobileDrawer.classList.add('translate-x-full');
            els.drawerScrim.classList.add('opacity-0');
            document.body.style.overflow = '';
        }

        els.mobileJumpTrigger.addEventListener('click', openMobileNav);
        els.drawerClose.addEventListener('click', closeMobileNav);
        els.drawerScrim.addEventListener('click', closeMobileNav);

        // --- RUN ---
        init();

    </script>
</body>
</html>
