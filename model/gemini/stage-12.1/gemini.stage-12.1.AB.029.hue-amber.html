<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AB","indexWithinVariant":"29","totalWithinVariant":"200","hueFamily":"amber","intensityMode":"","timestamp":"2026-01-06T20:57:09.194Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AB&quot;,&quot;indexWithinVariant&quot;:&quot;29&quot;,&quot;totalWithinVariant&quot;:&quot;200&quot;,&quot;hueFamily&quot;:&quot;amber&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-06T20:57:09.194Z&quot;}'>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RTQ Maths Paper Viewer</title>
  
  <!-- KaTeX (SRI Disabled per Stage 6.0.7b) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
  
  <!-- Markdown-it (SRI Disabled) -->
  <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>
  
  <style>
    /* 
      STAGE 6 ADD-ON: COLORLAB B (Amber Hue Forced) 
      Base Neutral: Warm Sand (Hue 30)
      Accent: Amber (Hue 38)
    */
    :root {
      /* Hues */
      --hue-neutral: 30; 
      --hue-primary: 38; 

      /* Base Surfaces */
      --color-bg-page: hsl(var(--hue-neutral), 12%, 98%);
      --color-bg-surface: #ffffff;
      --color-bg-subtle: hsl(var(--hue-neutral), 15%, 96%); 

      /* Typography */
      --color-text-primary: hsl(var(--hue-neutral), 10%, 15%);
      --color-text-secondary: hsl(var(--hue-neutral), 8%, 40%);
      --color-text-tertiary: hsl(var(--hue-neutral), 6%, 60%);

      /* Dividers */
      --color-border-hairline: hsl(var(--hue-neutral), 10%, 92%);
      --color-border-subtle: hsl(var(--hue-neutral), 10%, 86%);

      /* Accents (Restrained per Stage 5.3.2 Override + ColorLab B) */
      --color-accent: hsl(var(--hue-primary), 90%, 35%); 
      --color-accent-subtle: hsl(var(--hue-primary), 85%, 96%); /* Wash for Solution Details */
      --color-focus-ring: hsl(var(--hue-primary), 90%, 50%);

      /* Spacing Variables */
      --space-xs: 0.25rem;
      --space-sm: 0.5rem;
      --space-md: 1rem;
      --space-lg: 1.5rem;
      --space-xl: 2.5rem;
      --space-xxl: 4rem;

      /* Typography Setup */
      --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      --font-size-base: 16px;
      --font-size-sm: 14px;
      --font-size-xs: 12px;
    }

    /* Reset & Base */
    * { box-sizing: border-box; }
    
    body {
      margin: 0;
      padding: 0;
      font-family: var(--font-family);
      background-color: var(--color-bg-page);
      color: var(--color-text-primary);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
    }

    /* Scrollbar Hiding (Nav) */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    /* --- LAYOUT SHELL --- */
    .app-shell {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    /* Top Controls */
    .top-controls {
      position: sticky;
      top: 0;
      z-index: 50;
      background-color: var(--color-bg-page);
      border-bottom: 1px solid var(--color-border-hairline);
      height: 60px;
      padding: 0 var(--space-md);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    /* Document Frame (Constrains Nav + Paper) */
    .document-frame {
      display: flex;
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      flex: 1;
    }

    /* --- CONTROLS --- */
    .paper-select {
      font-size: var(--font-size-sm);
      padding: var(--space-xs) var(--space-sm);
      border: 1px solid var(--color-border-subtle);
      border-radius: 4px;
      background: var(--color-bg-surface);
      color: var(--color-text-primary);
    }

    .jump-to-trigger {
      display: none; /* Desktop hidden */
      background: none;
      border: 1px solid var(--color-border-subtle);
      border-radius: 4px;
      padding: var(--space-xs) var(--space-sm);
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
      cursor: pointer;
    }

    /* --- NAVIGATION --- */
    .nav-rail {
      width: 220px;
      flex-shrink: 0;
      position: sticky;
      top: 60px;
      height: calc(100vh - 60px);
      overflow-y: auto;
      padding: var(--space-lg) var(--space-md) var(--space-lg) 0;
      display: none; /* Hidden on mobile */
    }

    .nav-list-container {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .nav-section-label {
      font-size: var(--font-size-xs);
      font-weight: 700;
      color: var(--color-text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-top: var(--space-md);
      margin-bottom: var(--space-xs);
      padding-left: 0; /* Flat list alignment */
    }

    .nav-link {
      text-decoration: none;
      color: var(--color-text-secondary);
      cursor: pointer;
      display: block;
      padding: 3px 0;
      transition: color 0.1s ease;
    }

    .nav-link:hover {
      color: var(--color-text-primary);
      text-decoration: underline;
      text-decoration-color: var(--color-border-hairline);
    }

    /* Active State (Weight only + Color Override) */
    .nav-link.active {
      font-weight: 700;
      color: var(--color-accent);
    }

    /* Hierarchy via Type Scale (Flat Left Edge) */
    .nav-link.depth-0 { font-size: 14px; }
    .nav-link.depth-1 { font-size: 13px; color: var(--color-text-tertiary); }
    .nav-link.depth-2 { font-size: 12px; color: var(--color-text-tertiary); }

    /* --- PAPER CONTENT --- */
    .paper-content {
      flex: 1;
      padding: var(--space-lg) var(--space-md) var(--space-xxl);
      max-width: 800px; /* Readable line length */
    }

    .section-header-block {
      margin-top: var(--space-xl);
      margin-bottom: var(--space-lg);
      border-bottom: 1px solid var(--color-border-hairline);
      padding-bottom: var(--space-xs);
    }
    .section-header-text {
      font-size: var(--font-size-base);
      font-weight: 700;
      color: var(--color-text-primary);
    }

    /* Question Node */
    .question-node {
      margin-bottom: var(--space-xxl); /* Top level separation */
    }
    .children-container {
      margin-top: var(--space-lg);
      padding-left: var(--space-lg); /* Indentation for sub-questions */
    }
    .children-container .question-node {
      margin-bottom: var(--space-lg); /* Tighter spacing for children */
    }

    /* Question Body */
    .question-body {
      margin-bottom: var(--space-md);
    }
    .question-identifier {
      font-weight: 700;
      color: var(--color-text-secondary);
      margin-right: var(--space-sm);
    }
    .question-text {
      display: inline;
    }
    .question-text p { display: inline; margin: 0; }
    .question-text p + p { display: block; margin-top: 0.5em; }

    /* Solution Block */
    .solution-block {
      margin-top: var(--space-md);
    }

    /* Answer */
    .answer-region {
      margin-bottom: var(--space-md);
    }
    .answer-label {
      font-size: var(--font-size-sm);
      font-weight: 700;
      color: var(--color-text-secondary);
      margin-right: var(--space-sm);
    }
    .answer-content {
      display: inline-block;
    }

    /* Solution Details Toggle */
    .sd-toggle {
      background: none;
      border: none;
      padding: 0;
      font-size: var(--font-size-sm);
      font-family: inherit;
      color: var(--color-accent);
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: var(--space-xs);
    }
    .sd-toggle:hover {
      text-decoration: underline;
    }
    .sd-icon {
      width: 14px; 
      height: 14px;
      transition: transform 0.2s;
    }
    .sd-toggle[aria-expanded="true"] .sd-icon {
      transform: rotate(180deg);
    }

    /* Solution Details Region */
    .solution-details-region {
      margin-top: var(--space-sm);
      background-color: var(--color-accent-subtle); /* Wash */
      padding: var(--space-md);
      border-radius: 4px;
    }
    .solution-details-region[hidden] {
      display: none;
    }

    /* SD Subsections */
    .sd-subsection { margin-bottom: var(--space-md); }
    .sd-subsection:last-child { margin-bottom: 0; }
    
    .sd-label {
      display: block;
      font-size: var(--font-size-xs);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--color-text-tertiary);
      margin-bottom: var(--space-xs);
    }
    
    .sd-body {
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
    }
    /* Keep In Mind: slightly higher contrast */
    .sd-keep-in-mind .sd-body {
      color: var(--color-text-primary);
    }

    /* Alternative Working Separator */
    .sd-working + .sd-alternative {
      margin-top: var(--space-lg);
      padding-top: var(--space-md);
      border-top: 1px solid var(--color-border-hairline);
    }

    /* --- MOBILE DRAWER --- */
    .drawer-backdrop {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.15);
      z-index: 100;
    }
    .drawer {
      position: fixed;
      top: 0; bottom: 0; left: 0;
      width: 280px;
      background: var(--color-bg-surface);
      border-right: 1px solid var(--color-border-subtle);
      z-index: 101;
      transform: translateX(-100%);
      transition: transform 0.2s ease-out;
      display: flex;
      flex-direction: column;
    }
    .drawer.open { transform: translateX(0); }
    
    .drawer-header {
      padding: var(--space-md);
      border-bottom: 1px solid var(--color-border-hairline);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .drawer-content {
      flex: 1;
      overflow-y: auto;
      padding: var(--space-md);
    }

    /* --- RESPONSIVE --- */
    @media (min-width: 768px) {
      .nav-rail { display: block; }
      .jump-to-trigger { display: none; }
    }
    @media (max-width: 767px) {
      .nav-rail { display: none; }
      .jump-to-trigger { display: block; }
    }

    /* --- MARKDOWN ELEMENTS --- */
    .katex-display {
      overflow-x: auto;
      overflow-y: hidden;
      max-width: 100%;
      padding: 0.5em 0;
      -webkit-overflow-scrolling: touch;
    }
    
    table {
      border-collapse: collapse;
      width: 100%;
      margin: 1em 0;
      font-size: var(--font-size-sm);
    }
    th, td {
      border: 1px solid var(--color-border-subtle);
      padding: var(--space-xs) var(--space-sm);
      text-align: left;
    }
    th {
      background-color: var(--color-bg-subtle);
      font-weight: 600;
    }

    /* Utility */
    .error-msg {
      padding: var(--space-xl);
      text-align: center;
      color: var(--color-text-secondary);
    }
    
    /* Accessibility */
    *:focus-visible {
      outline: 2px solid var(--color-focus-ring);
      outline-offset: 2px;
    }
  </style>
</head>
<body>

  <div class="app-shell">
    
    <!-- Top Controls -->
    <header class="top-controls">
      <select id="paperSelector" class="paper-select" aria-label="Select paper">
        <option disabled selected>Loading papers...</option>
      </select>
      <button id="mobileJumpTrigger" class="jump-to-trigger">Jump to...</button>
    </header>

    <!-- Document Frame -->
    <div class="document-frame">
      
      <!-- Desktop Navigation -->
      <nav class="nav-rail no-scrollbar" aria-label="Document navigation">
        <div id="desktopNavContent" class="nav-list-container"></div>
      </nav>

      <!-- Paper Content -->
      <main id="paperContentRegion" class="paper-content">
        <!-- Content injected here -->
      </main>

    </div>
  </div>

  <!-- Mobile Drawer -->
  <div id="drawerBackdrop" class="drawer-backdrop"></div>
  <aside id="drawer" class="drawer" aria-label="Mobile navigation">
    <div class="drawer-header">
      <span style="font-weight:700; font-size:var(--font-size-sm);">Jump to</span>
      <button id="drawerClose" style="background:none; border:none; font-size:1.5rem; cursor:pointer; color:var(--color-text-secondary);">&times;</button>
    </div>
    <div id="mobileNavContent" class="drawer-content nav-list-container"></div>
  </aside>

<script>
  // --- STAGE 0: CONSTANTS ---
  const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
  const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

  // --- STATE ---
  let g_papers = [];
  let g_currentPaper = null;

  // --- MARKDOWN INIT (Stage 6 Config) ---
  const md = window.markdownit ? window.markdownit({
    html: true,
    linkify: true,
    breaks: false // Authoritative: false
  }) : null;
  
  if (md) {
    // Preserve TeX backslashes
    md.inline.ruler.disable(['escape']);
  }

  // --- DOM REFERENCES ---
  const elSelector = document.getElementById('paperSelector');
  const elContent = document.getElementById('paperContentRegion');
  const elDesktopNav = document.getElementById('desktopNavContent');
  const elMobileNav = document.getElementById('mobileNavContent');
  const elJumpBtn = document.getElementById('mobileJumpTrigger');
  const elDrawer = document.getElementById('drawer');
  const elBackdrop = document.getElementById('drawerBackdrop');
  const elDrawerClose = document.getElementById('drawerClose');

  // --- INIT ---
  (async function init() {
    try {
      const res = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
      if (!res.ok) throw new Error("Fetch failed");
      const data = await res.json();
      
      if (!data.papers || !Array.isArray(data.papers)) throw new Error("Invalid schema");
      g_papers = data.papers;
      
      populateSelector();
      if (g_papers.length > 0) {
        loadPaper(g_papers[0].key);
      } else {
        renderError("No papers available.");
      }

    } catch (err) {
      console.error(err);
      renderError("PAPERS PAYLOAD MISSING");
    }
  })();

  function renderError(msg) {
    elContent.innerHTML = `<div class="error-msg">${msg}</div>`;
    elSelector.innerHTML = `<option>Error</option>`;
  }

  function populateSelector() {
    elSelector.innerHTML = '';
    g_papers.forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.key;
      opt.textContent = p.label || p.key;
      elSelector.appendChild(opt);
    });
    elSelector.addEventListener('change', (e) => loadPaper(e.target.value));
  }

  function loadPaper(key) {
    const paper = g_papers.find(p => p.key === key);
    if (!paper) return;
    g_currentPaper = paper;

    // Check default expanded state
    const defaultExpanded = paper.defaults?.expandedAll !== false;

    renderContent(paper, defaultExpanded);
    renderNavigation(paper);
    
    // Reset Scroll
    window.scrollTo(0,0);
    closeDrawer();
  }

  // --- CONTENT RENDERER ---
  function renderContent(paper, defaultExpanded) {
    elContent.innerHTML = '';

    // Helper to render lists
    const renderList = (questions, container, depth) => {
      questions.forEach(q => {
        const node = document.createElement('div');
        node.className = 'question-node';
        node.id = `q-${sanitizeId(q.id)}`;

        // 1. Question Body
        const body = document.createElement('div');
        body.className = 'question-body';
        
        const ident = document.createElement('span');
        ident.className = 'question-identifier';
        ident.textContent = q.id;
        
        const text = document.createElement('div');
        text.className = 'question-text';
        text.innerHTML = md ? md.render(q.question || '') : q.question;
        
        body.appendChild(ident);
        body.appendChild(text);
        node.appendChild(body);

        // 2. Solution Block (Optional)
        if (q.solutionBlock) {
          const sb = document.createElement('div');
          sb.className = 'solution-block';

          // Answer
          if (q.solutionBlock.answer) {
            const ar = document.createElement('div');
            ar.className = 'answer-region';
            ar.innerHTML = `<span class="answer-label">Answer</span><div class="answer-content">${md ? md.render(q.solutionBlock.answer) : q.solutionBlock.answer}</div>`;
            sb.appendChild(ar);
          }

          // Solution Details
          if (q.solutionBlock.solutionDetails) {
            const sdData = q.solutionBlock.solutionDetails;
            const detailsId = `sd-${sanitizeId(q.id)}`;
            
            // Toggle
            const btn = document.createElement('button');
            btn.className = 'sd-toggle';
            btn.setAttribute('aria-expanded', defaultExpanded ? 'true' : 'false');
            btn.setAttribute('aria-controls', detailsId);
            
            const updateBtn = (expanded) => {
              btn.innerHTML = `<span>${expanded ? 'Hide working' : 'Show working'}</span>
                <svg class="sd-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>`;
            };
            updateBtn(defaultExpanded);

            // Region
            const region = document.createElement('div');
            region.className = 'solution-details-region';
            region.id = detailsId;
            region.hidden = !defaultExpanded;

            // Subsections
            const renderSub = (label, content, extraClass='') => {
              if (!content) return;
              const div = document.createElement('div');
              div.className = `sd-subsection ${extraClass}`;
              div.innerHTML = `<span class="sd-label">${label}</span><div class="sd-body">${md ? md.render(content) : content}</div>`;
              region.appendChild(div);
            };

            renderSub('Keep in mind', sdData.keepInMind, 'sd-keep-in-mind');
            renderSub('Formulas used', sdData.formulasUsed, 'sd-formulas');
            renderSub('Working', sdData.working, 'sd-working');
            
            if (sdData.alternativeWorking && Array.isArray(sdData.alternativeWorking)) {
              sdData.alternativeWorking.forEach(alt => {
                renderSub('Alternative working', alt, 'sd-alternative');
              });
            }

            // Click Handler
            btn.onclick = () => {
              const isExp = btn.getAttribute('aria-expanded') === 'true';
              btn.setAttribute('aria-expanded', !isExp);
              region.hidden = isExp;
              updateBtn(!isExp);
            };

            sb.appendChild(btn);
            sb.appendChild(region);
          }
          
          node.appendChild(sb);
        }

        // 3. Children
        if (q.children && q.children.length > 0) {
          const childContainer = document.createElement('div');
          childContainer.className = 'children-container';
          renderList(q.children, childContainer, depth + 1);
          node.appendChild(childContainer);
        }

        container.appendChild(node);
      });
    };

    // Render Loop
    if (paper.sections) {
      paper.sections.forEach(sec => {
        if (sec.label && sec.label.trim()) {
          const hdr = document.createElement('div');
          hdr.className = 'section-header-block';
          hdr.innerHTML = `<span class="section-header-text">${sec.label}</span>`;
          elContent.appendChild(hdr);
        }
        if (sec.questions) renderList(sec.questions, elContent, 0);
      });
    } else if (paper.questions) {
      renderList(paper.questions, elContent, 0);
    }

    // KaTeX
    if (window.renderMathInElement) {
      renderMathInElement(elContent, {
        delimiters: [
          {left: '$$', right: '$$', display: true},
          {left: '$', right: '$', display: false}
        ],
        throwOnError: false
      });
    }
    
    // Update Observer
    setupObserver();
  }

  // --- NAVIGATION RENDERER ---
  function renderNavigation(paper) {
    const frag = document.createDocumentFragment();

    const addLink = (q, depth) => {
      const a = document.createElement('a');
      a.className = `nav-link depth-${Math.min(depth, 2)}`;
      a.textContent = q.id;
      a.href = `#q-${sanitizeId(q.id)}`;
      a.dataset.target = `q-${sanitizeId(q.id)}`;
      frag.appendChild(a);
      
      if (q.children) q.children.forEach(c => addLink(c, depth + 1));
    };

    if (paper.sections) {
      paper.sections.forEach(sec => {
        if (sec.label && sec.label.trim()) {
          const lbl = document.createElement('div');
          lbl.className = 'nav-section-label';
          lbl.textContent = sec.label;
          frag.appendChild(lbl);
        }
        if (sec.questions) sec.questions.forEach(q => addLink(q, 0));
      });
    } else if (paper.questions) {
      paper.questions.forEach(q => addLink(q, 0));
    }

    // Render Desktop
    elDesktopNav.innerHTML = '';
    elDesktopNav.appendChild(frag.cloneNode(true));
    
    // Render Mobile
    elMobileNav.innerHTML = '';
    elMobileNav.appendChild(frag.cloneNode(true));

    // Listeners
    const handler = (e) => {
      if (e.target.classList.contains('nav-link')) {
        e.preventDefault();
        const id = e.target.dataset.target;
        const el = document.getElementById(id);
        if (el) {
          const offset = el.getBoundingClientRect().top + window.pageYOffset - 80;
          window.scrollTo({top: offset, behavior: 'smooth'});
          closeDrawer();
        }
      }
    };
    elDesktopNav.onclick = handler;
    elMobileNav.onclick = handler;
  }

  // --- UTILS ---
  function sanitizeId(id) {
    return id.replace(/[^a-zA-Z0-9-_]/g, '_');
  }

  // Drawer
  function openDrawer() { elDrawer.classList.add('open'); elBackdrop.style.display = 'block'; document.body.style.overflow = 'hidden'; }
  function closeDrawer() { elDrawer.classList.remove('open'); elBackdrop.style.display = 'none'; document.body.style.overflow = ''; }
  
  elJumpBtn.onclick = openDrawer;
  elDrawerClose.onclick = closeDrawer;
  elBackdrop.onclick = closeDrawer;

  // ScrollSpy
  let observer;
  function setupObserver() {
    if (observer) observer.disconnect();
    
    observer = new IntersectionObserver((entries) => {
      entries.forEach(e => {
        if (e.isIntersecting) {
          const id = e.target.id;
          document.querySelectorAll('.nav-link').forEach(l => {
            l.classList.toggle('active', l.dataset.target === id);
          });
        }
      });
    }, { rootMargin: '-10% 0px -80% 0px' });

    document.querySelectorAll('.question-node').forEach(n => observer.observe(n));
  }

</script>
</body>
</html>
