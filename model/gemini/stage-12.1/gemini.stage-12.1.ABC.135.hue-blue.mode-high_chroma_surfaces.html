<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"ABC","indexWithinVariant":"135","totalWithinVariant":"320","hueFamily":"blue","intensityMode":"high_chroma_surfaces","timestamp":"2026-01-07T15:44:27.256Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;ABC&quot;,&quot;indexWithinVariant&quot;:&quot;135&quot;,&quot;totalWithinVariant&quot;:&quot;320&quot;,&quot;hueFamily&quot;:&quot;blue&quot;,&quot;intensityMode&quot;:&quot;high_chroma_surfaces&quot;,&quot;timestamp&quot;:&quot;2026-01-07T15:44:27.256Z&quot;}'>

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RTQ Maths Paper Solution Viewer</title>

<!-- KaTeX CSS (SRI disabled per Stage 6.0.7b) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

<!-- Fonts -->
<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
</style>

<style>
/* ==========================================================================
   STAGE 0 & 5 & 6 CONSTANTS & COLORLAB C VARIABLES
   Hue Family: Blue (ColorLab B)
   Intensity Mode: High Chroma Surfaces (ColorLab C Mode 3)
   ========================================================================== */
:root {
    /* ColorLab B: Forced Hue = Blue (~260 in OKLCH) */
    --hue: 260; 

    /* ColorLab C Mode 3: High Chroma Surfaces 
       Rules:
       - 2+ major surfaces C in [0.06..0.12] (Page & Frame)
       - Remaining major surface C in [0.03..0.07] (Paper)
       - Wash surfaces C in [0.05..0.10]
       - Text C <= 0.015
       - Accent C in [0.12..0.20]
    */

    /* Surfaces */
    --c-page-bg: oklch(0.93 0.07 var(--hue));   /* High Chroma */
    --c-frame-bg: oklch(0.90 0.08 var(--hue));  /* High Chroma */
    --c-paper-bg: oklch(0.98 0.04 var(--hue));  /* Tinted */
    
    --c-wash-bg: oklch(0.95 0.06 var(--hue));   /* Wash */
    --c-wash-sub-bg: oklch(0.94 0.07 var(--hue)); /* Deeper wash if needed */

    /* Text */
    --c-text-primary: oklch(0.25 0.015 var(--hue));
    --c-text-secondary: oklch(0.45 0.015 var(--hue));
    --c-text-quiet: oklch(0.55 0.015 var(--hue));

    /* Accents & UI */
    --c-accent: oklch(0.55 0.18 var(--hue));    /* High Chroma Accent */
    --c-focus: var(--c-accent);
    --c-divider: oklch(0.88 0.03 var(--hue));

    /* Spacing System */
    --sp-xs: 0.25rem;
    --sp-sm: 0.5rem;
    --sp-md: 1rem;
    --sp-lg: 1.5rem;
    --sp-xl: 2.5rem; /* Largest unit for top-level questions */
    
    /* Layout */
    --frame-max-width: 1024px;
    --nav-width: 180px;
    --header-height: 60px;
}

/* ==========================================================================
   RESET & BASELINE
   ========================================================================== */
* { box-sizing: border-box; }
body {
    margin: 0;
    padding: 0;
    font-family: 'Inter', sans-serif;
    background-color: var(--c-page-bg);
    color: var(--c-text-primary);
    line-height: 1.5;
    -webkit-font-smoothing: antialiased;
    overflow-y: scroll; /* Force scrollbar stability */
}

/* Scrollbar hiding for nav but keeping functionality */
.no-scrollbar {
    scrollbar-width: none; /* Firefox */
    -ms-overflow-style: none; /* IE/Edge */
}
.no-scrollbar::-webkit-scrollbar {
    display: none; /* Chrome/Safari */
}

/* ==========================================================================
   LAYOUT STRUCTURE
   ========================================================================== */
.app-shell {
    display: flex;
    flex-direction: column;
    min-height: 100vh;
    align-items: center;
}

/* Top Controls - Aligned with Frame */
.top-controls-region {
    width: 100%;
    display: flex;
    justify-content: center;
    background-color: var(--c-frame-bg); /* Integrating top controls into frame concept */
    border-bottom: 1px solid var(--c-divider);
    position: sticky;
    top: 0;
    z-index: 50;
}

.top-controls-inner {
    width: 100%;
    max-width: var(--frame-max-width);
    height: var(--header-height);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 var(--sp-md);
}

/* Document Frame Shell */
.doc-frame-shell {
    width: 100%;
    max-width: var(--frame-max-width);
    background-color: var(--c-frame-bg); /* Shared surface for nav & paper context */
    display: flex;
    flex: 1;
    position: relative;
    /* Desktop: Sibling columns */
}

/* Navigation Rail (Desktop) */
.nav-rail {
    display: none; /* Hidden on mobile by default */
    width: var(--nav-width);
    flex-shrink: 0;
    position: sticky;
    top: var(--header-height);
    height: calc(100vh - var(--header-height));
    overflow-y: auto;
    padding: var(--sp-lg) var(--sp-sm);
    border-right: 1px solid var(--c-divider); /* Subtle hairline */
}

@media (min-width: 768px) {
    .nav-rail { display: block; }
}

/* Paper Content Column */
.paper-column {
    flex: 1;
    min-width: 0; /* Flexbox overflow fix */
    padding: var(--sp-lg) var(--sp-md) var(--sp-xl);
}

.paper-surface {
    background-color: var(--c-paper-bg);
    padding: var(--sp-lg) var(--sp-xl); /* Generous padding */
    min-height: 80vh;
    /* No border radius or shadow per tone rules - flat paper model */
}

@media (max-width: 640px) {
    .paper-surface {
        padding: var(--sp-md);
    }
}

/* ==========================================================================
   NAVIGATION COMPONENTS
   ========================================================================== */
.nav-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.nav-section-label {
    display: block;
    font-size: 0.75rem;
    font-weight: 700;
    color: var(--c-text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-top: var(--sp-lg);
    margin-bottom: var(--sp-sm);
    padding-left: var(--sp-sm);
}

.nav-item {
    display: block;
    width: 100%;
    text-align: left;
    background: none;
    border: none;
    cursor: pointer;
    padding: var(--sp-xs) var(--sp-sm);
    color: var(--c-text-secondary);
    font-size: 0.875rem;
    line-height: 1.4;
    transition: color 0.1s ease;
    /* Flat list - shared left edge */
}

.nav-item:hover {
    color: var(--c-text-primary);
    text-decoration: underline;
    text-decoration-color: var(--c-accent);
    text-decoration-thickness: 1px;
}

.nav-item:focus-visible {
    outline: 2px solid var(--c-accent);
    outline-offset: -2px;
}

.nav-item.is-active {
    font-weight: 700;
    color: var(--c-accent); /* Permitted accent usage in nav */
}

/* Hierarchy via Type Scale Only */
.nav-item[data-depth="0"] { font-size: 0.9rem; }
.nav-item[data-depth="1"] { font-size: 0.85rem; color: var(--c-text-quiet); }
.nav-item[data-depth="2"] { font-size: 0.8rem;  color: var(--c-text-quiet); }

/* ==========================================================================
   PAPER CONTENT COMPONENTS
   ========================================================================== */

/* Question List */
.question-list {
    display: flex;
    flex-direction: column;
    gap: var(--sp-xl); /* Largest spacing unit between top-level questions */
}

.section-header-block {
    border-bottom: 1px solid var(--c-divider);
    margin-bottom: var(--sp-lg);
    padding-bottom: var(--sp-sm);
    margin-top: var(--sp-xl);
}
.section-header-text {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--c-text-secondary);
}

/* Question Node */
.q-node {
    display: flex;
    flex-direction: column;
    position: relative;
    /* No cards, no borders */
}

/* Inter-question spacing based on depth */
.q-node[data-depth="0"] + .q-node[data-depth="0"] { margin-top: var(--sp-xl); }
.q-node[data-depth="1"] { margin-top: var(--sp-md); } 

/* Indentation for children */
.children-container {
    padding-left: var(--sp-lg); /* Structural indentation */
    margin-top: var(--sp-md);
    display: flex;
    flex-direction: column;
    gap: var(--sp-md);
}

@media (max-width: 640px) {
    .children-container { padding-left: var(--sp-md); }
}

/* Question Body */
.q-body {
    display: flex;
    gap: var(--sp-md);
    align-items: baseline;
    font-size: 1.125rem;
    color: var(--c-text-primary);
    margin-bottom: var(--sp-sm);
}
.q-id {
    font-weight: 700;
    flex-shrink: 0;
    min-width: 1.5rem;
    color: var(--c-text-secondary);
    font-size: 1rem;
}
.q-prompt {
    flex: 1;
}

/* Solution Block */
.solution-block {
    margin-left: calc(1.5rem + var(--sp-md)); /* Align with prompt text */
    display: flex;
    flex-direction: column;
    gap: var(--sp-sm);
}

@media (max-width: 640px) {
    .solution-block { margin-left: 0; padding-left: var(--sp-sm); border-left: 2px solid var(--c-divider); }
}

/* Answer */
.answer-region {
    margin-top: var(--sp-xs);
    font-size: 1rem;
}
.answer-label {
    font-size: 0.875rem;
    font-weight: 700;
    color: var(--c-text-secondary);
    margin-right: var(--sp-sm);
}

/* Disclosure Control */
.disclosure-ctrl {
    appearance: none;
    background: none;
    border: none;
    padding: 0;
    margin-top: var(--sp-xs);
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--c-accent);
    cursor: pointer;
    text-align: left;
    display: inline-flex;
    align-items: center;
    gap: var(--sp-xs);
}
.disclosure-ctrl:hover {
    text-decoration: underline;
}
.disclosure-ctrl:focus-visible {
    outline: 2px solid var(--c-focus);
    border-radius: 2px;
}

/* Solution Details Region */
.sd-region {
    margin-top: var(--sp-sm);
    background-color: var(--c-wash-bg); /* Surface differentiation for solution details */
    padding: var(--sp-md);
    /* No border radius per tone */
    display: none; /* Collapsed by default via class toggle */
}
.sd-region.is-expanded {
    display: block;
    animation: reveal 0.2s ease-out;
}

@keyframes reveal {
    from { opacity: 0; transform: translateY(-4px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Subsections */
.sd-subsection {
    margin-bottom: var(--sp-md);
}
.sd-subsection:last-child { margin-bottom: 0; }

.sd-label {
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    color: var(--c-text-secondary);
    margin-bottom: var(--sp-xs);
    display: block;
}

.sd-content {
    font-size: 0.95rem;
    color: var(--c-text-primary);
    /* Subordination via slightly smaller size and context */
}

/* Keep in mind specifics */
.sd-subsection.keep-in-mind .sd-content {
    /* Slightly more prominent than working */
}
.sd-subsection.formulas .sd-content {
    font-family: 'Inter', sans-serif; /* Ensure not forced mono */
}

/* Markdown Content Styling */
.md-content p { margin: 0 0 0.75em 0; }
.md-content p:last-child { margin-bottom: 0; }
.md-content ul, .md-content ol { margin: 0 0 0.75em 1.5em; padding: 0; }
.md-content li { margin-bottom: 0.25em; }
.md-content table {
    width: 100%;
    border-collapse: collapse;
    margin: 1em 0;
    font-size: 0.9em;
}
.md-content th, .md-content td {
    border: 1px solid var(--c-divider);
    padding: 0.5em;
    text-align: left;
}
.md-content th { font-weight: 600; }

/* KaTeX Containment & Styles */
.katex-display {
    overflow-x: auto;
    overflow-y: hidden;
    max-width: 100%;
    padding: 0.25em 0;
    margin: 0.5em 0;
    /* Block math underlay permitted */
    background-color: var(--c-wash-sub-bg); /* Subtle underlay for block math */
}
.katex { font-size: 1.1em; } /* Adjust for readability */

/* Mobile Drawer */
.mobile-jump-trigger {
    display: none; /* Desktop hidden */
}
@media (max-width: 767px) {
    .mobile-jump-trigger {
        display: block;
        background: none;
        border: 1px solid var(--c-divider);
        padding: var(--sp-xs) var(--sp-sm);
        font-size: 0.875rem;
        color: var(--c-text-secondary);
        border-radius: 4px;
        cursor: pointer;
    }
}

.drawer-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 100;
    display: none;
}
.drawer-overlay.is-open { display: flex; justify-content: flex-start; }

.drawer-panel {
    width: 85%;
    max-width: 300px;
    background-color: var(--c-frame-bg);
    height: 100%;
    display: flex;
    flex-direction: column;
    box-shadow: 2px 0 8px rgba(0,0,0,0.1);
}
.drawer-header {
    padding: var(--sp-md);
    border-bottom: 1px solid var(--c-divider);
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.drawer-title { font-weight: 700; color: var(--c-text-primary); }
.drawer-close {
    background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--c-text-secondary);
}
.drawer-content {
    flex: 1;
    overflow-y: auto;
    padding: var(--sp-md);
}

/* Paper Selector */
.paper-selector {
    padding: var(--sp-xs) var(--sp-sm);
    font-size: 0.875rem;
    border: 1px solid var(--c-divider);
    border-radius: 4px;
    background-color: var(--c-paper-bg);
    color: var(--c-text-primary);
}

/* Error State */
.error-message {
    padding: var(--sp-xl);
    text-align: center;
    color: var(--c-text-secondary);
    font-weight: 700;
    border: 1px dashed var(--c-divider);
    margin: var(--sp-xl);
}

</style>
</head>
<body>

<div id="app-root">
    <!-- Initial Loading State -->
    <div style="padding: 2rem; text-align: center; color: #666;">Loading Paper Viewer...</div>
</div>

<!-- LIBRARIES -->
<!-- Markdown-it -->
<script src="https://cdn.jsdelivr.net/npm/markdown-it@13.0.1/dist/markdown-it.min.js"></script>
<!-- KaTeX JS (SRI disabled) -->
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

<script>
// ==========================================================================
// STAGE 0 CONSTANTS (Authoritative)
// ==========================================================================
const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

// ==========================================================================
// APPLICATION LOGIC
// ==========================================================================

const App = {
    state: {
        papersPayload: null,
        currentPaperKey: null,
        expandedMap: {}, // key: questionId -> boolean
        mobileNavOpen: false
    },
    
    // Markdown Renderer (Configured per Stage 6)
    md: window.markdownit ? window.markdownit({
        html: true,
        linkify: true,
        breaks: false // MUST be false
    }) : null,

    async init() {
        if (this.md) {
            this.md.inline.ruler.disable(['escape']);
        }

        try {
            const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
            if (!response.ok) throw new Error('Network response was not ok');
            const data = await response.json();
            this.state.papersPayload = data;
            
            // Set default paper
            if (data.papers && data.papers.length > 0) {
                this.setPaper(data.papers[0].key);
            } else {
                this.renderError("No papers found in payload.");
            }
        } catch (error) {
            console.error(error);
            this.renderError("PAPERS PAYLOAD MISSING");
        }
    },

    setPaper(key) {
        this.state.currentPaperKey = key;
        const paper = this.getCurrentPaper();
        
        // Reset expanded map based on defaults
        this.state.expandedMap = {};
        const defaultExpanded = paper.defaults?.expandedAll !== false; // Default to true unless explicitly false
        
        // Helper to recurse and set defaults
        const setDefaults = (nodes) => {
            nodes.forEach(node => {
                if (node.solutionBlock?.solutionDetails) {
                    this.state.expandedMap[node.id] = defaultExpanded;
                }
                if (node.children) setDefaults(node.children);
            });
        };
        
        if (paper.questions) setDefaults(paper.questions);
        if (paper.sections) {
            paper.sections.forEach(sec => setDefaults(sec.questions));
        }

        this.render();
    },

    getCurrentPaper() {
        return this.state.papersPayload.papers.find(p => p.key === this.state.currentPaperKey);
    },

    toggleWorking(qId) {
        this.state.expandedMap[qId] = !this.state.expandedMap[qId];
        this.render(); // Re-render to update DOM
    },

    toggleMobileNav(isOpen) {
        this.state.mobileNavOpen = isOpen;
        this.render();
    },

    scrollToQuestion(qId) {
        const el = document.getElementById(`q-${qId}`);
        if (el) {
            el.scrollIntoView({ behavior: 'smooth', block: 'start' });
            // Close mobile nav if open
            if (this.state.mobileNavOpen) this.toggleMobileNav(false);
            // Highlight active state logic could go here if tracking scroll
        }
    },

    // ======================================================================
    // RENDERING
    // ======================================================================

    render() {
        const root = document.getElementById('app-root');
        root.innerHTML = ''; // Clear

        if (!this.state.papersPayload) return; // Should have handled error or loading

        const paper = this.getCurrentPaper();

        // 1. Shell
        const shell = document.createElement('div');
        shell.className = 'app-shell';

        // 2. Top Controls Region
        const topRegion = document.createElement('header');
        topRegion.className = 'top-controls-region';
        topRegion.innerHTML = `
            <div class="top-controls-inner">
                <select id="paper-select" class="paper-selector">
                    ${this.state.papersPayload.papers.map(p => 
                        `<option value="${p.key}" ${p.key === this.state.currentPaperKey ? 'selected' : ''}>${p.label}</option>`
                    ).join('')}
                </select>
                <button id="mobile-jump" class="mobile-jump-trigger">Jump to...</button>
            </div>
        `;
        shell.appendChild(topRegion);

        // 3. Document Frame Shell
        const frameShell = document.createElement('div');
        frameShell.className = 'doc-frame-shell';

        // 4. Desktop Nav Rail
        const navRail = document.createElement('nav');
        navRail.className = 'nav-rail no-scrollbar';
        navRail.appendChild(this.buildNavList(paper));
        frameShell.appendChild(navRail);

        // 5. Paper Content Column
        const paperCol = document.createElement('div');
        paperCol.className = 'paper-column';
        
        const paperSurface = document.createElement('div');
        paperSurface.className = 'paper-surface';
        
        // Build Question List
        const listContainer = document.createElement('div');
        listContainer.className = 'question-list';
        
        if (paper.sections) {
            paper.sections.forEach(sec => {
                // Render section header if label exists
                if (sec.label && sec.label.trim().length > 0) {
                    const secHeader = document.createElement('div');
                    secHeader.className = 'section-header-block';
                    secHeader.innerHTML = `<div class="section-header-text">${sec.label}</div>`;
                    listContainer.appendChild(secHeader);
                }
                sec.questions.forEach(q => {
                    listContainer.appendChild(this.buildQuestionNode(q, 0));
                });
            });
        } else if (paper.questions) {
            paper.questions.forEach(q => {
                listContainer.appendChild(this.buildQuestionNode(q, 0));
            });
        }

        paperSurface.appendChild(listContainer);
        paperCol.appendChild(paperSurface);
        frameShell.appendChild(paperCol);

        shell.appendChild(frameShell);

        // 6. Mobile Drawer
        const drawer = document.createElement('div');
        drawer.className = `drawer-overlay ${this.state.mobileNavOpen ? 'is-open' : ''}`;
        drawer.innerHTML = `
            <div class="drawer-panel">
                <div class="drawer-header">
                    <span class="drawer-title">Jump to</span>
                    <button id="drawer-close" class="drawer-close">&times;</button>
                </div>
                <div class="drawer-content">
                    <!-- Nav List injected here -->
                </div>
            </div>
        `;
        // Inject nav list copy into drawer
        const drawerContent = drawer.querySelector('.drawer-content');
        drawerContent.appendChild(this.buildNavList(paper)); // Rebuild a copy

        shell.appendChild(drawer);
        root.appendChild(shell);

        // Event Listeners
        document.getElementById('paper-select').addEventListener('change', (e) => this.setPaper(e.target.value));
        document.getElementById('mobile-jump').addEventListener('click', () => this.toggleMobileNav(true));
        document.getElementById('drawer-close').addEventListener('click', () => this.toggleMobileNav(false));
        drawer.addEventListener('click', (e) => {
            if (e.target === drawer) this.toggleMobileNav(false);
        });

        // KaTeX Rendering Phase
        renderMathInElement(paperSurface, {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false}
            ],
            throwOnError: false
        });
    },

    renderError(msg) {
        const root = document.getElementById('app-root');
        root.innerHTML = `<div class="error-message">${msg}</div>`;
    },

    // ======================================================================
    // DOM BUILDERS
    // ======================================================================

    buildNavList(paper) {
        const ul = document.createElement('ul');
        ul.className = 'nav-list';

        const addItems = (nodes, depth) => {
            nodes.forEach(node => {
                const li = document.createElement('li');
                const btn = document.createElement('button');
                btn.className = 'nav-item';
                btn.textContent = node.id;
                btn.dataset.depth = Math.min(depth, 2); // Cap visual depth attributes
                btn.addEventListener('click', () => this.scrollToQuestion(node.id));
                li.appendChild(btn);
                ul.appendChild(li);

                if (node.children) addItems(node.children, depth + 1);
            });
        };

        if (paper.sections) {
            paper.sections.forEach(sec => {
                if (sec.label && sec.label.trim()) {
                    const label = document.createElement('li');
                    label.className = 'nav-section-label';
                    label.textContent = sec.label;
                    ul.appendChild(label);
                }
                addItems(sec.questions, 0);
            });
        } else {
            addItems(paper.questions || [], 0);
        }
        return ul;
    },

    buildQuestionNode(node, depth) {
        const nodeEl = document.createElement('div');
        nodeEl.className = 'q-node';
        nodeEl.dataset.depth = Math.min(depth, 1); // Only 0 and 1+ matter for top-level spacing
        nodeEl.id = `q-${node.id}`;

        // Question Body
        const qBody = document.createElement('div');
        qBody.className = 'q-body';
        qBody.innerHTML = `
            <div class="q-id">${node.id}</div>
            <div class="q-prompt md-content">${this.mdRender(node.question)}</div>
        `;
        nodeEl.appendChild(qBody);

        // Solution Block (Optional)
        if (node.solutionBlock) {
            const sb = node.solutionBlock;
            const hasAnswer = !!sb.answer;
            const hasDetails = !!sb.solutionDetails;
            const isExpanded = !!this.state.expandedMap[node.id];

            if (hasAnswer || hasDetails) {
                const sbEl = document.createElement('div');
                sbEl.className = 'solution-block';

                // Answer
                if (hasAnswer) {
                    const ansEl = document.createElement('div');
                    ansEl.className = 'answer-region';
                    ansEl.innerHTML = `
                        <span class="answer-label">Answer</span>
                        <span class="md-content">${this.mdRender(sb.answer)}</span>
                    `;
                    sbEl.appendChild(ansEl);
                }

                // Details Control & Region
                if (hasDetails) {
                    const ctrl = document.createElement('button');
                    ctrl.className = 'disclosure-ctrl';
                    ctrl.innerHTML = `
                        <span>${isExpanded ? 'Hide working' : 'Show working'}</span>
                        <svg width="10" height="6" viewBox="0 0 10 6" fill="none" style="transform: ${isExpanded ? 'rotate(180deg)' : 'rotate(0deg)'}">
                            <path d="M1 1L5 5L9 1" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    `;
                    ctrl.addEventListener('click', () => this.toggleWorking(node.id));
                    sbEl.appendChild(ctrl);

                    const detailsEl = document.createElement('div');
                    detailsEl.className = `sd-region ${isExpanded ? 'is-expanded' : ''}`;
                    if (isExpanded) {
                        const sd = sb.solutionDetails;
                        // Keep in mind
                        if (sd.keepInMind) {
                            detailsEl.innerHTML += `
                                <div class="sd-subsection keep-in-mind">
                                    <span class="sd-label">Keep in mind</span>
                                    <div class="sd-content md-content">${this.mdRender(sd.keepInMind)}</div>
                                </div>
                            `;
                        }
                        // Formulas used
                        if (sd.formulasUsed) {
                            detailsEl.innerHTML += `
                                <div class="sd-subsection formulas">
                                    <span class="sd-label">Formulas used</span>
                                    <div class="sd-content md-content">${this.mdRender(sd.formulasUsed)}</div>
                                </div>
                            `;
                        }
                        // Working
                        if (sd.working) {
                            detailsEl.innerHTML += `
                                <div class="sd-subsection working">
                                    <span class="sd-label">Working</span>
                                    <div class="sd-content md-content">${this.mdRender(sd.working)}</div>
                                </div>
                            `;
                        }
                        // Alternative Working
                        if (sd.alternativeWorking && Array.isArray(sd.alternativeWorking)) {
                            sd.alternativeWorking.forEach((alt, idx) => {
                                detailsEl.innerHTML += `
                                    <div class="sd-subsection alt-working">
                                        <span class="sd-label">Alternative working ${sd.alternativeWorking.length > 1 ? idx+1 : ''}</span>
                                        <div class="sd-content md-content">${this.mdRender(alt)}</div>
                                    </div>
                                `;
                            });
                        }
                    }
                    sbEl.appendChild(detailsEl);
                }
                nodeEl.appendChild(sbEl);
            }
        }

        // Children
        if (node.children && node.children.length > 0) {
            const childContainer = document.createElement('div');
            childContainer.className = 'children-container';
            node.children.forEach(child => {
                childContainer.appendChild(this.buildQuestionNode(child, depth + 1));
            });
            nodeEl.appendChild(childContainer);
        }

        return nodeEl;
    },

    mdRender(content) {
        if (!content) return '';
        if (!this.md) return content; // Fallback
        return this.md.render(content);
    }
};

// Start
App.init();

</script>
</body>
</html>
