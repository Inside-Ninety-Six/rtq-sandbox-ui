<!DOCTYPE html>
<html lang="en" class="antialiased">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AB","indexWithinVariant":"161","totalWithinVariant":"200","hueFamily":"green","intensityMode":"","timestamp":"2026-01-07T07:34:26.841Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AB&quot;,&quot;indexWithinVariant&quot;:&quot;161&quot;,&quot;totalWithinVariant&quot;:&quot;200&quot;,&quot;hueFamily&quot;:&quot;green&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-07T07:34:26.841Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>

    <!-- FONTS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- ICONS (Phosphor) -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- KATEX CSS (No Integrity per Stage 6.0.7b) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <!-- TAILWIND (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        // COLORLAB B: Forced Hue Family "green"
                        // Mapping generic "accent" roles to the green scale
                        brand: {
                            50: '#f0fdf4',
                            100: '#dcfce7',
                            200: '#bbf7d0',
                            300: '#86efac',
                            400: '#4ade80',
                            500: '#22c55e',
                            600: '#16a34a',
                            700: '#15803d',  // Primary accent text
                            800: '#166534',  // Active/Darker
                            900: '#14532d',
                        }
                    }
                }
            }
        }
    </script>

    <!-- MARKDOWN-IT -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <!-- KATEX JS (No Integrity per Stage 6.0.7b) -->
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <style>
        /* STAGE 0 & 5: Visual Constraints & Overrides */
        
        /* Base settings */
        body {
            background-color: #f9fafb; /* Soft neutral base */
            color: #1f2937; /* Gray-800 */
        }

        /* Focus management (Stage 5.5.2) */
        *:focus-visible {
            outline: 2px solid #22c55e; /* Green-500 */
            outline-offset: 2px;
        }

        /* Scrollbar hiding for nav (Stage 6.0.9) */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* KaTeX Containment Invariant (Stage 3 & 6.0.8) */
        /* Prevent page horizontal scroll, allow math internal scroll */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            padding-bottom: 4px; /* Space for scrollbar if needed */
            max-width: 100%;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Typography overrides for lists within Markdown */
        .markdown-body ul {
            list-style-type: disc;
            padding-left: 1.5em;
            margin-top: 0.5em;
            margin-bottom: 0.5em;
        }
        .markdown-body ol {
            list-style-type: decimal;
            padding-left: 1.5em;
            margin-top: 0.5em;
            margin-bottom: 0.5em;
        }
        .markdown-body p {
            margin-bottom: 0.75em;
            line-height: 1.6;
        }
        .markdown-body p:last-child {
            margin-bottom: 0;
        }
        /* Tables in markdown */
        .markdown-body table {
            border-collapse: collapse;
            width: 100%;
            margin: 1em 0;
            font-size: 0.95em;
        }
        .markdown-body th, .markdown-body td {
            border: 1px solid #e5e7eb; /* Gray-200 */
            padding: 0.5em 0.75em;
            text-align: left;
        }
        .markdown-body th {
            font-weight: 600;
            background-color: #f9fafb; /* Gray-50 */
        }
        
        /* Navigation sticky positioning */
        .nav-sticky {
            position: sticky;
            top: 0;
            max-height: 100vh;
            overflow-y: auto;
        }

        /* Mobile drawer transitions */
        .drawer-enter { transform: translateX(-100%); opacity: 0; }
        .drawer-enter-active { transform: translateX(0); opacity: 1; transition: all 0.3s ease-out; }
        .drawer-exit { transform: translateX(0); opacity: 1; }
        .drawer-exit-active { transform: translateX(-100%); opacity: 0; transition: all 0.2s ease-in; }

    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- APPLICATION ROOT -->
    <div id="app" class="flex-grow flex flex-col">
        <!-- Loading State -->
        <div id="loader" class="flex items-center justify-center min-h-screen text-gray-500">
            Loading Paper Content...
        </div>
    </div>

    <!-- MAIN SCRIPT -->
    <script>
        // =================================================================
        // STAGE 0: CONSTANTS (Canonical)
        // =================================================================
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";
        // ColorLab B forced hue is implemented via Tailwind config above ("green")

        // =================================================================
        // STATE
        // =================================================================
        const store = {
            papers: [],
            activePaperKey: null,
            loading: true,
            error: false,
            // expandedState: Map<questionId, boolean>
            expandedState: {},
            mobileMenuOpen: false
        };

        // =================================================================
        // INITIALIZATION
        // =================================================================
        document.addEventListener('DOMContentLoaded', init);

        async function init() {
            // Setup Markdown renderer per Stage 6 requirements
            setupMarkdown();

            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Failed to load payload");
                
                const data = await response.json();
                store.papers = data.papers || [];
                
                if (store.papers.length > 0) {
                    selectPaper(store.papers[0].key);
                } else {
                    store.error = true;
                }
            } catch (e) {
                console.error(e);
                store.error = true;
            } finally {
                store.loading = false;
                render();
            }
        }

        let md = null;
        function setupMarkdown() {
            // Stage 6.0.1 Implementation Add-on: Markdown config
            if (window.markdownit) {
                md = window.markdownit({
                    html: true, // Inline SVG passthrough
                    linkify: true,
                    breaks: false // Critical: prevent <br> in math
                });
                // Disable escape to preserve TeX backslashes
                md.inline.ruler.disable(['escape']);
            }
        }

        // =================================================================
        // ACTIONS
        // =================================================================
        function selectPaper(key) {
            store.activePaperKey = key;
            store.expandedState = {}; // Reset expansion state
            store.mobileMenuOpen = false;
            
            const paper = store.papers.find(p => p.key === key);
            if (paper) {
                // Initialize default expansion state based on paper defaults
                const defaultExpanded = paper.defaults?.expandedAll !== false;
                
                // Recursively set default state for all questions with solution details
                const initQuestions = (qs) => {
                    qs.forEach(q => {
                        if (q.solutionBlock?.solutionDetails) {
                            store.expandedState[q.id] = defaultExpanded;
                        }
                        if (q.children) initQuestions(q.children);
                    });
                };
                
                if (paper.sections) {
                    paper.sections.forEach(s => initQuestions(s.questions));
                } else if (paper.questions) {
                    initQuestions(paper.questions);
                }
            }
            render();
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'auto' });
        }

        function toggleSolution(questionId) {
            store.expandedState[questionId] = !store.expandedState[questionId];
            render(); 
            // Note: In a robust React app we'd preserve scroll, here re-render is fast enough.
            // But we must re-trigger KaTeX after render.
        }

        function toggleMobileMenu() {
            store.mobileMenuOpen = !store.mobileMenuOpen;
            render();
        }

        function scrollToQuestion(id) {
            const el = document.getElementById(`q-${id}`);
            if (el) {
                el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                // If mobile menu is open, close it
                if (store.mobileMenuOpen) {
                    toggleMobileMenu();
                }
            }
        }

        // =================================================================
        // RENDERING (HTML GENERATION)
        // =================================================================
        function render() {
            const app = document.getElementById('app');
            if (!app) return;

            if (store.loading) return; // Loader already there

            if (store.error) {
                app.innerHTML = `
                    <div class="flex flex-col items-center justify-center min-h-screen p-4 text-center">
                        <h1 class="text-xl font-bold text-gray-900 mb-2">PAPERS PAYLOAD MISSING</h1>
                        <p class="text-gray-600">Could not load content from ${RTQ_PAPERS_PAYLOAD_PATH}</p>
                    </div>
                `;
                return;
            }

            const activePaper = store.papers.find(p => p.key === store.activePaperKey);
            if (!activePaper) return;

            // Generate full UI
            app.innerHTML = `
                ${renderTopControls(activePaper)}
                ${renderMobileDrawer(activePaper)}
                
                <div class="flex-grow w-full max-w-7xl mx-auto md:flex md:flex-row relative">
                    <!-- DESKTOP NAV RAIL -->
                    <aside class="hidden md:block w-64 flex-shrink-0 border-r border-transparent">
                        <div class="nav-sticky h-screen py-6 px-4 no-scrollbar">
                           ${renderNavList(activePaper)} 
                        </div>
                    </aside>

                    <!-- PAPER CONTENT -->
                    <main class="flex-grow min-w-0 py-6 px-4 md:px-8 lg:px-12 bg-white">
                        <div class="max-w-3xl mx-auto">
                            ${renderPaperContent(activePaper)}
                        </div>
                    </main>
                </div>
            `;

            // Post-render: KaTeX
            if (window.renderMathInElement) {
                renderMathInElement(document.body, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false}
                    ],
                    throwOnError: false
                });
            }

            // Re-attach events (Vanilla JS delegation would be better, but direct binding for simplicity)
            bindEvents();
        }

        function renderTopControls(activePaper) {
            const options = store.papers.map(p => 
                `<option value="${p.key}" ${p.key === activePaper.key ? 'selected' : ''}>${p.label}</option>`
            ).join('');

            return `
                <div class="sticky top-0 z-40 w-full bg-white/95 backdrop-blur border-b border-gray-200">
                    <div class="max-w-7xl mx-auto px-4 h-14 flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <!-- Paper Selector -->
                            <div class="relative">
                                <select id="paper-selector" class="appearance-none bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-md focus:ring-brand-500 focus:border-brand-500 block w-full p-2 pr-8 cursor-pointer">
                                    ${options}
                                </select>
                                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
                                    <i class="ph ph-caret-down"></i>
                                </div>
                            </div>
                        </div>

                        <!-- Mobile Jump To Trigger -->
                        <button id="mobile-menu-trigger" class="md:hidden flex items-center gap-2 text-sm font-medium text-brand-700 hover:text-brand-800">
                            <span>Jump to</span>
                            <i class="ph ph-list text-lg"></i>
                        </button>
                    </div>
                </div>
            `;
        }

        function renderNavList(paper) {
            // Helper to render a list of questions
            const renderItems = (questions) => {
                return questions.map(q => {
                    // Flatten hierarchy visually but keep structure logic if needed
                    // Stage 5.4.5: Flat list, identifiers only.
                    // Sub-questions expressed via typographic scale only.
                    
                    // Simple recursive flattener for navigation items
                    let html = renderNavItem(q, 0);
                    if (q.children && q.children.length > 0) {
                        html += q.children.map(c => renderNavItem(c, 1)).join('');
                    }
                    return html;
                }).join('');
            };

            const renderNavItem = (q, depth) => {
                // Depth 0: Base text size
                // Depth >0: Smaller, lighter weight
                const baseClasses = "block py-1 text-left hover:text-brand-700 hover:underline decoration-brand-300 underline-offset-2 transition-colors duration-150";
                const depthClasses = depth === 0 
                    ? "text-gray-600 font-medium text-sm" 
                    : "text-gray-500 text-xs font-normal pl-0"; // No indentation allowed per rules, just scale
                
                return `
                    <button onclick="scrollToQuestion('${q.id}')" class="${baseClasses} ${depthClasses} w-full truncate">
                        ${q.id}
                    </button>
                `;
            };

            let content = '';

            if (paper.sections) {
                content = paper.sections.map(sec => {
                    // Section Header (non-clickable)
                    const header = sec.label && sec.label.trim() !== '' 
                        ? `<div class="mt-4 mb-2 first:mt-0 text-xs font-bold text-gray-400 uppercase tracking-wider">${sec.label}</div>`
                        : `<div class="mt-2"></div>`; // Spacing if no label but logic separation
                    
                    return header + renderItems(sec.questions);
                }).join('');
            } else if (paper.questions) {
                content = renderItems(paper.questions);
            }

            return `<nav class="flex flex-col gap-0.5">${content}</nav>`;
        }

        function renderMobileDrawer(paper) {
            if (!store.mobileMenuOpen) return '';

            return `
                <div class="fixed inset-0 z-50 flex justify-end">
                    <!-- Scrim -->
                    <div class="absolute inset-0 bg-black/20 backdrop-blur-sm" onclick="toggleMobileMenu()"></div>
                    
                    <!-- Drawer -->
                    <div class="relative w-64 bg-white h-full shadow-xl flex flex-col animate-[drawer-enter_0.3s_ease-out]">
                        <div class="flex items-center justify-between p-4 border-b border-gray-100">
                            <h2 class="text-sm font-semibold text-gray-900">Jump to</h2>
                            <button onclick="toggleMobileMenu()" class="text-gray-500 hover:text-gray-700 p-1">
                                <i class="ph ph-x text-lg"></i>
                            </button>
                        </div>
                        <div class="flex-grow overflow-y-auto p-4 no-scrollbar">
                            ${renderNavList(paper)}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderPaperContent(paper) {
            if (paper.sections) {
                return paper.sections.map(sec => {
                    const headerHtml = sec.label && sec.label.trim() !== '' 
                        ? `<div class="mb-8 mt-12 pb-2 border-b border-gray-200">
                                <h2 class="text-xl font-bold text-gray-900">${sec.label}</h2>
                           </div>`
                        : '';
                    
                    const questionsHtml = renderQuestionList(sec.questions);
                    return `<section class="mb-12">${headerHtml}${questionsHtml}</section>`;
                }).join('');
            } else if (paper.questions) {
                return renderQuestionList(paper.questions);
            }
            return '';
        }

        function renderQuestionList(questions) {
            return questions.map(q => renderQuestionNode(q, 0)).join('');
        }

        function renderQuestionNode(q, depth) {
            // Stage 3 & 5: Spacing and hierarchy
            // Top level gets largest spacing.
            const containerClass = depth === 0 ? "mb-16" : "mt-6 mb-2";
            
            // Sub-question indentation (adaptive)
            const indentClass = depth > 0 ? "pl-4 md:pl-8 border-l-2 border-transparent" : "";

            // Question Body
            const qBodyHtml = `
                <div class="flex gap-3 md:gap-4 items-baseline group" id="q-${q.id}">
                    <span class="flex-shrink-0 font-bold text-gray-500 w-8 md:w-10 text-right text-sm md:text-base select-none pt-0.5">${q.id}</span>
                    <div class="flex-grow min-w-0">
                        <div class="text-gray-900 font-medium text-base md:text-lg leading-relaxed markdown-body">
                            ${parseMarkdown(q.question)}
                        </div>
                    </div>
                </div>
            `;

            // Solution Block (Optional)
            let solutionBlockHtml = '';
            if (q.solutionBlock) {
                const { answer, solutionDetails } = q.solutionBlock;
                
                // 1. Answer (visible by default if present)
                let answerHtml = '';
                if (answer) {
                    answerHtml = `
                        <div class="mt-4 flex gap-3 md:gap-4">
                            <div class="w-8 md:w-10 flex-shrink-0"></div> <!-- Indent spacer -->
                            <div class="flex-grow">
                                <div class="inline-block">
                                    <span class="text-xs font-bold text-gray-400 uppercase tracking-wider block mb-1">Answer</span>
                                    <div class="text-gray-800 text-base markdown-body">
                                        ${parseMarkdown(answer)}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }

                // 2. Solution Details (Expandable)
                let detailsHtml = '';
                if (solutionDetails) {
                    const isExpanded = !!store.expandedState[q.id];
                    
                    const toggleLabel = isExpanded ? "Hide working" : "Show working";
                    const toggleIcon = isExpanded ? "ph-caret-up" : "ph-caret-down";
                    
                    // Disclosure Control
                    const controlHtml = `
                        <div class="mt-3 flex gap-3 md:gap-4 select-none">
                            <div class="w-8 md:w-10 flex-shrink-0"></div>
                            <button onclick="toggleSolution('${q.id}')" class="group flex items-center gap-1.5 text-sm font-medium text-brand-700 hover:text-brand-800 focus:outline-none focus:ring-2 focus:ring-brand-500 rounded px-1 -ml-1 py-1 transition-colors">
                                <span>${toggleLabel}</span>
                                <i class="ph ${toggleIcon}"></i>
                            </button>
                        </div>
                    `;

                    // Expanded Content
                    let expandedContent = '';
                    if (isExpanded) {
                        const { keepInMind, formulasUsed, working, alternativeWorking } = solutionDetails;

                        // Helper for subsections
                        const renderSubsection = (label, contentMd, type) => {
                            if (!contentMd) return '';
                            // Type styles
                            let labelStyle = "text-gray-500";
                            let bodyStyle = "text-gray-600";
                            
                            if (type === 'keepInMind') {
                                labelStyle = "text-brand-700"; // Slight accent for tips per rules
                                bodyStyle = "text-gray-700";
                            }

                            return `
                                <div class="mt-5 first:mt-0">
                                    <h4 class="text-xs font-bold uppercase tracking-wider mb-2 ${labelStyle}">${label}</h4>
                                    <div class="markdown-body ${bodyStyle} text-sm md:text-base">
                                        ${parseMarkdown(contentMd)}
                                    </div>
                                </div>
                            `;
                        };

                        // Alt workings array handling
                        let altWorkingsHtml = '';
                        if (alternativeWorking && Array.isArray(alternativeWorking)) {
                            altWorkingsHtml = alternativeWorking.map(aw => renderSubsection("Alternative working", aw)).join('');
                        } else if (alternativeWorking && typeof alternativeWorking === 'string') {
                            altWorkingsHtml = renderSubsection("Alternative working", alternativeWorking);
                        }

                        expandedContent = `
                            <div class="mt-2 flex gap-3 md:gap-4 animate-fade-in">
                                <div class="w-8 md:w-10 flex-shrink-0 border-r-2 border-brand-100 mr-[-2px] relative z-0"></div> <!-- Vertical thread hint -->
                                <div class="flex-grow pt-2 pb-4">
                                    ${renderSubsection("Keep in mind", keepInMind, 'keepInMind')}
                                    ${renderSubsection("Formulas used", formulasUsed)}
                                    ${renderSubsection("Working", working)}
                                    ${altWorkingsHtml}
                                </div>
                            </div>
                        `;
                    }

                    detailsHtml = controlHtml + expandedContent;
                }

                solutionBlockHtml = answerHtml + detailsHtml;
            }

            // Children recursion
            let childrenHtml = '';
            if (q.children && q.children.length > 0) {
                childrenHtml = `
                    <div class="mt-2">
                        ${q.children.map(c => renderQuestionNode(c, depth + 1)).join('')}
                    </div>
                `;
            }

            return `
                <div class="${containerClass} ${indentClass}">
                    ${qBodyHtml}
                    ${solutionBlockHtml}
                    ${childrenHtml}
                </div>
            `;
        }

        // =================================================================
        // UTILS
        // =================================================================
        function parseMarkdown(text) {
            if (!text) return '';
            if (!md) return text; // Fallback if MD failed to load
            return md.render(text);
        }

        function bindEvents() {
            // Paper Selector
            const selector = document.getElementById('paper-selector');
            if (selector) {
                selector.onchange = (e) => selectPaper(e.target.value);
            }

            // Mobile Trigger
            const trigger = document.getElementById('mobile-menu-trigger');
            if (trigger) {
                trigger.onclick = toggleMobileMenu;
            }
        }
    </script>
</body>
</html>
