<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"ABC","indexWithinVariant":"107","totalWithinVariant":"320","hueFamily":"purple","intensityMode":"high_chroma_surfaces","timestamp":"2026-01-07T14:21:27.656Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;ABC&quot;,&quot;indexWithinVariant&quot;:&quot;107&quot;,&quot;totalWithinVariant&quot;:&quot;320&quot;,&quot;hueFamily&quot;:&quot;purple&quot;,&quot;intensityMode&quot;:&quot;high_chroma_surfaces&quot;,&quot;timestamp&quot;:&quot;2026-01-07T14:21:27.656Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer (Stage 6 Baseline)</title>

    <!-- Tailwind CSS (via CDN for prototyping) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- KaTeX CSS (No integrity, no SRI) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Markdown-it (No integrity) -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>
    
    <!-- KaTeX JS (No integrity) -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* 
         * COLORLAB C: HUE APPLICATION INTENSITY (high_chroma_surfaces)
         * COLORLAB B: FORCED HUE FAMILY (Purple - approx H=300)
         * LIGHT MODE ONLY
         */
        :root {
            /* 
             * Hue 300 (Purple) 
             * High Chroma Surfaces Specs:
             * - 2 major surfaces C in [0.06 .. 0.12]
             * - Remaining major surface C in [0.03 .. 0.07]
             */
            
            /* Page Background (Major 1 - High Chroma) */
            --col-page-bg: oklch(0.95 0.08 300);
            
            /* Frame Base (Major 2 - High Chroma) */
            --col-frame-bg: oklch(0.93 0.09 300);
            
            /* Paper Surface (Major 3 - Moderate/Tinted) */
            --col-paper-bg: oklch(0.99 0.035 300);

            /* Solution Details Wash (C in [0.05 .. 0.10]) */
            --col-sd-wash: oklch(0.96 0.06 300);

            /* Keep/Formulas Surfaces (C in [0.05 .. 0.11]) */
            --col-info-surface: oklch(0.95 0.07 300);

            /* Text (Primary C <= 0.015, Secondary C <= 0.015) */
            --col-text-primary: oklch(0.20 0.015 300);
            --col-text-secondary: oklch(0.45 0.015 300);
            --col-text-tertiary: oklch(0.60 0.015 300);

            /* Accent (C in [0.12 .. 0.20]) */
            --col-accent: oklch(0.60 0.18 300);
            --col-accent-hover: oklch(0.55 0.18 300);
            
            /* Borders/Dividers (Neutral-ish) */
            --col-divider: oklch(0.88 0.04 300);
            
            /* Focus Ring */
            --col-focus: oklch(0.60 0.18 300);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--col-page-bg);
            color: var(--col-text-primary);
            overflow-y: scroll; /* Force scrollbar to prevent layout shift */
        }

        /* 
         * KaTeX Containment Invariant (Locked) 
         * Prevent page-level horizontal scroll.
         * Scroll only within math blocks.
         */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 4px; /* Space for scrollbar */
        }
        
        /* Hide scrollbars for nav lists but keep functional */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Focus styles */
        .focus-ring {
            outline: none;
        }
        .focus-ring:focus-visible {
            outline: 2px solid var(--col-focus);
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* Markdown Table Minimal Styling */
        .md-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 1em 0;
            font-size: 0.95em;
        }
        .md-content th, .md-content td {
            border: 1px solid var(--col-divider);
            padding: 0.5em 0.75em;
            text-align: left;
        }
        .md-content th {
            font-weight: 600;
        }

        /* Markdown Lists */
        .md-content ul {
            list-style-type: disc;
            padding-left: 1.25em;
            margin-bottom: 1em;
        }
        .md-content ol {
            list-style-type: decimal;
            padding-left: 1.25em;
            margin-bottom: 1em;
        }
        .md-content p {
            margin-bottom: 0.75em;
        }
        .md-content p:last-child {
            margin-bottom: 0;
        }

        /* Inline SVG sizing */
        svg {
            display: inline-block;
            vertical-align: middle;
        }
        
        /* Color Application Utility Classes */
        .bg-page { background-color: var(--col-page-bg); }
        .bg-frame { background-color: var(--col-frame-bg); }
        .bg-paper { background-color: var(--col-paper-bg); }
        .bg-sd-wash { background-color: var(--col-sd-wash); }
        .bg-info { background-color: var(--col-info-surface); }
        .text-primary { color: var(--col-text-primary); }
        .text-secondary { color: var(--col-text-secondary); }
        .text-tertiary { color: var(--col-text-tertiary); }
        .text-accent { color: var(--col-accent); }
        .border-divider { border-color: var(--col-divider); }
        .border-accent { border-color: var(--col-accent); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        /**
         * STAGE 0: CONSTANTS
         * Authoritative source of truth for paths.
         */
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // --- Markdown Renderer Configuration (Authoritative) ---
        // Must configure before component usage.
        const md = window.markdownit 
            ? window.markdownit({
                html: true,     // Allow inline SVG/HTML
                linkify: true,
                breaks: false,  // CRITICAL: Must be false to prevent <br> breaking KaTeX
            })
            : null;

        if (md) {
            // Disable escape rule to preserve TeX backslashes
            md.inline.ruler.disable(['escape']);
        }

        // --- Components ---

        const Icons = {
            ChevronRight: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m9 18 6-6-6-6"/></svg>,
            ChevronDown: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m6 9 6 6 6-6"/></svg>,
            Menu: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>,
            X: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
            Info: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
        };

        // Render Markdown content and apply KaTeX auto-render
        const MarkdownContent = ({ content, className = "" }) => {
            const containerRef = React.useRef(null);

            React.useEffect(() => {
                if (containerRef.current && window.renderMathInElement) {
                    window.renderMathInElement(containerRef.current, {
                        delimiters: [
                            {left: '$$', right: '$$', display: true},
                            {left: '$', right: '$', display: false}
                        ],
                        throwOnError: false
                    });
                }
            }, [content]);

            if (!md) return <div className="text-red-600">Markdown renderer missing</div>;
            if (!content) return null;

            const html = md.render(content);

            return (
                <div 
                    ref={containerRef}
                    className={`md-content ${className}`}
                    dangerouslySetInnerHTML={{ __html: html }}
                />
            );
        };

        // Navigation Item
        const NavItem = ({ id, label, isActive, onClick, depth = 0 }) => {
            // Stage 5.4.5: Flat list, hierarchy via type scale/weight only.
            // Accent color allowed for Nav Current Marker (Override 5.3.2)
            
            const baseClasses = "block w-full text-left py-1.5 px-3 rounded focus-ring transition-colors duration-200 select-none";
            const textClasses = isActive 
                ? "font-semibold text-accent" 
                : "text-secondary hover:text-primary hover:bg-black/5"; // subtle hover

            // Sub-questions quieter (depth 1+)
            const depthScale = depth > 0 ? "text-sm" : "text-base";

            return (
                <button 
                    onClick={onClick}
                    className={`${baseClasses} ${textClasses} ${depthScale}`}
                >
                    {label}
                </button>
            );
        };

        // Section Label (Non-clickable)
        const NavSectionLabel = ({ label }) => (
            <div className="px-3 pt-4 pb-1 text-xs font-bold uppercase tracking-wider text-tertiary select-none">
                {label}
            </div>
        );

        // Solution Details Block
        const SolutionDetails = ({ details, isExpanded, onToggle }) => {
            const { keepInMind, formulasUsed, working, alternativeWorking } = details;

            // If no details content actually exists, don't render toggle (Stage 3 logic)
            // But if details object exists, we assume authored intent.
            
            return (
                <div className="mt-2">
                    {/* Disclosure Control */}
                    {/* Stage 5.7: Text-first, optional icon. Subordinate to Answer. */}
                    {/* Accent permitted for disclosure text (Stage 6.0.11) */}
                    <button 
                        onClick={onToggle}
                        className="flex items-center gap-1.5 text-sm font-medium text-accent hover:text-accent-hover focus-ring rounded px-1 -ml-1 py-1 transition-colors"
                        aria-expanded={isExpanded}
                    >
                        <span className="text-xs">{isExpanded ? <Icons.ChevronDown /> : <Icons.ChevronRight />}</span>
                        <span>{isExpanded ? "Hide working" : "Show working"}</span>
                    </button>

                    {isExpanded && (
                        <div className="mt-3 pl-1 bg-sd-wash rounded-sm overflow-hidden border-l-2 border-divider">
                            <div className="p-4 space-y-6">
                                {/* Keep in mind */}
                                {keepInMind && (
                                    <div className="bg-info rounded p-3 text-sm text-secondary">
                                        <div className="flex items-center gap-2 mb-2 font-semibold text-primary">
                                            <Icons.Info />
                                            <span>Keep in mind</span>
                                        </div>
                                        <MarkdownContent content={keepInMind} />
                                    </div>
                                )}

                                {/* Formulas used */}
                                {formulasUsed && (
                                    <div className="space-y-1">
                                        <div className="text-xs font-bold uppercase tracking-wide text-tertiary">Formulas used</div>
                                        <div className="text-sm text-secondary">
                                            <MarkdownContent content={formulasUsed} />
                                        </div>
                                    </div>
                                )}

                                {/* Working (Primary) */}
                                {working && (
                                    <div className="space-y-1">
                                        <div className="text-xs font-bold uppercase tracking-wide text-tertiary">Working</div>
                                        <div className="text-base text-secondary">
                                            <MarkdownContent content={working} />
                                        </div>
                                    </div>
                                )}

                                {/* Alternative Working */}
                                {alternativeWorking && Array.isArray(alternativeWorking) && alternativeWorking.map((alt, idx) => (
                                    <div key={idx} className="pt-4 mt-4 border-t border-divider space-y-1">
                                        <div className="text-xs font-bold uppercase tracking-wide text-tertiary">Alternative working</div>
                                        <div className="text-base text-secondary">
                                            <MarkdownContent content={alt} />
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // Question Node
        const QuestionNode = ({ node, depth = 0, expandedState, toggleExpand, paperDefaults }) => {
            const { id, question, solutionBlock, children } = node;
            const hasSolutionBlock = !!solutionBlock;
            const hasDetails = hasSolutionBlock && !!solutionBlock.solutionDetails;
            
            // Determine expanded state: explicit state -> paper default -> true
            const isExpanded = expandedState[id] !== undefined 
                ? expandedState[id] 
                : (paperDefaults?.expandedAll ?? true);

            // Spacing rhythm based on depth
            const containerClass = depth === 0 
                ? "mb-12" // Top-level: Largest spacing
                : "mt-6 ml-0 md:ml-4"; // Children: Indented on desktop, vertical spacing

            return (
                <div id={`q-${id}`} className={`group ${containerClass}`}>
                    {/* Question Body */}
                    <div className="flex flex-col gap-2">
                        <div className="flex items-baseline gap-3">
                            <span className="text-sm font-bold text-tertiary shrink-0 select-none min-w-[1.5rem]">{id}</span>
                            <div className="flex-1 min-w-0">
                                <div className="text-lg font-medium text-primary">
                                    <MarkdownContent content={question} />
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Solution Block (Optional) */}
                    {hasSolutionBlock && (
                        <div className="ml-9 mt-4">
                            {/* Answer (Visible by default if present) */}
                            {solutionBlock.answer && (
                                <div className="mb-3">
                                    <div className="text-xs font-bold text-tertiary uppercase tracking-wider mb-1">Answer</div>
                                    <div className="text-base font-medium text-primary">
                                        <MarkdownContent content={solutionBlock.answer} />
                                    </div>
                                </div>
                            )}

                            {/* Solution Details (Expandable) */}
                            {hasDetails && (
                                <SolutionDetails 
                                    details={solutionBlock.solutionDetails}
                                    isExpanded={isExpanded}
                                    onToggle={() => toggleExpand(id)}
                                />
                            )}
                        </div>
                    )}

                    {/* Children */}
                    {children && children.length > 0 && (
                        <div className="border-l border-transparent">
                            {children.map(child => (
                                <QuestionNode 
                                    key={child.id} 
                                    node={child} 
                                    depth={depth + 1}
                                    expandedState={expandedState}
                                    toggleExpand={toggleExpand}
                                    paperDefaults={paperDefaults}
                                />
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        const PaperViewer = () => {
            const [payload, setPayload] = React.useState(null);
            const [error, setError] = React.useState(false);
            const [currentPaperKey, setCurrentPaperKey] = React.useState(null);
            const [expandedState, setExpandedState] = React.useState({});
            const [isMobileNavOpen, setIsMobileNavOpen] = React.useState(false);

            // Fetch Payload
            React.useEffect(() => {
                fetch(RTQ_PAPERS_PAYLOAD_PATH)
                    .then(res => {
                        if (!res.ok) throw new Error("Fetch failed");
                        return res.json();
                    })
                    .then(data => {
                        setPayload(data);
                        if (data.papers && data.papers.length > 0) {
                            setCurrentPaperKey(data.papers[0].key);
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        setError(true);
                    });
            }, []);

            // Helper to scroll to question
            const scrollToQuestion = (id) => {
                const el = document.getElementById(`q-${id}`);
                if (el) {
                    el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    // On mobile, close drawer
                    setIsMobileNavOpen(false);
                }
            };

            // Toggle logic
            const toggleExpand = (id) => {
                setExpandedState(prev => {
                    const currentPaper = payload?.papers.find(p => p.key === currentPaperKey);
                    const defaultState = currentPaper?.defaults?.expandedAll ?? true;
                    const currentState = prev[id] !== undefined ? prev[id] : defaultState;
                    return { ...prev, [id]: !currentState };
                });
            };

            if (error) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-page text-primary font-bold">
                        PAPERS PAYLOAD MISSING
                    </div>
                );
            }

            if (!payload) {
                return <div className="min-h-screen bg-page"></div>; // Loading...
            }

            const currentPaper = payload.papers.find(p => p.key === currentPaperKey);

            // Flatten questions for navigation
            // If sections exist, we group them. If not, flat list.
            const renderNavItems = () => {
                if (!currentPaper) return null;

                const renderItem = (q, depth=0) => (
                    <React.Fragment key={q.id}>
                        <NavItem 
                            id={q.id}
                            label={q.id} // Identifiers only
                            depth={depth}
                            isActive={false} // Simple prototyping active state logic could go here, omitting for simplicity/perf
                            onClick={() => scrollToQuestion(q.id)}
                        />
                        {q.children?.map(child => renderItem(child, depth + 1))}
                    </React.Fragment>
                );

                // Sectioned Paper
                if (currentPaper.sections) {
                    return currentPaper.sections.map((section, idx) => (
                        <div key={idx} className="mb-4">
                            {section.label && section.label.trim() !== "" && (
                                <NavSectionLabel label={section.label} />
                            )}
                            <div className="space-y-0.5">
                                {section.questions.map(q => renderItem(q))}
                            </div>
                        </div>
                    ));
                }

                // Flat Paper
                return (
                    <div className="space-y-0.5 mt-2">
                        {currentPaper.questions.map(q => renderItem(q))}
                    </div>
                );
            };

            return (
                <div className="min-h-screen flex flex-col">
                    {/* Top Controls (Aligned to frame) */}
                    <div className="bg-frame border-b border-divider sticky top-0 z-20">
                        <div className="max-w-6xl mx-auto px-4 h-14 flex items-center justify-between">
                            {/* Paper Selector */}
                            <select 
                                value={currentPaperKey || ""}
                                onChange={(e) => {
                                    setCurrentPaperKey(e.target.value);
                                    setExpandedState({}); // Reset local state on switch
                                    window.scrollTo(0,0);
                                }}
                                className="bg-white border border-divider text-primary text-sm rounded px-3 py-1.5 focus-ring"
                            >
                                {payload.papers.map(p => (
                                    <option key={p.key} value={p.key}>{p.label}</option>
                                ))}
                            </select>

                            {/* Mobile Jump To */}
                            <button 
                                className="md:hidden flex items-center gap-2 text-sm font-medium text-accent focus-ring px-2 py-1 rounded"
                                onClick={() => setIsMobileNavOpen(true)}
                            >
                                <span>Jump to</span>
                                <Icons.Menu />
                            </button>
                        </div>
                    </div>

                    {/* DocumentFrameShell */}
                    <div className="flex-1 bg-frame">
                        <div className="max-w-6xl mx-auto flex min-h-[calc(100vh-3.5rem)]">
                            
                            {/* Desktop Nav Rail (Sticky) */}
                            <nav className="hidden md:block w-64 shrink-0 py-8 pr-8 sticky top-14 h-[calc(100vh-3.5rem)] overflow-y-auto no-scrollbar">
                                {renderNavItems()}
                            </nav>

                            {/* Separator */}
                            <div className="hidden md:block w-px bg-divider my-8"></div>

                            {/* Paper Content Column */}
                            <main className="flex-1 min-w-0 py-8 px-4 md:px-12 bg-frame"> {/* Using Frame BG here as Paper and Nav share context on desktop per Stage 3 */}
                                <div className="bg-paper shadow-sm border border-divider rounded-sm max-w-3xl mx-auto p-8 md:p-12 min-h-[80vh]">
                                    {currentPaper && (
                                        <>
                                            {/* Sectioned Rendering */}
                                            {currentPaper.sections ? (
                                                currentPaper.sections.map((section, sIdx) => (
                                                    <div key={sIdx} className="mb-12">
                                                        {section.label && section.label.trim() !== "" && (
                                                            <div className="border-b border-divider pb-2 mb-8">
                                                                <span className="text-xl font-bold text-primary">{section.label}</span>
                                                            </div>
                                                        )}
                                                        <div>
                                                            {section.questions.map((q, qIdx) => (
                                                                <React.Fragment key={q.id}>
                                                                    <QuestionNode 
                                                                        node={q} 
                                                                        expandedState={expandedState}
                                                                        toggleExpand={toggleExpand}
                                                                        paperDefaults={currentPaper.defaults}
                                                                    />
                                                                    {/* Divider between top-level questions (except last) */}
                                                                    {(qIdx < section.questions.length - 1) && (
                                                                        <div className="h-px bg-divider/50 my-12" />
                                                                    )}
                                                                </React.Fragment>
                                                            ))}
                                                        </div>
                                                    </div>
                                                ))
                                            ) : (
                                                /* Flat Rendering */
                                                <div>
                                                    {currentPaper.questions.map((q, qIdx) => (
                                                        <React.Fragment key={q.id}>
                                                            <QuestionNode 
                                                                node={q} 
                                                                expandedState={expandedState}
                                                                toggleExpand={toggleExpand}
                                                                paperDefaults={currentPaper.defaults}
                                                            />
                                                            {/* Divider between top-level questions */}
                                                            {(qIdx < currentPaper.questions.length - 1) && (
                                                                <div className="h-px bg-divider/50 my-12" />
                                                            )}
                                                        </React.Fragment>
                                                    ))}
                                                </div>
                                            )}
                                        </>
                                    )}
                                </div>
                            </main>
                        </div>
                    </div>

                    {/* Mobile Navigation Drawer */}
                    {isMobileNavOpen && (
                        <div className="fixed inset-0 z-50 flex justify-end md:hidden" role="dialog" aria-modal="true">
                            {/* Scrim */}
                            <div 
                                className="absolute inset-0 bg-black/20 backdrop-blur-sm"
                                onClick={() => setIsMobileNavOpen(false)}
                            ></div>
                            
                            {/* Drawer */}
                            <div className="relative w-64 h-full bg-paper shadow-2xl flex flex-col">
                                <div className="h-14 flex items-center justify-between px-4 border-b border-divider bg-frame">
                                    <span className="font-bold text-primary">Jump to</span>
                                    <button 
                                        onClick={() => setIsMobileNavOpen(false)}
                                        className="text-secondary p-1 focus-ring rounded"
                                    >
                                        <Icons.X />
                                    </button>
                                </div>
                                <div className="flex-1 overflow-y-auto p-4 bg-frame">
                                    {renderNavItems()}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<PaperViewer />);
    </script>
</body>
</html>
