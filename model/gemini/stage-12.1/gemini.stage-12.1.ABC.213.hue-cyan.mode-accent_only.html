<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"ABC","indexWithinVariant":"213","totalWithinVariant":"320","hueFamily":"cyan","intensityMode":"accent_only","timestamp":"2026-01-07T19:16:39.841Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;ABC&quot;,&quot;indexWithinVariant&quot;:&quot;213&quot;,&quot;totalWithinVariant&quot;:&quot;320&quot;,&quot;hueFamily&quot;:&quot;cyan&quot;,&quot;intensityMode&quot;:&quot;accent_only&quot;,&quot;timestamp&quot;:&quot;2026-01-07T19:16:39.841Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer (Stress Test)</title>

    <!-- 
      STAGE 0: CONSTANTS & EXTERNAL LIBS
      
      Libraries:
      - Tailwind CSS (via CDN for styling)
      - KaTeX (CSS + JS for math rendering)
      - Markdown-it (JS for content rendering)
      - Remix Icon (for UI icons)
      
      SRI/Integrity is intentionally disabled per Stage 6 baseline rules to prevent load failures.
    -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

    <!-- COLORLAB C CONFIGURATION: Mode 1 (accent_only) + Hue (cyan) -->
    <style>
        :root {
            /* 
               COLORLAB C: MODE 1 (accent_only) - CYAN
               Hue: 190 (Cyan)
               Rules:
               - Surfaces C <= 0.015
               - Text C <= 0.010
               - Accent C in [0.08 .. 0.14]
            */
            
            /* Surfaces */
            --c-page-bg: oklch(0.985 0.005 190);
            --c-frame-bg: oklch(0.985 0.005 190); /* Shared surface context */
            --c-paper-bg: oklch(1.0 0 0); /* White */
            --c-wash-bg: oklch(0.97 0.008 190); /* Very subtle wash for expanded solutions */

            /* Text */
            --c-text-primary: oklch(0.20 0.01 190);
            --c-text-secondary: oklch(0.45 0.01 190);
            --c-text-tertiary: oklch(0.60 0.01 190); /* Nav idle */

            /* Accents (Links, Focus, Toggles, Current Nav) */
            /* C must be [0.08 - 0.14]. Using L=0.45 for sufficient text contrast. */
            --c-accent: oklch(0.45 0.11 190); 
            --c-focus-ring: oklch(0.70 0.11 190);

            /* Borders */
            --c-border-hairline: oklch(0.92 0.005 190);
        }

        body {
            background-color: var(--c-page-bg);
            color: var(--c-text-primary);
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        /* 
           KaTeX Containment Invariant 
           Prevent page-level scroll, allow local scroll for math blocks.
        */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding-block: 0.5rem;
            /* Scrollbar styling for math */
            scrollbar-width: thin;
            scrollbar-color: var(--c-text-tertiary) transparent;
        }
        .katex-display::-webkit-scrollbar {
            height: 4px;
        }
        .katex-display::-webkit-scrollbar-thumb {
            background-color: var(--c-text-tertiary);
            border-radius: 4px;
        }

        /* Hide Scrollbar for Nav but keep functionality */
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* Markdown Content Styling */
        .md-content p {
            margin-bottom: 0.75em;
            line-height: 1.6;
        }
        .md-content p:last-child {
            margin-bottom: 0;
        }
        .md-content ul {
            list-style-type: disc;
            padding-left: 1.25em;
            margin-bottom: 0.75em;
        }
        .md-content ol {
            list-style-type: decimal;
            padding-left: 1.25em;
            margin-bottom: 0.75em;
        }
        /* Tables: Minimal, structural */
        .md-content table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1em;
            font-size: 0.95em;
        }
        .md-content th, .md-content td {
            border: 1px solid var(--c-border-hairline);
            padding: 0.5em 0.75em;
            text-align: left;
        }
        .md-content th {
            font-weight: 600;
        }
        /* Table overflow container */
        .table-wrapper {
            overflow-x: auto;
            margin-bottom: 1em;
        }
        
        /* Focus Styles */
        :focus-visible {
            outline: 2px solid var(--c-focus-ring);
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* Utility */
        .text-accent { color: var(--c-accent); }
        .border-hairline { border-color: var(--c-border-hairline); }
        .bg-paper { background-color: var(--c-paper-bg); }
        .bg-wash { background-color: var(--c-wash-bg); }
        
        /* Navigation Active State - Weight only per Stage 6 */
        .nav-item-active {
            font-weight: 700;
            color: var(--c-accent); /* Permitted for nav marker only */
        }
        
        /* Drawer animation */
        .drawer-enter { transform: translateX(-100%); }
        .drawer-enter-active { transform: translateX(0); transition: transform 0.3s ease-out; }
        .drawer-exit { transform: translateX(0); }
        .drawer-exit-active { transform: translateX(-100%); transition: transform 0.2s ease-in; }

        /* Print styles */
        @media print {
            .no-print { display: none !important; }
            body { background: white; color: black; }
            .katex-display { overflow: visible; }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center">

    <!-- 
      APP SHELL
      Contains Top Controls, DocumentFrame, Nav, and Paper Content.
    -->
    <div id="app-root" class="w-full max-w-[1200px] flex flex-col relative px-4 md:px-6 lg:px-8">
        
        <!-- TOP CONTROLS REGION -->
        <header class="w-full py-4 flex items-center justify-between border-b border-transparent md:h-16 shrink-0 z-20">
            <!-- Mobile Jump To Trigger -->
            <button id="mobile-jump-trigger" class="md:hidden flex items-center gap-2 text-sm font-medium text-accent p-2 -ml-2 rounded hover:bg-black/5" aria-label="Open navigation">
                <i class="ri-menu-line"></i>
                <span>Jump to</span>
            </button>

            <!-- Paper Selector -->
            <div class="flex items-center gap-3">
                <label for="paper-select" class="text-sm font-medium text-[var(--c-text-secondary)] hidden sm:block">Paper:</label>
                <select id="paper-select" class="bg-transparent border border-[var(--c-border-hairline)] rounded px-3 py-1.5 text-sm font-medium text-[var(--c-text-primary)] focus:border-[var(--c-accent)] cursor-pointer">
                    <option value="" disabled selected>Loading papers...</option>
                </select>
            </div>
            
            <div class="w-8 md:hidden"></div> <!-- Spacer for balance -->
        </header>

        <!-- DOCUMENT FRAME SHELL -->
        <!-- Desktop: Two columns (Nav + Paper). Mobile: Single column. -->
        <div class="flex flex-row w-full flex-1 pt-6 pb-20 relative">
            
            <!-- DESKTOP NAV RAIL (Sticky) -->
            <nav id="desktop-nav" class="hidden md:block w-48 shrink-0 sticky top-6 h-[calc(100vh-3rem)] overflow-y-auto no-scrollbar pr-6 border-r border-transparent" aria-label="Question navigation">
                <!-- Injected via JS -->
            </nav>

            <!-- SEPARATOR (Implicit via spacing/layout) -->
            
            <!-- PAPER CONTENT COLUMN -->
            <main id="paper-column" class="flex-1 w-full min-w-0">
                <!-- Content injected via JS -->
                <div id="paper-content" class="w-full max-w-3xl">
                    <div class="py-12 text-center text-[var(--c-text-secondary)] animate-pulse">Initializing...</div>
                </div>
            </main>

        </div>
    </div>

    <!-- MOBILE NAVIGATION DRAWER -->
    <div id="mobile-drawer-backdrop" class="fixed inset-0 bg-black/20 z-40 hidden transition-opacity opacity-0" aria-hidden="true"></div>
    <div id="mobile-drawer" class="fixed inset-y-0 left-0 w-64 bg-[var(--c-page-bg)] z-50 transform -translate-x-full transition-transform duration-300 shadow-xl flex flex-col" aria-modal="true" role="dialog">
        <div class="flex items-center justify-between p-4 border-b border-[var(--c-border-hairline)]">
            <h2 class="text-sm font-bold text-[var(--c-text-primary)]">Jump to</h2>
            <button id="mobile-drawer-close" class="p-2 -mr-2 text-[var(--c-text-secondary)] hover:text-[var(--c-text-primary)]">
                <i class="ri-close-line text-lg"></i>
            </button>
        </div>
        <nav id="mobile-nav-list" class="flex-1 overflow-y-auto p-4">
            <!-- Injected via JS -->
        </nav>
    </div>

    <!-- RUNTIME LOGIC -->
    <script>
        // --- STAGE 0: CONSTANTS ---
        // Authoritative source for payload path. Literal string appears ONLY here.
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // --- STATE MANAGEMENT ---
        const state = {
            papers: [],
            currentPaper: null,
            expandedStates: {}, // Map<questionNodeId, boolean>
            currentNavId: null
        };

        // --- MARKDOWN CONFIGURATION (STAGE 6 REQUIRED) ---
        // Configure markdown-it with specific rules: no breaks, html enabled, disable escape.
        const md = window.markdownit ? window.markdownit({
            html: true,       // Enable inline SVG passthrough
            linkify: true,
            breaks: false     // MUST be false to prevent <br> in math blocks
        }) : null;

        if (md) {
            // Disable escape rule to preserve TeX backslashes
            md.inline.ruler.disable(['escape']);
        }

        // --- DOM ELEMENTS ---
        const els = {
            paperSelect: document.getElementById('paper-select'),
            paperContent: document.getElementById('paper-content'),
            desktopNav: document.getElementById('desktop-nav'),
            mobileNavList: document.getElementById('mobile-nav-list'),
            mobileJumpTrigger: document.getElementById('mobile-jump-trigger'),
            mobileDrawer: document.getElementById('mobile-drawer'),
            mobileDrawerBackdrop: document.getElementById('mobile-drawer-backdrop'),
            mobileDrawerClose: document.getElementById('mobile-drawer-close')
        };

        // --- INITIALIZATION ---
        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error('Fetch failed');
                const payload = await response.json();
                
                if (!payload.papers || !Array.isArray(payload.papers)) {
                    throw new Error('Invalid payload structure');
                }

                state.papers = payload.papers;
                populatePaperSelector();
                
                // Load first paper by default
                if (state.papers.length > 0) {
                    loadPaper(state.papers[0].key);
                } else {
                    renderError("NO PAPERS FOUND IN PAYLOAD");
                }

            } catch (error) {
                console.error(error);
                renderError("PAPERS PAYLOAD MISSING");
            }
        }

        function renderError(msg) {
            els.paperContent.innerHTML = `
                <div class="flex items-center justify-center min-h-[50vh]">
                    <p class="text-[var(--c-text-tertiary)] font-medium text-lg tracking-wide uppercase">${msg}</p>
                </div>
            `;
            els.paperSelect.innerHTML = '<option disabled>Error loading</option>';
        }

        function populatePaperSelector() {
            els.paperSelect.innerHTML = state.papers.map(p => 
                `<option value="${p.key}">${p.label}</option>`
            ).join('');

            els.paperSelect.addEventListener('change', (e) => {
                loadPaper(e.target.value);
            });
        }

        function loadPaper(key) {
            const paper = state.papers.find(p => p.key === key);
            if (!paper) return;

            state.currentPaper = paper;
            // Reset expanded states based on defaults
            state.expandedStates = {};
            // Default expandedAll is true unless explicitly false
            const defaultExpanded = paper.defaults?.expandedAll !== false;
            
            // Render Structure
            renderNav(paper);
            renderPaperContent(paper, defaultExpanded);

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'auto' });
        }

        // --- RENDERING: NAVIGATION ---
        function renderNav(paper) {
            let html = '';
            
            // Helper to render a generic list item
            const renderItem = (q, depth) => {
                // Hierarchy via type scale/weight only (Stage 3/5)
                // Depth 0: Base, Depth > 0: Smaller/Quieter
                const isSub = depth > 0;
                const fontSizeClass = isSub ? 'text-xs' : 'text-sm';
                const colorClass = isSub ? 'text-[var(--c-text-secondary)]' : 'text-[var(--c-text-primary)]';
                const paddingClass = 'py-1'; // Flat list, spacing rhythm

                return `
                    <div class="nav-item group flex items-center ${paddingClass} cursor-pointer select-none" 
                         data-target-id="${q.id}" 
                         role="button" 
                         tabindex="0"
                         onclick="scrollToQuestion('${q.id}')"
                         onkeydown="if(event.key==='Enter'||event.key===' ')scrollToQuestion('${q.id}')">
                        <span class="${fontSizeClass} ${colorClass} transition-colors group-hover:text-[var(--c-text-primary)]" id="nav-label-${q.id}">
                            ${q.id}
                        </span>
                    </div>
                `;
            };

            const traverseQuestions = (nodes, depth) => {
                let out = '';
                nodes.forEach(node => {
                    out += renderItem(node, depth);
                    if (node.children && node.children.length > 0) {
                        out += traverseQuestions(node.children, depth + 1);
                    }
                });
                return out;
            };

            if (paper.sections) {
                // Sectioned Paper
                paper.sections.forEach((section, idx) => {
                    // Render section label if present
                    if (section.label && section.label.trim().length > 0) {
                        // Section label is non-clickable signpost
                        const mt = idx > 0 ? 'mt-6' : '';
                        html += `<div class="${mt} mb-2 text-xs font-bold text-[var(--c-text-tertiary)] uppercase tracking-wider">${section.label}</div>`;
                    } else if (idx > 0) {
                        // Spacing only if label omitted
                        html += `<div class="mt-4"></div>`;
                    }
                    html += traverseQuestions(section.questions, 0);
                });
            } else if (paper.questions) {
                // Flat Paper
                html += traverseQuestions(paper.questions, 0);
            }

            els.desktopNav.innerHTML = html;
            els.mobileNavList.innerHTML = html; // Mirror content
        }

        // --- RENDERING: PAPER CONTENT ---
        function renderPaperContent(paper, defaultExpanded) {
            let html = '';

            const traverseRender = (nodes, depth) => {
                return nodes.map(node => renderQuestionNode(node, depth, defaultExpanded)).join('');
            };

            if (paper.sections) {
                paper.sections.forEach(section => {
                    html += `<section class="mb-12">`;
                    if (section.label && section.label.trim().length > 0) {
                        html += `
                            <div class="mb-8 border-b border-[var(--c-border-hairline)] pb-2">
                                <h2 class="text-xl font-bold text-[var(--c-text-primary)]">${section.label}</h2>
                            </div>
                        `;
                    }
                    html += traverseRender(section.questions, 0);
                    html += `</section>`;
                });
            } else if (paper.questions) {
                html += traverseRender(paper.questions, 0);
            }

            els.paperContent.innerHTML = html;
            
            // Post-render: KaTeX hydration
            renderMathInElement(els.paperContent);
            
            // Post-render: Add event listeners for toggles
            addToggleListeners();
        }

        function renderQuestionNode(node, depth, defaultExpanded) {
            // Stage 3 Canonical Layout Structure
            
            // Initialize expansion state if not present
            if (state.expandedStates[node.id] === undefined) {
                state.expandedStates[node.id] = defaultExpanded;
            }
            const isExpanded = state.expandedStates[node.id];
            
            // Determine parts existence
            const hasSolutionBlock = !!node.solutionBlock;
            const hasAnswer = hasSolutionBlock && !!node.solutionBlock.answer;
            const hasDetails = hasSolutionBlock && !!node.solutionBlock.solutionDetails;
            
            // Markdown Rendering
            const questionHtml = renderMarkdown(node.question);
            
            // Indentation / Nesting Visuals
            // Top-level questions get large vertical spacing. Children get indentation.
            const isTopLevel = depth === 0;
            const containerClass = isTopLevel ? 'mb-16' : 'mt-6 ml-0 sm:ml-6 md:ml-8'; // Indentation logic

            // Start Node Surface
            let html = `<div id="q-${node.id}" class="${containerClass} relative group" data-node-id="${node.id}">`;
            
            // --- 1. Question Body ---
            html += `
                <div class="flex gap-4">
                    <!-- Identifier -->
                    <div class="shrink-0 w-8 md:w-12 pt-0.5">
                        <span class="text-base font-bold text-[var(--c-text-secondary)] select-none">${node.id}</span>
                    </div>
                    <!-- Prompt -->
                    <div class="flex-1 min-w-0">
                        <div class="md-content text-lg text-[var(--c-text-primary)] leading-relaxed">
                            ${questionHtml}
                        </div>
                    </div>
                </div>
            `;

            // --- 2. Solution Block (Optional) ---
            if (hasSolutionBlock) {
                html += `<div class="mt-6 ml-8 md:ml-12 pl-4 border-l border-[var(--c-border-hairline)]">`;
                
                // Answer
                if (hasAnswer) {
                    const answerHtml = renderMarkdown(node.solutionBlock.answer);
                    html += `
                        <div class="mb-4">
                            <span class="text-xs font-bold text-[var(--c-text-tertiary)] uppercase tracking-wide block mb-1">Answer</span>
                            <div class="md-content text-base font-medium text-[var(--c-text-primary)]">
                                ${answerHtml}
                            </div>
                        </div>
                    `;
                }

                // Solution Details Control & Region
                if (hasDetails) {
                    const details = node.solutionBlock.solutionDetails;
                    const btnText = isExpanded ? "Hide working" : "Show working";
                    const btnIconClass = isExpanded ? "ri-arrow-up-s-line" : "ri-arrow-down-s-line";
                    const displayStyle = isExpanded ? "block" : "none";

                    // Toggle Control
                    html += `
                        <button class="js-toggle-working flex items-center gap-1.5 text-sm font-medium text-[var(--c-accent)] hover:text-[var(--c-text-primary)] transition-colors focus-visible:ring-offset-2 mb-3" 
                                data-target="${node.id}" 
                                aria-expanded="${isExpanded}">
                            <span>${btnText}</span>
                            <i class="${btnIconClass}"></i>
                        </button>
                    `;

                    // Details Region
                    html += `
                        <div id="details-${node.id}" class="bg-wash rounded-sm p-4 md:p-6 space-y-6" style="display: ${displayStyle};">
                            
                            ${/* Keep in Mind */ details.keepInMind ? `
                                <div>
                                    <div class="flex items-center gap-2 mb-2 text-[var(--c-text-secondary)]">
                                        <i class="ri-lightbulb-line text-sm"></i>
                                        <span class="text-xs font-bold uppercase tracking-wide">Keep in mind</span>
                                    </div>
                                    <div class="md-content text-sm text-[var(--c-text-primary)]">
                                        ${renderMarkdown(details.keepInMind)}
                                    </div>
                                </div>
                                <div class="border-t border-[var(--c-border-hairline)] opacity-50"></div>
                            ` : ''}

                            ${/* Formulas Used */ details.formulasUsed ? `
                                <div>
                                    <span class="text-xs font-bold text-[var(--c-text-secondary)] uppercase tracking-wide block mb-2">Formulas used</span>
                                    <div class="md-content text-sm text-[var(--c-text-primary)]">
                                        ${renderMarkdown(details.formulasUsed)}
                                    </div>
                                </div>
                                <div class="border-t border-[var(--c-border-hairline)] opacity-50"></div>
                            ` : ''}

                            ${/* Working (Primary) */ details.working ? `
                                <div>
                                    <span class="text-xs font-bold text-[var(--c-text-secondary)] uppercase tracking-wide block mb-2">Working</span>
                                    <div class="md-content text-base text-[var(--c-text-primary)]">
                                        ${renderMarkdown(details.working)}
                                    </div>
                                </div>
                            ` : ''}

                            ${/* Alternative Working */ details.alternativeWorking && details.alternativeWorking.length > 0 ? 
                                details.alternativeWorking.map(alt => `
                                    <div class="border-t border-[var(--c-border-hairline)] opacity-50"></div>
                                    <div>
                                        <span class="text-xs font-bold text-[var(--c-text-secondary)] uppercase tracking-wide block mb-2">Alternative working</span>
                                        <div class="md-content text-base text-[var(--c-text-primary)]">
                                            ${renderMarkdown(alt)}
                                        </div>
                                    </div>
                                `).join('') 
                            : ''}
                            
                        </div>
                    `;
                }
                html += `</div>`; // End Solution Block Wrapper
            }

            // --- 3. Children ---
            if (node.children && node.children.length > 0) {
                // Recursively render children
                node.children.forEach(child => {
                    html += renderQuestionNode(child, depth + 1, defaultExpanded);
                });
            }

            html += `</div>`; // End Question Node Surface
            return html;
        }

        // --- UTILS: MARKDOWN & MATH ---
        function renderMarkdown(text) {
            if (!text) return '';
            if (!md) return text; // Fallback to plain text if md failed
            return md.render(text);
        }

        function renderMathInElement(elem) {
            if (window.renderMathInElement) {
                window.renderMathInElement(elem, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false}
                    ],
                    throwOnError: false
                });
            }
        }

        // --- INTERACTION LOGIC ---
        
        function scrollToQuestion(id) {
            const el = document.getElementById(`q-${id}`);
            if (el) {
                // Offset for sticky header/nav
                const offset = 80; 
                const elementPosition = el.getBoundingClientRect().top;
                const offsetPosition = elementPosition + window.pageYOffset - offset;
                
                window.scrollTo({
                    top: offsetPosition,
                    behavior: "smooth"
                });
                
                // Update URL/History (Optional, good for UX)
                // history.replaceState(null, null, `#${id}`);
                
                // Close mobile drawer if open
                closeMobileDrawer();
            }
        }

        function addToggleListeners() {
            document.querySelectorAll('.js-toggle-working').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = btn.dataset.target;
                    const region = document.getElementById(`details-${id}`);
                    const isNowExpanded = region.style.display === 'none';
                    
                    // Update DOM
                    region.style.display = isNowExpanded ? 'block' : 'none';
                    btn.setAttribute('aria-expanded', isNowExpanded);
                    btn.querySelector('span').textContent = isNowExpanded ? "Hide working" : "Show working";
                    btn.querySelector('i').className = isNowExpanded ? "ri-arrow-up-s-line" : "ri-arrow-down-s-line";
                    
                    // Update State
                    state.expandedStates[id] = isNowExpanded;
                });
            });
        }

        // --- MOBILE DRAWER LOGIC ---
        function openMobileDrawer() {
            els.mobileDrawer.classList.remove('-translate-x-full');
            els.mobileDrawerBackdrop.classList.remove('hidden');
            // Small delay for opacity transition
            setTimeout(() => els.mobileDrawerBackdrop.classList.remove('opacity-0'), 10);
            document.body.style.overflow = 'hidden'; // Lock scroll
        }

        function closeMobileDrawer() {
            els.mobileDrawer.classList.add('-translate-x-full');
            els.mobileDrawerBackdrop.classList.add('opacity-0');
            setTimeout(() => {
                els.mobileDrawerBackdrop.classList.add('hidden');
                document.body.style.overflow = ''; // Unlock scroll
            }, 300);
        }

        els.mobileJumpTrigger.addEventListener('click', openMobileDrawer);
        els.mobileDrawerClose.addEventListener('click', closeMobileDrawer);
        els.mobileDrawerBackdrop.addEventListener('click', closeMobileDrawer);

        // --- SCROLL SPY (For Nav Active State) ---
        // Simple IntersectionObserver strategy or Scroll Listener
        // Given complexity of variable heights, scroll listener is robust for prototype.
        
        let isScrollingTimeout;
        window.addEventListener('scroll', () => {
            if (isScrollingTimeout) clearTimeout(isScrollingTimeout);
            isScrollingTimeout = setTimeout(() => {
                updateActiveNav();
            }, 50);
        });

        function updateActiveNav() {
            if (!state.currentPaper) return;
            
            // Find visible question
            // Strategy: Find the question closest to the top of the viewport (with offset)
            const questions = Array.from(document.querySelectorAll('[id^="q-"]'));
            const offset = 100;
            
            let current = null;
            for (const q of questions) {
                const rect = q.getBoundingClientRect();
                if (rect.top <= offset) {
                    current = q;
                } else {
                    break; 
                }
            }
            
            // If we are at the very top, pick first
            if (window.scrollY < 50 && questions.length > 0) current = questions[0];

            if (current) {
                const id = current.dataset.nodeId;
                if (state.currentNavId !== id) {
                    // Update UI
                    if (state.currentNavId) {
                        const oldLabel = document.getElementById(`nav-label-${state.currentNavId}`);
                        if (oldLabel) oldLabel.parentElement.classList.remove('nav-item-active');
                        if (oldLabel) oldLabel.classList.remove('nav-item-active');
                    }
                    const newLabel = document.getElementById(`nav-label-${id}`);
                    if (newLabel) {
                        newLabel.classList.add('nav-item-active');
                        // Ensure nav rail scrolls to keep active item in view
                        // Only on desktop
                        if (window.innerWidth >= 768) {
                            newLabel.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                        }
                    }
                    state.currentNavId = id;
                }
            }
        }

        // --- BOOTSTRAP ---
        init();

    </script>
</body>
</html>
