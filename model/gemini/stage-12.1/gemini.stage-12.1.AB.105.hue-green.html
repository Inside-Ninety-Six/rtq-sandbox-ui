<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AB","indexWithinVariant":"105","totalWithinVariant":"200","hueFamily":"green","intensityMode":"","timestamp":"2026-01-07T05:08:44.221Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AB&quot;,&quot;indexWithinVariant&quot;:&quot;105&quot;,&quot;totalWithinVariant&quot;:&quot;200&quot;,&quot;hueFamily&quot;:&quot;green&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-07T05:08:44.221Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>

    <!-- FONTS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- KATEX CSS (No integrity, CDN) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <!-- LIBRARIES (Scripts loaded via CDN, No integrity) -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <style>
        /* =========================================
           CSS VARIABLES - COLORLAB B (GREEN THEME)
           LIGHT MODE ONLY
           ========================================= */
        :root {
            /* HUE: GREEN (approx 145deg) */
            --hue: 145;
            
            /* NEUTRALS (Warm/Paper-like base) */
            --c-bg-app: hsl(40, 10%, 98%);     /* Page background */
            --c-bg-paper: hsl(0, 0%, 100%);    /* Main content surface */
            --c-text-primary: hsl(var(--hue), 10%, 10%);
            --c-text-secondary: hsl(var(--hue), 5%, 40%);
            --c-text-tertiary: hsl(var(--hue), 5%, 60%);
            
            /* ACCENT (Restrained, for focus/links/toggles) */
            --c-accent: hsl(var(--hue), 70%, 35%);
            --c-accent-hover: hsl(var(--hue), 70%, 25%);
            --c-accent-subtle: hsl(var(--hue), 30%, 90%); /* Focus rings etc */

            /* SURFACES & SEPARATORS */
            --c-divider: hsl(var(--hue), 10%, 90%);
            --c-surface-wash: hsl(var(--hue), 15%, 97%); /* Very subtle wash for regions if needed */

            /* SPACING SYSTEM */
            --sp-xs: 4px;
            --sp-s: 8px;
            --sp-m: 16px;
            --sp-l: 24px;
            --sp-xl: 48px;
            --sp-xxl: 80px;

            /* TYPOGRAPHY */
            --font-family: 'Inter', system-ui, sans-serif;
            --font-size-base: 16px;
            --font-size-sm: 14px;
            --font-size-xs: 13px;
            
            /* LAYOUT */
            --w-nav-rail: 260px;
            --w-frame-max: 1200px;
            --h-top-controls: 60px;
        }

        /* =========================================
           RESET & BASE
           ========================================= */
        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: var(--font-family);
            background-color: var(--c-bg-app);
            color: var(--c-text-primary);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            overflow-y: scroll; /* Always show vertical scrollbar */
        }

        button {
            font-family: inherit;
            cursor: pointer;
            border: none;
            background: none;
            padding: 0;
            margin: 0;
            color: inherit;
        }

        /* Focus management (Stage 5.5.2) */
        *:focus-visible {
            outline: 2px solid var(--c-accent);
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* =========================================
           LAYOUT ARCHITECTURE (Stage 3 Tree)
           ========================================= */
        .app-shell {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Top Controls */
        .top-controls-region {
            height: var(--h-top-controls);
            background-color: var(--c-bg-app); /* Matches shell base */
            border-bottom: 1px solid var(--c-divider); /* Optional Hairline */
            position: sticky;
            top: 0;
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 var(--sp-m);
        }

        .top-controls-content {
            width: 100%;
            max-width: var(--w-frame-max);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        /* Document Frame Shell */
        .document-frame-shell {
            flex: 1;
            width: 100%;
            max-width: var(--w-frame-max);
            margin: 0 auto;
            display: flex; /* Sibling columns on desktop */
            position: relative;
        }

        /* Navigation Rail (Desktop) */
        .nav-rail {
            width: var(--w-nav-rail);
            flex-shrink: 0;
            display: none; /* Hidden on mobile */
            padding-top: var(--sp-l);
            padding-bottom: var(--sp-l);
            padding-right: var(--sp-m);
            /* Sticky Logic (Stage 6.0.9) */
            position: sticky;
            top: var(--h-top-controls);
            height: calc(100vh - var(--h-top-controls));
            overflow-y: auto;
            /* Scrollbar hiding */
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .nav-rail::-webkit-scrollbar {
            display: none;
        }

        @media (min-width: 768px) {
            .nav-rail {
                display: block;
            }
        }

        /* Paper Document Column */
        .paper-column {
            flex: 1;
            min-width: 0; /* Prevent flex blowout */
            padding: var(--sp-l) var(--sp-m) var(--sp-xxl) var(--sp-m);
        }

        /* =========================================
           COMPONENTS: NAVIGATION
           ========================================= */
        .nav-list {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .nav-section-label {
            font-size: var(--font-size-xs);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--c-text-tertiary);
            font-weight: 600;
            margin-top: var(--sp-m);
            margin-bottom: var(--sp-xs);
            padding-left: var(--sp-s); /* Alignment */
            pointer-events: none;
        }
        
        /* First section label shouldn't have top margin */
        .nav-section-group:first-child .nav-section-label {
            margin-top: 0;
        }

        .nav-item {
            display: block;
            padding: var(--sp-xs) var(--sp-s);
            font-size: var(--font-size-sm);
            color: var(--c-text-secondary);
            text-decoration: none;
            border-radius: 4px;
            transition: color 0.1s ease, background-color 0.1s ease;
        }

        .nav-item:hover {
            color: var(--c-text-primary);
            background-color: rgba(0,0,0,0.03); /* Subtle hover */
        }

        /* Current Item (Stage 6.0.2 - Weight only, Accent marker allowed) */
        .nav-item.active {
            font-weight: 600;
            color: var(--c-text-primary);
            box-shadow: inset 3px 0 0 var(--c-accent); /* Left marker */
            background-color: transparent; /* No fill per instructions */
        }

        /* Hierarchy via type scale (Stage 5.4.5) */
        .nav-item[data-depth="0"] { font-size: 15px; }
        .nav-item[data-depth="1"] { font-size: 14px; }
        .nav-item[data-depth="2"] { font-size: 13px; }

        /* =========================================
           COMPONENTS: CONTROLS
           ========================================= */
        /* Paper Selector */
        .paper-selector {
            font-size: var(--font-size-sm);
            padding: var(--sp-s);
            border: 1px solid var(--c-divider);
            border-radius: 4px;
            background: var(--c-bg-paper);
            color: var(--c-text-primary);
            min-width: 200px;
        }

        /* Mobile Jump To Trigger */
        .mobile-jump-trigger {
            display: flex;
            align-items: center;
            gap: var(--sp-s);
            font-size: var(--font-size-sm);
            font-weight: 500;
            color: var(--c-text-secondary);
        }
        @media (min-width: 768px) {
            .mobile-jump-trigger {
                display: none;
            }
        }

        /* Mobile Drawer */
        .drawer-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.2);
            z-index: 100;
            display: none;
        }
        .drawer-overlay.open {
            display: block;
        }

        .drawer-content {
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            width: 80%;
            max-width: 300px;
            background: var(--c-bg-app);
            box-shadow: 2px 0 12px rgba(0,0,0,0.1);
            padding: var(--sp-m);
            overflow-y: auto;
            transform: translateX(-100%);
            transition: transform 0.2s ease-out;
        }
        .drawer-overlay.open .drawer-content {
            transform: translateX(0);
        }

        .drawer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--sp-m);
            border-bottom: 1px solid var(--c-divider);
            padding-bottom: var(--sp-s);
        }

        /* =========================================
           COMPONENTS: PAPER CONTENT
           ========================================= */
        
        .paper-surface {
            /* Pure whitespace driven */
        }

        .section-header-block {
            margin-bottom: var(--sp-l);
            padding-bottom: var(--sp-s);
            border-bottom: 1px solid var(--c-divider);
        }
        .section-header-text {
            font-size: 18px;
            font-weight: 600;
            color: var(--c-text-secondary);
        }

        /* Top Level Question Boundary */
        .question-node-wrapper {
            margin-bottom: var(--sp-xl); /* Strongest separation */
        }
        
        .question-node-wrapper + .question-node-wrapper {
            /* Could use a hairline here if needed, but whitespace preferred */
        }

        /* Indentation for children */
        .children-container {
            margin-top: var(--sp-m);
            margin-left: var(--sp-l); /* Indentation */
            border-left: 1px solid transparent; /* Placeholder for alignment */
        }
        
        /* Mobile indentation adaptation */
        @media (max-width: 480px) {
            .children-container {
                margin-left: var(--sp-m);
            }
        }

        /* Question Body */
        .question-body {
            display: flex;
            gap: var(--sp-s);
            align-items: baseline;
            margin-bottom: var(--sp-m);
        }

        .question-id {
            font-weight: 600;
            color: var(--c-text-secondary);
            flex-shrink: 0;
        }

        .question-prompt {
            color: var(--c-text-primary);
            font-weight: 500; /* Primary anchor */
            flex: 1;
        }
        
        /* Markdown content styling within prompt/answer */
        .md-content p { margin-top: 0; margin-bottom: 0.75em; }
        .md-content p:last-child { margin-bottom: 0; }
        .md-content img, .md-content svg { max-width: 100%; height: auto; }
        
        /* Table styling (Stage 5.8.5) */
        .md-content table {
            border-collapse: collapse;
            width: 100%;
            margin: var(--sp-s) 0;
            font-size: var(--font-size-sm);
        }
        .md-content th, .md-content td {
            border: 1px solid var(--c-divider);
            padding: var(--sp-xs) var(--sp-s);
            text-align: left;
        }
        .md-content th {
            font-weight: 600;
            background: var(--c-surface-wash);
        }

        /* Solution Block (Wrapper) */
        .solution-block {
            padding-left: 0; /* Aligned with question content usually, or can be full width */
            /* Using margin-left to align with prompt if desired, but Stage 3 tree doesn't force it.
               Keeping it simple: flows vertically. */
        }

        /* Answer */
        .answer-region {
            margin-bottom: var(--sp-m);
            font-size: var(--font-size-base);
            color: var(--c-text-primary);
        }
        .answer-label {
            font-weight: 600;
            color: var(--c-text-secondary);
            font-size: var(--font-size-sm);
            margin-right: var(--sp-s);
        }

        /* Show/Hide Toggle */
        .disclosure-control {
            display: inline-flex;
            align-items: center;
            gap: var(--sp-xs);
            font-size: var(--font-size-sm);
            color: var(--c-accent); /* Interactive */
            font-weight: 500;
            margin-bottom: var(--sp-s);
        }
        .disclosure-control:hover {
            color: var(--c-accent-hover);
            text-decoration: underline;
        }

        /* Solution Details Region */
        .solution-details-region {
            display: none;
            margin-top: var(--sp-s);
            padding-left: var(--sp-m);
            border-left: 2px solid var(--c-divider); /* Subtle boundary cue */
        }
        .solution-details-region.expanded {
            display: block;
            animation: fadeIn 0.2s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-4px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Subsections (Keep in mind, Formulas, Working) */
        .sd-subsection {
            margin-bottom: var(--sp-m);
        }
        .sd-subsection:last-child {
            margin-bottom: 0;
        }

        .sd-label {
            font-size: var(--font-size-xs);
            font-weight: 600;
            text-transform: uppercase;
            color: var(--c-text-tertiary);
            margin-bottom: var(--sp-xs);
            display: block;
        }

        .sd-content {
            font-size: var(--font-size-sm);
            color: var(--c-text-secondary); /* Subordinate but readable */
        }
        
        /* KaTeX Overflow Handling (Stage 6.0.8) */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding: 0.5em 0;
            /* Scrollbar hiding optional but cleaner */
            scrollbar-width: thin;
        }

        /* Alternative Working Separation */
        .alt-working-divider {
            margin: var(--sp-m) 0;
            border-top: 1px dashed var(--c-divider);
        }

        /* Utility */
        .hidden { display: none !important; }
        .error-message {
            padding: var(--sp-xl);
            text-align: center;
            color: var(--c-text-secondary);
            font-weight: 600;
        }

    </style>
</head>
<body>

    <!-- STAGE 3 LAYOUT TREE IMPLEMENTATION -->
    
    <div class="app-shell">
        
        <!-- TOP CONTROLS REGION -->
        <header class="top-controls-region">
            <div class="top-controls-content">
                <!-- Mobile Jump Trigger -->
                <button class="mobile-jump-trigger" id="mobileJumpTrigger" aria-label="Open navigation">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    <span>Jump to</span>
                </button>

                <!-- Paper Selector -->
                <select id="paperSelector" class="paper-selector" aria-label="Select Paper">
                    <option value="" disabled selected>Loading papers...</option>
                </select>

                <!-- Spacer for balance -->
                <div style="width: 24px;" class="desktop-hidden"></div>
            </div>
        </header>

        <!-- DOCUMENT FRAME SHELL -->
        <div class="document-frame-shell">
            
            <!-- LEFT COLUMN: NAVIGATION RAIL (Desktop) -->
            <nav class="nav-rail" id="desktopNav" aria-label="Paper Navigation">
                <!-- Injected via JS -->
            </nav>

            <!-- RIGHT COLUMN: PAPER CONTENT -->
            <main class="paper-column" id="paperContent">
                <!-- Injected via JS -->
                <div style="text-align:center; padding: 40px; color: var(--c-text-tertiary);">Loading...</div>
            </main>

        </div>
    </div>

    <!-- MOBILE DRAWER -->
    <div class="drawer-overlay" id="mobileDrawer">
        <div class="drawer-content">
            <div class="drawer-header">
                <span style="font-weight:600;">Jump to</span>
                <button id="mobileDrawerClose" aria-label="Close navigation">
                    <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <nav id="mobileNavList" class="nav-list">
                <!-- Cloned from Desktop Nav -->
            </nav>
        </div>
    </div>

    <script>
        // =========================================
        // STAGE 0: CONSTANTS (Canonical)
        // =========================================
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // =========================================
        // ADD-ON PARAMETERS
        // =========================================
        // Script substitution would happen here. Defaults provided.
        const RTQ_COLORLAB_FORCE_HUE_FAMILY = "green";

        // =========================================
        // STATE & UTILS
        // =========================================
        let appState = {
            papers: [],
            currentPaperKey: null,
            payload: null,
            expandedNodes: new Set() // Tracks IDs of questions with expanded workings
        };

        // DOM Elements
        const elSelector = document.getElementById('paperSelector');
        const elContent = document.getElementById('paperContent');
        const elDesktopNav = document.getElementById('desktopNav');
        const elMobileNav = document.getElementById('mobileNavList');
        const elDrawer = document.getElementById('mobileDrawer');
        const elDrawerTrigger = document.getElementById('mobileJumpTrigger');
        const elDrawerClose = document.getElementById('mobileDrawerClose');

        // Markdown-it Setup (Stage 6 Add-on)
        const md = window.markdownit ? window.markdownit({
            html: true,
            linkify: true,
            breaks: false // Critical requirement
        }) : null;
        
        if (md) {
            md.inline.ruler.disable(['escape']); // Preserve TeX backslashes
        }

        // =========================================
        // CORE LOGIC
        // =========================================

        async function init() {
            try {
                // Fetch Payload
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Payload not found");
                const data = await response.json();
                
                appState.payload = data;
                appState.papers = data.papers || [];

                if (appState.papers.length === 0) throw new Error("No papers in payload");

                renderSelector();
                
                // Select first paper by default
                loadPaper(appState.papers[0].key);

            } catch (err) {
                console.error(err);
                elContent.innerHTML = `<div class="error-message">PAPERS PAYLOAD MISSING</div>`;
                elSelector.innerHTML = `<option>Error loading papers</option>`;
                elSelector.disabled = true;
            }
        }

        function renderSelector() {
            elSelector.innerHTML = appState.papers.map(p => 
                `<option value="${p.key}">${p.label || p.key}</option>`
            ).join('');
            
            elSelector.addEventListener('change', (e) => {
                loadPaper(e.target.value);
            });
        }

        function loadPaper(paperKey) {
            const paper = appState.papers.find(p => p.key === paperKey);
            if (!paper) return;

            appState.currentPaperKey = paperKey;
            
            // Handle Defaults (expandedAll)
            appState.expandedNodes.clear();
            const defaultExpanded = paper.defaults?.expandedAll !== false;

            // Recursively collect IDs if default is expanded
            // We only track expanded state for interactive control. 
            // If default is true, we simply don't add to "collapsed" set, or we assume expanded unless tracked.
            // Let's invert: Set tracks non-default states? No, simpler to track expanded explicitly.
            
            // Helper to pre-expand if needed
            const traverseAndExpand = (nodes) => {
                nodes.forEach(node => {
                    if (defaultExpanded && node.solutionBlock?.solutionDetails) {
                        appState.expandedNodes.add(node.id);
                    }
                    if (node.children) traverseAndExpand(node.children);
                });
            };

            const questions = paper.questions || [];
            const sections = paper.sections || [];
            
            if (questions.length) traverseAndExpand(questions);
            if (sections.length) sections.forEach(s => traverseAndExpand(s.questions));

            // Render
            renderNav(paper);
            renderContent(paper);
            
            // Scroll to top
            window.scrollTo(0, 0);
            elDesktopNav.scrollTop = 0;
        }

        // =========================================
        // RENDERING: NAVIGATION
        // =========================================

        function renderNav(paper) {
            let html = '<div class="nav-list">';
            
            const renderItem = (node, depth) => {
                const isActive = false; // logic for active scroll spy could go here
                return `<a href="#q-${node.id}" class="nav-item" data-id="${node.id}" data-depth="${depth}">
                    ${node.id}
                </a>`;
            };

            const processNodes = (nodes, depth = 0) => {
                let str = '';
                nodes.forEach(node => {
                    str += renderItem(node, depth);
                    if (node.children) str += processNodes(node.children, depth + 1);
                });
                return str;
            };

            if (paper.sections) {
                paper.sections.forEach(section => {
                    html += `<div class="nav-section-group">`;
                    if (section.label && section.label.trim().length > 0) {
                        html += `<div class="nav-section-label">${section.label}</div>`;
                    }
                    html += processNodes(section.questions);
                    html += `</div>`;
                });
            } else {
                html += processNodes(paper.questions);
            }

            html += '</div>';

            elDesktopNav.innerHTML = html;
            elMobileNav.innerHTML = html; // Mirror to mobile drawer

            // Attach Nav Click Listeners for Smooth Scroll
            const handleNavClick = (e) => {
                if (e.target.classList.contains('nav-item')) {
                    e.preventDefault();
                    const targetId = e.target.getAttribute('href').substring(1);
                    const el = document.getElementById(targetId);
                    if (el) {
                        // Close drawer if open
                        elDrawer.classList.remove('open');
                        
                        // Scroll with offset for sticky header
                        const top = el.getBoundingClientRect().top + window.pageYOffset - 80;
                        window.scrollTo({ top, behavior: 'smooth' });
                        
                        // Set Active State manually (simple version)
                        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                        document.querySelectorAll(`.nav-item[data-id="${e.target.dataset.id}"]`).forEach(n => n.classList.add('active'));
                    }
                }
            };

            elDesktopNav.onclick = handleNavClick;
            elMobileNav.onclick = handleNavClick;
        }

        // =========================================
        // RENDERING: CONTENT
        // =========================================

        function renderContent(paper) {
            let html = '<div class="paper-surface">';

            // Helper to render a question node recursively
            const renderNode = (node, depth = 0) => {
                const hasSolutionBlock = !!node.solutionBlock;
                const hasAnswer = hasSolutionBlock && !!node.solutionBlock.answer;
                const hasDetails = hasSolutionBlock && !!node.solutionBlock.solutionDetails;
                const isExpanded = appState.expandedNodes.has(node.id);

                let nodeHtml = `<div class="question-node-wrapper" id="q-${node.id}">`;
                
                // 1. Question Body
                nodeHtml += `
                    <div class="question-body">
                        <div class="question-id">${node.id}</div>
                        <div class="question-prompt md-content">${md ? md.render(node.question || '') : (node.question || '')}</div>
                    </div>
                `;

                // 2. Solution Block (Optional)
                if (hasSolutionBlock) {
                    nodeHtml += `<div class="solution-block">`;
                    
                    // Answer
                    if (hasAnswer) {
                        nodeHtml += `
                            <div class="answer-region">
                                <span class="answer-label">Answer</span>
                                <span class="md-content" style="display:inline;">${md ? md.renderInline(node.solutionBlock.answer) : node.solutionBlock.answer}</span>
                            </div>
                        `;
                    }

                    // Solution Details
                    if (hasDetails) {
                        const details = node.solutionBlock.solutionDetails;
                        const label = isExpanded ? "Hide working" : "Show working";
                        const icon = isExpanded 
                            ? `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M18 15l-6-6-6 6"/></svg>`
                            : `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M6 9l6 6 6-6"/></svg>`;

                        nodeHtml += `
                            <button class="disclosure-control" onclick="toggleWorking('${node.id}')">
                                <span>${label}</span>
                                ${icon}
                            </button>
                            
                            <div class="solution-details-region ${isExpanded ? 'expanded' : ''}">
                        `;

                        if (isExpanded) {
                            // Keep in mind
                            if (details.keepInMind) {
                                nodeHtml += `
                                    <div class="sd-subsection">
                                        <span class="sd-label">Keep in mind</span>
                                        <div class="sd-content md-content">${md.render(details.keepInMind)}</div>
                                    </div>
                                `;
                            }
                            
                            // Formulas Used
                            if (details.formulasUsed) {
                                nodeHtml += `
                                    <div class="sd-subsection">
                                        <span class="sd-label">Formulas used</span>
                                        <div class="sd-content md-content">${md.render(details.formulasUsed)}</div>
                                    </div>
                                `;
                            }

                            // Working
                            if (details.working) {
                                nodeHtml += `
                                    <div class="sd-subsection">
                                        <span class="sd-label">Working</span>
                                        <div class="sd-content md-content">${md.render(details.working)}</div>
                                    </div>
                                `;
                            }

                            // Alternative Working (Array)
                            if (details.alternativeWorking && Array.isArray(details.alternativeWorking)) {
                                details.alternativeWorking.forEach(alt => {
                                    nodeHtml += `
                                        <div class="alt-working-divider"></div>
                                        <div class="sd-subsection">
                                            <span class="sd-label">Alternative working</span>
                                            <div class="sd-content md-content">${md.render(alt)}</div>
                                        </div>
                                    `;
                                });
                            }
                        }

                        nodeHtml += `</div>`; // End details region
                    }
                    
                    nodeHtml += `</div>`; // End solution block
                }

                // 3. Children
                if (node.children && node.children.length > 0) {
                    nodeHtml += `<div class="children-container">`;
                    node.children.forEach(child => {
                        nodeHtml += renderNode(child, depth + 1);
                    });
                    nodeHtml += `</div>`;
                }

                nodeHtml += `</div>`; // End wrapper
                return nodeHtml;
            };

            // Main loop
            if (paper.sections) {
                paper.sections.forEach(section => {
                    html += `<div class="section-header-block">`;
                    if (section.label && section.label.trim().length > 0) {
                        html += `<div class="section-header-text">${section.label}</div>`;
                    }
                    html += `</div>`;
                    section.questions.forEach(q => html += renderNode(q));
                });
            } else if (paper.questions) {
                paper.questions.forEach(q => html += renderNode(q));
            }

            html += '</div>';
            elContent.innerHTML = html;

            // Trigger KaTeX Auto Render
            if (window.renderMathInElement) {
                renderMathInElement(elContent, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false}
                    ],
                    throwOnError: false
                });
            }
        }

        // =========================================
        // INTERACTIONS
        // =========================================

        window.toggleWorking = (nodeId) => {
            if (appState.expandedNodes.has(nodeId)) {
                appState.expandedNodes.delete(nodeId);
            } else {
                appState.expandedNodes.add(nodeId);
            }
            // Re-render content to reflect state (could be optimized, but fine for prototype)
            // Re-fetching paper object from state
            const paper = appState.papers.find(p => p.key === appState.currentPaperKey);
            
            // We need to preserve scroll position relative to the element
            // Simple approach: re-render, then find element
            const yPos = window.scrollY;
            renderContent(paper);
            window.scrollTo(0, yPos);
        };

        // Mobile Drawer
        elDrawerTrigger.addEventListener('click', () => {
            elDrawer.classList.add('open');
        });
        elDrawerClose.addEventListener('click', () => {
            elDrawer.classList.remove('open');
        });
        elDrawer.addEventListener('click', (e) => {
            if (e.target === elDrawer) elDrawer.classList.remove('open');
        });

        // =========================================
        // INIT
        // =========================================
        init();

    </script>
</body>
</html>
