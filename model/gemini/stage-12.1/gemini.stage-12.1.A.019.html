<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"A","indexWithinVariant":"19","totalWithinVariant":"50","hueFamily":"","intensityMode":"","timestamp":"2026-01-06T18:13:15.686Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;A&quot;,&quot;indexWithinVariant&quot;:&quot;19&quot;,&quot;totalWithinVariant&quot;:&quot;50&quot;,&quot;hueFamily&quot;:&quot;&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-06T18:13:15.686Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>

    <!-- KaTeX CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <!-- CSS -->
    <style>
        :root {
            /* COLORLAB A: Calm Teal/Slate Palette (Light Mode Only) */
            --c-bg-app: #f8fafc;        /* Slate 50 - Soft neutral background */
            --c-surface-base: #ffffff;  /* White */
            
            --c-text-primary: #1e293b;  /* Slate 800 - High contrast text */
            --c-text-secondary: #475569;/* Slate 600 - Supporting text */
            --c-text-tertiary: #94a3b8; /* Slate 400 - Quiet text */

            --c-accent: #0f766e;        /* Teal 700 - Restrained accent (links, focus, active nav) */
            --c-accent-subtle: #ccfbf1; /* Teal 100 - Focus rings / subtle highlight */

            --c-hairline: #e2e8f0;      /* Slate 200 - Quiet dividers */
            --c-wash-solution: #f1f5f9; /* Slate 100 - Very subtle wash for expanded solutions */

            /* SPACING SYSTEM (Base unit 4px) */
            --sp-1: 0.25rem;
            --sp-2: 0.5rem;
            --sp-3: 0.75rem;
            --sp-4: 1rem;
            --sp-6: 1.5rem;
            --sp-8: 2rem;
            --sp-12: 3rem;
            --sp-16: 4rem;

            /* TYPOGRAPHY */
            --font-stack: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --font-weight-regular: 400;
            --font-weight-medium: 500;
            --font-weight-bold: 600;

            /* LAYOUT */
            --w-frame-max: 1024px;
            --w-nav-col: 180px;
            --h-header: 60px;
        }

        /* RESET & BASE */
        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: var(--font-stack);
            background-color: var(--c-bg-app);
            color: var(--c-text-primary);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        button {
            font-family: inherit;
            border: none;
            background: none;
            cursor: pointer;
            padding: 0;
            color: inherit;
        }

        /* UTILITIES */
        .hidden { display: none !important; }
        .sr-only {
            position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px;
            overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0;
        }

        /* KATEX CONTAINMENT INVARIANT (Stage 6.0.8) */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding-block: var(--sp-2);
            -webkit-overflow-scrolling: touch;
            /* Scrollbar hiding for neatness where supported */
            scrollbar-width: none; 
        }
        .katex-display::-webkit-scrollbar {
            display: none;
        }
        /* Block math underlay rule: Only display math gets subtle box treatment if desired, 
           but strict rule is NO background on inline math. 
           We will leave display math transparent per strict "paper" feel, 
           unless overflow mandates a cue, but standard is clean. */

        /* LAYOUT SHELL */
        .app-shell {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* TOP CONTROLS */
        .top-controls {
            position: sticky;
            top: 0;
            z-index: 50;
            height: var(--h-header);
            background-color: var(--c-bg-app); /* Matches shell base */
            border-bottom: 1px solid var(--c-hairline);
            display: flex;
            align-items: center;
            justify-content: center;
            padding-inline: var(--sp-4);
        }

        .top-controls-inner {
            width: 100%;
            max-width: var(--w-frame-max);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .paper-selector {
            font-size: 0.9rem;
            padding: var(--sp-2);
            border: 1px solid var(--c-hairline);
            border-radius: 4px;
            background-color: var(--c-surface-base);
            color: var(--c-text-primary);
        }

        .mobile-jump-trigger {
            font-size: 0.9rem;
            font-weight: var(--font-weight-medium);
            color: var(--c-accent);
            display: none; /* Desktop default */
        }

        /* DOCUMENT FRAME SHELL */
        .doc-frame {
            flex: 1;
            width: 100%;
            max-width: var(--w-frame-max);
            margin: 0 auto;
            display: grid;
            grid-template-columns: var(--w-nav-col) 1fr;
            gap: var(--sp-8);
            padding-top: var(--sp-8);
            padding-bottom: var(--sp-16);
            padding-inline: var(--sp-4);
        }

        /* NAV COLUMN (Desktop) */
        .nav-col {
            position: sticky;
            top: calc(var(--h-header) + var(--sp-8));
            height: calc(100vh - var(--h-header) - var(--sp-16));
            overflow-y: auto;
            /* Scrollbar hiding */
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .nav-col::-webkit-scrollbar { display: none; }

        .nav-list {
            display: flex;
            flex-direction: column;
            gap: var(--sp-1);
        }

        /* Nav Item Styling */
        .nav-item {
            display: block;
            text-decoration: none;
            font-size: 0.85rem;
            color: var(--c-text-secondary);
            padding-block: 2px;
            padding-inline: 0;
            border-left: 2px solid transparent;
            padding-left: var(--sp-2);
            margin-left: -2px; /* Align border with edge */
            transition: color 0.1s, font-weight 0.1s;
        }
        .nav-item:hover {
            color: var(--c-text-primary);
            text-decoration: underline;
            text-decoration-color: var(--c-hairline);
        }
        .nav-item.active {
            font-weight: var(--font-weight-bold);
            color: var(--c-accent);
            border-left-color: var(--c-accent); /* Active marker */
        }
        /* Hierarchy via type scale only */
        .nav-item[data-depth="0"] { font-size: 0.9rem; }
        .nav-item[data-depth="1"] { font-size: 0.85rem; }
        .nav-item[data-depth="2"] { font-size: 0.8rem; }
        .nav-item[data-depth="3"] { font-size: 0.75rem; }

        .nav-section-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--c-text-tertiary);
            margin-top: var(--sp-4);
            margin-bottom: var(--sp-2);
            font-weight: var(--font-weight-bold);
            cursor: default;
        }
        .nav-section-label:first-child { margin-top: 0; }


        /* PAPER COLUMN */
        .paper-col {
            min-width: 0; /* Allow grid flex shrinkage */
        }

        .paper-surface {
            /* Pure text/content, no card background */
        }

        .paper-loading-error {
            text-align: center;
            padding: var(--sp-8);
            color: var(--c-text-secondary);
            font-weight: var(--font-weight-medium);
            border: 1px dashed var(--c-hairline);
        }

        /* SECTION HEADERS IN PAPER */
        .paper-section-header {
            font-size: 1.25rem;
            font-weight: var(--font-weight-bold);
            color: var(--c-text-primary);
            border-bottom: 1px solid var(--c-hairline);
            padding-bottom: var(--sp-2);
            margin-top: var(--sp-12);
            margin-bottom: var(--sp-8);
        }
        .paper-section-header:first-child { margin-top: 0; }

        /* QUESTION NODE STRUCTURE */
        .q-node-wrapper {
            /* No container styling */
        }
        
        /* Top level separation */
        .q-node-wrapper[data-depth="0"] + .q-node-wrapper[data-depth="0"] {
            margin-top: var(--sp-12); /* Largest spacing unit */
        }

        .q-body {
            display: flex;
            gap: var(--sp-3);
            font-size: 1.05rem;
            line-height: 1.6;
            color: var(--c-text-primary);
        }

        .q-id {
            font-weight: var(--font-weight-bold);
            flex-shrink: 0;
            min-width: 1.5em;
        }

        .q-prompt {
            flex: 1;
            /* Markdown content styling */
        }
        .q-prompt p { margin-top: 0; margin-bottom: var(--sp-2); }
        .q-prompt p:last-child { margin-bottom: 0; }
        /* Tables in question */
        .q-prompt table {
            border-collapse: collapse;
            width: 100%;
            margin-block: var(--sp-2);
            font-size: 0.95em;
        }
        .q-prompt th, .q-prompt td {
            border: 1px solid var(--c-hairline);
            padding: var(--sp-2);
            text-align: left;
        }
        .q-prompt th { font-weight: var(--font-weight-bold); }

        /* SOLUTION BLOCK */
        .sol-block {
            margin-top: var(--sp-4);
            margin-left: calc(1.5em + var(--sp-3)); /* Align with prompt text */
            display: flex;
            flex-direction: column;
            gap: var(--sp-4);
        }

        /* ANSWER */
        .answer-region {
            /* Default visible */
        }
        .answer-label {
            font-size: 0.85rem;
            font-weight: var(--font-weight-bold);
            color: var(--c-text-secondary);
            margin-bottom: var(--sp-1);
            display: block;
        }
        .answer-content {
            font-weight: var(--font-weight-medium);
            color: var(--c-text-primary);
        }
        .answer-content p { margin: 0; }

        /* SOLUTION DETAILS TOGGLE */
        .sd-toggle {
            font-size: 0.9rem;
            color: var(--c-accent);
            font-weight: var(--font-weight-medium);
            text-align: left;
            display: inline-flex;
            align-items: center;
            gap: var(--sp-1);
        }
        .sd-toggle:hover { text-decoration: underline; }
        .sd-toggle:focus-visible {
            outline: 2px solid var(--c-accent);
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* SOLUTION DETAILS REGION */
        .sd-region {
            /* Hidden by default via JS toggle, or inline style */
            display: none; 
            flex-direction: column;
            gap: var(--sp-6);
            padding: var(--sp-4);
            background-color: var(--c-wash-solution); /* Subtle differentiation */
            border-radius: 4px; /* Permitted quiet cue for boundary clarity */
            margin-top: var(--sp-2);
        }
        .sd-region.expanded { display: flex; }

        /* Subsections */
        .sd-subsection {
            display: flex;
            flex-direction: column;
            gap: var(--sp-2);
        }
        .sd-sub-label {
            font-size: 0.8rem;
            font-weight: var(--font-weight-bold);
            color: var(--c-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .sd-body {
            font-size: 0.95rem;
            color: var(--c-text-secondary); /* Subordinate but readable */
        }
        .sd-body p { margin-top: 0; margin-bottom: var(--sp-2); }
        .sd-body p:last-child { margin-bottom: 0; }

        /* Keep in mind */
        .sd-kim .sd-body ul {
            margin: 0; padding-left: var(--sp-4);
        }

        /* Working / Alternative Working */
        .sd-working .sd-body, .sd-alt-working .sd-body {
            /* Support mixed prose + math */
        }
        /* Internal Separators */
        .sd-working + .sd-alt-working {
            padding-top: var(--sp-4);
            border-top: 1px solid var(--c-hairline); /* Allowed separator */
        }


        /* CHILDREN CONTAINER */
        .children-container {
            margin-top: var(--sp-4);
            margin-left: var(--sp-4); /* Indentation for hierarchy */
            display: flex;
            flex-direction: column;
            gap: var(--sp-6); /* Tighter than top-level */
        }


        /* MOBILE RESPONSIVE */
        @media (max-width: 768px) {
            .mobile-jump-trigger { display: block; }
            .doc-frame {
                grid-template-columns: 1fr; /* Single column */
                gap: 0;
            }
            .nav-col { display: none; } /* Hide sticky rail */
        }

        /* DRAWER (Mobile) */
        .drawer-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 100;
            display: flex;
            justify-content: flex-end;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }
        .drawer-overlay.open {
            opacity: 1;
            pointer-events: auto;
        }

        .drawer-content {
            width: 85%;
            max-width: 320px;
            background: var(--c-bg-app);
            height: 100%;
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.2s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: -4px 0 12px rgba(0,0,0,0.1);
        }
        .drawer-overlay.open .drawer-content {
            transform: translateX(0);
        }

        .drawer-header {
            height: var(--h-header);
            border-bottom: 1px solid var(--c-hairline);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-inline: var(--sp-4);
            font-weight: var(--font-weight-bold);
        }
        
        .drawer-scroll {
            flex: 1;
            overflow-y: auto;
            padding: var(--sp-4);
        }
        /* Reuse nav styles in drawer */
        .drawer-scroll .nav-list { gap: var(--sp-3); }
        .drawer-scroll .nav-item { 
            font-size: 1rem; 
            padding-block: var(--sp-2);
        }
        
        /* Focus styles */
        :focus-visible {
            outline: 2px solid var(--c-accent);
            outline-offset: 2px;
        }
    </style>

    <!-- Markdown-it Script -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>
    
    <!-- KaTeX Script -->
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <!-- Auto-render extension -->
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" onload="initApp()"></script>
</head>
<body>

    <!-- TOP CONTROLS -->
    <header class="top-controls">
        <div class="top-controls-inner">
            <select id="paper-selector" class="paper-selector" aria-label="Select paper">
                <option value="" disabled selected>Loading papers...</option>
            </select>
            
            <button id="mobile-jump-trigger" class="mobile-jump-trigger">
                Jump to...
            </button>
        </div>
    </header>

    <!-- DOCUMENT FRAME -->
    <main class="doc-frame">
        <!-- NAV RAIL (Desktop) -->
        <aside class="nav-col" aria-label="Paper navigation">
            <nav id="nav-list-desktop" class="nav-list">
                <!-- Injected via JS -->
            </nav>
        </aside>

        <!-- PAPER COLUMN -->
        <div class="paper-col">
            <div id="paper-content" class="paper-surface">
                <!-- Injected via JS -->
                <div class="paper-loading-error" style="display:none;" id="loading-error">
                    PAPERS PAYLOAD MISSING
                </div>
            </div>
        </div>
    </main>

    <!-- MOBILE DRAWER -->
    <div id="drawer-overlay" class="drawer-overlay" aria-hidden="true">
        <aside class="drawer-content" role="dialog" aria-modal="true" aria-label="Navigation">
            <div class="drawer-header">
                <span>Jump to</span>
                <button id="drawer-close" aria-label="Close navigation">âœ•</button>
            </div>
            <div class="drawer-scroll">
                <nav id="nav-list-mobile" class="nav-list">
                    <!-- Cloned via JS -->
                </nav>
            </div>
        </aside>
    </div>

    <!-- APP LOGIC -->
    <script>
        // --- CONSTANTS ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // --- STATE ---
        let state = {
            papers: [],
            currentPaper: null,
            navItems: [] // { id, elId, label, depth, sectionLabel }
        };

        // --- MARKDOWN INIT ---
        const md = window.markdownit
            ? window.markdownit({
                html: true, // Inline SVG passthrough
                linkify: true,
                breaks: false, // Must be false for KaTeX
            })
            : null;

        if (md) {
            md.inline.ruler.disable(['escape']); // Preserve TeX backslashes
        }

        // --- FETCH & INIT ---
        async function initApp() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Payload missing");
                
                const payload = await response.json();
                state.papers = payload.papers || [];

                if (state.papers.length === 0) throw new Error("No papers");

                populateSelector();
                loadPaper(state.papers[0].key);

            } catch (err) {
                console.error(err);
                document.getElementById('loading-error').style.display = 'block';
                document.getElementById('paper-selector').innerHTML = '<option disabled>Error</option>';
            }

            setupInteractions();
            setupObserver();
        }

        function populateSelector() {
            const select = document.getElementById('paper-selector');
            select.innerHTML = '';
            state.papers.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.key;
                opt.textContent = p.label;
                select.appendChild(opt);
            });
            select.disabled = false;
        }

        // --- RENDER LOGIC ---

        function loadPaper(key) {
            const paper = state.papers.find(p => p.key === key);
            if (!paper) return;

            state.currentPaper = paper;
            state.navItems = [];
            
            const contentContainer = document.getElementById('paper-content');
            contentContainer.innerHTML = '';

            // Handle Sections vs Flat
            if (paper.sections) {
                paper.sections.forEach(section => {
                    // Render Section Header if label exists
                    if (section.label && section.label.trim() !== "") {
                        // Nav logic
                        state.navItems.push({ type: 'section', label: section.label });
                        
                        // Render UI Header
                        const headerEl = document.createElement('div');
                        headerEl.className = 'paper-section-header';
                        headerEl.textContent = section.label;
                        contentContainer.appendChild(headerEl);
                    }

                    // Render Questions
                    if (section.questions) {
                        section.questions.forEach(q => renderQuestionNode(q, contentContainer, 0));
                    }
                });
            } else if (paper.questions) {
                paper.questions.forEach(q => renderQuestionNode(q, contentContainer, 0));
            }

            renderNav();
            runKatex(contentContainer);
        }

        function renderQuestionNode(node, container, depth) {
            // Check inputs
            if (!node || !node.id || !node.question) return;

            const elId = `q-${node.id.replace(/[^a-zA-Z0-9]/g, '-')}`;

            // Register for Nav
            state.navItems.push({ 
                type: 'item', 
                id: node.id, 
                elId: elId, 
                depth: depth 
            });

            // Wrapper
            const wrapper = document.createElement('div');
            wrapper.className = 'q-node-wrapper';
            wrapper.setAttribute('data-depth', depth);
            wrapper.id = elId;

            // 1. Question Body
            const body = document.createElement('div');
            body.className = 'q-body';
            
            const idEl = document.createElement('div');
            idEl.className = 'q-id';
            idEl.textContent = node.id;
            
            const promptEl = document.createElement('div');
            promptEl.className = 'q-prompt';
            promptEl.innerHTML = renderMarkdown(node.question);

            body.appendChild(idEl);
            body.appendChild(promptEl);
            wrapper.appendChild(body);

            // 2. Solution Block (Optional)
            if (node.solutionBlock) {
                const sb = node.solutionBlock;
                const blockEl = document.createElement('div');
                blockEl.className = 'sol-block';

                // Answer (Optional)
                if (sb.answer) {
                    const ansEl = document.createElement('div');
                    ansEl.className = 'answer-region';
                    ansEl.innerHTML = `
                        <span class="answer-label">Answer</span>
                        <div class="answer-content">${renderMarkdown(sb.answer)}</div>
                    `;
                    blockEl.appendChild(ansEl);
                }

                // Solution Details (Optional)
                if (sb.solutionDetails) {
                    const sd = sb.solutionDetails;
                    const detailsId = `${elId}-details`;
                    
                    // Defaults logic
                    const isExpanded = state.currentPaper.defaults?.expandedAll !== false;

                    // Toggle
                    const toggleBtn = document.createElement('button');
                    toggleBtn.className = 'sd-toggle';
                    toggleBtn.setAttribute('aria-expanded', isExpanded);
                    toggleBtn.setAttribute('aria-controls', detailsId);
                    toggleBtn.innerHTML = `<span>${isExpanded ? 'Hide working' : 'Show working'}</span>`;
                    
                    // Region
                    const region = document.createElement('div');
                    region.id = detailsId;
                    region.className = `sd-region ${isExpanded ? 'expanded' : ''}`;

                    // Subsections
                    // Keep in mind
                    if (sd.keepInMind) {
                        region.appendChild(createSDSubsection('Keep in mind', sd.keepInMind, 'sd-kim'));
                    }
                    // Formulas used
                    if (sd.formulasUsed) {
                        region.appendChild(createSDSubsection('Formulas used', sd.formulasUsed, 'sd-formulas'));
                    }
                    // Working
                    if (sd.working) {
                        region.appendChild(createSDSubsection('Working', sd.working, 'sd-working'));
                    }
                    // Alternative Working (Array)
                    if (sd.alternativeWorking && Array.isArray(sd.alternativeWorking)) {
                        sd.alternativeWorking.forEach(alt => {
                            region.appendChild(createSDSubsection('Alternative working', alt, 'sd-alt-working'));
                        });
                    }

                    // Toggle Event
                    toggleBtn.onclick = () => {
                        const expanded = toggleBtn.getAttribute('aria-expanded') === 'true';
                        toggleBtn.setAttribute('aria-expanded', !expanded);
                        toggleBtn.innerHTML = `<span>${!expanded ? 'Hide working' : 'Show working'}</span>`;
                        region.classList.toggle('expanded');
                    };

                    blockEl.appendChild(toggleBtn);
                    blockEl.appendChild(region);
                }

                wrapper.appendChild(blockEl);
            }

            // 3. Children (Optional)
            if (node.children && node.children.length > 0) {
                const childContainer = document.createElement('div');
                childContainer.className = 'children-container';
                node.children.forEach(child => renderQuestionNode(child, childContainer, depth + 1));
                wrapper.appendChild(childContainer);
            }

            container.appendChild(wrapper);
        }

        function createSDSubsection(label, markdownContent, className) {
            const div = document.createElement('div');
            div.className = `sd-subsection ${className}`;
            div.innerHTML = `
                <div class="sd-sub-label">${label}</div>
                <div class="sd-body">${renderMarkdown(markdownContent)}</div>
            `;
            return div;
        }

        function renderMarkdown(text) {
            if (!text) return '';
            return md ? md.render(text) : text; // Fallback plain text if MD fails
        }

        function runKatex(container) {
            renderMathInElement(container, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false},
                    {left: '\\(', right: '\\)', display: false},
                    {left: '\\[', right: '\\]', display: true}
                ],
                throwOnError: false
            });
        }

        // --- NAVIGATION RENDER ---
        function renderNav() {
            const desktopNav = document.getElementById('nav-list-desktop');
            const mobileNav = document.getElementById('nav-list-mobile');
            
            const frag = document.createDocumentFragment();

            state.navItems.forEach(item => {
                if (item.type === 'section') {
                    const sec = document.createElement('div');
                    sec.className = 'nav-section-label';
                    sec.textContent = item.label;
                    frag.appendChild(sec);
                } else {
                    const link = document.createElement('a');
                    link.className = 'nav-item';
                    link.href = `#${item.elId}`;
                    link.textContent = item.id;
                    link.setAttribute('data-depth', Math.min(item.depth, 3)); // Cap visual depth cues
                    link.onclick = (e) => {
                        e.preventDefault();
                        const target = document.getElementById(item.elId);
                        if (target) {
                            // Close drawer if open
                            closeDrawer();
                            // Scroll smooth with offset for sticky header
                            const headerOffset = 70;
                            const elementPosition = target.getBoundingClientRect().top;
                            const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
                            
                            window.scrollTo({
                                top: offsetPosition,
                                behavior: "smooth"
                            });
                        }
                    };
                    frag.appendChild(link);
                }
            });

            desktopNav.innerHTML = '';
            desktopNav.appendChild(frag.cloneNode(true));
            
            mobileNav.innerHTML = '';
            mobileNav.appendChild(frag);
        }

        // --- INTERACTION ---
        function setupInteractions() {
            // Paper Selector
            document.getElementById('paper-selector').addEventListener('change', (e) => {
                loadPaper(e.target.value);
            });

            // Mobile Drawer
            const overlay = document.getElementById('drawer-overlay');
            const closeBtn = document.getElementById('drawer-close');
            const jumpBtn = document.getElementById('mobile-jump-trigger');

            jumpBtn.onclick = openDrawer;
            closeBtn.onclick = closeDrawer;
            overlay.onclick = (e) => {
                if (e.target === overlay) closeDrawer();
            };
        }

        function openDrawer() {
            const overlay = document.getElementById('drawer-overlay');
            overlay.classList.remove('hidden');
            // Force reflow for transition
            void overlay.offsetWidth; 
            overlay.classList.add('open');
            document.body.style.overflow = 'hidden'; // Lock body scroll
        }

        function closeDrawer() {
            const overlay = document.getElementById('drawer-overlay');
            overlay.classList.remove('open');
            document.body.style.overflow = '';
            setTimeout(() => {
                if (!overlay.classList.contains('open')) {
                    overlay.classList.add('hidden');
                }
            }, 200);
        }

        // --- SCROLL OBSERVER (Active Nav) ---
        function setupObserver() {
            const options = {
                root: null,
                rootMargin: '-80px 0px -80% 0px', // Active region near top
                threshold: 0
            };

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        updateActiveNav(entry.target.id);
                    }
                });
            }, options);

            // MutationObserver to attach IntersectionObserver to new elements
            const mo = new MutationObserver(() => {
                document.querySelectorAll('.q-node-wrapper').forEach(el => observer.observe(el));
            });
            
            mo.observe(document.getElementById('paper-content'), { childList: true, subtree: true });
        }

        function updateActiveNav(id) {
            document.querySelectorAll('.nav-item').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === `#${id}`) {
                    link.classList.add('active');
                    // Scroll nav into view if needed (desktop only really)
                    if (window.innerWidth > 768) {
                        // basic ensure visible logic could go here
                    }
                }
            });
        }

    </script>
</body>
</html>
