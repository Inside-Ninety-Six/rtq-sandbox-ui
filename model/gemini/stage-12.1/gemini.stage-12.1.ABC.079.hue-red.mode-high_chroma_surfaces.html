<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"ABC","indexWithinVariant":"79","totalWithinVariant":"320","hueFamily":"red","intensityMode":"high_chroma_surfaces","timestamp":"2026-01-07T13:03:10.850Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;ABC&quot;,&quot;indexWithinVariant&quot;:&quot;79&quot;,&quot;totalWithinVariant&quot;:&quot;320&quot;,&quot;hueFamily&quot;:&quot;red&quot;,&quot;intensityMode&quot;:&quot;high_chroma_surfaces&quot;,&quot;timestamp&quot;:&quot;2026-01-07T13:03:10.850Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- KaTeX CSS (No SRI) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    
    <!-- KaTeX JS (No SRI) -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Markdown-it -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@13.0.2/dist/markdown-it.min.js"></script>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* COLORLAB C: HIGH CHROMA SURFACES (BLUE HUE FAMILY) */
        /* Light Mode Only. OKLCH Format. */
        :root {
            /* 
               Hue: 260 (Blue) 
               Requirements:
               - Two surfaces in [0.06 .. 0.12]
               - One surface in [0.03 .. 0.07]
            */
            --c-page-bg: oklch(0.93 0.07 260);    /* High chroma surface 1 */
            --c-frame-bg: oklch(0.91 0.04 260);   /* Tinted surface (the "remaining" one) */
            --c-paper-bg: oklch(0.97 0.06 260);   /* High chroma surface 2 */
            
            /* Wash surfaces: C in [0.05 .. 0.10] */
            --c-wash-sd: oklch(0.94 0.08 260);
            --c-wash-sub: oklch(0.95 0.06 260); 

            /* Text: C <= 0.015 */
            --c-txt-pri: oklch(0.20 0.015 260);
            --c-txt-sec: oklch(0.40 0.015 260);
            --c-txt-ter: oklch(0.55 0.015 260);

            /* Accent: C in [0.12 .. 0.20] */
            --c-accent: oklch(0.50 0.16 260);
            
            /* Divider: Neutral-ish */
            --c-divider: oklch(0.85 0.02 260);
            
            /* Focus */
            --c-focus: oklch(0.50 0.16 260); 
        }

        body {
            background-color: var(--c-page-bg);
            color: var(--c-txt-pri);
            font-family: ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            -webkit-font-smoothing: antialiased;
            overflow-y: scroll; /* Always show scrollbar to prevent layout shift */
        }

        /* Nav scrollbar hiding */
        .nav-scroll-hidden {
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE/Edge */
        }
        .nav-scroll-hidden::-webkit-scrollbar {
            display: none; /* Chrome/Safari */
        }

        /* KaTeX Containment & Styles */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            padding-top: 0.5em;
            padding-bottom: 0.5em;
            /* Underlay permitted for block math only */
            background-color: rgba(255, 255, 255, 0.4); 
            border-radius: 4px;
        }
        
        /* Inline KaTeX: Transparent background override */
        .katex {
            background-color: transparent !important;
        }

        /* Markdown Table Styling */
        .md-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 1em 0;
            font-size: 0.95em;
        }
        .md-content th, .md-content td {
            border: 1px solid var(--c-divider);
            padding: 0.5em 0.75em;
            text-align: left;
        }
        .md-content th {
            font-weight: 600;
            color: var(--c-txt-pri);
        }

        /* Markdown lists */
        .md-content ul { list-style-type: disc; padding-left: 1.5em; margin: 0.5em 0; }
        .md-content ol { list-style-type: decimal; padding-left: 1.5em; margin: 0.5em 0; }
        .md-content p { margin-bottom: 0.75em; line-height: 1.6; }
        .md-content p:last-child { margin-bottom: 0; }

        /* Focus styles */
        :focus-visible {
            outline: 2px solid var(--c-focus);
            outline-offset: 2px;
        }
        
        /* Utility for markdown content wrapper to target children */
        .md-content img, .md-content svg {
            max-width: 100%;
            height: auto;
        }
    </style>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        page: 'var(--c-page-bg)',
                        frame: 'var(--c-frame-bg)',
                        paper: 'var(--c-paper-bg)',
                        wash: {
                            sd: 'var(--c-wash-sd)',
                            sub: 'var(--c-wash-sub)',
                        },
                        txt: {
                            pri: 'var(--c-txt-pri)',
                            sec: 'var(--c-txt-sec)',
                            ter: 'var(--c-txt-ter)',
                        },
                        accent: 'var(--c-accent)',
                        divider: 'var(--c-divider)',
                    },
                    spacing: {
                        'q-gap': '3rem',
                        'sub-gap': '1.5rem',
                        'internal-gap': '0.75rem',
                    }
                }
            }
        }
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- STAGE 0: CONSTANTS ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // --- MARKDOWN SETUP ---
        const md = window.markdownit ? window.markdownit({
            html: true,
            linkify: true,
            breaks: false, // Critical: prevent <br> in math
        }) : null;

        if (md) {
            md.inline.ruler.disable(['escape']); // Critical: preserve TeX backslashes
        }

        // --- HELPERS ---
        const Markdown = ({ content, className = "md-content" }) => {
            const containerRef = React.useRef(null);

            React.useEffect(() => {
                if (containerRef.current && window.renderMathInElement) {
                    window.renderMathInElement(containerRef.current, {
                        delimiters: [
                            {left: "$$", right: "$$", display: true},
                            {left: "$", right: "$", display: false}
                        ],
                        throwOnError: false
                    });
                }
            }, [content]);

            if (!content) return null;
            if (!md) return <div className={className}>{content}</div>;

            const html = md.render(content);
            return (
                <div 
                    ref={containerRef}
                    className={className} 
                    dangerouslySetInnerHTML={{ __html: html }} 
                />
            );
        };

        const IconChevronDown = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m6 9 6 6 6-6"/></svg>
        );

        const IconChevronUp = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m18 15-6-6-6 6"/></svg>
        );

        const IconMenu = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>
        );

        const IconClose = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
        );

        // --- COMPONENTS ---

        // Solution Details Block
        const SolutionDetails = ({ details, isExpanded, onToggle }) => {
            if (!details) return null;

            return (
                <div className="mt-internal-gap">
                    <button 
                        onClick={onToggle}
                        className="flex items-center gap-2 text-sm font-medium text-accent hover:underline focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-1 focus-visible:ring-accent rounded-sm"
                        aria-expanded={isExpanded}
                    >
                        {isExpanded ? "Hide working" : "Show working"}
                        {isExpanded ? <IconChevronUp /> : <IconChevronDown />}
                    </button>

                    {isExpanded && (
                        <div className="mt-2 pl-3 border-l border-divider bg-wash-sd p-4 rounded-sm animate-in fade-in slide-in-from-top-1 duration-200">
                            
                            {/* Keep in mind */}
                            {details.keepInMind && (
                                <div className="mb-4 text-txt-pri">
                                    <div className="text-xs uppercase tracking-wide font-bold text-txt-sec mb-1">Keep in mind</div>
                                    <Markdown content={details.keepInMind} className="md-content text-sm" />
                                </div>
                            )}

                            {/* Formulas used */}
                            {details.formulasUsed && (
                                <div className="mb-4">
                                    <div className="text-xs uppercase tracking-wide font-bold text-txt-sec mb-1">Formulas used</div>
                                    <Markdown content={details.formulasUsed} className="md-content text-sm" />
                                </div>
                            )}

                            {/* Working (Primary) */}
                            {details.working && (
                                <div className="mb-4">
                                    <div className="text-xs uppercase tracking-wide font-bold text-txt-sec mb-1">Working</div>
                                    <Markdown content={details.working} className="md-content" />
                                </div>
                            )}

                            {/* Alternative Working */}
                            {details.alternativeWorking && details.alternativeWorking.map((alt, idx) => (
                                <div key={idx} className="mt-6 pt-4 border-t border-divider">
                                    <div className="text-xs uppercase tracking-wide font-bold text-txt-sec mb-1">Alternative working</div>
                                    <Markdown content={alt} className="md-content" />
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        // Recursive Question Node
        const QuestionNode = ({ node, paperDefaults, depth = 0 }) => {
            // Determine default expanded state: unless explicitly false in defaults, default to true
            const [isExpanded, setIsExpanded] = React.useState(
                paperDefaults?.expandedAll !== false
            );

            // Solution Block Logic
            const hasSolutionBlock = !!node.solutionBlock;
            const hasAnswer = hasSolutionBlock && !!node.solutionBlock.answer;
            const hasSolutionDetails = hasSolutionBlock && !!node.solutionBlock.solutionDetails;

            const handleToggle = () => setIsExpanded(!isExpanded);

            // Spacing logic: depth 0 = large gap, depth > 0 = smaller gap
            const wrapperClass = depth === 0 ? "mb-q-gap py-4 border-b border-divider/30 last:border-0" : "mt-sub-gap pl-4 md:pl-6 border-l border-divider/50";
            
            // Hierarchy visualization for prompt
            const promptClass = depth === 0 ? "text-lg md:text-xl font-medium text-txt-pri" : "text-base text-txt-pri";

            return (
                <div id={`q-${node.id}`} className={wrapperClass}>
                    {/* Header */}
                    <div className="flex flex-col gap-2">
                        <div className="flex items-baseline gap-3">
                            <span className="text-sm font-bold text-txt-sec shrink-0 w-8 md:w-10">{node.id}</span>
                            <div className="flex-1 min-w-0">
                                <Markdown content={node.question} className={`md-content ${promptClass}`} />
                            </div>
                        </div>
                    </div>

                    {/* Solution Block */}
                    {hasSolutionBlock && (
                        <div className="ml-8 md:ml-10 mt-internal-gap">
                            {/* Answer */}
                            {hasAnswer && (
                                <div className="mb-2">
                                    <span className="text-xs font-bold text-txt-sec uppercase tracking-wide block mb-1">Answer</span>
                                    <div className="text-txt-pri font-medium">
                                        <Markdown content={node.solutionBlock.answer} />
                                    </div>
                                </div>
                            )}

                            {/* Solution Details (Toggle + Content) */}
                            {hasSolutionDetails && (
                                <SolutionDetails 
                                    details={node.solutionBlock.solutionDetails} 
                                    isExpanded={isExpanded}
                                    onToggle={handleToggle}
                                />
                            )}
                        </div>
                    )}

                    {/* Recursive Children */}
                    {node.children && node.children.length > 0 && (
                        <div className="ml-0">
                            {node.children.map((child, idx) => (
                                <QuestionNode 
                                    key={child.id || idx} 
                                    node={child} 
                                    depth={depth + 1} 
                                    paperDefaults={paperDefaults}
                                />
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        // Navigation Item
        const NavItem = ({ id, isActive, onClick, depth = 0 }) => {
            // Flat list visual, but use type scale for hierarchy
            const fontSize = depth === 0 ? "text-sm font-semibold" : "text-sm font-normal text-txt-sec";
            const activeClass = isActive ? "text-accent font-bold" : "text-txt-sec hover:text-txt-pri";
            
            return (
                <button 
                    onClick={() => onClick(id)}
                    className={`block w-full text-left py-1 px-2 rounded-sm transition-colors ${fontSize} ${activeClass} focus-visible:ring-2 focus-visible:ring-accent`}
                >
                    {id}
                </button>
            );
        };

        // Navigation List Generator
        const NavigationList = ({ items, onJump, activeId }) => {
            // Flattens the tree for navigation rendering
            const renderItems = (nodes, currentDepth = 0) => {
                return nodes.map(node => (
                    <React.Fragment key={node.id}>
                        <NavItem 
                            id={node.id} 
                            depth={currentDepth}
                            isActive={activeId === node.id}
                            onClick={onJump}
                        />
                        {node.children && renderItems(node.children, currentDepth + 1)}
                    </React.Fragment>
                ));
            };
            return <div className="space-y-0.5">{renderItems(items)}</div>;
        };

        // Main App
        const App = () => {
            const [payload, setPayload] = React.useState(null);
            const [loading, setLoading] = React.useState(true);
            const [error, setError] = React.useState(false);
            const [currentPaperKey, setCurrentPaperKey] = React.useState(null);
            const [mobileNavOpen, setMobileNavOpen] = React.useState(false);
            const [activeQId, setActiveQId] = React.useState(null); // Simple state, could be IntersectionObserver

            React.useEffect(() => {
                fetch(RTQ_PAPERS_PAYLOAD_PATH)
                    .then(res => {
                        if (!res.ok) throw new Error("Payload missing");
                        return res.json();
                    })
                    .then(data => {
                        setPayload(data);
                        if (data.papers && data.papers.length > 0) {
                            setCurrentPaperKey(data.papers[0].key);
                        }
                        setLoading(false);
                    })
                    .catch(err => {
                        console.error(err);
                        setError(true);
                        setLoading(false);
                    });
            }, []);

            if (loading) return <div className="p-10 text-txt-sec">Loading papers...</div>;
            if (error || !payload) return (
                <div className="flex h-screen items-center justify-center bg-page text-txt-pri font-bold">
                    PAPERS PAYLOAD MISSING
                </div>
            );

            const currentPaper = payload.papers.find(p => p.key === currentPaperKey) || payload.papers[0];

            const handleJump = (id) => {
                setMobileNavOpen(false);
                setActiveQId(id);
                const el = document.getElementById(`q-${id}`);
                if (el) {
                    el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            };

            const renderPaperContent = () => {
                if (currentPaper.sections) {
                    return currentPaper.sections.map((section, sIdx) => (
                        <div key={sIdx} className="mb-8">
                            {section.label && section.label.trim() !== "" && (
                                <div className="mb-6 pb-2 border-b border-divider font-bold text-lg text-txt-pri">
                                    Section {section.label}
                                </div>
                            )}
                            {section.questions.map(q => (
                                <QuestionNode 
                                    key={q.id} 
                                    node={q} 
                                    paperDefaults={currentPaper.defaults} 
                                />
                            ))}
                        </div>
                    ));
                } else if (currentPaper.questions) {
                    return currentPaper.questions.map(q => (
                        <QuestionNode 
                            key={q.id} 
                            node={q} 
                            paperDefaults={currentPaper.defaults} 
                        />
                    ));
                }
                return null;
            };

            const renderNavContent = () => {
                 if (currentPaper.sections) {
                    return currentPaper.sections.map((section, sIdx) => (
                        <div key={sIdx} className="mb-4">
                             {section.label && section.label.trim() !== "" && (
                                <div className="px-2 text-xs font-bold text-txt-ter uppercase mb-1 mt-2">
                                    Section {section.label}
                                </div>
                            )}
                            <NavigationList items={section.questions} onJump={handleJump} activeId={activeQId} />
                        </div>
                    ));
                } else if (currentPaper.questions) {
                    return <NavigationList items={currentPaper.questions} onJump={handleJump} activeId={activeQId} />;
                }
            };

            return (
                <div className="min-h-screen flex flex-col md:flex-row bg-frame max-w-7xl mx-auto shadow-xl">
                    
                    {/* Top Controls (Mobile + Desktop integrated in shell for this prototype) */}
                    <div className="md:hidden sticky top-0 z-30 bg-frame border-b border-divider px-4 py-3 flex items-center justify-between">
                        <div className="flex items-center gap-3">
                            <select 
                                className="bg-page border border-divider rounded px-2 py-1 text-sm text-txt-pri focus:border-accent outline-none"
                                value={currentPaperKey}
                                onChange={(e) => setCurrentPaperKey(e.target.value)}
                            >
                                {payload.papers.map(p => (
                                    <option key={p.key} value={p.key}>{p.label}</option>
                                ))}
                            </select>
                        </div>
                        <button 
                            onClick={() => setMobileNavOpen(true)}
                            className="flex items-center gap-2 text-sm font-medium text-accent"
                        >
                            Jump to <IconMenu />
                        </button>
                    </div>

                    {/* Desktop Sidebar (Nav Rail) */}
                    <div className="hidden md:block w-64 shrink-0 bg-frame border-r border-divider">
                        <div className="sticky top-0 h-screen overflow-y-auto nav-scroll-hidden p-6 flex flex-col">
                            <div className="mb-6">
                                <label className="block text-xs font-bold text-txt-ter mb-1">Paper</label>
                                <select 
                                    className="w-full bg-page border border-divider rounded px-2 py-1.5 text-sm text-txt-pri focus:border-accent outline-none transition-shadow"
                                    value={currentPaperKey}
                                    onChange={(e) => setCurrentPaperKey(e.target.value)}
                                >
                                    {payload.papers.map(p => (
                                        <option key={p.key} value={p.key}>{p.label}</option>
                                    ))}
                                </select>
                            </div>
                            
                            <nav className="flex-1" aria-label="Paper navigation">
                                {renderNavContent()}
                            </nav>
                        </div>
                    </div>

                    {/* Mobile Drawer */}
                    {mobileNavOpen && (
                        <div className="fixed inset-0 z-50 flex justify-end">
                            <div className="absolute inset-0 bg-black/20" onClick={() => setMobileNavOpen(false)} />
                            <div className="relative w-64 bg-frame h-full shadow-2xl flex flex-col animate-in slide-in-from-right duration-200">
                                <div className="p-4 border-b border-divider flex items-center justify-between">
                                    <h2 className="font-bold text-txt-pri">Jump to</h2>
                                    <button onClick={() => setMobileNavOpen(false)} className="text-txt-sec hover:text-txt-pri">
                                        <IconClose />
                                    </button>
                                </div>
                                <div className="flex-1 overflow-y-auto p-4">
                                    {renderNavContent()}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Main Content (Paper Column) */}
                    <main className="flex-1 bg-paper min-h-screen">
                        <div className="max-w-3xl mx-auto px-4 py-8 md:px-12 md:py-12">
                            {renderPaperContent()}
                        </div>
                    </main>

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
