<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"ABC","indexWithinVariant":"294","totalWithinVariant":"320","hueFamily":"blue","intensityMode":"tinted_neutrals","timestamp":"2026-01-07T23:10:06.345Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;ABC&quot;,&quot;indexWithinVariant&quot;:&quot;294&quot;,&quot;totalWithinVariant&quot;:&quot;320&quot;,&quot;hueFamily&quot;:&quot;blue&quot;,&quot;intensityMode&quot;:&quot;tinted_neutrals&quot;,&quot;timestamp&quot;:&quot;2026-01-07T23:10:06.345Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer (Stage 6 Baseline)</title>

    <!-- 
      STAGE 6 ADD-ON: ColorLab B (Forced Hue: Blue)
      STAGE 6 ADD-ON: ColorLab C (Intensity Mode: Tinted Neutrals)
      LIGHT MODE ONLY
    -->

    <!-- Taildwind CSS (via CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- KaTeX CSS (via CDN, no integrity) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <!-- KaTeX JS (via CDN, no integrity) -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Markdown-it (via CDN, no integrity) -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <!-- Lucide Icons (via CDN, no integrity) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Configuration for ColorLab B (Blue) + ColorLab C (Tinted Neutrals) -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    colors: {
                        // OKLCH Definitions for Tinted Neutrals (Hue 250)
                        page: 'oklch(0.98 0.02 250)',     // Very light tinted bg
                        frame: 'oklch(0.99 0.025 250)',    // Slightly distinct frame
                        paper: 'oklch(1.0 0.015 250)',     // Near white, slight tint
                        wash: 'oklch(0.96 0.035 250)',     // Solution details wash
                        primary: 'oklch(0.20 0.01 250)',   // Dark grey-blue
                        secondary: 'oklch(0.45 0.012 250)',// Medium grey-blue
                        hairline: 'oklch(0.92 0.02 250)',  // Subtle divider
                        accent: 'oklch(0.55 0.14 250)',    // Restrained Blue Accent
                        focus: 'oklch(0.55 0.14 250)',     // Focus ring
                    }
                }
            }
        }
    </script>

    <style>
        /* Base Resets & Typography */
        body {
            background-color: theme('colors.page');
            color: theme('colors.primary');
            font-family: theme('fontFamily.sans');
            -webkit-font-smoothing: antialiased;
        }

        /* Focus Management - Stage 5.5.2 */
        :focus-visible {
            outline: 2px solid theme('colors.focus');
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* 
           KaTeX Containment Invariant (Stage 3 + Stage 6.0.8) 
           Block math must scroll internally on overflow.
           Inline math must allow wrapping/not break layout.
        */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding: 0.5rem 0;
            margin: 0.5rem 0;
            /* Scrollbar hiding for cleaner look, functional on touch/wheel */
            scrollbar-width: thin; 
            scrollbar-color: theme('colors.secondary') transparent;
        }

        /* Inline KaTeX: Transparent background (Stage 5.8.4) */
        .katex {
            font-size: 1.1em; /* Slight bump for readability */
        }
        
        /* Nav Scrollbar Hiding (Stage 6.0.9) */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Layout Utilities */
        .layout-shell {
            max-width: 1200px;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Markdown Content Styling (Minimal/Reset) */
        .md-content p {
            margin-bottom: 0.75rem;
            line-height: 1.6;
        }
        .md-content p:last-child {
            margin-bottom: 0;
        }
        .md-content ul {
            list-style-type: disc;
            padding-left: 1.25rem;
            margin-bottom: 0.75rem;
        }
        .md-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 0.75rem 0;
            font-size: 0.95em;
        }
        .md-content th, .md-content td {
            border: 1px solid theme('colors.hairline');
            padding: 0.5rem;
            text-align: left;
        }
        .md-content th {
            font-weight: 600;
        }
        
        /* Drawer Transition */
        .drawer-transform {
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
    </style>
</head>
<body class="text-primary bg-page">

    <!-- CANONICAL CONSTANTS DEFINITION (Runtime) -->
    <script>
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";
    </script>

    <!-- APP SHELL -->
    <div id="app" class="layout-shell bg-frame relative">
        
        <!-- TOP CONTROLS REGION -->
        <header class="sticky top-0 z-20 bg-frame border-b border-hairline px-4 h-16 flex items-center justify-between lg:justify-start gap-4">
            
            <!-- Mobile: Jump To Trigger -->
            <button id="mobile-jump-trigger" class="lg:hidden flex items-center gap-2 text-primary font-medium px-2 py-1 hover:text-accent transition-colors" aria-label="Jump to question">
                <i data-lucide="menu" class="w-5 h-5"></i>
                <span>Jump to</span>
            </button>

            <!-- Paper Selector -->
            <div class="flex items-center gap-3">
                <label for="paper-select" class="text-sm font-medium text-secondary hidden sm:block">Paper:</label>
                <div class="relative">
                    <select id="paper-select" class="appearance-none bg-paper border border-hairline rounded px-3 py-1.5 pr-8 text-sm font-medium focus:border-accent focus:ring-1 focus:ring-accent outline-none min-w-[200px]">
                        <option>Loading papers...</option>
                    </select>
                    <i data-lucide="chevron-down" class="absolute right-2.5 top-1/2 -translate-y-1/2 w-4 h-4 text-secondary pointer-events-none"></i>
                </div>
            </div>

        </header>

        <!-- MAIN DOCUMENT FRAME -->
        <div class="flex flex-1 relative overflow-hidden">
            
            <!-- DESKTOP NAVIGATION RAIL (Sticky) -->
            <nav class="hidden lg:block w-64 flex-shrink-0 sticky top-16 h-[calc(100vh-4rem)] overflow-y-auto no-scrollbar border-r border-hairline py-6 pl-4 pr-4">
                <div id="desktop-nav-list" class="flex flex-col gap-1">
                    <!-- Nav items injected here -->
                </div>
            </nav>

            <!-- PAPER CONTENT COLUMN -->
            <main class="flex-1 w-full min-w-0 bg-paper">
                <div id="paper-content" class="max-w-3xl mx-auto py-8 px-4 sm:px-8 pb-32">
                    <!-- Paper content injected here -->
                    <div class="text-center text-secondary py-20">Loading payload...</div>
                </div>
            </main>

        </div>

    </div>

    <!-- MOBILE DRAWER (Overlay) -->
    <div id="mobile-drawer-backdrop" class="fixed inset-0 bg-black/20 z-40 hidden transition-opacity opacity-0" aria-hidden="true"></div>
    <div id="mobile-drawer" class="fixed inset-y-0 left-0 w-80 bg-paper z-50 transform -translate-x-full drawer-transform shadow-xl flex flex-col" aria-hidden="true">
        <div class="h-16 flex items-center justify-between px-4 border-b border-hairline">
            <h2 class="font-semibold text-lg">Jump to</h2>
            <button id="drawer-close" class="p-2 hover:bg-wash rounded text-secondary hover:text-primary">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>
        <div class="flex-1 overflow-y-auto p-4">
            <div id="mobile-nav-list" class="flex flex-col gap-1">
                <!-- Mobile nav items injected here -->
            </div>
        </div>
    </div>

    <!-- LOGIC -->
    <script>
        // --- Markdown Renderer Setup (Authoritative Config) ---
        const md = window.markdownit ? window.markdownit({
            html: true,       // Enable inline SVG passthrough
            linkify: true,
            breaks: false     // MUST be false to preserve KaTeX
        }) : null;

        if (md) {
            md.inline.ruler.disable(['escape']); // Preserve TeX backslashes
        }

        // --- State ---
        let state = {
            papers: [],
            activePaperKey: null,
            payloadLoaded: false,
            expandedStates: {} // Key: questionId, Value: boolean
        };

        // --- DOM Elements ---
        const els = {
            paperSelect: document.getElementById('paper-select'),
            desktopNav: document.getElementById('desktop-nav-list'),
            mobileNav: document.getElementById('mobile-nav-list'),
            paperContent: document.getElementById('paper-content'),
            mobileDrawer: document.getElementById('mobile-drawer'),
            mobileBackdrop: document.getElementById('mobile-drawer-backdrop'),
            jumpTrigger: document.getElementById('mobile-jump-trigger'),
            drawerClose: document.getElementById('drawer-close')
        };

        // --- Initialization ---
        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Payload not found");
                const payload = await response.json();
                
                state.papers = payload.papers || [];
                state.payloadLoaded = true;

                if (state.papers.length > 0) {
                    renderPaperSelector();
                    // Load first paper by default
                    loadPaper(state.papers[0].key);
                } else {
                    renderError("No papers in payload");
                }
            } catch (e) {
                console.error(e);
                renderError("PAPERS PAYLOAD MISSING");
            }
        }

        function renderError(msg) {
            els.paperContent.innerHTML = `<div class="text-center text-secondary font-medium mt-10">${msg}</div>`;
            els.paperSelect.innerHTML = `<option disabled>Error loading</option>`;
        }

        function renderPaperSelector() {
            els.paperSelect.innerHTML = state.papers.map(p => 
                `<option value="${p.key}">${p.label}</option>`
            ).join('');
            
            els.paperSelect.addEventListener('change', (e) => {
                loadPaper(e.target.value);
            });
        }

        function loadPaper(paperKey) {
            state.activePaperKey = paperKey;
            const paper = state.papers.find(p => p.key === paperKey);
            if (!paper) return;

            // Reset expanded states based on defaults
            state.expandedStates = {};
            // Default is expanded unless explicitly false
            const defaultExpanded = paper.defaults?.expandedAll !== false; 
            
            // Build content HTML
            const contentHtml = renderPaperHtml(paper, defaultExpanded);
            els.paperContent.innerHTML = contentHtml;

            // Build Navigation
            renderNavigation(paper);

            // Post-Render: KaTeX
            renderMathInElement(els.paperContent, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false}
                ],
                throwOnError: false
            });

            // Post-Render: Icons
            lucide.createIcons();

            // Setup Interactions (Delegation)
            setupInteractions(defaultExpanded);

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'auto' });
        }

        // --- Rendering Logic ---

        function renderPaperHtml(paper, defaultExpanded) {
            let html = '';

            // Handle Sections vs Flat
            if (paper.sections) {
                paper.sections.forEach(section => {
                    // Render Section Header if label exists
                    if (section.label && section.label.trim().length > 0) {
                        html += `
                            <div class="mb-6 pt-4 border-b border-hairline pb-2">
                                <h2 class="text-xl font-semibold text-primary">${escapeHtml(section.label)}</h2>
                            </div>
                        `;
                    }
                    html += `<div class="flex flex-col gap-12 mb-12">`; // Question list container
                    section.questions.forEach(q => {
                        html += renderQuestionNode(q, defaultExpanded, 0);
                    });
                    html += `</div>`;
                });
            } else if (paper.questions) {
                html += `<div class="flex flex-col gap-12">`;
                paper.questions.forEach(q => {
                    html += renderQuestionNode(q, defaultExpanded, 0);
                });
                html += `</div>`;
            }

            return html;
        }

        function renderQuestionNode(node, defaultExpanded, depth) {
            // Determine if we have solution details
            const hasSolutionBlock = !!node.solutionBlock;
            const hasAnswer = hasSolutionBlock && !!node.solutionBlock.answer;
            const hasDetails = hasSolutionBlock && !!node.solutionBlock.solutionDetails;
            
            // Initial state: Use state if set, else default
            const isExpanded = state.expandedStates[node.id] !== undefined 
                ? state.expandedStates[node.id] 
                : defaultExpanded;

            // Track state for this node if not set
            if (state.expandedStates[node.id] === undefined) {
                state.expandedStates[node.id] = defaultExpanded;
            }

            // Render content
            const questionHtml = renderMarkdown(node.question);

            let html = `
                <div id="q-${node.id}" class="group relative scroll-mt-24">
                    <!-- Question Body -->
                    <div class="flex gap-4">
                        <div class="flex-shrink-0 w-8 sm:w-12 pt-0.5">
                            <span class="text-secondary font-medium text-lg block leading-none">${node.id}</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="md-content text-lg text-primary font-medium">
                                ${questionHtml}
                            </div>
                        </div>
                    </div>
            `;

            // Solution Block
            if (hasSolutionBlock) {
                html += `<div class="ml-8 sm:ml-12 mt-6 flex flex-col gap-4">`; // Indented block

                // Answer
                if (hasAnswer) {
                    html += `
                        <div class="flex flex-col gap-1">
                            <span class="text-xs font-bold uppercase tracking-wider text-secondary select-none">Answer</span>
                            <div class="md-content text-primary">
                                ${renderMarkdown(node.solutionBlock.answer)}
                            </div>
                        </div>
                    `;
                }

                // Solution Details
                if (hasDetails) {
                    const details = node.solutionBlock.solutionDetails;
                    const controlId = `toggle-${node.id}`;
                    const contentId = `details-${node.id}`;
                    const btnText = isExpanded ? "Hide working" : "Show working";
                    const displayStyle = isExpanded ? "block" : "hidden";
                    
                    html += `
                        <div class="mt-2">
                            <button class="text-accent hover:text-focus text-sm font-medium flex items-center gap-1 focus:outline-none focus-visible js-toggle-working" 
                                    data-target="${node.id}" aria-expanded="${isExpanded}" aria-controls="${contentId}">
                                <span>${btnText}</span>
                                <i data-lucide="chevron-down" class="w-4 h-4 transition-transform duration-200 ${isExpanded ? 'rotate-180' : ''}"></i>
                            </button>

                            <div id="${contentId}" class="${displayStyle} mt-4 pl-4 border-l-2 border-hairline bg-wash rounded-r-sm py-4 pr-4">
                                <div class="flex flex-col gap-6">
                    `;

                    // Keep in mind
                    if (details.keepInMind) {
                        html += `
                            <div class="text-sm">
                                <div class="flex items-center gap-2 mb-2 text-secondary font-bold text-xs uppercase tracking-wider">
                                    <i data-lucide="lightbulb" class="w-3 h-3"></i>
                                    <span>Keep in mind</span>
                                </div>
                                <div class="md-content text-secondary">
                                    ${renderMarkdown(details.keepInMind)}
                                </div>
                            </div>
                            <div class="h-px bg-hairline/50 w-full"></div>
                        `;
                    }

                    // Formulas Used
                    if (details.formulasUsed) {
                        html += `
                            <div class="text-sm">
                                <div class="mb-2 text-secondary font-bold text-xs uppercase tracking-wider">Formulas used</div>
                                <div class="md-content text-secondary">
                                    ${renderMarkdown(details.formulasUsed)}
                                </div>
                            </div>
                            <div class="h-px bg-hairline/50 w-full"></div>
                        `;
                    }

                    // Working
                    if (details.working) {
                        html += `
                            <div>
                                <div class="mb-2 text-secondary font-bold text-xs uppercase tracking-wider">Working</div>
                                <div class="md-content text-primary/90 text-[0.95rem]">
                                    ${renderMarkdown(details.working)}
                                </div>
                            </div>
                        `;
                    }

                    // Alternative Working
                    if (details.alternativeWorking && Array.isArray(details.alternativeWorking)) {
                        details.alternativeWorking.forEach((alt, idx) => {
                             html += `
                                <div class="h-px bg-hairline w-full"></div>
                                <div>
                                    <div class="mb-2 text-secondary font-bold text-xs uppercase tracking-wider">Alternative working</div>
                                    <div class="md-content text-primary/90 text-[0.95rem]">
                                        ${renderMarkdown(alt)}
                                    </div>
                                </div>
                            `;
                        });
                    }

                    html += `
                                </div>
                            </div>
                        </div>
                    `;
                }

                html += `</div>`; // End Solution Block wrapper
            }

            // Children recursion
            if (node.children && node.children.length > 0) {
                html += `<div class="mt-6 flex flex-col gap-6">`;
                node.children.forEach(child => {
                    html += renderQuestionNode(child, defaultExpanded, depth + 1);
                });
                html += `</div>`;
            }

            html += `</div>`; // End Node
            return html;
        }

        function renderNavigation(paper) {
            let html = '';
            
            const renderItem = (id) => `
                <a href="#q-${id}" class="block py-1 px-2 text-sm text-secondary hover:text-primary transition-colors hover:underline decoration-hairline js-nav-link" data-id="${id}">
                    <span class="js-nav-label" data-id="${id}">${id}</span>
                </a>
            `;

            if (paper.sections) {
                paper.sections.forEach(section => {
                    if (section.label && section.label.trim()) {
                        html += `<div class="mb-4">
                            <div class="px-2 mb-1 text-xs font-bold text-secondary/70 uppercase tracking-wider select-none">${section.label}</div>`;
                    } else {
                         html += `<div class="mb-4">`;
                    }
                    section.questions.forEach(q => {
                        html += renderItem(q.id);
                        if (q.children) {
                            q.children.forEach(c => html += renderItem(c.id));
                        }
                    });
                    html += `</div>`;
                });
            } else if (paper.questions) {
                paper.questions.forEach(q => {
                    html += renderItem(q.id);
                    if (q.children) {
                        q.children.forEach(c => html += renderItem(c.id));
                    }
                });
            }

            els.desktopNav.innerHTML = html;
            els.mobileNav.innerHTML = html;
        }

        // --- Helpers ---

        function renderMarkdown(text) {
            if (!text || !md) return text || '';
            // Markdown-it renders
            return md.render(text);
        }

        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function setupInteractions() {
            // Expand/Collapse Delegation
            els.paperContent.onclick = (e) => {
                const btn = e.target.closest('.js-toggle-working');
                if (btn) {
                    const id = btn.dataset.target;
                    const contentId = btn.getAttribute('aria-controls');
                    const contentDiv = document.getElementById(contentId);
                    const isExpanded = btn.getAttribute('aria-expanded') === 'true';
                    const icon = btn.querySelector('i');
                    const span = btn.querySelector('span');

                    // Toggle State
                    const newState = !isExpanded;
                    state.expandedStates[id] = newState;

                    // Toggle DOM
                    if (newState) {
                        contentDiv.classList.remove('hidden');
                        contentDiv.classList.add('block');
                        btn.setAttribute('aria-expanded', 'true');
                        span.textContent = "Hide working";
                        icon.style.transform = "rotate(180deg)";
                    } else {
                        contentDiv.classList.add('hidden');
                        contentDiv.classList.remove('block');
                        btn.setAttribute('aria-expanded', 'false');
                        span.textContent = "Show working";
                        icon.style.transform = "rotate(0deg)";
                    }
                }
            };

            // Intersection Observer for Active Nav
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const id = entry.target.id.replace('q-', '');
                        updateActiveNav(id);
                    }
                });
            }, { rootMargin: '-10% 0px -80% 0px' });

            document.querySelectorAll('[id^="q-"]').forEach(el => observer.observe(el));
        }

        function updateActiveNav(id) {
            // Reset all
            document.querySelectorAll('.js-nav-label').forEach(el => {
                el.classList.remove('font-bold', 'text-accent');
                el.classList.add('font-normal');
            });

            // Set active (weight + accent marker per Stage 6 override)
            const activeEls = document.querySelectorAll(`.js-nav-label[data-id="${id}"]`);
            activeEls.forEach(el => {
                el.classList.remove('font-normal');
                el.classList.add('font-bold', 'text-accent');
            });
        }

        // --- Mobile Drawer Logic ---
        function toggleDrawer(show) {
            if (show) {
                els.mobileBackdrop.classList.remove('hidden');
                // timeout for opacity transition
                setTimeout(() => els.mobileBackdrop.classList.remove('opacity-0'), 10);
                els.mobileDrawer.classList.remove('-translate-x-full');
            } else {
                els.mobileBackdrop.classList.add('opacity-0');
                els.mobileDrawer.classList.add('-translate-x-full');
                setTimeout(() => els.mobileBackdrop.classList.add('hidden'), 300);
            }
        }

        els.jumpTrigger.addEventListener('click', () => toggleDrawer(true));
        els.drawerClose.addEventListener('click', () => toggleDrawer(false));
        els.mobileBackdrop.addEventListener('click', () => toggleDrawer(false));
        
        // Close drawer on nav click
        els.mobileNav.addEventListener('click', (e) => {
            if (e.target.closest('a')) toggleDrawer(false);
        });

        // Run Init
        init();

    </script>
</body>
</html>
