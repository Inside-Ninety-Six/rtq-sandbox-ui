<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"ABC","indexWithinVariant":"199","totalWithinVariant":"320","hueFamily":"blue","intensityMode":"high_chroma_surfaces","timestamp":"2026-01-07T18:38:58.169Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;ABC&quot;,&quot;indexWithinVariant&quot;:&quot;199&quot;,&quot;totalWithinVariant&quot;:&quot;320&quot;,&quot;hueFamily&quot;:&quot;blue&quot;,&quot;intensityMode&quot;:&quot;high_chroma_surfaces&quot;,&quot;timestamp&quot;:&quot;2026-01-07T18:38:58.169Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Solution Viewer</title>

    <!-- KaTeX CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <!-- Tailwind CSS (Prototyping) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Tailwind Config for ColorLab C (High Chroma Surfaces) + ColorLab B (Blue) -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['ui-sans-serif', 'system-ui', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif'],
                    },
                    colors: {
                        // COLORLAB C: Mode 3 (High Chroma Surfaces)
                        // COLORLAB B: Hue Family = Blue (~264deg)
                        
                        // Page Background: L 0.96, C 0.06, H 264
                        page: 'oklch(0.96 0.06 264)',
                        
                        // Frame Base: L 0.93, C 0.08, H 264
                        frame: 'oklch(0.93 0.08 264)',
                        
                        // Paper Surface: L 0.98, C 0.06, H 264 (Distinct from page/frame)
                        paper: 'oklch(0.98 0.06 264)',
                        
                        // Wash Surface (Solution Details): L 0.94, C 0.07, H 264
                        wash: 'oklch(0.94 0.07 264)',

                        // Text - Primary: L 0.20, C 0.015, H 264 (Low chroma)
                        primary: 'oklch(0.20 0.015 264)',
                        
                        // Text - Secondary: L 0.40, C 0.02, H 264
                        secondary: 'oklch(0.40 0.02 264)',

                        // Accent (Links, Focus, Controls): L 0.55, C 0.18, H 264 (High intensity)
                        accent: 'oklch(0.55 0.18 264)',

                        // Divider: L 0.85, C 0.02, H 264
                        divider: 'oklch(0.85 0.02 264)',
                    }
                }
            }
        }
    </script>

    <!-- Styles for constraints and specific behaviors -->
    <style>
        /* Hide scrollbar for Nav but keep functionality */
        .no-scrollbar {
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none;  /* IE 10+ */
        }
        .no-scrollbar::-webkit-scrollbar { 
            display: none; /* WebKit */
        }

        /* KaTeX Containment Invariant */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 4px; /* Space for scrollbar if needed */
        }
        
        /* Prevent layout shifts from scrollbars */
        html {
            overflow-y: scroll;
        }

        /* Focus styles matching ColorLab intent */
        *:focus-visible {
            outline: 2px solid oklch(0.55 0.18 264); /* Accent */
            outline-offset: 2px;
        }

        /* Utility for sticky nav alignment */
        .sticky-col {
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-page text-primary antialiased min-h-screen flex flex-col items-center">

    <!-- Top Controls Region (Aligned to Shell) -->
    <div class="w-full max-w-7xl px-4 md:px-8 py-4 flex items-center justify-between shrink-0 z-50">
        <div class="flex items-center gap-4">
            <!-- Paper Selector -->
            <select id="paper-selector" class="bg-paper border border-divider rounded px-3 py-2 text-sm font-medium focus:ring-1 focus:ring-accent outline-none cursor-pointer">
                <option value="" disabled selected>Loading papers...</option>
            </select>
        </div>
        
        <!-- Mobile "Jump to" Trigger -->
        <button id="mobile-jump-trigger" class="md:hidden text-accent font-medium text-sm flex items-center gap-1 hover:text-accent/80 transition-colors">
            Jump to
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>
        </button>
    </div>

    <!-- DocumentFrameShell -->
    <main class="w-full max-w-7xl flex flex-row flex-1 px-4 md:px-8 pb-12 gap-8 relative">
        
        <!-- Desktop Navigation Rail (Sticky) -->
        <aside class="hidden md:block w-48 shrink-0 sticky-col no-scrollbar pt-2 pb-10">
            <nav id="desktop-nav-list" class="flex flex-col gap-1 text-sm text-secondary" aria-label="Paper Navigation">
                <!-- Nav items generated here -->
            </nav>
        </aside>

        <!-- Paper Document Column -->
        <div class="flex-1 min-w-0 pt-2">
            <!-- Paper Surface -->
            <div id="paper-content" class="bg-paper min-h-[50vh] rounded-none md:rounded-sm w-full p-6 md:p-10 lg:p-12 shadow-sm border border-divider/50">
                <!-- Content generated here -->
                <div class="text-secondary text-center py-12">Loading Paper...</div>
            </div>
        </div>

    </main>

    <!-- Mobile Navigation Drawer -->
    <div id="mobile-drawer" class="fixed inset-0 z-[100] hidden" role="dialog" aria-modal="true">
        <!-- Scrim -->
        <div id="mobile-drawer-scrim" class="absolute inset-0 bg-black/20 backdrop-blur-sm transition-opacity opacity-0"></div>
        
        <!-- Drawer Panel -->
        <div id="mobile-drawer-panel" class="absolute right-0 top-0 bottom-0 w-64 bg-paper shadow-xl transform translate-x-full transition-transform duration-200 flex flex-col">
            <div class="flex items-center justify-between p-4 border-b border-divider">
                <span class="font-bold text-primary">Jump to</span>
                <button id="mobile-drawer-close" class="text-secondary p-2 hover:text-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <nav id="mobile-nav-list" class="flex-1 overflow-y-auto p-4 flex flex-col gap-1 text-sm text-secondary">
                <!-- Nav items generated here -->
            </nav>
        </div>
    </div>

    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Runtime Logic -->
    <script>
        // --- STAGE 0: CONSTANTS ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // --- STATE & CONFIG ---
        let rawPayload = null;
        let activePaperKey = null;
        let expandedState = new Map(); // Key: questionNodeId -> boolean

        // --- MARKDOWN INIT ---
        const md = window.markdownit ? window.markdownit({
            html: true,
            linkify: true,
            breaks: false 
        }) : null;

        if (md) {
            md.inline.ruler.disable(['escape']);
        }

        // --- DOM ELEMENTS ---
        const els = {
            selector: document.getElementById('paper-selector'),
            paperContent: document.getElementById('paper-content'),
            desktopNav: document.getElementById('desktop-nav-list'),
            mobileNav: document.getElementById('mobile-nav-list'),
            mobileTrigger: document.getElementById('mobile-jump-trigger'),
            drawer: document.getElementById('mobile-drawer'),
            drawerScrim: document.getElementById('mobile-drawer-scrim'),
            drawerPanel: document.getElementById('mobile-drawer-panel'),
            drawerClose: document.getElementById('mobile-drawer-close'),
        };

        // --- INITIALIZATION ---
        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Fetch failed");
                rawPayload = await response.json();
                
                if (!rawPayload || !rawPayload.papers || rawPayload.papers.length === 0) {
                    throw new Error("Invalid payload");
                }

                populateSelector(rawPayload.papers);
                
                // Select first paper by default
                const firstPaperKey = rawPayload.papers[0].key;
                switchPaper(firstPaperKey);

            } catch (err) {
                console.error(err);
                els.paperContent.innerHTML = `<div class="p-8 text-center font-bold text-red-700">PAPERS PAYLOAD MISSING</div>`;
                els.selector.innerHTML = `<option>Error</option>`;
                els.selector.disabled = true;
            }
        }

        function populateSelector(papers) {
            els.selector.innerHTML = papers.map(p => 
                `<option value="${p.key}">${p.label}</option>`
            ).join('');
            
            els.selector.addEventListener('change', (e) => {
                switchPaper(e.target.value);
            });
        }

        // --- RENDER PIPELINE ---

        function switchPaper(key) {
            activePaperKey = key;
            const paper = rawPayload.papers.find(p => p.key === key);
            if (!paper) return;

            // Reset state
            expandedState.clear();
            const defaultExpanded = paper.defaults && paper.defaults.expandedAll !== false;

            // Render Nav
            renderNavigation(paper, els.desktopNav);
            renderNavigation(paper, els.mobileNav);

            // Render Content
            const contentHTML = renderPaperContent(paper, defaultExpanded);
            els.paperContent.innerHTML = contentHTML;

            // Post-process: KaTeX
            renderMathInElement(els.paperContent, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false},
                    {left: '\\(', right: '\\)', display: false},
                    {left: '\\[', right: '\\]', display: true}
                ],
                throwOnError: false
            });

            // Re-attach event listeners for toggles
            attachToggleListeners();
            updateToggleUI();
        }

        function renderNavigation(paper, container) {
            let html = '';
            
            if (paper.sections) {
                paper.sections.forEach(section => {
                    const hasLabel = section.label && section.label.trim().length > 0;
                    if (hasLabel) {
                        html += `
                            <div class="mt-4 mb-2 first:mt-0 font-bold text-primary select-none px-2 opacity-80">
                                ${section.label}
                            </div>
                        `;
                    }
                    if (section.questions) {
                        section.questions.forEach(q => {
                            html += renderNavItemsRecursive(q);
                        });
                    }
                });
            } else if (paper.questions) {
                paper.questions.forEach(q => {
                    html += renderNavItemsRecursive(q);
                });
            }
            container.innerHTML = html;
        }

        function renderNavItemsRecursive(node) {
            let html = `
                <a href="#q-${node.id}" 
                   class="block py-1 px-2 rounded hover:text-accent hover:bg-accent/5 transition-colors focus-visible:ring-accent"
                   onclick="closeDrawer()"
                   style="font-size: ${calculateNavSize(node)}rem"
                >
                    ${node.id}
                </a>
            `;
            if (node.children) {
                node.children.forEach(child => {
                    html += renderNavItemsRecursive(child);
                });
            }
            return html;
        }

        function calculateNavSize(node) {
            // Very primitive heuristic for "sub-questions are quieter"
            // Base 0.875rem (text-sm). Recursion logic not strictly tracked here via args, 
            // but for a flattened list we assume top-level is distinct by ID structure in a real app.
            // For this prototype, we'll keep it flat per spec "Hierarchy expressed via type scale only"
            // Since we don't track depth in the recursion easily without pass-through, we rely on the ID length or pattern.
            // Simplification: Keeping strictly flat per spec "all identifiers share the same left edge".
            return 0.875;
        }

        function renderPaperContent(paper, defaultExpanded) {
            let html = '';
            
            if (paper.sections) {
                paper.sections.forEach(section => {
                    if (section.label && section.label.trim()) {
                        html += `<div class="text-xl font-bold text-primary mb-8 border-b border-divider pb-2 mt-12 first:mt-0">${section.label}</div>`;
                    }
                    html += `<div class="flex flex-col gap-12 mb-12">`; // Question list spacing
                    section.questions.forEach(q => {
                        html += renderQuestionNode(q, defaultExpanded);
                    });
                    html += `</div>`;
                });
            } else if (paper.questions) {
                html += `<div class="flex flex-col gap-12">`;
                paper.questions.forEach(q => {
                    html += renderQuestionNode(q, defaultExpanded);
                });
                html += `</div>`;
            }
            return html;
        }

        function renderQuestionNode(node, defaultExpanded) {
            const hasSolutionBlock = !!node.solutionBlock;
            const hasSolutionDetails = hasSolutionBlock && !!node.solutionBlock.solutionDetails;
            
            // Set default state if not set
            if (hasSolutionDetails && !expandedState.has(node.id)) {
                expandedState.set(node.id, defaultExpanded);
            }

            const isExpanded = expandedState.get(node.id);

            // Render content
            const promptHtml = mdRender(node.question);
            
            let solutionBlockHtml = '';
            if (hasSolutionBlock) {
                // Answer
                let answerHtml = '';
                if (node.solutionBlock.answer) {
                    answerHtml = `
                        <div class="mb-4">
                            <div class="text-xs font-bold text-accent uppercase tracking-wider mb-1">Answer</div>
                            <div class="text-primary/90">${mdRender(node.solutionBlock.answer)}</div>
                        </div>
                    `;
                }

                // Solution Details
                let detailsHtml = '';
                if (hasSolutionDetails) {
                    const details = node.solutionBlock.solutionDetails;
                    const controlLabel = isExpanded ? "Hide working" : "Show working";
                    const chevronClass = isExpanded ? "rotate-180" : "";
                    const displayClass = isExpanded ? "block" : "hidden";

                    // Content Subsections
                    let keepInMind = details.keepInMind ? `
                        <div class="mb-4 text-sm text-secondary/90 bg-white/0">
                            <div class="font-bold text-accent text-xs mb-1 flex items-center gap-2">Keep in mind</div>
                            <div class="prose-sm">${mdRender(details.keepInMind)}</div>
                        </div>` : '';

                    let formulas = details.formulasUsed ? `
                        <div class="mb-4 text-sm text-secondary/80">
                            <div class="font-bold text-xs mb-1">Formulas used</div>
                            <div class="font-mono text-xs">${mdRender(details.formulasUsed)}</div>
                        </div>` : '';

                    let working = details.working ? `
                        <div class="mb-6 text-sm text-secondary">
                            <div class="font-bold text-xs mb-2">Working</div>
                            <div class="space-y-4">${mdRender(details.working)}</div>
                        </div>` : '';

                    let altWorking = '';
                    if (details.alternativeWorking) {
                        if (Array.isArray(details.alternativeWorking)) {
                            details.alternativeWorking.forEach((aw, idx) => {
                                altWorking += `
                                    <div class="mt-6 pt-4 border-t border-divider/50 text-sm text-secondary">
                                        <div class="font-bold text-xs mb-2">Alternative working</div>
                                        <div class="space-y-4">${mdRender(aw)}</div>
                                    </div>`;
                            });
                        } else {
                             // Fallback for single string if legacy payload
                             altWorking += `
                                <div class="mt-6 pt-4 border-t border-divider/50 text-sm text-secondary">
                                    <div class="font-bold text-xs mb-2">Alternative working</div>
                                    <div class="space-y-4">${mdRender(details.alternativeWorking)}</div>
                                </div>`;
                        }
                    }

                    detailsHtml = `
                        <div class="mt-4">
                            <button class="toggle-btn text-accent font-medium text-sm flex items-center gap-1 hover:underline focus:outline-none mb-3" 
                                    data-id="${node.id}">
                                <span>${controlLabel}</span>
                                <svg class="w-4 h-4 transition-transform duration-200 ${chevronClass}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </button>
                            <div class="solution-region rounded-sm p-4 bg-wash/30 border-l-2 border-accent/20 ${displayClass}">
                                ${keepInMind}
                                ${formulas}
                                ${working}
                                ${altWorking}
                            </div>
                        </div>
                    `;
                }

                solutionBlockHtml = `
                    <div class="mt-6 pl-0 md:pl-2">
                        ${answerHtml}
                        ${detailsHtml}
                    </div>
                `;
            }

            // Children
            let childrenHtml = '';
            if (node.children && node.children.length > 0) {
                childrenHtml = `<div class="mt-6 ml-0 md:ml-6 flex flex-col gap-6 border-l border-divider/0 pl-0 md:pl-0">`; // Structure only, visual indent via padding
                node.children.forEach(child => {
                    childrenHtml += renderQuestionNode(child, defaultExpanded);
                });
                childrenHtml += `</div>`;
            }

            return `
                <div id="q-${node.id}" class="scroll-mt-24 group">
                    <!-- Question Body -->
                    <div class="flex items-baseline gap-3">
                        <span class="text-secondary font-semibold text-sm select-none w-8 shrink-0 text-right opacity-60">${node.id}</span>
                        <div class="flex-1 text-primary text-base leading-relaxed md:text-lg">
                            ${promptHtml}
                        </div>
                    </div>
                    
                    <!-- Solution Block -->
                    <div class="ml-11">
                        ${solutionBlockHtml}
                    </div>

                    <!-- Recursion -->
                    ${childrenHtml}
                </div>
            `;
        }

        function mdRender(text) {
            if (!text) return '';
            // If markdown-it failed to load, return raw text
            return md ? md.render(text) : text;
        }

        // --- INTERACTION LOGIC ---

        function attachToggleListeners() {
            document.querySelectorAll('.toggle-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = btn.getAttribute('data-id');
                    const current = expandedState.get(id);
                    expandedState.set(id, !current);
                    
                    // Simple re-render of this node's UI state is hard without a framework.
                    // For this vanilla prototype, we'll manually toggle classes and text
                    // to avoid full re-render which loses scroll/focus.
                    
                    const region = btn.nextElementSibling;
                    const span = btn.querySelector('span');
                    const icon = btn.querySelector('svg');

                    if (!current) { // Expanding
                        region.classList.remove('hidden');
                        region.classList.add('block');
                        span.textContent = "Hide working";
                        icon.classList.add('rotate-180');
                    } else { // Collapsing
                        region.classList.remove('block');
                        region.classList.add('hidden');
                        span.textContent = "Show working";
                        icon.classList.remove('rotate-180');
                    }
                });
            });
        }

        function updateToggleUI() {
            // Used after full render if needed, but renderQuestionNode handles init state.
        }

        // --- DRAWER LOGIC ---
        function openDrawer() {
            els.drawer.classList.remove('hidden');
            // Trigger reflow
            void els.drawer.offsetWidth;
            els.drawerScrim.classList.remove('opacity-0');
            els.drawerPanel.classList.remove('translate-x-full');
            document.body.style.overflow = 'hidden';
        }

        function closeDrawer() {
            els.drawerScrim.classList.add('opacity-0');
            els.drawerPanel.classList.add('translate-x-full');
            setTimeout(() => {
                els.drawer.classList.add('hidden');
                document.body.style.overflow = '';
            }, 200);
        }

        els.mobileTrigger.addEventListener('click', openDrawer);
        els.drawerClose.addEventListener('click', closeDrawer);
        els.drawerScrim.addEventListener('click', closeDrawer);

        // --- KEYBOARD NAV ---
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !els.drawer.classList.contains('hidden')) {
                closeDrawer();
            }
        });

        // Start
        init();

    </script>
</body>
</html>
