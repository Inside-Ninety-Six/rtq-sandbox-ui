<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"ABC","indexWithinVariant":"100","totalWithinVariant":"320","hueFamily":"green","intensityMode":"deep_theme","timestamp":"2026-01-07T14:01:32.243Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;ABC&quot;,&quot;indexWithinVariant&quot;:&quot;100&quot;,&quot;totalWithinVariant&quot;:&quot;320&quot;,&quot;hueFamily&quot;:&quot;green&quot;,&quot;intensityMode&quot;:&quot;deep_theme&quot;,&quot;timestamp&quot;:&quot;2026-01-07T14:01:32.243Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer (Stage 6 Baseline)</title>

    <!-- Tailwind CSS (via CDN for prototype speed/utility) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- KaTeX CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- Markdown-it -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <!-- KaTeX JS -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        // Configure Tailwind to use CSS variables for ColorLab compliance
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        page: 'var(--color-page)',
                        frame: 'var(--color-frame)',
                        paper: 'var(--color-paper)',
                        primary: 'var(--color-text-primary)',
                        secondary: 'var(--color-text-secondary)',
                        accent: 'var(--color-accent)',
                        wash: 'var(--color-wash)',
                        border: 'var(--color-border)',
                        focus: 'var(--color-focus)',
                    }
                }
            }
        }
    </script>

    <style>
        /* 
           COLORLAB C: DEEP THEME + GREEN (HUE ~145)
           All values in OKLCH per instruction requirements.
        */
        :root {
            /* Page Background: L~0.95, C~0.10 */
            --color-page: oklch(0.95 0.10 145);
            
            /* Frame Base Surface: L~0.92, C~0.12 */
            --color-frame: oklch(0.92 0.12 145);
            
            /* Paper Surface: L~0.98, C~0.07 */
            --color-paper: oklch(0.98 0.07 145);
            
            /* Text: Neutral-leaning dark green */
            --color-text-primary: oklch(0.20 0.015 145);
            --color-text-secondary: oklch(0.35 0.02 145);
            
            /* Accent: Vibrant green (Links, Focus, UI markers) */
            --color-accent: oklch(0.55 0.20 145);
            --color-focus: oklch(0.55 0.20 145);
            
            /* Structural dividers */
            --color-border: oklch(0.85 0.04 145);
            
            /* Region Wash */
            --color-wash: oklch(0.96 0.08 145);
        }

        body {
            background-color: var(--color-page);
            color: var(--color-text-primary);
        }

        /* Focus Styles (Stage 5.5.2) */
        *:focus-visible {
            outline: 2px solid var(--color-focus);
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* Navigation Scrollbar Hiding (Add-on) */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* KaTeX Containment & Overrides (Stage 6.0.8 & 5.8.4) */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            padding-bottom: 0.5rem; /* space for scrollbar if needed */
            max-width: 100%;
            -webkit-overflow-scrolling: touch;
            margin: 1em 0;
        }
        
        /* Inline math background transparency rule */
        .katex {
            background-color: transparent !important;
        }

        /* Markdown Table Styling (Stage 5.8.5) */
        .md-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            font-size: 0.95em;
        }
        .md-content th, .md-content td {
            border: 1px solid var(--color-border);
            padding: 0.5rem;
            text-align: left;
            vertical-align: top;
        }
        .md-content th {
            font-weight: 600;
        }
        /* Mobile table scroll wrapper handled via container class in render */

        /* Document Shell Layout */
        .document-shell {
            max-width: 1200px;
            margin: 0 auto;
            min-height: 100vh;
            display: grid;
            /* Mobile: 1 col, Desktop: 2 cols (Nav 240px + Content) */
            grid-template-columns: 1fr;
        }
        @media (min-width: 1024px) {
            .document-shell {
                grid-template-columns: 240px minmax(0, 1fr);
                gap: 2rem;
                padding: 0 2rem;
            }
        }
        
        /* Smooth transitions for disclosure */
        .details-region {
            transition: all 0.2s ease-in-out;
            overflow: hidden;
        }

    </style>
</head>
<body class="selection:bg-accent selection:text-white">

    <!-- Top Controls (Aligned to frame shell) -->
    <div class="w-full bg-frame border-b border-border sticky top-0 z-20">
        <div class="max-w-[1200px] mx-auto px-4 lg:px-8 h-14 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <label for="paper-select" class="text-sm font-medium text-secondary">Paper:</label>
                <select id="paper-select" class="bg-paper border border-border rounded px-2 py-1 text-sm focus:border-accent text-primary">
                    <option value="" disabled selected>Loading...</option>
                </select>
            </div>
            
            <!-- Mobile Jump Trigger -->
            <button id="mobile-jump-trigger" class="lg:hidden flex items-center gap-2 text-sm font-medium text-accent hover:text-primary transition-colors">
                <i data-lucide="menu" class="w-4 h-4"></i>
                Jump to
            </button>
        </div>
    </div>

    <!-- Main Content Shell -->
    <div class="bg-frame document-shell">
        
        <!-- Desktop Nav Rail (Sticky) -->
        <aside class="hidden lg:block sticky top-14 h-[calc(100vh-3.5rem)] pt-8 pb-8 overflow-y-auto no-scrollbar">
            <nav id="desktop-nav-list" class="flex flex-col gap-1 text-sm" aria-label="Paper navigation">
                <!-- Injected via JS -->
            </nav>
        </aside>

        <!-- Paper Content Column -->
        <main class="py-8 min-w-0">
            <div id="paper-container" class="bg-paper min-h-[500px] p-6 md:p-12 shadow-sm border border-border/50">
                <!-- Content injected via JS -->
                <div class="flex items-center justify-center h-full text-secondary">Loading Paper Payload...</div>
            </div>
        </main>

    </div>

    <!-- Mobile Navigation Drawer -->
    <div id="mobile-drawer-backdrop" class="fixed inset-0 bg-black/20 backdrop-blur-sm z-40 hidden transition-opacity opacity-0" aria-hidden="true"></div>
    <div id="mobile-drawer" class="fixed inset-y-0 right-0 w-64 bg-paper z-50 transform translate-x-full transition-transform duration-300 shadow-xl flex flex-col" role="dialog" aria-modal="true">
        <div class="flex items-center justify-between p-4 border-b border-border">
            <h2 class="font-medium text-primary">Jump to</h2>
            <button id="drawer-close" class="p-2 text-secondary hover:text-primary">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>
        <div class="flex-1 overflow-y-auto p-4 no-scrollbar">
            <nav id="mobile-nav-list" class="flex flex-col gap-1 text-sm">
                <!-- Injected via JS -->
            </nav>
        </div>
    </div>

    <!-- JS Logic -->
    <script>
        // --- CONSTANTS (Canonical) ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        
        // --- GLOBALS ---
        let currentPayload = null;
        let currentPaper = null;
        let md = null;

        // --- MARKDOWN SETUP (Stage 6 Add-on) ---
        if (window.markdownit) {
            md = window.markdownit({
                html: true,    // Allow inline SVG passthrough
                linkify: true,
                breaks: false  // CRITICAL: prevents <br> inside math delimiters
            });
            // CRITICAL: Disable escape rule to preserve TeX backslashes
            md.inline.ruler.disable(['escape']);
        }

        // --- DOM ELEMENTS ---
        const els = {
            paperSelect: document.getElementById('paper-select'),
            paperContainer: document.getElementById('paper-container'),
            desktopNav: document.getElementById('desktop-nav-list'),
            mobileNav: document.getElementById('mobile-nav-list'),
            mobileJumpTrigger: document.getElementById('mobile-jump-trigger'),
            mobileDrawer: document.getElementById('mobile-drawer'),
            mobileDrawerBackdrop: document.getElementById('mobile-drawer-backdrop'),
            drawerClose: document.getElementById('drawer-close'),
        };

        // --- INITIALIZATION ---
        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Network response was not ok");
                
                currentPayload = await response.json();
                
                populatePaperSelector();
                
                // Load first paper by default
                if (currentPayload.papers && currentPayload.papers.length > 0) {
                    loadPaper(currentPayload.papers[0].key);
                } else {
                    renderError("No papers found in payload.");
                }

            } catch (error) {
                console.error("Payload loading failed:", error);
                renderError("PAPERS PAYLOAD MISSING");
            }

            setupEventHandlers();
        }

        function renderError(msg) {
            els.paperContainer.innerHTML = `<div class="text-center py-20 text-secondary font-medium tracking-wide">${msg}</div>`;
            els.paperSelect.innerHTML = `<option disabled selected>Error</option>`;
        }

        function populatePaperSelector() {
            els.paperSelect.innerHTML = '';
            currentPayload.papers.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.key;
                opt.textContent = p.label || p.key;
                els.paperSelect.appendChild(opt);
            });
        }

        function loadPaper(paperKey) {
            currentPaper = currentPayload.papers.find(p => p.key === paperKey);
            if (!currentPaper) return;

            // Reset Scroll
            window.scrollTo(0,0);

            // Re-render
            renderContent();
            renderNavigation();
            
            // Re-initialize icons
            lucide.createIcons();
            
            // Re-render Math
            renderMath();
        }

        // --- CONTENT RENDERING ---

        function renderContent() {
            if (!currentPaper) return;

            const contentHTML = [];

            // Helper to determine question structure
            const questions = currentPaper.questions || [];
            const sections = currentPaper.sections || [];

            // Defaults
            const expandAll = currentPaper.defaults?.expandedAll !== false; // Default true unless explicitly false

            // If flat questions
            if (questions.length > 0) {
                questions.forEach((q, idx) => {
                    contentHTML.push(renderQuestionNode(q, 0, expandAll, idx === 0));
                });
            } 
            // If sectioned
            else if (sections.length > 0) {
                sections.forEach((sec, idx) => {
                    // Render section header (structural separator)
                    // Stage 3: Section label shown only if non-empty
                    if (sec.label && sec.label.trim().length > 0) {
                        contentHTML.push(`
                            <div class="mt-12 mb-6 border-b border-border pb-2">
                                <h2 class="text-lg font-semibold text-primary">${sec.label}</h2>
                            </div>
                        `);
                    }
                    sec.questions.forEach((q, qIdx) => {
                        contentHTML.push(renderQuestionNode(q, 0, expandAll, idx === 0 && qIdx === 0));
                    });
                });
            }

            els.paperContainer.innerHTML = contentHTML.join('');
        }

        // Recursive Question Node Renderer
        function renderQuestionNode(node, depth, defaultExpanded, isFirst) {
            // Derived State
            const hasSolutionBlock = !!node.solutionBlock;
            const answerStr = node.solutionBlock?.answer;
            const detailsObj = node.solutionBlock?.solutionDetails;
            const hasSolutionDetails = !!detailsObj;
            
            // Unique ID for toggle
            const toggleId = `toggle-${node.id.replace(/[^a-zA-Z0-9]/g, '-')}-${Math.random().toString(36).substr(2,9)}`;
            
            // Spacing logic (Stage 5.1/5.2)
            // Top level gets largest spacing. Children get less.
            let containerClass = "relative";
            if (depth === 0) {
                containerClass += isFirst ? " mb-12" : " mt-16 mb-12 border-t border-border/30 pt-12"; 
            } else {
                containerClass += " mt-6 pl-4 md:pl-8 border-l border-border/50"; // Indentation via border/padding
            }

            let html = `<div id="q-${node.id}" class="${containerClass} scroll-mt-24 group">`;

            // 1. Question Body
            html += `<div class="question-body mb-4">`;
                // Identifier + Prompt
                html += `<div class="flex items-baseline gap-3">`;
                    html += `<span class="text-secondary font-medium text-sm select-none shrink-0 w-8 md:w-10 text-right">${node.id}</span>`;
                    html += `<div class="text-primary font-medium text-lg leading-relaxed md-content">${md ? md.render(node.question || "") : node.question}</div>`;
                html += `</div>`;
            html += `</div>`;

            // 2. Solution Block (Optional)
            if (hasSolutionBlock) {
                html += `<div class="solution-block pl-11 md:pl-14">`;

                // Answer (Optional)
                if (answerStr) {
                    html += `<div class="mb-3">`;
                        html += `<div class="text-xs font-bold text-secondary uppercase tracking-wider mb-1">Answer</div>`;
                        html += `<div class="text-primary md-content">${md ? md.render(answerStr) : answerStr}</div>`;
                    html += `</div>`;
                }

                // Solution Details (Optional)
                if (hasSolutionDetails) {
                    // Toggle Control
                    const isExpanded = defaultExpanded;
                    const btnText = isExpanded ? "Hide working" : "Show working";
                    const iconClass = isExpanded ? "rotate-180" : "";
                    const regionStyle = isExpanded ? "" : "display: none;";

                    html += `<button 
                        class="toggle-btn flex items-center gap-1.5 text-sm font-medium text-accent hover:text-focus transition-colors mt-3 mb-2 focus:outline-none"
                        aria-expanded="${isExpanded}"
                        aria-controls="${toggleId}"
                        onclick="toggleDetails('${toggleId}', this)"
                    >`;
                        html += `<span>${btnText}</span>`;
                        html += `<i data-lucide="chevron-down" class="w-4 h-4 transition-transform duration-200 ${iconClass}"></i>`;
                    html += `</button>`;

                    // Details Region
                    html += `<div id="${toggleId}" class="details-region bg-wash rounded-sm -ml-2 -mr-2 px-4 py-4 mt-2 border-l-2 border-accent/20" style="${regionStyle}">`;
                        
                        // Keep In Mind
                        if (detailsObj.keepInMind) {
                            html += `<div class="mb-5">`;
                                html += `<div class="text-xs font-bold text-accent uppercase tracking-wider mb-2 flex items-center gap-2"><i data-lucide="lightbulb" class="w-3 h-3"></i> Keep in mind</div>`;
                                html += `<div class="text-sm text-primary/90 md-content space-y-1">${md ? md.render(detailsObj.keepInMind) : detailsObj.keepInMind}</div>`;
                            html += `</div>`;
                        }

                        // Formulas Used
                        if (detailsObj.formulasUsed) {
                            html += `<div class="mb-5">`;
                                html += `<div class="text-xs font-bold text-secondary uppercase tracking-wider mb-2">Formulas used</div>`;
                                html += `<div class="text-sm text-secondary md-content">${md ? md.render(detailsObj.formulasUsed) : detailsObj.formulasUsed}</div>`;
                            html += `</div>`;
                        }

                        // Working (Primary)
                        if (detailsObj.working) {
                            html += `<div class="mb-6">`;
                                html += `<div class="text-xs font-bold text-secondary uppercase tracking-wider mb-2">Working</div>`;
                                html += `<div class="text-base text-primary md-content leading-relaxed space-y-3">${md ? md.render(detailsObj.working) : detailsObj.working}</div>`;
                            html += `</div>`;
                        }

                        // Alternative Working (Array)
                        if (detailsObj.alternativeWorking && Array.isArray(detailsObj.alternativeWorking)) {
                            detailsObj.alternativeWorking.forEach((alt, idx) => {
                                html += `<div class="mt-6 pt-4 border-t border-border/50">`;
                                    html += `<div class="text-xs font-bold text-secondary uppercase tracking-wider mb-2">Alternative working</div>`;
                                    html += `<div class="text-base text-primary md-content leading-relaxed space-y-3">${md ? md.render(alt) : alt}</div>`;
                                html += `</div>`;
                            });
                        }

                    html += `</div>`;
                }

                html += `</div>`; // End Solution Block
            }

            // 3. Children (Recursive)
            if (node.children && node.children.length > 0) {
                html += `<div class="children-container mt-4">`;
                node.children.forEach(child => {
                    html += renderQuestionNode(child, depth + 1, defaultExpanded, false);
                });
                html += `</div>`;
            }

            html += `</div>`;
            return html;
        }

        // --- NAVIGATION RENDERING ---

        function renderNavigation() {
            const items = [];
            const questions = currentPaper.questions || [];
            const sections = currentPaper.sections || [];

            // Flat list generator
            if (questions.length > 0) {
                questions.forEach(q => collectNavItems(q, items));
            } else if (sections.length > 0) {
                sections.forEach(sec => {
                    if (sec.label && sec.label.trim().length > 0) {
                        items.push({ type: 'section', label: sec.label });
                    }
                    sec.questions.forEach(q => collectNavItems(q, items));
                });
            }

            const html = items.map(item => {
                if (item.type === 'section') {
                    return `<div class="px-4 py-3 mt-2 text-xs font-bold text-secondary/60 uppercase tracking-widest pointer-events-none">${item.label}</div>`;
                }
                // Identifier Item
                // Hierarchy via type scale: top level normal, children smaller/lighter
                const isChild = item.id.length > 2 || item.id.includes('('); 
                const baseClass = "block px-4 py-1.5 border-l-2 border-transparent transition-colors hover:border-accent/50 hover:text-primary";
                const typeClass = isChild ? "text-secondary font-normal text-xs" : "text-primary font-medium text-sm";
                
                return `<a href="#q-${item.id}" 
                           class="nav-item ${baseClass} ${typeClass}" 
                           onclick="handleNavClick(event, 'q-${item.id}')">
                            ${item.id}
                        </a>`;
            }).join('');

            els.desktopNav.innerHTML = html;
            els.mobileNav.innerHTML = html;
            
            // Intersection Observer for Active State
            setupScrollSpy();
        }

        function collectNavItems(node, list) {
            list.push({ type: 'item', id: node.id });
            if (node.children) {
                node.children.forEach(c => collectNavItems(c, list));
            }
        }

        // --- INTERACTION ---

        window.toggleDetails = function(targetId, btn) {
            const target = document.getElementById(targetId);
            if (!target) return;
            
            const isHidden = target.style.display === 'none';
            
            if (isHidden) {
                target.style.display = 'block';
                btn.setAttribute('aria-expanded', 'true');
                btn.querySelector('span').textContent = 'Hide working';
                btn.querySelector('i').classList.add('rotate-180');
            } else {
                target.style.display = 'none';
                btn.setAttribute('aria-expanded', 'false');
                btn.querySelector('span').textContent = 'Show working';
                btn.querySelector('i').classList.remove('rotate-180');
            }
        };

        window.handleNavClick = function(e, targetId) {
            e.preventDefault();
            const el = document.getElementById(targetId);
            if (el) {
                // Scroll with offset for sticky header
                const offset = 80; 
                const bodyRect = document.body.getBoundingClientRect().top;
                const elementRect = el.getBoundingClientRect().top;
                const elementPosition = elementRect - bodyRect;
                const offsetPosition = elementPosition - offset;

                window.scrollTo({
                    top: offsetPosition,
                    behavior: "smooth"
                });

                closeDrawer();
            }
        };

        function setupEventHandlers() {
            // Paper Switch
            els.paperSelect.addEventListener('change', (e) => {
                loadPaper(e.target.value);
            });

            // Mobile Drawer
            els.mobileJumpTrigger.addEventListener('click', openDrawer);
            els.drawerClose.addEventListener('click', closeDrawer);
            els.mobileDrawerBackdrop.addEventListener('click', closeDrawer);
        }

        function openDrawer() {
            els.mobileDrawer.classList.remove('translate-x-full');
            els.mobileDrawerBackdrop.classList.remove('hidden');
            // Small delay for fade in
            requestAnimationFrame(() => els.mobileDrawerBackdrop.classList.remove('opacity-0'));
            document.body.style.overflow = 'hidden';
        }

        function closeDrawer() {
            els.mobileDrawer.classList.add('translate-x-full');
            els.mobileDrawerBackdrop.classList.add('opacity-0');
            setTimeout(() => {
                els.mobileDrawerBackdrop.classList.add('hidden');
            }, 300);
            document.body.style.overflow = '';
        }

        function setupScrollSpy() {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const id = entry.target.id.replace('q-', '');
                        updateActiveNav(id);
                    }
                });
            }, { rootMargin: '-10% 0px -80% 0px' });

            document.querySelectorAll('[id^="q-"]').forEach(el => observer.observe(el));
        }

        function updateActiveNav(id) {
            document.querySelectorAll('.nav-item').forEach(el => {
                // Reset
                el.classList.remove('border-accent', 'text-accent', 'font-bold');
                el.classList.add('border-transparent');
                
                // Set Active
                if (el.getAttribute('href') === `#q-${id}`) {
                    el.classList.remove('border-transparent', 'text-secondary');
                    el.classList.add('border-accent', 'text-accent', 'font-bold');
                }
            });
        }

        function renderMath() {
            renderMathInElement(els.paperContainer, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false},
                    {left: '\\(', right: '\\)', display: false},
                    {left: '\\[', right: '\\]', display: true}
                ],
                throwOnError: false,
                output: 'html', // Use HTML output
                trust: true     // Allow basic commands
            });
        }

        // Initialize App
        init();

    </script>
</body>
</html>
