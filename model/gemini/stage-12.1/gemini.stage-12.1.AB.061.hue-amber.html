<!DOCTYPE html>
<html lang="en" class="antialiased">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AB","indexWithinVariant":"61","totalWithinVariant":"200","hueFamily":"amber","intensityMode":"","timestamp":"2026-01-06T22:59:15.316Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AB&quot;,&quot;indexWithinVariant&quot;:&quot;61&quot;,&quot;totalWithinVariant&quot;:&quot;200&quot;,&quot;hueFamily&quot;:&quot;amber&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-06T22:59:15.316Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer (Prototype)</title>

    <!-- FONTS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- TAILWIND CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        // COLORLAB B: AMBER THEME FORCE
                        // Base neutrals (Warm/Paper-like per Stage 5.3.1)
                        bg: '#FDFBF9', // Very subtle warm off-white
                        surface: '#FFFFFF',
                        surface_alt: '#F9F6F3', // Slightly darker warm neutral for demarcations
                        
                        // Text
                        txt: {
                            primary: '#1A1918',
                            secondary: '#504E4B',
                            tertiary: '#85817D',
                            quaternary: '#A8A4A1', // Nav inactive
                        },

                        // Border
                        border: {
                            light: '#EBE8E4',
                            medium: '#D6D3D0',
                        },

                        // Accent (Amber) - Used for focus, active nav, links
                        accent: {
                            50: '#FFFBEB',
                            100: '#FEF3C7',
                            200: '#FDE68A',
                            300: '#FCD34D',
                            400: '#FBBF24',
                            500: '#F59E0B', // Primary Amber
                            600: '#D97706',
                            700: '#B45309',
                        }
                    },
                    spacing: {
                        'layout-gap': '3rem', // Gap between nav and paper
                        'q-gap': '4rem',      // Top level question gap
                    }
                }
            }
        }
    </script>

    <!-- KATEX (CDN) - No Integrity attributes per Stage 6.0.7b -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- MARKDOWN-IT (CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <style>
        /* BASE & SCROLLING */
        html, body {
            height: 100%;
            background-color: theme('colors.bg');
            color: theme('colors.txt.primary');
            scroll-behavior: smooth;
        }

        /* STAGE 5.3.6: Contrast Ceiling Enforcement */
        /* Question text is #1A1918 (900 equiv). Nothing should be darker/heavier. */

        /* NAVIGATION SCROLLBAR HIDING (Stage 3 Add-on) */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* KATEX CONTAINMENT INVARIANT (Stage 6.0.8) */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 4px; /* Space for scrollbar if needed */
            margin: 0.5em 0;
        }
        
        /* INLINE KATEX BACKGROUND RULE (Stage 5.8.4) */
        .katex {
            background-color: transparent !important;
        }
        
        /* Block math underlay (Optional Stage 3 cue) */
        .katex-display > .katex {
            background-color: transparent; /* Clean look preferred in ColorLab B */
        }

        /* MARKDOWN TABLE STYLING (Stage 5.8.5) */
        .md-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 1em 0;
            font-size: 0.95em;
        }
        .md-content th, .md-content td {
            border: 1px solid theme('colors.border.light');
            padding: 0.5em 0.75em;
            text-align: left;
            vertical-align: top;
        }
        .md-content th {
            font-weight: 600;
            color: theme('colors.txt.secondary');
        }

        /* MARKDOWN CONTENT TYPOGRAPHY */
        .md-content p {
            margin-bottom: 0.75em;
            line-height: 1.6;
        }
        .md-content p:last-child {
            margin-bottom: 0;
        }
        .md-content ul {
            list-style-type: disc;
            padding-left: 1.25em;
            margin-bottom: 0.75em;
        }
        .md-content ol {
            list-style-type: decimal;
            padding-left: 1.25em;
            margin-bottom: 0.75em;
        }
        
        /* SVG Passthrough Sizing */
        .md-content svg {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 1rem 0;
        }

        /* FOCUS STATES (Stage 5.5.2) */
        :focus-visible {
            outline: 2px solid theme('colors.accent.500');
            outline-offset: 2px;
        }

        /* ANIMATIONS (Stage 5.5.3 - Continuity) */
        .details-wrapper {
            display: grid;
            grid-template-rows: 0fr;
            transition: grid-template-rows 0.3s ease-out;
            overflow: hidden;
        }
        .details-wrapper.open {
            grid-template-rows: 1fr;
        }
        .details-inner {
            min-height: 0;
        }

        /* DRAWER (Mobile) */
        .drawer-overlay {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }
        .drawer-overlay.open {
            opacity: 1;
            pointer-events: auto;
        }
        .drawer-panel {
            transform: translateX(-100%);
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .drawer-panel.open {
            transform: translateX(0);
        }

    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- TOP CONTROLS REGION -->
    <!-- Aligned to shell via max-width container -->
    <header class="w-full bg-bg z-30 pt-4 pb-2 border-b border-transparent sticky top-0">
        <div class="max-w-[1200px] mx-auto px-4 md:px-8 flex items-center justify-between h-12">
            
            <!-- Paper Selector -->
            <div class="relative">
                <label for="paper-selector" class="sr-only">Select Paper</label>
                <select id="paper-selector" class="appearance-none bg-surface border border-border-medium text-txt-primary py-1.5 pl-3 pr-8 rounded-md text-sm font-medium hover:border-accent-400 focus:border-accent-500 transition-colors cursor-pointer">
                    <option value="" disabled selected>Loading papers...</option>
                </select>
                <!-- Custom Arrow -->
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-txt-secondary">
                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </div>
            </div>

            <!-- Mobile Jump To Trigger -->
            <button id="jump-to-trigger" class="md:hidden flex items-center gap-2 text-sm font-medium text-txt-secondary hover:text-accent-600 transition-colors px-3 py-1.5 rounded-md hover:bg-accent-50">
                <span class="text-accent-600 font-semibold">Jump to</span>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
            </button>
        </div>
    </header>

    <!-- DOCUMENT FRAME SHELL -->
    <main class="flex-grow w-full max-w-[1200px] mx-auto px-4 md:px-8 flex gap-layout-gap relative">

        <!-- NAVIGATION RAIL (Desktop) -->
        <!-- Stage 5.4: Subordinate, shared surface, flat list, identifier-only -->
        <aside class="hidden md:block w-48 flex-shrink-0 sticky top-20 h-[calc(100vh-6rem)] overflow-hidden">
            <nav class="h-full flex flex-col" aria-label="Question navigation">
                <!-- List container with hidden scrollbar -->
                <div id="desktop-nav-list" class="flex-1 overflow-y-auto no-scrollbar py-2 space-y-1">
                    <!-- Injected via JS -->
                </div>
            </nav>
        </aside>

        <!-- PAPER CONTENT COLUMN -->
        <div class="flex-1 min-w-0 pb-32">
            <div id="paper-content" class="space-y-q-gap pt-4">
                <!-- Content Injected via JS -->
                <div class="flex items-center justify-center h-64 text-txt-tertiary animate-pulse">
                    Loading Paper...
                </div>
            </div>
        </div>

    </main>

    <!-- MOBILE NAVIGATION DRAWER -->
    <div id="mobile-drawer-overlay" class="fixed inset-0 bg-black/20 z-40 drawer-overlay backdrop-blur-[1px]" aria-hidden="true"></div>
    <div id="mobile-drawer-panel" class="fixed inset-y-0 left-0 w-64 bg-surface shadow-xl z-50 drawer-panel flex flex-col" aria-hidden="true">
        <div class="flex items-center justify-between p-4 border-b border-border-light">
            <h2 class="text-lg font-semibold text-txt-primary">Jump to</h2>
            <button id="close-drawer" class="p-2 text-txt-secondary hover:text-txt-primary rounded-md hover:bg-border-light transition-colors">
                <span class="sr-only">Close navigation</span>
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <nav class="flex-1 overflow-y-auto p-2" aria-label="Mobile question navigation">
            <div id="mobile-nav-list" class="space-y-1">
                <!-- Injected via JS -->
            </div>
        </nav>
    </div>

    <!-- SCRIPTS -->
    <script>
        // --- CONSTANTS (Canonical v1.0) ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // --- STATE ---
        let payloadData = null;
        let currentPaper = null;
        let markdownRenderer = null;

        // --- DOM ELEMENTS ---
        const els = {
            paperSelector: document.getElementById('paper-selector'),
            paperContent: document.getElementById('paper-content'),
            desktopNavList: document.getElementById('desktop-nav-list'),
            mobileNavList: document.getElementById('mobile-nav-list'),
            jumpToTrigger: document.getElementById('jump-to-trigger'),
            drawerOverlay: document.getElementById('mobile-drawer-overlay'),
            drawerPanel: document.getElementById('mobile-drawer-panel'),
            closeDrawerBtn: document.getElementById('close-drawer'),
        };

        // --- MARKDOWN SETUP ---
        // Stage 6 add-on requirements: html: true, breaks: false, escape disabled
        function initMarkdown() {
            if (window.markdownit) {
                markdownRenderer = window.markdownit({
                    html: true,
                    linkify: true,
                    breaks: false
                });
                // Disable escape to preserve TeX backslashes
                markdownRenderer.inline.ruler.disable(['escape']);
            } else {
                console.error("Markdown-it not loaded");
            }
        }

        // --- DATA FETCHING ---
        async function loadPayload() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Fetch failed");
                const data = await response.json();
                payloadData = data;
                initPaperSelector();
            } catch (err) {
                renderErrorState();
                console.error(err);
            }
        }

        function renderErrorState() {
            els.paperContent.innerHTML = `
                <div class="p-8 text-center border border-border-medium rounded-lg bg-surface text-txt-secondary">
                    <h1 class="text-xl font-bold mb-2 text-txt-primary">PAPERS PAYLOAD MISSING</h1>
                    <p>Unable to load content from canonical path.</p>
                </div>
            `;
            els.paperSelector.innerHTML = '<option disabled>Error loading papers</option>';
        }

        // --- PAPER SELECTOR ---
        function initPaperSelector() {
            if (!payloadData || !payloadData.papers) return;
            
            els.paperSelector.innerHTML = '';
            payloadData.papers.forEach((paper, index) => {
                const opt = document.createElement('option');
                opt.value = index; // Use index to reference paper easily
                opt.textContent = paper.label || paper.key;
                els.paperSelector.appendChild(opt);
            });

            // Initial render
            els.paperSelector.addEventListener('change', (e) => {
                const paperIndex = parseInt(e.target.value, 10);
                renderPaper(payloadData.papers[paperIndex]);
            });

            // Trigger first paper
            renderPaper(payloadData.papers[0]);
        }

        // --- RENDER PIPELINE ---
        function renderPaper(paper) {
            currentPaper = paper;
            
            // 1. Clear Views
            els.paperContent.innerHTML = '';
            els.desktopNavList.innerHTML = '';
            els.mobileNavList.innerHTML = '';
            window.scrollTo(0, 0);

            // 2. Determine Structure (Sectioned vs Flat)
            // Flatten questions for rendering linear document, but keep structure for nav
            const isSectioned = !!paper.sections;
            let flatQuestionList = [];
            
            // Build the paper DOM
            if (isSectioned) {
                paper.sections.forEach(section => {
                    // Render Section Header if label exists
                    if (section.label && section.label.trim() !== "") {
                        const secHeader = document.createElement('div');
                        secHeader.className = "pt-8 pb-4 border-b border-border-light mb-8";
                        secHeader.innerHTML = `<h2 class="text-xl font-bold text-txt-primary">${section.label}</h2>`;
                        els.paperContent.appendChild(secHeader);
                        
                        // Add non-clickable separator to Nav
                        addNavSectionLabel(section.label);
                    }
                    
                    // Render Questions
                    section.questions.forEach(q => {
                        els.paperContent.appendChild(createQuestionNode(q, 0, paper.defaults));
                        addNavItem(q);
                    });
                });
            } else {
                // Flat structure
                if (paper.questions) {
                    paper.questions.forEach(q => {
                        els.paperContent.appendChild(createQuestionNode(q, 0, paper.defaults));
                        addNavItem(q);
                    });
                }
            }

            // 3. Post-Render: KaTeX
            renderMathInElement(els.paperContent, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false}
                ],
                throwOnError: false
            });

            // 4. Setup Scroll Spy for Navigation
            setupIntersectionObserver();
        }

        // --- NAVIGATION BUILDER ---
        function addNavSectionLabel(label) {
            const el = document.createElement('div');
            el.className = "px-3 py-2 text-xs font-bold text-txt-quaternary uppercase tracking-wider mt-4 first:mt-0 select-none cursor-default";
            el.textContent = label;
            
            const mobEl = el.cloneNode(true);
            
            els.desktopNavList.appendChild(el);
            els.mobileNavList.appendChild(mobEl);
        }

        function addNavItem(question) {
            // Helper recursive for sub-questions if needed for nav (Stage 3 says identifiers only)
            // Stage 5.4.5: Flat list. Hierarchy via type scale only.
            
            function createLink(q, depth) {
                const id = q.id;
                const link = document.createElement('a');
                link.href = `#q-${id}`;
                // Stage 5.4.5: Flat list, same left edge.
                // Depth expressed via font size/color subtlety.
                // Top level: Text-sm, Primary. Sub: Text-xs, Secondary.
                
                const baseClasses = "block px-3 py-1.5 rounded-md transition-colors text-left truncate focus-visible:ring-2 focus-visible:ring-accent-500 outline-none";
                const depthClasses = depth === 0 
                    ? "text-sm text-txt-secondary hover:text-txt-primary hover:bg-surface_alt font-medium" 
                    : "text-xs text-txt-tertiary hover:text-txt-primary hover:bg-surface_alt";

                link.className = `${baseClasses} ${depthClasses} nav-item`;
                link.dataset.targetId = `q-${id}`;
                link.textContent = id;
                
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const target = document.getElementById(`q-${id}`);
                    if (target) {
                        // Smooth scroll with offset for sticky header
                        const y = target.getBoundingClientRect().top + window.scrollY - 80;
                        window.scrollTo({top: y, behavior: 'smooth'});
                        closeDrawer();
                    }
                });

                return link;
            }

            // Recursive add to nav
            function processNavNode(node, depth) {
                const link = createLink(node, depth);
                els.desktopNavList.appendChild(link);
                els.mobileNavList.appendChild(link.cloneNode(true)); // Clone for mobile

                if (node.children && node.children.length > 0) {
                    node.children.forEach(child => processNavNode(child, depth + 1));
                }
            }

            processNavNode(question, 0);
        }

        // --- CONTENT BUILDER ---
        function createQuestionNode(node, depth, paperDefaults) {
            const container = document.createElement('div');
            container.id = `q-${node.id}`;
            // Stage 3 Spacing: 
            // Top-level: large gap (handled by space-y on parent).
            // Sub-questions: vertical separation (less than top level).
            
            if (depth > 0) {
                container.className = "mt-8 pl-0 md:pl-6 border-l-2 border-transparent md:border-border-light"; // Indentation logic via border/padding on desktop
            } else {
                container.className = "group relative scroll-mt-24"; // Scroll margin for sticky header
            }

            // 1. Question Body
            const qBody = document.createElement('div');
            qBody.className = "mb-4";
            
            // Identifier
            const qId = document.createElement('span');
            qId.className = "inline-block text-sm font-bold text-txt-secondary mb-1 mr-2 bg-surface_alt px-1.5 rounded";
            qId.textContent = node.id;
            
            // Prompt (Markdown)
            const qPrompt = document.createElement('div');
            qPrompt.className = "text-lg text-txt-primary font-medium leading-relaxed md-content";
            qPrompt.innerHTML = mdRender(node.question);

            qBody.appendChild(qId);
            qBody.appendChild(qPrompt);
            container.appendChild(qBody);

            // 2. Solution Block (Optional)
            if (node.solutionBlock) {
                const sb = node.solutionBlock;
                const hasAnswer = !!sb.answer;
                const hasDetails = !!sb.solutionDetails;

                // Wrapper
                const sbWrapper = document.createElement('div');
                sbWrapper.className = "mt-4 ml-0 md:ml-2"; 

                // A. Answer (Visible by default)
                if (hasAnswer) {
                    const ansRow = document.createElement('div');
                    ansRow.className = "mb-3 text-txt-primary";
                    ansRow.innerHTML = `
                        <span class="text-xs font-bold text-accent-600 uppercase tracking-wide block mb-1">Answer</span>
                        <div class="md-content text-base">${mdRender(sb.answer)}</div>
                    `;
                    sbWrapper.appendChild(ansRow);
                }

                // B. Solution Details (Expandable)
                if (hasDetails) {
                    // Divider (Quiet hairline) if answer exists
                    if (hasAnswer) {
                        const div = document.createElement('hr');
                        div.className = "border-t border-border-light my-3";
                        sbWrapper.appendChild(div);
                    }

                    // Default State
                    const isExpandedDefault = paperDefaults?.expandedAll !== false; // Default true unless false
                    
                    // Disclosure Control
                    const toggleBtn = document.createElement('button');
                    toggleBtn.className = "flex items-center gap-2 text-sm font-medium text-accent-600 hover:text-accent-700 transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-accent-500 rounded px-1 -ml-1 py-1";
                    
                    const updateToggleText = (isOpen) => {
                        toggleBtn.innerHTML = `
                            <span>${isOpen ? 'Hide working' : 'Show working'}</span>
                            <svg class="w-4 h-4 transition-transform duration-200 ${isOpen ? 'rotate-180' : ''}" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        `;
                    };
                    updateToggleText(isExpandedDefault);

                    // Content Wrapper (for animation)
                    const detailsWrapper = document.createElement('div');
                    detailsWrapper.className = `details-wrapper ${isExpandedDefault ? 'open' : ''}`;
                    
                    const detailsInner = document.createElement('div');
                    detailsInner.className = "details-inner pt-3 pl-2 border-l-2 border-border-light"; // Minimal indentation line

                    // Render Subsections
                    const sd = sb.solutionDetails;
                    
                    // Keep In Mind
                    if (sd.keepInMind) {
                        detailsInner.appendChild(createDetailSection('Keep in mind', sd.keepInMind, 'mb-4 text-sm text-txt-secondary'));
                    }
                    // Formulas Used
                    if (sd.formulasUsed) {
                        detailsInner.appendChild(createDetailSection('Formulas used', sd.formulasUsed, 'mb-4 text-sm font-mono text-txt-secondary bg-surface_alt p-2 rounded'));
                    }
                    // Working (Primary)
                    if (sd.working) {
                        detailsInner.appendChild(createDetailSection('Working', sd.working, 'mb-4 text-base text-txt-secondary'));
                    }
                    // Alternative Working
                    if (sd.alternativeWorking && Array.isArray(sd.alternativeWorking)) {
                        sd.alternativeWorking.forEach((alt, idx) => {
                            // Separator
                            const sep = document.createElement('hr');
                            sep.className = "border-t border-dashed border-border-medium my-4 w-1/2";
                            detailsInner.appendChild(sep);
                            detailsInner.appendChild(createDetailSection('Alternative working', alt, 'mb-4 text-base text-txt-secondary'));
                        });
                    }

                    detailsWrapper.appendChild(detailsInner);

                    // Interaction
                    toggleBtn.onclick = () => {
                        const isOpen = detailsWrapper.classList.toggle('open');
                        updateToggleText(isOpen);
                    };

                    sbWrapper.appendChild(toggleBtn);
                    sbWrapper.appendChild(detailsWrapper);
                }

                container.appendChild(sbWrapper);
            }

            // 3. Children (Recursive)
            if (node.children && node.children.length > 0) {
                const childWrapper = document.createElement('div');
                childWrapper.className = "mt-6 space-y-6";
                node.children.forEach(child => {
                    childWrapper.appendChild(createQuestionNode(child, depth + 1, paperDefaults));
                });
                container.appendChild(childWrapper);
            }

            return container;
        }

        function createDetailSection(label, markdown, wrapperClasses) {
            const div = document.createElement('div');
            div.className = wrapperClasses;
            div.innerHTML = `
                <div class="text-xs font-bold text-txt-tertiary uppercase tracking-wider mb-1">${label}</div>
                <div class="md-content">${mdRender(markdown)}</div>
            `;
            return div;
        }

        function mdRender(text) {
            if (!markdownRenderer) return text;
            return markdownRenderer.render(text || '');
        }

        // --- INTERSECTION OBSERVER (Active Nav State) ---
        function setupIntersectionObserver() {
            // Unobserve old if exists (simplified for prototype: create new each paper load)
            const options = {
                root: null,
                rootMargin: '-10% 0px -80% 0px', // Active when element is near top
                threshold: 0
            };

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        updateActiveNav(entry.target.id);
                    }
                });
            }, options);

            // Observe all question containers
            document.querySelectorAll('[id^="q-"]').forEach(el => observer.observe(el));
        }

        function updateActiveNav(targetId) {
            // Desktop & Mobile lists
            const allLinks = document.querySelectorAll('.nav-item');
            allLinks.forEach(link => {
                const isActive = link.dataset.targetId === targetId;
                if (isActive) {
                    // Active state: ColorLab B - Amber text + bold (weight-only per baseline lock, reinforced by color per override)
                    link.classList.remove('text-txt-secondary', 'text-txt-tertiary', 'font-medium');
                    link.classList.add('text-accent-700', 'font-bold', 'bg-accent-50');
                    
                    // Scroll nav into view if needed
                    if(link.offsetParent !== null) { // if visible
                       link.scrollIntoView({block: "nearest", behavior: "smooth"});
                    }
                } else {
                    link.classList.remove('text-accent-700', 'font-bold', 'bg-accent-50');
                    // Reset to depth defaults is complex here, simplifying to generic inactive
                    // (Production would store original classes)
                    if (link.classList.contains('text-sm')) {
                         link.classList.add('text-txt-secondary', 'font-medium');
                    } else {
                         link.classList.add('text-txt-tertiary');
                    }
                }
            });
        }

        // --- MOBILE DRAWER LOGIC ---
        function openDrawer() {
            els.drawerOverlay.classList.remove('hidden');
            // Trigger reflow
            void els.drawerOverlay.offsetWidth;
            els.drawerOverlay.classList.add('open');
            els.drawerPanel.classList.add('open');
            document.body.style.overflow = 'hidden';
        }

        function closeDrawer() {
            els.drawerOverlay.classList.remove('open');
            els.drawerPanel.classList.remove('open');
            setTimeout(() => {
                document.body.style.overflow = '';
            }, 300);
        }

        els.jumpToTrigger.addEventListener('click', openDrawer);
        els.closeDrawerBtn.addEventListener('click', closeDrawer);
        els.drawerOverlay.addEventListener('click', closeDrawer);

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            initMarkdown();
            loadPayload();
        });

    </script>
</body>
</html>
