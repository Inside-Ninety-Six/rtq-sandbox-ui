<!DOCTYPE html>
<html lang="en" class="light">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AB","indexWithinVariant":"74","totalWithinVariant":"200","hueFamily":"blue","intensityMode":"","timestamp":"2026-01-06T23:32:34.788Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AB&quot;,&quot;indexWithinVariant&quot;:&quot;74&quot;,&quot;totalWithinVariant&quot;:&quot;200&quot;,&quot;hueFamily&quot;:&quot;blue&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-06T23:32:34.788Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>
    
    <!-- Dependencies (Stage 6 Add-ons + Baseline) -->
    
    <!-- Tailwind CSS (Rapid styling prototype) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class', // Light mode only enforced by ColorLab A
            theme: {
                extend: {
                    colors: {
                        // ColorLab B: Forced Hue Family = Blue
                        // Using Slate for neutrals (cool neutral) and Blue for accents
                        border: "hsl(var(--border))",
                        input: "hsl(var(--input))",
                        ring: "hsl(var(--ring))",
                        background: "hsl(var(--background))",
                        foreground: "hsl(var(--foreground))",
                        primary: {
                            DEFAULT: "hsl(var(--primary))",
                            foreground: "hsl(var(--primary-foreground))",
                        },
                        secondary: {
                            DEFAULT: "hsl(var(--secondary))",
                            foreground: "hsl(var(--secondary-foreground))",
                        },
                        muted: {
                            DEFAULT: "hsl(var(--muted))",
                            foreground: "hsl(var(--muted-foreground))",
                        },
                        accent: {
                            DEFAULT: "hsl(var(--accent))",
                            foreground: "hsl(var(--accent-foreground))",
                        },
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'], // Modern, friendly sans-serif
                    }
                }
            }
        }
    </script>
    
    <!-- KaTeX (No integrity attributes per Stage 6.0.7b) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Markdown-it -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* CSS Variables for ColorLab B (Blue Theme) & ColorLab A (Light Only) */
        :root {
            /* Base Slate Neutrals */
            --background: 210 40% 98%;      /* Slate-50-ish */
            --foreground: 222 47% 11%;      /* Slate-900 */
            
            --muted: 210 40% 96.1%;         /* Slate-100 */
            --muted-foreground: 215 16% 47%;/* Slate-500 */
            
            --popover: 0 0% 100%;
            --popover-foreground: 222 47% 11%;
            
            --card: 0 0% 100%;
            --card-foreground: 222 47% 11%;
            
            --border: 214 32% 91%;          /* Slate-200 */
            --input: 214 32% 91%;
            
            /* Primary Accent: Blue (Restrained usage) */
            --primary: 221 83% 53%;         /* Blue-600 */
            --primary-foreground: 210 40% 98%;
            
            --secondary: 210 40% 96.1%;
            --secondary-foreground: 222 47% 11%;
            
            --accent: 210 40% 96.1%;
            --accent-foreground: 222 47% 11%;
            
            --ring: 221 83% 53%;            /* Focus ring blue */
            
            --radius: 0.5rem;
        }

        /* 
           KaTeX Containment Invariant (Locked):
           No horizontal scroll on page. 
           Horizontal scroll ONLY within math blocks.
        */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding: 0.5rem 0;
            -webkit-overflow-scrolling: touch;
            /* Hide scrollbar visually but keep functionality */
            scrollbar-width: none; 
        }
        .katex-display::-webkit-scrollbar {
            display: none;
        }

        /* Nav Scrollbar Hiding (Stage 6 Add-on) */
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* Markdown Table Styling (Stage 5.8.5) */
        .rtq-md-table table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95em;
            margin-bottom: 1em;
        }
        .rtq-md-table th, .rtq-md-table td {
            border: 1px solid #e2e8f0; /* slate-200 */
            padding: 0.5rem;
            text-align: left;
        }
        .rtq-md-table th {
            font-weight: 600;
            background-color: transparent;
        }
        /* Mobile table overflow wrapper */
        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* Base Typography Helpers */
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }
        
        /* Focus Visibility (Stage 5.5.2) */
        :focus-visible {
            outline: 2px solid hsl(var(--ring));
            outline-offset: 2px;
        }
    </style>
</head>
<body class="bg-background text-foreground min-h-screen flex flex-col">

    <!-- App Root -->
    <div id="app" class="flex flex-col min-h-screen">
        <!-- JS renders content here -->
    </div>

    <script>
        // =================================================================
        // STAGE 0: CONSTANTS (Canonical Sources)
        // =================================================================
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // =================================================================
        // STATE MANAGEMENT
        // =================================================================
        const state = {
            papers: [],
            currentPaperKey: null,
            expandedNodes: new Set(), // Set of node IDs that are expanded
            paperDefaults: {},
            payloadLoaded: false,
            payloadError: false,
            mobileNavOpen: false
        };

        // =================================================================
        // MARKDOWN CONFIGURATION (Stage 6 - Strict)
        // =================================================================
        const md = window.markdownit ? window.markdownit({
            html: true,    // Allow inline SVG
            linkify: true,
            breaks: false, // CRITICAL: Must be false for KaTeX
            typographer: true
        }) : null;

        if (md) {
            // Disable inline escape to preserve TeX backslashes
            md.inline.ruler.disable(['escape']);
        }

        // =================================================================
        // UTILITIES
        // =================================================================
        
        function renderMarkdown(text) {
            if (!text || !md) return text || '';
            // Render MD to HTML
            return md.render(text);
        }

        function toggleNode(nodeId) {
            if (state.expandedNodes.has(nodeId)) {
                state.expandedNodes.delete(nodeId);
            } else {
                state.expandedNodes.add(nodeId);
            }
            renderApp();
            // Maintain scroll position is handled naturally by browser unless explicit shift needed
        }

        function switchPaper(key) {
            const paper = state.papers.find(p => p.key === key);
            if (!paper) return;

            state.currentPaperKey = key;
            state.paperDefaults = paper.defaults || {};
            
            // Reset expanded state based on defaults
            state.expandedNodes.clear();
            if (state.paperDefaults.expandedAll) {
                // To support "expand all by default", we logically need to know all IDs.
                // For simplicity in this prototype, we check state.paperDefaults.expandedAll 
                // during render. If true, we treat a node as expanded unless explicitly collapsed?
                // Actually, simpler to just populate the set if we could, but recursive traversal 
                // is easier done lazily. 
                // Let's implement: expandedNodes stores EXPLICIT toggles. 
                // If expandedAll is true, missing in set = expanded. If false, missing = collapsed.
                // However, user interaction needs to invert. 
                // Strategy: Use a helper `isExpanded(nodeId)`
            }
            
            state.mobileNavOpen = false;
            renderApp();
            window.scrollTo(0, 0);
        }

        function isExpanded(nodeId) {
            const inSet = state.expandedNodes.has(nodeId);
            const defaultAll = state.paperDefaults?.expandedAll === true;
            // If default is expanded, only hidden if explicitly in set (as "hidden_ID"?) 
            // Or simpler: Just pre-fill the set on load if we want strict control?
            // To stick to "Simple", let's use the set as "Currently Open". 
            // On paper load, if defaultAll is true, we traverse and add all.
            return inSet;
        }

        function collectNodeIds(nodes, idSet) {
            nodes.forEach(node => {
                if (node.solutionBlock?.solutionDetails) {
                    idSet.add(node.id);
                }
                if (node.children) {
                    collectNodeIds(node.children, idSet);
                }
            });
        }
        
        function initializePaperState(paper) {
            state.expandedNodes.clear();
            if (paper.defaults?.expandedAll) {
                const nodes = paper.questions || (paper.sections ? paper.sections.flatMap(s => s.questions) : []);
                const ids = new Set();
                collectNodeIds(nodes, ids);
                state.expandedNodes = ids;
            }
        }

        function scrollToQuestion(id) {
            const el = document.getElementById(`q-${id}`);
            if (el) {
                // Header offset
                const offset = 80; 
                const elementPosition = el.getBoundingClientRect().top;
                const offsetPosition = elementPosition + window.pageYOffset - offset;
                
                window.scrollTo({
                    top: offsetPosition,
                    behavior: "smooth"
                });
                state.mobileNavOpen = false;
                renderApp(); // To update active nav state if we tracked it
            }
        }

        // =================================================================
        // RENDERING COMPONENTS
        // =================================================================

        function Icon(name, classes = "") {
            // Lucide icons will be replaced by `lucide.createIcons()` after render
            return `<i data-lucide="${name}" class="${classes}"></i>`;
        }

        // --- Shell ---
        
        function renderShell() {
            const app = document.getElementById('app');
            if (state.payloadError) {
                app.innerHTML = `
                    <div class="flex items-center justify-center min-h-screen bg-slate-50">
                        <div class="text-center p-8">
                            <h1 class="text-xl font-bold text-slate-900 mb-2">PAPERS PAYLOAD MISSING</h1>
                            <p class="text-slate-500">Could not load content from ${RTQ_PAPERS_PAYLOAD_PATH}</p>
                        </div>
                    </div>
                `;
                return;
            }

            if (!state.payloadLoaded) {
                app.innerHTML = `
                    <div class="flex items-center justify-center min-h-screen bg-slate-50">
                        <div class="animate-pulse text-slate-400 font-medium">Loading Paper...</div>
                    </div>
                `;
                return;
            }

            // Desktop Layout: 2 Columns inside a centered shell
            // Mobile Layout: Header + Content
            const paper = state.papers.find(p => p.key === state.currentPaperKey);
            
            app.innerHTML = `
                <!-- Top Controls (Aligned to frame) -->
                <header class="sticky top-0 z-40 w-full bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60 border-b border-border">
                    <div class="max-w-[1400px] mx-auto px-4 md:px-8 h-14 flex items-center justify-between">
                        <!-- Paper Selector -->
                        <div class="flex items-center gap-2">
                            <select 
                                onchange="switchPaper(this.value)" 
                                class="h-9 w-[200px] rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:ring-1 focus-visible:ring-ring"
                            >
                                ${state.papers.map(p => `
                                    <option value="${p.key}" ${p.key === state.currentPaperKey ? 'selected' : ''}>
                                        ${p.label}
                                    </option>
                                `).join('')}
                            </select>
                        </div>

                        <!-- Mobile Jump To Trigger -->
                        <button 
                            onclick="state.mobileNavOpen = true; renderApp();"
                            class="md:hidden inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 hover:bg-accent hover:text-accent-foreground h-9 py-2 px-4"
                        >
                            <span class="mr-2">Jump to</span>
                            ${Icon('menu', 'h-4 w-4')}
                        </button>
                    </div>
                </header>

                <!-- DocumentFrameShell -->
                <div class="flex-1 w-full max-w-[1400px] mx-auto flex items-start md:px-8">
                    
                    <!-- Desktop Nav Rail -->
                    <aside class="hidden md:block w-64 sticky top-14 h-[calc(100vh-3.5rem)] py-6 pr-6 overflow-y-auto no-scrollbar border-r border-transparent">
                        ${renderNavigationList(paper)}
                    </aside>

                    <!-- Paper Content Column -->
                    <main class="flex-1 min-w-0 py-8 px-4 md:px-8 md:pl-12">
                        ${renderPaperContent(paper)}
                    </main>

                </div>

                <!-- Mobile Navigation Drawer -->
                ${renderMobileDrawer(paper)}
            `;

            // Initialize Icons & Math
            lucide.createIcons();
            renderMathInElement(document.body, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false}
                ],
                throwOnError: false
            });
        }

        // --- Navigation ---

        function renderNavigationList(paper) {
            if (!paper) return '';
            
            // Handle Sections
            if (paper.sections) {
                return `
                    <nav class="space-y-6">
                        ${paper.sections.map(section => `
                            <div class="space-y-2">
                                ${section.label ? `
                                    <div class="text-xs font-semibold text-slate-400 uppercase tracking-wider px-2 select-none">
                                        ${section.label}
                                    </div>
                                ` : ''}
                                <div class="flex flex-col">
                                    ${section.questions.map(q => renderNavNode(q)).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </nav>
                `;
            }

            // Flat Paper
            return `
                <nav class="flex flex-col space-y-0.5">
                    ${paper.questions.map(q => renderNavNode(q)).join('')}
                </nav>
            `;
        }

        function renderNavNode(node, depth = 0) {
            let html = '';
            
            // Visual Hierarchy via type scale/color (Stage 5.4.5)
            // No margin indentation.
            const isTopLevel = depth === 0;
            const classes = `
                group flex items-center px-2 py-1.5 text-sm rounded-md transition-colors 
                ${isTopLevel ? 'text-slate-700 font-medium' : 'text-slate-500 font-normal text-xs'} 
                hover:text-slate-900 hover:bg-slate-100 focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring
            `;

            // Active state indicator logic could go here (using accent color border or text weight)
            
            html += `
                <button onclick="scrollToQuestion('${node.id}')" class="${classes} w-full text-left">
                    ${isTopLevel ? '' : '<span class="sr-only">Sub-question </span>'}
                    ${node.id}
                </button>
            `;

            if (node.children && node.children.length > 0) {
                html += node.children.map(child => renderNavNode(child, depth + 1)).join('');
            }

            return html;
        }

        function renderMobileDrawer(paper) {
            if (!state.mobileNavOpen) return '';
            
            return `
                <div class="fixed inset-0 z-50 flex justify-end md:hidden" role="dialog" aria-modal="true">
                    <!-- Backdrop -->
                    <div class="fixed inset-0 bg-black/20 backdrop-blur-sm" onclick="state.mobileNavOpen = false; renderApp();"></div>
                    
                    <!-- Drawer -->
                    <div class="relative w-[300px] h-full bg-background shadow-xl border-l border-border flex flex-col animate-in slide-in-from-right duration-200">
                        <div class="h-14 flex items-center justify-between px-4 border-b border-border">
                            <h2 class="font-semibold">Jump to</h2>
                            <button onclick="state.mobileNavOpen = false; renderApp();" class="p-2 hover:bg-slate-100 rounded-md">
                                ${Icon('x', 'h-4 w-4')}
                            </button>
                        </div>
                        <div class="flex-1 overflow-y-auto p-4 no-scrollbar">
                            ${renderNavigationList(paper)}
                        </div>
                    </div>
                </div>
            `;
        }

        // --- Paper Content ---

        function renderPaperContent(paper) {
            if (!paper) return '';
            
            if (paper.sections) {
                return paper.sections.map((section, idx) => `
                    <div class="mb-12">
                        ${section.label ? `
                            <div class="mb-8 pb-4 border-b border-slate-100">
                                <span class="text-sm font-bold text-slate-400 uppercase tracking-widest">${section.label}</span>
                            </div>
                        ` : ''}
                        <div class="space-y-12"> <!-- SPC__TOP_LEVEL_INTER_QUESTION_SPACING -->
                            ${section.questions.map(q => renderQuestionNode(q, 0)).join('')}
                        </div>
                    </div>
                `).join('');
            }
            
            return `
                <div class="space-y-16"> <!-- SPC__TOP_LEVEL_INTER_QUESTION_SPACING -->
                    ${paper.questions.map(q => renderQuestionNode(q, 0)).join('')}
                </div>
            `;
        }

        function renderQuestionNode(node, depth) {
            const isExpandedState = isExpanded(node.id);
            const hasSolutionBlock = !!node.solutionBlock;
            const hasAnswer = hasSolutionBlock && !!node.solutionBlock.answer;
            const hasSolutionDetails = hasSolutionBlock && !!node.solutionBlock.solutionDetails;
            
            // Layout Tree: Question Body
            // Question ID is subordinate to Prompt, but technically part of the body.
            // Stage 5.6.1: Question body is primary anchor.
            
            const indentClass = depth > 0 ? 'ml-4 md:ml-8 border-l-2 border-slate-100 pl-4 md:pl-6' : '';
            const spacingClass = depth > 0 ? 'mt-8' : ''; // Tighter vertical spacing for children

            return `
                <div id="q-${node.id}" class="group relative ${indentClass} ${spacingClass} scroll-mt-20">
                    
                    <!-- Question Body -->
                    <div class="mb-4">
                        <div class="flex items-baseline gap-3 md:gap-4">
                            <span class="flex-none text-slate-400 font-medium text-sm md:text-base select-none w-8 md:w-10 text-right font-mono" aria-hidden="true">${node.id}</span>
                            <div class="flex-1 prose prose-slate max-w-none text-slate-900 prose-p:leading-relaxed prose-headings:font-semibold">
                                ${renderMarkdown(node.question)}
                            </div>
                        </div>
                    </div>

                    <!-- Solution Block (Optional) -->
                    ${hasSolutionBlock ? `
                        <div class="pl-[2.75rem] md:pl-[3.5rem]"> <!-- Align with text start -->
                            
                            <!-- Answer (Optional) -->
                            ${hasAnswer ? `
                                <div class="mb-3">
                                    <div class="text-xs font-bold text-slate-500 uppercase tracking-wide mb-1">Answer</div>
                                    <div class="prose prose-slate max-w-none text-slate-800">
                                        ${renderMarkdown(node.solutionBlock.answer)}
                                    </div>
                                </div>
                            ` : ''}

                            <!-- Solution Details Disclosure (Optional) -->
                            ${hasSolutionDetails ? `
                                <div class="mt-4">
                                    <button 
                                        onclick="toggleNode('${node.id}')"
                                        class="inline-flex items-center gap-1.5 text-sm font-medium text-primary hover:text-primary/80 transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring rounded-sm px-0.5"
                                        aria-expanded="${isExpandedState}"
                                        aria-controls="sd-${node.id}"
                                    >
                                        ${isExpandedState ? 'Hide working' : 'Show working'}
                                        ${Icon(isExpandedState ? 'chevron-up' : 'chevron-down', 'h-4 w-4 opacity-70')}
                                    </button>

                                    <!-- Expanded Content Region -->
                                    <div 
                                        id="sd-${node.id}"
                                        class="${isExpandedState ? 'block' : 'hidden'} mt-4 animate-in fade-in slide-in-from-top-2 duration-200"
                                    >
                                        <div class="space-y-6 pt-2 pb-2">
                                            ${renderSolutionDetails(node.solutionBlock.solutionDetails)}
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}

                    <!-- Children -->
                    ${node.children && node.children.length > 0 ? `
                        <div class="mt-8">
                            ${node.children.map(child => renderQuestionNode(child, depth + 1)).join('')}
                        </div>
                    ` : ''}

                </div>
            `;
        }

        function renderSolutionDetails(details) {
            if (!details) return '';
            let html = '';

            // 1. Keep in Mind
            if (details.keepInMind) {
                html += `
                    <div class="space-y-2">
                        <div class="flex items-center gap-2 text-sm font-bold text-slate-600">
                            ${Icon('lightbulb', 'h-4 w-4 text-amber-500')}
                            Keep in mind
                        </div>
                        <div class="prose prose-sm prose-slate max-w-none text-slate-600">
                            ${renderMarkdown(details.keepInMind)}
                        </div>
                    </div>
                `;
            }

            // 2. Formulas Used
            if (details.formulasUsed) {
                html += `
                    <div class="space-y-2 pt-2">
                        <div class="text-sm font-bold text-slate-600">Formulas used</div>
                        <div class="prose prose-sm prose-slate max-w-none text-slate-600 bg-slate-50/50 p-2 rounded border border-slate-100">
                            ${renderMarkdown(details.formulasUsed)}
                        </div>
                    </div>
                `;
            }

            // 3. Working (Primary)
            if (details.working) {
                html += `
                    <div class="space-y-2 pt-2">
                        <div class="text-sm font-bold text-slate-600">Working</div>
                        <!-- Internal grammar: mixed prose + math -->
                        <!-- rtq-md-table class for table styling -->
                        <div class="prose prose-slate max-w-none text-slate-700 rtq-md-table">
                            ${renderMarkdown(details.working)}
                        </div>
                    </div>
                `;
            }

            // 4. Alternative Working
            if (details.alternativeWorking && details.alternativeWorking.length > 0) {
                details.alternativeWorking.forEach((alt, idx) => {
                    html += `
                        <div class="pt-6 border-t border-slate-100 mt-6">
                            <div class="text-sm font-bold text-slate-600 mb-2">Alternative working</div>
                            <div class="prose prose-slate max-w-none text-slate-700 rtq-md-table">
                                ${renderMarkdown(alt)}
                            </div>
                        </div>
                    `;
                });
            }

            return html;
        }

        // --- Main Render Loop ---

        function renderApp() {
            renderShell();
        }

        // =================================================================
        // INITIALIZATION
        // =================================================================

        async function init() {
            try {
                // Fetch Payload from Canonical Path
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Network response was not ok");
                
                const data = await response.json();
                state.papers = data.papers || [];
                
                if (state.papers.length > 0) {
                    // Set initial paper
                    state.currentPaperKey = state.papers[0].key;
                    state.paperDefaults = state.papers[0].defaults || {};
                    initializePaperState(state.papers[0]);
                }
                
                state.payloadLoaded = true;
            } catch (error) {
                console.error("Payload Load Failed", error);
                state.payloadError = true;
            }

            renderApp();
        }

        // Start
        init();

    </script>
</body>
</html>
