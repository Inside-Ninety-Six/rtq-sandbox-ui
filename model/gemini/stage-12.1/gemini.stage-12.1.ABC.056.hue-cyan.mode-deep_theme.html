<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"ABC","indexWithinVariant":"56","totalWithinVariant":"320","hueFamily":"cyan","intensityMode":"deep_theme","timestamp":"2026-01-07T11:58:55.121Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;ABC&quot;,&quot;indexWithinVariant&quot;:&quot;56&quot;,&quot;totalWithinVariant&quot;:&quot;320&quot;,&quot;hueFamily&quot;:&quot;cyan&quot;,&quot;intensityMode&quot;:&quot;deep_theme&quot;,&quot;timestamp&quot;:&quot;2026-01-07T11:58:55.121Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- KaTeX CSS (No Integrity per Stage 6) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <!-- Dependencies (No Integrity per Stage 6) -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <style>
        /* =========================================
           STAGE 6 ADD-ON: COLORLAB C (DEEP THEME)
           Forced Hue: Cyan (approx 230 deg)
           Mode: deep_theme (Light Mode Only)
           ========================================= */
        :root {
            /* Palette Constants - Deep Theme / Cyan */
            --hue: 230; 

            /* Surfaces: High Chroma required for Deep Theme */
            /* Page: L[0.92-0.98], C[0.08-0.16] */
            --c-page-bg: oklch(0.93 0.1 var(--hue));
            
            /* Frame: L[0.90-0.96], C[0.08-0.16] */
            --c-frame-bg: oklch(0.91 0.12 var(--hue));

            /* Paper: L[0.94-0.99], C[0.06-0.14] */
            --c-paper-bg: oklch(0.96 0.08 var(--hue));

            /* Wash (Solution Details): Distinct from paper */
            --c-sd-wash: oklch(0.94 0.07 var(--hue));

            /* Text: Mostly neutral */
            /* Primary: L[0.15-0.25], C<=0.015 */
            --c-text-primary: oklch(0.2 0.015 var(--hue));
            /* Secondary: L[0.25-0.40], C<=0.020 */
            --c-text-secondary: oklch(0.35 0.02 var(--hue));

            /* Accent: L[0.45-0.65], C[0.16-0.26] */
            --c-accent: oklch(0.55 0.2 var(--hue));
            
            /* Dividers: Neutral-leaning, low chroma */
            --c-divider: oklch(0.85 0.02 var(--hue));
            
            /* Interactive States */
            --c-focus-ring: var(--c-accent);

            /* Typography */
            --font-base: 'Inter', system-ui, -apple-system, sans-serif;
            
            /* Spacing Units */
            --sp-xs: 4px;
            --sp-s: 8px;
            --sp-m: 16px;
            --sp-l: 24px;
            --sp-xl: 32px;
            --sp-xxl: 48px;

            /* Layout */
            --nav-width: 240px;
            --frame-max-width: 1024px;
        }

        /* =========================================
           RESET & BASE
           ========================================= */
        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: var(--font-base);
            background-color: var(--c-page-bg);
            color: var(--c-text-primary);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        button {
            font: inherit;
            border: none;
            background: none;
            cursor: pointer;
            padding: 0;
            color: inherit;
        }

        /* =========================================
           LAYOUT SHELL (Stage 3 Grammar)
           ========================================= */
        .viewport {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Top Controls Region */
        .top-controls-region {
            width: 100%;
            display: flex;
            justify-content: center;
            background-color: var(--c-frame-bg); /* Match frame context per brief */
            padding: var(--sp-m) 0;
            position: relative;
            z-index: 10;
        }

        .top-controls-content {
            width: 100%;
            max-width: var(--frame-max-width);
            padding: 0 var(--sp-m);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        /* Paper Selector */
        .paper-selector {
            background-color: var(--c-paper-bg);
            border: 1px solid var(--c-divider);
            color: var(--c-text-primary);
            padding: var(--sp-s) var(--sp-m);
            border-radius: 4px;
            font-size: 0.9rem;
        }
        .paper-selector:focus-visible {
            outline: 2px solid var(--c-focus-ring);
            outline-offset: 2px;
        }

        /* Mobile Jump Trigger */
        .mobile-jump-trigger {
            display: none; /* Desktop default */
            font-weight: 500;
            color: var(--c-accent);
            align-items: center;
            gap: var(--sp-xs);
        }

        /* Document Frame Shell */
        .document-frame-shell {
            width: 100%;
            max-width: var(--frame-max-width);
            flex: 1;
            display: flex;
            background-color: var(--c-frame-bg);
            /* Navigation and Paper share this surface on desktop */
        }

        /* Navigation Rail (Desktop) */
        .nav-rail {
            width: var(--nav-width);
            flex-shrink: 0;
            padding: var(--sp-l) var(--sp-m);
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
            /* Hide scrollbar visually */
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .nav-rail::-webkit-scrollbar {
            display: none;
        }

        /* Paper Content Column */
        .paper-column {
            flex: 1;
            min-width: 0; /* Flexbox overflow safety */
            padding: var(--sp-l) var(--sp-m) var(--sp-xxl) var(--sp-m);
        }

        .paper-surface {
            background-color: var(--c-paper-bg);
            min-height: 80vh;
            padding: var(--sp-xl);
            /* Optional subtle shadow for separation in Deep Theme */
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); 
        }

        /* =========================================
           NAVIGATION (Stage 3 & 5)
           ========================================= */
        .nav-list {
            display: flex;
            flex-direction: column;
            gap: var(--sp-xs);
        }

        .nav-section-label {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--c-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: var(--sp-m);
            margin-bottom: var(--sp-xs);
            padding-left: var(--sp-s); /* Alignment */
            pointer-events: none;
        }
        .nav-section-label:first-child {
            margin-top: 0;
        }

        .nav-item {
            font-size: 0.9rem;
            color: var(--c-text-secondary);
            padding: 4px var(--sp-s);
            text-align: left;
            border-left: 2px solid transparent;
            transition: color 0.1s, border-color 0.1s;
        }

        .nav-item:hover {
            color: var(--c-text-primary);
        }

        .nav-item.active {
            color: var(--c-text-primary);
            font-weight: 600;
            border-left-color: var(--c-accent); /* Stage 6 override permits accent here */
        }

        .nav-item:focus-visible {
            outline: 2px solid var(--c-focus-ring);
            outline-offset: -2px;
        }

        /* Hierarchy via type scale (flat list) */
        .nav-item[data-depth="1"] { font-size: 0.85rem; }
        .nav-item[data-depth="2"] { font-size: 0.8rem; }

        /* =========================================
           MOBILE DRAWER
           ========================================= */
        .drawer-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.3);
            z-index: 100;
            display: none;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .drawer-overlay.open {
            display: block;
            opacity: 1;
        }

        .drawer {
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            width: 280px;
            background-color: var(--c-paper-bg);
            z-index: 101;
            transform: translateX(-100%);
            transition: transform 0.2s ease-out;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        .drawer.open {
            transform: translateX(0);
        }

        .drawer-header {
            padding: var(--sp-m);
            border-bottom: 1px solid var(--c-divider);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .drawer-title {
            font-weight: 600;
            font-size: 1.1rem;
        }
        .drawer-close {
            padding: var(--sp-s);
            font-size: 1.5rem;
            line-height: 1;
        }

        .drawer-content {
            flex: 1;
            overflow-y: auto;
            padding: var(--sp-m);
        }

        /* =========================================
           CONTENT TYPOGRAPHY & MATH
           ========================================= */
        h1, h2, h3, p, ul, ol {
            margin-top: 0;
            margin-bottom: var(--sp-m);
        }

        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            padding: var(--sp-s) 0;
            /* Deep Theme Block Math styling optional - sticking to clean */
        }
        
        /* KaTeX Containment Invariant */
        .katex-display > .katex {
            white-space: normal;
        }
        .katex-display > .katex > .katex-html {
            display: block;
            padding-bottom: 2px; /* Scrollbar breathing room */
        }

        /* Table minimal styling */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: var(--sp-m);
            font-size: 0.95rem;
        }
        th, td {
            padding: var(--sp-s);
            border: 1px solid var(--c-divider);
            text-align: left;
        }
        th {
            font-weight: 600;
        }
        .table-wrapper {
            overflow-x: auto;
            margin-bottom: var(--sp-m);
        }

        /* =========================================
           PAPER STRUCTURE
           ========================================= */
        
        /* Section Header in Paper */
        .section-header-row {
            padding-top: var(--sp-xl);
            padding-bottom: var(--sp-l);
            border-bottom: 1px solid var(--c-divider);
            margin-bottom: var(--sp-xl);
        }
        .section-header-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--c-text-primary);
        }

        /* Question Node */
        .question-node {
            margin-bottom: var(--sp-xxl); /* Top Level Spacing */
        }

        .question-node[data-depth="0"] + .question-node[data-depth="0"] {
            /* Handled by margin-bottom above, consistency check */
        }

        /* Indentation logic via spacing only (Stage 3) */
        .children-container {
            margin-top: var(--sp-m);
            margin-left: var(--sp-l); /* Indentation */
        }

        /* Question Body */
        .question-body {
            display: flex;
            gap: var(--sp-m);
            align-items: baseline;
        }
        .q-id {
            font-weight: 600;
            flex-shrink: 0;
            min-width: 2ch;
            color: var(--c-text-secondary);
        }
        .q-prompt {
            flex: 1;
            color: var(--c-text-primary);
        }

        /* Solution Block */
        .solution-block {
            margin-top: var(--sp-m);
            margin-left: calc(2ch + var(--sp-m)); /* Align with prompt text start */
            display: flex;
            flex-direction: column;
            gap: var(--sp-m);
        }

        /* Answer */
        .answer-region {
            /* Visible by default */
        }
        .answer-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--c-text-secondary);
            margin-bottom: var(--sp-xs);
            display: block;
        }
        .answer-content {
            font-weight: 500;
            color: var(--c-text-primary);
        }

        /* Solution Details */
        .disclosure-control {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--c-accent); /* Stage 6 Permitted Accent */
            display: flex;
            align-items: center;
            gap: var(--sp-xs);
            margin-bottom: var(--sp-s);
            width: fit-content;
        }
        .disclosure-control:hover {
            text-decoration: underline;
        }
        .disclosure-control:focus-visible {
            outline: 2px solid var(--c-focus-ring);
            border-radius: 2px;
        }
        
        .disclosure-icon {
            width: 1em;
            height: 1em;
            transition: transform 0.2s;
            fill: currentColor;
        }
        .disclosure-control[aria-expanded="true"] .disclosure-icon {
            transform: rotate(180deg);
        }

        .solution-details-region {
            background-color: var(--c-sd-wash); /* Surface Differentiation */
            padding: var(--sp-m);
            border-radius: 4px; /* Softness */
            display: none; /* Collapsed default */
        }
        .solution-details-region.expanded {
            display: block;
            animation: slideDown 0.2s ease-out;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Subsections */
        .sd-subsection {
            margin-bottom: var(--sp-l);
        }
        .sd-subsection:last-child {
            margin-bottom: 0;
        }

        .sd-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--c-text-secondary);
            margin-bottom: var(--sp-s);
            display: block;
        }

        .keep-in-mind-body {
            font-size: 0.95rem;
        }
        .keep-in-mind-body ul {
            padding-left: 1.2em;
        }

        .working-body {
            /* Mixed prose + math */
        }
        
        .alt-working-block {
            margin-top: var(--sp-l);
            border-top: 1px solid var(--c-divider);
            padding-top: var(--sp-m);
        }

        /* =========================================
           RESPONSIVE
           ========================================= */
        @media (max-width: 768px) {
            .nav-rail {
                display: none;
            }
            .mobile-jump-trigger {
                display: flex;
            }
            .paper-column {
                padding: var(--sp-m);
            }
            .paper-surface {
                padding: var(--sp-m);
            }
            .children-container {
                margin-left: var(--sp-s);
                padding-left: var(--sp-s);
                border-left: 1px solid var(--c-divider); /* Helper for depth on mobile */
            }
            .solution-block {
                margin-left: 0; /* Reclaim space on mobile */
                padding-left: var(--sp-s);
                border-left: 2px solid var(--c-divider); /* Association cue */
            }
        }
    </style>
</head>
<body>

    <!-- App Shell -->
    <div class="viewport" id="app">
        
        <!-- Top Controls -->
        <div class="top-controls-region">
            <div class="top-controls-content">
                <select id="paper-selector" class="paper-selector" aria-label="Select Paper">
                    <option value="" disabled selected>Loading papers...</option>
                </select>

                <button id="mobile-jump-trigger" class="mobile-jump-trigger" aria-label="Open navigation">
                    <span>Jump to</span>
                    <svg width="16" height="16" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1.5 3C1.22386 3 1 3.22386 1 3.5C1 3.77614 1.22386 4 1.5 4H13.5C13.7761 4 14 3.77614 14 3.5C14 3.22386 13.7761 3 13.5 3H1.5ZM1 7.5C1 7.22386 1.22386 7 1.5 7H13.5C13.7761 7 14 7.22386 14 7.5C14 7.77614 13.7761 8 13.5 8H1.5C1.22386 8 1 7.77614 1 7.5ZM1 11.5C1 11.2239 1.22386 11 1.5 11H13.5C13.7761 11 14 11.2239 14 11.5C14 11.7761 13.7761 12 13.5 12H1.5C1.22386 12 1 11.7761 1 11.5Z" fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
                </button>
            </div>
        </div>

        <!-- Document Frame -->
        <div class="document-frame-shell">
            
            <!-- Desktop Nav Rail -->
            <nav id="nav-rail" class="nav-rail" aria-label="Paper navigation">
                <!-- Injected via JS -->
            </nav>

            <!-- Paper Column -->
            <main class="paper-column">
                <div id="paper-surface" class="paper-surface">
                    <div id="paper-content">
                        <!-- Content Injected via JS -->
                        <div style="text-align: center; color: var(--c-text-secondary); margin-top: 4rem;">Select a paper to begin</div>
                    </div>
                </div>
            </main>

        </div>
    </div>

    <!-- Mobile Drawer -->
    <div id="drawer-overlay" class="drawer-overlay"></div>
    <div id="drawer" class="drawer">
        <div class="drawer-header">
            <span class="drawer-title">Jump to</span>
            <button id="drawer-close" class="drawer-close" aria-label="Close navigation">&times;</button>
        </div>
        <div id="drawer-nav-content" class="drawer-content">
            <!-- Clone of nav injected here -->
        </div>
    </div>

    <!-- SCRIPT -->
    <script>
        // --- STAGE 0: CONSTANTS ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // --- STATE ---
        let payloadData = null;
        let activePaperKey = null;

        // --- MARKDOWN SETUP ---
        const md = window.markdownit ? window.markdownit({
            html: true, // Allow inline SVG
            linkify: true,
            breaks: false // Preserves TeX backslashes
        }) : null;

        if (md) {
            md.inline.ruler.disable(['escape']); // Critical for TeX
        }

        // --- DOM ELEMENTS ---
        const els = {
            paperSelector: document.getElementById('paper-selector'),
            navRail: document.getElementById('nav-rail'),
            drawerNav: document.getElementById('drawer-nav-content'),
            paperContent: document.getElementById('paper-content'),
            mobileJump: document.getElementById('mobile-jump-trigger'),
            drawerOverlay: document.getElementById('drawer-overlay'),
            drawer: document.getElementById('drawer'),
            drawerClose: document.getElementById('drawer-close')
        };

        // --- INITIALIZATION ---
        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Fetch failed");
                payloadData = await response.json();
                
                populateSelector();
                
                // Select first paper by default if available
                if (payloadData.papers && payloadData.papers.length > 0) {
                    loadPaper(payloadData.papers[0].key);
                }
            } catch (err) {
                console.error(err);
                els.paperContent.innerHTML = `<div style="padding: 2rem; text-align: center; font-weight: 600; color: var(--c-text-primary);">PAPERS PAYLOAD MISSING</div>`;
                els.paperSelector.innerHTML = `<option disabled>Error loading papers</option>`;
            }
        }

        function populateSelector() {
            els.paperSelector.innerHTML = '';
            payloadData.papers.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.key;
                opt.textContent = p.label || p.key;
                els.paperSelector.appendChild(opt);
            });
        }

        function loadPaper(key) {
            activePaperKey = key;
            els.paperSelector.value = key;
            const paper = payloadData.papers.find(p => p.key === key);
            
            if (!paper) return;

            // Render Content
            const contentHTML = renderPaperContent(paper);
            els.paperContent.innerHTML = contentHTML;

            // Render Nav
            const navHTML = renderNav(paper);
            els.navRail.innerHTML = navHTML;
            els.drawerNav.innerHTML = navHTML;

            // Post-Render: KaTeX
            renderMathInElement(els.paperContent, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false}
                ],
                throwOnError: false
            });

            // Reset scroll
            window.scrollTo(0, 0);
        }

        // --- RENDERING LOGIC ---

        function renderPaperContent(paper) {
            let html = '';
            
            if (paper.sections) {
                paper.sections.forEach(section => {
                    // Section Header
                    if (section.label && section.label.trim().length > 0) {
                        html += `
                            <div class="section-header-row">
                                <div class="section-header-title">Section ${section.label}</div>
                            </div>
                        `;
                    }
                    html += `<div class="question-list">`;
                    section.questions.forEach(q => {
                        html += renderQuestionNode(q, 0, paper.defaults);
                    });
                    html += `</div>`;
                });
            } else if (paper.questions) {
                html += `<div class="question-list">`;
                paper.questions.forEach(q => {
                    html += renderQuestionNode(q, 0, paper.defaults);
                });
                html += `</div>`;
            }

            return html;
        }

        function renderQuestionNode(node, depth, defaults = {}) {
            const hasChildren = node.children && node.children.length > 0;
            const hasSolutionBlock = !!node.solutionBlock;
            const hasDetails = hasSolutionBlock && !!node.solutionBlock.solutionDetails;
            const hasAnswer = hasSolutionBlock && !!node.solutionBlock.answer;
            
            // Generate IDs
            const domId = `q-${node.id.replace(/[^a-zA-Z0-9]/g, '-')}`;
            
            let html = `
                <div id="${domId}" class="question-node" data-depth="${depth}">
                    <div class="question-body">
                        <span class="q-id">${node.id}</span>
                        <div class="q-prompt">${renderMarkdown(node.question)}</div>
                    </div>
            `;

            if (hasSolutionBlock) {
                html += `<div class="solution-block">`;
                
                // Answer
                if (hasAnswer) {
                    html += `
                        <div class="answer-region">
                            <span class="answer-label">Answer</span>
                            <div class="answer-content">${renderMarkdown(node.solutionBlock.answer)}</div>
                        </div>
                    `;
                }

                // Solution Details
                if (hasDetails) {
                    const sd = node.solutionBlock.solutionDetails;
                    const isExpanded = defaults.expandedAll !== false; // Default true unless false
                    const expandedClass = isExpanded ? 'expanded' : '';
                    const ariaExpanded = isExpanded ? 'true' : 'false';
                    const btnText = isExpanded ? 'Hide working' : 'Show working';

                    html += `
                        <div class="solution-details-wrapper">
                            <button class="disclosure-control" aria-expanded="${ariaExpanded}" onclick="toggleSolution(this)">
                                <span>${btnText}</span>
                                <svg class="disclosure-icon" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.13523 6.15803C3.3241 5.95657 3.64052 5.94637 3.84197 6.13523L7.5 9.56464L11.158 6.13523C11.3595 5.94637 11.6759 5.95657 11.8648 6.15803C12.0536 6.35949 12.0434 6.67591 11.842 6.86477L7.84197 10.6148C7.64964 10.7951 7.35036 10.7951 7.15803 10.6148L3.15803 6.86477C2.95657 6.67591 2.94637 6.35949 3.13523 6.15803Z" fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
                            </button>
                            <div class="solution-details-region ${expandedClass}">
                    `;

                    // Keep in mind
                    if (sd.keepInMind) {
                        html += `
                            <div class="sd-subsection">
                                <span class="sd-label">Keep in mind</span>
                                <div class="keep-in-mind-body">${renderMarkdown(sd.keepInMind)}</div>
                            </div>
                        `;
                    }

                    // Formulas used
                    if (sd.formulasUsed) {
                        html += `
                            <div class="sd-subsection">
                                <span class="sd-label">Formulas used</span>
                                <div class="formulas-body">${renderMarkdown(sd.formulasUsed)}</div>
                            </div>
                        `;
                    }

                    // Working
                    if (sd.working) {
                        html += `
                            <div class="sd-subsection">
                                <span class="sd-label">Working</span>
                                <div class="working-body">${renderMarkdown(sd.working)}</div>
                            </div>
                        `;
                    }

                    // Alternative Workings
                    if (sd.alternativeWorking && Array.isArray(sd.alternativeWorking)) {
                        sd.alternativeWorking.forEach(alt => {
                            html += `
                                <div class="sd-subsection alt-working-block">
                                    <span class="sd-label">Alternative working</span>
                                    <div class="working-body">${renderMarkdown(alt)}</div>
                                </div>
                            `;
                        });
                    }

                    html += `</div></div>`; // Close region + wrapper
                }

                html += `</div>`; // Close solution block
            }

            // Children Recursion
            if (hasChildren) {
                html += `<div class="children-container">`;
                node.children.forEach(child => {
                    html += renderQuestionNode(child, depth + 1, defaults);
                });
                html += `</div>`;
            }

            html += `</div>`; // Close node
            return html;
        }

        function renderNav(paper) {
            let html = `<div class="nav-list">`;

            function buildItems(list) {
                let sHtml = '';
                list.forEach(q => {
                    const domId = `q-${q.id.replace(/[^a-zA-Z0-9]/g, '-')}`;
                    // Depth logic for type scale cues (flat list structure)
                    // Depth 0: Standard, Depth 1+: Quieter
                    const depth = (q.id.match(/\(/g) || []).length; // rough heuristic or use recursive passing if needed
                    // Actually, let's use a cleaner recursive builder if we want strict depth tracking,
                    // but question list structure in payload is nested.
                    // To keep nav flat, we flatten the structure or iterate recursively.
                    
                    sHtml += `<button class="nav-item" data-target="${domId}" onclick="jumpTo('${domId}')">${q.id}</button>`;
                    
                    if (q.children) {
                         sHtml += buildItems(q.children);
                    }
                });
                return sHtml;
            }

            if (paper.sections) {
                paper.sections.forEach(section => {
                    if (section.label && section.label.trim().length > 0) {
                        html += `<div class="nav-section-label">${section.label}</div>`;
                    }
                    html += buildItems(section.questions);
                });
            } else if (paper.questions) {
                html += buildItems(paper.questions);
            }

            html += `</div>`;
            return html;
        }

        // --- UTILS ---
        function renderMarkdown(text) {
            if (!text) return '';
            return md ? md.render(text) : text;
        }

        // --- INTERACTIVITY ---
        window.toggleSolution = function(btn) {
            const isExpanded = btn.getAttribute('aria-expanded') === 'true';
            const newState = !isExpanded;
            btn.setAttribute('aria-expanded', newState);
            const span = btn.querySelector('span');
            span.textContent = newState ? 'Hide working' : 'Show working';
            
            const region = btn.nextElementSibling;
            if (newState) {
                region.classList.add('expanded');
            } else {
                region.classList.remove('expanded');
            }
        };

        window.jumpTo = function(id) {
            const el = document.getElementById(id);
            if (el) {
                // Offset for sticky header/padding
                const y = el.getBoundingClientRect().top + window.pageYOffset - 24;
                window.scrollTo({top: y, behavior: 'smooth'});
                
                // Highlight nav
                updateActiveNav(id);

                // Close drawer if open
                closeDrawer();
            }
        };

        function updateActiveNav(id) {
            document.querySelectorAll('.nav-item').forEach(btn => {
                if (btn.dataset.target === id) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        // Paper Switching
        els.paperSelector.addEventListener('change', (e) => {
            loadPaper(e.target.value);
        });

        // Mobile Drawer
        function openDrawer() {
            els.drawerOverlay.classList.add('open');
            els.drawer.classList.add('open');
        }
        function closeDrawer() {
            els.drawerOverlay.classList.remove('open');
            els.drawer.classList.remove('open');
        }
        
        els.mobileJump.addEventListener('click', openDrawer);
        els.drawerClose.addEventListener('click', closeDrawer);
        els.drawerOverlay.addEventListener('click', closeDrawer);

        // Scroll Spy for Nav
        let scrollTimeout;
        window.addEventListener('scroll', () => {
            if (scrollTimeout) return;
            scrollTimeout = setTimeout(() => {
                scrollTimeout = null;
                // Simple heuristic: find first question near top
                const questions = document.querySelectorAll('.question-node');
                for (let q of questions) {
                    const rect = q.getBoundingClientRect();
                    if (rect.top >= 0 && rect.top < window.innerHeight / 2) {
                        updateActiveNav(q.id);
                        break;
                    }
                }
            }, 100);
        });

        // Start
        init();

    </script>
</body>
</html>
