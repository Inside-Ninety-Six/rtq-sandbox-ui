<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"ABC","indexWithinVariant":"212","totalWithinVariant":"320","hueFamily":"amber","intensityMode":"deep_theme","timestamp":"2026-01-07T19:14:11.578Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;ABC&quot;,&quot;indexWithinVariant&quot;:&quot;212&quot;,&quot;totalWithinVariant&quot;:&quot;320&quot;,&quot;hueFamily&quot;:&quot;amber&quot;,&quot;intensityMode&quot;:&quot;deep_theme&quot;,&quot;timestamp&quot;:&quot;2026-01-07T19:14:11.578Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer (Stage 6)</title>

    <!-- FONTS -->
    <link rel="preconnect" href="https://rsms.me/">
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">

    <!-- LIBRARIES (No Integrity/SRI as per Stage 6 instructions) -->
    <!-- KaTeX CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    
    <!-- Tailwind CSS (Prototype Build) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- MARKDOWN-IT -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <!-- KATEX JS -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- LUCIDE ICONS -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- CONFIGURATION: COLORLAB (Blue + Tinted Neutrals) -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        // COLORLAB C: Mode 2 (tinted_neutrals) + Blue Hue (260)
                        // OKLCH values hardcoded for browser compatibility in this prototype script
                        page: 'oklch(0.98 0.02 260)',
                        frame: 'oklch(0.97 0.025 260)', 
                        paper: 'oklch(0.99 0.015 260)',
                        
                        // Text
                        primary: 'oklch(0.20 0.01 260)',
                        secondary: 'oklch(0.40 0.012 260)',
                        
                        // Accents (Restrained usage)
                        accent: 'oklch(0.55 0.14 260)',
                        'accent-hover': 'oklch(0.50 0.14 260)',
                        
                        // Structure
                        divider: 'oklch(0.90 0.02 260)',
                        
                        // Wash Surfaces
                        wash: 'oklch(0.96 0.035 260)', // Solution Details
                        'wash-strong': 'oklch(0.95 0.045 260)', // Nested washes if needed
                    },
                    spacing: {
                        'nav-w': '240px',
                    }
                }
            }
        }
    </script>

    <style>
        /* BASE STYLES & RESETS */
        body {
            background-color: theme('colors.page');
            color: theme('colors.primary');
            font-feature-settings: "cv11", "ss01";
            -webkit-font-smoothing: antialiased;
            overflow-y: hidden; /* App shell manages scroll */
            height: 100vh;
            width: 100vw;
        }

        /* KATEX CONTAINMENT INVARIANT */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding: 0.5em 0;
            margin: 1em 0;
            /* Scrollbar hiding logic for cleanness */
            scrollbar-width: thin;
            scrollbar-color: theme('colors.divider') transparent;
        }
        
        /* Math block background safety */
        .katex-display > .katex {
            text-align: left; /* Left align display math usually reads better for steps */
            white-space: normal;
        }

        /* Inline math must allow breaking but not have background */
        .katex { 
            font-size: 1.05em; 
        }

        /* NAVIGATION SCROLLBAR HIDING */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* TABLE STYLING (Minimal) */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            font-size: 0.95em;
        }
        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid theme('colors.divider');
        }
        th {
            font-weight: 600;
            color: theme('colors.primary');
        }
        td {
            color: theme('colors.secondary');
        }

        /* MARKDOWN PROSE OVERRIDES */
        .prose p {
            margin-bottom: 0.75em;
            line-height: 1.6;
        }
        .prose ul {
            list-style-type: disc;
            padding-left: 1.5em;
            margin-bottom: 0.75em;
        }
        .prose ol {
            list-style-type: decimal;
            padding-left: 1.5em;
            margin-bottom: 0.75em;
        }
        
        /* FOCUS STATES */
        :focus-visible {
            outline: 2px solid theme('colors.accent');
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* UTILS */
        .anim-reveal {
            transition: all 0.2s ease-out;
        }
    </style>
</head>
<body class="flex flex-col">

    <!-- TOP CONTROLS REGION -->
    <header id="top-controls" class="flex-none border-b border-divider bg-frame px-4 py-3 flex items-center justify-between z-20 relative">
        <div class="flex items-center gap-4 w-full max-w-[1200px] mx-auto px-4 md:px-0">
            <!-- Paper Selector -->
            <div class="flex items-center gap-3">
                <span class="text-sm font-medium text-secondary">Paper</span>
                <select id="paper-selector" class="bg-paper border border-divider rounded px-3 py-1.5 text-sm text-primary focus:border-accent focus:ring-0 cursor-pointer">
                    <option disabled selected>Loading papers...</option>
                </select>
            </div>
            
            <!-- Mobile Jump Trigger (Visible < md) -->
            <button id="mobile-jump-trigger" class="md:hidden ml-auto flex items-center gap-2 text-sm text-accent font-medium px-2 py-1">
                <i data-lucide="list" class="w-4 h-4"></i>
                Jump to
            </button>
        </div>
    </header>

    <!-- DOCUMENT FRAME SHELL -->
    <div id="document-frame" class="flex-1 overflow-hidden bg-frame flex justify-center relative">
        <div class="w-full max-w-[1200px] flex h-full">
            
            <!-- DESKTOP NAVIGATION RAIL (Visible >= md) -->
            <nav id="desktop-nav" class="hidden md:block w-nav-w flex-none h-full overflow-y-auto no-scrollbar py-8 pl-4 pr-6 sticky top-0">
                <div id="desktop-nav-list" class="flex flex-col gap-1">
                    <!-- Injected via JS -->
                </div>
            </nav>

            <!-- SEPARATOR (Desktop) -->
            <div class="hidden md:block w-px bg-divider my-6 mx-2"></div>

            <!-- PAPER CONTENT COLUMN -->
            <main id="paper-column" class="flex-1 h-full overflow-y-auto overflow-x-hidden relative scroll-smooth bg-frame">
                <div id="paper-content" class="max-w-[800px] mx-auto py-8 px-4 md:px-8 min-h-full pb-32">
                    <!-- Content injected via JS -->
                    <div class="flex items-center justify-center h-64 text-secondary italic">
                        Initializing...
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- MOBILE DRAWER (Overlay) -->
    <div id="mobile-drawer" class="fixed inset-0 z-50 transform translate-x-full transition-transform duration-300 md:hidden flex justify-end" aria-hidden="true">
        <div id="drawer-backdrop" class="absolute inset-0 bg-primary/20 backdrop-blur-sm opacity-0 transition-opacity"></div>
        <div class="relative w-[85%] max-w-[320px] bg-frame h-full shadow-2xl flex flex-col">
            <div class="flex items-center justify-between p-4 border-b border-divider bg-page">
                <h2 class="text-sm font-bold text-primary">Jump to</h2>
                <button id="drawer-close" class="p-2 text-secondary hover:text-primary">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div id="drawer-nav-list" class="flex-1 overflow-y-auto p-4 flex flex-col gap-1">
                <!-- Injected via JS -->
            </div>
        </div>
    </div>

    <!-- MAIN SCRIPT -->
    <script>
        // --- STAGE 0: CONSTANTS ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // --- STATE ---
        let appState = {
            papers: [],
            activePaperKey: null,
            expandedWorkings: new Set(), // Set of question IDs
            defaultExpanded: true
        };

        // --- MARKDOWN INIT (Deterministic Config) ---
        const md = window.markdownit ? window.markdownit({
            html: true,
            linkify: true,
            breaks: false // Authoritative: must be false for KaTeX
        }) : null;

        if (md) {
            md.inline.ruler.disable(['escape']); // Preserve TeX backslashes
        }

        // --- DOM ELEMENTS ---
        const els = {
            paperSelector: document.getElementById('paper-selector'),
            paperContent: document.getElementById('paper-content'),
            desktopNavList: document.getElementById('desktop-nav-list'),
            drawerNavList: document.getElementById('drawer-nav-list'),
            mobileDrawer: document.getElementById('mobile-drawer'),
            drawerBackdrop: document.getElementById('drawer-backdrop'),
            mobileJumpTrigger: document.getElementById('mobile-jump-trigger'),
            drawerClose: document.getElementById('drawer-close'),
            paperColumn: document.getElementById('paper-column')
        };

        // --- INIT ---
        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Payload not found");
                const payload = await response.json();
                
                appState.papers = payload.papers || [];
                
                if (appState.papers.length === 0) {
                    throw new Error("No papers in payload");
                }

                renderPaperSelector();
                
                // Select first paper by default
                switchPaper(appState.papers[0].key);
                
                lucide.createIcons();

            } catch (e) {
                console.error(e);
                els.paperContent.innerHTML = `
                    <div class="flex flex-col items-center justify-center pt-20 text-center">
                        <div class="text-xl font-bold text-primary mb-2">PAPERS PAYLOAD MISSING</div>
                        <div class="text-secondary text-sm max-w-md">
                            Could not load content from ${RTQ_PAPERS_PAYLOAD_PATH}.<br>
                            Ensure the file exists and is accessible.
                        </div>
                    </div>
                `;
                els.paperSelector.innerHTML = '<option disabled>Error loading</option>';
            }
        }

        // --- RENDERERS ---

        function renderPaperSelector() {
            els.paperSelector.innerHTML = appState.papers.map(p => 
                `<option value="${p.key}">${p.label}</option>`
            ).join('');

            els.paperSelector.addEventListener('change', (e) => {
                switchPaper(e.target.value);
            });
        }

        function switchPaper(key) {
            const paper = appState.papers.find(p => p.key === key);
            if (!paper) return;

            appState.activePaperKey = key;
            appState.defaultExpanded = paper.defaults?.expandedAll !== false;
            
            // Reset working states based on defaults
            appState.expandedWorkings.clear();
            
            // Flatten questions to set initial state if needed
            // Actually, we determine state dynamically or just assume default on render
            // But if we want to track user toggles, we start empty and fallback to default logic
            
            // Render
            renderNavigation(paper);
            renderContent(paper);
            
            // Reset Scroll
            els.paperColumn.scrollTop = 0;
            
            // Math Typeset
            requestAnimationFrame(() => {
                renderMathInElement(els.paperContent, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false}
                    ],
                    throwOnError: false
                });
            });
        }

        function renderNavigation(paper) {
            // Logic to build flat list with section headers
            let html = '';
            
            const isSectioned = !!paper.sections;
            const items = isSectioned ? paper.sections : [{ label: '', questions: paper.questions }];

            items.forEach(section => {
                if (isSectioned && section.label && section.label.trim() !== '') {
                    html += `
                        <div class="mt-4 mb-2 text-xs font-semibold text-secondary uppercase tracking-wider pl-3 select-none">
                            ${section.label}
                        </div>
                    `;
                }
                
                // Helper to walk tree
                const walk = (qs, depth = 0) => {
                    qs.forEach(q => {
                        // Sub-question hierarchy via type scale/weight, flat list
                        // Using visual weight reduction for sub-items
                        const isTop = depth === 0;
                        const fontSize = isTop ? 'text-sm' : 'text-xs';
                        const color = isTop ? 'text-primary' : 'text-secondary';
                        const weight = isTop ? 'font-medium' : 'font-normal';
                        
                        // Active state logic would go here (scroll spy) - Baseline: weight only
                        
                        html += `
                            <button onclick="scrollToQuestion('${q.id}')" 
                                class="text-left w-full py-1 pl-3 border-l-2 border-transparent hover:border-accent hover:text-accent transition-colors ${fontSize} ${color} ${weight}">
                                ${q.id}
                            </button>
                        `;

                        if (q.children) walk(q.children, depth + 1);
                    });
                };
                
                walk(section.questions);
            });

            els.desktopNavList.innerHTML = html;
            els.drawerNavList.innerHTML = html;
        }

        function renderContent(paper) {
            let html = '';
            
            const isSectioned = !!paper.sections;
            const items = isSectioned ? paper.sections : [{ label: '', questions: paper.questions }];

            items.forEach((section, idx) => {
                // Section Header (Page Level)
                if (isSectioned && section.label && section.label.trim() !== '') {
                    html += `
                        <div class="mt-12 mb-8 pb-2 border-b border-divider">
                            <h2 class="text-xl font-bold text-primary">${section.label}</h2>
                        </div>
                    `;
                } else if (idx > 0) {
                    // Spacing between implicit sections
                    html += `<div class="h-12"></div>`; 
                }

                // Questions
                section.questions.forEach((q, i) => {
                    html += renderQuestionNode(q, 0, i === 0);
                });
            });

            els.paperContent.innerHTML = html;
            lucide.createIcons();
            setupToggles();
        }

        function renderQuestionNode(node, depth, isFirst) {
            const indentClass = depth > 0 ? 'ml-0 md:ml-6 mt-6' : 'mt-12';
            const topMargin = isFirst && depth === 0 ? 'mt-0' : indentClass;
            
            const hasSolBlock = !!node.solutionBlock;
            const hasDetails = hasSolBlock && !!node.solutionBlock.solutionDetails;
            const hasAnswer = hasSolBlock && !!node.solutionBlock.answer;
            
            // Determine expanded state: user preference > default
            const isExpanded = appState.expandedWorkings.has(node.id) || (!appState.expandedWorkings.has(node.id) && appState.defaultExpanded);

            let html = `
                <div id="q-${node.id}" class="group ${topMargin} scroll-mt-24">
                    <!-- Question Body -->
                    <div class="flex gap-4">
                        <div class="flex-none w-8 pt-0.5 text-right font-medium text-secondary text-sm select-none">
                            ${node.id}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="prose text-primary text-base max-w-none">
                                ${mdRender(node.question)}
                            </div>
                        </div>
                    </div>
            `;

            if (hasSolBlock) {
                html += `<div class="ml-12 mt-4">`; // Indent solution block to align with question text
                
                // Answer
                if (hasAnswer) {
                    html += `
                        <div class="mb-3">
                            <span class="text-xs font-bold text-secondary uppercase tracking-wider mr-2">Answer</span>
                            <div class="inline-block text-primary font-medium">
                                ${mdRender(node.solutionBlock.answer)}
                            </div>
                        </div>
                    `;
                }

                // Solution Details Toggle & Region
                if (hasDetails) {
                    const sd = node.solutionBlock.solutionDetails;
                    const expandId = `sd-${node.id}`;
                    const btnText = isExpanded ? "Hide working" : "Show working";
                    const displayStyle = isExpanded ? 'block' : 'none';
                    const iconRot = isExpanded ? 'rotate-180' : '';

                    html += `
                        <!-- Toggle -->
                        <button class="toggle-btn flex items-center gap-1.5 text-sm font-medium text-accent hover:text-accent-hover mb-3 focus:outline-none focus-visible:ring-2 focus-visible:ring-accent rounded px-1 -ml-1" 
                            data-target="${expandId}" data-qid="${node.id}">
                            <span>${btnText}</span>
                            <i data-lucide="chevron-down" class="w-4 h-4 transition-transform duration-200 ${iconRot}"></i>
                        </button>

                        <!-- Region -->
                        <div id="${expandId}" class="bg-wash rounded-sm overflow-hidden border-l-2 border-divider pl-4 pr-3 py-4 text-sm space-y-5 anim-reveal" style="display: ${displayStyle}">
                    `;

                    // Subsections
                    // 1. Keep in mind
                    if (sd.keepInMind) {
                        html += `
                            <div class="space-y-1">
                                <div class="flex items-center gap-2 text-xs font-bold text-secondary uppercase tracking-wider">
                                    <i data-lucide="lightbulb" class="w-3 h-3"></i>
                                    Keep in mind
                                </div>
                                <div class="prose prose-sm text-secondary">
                                    ${mdRender(sd.keepInMind)}
                                </div>
                            </div>
                        `;
                    }

                    // 2. Formulas Used
                    if (sd.formulasUsed) {
                         html += `
                            <div class="space-y-1">
                                <div class="text-xs font-bold text-secondary uppercase tracking-wider">Formulas used</div>
                                <div class="prose prose-sm text-secondary">
                                    ${mdRender(sd.formulasUsed)}
                                </div>
                            </div>
                        `;
                    }

                    // 3. Working
                    if (sd.working) {
                        html += `
                            <div class="space-y-2">
                                <div class="text-xs font-bold text-secondary uppercase tracking-wider">Working</div>
                                <div class="prose prose-sm text-primary">
                                    ${mdRender(sd.working)}
                                </div>
                            </div>
                        `;
                    }

                    // 4. Alternative Working
                    if (sd.alternativeWorking && Array.isArray(sd.alternativeWorking)) {
                        sd.alternativeWorking.forEach(alt => {
                            html += `
                                <div class="pt-4 border-t border-divider space-y-2">
                                    <div class="text-xs font-bold text-secondary uppercase tracking-wider">Alternative working</div>
                                    <div class="prose prose-sm text-primary">
                                        ${mdRender(alt)}
                                    </div>
                                </div>
                            `;
                        });
                    } else if (sd.alternativeWorking && typeof sd.alternativeWorking === 'string') {
                         html += `
                                <div class="pt-4 border-t border-divider space-y-2">
                                    <div class="text-xs font-bold text-secondary uppercase tracking-wider">Alternative working</div>
                                    <div class="prose prose-sm text-primary">
                                        ${mdRender(sd.alternativeWorking)}
                                    </div>
                                </div>
                            `;
                    }

                    html += `</div>`; // End Region
                }

                html += `</div>`; // End Indent
            }

            html += `</div>`; // End Question Wrapper

            // Children
            if (node.children && node.children.length > 0) {
                node.children.forEach(child => {
                    html += renderQuestionNode(child, depth + 1, false);
                });
            }

            return html;
        }

        function mdRender(text) {
            if (!text) return '';
            if (!md) return text; // Fallback
            return md.render(text);
        }

        // --- INTERACTION HANDLERS ---
        
        function setupToggles() {
            document.querySelectorAll('.toggle-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    // Find closest btn in case of icon click
                    const trigger = e.target.closest('button');
                    const targetId = trigger.getAttribute('data-target');
                    const qid = trigger.getAttribute('data-qid');
                    const targetEl = document.getElementById(targetId);
                    const textSpan = trigger.querySelector('span');
                    const icon = trigger.querySelector('i');
                    
                    const isHidden = targetEl.style.display === 'none';
                    
                    if (isHidden) {
                        targetEl.style.display = 'block';
                        textSpan.textContent = "Hide working";
                        icon.style.transform = "rotate(180deg)";
                        appState.expandedWorkings.add(qid);
                    } else {
                        targetEl.style.display = 'none';
                        textSpan.textContent = "Show working";
                        icon.style.transform = "rotate(0deg)";
                        appState.expandedWorkings.delete(qid);
                    }
                });
            });
        }

        window.scrollToQuestion = (id) => {
            const el = document.getElementById(`q-${id}`);
            if (el) {
                el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                // Flash effect? No, kept calm per brief.
                
                // Close drawer if open
                closeDrawer();
            }
        };

        // --- MOBILE DRAWER ---
        const openDrawer = () => {
            els.mobileDrawer.classList.remove('translate-x-full');
            els.drawerBackdrop.classList.remove('opacity-0', 'pointer-events-none');
        };
        
        const closeDrawer = () => {
            els.mobileDrawer.classList.add('translate-x-full');
            els.drawerBackdrop.classList.add('opacity-0', 'pointer-events-none');
        };

        els.mobileJumpTrigger.addEventListener('click', openDrawer);
        els.drawerClose.addEventListener('click', closeDrawer);
        els.drawerBackdrop.addEventListener('click', closeDrawer);

        // --- RUN ---
        init();

    </script>
</body>
</html>
