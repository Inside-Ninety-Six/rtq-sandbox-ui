<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"ABC","indexWithinVariant":"223","totalWithinVariant":"320","hueFamily":"pink","intensityMode":"high_chroma_surfaces","timestamp":"2026-01-07T20:04:43.482Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;ABC&quot;,&quot;indexWithinVariant&quot;:&quot;223&quot;,&quot;totalWithinVariant&quot;:&quot;320&quot;,&quot;hueFamily&quot;:&quot;pink&quot;,&quot;intensityMode&quot;:&quot;high_chroma_surfaces&quot;,&quot;timestamp&quot;:&quot;2026-01-07T20:04:43.482Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer (Stage 6 Baseline)</title>

    <!-- 
        STAGE 6 BASELINE LIBRARIES 
        - Markdown-it for payload rendering
        - KaTeX for math rendering
        - No SRI integrity per instruction
    -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/13.0.1/markdown-it.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/contrib/auto-render.min.js"></script>

    <style>
        /* 
         * STAGE 6 ADD-ON: COLORLAB C (High Chroma Surfaces / Pink / Light Mode)
         * Mode: high_chroma_surfaces
         * Hue: Pink (approx 350deg)
         * 
         * Logic:
         * 1. Two major surfaces C in [0.06 .. 0.12] -> Page & Frame
         * 2. Remaining surface C in [0.03 .. 0.07] -> Paper
         * 3. Wash C in [0.05 .. 0.10]
         * 4. Accent C in [0.12 .. 0.20]
         * 5. Text C <= 0.015
         */
        :root {
            /* Palette - Pink Family (H=350) */
            
            /* Major Surfaces */
            --c-page-bg: oklch(0.96 0.07 350);  /* High chroma */
            --c-frame-bg: oklch(0.93 0.09 350); /* High chroma */
            --c-paper-bg: oklch(0.985 0.035 350); /* Tinted "remaining" surface */

            /* Supporting Surfaces */
            --c-wash-bg: oklch(0.95 0.06 350); /* Solution details wash */
            --c-nav-marker: oklch(0.60 0.16 350); /* Accent used for marker */
            
            /* Text - Neutral/Restrained */
            --c-text-primary: oklch(0.20 0.015 350);
            --c-text-secondary: oklch(0.40 0.015 350);
            --c-text-quiet: oklch(0.55 0.015 350);

            /* Accents (Restrained usage: Links, Focus, Controls) */
            --c-accent: oklch(0.55 0.18 350); 
            --c-accent-hover: oklch(0.50 0.20 350);
            
            /* Separators */
            --c-divider: oklch(0.85 0.04 350);

            /* Focus Ring */
            --c-focus: var(--c-accent);

            /* Spacing Units */
            --sp-xs: 0.25rem;
            --sp-s: 0.5rem;
            --sp-m: 1rem;
            --sp-l: 1.5rem;
            --sp-xl: 2.5rem;
            --sp-xxl: 4rem;

            /* Font */
            --font-stack: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }

        /* RESET & BASE */
        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: var(--font-stack);
            background-color: var(--c-page-bg);
            color: var(--c-text-primary);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            overflow-y: scroll; /* Force scrollbar stability */
        }

        /* UTILITIES */
        .hidden { display: none !important; }
        .visually-hidden {
            position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px;
            overflow: hidden; clip: rect(0, 0, 0, 0); border: 0;
        }
        button {
            font-family: inherit;
            border: none;
            background: none;
            cursor: pointer;
            padding: 0;
            color: inherit;
        }
        button:focus-visible, a:focus-visible, select:focus-visible {
            outline: 2px solid var(--c-focus);
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* LAYOUT SHELL */
        .shell-root {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Top Controls */
        .top-controls {
            padding: var(--sp-m);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: transparent; /* Sits on page bg */
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        .paper-selector {
            font-size: 0.95rem;
            padding: var(--sp-s) var(--sp-m);
            border-radius: 4px;
            border: 1px solid var(--c-divider);
            background-color: var(--c-paper-bg);
            color: var(--c-text-primary);
        }

        .mobile-jump-trigger {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--c-accent);
            display: none; /* Desktop default */
        }

        /* Document Frame Shell */
        .doc-frame {
            flex: 1;
            display: flex;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            background-color: var(--c-frame-bg);
            border-radius: 8px 8px 0 0; /* Subtle paper sheet feel */
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); /* Very subtle depth */
        }

        /* Navigation Column (Desktop) */
        .nav-column {
            width: 240px;
            flex-shrink: 0;
            padding: var(--sp-l) var(--sp-m);
            border-right: 1px solid var(--c-divider);
            display: block;
        }
        
        .nav-sticky-container {
            position: sticky;
            top: var(--sp-l);
            max-height: calc(100vh - 2 * var(--sp-l));
            overflow-y: auto;
            scrollbar-width: none; /* Firefox */
        }
        .nav-sticky-container::-webkit-scrollbar {
            display: none; /* Chrome/Safari */
        }

        /* Navigation List */
        .nav-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: var(--sp-xs);
        }
        
        .nav-section-label {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--c-text-quiet);
            margin-top: var(--sp-m);
            margin-bottom: var(--sp-s);
            font-weight: 600;
            padding-left: var(--sp-s);
        }
        .nav-section-label:first-child {
            margin-top: 0;
        }

        .nav-item {
            font-size: 0.9rem;
            color: var(--c-text-secondary);
            padding: 2px var(--sp-s);
            text-decoration: none;
            display: block;
            border-left: 2px solid transparent;
            transition: color 0.2s, border-color 0.2s;
        }
        
        .nav-item:hover {
            color: var(--c-text-primary);
            border-left-color: var(--c-divider);
        }

        .nav-item.active {
            color: var(--c-text-primary);
            font-weight: 700;
            border-left-color: var(--c-nav-marker);
        }

        /* Hierarchy visual cues in flat list */
        .nav-item[data-depth="1"] { font-size: 0.85rem; color: var(--c-text-quiet); }
        .nav-item[data-depth="2"] { font-size: 0.8rem; color: var(--c-text-quiet); }
        .nav-item[data-depth="1"].active, .nav-item[data-depth="2"].active { color: var(--c-text-primary); }

        /* Paper Column */
        .paper-column {
            flex: 1;
            padding: var(--sp-xl);
            background-color: var(--c-paper-bg);
            /* Ensure containment context */
            min-width: 0; 
        }

        /* PAPER CONTENT TYPOGRAPHY & LAYOUT */
        
        /* Section Header in Paper */
        .paper-section-header {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--c-text-primary);
            margin-top: var(--sp-xxl);
            margin-bottom: var(--sp-l);
            padding-bottom: var(--sp-s);
            border-bottom: 1px solid var(--c-divider);
        }
        .paper-section-header:first-child { margin-top: 0; }

        /* Top Level Question Node */
        .question-node-top {
            margin-bottom: var(--sp-xxl); /* Largest spacing unit */
        }

        .question-body {
            display: flex;
            gap: var(--sp-m);
            font-size: 1.125rem;
            color: var(--c-text-primary);
        }

        .q-id {
            font-weight: 700;
            min-width: 2rem;
            flex-shrink: 0;
        }
        
        .q-prompt {
            flex: 1;
            /* Markdown content spacing */
        }
        .q-prompt p { margin-top: 0; margin-bottom: 0.75em; }
        .q-prompt p:last-child { margin-bottom: 0; }

        /* Sub-questions */
        .children-container {
            margin-top: var(--sp-m);
            padding-left: var(--sp-l); /* Indentation for structure */
            display: flex;
            flex-direction: column;
            gap: var(--sp-l); /* Weaker separation than top-level */
        }
        
        /* Solution Block */
        .solution-block {
            margin-top: var(--sp-m);
            margin-left: calc(2rem + var(--sp-m)); /* Align with prompt */
            /* No border/card styling per rules */
        }

        /* Answer */
        .answer-region {
            margin-bottom: var(--sp-s);
        }
        .answer-label {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--c-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: block;
            margin-bottom: var(--sp-xs);
        }
        .answer-content {
            font-size: 1rem;
            color: var(--c-text-primary);
        }

        /* Solution Details Control */
        .sd-control-wrapper {
            margin-top: var(--sp-s);
            margin-bottom: var(--sp-s);
        }
        .sd-toggle {
            font-size: 0.95rem;
            color: var(--c-accent);
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .sd-toggle:hover {
            color: var(--c-accent-hover);
            text-decoration: underline;
        }
        .chevron {
            transition: transform 0.2s ease;
            width: 1em; height: 1em;
            fill: currentColor;
        }
        .sd-toggle[aria-expanded="true"] .chevron {
            transform: rotate(180deg);
        }

        /* Solution Details Region */
        .solution-details-region {
            margin-top: var(--sp-s);
            padding: var(--sp-m);
            background-color: var(--c-wash-bg); /* Surface differentiation */
            border-radius: 4px; /* Subtle adjustment, not a card */
        }
        
        /* Internal Solution Details Typography */
        .sd-subsection {
            margin-bottom: var(--sp-m);
        }
        .sd-subsection:last-child { margin-bottom: 0; }

        .sd-label {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--c-text-secondary);
            margin-bottom: var(--sp-xs);
            display: block;
        }

        .sd-content {
            font-size: 1rem;
            color: var(--c-text-primary);
            line-height: 1.4;
        }
        
        /* Keep in mind specific */
        .sd-kim-list {
            margin: 0; padding-left: 1.2em;
        }

        /* Formulas used specific */
        .sd-formulas-list {
            margin: 0; padding-left: 0;
            list-style: none;
            font-family: var(--font-stack);
        }

        /* Working / Alt Working internal spacing */
        .sd-content p { margin-top: 0; margin-bottom: 0.5em; }
        .sd-content p:last-child { margin-bottom: 0; }

        /* Alternative Working Separation */
        .alt-working-separator {
            height: 1px;
            background-color: var(--c-divider);
            margin: var(--sp-m) 0;
        }

        /* KaTeX / Markdown Overrides */
        .katex-display {
            max-width: 100%;
            overflow-x: auto;
            overflow-y: hidden;
            padding: 0.5em 0;
            margin: 0.5em 0;
            /* Scrollbar hiding logic */
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .katex-display::-webkit-scrollbar { display: none; }
        
        /* Block math underlay handled by region wash implicitly, 
           but prompt permits specific display math underlay. 
           Given the "High Chroma" pink wash, extra underlay might be noisy. 
           We stick to the region wash. */

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
            margin: var(--sp-s) 0;
        }
        th, td {
            border: 1px solid var(--c-divider);
            padding: var(--sp-s);
            text-align: left;
        }
        th { font-weight: 600; background-color: rgba(0,0,0,0.02); }
        .table-wrapper {
            overflow-x: auto;
            max-width: 100%;
        }

        /* MOBILE DRAWER */
        .drawer-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0,0,0,0.3); /* Scrim */
            z-index: 100;
            display: none;
        }
        .drawer-overlay.open { display: block; }
        
        .drawer-panel {
            position: fixed;
            top: 0; left: 0; bottom: 0;
            width: 280px;
            background-color: var(--c-frame-bg);
            z-index: 101;
            transform: translateX(-100%);
            transition: transform 0.2s ease-out;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 8px rgba(0,0,0,0.1);
        }
        .drawer-panel.open { transform: translateX(0); }

        .drawer-header {
            padding: var(--sp-m);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--c-divider);
        }
        .drawer-title { font-weight: 700; color: var(--c-text-primary); }
        .drawer-close { font-size: 1.5rem; line-height: 1; color: var(--c-text-secondary); }
        
        .drawer-content {
            flex: 1;
            overflow-y: auto;
            padding: var(--sp-m);
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .nav-column { display: none; }
            .mobile-jump-trigger { display: block; }
            .paper-column { padding: var(--sp-m); }
            .solution-block { margin-left: 0; padding-left: var(--sp-s); border-left: 2px solid var(--c-divider); } /* Fallback separation for mobile density */
            .children-container { padding-left: var(--sp-m); }
        }

    </style>
</head>
<body>

    <div class="shell-root">
        <!-- TOP CONTROLS -->
        <div class="top-controls">
            <select id="paperSelector" class="paper-selector" aria-label="Select paper">
                <option disabled selected>Loading papers...</option>
            </select>
            <button id="mobileJumpTrigger" class="mobile-jump-trigger">Jump to question</button>
        </div>

        <!-- DOCUMENT FRAME -->
        <div class="doc-frame">
            <!-- NAV RAIL (Desktop) -->
            <nav class="nav-column" aria-label="Document navigation">
                <div class="nav-sticky-container" id="desktopNavContainer">
                    <!-- Nav generated here -->
                </div>
            </nav>

            <!-- PAPER REGION -->
            <main class="paper-column" id="paperContent">
                <!-- Content generated here -->
                <div style="padding: 2rem; text-align: center; color: var(--c-text-quiet);">Initializing...</div>
            </main>
        </div>
    </div>

    <!-- MOBILE DRAWER -->
    <div id="drawerOverlay" class="drawer-overlay"></div>
    <div id="drawerPanel" class="drawer-panel" aria-modal="true" role="dialog" aria-label="Navigation">
        <div class="drawer-header">
            <span class="drawer-title">Jump to</span>
            <button id="drawerClose" class="drawer-close">&times;</button>
        </div>
        <div class="drawer-content" id="mobileNavContainer">
            <!-- Nav generated here -->
        </div>
    </div>

    <script>
        // STAGE 0: CONSTANTS (Canonical)
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // APP STATE
        let papersData = [];
        let currentPaper = null;
        let md = null;

        // MARKDOWN SETUP
        if (window.markdownit) {
            md = window.markdownit({
                html: true,     // Payload SVG passthrough
                linkify: true,
                breaks: false   // Critical: prevent <br> in math
            });
            // Disable escape rule to preserve TeX backslashes
            md.inline.ruler.disable(['escape']);
        }

        // INITIALIZATION
        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Payload missing");
                const data = await response.json();
                papersData = data.papers || [];
                
                if (papersData.length === 0) {
                    renderError("NO PAPERS FOUND IN PAYLOAD");
                    return;
                }

                populateSelector();
                loadPaper(papersData[0].key);

            } catch (e) {
                console.error(e);
                renderError("PAPERS PAYLOAD MISSING");
            }
        }

        function renderError(msg) {
            const el = document.getElementById('paperContent');
            el.innerHTML = `<div style="display:flex;justify-content:center;align-items:center;height:200px;font-weight:700;color:var(--c-text-secondary);">${msg}</div>`;
            document.getElementById('paperSelector').innerHTML = '<option>Error</option>';
        }

        // SELECTOR LOGIC
        function populateSelector() {
            const sel = document.getElementById('paperSelector');
            sel.innerHTML = '';
            papersData.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.key;
                opt.textContent = p.label || p.key;
                sel.appendChild(opt);
            });
            sel.addEventListener('change', (e) => loadPaper(e.target.value));
        }

        // PAPER LOADING
        function loadPaper(key) {
            currentPaper = papersData.find(p => p.key === key);
            if (!currentPaper) return;

            // 1. Render Content
            const contentEl = document.getElementById('paperContent');
            contentEl.innerHTML = '';
            
            const isSectioned = currentPaper.sections && currentPaper.sections.length > 0;
            const expandedDefault = currentPaper.defaults?.expandedAll !== false;

            if (isSectioned) {
                currentPaper.sections.forEach(section => {
                    // Render Section Header if label exists
                    if (section.label && section.label.trim().length > 0) {
                        const h = document.createElement('div');
                        h.className = 'paper-section-header';
                        h.textContent = section.label;
                        contentEl.appendChild(h);
                    }
                    // Render Questions
                    if (section.questions) {
                        section.questions.forEach(q => {
                            contentEl.appendChild(renderQuestionNode(q, 1, expandedDefault));
                        });
                    }
                });
            } else if (currentPaper.questions) {
                currentPaper.questions.forEach(q => {
                    contentEl.appendChild(renderQuestionNode(q, 1, expandedDefault));
                });
            }

            // 2. Render Navigation (Desktop & Mobile)
            renderNavigation(isSectioned);

            // 3. Render Math
            renderMath(contentEl);

            // 4. Scroll to top
            window.scrollTo(0,0);
        }

        // CONTENT RENDERING (RECURSIVE)
        function renderQuestionNode(node, depth, expandedDefault) {
            const wrapper = document.createElement('div');
            wrapper.className = depth === 1 ? 'question-node-top' : 'question-node-child';
            wrapper.id = `q-${node.id}`; // Anchor for nav

            // Question Body
            const body = document.createElement('div');
            body.className = 'question-body';
            
            const idEl = document.createElement('div');
            idEl.className = 'q-id';
            idEl.textContent = node.id;
            
            const promptEl = document.createElement('div');
            promptEl.className = 'q-prompt';
            promptEl.innerHTML = renderMarkdown(node.question || "");

            body.appendChild(idEl);
            body.appendChild(promptEl);
            wrapper.appendChild(body);

            // Solution Block
            if (node.solutionBlock) {
                const sb = node.solutionBlock;
                const hasAnswer = sb.answer && sb.answer.trim().length > 0;
                const hasDetails = sb.solutionDetails && (
                    sb.solutionDetails.working || 
                    sb.solutionDetails.keepInMind || 
                    sb.solutionDetails.formulasUsed
                );

                if (hasAnswer || hasDetails) {
                    const block = document.createElement('div');
                    block.className = 'solution-block';

                    // Answer
                    if (hasAnswer) {
                        const ansReg = document.createElement('div');
                        ansReg.className = 'answer-region';
                        ansReg.innerHTML = `
                            <span class="answer-label">Answer</span>
                            <div class="answer-content">${renderMarkdown(sb.answer)}</div>
                        `;
                        block.appendChild(ansReg);
                    }

                    // Solution Details
                    if (hasDetails) {
                        // Toggle Control
                        const controlWrap = document.createElement('div');
                        controlWrap.className = 'sd-control-wrapper';
                        
                        const btn = document.createElement('button');
                        btn.className = 'sd-toggle';
                        const isExpanded = expandedDefault; // Defaults logic
                        btn.setAttribute('aria-expanded', isExpanded);
                        btn.innerHTML = `
                            <span class="btn-text">${isExpanded ? 'Hide working' : 'Show working'}</span>
                            <svg class="chevron" viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>
                        `;
                        
                        const detailsRegion = document.createElement('div');
                        detailsRegion.className = 'solution-details-region';
                        if (!isExpanded) detailsRegion.classList.add('hidden');

                        // Event Listener
                        btn.onclick = () => {
                            const expanded = btn.getAttribute('aria-expanded') === 'true';
                            btn.setAttribute('aria-expanded', !expanded);
                            btn.querySelector('.btn-text').textContent = !expanded ? 'Hide working' : 'Show working';
                            detailsRegion.classList.toggle('hidden');
                        };

                        controlWrap.appendChild(btn);
                        block.appendChild(controlWrap);

                        // Content Rendering
                        const sd = sb.solutionDetails;
                        
                        // Keep in mind
                        if (sd.keepInMind) {
                            const section = document.createElement('div');
                            section.className = 'sd-subsection';
                            section.innerHTML = `<span class="sd-label">Keep in mind</span><div class="sd-content sd-kim-list">${renderMarkdown(sd.keepInMind)}</div>`;
                            detailsRegion.appendChild(section);
                        }

                        // Formulas used
                        if (sd.formulasUsed) {
                            const section = document.createElement('div');
                            section.className = 'sd-subsection';
                            section.innerHTML = `<span class="sd-label">Formulas used</span><div class="sd-content sd-formulas-list">${renderMarkdown(sd.formulasUsed)}</div>`;
                            detailsRegion.appendChild(section);
                        }

                        // Working
                        if (sd.working) {
                            const section = document.createElement('div');
                            section.className = 'sd-subsection';
                            section.innerHTML = `<span class="sd-label">Working</span><div class="sd-content">${renderMarkdown(sd.working)}</div>`;
                            detailsRegion.appendChild(section);
                        }

                        // Alternative working
                        if (sd.alternativeWorking && Array.isArray(sd.alternativeWorking)) {
                            sd.alternativeWorking.forEach(alt => {
                                const sep = document.createElement('div');
                                sep.className = 'alt-working-separator';
                                detailsRegion.appendChild(sep);

                                const section = document.createElement('div');
                                section.className = 'sd-subsection';
                                section.innerHTML = `<span class="sd-label">Alternative working</span><div class="sd-content">${renderMarkdown(alt)}</div>`;
                                detailsRegion.appendChild(section);
                            });
                        } else if (typeof sd.alternativeWorking === 'string') {
                             // Fallback if string
                            const sep = document.createElement('div');
                            sep.className = 'alt-working-separator';
                            detailsRegion.appendChild(sep);

                            const section = document.createElement('div');
                            section.className = 'sd-subsection';
                            section.innerHTML = `<span class="sd-label">Alternative working</span><div class="sd-content">${renderMarkdown(sd.alternativeWorking)}</div>`;
                            detailsRegion.appendChild(section);
                        }

                        block.appendChild(detailsRegion);
                    }
                    wrapper.appendChild(block);
                }
            }

            // Children
            if (node.children && node.children.length > 0) {
                const childContainer = document.createElement('div');
                childContainer.className = 'children-container';
                node.children.forEach(child => {
                    childContainer.appendChild(renderQuestionNode(child, depth + 1, expandedDefault));
                });
                wrapper.appendChild(childContainer);
            }

            return wrapper;
        }

        // NAV RENDERING
        function renderNavigation(isSectioned) {
            const containers = [document.getElementById('desktopNavContainer'), document.getElementById('mobileNavContainer')];
            
            containers.forEach(cont => {
                cont.innerHTML = '';
                const list = document.createElement('ul');
                list.className = 'nav-list';

                const generateItems = (questions, sectionLabel) => {
                    if (isSectioned && sectionLabel) {
                         const sec = document.createElement('li');
                         sec.className = 'nav-section-label';
                         sec.textContent = sectionLabel;
                         list.appendChild(sec);
                    }
                    
                    const traverse = (nodes, depth) => {
                        nodes.forEach(n => {
                            const li = document.createElement('li');
                            const a = document.createElement('a');
                            a.href = `#q-${n.id}`;
                            a.className = 'nav-item';
                            a.textContent = n.id;
                            a.dataset.depth = Math.min(depth, 3); // Cap depth attribute
                            
                            a.onclick = (e) => {
                                e.preventDefault();
                                document.getElementById(`q-${n.id}`).scrollIntoView({behavior: 'smooth', block: 'start'});
                                // Update active state logic could go here, but IntersectionObserver is better.
                                // Close drawer on mobile
                                toggleDrawer(false);
                            };

                            li.appendChild(a);
                            list.appendChild(li);

                            if (n.children) traverse(n.children, depth + 1);
                        });
                    };
                    traverse(questions, 1);
                };

                if (isSectioned) {
                    currentPaper.sections.forEach(s => generateItems(s.questions, s.label));
                } else {
                    generateItems(currentPaper.questions || [], null);
                }

                cont.appendChild(list);
            });

            setupIntersectionObserver();
        }

        // UTILS
        function renderMarkdown(text) {
            if (!md) return text; // Fallback
            return md.render(text || "");
        }

        function renderMath(container) {
            if (window.renderMathInElement) {
                renderMathInElement(container, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false},
                        {left: '\\(', right: '\\)', display: false},
                        {left: '\\[', right: '\\]', display: true}
                    ],
                    throwOnError: false
                });
            }
        }

        // ACTIVE NAV STATE
        function setupIntersectionObserver() {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const id = entry.target.id.replace('q-', '');
                        document.querySelectorAll('.nav-item').forEach(n => {
                            n.classList.toggle('active', n.textContent === id);
                        });
                    }
                });
            }, { rootMargin: '-10% 0px -80% 0px' }); // Trigger near top

            document.querySelectorAll('[id^="q-"]').forEach(el => observer.observe(el));
        }

        // MOBILE DRAWER LOGIC
        const drawer = document.getElementById('drawerPanel');
        const overlay = document.getElementById('drawerOverlay');
        
        function toggleDrawer(show) {
            if (show) {
                drawer.classList.add('open');
                overlay.classList.add('open');
            } else {
                drawer.classList.remove('open');
                overlay.classList.remove('open');
            }
        }

        document.getElementById('mobileJumpTrigger').onclick = () => toggleDrawer(true);
        document.getElementById('drawerClose').onclick = () => toggleDrawer(false);
        overlay.onclick = () => toggleDrawer(false);

        // START
        init();

    </script>
</body>
</html>
