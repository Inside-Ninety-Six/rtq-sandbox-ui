<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"ABC","indexWithinVariant":"222","totalWithinVariant":"320","hueFamily":"pink","intensityMode":"tinted_neutrals","timestamp":"2026-01-07T20:01:58.640Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;ABC&quot;,&quot;indexWithinVariant&quot;:&quot;222&quot;,&quot;totalWithinVariant&quot;:&quot;320&quot;,&quot;hueFamily&quot;:&quot;pink&quot;,&quot;intensityMode&quot;:&quot;tinted_neutrals&quot;,&quot;timestamp&quot;:&quot;2026-01-07T20:01:58.640Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer (Stage 6 Baseline)</title>

    <!-- Tailwind CSS (via CDN for prototype) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- KaTeX (No Integrity/SRI as per Stage 6 Baseline) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Markdown-it -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        // ColorLab B: Force Hue Family "pink" (H ~ 350)
                        // ColorLab C: Intensity Mode "tinted_neutrals"
                        // - Core surfaces C in [0.015 .. 0.035]
                        // - Wash surfaces C in [0.025 .. 0.045]
                        // - Text C <= 0.010 / 0.012
                        // - Accent C in [0.10 .. 0.16]
                        
                        page: 'oklch(0.97 0.018 350)',    // Tinted page background
                        paper: 'oklch(0.99 0.015 350)',   // Slightly lighter paper surface
                        wash: 'oklch(0.96 0.035 350)',    // Solution details wash
                        
                        primary: 'oklch(0.20 0.008 350)', // Text primary
                        secondary: 'oklch(0.45 0.010 350)', // Text secondary
                        
                        accent: 'oklch(0.60 0.13 350)',   // Accent (Link, Focus, Control)
                        'accent-hover': 'oklch(0.55 0.13 350)',
                        
                        hairline: 'oklch(0.90 0.02 350)', // Divider
                    }
                }
            }
        }
    </script>

    <style>
        /* Base & Reset */
        body {
            background-color: theme('colors.page');
            color: theme('colors.primary');
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Scrollbar Hiding for Nav */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Focus Styling (Custom, Restrained) */
        *:focus-visible {
            outline: 2px solid theme('colors.accent');
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* KaTeX Containment Invariant */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding-bottom: 4px; /* Space for scrollbar if needed */
            -webkit-overflow-scrolling: touch;
        }
        
        /* Markdown Content Styles */
        .markdown-body p {
            margin-bottom: 1rem;
            line-height: 1.6;
        }
        .markdown-body p:last-child {
            margin-bottom: 0;
        }
        /* Tables (Minimal, Structural) */
        .markdown-body table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
            font-size: 0.95em;
        }
        .markdown-body th, .markdown-body td {
            border: 1px solid theme('colors.hairline');
            padding: 0.5rem 0.75rem;
            text-align: left;
        }
        .markdown-body th {
            font-weight: 500;
            color: theme('colors.primary');
        }
        /* Lists */
        .markdown-body ul {
            list-style-type: disc;
            padding-left: 1.5rem;
            margin-bottom: 1rem;
        }
        .markdown-body ol {
            list-style-type: decimal;
            padding-left: 1.5rem;
            margin-bottom: 1rem;
        }
        
        /* Inline KaTeX: No background */
        .katex {
            background-color: transparent !important;
        }
        
        /* Layout Utilities */
        .layout-grid {
            display: grid;
            grid-template-columns: 1fr;
        }
        @media (min-width: 1024px) {
            .layout-grid {
                grid-template-columns: 240px minmax(0, 1fr); /* Nav Rail + Paper */
                gap: 2rem;
                align-items: start;
            }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Top Controls Region -->
    <header class="w-full max-w-6xl mx-auto px-4 lg:px-8 pt-4 pb-2 flex items-center justify-between lg:justify-start gap-4">
        <!-- Paper Selector -->
        <div id="paper-selector-container" class="relative z-10">
            <!-- Injected via JS -->
        </div>

        <!-- Mobile Jump To Trigger -->
        <button id="mobile-jump-trigger" class="lg:hidden text-accent text-sm font-medium flex items-center gap-1">
            <span data-lucide="menu" class="w-4 h-4"></span>
            Jump to
        </button>
    </header>

    <div class="border-b border-hairline w-full mb-6 lg:mb-8 opacity-50"></div>

    <!-- DocumentFrameShell -->
    <main class="w-full max-w-6xl mx-auto px-4 lg:px-8 pb-32 flex-grow layout-grid relative">
        
        <!-- Navigation Rail (Desktop) -->
        <nav id="desktop-nav" class="hidden lg:block sticky top-8 h-[calc(100vh-4rem)] overflow-y-auto no-scrollbar pr-4">
            <!-- Injected via JS -->
        </nav>

        <!-- Paper Content Column -->
        <div id="paper-content" class="w-full min-w-0">
            <!-- Injected via JS -->
            <div class="text-secondary italic pt-10 text-center">Loading...</div>
        </div>

    </main>

    <!-- Mobile Drawer -->
    <div id="mobile-drawer-backdrop" class="fixed inset-0 bg-black/20 z-40 hidden transition-opacity opacity-0" aria-hidden="true"></div>
    <div id="mobile-drawer" class="fixed inset-y-0 right-0 w-64 bg-paper shadow-xl z-50 transform translate-x-full transition-transform duration-300 ease-in-out flex flex-col" aria-hidden="true">
        <div class="p-4 border-b border-hairline flex justify-between items-center">
            <h2 class="font-medium text-primary">Jump to</h2>
            <button id="mobile-drawer-close" class="text-secondary hover:text-primary">
                <span data-lucide="x" class="w-5 h-5"></span>
            </button>
        </div>
        <nav id="mobile-nav-list" class="flex-1 overflow-y-auto p-4 no-scrollbar">
            <!-- Injected via JS -->
        </nav>
    </div>

    <!-- Runtime Logic -->
    <script>
        // --- STAGE 0: CONSTANTS ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";
        
        // --- ADD-ON PARAMS ---
        const RTQ_COLORLAB_FORCE_HUE_FAMILY = "pink";
        const RTQ_COLORLAB_INTENSITY_MODE = "tinted_neutrals";

        // --- STATE ---
        let appData = {
            papers: [],
            currentPaperId: null,
            expandedStates: new Set() // Stores IDs of questions with expanded workings
        };

        // --- MARKDOWN CONFIGURATION (Authoritative) ---
        // html: true (SVG passthrough), breaks: false (KaTeX requirement)
        const md = window.markdownit ? window.markdownit({
            html: true,
            linkify: true,
            breaks: false 
        }) : null;

        if (md) {
            // Disable escape rule to preserve TeX backslashes
            md.inline.ruler.disable(['escape']);
        }

        // --- DOM ELEMENTS ---
        const dom = {
            selectorContainer: document.getElementById('paper-selector-container'),
            paperContent: document.getElementById('paper-content'),
            desktopNav: document.getElementById('desktop-nav'),
            mobileNavList: document.getElementById('mobile-nav-list'),
            mobileJumpTrigger: document.getElementById('mobile-jump-trigger'),
            mobileDrawer: document.getElementById('mobile-drawer'),
            mobileDrawerBackdrop: document.getElementById('mobile-drawer-backdrop'),
            mobileDrawerClose: document.getElementById('mobile-drawer-close')
        };

        // --- INITIALIZATION ---
        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Payload missing");
                const payload = await response.json();
                
                if (!payload.papers || payload.papers.length === 0) {
                    throw new Error("No papers found");
                }

                appData.papers = payload.papers;
                // Default to first paper
                switchPaper(appData.papers[0].key);
                
                renderSelector();
            } catch (error) {
                console.error(error);
                renderError();
            }
        }

        function renderError() {
            dom.paperContent.innerHTML = `<div class="p-8 text-center text-secondary font-medium uppercase tracking-wide">Papers Payload Missing</div>`;
            dom.selectorContainer.innerHTML = '';
            dom.desktopNav.innerHTML = '';
        }

        // --- PAPER SWITCHING ---
        function switchPaper(paperKey) {
            const paper = appData.papers.find(p => p.key === paperKey);
            if (!paper) return;

            appData.currentPaperId = paperKey;
            
            // Reset state
            appData.expandedStates.clear();
            
            // Apply defaults
            const expandAll = paper.defaults?.expandedAll !== false;
            if (expandAll) {
                // We'll calculate which IDs need expansion during render traversal or lazy load
                // For simplicity in this harness, we assume all are expanded initially if default is true.
                // However, logic dictates we need specific IDs.
                // We will handle "default expanded" logic at the Node render time:
                // If expandedStates doesn't have the key, and we haven't toggled it yet, check default.
            }

            renderPaper(paper);
            renderNav(paper);
            
            // Re-run icons
            lucide.createIcons();

            // Re-run KaTeX
            if (window.renderMathInElement) {
                renderMathInElement(dom.paperContent, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false}
                    ],
                    throwOnError: false
                });
            }
        }

        // --- RENDERING: SELECTOR ---
        function renderSelector() {
            const select = document.createElement('select');
            select.className = "bg-transparent border border-hairline text-primary text-sm rounded px-3 py-1.5 focus:border-accent hover:border-accent/50 transition-colors cursor-pointer";
            
            appData.papers.forEach(p => {
                const option = document.createElement('option');
                option.value = p.key;
                option.textContent = p.label;
                if (p.key === appData.currentPaperId) option.selected = true;
                select.appendChild(option);
            });

            select.addEventListener('change', (e) => switchPaper(e.target.value));
            dom.selectorContainer.innerHTML = '';
            dom.selectorContainer.appendChild(select);
        }

        // --- RENDERING: NAVIGATION ---
        function renderNav(paper) {
            const generateNavHTML = (isMobile) => {
                let html = '<ul class="flex flex-col gap-0.5">';
                
                const renderItem = (q, depth) => {
                    // Type scale hierarchy only, no indentation
                    const fontSize = depth === 0 ? 'text-sm' : 'text-xs';
                    const weight = depth === 0 ? 'font-medium' : 'font-normal';
                    const opacity = depth === 0 ? 'text-primary' : 'text-secondary';
                    
                    return `
                        <li>
                            <a href="#question-${q.id}" 
                               class="block py-1 ${fontSize} ${weight} ${opacity} hover:text-accent focus:text-accent transition-colors truncate text-left"
                               onclick="handleNavClick(event, '${q.id}')">
                                ${q.id}
                            </a>
                        </li>
                    `;
                };

                const traverse = (nodes, depth) => {
                    let items = '';
                    nodes.forEach(node => {
                        items += renderItem(node, depth);
                        if (node.children && node.children.length > 0) {
                            items += traverse(node.children, depth + 1);
                        }
                    });
                    return items;
                };

                if (paper.sections) {
                    paper.sections.forEach((section, index) => {
                        // Section Label (Separator)
                        if (section.label && section.label.trim() !== "") {
                            // Spacing above section (except first)
                            const mt = index > 0 ? 'mt-6' : 'mt-0';
                            html += `
                                <li class="${mt} mb-2 text-xs font-semibold text-secondary uppercase tracking-wider select-none border-b border-hairline pb-1">
                                    ${section.label}
                                </li>
                            `;
                        } else if (index > 0) {
                            // Empty label but new section group -> just spacing
                            html += `<li class="mt-4"></li>`;
                        }
                        html += traverse(section.questions, 0);
                    });
                } else if (paper.questions) {
                    html += traverse(paper.questions, 0);
                }

                html += '</ul>';
                return html;
            };

            dom.desktopNav.innerHTML = generateNavHTML(false);
            dom.mobileNavList.innerHTML = generateNavHTML(true);
        }

        window.handleNavClick = (e, id) => {
            e.preventDefault();
            const el = document.getElementById(`question-${id}`);
            if (el) {
                // Smooth scroll
                const headerOffset = 80;
                const elementPosition = el.getBoundingClientRect().top;
                const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
                
                window.scrollTo({
                    top: offsetPosition,
                    behavior: "smooth"
                });
                
                // Close drawer if open
                closeDrawer();
                
                // Set focus for accessibility
                el.setAttribute('tabindex', '-1');
                el.focus({preventScroll: true});
            }
        };

        // --- RENDERING: PAPER CONTENT ---
        function renderPaper(paper) {
            const container = document.createElement('div');
            container.className = "flex flex-col gap-12 pb-24"; // Top-level inter-question spacing (Large)

            if (paper.sections) {
                paper.sections.forEach(section => {
                    const sectionBlock = document.createElement('div');
                    
                    if (section.label && section.label.trim() !== "") {
                        const header = document.createElement('h2');
                        header.className = "text-xl font-semibold text-primary mb-8 border-b border-hairline pb-2";
                        header.textContent = section.label; // Label only (A, B, C)
                        sectionBlock.appendChild(header);
                    }
                    
                    const list = document.createElement('div');
                    list.className = "flex flex-col gap-12"; // Spacing between top-level questions
                    section.questions.forEach(q => list.appendChild(createQuestionNode(q, 0, paper)));
                    sectionBlock.appendChild(list);
                    container.appendChild(sectionBlock);
                });
            } else if (paper.questions) {
                paper.questions.forEach(q => container.appendChild(createQuestionNode(q, 0, paper)));
            }

            dom.paperContent.innerHTML = '';
            dom.paperContent.appendChild(container);
        }

        function createQuestionNode(node, depth, paper) {
            const wrapper = document.createElement('div');
            wrapper.className = "flex flex-col w-full";
            wrapper.id = `question-${node.id}`;

            // 1. Question Body
            const body = document.createElement('div');
            body.className = "mb-4"; // Spacing Question -> Solution Block
            
            const idLabel = document.createElement('span');
            idLabel.className = "text-secondary font-medium mr-3 select-none inline-block";
            idLabel.textContent = node.id;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = "inline markdown-body text-primary text-lg leading-relaxed";
            contentDiv.innerHTML = md ? md.render(node.question) : node.question;
            
            // Prepend ID to first paragraph if possible, or just prepend
            if (contentDiv.firstElementChild && contentDiv.firstElementChild.tagName === 'P') {
                contentDiv.firstElementChild.prepend(idLabel);
            } else {
                body.appendChild(idLabel);
            }
            body.appendChild(contentDiv);
            wrapper.appendChild(body);

            // 2. Solution Block (Optional)
            if (node.solutionBlock) {
                const solutionBlock = document.createElement('div');
                solutionBlock.className = "pl-0 lg:pl-0 flex flex-col gap-3"; // Internal spacing

                // Answer (Optional)
                if (node.solutionBlock.answer) {
                    const ansDiv = document.createElement('div');
                    ansDiv.className = "text-base";
                    ansDiv.innerHTML = `<span class="font-semibold text-sm text-accent uppercase tracking-wide mr-2">Answer</span> <span class="markdown-body inline">${md ? md.renderInline(node.solutionBlock.answer) : node.solutionBlock.answer}</span>`;
                    solutionBlock.appendChild(ansDiv);
                }

                // Solution Details (Optional)
                if (node.solutionBlock.solutionDetails) {
                    const details = node.solutionBlock.solutionDetails;
                    
                    // State Check
                    // If not explicitly tracked, use paper default
                    const isDefaultExpanded = paper.defaults?.expandedAll !== false;
                    const isExpanded = appData.expandedStates.has(node.id) || (!appData.expandedStates.has(node.id) && isDefaultExpanded && !appData.expandedStates.has(`collapsed-${node.id}`));

                    // Toggle Control
                    const toggleBtn = document.createElement('button');
                    toggleBtn.className = "text-accent font-medium text-sm flex items-center gap-1 hover:text-accent-hover focus:outline-none transition-colors w-fit mt-1";
                    toggleBtn.innerHTML = `
                        <span>${isExpanded ? 'Hide working' : 'Show working'}</span>
                        <span data-lucide="${isExpanded ? 'chevron-up' : 'chevron-down'}" class="w-4 h-4"></span>
                    `;
                    
                    // Region
                    const region = document.createElement('div');
                    region.className = `mt-3 bg-wash rounded-sm overflow-hidden transition-all duration-300 ease-in-out border-l-2 border-hairline/50 pl-4 py-4 pr-4 ${isExpanded ? 'block' : 'hidden'}`;
                    
                    if (isExpanded) {
                        // Render internals only if expanded (or eager render and hide, but logic says expand/collapse region)
                        // Content
                        let innerHTML = '';
                        
                        // Keep in mind
                        if (details.keepInMind) {
                            innerHTML += `
                                <div class="mb-4 text-sm">
                                    <div class="flex items-center gap-2 mb-1 text-accent font-semibold text-xs uppercase tracking-wide">
                                        <span data-lucide="lightbulb" class="w-3 h-3"></span> Keep in mind
                                    </div>
                                    <div class="markdown-body text-secondary">${md ? md.render(details.keepInMind) : details.keepInMind}</div>
                                </div>
                            `;
                        }

                        // Formulas
                        if (details.formulasUsed) {
                            innerHTML += `
                                <div class="mb-4 text-sm">
                                    <div class="mb-1 text-secondary font-semibold text-xs uppercase tracking-wide">Formulas used</div>
                                    <div class="markdown-body text-secondary">${md ? md.render(details.formulasUsed) : details.formulasUsed}</div>
                                </div>
                            `;
                        }

                        // Working
                        if (details.working) {
                            innerHTML += `
                                <div class="mb-4">
                                    <div class="mb-2 text-secondary font-semibold text-xs uppercase tracking-wide">Working</div>
                                    <div class="markdown-body text-primary text-base">${md ? md.render(details.working) : details.working}</div>
                                </div>
                            `;
                        }

                        // Alternative Working
                        if (details.alternativeWorking && Array.isArray(details.alternativeWorking)) {
                            details.alternativeWorking.forEach(alt => {
                                innerHTML += `
                                    <div class="mt-6 pt-4 border-t border-hairline/50">
                                        <div class="mb-2 text-secondary font-semibold text-xs uppercase tracking-wide">Alternative working</div>
                                        <div class="markdown-body text-primary text-base">${md ? md.render(alt) : alt}</div>
                                    </div>
                                `;
                            });
                        }

                        region.innerHTML = innerHTML;
                    }

                    toggleBtn.onclick = () => {
                        const nextState = !isExpanded;
                        if (nextState) {
                            appData.expandedStates.add(node.id);
                            appData.expandedStates.delete(`collapsed-${node.id}`);
                        } else {
                            appData.expandedStates.delete(node.id);
                            appData.expandedStates.add(`collapsed-${node.id}`);
                        }
                        
                        // Re-render just this node or swapping HTML? 
                        // For simplicity in this vanilla JS prototype, we'll re-render the whole paper to keep state consistent easily.
                        // Optimization: In a real app, update only this DOM subtree.
                        const newWrapper = createQuestionNode(node, depth, paper);
                        wrapper.replaceWith(newWrapper);
                        
                        // Re-init icons and math for the new content
                        lucide.createIcons();
                        if (window.renderMathInElement) {
                            renderMathInElement(newWrapper, {
                                delimiters: [
                                    {left: '$$', right: '$$', display: true},
                                    {left: '$', right: '$', display: false}
                                ],
                                throwOnError: false
                            });
                        }
                    };

                    solutionBlock.appendChild(toggleBtn);
                    solutionBlock.appendChild(region);
                }

                wrapper.appendChild(solutionBlock);
            }

            // 3. Children
            if (node.children && node.children.length > 0) {
                const childrenContainer = document.createElement('div');
                // Indentation logic via spacing only (Stage 3)
                // We use padding left for visual hierarchy, but keep it fluid
                childrenContainer.className = "flex flex-col gap-6 mt-6 ml-4 lg:ml-8 border-l border-hairline/30 pl-4";
                
                node.children.forEach(child => {
                    childrenContainer.appendChild(createQuestionNode(child, depth + 1, paper));
                });
                wrapper.appendChild(childrenContainer);
            }

            return wrapper;
        }

        // --- DRAWER LOGIC ---
        function openDrawer() {
            dom.mobileDrawerBackdrop.classList.remove('hidden');
            dom.mobileDrawerBackdrop.classList.remove('opacity-0');
            dom.mobileDrawer.classList.remove('translate-x-full');
            document.body.style.overflow = 'hidden';
        }

        function closeDrawer() {
            dom.mobileDrawerBackdrop.classList.add('opacity-0');
            dom.mobileDrawer.classList.add('translate-x-full');
            setTimeout(() => {
                dom.mobileDrawerBackdrop.classList.add('hidden');
            }, 300);
            document.body.style.overflow = '';
        }

        dom.mobileJumpTrigger.addEventListener('click', openDrawer);
        dom.mobileDrawerClose.addEventListener('click', closeDrawer);
        dom.mobileDrawerBackdrop.addEventListener('click', closeDrawer);

        // --- START ---
        document.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
