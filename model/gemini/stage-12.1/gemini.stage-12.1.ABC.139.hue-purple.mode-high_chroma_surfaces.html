<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"ABC","indexWithinVariant":"139","totalWithinVariant":"320","hueFamily":"purple","intensityMode":"high_chroma_surfaces","timestamp":"2026-01-07T15:55:38.228Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;ABC&quot;,&quot;indexWithinVariant&quot;:&quot;139&quot;,&quot;totalWithinVariant&quot;:&quot;320&quot;,&quot;hueFamily&quot;:&quot;purple&quot;,&quot;intensityMode&quot;:&quot;high_chroma_surfaces&quot;,&quot;timestamp&quot;:&quot;2026-01-07T15:55:38.228Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>

    <!-- 
    STAGE 0: CONSTANTS 
    Authoritative definitions for runtime constants.
    -->
    <script>
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";
    </script>

    <!-- Tailwind CSS (via CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- KaTeX (via CDN, SRI disabled per Stage 6.0.7b) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Markdown-it (via CDN, SRI disabled) -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <!-- ColorLab & Styles -->
    <style>
        /* 
        COLORLAB C: HIGH CHROMA SURFACES (Purple Hue)
        Hue: 290 (Purple)
        Mode: High Chroma Surfaces (Light Mode Only)
        Requirements:
        - 2 Major surfaces C in [0.06..0.12]
        - 1 Major surface C in [0.03..0.07]
        - Wash surfaces C in [0.05..0.10]
        - Accent C in [0.12..0.20]
        */
        :root {
            /* Major Surfaces */
            --col-page-bg: oklch(0.95 0.08 290);    /* High Chroma */
            --col-frame-bg: oklch(0.93 0.07 290);   /* High Chroma */
            --col-paper-bg: oklch(0.99 0.03 290);   /* Tinted */

            /* Supporting Surfaces */
            --col-wash-bg: oklch(0.96 0.06 290);    /* Wash */
            
            /* Text & Content */
            --col-text-pri: oklch(0.20 0.015 290);
            --col-text-sec: oklch(0.45 0.015 290);
            
            /* Accents & UI */
            --col-accent: oklch(0.55 0.16 290);     /* Accent */
            --col-divider: oklch(0.88 0.02 290);
            --col-focus: oklch(0.55 0.16 290);
        }

        body {
            background-color: var(--col-page-bg);
            color: var(--col-text-pri);
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        /* Layout & Scrollbars */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Math Containment Invariant */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding-block: 0.5rem;
            /* Allow scrolling within math container only */
        }
        
        /* Tables in content */
        .md-content table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
            font-size: 0.95em;
        }
        .md-content th, .md-content td {
            border: 1px solid var(--col-divider);
            padding: 0.5rem;
            text-align: left;
        }
        .md-content th {
            font-weight: 600;
        }

        /* Focus Styles */
        :focus-visible {
            outline: 2px solid var(--col-focus);
            outline-offset: 2px;
        }

        /* ColorLab Utility Classes */
        .bg-frame { background-color: var(--col-frame-bg); }
        .bg-paper { background-color: var(--col-paper-bg); }
        .bg-wash { background-color: var(--col-wash-bg); }
        .text-pri { color: var(--col-text-pri); }
        .text-sec { color: var(--col-text-sec); }
        .text-accent { color: var(--col-accent); }
        .border-div { border-color: var(--col-divider); }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- TOP CONTROLS REGION -->
    <div class="sticky top-0 z-40 w-full bg-frame border-b border-div">
        <div class="max-w-[1400px] mx-auto px-4 md:px-6 h-14 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <select id="paperSelector" class="bg-paper border border-div rounded px-3 py-1.5 text-sm font-medium text-pri focus:outline-none focus:ring-2 focus:ring-[var(--col-focus)]">
                    <option disabled selected>Loading papers...</option>
                </select>
            </div>
            
            <!-- Mobile Jump To Trigger -->
            <button id="mobileJumpBtn" class="md:hidden text-sm font-bold text-accent px-2 py-1">
                Jump to
            </button>
        </div>
    </div>

    <!-- DOCUMENT FRAME SHELL -->
    <main class="flex-1 w-full max-w-[1400px] mx-auto md:px-6 bg-frame flex flex-col md:flex-row overflow-hidden relative">
        
        <!-- NAVIGATION RAIL (Desktop) -->
        <!-- Fixed width, sticky, distinct column but shared surface context -->
        <aside class="hidden md:block w-64 flex-shrink-0 sticky top-14 h-[calc(100vh-3.5rem)] overflow-y-auto no-scrollbar py-8 pr-6">
            <nav id="desktopNav" class="flex flex-col gap-1" aria-label="Desktop Navigation"></nav>
        </aside>

        <!-- SEPARATOR (Visual Only) -->
        <div class="hidden md:block w-px bg-div my-8 mr-8"></div>

        <!-- PAPER DOCUMENT COLUMN -->
        <section class="flex-1 min-w-0 bg-paper py-8 px-4 md:px-12 lg:px-16 pb-32 min-h-screen">
            <div id="paperContent" class="max-w-3xl mx-auto space-y-12">
                <!-- Content injected here -->
                <div class="flex items-center justify-center h-32 text-sec italic">
                    Initializing...
                </div>
            </div>
        </section>

    </main>

    <!-- MOBILE NAVIGATION DRAWER -->
    <div id="mobileDrawer" class="fixed inset-0 z-50 transform translate-x-full transition-transform duration-200 ease-out md:hidden" aria-hidden="true">
        <!-- Backdrop -->
        <div id="drawerBackdrop" class="absolute inset-0 bg-black/20 backdrop-blur-sm opacity-0 transition-opacity duration-200"></div>
        
        <!-- Drawer Panel -->
        <div class="absolute right-0 top-0 bottom-0 w-[85%] max-w-sm bg-paper shadow-xl flex flex-col h-full transform transition-transform duration-200">
            <div class="flex items-center justify-between px-4 h-14 border-b border-div flex-shrink-0">
                <h2 class="text-sm font-bold text-pri">Jump to</h2>
                <button id="closeDrawerBtn" class="p-2 text-sec hover:text-pri">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            <nav id="mobileNavList" class="flex-1 overflow-y-auto p-4 space-y-1"></nav>
        </div>
    </div>

    <!-- MAIN SCRIPT -->
    <script>
        /**
         * RTQ Maths Paper Solution Viewer - Runtime
         * Adheres to Stage 3 Semantics + Stage 6 Baseline Rules
         */

        // --- GLOBAL STATE ---
        const state = {
            papers: [],
            activePaperKey: null,
            expandedNodes: new Set(), // IDs of questions with expanded workings
            mobileDrawerOpen: false
        };

        // --- MARKDOWN SETUP ---
        // Authoritative config per Stage 6 Add-on
        const md = window.markdownit ? window.markdownit({
            html: true,     // Allow inline SVG/HTML
            linkify: true,
            breaks: false   // MUST be false for KaTeX
        }) : null;

        if (md) {
            // Disable escaping to preserve TeX backslashes
            md.inline.ruler.disable(['escape']);
        }

        // --- DOM ELEMENTS ---
        const els = {
            selector: document.getElementById('paperSelector'),
            content: document.getElementById('paperContent'),
            desktopNav: document.getElementById('desktopNav'),
            mobileNavList: document.getElementById('mobileNavList'),
            mobileJumpBtn: document.getElementById('mobileJumpBtn'),
            mobileDrawer: document.getElementById('mobileDrawer'),
            drawerBackdrop: document.getElementById('drawerBackdrop'),
            closeDrawerBtn: document.getElementById('closeDrawerBtn')
        };

        // --- INITIALIZATION ---
        (async function init() {
            try {
                // Deterministic Payload Load
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error('Fetch failed');
                const payload = await response.json();

                if (!payload || !Array.isArray(payload.papers)) {
                    throw new Error('Invalid payload structure');
                }

                state.papers = payload.papers;
                renderSelector();
                
                // Load first paper by default
                if (state.papers.length > 0) {
                    loadPaper(state.papers[0].key);
                }

            } catch (err) {
                console.error(err);
                renderFailure();
            }
            
            setupMobileNav();
        })();

        // --- CORE RENDER LOGIC ---

        function renderSelector() {
            els.selector.innerHTML = state.papers.map(p => 
                `<option value="${p.key}">${p.label}</option>`
            ).join('');
            
            els.selector.addEventListener('change', (e) => {
                loadPaper(e.target.value);
            });
        }

        function loadPaper(paperKey) {
            const paper = state.papers.find(p => p.key === paperKey);
            if (!paper) return;

            state.activePaperKey = paperKey;
            
            // Set defaults based on payload
            state.expandedNodes.clear();
            const defaultExpanded = paper.defaults?.expandedAll !== false;

            // Collect IDs for expansion defaults if needed
            // (We handle this lazily in render, checking state.expandedNodes size vs default)
            // Actually, simplest is to just flag nodes as we encounter them or use a global default check.
            // Let's store a flag on the state object for the current paper's default.
            state.currentPaperDefaultExpanded = defaultExpanded;

            renderPaperContent(paper);
            renderNavigation(paper);
            
            // Initial Math Render
            renderMathInElement(els.content);
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'instant' });
        }

        function renderPaperContent(paper) {
            els.content.innerHTML = ''; // Clear

            if (paper.sections && paper.sections.length > 0) {
                // Sectioned Paper
                paper.sections.forEach((section, idx) => {
                    const sectionBlock = document.createElement('div');
                    sectionBlock.className = 'mb-16'; // Spacing between sections
                    
                    if (section.label && section.label.trim().length > 0) {
                        const header = document.createElement('h2');
                        header.className = 'text-xl font-bold text-pri mb-8 border-b border-div pb-2';
                        header.textContent = section.label; // Plain text
                        sectionBlock.appendChild(header);
                    }

                    const qList = document.createElement('div');
                    qList.className = 'space-y-12'; // Top-level inter-question spacing
                    
                    if (section.questions) {
                        section.questions.forEach(q => {
                            qList.appendChild(createQuestionNode(q, 0));
                        });
                    }
                    sectionBlock.appendChild(qList);
                    els.content.appendChild(sectionBlock);
                });
            } else if (paper.questions && paper.questions.length > 0) {
                // Flat Paper
                const qList = document.createElement('div');
                qList.className = 'space-y-12';
                paper.questions.forEach(q => {
                    qList.appendChild(createQuestionNode(q, 0));
                });
                els.content.appendChild(qList);
            } else {
                els.content.innerHTML = '<div class="text-sec italic">No questions in this paper.</div>';
            }
        }

        function createQuestionNode(q, depth) {
            // Container
            const node = document.createElement('div');
            node.className = `flex flex-col group`;
            node.id = `q-${q.id}`; // Anchor for nav

            // 1. Question Body (Identifier + Prompt)
            const bodyRow = document.createElement('div');
            bodyRow.className = "flex gap-4 md:gap-6";
            
            const idEl = document.createElement('div');
            idEl.className = "flex-shrink-0 w-8 md:w-12 text-sec font-semibold text-lg md:text-xl leading-relaxed select-none";
            idEl.textContent = q.id;

            const promptEl = document.createElement('div');
            promptEl.className = "flex-1 text-pri text-lg md:text-xl leading-relaxed md-content";
            promptEl.innerHTML = md ? md.render(q.question || '') : q.question;

            bodyRow.appendChild(idEl);
            bodyRow.appendChild(promptEl);
            node.appendChild(bodyRow);

            // 2. Solution Block (Optional)
            if (q.solutionBlock) {
                const sb = q.solutionBlock;
                const blockWrapper = document.createElement('div');
                // Indent matching prompt
                blockWrapper.className = "ml-12 md:ml-[4.5rem] mt-4 flex flex-col gap-4";

                // A. Answer (Optional)
                if (sb.answer) {
                    const ansRow = document.createElement('div');
                    ansRow.className = "flex flex-col sm:flex-row sm:items-baseline gap-2 sm:gap-4 text-base";
                    
                    const label = document.createElement('span');
                    label.className = "text-sm font-bold text-sec uppercase tracking-wide flex-shrink-0 select-none";
                    label.textContent = "Answer";
                    
                    const ansContent = document.createElement('div');
                    ansContent.className = "text-pri font-medium md-content";
                    ansContent.innerHTML = md ? md.render(sb.answer || '') : sb.answer;

                    ansRow.appendChild(label);
                    ansRow.appendChild(ansContent);
                    blockWrapper.appendChild(ansRow);
                }

                // B. Solution Details (Optional)
                if (sb.solutionDetails) {
                    const detailsId = `sd-${q.id}`;
                    
                    // Determine state
                    // If explicitly toggled, use that. Else default.
                    const isExpanded = state.expandedNodes.has(q.id) || (state.currentPaperDefaultExpanded && !state.expandedNodes.has(`!${q.id}`)); // logic tweak: using !id to store collapsed state if default is expanded is complex.
                    // Simpler logic: Initialize state based on default.
                    // If not in set, use default.
                    // To support toggling, we need to know if the USER has intervened.
                    // Let's simplify: state.expandedNodes stores explicitly OPEN nodes.
                    // If default is TRUE, we treat everything as open unless in a "collapsedNodes" set.
                    // For this prototype, let's just use a helper that resolves current visibility.
                    const isDefaultOpen = state.currentPaperDefaultExpanded;
                    // We need a persistent way to track this. Let's assume expandedNodes tracks the *deviation* or absolute state.
                    // Let's use absolute state for simplicity in rendering.
                    // BUT initial render needs to populate it? No, lazy is better.
                    
                    // Let's rely on a helper function for state logic.
                    // render check:
                    let open = isNodeExpanded(q.id);

                    // Toggle Control
                    const toggleBtn = document.createElement('button');
                    toggleBtn.className = "text-accent font-medium text-sm hover:underline text-left flex items-center gap-1 w-fit select-none focus:outline-none focus:ring-2 focus:ring-[var(--col-focus)] rounded px-1 -ml-1";
                    toggleBtn.setAttribute('aria-expanded', open);
                    toggleBtn.setAttribute('aria-controls', detailsId);
                    
                    const updateToggleText = () => {
                        toggleBtn.innerHTML = open 
                            ? `Hide working <span class="text-xs">▲</span>` 
                            : `Show working <span class="text-xs">▼</span>`;
                    };
                    updateToggleText();

                    toggleBtn.onclick = () => {
                        open = !open;
                        setNodeExpanded(q.id, open);
                        updateToggleText();
                        const region = document.getElementById(detailsId);
                        if (region) {
                            region.style.display = open ? 'block' : 'none';
                            // Re-render math if revealing for first time? Auto-render handles DOM existence.
                        }
                    };
                    blockWrapper.appendChild(toggleBtn);

                    // Region
                    const detailsRegion = document.createElement('div');
                    detailsRegion.id = detailsId;
                    detailsRegion.className = "bg-wash rounded-sm p-4 md:p-6 mt-2 text-base text-sec space-y-6"; // Internal subsections spacing
                    detailsRegion.style.display = open ? 'block' : 'none';

                    // Subsections
                    const sd = sb.solutionDetails;

                    // 1. Keep in mind
                    if (sd.keepInMind) {
                        const sec = createSubsection("Keep in mind", sd.keepInMind, true);
                        detailsRegion.appendChild(sec);
                    }
                    // 2. Formulas used
                    if (sd.formulasUsed) {
                        const sec = createSubsection("Formulas used", sd.formulasUsed, true); // Formulas often lists
                        detailsRegion.appendChild(sec);
                    }
                    // 3. Working
                    if (sd.working) {
                        const sec = createSubsection("Working", sd.working, false);
                        detailsRegion.appendChild(sec);
                    }
                    // 4. Alternative working (Array)
                    if (sd.alternativeWorking && Array.isArray(sd.alternativeWorking)) {
                        sd.alternativeWorking.forEach(alt => {
                            const sec = createSubsection("Alternative working", alt, false);
                            detailsRegion.appendChild(sec);
                        });
                    }

                    blockWrapper.appendChild(detailsRegion);
                }

                node.appendChild(blockWrapper);
            }

            // 3. Children (Recursive)
            if (q.children && q.children.length > 0) {
                const childContainer = document.createElement('div');
                // Indentation logic: We need visual hierarchy but not extreme nesting width loss.
                // Stage 3: "Horizontal indentation... optional".
                // Let's use a small margin on left.
                childContainer.className = "mt-6 space-y-6"; 
                
                q.children.forEach(child => {
                    // Indent children slightly relative to parent content?
                    // Flat alignment is often safer on mobile, but let's do small indent.
                    const childWrapper = document.createElement('div');
                    childWrapper.className = "ml-4 md:ml-8 border-l border-div pl-4 md:pl-6"; 
                    // Using border-l as a "separator" guide helps structure without heavy boxing.
                    // Stage 3 permits "Vertical separation... optional hairline".
                    
                    childWrapper.appendChild(createQuestionNode(child, depth + 1));
                    childContainer.appendChild(childWrapper);
                });
                node.appendChild(childContainer);
            }

            return node;
        }

        function createSubsection(labelStr, contentMarkdown, isCompact) {
            const wrapper = document.createElement('div');
            
            const label = document.createElement('h4');
            label.className = "text-xs font-bold uppercase tracking-wider text-sec mb-2 select-none";
            label.textContent = labelStr;
            wrapper.appendChild(label);

            const body = document.createElement('div');
            // Solution body text logic: "Text must stay high-legibility and mostly neutral... primary C<=0.015"
            // We use text-pri for readability inside wash, or text-sec? 
            // Stage 5.9: Keep in mind "Slightly higher contrast than Working body".
            // Let's use text-pri for Keep in mind, text-sec for working.
            const isEmphasized = labelStr === "Keep in mind";
            body.className = `md-content ${isEmphasized ? 'text-pri' : 'text-sec'} leading-relaxed`;
            body.innerHTML = md ? md.render(contentMarkdown || '') : contentMarkdown;
            
            wrapper.appendChild(body);
            return wrapper;
        }

        // --- NAVIGATION RENDERER ---

        function renderNavigation(paper) {
            // Helper to flatten tree for nav list
            const flatList = [];
            
            function traverse(nodes) {
                nodes.forEach(q => {
                    flatList.push(q);
                    if (q.children) traverse(q.children);
                });
            }

            // Build DOM
            const buildNavContent = () => {
                const frag = document.createDocumentFragment();
                
                if (paper.sections) {
                    paper.sections.forEach(sec => {
                        // Section Label (only if non-empty)
                        if (sec.label && sec.label.trim()) {
                            const secHeader = document.createElement('div');
                            secHeader.className = "px-3 py-2 text-xs font-bold text-sec uppercase tracking-widest mt-4 first:mt-0 opacity-70 select-none";
                            secHeader.textContent = sec.label;
                            frag.appendChild(secHeader);
                        }
                        const secNodes = [];
                        const collect = (list) => list.forEach(n => { secNodes.push(n); if(n.children) collect(n.children); });
                        if(sec.questions) collect(sec.questions);
                        
                        secNodes.forEach(q => frag.appendChild(createNavItem(q)));
                    });
                } else if (paper.questions) {
                    const allNodes = [];
                    traverse(paper.questions); // flatten locally since traverse writes to flatList, let's just use local recursion
                    // Re-do flatten logic correctly
                    const flatten = (list) => list.reduce((acc, item) => {
                        acc.push(item);
                        if (item.children) acc = acc.concat(flatten(item.children));
                        return acc;
                    }, []);
                    
                    flatten(paper.questions).forEach(q => frag.appendChild(createNavItem(q)));
                }
                return frag;
            };

            els.desktopNav.innerHTML = '';
            els.desktopNav.appendChild(buildNavContent());

            els.mobileNavList.innerHTML = '';
            els.mobileNavList.appendChild(buildNavContent().cloneNode(true)); // Clone for mobile
            
            // Setup intersection observer for current item
            setupScrollSpy();
        }

        function createNavItem(q) {
            const a = document.createElement('a');
            a.href = `#q-${q.id}`;
            a.className = "block px-3 py-1.5 text-sm rounded transition-colors duration-200 text-sec hover:bg-black/5 hover:text-pri nav-item";
            a.dataset.target = `q-${q.id}`;
            
            // Visual hierarchy via opacity/size, NO indent
            // Sub-questions get slightly diminished style?
            // "Hierarchy expressed only via typographic scale/quietness... same left edge"
            // We can detect depth roughly by ID length or pattern? 
            // Or just keep it uniform flat list as requested by "Flat list visually".
            // Stage 5.4.5: "sub-questions are quieter/smaller than top-level items"
            // Let's approximate. If ID contains brackets or dots, maybe it's deeper.
            // Or just render flat. Let's stick to flat and simple.
            
            const label = document.createElement('span');
            label.textContent = q.id;
            
            // Active marker logic handled by scroll spy
            a.appendChild(label);

            a.onclick = (e) => {
                e.preventDefault();
                document.getElementById(`q-${q.id}`)?.scrollIntoView({ behavior: 'smooth', block: 'start' });
                closeMobileNav();
            };

            return a;
        }

        // --- INTERACTION UTILS ---

        // State management for expanded nodes
        // Since we can't easily persist "default open but user closed" without a complex map, 
        // we'll assume a Set tracks "Opposite of Default" or just explicit states.
        // Simplest: If paper default is Expanded, Set tracks Collapsed IDs.
        // If paper default is Collapsed, Set tracks Expanded IDs.
        function isNodeExpanded(id) {
            const def = state.currentPaperDefaultExpanded;
            if (def) {
                return !state.expandedNodes.has(`closed-${id}`);
            } else {
                return state.expandedNodes.has(`open-${id}`);
            }
        }

        function setNodeExpanded(id, isOpen) {
            const def = state.currentPaperDefaultExpanded;
            if (def) {
                if (!isOpen) state.expandedNodes.add(`closed-${id}`);
                else state.expandedNodes.delete(`closed-${id}`);
            } else {
                if (isOpen) state.expandedNodes.add(`open-${id}`);
                else state.expandedNodes.delete(`open-${id}`);
            }
        }

        // Math Rendering
        function renderMathInElement(root) {
            if (window.renderMathInElement) {
                renderMathInElement(root, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false}
                    ],
                    throwOnError: false,
                    output: 'html' // Use HTML output for better accessibility/layout integration usually
                });
            }
        }

        // Scroll Spy
        function setupScrollSpy() {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        setActiveNav(entry.target.id);
                    }
                });
            }, { rootMargin: '-10% 0px -80% 0px' }); // Trigger near top

            document.querySelectorAll('[id^="q-"]').forEach(el => observer.observe(el));
        }

        let currentActiveId = null;
        function setActiveNav(targetId) {
            if (currentActiveId === targetId) return;
            currentActiveId = targetId;

            document.querySelectorAll('.nav-item').forEach(el => {
                const isActive = el.dataset.target === targetId;
                if (isActive) {
                    el.classList.add('font-bold', 'text-accent');
                    el.classList.remove('text-sec');
                    // Ensure visible in scroll container
                    el.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                } else {
                    el.classList.remove('font-bold', 'text-accent');
                    el.classList.add('text-sec');
                }
            });
        }

        // Mobile Nav
        function setupMobileNav() {
            const toggle = (open) => {
                state.mobileDrawerOpen = open;
                const cl = els.mobileDrawer.classList;
                const bd = els.drawerBackdrop.classList;
                
                if (open) {
                    cl.remove('translate-x-full');
                    bd.remove('opacity-0');
                } else {
                    cl.add('translate-x-full');
                    bd.add('opacity-0');
                }
            };

            els.mobileJumpBtn.onclick = () => toggle(true);
            els.closeDrawerBtn.onclick = () => toggle(false);
            els.drawerBackdrop.onclick = () => toggle(false);
            
            window.closeMobileNav = () => toggle(false);
        }

        function renderFailure() {
            els.content.innerHTML = `
                <div class="flex flex-col items-center justify-center h-64 text-center">
                    <h2 class="text-xl font-bold text-red-600 mb-2">PAPERS PAYLOAD MISSING</h2>
                    <p class="text-sec">Could not load ${RTQ_PAPERS_PAYLOAD_PATH}</p>
                </div>
            `;
        }

    </script>
</body>
</html>
