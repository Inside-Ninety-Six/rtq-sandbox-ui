<!DOCTYPE html>
<html lang="en" class="antialiased">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AB","indexWithinVariant":"194","totalWithinVariant":"200","hueFamily":"blue","intensityMode":"","timestamp":"2026-01-07T09:04:02.201Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AB&quot;,&quot;indexWithinVariant&quot;:&quot;194&quot;,&quot;totalWithinVariant&quot;:&quot;200&quot;,&quot;hueFamily&quot;:&quot;blue&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-07T09:04:02.201Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>

    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- KaTeX CSS (CDN) - No Integrity -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <!-- KaTeX JS (CDN) - No Integrity -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Markdown-it (CDN) - No Integrity -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Tailwind Config for ColorLab B (Blue Hue Family) + Typography -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // ColorLab B: Blue Hue Family Forced
                        // Base neutrals (Slate) for Light Mode Only
                        page: '#f8fafc', // Slate-50
                        surface: '#ffffff',
                        ui: {
                            text: '#0f172a', // Slate-900 (Primary)
                            muted: '#64748b', // Slate-500 (Secondary)
                            faint: '#94a3b8', // Slate-400 (Tertiary)
                            border: '#e2e8f0', // Slate-200
                        },
                        // Forced Accent: Blue
                        accent: {
                            DEFAULT: '#2563eb', // Blue-600
                            hover: '#1d4ed8',   // Blue-700
                            subtle: '#eff6ff',  // Blue-50
                            focus: '#60a5fa',   // Blue-400
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    spacing: {
                        'question-gap': '3rem', // Largest unit
                        'sub-gap': '1.5rem',
                        'internal-gap': '0.75rem',
                    }
                }
            }
        }
    </script>

    <style>
        /* Base Reset & Typography Defaults */
        body {
            background-color: theme('colors.page');
            color: theme('colors.ui.text');
            line-height: 1.5;
        }

        /* Scrollbar hiding utilities */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* KaTeX Containment Invariant */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding: 0.5rem 0; /* Breathing room for scrollbars */
            /* Paper-like styling for block math */
            background: transparent; 
        }
        
        /* Markdown Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
            font-size: 0.95em;
        }
        th, td {
            border: 1px solid theme('colors.ui.border');
            padding: 0.5rem;
            text-align: left;
            vertical-align: top;
        }
        th {
            font-weight: 600;
            background-color: transparent; 
        }

        /* Focus States */
        :focus-visible {
            outline: 2px solid theme('colors.accent.focus');
            outline-offset: 2px;
            border-radius: 0.25rem;
        }

        /* Drawer Transitions */
        .drawer-enter { transform: translateX(-100%); }
        .drawer-enter-active { transform: translateX(0); transition: transform 0.3s ease-out; }
        .drawer-exit { transform: translateX(0); }
        .drawer-exit-active { transform: translateX(-100%); transition: transform 0.2s ease-in; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- App Shell -->
    <div id="app" class="flex-1 flex flex-col max-w-6xl mx-auto w-full px-4 sm:px-6 lg:px-8 py-6">
        
        <!-- Top Controls (Aligned to Shell) -->
        <header class="flex items-center justify-between mb-8">
            <div class="flex items-center gap-4">
                <!-- Paper Selector -->
                <select id="paper-selector" class="bg-surface border border-ui-border text-ui-text text-sm rounded px-3 py-2 min-w-[200px] focus:border-accent shadow-sm">
                    <option disabled selected>Loading papers...</option>
                </select>
            </div>

            <!-- Mobile Jump To Trigger -->
            <button id="mobile-menu-trigger" class="lg:hidden flex items-center gap-2 text-ui-text hover:text-accent font-medium text-sm px-3 py-2 rounded">
                <i data-lucide="menu" class="w-5 h-5"></i>
                <span>Jump to</span>
            </button>
        </header>

        <!-- DocumentFrameShell -->
        <div class="flex flex-1 relative">
            
            <!-- Desktop Navigation Rail (Sticky) -->
            <aside class="hidden lg:block w-64 pr-8 shrink-0">
                <div class="sticky top-6 max-h-[calc(100vh-3rem)] overflow-y-auto no-scrollbar">
                    <nav id="desktop-nav" class="flex flex-col space-y-1" aria-label="Question navigation">
                        <!-- Nav items injected here -->
                    </nav>
                </div>
            </aside>

            <!-- Paper Content Column -->
            <main id="paper-content" class="flex-1 min-w-0 pb-32">
                <!-- Content injected here -->
                <div id="loading-state" class="text-ui-muted text-center py-20">Loading payload...</div>
            </main>

        </div>
    </div>

    <!-- Mobile Navigation Drawer -->
    <div id="mobile-drawer-overlay" class="fixed inset-0 bg-black/20 z-40 hidden transition-opacity opacity-0" aria-hidden="true"></div>
    <div id="mobile-drawer" class="fixed inset-y-0 left-0 w-72 bg-surface shadow-xl z-50 transform -translate-x-full transition-transform duration-300 ease-in-out flex flex-col" aria-modal="true" role="dialog">
        <div class="flex items-center justify-between p-4 border-b border-ui-border">
            <span class="font-medium text-ui-text">Jump to</span>
            <button id="mobile-drawer-close" class="text-ui-muted hover:text-accent p-1">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>
        <div class="flex-1 overflow-y-auto p-4 no-scrollbar">
            <nav id="mobile-nav" class="flex flex-col space-y-1">
                <!-- Nav items injected here -->
            </nav>
        </div>
    </div>

    <!-- Runtime Logic -->
    <script>
        // --- STAGE 0: CONSTANTS ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // --- GLOBAL STATE ---
        let payload = null;
        let currentPaperKey = null;
        let currentPaperData = null;
        let expandedStates = {}; // key: questionId (string), value: boolean
        
        // --- MARKDOWN SETUP (Stage 6 Add-on) ---
        // html: true (SVG passthrough), breaks: false (KaTeX Compat), linkify: true
        const md = window.markdownit ? window.markdownit({
            html: true,
            linkify: true,
            breaks: false 
        }) : null;

        if (md) {
            // Disable escape rule to preserve TeX backslashes
            md.inline.ruler.disable(['escape']);
        }

        // --- DOM ELEMENTS ---
        const els = {
            app: document.getElementById('app'),
            selector: document.getElementById('paper-selector'),
            content: document.getElementById('paper-content'),
            desktopNav: document.getElementById('desktop-nav'),
            mobileNav: document.getElementById('mobile-nav'),
            mobileTrigger: document.getElementById('mobile-menu-trigger'),
            mobileDrawer: document.getElementById('mobile-drawer'),
            mobileOverlay: document.getElementById('mobile-drawer-overlay'),
            mobileClose: document.getElementById('mobile-drawer-close'),
            loading: document.getElementById('loading-state')
        };

        // --- INITIALIZATION ---
        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Payload not found");
                payload = await response.json();
                
                if (!payload.papers || payload.papers.length === 0) {
                    throw new Error("No papers in payload");
                }

                populateSelector();
                loadPaper(payload.papers[0].key);
                els.loading.remove();
                lucide.createIcons();

            } catch (err) {
                console.error(err);
                els.content.innerHTML = `<div class="p-8 text-center text-red-600 font-bold border border-red-200 rounded bg-red-50">PAPERS PAYLOAD MISSING</div>`;
                els.loading.remove();
            }
        }

        function populateSelector() {
            els.selector.innerHTML = '';
            payload.papers.forEach(paper => {
                const opt = document.createElement('option');
                opt.value = paper.key;
                opt.textContent = paper.label;
                els.selector.appendChild(opt);
            });

            els.selector.addEventListener('change', (e) => {
                loadPaper(e.target.value);
            });
        }

        function loadPaper(key) {
            currentPaperKey = key;
            currentPaperData = payload.papers.find(p => p.key === key);
            
            // Reset state
            expandedStates = {};
            const defaultExpanded = currentPaperData.defaults?.expandedAll !== false; // Default true unless false
            
            // Build Initial Expanded State (can be optimized, but simpler to do just-in-time or assumed default)
            // For this prototype, we rely on checking `expandedStates[id] ?? defaultExpanded`
            
            render();
            closeDrawer();
        }

        // --- RENDERING CORE ---

        function render() {
            // Clear Views
            els.content.innerHTML = '';
            els.desktopNav.innerHTML = '';
            els.mobileNav.innerHTML = '';

            // Handle Sections vs Flat
            const questions = currentPaperData.questions || [];
            const sections = currentPaperData.sections || [];

            // Container for Nav Items
            const navFragments = document.createDocumentFragment();

            if (sections.length > 0) {
                // Sectioned Paper
                sections.forEach((section, index) => {
                    // Section Header (Nav)
                    if (section.label && section.label.trim().length > 0) {
                        const secHeader = document.createElement('div');
                        secHeader.className = "text-xs font-semibold text-ui-muted uppercase tracking-wider mt-4 mb-2 pl-2 select-none";
                        secHeader.textContent = section.label;
                        navFragments.appendChild(secHeader);
                        
                        // Section Header (Paper)
                        const paperSecHeader = document.createElement('div');
                        paperSecHeader.className = "mb-8 pb-2 border-b border-ui-border";
                        paperSecHeader.innerHTML = `<h2 class="text-xl font-semibold text-ui-text">${section.label}</h2>`;
                        els.content.appendChild(paperSecHeader);
                    } else if (index > 0) {
                         // Spacer if no label but distinct section block
                         const spacer = document.createElement('div');
                         spacer.className = "mt-4";
                         navFragments.appendChild(spacer);
                    }

                    // Section Questions
                    renderQuestionList(section.questions, navFragments, els.content);
                });
            } else {
                // Flat Paper
                renderQuestionList(questions, navFragments, els.content);
            }

            // Inject Nav
            els.desktopNav.appendChild(navFragments.cloneNode(true));
            els.mobileNav.appendChild(navFragments);

            // Post-Render Math
            renderMathInElement(els.content, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false},
                    {left: '\\(', right: '\\)', display: false},
                    {left: '\\[', right: '\\]', display: true}
                ],
                throwOnError: false
            });
            
            // Re-init icons
            lucide.createIcons();
        }

        function renderQuestionList(questions, navContainer, paperContainer) {
            questions.forEach(q => {
                // Nav Item
                const navItem = createNavItem(q);
                navContainer.appendChild(navItem);

                // Question Node
                const qNode = createQuestionNode(q, 0);
                paperContainer.appendChild(qNode);
            });
        }

        function createNavItem(q) {
            const a = document.createElement('a');
            a.href = `#q-${q.id}`;
            a.className = "block px-2 py-1 text-sm text-ui-muted hover:text-ui-text hover:bg-slate-50 rounded transition-colors duration-150";
            
            // Hierarchy via type scale/quietness (Stage 5.4.5)
            // We use simple ID length or parent context logic if we had it. 
            // For now, flat list with consistent left edge.
            // Active state would be handled via IntersectionObserver in a real app, 
            // here we keep it static or rely on click handling for manual active style.
            
            // Active state cue placeholder logic:
            a.onclick = (e) => {
                // Remove active class from all
                document.querySelectorAll('nav a').forEach(l => {
                    l.classList.remove('font-bold', 'text-accent', 'bg-accent-subtle');
                    l.classList.add('text-ui-muted');
                });
                // Add to clicked
                e.target.classList.remove('text-ui-muted');
                e.target.classList.add('font-bold', 'text-accent', 'bg-accent-subtle');
                
                // Also update mobile drawer sync
                closeDrawer();
            };

            a.textContent = q.id;
            
            // Process children for Nav (Flattened per Brief)
            if (q.children && q.children.length > 0) {
                const fragment = document.createDocumentFragment();
                fragment.appendChild(a);
                q.children.forEach(child => {
                    // Recursively flatten children into nav
                    // Sub-questions get quieter styling
                    const childLink = createNavItem(child);
                    childLink.classList.add('text-xs'); // Scale down
                    fragment.appendChild(childLink);
                });
                return fragment; // Return fragment containing parent + flattened children
            }
            
            return a;
        }

        // Handle fragment return from createNavItem recursion helper
        function appendNavItems(q, container) {
            // ... complexity handling for fragment return ...
            // Simplified: The list is generated linearly.
        }

        function createQuestionNode(node, depth) {
            const wrapper = document.createElement('div');
            wrapper.id = `q-${node.id}`;
            wrapper.className = `flex flex-col ${depth === 0 ? 'mb-question-gap border-b border-transparent' : 'mt-sub-gap'}`; // Top level separation

            // 1. Question Body
            const bodyRow = document.createElement('div');
            bodyRow.className = "flex gap-4";

            // Identifier
            const idSpan = document.createElement('div');
            idSpan.className = "flex-shrink-0 w-8 text-ui-muted font-medium text-sm pt-1 select-none";
            idSpan.textContent = node.id;

            // Prompt
            const promptDiv = document.createElement('div');
            promptDiv.className = "flex-1 text-ui-text text-base leading-relaxed max-w-none prose prose-slate prose-p:my-2 prose-headings:font-semibold prose-strong:font-semibold";
            promptDiv.innerHTML = md ? md.render(node.question) : node.question;

            bodyRow.appendChild(idSpan);
            bodyRow.appendChild(promptDiv);
            wrapper.appendChild(bodyRow);

            // 2. Solution Block (Optional)
            if (node.solutionBlock) {
                const sb = node.solutionBlock;
                const blockWrapper = document.createElement('div');
                blockWrapper.className = "ml-12 mt-4 pl-4 border-l border-ui-border"; // Indented alignment

                // A. Answer (Optional)
                if (sb.answer) {
                    const ansRow = document.createElement('div');
                    ansRow.className = "mb-4";
                    
                    const ansLabel = document.createElement('div');
                    ansLabel.className = "text-xs font-bold text-accent uppercase tracking-wide mb-1";
                    ansLabel.textContent = "Answer";

                    const ansContent = document.createElement('div');
                    ansContent.className = "text-ui-text text-base font-medium prose prose-slate";
                    ansContent.innerHTML = md ? md.render(sb.answer) : sb.answer;

                    ansRow.appendChild(ansLabel);
                    ansRow.appendChild(ansContent);
                    blockWrapper.appendChild(ansRow);
                }

                // B. Solution Details (Optional)
                if (sb.solutionDetails) {
                    // Check Default State
                    const isDefaultExpanded = currentPaperData.defaults?.expandedAll !== false;
                    const isExpanded = expandedStates[node.id] ?? isDefaultExpanded;

                    // Toggle Control
                    const toggleBtn = document.createElement('button');
                    toggleBtn.className = "flex items-center gap-1.5 text-sm font-medium text-accent hover:text-accent-hover transition-colors focus:outline-none focus-visible";
                    toggleBtn.innerHTML = `
                        <span class="btn-label">${isExpanded ? 'Hide working' : 'Show working'}</span>
                        <i data-lucide="${isExpanded ? 'chevron-up' : 'chevron-down'}" class="w-4 h-4"></i>
                    `;
                    
                    // Region
                    const detailsRegion = document.createElement('div');
                    detailsRegion.className = isExpanded ? "mt-4 space-y-6 animate-in fade-in slide-in-from-top-1 duration-200" : "hidden";
                    
                    // Helper to build sections
                    const buildSection = (label, content, isList = false) => {
                        if (!content) return null;
                        const div = document.createElement('div');
                        div.className = "prose prose-slate max-w-none";
                        
                        const lbl = document.createElement('h4');
                        lbl.className = "text-xs font-bold text-ui-muted uppercase tracking-wide mb-2";
                        lbl.textContent = label;
                        div.appendChild(lbl);

                        const body = document.createElement('div');
                        // Use slightly tighter text for details
                        body.className = "text-ui-text text-sm leading-relaxed"; 
                        body.innerHTML = md ? md.render(content) : content;
                        div.appendChild(body);
                        
                        return div;
                    };

                    // 1. Keep in mind
                    const kim = buildSection("Keep in mind", sb.solutionDetails.keepInMind);
                    if (kim) detailsRegion.appendChild(kim);

                    // 2. Formulas
                    const formulas = buildSection("Formulas used", sb.solutionDetails.formulasUsed);
                    if (formulas) detailsRegion.appendChild(formulas);

                    // 3. Working
                    const working = buildSection("Working", sb.solutionDetails.working);
                    if (working) detailsRegion.appendChild(working);

                    // 4. Alternative Working (Array)
                    if (sb.solutionDetails.alternativeWorking && Array.isArray(sb.solutionDetails.alternativeWorking)) {
                        sb.solutionDetails.alternativeWorking.forEach((alt, idx) => {
                            // Separator
                            if(idx === 0 && (working || formulas || kim)) {
                                const sep = document.createElement('hr');
                                sep.className = "border-t border-ui-border my-4 opacity-50";
                                detailsRegion.appendChild(sep);
                            }
                            const altNode = buildSection("Alternative working", alt);
                            detailsRegion.appendChild(altNode);
                        });
                    }

                    // Toggle Logic
                    toggleBtn.onclick = () => {
                        const newState = ! (expandedStates[node.id] ?? isDefaultExpanded);
                        expandedStates[node.id] = newState;
                        
                        // Update UI
                        const labelSpan = toggleBtn.querySelector('.btn-label');
                        const icon = toggleBtn.querySelector('i');
                        
                        labelSpan.textContent = newState ? 'Hide working' : 'Show working';
                        
                        // Icon replace
                        icon.setAttribute('data-lucide', newState ? 'chevron-up' : 'chevron-down');
                        lucide.createIcons({ root: toggleBtn });

                        // Show/Hide Region
                        if (newState) {
                            detailsRegion.classList.remove('hidden');
                            detailsRegion.classList.add('animate-in', 'fade-in', 'slide-in-from-top-1');
                        } else {
                            detailsRegion.classList.add('hidden');
                            detailsRegion.classList.remove('animate-in', 'fade-in', 'slide-in-from-top-1');
                        }
                    };

                    blockWrapper.appendChild(toggleBtn);
                    blockWrapper.appendChild(detailsRegion);
                }

                wrapper.appendChild(blockWrapper);
            }

            // 3. Children (Recursion)
            if (node.children && node.children.length > 0) {
                const childrenContainer = document.createElement('div');
                childrenContainer.className = "ml-8 mt-4 border-l-2 border-transparent hover:border-ui-border transition-colors pl-4"; // Indentation guide
                
                node.children.forEach(child => {
                    const childNode = createQuestionNode(child, depth + 1);
                    childrenContainer.appendChild(childNode);
                });
                wrapper.appendChild(childrenContainer);
            }

            return wrapper;
        }

        // --- MOBILE DRAWER LOGIC ---
        function openDrawer() {
            els.mobileDrawer.classList.remove('-translate-x-full');
            els.mobileOverlay.classList.remove('hidden', 'opacity-0');
        }

        function closeDrawer() {
            els.mobileDrawer.classList.add('-translate-x-full');
            els.mobileOverlay.classList.add('opacity-0');
            setTimeout(() => els.mobileOverlay.classList.add('hidden'), 300);
        }

        els.mobileTrigger.addEventListener('click', openDrawer);
        els.mobileClose.addEventListener('click', closeDrawer);
        els.mobileOverlay.addEventListener('click', closeDrawer);

        // --- START ---
        init();

    </script>
</body>
</html>
