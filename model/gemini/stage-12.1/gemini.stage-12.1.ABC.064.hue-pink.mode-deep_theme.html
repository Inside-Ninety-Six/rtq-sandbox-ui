<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"ABC","indexWithinVariant":"64","totalWithinVariant":"320","hueFamily":"pink","intensityMode":"deep_theme","timestamp":"2026-01-07T12:20:38.316Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;ABC&quot;,&quot;indexWithinVariant&quot;:&quot;64&quot;,&quot;totalWithinVariant&quot;:&quot;320&quot;,&quot;hueFamily&quot;:&quot;pink&quot;,&quot;intensityMode&quot;:&quot;deep_theme&quot;,&quot;timestamp&quot;:&quot;2026-01-07T12:20:38.316Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>

    <!-- Tailwind CSS (via CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- KaTeX CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <!-- Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Markdown-it -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>
    
    <!-- KaTeX JS & Auto-render -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Configuration for ColorLab C: Deep Theme + ColorLab B: Pink -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        // COLORLAB C: MODE 4 "deep_theme" (Light Only) + COLORLAB B: "pink" (Hue ~350)
                        // All values in OKLCH
                        page: 'oklch(0.95 0.10 350)',        // L[0.92-0.98], C[0.08-0.16]
                        frame: 'oklch(0.93 0.10 350)',       // L[0.90-0.96], C[0.08-0.16]
                        paper: 'oklch(0.97 0.08 350)',       // L[0.94-0.99], C[0.06-0.14]
                        
                        primary: 'oklch(0.20 0.015 350)',    // L[0.15-0.25], C<=0.015
                        secondary: 'oklch(0.35 0.020 350)',  // L[0.25-0.40], C<=0.020
                        
                        accent: 'oklch(0.55 0.22 350)',      // L[0.45-0.65], C[0.16-0.26]
                        'accent-hover': 'oklch(0.50 0.22 350)',
                        
                        hairline: 'oklch(0.85 0.02 350)',    // C<=0.02
                        
                        // Wash surfaces
                        wash: 'oklch(0.95 0.06 350)',        // C[0.05-0.10]
                        'wash-inner': 'oklch(0.94 0.06 350)', 
                    },
                    spacing: {
                        'nav-w': '240px',
                    }
                }
            }
        }
    </script>

    <style>
        /* Base styles & resets */
        body {
            background-color: theme('colors.page');
            color: theme('colors.primary');
        }

        /* Scrollbar hiding for nav */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* KaTeX Containment Invariant */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            -webkit-overflow-scrolling: touch;
            padding: 0.5em 0;
        }
        
        /* Table styles per Stage 5.8.5 */
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 1em 0;
            font-size: 0.95em;
        }
        th, td {
            border: 1px solid theme('colors.hairline');
            padding: 0.5em 0.75em;
            text-align: left;
        }
        th {
            font-weight: 600;
        }
        .table-wrapper {
            overflow-x: auto;
            margin-bottom: 1em;
        }

        /* Markdown Content Rhythm */
        .md-content p {
            margin-bottom: 0.75em;
            line-height: 1.6;
        }
        .md-content p:last-child {
            margin-bottom: 0;
        }
        .md-content ul {
            list-style-type: disc;
            padding-left: 1.5em;
            margin-bottom: 0.75em;
        }
        .md-content ol {
            list-style-type: decimal;
            padding-left: 1.5em;
            margin-bottom: 0.75em;
        }

        /* Focus styles per Stage 5.5.2 */
        *:focus-visible {
            outline: 2px solid theme('colors.accent');
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* Utility for sticky nav rail */
        .sticky-nav {
            position: sticky;
            top: 0;
            max-height: 100vh;
            overflow-y: auto;
        }
    </style>
</head>
<body>

    <!-- STAGE 0 & 6.0.1b CONSTANTS -->
    <script>
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";
    </script>

    <!-- APP SHELL -->
    <div class="w-full flex justify-center p-0 md:p-6 lg:p-8 min-h-screen">
        
        <!-- DocumentFrameShell (Desktop: max-w-6xl) -->
        <div class="w-full max-w-6xl flex flex-col md:flex-row bg-frame md:rounded-lg md:shadow-sm overflow-hidden min-h-[90vh]">
            
            <!-- Mobile Top Bar (Visible only on small screens) -->
            <div class="md:hidden w-full bg-frame border-b border-hairline p-4 sticky top-0 z-20 flex justify-between items-center">
                <div id="mobile-paper-selector-container"></div>
                <button id="mobile-jump-to-btn" class="text-accent font-medium text-sm flex items-center gap-1">
                    Jump to
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="12" x2="20" y2="12"/><line x1="4" y1="6" x2="20" y2="6"/><line x1="4" y1="18" x2="20" y2="18"/></svg>
                </button>
            </div>

            <!-- Left Column: Navigation Rail (Desktop) -->
            <aside class="hidden md:block w-64 flex-shrink-0 border-r border-hairline bg-frame text-secondary sticky-nav">
                <div class="p-6">
                    <!-- Top Controls Wrapper -->
                    <div class="mb-8" id="desktop-paper-selector-container">
                        <!-- Paper Selector injected here -->
                    </div>
                    
                    <!-- Navigation List -->
                    <nav id="desktop-nav-list" class="flex flex-col gap-1" aria-label="Paper navigation">
                        <!-- Nav items injected here -->
                    </nav>
                </div>
            </aside>

            <!-- Right Column: Paper Content -->
            <main class="flex-1 bg-paper relative flex flex-col">
                <!-- Content Area -->
                <div id="paper-content" class="w-full max-w-3xl mx-auto px-4 py-8 md:px-12 md:py-12">
                    <!-- Paper injected here -->
                    <div class="flex items-center justify-center h-64 text-secondary italic">Loading paper...</div>
                </div>
            </main>
        </div>
    </div>

    <!-- Mobile Drawer Overlay -->
    <div id="drawer-overlay" class="fixed inset-0 bg-black/20 z-40 hidden opacity-0 transition-opacity duration-200" aria-hidden="true"></div>
    
    <!-- Mobile Drawer -->
    <div id="drawer-panel" class="fixed inset-y-0 right-0 z-50 w-64 bg-frame transform translate-x-full transition-transform duration-300 shadow-xl flex flex-col" aria-hidden="true">
        <div class="p-4 border-b border-hairline flex justify-between items-center">
            <span class="font-semibold text-primary">Jump to</span>
            <button id="drawer-close-btn" class="text-secondary hover:text-primary p-1">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
        </div>
        <div class="flex-1 overflow-y-auto p-4 no-scrollbar">
            <nav id="mobile-nav-list" class="flex flex-col gap-1">
                <!-- Mobile Nav items injected here -->
            </nav>
        </div>
    </div>

    <!-- Templates & Logic -->
    <script>
        // --- State ---
        let payload = null;
        let currentPaperKey = null;
        let expandedStates = {}; // { questionId: boolean }

        // --- Markdown & KaTeX Setup ---
        // Markdown-it strict config per Stage 6 Add-on
        const md = window.markdownit ? window.markdownit({
            html: true,     // Allow inline SVG
            linkify: true,
            breaks: false   // MUST be false to prevent <br> in math blocks
        }) : null;

        if (md) {
            // Disable escape rule to preserve TeX backslashes
            md.inline.ruler.disable(['escape']);
        }

        // --- Helper: Render Markdown ---
        function renderMarkdown(text) {
            if (!text) return '';
            if (!md) return text; // Fallback
            return md.render(text);
        }

        // --- Helper: Post-Render Math ---
        function renderMath(container) {
            if (window.renderMathInElement) {
                renderMathInElement(container, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false}
                    ],
                    throwOnError: false
                });
            }
        }

        // --- Initialization ---
        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Payload missing");
                payload = await response.json();
                
                if (!payload.papers || payload.papers.length === 0) {
                    throw new Error("No papers in payload");
                }

                renderPaperSelector();
                
                // Load first paper by default
                switchPaper(payload.papers[0].key);

            } catch (error) {
                console.error(error);
                document.getElementById('paper-content').innerHTML = `
                    <div class="p-8 text-center text-red-600 font-bold border border-red-200 bg-red-50 rounded">
                        PAPERS PAYLOAD MISSING
                    </div>
                `;
            }
        }

        // --- Paper Switching ---
        function switchPaper(key) {
            const paper = payload.papers.find(p => p.key === key);
            if (!paper) return;

            currentPaperKey = key;
            
            // Set defaults
            const defaultExpanded = paper.defaults?.expandedAll !== false;
            expandedStates = {}; 
            // Note: We don't recursively set all true here, we just assume true if missing, 
            // or explicit check if we wanted to be strict. For this logic, 
            // accessors will check `expandedStates[id] ?? defaultExpanded`.

            // Render
            renderPaperContent(paper);
            renderNavigation(paper);
            updateSelectorUI(key);

            // Reset Scroll
            window.scrollTo(0, 0);
            document.querySelector('.sticky-nav')?.scrollTo(0,0);
        }

        function updateSelectorUI(key) {
            const selects = document.querySelectorAll('.paper-select');
            selects.forEach(s => s.value = key);
        }

        // --- Rendering: Selectors ---
        function renderPaperSelector() {
            const options = payload.papers.map(p => `<option value="${p.key}">${p.label}</option>`).join('');
            const selectHTML = `
                <div class="relative">
                    <label for="paper-select" class="sr-only">Select Paper</label>
                    <select class="paper-select w-full bg-paper border border-hairline rounded px-3 py-2 text-sm text-primary focus:border-accent appearance-none cursor-pointer">
                        ${options}
                    </select>
                    <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none text-secondary">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                </div>
            `;

            // Inject into Desktop & Mobile containers
            document.getElementById('desktop-paper-selector-container').innerHTML = selectHTML;
            document.getElementById('mobile-paper-selector-container').innerHTML = selectHTML;

            // Bind events
            document.querySelectorAll('.paper-select').forEach(sel => {
                sel.addEventListener('change', (e) => switchPaper(e.target.value));
            });
        }

        // --- Rendering: Navigation ---
        function renderNavigation(paper) {
            const containers = [
                document.getElementById('desktop-nav-list'),
                document.getElementById('mobile-nav-list')
            ];

            let html = '';

            // Helper to render recursively
            const renderNavNodes = (nodes, level = 0) => {
                let chunk = '';
                nodes.forEach(node => {
                    // Item
                    const isSub = level > 0;
                    const typeScale = isSub ? 'text-sm text-secondary font-normal' : 'text-base text-primary font-medium';
                    
                    chunk += `
                        <button onclick="scrollToQuestion('${node.id}')" 
                                class="nav-item w-full text-left py-1 px-2 rounded hover:text-accent focus:text-accent transition-colors ${typeScale}"
                                data-id="${node.id}">
                            ${node.id}
                        </button>
                    `;
                    
                    if (node.children && node.children.length > 0) {
                        chunk += renderNavNodes(node.children, level + 1);
                    }
                });
                return chunk;
            };

            if (paper.sections) {
                paper.sections.forEach((section, idx) => {
                    // Section Label (only if valid)
                    if (section.label && section.label.trim().length > 0) {
                        html += `
                            <div class="mt-4 first:mt-0 mb-1 px-2 text-xs font-bold text-secondary uppercase tracking-wider select-none">
                                ${section.label}
                            </div>
                        `;
                    } else if (idx > 0) {
                        // Spacing if explicit label omitted but it's a new section block
                        html += `<div class="mt-4"></div>`;
                    }
                    html += renderNavNodes(section.questions);
                });
            } else if (paper.questions) {
                html += renderNavNodes(paper.questions);
            }

            containers.forEach(c => c.innerHTML = html);
        }

        function scrollToQuestion(id) {
            const el = document.getElementById(`q-${id}`);
            if (el) {
                // Close mobile drawer if open
                closeDrawer();
                // Scroll with offset for sticky headers/topbar
                const yOffset = -20; 
                const y = el.getBoundingClientRect().top + window.pageYOffset + yOffset;
                window.scrollTo({top: y, behavior: 'smooth'});
                
                // Update active state in nav (simple implementation)
                updateActiveNav(id);
            }
        }

        function updateActiveNav(id) {
            document.querySelectorAll('.nav-item').forEach(btn => {
                if (btn.dataset.id === id) {
                    btn.classList.add('font-bold', 'text-accent');
                    btn.classList.remove('text-secondary', 'font-normal');
                } else {
                    btn.classList.remove('font-bold', 'text-accent');
                }
            });
        }

        // --- Rendering: Paper Content ---
        function renderPaperContent(paper) {
            const container = document.getElementById('paper-content');
            let html = '';

            const renderNodes = (nodes, level = 0) => {
                return nodes.map(node => renderQuestionNode(node, level, paper)).join('');
            };

            if (paper.sections) {
                paper.sections.forEach((section, idx) => {
                    html += `<section class="mb-12">`;
                    if (section.label && section.label.trim().length > 0) {
                        html += `
                            <div class="mb-8 border-b border-hairline pb-2">
                                <h2 class="text-xl font-bold text-primary">${section.label}</h2>
                            </div>
                        `;
                    }
                    html += `<div class="flex flex-col gap-12">`; // Spacing between top-level questions
                    html += renderNodes(section.questions, 0);
                    html += `</div>`;
                    html += `</section>`;
                });
            } else if (paper.questions) {
                html += `<div class="flex flex-col gap-16">`;
                html += renderNodes(paper.questions, 0);
                html += `</div>`;
            }

            container.innerHTML = html;

            // Trigger KaTeX
            renderMath(container);
        }

        function renderQuestionNode(node, level, paper) {
            // Defaults
            const defaultExpanded = paper.defaults?.expandedAll !== false;
            const isExpanded = expandedStates[node.id] ?? defaultExpanded;
            
            const hasSolutionBlock = !!node.solutionBlock;
            const hasAnswer = hasSolutionBlock && !!node.solutionBlock.answer;
            const hasDetails = hasSolutionBlock && !!node.solutionBlock.solutionDetails;

            // Indentation class for children
            const indentClass = level > 0 ? 'ml-0 md:ml-8 mt-6' : '';
            // Separation for sub-questions is weaker than top-level
            const wrapperClass = level > 0 ? 'flex flex-col gap-4' : 'flex flex-col gap-4 w-full';

            let html = `
                <div id="q-${node.id}" class="${wrapperClass} ${indentClass}">
                    <!-- Question Body -->
                    <div class="group">
                        <div class="flex flex-row gap-3">
                            <span class="flex-shrink-0 font-bold text-secondary text-lg select-none pt-0.5">${node.id}</span>
                            <div class="text-primary text-lg leading-relaxed md-content w-full">
                                ${renderMarkdown(node.question)}
                            </div>
                        </div>
                    </div>
            `;

            // Solution Block
            if (hasSolutionBlock) {
                html += `<div class="ml-0 md:ml-10 mt-2 flex flex-col gap-3">`;

                // Answer
                if (hasAnswer) {
                    html += `
                        <div class="flex flex-col gap-1 text-primary">
                            <span class="text-xs font-bold text-accent uppercase tracking-wide">Answer</span>
                            <div class="text-base font-medium md-content">${renderMarkdown(node.solutionBlock.answer)}</div>
                        </div>
                    `;
                }

                // Solution Details Toggle
                if (hasDetails) {
                    const btnLabel = isExpanded ? 'Hide working' : 'Show working';
                    const iconRot = isExpanded ? 'rotate-180' : '';
                    
                    html += `
                        <div class="mt-1">
                            <button onclick="toggleSolutionDetails('${node.id}')" 
                                    class="text-accent text-sm font-medium hover:text-accent-hover flex items-center gap-1 focus:outline-none transition-colors">
                                <span>${btnLabel}</span>
                                <svg class="w-4 h-4 transition-transform duration-200 ${iconRot}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </button>
                        </div>
                    `;

                    // Expanded Details Region
                    if (isExpanded) {
                        const details = node.solutionBlock.solutionDetails;
                        html += `
                            <div class="bg-wash rounded-sm p-4 md:p-6 mt-1 flex flex-col gap-6 text-sm md:text-base border-l-2 border-hairline md:border-l-0">
                        `;

                        // Keep in mind
                        if (details.keepInMind) {
                            html += `
                                <div class="bg-wash-inner p-3 rounded-sm">
                                    <div class="font-bold text-accent text-xs uppercase mb-2">Keep in mind</div>
                                    <div class="md-content text-secondary">${renderMarkdown(details.keepInMind)}</div>
                                </div>
                            `;
                        }

                        // Formulas used
                        if (details.formulasUsed) {
                            html += `
                                <div>
                                    <div class="font-bold text-secondary text-xs uppercase mb-1">Formulas used</div>
                                    <div class="md-content text-primary">${renderMarkdown(details.formulasUsed)}</div>
                                </div>
                            `;
                        }

                        // Working
                        if (details.working) {
                            html += `
                                <div>
                                    <div class="font-bold text-secondary text-xs uppercase mb-2">Working</div>
                                    <div class="md-content text-primary space-y-4">${renderMarkdown(details.working)}</div>
                                </div>
                            `;
                        }

                        // Alternative working
                        if (details.alternativeWorking && Array.isArray(details.alternativeWorking)) {
                            details.alternativeWorking.forEach(alt => {
                                html += `
                                    <div class="border-t border-hairline pt-4 mt-2">
                                        <div class="font-bold text-secondary text-xs uppercase mb-2">Alternative working</div>
                                        <div class="md-content text-primary space-y-4">${renderMarkdown(alt)}</div>
                                    </div>
                                `;
                            });
                        }

                        html += `</div>`; // End details region
                    }
                }
                html += `</div>`; // End solution block wrapper
            }

            // Children Recursive
            if (node.children && node.children.length > 0) {
                html += `<div class="mt-2">`;
                html += node.children.map(child => renderQuestionNode(child, level + 1, paper)).join('');
                html += `</div>`;
            }

            html += `</div>`; // End main wrapper
            return html;
        }

        function toggleSolutionDetails(id) {
            // Find paper to check default
            const paper = payload.papers.find(p => p.key === currentPaperKey);
            const defaultExpanded = paper?.defaults?.expandedAll !== false;
            
            const current = expandedStates[id] ?? defaultExpanded;
            expandedStates[id] = !current;
            
            // Re-render ONLY current paper content to preserve scroll (mostly)
            // Ideally we'd find the node and update DOM, but full re-render is safer for prototype simplicity
            // To prevent scroll jumping, we'll try to save position?
            // Actually, the invariants say "expanding must not intentionally reposition scroll". 
            // A full re-render might jump if height changes above viewport. 
            // For a robust prototype, we re-render.
            
            // Save Y
            const y = window.scrollY;
            renderPaperContent(paper);
            window.scrollTo(0, y);
        }

        // --- Mobile Drawer Logic ---
        const drawerOverlay = document.getElementById('drawer-overlay');
        const drawerPanel = document.getElementById('drawer-panel');
        const jumpToBtn = document.getElementById('mobile-jump-to-btn');
        const closeBtn = document.getElementById('drawer-close-btn');

        function openDrawer() {
            drawerOverlay.classList.remove('hidden');
            // small delay to allow display:block to apply before opacity transition
            setTimeout(() => {
                drawerOverlay.classList.remove('opacity-0');
                drawerPanel.classList.remove('translate-x-full');
            }, 10);
            document.body.style.overflow = 'hidden';
        }

        function closeDrawer() {
            drawerPanel.classList.add('translate-x-full');
            drawerOverlay.classList.add('opacity-0');
            setTimeout(() => {
                drawerOverlay.classList.add('hidden');
            }, 300);
            document.body.style.overflow = '';
        }

        jumpToBtn.addEventListener('click', openDrawer);
        closeBtn.addEventListener('click', closeDrawer);
        drawerOverlay.addEventListener('click', closeDrawer);

        // --- Start ---
        init();

    </script>
</body>
</html>
