<!DOCTYPE html>
<html lang="en" class="light">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"A","indexWithinVariant":"5","totalWithinVariant":"25","hueFamily":"","intensityMode":"","timestamp":"2026-01-06T17:36:26.704Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;A&quot;,&quot;indexWithinVariant&quot;:&quot;5&quot;,&quot;totalWithinVariant&quot;:&quot;25&quot;,&quot;hueFamily&quot;:&quot;&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-06T17:36:26.704Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>

    <!-- Tailwind CSS (for prototyping speed per visual requirements) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class', // Manual only, enforced light mode in logic
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    colors: {
                        // ColorLab A Palette: Calm, Friendly, Modern, Light Mode Only
                        background: '#F8FAFC', // Slate 50
                        surface: '#FFFFFF',    // White
                        
                        // Text hierarchy
                        primary: '#0F172A',    // Slate 900
                        secondary: '#334155',  // Slate 700
                        tertiary: '#64748B',   // Slate 500
                        quaternary: '#94A3B8', // Slate 400

                        // Accent (Interactive, Focus, Current Nav) - Indigo
                        accent: {
                            DEFAULT: '#4F46E5', // Indigo 600
                            hover: '#4338CA',   // Indigo 700
                            subtle: '#EEF2FF',  // Indigo 50
                        },

                        // Structural
                        border: '#E2E8F0',     // Slate 200
                        divider: '#CBD5E1',    // Slate 300
                        
                        // Surfaces for solution details (subtle wash)
                        wash: '#F8FAFC',       // Slate 50 (subtle differentiation from white)
                    }
                }
            }
        }
    </script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- KaTeX CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Markdown-it -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <!-- KaTeX JS + Auto-render -->
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <style>
        /* Base Reset & Typography */
        body {
            font-family: 'Inter', sans-serif;
            background-color: theme('colors.background');
            color: theme('colors.primary');
            -webkit-font-smoothing: antialiased;
            overflow-y: scroll; /* Always show scrollbar to prevent layout shift */
        }

        /* Layout Utilities */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* KaTeX / Math Containment - Stage 6 Invariant */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding-bottom: 4px; /* Space for scrollbar if needed */
            -webkit-overflow-scrolling: touch;
        }
        
        /* Prevent inline math background */
        .katex {
            background-color: transparent !important;
        }

        /* Markdown Content Styles */
        .markdown-content p {
            margin-bottom: 0.75em;
            line-height: 1.6;
        }
        .markdown-content p:last-child {
            margin-bottom: 0;
        }
        
        /* Table styles - Minimal, structural */
        .markdown-content table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1em;
            font-size: 0.95em;
        }
        .markdown-content th, .markdown-content td {
            border: 1px solid theme('colors.border');
            padding: 0.5rem;
            text-align: left;
        }
        .markdown-content th {
            font-weight: 600;
            color: theme('colors.secondary');
        }

        /* Focus Styles - Accessible but restrained */
        :focus-visible {
            outline: 2px solid theme('colors.accent.DEFAULT');
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* Transition Utilities */
        .transition-height {
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
        }

        /* Sticky Nav Persistence */
        .sticky-nav {
            position: sticky;
            top: 1rem; /* Spacing from top */
            max-height: calc(100vh - 2rem);
            overflow-y: auto;
        }

        /* Navigation Drawer Animation */
        .drawer-enter {
            transform: translateX(-100%);
        }
        .drawer-enter-active {
            transform: translateX(0);
            transition: transform 0.3s ease-out;
        }
        .drawer-exit {
            transform: translateX(0);
        }
        .drawer-exit-active {
            transform: translateX(-100%);
            transition: transform 0.3s ease-in;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- STAGE 0 CONSTANTS DEFINITION IN JS (See bottom script) -->

    <!-- Top Controls Region -->
    <header class="w-full bg-background/95 backdrop-blur z-40 border-b border-border sticky top-0">
        <div class="max-w-7xl mx-auto px-4 md:px-8 h-14 flex items-center justify-between">
            <!-- Left: Mobile Menu Trigger -->
            <button id="mobile-menu-trigger" class="md:hidden p-2 -ml-2 text-secondary hover:text-primary rounded-md" aria-label="Jump to question">
                <i data-lucide="menu" class="w-5 h-5"></i>
            </button>

            <!-- Center/Left: Paper Selector -->
            <div class="flex items-center gap-3">
                <label for="paper-selector" class="text-sm font-medium text-tertiary hidden sm:block">Paper</label>
                <select id="paper-selector" class="bg-surface border border-border text-primary text-sm rounded-md py-1.5 pl-3 pr-8 focus:border-accent focus:ring-1 focus:ring-accent outline-none">
                    <option value="" disabled selected>Loading papers...</option>
                </select>
            </div>

            <!-- Right: Mobile "Jump to" label (visual anchor) -->
            <span class="md:hidden text-sm font-medium text-tertiary">Jump to</span>
        </div>
    </header>

    <!-- DocumentFrameShell -->
    <div id="main-shell" class="flex-1 max-w-7xl mx-auto w-full px-4 md:px-8 py-6 md:py-8 flex gap-8 relative">
        
        <!-- Desktop Navigation Rail (Left Column) -->
        <nav class="hidden md:block w-48 shrink-0 relative" aria-label="Document navigation">
            <div class="sticky-nav scrollbar-hide pr-4">
                <div id="desktop-nav-list" class="flex flex-col gap-1">
                    <!-- Nav items injected here -->
                </div>
            </div>
        </nav>

        <!-- Paper Document Column (Right Column) -->
        <main id="paper-content" class="flex-1 min-w-0 pb-32">
            <!-- Content injected here -->
            <div id="loading-state" class="text-tertiary text-center mt-12">Loading paper content...</div>
            <div id="error-state" class="hidden text-red-600 font-medium text-center mt-12 text-lg">PAPERS PAYLOAD MISSING</div>
        </main>

    </div>

    <!-- Mobile Navigation Drawer -->
    <div id="mobile-drawer-overlay" class="fixed inset-0 bg-black/50 z-50 hidden transition-opacity opacity-0" aria-hidden="true"></div>
    <div id="mobile-drawer" class="fixed inset-y-0 left-0 w-64 bg-surface shadow-xl z-50 transform -translate-x-full transition-transform duration-300 ease-out flex flex-col" role="dialog" aria-modal="true" aria-label="Jump to question">
        
        <div class="h-14 flex items-center justify-between px-4 border-b border-border">
            <span class="font-medium text-primary">Jump to</span>
            <button id="mobile-drawer-close" class="p-2 -mr-2 text-secondary hover:text-primary rounded-md">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>

        <div class="flex-1 overflow-y-auto p-4">
            <div id="mobile-nav-list" class="flex flex-col gap-1">
                <!-- Mobile nav items injected here -->
            </div>
        </div>
    </div>

    <script>
        // --- STAGE 0: CONSTANTS ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // --- STATE & DOM ---
        let payloadData = null;
        let currentPaperId = null;
        let expandedStates = {}; // Map<QuestionID, boolean>
        
        const els = {
            paperSelector: document.getElementById('paper-selector'),
            paperContent: document.getElementById('paper-content'),
            desktopNavList: document.getElementById('desktop-nav-list'),
            mobileNavList: document.getElementById('mobile-nav-list'),
            loadingState: document.getElementById('loading-state'),
            errorState: document.getElementById('error-state'),
            mobileMenuTrigger: document.getElementById('mobile-menu-trigger'),
            mobileDrawer: document.getElementById('mobile-drawer'),
            mobileDrawerOverlay: document.getElementById('mobile-drawer-overlay'),
            mobileDrawerClose: document.getElementById('mobile-drawer-close'),
        };

        // --- MARKDOWN SETUP ---
        // Stage 6 Requirement: html: true, linkify: true, breaks: false. Disable escape.
        const md = window.markdownit ? window.markdownit({
            html: true,
            linkify: true,
            breaks: false 
        }) : null;

        if (md) {
            // Disable inline escape rule to preserve TeX backslashes
            md.inline.ruler.disable(['escape']);
        }

        // --- FETCH LOGIC ---
        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error('Payload fetch failed');
                
                payloadData = await response.json();
                
                if (!payloadData || !payloadData.papers || payloadData.papers.length === 0) {
                    throw new Error('Invalid payload structure');
                }

                populatePaperSelector();
                switchPaper(payloadData.papers[0].key);
                
                els.loadingState.classList.add('hidden');
            } catch (error) {
                console.error(error);
                els.loadingState.classList.add('hidden');
                els.paperSelector.disabled = true;
                els.paperSelector.innerHTML = '<option>Error</option>';
                els.paperContent.innerHTML = '';
                els.errorState.classList.remove('hidden');
            }
        }

        // --- INITIALIZATION ---
        init();

        // --- RENDERERS ---

        function populatePaperSelector() {
            els.paperSelector.innerHTML = payloadData.papers.map(p => 
                `<option value="${p.key}">${p.label}</option>`
            ).join('');
            
            els.paperSelector.addEventListener('change', (e) => {
                switchPaper(e.target.value);
            });
        }

        function switchPaper(paperKey) {
            currentPaperId = paperKey;
            const paper = payloadData.papers.find(p => p.key === paperKey);
            if (!paper) return;

            // Reset state
            expandedStates = {};
            const defaultExpanded = paper.defaults && paper.defaults.expandedAll !== false;

            // Build flattened list for navigation and linear rendering
            const { flatQuestions, sectionsMap } = processPaperStructure(paper);

            // Initialize default expanded states for all questions with solution details
            flatQuestions.forEach(q => {
                if (hasSolutionDetails(q)) {
                    expandedStates[q.id] = defaultExpanded;
                }
            });

            // Render Navigation
            renderNavigation(flatQuestions, sectionsMap, paper);

            // Render Content
            renderPaperContent(paper);

            // Trigger Icons & Math
            lucide.createIcons();
            renderMath();
            
            // Setup Intersection Observer for Nav Highlighting
            setupNavObserver(flatQuestions);

            // Scroll to top
            window.scrollTo(0, 0);
        }

        function processPaperStructure(paper) {
            let flatQuestions = [];
            let sectionsMap = new Map(); // QuestionID -> SectionLabel (if exists)

            if (paper.sections) {
                paper.sections.forEach(section => {
                    section.questions.forEach((q, idx) => {
                        if (idx === 0) sectionsMap.set(q.id, section.label); // Mark start of section
                        collectQuestions(q, flatQuestions);
                    });
                });
            } else if (paper.questions) {
                paper.questions.forEach(q => {
                    collectQuestions(q, flatQuestions);
                });
            }
            return { flatQuestions, sectionsMap };
        }

        function collectQuestions(node, list) {
            list.push(node);
            if (node.children) {
                node.children.forEach(child => collectQuestions(child, list));
            }
        }

        function hasSolutionDetails(node) {
            return node.solutionBlock && node.solutionBlock.solutionDetails;
        }

        // --- NAVIGATION RENDER ---
        function renderNavigation(flatQuestions, sectionsMap, paper) {
            const createNavHTML = (isDesktop) => {
                let html = '';
                let currentSectionLabel = null;

                // If paper has sections, we iterate the paper.sections structure to insert headers
                if (paper.sections) {
                    paper.sections.forEach(section => {
                        if (section.label && section.label.trim() !== '') {
                            html += `<div class="text-xs font-semibold text-tertiary uppercase tracking-wider mb-2 mt-4 px-2 select-none">${section.label}</div>`;
                        }
                        
                        section.questions.forEach(q => {
                            html += renderNavTree(q, 0);
                        });
                        
                        // Add spacing between sections
                        html += '<div class="h-2"></div>';
                    });
                } else {
                    // Flat paper
                    paper.questions.forEach(q => {
                        html += renderNavTree(q, 0);
                    });
                }
                return html;
            };

            const renderNavTree = (node, depth) => {
                let html = '';
                // Hierarchy via type scale/weight/color, NO indentation
                // Depth 0: Base size. Depth > 0: Smaller, lighter.
                const isTopLevel = depth === 0;
                const classes = isTopLevel 
                    ? "text-sm font-medium text-secondary py-1 px-2 block hover:text-primary hover:bg-black/5 rounded transition-colors nav-item" 
                    : "text-xs font-normal text-tertiary py-0.5 px-2 block hover:text-secondary hover:bg-black/5 rounded transition-colors nav-item";
                
                html += `<a href="#q-${node.id}" class="${classes}" data-target="q-${node.id}">
                    ${node.id}
                </a>`;

                if (node.children) {
                    node.children.forEach(child => {
                        html += renderNavTree(child, depth + 1);
                    });
                }
                return html;
            };

            const navHTML = createNavHTML();
            els.desktopNavList.innerHTML = navHTML;
            els.mobileNavList.innerHTML = navHTML;
        }

        // --- CONTENT RENDER ---
        function renderPaperContent(paper) {
            let html = '';

            if (paper.sections) {
                paper.sections.forEach(section => {
                    // Section Header (Structural Divider)
                    if (section.label && section.label.trim() !== '') {
                        html += `
                            <div class="mb-8 mt-12 pb-2 border-b border-border">
                                <h2 class="text-xl font-semibold text-primary">${section.label}</h2>
                            </div>
                        `;
                    } else if (html !== '') {
                         // Divider if unnamed section follows another, just spacing
                         html += `<div class="h-12"></div>`;
                    }

                    // Render Questions
                    html += `<div class="flex flex-col gap-12">`;
                    section.questions.forEach(q => {
                        html += renderQuestionNode(q, 0);
                    });
                    html += `</div>`;
                });
            } else {
                html += `<div class="flex flex-col gap-12">`;
                paper.questions.forEach(q => {
                    html += renderQuestionNode(q, 0);
                });
                html += `</div>`;
            }

            els.paperContent.innerHTML = html;
        }

        function renderQuestionNode(node, depth) {
            // Stage 3: Top-level questions separated by largest unit. 
            // Child questions separated by vertical spacing + indentation (handled via flex/padding).
            // Recursion handles nesting.

            const isTopLevel = depth === 0;
            const indentClass = depth > 0 ? 'pl-4 md:pl-8 border-l border-border/50' : '';
            const spacingClass = depth > 0 ? 'mt-6' : ''; // Spacing between parent and children or between siblings

            // Markdown render of Question Prompt
            const questionHtml = md ? md.render(node.question || '') : node.question;

            // Generate Solution Block HTML
            const solutionBlockHtml = renderSolutionBlock(node);

            let childrenHtml = '';
            if (node.children && node.children.length > 0) {
                childrenHtml = `<div class="flex flex-col gap-6 mt-6">
                    ${node.children.map(child => renderQuestionNode(child, depth + 1)).join('')}
                </div>`;
            }

            return `
                <div id="q-${node.id}" class="relative group scroll-mt-24 ${indentClass} ${spacingClass}">
                    <!-- Question Body -->
                    <div class="flex flex-col gap-2">
                        <div class="flex items-baseline gap-3">
                            <span class="text-tertiary font-medium text-sm select-none shrink-0 w-8 md:w-10 text-right font-mono" aria-hidden="true">${node.id}</span>
                            <div class="flex-1 text-primary text-base md:text-lg markdown-content font-medium">
                                ${questionHtml}
                            </div>
                        </div>
                    </div>

                    <!-- Solution Block -->
                    ${solutionBlockHtml}

                    <!-- Children -->
                    ${childrenHtml}
                </div>
            `;
        }

        function renderSolutionBlock(node) {
            if (!node.solutionBlock) return '';

            const { answer, solutionDetails } = node.solutionBlock;
            const hasAnswer = !!answer;
            const hasDetails = !!solutionDetails;
            
            // If neither exist, return empty (shouldn't happen per spec if block exists, but safe guard)
            if (!hasAnswer && !hasDetails) return '';

            let html = `<div class="ml-11 md:ml-14 mt-4 flex flex-col gap-4">`;

            // 1. Answer (Visible by default if present)
            if (hasAnswer) {
                const answerContent = md ? md.render(answer) : answer;
                html += `
                    <div class="flex flex-col gap-1">
                        <span class="text-xs font-bold text-tertiary uppercase tracking-wide">Answer</span>
                        <div class="text-primary font-medium markdown-content bg-surface">
                            ${answerContent}
                        </div>
                    </div>
                `;
            }

            // 2. Solution Details (Expandable)
            if (hasDetails) {
                const isExpanded = expandedStates[node.id];
                const buttonText = isExpanded ? 'Hide working' : 'Show working';
                const chevronClass = isExpanded ? 'rotate-180' : '';
                const detailsClass = isExpanded ? 'block' : 'hidden';

                // Content Render
                const keepInMind = solutionDetails.keepInMind ? md.render(solutionDetails.keepInMind) : '';
                const formulas = solutionDetails.formulasUsed ? md.render(solutionDetails.formulasUsed) : '';
                const working = solutionDetails.working ? md.render(solutionDetails.working) : '';
                
                let altWorkingHtml = '';
                if (solutionDetails.alternativeWorking && Array.isArray(solutionDetails.alternativeWorking)) {
                    solutionDetails.alternativeWorking.forEach((aw, idx) => {
                        altWorkingHtml += `
                            <div class="mt-6 pt-6 border-t border-divider border-dashed">
                                <span class="text-xs font-bold text-tertiary uppercase tracking-wide block mb-2">Alternative working</span>
                                <div class="markdown-content text-secondary text-sm md:text-base">
                                    ${md.render(aw)}
                                </div>
                            </div>
                        `;
                    });
                } else if (solutionDetails.alternativeWorking) {
                    // Handle string case just in case payload varies
                     altWorkingHtml += `
                            <div class="mt-6 pt-6 border-t border-divider border-dashed">
                                <span class="text-xs font-bold text-tertiary uppercase tracking-wide block mb-2">Alternative working</span>
                                <div class="markdown-content text-secondary text-sm md:text-base">
                                    ${md.render(solutionDetails.alternativeWorking)}
                                </div>
                            </div>
                        `;
                }

                html += `
                    <div class="solution-details-container">
                        <!-- Toggle Control -->
                        <button onclick="toggleDetails('${node.id}')" class="group flex items-center gap-2 text-accent-DEFAULT hover:text-accent-hover text-sm font-medium focus:outline-none focus-visible:ring-2 focus-visible:ring-accent rounded py-1 -ml-1 px-1 transition-colors">
                            <span id="btn-text-${node.id}">${buttonText}</span>
                            <i data-lucide="chevron-down" id="icon-${node.id}" class="w-4 h-4 transition-transform duration-200 ${chevronClass}"></i>
                        </button>

                        <!-- Expanded Region -->
                        <div id="details-${node.id}" class="${detailsClass} mt-3 pl-4 border-l-2 border-accent-subtle/50 bg-wash rounded-r-md p-4 animate-in fade-in slide-in-from-top-1 duration-200">
                            
                            <!-- Keep in Mind -->
                            ${keepInMind ? `
                                <div class="mb-5">
                                    <div class="flex items-center gap-2 mb-1.5">
                                        <i data-lucide="lightbulb" class="w-4 h-4 text-tertiary"></i>
                                        <span class="text-xs font-bold text-tertiary uppercase tracking-wide">Keep in mind</span>
                                    </div>
                                    <div class="markdown-content text-secondary text-sm">
                                        ${keepInMind}
                                    </div>
                                </div>
                            ` : ''}

                            <!-- Formulas Used -->
                            ${formulas ? `
                                <div class="mb-5">
                                    <span class="text-xs font-bold text-tertiary uppercase tracking-wide block mb-1.5">Formulas used</span>
                                    <div class="markdown-content text-secondary text-sm">
                                        ${formulas}
                                    </div>
                                </div>
                            ` : ''}

                            <!-- Working (Primary) -->
                            ${working ? `
                                <div>
                                    <span class="text-xs font-bold text-tertiary uppercase tracking-wide block mb-1.5">Working</span>
                                    <div class="markdown-content text-secondary text-sm md:text-base">
                                        ${working}
                                    </div>
                                </div>
                            ` : ''}

                            <!-- Alternative Working -->
                            ${altWorkingHtml}

                        </div>
                    </div>
                `;
            }

            html += `</div>`;
            return html;
        }

        // --- INTERACTIONS ---
        
        window.toggleDetails = (id) => {
            const isExpanded = !expandedStates[id];
            expandedStates[id] = isExpanded;

            const detailsEl = document.getElementById(`details-${id}`);
            const btnTextEl = document.getElementById(`btn-text-${id}`);
            const iconEl = document.getElementById(`icon-${id}`);

            if (isExpanded) {
                detailsEl.classList.remove('hidden');
                btnTextEl.innerText = 'Hide working';
                iconEl.classList.add('rotate-180');
            } else {
                detailsEl.classList.add('hidden');
                btnTextEl.innerText = 'Show working';
                iconEl.classList.remove('rotate-180');
            }
        };

        // Render Math after DOM updates
        function renderMath() {
            if (window.renderMathInElement) {
                renderMathInElement(document.body, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false}
                    ],
                    throwOnError: false
                });
            }
        }

        // --- MOBILE DRAWER LOGIC ---
        function toggleDrawer(show) {
            const drawer = els.mobileDrawer;
            const overlay = els.mobileDrawerOverlay;
            
            if (show) {
                overlay.classList.remove('hidden');
                // Force reflow for opacity transition
                void overlay.offsetWidth; 
                overlay.classList.remove('opacity-0');
                
                drawer.classList.remove('-translate-x-full');
                document.body.style.overflow = 'hidden'; // Lock body scroll
            } else {
                overlay.classList.add('opacity-0');
                drawer.classList.add('-translate-x-full');
                
                setTimeout(() => {
                    overlay.classList.add('hidden');
                    document.body.style.overflow = '';
                }, 300);
            }
        }

        els.mobileMenuTrigger.addEventListener('click', () => toggleDrawer(true));
        els.mobileDrawerClose.addEventListener('click', () => toggleDrawer(false));
        els.mobileDrawerOverlay.addEventListener('click', () => toggleDrawer(false));

        // Close drawer on link click
        els.mobileNavList.addEventListener('click', (e) => {
            if (e.target.tagName === 'A') {
                toggleDrawer(false);
            }
        });

        // --- SCROLL SPY / ACTIVE NAV ---
        function setupNavObserver(questions) {
            const observerOptions = {
                root: null,
                rootMargin: '-10% 0px -80% 0px', // Active when question enters top area
                threshold: 0
            };

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const id = entry.target.id; // q-ID
                        updateActiveNav(id);
                    }
                });
            }, observerOptions);

            questions.forEach(q => {
                const el = document.getElementById(`q-${q.id}`);
                if (el) observer.observe(el);
            });
        }

        function updateActiveNav(targetId) {
            // Remove active styles from all
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('text-accent-DEFAULT', 'font-bold', 'bg-accent-subtle');
                // Reset to default colors
                if(el.classList.contains('text-sm')) {
                     el.classList.add('text-secondary');
                     el.classList.remove('text-primary'); // Ensure primary is removed if it was there
                } else {
                     el.classList.add('text-tertiary');
                }
            });

            // Add active styles to current
            const navLinks = document.querySelectorAll(`a[data-target="${targetId}"]`);
            navLinks.forEach(link => {
                link.classList.remove('text-secondary', 'text-tertiary');
                link.classList.add('text-accent-DEFAULT', 'font-bold', 'bg-accent-subtle');
            });
        }

    </script>
</body>
</html>
