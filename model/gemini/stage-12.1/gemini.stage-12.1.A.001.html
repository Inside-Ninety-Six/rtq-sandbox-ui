<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"A","indexWithinVariant":"1","totalWithinVariant":"20","hueFamily":"","intensityMode":"","timestamp":"2026-01-06T15:25:42.536Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;A&quot;,&quot;indexWithinVariant&quot;:&quot;1&quot;,&quot;totalWithinVariant&quot;:&quot;20&quot;,&quot;hueFamily&quot;:&quot;&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-06T15:25:42.536Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer (Stage 6 Baseline)</title>

    <!-- Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- KaTeX CSS (No integrity) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <style>
        /* =========================================
           STAGE 0-6: CSS RESET & BASE
           ========================================= */
        :root {
            /* COLORLAB A: Palette Freedom (Light Mode Only) */
            /* Using a crisp Slate/Blue theme for a modern, paper-adjacent feel */
            
            /* Surfaces (Steps) */
            --surf-step-0-base: #f8fafc;       /* Global background */
            --surf-step-1-frame: #f8fafc;      /* Frame shell (matches base per desktop rule) */
            --surf-step-2-paper: #ffffff;      /* Main paper surface */
            --surf-step-3-wash1: #f1f5f9;      /* Solution Details Region */
            --surf-step-4-wash2: #e2e8f0;      /* Keep in mind */
            --surf-step-5-wash3: #cbd5e1;      /* Formulas used */

            /* Typography */
            --font-sans: 'Inter', sans-serif;
            --text-primary: #0f172a;           /* Slate 900 */
            --text-secondary: #475569;         /* Slate 600 */
            --text-tertiary: #64748b;          /* Slate 500 */
            --text-quiet: #94a3b8;             /* Slate 400 */

            /* Accent (Restrained, Stage 5 Override) */
            --accent-color: #2563eb;           /* Blue 600 */
            --accent-hover: #1d4ed8;           /* Blue 700 */

            /* Dividers */
            --divider-color: #e2e8f0;          /* Slate 200 */

            /* Spacing Scale (Rem based) */
            --spc-0: 0;
            --spc-1: 0.25rem;  /* 4px */
            --spc-2: 0.5rem;   /* 8px */
            --spc-3: 0.75rem;  /* 12px */
            --spc-4: 1rem;     /* 16px */
            --spc-5: 1.5rem;   /* 24px */
            --spc-6: 2rem;     /* 32px */
            --spc-8: 3rem;     /* 48px */
            --spc-10: 4rem;    /* 64px */

            /* Layout Dimensions */
            --nav-width: 240px;
            --frame-max-width: 1024px;
            --header-height: 60px;
        }

        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: var(--font-sans);
            background-color: var(--surf-step-0-base);
            color: var(--text-primary);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        /* Focus Styles (Accessibility) */
        :focus-visible {
            outline: 2px solid var(--accent-color);
            outline-offset: 2px;
        }

        /* =========================================
           STAGE 6: CANONICAL LAYOUT MECHANISMS
           ========================================= */

        /* --- SEPARATORS (Virtual Boundaries) --- */
        [data-rtq-boundary] {
            display: block;
            width: 100%;
        }

        /* --- DIVIDERS (Hairlines) --- */
        .rtq-divider {
            height: 1px;
            background-color: var(--divider-color);
            width: 100%;
            border: none;
            margin: 0;
        }
        
        /* Specific dividers based on canonical names */
        [data-rtq="DIV__TOP_CONTROLS_TO_FRAME_HAIRLINE"] { margin-bottom: var(--spc-4); }
        [data-rtq="DIV__NAV_SECTION_LABEL_TO_ITEMS_HAIRLINE"] { margin-top: var(--spc-1); margin-bottom: var(--spc-1); }
        [data-rtq="DIV__NAV_BETWEEN_SECTIONS_HAIRLINE"] { margin-top: var(--spc-2); margin-bottom: var(--spc-2); }
        [data-rtq="DIV__NAV_TO_PAPER_COLUMN_HAIRLINE"] { display: none; /* Desktop uses grid gap, mobile handled differently */ }
        [data-rtq="DIV__SECTION_HEADER_TO_QUESTION_LIST_HAIRLINE"] { margin-bottom: var(--spc-4); }
        [data-rtq="DIV__QUESTION_LIST_TO_NEXT_SECTION_HEADER_HAIRLINE"] { margin-top: var(--spc-6); }
        [data-rtq="DIV__TOP_LEVEL_HAIRLINE"] { display: none; /* Spacing primary */ }
        [data-rtq="DIV__PARENT_TO_CHILDREN_VERTICAL_DIVIDER"] { display: none; }
        [data-rtq="DIV__QUESTION_TO_SOLUTION_DIVIDER"] { margin-top: var(--spc-3); margin-bottom: var(--spc-3); }
        [data-rtq="DIV__ANSWER_TO_SOLUTION_DETAILS_DIVIDER"] { margin-top: var(--spc-3); margin-bottom: var(--spc-3); }
        [data-rtq="DIV__SD_KEEP_IN_MIND_TO_FORMULAS_DIVIDER"] { margin-top: var(--spc-3); margin-bottom: var(--spc-3); }
        [data-rtq="DIV__SD_FORMULAS_TO_WORKING_DIVIDER"] { margin-top: var(--spc-3); margin-bottom: var(--spc-3); }
        [data-rtq="DIV__SD_WORKING_TO_ALTERNATIVE_DIVIDER"] { margin-top: var(--spc-4); margin-bottom: var(--spc-4); }
        [data-rtq="DIV__DRAWER_HEADER_TO_LIST_HAIRLINE"] { margin-bottom: var(--spc-3); }

        /* --- SPACING (Layout rhythm) --- */
        /* Implemented via utility classes applied to container/elements */
        .spc-mb-1 { margin-bottom: var(--spc-1); }
        .spc-mb-2 { margin-bottom: var(--spc-2); }
        .spc-mb-3 { margin-bottom: var(--spc-3); }
        .spc-mb-4 { margin-bottom: var(--spc-4); }
        .spc-mb-5 { margin-bottom: var(--spc-5); }
        .spc-mb-6 { margin-bottom: var(--spc-6); }
        
        /* Specific spacing canonical hooks */
        [data-rtq="SPC__TOP_LEVEL_INTER_QUESTION_SPACING"] { height: var(--spc-8); }
        [data-rtq="SPC__CHILD_INDENTATION"] { margin-left: var(--spc-4); }
        [data-rtq="SPC__PARENT_TO_CHILDREN_VERTICAL_SPACING"] { height: var(--spc-3); }
        
        /* --- SURFACES (Explicit Steps) --- */
        [data-rtq="SURF__TOP_CONTROLS"] {
            background-color: var(--surf-step-1-frame);
            /* Aligned to frame shell logic */
        }
        [data-rtq="SURF__FRAME_BASE"] {
            background-color: var(--surf-step-1-frame);
            min-height: 100vh;
        }
        [data-rtq="SURF__PAPER"] {
            background-color: var(--surf-step-2-paper);
            padding: var(--spc-6) var(--spc-8); 
            /* Paper shadow/border for distinctness */
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            border-radius: 4px;
        }
        [data-rtq="SURF__SOLUTION_DETAILS_WASH"] {
            background-color: var(--surf-step-3-wash1);
            padding: var(--spc-4);
            border-radius: 4px;
        }
        [data-rtq="SURF__SD_KEEP_IN_MIND"] {
            background-color: var(--surf-step-4-wash2);
            padding: var(--spc-3);
            border-radius: 4px;
        }
        [data-rtq="SURF__SD_FORMULAS_USED"] {
            background-color: var(--surf-step-5-wash3);
            padding: var(--spc-3);
            border-radius: 4px;
        }
        /* Question Node & Answer surfaces are typically transparent/part of flow, 
           but mandatory surface hook exists. We use transparent base for them unless density requires otherwise.
           Stage 6 6.0.0b1 allows transparent if logical parent is distinct, but mandatory requires assignment.
           We assign them to 'transparent' on top of SURF__PAPER.
        */
        [data-rtq="SURF__QUESTION_NODE"], [data-rtq="SURF__ANSWER"] {
            background-color: transparent;
        }

        /* --- CONTENT TYPOGRAPHY --- */
        h1, h2, h3, h4, p, ul, ol { margin-top: 0; margin-bottom: 0.75em; }
        
        .typo-question-id {
            font-weight: 700;
            color: var(--text-secondary);
            font-size: 1.125rem;
            margin-right: 0.5em;
        }
        .typo-question-text {
            font-size: 1.125rem;
            color: var(--text-primary);
            font-weight: 500;
        }
        .typo-answer-label {
            font-size: 0.875rem;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .typo-answer-content {
            font-size: 1rem;
            color: var(--text-primary);
            font-weight: 500;
        }
        .typo-sd-label {
            font-size: 0.875rem;
            font-weight: 700;
            color: var(--text-secondary);
            margin-bottom: var(--spc-1);
        }
        .typo-disclosure {
            font-size: 0.9375rem;
            font-weight: 600;
            color: var(--accent-color);
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            display: inline-flex;
            align-items: center;
            gap: 0.5ch;
        }
        .typo-disclosure:hover {
            color: var(--accent-hover);
            text-decoration: underline;
        }

        /* --- LAYOUT STRUCTURE --- */
        .shell-container {
            max-width: var(--frame-max-width);
            margin: 0 auto;
            display: grid;
            grid-template-columns: var(--nav-width) 1fr;
            gap: var(--spc-6);
            padding: 0 var(--spc-4) var(--spc-8) var(--spc-4);
        }

        /* Top Controls */
        .top-controls {
            position: sticky;
            top: 0;
            z-index: 10;
            padding: var(--spc-4) 0;
            background-color: var(--surf-step-1-frame); /* Matches shell */
        }
        .top-controls-inner {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* Navigation (Desktop) */
        .nav-rail {
            position: sticky;
            top: 80px; /* Offset for top controls */
            height: calc(100vh - 80px);
            overflow-y: auto;
            /* CUE__NAV_SCROLLBARS_HIDDEN */
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .nav-rail::-webkit-scrollbar { display: none; }

        .nav-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .nav-item {
            display: block;
            padding: var(--spc-1) 0;
            color: var(--text-tertiary);
            text-decoration: none;
            font-size: 0.9375rem;
            /* Flat list, no indent */
            padding-left: 0; 
            border-left: 2px solid transparent;
            margin-left: -2px; /* Compensate border */
        }
        .nav-item:hover {
            color: var(--text-primary);
        }
        .nav-item.active {
            color: var(--accent-color);
            font-weight: 700;
            border-left-color: var(--accent-color);
        }
        .nav-section-label {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text-quiet);
            text-transform: uppercase;
            margin-top: var(--spc-4);
            margin-bottom: var(--spc-2);
            pointer-events: none;
        }

        /* Paper Content */
        .paper-region {
            min-width: 0; /* Prevent grid blowout */
        }

        .section-header {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-secondary);
            margin-bottom: var(--spc-4);
            padding-bottom: var(--spc-2);
            border-bottom: 1px solid var(--divider-color);
        }

        /* --- MOBILE DRAWER --- */
        .mobile-jump-trigger {
            display: none; /* Desktop default */
            font-size: 0.9375rem;
            font-weight: 600;
            color: var(--accent-color);
            background: none;
            border: 1px solid var(--divider-color);
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .drawer-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(15, 23, 42, 0.4); /* CUE__DRAWER_SCRIM */
            z-index: 50;
            display: none;
        }
        .drawer-overlay.open { display: block; }
        
        .drawer-content {
            position: fixed;
            top: 0; right: 0; bottom: 0;
            width: 85%;
            max-width: 320px;
            background-color: var(--surf-step-2-paper);
            z-index: 51;
            transform: translateX(100%);
            transition: transform 0.2s ease-out;
            display: flex;
            flex-direction: column;
            padding: var(--spc-4);
            box-shadow: -4px 0 16px rgba(0,0,0,0.1);
        }
        .drawer-overlay.open .drawer-content {
            transform: translateX(0);
        }
        .drawer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spc-4);
            font-weight: 700;
            font-size: 1.125rem;
        }
        .drawer-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0 var(--spc-2);
        }
        .drawer-nav-area {
            flex: 1;
            overflow-y: auto;
        }

        /* --- KATEX / MATH OVERRIDES --- */
        /* Containment Invariant */
        .katex-display {
            display: block;
            margin: 1em 0;
            text-align: center;
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
        }
        /* ColorLab A: Block Math Underlay allowed if needed, but strict spec says 
           Stage 6.0.4 mixed prose+math uses subtle differentiation only. 
           Let's keep it transparent unless inside a specific block that has a wash.
        */
        
        /* --- TABLES --- */
        table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 1em;
            font-size: 0.9375rem;
        }
        th, td {
            border: 1px solid var(--divider-color);
            padding: 0.5rem;
            text-align: left;
        }
        th {
            font-weight: 600;
            background-color: transparent; /* No fill per 5.8.5 */
        }
        /* Mobile table scroll wrapper */
        .table-wrapper {
            overflow-x: auto;
            max-width: 100%;
            margin-bottom: 1em;
        }
        .table-wrapper table { margin-bottom: 0; }

        /* --- RESPONSIVE --- */
        @media (max-width: 768px) {
            .shell-container {
                display: block; /* Stack layout */
                padding: 0 var(--spc-2) var(--spc-8) var(--spc-2);
            }
            .nav-rail {
                display: none; /* Hide sticky rail on mobile */
            }
            .mobile-jump-trigger {
                display: inline-block;
            }
            [data-rtq="SURF__PAPER"] {
                padding: var(--spc-4) var(--spc-3);
            }
            [data-rtq="SPC__CHILD_INDENTATION"] {
                margin-left: var(--spc-2); /* Adaptive indentation */
            }
        }

        /* --- UTILITY / HELPERS --- */
        .hidden { display: none !important; }
        .flex-col { display: flex; flex-direction: column; }
        .gap-2 { gap: 0.5rem; }
        
        .paper-selector {
            padding: 0.5rem;
            font-family: var(--font-sans);
            font-size: 0.9375rem;
            border: 1px solid var(--divider-color);
            border-radius: 4px;
            color: var(--text-primary);
            background-color: var(--surf-step-2-paper);
        }

        .error-message {
            color: #ef4444;
            font-weight: 700;
            text-align: center;
            padding: 2rem;
            border: 1px dashed #ef4444;
            background-color: #fef2f2;
        }
    </style>
</head>
<body>

    <!-- Root Application Node -->
    <div id="root" data-rtq="SURF__FRAME_BASE">
        <!-- Structure injected by JS -->
    </div>

    <!-- Scripts -->
    <!-- Markdown-it (No integrity) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/13.0.1/markdown-it.min.js"></script>
    <!-- KaTeX JS (No integrity) -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <!-- KaTeX Auto-render (No integrity) -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <script>
        // =========================================
        // STAGE 0: CONSTANTS (Canonical)
        // =========================================
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // =========================================
        // SETUP & CONFIG
        // =========================================
        
        // Markdown renderer setup per Stage 6 requirements
        const md = window.markdownit ? window.markdownit({
            html: true,       // Enable inline SVG passthrough
            linkify: true,
            breaks: false     // MUST be false to prevent breaking KaTeX
        }) : null;

        if (md) {
            // Disable escape rule to preserve TeX backslashes
            md.inline.ruler.disable(['escape']);
        }

        // State management
        const state = {
            papers: [],
            activePaperKey: null,
            expandedState: {} // Map: questionId -> boolean
        };

        // =========================================
        // APP LOGIC
        // =========================================

        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Fetch failed");
                const data = await response.json();
                
                state.papers = data.papers || [];
                if (state.papers.length > 0) {
                    state.activePaperKey = state.papers[0].key;
                }
                
                renderApp();
            } catch (error) {
                console.error("Payload Error:", error);
                renderErrorState();
            }
        }

        function renderErrorState() {
            const root = document.getElementById('root');
            root.innerHTML = `
                <div class="shell-container">
                    <div class="paper-region">
                        <div class="error-message">PAPERS PAYLOAD MISSING</div>
                    </div>
                </div>
            `;
        }

        function getActivePaper() {
            return state.papers.find(p => p.key === state.activePaperKey);
        }

        // =========================================
        // RENDERING
        // =========================================

        function renderApp() {
            const root = document.getElementById('root');
            const paper = getActivePaper();

            if (!paper) {
                renderErrorState();
                return;
            }

            // --- Top Controls & Shell ---
            const topControlsHTML = `
                <div class="top-controls" data-rtq="SURF__TOP_CONTROLS">
                    <div class="shell-container top-controls-inner">
                        <div class="left-controls">
                            <!-- Paper Selector -->
                            <select id="paperSelector" class="paper-selector">
                                ${state.papers.map(p => 
                                    `<option value="${p.key}" ${p.key === state.activePaperKey ? 'selected' : ''}>
                                        ${p.label}
                                    </option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="right-controls">
                             <button id="mobileJumpTo" class="mobile-jump-trigger">Jump to</button>
                        </div>
                    </div>
                    <!-- DIV__TOP_CONTROLS_TO_FRAME_HAIRLINE -->
                    <div class="shell-container">
                         <hr class="rtq-divider" data-rtq="DIV__TOP_CONTROLS_TO_FRAME_HAIRLINE">
                    </div>
                </div>
            `;

            // --- Navigation (Desktop) ---
            const navHTML = `
                <nav class="nav-rail" data-rtq="CUE__NAV_STICKY_PERSISTENCE">
                    ${renderNavList(paper)}
                </nav>
            `;

            // --- Paper Content ---
            const contentHTML = `
                <main class="paper-region" data-rtq="SURF__PAPER">
                    ${renderPaperContent(paper)}
                </main>
            `;

            // --- Drawer (Mobile) ---
            const drawerHTML = `
                <div id="drawerOverlay" class="drawer-overlay" data-rtq="CUE__DRAWER_SCRIM">
                    <div class="drawer-content" role="dialog" aria-modal="true" data-rtq="CUE__DRAWER_FOCUS_TRAP_AND_BACKGROUND_BLOCK">
                        <div class="drawer-header" data-rtq="SEP__DRAWER_HEADER_TO_LIST">
                            <span>Jump to</span>
                            <button id="drawerClose" class="drawer-close" aria-label="Close navigation">&times;</button>
                        </div>
                        <hr class="rtq-divider" data-rtq="DIV__DRAWER_HEADER_TO_LIST_HAIRLINE">
                        <div class="drawer-nav-area">
                            ${renderNavList(paper, true)}
                        </div>
                    </div>
                </div>
            `;

            // Combine
            root.innerHTML = `
                ${topControlsHTML}
                <div class="shell-container">
                    ${navHTML}
                    <!-- SEP__NAV_TO_PAPER_COLUMN_BOUNDARY handled by grid gap -->
                    ${contentHTML}
                </div>
                ${drawerHTML}
            `;

            // --- Post-Render: Event Listeners & Math ---
            attachEventListeners();
            renderMath(root);
            
            // Set sticky observer for active nav highlight
            initScrollSpy();
        }

        function renderNavList(paper, isMobile = false) {
            let html = `<ul class="nav-list" data-rtq="CUE__NAV_FLAT_LIST_NO_INDENTATION">`;
            
            // Helper to render items recursively
            const renderItems = (questions) => {
                let s = '';
                questions.forEach(q => {
                    s += `<li class="spc-mb-1">
                            <a href="#q-${q.id}" class="nav-item js-nav-link" data-target="q-${q.id}">
                                ${q.id}
                            </a>
                          </li>`;
                    if (q.children && q.children.length > 0) {
                        s += renderItems(q.children);
                    }
                });
                return s;
            };

            if (paper.sections) {
                paper.sections.forEach((sec, idx) => {
                    if (sec.label && sec.label.trim() !== "") {
                        // Section Header
                        html += `
                            <li class="nav-section-container" data-rtq="SEP__NAV_SECTION_LABEL_TO_ITEMS">
                                <div class="nav-section-label">${sec.label}</div>
                                <hr class="rtq-divider" data-rtq="DIV__NAV_SECTION_LABEL_TO_ITEMS_HAIRLINE">
                            </li>
                        `;
                    }
                    html += renderItems(sec.questions);
                    
                    // Divider between sections
                    if (idx < paper.sections.length - 1) {
                         html += `<li data-rtq="SEP__NAV_BETWEEN_SECTIONS">
                                    <hr class="rtq-divider" data-rtq="DIV__NAV_BETWEEN_SECTIONS_HAIRLINE">
                                  </li>`;
                    }
                });
            } else if (paper.questions) {
                html += renderItems(paper.questions);
            }
            
            html += `</ul>`;
            return html;
        }

        function renderPaperContent(paper) {
            let html = '';
            
            const renderQList = (questions) => {
                return questions.map((q, idx) => {
                    const isLast = idx === questions.length - 1;
                    return renderQuestionNode(q) + 
                           (isLast ? '' : `<div data-rtq="SPC__TOP_LEVEL_INTER_QUESTION_SPACING"></div>`);
                }).join('');
            };

            if (paper.sections) {
                paper.sections.forEach((sec, idx) => {
                    // Section Wrapper
                    html += `<div class="section-block" data-rtq="SURF__SECTION_HEADER">`;
                    if (sec.label && sec.label.trim() !== "") {
                        html += `
                            <div class="section-header">${sec.label}</div>
                            <div data-rtq="SPC__SECTION_HEADER_TO_QUESTION_LIST_SPACING"></div>
                            <div class="rtq-divider" data-rtq="DIV__SECTION_HEADER_TO_QUESTION_LIST_HAIRLINE"></div>
                        `;
                    }
                    
                    html += renderQList(sec.questions);
                    
                    html += `</div>`;
                    
                    // Boundary between sections
                    if (idx < paper.sections.length - 1) {
                        html += `<div data-rtq="SEP__QUESTION_LIST_TO_NEXT_SECTION_HEADER_BOUNDARY">
                                    <div class="rtq-divider" data-rtq="DIV__QUESTION_LIST_TO_NEXT_SECTION_HEADER_HAIRLINE"></div>
                                 </div>`;
                    }
                });
            } else if (paper.questions) {
                html += renderQList(paper.questions);
            }
            return html;
        }

        function renderQuestionNode(q, depth = 0) {
            const hasChildren = q.children && q.children.length > 0;
            const qId = `q-${q.id}`;
            const sb = q.solutionBlock;
            const hasSolutionDetails = sb && sb.solutionDetails;
            
            // Check expansion state (default collapsed unless paper defaults say otherwise)
            // Note: Simplistic default logic here based on payload. No explicit defaults in v2 payload usually, assume false.
            const isExpanded = state.expandedState[qId] === true; 

            // Markdown Render
            const qText = md ? md.render(q.question || '') : q.question;
            
            // Build Node
            let html = `<div id="${qId}" class="question-node" data-rtq="SURF__QUESTION_NODE">`;
            
            // Question Body
            html += `<div class="question-body spc-mb-3">
                        <span class="typo-question-id">${q.id}</span>
                        <span class="typo-question-text">${qText}</span>
                     </div>`;

            // Solution Block
            if (sb) {
                html += `<div class="solution-block" data-rtq="SEP__QUESTION_TO_SOLUTION_BOUNDARY">`;
                html += `<div class="rtq-divider" data-rtq="DIV__QUESTION_TO_SOLUTION_DIVIDER"></div>`;
                
                // Answer
                if (sb.answer) {
                    const ansText = md ? md.render(sb.answer) : sb.answer;
                    html += `<div class="answer-region spc-mb-3" data-rtq="SURF__ANSWER">
                                <div class="typo-answer-label">Answer</div>
                                <div data-rtq="SPC__ANSWER_LABEL_TO_CONTENT_SPACING" style="height:4px"></div>
                                <div class="typo-answer-content">${ansText}</div>
                             </div>`;
                }

                // Solution Details
                if (hasSolutionDetails) {
                    // Divider Answer -> Details
                    if (sb.answer) {
                        html += `<div data-rtq="SEP__ANSWER_TO_SOLUTION_DETAILS">
                                    <div class="rtq-divider" data-rtq="DIV__ANSWER_TO_SOLUTION_DETAILS_DIVIDER"></div>
                                 </div>`;
                    }

                    // Toggle
                    html += `<button class="typo-disclosure js-toggle" data-qid="${qId}" aria-expanded="${isExpanded}">
                                ${isExpanded ? 'Hide working' : 'Show working'}
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" style="transform: ${isExpanded ? 'rotate(180deg)' : 'rotate(0deg)'}">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                             </button>`;

                    // Expanded Content
                    if (isExpanded) {
                        const sd = sb.solutionDetails;
                        html += `<div class="solution-details mt-4" data-rtq="SURF__SOLUTION_DETAILS_WASH">`;
                        
                        // Keep in mind
                        if (sd.keepInMind) {
                            const kmText = md ? md.render(sd.keepInMind) : sd.keepInMind;
                            html += `<div class="sd-subsection spc-mb-3" data-rtq="SURF__SD_KEEP_IN_MIND">
                                        <div class="typo-sd-label">Keep in mind</div>
                                        <div class="sd-body">${kmText}</div>
                                     </div>`;
                            // Divider
                            if (sd.formulasUsed || sd.working) {
                                html += `<div class="rtq-divider" data-rtq="DIV__SD_KEEP_IN_MIND_TO_FORMULAS_DIVIDER"></div>`;
                            }
                        }

                        // Formulas used
                        if (sd.formulasUsed) {
                            const fuText = md ? md.render(sd.formulasUsed) : sd.formulasUsed;
                            html += `<div class="sd-subsection spc-mb-3" data-rtq="SURF__SD_FORMULAS_USED">
                                        <div class="typo-sd-label">Formulas used</div>
                                        <div class="sd-body">${fuText}</div>
                                     </div>`;
                             // Divider
                            if (sd.working) {
                                html += `<div class="rtq-divider" data-rtq="DIV__SD_FORMULAS_TO_WORKING_DIVIDER"></div>`;
                            }
                        }

                        // Working
                        if (sd.working) {
                             const wkText = md ? md.render(sd.working) : sd.working;
                             html += `<div class="sd-subsection spc-mb-4">
                                        <div class="typo-sd-label">Working</div>
                                        <div class="sd-body">${wkText}</div>
                                     </div>`;
                        }

                        // Alternative Working
                        if (sd.alternativeWorking && Array.isArray(sd.alternativeWorking)) {
                            sd.alternativeWorking.forEach((aw) => {
                                const awText = md ? md.render(aw) : aw;
                                html += `<div class="rtq-divider" data-rtq="DIV__SD_WORKING_TO_ALTERNATIVE_DIVIDER"></div>`;
                                html += `<div class="sd-subsection spc-mb-3">
                                            <div class="typo-sd-label">Alternative working</div>
                                            <div class="sd-body">${awText}</div>
                                         </div>`;
                            });
                        }

                        html += `</div>`; // End Wash
                    }
                }
                
                html += `</div>`; // End Solution Block
            }

            // Children
            if (hasChildren) {
                html += `<div class="children-container" data-rtq="SEP__PARENT_TO_CHILDREN_VERTICAL">
                            <div data-rtq="SPC__PARENT_TO_CHILDREN_VERTICAL_SPACING"></div>
                            <div data-rtq="SPC__CHILD_INDENTATION">
                                ${q.children.map(child => renderQuestionNode(child, depth + 1)).join('<div class="spc-mb-3"></div>')}
                            </div>
                         </div>`;
            }

            html += `</div>`; // End Question Node
            return html;
        }

        function renderMath(container) {
            if (window.renderMathInElement) {
                window.renderMathInElement(container, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false}
                    ],
                    throwOnError: false,
                    // Security note: We trust the payload per instructions
                });
            }
        }

        // =========================================
        // INTERACTIONS
        // =========================================

        function attachEventListeners() {
            // Paper Selector
            const selector = document.getElementById('paperSelector');
            if (selector) {
                selector.addEventListener('change', (e) => {
                    state.activePaperKey = e.target.value;
                    state.expandedState = {}; // Reset expansions
                    renderApp();
                    window.scrollTo(0,0);
                });
            }

            // Toggle Working
            document.querySelectorAll('.js-toggle').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const qId = e.currentTarget.dataset.qid;
                    state.expandedState[qId] = !state.expandedState[qId];
                    // Re-render whole app to maintain simple state logic (prototype style)
                    // In prod we'd diff or just replace the node, but this is a stress-test harness.
                    // To prevent scroll jumping, we need to be careful. 
                    // Simple re-render works but scroll pos might reset if we don't save it.
                    // For a prototype, let's just re-render and try to preserve scroll of the clicked element.
                    
                    const scrollY = window.scrollY;
                    renderApp();
                    
                    // Restore focus/scroll if needed, though pure re-render usually needs layout stability.
                    // A better prototype approach for toggles is inline manipulation, but we built a declarative renderer.
                    // Let's settle for restore scroll position:
                    window.scrollTo(0, scrollY);
                });
            });

            // Mobile Drawer Logic
            const drawerBtn = document.getElementById('mobileJumpTo');
            const drawerOverlay = document.getElementById('drawerOverlay');
            const drawerClose = document.getElementById('drawerClose');
            const navLinks = document.querySelectorAll('.js-nav-link');

            if (drawerBtn && drawerOverlay) {
                const toggleDrawer = (open) => {
                    if (open) {
                        drawerOverlay.classList.add('open');
                        drawerClose.focus();
                        document.body.style.overflow = 'hidden'; // Lock body scroll
                    } else {
                        drawerOverlay.classList.remove('open');
                        drawerBtn.focus();
                        document.body.style.overflow = '';
                    }
                };

                drawerBtn.addEventListener('click', () => toggleDrawer(true));
                drawerClose.addEventListener('click', () => toggleDrawer(false));
                
                // Close on link click
                navLinks.forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const targetId = e.currentTarget.dataset.target;
                        const targetEl = document.getElementById(targetId);
                        if (targetEl) {
                            toggleDrawer(false);
                            // Smooth scroll
                            targetEl.scrollIntoView({ behavior: 'smooth' });
                        }
                    });
                });

                // Close on overlay click
                drawerOverlay.addEventListener('click', (e) => {
                    if (e.target === drawerOverlay) toggleDrawer(false);
                });
            }
            
            // Desktop Nav Links
            if (!drawerBtn || getComputedStyle(drawerBtn).display === 'none') {
                 document.querySelectorAll('.nav-rail .js-nav-link').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const targetId = e.currentTarget.dataset.target;
                        const targetEl = document.getElementById(targetId);
                        if (targetEl) targetEl.scrollIntoView({ behavior: 'smooth' });
                    });
                 });
            }
        }

        function initScrollSpy() {
            const navItems = document.querySelectorAll('.nav-rail .nav-item');
            const observerOptions = {
                root: null,
                rootMargin: '-20% 0px -70% 0px', // Active region in viewport
                threshold: 0
            };

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        // Activate nav item
                        navItems.forEach(item => item.classList.remove('active'));
                        const id = entry.target.id;
                        const navLink = document.querySelector(`.nav-rail .nav-item[data-target="${id}"]`);
                        if (navLink) navLink.classList.add('active');
                    }
                });
            }, observerOptions);

            document.querySelectorAll('.question-node').forEach(node => observer.observe(node));
        }

        // Run
        init();

    </script>
</body>
</html>
