<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"A","indexWithinVariant":"37","totalWithinVariant":"50","hueFamily":"","intensityMode":"","timestamp":"2026-01-06T19:00:25.089Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;A&quot;,&quot;indexWithinVariant&quot;:&quot;37&quot;,&quot;totalWithinVariant&quot;:&quot;50&quot;,&quot;hueFamily&quot;:&quot;&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-06T19:00:25.089Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>
    
    <!-- Fonts: Inter for modern, calm sans-serif -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- KaTeX CSS (No SRI) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <!-- Tailwind CSS (via CDN for prototype) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Tailwind Configuration (ColorLab A: Light Mode Palette Freedom) -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        // Custom palette: "Academic Fresh" - Calm, Slate-based, Indigo accents
                        // Light mode only per instructions.
                        gray: {
                            50: '#F8FAFC',
                            100: '#F1F5F9',
                            200: '#E2E8F0',  // Hairlines
                            300: '#CBD5E1',
                            400: '#94A3B8',
                            500: '#64748B',  // Muted text
                            600: '#475569',
                            700: '#334155',
                            800: '#1E293B',
                            900: '#0F172A',  // Primary text
                        },
                        accent: {
                            50: '#EEF2FF',
                            100: '#E0E7FF',
                            500: '#6366F1',
                            600: '#4F46E5', // Primary Accent (Focus, Active Nav)
                            700: '#4338CA',
                        }
                    }
                }
            }
        }
    </script>

    <!-- CSS Overrides & Invariants -->
    <style>
        /* Base settings */
        body {
            /* Light mode only enforcement */
            background-color: #F8FAFC; 
            color: #0F172A;
            -webkit-font-smoothing: antialiased;
        }

        /* Scrollbar hiding for Navigation (while keeping functionality) */
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* KaTeX Containment Invariant (Locked) */
        /* Never allow horizontal scroll on the page. */
        /* Horizontal scroll only allowed within math blocks. */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding-bottom: 2px; /* Prevent scrollbar clipping descenders */
            -webkit-overflow-scrolling: touch;
        }
        
        /* Inline KaTeX background invariant */
        .katex {
            background-color: transparent !important;
        }

        /* Focus Visibility (Accessibility) */
        *:focus-visible {
            outline: 2px solid #4F46E5; /* Accent 600 */
            outline-offset: 2px;
            border-radius: 2px;
        }
        
        /* Utility: Hide content visually but keep accessible */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        /* Layout Tweaks */
        /* Table styles for Markdown tables */
        .markdown-content table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.95em;
        }
        .markdown-content th, .markdown-content td {
            border: 1px solid #E2E8F0;
            padding: 0.5rem;
            text-align: left;
        }
        .markdown-content th {
            font-weight: 600;
            background-color: #F8FAFC;
        }

        /* Markdown List Styles */
        .markdown-content ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 0.5em; }
        .markdown-content ol { list-style-type: decimal; padding-left: 1.5em; margin-bottom: 0.5em; }
        .markdown-content p { margin-bottom: 0.5em; line-height: 1.6; }
        .markdown-content p:last-child { margin-bottom: 0; }

        /* Animation constraints */
        .expand-transition {
            transition-property: max-height, opacity, transform;
            transition-duration: 200ms;
            transition-timing-function: cubic-bezier(0.25, 0.1, 0.25, 1.0);
        }
    </style>

    <!-- Libraries (No Integrity/SRI per instruction) -->
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Markdown-it -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>
    <!-- KaTeX JS -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

</head>
<body class="bg-gray-50 text-gray-900">

    <!-- App Shell -->
    <div id="app-shell" class="min-h-screen flex flex-col items-center">
        
        <!-- Top Controls Area (Frame Aligned) -->
        <div class="w-full max-w-7xl px-4 md:px-8 pt-4 pb-2 flex items-center justify-between z-20 bg-gray-50">
            <!-- Paper Selector -->
            <div class="flex items-center gap-3">
                <label for="paper-select" class="text-sm font-medium text-gray-500">Paper</label>
                <select id="paper-select" class="bg-white border border-gray-300 text-gray-900 text-sm rounded-md focus:ring-accent-600 focus:border-accent-600 block px-3 py-1.5 shadow-sm">
                    <option value="" disabled selected>Loading...</option>
                </select>
            </div>

            <!-- Mobile Jump To Trigger -->
            <button id="mobile-jump-trigger" class="md:hidden flex items-center gap-2 text-accent-600 font-medium text-sm hover:text-accent-700 transition-colors">
                <span class="sr-only">Open navigation</span>
                <span>Jump to</span>
                <i data-lucide="list" class="w-4 h-4"></i>
            </button>
        </div>

        <!-- DocumentFrameShell -->
        <div class="w-full max-w-7xl px-4 md:px-8 flex-1 flex flex-row gap-0 md:gap-8 relative">
            
            <!-- Desktop Navigation Rail (Left Column - Sticky) -->
            <aside class="hidden md:block w-48 lg:w-56 shrink-0 pt-4 pb-12 sticky top-4 h-[calc(100vh-2rem)] overflow-y-auto no-scrollbar" aria-label="Paper Navigation">
                <nav id="desktop-nav-list" class="flex flex-col gap-1 text-sm">
                    <!-- Nav items injected here -->
                </nav>
            </aside>

            <!-- Paper Content Column (Right Column - Primary) -->
            <main id="paper-content-region" class="flex-1 pt-4 pb-32 min-w-0">
                <!-- Status / Content injected here -->
                <div id="content-status" class="text-gray-500 italic mt-8 text-center">Initializing...</div>
            </main>

        </div>

    </div>

    <!-- Mobile Navigation Drawer -->
    <div id="mobile-drawer-backdrop" class="fixed inset-0 bg-gray-900/20 backdrop-blur-sm z-40 hidden transition-opacity opacity-0" aria-hidden="true"></div>
    <div id="mobile-drawer" class="fixed inset-y-0 right-0 w-64 bg-white shadow-2xl transform translate-x-full transition-transform duration-300 ease-out z-50 flex flex-col" aria-modal="true" role="dialog">
        <div class="flex items-center justify-between p-4 border-b border-gray-100">
            <h2 class="text-sm font-semibold text-gray-900">Jump to</h2>
            <button id="close-drawer-btn" class="text-gray-500 hover:text-gray-700 p-1">
                <span class="sr-only">Close navigation</span>
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>
        <div class="flex-1 overflow-y-auto p-4">
            <nav id="mobile-nav-list" class="flex flex-col gap-1 text-sm">
                <!-- Mobile Nav Items injected here -->
            </nav>
        </div>
    </div>

    <!-- Runtime Scripts -->
    <script>
        // --- STAGE 0: CONSTANTS ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json"; // Included for completeness per spec

        // --- MARKDOWN CONFIGURATION (Authoritative) ---
        const md = window.markdownit ? window.markdownit({
            html: true,       // Allow inline SVG/HTML
            linkify: true,
            breaks: false     // MUST be false to prevent <br> in math
        }) : null;

        if (md) {
            // Disable escaping of TeX backslashes
            md.inline.ruler.disable(['escape']);
        }

        // --- STATE & DOM ELEMENTS ---
        const dom = {
            paperSelect: document.getElementById('paper-select'),
            contentRegion: document.getElementById('paper-content-region'),
            desktopNavList: document.getElementById('desktop-nav-list'),
            mobileNavList: document.getElementById('mobile-nav-list'),
            mobileJumpTrigger: document.getElementById('mobile-jump-trigger'),
            mobileDrawer: document.getElementById('mobile-drawer'),
            mobileDrawerBackdrop: document.getElementById('mobile-drawer-backdrop'),
            closeDrawerBtn: document.getElementById('close-drawer-btn'),
            status: document.getElementById('content-status')
        };

        let payloadData = null;
        let activePaperKey = null;
        let expandedStates = new Map(); // Key: questionId, Value: boolean

        // --- INITIALIZATION ---
        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error('Network response was not ok');
                payloadData = await response.json();
                
                if (!payloadData || !payloadData.papers) throw new Error('Invalid payload');

                renderPaperSelector();
                
                // Select first paper by default
                if (payloadData.papers.length > 0) {
                    selectPaper(payloadData.papers[0].key);
                }

            } catch (error) {
                console.error("Payload loading failed:", error);
                renderErrorState();
            }
        }

        // --- RENDERING CORE ---

        function renderErrorState() {
            dom.contentRegion.innerHTML = `
                <div class="text-center py-20">
                    <h1 class="text-xl font-semibold text-gray-900">PAPERS PAYLOAD MISSING</h1>
                    <p class="text-gray-500 mt-2">Unable to load content from ${RTQ_PAPERS_PAYLOAD_PATH}</p>
                </div>
            `;
            dom.paperSelect.innerHTML = '<option disabled selected>Error</option>';
            dom.paperSelect.disabled = true;
        }

        function renderPaperSelector() {
            dom.paperSelect.innerHTML = '';
            payloadData.papers.forEach(paper => {
                const option = document.createElement('option');
                option.value = paper.key;
                option.textContent = paper.label;
                dom.paperSelect.appendChild(option);
            });
            dom.paperSelect.disabled = false;
        }

        function selectPaper(paperKey) {
            activePaperKey = paperKey;
            dom.paperSelect.value = paperKey;
            
            const paper = payloadData.papers.find(p => p.key === paperKey);
            if (!paper) return;

            // Reset Expanded States based on paper defaults
            // Default is expanded unless explicit expandedAll: false
            const defaultExpanded = paper.defaults?.expandedAll !== false;
            // We don't need to prepopulate the map; logic will fallback to defaultExpanded if key missing

            // Render Content
            dom.contentRegion.innerHTML = ''; // Clear
            
            // Handle Sectioned vs Flat
            let questionNodesForNav = [];
            
            if (paper.sections) {
                paper.sections.forEach(section => {
                    // Render Section Header if label exists
                    if (section.label && section.label.trim().length > 0) {
                        const sectionHeader = document.createElement('div');
                        sectionHeader.className = "mb-6 mt-12 pb-2 border-b border-gray-200";
                        sectionHeader.innerHTML = `<span class="text-lg font-semibold text-gray-900">${escapeHtml(section.label)}</span>`;
                        dom.contentRegion.appendChild(sectionHeader);
                    }
                    
                    // Render Questions
                    if (section.questions) {
                        const listContainer = document.createElement('div');
                        listContainer.className = "flex flex-col gap-12"; // Top level spacing
                        section.questions.forEach(q => {
                            listContainer.appendChild(renderQuestionNode(q, 0, defaultExpanded));
                            collectNavItems(q, questionNodesForNav, section.label);
                        });
                        dom.contentRegion.appendChild(listContainer);
                    }
                });
            } else if (paper.questions) {
                const listContainer = document.createElement('div');
                listContainer.className = "flex flex-col gap-12"; // Top level spacing
                paper.questions.forEach(q => {
                    listContainer.appendChild(renderQuestionNode(q, 0, defaultExpanded));
                    collectNavItems(q, questionNodesForNav, null);
                });
                dom.contentRegion.appendChild(listContainer);
            }

            // Render Navigation
            renderNavigation(paper, questionNodesForNav);

            // Trigger KaTeX
            renderMathInElement(dom.contentRegion, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false}
                ],
                throwOnError: false
            });

            // Re-init Icons
            lucide.createIcons();

            // Reset Scroll
            window.scrollTo(0,0);
        }

        // --- QUESTION NODE RENDERING (RECURSIVE) ---

        function renderQuestionNode(node, depth, defaultExpanded) {
            const wrapper = document.createElement('div');
            wrapper.className = "flex flex-col w-full";
            wrapper.id = `q-${node.id}`; // Anchor

            // 1. Question Body
            const qBody = document.createElement('div');
            qBody.className = "flex flex-col gap-2 mb-4"; // Spacing between Q and Solution Block
            
            // Identifier
            const qId = document.createElement('span');
            qId.className = "text-sm font-semibold text-gray-500";
            qId.textContent = node.id;
            
            // Prompt
            const qPrompt = document.createElement('div');
            qPrompt.className = "text-base md:text-lg text-gray-900 leading-relaxed markdown-content font-medium";
            qPrompt.innerHTML = renderMarkdown(node.question);

            qBody.appendChild(qId);
            qBody.appendChild(qPrompt);
            wrapper.appendChild(qBody);

            // 2. Solution Block (Optional)
            if (node.solutionBlock) {
                const sb = node.solutionBlock;
                const hasAnswer = !!sb.answer;
                const hasDetails = !!sb.solutionDetails;

                // Container for Solution Block
                const solBlock = document.createElement('div');
                solBlock.className = "pl-0 md:pl-0 flex flex-col gap-4"; // No indent, just vertical flow

                // Answer (Optional, Visible by Default)
                if (hasAnswer) {
                    const ansRow = document.createElement('div');
                    ansRow.className = "flex flex-col sm:flex-row sm:items-baseline gap-2 text-gray-800";
                    
                    const ansLabel = document.createElement('span');
                    ansLabel.className = "text-sm font-bold text-gray-700 uppercase tracking-wide shrink-0 select-none";
                    ansLabel.textContent = "Answer";
                    
                    const ansContent = document.createElement('div');
                    ansContent.className = "markdown-content text-base font-medium";
                    ansContent.innerHTML = renderMarkdown(sb.answer);

                    ansRow.appendChild(ansLabel);
                    ansRow.appendChild(ansContent);
                    solBlock.appendChild(ansRow);
                }

                // Solution Details (Optional, Expandable)
                if (hasDetails) {
                    const details = sb.solutionDetails;
                    
                    // Determine State
                    // Check map first, fallback to default
                    let isExpanded = expandedStates.has(node.id) 
                        ? expandedStates.get(node.id) 
                        : defaultExpanded;

                    // Toggle Control
                    const toggleBtn = document.createElement('button');
                    toggleBtn.className = "group flex items-center gap-2 text-sm text-accent-600 font-medium hover:text-accent-700 focus:outline-none focus-visible:ring-2 focus-visible:ring-accent-500 rounded-sm w-max transition-colors";
                    toggleBtn.setAttribute('aria-expanded', isExpanded);
                    toggleBtn.setAttribute('aria-controls', `details-${node.id}`);
                    
                    const btnText = document.createElement('span');
                    btnText.textContent = isExpanded ? "Hide working" : "Show working";
                    
                    const btnIcon = document.createElement('i');
                    btnIcon.setAttribute('data-lucide', isExpanded ? 'chevron-up' : 'chevron-down');
                    btnIcon.className = "w-4 h-4 transition-transform duration-200";
                    
                    toggleBtn.appendChild(btnText);
                    toggleBtn.appendChild(btnIcon);
                    
                    // Details Region
                    const detailsRegion = document.createElement('div');
                    detailsRegion.id = `details-${node.id}`;
                    detailsRegion.className = `mt-2 overflow-hidden ${isExpanded ? '' : 'hidden'}`;
                    
                    // Inner content wrapper
                    const detailsInner = document.createElement('div');
                    // Stage 3 permitted: solution details surface wash/demarcation
                    // Per Stage 5: quiet, subtle. No card.
                    // Implementation: Minimal left border + slight padding to demarcate region, clean white bg.
                    detailsInner.className = "flex flex-col gap-6 py-2 pl-4 border-l-2 border-gray-100"; 

                    // Keep in Mind
                    if (details.keepInMind) {
                        const block = createDetailsBlock("Keep in mind", details.keepInMind, "text-gray-600", "list-disc pl-4", "lightbulb");
                        detailsInner.appendChild(block);
                    }

                    // Formulas Used
                    if (details.formulasUsed) {
                        const block = createDetailsBlock("Formulas used", details.formulasUsed, "text-gray-500", "font-mono text-sm");
                        detailsInner.appendChild(block);
                    }

                    // Working (Primary)
                    if (details.working) {
                        const block = createDetailsBlock("Working", details.working, "text-gray-700");
                        detailsInner.appendChild(block);
                    }

                    // Alternative Working
                    if (details.alternativeWorking && Array.isArray(details.alternativeWorking)) {
                        details.alternativeWorking.forEach((alt, idx) => {
                             // "Alternative working" demarcation
                             // Using Stage 3 permitted internal separator (spacing + hairline if needed)
                             if (idx === 0 || details.working) {
                                 const sep = document.createElement('hr');
                                 sep.className = "border-gray-200 my-2";
                                 detailsInner.appendChild(sep);
                             }
                             const block = createDetailsBlock("Alternative working", alt, "text-gray-700");
                             detailsInner.appendChild(block);
                        });
                    }

                    detailsRegion.appendChild(detailsInner);

                    // Toggle Logic
                    toggleBtn.onclick = () => {
                        const newState = !expandedStates.get(node.id); // Get current valid state from map or assume sync
                        // Update Source of Truth
                        expandedStates.set(node.id, !isExpanded);
                        isExpanded = !isExpanded;
                        
                        // Update UI
                        btnText.textContent = isExpanded ? "Hide working" : "Show working";
                        btnIcon.setAttribute('data-lucide', isExpanded ? 'chevron-up' : 'chevron-down');
                        lucide.createIcons();
                        
                        if (isExpanded) {
                            detailsRegion.classList.remove('hidden');
                        } else {
                            detailsRegion.classList.add('hidden');
                        }
                        toggleBtn.setAttribute('aria-expanded', isExpanded);
                    };

                    solBlock.appendChild(toggleBtn);
                    solBlock.appendChild(detailsRegion);
                    
                    // Sync initial map state if not set
                    if (!expandedStates.has(node.id)) {
                        expandedStates.set(node.id, defaultExpanded);
                    }
                }

                wrapper.appendChild(solBlock);
            }

            // 3. Children (Recursive)
            if (node.children && node.children.length > 0) {
                const childrenContainer = document.createElement('div');
                // Stage 3: Indentation (spacing only)
                // Adaptive indentation: pl-4 on mobile, pl-8 on desktop to save space
                childrenContainer.className = "mt-6 flex flex-col gap-6 pl-4 md:pl-8 border-l border-transparent"; 
                
                node.children.forEach(child => {
                    childrenContainer.appendChild(renderQuestionNode(child, depth + 1, defaultExpanded));
                });
                wrapper.appendChild(childrenContainer);
            }

            return wrapper;
        }

        function createDetailsBlock(labelStr, contentMarkdown, textColorClass, extraBodyClass = "", iconName = null) {
            const container = document.createElement('div');
            
            const labelRow = document.createElement('div');
            labelRow.className = "flex items-center gap-2 mb-1";
            
            if (iconName) {
                const icon = document.createElement('i');
                icon.setAttribute('data-lucide', iconName);
                icon.className = "w-4 h-4 text-gray-400";
                labelRow.appendChild(icon);
            }
            
            const label = document.createElement('h4');
            label.className = "text-xs font-bold text-gray-500 uppercase tracking-wider";
            label.textContent = labelStr;
            labelRow.appendChild(label);
            
            const body = document.createElement('div');
            body.className = `markdown-content text-sm md:text-base leading-relaxed ${textColorClass} ${extraBodyClass}`;
            body.innerHTML = renderMarkdown(contentMarkdown);

            container.appendChild(labelRow);
            container.appendChild(body);
            return container;
        }

        // --- MARKDOWN HELPER ---
        function renderMarkdown(text) {
            if (!text) return '';
            if (!md) return text; // Fallback to plain text
            return md.render(text);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // --- NAVIGATION LOGIC ---

        function collectNavItems(node, list, currentSectionLabel) {
            // Flatten hierarchy for nav list
            // We store depth to apply typographic scale
            
            // Calculate depth from children, but since we are traversing down,
            // we need to know the depth relative to root.
            // Simplified: we'll trust the traversal order.
            
            // Heuristic for depth: Id length or structure? No, strictly hierarchy in recursion.
            // But here we are linearizing.
            // Let's pass depth in recursion.
            
            function recurse(n, d) {
                list.push({
                    id: n.id,
                    depth: d,
                    section: currentSectionLabel // undefined if none
                });
                if (n.children) {
                    n.children.forEach(c => recurse(c, d + 1));
                }
            }
            recurse(node, 0);
        }

        function renderNavigation(paper, navItems) {
            const desktopList = dom.desktopNavList;
            const mobileList = dom.mobileNavList;
            
            desktopList.innerHTML = '';
            mobileList.innerHTML = '';

            let lastSection = null;

            navItems.forEach((item, index) => {
                // Section Handling
                if (paper.sections && item.section !== lastSection) {
                    // Render Section Label
                    if (item.section) {
                        const secLabel = document.createElement('div');
                        secLabel.className = "mt-4 mb-2 text-xs font-bold text-gray-400 uppercase tracking-widest pl-2";
                        secLabel.textContent = item.section;
                        
                        desktopList.appendChild(secLabel.cloneNode(true));
                        mobileList.appendChild(secLabel.cloneNode(true));
                    }
                    lastSection = item.section;
                }

                // Nav Item
                const btn = document.createElement('a');
                btn.href = `#q-${item.id}`;
                // Hierarchy via type scale/opacity per instructions
                // Depth 0: Standard
                // Depth 1+: Quieter/Smaller
                const isTopLevel = item.depth === 0;
                
                // Base classes
                let classes = "block py-1 px-2 rounded hover:bg-gray-100 transition-colors text-left border-l-2 border-transparent ";
                
                if (isTopLevel) {
                    classes += "text-gray-600 font-medium text-sm";
                } else {
                    classes += "text-gray-500 font-normal text-xs"; // Quieter sub-questions
                }

                btn.className = classes;
                btn.textContent = item.id;
                
                // Interaction: Smooth Scroll
                btn.onclick = (e) => {
                    e.preventDefault();
                    document.getElementById(`q-${item.id}`)?.scrollIntoView({behavior: 'smooth', block: 'start'});
                    closeMobileDrawer();
                    updateActiveNav(item.id);
                };
                
                btn.dataset.targetId = item.id;

                desktopList.appendChild(btn);
                mobileList.appendChild(btn.cloneNode(true)); // Clone for mobile
            });

            // Re-attach listeners for cloned mobile elements
            Array.from(mobileList.children).forEach(el => {
                if (el.tagName === 'A') {
                    el.onclick = (e) => {
                        e.preventDefault();
                        const targetId = el.dataset.targetId;
                        document.getElementById(`q-${targetId}`)?.scrollIntoView({behavior: 'smooth', block: 'start'});
                        closeMobileDrawer();
                        updateActiveNav(targetId);
                    };
                }
            });
            
            // Setup Intersection Observer for Active State
            setupScrollSpy(navItems);
        }

        function updateActiveNav(activeId) {
            // Reset all
            const allLinks = document.querySelectorAll('nav a');
            allLinks.forEach(link => {
                link.classList.remove('text-accent-600', 'font-bold', 'bg-accent-50', 'border-accent-600');
                // Restore defaults
                if (link.classList.contains('text-xs')) {
                    link.classList.add('text-gray-500');
                } else {
                    link.classList.add('text-gray-600');
                }
            });

            // Set active
            const activeLinks = document.querySelectorAll(`nav a[href="#q-${activeId}"]`);
            activeLinks.forEach(link => {
                link.classList.remove('text-gray-500', 'text-gray-600');
                link.classList.add('text-accent-600', 'font-bold', 'bg-accent-50', 'border-accent-600');
            });
        }

        function setupScrollSpy(navItems) {
            const observerOptions = {
                root: null,
                rootMargin: '-10% 0px -80% 0px', // Active when near top
                threshold: 0
            };

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const id = entry.target.id.replace('q-', '');
                        updateActiveNav(id);
                    }
                });
            }, observerOptions);

            navItems.forEach(item => {
                const el = document.getElementById(`q-${item.id}`);
                if (el) observer.observe(el);
            });
        }

        // --- MOBILE DRAWER ---
        function openMobileDrawer() {
            dom.mobileDrawerBackdrop.classList.remove('hidden');
            // Small delay to allow display:block to apply before opacity transition
            requestAnimationFrame(() => {
                dom.mobileDrawerBackdrop.classList.remove('opacity-0');
                dom.mobileDrawer.classList.remove('translate-x-full');
            });
            document.body.style.overflow = 'hidden'; // Lock body scroll
        }

        function closeMobileDrawer() {
            dom.mobileDrawer.classList.add('translate-x-full');
            dom.mobileDrawerBackdrop.classList.add('opacity-0');
            
            setTimeout(() => {
                dom.mobileDrawerBackdrop.classList.add('hidden');
                document.body.style.overflow = '';
            }, 300);
        }

        // --- EVENT LISTENERS ---
        dom.paperSelect.addEventListener('change', (e) => selectPaper(e.target.value));
        dom.mobileJumpTrigger.addEventListener('click', openMobileDrawer);
        dom.closeDrawerBtn.addEventListener('click', closeMobileDrawer);
        dom.mobileDrawerBackdrop.addEventListener('click', closeMobileDrawer);

        // Escape to close drawer
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeMobileDrawer();
        });

        // Initialize App
        init();

    </script>
</body>
</html>
