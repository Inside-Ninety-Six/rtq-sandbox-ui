<!DOCTYPE html>
<html lang="en" class="light">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AB","indexWithinVariant":"127","totalWithinVariant":"200","hueFamily":"teal","intensityMode":"","timestamp":"2026-01-07T06:04:40.987Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AB&quot;,&quot;indexWithinVariant&quot;:&quot;127&quot;,&quot;totalWithinVariant&quot;:&quot;200&quot;,&quot;hueFamily&quot;:&quot;teal&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-07T06:04:40.987Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Viewer</title>

    <!-- 1. Libraries (CDNs) -->
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Markdown-it -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/13.0.1/markdown-it.min.js"></script>
    
    <!-- KaTeX CSS & JS (No SRI/Integrity per Stage 6.0.7b) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- 2. Configuration & Styles -->
    <script>
        tailwind.config = {
            darkMode: 'class', // Forced Light Mode per Add-on
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    colors: {
                        // Forced Hue: TEAL (ColorLab B)
                        // Base neutrals: Slate
                        border: "hsl(var(--border))",
                        input: "hsl(var(--input))",
                        ring: "hsl(var(--ring))",
                        background: "hsl(var(--background))",
                        foreground: "hsl(var(--foreground))",
                        primary: {
                            DEFAULT: "hsl(var(--primary))",
                            foreground: "hsl(var(--primary-foreground))",
                        },
                        secondary: {
                            DEFAULT: "hsl(var(--secondary))",
                            foreground: "hsl(var(--secondary-foreground))",
                        },
                        muted: {
                            DEFAULT: "hsl(var(--muted))",
                            foreground: "hsl(var(--muted-foreground))",
                        },
                        accent: {
                            DEFAULT: "hsl(var(--accent))",
                            foreground: "hsl(var(--accent-foreground))",
                        },
                    }
                }
            }
        }
    </script>

    <style type="text/tailwindcss">
        @layer base {
            :root {
                /* Light Mode Only - Teal Theme */
                --background: 0 0% 100%;       /* white */
                --foreground: 200 50% 10%;     /* slate-950 */
                
                --primary: 173 80% 40%;        /* teal-600 */
                --primary-foreground: 0 0% 100%;

                --secondary: 200 20% 96%;      /* slate-100 */
                --secondary-foreground: 200 50% 10%;

                --muted: 200 20% 96%;          /* slate-100 */
                --muted-foreground: 200 10% 40%; /* slate-500 */

                --accent: 173 50% 96%;         /* teal-50 */
                --accent-foreground: 173 80% 30%; /* teal-800 */

                --border: 200 20% 90%;         /* slate-200 */
                --input: 200 20% 90%;
                --ring: 173 80% 40%;           /* teal-600 */

                --radius: 0.375rem;
            }

            body {
                @apply bg-background text-foreground antialiased font-sans selection:bg-teal-100 selection:text-teal-900;
            }
        }

        @layer utilities {
            /* Hide scrollbars for nav */
            .no-scrollbar::-webkit-scrollbar {
                display: none;
            }
            .no-scrollbar {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
        }

        /* KaTeX Containment Invariant (Stage 6.0.8) */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding-bottom: 4px; /* Space for scrollbar if needed */
            -webkit-overflow-scrolling: touch;
        }
        
        /* Markdown Table Minimal Styling */
        .md-content table {
            @apply w-full border-collapse my-4 text-sm text-slate-700;
        }
        .md-content th {
            @apply border-b border-slate-200 pb-2 text-left font-medium text-slate-900;
        }
        .md-content td {
            @apply border-b border-slate-100 py-2 align-top;
        }

        /* Focus States (Stage 5.5.2) */
        :focus-visible {
            @apply outline-none ring-2 ring-primary ring-offset-2;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Top Controls (Fixed/Sticky context) -->
    <header class="sticky top-0 z-40 w-full bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60 border-b border-slate-100">
        <div class="max-w-[1400px] mx-auto flex items-center h-14 px-4 lg:px-8">
            
            <!-- Mobile Menu Trigger -->
            <button id="mobile-menu-trigger" class="mr-4 lg:hidden p-2 -ml-2 text-slate-500 hover:text-primary transition-colors rounded-md" aria-label="Jump to question">
                <i data-lucide="menu" class="w-5 h-5"></i>
            </button>

            <!-- Paper Selector -->
            <div class="flex items-center gap-3">
                <span class="text-sm font-medium text-slate-500 hidden sm:inline-block">Paper:</span>
                <div class="relative">
                    <select id="paper-selector" class="h-9 w-[200px] rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50">
                        <option>Loading...</option>
                    </select>
                </div>
            </div>

            <!-- Jump To Label (Mobile context) -->
            <div class="ml-auto lg:hidden text-sm font-medium text-primary cursor-pointer" onclick="document.getElementById('mobile-menu-trigger').click()">
                Jump to
            </div>
        </div>
    </header>

    <!-- Main Shell: DocumentFrameShell -->
    <div class="flex-1 max-w-[1400px] mx-auto w-full flex items-start">
        
        <!-- Desktop Navigation Rail -->
        <aside class="hidden lg:block w-64 shrink-0 sticky top-14 h-[calc(100vh-3.5rem)] pt-8 pb-8 pr-6 overflow-y-auto no-scrollbar border-r border-transparent">
            <nav id="desktop-nav" class="flex flex-col space-y-1" aria-label="Paper navigation">
                <!-- Nav items generated here -->
            </nav>
        </aside>

        <!-- Paper Content Column -->
        <main id="paper-region" class="flex-1 min-w-0 py-8 px-4 lg:px-12 max-w-4xl mx-auto w-full">
            <!-- Content generated here -->
            <div id="content-loader" class="text-center py-20 text-slate-400">Loading payload...</div>
        </main>

    </div>

    <!-- Mobile Navigation Drawer -->
    <div id="mobile-drawer-backdrop" class="fixed inset-0 z-50 bg-black/20 backdrop-blur-sm hidden transition-opacity opacity-0" aria-hidden="true"></div>
    <div id="mobile-drawer" class="fixed inset-y-0 left-0 z-50 w-[280px] bg-background shadow-xl transform -translate-x-full transition-transform duration-300 ease-in-out flex flex-col" aria-hidden="true">
        <div class="flex items-center justify-between px-4 h-14 border-b border-slate-100">
            <span class="font-medium text-sm text-slate-900">Jump to</span>
            <button id="mobile-drawer-close" class="p-2 -mr-2 text-slate-500 hover:text-slate-900 rounded-md">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>
        <nav id="mobile-nav" class="flex-1 overflow-y-auto p-4 space-y-1">
            <!-- Nav items generated here -->
        </nav>
    </div>

    <!-- 3. Scripts -->
    <script>
        // --- STAGE 0: CONSTANTS ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // --- State ---
        let payload = null;
        let currentPaper = null;
        let expandedStates = new Map(); // questionId -> boolean

        // --- Markdown Renderer Setup (Stage 6 Add-on) ---
        const md = window.markdownit ? window.markdownit({
            html: true,       // Allow inline SVG
            linkify: true,
            breaks: false,    // Critical: must be false for KaTeX
        }) : null;

        if (md) {
            // Disable escape rule to preserve TeX backslashes
            md.inline.ruler.disable(['escape']);
        }

        // --- DOM Elements ---
        const els = {
            selector: document.getElementById('paper-selector'),
            paperRegion: document.getElementById('paper-region'),
            desktopNav: document.getElementById('desktop-nav'),
            mobileNav: document.getElementById('mobile-nav'),
            mobileTrigger: document.getElementById('mobile-menu-trigger'),
            mobileClose: document.getElementById('mobile-drawer-close'),
            drawer: document.getElementById('mobile-drawer'),
            backdrop: document.getElementById('mobile-drawer-backdrop'),
        };

        // --- Init ---
        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error('Payload fetch failed');
                payload = await response.json();
                
                renderSelector();
                if (payload.papers && payload.papers.length > 0) {
                    loadPaper(payload.papers[0].key);
                } else {
                    renderError("No papers found in payload.");
                }
            } catch (err) {
                console.error(err);
                renderError("PAPERS PAYLOAD MISSING");
            }
        }

        function renderError(msg) {
            els.paperRegion.innerHTML = `<div class="text-center py-20 font-medium text-slate-400 select-none">${msg}</div>`;
            els.selector.innerHTML = `<option>Error</option>`;
            els.selector.disabled = true;
        }

        function renderSelector() {
            els.selector.innerHTML = payload.papers.map(p => 
                `<option value="${p.key}">${p.label}</option>`
            ).join('');
            
            els.selector.addEventListener('change', (e) => {
                loadPaper(e.target.value);
            });
        }

        function loadPaper(paperKey) {
            currentPaper = payload.papers.find(p => p.key === paperKey);
            if (!currentPaper) return;

            // Reset states
            // Paper defaults: expandedAll
            const defaultExpanded = currentPaper.defaults?.expandedAll !== false; 
            
            // Rebuild DOM
            // 1. Render Content
            const contentHtml = renderPaperContent(currentPaper, defaultExpanded);
            els.paperRegion.innerHTML = contentHtml;

            // 2. Render Nav
            const navItems = buildNavModel(currentPaper);
            renderNav(navItems, els.desktopNav);
            renderNav(navItems, els.mobileNav);

            // 3. Post-render: KaTeX
            renderMathInElement(els.paperRegion, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false},
                ],
                throwOnError: false
            });

            // 4. Hydrate Icons
            lucide.createIcons();

            // 5. Scroll to top
            window.scrollTo({ top: 0, behavior: 'auto' });
        }

        // --- Content Rendering ---

        function renderPaperContent(paper, defaultExpanded) {
            let html = '';
            
            // Handle Sectioned vs Flat
            if (paper.sections) {
                paper.sections.forEach(section => {
                    // Render Section Header if label exists
                    if (section.label && section.label.trim().length > 0) {
                        html += `
                            <div class="mb-8 pt-4 pb-2 border-b border-slate-100">
                                <h2 class="text-lg font-medium text-slate-800">${section.label}</h2>
                            </div>
                        `;
                    }
                    html += `<div class="space-y-16">`; // Top level spacing
                    section.questions.forEach(q => {
                        html += renderQuestionNode(q, defaultExpanded, 0);
                    });
                    html += `</div>`;
                    html += `<div class="h-12"></div>`; // Spacing between sections
                });
            } else if (paper.questions) {
                html += `<div class="space-y-16">`; // Top level spacing
                paper.questions.forEach(q => {
                    html += renderQuestionNode(q, defaultExpanded, 0);
                });
                html += `</div>`;
            }

            return html;
        }

        function renderQuestionNode(node, defaultExpanded, depth) {
            const hasSolutionBlock = !!node.solutionBlock;
            const hasAnswer = hasSolutionBlock && !!node.solutionBlock.answer;
            const hasDetails = hasSolutionBlock && !!node.solutionBlock.solutionDetails;
            
            const indentClass = depth > 0 ? 'pl-0 sm:pl-4 md:pl-8 border-l-2 border-transparent hover:border-slate-100 transition-colors' : ''; // Indent via padding, subtle cue
            
            // Unique ID for toggling
            const uniqueId = `q-${node.id.replace(/[^a-zA-Z0-9]/g, '-')}`;

            // --- Render Markdown ---
            const questionHtml = renderMarkdown(node.question);
            
            let blockHtml = `
                <article id="${uniqueId}" class="scroll-mt-24 group relative ${indentClass}">
                    <!-- Question Body -->
                    <div class="flex gap-3 md:gap-4">
                        <div class="shrink-0 w-8 md:w-10 pt-1">
                            <span class="text-base font-semibold text-slate-900/80">${node.id}</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="prose prose-slate max-w-none text-slate-900 text-lg/relaxed md-content">
                                ${questionHtml}
                            </div>
                        </div>
                    </div>
            `;

            if (hasSolutionBlock) {
                blockHtml += `<div class="mt-6 ml-8 md:ml-14 space-y-6">`;
                
                // --- Answer ---
                if (hasAnswer) {
                    const answerHtml = renderMarkdown(node.solutionBlock.answer);
                    blockHtml += `
                        <div class="relative">
                            <div class="text-xs font-bold uppercase tracking-wider text-teal-600 mb-1">Answer</div>
                            <div class="prose prose-slate max-w-none text-slate-800 md-content">
                                ${answerHtml}
                            </div>
                        </div>
                    `;
                }

                // --- Solution Details ---
                if (hasDetails) {
                    const details = node.solutionBlock.solutionDetails;
                    const isExpanded = defaultExpanded; // Initial render state
                    
                    blockHtml += `
                        <div class="solution-details-wrapper group/details">
                            <button onclick="toggleDetails(this)" class="flex items-center gap-2 text-sm font-medium text-teal-600 hover:text-teal-700 transition-colors py-1 focus:outline-none focus-visible:ring-2 focus-visible:ring-teal-500 rounded-sm">
                                <span class="label-text">${isExpanded ? 'Hide working' : 'Show working'}</span>
                                <i data-lucide="chevron-down" class="w-4 h-4 transition-transform duration-200 ${isExpanded ? 'rotate-180' : ''}"></i>
                            </button>
                            
                            <div class="details-content mt-4 border-l border-slate-200 pl-4 py-1 space-y-6 ${isExpanded ? '' : 'hidden'}">
                                <!-- Keep in mind -->
                                ${details.keepInMind ? `
                                    <div class="space-y-2">
                                        <div class="flex items-center gap-2 text-xs font-bold uppercase tracking-wider text-slate-500">
                                            <i data-lucide="lightbulb" class="w-3 h-3"></i>
                                            Keep in mind
                                        </div>
                                        <div class="prose prose-sm prose-slate max-w-none text-slate-600 md-content">
                                            ${renderMarkdown(details.keepInMind)}
                                        </div>
                                    </div>
                                ` : ''}

                                <!-- Formulas used -->
                                ${details.formulasUsed ? `
                                    <div class="space-y-2">
                                        <div class="text-xs font-bold uppercase tracking-wider text-slate-400">Formulas used</div>
                                        <div class="prose prose-sm prose-slate max-w-none text-slate-600 md-content">
                                            ${renderMarkdown(details.formulasUsed)}
                                        </div>
                                    </div>
                                ` : ''}

                                <!-- Working -->
                                ${details.working ? `
                                    <div class="space-y-2">
                                        <div class="text-xs font-bold uppercase tracking-wider text-slate-500">Working</div>
                                        <div class="prose prose-slate max-w-none text-slate-700 md-content">
                                            ${renderMarkdown(details.working)}
                                        </div>
                                    </div>
                                ` : ''}

                                <!-- Alternative Working -->
                                ${details.alternativeWorking && details.alternativeWorking.length ? details.alternativeWorking.map((alt, idx) => `
                                    <div class="pt-4 border-t border-slate-100 space-y-2">
                                        <div class="text-xs font-bold uppercase tracking-wider text-slate-500">Alternative working ${details.alternativeWorking.length > 1 ? idx + 1 : ''}</div>
                                        <div class="prose prose-slate max-w-none text-slate-700 md-content">
                                            ${renderMarkdown(alt)}
                                        </div>
                                    </div>
                                `).join('') : ''}
                            </div>
                        </div>
                    `;
                }

                blockHtml += `</div>`; // End Solution Block Wrapper
            }

            // Children
            if (node.children && node.children.length > 0) {
                blockHtml += `<div class="mt-8 space-y-8">`;
                node.children.forEach(child => {
                    blockHtml += renderQuestionNode(child, defaultExpanded, depth + 1);
                });
                blockHtml += `</div>`;
            }

            blockHtml += `</article>`;
            return blockHtml;
        }

        // --- Markdown Helper ---
        function renderMarkdown(text) {
            if (!text) return '';
            if (!md) return text; // Fallback
            return md.render(text);
        }

        // --- Interaction: Toggle Details ---
        window.toggleDetails = function(btn) {
            const wrapper = btn.closest('.solution-details-wrapper');
            const content = wrapper.querySelector('.details-content');
            const label = wrapper.querySelector('.label-text');
            const icon = wrapper.querySelector('[data-lucide]');
            
            const isHidden = content.classList.contains('hidden');
            
            if (isHidden) {
                content.classList.remove('hidden');
                label.textContent = 'Hide working';
                icon.classList.add('rotate-180');
            } else {
                content.classList.add('hidden');
                label.textContent = 'Show working';
                icon.classList.remove('rotate-180');
            }
        };

        // --- Navigation Logic ---
        function buildNavModel(paper) {
            const items = [];
            
            const traverse = (nodes, sectionId) => {
                nodes.forEach(node => {
                    items.push({
                        id: node.id,
                        sectionId: sectionId,
                        targetId: `q-${node.id.replace(/[^a-zA-Z0-9]/g, '-')}`,
                        // Derived depth logic for visual styling only
                        isChild: node.id.includes('(') || (node.id.match(/\./g) || []).length > 0
                    });
                    if (node.children) traverse(node.children, sectionId);
                });
            };

            if (paper.sections) {
                paper.sections.forEach(sec => {
                    if (sec.label) items.push({ type: 'section', label: sec.label });
                    traverse(sec.questions, sec.label);
                });
            } else if (paper.questions) {
                traverse(paper.questions, null);
            }
            return items;
        }

        function renderNav(items, container) {
            container.innerHTML = items.map(item => {
                if (item.type === 'section') {
                    // Section Separator
                    return `
                        <div class="mt-4 mb-2 px-3 text-xs font-bold text-slate-400 uppercase tracking-wider select-none">
                            ${item.label}
                        </div>
                    `;
                }
                
                // Flat list, hierarchy via type scale
                const isSub = item.isChild; 
                // ColorLab B: Active state marker will be handled via JS/IntersectionObserver
                // Base state: text-slate-600, hover:text-slate-900
                return `
                    <a href="#${item.targetId}" 
                       data-target="${item.targetId}"
                       class="nav-item block px-3 py-1 text-sm border-l-2 border-transparent transition-colors
                              ${isSub ? 'text-slate-500' : 'text-slate-700 font-medium'} 
                              hover:text-teal-700 hover:border-slate-200"
                       onclick="handleNavClick(event, '${item.targetId}')">
                        ${item.id}
                    </a>
                `;
            }).join('');
        }

        window.handleNavClick = function(e, targetId) {
            e.preventDefault();
            const el = document.getElementById(targetId);
            if (el) {
                // Adjust for sticky header
                const offset = 80; 
                const bodyRect = document.body.getBoundingClientRect().top;
                const elementRect = el.getBoundingClientRect().top;
                const elementPosition = elementRect - bodyRect;
                const offsetPosition = elementPosition - offset;

                window.scrollTo({
                    top: offsetPosition,
                    behavior: 'smooth'
                });

                // Update URL hash without jumping
                history.pushState(null, null, `#${targetId}`);
                
                // Close mobile drawer if open
                closeMobileDrawer();
            }
        };

        // --- Intersection Observer for Active Nav ---
        const observerOptions = {
            root: null,
            rootMargin: '-10% 0px -80% 0px', // Highlight what's near the top
            threshold: 0
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    setActiveNav(entry.target.id);
                }
            });
        }, observerOptions);

        function setActiveNav(targetId) {
            // Desktop
            document.querySelectorAll('#desktop-nav .nav-item').forEach(link => {
                const isActive = link.dataset.target === targetId;
                updateLinkState(link, isActive);
            });
            // Mobile
            document.querySelectorAll('#mobile-nav .nav-item').forEach(link => {
                const isActive = link.dataset.target === targetId;
                updateLinkState(link, isActive);
            });
        }

        function updateLinkState(link, isActive) {
            if (isActive) {
                link.classList.add('border-teal-600', 'text-teal-700', 'font-bold');
                link.classList.remove('border-transparent', 'text-slate-500', 'text-slate-700', 'font-medium');
                // Ensure visible in scrollable nav
                link.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            } else {
                link.classList.remove('border-teal-600', 'text-teal-700', 'font-bold');
                link.classList.add('border-transparent');
                // Reset to hierarchy base
                if (link.textContent.trim().length > 3) { // Rough heuristic for sub-question
                    link.classList.add('text-slate-500');
                } else {
                    link.classList.add('text-slate-700', 'font-medium');
                }
            }
        }

        // MutationObserver to attach IntersectionObserver to new content
        const mutationObserver = new MutationObserver(() => {
            document.querySelectorAll('article[id^="q-"]').forEach(el => observer.observe(el));
        });
        mutationObserver.observe(els.paperRegion, { childList: true, subtree: true });


        // --- Mobile Drawer Logic ---
        function openMobileDrawer() {
            els.drawer.classList.remove('-translate-x-full');
            els.backdrop.classList.remove('hidden');
            // small delay to allow display:block to apply before opacity transition
            setTimeout(() => {
                els.backdrop.classList.remove('opacity-0');
            }, 10);
            document.body.style.overflow = 'hidden'; // Lock scroll
        }

        function closeMobileDrawer() {
            els.drawer.classList.add('-translate-x-full');
            els.backdrop.classList.add('opacity-0');
            setTimeout(() => {
                els.backdrop.classList.add('hidden');
            }, 300);
            document.body.style.overflow = ''; // Unlock scroll
        }

        els.mobileTrigger.addEventListener('click', openMobileDrawer);
        els.mobileClose.addEventListener('click', closeMobileDrawer);
        els.backdrop.addEventListener('click', closeMobileDrawer);

        // --- Run ---
        init();

    </script>
</body>
</html>
