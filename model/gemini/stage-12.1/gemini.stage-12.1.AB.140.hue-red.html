<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AB","indexWithinVariant":"140","totalWithinVariant":"200","hueFamily":"red","intensityMode":"","timestamp":"2026-01-07T06:39:12.677Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AB&quot;,&quot;indexWithinVariant&quot;:&quot;140&quot;,&quot;totalWithinVariant&quot;:&quot;200&quot;,&quot;hueFamily&quot;:&quot;red&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-07T06:39:12.677Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer (Prototype)</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- KaTeX CSS (No Integrity, No SRI) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <!-- KaTeX JS (No Integrity, No SRI) -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Markdown-it JS -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <style>
        /* =========================================
           CSS VARIABLES & RESET
           ColorLab B: Force Hue Family = RED
           Light Mode Only
           ========================================= */
        :root {
            /* Palette: Red Family (Base) */
            --color-base-0: #ffffff;
            --color-base-50: #fcfcfc;
            --color-base-100: #f3f4f6; /* Neutral grey for structure */
            --color-base-200: #e5e7eb; /* Hairlines */
            --color-base-300: #d1d5db;
            
            /* Typography Colors */
            --color-text-primary: #111827;   /* Question Body */
            --color-text-secondary: #374151; /* Answer, Headers */
            --color-text-tertiary: #4b5563;  /* Sub-questions, Solution Details Body */
            --color-text-quaternary: #6b7280;/* Navigation, Metadata */

            /* Accent: Red (For Focus, Links, Nav Marker, Controls) */
            --color-accent-primary: #dc2626; /* Red-600 */
            --color-accent-hover: #b91c1c;   /* Red-700 */
            --color-accent-subtle: #fef2f2;  /* Red-50 (Focus backgrounds if needed) */
            --color-focus-ring: rgba(220, 38, 38, 0.4);

            /* Semantic Mappings */
            --bg-page: var(--color-base-0);
            --bg-paper: var(--color-base-0);
            --divider-hairline: var(--color-base-200);
            
            /* Spacing Scale */
            --space-xs: 0.25rem;
            --space-sm: 0.5rem;
            --space-md: 1rem;
            --space-lg: 1.5rem;
            --space-xl: 2.5rem; /* Between top-level questions */
            --space-xxl: 4rem;

            /* Dimensions */
            --nav-width: 260px;
            --max-content-width: 800px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--bg-page);
            color: var(--color-text-primary);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        /* Focus Styles (Stage 5.5.2) - Red Accent */
        :focus-visible {
            outline: 2px solid var(--color-accent-primary);
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* Scrollbar Hiding (Add-on) */
        .hide-scrollbar {
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE/Edge */
        }
        .hide-scrollbar::-webkit-scrollbar {
            display: none; /* Chrome/Safari */
        }

        /* =========================================
           LAYOUT ARCHITECTURE (Stage 3)
           ========================================= */
        
        /* Top Controls Region */
        .top-controls {
            position: sticky;
            top: 0;
            z-index: 50;
            background-color: var(--bg-page); /* Matches paper surface context */
            border-bottom: 1px solid var(--divider-hairline);
            padding: var(--space-md) var(--space-lg);
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 60px;
        }

        .paper-selector {
            font-family: inherit;
            font-size: 0.95rem;
            padding: var(--space-xs) var(--space-sm);
            border: 1px solid var(--color-base-300);
            border-radius: 4px;
            color: var(--color-text-primary);
            background: white;
            cursor: pointer;
        }

        /* DocumentFrameShell */
        .document-shell {
            display: flex; /* Two sibling columns on desktop */
            max-width: 1200px;
            margin: 0 auto;
            min-height: calc(100vh - 60px);
        }

        /* Navigation Rail (Desktop) */
        .nav-rail {
            width: var(--nav-width);
            flex-shrink: 0;
            position: sticky;
            top: 60px; /* Below top controls */
            height: calc(100vh - 60px);
            overflow-y: auto;
            padding: var(--space-lg) var(--space-md) var(--space-lg) 0;
            display: none; /* Hidden on mobile */
            border-right: 1px solid transparent; /* Optical separation handled by whitespace/spacing */
        }

        @media (min-width: 768px) {
            .nav-rail {
                display: block;
            }
        }

        /* Paper Document Column */
        .paper-column {
            flex-grow: 1;
            padding: var(--space-lg) var(--space-md) var(--space-xxl) var(--space-lg);
            max-width: var(--max-content-width); /* Visual dominance but readable line length */
        }

        /* Mobile "Jump to" Trigger */
        .mobile-jump-trigger {
            display: block;
            background: none;
            border: none;
            color: var(--color-accent-primary);
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            padding: var(--space-sm);
        }
        @media (min-width: 768px) {
            .mobile-jump-trigger {
                display: none;
            }
        }

        /* Mobile Navigation Drawer */
        .drawer-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.2);
            z-index: 100;
            display: none;
        }
        .drawer-overlay.open {
            display: block;
        }
        .drawer-content {
            position: fixed;
            top: 0;
            right: 0; /* Right side drawer common for menus, or left per design. Let's use Right to not conflict with reading direction? Brief says "drawer", standard is often left. Let's stick to Left for nav alignment. */
            left: 0;
            bottom: 0;
            width: 85%;
            max-width: 320px;
            background: var(--bg-page);
            z-index: 101;
            transform: translateX(-100%);
            transition: transform 0.2s ease-out;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--divider-hairline);
        }
        .drawer-content.open {
            transform: translateX(0);
        }
        .drawer-header {
            padding: var(--space-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--divider-hairline);
        }
        .drawer-title {
            font-weight: 600;
            color: var(--color-text-primary);
        }
        .drawer-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            line-height: 1;
            color: var(--color-text-tertiary);
            cursor: pointer;
            padding: var(--space-sm);
        }
        .drawer-list-container {
            flex-grow: 1;
            overflow-y: auto;
            padding: var(--space-md);
        }

        /* =========================================
           NAVIGATION CONTENT (Desktop & Mobile)
           ========================================= */
        .nav-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .nav-section-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--color-text-quaternary);
            margin-top: var(--space-md);
            margin-bottom: var(--space-xs);
            padding-left: var(--space-sm);
            font-weight: 600;
        }

        .nav-item {
            display: block;
            font-size: 0.9rem;
            color: var(--color-text-quaternary);
            padding: 4px var(--space-sm);
            text-decoration: none;
            border-left: 2px solid transparent; /* Marker placeholder */
            cursor: pointer;
            transition: color 0.15s ease;
        }

        .nav-item:hover {
            color: var(--color-text-primary);
            text-decoration: underline;
            text-decoration-color: var(--color-base-300);
        }

        .nav-item.active {
            color: var(--color-text-primary);
            font-weight: 700;
            border-left-color: var(--color-accent-primary); /* Red marker */
        }

        /* Hierarchy via type scale (Stage 5.4.5) */
        .nav-item.depth-0 { font-size: 0.95rem; }
        .nav-item.depth-1 { font-size: 0.85rem; color: var(--color-text-tertiary); }
        .nav-item.depth-2 { font-size: 0.8rem;  color: var(--color-text-tertiary); }

        /* =========================================
           PAPER CONTENT STYLING (Stage 5)
           ========================================= */
        
        .section-header {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--color-text-primary);
            margin-top: var(--space-xl);
            margin-bottom: var(--space-lg);
            border-bottom: 1px solid var(--divider-hairline);
            padding-bottom: var(--space-sm);
        }

        .question-node {
            margin-bottom: var(--space-xl); /* Top level spacing */
            position: relative;
        }
        
        /* Nesting Spacing */
        .children-container {
            margin-top: var(--space-md);
            padding-left: 0; /* No visual indentation via padding for containers, handled by content indentation if needed, strict tree says: indentation optional. Let's use small indentation for hierarchy clarity. */
        }
        .children-container .question-node {
            margin-bottom: var(--space-lg); /* Tighter spacing for children */
        }
        
        /* Mobile/Small screen adaptation for indentation */
        @media (min-width: 600px) {
            .children-container {
                padding-left: var(--space-lg);
            }
        }

        /* Question Body */
        .question-body {
            display: flex;
            gap: var(--space-sm);
            align-items: baseline;
            color: var(--color-text-primary);
            margin-bottom: var(--space-md);
        }

        .q-id {
            font-weight: 600;
            min-width: 2em;
            color: var(--color-text-secondary);
            flex-shrink: 0;
        }

        .q-prompt {
            flex-grow: 1;
            font-size: 1.05rem;
            line-height: 1.6;
        }

        /* Solution Block */
        .solution-block {
            /* Subordinate container */
            margin-left: 0; 
        }
        @media (min-width: 600px) {
            .solution-block {
                margin-left: calc(2em + var(--space-sm)); /* Align with prompt text */
            }
        }

        /* Answer Region */
        .answer-region {
            margin-bottom: var(--space-md);
            display: flex;
            gap: var(--space-sm);
            align-items: baseline;
        }
        .answer-label {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--color-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .answer-content {
            font-weight: 500;
            color: var(--color-text-secondary);
        }

        /* Disclosure Control */
        .disclosure-control {
            background: none;
            border: none;
            padding: 0;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--color-accent-primary); /* Red per ColorLab B */
            display: inline-flex;
            align-items: center;
            gap: var(--space-xs);
            margin-bottom: var(--space-sm);
            transition: color 0.2s;
        }
        .disclosure-control:hover {
            color: var(--color-accent-hover);
            text-decoration: underline;
        }
        .chevron {
            transition: transform 0.2s;
            width: 1em;
            height: 1em;
            fill: currentColor;
        }
        .disclosure-control[aria-expanded="true"] .chevron {
            transform: rotate(180deg);
        }

        /* Solution Details Region */
        .solution-details {
            display: none;
            margin-top: var(--space-sm);
            /* Stage 3 permitted: very subtle background wash */
            /* background-color: var(--color-base-50); No, keep it cleaner. Whitespace only unless needed. */
            padding-top: var(--space-xs);
        }
        .solution-details.expanded {
            display: block;
            animation: slideDown 0.2s ease-out;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Solution Details Subsections */
        .sd-section {
            margin-bottom: var(--space-lg);
            font-size: 0.95rem;
            color: var(--color-text-tertiary);
        }

        .sd-label {
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--color-text-quaternary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: var(--space-xs);
            display: block;
        }

        /* Keep in Mind */
        .sd-keep-in-mind .sd-label {
            color: var(--color-text-secondary); /* Slightly more prominent */
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .sd-keep-in-mind ul {
            margin: 0;
            padding-left: 1.2em;
            list-style-type: disc;
        }

        /* Working / Alternative Working */
        .sd-working-body, .sd-alt-working-body {
            line-height: 1.6;
        }

        /* Separation between Working and Alt Working */
        .sep-working-to-alt {
            height: 1px;
            background-color: var(--divider-hairline);
            margin: var(--space-lg) 0;
        }

        /* =========================================
           CONTENT RENDERING (Markdown / KaTeX)
           ========================================= */
        
        /* Markdown generated content styling */
        .md-content p {
            margin-top: 0;
            margin-bottom: 0.75em;
        }
        .md-content p:last-child {
            margin-bottom: 0;
        }
        
        /* Tables (Minimal, Stage 5.8.5) */
        .md-content table {
            border-collapse: collapse;
            width: 100%;
            margin: var(--space-sm) 0;
            font-size: 0.9em;
        }
        .md-content th, .md-content td {
            border: 1px solid var(--color-base-200);
            padding: var(--space-sm);
            text-align: left;
        }
        .md-content th {
            font-weight: 600;
            color: var(--color-text-secondary);
            background: transparent;
        }
        /* Mobile table scroll wrapper */
        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-bottom: var(--space-md);
        }

        /* KaTeX Block Containment (Stage 6.0.8) */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            -webkit-overflow-scrolling: touch;
            padding: var(--space-xs) 0;
            margin: var(--space-sm) 0;
        }
        /* Stage 5.8.2 Pure math working - no special framing */
        
        /* Inline Math */
        .katex {
            font-size: 1.1em; /* Slight bump for readability */
        }

        /* Diagrams (SVG) */
        .md-content svg {
            max-width: 100%;
            height: auto;
            display: block;
            margin: var(--space-md) 0;
        }
        
        /* Loading / Error States */
        .loading-state, .error-state {
            padding: var(--space-xl);
            text-align: center;
            color: var(--color-text-tertiary);
            font-weight: 500;
        }

    </style>
</head>
<body>

    <!-- STAGE 0: CONSTANTS (Runtime Definition) -->
    <script>
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";
    </script>

    <!-- App Shell -->
    <div id="app">
        <!-- Top Controls -->
        <header class="top-controls">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <select id="paper-selector" class="paper-selector" aria-label="Select Paper">
                    <option disabled selected>Loading papers...</option>
                </select>
            </div>
            
            <button id="mobile-jump-trigger" class="mobile-jump-trigger">
                Jump to...
            </button>
        </header>

        <!-- Document Frame Shell -->
        <div class="document-shell">
            
            <!-- Desktop Nav Rail -->
            <nav class="nav-rail hide-scrollbar" aria-label="Document Navigation">
                <div id="desktop-nav-content"></div>
            </nav>

            <!-- Paper Column -->
            <main class="paper-column" id="paper-content">
                <div class="loading-state">Initializing...</div>
            </main>

        </div>

        <!-- Mobile Drawer -->
        <div id="drawer-overlay" class="drawer-overlay"></div>
        <div id="drawer-content" class="drawer-content">
            <div class="drawer-header">
                <span class="drawer-title">Jump to question</span>
                <button id="drawer-close" class="drawer-close" aria-label="Close navigation">&times;</button>
            </div>
            <div class="drawer-list-container hide-scrollbar" id="mobile-nav-content">
                <!-- Nav items cloned here -->
            </div>
        </div>
    </div>

    <!-- MAIN SCRIPT -->
    <script>
        (function() {
            // --- 1. CONFIGURATION & STATE ---
            
            // Markdown Renderer Configuration (Authoritative Stage 6 Add-on)
            const md = window.markdownit ? window.markdownit({
                html: true, 
                linkify: true,
                breaks: false // MUST stay false
            }) : null;

            if (md) {
                // Disable escape rule to preserve TeX backslashes
                md.inline.ruler.disable(['escape']);
            }

            const state = {
                papers: [],
                currentPaper: null,
                activePaperData: null // The full data object
            };

            const els = {
                paperSelector: document.getElementById('paper-selector'),
                paperContent: document.getElementById('paper-content'),
                desktopNav: document.getElementById('desktop-nav-content'),
                mobileNav: document.getElementById('mobile-nav-content'),
                mobileTrigger: document.getElementById('mobile-jump-trigger'),
                drawerOverlay: document.getElementById('drawer-overlay'),
                drawerContent: document.getElementById('drawer-content'),
                drawerClose: document.getElementById('drawer-close')
            };

            // --- 2. DATA LOADING ---

            async function init() {
                try {
                    const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                    if (!response.ok) throw new Error("Payload not found");
                    const data = await response.json();
                    
                    if (!data.papers || !Array.isArray(data.papers)) {
                        throw new Error("Invalid payload format");
                    }

                    state.papers = data.papers;
                    populateSelector();
                    
                    // Default to first paper
                    if (state.papers.length > 0) {
                        loadPaper(state.papers[0].key);
                    } else {
                        renderError("No papers in payload.");
                    }

                } catch (err) {
                    console.error(err);
                    renderError("PAPERS PAYLOAD MISSING");
                }
            }

            function populateSelector() {
                els.paperSelector.innerHTML = '';
                state.papers.forEach(paper => {
                    const opt = document.createElement('option');
                    opt.value = paper.key;
                    opt.textContent = paper.label || paper.key;
                    els.paperSelector.appendChild(opt);
                });
                els.paperSelector.addEventListener('change', (e) => {
                    loadPaper(e.target.value);
                });
            }

            function loadPaper(paperKey) {
                const paperData = state.papers.find(p => p.key === paperKey);
                if (!paperData) return;

                state.currentPaper = paperData;
                
                // Reset scroll
                window.scrollTo(0,0);
                
                renderPaper(paperData);
                renderNavigation(paperData);
            }

            function renderError(msg) {
                els.paperContent.innerHTML = `<div class="error-state">${msg}</div>`;
            }

            // --- 3. RENDERING LOGIC ---

            function renderPaper(paper) {
                els.paperContent.innerHTML = '';
                
                // Determine structure: Sections vs Flat
                const isSectioned = !!paper.sections;
                
                // Apply defaults
                const expandAll = paper.defaults?.expandedAll !== false; // Default true unless false

                if (isSectioned) {
                    paper.sections.forEach(section => {
                        // Section Header (only if label exists)
                        if (section.label && section.label.trim().length > 0) {
                            const header = document.createElement('div');
                            header.className = 'section-header';
                            header.textContent = section.label;
                            els.paperContent.appendChild(header);
                        }
                        
                        // Question List
                        if (section.questions) {
                            section.questions.forEach(q => {
                                els.paperContent.appendChild(createQuestionNode(q, 0, expandAll));
                            });
                        }
                    });
                } else if (paper.questions) {
                    // Flat list
                    paper.questions.forEach(q => {
                        els.paperContent.appendChild(createQuestionNode(q, 0, expandAll));
                    });
                }

                // Render Math (KaTeX)
                renderMathInElement(els.paperContent);
            }

            function createQuestionNode(data, depth, defaultExpanded) {
                const container = document.createElement('div');
                container.className = `question-node depth-${depth}`;
                container.id = `q-${sanitizeId(data.id)}`;

                // 1. Question Body
                const bodyEl = document.createElement('div');
                bodyEl.className = 'question-body';
                
                const idEl = document.createElement('div');
                idEl.className = 'q-id';
                idEl.textContent = data.id;
                
                const promptEl = document.createElement('div');
                promptEl.className = 'q-prompt md-content';
                promptEl.innerHTML = renderMd(data.question);

                bodyEl.appendChild(idEl);
                bodyEl.appendChild(promptEl);
                container.appendChild(bodyEl);

                // 2. Solution Block (Optional)
                if (data.solutionBlock) {
                    const blockEl = document.createElement('div');
                    blockEl.className = 'solution-block';

                    // A. Answer (Optional)
                    if (data.solutionBlock.answer) {
                        const ansEl = document.createElement('div');
                        ansEl.className = 'answer-region';
                        
                        const label = document.createElement('div');
                        label.className = 'answer-label';
                        label.textContent = 'Answer';
                        
                        const content = document.createElement('div');
                        content.className = 'answer-content md-content';
                        content.innerHTML = renderMd(data.solutionBlock.answer);
                        
                        ansEl.appendChild(label);
                        ansEl.appendChild(content);
                        blockEl.appendChild(ansEl);
                    }

                    // B. Solution Details (Optional)
                    const sdData = data.solutionBlock.solutionDetails;
                    if (sdData) {
                        // Toggle Control
                        const toggleBtn = document.createElement('button');
                        toggleBtn.className = 'disclosure-control';
                        toggleBtn.innerHTML = `
                            <span>${defaultExpanded ? 'Hide working' : 'Show working'}</span>
                            <svg class="chevron" viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>
                        `;
                        
                        // Expanded Region
                        const detailsRegion = document.createElement('div');
                        detailsRegion.className = 'solution-details';
                        if (defaultExpanded) detailsRegion.classList.add('expanded');

                        // Toggle Logic
                        let isExpanded = defaultExpanded;
                        toggleBtn.setAttribute('aria-expanded', isExpanded);
                        toggleBtn.onclick = () => {
                            isExpanded = !isExpanded;
                            detailsRegion.classList.toggle('expanded', isExpanded);
                            toggleBtn.querySelector('span').textContent = isExpanded ? 'Hide working' : 'Show working';
                            toggleBtn.setAttribute('aria-expanded', isExpanded);
                        };

                        // Subsections
                        
                        // Keep in mind
                        if (sdData.keepInMind) {
                            const kim = document.createElement('div');
                            kim.className = 'sd-section sd-keep-in-mind';
                            kim.innerHTML = `
                                <span class="sd-label">
                                    <svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor"><path d="M9 21c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-1H9v1zm3-19C8.14 2 5 5.14 5 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26c1.81-1.27 3-3.36 3-5.74 0-3.86-3.14-7-7-7zm2.85 11.1l-.85.6V16h-4v-2.3l-.85-.6A4.997 4.997 0 0 1 7 9c0-2.76 2.24-5 5-5s5 2.24 5 5c0 2.37-1.59 4.43-3.15 5.1z"/></svg>
                                    Keep in mind
                                </span>
                                <div class="md-content">${renderMd(sdData.keepInMind)}</div>
                            `;
                            detailsRegion.appendChild(kim);
                        }

                        // Formulas used
                        if (sdData.formulasUsed) {
                            const form = document.createElement('div');
                            form.className = 'sd-section sd-formulas';
                            form.innerHTML = `
                                <span class="sd-label">Formulas used</span>
                                <div class="md-content">${renderMd(sdData.formulasUsed)}</div>
                            `;
                            detailsRegion.appendChild(form);
                        }

                        // Working
                        if (sdData.working) {
                            const work = document.createElement('div');
                            work.className = 'sd-section sd-working';
                            work.innerHTML = `
                                <span class="sd-label">Working</span>
                                <div class="sd-working-body md-content">${renderMd(sdData.working)}</div>
                            `;
                            detailsRegion.appendChild(work);
                        }

                        // Alternative working (Array)
                        if (sdData.alternativeWorking && Array.isArray(sdData.alternativeWorking)) {
                            sdData.alternativeWorking.forEach(altMd => {
                                // Separator
                                detailsRegion.appendChild(document.createElement('div')).className = 'sep-working-to-alt';
                                
                                const alt = document.createElement('div');
                                alt.className = 'sd-section sd-alt-working';
                                alt.innerHTML = `
                                    <span class="sd-label">Alternative working</span>
                                    <div class="sd-alt-working-body md-content">${renderMd(altMd)}</div>
                                `;
                                detailsRegion.appendChild(alt);
                            });
                        }

                        blockEl.appendChild(toggleBtn);
                        blockEl.appendChild(detailsRegion);
                    }

                    container.appendChild(blockEl);
                }

                // 3. Children (Recursive)
                if (data.children && data.children.length > 0) {
                    const childrenCont = document.createElement('div');
                    childrenCont.className = 'children-container';
                    data.children.forEach(child => {
                        childrenCont.appendChild(createQuestionNode(child, depth + 1, defaultExpanded));
                    });
                    container.appendChild(childrenCont);
                }

                return container;
            }

            function renderNavigation(paper) {
                // Generate Nav DOM
                const fragment = document.createDocumentFragment();
                const navList = document.createElement('ul');
                navList.className = 'nav-list';

                const isSectioned = !!paper.sections;

                // Flatten the structure for navigation generation
                if (isSectioned) {
                    paper.sections.forEach(section => {
                        // Section Label (Non-clickable, if exists)
                        if (section.label && section.label.trim().length > 0) {
                            const secLabel = document.createElement('li');
                            secLabel.className = 'nav-section-label';
                            secLabel.textContent = section.label;
                            navList.appendChild(secLabel);
                        }
                        // Questions
                        if (section.questions) {
                            section.questions.forEach(q => appendNavItems(q, navList, 0));
                        }
                    });
                } else if (paper.questions) {
                    paper.questions.forEach(q => appendNavItems(q, navList, 0));
                }

                fragment.appendChild(navList);
                
                // Desktop
                els.desktopNav.innerHTML = '';
                els.desktopNav.appendChild(fragment.cloneNode(true));

                // Mobile
                els.mobileNav.innerHTML = '';
                els.mobileNav.appendChild(fragment.cloneNode(true));
                
                // Bind Click Events (delegate)
                bindNavEvents(els.desktopNav);
                bindNavEvents(els.mobileNav);
                
                // Start Scroll Spy (Active State)
                updateActiveNavState();
            }

            function appendNavItems(node, list, depth) {
                const li = document.createElement('li');
                const a = document.createElement('a');
                a.className = `nav-item depth-${Math.min(depth, 2)}`;
                a.textContent = node.id;
                a.dataset.targetId = `q-${sanitizeId(node.id)}`;
                li.appendChild(a);
                list.appendChild(li);

                if (node.children) {
                    node.children.forEach(child => appendNavItems(child, list, depth + 1));
                }
            }

            function bindNavEvents(container) {
                container.addEventListener('click', (e) => {
                    if (e.target.classList.contains('nav-item')) {
                        e.preventDefault();
                        const targetId = e.target.dataset.targetId;
                        const targetEl = document.getElementById(targetId);
                        if (targetEl) {
                            // Smooth scroll
                            const headerOffset = 80;
                            const elementPosition = targetEl.getBoundingClientRect().top;
                            const offsetPosition = elementPosition + window.pageYOffset - headerOffset;

                            window.scrollTo({
                                top: offsetPosition,
                                behavior: "smooth"
                            });

                            // Close mobile drawer if open
                            closeDrawer();
                        }
                    }
                });
            }

            // --- 4. UTILITIES ---

            function sanitizeId(str) {
                return str.replace(/[^a-zA-Z0-9]/g, '_');
            }

            function renderMd(text) {
                if (!md || !text) return text || '';
                return md.render(text);
            }

            function renderMathInElement(root) {
                if (window.renderMathInElement) {
                    window.renderMathInElement(root, {
                        delimiters: [
                            {left: '$$', right: '$$', display: true},
                            {left: '$', right: '$', display: false}
                        ],
                        throwOnError: false
                    });
                }
            }

            // --- 5. INTERACTION HANDLERS ---
            
            // Drawer
            function openDrawer() {
                els.drawerOverlay.classList.add('open');
                els.drawerContent.classList.add('open');
                document.body.style.overflow = 'hidden'; // Lock body scroll
            }
            function closeDrawer() {
                els.drawerOverlay.classList.remove('open');
                els.drawerContent.classList.remove('open');
                document.body.style.overflow = '';
            }
            els.mobileTrigger.addEventListener('click', openDrawer);
            els.drawerClose.addEventListener('click', closeDrawer);
            els.drawerOverlay.addEventListener('click', closeDrawer);

            // Scroll Spy for Nav
            // Simple logic: Highlight top-most visible question
            window.addEventListener('scroll', throttle(updateActiveNavState, 100));

            function updateActiveNavState() {
                const questions = document.querySelectorAll('.question-node');
                let activeId = null;

                // Find first element that is roughly in view (offset by header)
                for (let i = 0; i < questions.length; i++) {
                    const rect = questions[i].getBoundingClientRect();
                    if (rect.top >= 0 && rect.top < 300) {
                        activeId = questions[i].id;
                        break;
                    }
                }
                // If nothing found in top range, look for what covers the top
                if (!activeId && questions.length > 0) {
                    for (let i = 0; i < questions.length; i++) {
                        const rect = questions[i].getBoundingClientRect();
                        if (rect.bottom > 100) {
                            activeId = questions[i].id;
                            break;
                        }
                    }
                }

                if (activeId) {
                    // Update both navs
                    [els.desktopNav, els.mobileNav].forEach(nav => {
                        const items = nav.querySelectorAll('.nav-item');
                        items.forEach(item => {
                            if (item.dataset.targetId === activeId) item.classList.add('active');
                            else item.classList.remove('active');
                        });
                    });
                }
            }

            function throttle(func, limit) {
                let inThrottle;
                return function() {
                    const args = arguments;
                    const context = this;
                    if (!inThrottle) {
                        func.apply(context, args);
                        inThrottle = true;
                        setTimeout(() => inThrottle = false, limit);
                    }
                }
            }

            // --- START ---
            init();

        })();
    </script>
</body>
</html>
