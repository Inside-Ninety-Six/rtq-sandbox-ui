<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"ABC","indexWithinVariant":"36","totalWithinVariant":"320","hueFamily":"green","intensityMode":"deep_theme","timestamp":"2026-01-07T11:03:00.010Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;ABC&quot;,&quot;indexWithinVariant&quot;:&quot;36&quot;,&quot;totalWithinVariant&quot;:&quot;320&quot;,&quot;hueFamily&quot;:&quot;green&quot;,&quot;intensityMode&quot;:&quot;deep_theme&quot;,&quot;timestamp&quot;:&quot;2026-01-07T11:03:00.010Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Viewer</title>
    
    <!-- KaTeX CSS (SRI Disabled per Stage 6.0.7b) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    
    <!-- Fonts -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap');
    </style>

    <style>
        /* =========================================
           STAGE 0-6: CSS RESET & VARIABLES
           ========================================= */
        :root {
            /* 
               COLORLAB B: Forced Hue Family = GREEN 
               COLORLAB C: Intensity Mode = DEEP_THEME (Light Mode Only)
               
               Normative OKLCH Definitions per Stage 6 Add-on C
            */
            
            /* HUE CONSTANT: Green ~ 150deg */
            --hue-primary: 150;

            /* SURFACE PALETTE (Deep Theme: Chromatic Light Surfaces) */
            /* Page Bg: L[0.92..0.98], C[0.08..0.16] */
            --color-surface-page: oklch(0.96 0.08 var(--hue-primary));
            
            /* Frame Base: L[0.90..0.96], C[0.08..0.16] */
            --color-surface-frame: oklch(0.94 0.10 var(--hue-primary));
            
            /* Paper Surface: L[0.94..0.99], C[0.06..0.14] */
            --color-surface-paper: oklch(0.98 0.06 var(--hue-primary));
            
            /* Solution Details Wash: C[0.05..0.10] */
            --color-surface-wash: oklch(0.95 0.07 var(--hue-primary));

            /* TYPOGRAPHY PALETTE (High legibility, mostly neutral) */
            /* Primary: L[0.15..0.25], C<=0.015 */
            --color-text-primary: oklch(0.20 0.015 var(--hue-primary));
            
            /* Secondary: L[0.25..0.40], C<=0.020 */
            --color-text-secondary: oklch(0.38 0.02 var(--hue-primary));
            
            /* Quiet/Tertiary Text */
            --color-text-tertiary: oklch(0.55 0.03 var(--hue-primary));

            /* ACCENTS (Restrained, Semantic-Free) */
            /* Accent: L[0.45..0.65], C[0.16..0.26] */
            --color-accent: oklch(0.55 0.22 var(--hue-primary));
            
            /* Focus Ring */
            --color-focus: var(--color-accent);

            /* BORDERS & DIVIDERS */
            /* Hairline: C<=0.02 */
            --color-hairline: oklch(0.85 0.02 var(--hue-primary));

            /* SPACING SYSTEM (Rhythm) */
            --space-xs: 0.25rem;
            --space-s: 0.5rem;
            --space-m: 1rem;
            --space-l: 1.5rem;
            --space-xl: 2.5rem; /* Top-level question separation */
            --space-xxl: 4rem;

            /* DIMENSIONS */
            --width-nav-rail: 240px;
            --width-paper-max: 800px;
            --header-height: 60px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--color-surface-page);
            color: var(--color-text-primary);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            overflow-y: scroll; /* Force scrollbar to prevent layout shift */
        }

        /* Focus Management (Stage 5.5.2) */
        :focus-visible {
            outline: 2px solid var(--color-focus);
            outline-offset: 2px;
            border-radius: 2px;
        }

        button {
            font-family: inherit;
            border: none;
            background: none;
            cursor: pointer;
            padding: 0;
            color: inherit;
        }

        /* =========================================
           LAYOUT ARCHITECTURE (DocumentFrameShell)
           ========================================= */
        #app {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            max-width: 1200px; /* Constrain wide screens */
            margin: 0 auto;
            background-color: var(--color-surface-frame); /* Shared shell context */
        }

        /* Top Controls Region */
        .top-controls {
            height: var(--header-height);
            display: flex;
            align-items: center;
            padding: 0 var(--space-m);
            border-bottom: 1px solid var(--color-hairline);
            flex-shrink: 0;
            background-color: var(--color-surface-frame);
            position: sticky;
            top: 0;
            z-index: 20;
        }

        .paper-selector-wrapper {
            display: flex;
            gap: var(--space-s);
            align-items: center;
        }

        select.paper-selector {
            padding: var(--space-s);
            font-size: 0.9rem;
            border: 1px solid var(--color-hairline);
            border-radius: 4px;
            background-color: var(--color-surface-paper);
            color: var(--color-text-primary);
        }

        .mobile-jump-trigger {
            margin-left: auto;
            display: none; /* Desktop default */
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--color-accent);
        }

        /* Main Document Frame */
        .document-frame-shell {
            display: flex;
            flex: 1;
            position: relative;
        }

        /* Navigation Rail (Desktop) */
        .nav-rail {
            width: var(--width-nav-rail);
            flex-shrink: 0;
            padding: var(--space-l) var(--space-m);
            position: sticky;
            top: var(--header-height);
            height: calc(100vh - var(--header-height));
            overflow-y: auto; /* Independent scroll if needed */
            border-right: 1px solid var(--color-hairline);
            
            /* Scrollbar hiding (Add-on) */
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .nav-rail::-webkit-scrollbar {
            display: none;
        }

        /* Paper Content Region */
        .paper-region {
            flex: 1;
            padding: var(--space-l) var(--space-xl); /* Generous padding */
            background-color: var(--color-surface-frame); /* Visually shared with nav on desktop */
            display: flex;
            justify-content: center;
        }

        .paper-surface {
            background-color: var(--color-surface-paper);
            width: 100%;
            max-width: var(--width-paper-max);
            /* No cards/shadows per Stage 5 */
            min-height: 500px;
        }

        /* =========================================
           NAVIGATION STYLES
           ========================================= */
        .nav-list {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .nav-section-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--color-text-tertiary);
            margin-top: var(--space-m);
            margin-bottom: var(--space-xs);
            padding-left: var(--space-xs);
            font-weight: 600;
        }

        .nav-item {
            display: block;
            text-decoration: none;
            color: var(--color-text-secondary);
            font-size: 0.9rem;
            padding: var(--space-xs) var(--space-s);
            border-radius: 4px;
            transition: color 0.1s, font-weight 0.1s;
            /* Flat list - no indentation */
        }

        .nav-item:hover {
            color: var(--color-text-primary);
            text-decoration: underline;
            text-decoration-color: var(--color-hairline);
        }

        .nav-item.active {
            font-weight: 600;
            color: var(--color-text-primary);
            /* Add-on: optional accent marker allowed in nav */
            border-left: 2px solid var(--color-accent); 
            padding-left: calc(var(--space-s) - 2px);
        }

        /* Sub-question hierarchy via type scale (Stage 5.4.5) */
        .nav-item[data-depth="1"] { font-size: 0.85rem; color: var(--color-text-tertiary); }
        .nav-item[data-depth="2"] { font-size: 0.8rem; color: var(--color-text-tertiary); }

        /* =========================================
           PAPER CONTENT STYLES
           ========================================= */
        
        .paper-error {
            padding: var(--space-xl);
            text-align: center;
            color: var(--color-text-secondary);
            font-weight: 500;
            border: 1px dashed var(--color-hairline);
            margin-top: var(--space-xl);
        }

        .section-header-block {
            margin-bottom: var(--space-l);
            padding-bottom: var(--space-s);
            border-bottom: 1px solid var(--color-hairline);
        }

        .section-header-text {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--color-text-secondary);
        }

        .question-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-xl); /* Top-level separation */
        }

        .question-node {
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        /* Children handling */
        .children-container {
            margin-top: var(--space-m);
            display: flex;
            flex-direction: column;
            gap: var(--space-m); /* Child sibling separation */
        }
        
        /* Child Indentation (Adaptive) */
        .question-node[data-depth="0"] > .children-container { padding-left: 0; }
        .question-node[data-depth="1"] { padding-left: var(--space-m); } 
        .question-node[data-depth="2"] { padding-left: var(--space-m); }

        /* Question Body */
        .question-body {
            margin-bottom: var(--space-s);
        }
        
        .question-identifier {
            font-weight: 600;
            color: var(--color-text-secondary);
            margin-right: var(--space-s);
            float: left; /* Inline with first line */
        }

        .question-prompt {
            color: var(--color-text-primary);
            /* Markdown content styling */
        }

        .question-prompt p { margin: 0 0 var(--space-s) 0; }
        .question-prompt p:last-child { margin-bottom: 0; }

        /* Solution Block (Supporting Material) */
        .solution-block {
            margin-top: var(--space-s);
            /* Subordination via spacing, no frames */
        }

        /* Answer */
        .answer-region {
            margin-bottom: var(--space-s);
            color: var(--color-text-secondary);
            font-size: 0.95rem;
        }

        .answer-label {
            font-weight: 600;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-right: var(--space-s);
            color: var(--color-text-tertiary);
        }

        /* Disclosure Control */
        .disclosure-control {
            display: inline-flex;
            align-items: center;
            gap: var(--space-xs);
            font-size: 0.9rem;
            color: var(--color-accent); /* Permitted accent usage */
            font-weight: 500;
            margin-bottom: var(--space-s);
            transition: opacity 0.2s;
        }
        .disclosure-control:hover {
            opacity: 0.8;
            text-decoration: underline;
        }
        .disclosure-icon {
            font-size: 0.8em;
            transition: transform 0.2s ease;
        }
        .disclosure-control[aria-expanded="true"] .disclosure-icon {
            transform: rotate(180deg);
        }

        /* Solution Details Region */
        .solution-details-region {
            /* Subordinate visual treatment */
            font-size: 0.95rem;
            line-height: 1.45;
            color: var(--color-text-secondary); /* Restrained contrast */
            padding: var(--space-m);
            background-color: var(--color-surface-wash); /* Subordination via surface */
            border-radius: 4px;
            /* Animation hidden logic handled via JS/CSS class */
            display: none;
        }
        .solution-details-region.expanded {
            display: block;
            animation: fadeIn 0.2s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-4px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Solution Details Subsections */
        .sd-subsection {
            margin-bottom: var(--space-m);
        }
        .sd-subsection:last-child { margin-bottom: 0; }

        .sd-label {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--color-text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: var(--space-xs);
            display: block;
        }

        /* Keep in Mind specific */
        .keep-in-mind ul {
            margin: 0;
            padding-left: var(--space-l);
        }
        
        /* Working Internal Grammar */
        .working-body p { margin-bottom: var(--space-s); }
        .working-body table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: var(--space-s);
            font-size: 0.9em;
        }
        .working-body th, .working-body td {
            border: 1px solid var(--color-hairline);
            padding: var(--space-xs) var(--space-s);
            text-align: left;
        }

        /* KaTeX Containment Invariant (Locked) */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding: var(--space-xs) 0;
            /* Block-level math background only if needed, but per Stage 5.8.4 inline is transparent */
            /* Stage 6 rules allow scrolling only here */
            -webkit-overflow-scrolling: touch;
        }
        
        /* Inline KaTeX background explicitly transparent */
        .katex { background-color: transparent !important; }

        /* =========================================
           MOBILE DRAWER
           ========================================= */
        .mobile-drawer-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 50;
            display: none;
            justify-content: flex-end; /* Drawer on right? or Bottom? "Drawer" usually implies side or bottom. Let's do Bottom for easy thumb access or Side. Brief says "Drawer". I'll do Right Side for nav consistency logic. */
        }
        
        .mobile-drawer-content {
            width: 85%;
            max-width: 320px;
            height: 100%;
            background-color: var(--color-surface-page);
            padding: var(--space-m);
            overflow-y: auto;
            transform: translateX(100%);
            transition: transform 0.2s ease-out;
            display: flex;
            flex-direction: column;
        }

        .mobile-drawer-overlay.open { display: flex; }
        .mobile-drawer-overlay.open .mobile-drawer-content { transform: translateX(0); }

        .drawer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-m);
            padding-bottom: var(--space-s);
            border-bottom: 1px solid var(--color-hairline);
        }

        .drawer-title { font-weight: 600; }
        .drawer-close { font-size: 1.5rem; line-height: 1; }

        /* =========================================
           RESPONSIVE
           ========================================= */
        @media (max-width: 768px) {
            .nav-rail { display: none; } /* Hide desktop nav */
            .mobile-jump-trigger { display: block; }
            .paper-region { padding: var(--space-m) var(--space-s); }
            /* Adjust spacing for mobile */
            :root {
                --space-xl: 1.5rem;
                --space-l: 1rem;
            }
        }

    </style>
</head>
<body>

<div id="app">
    <!-- Top Controls -->
    <header class="top-controls">
        <div class="paper-selector-wrapper">
            <select id="paper-selector" class="paper-selector" aria-label="Select paper">
                <option value="" disabled selected>Loading papers...</option>
            </select>
        </div>
        <button class="mobile-jump-trigger" id="jump-to-trigger">Jump to</button>
    </header>

    <!-- Document Frame Shell -->
    <div class="document-frame-shell">
        <!-- Desktop Navigation Rail -->
        <nav class="nav-rail" aria-label="Document navigation">
            <div class="nav-list" id="desktop-nav-list">
                <!-- Injected via JS -->
            </div>
        </nav>

        <!-- Paper Region -->
        <main class="paper-region">
            <div id="paper-content" class="paper-surface">
                <!-- Injected via JS -->
            </div>
        </main>
    </div>

    <!-- Mobile Navigation Drawer -->
    <div id="mobile-drawer" class="mobile-drawer-overlay">
        <div class="mobile-drawer-content">
            <div class="drawer-header">
                <span class="drawer-title">Jump to</span>
                <button class="drawer-close" id="drawer-close" aria-label="Close navigation">&times;</button>
            </div>
            <div class="nav-list" id="mobile-nav-list">
                <!-- Injected via JS (Clone) -->
            </div>
        </div>
    </div>
</div>

<!-- SCRIPTS -->
<!-- Markdown-it (No SRI) -->
<script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>
<!-- KaTeX JS (No SRI) -->
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
<!-- Auto-render extension -->
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

<script>
    // =========================================
    // STAGE 0: CONSTANTS definition
    // =========================================
    const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
    const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

    // =========================================
    // GLOBAL STATE
    // =========================================
    let papersData = [];
    let currentPaper = null;
    let expandedStates = {}; // key: questionId, value: boolean

    // =========================================
    // MARKDOWN CONFIGURATION (Authoritative)
    // =========================================
    const md = window.markdownit
        ? window.markdownit({
            html: true, // Allow inline SVG
            linkify: true,
            breaks: false, // Must be false for KaTeX
        })
        : null;

    if (md) {
        // Disable escape to preserve TeX backslashes
        md.inline.ruler.disable(['escape']);
    }

    // =========================================
    // INITIALIZATION
    // =========================================
    async function init() {
        const selector = document.getElementById('paper-selector');
        
        try {
            const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
            if (!response.ok) throw new Error("Payload not found");
            const payload = await response.json();
            
            papersData = payload.papers || [];
            
            if (papersData.length === 0) {
                renderError("No papers found in payload.");
                return;
            }

            // Populate Selector
            selector.innerHTML = '';
            papersData.forEach(paper => {
                const opt = document.createElement('option');
                opt.value = paper.key;
                opt.textContent = paper.label || paper.key;
                selector.appendChild(opt);
            });

            // Event Listeners
            selector.addEventListener('change', (e) => loadPaper(e.target.value));
            
            // Load first paper
            loadPaper(papersData[0].key);

        } catch (e) {
            console.error(e);
            renderError("PAPERS PAYLOAD MISSING");
            // Disable selector
            selector.innerHTML = '<option disabled selected>Error loading payload</option>';
        }

        // Mobile Drawer Logic
        const drawer = document.getElementById('mobile-drawer');
        const trigger = document.getElementById('jump-to-trigger');
        const closeBtn = document.getElementById('drawer-close');

        function toggleDrawer(show) {
            if (show) drawer.classList.add('open');
            else drawer.classList.remove('open');
        }

        trigger.addEventListener('click', () => toggleDrawer(true));
        closeBtn.addEventListener('click', () => toggleDrawer(false));
        drawer.addEventListener('click', (e) => {
            if (e.target === drawer) toggleDrawer(false);
        });
    }

    function renderError(msg) {
        const container = document.getElementById('paper-content');
        container.innerHTML = `<div class="paper-error">${msg}</div>`;
    }

    // =========================================
    // CORE LOGIC: LOAD & RENDER PAPER
    // =========================================
    function loadPaper(paperKey) {
        const paper = papersData.find(p => p.key === paperKey);
        if (!paper) return;
        currentPaper = paper;
        
        // Reset expanded states based on defaults
        expandedStates = {};
        const defaultExpanded = paper.defaults?.expandedAll !== false; // Default to true unless explicit false

        // Helper to init states recursively
        function initStates(nodes) {
            if (!nodes) return;
            nodes.forEach(node => {
                if (node.solutionBlock?.solutionDetails) {
                    expandedStates[node.id] = defaultExpanded;
                }
                if (node.children) initStates(node.children);
            });
        }

        // Handle sections vs flat
        let allQuestions = [];
        if (paper.sections) {
            paper.sections.forEach(sec => {
                allQuestions = allQuestions.concat(sec.questions || []);
            });
        } else {
            allQuestions = paper.questions || [];
        }
        initStates(allQuestions);

        // Render Content
        renderContent(paper);
        
        // Render Navigation
        renderNavigation(paper);

        // Run KaTeX
        renderMath();
    }

    // =========================================
    // CONTENT RENDERING
    // =========================================
    function renderContent(paper) {
        const container = document.getElementById('paper-content');
        container.innerHTML = '';

        if (paper.sections) {
            paper.sections.forEach(section => {
                // Section Header (only if label exists)
                if (section.label && section.label.trim() !== "") {
                    const secBlock = document.createElement('div');
                    secBlock.className = 'section-header-block';
                    secBlock.innerHTML = `<div class="section-header-text">${section.label}</div>`;
                    container.appendChild(secBlock);
                }
                
                // Question List
                const qList = document.createElement('div');
                qList.className = 'question-list';
                section.questions.forEach(q => {
                    qList.appendChild(createQuestionNode(q, 0));
                });
                container.appendChild(qList);
            });
        } else if (paper.questions) {
            const qList = document.createElement('div');
            qList.className = 'question-list';
            paper.questions.forEach(q => {
                qList.appendChild(createQuestionNode(q, 0));
            });
            container.appendChild(qList);
        }
    }

    function createQuestionNode(node, depth) {
        const wrapper = document.createElement('div');
        wrapper.className = 'question-node';
        wrapper.dataset.depth = depth;
        wrapper.id = `q-${node.id}`; // Anchor target

        // 1. Question Body
        const qBody = document.createElement('div');
        qBody.className = 'question-body';
        
        // Identifier
        const ident = document.createElement('div');
        ident.className = 'question-identifier';
        ident.textContent = node.id;
        qBody.appendChild(ident);

        // Prompt (Markdown)
        const prompt = document.createElement('div');
        prompt.className = 'question-prompt';
        prompt.innerHTML = md ? md.render(node.question || '') : (node.question || '');
        qBody.appendChild(prompt);

        wrapper.appendChild(qBody);

        // 2. Solution Block (Optional)
        if (node.solutionBlock) {
            const sb = node.solutionBlock;
            const block = document.createElement('div');
            block.className = 'solution-block';

            // A) Answer
            if (sb.answer) {
                const ansRegion = document.createElement('div');
                ansRegion.className = 'answer-region';
                const label = document.createElement('span');
                label.className = 'answer-label';
                label.textContent = "Answer";
                
                const content = document.createElement('span');
                content.innerHTML = md ? md.renderInline(sb.answer) : sb.answer;
                
                ansRegion.appendChild(label);
                ansRegion.appendChild(content);
                block.appendChild(ansRegion);
            }

            // B) Solution Details (Toggle + Region)
            if (sb.solutionDetails) {
                const sd = sb.solutionDetails;
                const isExpanded = expandedStates[node.id];

                // Toggle Control
                const toggle = document.createElement('button');
                toggle.className = 'disclosure-control';
                toggle.setAttribute('aria-expanded', isExpanded);
                toggle.innerHTML = `
                    <span class="disclosure-label">${isExpanded ? 'Hide working' : 'Show working'}</span>
                    <span class="disclosure-icon">â–¼</span>
                `;
                
                // Region
                const region = document.createElement('div');
                region.className = `solution-details-region ${isExpanded ? 'expanded' : ''}`;
                
                // Interaction
                toggle.onclick = () => {
                    expandedStates[node.id] = !expandedStates[node.id];
                    const expanded = expandedStates[node.id];
                    
                    toggle.setAttribute('aria-expanded', expanded);
                    toggle.querySelector('.disclosure-label').textContent = expanded ? 'Hide working' : 'Show working';
                    
                    if (expanded) {
                        region.classList.add('expanded');
                    } else {
                        region.classList.remove('expanded');
                    }
                };

                // Build Subsections
                // Order: Keep in mind -> Formulas used -> Working -> Alternative working

                // i. Keep in mind
                if (sd.keepInMind) {
                    const div = document.createElement('div');
                    div.className = 'sd-subsection keep-in-mind';
                    div.innerHTML = `
                        <span class="sd-label">Keep in mind</span>
                        <div class="sd-body">${md ? md.render(sd.keepInMind) : sd.keepInMind}</div>
                    `;
                    region.appendChild(div);
                }

                // ii. Formulas used
                if (sd.formulasUsed) {
                    const div = document.createElement('div');
                    div.className = 'sd-subsection formulas-used';
                    div.innerHTML = `
                        <span class="sd-label">Formulas used</span>
                        <div class="sd-body">${md ? md.render(sd.formulasUsed) : sd.formulasUsed}</div>
                    `;
                    region.appendChild(div);
                }

                // iii. Working
                if (sd.working) {
                    const div = document.createElement('div');
                    div.className = 'sd-subsection working-body';
                    div.innerHTML = `
                        <span class="sd-label">Working</span>
                        <div class="sd-body">${md ? md.render(sd.working) : sd.working}</div>
                    `;
                    region.appendChild(div);
                }

                // iv. Alternative Working
                if (sd.alternativeWorking && Array.isArray(sd.alternativeWorking)) {
                    sd.alternativeWorking.forEach(alt => {
                        const div = document.createElement('div');
                        div.className = 'sd-subsection alternative-working';
                        div.innerHTML = `
                            <span class="sd-label">Alternative working</span>
                            <div class="sd-body">${md ? md.render(alt) : alt}</div>
                        `;
                        region.appendChild(div);
                    });
                }

                block.appendChild(toggle);
                block.appendChild(region);
            }
            
            wrapper.appendChild(block);
        }

        // 3. Children
        if (node.children && node.children.length > 0) {
            const childContainer = document.createElement('div');
            childContainer.className = 'children-container';
            node.children.forEach(child => {
                childContainer.appendChild(createQuestionNode(child, depth + 1));
            });
            wrapper.appendChild(childContainer);
        }

        return wrapper;
    }

    // =========================================
    // NAVIGATION GENERATION
    // =========================================
    function renderNavigation(paper) {
        const desktopList = document.getElementById('desktop-nav-list');
        const mobileList = document.getElementById('mobile-nav-list');
        desktopList.innerHTML = '';
        mobileList.innerHTML = '';

        const frag = document.createDocumentFragment();

        function addNavItem(node, depth) {
            const item = document.createElement('a');
            item.className = 'nav-item';
            item.href = `#q-${node.id}`;
            item.textContent = node.id;
            item.dataset.depth = Math.min(depth, 2); // Cap visual hierarchy depth
            
            item.onclick = (e) => {
                e.preventDefault();
                const target = document.getElementById(`q-${node.id}`);
                if (target) {
                    target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    // Highlight active logic
                    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                    // We need to highlight corresponding items in both lists
                    const allLinks = document.querySelectorAll(`a[href="#q-${node.id}"]`);
                    allLinks.forEach(link => link.classList.add('active'));

                    // Close mobile drawer
                    document.getElementById('mobile-drawer').classList.remove('open');
                }
            }
            return item;
        }

        function processNodes(nodes, depth) {
            nodes.forEach(node => {
                frag.appendChild(addNavItem(node, depth));
                if (node.children) processNodes(node.children, depth + 1);
            });
        }

        if (paper.sections) {
            paper.sections.forEach(sec => {
                // Section Label
                if (sec.label && sec.label.trim() !== "") {
                    const label = document.createElement('div');
                    label.className = 'nav-section-label';
                    label.textContent = sec.label;
                    frag.appendChild(label);
                }
                processNodes(sec.questions, 0);
            });
        } else {
            processNodes(paper.questions || [], 0);
        }

        desktopList.appendChild(frag.cloneNode(true));
        mobileList.appendChild(frag);
    }

    // =========================================
    // KATEX RENDERING
    // =========================================
    function renderMath() {
        if (!window.renderMathInElement) return;
        
        renderMathInElement(document.body, {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false}
            ],
            throwOnError: false,
            // Ensure no macros clash
            macros: {
                "\\le": "\\leqslant",
                "\\ge": "\\geqslant"
            }
        });
    }

    // =========================================
    // START
    // =========================================
    // Simple Intersection Observer to update Active Nav on scroll
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const id = entry.target.id;
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                const links = document.querySelectorAll(`a[href="#${id}"]`);
                links.forEach(l => l.classList.add('active'));
            }
        });
    }, { rootMargin: '-20% 0px -60% 0px' }); // Trigger when element is near top

    // Hook observer after render
    const originalRenderContent = renderContent;
    renderContent = function(paper) {
        originalRenderContent(paper);
        document.querySelectorAll('.question-node').forEach(node => observer.observe(node));
    }

    init();

</script>
</body>
</html>
