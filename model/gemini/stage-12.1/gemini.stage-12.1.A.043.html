<!DOCTYPE html>
<html lang="en" class="light">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"A","indexWithinVariant":"43","totalWithinVariant":"50","hueFamily":"","intensityMode":"","timestamp":"2026-01-06T19:16:05.325Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;A&quot;,&quot;indexWithinVariant&quot;:&quot;43&quot;,&quot;totalWithinVariant&quot;:&quot;50&quot;,&quot;hueFamily&quot;:&quot;&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-06T19:16:05.325Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Viewer</title>

    <!-- Typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- KaTeX CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <!-- Tailwind CSS (via CDN for prototype executable) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class', // Manual toggling only (disabled per instructions)
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        // COLORLAB A: Modern cool palette
                        brand: {
                            50: '#f5f3ff',
                            100: '#ede9fe',
                            500: '#8b5cf6', // Violet accent
                            600: '#7c3aed',
                            700: '#6d28d9',
                        },
                        neutral: {
                            50: '#f8fafc',  // Page bg
                            100: '#f1f5f9',
                            200: '#e2e8f0', // Dividers
                            300: '#cbd5e1',
                            400: '#94a3b8', // Quiet text
                            500: '#64748b', // Secondary text
                            600: '#475569',
                            700: '#334155',
                            800: '#1e293b',
                            900: '#0f172a', // Primary text
                        }
                    }
                }
            }
        }
    </script>

    <!-- Markdown-it -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>
    <!-- KaTeX JS -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <style>
        /* Base Reset & Setup */
        body {
            background-color: #f8fafc; /* neutral-50 */
            color: #0f172a; /* neutral-900 */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Scrollbar hiding for Nav */
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        /* Focus styles */
        :focus-visible {
            outline: 2px solid #7c3aed; /* brand-600 */
            outline-offset: 2px;
        }

        /* KaTeX / Math Overflow Protection (Locked Invariant) */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding: 0.5rem 0;
            -webkit-overflow-scrolling: touch;
            /* Scrollbar styling for math blocks */
            scrollbar-width: thin;
            scrollbar-color: #cbd5e1 transparent;
        }
        .katex-display::-webkit-scrollbar {
            height: 4px;
        }
        .katex-display::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 4px;
        }

        /* Markdown Content Styling */
        .md-content p {
            margin-bottom: 1rem;
            line-height: 1.6;
        }
        .md-content p:last-child {
            margin-bottom: 0;
        }
        .md-content ul {
            list-style-type: disc;
            padding-left: 1.5rem;
            margin-bottom: 1rem;
        }
        .md-content ol {
            list-style-type: decimal;
            padding-left: 1.5rem;
            margin-bottom: 1rem;
        }
        .md-content table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
            font-size: 0.95em;
        }
        .md-content th, .md-content td {
            border: 1px solid #e2e8f0;
            padding: 0.5rem;
            text-align: left;
        }
        .md-content th {
            font-weight: 600;
            background-color: transparent;
        }

        /* Diagram / SVG Passthrough limits */
        .md-content svg {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 1rem 0;
        }

        /* Document Frame Shell Alignment */
        .shell-container {
            max-width: 80rem; /* 7xl */
            margin: 0 auto;
            padding-left: 1rem;
            padding-right: 1rem;
        }
        @media (min-width: 1024px) {
            .shell-container {
                padding-left: 2rem;
                padding-right: 2rem;
            }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Top Controls Region -->
    <header class="w-full bg-neutral-50 border-b border-neutral-200 sticky top-0 z-20">
        <div class="shell-container h-14 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <!-- Mobile Menu Trigger -->
                <button id="mobile-menu-trigger" class="lg:hidden p-2 -ml-2 text-neutral-600 hover:text-neutral-900 rounded-md" aria-label="Jump to question">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
                
                <!-- Paper Selector -->
                <div class="relative">
                    <select id="paper-selector" class="appearance-none bg-transparent pl-3 pr-8 py-1.5 text-sm font-medium text-neutral-700 hover:text-neutral-900 focus:outline-none cursor-pointer">
                        <option>Loading papers...</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-neutral-500">
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                </div>
            </div>
            
            <div class="hidden lg:block text-xs font-medium text-neutral-400 uppercase tracking-wider">
                RTQ Viewer
            </div>
            
             <!-- Mobile Jump To Label (only visible on mobile header) -->
            <span class="lg:hidden text-sm font-medium text-neutral-500">Jump to</span>
        </div>
    </header>

    <!-- Main Document Frame Shell -->
    <div class="flex-1 shell-container relative">
        <div class="flex flex-col lg:flex-row min-h-[calc(100vh-3.5rem)]">
            
            <!-- Desktop Navigation Rail (Sticky) -->
            <nav class="hidden lg:block w-48 shrink-0 relative">
                <div class="sticky top-14 pt-8 pb-10 max-h-[calc(100vh-3.5rem)] overflow-y-auto scrollbar-hide pr-4">
                    <div id="desktop-nav-list" class="space-y-1">
                        <!-- Nav Items Generated Here -->
                    </div>
                </div>
            </nav>

            <!-- Separator (Desktop) -->
            <div class="hidden lg:block w-px bg-neutral-200 mx-8 my-8"></div>

            <!-- Paper Content Column -->
            <main class="flex-1 pt-8 pb-32 min-w-0" id="paper-content-region">
                <div id="paper-container" class="max-w-3xl mx-auto lg:mx-0">
                    <!-- Content Generated Here -->
                    <div class="text-center py-20 text-neutral-400 animate-pulse">Loading payload...</div>
                </div>
            </main>

        </div>
    </div>

    <!-- Mobile Drawer Overlay -->
    <div id="mobile-drawer-backdrop" class="fixed inset-0 bg-neutral-900/20 backdrop-blur-sm z-30 hidden opacity-0 transition-opacity duration-200"></div>
    <div id="mobile-drawer" class="fixed inset-y-0 left-0 w-64 bg-white z-40 transform -translate-x-full transition-transform duration-300 ease-out shadow-xl flex flex-col">
        <div class="h-14 flex items-center justify-between px-4 border-b border-neutral-100">
            <span class="font-semibold text-neutral-800">Jump to</span>
            <button id="mobile-drawer-close" class="p-2 -mr-2 text-neutral-500 hover:text-neutral-800">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <div class="flex-1 overflow-y-auto py-4 px-2">
            <div id="mobile-nav-list" class="space-y-1">
                <!-- Mobile Nav Items Generated Here -->
            </div>
        </div>
    </div>

    <!-- Runtime Logic -->
    <script>
        // --- STAGE 0: CONSTANTS ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json"; // Included for completeness per brief rules

        // --- State Management ---
        let appState = {
            papers: [],
            currentPaperId: null,
            expandedNodes: new Set(), // Set of Question Node IDs
            activeQuestionId: null // For nav highlighting
        };

        // --- DOM Elements ---
        const els = {
            paperSelector: document.getElementById('paper-selector'),
            paperContainer: document.getElementById('paper-container'),
            desktopNavList: document.getElementById('desktop-nav-list'),
            mobileNavList: document.getElementById('mobile-nav-list'),
            mobileMenuBtn: document.getElementById('mobile-menu-trigger'),
            mobileDrawer: document.getElementById('mobile-drawer'),
            mobileDrawerBackdrop: document.getElementById('mobile-drawer-backdrop'),
            mobileDrawerClose: document.getElementById('mobile-drawer-close'),
        };

        // --- Markdown & KaTeX Setup ---
        // Authoritative config per Stage 6 instructions
        const md = window.markdownit ? window.markdownit({
            html: true,   // Allow inline SVG passthrough
            linkify: true,
            breaks: false // Critical: prevent <br> in math blocks
        }) : null;

        if (md) {
            // Disable escape rule to preserve TeX backslashes
            md.inline.ruler.disable(['escape']);
        }

        // --- Utility Functions ---

        // Fetch Payload
        async function loadPayload() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Payload not found");
                const data = await response.json();
                appState.papers = data.papers || [];
                initApp();
            } catch (e) {
                console.error(e);
                renderFailureMode();
            }
        }

        function renderFailureMode() {
            els.paperSelector.innerHTML = '<option>Error</option>';
            els.paperContainer.innerHTML = `
                <div class="flex items-center justify-center h-64 border-2 border-dashed border-neutral-300 rounded-lg">
                    <p class="text-neutral-500 font-medium">PAPERS PAYLOAD MISSING</p>
                </div>
            `;
            els.desktopNavList.innerHTML = '';
        }

        function initApp() {
            if (appState.papers.length === 0) {
                renderFailureMode();
                return;
            }

            // Populate Selector
            els.paperSelector.innerHTML = appState.papers.map(p => 
                `<option value="${p.key}">${p.label}</option>`
            ).join('');

            // Event Listener for Selector
            els.paperSelector.addEventListener('change', (e) => {
                switchPaper(e.target.value);
            });

            // Initial Load
            switchPaper(appState.papers[0].key);
        }

        function switchPaper(paperKey) {
            const paper = appState.papers.find(p => p.key === paperKey);
            if (!paper) return;

            appState.currentPaperId = paperKey;
            
            // Handle Defaults
            appState.expandedNodes.clear();
            const expandAll = paper.defaults?.expandedAll !== false; // Default true unless explicitly false

            // Pre-calculate expanded states for questions with solutionDetails
            const recurseExpand = (nodes) => {
                if (!nodes) return;
                nodes.forEach(node => {
                    if (node.solutionBlock?.solutionDetails && expandAll) {
                        appState.expandedNodes.add(node.id);
                    }
                    if (node.children) recurseExpand(node.children);
                });
            };
            
            // Handle flat vs sectioned structure for recursion
            if (paper.sections) {
                paper.sections.forEach(s => recurseExpand(s.questions));
            } else if (paper.questions) {
                recurseExpand(paper.questions);
            }

            renderNav(paper);
            renderPaperContent(paper);
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'auto' });
        }

        // --- Rendering Logic: Navigation ---

        function renderNav(paper) {
            const createNavItem = (id, label) => {
                const btn = document.createElement('button');
                btn.className = `w-full text-left py-1 px-2 text-sm rounded transition-colors duration-150 text-neutral-500 hover:text-neutral-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-brand-500`;
                // Hierarchy via type scale/quietness (simulated here with class logic if needed, but keeping flat per Stage 5)
                // Using dataset for intersection observer active state logic later if implemented
                btn.dataset.targetId = id;
                btn.textContent = label || id;
                
                // Active State logic would go here dynamically, simplified for static render
                btn.onclick = () => {
                    const el = document.getElementById(`q-${id}`);
                    if (el) {
                        // Smooth scroll with offset for sticky header
                        const headerOffset = 80;
                        const elementPosition = el.getBoundingClientRect().top;
                        const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
                        window.scrollTo({
                            top: offsetPosition,
                            behavior: "smooth"
                        });
                        closeDrawer();
                    }
                };
                return btn;
            };

            const createSectionLabel = (label) => {
                const div = document.createElement('div');
                div.className = "mt-4 mb-2 px-2 text-xs font-semibold text-neutral-400 uppercase tracking-wider select-none";
                div.textContent = label;
                return div;
            };

            const buildList = (container) => {
                container.innerHTML = '';
                
                if (paper.sections) {
                    paper.sections.forEach(section => {
                        if (section.label && section.label.trim() !== "") {
                            container.appendChild(createSectionLabel(section.label));
                        }
                        section.questions.forEach(q => processNavNode(q, container));
                    });
                } else if (paper.questions) {
                    paper.questions.forEach(q => processNavNode(q, container));
                }
            };

            const processNavNode = (node, container) => {
                // Flattened tree for nav
                container.appendChild(createNavItem(node.id, node.id));
                if (node.children) {
                    node.children.forEach(child => processNavNode(child, container));
                }
            };

            buildList(els.desktopNavList);
            buildList(els.mobileNavList);
        }

        // --- Rendering Logic: Content ---

        function renderPaperContent(paper) {
            const container = els.paperContainer;
            container.innerHTML = '';

            // Sectioned vs Flat
            if (paper.sections) {
                paper.sections.forEach((section, idx) => {
                    // Section Wrapper
                    const sectionWrapper = document.createElement('div');
                    sectionWrapper.className = "mb-12";
                    
                    // Section Header (only if non-empty)
                    if (section.label && section.label.trim() !== "") {
                        const header = document.createElement('div');
                        header.className = "mb-6 pb-2 border-b border-neutral-200";
                        header.innerHTML = `<h2 class="text-lg font-bold text-neutral-900">${section.label}</h2>`;
                        sectionWrapper.appendChild(header);
                    }

                    // Question List
                    const list = document.createElement('div');
                    list.className = "space-y-16"; // Top level spacing
                    section.questions.forEach(q => {
                        list.appendChild(createQuestionNode(q, 0));
                    });
                    sectionWrapper.appendChild(list);
                    container.appendChild(sectionWrapper);
                });
            } else if (paper.questions) {
                const list = document.createElement('div');
                list.className = "space-y-16"; // Top level spacing
                paper.questions.forEach(q => {
                    list.appendChild(createQuestionNode(q, 0));
                });
                container.appendChild(list);
            }

            // After HTML insertion, render math
            renderMathInElement(container, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false}
                ],
                throwOnError: false
            });
        }

        function createQuestionNode(node, depth) {
            const wrapper = document.createElement('div');
            wrapper.id = `q-${node.id}`;
            wrapper.className = "flex flex-col relative group"; // Group for potential future hover effects

            // Question Body Surface (Clean, no box)
            const qBody = document.createElement('div');
            // Depth visual indentation via padding-left (responsive)
            // Top level: 0, Children: indentation.
            const paddingLeftClass = depth > 0 ? (depth === 1 ? 'pl-4 lg:pl-8' : 'pl-8 lg:pl-16') : '';
            qBody.className = `${paddingLeftClass} w-full`;

            // 1. Question Identifier & Prompt
            const headerRow = document.createElement('div');
            headerRow.className = "flex flex-col sm:flex-row gap-2 sm:gap-4 mb-3";
            
            const idSpan = document.createElement('span');
            idSpan.className = "text-neutral-500 font-semibold shrink-0 min-w-[2rem] pt-0.5 select-none";
            idSpan.textContent = node.id;
            
            const promptDiv = document.createElement('div');
            promptDiv.className = "text-neutral-900 font-medium text-lg leading-relaxed md-content";
            promptDiv.innerHTML = md ? md.render(node.question) : node.question;

            headerRow.appendChild(idSpan);
            headerRow.appendChild(promptDiv);
            qBody.appendChild(headerRow);

            // 2. Solution Block (Optional)
            if (node.solutionBlock) {
                const sbWrapper = document.createElement('div');
                // Align with prompt text (push right past identifier)
                sbWrapper.className = "ml-0 sm:ml-12 mt-2"; 

                // A. Answer (Optional)
                if (node.solutionBlock.answer) {
                    const ansRow = document.createElement('div');
                    ansRow.className = "mb-3 group/answer";
                    
                    const ansLabel = document.createElement('div');
                    ansLabel.className = "text-xs font-bold text-brand-600 uppercase tracking-wide mb-1";
                    ansLabel.textContent = "Answer";
                    
                    const ansContent = document.createElement('div');
                    ansContent.className = "text-neutral-800 md-content bg-neutral-50/50 p-2 -ml-2 rounded border border-transparent"; // Subtle grouping, no card
                    ansContent.innerHTML = md ? md.render(node.solutionBlock.answer) : node.solutionBlock.answer;

                    ansRow.appendChild(ansLabel);
                    ansRow.appendChild(ansContent);
                    sbWrapper.appendChild(ansRow);
                }

                // B. Solution Details (Optional)
                if (node.solutionBlock.solutionDetails) {
                    const sd = node.solutionBlock.solutionDetails;
                    const isExpanded = appState.expandedNodes.has(node.id);

                    // Toggle Control
                    const toggleBtn = document.createElement('button');
                    toggleBtn.className = "flex items-center gap-2 text-sm font-medium text-brand-600 hover:text-brand-700 transition-colors focus:outline-none mb-2 select-none";
                    toggleBtn.innerHTML = `
                        <span>${isExpanded ? 'Hide working' : 'Show working'}</span>
                        <svg class="w-4 h-4 transition-transform duration-200 ${isExpanded ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    `;
                    
                    toggleBtn.onclick = () => {
                        if (appState.expandedNodes.has(node.id)) {
                            appState.expandedNodes.delete(node.id);
                        } else {
                            appState.expandedNodes.add(node.id);
                        }
                        // Re-render this node (simplest way to update state cleanly for prototype)
                        // In React we'd setState. Here we swap the element content.
                        const newNode = createQuestionNode(node, depth);
                        wrapper.replaceWith(newNode);
                        // Re-trigger math render on the new node
                        renderMathInElement(newNode, {
                            delimiters: [{left: '$$', right: '$$', display: true}, {left: '$', right: '$', display: false}]
                        });
                    };
                    sbWrapper.appendChild(toggleBtn);

                    // Expanded Content Region
                    if (isExpanded) {
                        const detailsRegion = document.createElement('div');
                        // ColorLab A: Use a very subtle slate tint for separation without heavy boxing
                        // using ring-1 ring-neutral-200/50 for a hairline hint if needed, or just left border
                        detailsRegion.className = "relative pl-4 border-l-2 border-neutral-200 space-y-6 py-2 mt-2";

                        // 1. Keep in Mind
                        if (sd.keepInMind) {
                            const block = document.createElement('div');
                            block.innerHTML = `
                                <h4 class="text-xs font-bold text-neutral-500 uppercase tracking-wide mb-1">Keep in mind</h4>
                                <div class="text-sm text-neutral-600 md-content leading-relaxed">${md ? md.render(sd.keepInMind) : sd.keepInMind}</div>
                            `;
                            detailsRegion.appendChild(block);
                        }

                        // 2. Formulas Used
                        if (sd.formulasUsed) {
                            const block = document.createElement('div');
                            block.innerHTML = `
                                <h4 class="text-xs font-bold text-neutral-500 uppercase tracking-wide mb-1">Formulas used</h4>
                                <div class="text-sm text-neutral-600 md-content font-mono text-xs bg-neutral-50 p-2 rounded">${md ? md.render(sd.formulasUsed) : sd.formulasUsed}</div>
                            `;
                            detailsRegion.appendChild(block);
                        }

                        // 3. Working
                        if (sd.working) {
                            const block = document.createElement('div');
                            block.innerHTML = `
                                <h4 class="text-xs font-bold text-neutral-500 uppercase tracking-wide mb-1">Working</h4>
                                <div class="text-neutral-700 md-content text-base">${md ? md.render(sd.working) : sd.working}</div>
                            `;
                            detailsRegion.appendChild(block);
                        }

                        // 4. Alternative Working
                        if (sd.alternativeWorking && Array.isArray(sd.alternativeWorking)) {
                            sd.alternativeWorking.forEach((alt, i) => {
                                const block = document.createElement('div');
                                block.className = "pt-4 border-t border-neutral-100 border-dashed";
                                block.innerHTML = `
                                    <h4 class="text-xs font-bold text-neutral-500 uppercase tracking-wide mb-1">Alternative working</h4>
                                    <div class="text-neutral-700 md-content text-base">${md ? md.render(alt) : alt}</div>
                                `;
                                detailsRegion.appendChild(block);
                            });
                        }
                        
                        sbWrapper.appendChild(detailsRegion);
                    }
                }
                qBody.appendChild(sbWrapper);
            }

            wrapper.appendChild(qBody);

            // 3. Children (Recursion)
            if (node.children && node.children.length > 0) {
                const childrenContainer = document.createElement('div');
                childrenContainer.className = "mt-6 space-y-6"; // Spacing between sibling sub-questions
                node.children.forEach(child => {
                    childrenContainer.appendChild(createQuestionNode(child, depth + 1));
                });
                wrapper.appendChild(childrenContainer);
            }

            return wrapper;
        }

        // --- Mobile Drawer Logic ---
        function toggleDrawer() {
            const isOpen = !els.mobileDrawer.classList.contains('-translate-x-full');
            if (isOpen) closeDrawer();
            else openDrawer();
        }

        function openDrawer() {
            els.mobileDrawer.classList.remove('-translate-x-full');
            els.mobileDrawerBackdrop.classList.remove('hidden');
            // small delay to allow display:block to apply before opacity transition
            setTimeout(() => els.mobileDrawerBackdrop.classList.remove('opacity-0'), 10);
            document.body.style.overflow = 'hidden'; // Lock scroll
        }

        function closeDrawer() {
            els.mobileDrawer.classList.add('-translate-x-full');
            els.mobileDrawerBackdrop.classList.add('opacity-0');
            setTimeout(() => els.mobileDrawerBackdrop.classList.add('hidden'), 200);
            document.body.style.overflow = ''; // Unlock scroll
        }

        els.mobileMenuBtn.addEventListener('click', toggleDrawer);
        els.mobileDrawerClose.addEventListener('click', closeDrawer);
        els.mobileDrawerBackdrop.addEventListener('click', closeDrawer);

        // --- Intersection Observer for Active Nav State (Bonus Polish) ---
        // Implementation note: Keep simple weight change per rules.
        const observerOptions = {
            root: null,
            rootMargin: '-10% 0px -80% 0px', // Trigger near top
            threshold: 0
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const id = entry.target.id.replace('q-', '');
                    updateActiveNav(id);
                }
            });
        }, observerOptions);

        function updateActiveNav(id) {
            // Reset all
            document.querySelectorAll('[data-target-id]').forEach(btn => {
                btn.classList.remove('font-bold', 'text-brand-600', 'bg-brand-50');
                btn.classList.add('text-neutral-500');
            });
            // Set active
            const activeBtn = document.querySelector(`[data-target-id="${id}"]`);
            if (activeBtn) {
                activeBtn.classList.remove('text-neutral-500');
                activeBtn.classList.add('font-bold', 'text-brand-600', 'bg-brand-50');
            }
        }

        // Monitor elements for scroll spy
        const mutationObserver = new MutationObserver(() => {
            const questions = document.querySelectorAll('[id^="q-"]');
            questions.forEach(q => observer.observe(q));
        });
        mutationObserver.observe(els.paperContainer, { childList: true, subtree: true });

        // --- Boot ---
        loadPayload();

    </script>
</body>
</html>
