<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"ABC","indexWithinVariant":"274","totalWithinVariant":"320","hueFamily":"amber","intensityMode":"tinted_neutrals","timestamp":"2026-01-07T22:18:54.043Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;ABC&quot;,&quot;indexWithinVariant&quot;:&quot;274&quot;,&quot;totalWithinVariant&quot;:&quot;320&quot;,&quot;hueFamily&quot;:&quot;amber&quot;,&quot;intensityMode&quot;:&quot;tinted_neutrals&quot;,&quot;timestamp&quot;:&quot;2026-01-07T22:18:54.043Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>
    
    <!-- KA-TEX CSS (No Integrity) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    
    <!-- TAILWIND CSS (Via CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- MARKDOWN-IT (No Integrity) -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>
    
    <!-- KA-TEX JS (No Integrity) -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <script>
        // --- COLORLAB CONFIGURATION (Amber / Tinted Neutrals) ---
        // Hue: 85 (Amber)
        // Mode: tinted_neutrals
        // Rules: 
        // Page/Frame/Paper C in [0.015 .. 0.035]
        // Wash C in [0.025 .. 0.045]
        // Text C <= 0.010/0.012
        // Accent C in [0.10 .. 0.16]

        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        page: 'oklch(0.975 0.02 85)',
                        frame: 'oklch(0.96 0.025 85)',
                        paper: 'oklch(0.985 0.015 85)',
                        wash: 'oklch(0.95 0.035 85)', 
                        border: 'oklch(0.88 0.025 85)',
                        
                        txt: {
                            primary: 'oklch(0.20 0.01 85)',
                            secondary: 'oklch(0.45 0.012 85)',
                            tertiary: 'oklch(0.60 0.012 85)',
                        },
                        
                        accent: {
                            DEFAULT: 'oklch(0.60 0.14 85)', // Amber accent
                            focus: 'oklch(0.60 0.14 85 / 0.5)',
                        }
                    },
                    fontFamily: {
                        sans: ['ui-sans-serif', 'system-ui', 'sans-serif'],
                    },
                    spacing: {
                        'nav-w': '240px',
                    }
                }
            }
        }
    </script>

    <style>
        /* BASE STYLES & RESET */
        :root {
            color-scheme: light;
        }
        
        body {
            background-color: oklch(0.975 0.02 85); /* page */
            color: oklch(0.20 0.01 85); /* txt-primary */
            -webkit-font-smoothing: antialiased;
            overflow-y: scroll;
        }

        /* KATEX CONTAINMENT INVARIANT (STAGE 3/6) */
        /* Never allow horizontal scroll on page. 
           Math blocks scroll internally. */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding: 0.5em 0;
            -webkit-overflow-scrolling: touch;
        }
        
        /* SCROLLBAR HIDING FOR NAV (STAGE 3 ADD-ON) */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* TYPOGRAPHY UTILS */
        .prose p {
            margin-bottom: 0.75em;
            line-height: 1.6;
        }
        .prose p:last-child {
            margin-bottom: 0;
        }
        /* Tables in Markdown */
        .prose table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95em;
            margin: 1em 0;
        }
        .prose th, .prose td {
            border: 1px solid oklch(0.88 0.025 85);
            padding: 0.5em;
            text-align: left;
        }
        .prose th {
            font-weight: 600;
            background-color: transparent;
        }
        
        /* INLINE SVG PASSTHROUGH */
        svg {
            max-width: 100%;
            height: auto;
        }

        /* FOCUS STATES */
        *:focus-visible {
            outline: 2px solid oklch(0.60 0.14 85);
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* STICKY NAV RAIL */
        .nav-sticky {
            position: sticky;
            top: 1rem;
            max-height: calc(100vh - 2rem);
            overflow-y: auto;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-4 sm:py-8 px-0 sm:px-4">

    <!-- TOP CONTROLS (Aligned to Shell) -->
    <div class="w-full max-w-5xl px-4 mb-4 flex justify-between items-center sm:px-0">
        <!-- Paper Selector -->
        <div class="relative">
            <label for="paper-select" class="sr-only">Select Paper</label>
            <select id="paper-select" class="appearance-none bg-paper border border-border rounded px-3 py-1.5 text-sm font-medium text-txt-primary pr-8 cursor-pointer focus:border-accent">
                <option value="" disabled selected>Loading papers...</option>
            </select>
            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-txt-secondary">
                <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
            </div>
        </div>

        <!-- Mobile Jump To Trigger -->
        <button id="mobile-jump-trigger" class="sm:hidden text-sm font-medium text-accent hover:text-txt-primary transition-colors">
            Jump to
        </button>
    </div>

    <!-- DOCUMENT FRAME SHELL -->
    <main class="w-full max-w-5xl bg-frame rounded-none sm:rounded-lg shadow-sm border-y sm:border border-border flex items-start min-h-[80vh] overflow-hidden relative">
        
        <!-- NAVIGATION RAIL (Desktop) -->
        <nav class="hidden sm:block w-nav-w flex-shrink-0 border-r border-border p-6 bg-frame nav-sticky no-scrollbar" aria-label="Paper navigation">
            <div id="desktop-nav-list" class="flex flex-col space-y-1">
                <!-- Injected via JS -->
            </div>
        </nav>

        <!-- PAPER CONTENT COLUMN -->
        <div class="flex-1 bg-paper min-h-full p-4 sm:p-10 w-full max-w-full">
            <div id="paper-content" class="max-w-3xl mx-auto flex flex-col gap-12 sm:gap-16">
                <!-- Injected via JS -->
                <div class="flex flex-col items-center justify-center py-20 text-txt-secondary animate-pulse">
                    Loading paper content...
                </div>
            </div>
        </div>

    </main>

    <!-- MOBILE NAVIGATION DRAWER -->
    <div id="mobile-drawer" class="fixed inset-0 z-50 transform translate-x-full transition-transform duration-300 ease-in-out sm:hidden" aria-hidden="true">
        <!-- Scrim -->
        <div id="drawer-scrim" class="absolute inset-0 bg-black/20 backdrop-blur-sm opacity-0 transition-opacity duration-300"></div>
        
        <!-- Drawer Content -->
        <div class="absolute right-0 top-0 bottom-0 w-64 bg-paper shadow-xl flex flex-col h-full transform transition-transform duration-300">
            <div class="p-4 border-b border-border flex justify-between items-center bg-paper">
                <h2 class="text-sm font-bold text-txt-primary">Jump to</h2>
                <button id="drawer-close" class="text-txt-secondary hover:text-txt-primary p-1">
                    <span class="sr-only">Close navigation</span>
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <nav class="flex-1 overflow-y-auto p-4 no-scrollbar bg-paper">
                <div id="mobile-nav-list" class="flex flex-col space-y-2">
                    <!-- Injected via JS -->
                </div>
            </nav>
        </div>
    </div>

    <script>
        // --- STAGE 0: CONSTANTS ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // --- STATE & UTILS ---
        const state = {
            papers: [],
            activePaper: null,
            expandedMap: new Set(), // Store IDs of expanded Solution Details
            navItems: [] // Flat list for navigation
        };

        // --- MARKDOWN SETUP (STAGE 6) ---
        const md = window.markdownit ? window.markdownit({
            html: true,     // Allow inline SVG
            linkify: true,
            breaks: false   // CRITICAL: Prevent <br> in math blocks
        }) : null;

        if (md) {
            // CRITICAL: Disable escape rule to preserve TeX backslashes
            md.inline.ruler.disable(['escape']);
        }

        // --- DATA LOADING ---
        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                
                state.papers = data.papers || [];
                
                if (state.papers.length === 0) {
                    renderError("NO PAPERS FOUND IN PAYLOAD");
                    return;
                }

                renderPaperSelector();
                
                // Load first paper by default
                loadPaper(state.papers[0].key);

            } catch (error) {
                console.error("Payload loading failed:", error);
                renderError("PAPERS PAYLOAD MISSING");
            }
        }

        function renderError(msg) {
            const container = document.getElementById('paper-content');
            container.innerHTML = `<div class="text-center py-20 text-txt-primary font-bold tracking-wide border-2 border-dashed border-border p-8 rounded bg-wash">${msg}</div>`;
            document.getElementById('paper-select').innerHTML = '<option disabled>Error loading papers</option>';
        }

        // --- RENDERERS ---

        function renderPaperSelector() {
            const select = document.getElementById('paper-select');
            select.innerHTML = state.papers.map(p => 
                `<option value="${p.key}">${p.label}</option>`
            ).join('');

            select.addEventListener('change', (e) => {
                loadPaper(e.target.value);
            });
        }

        function loadPaper(paperKey) {
            const paper = state.papers.find(p => p.key === paperKey);
            if (!paper) return;

            state.activePaper = paper;
            
            // Reset state
            state.expandedMap.clear();
            
            // Handle defaults
            const expandAll = paper.defaults?.expandedAll !== false; // Default to true unless explicitly false
            
            // Helper to collect IDs and set initial state
            const initNodes = (nodes) => {
                nodes.forEach(node => {
                    if (node.solutionBlock?.solutionDetails && expandAll) {
                        state.expandedMap.add(node.id);
                    }
                    if (node.children) initNodes(node.children);
                });
            };

            if (paper.sections) {
                paper.sections.forEach(s => initNodes(s.questions));
            } else if (paper.questions) {
                initNodes(paper.questions);
            }

            renderContent();
            renderNavigation();
            
            // Post-render: Math
            renderMath();
        }

        function renderContent() {
            const container = document.getElementById('paper-content');
            const paper = state.activePaper;

            let html = '';

            if (paper.sections) {
                paper.sections.forEach(section => {
                    // Render Section Header if label exists
                    if (section.label && section.label.trim().length > 0) {
                        html += `
                            <div class="border-b border-border pb-2 mb-8 mt-4">
                                <h2 class="text-lg font-bold text-txt-primary">${section.label}</h2>
                            </div>
                        `;
                    }
                    // Render Questions
                    html += `<div class="flex flex-col gap-12 sm:gap-16">`;
                    section.questions.forEach(q => {
                        html += renderQuestionNode(q, 0);
                    });
                    html += `</div>`;
                    
                    // Separation between sections
                    html += `<div class="h-8"></div>`;
                });
            } else if (paper.questions) {
                html += `<div class="flex flex-col gap-12 sm:gap-16">`;
                paper.questions.forEach(q => {
                    html += renderQuestionNode(q, 0);
                });
                html += `</div>`;
            }

            container.innerHTML = html;
            attachEventListeners();
        }

        // Recursive Question Renderer
        function renderQuestionNode(node, depth) {
            const isTopLevel = depth === 0;
            const hasSolutionBlock = !!node.solutionBlock;
            const hasAnswer = hasSolutionBlock && !!node.solutionBlock.answer;
            const hasDetails = hasSolutionBlock && !!node.solutionBlock.solutionDetails;
            const isExpanded = state.expandedMap.has(node.id);
            
            const indentClass = depth > 0 ? 'pl-0 sm:pl-6 border-l-0 sm:border-l border-transparent' : '';
            const spacingClass = depth > 0 ? 'mt-8' : '';

            // Render Markdown content
            const questionHtml = md ? md.render(node.question) : node.question;
            
            let blockHtml = `
                <div id="q-${node.id.replace(/[^a-zA-Z0-9]/g, '-')}" class="group ${indentClass} ${spacingClass} scroll-mt-24">
                    <!-- QUESTION BODY -->
                    <div class="mb-4">
                        <div class="flex items-baseline gap-3">
                            <span class="text-sm font-bold text-txt-secondary flex-shrink-0 select-none">${node.id}</span>
                            <div class="prose text-txt-primary max-w-none text-base sm:text-lg leading-relaxed">
                                ${questionHtml}
                            </div>
                        </div>
                    </div>
            `;

            if (hasSolutionBlock) {
                blockHtml += `<div class="ml-0 sm:ml-8 pl-0 sm:pl-4 border-l border-transparent sm:border-border transition-colors duration-200 hover:border-border">`;

                // ANSWER (Visible by default if present)
                if (hasAnswer) {
                    const answerHtml = md ? md.render(node.solutionBlock.answer) : node.solutionBlock.answer;
                    blockHtml += `
                        <div class="mb-4">
                            <div class="text-xs font-bold text-txt-tertiary uppercase tracking-wider mb-1">Answer</div>
                            <div class="prose text-txt-primary max-w-none font-medium">
                                ${answerHtml}
                            </div>
                        </div>
                    `;
                }

                // SOLUTION DETAILS (Disclosure)
                if (hasDetails) {
                    const toggleId = `toggle-${node.id}`;
                    const detailsId = `details-${node.id}`;
                    
                    blockHtml += `
                        <div class="mt-2">
                            <button 
                                type="button"
                                data-id="${node.id}"
                                aria-expanded="${isExpanded}"
                                aria-controls="${detailsId}"
                                class="js-toggle-working flex items-center gap-1.5 text-sm font-medium text-accent hover:text-txt-primary transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-accent rounded px-1 -ml-1 py-1"
                            >
                                <span class="js-label">${isExpanded ? 'Hide working' : 'Show working'}</span>
                                <svg class="w-4 h-4 transform transition-transform duration-200 ${isExpanded ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </button>
                            
                            <div id="${detailsId}" class="${isExpanded ? 'block' : 'hidden'} mt-4">
                                <div class="bg-wash rounded px-4 py-5 sm:px-6 sm:py-6 text-sm sm:text-base border border-transparent">
                                    ${renderSolutionDetails(node.solutionBlock.solutionDetails)}
                                </div>
                            </div>
                        </div>
                    `;
                }

                blockHtml += `</div>`; // End Solution Block Wrapper
            }

            // CHILDREN
            if (node.children && node.children.length > 0) {
                blockHtml += `<div class="mt-4 flex flex-col">`;
                node.children.forEach(child => {
                    blockHtml += renderQuestionNode(child, depth + 1);
                });
                blockHtml += `</div>`;
            }

            blockHtml += `</div>`; // End Question Node
            return blockHtml;
        }

        function renderSolutionDetails(details) {
            let html = '';
            
            // 1. Keep in mind
            if (details.keepInMind) {
                const content = md ? md.render(details.keepInMind) : details.keepInMind;
                html += `
                    <div class="mb-6">
                        <div class="flex items-center gap-2 mb-2">
                            <svg class="w-4 h-4 text-txt-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            <span class="text-xs font-bold text-txt-primary uppercase tracking-wider">Keep in mind</span>
                        </div>
                        <div class="prose text-txt-primary max-w-none">
                            ${content}
                        </div>
                    </div>
                    <div class="border-b border-border/50 my-6"></div>
                `;
            }

            // 2. Formulas Used
            if (details.formulasUsed) {
                const content = md ? md.render(details.formulasUsed) : details.formulasUsed;
                html += `
                    <div class="mb-6">
                        <div class="text-xs font-bold text-txt-secondary uppercase tracking-wider mb-2">Formulas used</div>
                        <div class="prose text-txt-secondary max-w-none text-sm">
                            ${content}
                        </div>
                    </div>
                    <div class="border-b border-border/50 my-6"></div>
                `;
            }

            // 3. Working
            if (details.working) {
                const content = md ? md.render(details.working) : details.working;
                html += `
                    <div class="mb-6">
                        <div class="text-xs font-bold text-txt-tertiary uppercase tracking-wider mb-2">Working</div>
                        <div class="prose text-txt-primary max-w-none">
                            ${content}
                        </div>
                    </div>
                `;
            }

            // 4. Alternative Working
            if (details.alternativeWorking && Array.isArray(details.alternativeWorking)) {
                details.alternativeWorking.forEach((alt, idx) => {
                    const content = md ? md.render(alt) : alt;
                    html += `
                        <div class="border-t border-border mt-8 pt-8 mb-4">
                            <div class="text-xs font-bold text-txt-tertiary uppercase tracking-wider mb-2">Alternative working</div>
                            <div class="prose text-txt-primary max-w-none">
                                ${content}
                            </div>
                        </div>
                    `;
                });
            }

            return html;
        }

        // --- NAVIGATION RENDERER ---
        
        function renderNavigation() {
            const paper = state.activePaper;
            const desktopList = document.getElementById('desktop-nav-list');
            const mobileList = document.getElementById('mobile-nav-list');
            
            let html = '';

            const renderItem = (id, depth) => {
                // Hierarchy via Type Scale/Opacity only (Stage 5.4.5)
                const textStyle = depth === 0 ? 'font-medium text-txt-primary' : 'font-normal text-txt-secondary text-sm';
                const anchorId = `q-${id.replace(/[^a-zA-Z0-9]/g, '-')}`;
                
                return `
                    <a href="#${anchorId}" 
                       class="block py-1 px-2 rounded hover:bg-wash transition-colors ${textStyle} focus:outline-none focus-visible:ring-2 focus-visible:ring-accent"
                       onclick="handleNavClick(event, '${anchorId}')"
                    >
                        ${id}
                    </a>
                `;
            };

            const traverse = (nodes, depth) => {
                let chunk = '';
                nodes.forEach(node => {
                    chunk += renderItem(node.id, depth);
                    if (node.children) {
                        chunk += traverse(node.children, depth + 1);
                    }
                });
                return chunk;
            };

            if (paper.sections) {
                paper.sections.forEach(s => {
                    // Section Label (Non-clickable)
                    if (s.label && s.label.trim()) {
                        html += `
                            <div class="mt-4 first:mt-0 mb-1 px-2 text-xs font-bold text-txt-tertiary uppercase tracking-wider select-none">
                                ${s.label}
                            </div>
                        `;
                    }
                    html += traverse(s.questions, 0);
                    // Separator between sections
                    html += `<div class="h-2"></div>`;
                });
            } else if (paper.questions) {
                html += traverse(paper.questions, 0);
            }

            desktopList.innerHTML = html;
            mobileList.innerHTML = html;
        }

        // --- INTERACTION HANDLERS ---

        function handleNavClick(e, anchorId) {
            e.preventDefault();
            const target = document.getElementById(anchorId);
            if (target) {
                // Close mobile drawer if open
                closeDrawer();
                
                // Smooth scroll
                const offset = 80; // Top controls offset
                const elementPosition = target.getBoundingClientRect().top;
                const offsetPosition = elementPosition + window.pageYOffset - offset;
                
                window.scrollTo({
                    top: offsetPosition,
                    behavior: "smooth"
                });

                // Update URL hash without jump
                history.pushState(null, null, '#' + anchorId);
            }
        }

        function attachEventListeners() {
            // Show/Hide Toggles
            document.querySelectorAll('.js-toggle-working').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = btn.dataset.id;
                    const detailsEl = document.getElementById(`details-${id}`);
                    const labelSpan = btn.querySelector('.js-label');
                    const icon = btn.querySelector('svg');
                    
                    const isExpanded = state.expandedMap.has(id);
                    
                    if (isExpanded) {
                        // Collapse
                        state.expandedMap.delete(id);
                        detailsEl.classList.add('hidden');
                        btn.setAttribute('aria-expanded', 'false');
                        labelSpan.textContent = 'Show working';
                        icon.classList.remove('rotate-180');
                    } else {
                        // Expand
                        state.expandedMap.add(id);
                        detailsEl.classList.remove('hidden');
                        btn.setAttribute('aria-expanded', 'true');
                        labelSpan.textContent = 'Hide working';
                        icon.classList.add('rotate-180');
                        // Re-render math in newly revealed content if needed 
                        // (though renderMath() handles document, doing it again is safe or we can scope it)
                        renderMath(detailsEl);
                    }
                });
            });
        }

        function renderMath(scope = document.body) {
            if (window.renderMathInElement) {
                renderMathInElement(scope, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false}
                    ],
                    throwOnError: false
                });
            }
        }

        // --- MOBILE DRAWER LOGIC ---
        const drawer = document.getElementById('mobile-drawer');
        const scrim = document.getElementById('drawer-scrim');
        const drawerContent = drawer.querySelector('div:last-child'); // The paper bg div
        const jumpBtn = document.getElementById('mobile-jump-trigger');
        const closeBtn = document.getElementById('drawer-close');

        function openDrawer() {
            drawer.classList.remove('translate-x-full');
            drawer.classList.add('translate-x-0');
            scrim.classList.remove('opacity-0', 'pointer-events-none');
            scrim.classList.add('opacity-100', 'pointer-events-auto');
            document.body.style.overflow = 'hidden'; // Lock body scroll
        }

        function closeDrawer() {
            drawer.classList.remove('translate-x-0');
            drawer.classList.add('translate-x-full');
            scrim.classList.remove('opacity-100', 'pointer-events-auto');
            scrim.classList.add('opacity-0', 'pointer-events-none');
            document.body.style.overflow = ''; // Unlock body scroll
        }

        jumpBtn.addEventListener('click', openDrawer);
        closeBtn.addEventListener('click', closeDrawer);
        scrim.addEventListener('click', closeDrawer);

        // --- BOOTSTRAP ---
        // Wait for DOM
        document.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
