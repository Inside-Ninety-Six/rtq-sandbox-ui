<!DOCTYPE html>
<html lang="en" class="antialiased">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AB","indexWithinVariant":"116","totalWithinVariant":"200","hueFamily":"red","intensityMode":"","timestamp":"2026-01-07T05:36:40.095Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AB&quot;,&quot;indexWithinVariant&quot;:&quot;116&quot;,&quot;totalWithinVariant&quot;:&quot;200&quot;,&quot;hueFamily&quot;:&quot;red&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-07T05:36:40.095Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer (Stage 6)</title>

    <!-- 
        STAGE 6 BASELINE LIBRARIES 
        SRI/Integrity disabled per Stage 6.0.7b and Stage 6 Implementation Add-on 
    -->
    
    <!-- Tailwind CSS (Prototyping) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- KaTeX CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    
    <!-- KaTeX JS -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Markdown-it -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- ColorLab B Configuration (Forced Hue: Blue) + Custom Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    colors: {
                        // COLORLAB B: Forced Hue Family = Blue
                        // Palette constructed for Light Mode Only (ColorLab A)
                        // Neutrals: Slate
                        // Accent: Blue
                        brand: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb', // Primary Accent (Links, Focus, Nav Marker)
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                        },
                        neutral: {
                            50: '#f8fafc',  // Page Background / Subtle Wash
                            100: '#f1f5f9', // Dividers
                            200: '#e2e8f0',
                            300: '#cbd5e1',
                            400: '#94a3b8', // Quiet text
                            500: '#64748b', // Secondary text
                            600: '#475569', // Body text
                            700: '#334155', 
                            800: '#1e293b', 
                            900: '#0f172a', // Primary text
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* STAGE 6: KaTeX Containment Invariant */
        /* Prevent page-level scroll, allow local scroll for display math */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding-bottom: 0.5rem; /* Scrollbar spacing */
            -webkit-overflow-scrolling: touch;
        }

        /* Hide scrollbars for navigation but keep functionality */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Focus styles matching Stage 5.5.2 (Custom but restrained) */
        :focus-visible {
            outline: 2px solid #2563eb; /* brand-600 */
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* Continuity Motion */
        @media (prefers-reduced-motion: no-preference) {
            .reveal-content {
                transition: all 0.25s ease-out;
            }
        }

        /* Table minimal styling */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }
        th, td {
            border: 1px solid #f1f5f9; /* neutral-100 */
            padding: 0.5rem;
            text-align: left;
            font-size: 0.95em;
        }
        th {
            font-weight: 600;
            color: #334155; /* neutral-700 */
        }
        
        /* Mobile Drawer Utilities */
        .drawer-open {
            overflow: hidden;
        }
    </style>
</head>
<body class="bg-white text-neutral-900 font-sans min-h-screen flex flex-col">

    <!-- Top Controls Region -->
    <div class="sticky top-0 z-40 bg-white/95 backdrop-blur-sm border-b border-neutral-100">
        <div class="max-w-7xl mx-auto px-4 md:px-8 h-14 flex items-center justify-between">
            
            <!-- Paper Selector -->
            <div class="flex items-center gap-3">
                <label for="paper-selector" class="text-sm font-medium text-neutral-500 sr-only">Select Paper</label>
                <select id="paper-selector" class="bg-transparent text-sm font-medium text-neutral-900 border-none focus:ring-0 cursor-pointer pr-8 hover:text-brand-600 transition-colors">
                    <option value="" disabled selected>Loading papers...</option>
                </select>
            </div>

            <!-- Mobile Jump To Trigger -->
            <button id="mobile-jump-trigger" class="md:hidden flex items-center gap-2 text-sm font-medium text-brand-600 hover:text-brand-700 px-2 py-1">
                <i data-lucide="list" class="w-4 h-4"></i>
                <span>Jump to</span>
            </button>
        </div>
    </div>

    <!-- DocumentFrameShell -->
    <div class="flex-1 max-w-7xl mx-auto w-full md:px-8 flex relative">
        
        <!-- Desktop Navigation Rail (Sticky) -->
        <!-- Visually shares surface with paper (Stage 5.4.2) -->
        <nav id="desktop-nav" class="hidden md:block w-48 lg:w-64 flex-shrink-0 pt-8 pb-12 sticky top-14 h-[calc(100vh-3.5rem)] overflow-y-auto no-scrollbar pr-4">
            <!-- Navigation Content Generated JS -->
            <div id="desktop-nav-content" class="flex flex-col gap-1"></div>
        </nav>

        <!-- Paper Document Column -->
        <main id="paper-content" class="flex-1 min-w-0 pt-8 pb-24 px-4 md:px-8 lg:px-12 max-w-4xl">
            <!-- Dynamic Content -->
            <div id="paper-body" class="space-y-16">
                <!-- Initial Loading State -->
                <div class="animate-pulse space-y-8">
                    <div class="h-4 bg-neutral-100 rounded w-3/4"></div>
                    <div class="h-4 bg-neutral-100 rounded w-1/2"></div>
                    <div class="h-32 bg-neutral-50 rounded w-full"></div>
                </div>
            </div>
        </main>

    </div>

    <!-- Mobile Navigation Drawer -->
    <div id="mobile-drawer" class="fixed inset-0 z-50 transform translate-x-full transition-transform duration-300 md:hidden" aria-hidden="true">
        <!-- Scrim -->
        <div id="drawer-scrim" class="absolute inset-0 bg-neutral-900/20 backdrop-blur-sm opacity-0 transition-opacity duration-300"></div>
        
        <!-- Drawer Panel -->
        <div class="absolute right-0 top-0 bottom-0 w-64 bg-white shadow-xl flex flex-col">
            <div class="flex items-center justify-between p-4 border-b border-neutral-100">
                <h2 class="text-sm font-semibold text-neutral-900">Jump to</h2>
                <button id="drawer-close" class="text-neutral-500 hover:text-neutral-900 p-1">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div id="mobile-nav-content" class="flex-1 overflow-y-auto p-4 space-y-1">
                <!-- Mobile Nav Items -->
            </div>
        </div>
    </div>

    <!-- Runtime Script -->
    <script>
        // --- STAGE 0: CONSTANTS ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // --- GLOBAL STATE ---
        let globalPapers = [];
        let currentPaper = null;
        let expandedStates = {}; // Key: Question ID, Value: Boolean

        // --- MARKDOWN SETUP ---
        // Stage 6 Implementation Add-on: Config Invariants
        const md = window.markdownit ? window.markdownit({
            html: true,    // Allow inline SVG
            linkify: true,
            breaks: false  // MUST stay false to prevent <br> in math
        }) : null;

        if (md) {
            // Disable inline escape to preserve TeX backslashes
            md.inline.ruler.disable(['escape']);
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', async () => {
            initMobileDrawer();
            await loadPayload();
            initScrollSpy();
        });

        // --- PAYLOAD LOADING ---
        async function loadPayload() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Network response was not ok");
                
                const data = await response.json();
                
                if (!data.papers || !Array.isArray(data.papers)) {
                    throw new Error("Invalid payload structure");
                }

                globalPapers = data.papers;
                populateSelector();
                
                // Load first paper by default
                if (globalPapers.length > 0) {
                    loadPaper(globalPapers[0].key);
                }

            } catch (error) {
                console.error("Payload Load Error:", error);
                renderError();
            }
        }

        function renderError() {
            const container = document.getElementById('paper-body');
            container.innerHTML = `
                <div class="py-12 text-center">
                    <p class="text-neutral-500 font-medium tracking-wide">PAPERS PAYLOAD MISSING</p>
                </div>
            `;
            const selector = document.getElementById('paper-selector');
            selector.innerHTML = '<option>Error loading papers</option>';
            selector.disabled = true;
        }

        // --- PAPER SELECTOR ---
        function populateSelector() {
            const selector = document.getElementById('paper-selector');
            selector.innerHTML = '';
            
            globalPapers.forEach(paper => {
                const option = document.createElement('option');
                option.value = paper.key;
                option.textContent = paper.label || paper.key;
                selector.appendChild(option);
            });

            selector.addEventListener('change', (e) => {
                loadPaper(e.target.value);
            });
        }

        function loadPaper(paperKey) {
            const paper = globalPapers.find(p => p.key === paperKey);
            if (!paper) return;

            currentPaper = paper;
            
            // Set Default Expansion States
            // Default: expandedAll = true unless explicitly false in defaults
            const defaultExpanded = paper.defaults?.expandedAll !== false;
            
            // Reset states
            expandedStates = {}; 
            // We initialize states during rendering logic or assume default if missing

            renderPaperContent(paper, defaultExpanded);
            renderNavigation(paper);
            
            // Re-run Lucide icons
            lucide.createIcons();
            
            // Render Math
            renderMath();

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'auto' });
        }

        // --- RENDERING CORE ---

        function renderPaperContent(paper, defaultExpanded) {
            const container = document.getElementById('paper-body');
            container.innerHTML = '';

            let questionsToRender = [];

            // Handle Sectioned vs Flat Papers
            if (paper.sections && Array.isArray(paper.sections)) {
                paper.sections.forEach(section => {
                    // Stage 3/6: Section Header only if label not empty
                    if (section.label && section.label.trim() !== '') {
                        const sectionHeader = document.createElement('div');
                        sectionHeader.className = "pt-8 pb-4 border-b border-neutral-100 mb-8";
                        sectionHeader.innerHTML = `<h2 class="text-xl font-medium text-neutral-400 font-sans">${section.label}</h2>`;
                        container.appendChild(sectionHeader);
                    }
                    // Render questions in this section
                    if (section.questions) {
                        section.questions.forEach(q => {
                            container.appendChild(createQuestionNode(q, defaultExpanded, 0));
                        });
                    }
                });
            } else if (paper.questions && Array.isArray(paper.questions)) {
                paper.questions.forEach(q => {
                    container.appendChild(createQuestionNode(q, defaultExpanded, 0));
                });
            }
        }

        function createQuestionNode(node, defaultExpanded, depth) {
            // Stage 3 Grammar: Question Node
            const wrapper = document.createElement('div');
            wrapper.className = `question-node scroll-mt-24 ${depth === 0 ? 'mb-16' : 'mt-6'}`;
            wrapper.id = `q-${node.id}`; // Anchor for nav
            wrapper.dataset.depth = depth;

            // 1. Question Body
            const body = document.createElement('div');
            body.className = "mb-4";
            
            // Identifier + Prompt
            // Hierarchy: Question Text is primary anchor.
            const qContentHtml = md ? md.render(node.question || '') : (node.question || '');
            
            body.innerHTML = `
                <div class="flex flex-col gap-1">
                    <span class="text-sm font-medium text-neutral-500 font-sans">${node.id}</span>
                    <div class="text-lg md:text-xl text-neutral-900 leading-relaxed font-medium prose-neutral">
                        ${qContentHtml}
                    </div>
                </div>
            `;
            wrapper.appendChild(body);

            // 2. Solution Block (Optional)
            if (node.solutionBlock) {
                const sb = node.solutionBlock;
                const solutionContainer = document.createElement('div');
                solutionContainer.className = "mt-4 pl-0"; // Indentation handled by spacing/rhythm, not hard margins per se

                // A. Answer (Visible by default if present)
                if (sb.answer) {
                    const answerDiv = document.createElement('div');
                    answerDiv.className = "mb-4 text-neutral-800";
                    const answerHtml = md ? md.render(sb.answer) : sb.answer;
                    
                    answerDiv.innerHTML = `
                        <div class="flex flex-col gap-1">
                            <span class="text-xs font-bold uppercase tracking-wider text-brand-600">Answer</span>
                            <div class="text-base font-medium">${answerHtml}</div>
                        </div>
                    `;
                    solutionContainer.appendChild(answerDiv);
                }

                // B. Solution Details (Expandable)
                if (sb.solutionDetails) {
                    const sd = sb.solutionDetails;
                    const isExpanded = expandedStates[node.id] !== undefined ? expandedStates[node.id] : defaultExpanded;
                    expandedStates[node.id] = isExpanded; // Ensure tracked

                    // Disclosure Control
                    const toggleBtn = document.createElement('button');
                    toggleBtn.className = "group flex items-center gap-2 text-sm font-medium text-brand-600 hover:text-brand-700 transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-brand-600 rounded py-1 pr-2";
                    toggleBtn.innerHTML = `
                        <span class="toggle-text">${isExpanded ? 'Hide working' : 'Show working'}</span>
                        <i data-lucide="chevron-down" class="w-4 h-4 transition-transform duration-200 ${isExpanded ? 'rotate-180' : ''}"></i>
                    `;
                    
                    const detailsRegion = document.createElement('div');
                    detailsRegion.className = `overflow-hidden reveal-content ${isExpanded ? 'max-h-none opacity-100 mt-4' : 'max-h-0 opacity-0 mt-0'}`;
                    
                    // Internal Content of Solution Details
                    // Order: Keep in mind -> Formulas -> Working -> Alt Working
                    let detailsHtml = '';

                    // Keep in mind
                    if (sd.keepInMind) {
                        const kimHtml = md ? md.render(sd.keepInMind) : sd.keepInMind;
                        detailsHtml += `
                            <div class="mb-6">
                                <div class="flex items-center gap-2 mb-2 text-neutral-700 font-semibold text-sm">
                                    <i data-lucide="lightbulb" class="w-4 h-4"></i>
                                    <span>Keep in mind</span>
                                </div>
                                <div class="text-neutral-600 text-sm leading-relaxed">${kimHtml}</div>
                            </div>
                        `;
                    }

                    // Formulas
                    if (sd.formulasUsed) {
                        const formHtml = md ? md.render(sd.formulasUsed) : sd.formulasUsed;
                        detailsHtml += `
                            <div class="mb-6">
                                <h4 class="text-xs font-bold text-neutral-500 uppercase tracking-wide mb-2">Formulas used</h4>
                                <div class="text-neutral-600 text-sm leading-relaxed">${formHtml}</div>
                            </div>
                        `;
                    }

                    // Working
                    if (sd.working) {
                        const workHtml = md ? md.render(sd.working) : sd.working;
                        detailsHtml += `
                            <div class="mb-8">
                                <h4 class="text-xs font-bold text-neutral-500 uppercase tracking-wide mb-3">Working</h4>
                                <div class="text-neutral-700 text-base leading-relaxed space-y-4">${workHtml}</div>
                            </div>
                        `;
                    }

                    // Alternative Working
                    if (sd.alternativeWorking && Array.isArray(sd.alternativeWorking)) {
                        sd.alternativeWorking.forEach((alt, idx) => {
                            const altHtml = md ? md.render(alt) : alt;
                            // Separator per Stage 5.8.7 (Label + Stronger separation)
                            detailsHtml += `
                                <div class="mt-8 pt-6 border-t border-neutral-100">
                                    <h4 class="text-xs font-bold text-neutral-500 uppercase tracking-wide mb-3">Alternative working ${sd.alternativeWorking.length > 1 ? idx + 1 : ''}</h4>
                                    <div class="text-neutral-700 text-base leading-relaxed space-y-4">${altHtml}</div>
                                </div>
                            `;
                        });
                    }

                    // Wrap details in a subtle surface container if needed (Stage 3 allows Region Surface or Just Spacing)
                    // We stick to pure spacing/typography per "Calm" tone, maybe a very subtle left border or just indent
                    detailsRegion.innerHTML = `
                        <div class="pl-0 md:pl-0 border-l-2 border-neutral-100 pl-4 py-1">
                            ${detailsHtml}
                        </div>
                    `;

                    // Toggle Logic
                    toggleBtn.onclick = () => {
                        const current = expandedStates[node.id];
                        const next = !current;
                        expandedStates[node.id] = next;
                        
                        // Update UI
                        const textSpan = toggleBtn.querySelector('.toggle-text');
                        const icon = toggleBtn.querySelector('i');
                        
                        textSpan.textContent = next ? 'Hide working' : 'Show working';
                        icon.style.transform = next ? 'rotate(180deg)' : 'rotate(0deg)';
                        
                        if (next) {
                            detailsRegion.classList.remove('max-h-0', 'opacity-0', 'mt-0');
                            detailsRegion.classList.add('max-h-none', 'opacity-100', 'mt-4');
                        } else {
                            detailsRegion.classList.remove('max-h-none', 'opacity-100', 'mt-4');
                            detailsRegion.classList.add('max-h-0', 'opacity-0', 'mt-0');
                        }
                    };

                    solutionContainer.appendChild(toggleBtn);
                    solutionContainer.appendChild(detailsRegion);
                }

                wrapper.appendChild(solutionContainer);
            }

            // 3. Children (Recursive)
            if (node.children && node.children.length > 0) {
                const childrenContainer = document.createElement('div');
                // Stage 3: Indentation optional but structure required.
                // We use left spacing to imply hierarchy gently.
                childrenContainer.className = "mt-6 ml-0 md:ml-4 lg:ml-8 border-l border-neutral-100/50 pl-4 md:pl-6"; 
                
                node.children.forEach(child => {
                    childrenContainer.appendChild(createQuestionNode(child, defaultExpanded, depth + 1));
                });
                wrapper.appendChild(childrenContainer);
            }

            return wrapper;
        }

        // --- NAVIGATION ---
        function renderNavigation(paper) {
            const desktopContainer = document.getElementById('desktop-nav-content');
            const mobileContainer = document.getElementById('mobile-nav-content');
            
            desktopContainer.innerHTML = '';
            mobileContainer.innerHTML = '';

            // Flatten logic for list generation
            const navItems = [];
            
            if (paper.sections) {
                paper.sections.forEach(sec => {
                    if (sec.label && sec.label.trim() !== '') {
                        navItems.push({ type: 'section', label: sec.label });
                    }
                    if (sec.questions) {
                        sec.questions.forEach(q => collectNavItems(q, navItems));
                    }
                });
            } else if (paper.questions) {
                paper.questions.forEach(q => collectNavItems(q, navItems));
            }

            // Render Items
            navItems.forEach(item => {
                if (item.type === 'section') {
                    // Section Separator (Non-clickable)
                    const el = document.createElement('div');
                    el.className = "mt-4 mb-2 text-xs font-bold text-neutral-400 uppercase tracking-wider px-2 select-none";
                    el.textContent = item.label;
                    desktopContainer.appendChild(el.cloneNode(true));
                    mobileContainer.appendChild(el.cloneNode(true));
                } else {
                    // Question Link
                    const link = document.createElement('a');
                    link.href = `#q-${item.id}`;
                    link.className = "nav-link block px-2 py-1 text-sm text-neutral-500 hover:text-neutral-900 hover:bg-neutral-50 rounded transition-colors border-l-2 border-transparent";
                    link.dataset.target = `q-${item.id}`;
                    
                    // Hierarchy via type scale/quietness (Stage 5.4.5)
                    // We reduce font size slightly for deeper items? Or keeps flat list but lower weight?
                    // Brief says "flat vertical list (no nested visual indentation)"
                    // "Hierarchy expressed only via typographic scale/quietness"
                    // We'll keep font size same to align left edge perfect, maybe lighter color for deep nesting?
                    // Actually, brief says "sub-questions are quieter/smaller".
                    if (item.depth > 0) {
                        link.classList.add('text-xs'); // Smaller
                    }

                    link.textContent = item.id;
                    
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const target = document.getElementById(`q-${item.id}`);
                        if (target) {
                            // Close drawer if mobile
                            closeMobileDrawer();
                            // Smooth scroll
                            const offset = 80; // Top header space
                            const bodyRect = document.body.getBoundingClientRect().top;
                            const elementRect = target.getBoundingClientRect().top;
                            const elementPosition = elementRect - bodyRect;
                            const offsetPosition = elementPosition - offset;

                            window.scrollTo({
                                top: offsetPosition,
                                behavior: "smooth"
                            });
                        }
                    });

                    desktopContainer.appendChild(link);
                    mobileContainer.appendChild(link.cloneNode(true));
                }
            });
        }

        function collectNavItems(node, list, depth = 0) {
            list.push({ type: 'question', id: node.id, depth });
            if (node.children) {
                node.children.forEach(c => collectNavItems(c, list, depth + 1));
            }
        }

        // --- SCROLL SPY & ACTIVE STATE ---
        function initScrollSpy() {
            const observerOptions = {
                root: null,
                rootMargin: '-20% 0px -60% 0px',
                threshold: 0
            };

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        updateActiveNav(entry.target.id);
                    }
                });
            }, observerOptions);

            // Re-observe when content changes
            const mutationObserver = new MutationObserver(() => {
                const questions = document.querySelectorAll('.question-node');
                questions.forEach(q => observer.observe(q));
            });

            mutationObserver.observe(document.getElementById('paper-body'), { childList: true, subtree: true });
        }

        function updateActiveNav(targetId) {
            const allLinks = document.querySelectorAll('.nav-link');
            allLinks.forEach(link => {
                // Reset style
                link.classList.remove('font-bold', 'text-brand-600', 'border-brand-600', 'bg-brand-50');
                link.classList.add('text-neutral-500', 'border-transparent');
                
                // Active style (Stage 5.4.3: Weight + Restrained Cue)
                // ColorLab B -> Blue permitted for active nav.
                if (link.dataset.target === targetId) {
                    link.classList.remove('text-neutral-500', 'border-transparent');
                    link.classList.add('font-bold', 'text-brand-600', 'border-brand-600', 'bg-brand-50');
                }
            });
        }

        // --- MOBILE DRAWER ---
        function initMobileDrawer() {
            const trigger = document.getElementById('mobile-jump-trigger');
            const drawer = document.getElementById('mobile-drawer');
            const scrim = document.getElementById('drawer-scrim');
            const closeBtn = document.getElementById('drawer-close');
            const content = drawer.querySelector('.bg-white'); // The panel

            function open() {
                drawer.classList.remove('translate-x-full');
                scrim.classList.remove('opacity-0');
                document.body.classList.add('drawer-open');
            }

            function close() {
                drawer.classList.add('translate-x-full');
                scrim.classList.add('opacity-0');
                document.body.classList.remove('drawer-open');
            }

            trigger.onclick = open;
            closeBtn.onclick = close;
            scrim.onclick = close;
            window.closeMobileDrawer = close;
        }

        // --- MATH RENDERING ---
        function renderMath() {
            if (window.renderMathInElement) {
                renderMathInElement(document.body, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false}
                    ],
                    throwOnError: false,
                    // Stage 6 KaTeX config
                    strict: false 
                });
            }
        }

    </script>
</body>
</html>
