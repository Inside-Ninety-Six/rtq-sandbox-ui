<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AB","indexWithinVariant":"185","totalWithinVariant":"200","hueFamily":"green","intensityMode":"","timestamp":"2026-01-07T08:40:00.395Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AB&quot;,&quot;indexWithinVariant&quot;:&quot;185&quot;,&quot;totalWithinVariant&quot;:&quot;200&quot;,&quot;hueFamily&quot;:&quot;green&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-07T08:40:00.395Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>
    
    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // ColorLab B: Forced Hue Family "Green"
                        brand: {
                            50: '#f0fdf4',
                            100: '#dcfce7',
                            200: '#bbf7d0',
                            300: '#86efac',
                            400: '#4ade80',
                            500: '#22c55e',
                            600: '#16a34a',
                            700: '#15803d',
                            800: '#166534',
                            900: '#14532d',
                        },
                        // Warm neutral base (Stage 5.3.1)
                        paper: {
                            50: '#fafaf9',
                            100: '#f5f5f4',
                            200: '#e7e5e4',
                            300: '#d6d3d1',
                            400: '#a8a29e',
                            500: '#78716c',
                            600: '#57534e',
                            700: '#44403c',
                            800: '#292524',
                            900: '#1c1917',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'ui-sans-serif', 'system-ui', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <!-- KaTeX CSS (No Integrity) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <style>
        /* Base typography and reset adjustments */
        body {
            background-color: #fafaf9; /* paper-50 */
            color: #1c1917; /* paper-900 */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* 
         * STAGE 6.0.8: KaTeX Containment Invariant
         * Block math overflow protection 
         */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 0.25rem;
            margin-top: 0.5em;
            margin-bottom: 0.5em;
        }
        
        /* Inline math no background (Stage 5.8.4) */
        .katex {
            background-color: transparent !important;
        }

        /* 
         * Markdown Content Styling 
         * Minimal, structural, paper-like.
         */
        .md-content p {
            margin-bottom: 1em;
            line-height: 1.6;
        }
        .md-content p:last-child {
            margin-bottom: 0;
        }
        
        /* Tables (Stage 5.8.5) */
        .md-content table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1em;
            font-size: 0.95em;
        }
        .md-content th, .md-content td {
            border: 1px solid #e7e5e4; /* paper-200 */
            padding: 0.5rem;
            text-align: left;
            vertical-align: top;
        }
        .md-content th {
            font-weight: 600;
            background-color: transparent;
        }
        /* Mobile table scroll wrapper handled in JS/HTML structure if needed, 
           but CSS overflow on container usually sufficient for broad tables */
        
        /* Lists */
        .md-content ul {
            list-style-type: disc;
            padding-left: 1.5em;
            margin-bottom: 1em;
        }
        .md-content ol {
            list-style-type: decimal;
            padding-left: 1.5em;
            margin-bottom: 1em;
        }

        /* 
         * ADD-ON: Scrollable Navigation Without Visible Scrollbars 
         */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Focus States (Stage 5.5.2) - Green accent per ColorLab B */
        *:focus-visible {
            outline: 2px solid #15803d; /* brand-700 */
            outline-offset: 2px;
        }

        /* Interaction Transitions (Stage 5.5.3) */
        .transition-height {
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- 
      STAGE 0: CONSTANTS
      These must be defined in the runtime before logic runs.
    -->
    <script>
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";
        // ColorLab B Hue Parameter: Green (Implemented via Tailwind config above)
    </script>

    <!-- Dependencies -->
    <!-- Markdown-it (No Integrity) -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>
    <!-- KaTeX JS (No Integrity) -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <div id="app" class="flex-1 flex flex-col">
        <!-- Initial Loading State -->
        <div class="flex-1 flex items-center justify-center text-paper-500">
            Loading Paper Viewer...
        </div>
    </div>

    <!-- MAIN APPLICATION LOGIC -->
    <script>
        // --- Markdown renderer (authoritative config) ---
        const md = window.markdownit 
          ? window.markdownit({
              html: true, // allow inline SVG
              linkify: true,
              breaks: false, // MUST stay false
            }) 
          : null;

        if (md) {
          md.inline.ruler.disable(['escape']);
        }

        // --- State ---
        const state = {
            papers: [],
            currentPaper: null,
            loading: true,
            error: false,
            mobileNavOpen: false,
            // Track expanded state per question ID. 
            // Key: paperKey + questionId, Value: boolean
            expanded: new Set()
        };

        // --- DOM Elements ---
        const app = document.getElementById('app');

        // --- Fetch Logic ---
        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Payload not found");
                const data = await response.json();
                
                if (!data.papers || !Array.isArray(data.papers)) {
                    throw new Error("Invalid payload structure");
                }

                state.papers = data.papers;
                if (state.papers.length > 0) {
                    selectPaper(state.papers[0].key);
                }
                state.loading = false;
                render();

            } catch (err) {
                console.error(err);
                state.loading = false;
                state.error = true;
                render();
            }
        }

        // --- Actions ---
        function selectPaper(key) {
            const paper = state.papers.find(p => p.key === key);
            if (!paper) return;
            state.currentPaper = paper;
            
            // Apply defaults
            state.expanded.clear();
            const expandAll = paper.defaults?.expandedAll !== false; // Default true unless false
            
            // Recursive helper to set initial state
            const setDefaults = (nodes) => {
                if (!nodes) return;
                nodes.forEach(node => {
                    if (node.solutionBlock?.solutionDetails) {
                         const idKey = getUniqueId(paper.key, node.id);
                         if (expandAll) state.expanded.add(idKey);
                    }
                    if (node.children) setDefaults(node.children);
                });
            };

            if (paper.questions) setDefaults(paper.questions);
            if (paper.sections) {
                paper.sections.forEach(s => setDefaults(s.questions));
            }
            
            // Close mobile drawer on switch
            state.mobileNavOpen = false;
        }

        function toggleWorking(questionId) {
            const idKey = getUniqueId(state.currentPaper.key, questionId);
            if (state.expanded.has(idKey)) {
                state.expanded.delete(idKey);
            } else {
                state.expanded.add(idKey);
            }
            render(); // Re-render to update UI
        }

        function toggleMobileNav() {
            state.mobileNavOpen = !state.mobileNavOpen;
            render();
        }

        function jumpTo(questionId) {
            const el = document.getElementById(`q-${questionId}`);
            if (el) {
                el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                state.mobileNavOpen = false;
                render();
            }
        }

        // --- Helpers ---
        function getUniqueId(paperKey, qId) {
            return `${paperKey}__${qId}`;
        }

        function renderMarkdown(text) {
            if (!text) return '';
            if (!md) return text; // Fallback
            return md.render(text);
        }

        function renderIcon(type) {
            // Minimal SVG icons
            if (type === 'chevron-down') return `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>`;
            if (type === 'chevron-up') return `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg>`;
            if (type === 'close') return `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>`;
            if (type === 'menu') return `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>`;
            return '';
        }

        // --- Rendering Logic ---

        function render() {
            app.innerHTML = '';

            // Failure Mode
            if (state.error) {
                app.innerHTML = `
                    <div class="flex-1 flex items-center justify-center p-8 text-center">
                        <div>
                            <h1 class="text-xl font-bold text-paper-900 mb-2">PAPERS PAYLOAD MISSING</h1>
                            <p class="text-paper-600">Could not load ${RTQ_PAPERS_PAYLOAD_PATH}</p>
                        </div>
                    </div>
                `;
                return;
            }

            if (state.loading) return;

            // SHELL STRUCTURE
            const shell = document.createElement('div');
            shell.className = "flex flex-col min-h-screen w-full max-w-7xl mx-auto bg-white shadow-sm md:my-8 md:min-h-[calc(100vh-4rem)] md:border md:border-paper-200 md:rounded-sm overflow-hidden";
            
            // Use desktop shell layout: Top Controls + (Nav | Paper)
            // Surfaces: Shared base surface for Nav and Paper on Desktop.
            
            // 1. Top Controls Region
            const topControls = renderTopControls();
            shell.appendChild(topControls);

            // 2. Main Body (Nav + Content)
            const mainBody = document.createElement('div');
            mainBody.className = "flex flex-1 relative overflow-hidden"; // relative for sticky nav context
            
            // Desktop Navigation Rail
            const navRail = renderNavRail();
            mainBody.appendChild(navRail);

            // Paper Content Column
            const paperCol = renderPaperColumn();
            mainBody.appendChild(paperCol);

            shell.appendChild(mainBody);
            
            // Mobile Drawer (Overlay)
            if (state.mobileNavOpen) {
                const drawer = renderMobileDrawer();
                document.body.appendChild(drawer); // Append to body to overlay everything
            } else {
                // Cleanup existing drawer if any
                const existing = document.getElementById('mobile-drawer-portal');
                if (existing) existing.remove();
            }

            app.appendChild(shell);

            // Post-Render: KaTeX Auto-Render
            // We apply this to the whole app or just the paper column
            if (window.renderMathInElement) {
                renderMathInElement(paperCol, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false},
                        {left: '\\(', right: '\\)', display: false},
                        {left: '\\[', right: '\\]', display: true}
                    ],
                    throwOnError: false
                });
            }
        }

        function renderTopControls() {
            const container = document.createElement('div');
            container.className = "sticky top-0 z-20 bg-white/95 backdrop-blur border-b border-paper-200 px-4 h-14 flex items-center justify-between md:px-6";
            
            // Paper Selector
            const selectorWrapper = document.createElement('div');
            selectorWrapper.className = "flex items-center gap-3";
            
            const label = document.createElement('label');
            label.className = "text-xs font-semibold uppercase tracking-wider text-paper-500 hidden sm:block";
            label.innerText = "Paper";
            selectorWrapper.appendChild(label);

            const select = document.createElement('select');
            select.className = "bg-paper-50 border border-paper-300 text-paper-900 text-sm rounded-md py-1.5 px-3 focus:border-brand-500 focus:ring-1 focus:ring-brand-500 outline-none";
            select.onchange = (e) => {
                selectPaper(e.target.value);
                render();
            };

            state.papers.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.key;
                opt.text = p.label;
                opt.selected = state.currentPaper?.key === p.key;
                select.appendChild(opt);
            });
            selectorWrapper.appendChild(select);
            container.appendChild(selectorWrapper);

            // Mobile Jump To Trigger
            const jumpBtn = document.createElement('button');
            jumpBtn.className = "md:hidden flex items-center gap-2 text-brand-700 hover:text-brand-800 font-medium text-sm px-3 py-1.5 rounded hover:bg-brand-50 transition-colors";
            jumpBtn.innerHTML = `<span>Jump to</span> ${renderIcon('menu')}`;
            jumpBtn.onclick = toggleMobileNav;
            container.appendChild(jumpBtn);

            return container;
        }

        function renderNavRail() {
            const nav = document.createElement('aside');
            nav.className = "hidden md:block w-64 flex-shrink-0 border-r border-paper-200 bg-paper-50/50 sticky top-0 h-[calc(100vh-3.5rem)] overflow-y-auto no-scrollbar py-6 pl-6 pr-2";
            
            // Navigation Content
            const list = renderNavList(false);
            nav.appendChild(list);

            return nav;
        }

        function renderMobileDrawer() {
            const portal = document.createElement('div');
            portal.id = 'mobile-drawer-portal';
            portal.className = "fixed inset-0 z-50 flex justify-end";
            
            // Scrim
            const scrim = document.createElement('div');
            scrim.className = "absolute inset-0 bg-paper-900/20 backdrop-blur-sm";
            scrim.onclick = toggleMobileNav;
            portal.appendChild(scrim);

            // Drawer
            const drawer = document.createElement('div');
            drawer.className = "relative w-64 max-w-[80%] bg-white h-full shadow-xl flex flex-col";
            
            // Header
            const header = document.createElement('div');
            header.className = "flex items-center justify-between p-4 border-b border-paper-200";
            const title = document.createElement('h2');
            title.className = "font-medium text-paper-900";
            title.innerText = "Jump to";
            header.appendChild(title);
            
            const closeBtn = document.createElement('button');
            closeBtn.className = "text-paper-500 hover:text-paper-900 p-1";
            closeBtn.innerHTML = renderIcon('close');
            closeBtn.onclick = toggleMobileNav;
            header.appendChild(closeBtn);
            drawer.appendChild(header);

            // List
            const content = document.createElement('div');
            content.className = "flex-1 overflow-y-auto p-4";
            content.appendChild(renderNavList(true));
            drawer.appendChild(content);

            return portal;
        }

        function renderNavList(isMobile) {
            const container = document.createElement('div');
            container.className = "flex flex-col gap-1";

            const p = state.currentPaper;
            if (!p) return container;

            const renderItem = (id, label) => {
                const btn = document.createElement('button');
                // Stage 5.4.3/6.0.2: Weight only, no pills. 
                // ColorLab B: Green text for active nav is allowed by override.
                btn.className = "text-left py-1 px-2 text-sm transition-colors duration-200 rounded select-none w-full truncate ";
                
                // Indentation logic strictly via type scale/opacity per brief? 
                // Brief says "Flat list... hierarchy via type scale/quietness... same left edge".
                // I won't add margin-left. 
                
                // Identify depth loosely by id length/format? 
                // The brief says "Nesting depth... derived ONLY from children[]... used for... permitted subtle type-scale cue".
                // Since I am iterating linearly here for a flat list, I need to know depth.
                // Let's flatten the tree first to generate the list.
                
                btn.innerText = label;
                btn.onclick = () => jumpTo(id);

                return btn;
            };

            const flattenNodes = (nodes, depth = 0) => {
                const items = [];
                nodes.forEach(node => {
                    items.push({ id: node.id, label: node.id, depth });
                    if (node.children) {
                        items.push(...flattenNodes(node.children, depth + 1));
                    }
                });
                return items;
            };

            // Render logic
            if (p.sections) {
                p.sections.forEach((section, index) => {
                    // Section Label (only if not empty)
                    if (section.label && section.label.trim() !== "") {
                        const secHeader = document.createElement('div');
                        secHeader.className = "text-xs font-bold text-paper-400 uppercase tracking-wider mt-4 mb-1 px-2 select-none";
                        secHeader.innerText = section.label;
                        container.appendChild(secHeader);
                    } else if (index > 0) {
                        // Spacing if implicit section
                        const spacer = document.createElement('div');
                        spacer.className = "h-4";
                        container.appendChild(spacer);
                    }

                    const flat = flattenNodes(section.questions);
                    flat.forEach(item => {
                        const btn = renderItem(item.id, item.label);
                        // Hierarchy via opacity/size
                        if (item.depth > 0) {
                            btn.classList.add('text-paper-500', 'font-normal', 'text-xs');
                        } else {
                            btn.classList.add('text-paper-700', 'font-medium');
                        }
                        // Active state logic would go here if we tracked scroll. 
                        // For now just hover styles.
                        btn.classList.add('hover:text-brand-700');
                        container.appendChild(btn);
                    });
                });
            } else if (p.questions) {
                const flat = flattenNodes(p.questions);
                flat.forEach(item => {
                    const btn = renderItem(item.id, item.label);
                    if (item.depth > 0) {
                        btn.classList.add('text-paper-500', 'font-normal', 'text-xs');
                    } else {
                        btn.classList.add('text-paper-700', 'font-medium');
                    }
                    btn.classList.add('hover:text-brand-700');
                    container.appendChild(btn);
                });
            }

            return container;
        }

        function renderPaperColumn() {
            const col = document.createElement('main');
            col.className = "flex-1 min-w-0 bg-white py-8 px-4 md:px-12 lg:px-16 pb-32";
            
            if (!state.currentPaper) return col;

            const p = state.currentPaper;

            if (p.sections) {
                p.sections.forEach((section, idx) => {
                    // Section Header
                    if (section.label && section.label.trim() !== "") {
                        const header = document.createElement('div');
                        header.className = "border-b border-paper-200 pb-2 mb-8 mt-8 first:mt-0";
                        const hTitle = document.createElement('h2');
                        hTitle.className = "text-lg font-bold text-paper-800";
                        hTitle.innerText = `Section ${section.label}`;
                        header.appendChild(hTitle);
                        col.appendChild(header);
                    }
                    
                    // Questions
                    const qList = document.createElement('div');
                    qList.className = "flex flex-col gap-12"; // Top level spacing (Stage 5.1.1.2)
                    section.questions.forEach(q => {
                        qList.appendChild(renderQuestionNode(q, 0));
                    });
                    col.appendChild(qList);
                });
            } else if (p.questions) {
                const qList = document.createElement('div');
                qList.className = "flex flex-col gap-12";
                p.questions.forEach(q => {
                    qList.appendChild(renderQuestionNode(q, 0));
                });
                col.appendChild(qList);
            }

            return col;
        }

        function renderQuestionNode(node, depth) {
            const container = document.createElement('div');
            container.id = `q-${node.id}`;
            container.className = "flex flex-col w-full";
            
            // Hierarchy Spacing: Sub-questions tighter than top level
            if (depth > 0) {
                container.className += " mt-6 pl-4 border-l border-paper-100"; // Indentation via border/padding for visual structure
            }

            // 1. Question Body (Identifier + Prompt)
            const qBody = document.createElement('div');
            qBody.className = "flex gap-4 items-baseline mb-4";
            
            // Identifier
            const qId = document.createElement('span');
            qId.className = "text-paper-500 font-semibold text-sm flex-shrink-0 select-none";
            qId.innerText = node.id;
            qBody.appendChild(qId);
            
            // Prompt
            const qPrompt = document.createElement('div');
            qPrompt.className = "text-paper-900 font-medium text-base leading-relaxed md-content";
            qPrompt.innerHTML = renderMarkdown(node.question);
            qBody.appendChild(qPrompt);

            container.appendChild(qBody);

            // 2. Solution Block (Optional)
            if (node.solutionBlock) {
                const solBlock = document.createElement('div');
                solBlock.className = "ml-0 sm:ml-8 lg:ml-10"; // Align under text roughly

                const sb = node.solutionBlock;
                const hasDetails = !!sb.solutionDetails;
                const hasAnswer = !!sb.answer;

                // Answer
                if (hasAnswer) {
                    const ansRow = document.createElement('div');
                    ansRow.className = "mb-3 text-paper-800";
                    
                    const ansLabel = document.createElement('span');
                    ansLabel.className = "text-xs font-bold uppercase tracking-wide text-paper-500 mr-2";
                    ansLabel.innerText = "Answer";
                    ansRow.appendChild(ansLabel);

                    const ansVal = document.createElement('div');
                    ansVal.className = "inline-block font-medium md-content align-top";
                    ansVal.innerHTML = renderMarkdown(sb.answer);
                    ansRow.appendChild(ansVal);

                    solBlock.appendChild(ansRow);
                }

                // Solution Details
                if (hasDetails) {
                    const idKey = getUniqueId(state.currentPaper.key, node.id);
                    const isExpanded = state.expanded.has(idKey);

                    // Toggle Control
                    const toggleBtn = document.createElement('button');
                    toggleBtn.className = "group flex items-center gap-1.5 text-sm font-medium text-brand-700 hover:text-brand-800 focus:outline-none mb-2 select-none";
                    toggleBtn.onclick = () => toggleWorking(node.id);
                    
                    const icon = document.createElement('span');
                    icon.className = `transition-transform duration-200 ${isExpanded ? 'rotate-180' : ''}`;
                    icon.innerHTML = renderIcon('chevron-down');
                    
                    const label = document.createElement('span');
                    label.className = "group-hover:underline decoration-brand-300 underline-offset-2";
                    label.innerText = isExpanded ? "Hide working" : "Show working";

                    toggleBtn.appendChild(label);
                    toggleBtn.appendChild(icon);
                    solBlock.appendChild(toggleBtn);

                    // Expanded Region
                    if (isExpanded) {
                        const detailsRegion = document.createElement('div');
                        // Stage 5.3.3: Surface differentiation (Optional). 
                        // Using a very subtle wash to distinguish it.
                        // ColorLab B: Can use tint. Let's use a tiny green tint or just neutral.
                        detailsRegion.className = "relative mt-2 p-4 rounded-sm bg-paper-100/50 border-l-2 border-brand-200 text-sm animate-in fade-in slide-in-from-top-1 duration-200";

                        const sd = sb.solutionDetails;

                        // Keep in mind
                        if (sd.keepInMind) {
                            const block = document.createElement('div');
                            block.className = "mb-4";
                            const lbl = document.createElement('div');
                            lbl.className = "text-xs font-bold text-brand-700 mb-1 flex items-center gap-2";
                            lbl.innerText = "Keep in mind";
                            block.appendChild(lbl);
                            
                            const body = document.createElement('div');
                            body.className = "text-paper-700 md-content";
                            body.innerHTML = renderMarkdown(sd.keepInMind);
                            block.appendChild(body);
                            detailsRegion.appendChild(block);
                        }

                        // Formulas used
                        if (sd.formulasUsed) {
                            const block = document.createElement('div');
                            block.className = "mb-4";
                            const lbl = document.createElement('div');
                            lbl.className = "text-xs font-bold text-paper-500 mb-1";
                            lbl.innerText = "Formulas used";
                            block.appendChild(lbl);
                            
                            const body = document.createElement('div');
                            body.className = "text-paper-600 md-content font-mono text-xs"; // Monospaced feel for formulas list
                            body.innerHTML = renderMarkdown(sd.formulasUsed);
                            block.appendChild(body);
                            detailsRegion.appendChild(block);
                        }

                        // Working
                        if (sd.working) {
                            const block = document.createElement('div');
                            block.className = "mb-4";
                            const lbl = document.createElement('div');
                            lbl.className = "text-xs font-bold text-paper-900 mb-1";
                            lbl.innerText = "Working";
                            block.appendChild(lbl);
                            
                            const body = document.createElement('div');
                            body.className = "text-paper-900 md-content";
                            body.innerHTML = renderMarkdown(sd.working);
                            block.appendChild(body);
                            detailsRegion.appendChild(block);
                        }

                        // Alternative working
                        if (sd.alternativeWorking && Array.isArray(sd.alternativeWorking)) {
                            sd.alternativeWorking.forEach((alt, idx) => {
                                // Separator
                                const sep = document.createElement('hr');
                                sep.className = "border-paper-200 my-4";
                                detailsRegion.appendChild(sep);

                                const block = document.createElement('div');
                                block.className = "mb-4";
                                const lbl = document.createElement('div');
                                lbl.className = "text-xs font-bold text-paper-500 mb-1";
                                lbl.innerText = "Alternative working";
                                block.appendChild(lbl);
                                
                                const body = document.createElement('div');
                                body.className = "text-paper-800 md-content";
                                body.innerHTML = renderMarkdown(alt);
                                block.appendChild(body);
                                detailsRegion.appendChild(block);
                            });
                        }

                        solBlock.appendChild(detailsRegion);
                    }
                }
                container.appendChild(solBlock);
            }

            // 3. Children (Recursive)
            if (node.children && node.children.length > 0) {
                const childrenContainer = document.createElement('div');
                childrenContainer.className = "flex flex-col mt-4";
                node.children.forEach(child => {
                    childrenContainer.appendChild(renderQuestionNode(child, depth + 1));
                });
                container.appendChild(childrenContainer);
            }

            return container;
        }

        // --- Init ---
        init();

    </script>
</body>
</html>
