<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"A","indexWithinVariant":"15","totalWithinVariant":"50","hueFamily":"","intensityMode":"","timestamp":"2026-01-06T18:02:31.827Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;A&quot;,&quot;indexWithinVariant&quot;:&quot;15&quot;,&quot;totalWithinVariant&quot;:&quot;50&quot;,&quot;hueFamily&quot;:&quot;&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-06T18:02:31.827Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ â€“ Maths Paper Solution Viewer</title>

    <!-- Typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- KaTeX CSS (No integrity) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <style>
        /* =========================================
           STAGE 0-6 COMPLIANT CSS
           ColorLab A Add-on Active (Palette Freedom)
           ========================================= */

        :root {
            /* Palette - Light Mode Only (ColorLab A) */
            --color-bg-page: #ffffff;
            --color-bg-subtle: #f8fafc; /* Very subtle surface */
            --color-text-primary: #1e293b; /* Deep slate */
            --color-text-secondary: #475569; /* Slate */
            --color-text-tertiary: #94a3b8; /* Light slate for quiet nav */
            --color-accent: #4f46e5; /* Indigo */
            --color-accent-hover: #4338ca;
            --color-border-hairline: #e2e8f0;
            --color-focus-ring: rgba(79, 70, 229, 0.4);

            /* Typography */
            --font-family: 'Inter', sans-serif;
            --font-size-base: 16px;
            --font-size-sm: 14px;
            --font-size-xs: 12px;
            --font-size-lg: 18px;
            --line-height-relaxed: 1.6;
            --line-height-snug: 1.4;

            /* Spacing (Rhythm) */
            --space-xs: 4px;
            --space-sm: 8px;
            --space-md: 16px;
            --space-lg: 24px;
            --space-xl: 32px;
            --space-2xl: 48px;
            --space-3xl: 64px;

            /* Layout */
            --width-content-max: 800px;
            --width-nav-rail: 240px;
            --header-height: 60px;
            --z-header: 50;
            --z-drawer: 100;
        }

        /* Reset & Base */
        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: var(--font-family);
            background-color: var(--color-bg-page);
            color: var(--color-text-primary);
            line-height: var(--line-height-relaxed);
            -webkit-font-smoothing: antialiased;
        }

        button {
            font-family: inherit;
            border: none;
            background: none;
            cursor: pointer;
            padding: 0;
        }

        a {
            color: var(--color-accent);
            text-decoration: none;
        }
        
        a:hover {
            text-decoration: underline;
        }

        /* Accessibility Focus */
        :focus-visible {
            outline: 2px solid var(--color-accent);
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* =========================================
           LAYOUT SHELL
           ========================================= */

        .app-shell {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Top Controls Region */
        .top-controls {
            height: var(--header-height);
            border-bottom: 1px solid var(--color-border-hairline);
            background-color: var(--color-bg-page);
            display: flex;
            align-items: center;
            padding: 0 var(--space-lg);
            position: sticky;
            top: 0;
            z-index: var(--z-header);
            /* Align strictly with DocumentFrameShell max width */
            justify-content: center;
        }

        .top-controls__inner {
            width: 100%;
            max-width: calc(var(--width-nav-rail) + var(--width-content-max) + var(--space-xl));
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .paper-selector {
            font-size: var(--font-size-sm);
            padding: var(--space-sm);
            border: 1px solid var(--color-border-hairline);
            border-radius: 4px;
            background-color: var(--color-bg-page);
            color: var(--color-text-primary);
        }

        .mobile-jump-trigger {
            display: none; /* Desktop default */
            font-size: var(--font-size-sm);
            font-weight: 500;
            color: var(--color-accent);
            align-items: center;
            gap: var(--space-xs);
        }

        /* DocumentFrameShell */
        .document-frame-shell {
            flex: 1;
            display: flex;
            justify-content: center;
            width: 100%;
        }

        .document-frame-shell__inner {
            display: flex;
            width: 100%;
            max-width: calc(var(--width-nav-rail) + var(--width-content-max) + var(--space-xl));
            padding: 0 var(--space-lg);
        }

        /* Navigation Rail (Desktop) */
        .nav-rail {
            width: var(--width-nav-rail);
            flex-shrink: 0;
            padding-top: var(--space-xl);
            /* Sticky Logic */
            position: sticky;
            top: var(--header-height);
            height: calc(100vh - var(--header-height));
            overflow-y: auto;
            /* Scrollbar hiding */
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .nav-rail::-webkit-scrollbar {
            display: none;
        }

        /* Paper Content Column */
        .paper-column {
            flex: 1;
            padding-top: var(--space-xl);
            padding-left: var(--space-xl);
            padding-bottom: var(--space-3xl);
            max-width: var(--width-content-max);
        }

        /* =========================================
           NAVIGATION STYLES
           ========================================= */
        
        .nav-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .nav-section-label {
            font-size: var(--font-size-xs);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--color-text-tertiary);
            font-weight: 600;
            margin-top: var(--space-md);
            margin-bottom: var(--space-xs);
            padding-left: var(--space-sm);
            cursor: default;
        }
        
        .nav-section-label:first-child {
            margin-top: 0;
        }

        .nav-item {
            display: block;
            padding: var(--space-xs) var(--space-sm);
            color: var(--color-text-secondary);
            font-size: var(--font-size-sm);
            border-radius: 4px;
            transition: color 0.2s, background-color 0.2s;
            cursor: pointer;
            /* Flat list - no indentation */
        }

        .nav-item:hover {
            color: var(--color-text-primary);
            background-color: var(--color-bg-subtle);
        }

        .nav-item.is-active {
            color: var(--color-accent);
            font-weight: 600;
            background-color: rgba(79, 70, 229, 0.05);
        }

        /* Hierarchy via type scale (Stage 5.4.5) */
        .nav-item--depth-0 { font-size: var(--font-size-sm); }
        .nav-item--depth-1 { font-size: 13px; color: var(--color-text-secondary); }
        .nav-item--depth-2 { font-size: 12px; color: var(--color-text-tertiary); }

        /* =========================================
           PAPER CONTENT
           ========================================= */

        .paper-error {
            padding: var(--space-2xl);
            text-align: center;
            color: var(--color-text-secondary);
            font-weight: 500;
        }

        .section-header {
            font-size: var(--font-size-lg);
            font-weight: 600;
            color: var(--color-text-secondary);
            margin-top: var(--space-3xl);
            margin-bottom: var(--space-lg);
            padding-bottom: var(--space-sm);
            border-bottom: 1px solid var(--color-border-hairline);
        }
        .section-header:first-child {
            margin-top: 0;
        }

        /* Question Node */
        .question-node {
            margin-bottom: var(--space-3xl); /* Largest spacing unit */
            scroll-margin-top: calc(var(--header-height) + var(--space-md));
        }

        .question-node__body {
            /* Question Body always visible */
        }

        .question-identifier {
            font-weight: 600;
            color: var(--color-text-secondary);
            margin-right: var(--space-xs);
            float: left; /* Keep id with text */
        }

        .question-prompt {
            color: var(--color-text-primary);
            font-size: var(--font-size-base);
        }
        
        .question-prompt p {
            margin-top: 0;
            margin-bottom: var(--space-md);
        }
        .question-prompt p:last-child {
            margin-bottom: 0;
        }

        /* Solution Block */
        .solution-block {
            margin-top: var(--space-md);
            padding-left: var(--space-md); /* Quiet visual subordination */
            border-left: 1px solid var(--color-border-hairline); /* Minimal demarcation permitted */
        }

        /* Answer */
        .answer-region {
            margin-bottom: var(--space-md);
        }

        .answer-label {
            font-size: var(--font-size-xs);
            font-weight: 600;
            color: var(--color-text-secondary);
            text-transform: uppercase;
            display: block;
            margin-bottom: var(--space-xs);
        }

        .answer-content {
            font-weight: 500;
            color: var(--color-text-primary);
        }

        /* Solution Details (Expandable) */
        .solution-details-control {
            display: inline-flex;
            align-items: center;
            gap: var(--space-xs);
            font-size: var(--font-size-sm);
            color: var(--color-accent);
            font-weight: 500;
            padding: var(--space-xs) 0;
        }
        
        .solution-details-control:hover {
            color: var(--color-accent-hover);
            text-decoration: underline;
        }

        .icon-chevron {
            width: 16px;
            height: 16px;
            transition: transform 0.2s ease;
        }
        .solution-details-control[aria-expanded="true"] .icon-chevron {
            transform: rotate(180deg);
        }

        .solution-details-region {
            margin-top: var(--space-md);
            display: none;
            /* Transition handled via simple display toggle for prototype, 
               could upgrade to grid animation, but display is robust. */
        }
        .solution-details-region.is-expanded {
            display: block;
            animation: fadeIn 0.2s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-4px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .solution-details-content {
            /* Subordinate typography */
            font-size: var(--font-size-base);
            color: var(--color-text-secondary);
        }

        /* Subsections: Keep in mind, Formulas, Working */
        .sd-subsection {
            margin-bottom: var(--space-lg);
        }
        .sd-subsection:last-child {
            margin-bottom: 0;
        }

        .sd-label {
            font-size: var(--font-size-xs);
            font-weight: 600;
            color: var(--color-text-tertiary);
            text-transform: uppercase;
            margin-bottom: var(--space-xs);
            display: block;
        }

        .keep-in-mind {
            /* Slightly distinguishable */
        }
        .keep-in-mind ul {
            margin: 0;
            padding-left: var(--space-lg);
            list-style-type: disc;
        }

        .formulas-used {
            /* Compact list */
        }
        .formulas-used ul {
            margin: 0;
            padding-left: var(--space-lg);
        }

        .working-block {
            /* Standard working */
        }

        .alt-working-block {
            margin-top: var(--space-lg);
            padding-top: var(--space-lg);
            border-top: 1px dashed var(--color-border-hairline); /* Quiet internal separator */
        }

        /* Child Questions */
        .children-container {
            margin-top: var(--space-lg);
            padding-left: var(--space-lg); /* Indentation */
        }

        /* =========================================
           MATH & TABLES (KaTeX & Markdown)
           ========================================= */

        /* KaTeX Containment Invariant */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding: var(--space-xs) 0;
            /* Block math underlay permitted but keep minimal/transparent per rules,
               or very subtle wash. Let's keep transparent as per explicit "Inline KaTeX background rule".
               Display math CAN have background. Let's add very subtle wash for block math to help separation. */
            background-color: rgba(0,0,0,0.015); 
            border-radius: 4px;
            padding: var(--space-sm);
        }
        
        /* Hide scrollbars on math */
        .katex-display::-webkit-scrollbar {
            display: none;
        }
        .katex-display {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Inline math: transparent background always */
        .katex {
            background-color: transparent !important;
        }

        /* Markdown Elements */
        .md-content p {
            margin-bottom: var(--space-sm);
        }
        .md-content p:last-child {
            margin-bottom: 0;
        }
        
        /* Tables */
        .md-content table {
            width: 100%;
            border-collapse: collapse;
            font-size: var(--font-size-sm);
            margin: var(--space-md) 0;
            display: block;
            overflow-x: auto;
        }
        .md-content th, .md-content td {
            border: 1px solid var(--color-border-hairline);
            padding: var(--space-sm);
            text-align: left;
        }
        .md-content th {
            background-color: var(--color-bg-subtle);
            font-weight: 600;
        }

        /* Inline SVG support (passthrough) */
        svg {
            max-width: 100%;
            height: auto;
        }

        /* =========================================
           MOBILE DRAWER
           ========================================= */
        
        .drawer-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.4);
            z-index: var(--z-drawer);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }
        
        .drawer {
            position: fixed;
            top: 0;
            right: 0; /* Right side drawer often standard, brief says 'drawer'. Left or Right? Left is safer for nav. */
            left: 0;
            bottom: 0;
            width: 280px;
            background-color: var(--color-bg-page);
            transform: translateX(-100%);
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            z-index: var(--z-drawer) + 1;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--color-border-hairline);
        }

        .drawer-visible .drawer-overlay {
            opacity: 1;
            pointer-events: auto;
        }
        
        .drawer-visible .drawer {
            transform: translateX(0);
        }

        .drawer-header {
            height: var(--header-height);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 var(--space-lg);
            border-bottom: 1px solid var(--color-border-hairline);
        }

        .drawer-title {
            font-weight: 600;
            font-size: var(--font-size-lg);
        }

        .drawer-close {
            font-size: 24px;
            color: var(--color-text-secondary);
        }

        .drawer-content {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-lg);
        }

        /* =========================================
           RESPONSIVE
           ========================================= */

        @media (max-width: 768px) {
            .nav-rail {
                display: none; /* Hide sticky rail on mobile */
            }
            .mobile-jump-trigger {
                display: flex; /* Show jump button */
            }
            .paper-column {
                padding-left: 0;
            }
            .document-frame-shell__inner {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>

    <!-- Runtime Payload Path Constant (Authoritative) -->
    <script>
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";
    </script>

    <!-- Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <div class="app-shell">
        <!-- Top Controls -->
        <header class="top-controls">
            <div class="top-controls__inner">
                <select id="paperSelector" class="paper-selector" aria-label="Select Paper">
                    <option value="" disabled selected>Loading papers...</option>
                </select>
                
                <button id="mobileJumpTrigger" class="mobile-jump-trigger">
                    <span>Jump to</span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="3" y1="12" x2="21" y2="12"></line>
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <line x1="3" y1="18" x2="21" y2="18"></line>
                    </svg>
                </button>
            </div>
        </header>

        <!-- Main Document Frame -->
        <main class="document-frame-shell">
            <div class="document-frame-shell__inner">
                
                <!-- Desktop Navigation Rail -->
                <nav class="nav-rail" aria-label="Desktop Navigation">
                    <div id="desktopNavContainer">
                        <!-- Nav items injected here -->
                    </div>
                </nav>

                <!-- Paper Content -->
                <div class="paper-column">
                    <div id="paperContent" class="paper-content">
                        <!-- Paper Content injected here -->
                        <div class="paper-error">Select a paper to begin.</div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Mobile Drawer -->
    <div id="mobileDrawerOverlay" class="drawer-overlay"></div>
    <div id="mobileDrawer" class="drawer" aria-hidden="true">
        <div class="drawer-header">
            <span class="drawer-title">Jump to</span>
            <button id="drawerClose" class="drawer-close" aria-label="Close navigation">&times;</button>
        </div>
        <div class="drawer-content" id="mobileNavContainer">
            <!-- Nav items injected here -->
        </div>
    </div>

    <script>
        /**
         * RTQ - Maths Paper Solution Viewer - Stage 6 Prototype
         * Pure Vanilla JS implementation.
         */

        // --- State ---
        let state = {
            papers: [],
            activePaperKey: null,
            expandedMap: {} // { questionId: boolean } - tracks local toggle state override
        };

        // --- Markdown Renderer Config ---
        const md = window.markdownit ? window.markdownit({
            html: true,
            linkify: true,
            breaks: false // REQUIRED: prevents <br> in math
        }) : null;

        if (md) {
            md.inline.ruler.disable(['escape']); // REQUIRED: preserve TeX backslashes
        }

        // --- DOM Elements ---
        const els = {
            paperSelector: document.getElementById('paperSelector'),
            paperContent: document.getElementById('paperContent'),
            desktopNav: document.getElementById('desktopNavContainer'),
            mobileNav: document.getElementById('mobileNavContainer'),
            mobileJumpTrigger: document.getElementById('mobileJumpTrigger'),
            mobileDrawer: document.getElementById('mobileDrawer'),
            mobileDrawerOverlay: document.getElementById('mobileDrawerOverlay'),
            drawerClose: document.getElementById('drawerClose'),
            appShell: document.querySelector('.app-shell')
        };

        // --- Initialization ---
        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error('Failed to load payload');
                const payload = await response.json();
                
                state.papers = payload.papers || [];
                
                if (state.papers.length === 0) {
                    throw new Error('No papers in payload');
                }

                renderSelector();
                
                // Select first paper by default
                loadPaper(state.papers[0].key);

            } catch (err) {
                console.error(err);
                els.paperContent.innerHTML = `<div class="paper-error">PAPERS PAYLOAD MISSING</div>`;
                els.paperSelector.innerHTML = '<option disabled>Error loading papers</option>';
            }

            setupEventHandlers();
        }

        function renderSelector() {
            els.paperSelector.innerHTML = state.papers.map(p => 
                `<option value="${p.key}">${p.label}</option>`
            ).join('');
        }

        function loadPaper(key) {
            const paper = state.papers.find(p => p.key === key);
            if (!paper) return;

            state.activePaperKey = key;
            state.expandedMap = {}; // Reset toggle states on paper switch

            // Scroll to top
            window.scrollTo(0, 0);

            // Determine Content (Flat vs Sectioned)
            let nodesHtml = '';
            let navItems = []; // { id, label, depth, isSectionLabel }

            if (paper.sections) {
                paper.sections.forEach(section => {
                    // 1. Render Section Header (if label exists)
                    if (section.label && section.label.trim() !== "") {
                        nodesHtml += `<div class="section-header">${section.label}</div>`;
                        navItems.push({ id: null, label: section.label, isSectionLabel: true });
                    }
                    // 2. Render Questions
                    if (section.questions) {
                        section.questions.forEach(q => {
                            nodesHtml += renderQuestionNode(q, 0, paper.defaults);
                            collectNavItems(q, 0, navItems);
                        });
                    }
                });
            } else if (paper.questions) {
                paper.questions.forEach(q => {
                    nodesHtml += renderQuestionNode(q, 0, paper.defaults);
                    collectNavItems(q, 0, navItems);
                });
            }

            // Inject Content
            els.paperContent.innerHTML = nodesHtml;

            // Build Nav
            const navHtml = renderNavList(navItems);
            els.desktopNav.innerHTML = navHtml;
            els.mobileNav.innerHTML = navHtml;

            // Render Math
            renderMath();
        }

        // --- Content Rendering ---

        function renderMarkdown(text) {
            if (!text) return '';
            if (!md) return text; // Fallback
            return md.render(text);
        }

        function renderQuestionNode(node, depth, defaults) {
            const indentClass = depth > 0 ? 'children-container' : '';
            const nodeID = `q-${node.id.replace(/[^a-zA-Z0-9]/g, '-')}`;
            
            // Default Expand Logic
            const expandedAll = defaults && defaults.expandedAll !== undefined ? defaults.expandedAll : true;
            
            // Build Question Body
            let html = `
                <div id="${nodeID}" class="question-node" data-id="${node.id}">
                    <div class="question-node__body">
                        <div class="question-identifier">${node.id}</div>
                        <div class="question-prompt md-content">${renderMarkdown(node.question)}</div>
                    </div>
            `;

            // Solution Block
            if (node.solutionBlock) {
                html += `<div class="solution-block">`;
                
                // Answer
                if (node.solutionBlock.answer) {
                    html += `
                        <div class="answer-region">
                            <span class="answer-label">Answer</span>
                            <div class="answer-content md-content">${renderMarkdown(node.solutionBlock.answer)}</div>
                        </div>
                    `;
                }

                // Solution Details
                const sd = node.solutionBlock.solutionDetails;
                if (sd) {
                    const isExpanded = expandedAll; // Initial render state
                    const ariaExpanded = isExpanded ? "true" : "false";
                    const regionClass = isExpanded ? "solution-details-region is-expanded" : "solution-details-region";

                    html += `
                        <button class="solution-details-control" aria-expanded="${ariaExpanded}" aria-controls="${nodeID}-sd">
                            <span class="control-text">${isExpanded ? 'Hide working' : 'Show working'}</span>
                            <svg class="icon-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                        </button>
                        <div id="${nodeID}-sd" class="${regionClass}">
                            <div class="solution-details-content">
                                ${renderSolutionDetailsContent(sd)}
                            </div>
                        </div>
                    `;
                }

                html += `</div>`; // End solution-block
            }

            // Children
            if (node.children && node.children.length > 0) {
                html += `<div class="${indentClass}">`;
                node.children.forEach(child => {
                    html += renderQuestionNode(child, depth + 1, defaults);
                });
                html += `</div>`;
            }

            html += `</div>`; // End question-node
            return html;
        }

        function renderSolutionDetailsContent(sd) {
            let html = '';

            if (sd.keepInMind) {
                html += `
                    <div class="sd-subsection keep-in-mind">
                        <span class="sd-label">Keep in mind</span>
                        <div class="md-content">${renderMarkdown(sd.keepInMind)}</div>
                    </div>
                `;
            }

            if (sd.formulasUsed) {
                html += `
                    <div class="sd-subsection formulas-used">
                        <span class="sd-label">Formulas used</span>
                        <div class="md-content">${renderMarkdown(sd.formulasUsed)}</div>
                    </div>
                `;
            }

            if (sd.working) {
                html += `
                    <div class="sd-subsection working-block">
                        <span class="sd-label">Working</span>
                        <div class="md-content">${renderMarkdown(sd.working)}</div>
                    </div>
                `;
            }

            if (sd.alternativeWorking && Array.isArray(sd.alternativeWorking)) {
                sd.alternativeWorking.forEach(alt => {
                    html += `
                        <div class="sd-subsection alt-working-block">
                            <span class="sd-label">Alternative working</span>
                            <div class="md-content">${renderMarkdown(alt)}</div>
                        </div>
                    `;
                });
            }

            return html;
        }

        // --- Navigation Logic ---

        function collectNavItems(node, depth, list) {
            list.push({ 
                id: node.id, 
                targetId: `q-${node.id.replace(/[^a-zA-Z0-9]/g, '-')}`, 
                depth: depth,
                isSectionLabel: false 
            });
            if (node.children) {
                node.children.forEach(c => collectNavItems(c, depth + 1, list));
            }
        }

        function renderNavList(items) {
            return `<ul class="nav-list">` + items.map(item => {
                if (item.isSectionLabel) {
                    return `<li class="nav-section-label">${item.label}</li>`;
                }
                // Cap depth class at 2 for styling logic
                const depthClass = `nav-item--depth-${Math.min(item.depth, 2)}`;
                return `<li><a class="nav-item ${depthClass}" data-target="${item.targetId}">${item.id}</a></li>`;
            }).join('') + `</ul>`;
        }

        // --- Math Rendering ---
        function renderMath() {
            if (window.renderMathInElement) {
                renderMathInElement(els.paperContent, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false}
                    ],
                    throwOnError: false
                });
            }
        }

        // --- Interaction Handlers ---

        function setupEventHandlers() {
            // Paper Switch
            els.paperSelector.addEventListener('change', (e) => {
                loadPaper(e.target.value);
            });

            // Expand/Collapse Delegation
            els.paperContent.addEventListener('click', (e) => {
                const btn = e.target.closest('.solution-details-control');
                if (btn) {
                    const isExpanded = btn.getAttribute('aria-expanded') === 'true';
                    const newState = !isExpanded;
                    
                    btn.setAttribute('aria-expanded', newState);
                    const textSpan = btn.querySelector('.control-text');
                    if (textSpan) textSpan.textContent = newState ? 'Hide working' : 'Show working';
                    
                    const regionId = btn.getAttribute('aria-controls');
                    const region = document.getElementById(regionId);
                    if (region) {
                        region.classList.toggle('is-expanded', newState);
                    }
                }
            });

            // Navigation Delegation (Desktop & Mobile)
            const handleNavClick = (e) => {
                const link = e.target.closest('.nav-item');
                if (link) {
                    const targetId = link.getAttribute('data-target');
                    const targetEl = document.getElementById(targetId);
                    if (targetEl) {
                        // Scroll logic
                        const headerOffset = 80; // approximate
                        const elementPosition = targetEl.getBoundingClientRect().top;
                        const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
                        
                        window.scrollTo({
                            top: offsetPosition,
                            behavior: "smooth"
                        });

                        // Set Active State manually for immediate feedback
                        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('is-active'));
                        // Select both desktop and mobile links corresponding to this target
                        document.querySelectorAll(`.nav-item[data-target="${targetId}"]`).forEach(el => el.classList.add('is-active'));

                        // Close mobile drawer if open
                        closeDrawer();
                    }
                }
            };

            els.desktopNav.addEventListener('click', handleNavClick);
            els.mobileNav.addEventListener('click', handleNavClick);

            // Mobile Drawer
            els.mobileJumpTrigger.addEventListener('click', openDrawer);
            els.drawerClose.addEventListener('click', closeDrawer);
            els.mobileDrawerOverlay.addEventListener('click', closeDrawer);

            // Intersection Observer for Scrolling Active State
            setupScrollSpy();
        }

        function openDrawer() {
            els.mobileDrawer.classList.remove('drawer-hidden');
            els.mobileDrawer.setAttribute('aria-hidden', 'false');
            document.body.classList.add('drawer-visible'); // CSS handles transform
        }

        function closeDrawer() {
            document.body.classList.remove('drawer-visible');
            els.mobileDrawer.setAttribute('aria-hidden', 'true');
        }

        function setupScrollSpy() {
            const observerOptions = {
                root: null,
                rootMargin: '-10% 0px -80% 0px', // Active when element hits top 10-20%
                threshold: 0
            };

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const id = entry.target.id;
                        // Find nav items pointing to this id
                        // But wait, ids are `q-...`
                        // data-target in nav matches this id
                        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('is-active'));
                        document.querySelectorAll(`.nav-item[data-target="${id}"]`).forEach(el => el.classList.add('is-active'));
                    }
                });
            }, observerOptions);

            // Observe all question nodes on render
            // Re-attach observer in loadPaper or use MutationObserver.
            // For prototype simplicity, we'll re-run observation in loadPaper if needed, 
            // but since loadPaper wipes DOM, we need to observe newly created elements.
            // Let's hook into loadPaper.
            
            // Hooking Intersection Observer re-attachment into loadPaper flow:
            const originalLoadPaper = loadPaper;
            loadPaper = function(key) {
                originalLoadPaper(key);
                // Re-observe
                document.querySelectorAll('.question-node').forEach(node => observer.observe(node));
            };
        }

        // Run
        init();

    </script>
</body>
</html>
