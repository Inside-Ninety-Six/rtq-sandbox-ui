<!DOCTYPE html>
<html lang="en" class="light">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AB","indexWithinVariant":"130","totalWithinVariant":"200","hueFamily":"blue","intensityMode":"","timestamp":"2026-01-07T06:12:21.950Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AB&quot;,&quot;indexWithinVariant&quot;:&quot;130&quot;,&quot;totalWithinVariant&quot;:&quot;200&quot;,&quot;hueFamily&quot;:&quot;blue&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-07T06:12:21.950Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- KaTeX CSS (No SRI per instructions) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <!-- Tailwind CSS (via CDN for prototype) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // ColorLab B: Forced Hue Family = BLUE
        // Using Tailwind's 'blue' for accents and 'slate' for neutrals to maintain paper feel
        tailwind.config = {
            darkMode: 'class', // Light mode only enforced by logic
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        border: "hsl(var(--border))",
                        input: "hsl(var(--input))",
                        ring: "hsl(var(--ring))",
                        background: "hsl(var(--background))",
                        foreground: "hsl(var(--foreground))",
                        primary: {
                            DEFAULT: "hsl(var(--primary))",
                            foreground: "hsl(var(--primary-foreground))",
                        },
                        secondary: {
                            DEFAULT: "hsl(var(--secondary))",
                            foreground: "hsl(var(--secondary-foreground))",
                        },
                        muted: {
                            DEFAULT: "hsl(var(--muted))",
                            foreground: "hsl(var(--muted-foreground))",
                        },
                        accent: {
                            DEFAULT: "hsl(var(--accent))",
                            foreground: "hsl(var(--accent-foreground))",
                        },
                        popover: {
                            DEFAULT: "hsl(var(--popover))",
                            foreground: "hsl(var(--popover-foreground))",
                        },
                        card: {
                            DEFAULT: "hsl(var(--card))",
                            foreground: "hsl(var(--card-foreground))",
                        },
                    },
                    borderRadius: {
                        lg: "var(--radius)",
                        md: "calc(var(--radius) - 2px)",
                        sm: "calc(var(--radius) - 4px)",
                    },
                }
            }
        }
    </script>

    <style>
        /* CSS Variables - Blue Lab Palette */
        :root {
            /* Base Surface: White / Light Slate */
            --background: 0 0% 100%;
            --foreground: 222 47% 11%;

            /* Muted Surfaces (Navigation, Dividing lines) */
            --muted: 210 40% 96.1%;
            --muted-foreground: 215.4 16.3% 46.9%;

            /* Borders */
            --border: 214.3 31.8% 91.4%;
            --input: 214.3 31.8% 91.4%;

            /* Primary (Accents - Blue) */
            --primary: 221.2 83.2% 53.3%; /* Blue-600 */
            --primary-foreground: 210 40% 98%;

            /* Secondary */
            --secondary: 210 40% 96.1%;
            --secondary-foreground: 222.2 47.4% 11.2%;

            /* Accent (Focus, Active states) */
            --accent: 210 40% 96.1%;
            --accent-foreground: 222.2 47.4% 11.2%;

            /* Radius */
            --radius: 0.5rem;

            /* Ring for focus */
            --ring: 221.2 83.2% 53.3%;
        }

        body {
            background-color: var(--background);
            color: var(--foreground);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Nav Scrollbar hiding */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* KaTeX Overflow & Background Rules */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            padding: 0.5em 0;
            max-width: 100%;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Inline KaTeX must have transparent background */
        .katex {
            background-color: transparent !important;
        }

        /* Markdown Content Styling */
        .markdown-body p {
            margin-bottom: 0.75em;
            line-height: 1.6;
        }
        .markdown-body p:last-child {
            margin-bottom: 0;
        }
        .markdown-body ul {
            list-style-type: disc;
            padding-left: 1.5em;
            margin-bottom: 0.75em;
        }
        .markdown-body ol {
            list-style-type: decimal;
            padding-left: 1.5em;
            margin-bottom: 0.75em;
        }
        .markdown-body table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1em;
            font-size: 0.95em;
        }
        .markdown-body th, .markdown-body td {
            border: 1px solid hsl(var(--border));
            padding: 0.5em;
            text-align: left;
        }
        .markdown-body th {
            font-weight: 600;
            background-color: hsl(var(--muted) / 0.3);
        }
        
        /* Layout Utilities */
        .sticky-nav {
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
        }
        
        /* Mobile Drawer Transitions */
        .drawer-backdrop {
            transition: opacity 0.3s ease;
        }
        .drawer-panel {
            transition: transform 0.3s ease;
        }
        .drawer-open .drawer-backdrop {
            opacity: 1;
            pointer-events: auto;
        }
        .drawer-open .drawer-panel {
            transform: translateX(0);
        }
        .drawer-closed .drawer-backdrop {
            opacity: 0;
            pointer-events: none;
        }
        .drawer-closed .drawer-panel {
            transform: translateX(-100%);
        }

        /* Focus styles */
        *:focus-visible {
            outline: 2px solid hsl(var(--ring));
            outline-offset: 2px;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col lg:flex-row">

    <!-- Mobile Header -->
    <header class="lg:hidden sticky top-0 z-40 w-full border-b bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60">
        <div class="container flex h-14 items-center gap-4 px-4">
            <button id="mobile-menu-trigger" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 hover:bg-accent hover:text-accent-foreground h-10 w-10 -ml-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>
                <span class="sr-only">Jump to</span>
            </button>
            <div class="flex-1" id="mobile-paper-selector-container">
                <!-- Mobile Paper Selector Mount -->
            </div>
        </div>
    </header>

    <!-- Mobile Navigation Drawer -->
    <div id="mobile-drawer" class="fixed inset-0 z-50 flex lg:hidden drawer-closed">
        <div id="drawer-backdrop" class="drawer-backdrop fixed inset-0 bg-black/80"></div>
        <div class="drawer-panel fixed inset-y-0 left-0 z-50 w-3/4 max-w-sm border-r bg-background shadow-lg p-6 overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-lg font-semibold tracking-tight">Jump to</h2>
                <button id="drawer-close" class="rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                    <span class="sr-only">Close</span>
                </button>
            </div>
            <nav id="mobile-nav-list" class="space-y-1">
                <!-- Mobile Nav Items Generated Here -->
            </nav>
        </div>
    </div>

    <!-- Desktop Sidebar -->
    <aside class="hidden lg:block w-[280px] border-r bg-background sticky-nav no-scrollbar flex-shrink-0">
        <div class="p-6 space-y-6">
            <div id="desktop-paper-selector-container">
                <!-- Desktop Paper Selector Mount -->
            </div>
            
            <nav id="desktop-nav-list" class="space-y-1 w-full text-sm">
                <!-- Desktop Nav Items Generated Here -->
            </nav>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 relative">
        <div class="mx-auto max-w-3xl p-6 lg:p-12 space-y-12 pb-32" id="paper-content">
            <div class="flex items-center justify-center h-64 text-muted-foreground animate-pulse">
                Loading paper content...
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <!-- Markdown-it -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>
    <!-- KaTeX JS (No SRI) -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <script>
        // --- STAGE 0: CONSTANTS ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // --- MARKDOWN RENDERER CONFIG (Authoritative) ---
        const md = window.markdownit ? window.markdownit({
            html: true, // Allow inline SVG
            linkify: true,
            breaks: false // MUST be false
        }) : null;

        if (md) {
            // Disable escape rule to preserve TeX backslashes
            md.inline.ruler.disable(['escape']);
        }

        // --- APP STATE ---
        let payload = null;
        let currentPaperKey = null;
        let currentPaper = null;
        let expandedStates = {}; // key: questionId -> boolean

        // --- DOM ELEMENTS ---
        const paperContentEl = document.getElementById('paper-content');
        const desktopNavEl = document.getElementById('desktop-nav-list');
        const mobileNavEl = document.getElementById('mobile-nav-list');
        const desktopSelectorContainer = document.getElementById('desktop-paper-selector-container');
        const mobileSelectorContainer = document.getElementById('mobile-paper-selector-container');
        const mobileDrawerTrigger = document.getElementById('mobile-menu-trigger');
        const mobileDrawerClose = document.getElementById('drawer-close');
        const mobileDrawer = document.getElementById('mobile-drawer');
        const mobileBackdrop = document.getElementById('drawer-backdrop');

        // --- INITIALIZATION ---
        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Fetch failed");
                payload = await response.json();
                
                if (!payload || !payload.papers || payload.papers.length === 0) {
                    throw new Error("Invalid payload");
                }

                // Initial Paper
                selectPaper(payload.papers[0].key);

            } catch (error) {
                console.error(error);
                renderError();
            }
        }

        function renderError() {
            paperContentEl.innerHTML = `
                <div class="flex items-center justify-center h-64 text-red-600 font-medium">
                    PAPERS PAYLOAD MISSING
                </div>
            `;
            desktopSelectorContainer.innerHTML = '';
            mobileSelectorContainer.innerHTML = '';
        }

        // --- LOGIC: SELECT PAPER ---
        function selectPaper(key) {
            const paper = payload.papers.find(p => p.key === key);
            if (!paper) return;

            currentPaper = paper;
            currentPaperKey = key;
            
            // Reset state
            expandedStates = {};
            const defaultExpanded = paper.defaults?.expandedAll !== false;
            
            // Traverse to set defaults if needed (though we treat absence in map as default state usually, 
            // explicit state is safer for toggles)
            // For simplicity: undefined in expandedStates means "use default"
            
            renderControls();
            renderNavigation();
            renderPaperContent();
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'instant' });
        }

        // --- RENDER: CONTROLS ---
        function renderControls() {
            const selectorHTML = `
                <label for="paper-select-${Date.now()}" class="sr-only">Select Paper</label>
                <div class="relative">
                    <select id="paper-select" class="w-full h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 appearance-none">
                        ${payload.papers.map(p => `
                            <option value="${p.key}" ${p.key === currentPaperKey ? 'selected' : ''}>
                                ${p.label}
                            </option>
                        `).join('')}
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-muted-foreground">
                        <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
                    </div>
                </div>
            `;

            desktopSelectorContainer.innerHTML = selectorHTML;
            mobileSelectorContainer.innerHTML = selectorHTML;

            // Bind events
            const desktopSelect = desktopSelectorContainer.querySelector('select');
            const mobileSelect = mobileSelectorContainer.querySelector('select');

            const handleSelect = (e) => selectPaper(e.target.value);
            
            if(desktopSelect) desktopSelect.addEventListener('change', handleSelect);
            if(mobileSelect) mobileSelect.addEventListener('change', handleSelect);
        }

        // --- RENDER: NAVIGATION ---
        function renderNavigation() {
            let navHTML = '';
            
            // Determine structure (Flat list with Section Headers if they exist)
            const hasSections = currentPaper.sections && currentPaper.sections.length > 0;
            
            const renderItem = (q) => `
                <a href="#question-${q.id}" class="block py-1.5 px-3 -ml-3 text-muted-foreground hover:text-foreground hover:underline decoration-border underline-offset-4 rounded-md transition-colors text-sm font-medium focus-visible:ring-2 focus-visible:ring-ring outline-none" data-id="${q.id}">
                    ${q.id}
                </a>
                ${q.children ? q.children.map(c => renderItem(c)).join('') : ''}
            `;

            if (hasSections) {
                currentPaper.sections.forEach(section => {
                    if (section.label && section.label.trim() !== "") {
                        navHTML += `
                            <div class="pt-4 first:pt-0 pb-2 text-xs font-semibold text-muted-foreground/70 uppercase tracking-wider select-none">
                                ${section.label}
                            </div>
                        `;
                    }
                    section.questions.forEach(q => {
                        navHTML += renderItem(q);
                    });
                });
            } else if (currentPaper.questions) {
                currentPaper.questions.forEach(q => {
                    navHTML += renderItem(q);
                });
            }

            desktopNavEl.innerHTML = navHTML;
            mobileNavEl.innerHTML = navHTML;
            
            // Intersection Observer for Active State
            setupIntersectionObserver();
        }

        // --- RENDER: CONTENT ---
        function renderPaperContent() {
            let contentHTML = '';

            const hasSections = currentPaper.sections && currentPaper.sections.length > 0;

            if (hasSections) {
                currentPaper.sections.forEach((section, index) => {
                    if (section.label && section.label.trim() !== "") {
                        contentHTML += `
                            <div class="border-b border-border/50 pb-2 mb-8 mt-12 first:mt-0">
                                <h2 class="text-xl font-semibold text-foreground tracking-tight">${section.label}</h2>
                            </div>
                        `;
                    }
                    section.questions.forEach((q, idx) => {
                        // Top level question spacing
                        const isFirst = index === 0 && idx === 0 && (!section.label || section.label.trim() === "");
                        contentHTML += renderQuestionNode(q, 0, isFirst);
                    });
                });
            } else if (currentPaper.questions) {
                currentPaper.questions.forEach((q, idx) => {
                    contentHTML += renderQuestionNode(q, 0, idx === 0);
                });
            }

            paperContentEl.innerHTML = contentHTML;

            // Post-process: KaTeX
            renderMathInElement(paperContentEl, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false}
                ],
                throwOnError: false
            });

            // Bind Disclosure Controls
            document.querySelectorAll('.toggle-control').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = btn.dataset.id;
                    const region = document.getElementById(`solution-${id}`);
                    const isExpanded = btn.getAttribute('aria-expanded') === 'true';
                    
                    // Toggle state
                    if (isExpanded) {
                        region.classList.add('hidden');
                        btn.setAttribute('aria-expanded', 'false');
                        btn.innerHTML = `Show working <svg class="ml-1 h-4 w-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>`;
                        expandedStates[id] = false;
                    } else {
                        region.classList.remove('hidden');
                        btn.setAttribute('aria-expanded', 'true');
                        btn.innerHTML = `Hide working <svg class="ml-1 h-4 w-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m18 15-6-6-6 6"/></svg>`;
                        expandedStates[id] = true;
                    }
                });
            });
        }

        // --- RENDER: QUESTION NODE (RECURSIVE) ---
        function renderQuestionNode(node, depth = 0, isFirstTopLevel = false) {
            // State Determination
            const defaultExpanded = currentPaper.defaults?.expandedAll !== false;
            const userState = expandedStates[node.id];
            const isExpanded = userState !== undefined ? userState : defaultExpanded;

            // Content Extraction
            const questionBody = md ? md.render(node.question || '') : (node.question || '');
            
            const hasSolutionBlock = !!node.solutionBlock;
            const answer = node.solutionBlock?.answer;
            const details = node.solutionBlock?.solutionDetails;
            
            // Solution Details Parts
            const keepInMind = details?.keepInMind;
            const formulas = details?.formulasUsed;
            const working = details?.working;
            const altWorking = details?.alternativeWorking || [];
            
            const hasDetails = !!(keepInMind || formulas || working || (altWorking && altWorking.length > 0));

            // Structure IDs
            const qId = `question-${node.id}`;
            const sId = `solution-${node.id}`;

            // Spacing & Styling classes based on depth
            // Top level: more spacing. Nested: tighter.
            const containerClass = depth === 0 
                ? (isFirstTopLevel ? "mb-16" : "mb-16 border-t border-transparent") // Use margin for separation
                : "mt-6 ml-0"; // Sub-questions indent handled by padding/margin logic or kept flat per brief (brief says indentation optional/permitted, keep responsive)

            // Let's use slight visual nesting via left border or margin for children
            const childContainerClass = depth >= 0 ? "pl-4 lg:pl-0" : ""; // minimal indent for children

            // HTML Construction
            let html = `
                <div id="${qId}" class="question-node scroll-mt-24 ${containerClass}">
                    <!-- Question Body -->
                    <div class="flex gap-4">
                        <div class="flex-shrink-0 w-12 pt-1">
                            <span class="text-sm font-semibold text-muted-foreground/80">${node.id}</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="prose prose-slate max-w-none text-foreground markdown-body">
                                ${questionBody}
                            </div>
                        </div>
                    </div>
            `;

            // Solution Block
            if (hasSolutionBlock) {
                html += `<div class="mt-4 ml-16 flex flex-col gap-4">`;

                // Answer
                if (answer) {
                    const answerBody = md ? md.render(answer) : answer;
                    html += `
                        <div class="flex gap-4 items-baseline">
                            <span class="text-sm font-semibold text-muted-foreground w-16 flex-shrink-0">Answer</span>
                            <div class="prose prose-slate max-w-none font-medium text-foreground markdown-body flex-1">
                                ${answerBody}
                            </div>
                        </div>
                    `;
                }

                // Solution Details Toggle & Region
                if (hasDetails) {
                    html += `
                        <div class="mt-1">
                            <button 
                                class="toggle-control inline-flex items-center text-sm font-medium text-primary hover:text-primary/80 transition-colors focus-visible:ring-2 focus-visible:ring-ring rounded-sm outline-none"
                                data-id="${node.id}"
                                aria-expanded="${isExpanded}"
                                aria-controls="${sId}"
                            >
                                ${isExpanded ? 'Hide working' : 'Show working'}
                                ${isExpanded 
                                    ? '<svg class="ml-1 h-4 w-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m18 15-6-6-6 6"/></svg>' 
                                    : '<svg class="ml-1 h-4 w-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>'}
                            </button>
                            
                            <div id="${sId}" class="${isExpanded ? '' : 'hidden'} mt-4 space-y-6 animate-in fade-in slide-in-from-top-2 duration-200">
                    `;

                    // Internal Parts Order: Keep in mind -> Formulas -> Working -> Alt
                    
                    // Keep In Mind
                    if (keepInMind) {
                        html += `
                            <div class="space-y-2">
                                <h4 class="text-sm font-bold text-muted-foreground">Keep in mind</h4>
                                <div class="prose prose-sm prose-slate max-w-none text-muted-foreground markdown-body">
                                    ${md ? md.render(keepInMind) : keepInMind}
                                </div>
                            </div>
                        `;
                    }

                    // Formulas Used
                    if (formulas) {
                        html += `
                            <div class="space-y-2">
                                <h4 class="text-sm font-bold text-muted-foreground">Formulas used</h4>
                                <div class="prose prose-sm prose-slate max-w-none text-muted-foreground markdown-body">
                                    ${md ? md.render(formulas) : formulas}
                                </div>
                            </div>
                        `;
                    }

                    // Working
                    if (working) {
                        html += `
                            <div class="space-y-2">
                                <h4 class="text-sm font-bold text-muted-foreground">Working</h4>
                                <div class="prose prose-slate max-w-none text-muted-foreground markdown-body">
                                    ${md ? md.render(working) : working}
                                </div>
                            </div>
                        `;
                    }

                    // Alternative Working
                    if (altWorking && altWorking.length > 0) {
                        // Separator
                        html += `<div class="h-px bg-border my-4"></div>`;
                        
                        altWorking.forEach(alt => {
                            html += `
                                <div class="space-y-2 mt-4">
                                    <h4 class="text-sm font-bold text-muted-foreground">Alternative working</h4>
                                    <div class="prose prose-slate max-w-none text-muted-foreground markdown-body">
                                        ${md ? md.render(alt) : alt}
                                    </div>
                                </div>
                            `;
                        });
                    }

                    html += `</div></div>`; // End Details Region & Wrapper
                }

                html += `</div>`; // End Solution Block Wrapper
            }

            // Children
            if (node.children && node.children.length > 0) {
                html += `<div class="${childContainerClass} mt-4">`;
                node.children.forEach(child => {
                    html += renderQuestionNode(child, depth + 1);
                });
                html += `</div>`;
            }

            html += `</div>`; // End Node
            return html;
        }

        // --- INTERSECTION OBSERVER (ACTIVE NAV) ---
        function setupIntersectionObserver() {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const id = entry.target.id.replace('question-', '');
                        // Reset all
                        document.querySelectorAll('#desktop-nav-list a, #mobile-nav-list a').forEach(a => {
                            a.classList.remove('text-primary', 'font-bold');
                            a.classList.add('text-muted-foreground', 'font-medium');
                        });
                        // Set active
                        document.querySelectorAll(`#desktop-nav-list a[data-id="${id}"], #mobile-nav-list a[data-id="${id}"]`).forEach(a => {
                            a.classList.remove('text-muted-foreground', 'font-medium');
                            a.classList.add('text-primary', 'font-bold');
                            
                            // Scroll Nav into view if needed (Desktop)
                            if(desktopNavEl.contains(a)) {
                                // Simple logic: keep it visible
                                const rect = a.getBoundingClientRect();
                                const containerRect = document.querySelector('aside').getBoundingClientRect();
                                if (rect.top < containerRect.top || rect.bottom > containerRect.bottom) {
                                    a.scrollIntoView({ block: 'center', behavior: 'smooth' });
                                }
                            }
                        });
                    }
                });
            }, { rootMargin: '-20% 0px -60% 0px', threshold: 0 });

            document.querySelectorAll('.question-node').forEach(node => observer.observe(node));
        }

        // --- MOBILE DRAWER LOGIC ---
        function toggleDrawer(show) {
            if (show) {
                mobileDrawer.classList.remove('drawer-closed');
                mobileDrawer.classList.add('drawer-open');
                document.body.style.overflow = 'hidden';
            } else {
                mobileDrawer.classList.remove('drawer-open');
                mobileDrawer.classList.add('drawer-closed');
                document.body.style.overflow = '';
            }
        }

        mobileDrawerTrigger.addEventListener('click', () => toggleDrawer(true));
        mobileDrawerClose.addEventListener('click', () => toggleDrawer(false));
        mobileBackdrop.addEventListener('click', () => toggleDrawer(false));
        
        // Close drawer on link click
        mobileNavEl.addEventListener('click', (e) => {
            if (e.target.tagName === 'A') toggleDrawer(false);
        });

        // --- START ---
        init();

    </script>
</body>
</html>
