<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AB","indexWithinVariant":"158","totalWithinVariant":"200","hueFamily":"cyan","intensityMode":"","timestamp":"2026-01-07T07:26:54.547Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AB&quot;,&quot;indexWithinVariant&quot;:&quot;158&quot;,&quot;totalWithinVariant&quot;:&quot;200&quot;,&quot;hueFamily&quot;:&quot;cyan&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-07T07:26:54.547Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- KaTeX CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <!-- Markdown-it & KaTeX JS -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <style>
        /* =========================================
           CSS RESET & BASE
           ========================================= */
        *, *::before, *::after {
            box-sizing: border-box;
        }

        :root {
            /* COLORLAB B: CYAN + Light Mode Only */
            --hue-primary: 189; /* Cyan */
            
            /* Neutrals */
            --color-bg: #ffffff;
            --color-text-primary: #111827;
            --color-text-secondary: #4b5563;
            --color-text-tertiary: #6b7280;
            --color-border: #e5e7eb;
            --color-divider: #e5e7eb;
            
            /* Accents (Cyan) */
            --color-accent: hsl(var(--hue-primary), 94%, 36%); /* ~Cyan-600 #0891b2 */
            --color-accent-hover: hsl(var(--hue-primary), 89%, 31%); /* ~Cyan-700 */
            --color-accent-light: hsl(var(--hue-primary), 90%, 96%); /* ~Cyan-50 */
            --color-focus-ring: hsl(var(--hue-primary), 80%, 60%);

            /* Semantic Surfaces */
            --surface-paper: #ffffff;
            --surface-nav: #ffffff; 
            --surface-solution-wash: hsl(var(--hue-primary), 60%, 98%); /* Very subtle cool tint */
            
            /* Spacing Scale */
            --space-xs: 0.25rem;
            --space-sm: 0.5rem;
            --space-md: 1rem;
            --space-lg: 1.5rem;
            --space-xl: 2.5rem; /* Between top-level questions */
            --space-xxl: 4rem;

            /* Dimensions */
            --nav-width: 240px;
            --max-width: 1024px;
            --header-height: 60px;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text-primary);
            margin: 0;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        button {
            font-family: inherit;
            cursor: pointer;
            border: none;
            background: none;
            padding: 0;
            margin: 0;
        }

        /* Focus Styles (Accessibility) */
        :focus-visible {
            outline: 2px solid var(--color-focus-ring);
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* =========================================
           LAYOUT SHELL
           ========================================= */
        .app-shell {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .top-controls {
            position: sticky;
            top: 0;
            z-index: 50;
            background-color: var(--color-bg);
            border-bottom: 1px solid var(--color-border);
            height: var(--header-height);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 var(--space-md);
        }

        .top-controls-inner {
            width: 100%;
            max-width: var(--max-width);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .document-frame-shell {
            flex: 1;
            display: flex;
            justify-content: center;
            width: 100%;
            max-width: var(--max-width);
            margin: 0 auto;
            position: relative;
        }

        /* =========================================
           NAVIGATION (Desktop Rail)
           ========================================= */
        .nav-rail {
            width: var(--nav-width);
            position: sticky;
            top: var(--header-height);
            height: calc(100vh - var(--header-height));
            overflow-y: auto;
            padding: var(--space-lg) var(--space-md) var(--space-lg) 0;
            border-right: 1px solid transparent; /* Optical separation handled by space */
            display: none; /* Hidden on mobile by default */
            scrollbar-width: none; /* Firefox */
        }
        .nav-rail::-webkit-scrollbar { 
            display: none; /* Chrome/Safari */
        }

        @media (min-width: 768px) {
            .nav-rail {
                display: block;
            }
        }

        .nav-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .nav-section-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--color-text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: var(--space-md);
            margin-bottom: var(--space-xs);
            padding-left: var(--space-xs);
            pointer-events: none;
        }
        .nav-section-label:first-child {
            margin-top: 0;
        }

        .nav-item {
            display: block;
            padding: var(--space-xs) var(--space-sm);
            font-size: 0.875rem;
            color: var(--color-text-secondary);
            text-decoration: none;
            border-left: 2px solid transparent;
            transition: color 0.2s, border-color 0.2s;
        }

        .nav-item:hover {
            color: var(--color-text-primary);
            background-color: var(--color-accent-light);
        }

        .nav-item.active {
            color: var(--color-accent); /* Cyan accent override for active nav */
            font-weight: 600;
            border-left-color: var(--color-accent);
            background-color: var(--surface-nav); /* Ensure clean background */
        }

        /* Hierarchy via Type Scale (Stage 5.4.5) */
        .nav-item[data-depth="0"] { font-size: 0.95rem; }
        .nav-item[data-depth="1"] { font-size: 0.85rem; color: var(--color-text-tertiary); }
        .nav-item[data-depth="2"] { font-size: 0.8rem; color: var(--color-text-tertiary); }

        /* =========================================
           PAPER CONTENT
           ========================================= */
        .paper-column {
            flex: 1;
            padding: var(--space-lg) 0 var(--space-xxl) var(--space-lg);
            min-width: 0; /* Enable text truncation/wrapping in flex child */
        }

        @media (max-width: 768px) {
            .paper-column {
                padding: var(--space-md);
            }
        }

        .question-node {
            display: flex;
            flex-direction: column;
        }

        /* Top level separation */
        .question-node[data-depth="0"] {
            margin-bottom: var(--space-xl);
        }

        /* Nested separation */
        .children-container {
            margin-top: var(--space-md);
            padding-left: var(--space-md); /* Indentation for reading clarity */
            border-left: 1px solid transparent; /* Placeholder for optional guide */
        }
        
        @media (max-width: 480px) {
            .children-container {
                padding-left: var(--space-sm); /* Tighter on mobile */
            }
        }

        /* Question Body */
        .question-body {
            margin-bottom: var(--space-sm);
        }

        .question-identifier {
            font-weight: 600;
            color: var(--color-text-secondary);
            margin-right: var(--space-xs);
            font-size: 1rem;
        }

        .question-prompt {
            color: var(--color-text-primary);
            font-weight: 500;
            display: inline;
        }
        
        .question-prompt p {
            margin: 0 0 var(--space-xs) 0;
            display: inline;
        }
        .question-prompt p:not(:last-child) {
            display: block;
        }

        /* Solution Block */
        .solution-block {
            margin-top: var(--space-sm);
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }

        /* Answer */
        .answer-region {
            font-size: 0.95rem;
        }
        .answer-label {
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--color-accent); /* ColorLab B: Cyan */
            margin-right: var(--space-xs);
        }

        /* Disclosure Control */
        .disclosure-control {
            align-self: flex-start;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--color-accent);
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            padding: var(--space-xs) 0;
            transition: color 0.2s;
        }
        .disclosure-control:hover {
            color: var(--color-accent-hover);
            text-decoration: underline;
        }
        .chevron {
            width: 16px;
            height: 16px;
            transition: transform 0.2s ease;
        }
        .disclosure-control[aria-expanded="true"] .chevron {
            transform: rotate(180deg);
        }

        /* Solution Details Region */
        .solution-details {
            margin-top: var(--space-xs);
            padding: var(--space-md);
            background-color: var(--surface-solution-wash); /* Subtle cyan tint */
            border-radius: 4px; /* Permitted quiet demarcation */
            font-size: 0.925rem;
            color: var(--color-text-secondary);
            /* Anti-fade guardrail: Color is dark enough to be legible */
            display: none; /* Hidden by default via class toggle */
            border-left: 2px solid var(--color-border); /* Subtle structural anchor */
        }

        .solution-details.expanded {
            display: block;
            animation: fadeIn 0.2s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-4px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Solution Subsections */
        .sd-section {
            margin-bottom: var(--space-md);
        }
        .sd-section:last-child {
            margin-bottom: 0;
        }

        .sd-label {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--color-text-secondary);
            margin-bottom: var(--space-xs);
            display: block;
        }

        /* Keep in Mind */
        .sd-keep-in-mind .sd-label {
            color: var(--color-text-primary); /* Higher prominence */
        }
        .sd-keep-in-mind ul {
            margin: 0;
            padding-left: var(--space-lg);
        }

        /* Formulas Used */
        .sd-formulas-used .sd-label {
            color: var(--color-text-tertiary);
        }
        .sd-formulas-used ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        /* Working / Alt Working */
        .sd-working-body {
            /* Mixed prose/math rhythm */
        }
        .sd-working-body p {
            margin: 0 0 var(--space-sm) 0;
        }
        
        /* Alternative Working Separation */
        .sd-alt-working {
            margin-top: var(--space-lg);
            border-top: 1px solid var(--color-border);
            padding-top: var(--space-md);
        }

        /* =========================================
           MOBILE DRAWER
           ========================================= */
        .mobile-jump-trigger {
            display: none;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--color-accent);
        }
        @media (max-width: 767px) {
            .mobile-jump-trigger {
                display: block;
            }
        }

        .drawer-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.3);
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }
        .drawer-overlay.open {
            opacity: 1;
            pointer-events: auto;
        }

        .drawer-content {
            position: absolute;
            top: 0;
            right: 0; /* Right side drawer for variety or Left? Standard is left usually, brief says "drawer". Let's stick to Left or Bottom. Brief says Left Nav on desktop, drawer on mobile. Let's do Left Drawer. */
            left: 0;
            bottom: 0;
            width: 85%;
            max-width: 320px;
            background: var(--color-bg);
            transform: translateX(-100%);
            transition: transform 0.2s ease-out;
            padding: var(--space-md);
            display: flex;
            flex-direction: column;
        }
        .drawer-overlay.open .drawer-content {
            transform: translateX(0);
        }

        .drawer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-md);
            border-bottom: 1px solid var(--color-border);
            padding-bottom: var(--space-sm);
        }
        
        .drawer-title {
            font-weight: 600;
            font-size: 1rem;
        }

        .drawer-close {
            font-size: 1.5rem;
            line-height: 1;
            color: var(--color-text-secondary);
            padding: var(--space-xs);
        }

        .drawer-nav-container {
            flex: 1;
            overflow-y: auto;
        }

        /* =========================================
           CONTROLS (Select)
           ========================================= */
        .paper-selector {
            padding: var(--space-xs) var(--space-sm);
            border: 1px solid var(--color-border);
            border-radius: 4px;
            font-size: 0.875rem;
            color: var(--color-text-primary);
            background: var(--color-bg);
        }
        .paper-selector:focus-visible {
            border-color: var(--color-accent);
        }

        /* =========================================
           KATEX & MARKDOWN OVERRIDES
           ========================================= */
        /* Containment Invariant */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            margin: 0.5em 0;
            padding: 0.25em 0;
            -webkit-overflow-scrolling: touch;
            /* Scrollbar hiding within math block */
            scrollbar-width: thin;
        }
        
        /* Inline math no background */
        .katex { 
            background: transparent !important; 
        }

        /* Block math underlay permitted by Stage 3/5.8? 
           Stage 5.8.2 says "no background blocks". 
           Stage 6.0.4 says "subtle differentiation for block-level math only".
           We will apply a very faint border-left or just rely on indentation 
           inside Working to satisfy 5.8.3 "tight spacing". 
           Let's keep it clean. No wash.
        */

        /* Table minimal styling */
        table {
            border-collapse: collapse;
            width: 100%;
            font-size: 0.9rem;
            margin: var(--space-sm) 0;
        }
        th, td {
            border: 1px solid var(--color-border);
            padding: var(--space-xs) var(--space-sm);
            text-align: left;
        }
        th {
            font-weight: 600;
            background-color: var(--color-bg);
        }
        /* Mobile table scroll wrapper handled by JS wrapper if needed, 
           or just standard overflow on container */
        .table-wrapper {
            overflow-x: auto;
            margin-bottom: var(--space-sm);
        }

        /* Error state */
        .error-message {
            color: #ef4444; /* Red allowed for system error, though not for content correctness */
            text-align: center;
            margin-top: var(--space-xl);
            font-weight: 600;
        }
    </style>
</head>
<body>

<script>
    // ===== STAGE 0: CONSTANTS =====
    const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
    const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";
    
    // ===== ADD-ON CONSTANTS =====
    const RTQ_COLORLAB_FORCE_HUE_FAMILY = "cyan"; // ColorLab B
</script>

<div id="root" class="app-shell">
    <!-- Top Controls -->
    <header class="top-controls">
        <div class="top-controls-inner">
            <select id="paper-selector" class="paper-selector" aria-label="Select paper">
                <option value="" disabled selected>Loading papers...</option>
            </select>
            
            <button id="mobile-jump-trigger" class="mobile-jump-trigger" aria-controls="mobile-drawer" aria-expanded="false">
                Jump to...
            </button>
        </div>
    </header>

    <!-- Main Content Frame -->
    <div class="document-frame-shell">
        <!-- Desktop Nav Rail -->
        <nav id="nav-rail" class="nav-rail" aria-label="Paper navigation">
            <ul id="nav-list-desktop" class="nav-list">
                <!-- Injected via JS -->
            </ul>
        </nav>

        <!-- Paper Content Column -->
        <main class="paper-column">
            <div id="paper-content">
                <!-- Injected via JS -->
                <div style="text-align:center; color: var(--color-text-tertiary); margin-top: 2rem;">Loading content...</div>
            </div>
        </main>
    </div>

    <!-- Mobile Drawer -->
    <div id="mobile-drawer-overlay" class="drawer-overlay">
        <div class="drawer-content" role="dialog" aria-modal="true" aria-labelledby="drawer-title">
            <div class="drawer-header">
                <span id="drawer-title" class="drawer-title">Jump to</span>
                <button id="drawer-close" class="drawer-close" aria-label="Close navigation">Ã—</button>
            </div>
            <div id="drawer-nav-container" class="drawer-nav-container">
                <ul id="nav-list-mobile" class="nav-list">
                    <!-- Cloned from desktop via JS -->
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
    /**
     * RTQ Prototype Logic
     * Handles fetching, Markdown rendering, KaTeX injection, Layout generation, and Interaction.
     */

    // --- Markdown Configuration (Stage 6 Add-on) ---
    const md = window.markdownit ? window.markdownit({
        html: true,     // Allow inline SVG
        linkify: true,
        breaks: false   // Critical: prevents <br> in math blocks
    }) : null;

    if (md) {
        // Disable escape rule to preserve TeX backslashes
        md.inline.ruler.disable(['escape']);
    }

    // --- State ---
    let appState = {
        papers: [],
        currentPaper: null,
        expandedNodes: new Set(), // Set of Node IDs that are expanded
        activeNavId: null
    };

    // --- DOM Elements ---
    const dom = {
        selector: document.getElementById('paper-selector'),
        content: document.getElementById('paper-content'),
        navRail: document.getElementById('nav-rail'),
        navListDesktop: document.getElementById('nav-list-desktop'),
        navListMobile: document.getElementById('nav-list-mobile'),
        mobileTrigger: document.getElementById('mobile-jump-trigger'),
        drawerOverlay: document.getElementById('mobile-drawer-overlay'),
        drawerClose: document.getElementById('drawer-close'),
        drawerLinks: document.getElementById('nav-list-mobile') // Event delegation target
    };

    // --- Initialization ---
    async function init() {
        try {
            const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
            if (!response.ok) throw new Error("Network response was not ok");
            const payload = await response.json();
            
            if (!payload.papers || !Array.isArray(payload.papers)) {
                throw new Error("Invalid payload structure");
            }

            appState.papers = payload.papers;
            renderSelector();
            
            // Select first paper by default
            if (appState.papers.length > 0) {
                switchPaper(appState.papers[0].key);
            }
        } catch (error) {
            console.error("Payload Load Error:", error);
            renderError();
        }
    }

    function renderError() {
        dom.content.innerHTML = `<div class="error-message">PAPERS PAYLOAD MISSING</div>`;
        dom.selector.innerHTML = `<option disabled>Error loading papers</option>`;
    }

    function renderSelector() {
        dom.selector.innerHTML = '';
        appState.papers.forEach(paper => {
            const opt = document.createElement('option');
            opt.value = paper.key;
            opt.textContent = paper.label || paper.key;
            dom.selector.appendChild(opt);
        });
        dom.selector.addEventListener('change', (e) => switchPaper(e.target.value));
    }

    function switchPaper(key) {
        const paper = appState.papers.find(p => p.key === key);
        if (!paper) return;

        appState.currentPaper = paper;
        
        // Reset Expansion State based on defaults
        appState.expandedNodes.clear();
        const shouldExpandAll = paper.defaults?.expandedAll !== false; // Default true unless false
        
        // Helper to collect all IDs that have solution details
        const collectExpandable = (nodes) => {
            if (!nodes) return;
            nodes.forEach(node => {
                if (node.solutionBlock?.solutionDetails) {
                    if (shouldExpandAll) appState.expandedNodes.add(node.id); // Using display ID as key for simplicity in this prototype, though recursive traversal usually needs unique internal key. Assuming ID is unique enough for prototype.
                }
                if (node.children) collectExpandable(node.children);
            });
        };
        
        if (paper.questions) collectExpandable(paper.questions);
        if (paper.sections) paper.sections.forEach(s => collectExpandable(s.questions));

        renderPaperContent();
        renderNavigation();
        
        // Scroll to top
        window.scrollTo(0, 0);
    }

    // --- Content Rendering ---
    function renderPaperContent() {
        const paper = appState.currentPaper;
        dom.content.innerHTML = '';

        if (paper.sections) {
            // Sectioned Paper
            paper.sections.forEach(section => {
                const sectionContainer = document.createElement('div');
                sectionContainer.className = 'section-block';
                
                // Section Header (only if non-empty)
                if (section.label && section.label.trim() !== '') {
                    const header = document.createElement('h2');
                    header.style.fontSize = '1.25rem';
                    header.style.fontWeight = '700';
                    header.style.marginBottom = 'var(--space-md)';
                    header.style.color = 'var(--color-text-secondary)';
                    header.textContent = section.label;
                    sectionContainer.appendChild(header);
                }

                // Questions
                if (section.questions) {
                    section.questions.forEach(q => {
                        sectionContainer.appendChild(createQuestionNode(q, 0));
                    });
                }
                dom.content.appendChild(sectionContainer);
            });
        } else if (paper.questions) {
            // Flat Paper
            paper.questions.forEach(q => {
                dom.content.appendChild(createQuestionNode(q, 0));
            });
        }

        // Post-render: Apply KaTeX
        renderMathInElement(dom.content, {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false},
                {left: '\\(', right: '\\)', display: false},
                {left: '\\[', right: '\\]', display: true}
            ],
            throwOnError: false
        });

        // Setup Intersection Observer for scroll spy
        setupScrollSpy();
    }

    function createQuestionNode(node, depth) {
        const container = document.createElement('div');
        container.className = 'question-node';
        container.dataset.depth = depth;
        container.id = `q-${sanitizeId(node.id)}`;

        // 1. Question Body
        const bodyDiv = document.createElement('div');
        bodyDiv.className = 'question-body';
        
        const identifier = document.createElement('span');
        identifier.className = 'question-identifier';
        identifier.textContent = node.id;
        
        const prompt = document.createElement('div');
        prompt.className = 'question-prompt';
        prompt.innerHTML = renderMarkdown(node.question);

        bodyDiv.appendChild(identifier);
        bodyDiv.appendChild(prompt);
        container.appendChild(bodyDiv);

        // 2. Solution Block (Optional)
        if (node.solutionBlock) {
            const solBlock = document.createElement('div');
            solBlock.className = 'solution-block';

            // Answer (Visible by default if present)
            if (node.solutionBlock.answer) {
                const answerDiv = document.createElement('div');
                answerDiv.className = 'answer-region';
                
                const ansLabel = document.createElement('span');
                ansLabel.className = 'answer-label';
                ansLabel.textContent = 'Answer';
                
                const ansContent = document.createElement('span');
                ansContent.innerHTML = renderMarkdown(node.solutionBlock.answer);

                answerDiv.appendChild(ansLabel);
                answerDiv.appendChild(ansContent);
                solBlock.appendChild(answerDiv);
            }

            // Solution Details (Expandable)
            if (node.solutionBlock.solutionDetails) {
                const details = node.solutionBlock.solutionDetails;
                const isExpanded = appState.expandedNodes.has(node.id);

                // Toggle Control
                const toggle = document.createElement('button');
                toggle.className = 'disclosure-control';
                toggle.setAttribute('aria-expanded', isExpanded);
                toggle.innerHTML = `
                    <span class="label-text">${isExpanded ? 'Hide working' : 'Show working'}</span>
                    <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                `;
                
                // Details Region
                const detailsRegion = document.createElement('div');
                detailsRegion.className = `solution-details ${isExpanded ? 'expanded' : ''}`;
                
                // Content Construction
                let html = '';
                
                if (details.keepInMind) {
                    html += `
                        <div class="sd-section sd-keep-in-mind">
                            <span class="sd-label">Keep in mind</span>
                            ${renderMarkdown(details.keepInMind)}
                        </div>`;
                }
                
                if (details.formulasUsed) {
                    html += `
                        <div class="sd-section sd-formulas-used">
                            <span class="sd-label">Formulas used</span>
                            ${renderMarkdown(details.formulasUsed)}
                        </div>`;
                }
                
                if (details.working) {
                    html += `
                        <div class="sd-section sd-working">
                            <span class="sd-label">Working</span>
                            <div class="sd-working-body">${renderMarkdown(details.working)}</div>
                        </div>`;
                }

                if (details.alternativeWorking && Array.isArray(details.alternativeWorking)) {
                    details.alternativeWorking.forEach((alt, idx) => {
                        html += `
                            <div class="sd-section sd-alt-working">
                                <span class="sd-label">Alternative working</span>
                                <div class="sd-working-body">${renderMarkdown(alt)}</div>
                            </div>`;
                    });
                }

                detailsRegion.innerHTML = html;

                // Event Listener
                toggle.addEventListener('click', () => {
                    const expanding = !appState.expandedNodes.has(node.id);
                    if (expanding) {
                        appState.expandedNodes.add(node.id);
                        detailsRegion.classList.add('expanded');
                        toggle.setAttribute('aria-expanded', 'true');
                        toggle.querySelector('.label-text').textContent = 'Hide working';
                    } else {
                        appState.expandedNodes.delete(node.id);
                        detailsRegion.classList.remove('expanded');
                        toggle.setAttribute('aria-expanded', 'false');
                        toggle.querySelector('.label-text').textContent = 'Show working';
                    }
                });

                solBlock.appendChild(toggle);
                solBlock.appendChild(detailsRegion);
            }
            container.appendChild(solBlock);
        }

        // 3. Children (Recursive)
        if (node.children && node.children.length > 0) {
            const childrenContainer = document.createElement('div');
            childrenContainer.className = 'children-container';
            node.children.forEach(child => {
                childrenContainer.appendChild(createQuestionNode(child, depth + 1));
            });
            container.appendChild(childrenContainer);
        }

        return container;
    }

    // --- Navigation Rendering ---
    function renderNavigation() {
        const paper = appState.currentPaper;
        dom.navListDesktop.innerHTML = '';
        dom.navListMobile.innerHTML = '';

        const createItem = (id, depth) => {
            const li = document.createElement('li');
            const a = document.createElement('a');
            a.className = 'nav-item';
            a.href = `#q-${sanitizeId(id)}`;
            a.textContent = id;
            a.dataset.depth = Math.min(depth, 2); // Cap depth style
            a.dataset.targetId = `q-${sanitizeId(id)}`;
            
            a.addEventListener('click', (e) => {
                e.preventDefault();
                const target = document.getElementById(a.dataset.targetId);
                if (target) {
                    // Offset for sticky header
                    const headerOffset = 80;
                    const elementPosition = target.getBoundingClientRect().top;
                    const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
                    
                    window.scrollTo({
                        top: offsetPosition,
                        behavior: "smooth"
                    });
                    
                    // Close drawer if open
                    closeDrawer();
                }
            });

            li.appendChild(a);
            return li;
        };

        const processNodes = (nodes, container, depth) => {
            if (!nodes) return;
            nodes.forEach(node => {
                container.appendChild(createItem(node.id, depth));
                if (node.children) processNodes(node.children, container, depth + 1);
            });
        };

        if (paper.sections) {
            paper.sections.forEach(section => {
                // Section Label
                if (section.label && section.label.trim() !== '') {
                    const liLabel = document.createElement('li');
                    liLabel.className = 'nav-section-label';
                    liLabel.textContent = section.label;
                    dom.navListDesktop.appendChild(liLabel);
                    dom.navListMobile.appendChild(liLabel.cloneNode(true));
                }
                processNodes(section.questions, dom.navListDesktop, 0);
                
                // For mobile clone, we need to recreate logic or clone and re-attach listeners?
                // Easier to rebuild for mobile to attach events cleanly.
                if (section.label && section.label.trim() !== '') {
                   // Already appended label above
                }
                processNodes(section.questions, dom.navListMobile, 0);
            });
        } else {
            processNodes(paper.questions, dom.navListDesktop, 0);
            processNodes(paper.questions, dom.navListMobile, 0);
        }
    }

    // --- Utilities ---
    function renderMarkdown(text) {
        if (!md || !text) return text || '';
        return md.render(text);
    }

    function sanitizeId(id) {
        return id.replace(/[^a-zA-Z0-9-_]/g, '-');
    }

    // --- Scroll Spy Logic ---
    function setupScrollSpy() {
        // Intersection Observer to detect active question
        const observerOptions = {
            root: null,
            rootMargin: '-20% 0px -70% 0px', // Active region
            threshold: 0
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    setActiveNav(entry.target.id);
                }
            });
        }, observerOptions);

        document.querySelectorAll('.question-node').forEach(node => {
            observer.observe(node);
        });
    }

    function setActiveNav(targetId) {
        if (appState.activeNavId === targetId) return;
        appState.activeNavId = targetId;

        document.querySelectorAll('.nav-item').forEach(item => {
            if (item.dataset.targetId === targetId) {
                item.classList.add('active');
                // Scroll nav rail if needed
                item.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
            } else {
                item.classList.remove('active');
            }
        });
    }

    // --- Mobile Drawer Logic ---
    function openDrawer() {
        dom.drawerOverlay.classList.add('open');
        dom.drawerOverlay.setAttribute('aria-hidden', 'false');
        dom.mobileTrigger.setAttribute('aria-expanded', 'true');
    }

    function closeDrawer() {
        dom.drawerOverlay.classList.remove('open');
        dom.drawerOverlay.setAttribute('aria-hidden', 'true');
        dom.mobileTrigger.setAttribute('aria-expanded', 'false');
    }

    dom.mobileTrigger.addEventListener('click', openDrawer);
    dom.drawerClose.addEventListener('click', closeDrawer);
    dom.drawerOverlay.addEventListener('click', (e) => {
        if (e.target === dom.drawerOverlay) closeDrawer();
    });

    // --- Start ---
    init();

</script>
</body>
</html>
