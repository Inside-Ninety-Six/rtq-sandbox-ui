<!DOCTYPE html>
<html lang="en" class="antialiased">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AB","indexWithinVariant":"134","totalWithinVariant":"200","hueFamily":"cyan","intensityMode":"","timestamp":"2026-01-07T06:22:55.976Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AB&quot;,&quot;indexWithinVariant&quot;:&quot;134&quot;,&quot;totalWithinVariant&quot;:&quot;200&quot;,&quot;hueFamily&quot;:&quot;cyan&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-07T06:22:55.976Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Viewer (Stage 6 Baseline)</title>

    <!-- Tailwind CSS (via CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- ColorLab B Configuration: Forced Cyan Hue Family -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Semantic mapping for ColorLab B (Cyan)
                        // Neutrals: Slate
                        // Accent: Cyan
                        brand: {
                            50: '#ecfeff',
                            100: '#cffafe',
                            200: '#a5f3fc',
                            300: '#67e8f9',
                            400: '#22d3ee',
                            500: '#06b6d4',
                            600: '#0891b2',
                            700: '#0e7490', // Primary accent text
                            800: '#155e75',
                            900: '#164e63',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <!-- KaTeX CSS (No Integrity) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <!-- KaTeX JS (No Integrity) -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Markdown-it (No Integrity) -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <style>
        /* 
         * STAGE 6 BASELINE STYLES 
         */

        /* Base setup */
        body {
            background-color: #f8fafc; /* Slate-50 - Paper feel */
            color: #0f172a; /* Slate-900 */
        }

        /* Nav Scrollbar Hiding */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* KaTeX Containment Invariant */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding-bottom: 4px; /* Space for scrollbar if needed */
            -webkit-overflow-scrolling: touch;
        }
        
        /* Math block scrollbar styling (minimal) */
        .katex-display::-webkit-scrollbar {
            height: 4px;
        }
        .katex-display::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 2px;
        }

        /* Prevent page-level horizontal scroll */
        .prevent-overflow {
            max-width: 100vw;
            overflow-x: hidden;
        }

        /* Table styling (Minimal, structural) */
        table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 1rem;
            font-size: 0.95em;
        }
        th, td {
            border: 1px solid #e2e8f0; /* Slate-200 */
            padding: 0.5rem;
            text-align: left;
            vertical-align: top;
        }
        th {
            font-weight: 600;
            background-color: transparent;
        }

        /* Focus states (Accessibility) */
        :focus-visible {
            outline: 2px solid #06b6d4; /* brand-500 */
            outline-offset: 2px;
        }

        /* Smooth scroll for navigation jumps */
        html {
            scroll-behavior: smooth;
        }
        @media (prefers-reduced-motion: reduce) {
            html {
                scroll-behavior: auto;
            }
        }
        
        /* Utility */
        .preserve-whitespace {
            white-space: pre-wrap;
        }
    </style>
</head>
<body class="prevent-overflow min-h-screen flex flex-col font-sans">

    <!-- TOP CONTROLS REGION -->
    <!-- Aligned to shell via max-width container -->
    <div class="sticky top-0 z-50 bg-[#f8fafc]/95 backdrop-blur-sm border-b border-slate-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-14 flex items-center justify-between">
            
            <!-- Paper Selector -->
            <div class="flex items-center gap-3">
                <label for="paper-select" class="text-sm font-medium text-slate-500 sr-only">Select Paper</label>
                <select id="paper-select" class="form-select text-sm border-slate-300 rounded-md py-1.5 pl-3 pr-8 text-slate-700 bg-white focus:border-brand-500 focus:ring-brand-500 shadow-sm cursor-pointer">
                    <option disabled selected>Loading papers...</option>
                </select>
            </div>

            <!-- Mobile "Jump to" Trigger -->
            <button id="mobile-menu-trigger" class="lg:hidden text-sm font-medium text-brand-700 flex items-center gap-1 py-2 px-3 rounded hover:bg-slate-100 transition-colors">
                <span>Jump to</span>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
        </div>
    </div>

    <!-- DOCUMENT FRAME SHELL -->
    <div class="flex-1 w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 lg:py-12">
        <div class="flex flex-col lg:flex-row gap-8 relative">

            <!-- NAVIGATION RAIL (Desktop) -->
            <!-- Sticky, Sibling Column -->
            <nav class="hidden lg:block w-48 flex-shrink-0 relative">
                <div class="sticky top-24 max-h-[calc(100vh-8rem)] overflow-y-auto no-scrollbar pr-4">
                    <div id="desktop-nav-list" class="flex flex-col gap-1">
                        <!-- Desktop Nav Items Injected Here -->
                    </div>
                </div>
            </nav>

            <!-- PAPER CONTENT COLUMN -->
            <main id="paper-content" class="flex-1 min-w-0 pb-32">
                <!-- Content Injected Here -->
                <div id="loading-state" class="text-slate-500 text-center mt-12 animate-pulse">Loading payload...</div>
                <div id="error-state" class="hidden text-red-700 font-bold text-center mt-12">PAPERS PAYLOAD MISSING</div>
            </main>

        </div>
    </div>

    <!-- MOBILE NAVIGATION DRAWER -->
    <div id="mobile-drawer-backdrop" class="fixed inset-0 bg-slate-900/20 backdrop-blur-[1px] z-[60] hidden transition-opacity opacity-0" aria-hidden="true"></div>
    <div id="mobile-drawer" class="fixed inset-y-0 right-0 z-[70] w-64 bg-white shadow-xl transform translate-x-full transition-transform duration-300 ease-out flex flex-col" aria-hidden="true">
        <div class="flex items-center justify-between p-4 border-b border-slate-100">
            <h2 class="text-lg font-semibold text-slate-800">Jump to</h2>
            <button id="close-drawer" class="p-2 text-slate-500 hover:text-slate-700 rounded-full hover:bg-slate-100">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                <span class="sr-only">Close navigation</span>
            </button>
        </div>
        <div class="flex-1 overflow-y-auto p-4">
            <div id="mobile-nav-list" class="flex flex-col gap-1">
                <!-- Mobile Nav Items Injected Here -->
            </div>
        </div>
    </div>

    <!-- MAIN SCRIPT -->
    <script>
        // --- STAGE 0: CONSTANTS ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // --- MARKDOWN SETUP (Authoritative Config) ---
        const md = window.markdownit ? window.markdownit({
            html: true,    // Allow inline SVG passthrough
            linkify: true,
            breaks: false  // MUST stay false to prevent <br> in math blocks
        }) : null;

        if (md) {
            // Disable inline escape to preserve TeX backslashes
            md.inline.ruler.disable(['escape']);
        }

        // --- STATE ---
        let payload = null;
        let currentPaperKey = null;
        let paperDefaults = { expandedAll: true };
        let activeQuestionId = null;

        // --- DOM ELEMENTS ---
        const paperSelect = document.getElementById('paper-select');
        const paperContent = document.getElementById('paper-content');
        const loadingState = document.getElementById('loading-state');
        const errorState = document.getElementById('error-state');
        const desktopNavList = document.getElementById('desktop-nav-list');
        const mobileNavList = document.getElementById('mobile-nav-list');
        
        // Mobile Drawer
        const mobileTrigger = document.getElementById('mobile-menu-trigger');
        const mobileDrawer = document.getElementById('mobile-drawer');
        const mobileBackdrop = document.getElementById('mobile-drawer-backdrop');
        const closeDrawerBtn = document.getElementById('close-drawer');

        // --- INITIALIZATION ---
        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error('Payload fetch failed');
                
                payload = await response.json();
                
                if (!payload.papers || !Array.isArray(payload.papers) || payload.papers.length === 0) {
                    throw new Error('Invalid payload structure');
                }

                // Populate Selector
                paperSelect.innerHTML = '';
                payload.papers.forEach((paper, index) => {
                    const option = document.createElement('option');
                    option.value = paper.key;
                    option.textContent = paper.label || paper.key;
                    paperSelect.appendChild(option);
                });

                // Bind Event
                paperSelect.addEventListener('change', (e) => loadPaper(e.target.value));

                // Load Initial Paper
                loadPaper(payload.papers[0].key);

            } catch (err) {
                console.error(err);
                loadingState.classList.add('hidden');
                errorState.classList.remove('hidden');
                paperSelect.disabled = true;
                paperSelect.innerHTML = '<option>Error loading papers</option>';
            }
        }

        // --- PAPER LOADING ---
        function loadPaper(key) {
            const paper = payload.papers.find(p => p.key === key);
            if (!paper) return;

            currentPaperKey = key;
            paperDefaults = paper.defaults || { expandedAll: true };

            // Clear previous
            loadingState.classList.add('hidden');
            errorState.classList.add('hidden');
            paperContent.innerHTML = '';
            desktopNavList.innerHTML = '';
            mobileNavList.innerHTML = '';

            // Handle Sections vs Flat
            const questions = []; // Flat list for nav generation logic convenience
            
            if (paper.sections) {
                // Sectioned Paper
                paper.sections.forEach(section => {
                    // Render Section Header if label exists
                    if (section.label && section.label.trim() !== "") {
                        // Paper Content Header
                        const sectionEl = document.createElement('div');
                        sectionEl.className = "mb-8 mt-12 first:mt-0 border-b border-slate-200 pb-2";
                        sectionEl.innerHTML = `<h2 class="text-xl font-bold text-slate-800">${escapeHtml(section.label)}</h2>`;
                        paperContent.appendChild(sectionEl);

                        // Nav Separator
                        addNavSectionLabel(section.label);
                    } else {
                        // Logic for omitted section label: just ensure spacing if needed
                        const spacer = document.createElement('div');
                        spacer.className = "h-8"; // Inter-section spacing
                        paperContent.appendChild(spacer);
                        
                        addNavSeparator();
                    }

                    // Render Questions in this section
                    section.questions.forEach(q => {
                        renderQuestionNode(q, paperContent, 0);
                        addNavItem(q);
                    });
                });
            } else if (paper.questions) {
                // Flat Paper
                paper.questions.forEach(q => {
                    renderQuestionNode(q, paperContent, 0);
                    addNavItem(q);
                });
            }

            // Trigger KaTeX Render
            renderMath();
            
            // Scroll to top
            window.scrollTo(0, 0);
        }

        // --- RENDERING LOGIC ---

        function renderQuestionNode(node, container, depth) {
            const nodeWrapper = document.createElement('div');
            // ID for anchorage
            nodeWrapper.id = `q-${node.id}`;
            
            // Spacing: Top level gets more, children less
            const isTopLevel = depth === 0;
            const verticalSpacing = isTopLevel ? 'mb-16' : 'mb-6 mt-6';
            
            nodeWrapper.className = `relative group ${verticalSpacing}`;

            // --- 1. Question Body ---
            const questionBody = document.createElement('div');
            questionBody.className = "text-slate-900";

            // Identifier + Prompt Layout
            const idSpan = `<span class="inline-block font-semibold text-slate-500 mr-2 select-none" style="font-size: 0.9em;">${node.id}</span>`;
            const contentHtml = md ? md.render(node.question || "") : (node.question || "");
            
            // We wrap the prompt to ensure it sits nicely next to ID if possible, or block if long
            // Using a simple flex or block approach. Let's use Block for robustness with math.
            const promptWrapper = document.createElement('div');
            promptWrapper.className = "text-lg leading-relaxed";
            if (isTopLevel) promptWrapper.classList.add('font-medium'); // Subtle weight for top level
            
            // Hacky but robust way to inject ID before first paragraph if MD generates <p>
            // Actually, safe way: Render ID as a separate sibling or float. 
            // Design Brief: "Question identifier is a semantic prefix".
            // Let's prepend to the HTML string if it starts with p, or just join.
            promptWrapper.innerHTML = `<div class="flex gap-3"><div class="flex-shrink-0 pt-[2px]">${idSpan}</div><div class="min-w-0 flex-1">${contentHtml}</div></div>`;
            
            questionBody.appendChild(promptWrapper);
            nodeWrapper.appendChild(questionBody);

            // --- 2. Solution Block (Optional) ---
            if (node.solutionBlock) {
                const sb = node.solutionBlock;
                const hasAnswer = sb.answer && sb.answer.trim().length > 0;
                const hasDetails = sb.solutionDetails && (
                    sb.solutionDetails.keepInMind || 
                    sb.solutionDetails.formulasUsed || 
                    sb.solutionDetails.working || 
                    sb.solutionDetails.alternativeWorking
                );

                if (hasAnswer || hasDetails) {
                    const blockWrapper = document.createElement('div');
                    blockWrapper.className = "mt-4 ml-0 sm:ml-8 pl-0 sm:pl-4 border-l-2 border-slate-100"; // Indent/Seam

                    // A) Answer
                    if (hasAnswer) {
                        const answerDiv = document.createElement('div');
                        answerDiv.className = "mb-4 text-base";
                        
                        const answerLabel = `<span class="font-bold text-brand-700 text-sm uppercase tracking-wide mr-2">Answer</span>`;
                        const answerContent = md ? md.render(sb.answer) : sb.answer;
                        
                        // Inline Answer layout
                        answerDiv.innerHTML = `<div class="flex flex-col sm:flex-row sm:items-baseline gap-2 sm:gap-4">${answerLabel}<div class="text-slate-900 font-medium">${answerContent}</div></div>`;
                        blockWrapper.appendChild(answerDiv);
                    }

                    // B) Solution Details
                    if (hasDetails) {
                        // Toggle Control
                        const detailsId = `details-${node.id}`;
                        const isExpandedDefault = paperDefaults.expandedAll !== false; // Default true unless false
                        
                        const toggleBtn = document.createElement('button');
                        toggleBtn.className = "group/btn flex items-center gap-2 text-sm font-medium text-brand-700 hover:text-brand-800 focus:outline-none focus-visible:underline transition-colors";
                        toggleBtn.setAttribute('aria-expanded', String(isExpandedDefault));
                        toggleBtn.setAttribute('aria-controls', detailsId);
                        
                        const updateBtnText = (expanded) => {
                            toggleBtn.innerHTML = `
                                <span class="group-hover/btn:underline underline-offset-2">${expanded ? 'Hide working' : 'Show working'}</span>
                                <svg class="w-4 h-4 transform transition-transform ${expanded ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            `;
                        };
                        updateBtnText(isExpandedDefault);

                        // Details Region
                        const detailsRegion = document.createElement('div');
                        detailsRegion.id = detailsId;
                        detailsRegion.className = `mt-3 space-y-6 overflow-hidden transition-all duration-300 ${isExpandedDefault ? '' : 'hidden'}`;
                        
                        // --- Internal Grammar for Subsections ---
                        const sd = sb.solutionDetails;
                        
                        // 1. Keep in mind
                        if (sd.keepInMind) {
                            const kimDiv = createSubSection('Keep in mind', sd.keepInMind, 'text-slate-700');
                            detailsRegion.appendChild(kimDiv);
                        }
                        
                        // 2. Formulas Used
                        if (sd.formulasUsed) {
                            const formDiv = createSubSection('Formulas used', sd.formulasUsed, 'text-slate-600 font-mono text-sm bg-slate-50 p-2 rounded border border-slate-100'); // Slight distinctive styling allowed by grammar "subtle contrast shifts"
                            detailsRegion.appendChild(formDiv);
                        }

                        // 3. Working (Primary)
                        if (sd.working) {
                            const workDiv = createSubSection('Working', sd.working, 'text-slate-800 leading-relaxed');
                            detailsRegion.appendChild(workDiv);
                        }

                        // 4. Alternative Working
                        if (sd.alternativeWorking && Array.isArray(sd.alternativeWorking)) {
                            sd.alternativeWorking.forEach((alt, idx) => {
                                const altDiv = createSubSection('Alternative working', alt, 'text-slate-800 leading-relaxed pt-4 border-t border-slate-100 mt-4');
                                detailsRegion.appendChild(altDiv);
                            });
                        }

                        // Toggle Logic
                        toggleBtn.onclick = () => {
                            const isHidden = detailsRegion.classList.contains('hidden');
                            if (isHidden) {
                                detailsRegion.classList.remove('hidden');
                                toggleBtn.setAttribute('aria-expanded', 'true');
                                updateBtnText(true);
                            } else {
                                detailsRegion.classList.add('hidden');
                                toggleBtn.setAttribute('aria-expanded', 'false');
                                updateBtnText(false);
                            }
                        };

                        blockWrapper.appendChild(toggleBtn);
                        blockWrapper.appendChild(detailsRegion);
                    }
                    
                    nodeWrapper.appendChild(blockWrapper);
                }
            }

            // --- 3. Children ---
            if (node.children && node.children.length > 0) {
                const childrenContainer = document.createElement('div');
                // Indentation logic: simple left margin
                childrenContainer.className = "ml-4 sm:ml-8 border-l border-slate-100 pl-4 sm:pl-8";
                
                node.children.forEach(child => {
                    renderQuestionNode(child, childrenContainer, depth + 1);
                });
                
                nodeWrapper.appendChild(childrenContainer);
            }

            container.appendChild(nodeWrapper);
        }

        // Helper for Solution Subsections
        function createSubSection(label, markdownContent, contentClasses) {
            const wrapper = document.createElement('div');
            
            const labelEl = document.createElement('h4');
            labelEl.className = "text-xs uppercase tracking-wider font-bold text-slate-500 mb-1.5";
            labelEl.textContent = label;
            
            const bodyEl = document.createElement('div');
            bodyEl.className = `prose prose-slate max-w-none ${contentClasses}`;
            // Override prose defaults for math/tables
            bodyEl.innerHTML = md ? md.render(markdownContent) : markdownContent;
            
            wrapper.appendChild(labelEl);
            wrapper.appendChild(bodyEl);
            return wrapper;
        }

        // --- NAVIGATION GENERATION ---

        function addNavItem(node) {
            // Identifier Nav Item
            const createItem = (id, depth) => {
                const btn = document.createElement('button');
                btn.className = `w-full text-left py-1 px-2 rounded hover:bg-slate-100 focus:bg-slate-50 transition-colors text-slate-600 hover:text-slate-900 block`;
                
                // Typography hierarchy: Depth 0 = Normal, Depth > 0 = Smaller/Lighter
                if (depth === 0) {
                    btn.classList.add('text-sm', 'font-medium');
                } else {
                    btn.classList.add('text-xs', 'font-normal', 'opacity-90');
                }
                
                btn.textContent = id;
                btn.onclick = () => scrollToQuestion(id);
                
                return btn;
            };

            const item = createItem(node.id, 0); // Flat list visual, but could use depth if we tracked it in flattened list. For now, treating all top-level prompts as base. 
            // Actually, node.id often encodes depth (1, 1a, 1ai). 
            // Design brief says "Hierarchy via type scale/quietness". 
            // Since we receive a recursive tree, let's flatten it for Nav logic or just process recursively.
            
            // Re-implementing recursive nav add to capture depth correctly
            function recursiveAdd(n, d) {
                const el = createItem(n.id, d);
                desktopNavList.appendChild(el.cloneNode(true));
                mobileNavList.appendChild(el.cloneNode(true)); // Add to mobile too

                if (n.children) {
                    n.children.forEach(c => recursiveAdd(c, d + 1));
                }
            }
            recursiveAdd(node, 0);
        }

        function addNavSectionLabel(label) {
            const createLabel = () => {
                const el = document.createElement('div');
                el.className = "mt-4 mb-2 text-xs font-bold text-slate-400 uppercase tracking-widest px-2 select-none";
                el.textContent = label;
                return el;
            };
            desktopNavList.appendChild(createLabel());
            mobileNavList.appendChild(createLabel().cloneNode(true));
        }

        function addNavSeparator() {
            const createSep = () => {
                const el = document.createElement('div');
                el.className = "my-2 h-px bg-slate-100 mx-2";
                return el;
            };
            desktopNavList.appendChild(createSep());
            mobileNavList.appendChild(createSep().cloneNode(true));
        }

        // --- INTERACTIONS ---

        function scrollToQuestion(id) {
            const el = document.getElementById(`q-${id}`);
            if (el) {
                // Offset for sticky header
                const headerOffset = 80;
                const elementPosition = el.getBoundingClientRect().top;
                const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
                
                window.scrollTo({
                    top: offsetPosition,
                    behavior: "smooth"
                });
                
                // Close mobile drawer if open
                closeMobileDrawer();
            }
        }

        function renderMath() {
            if (window.renderMathInElement) {
                renderMathInElement(document.body, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false}
                    ],
                    throwOnError: false
                });
            }
        }

        function escapeHtml(text) {
            if (!text) return text;
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // --- MOBILE DRAWER LOGIC ---
        function openMobileDrawer() {
            mobileDrawer.classList.remove('translate-x-full');
            mobileBackdrop.classList.remove('hidden');
            // small delay to allow display:block to apply before opacity transition
            setTimeout(() => {
                mobileBackdrop.classList.remove('opacity-0');
            }, 10);
            document.body.style.overflow = 'hidden'; // Lock scroll
        }

        function closeMobileDrawer() {
            mobileDrawer.classList.add('translate-x-full');
            mobileBackdrop.classList.add('opacity-0');
            setTimeout(() => {
                mobileBackdrop.classList.add('hidden');
            }, 300);
            document.body.style.overflow = ''; // Unlock scroll
        }

        mobileTrigger.addEventListener('click', openMobileDrawer);
        closeDrawerBtn.addEventListener('click', closeMobileDrawer);
        mobileBackdrop.addEventListener('click', closeMobileDrawer);

        // --- SCROLL SPY (Active Nav) ---
        // Simple IntersectionObserver for highlighting nav
        const observerOptions = {
            root: null,
            rootMargin: '-20% 0px -60% 0px',
            threshold: 0
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const id = entry.target.id.replace('q-', '');
                    updateActiveNav(id);
                }
            });
        }, observerOptions);

        // MutationObserver to attach ScrollSpy when content changes
        const contentObserver = new MutationObserver(() => {
            document.querySelectorAll('[id^="q-"]').forEach(el => observer.observe(el));
        });
        contentObserver.observe(paperContent, { childList: true, subtree: true });

        function updateActiveNav(id) {
            // Reset all
            document.querySelectorAll('nav button, #mobile-nav-list button').forEach(btn => {
                btn.classList.remove('font-bold', 'text-brand-700', 'bg-slate-50');
                if (btn.textContent === id) {
                    btn.classList.add('font-bold', 'text-brand-700', 'bg-slate-50');
                    btn.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                }
            });
        }

        // --- BOOTSTRAP ---
        init();

    </script>
</body>
</html>
