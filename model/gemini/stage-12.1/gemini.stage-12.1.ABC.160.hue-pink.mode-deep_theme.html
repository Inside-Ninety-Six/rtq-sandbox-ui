<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"ABC","indexWithinVariant":"160","totalWithinVariant":"320","hueFamily":"pink","intensityMode":"deep_theme","timestamp":"2026-01-07T16:54:32.338Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;ABC&quot;,&quot;indexWithinVariant&quot;:&quot;160&quot;,&quot;totalWithinVariant&quot;:&quot;320&quot;,&quot;hueFamily&quot;:&quot;pink&quot;,&quot;intensityMode&quot;:&quot;deep_theme&quot;,&quot;timestamp&quot;:&quot;2026-01-07T16:54:32.338Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Viewer Prototype</title>
    
    <!-- TAILWIND CSS (Prototyping) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- MARKDOWN-IT -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/13.0.1/markdown-it.min.js"></script>
    
    <!-- KATEX CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css">
    
    <!-- KATEX JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/contrib/auto-render.min.js"></script>

    <!-- LUCIDE ICONS -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- COLORLAB CONFIGURATION (Add-on B & C Implementation) -->
    <!-- 
       Selected Hue Family: "blue" (Hue angle approx 250-260)
       Selected Intensity Mode: "tinted_neutrals" (Mode 2)
       
       Mode 2 "tinted_neutrals" Rules:
       1. Core surfaces C in [0.015 .. 0.035]
       2. Wash surfaces C in [0.025 .. 0.045]
       3. Text Primary C <= 0.010, Secondary C <= 0.012
       4. Accent C in [0.10 .. 0.16]
    -->
    <style>
        :root {
            /* Base Hue: 260 (Blue) */
            
            /* Surfaces */
            --col-page-bg: oklch(0.97 0.02 260);    /* Mode 2 compliant */
            --col-frame-bg: oklch(0.985 0.015 260); /* Mode 2 compliant */
            --col-paper-bg: oklch(0.99 0.015 260);  /* Mode 2 compliant */
            
            /* Washes & Differentiation */
            --col-wash-bg: oklch(0.96 0.03 260);    /* Mode 2 compliant */
            --col-nav-hover: oklch(0.95 0.025 260);
            
            /* Typography (Low Chroma) */
            --col-text-primary: oklch(0.20 0.01 260);   /* C <= 0.010 */
            --col-text-secondary: oklch(0.45 0.012 260); /* C <= 0.012 */
            --col-text-tertiary: oklch(0.60 0.012 260);
            
            /* Accents & UI (Restrained) */
            --col-accent: oklch(0.55 0.14 260);     /* C in [0.10 .. 0.16] */
            --col-accent-focus: oklch(0.55 0.14 260 / 0.4);
            
            /* Dividers */
            --col-divider: oklch(0.92 0.02 260);
            --col-divider-strong: oklch(0.88 0.02 260);
        }

        /* Base Typography & Reset */
        body {
            background-color: var(--col-page-bg);
            color: var(--col-text-primary);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            overflow-y: scroll; /* Force vertical scrollbar to avoid layout shift */
        }

        /* Focus Styles (Stage 5.5.2) */
        :focus-visible {
            outline: 2px solid var(--col-accent);
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* Scrollbar Hiding for Nav (Stage 6 Add-on) */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* KaTeX Containment Invariant (Stage 6.0.8) */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding: 0.5rem 0;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Inline Math Transparency Rule (Stage 5.8.4) */
        .katex {
            background-color: transparent !important;
        }
        
        /* Table Styles (Stage 5.8.5) */
        .rtq-md-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            font-size: 0.95em;
        }
        .rtq-md-content th, .rtq-md-content td {
            border: 1px solid var(--col-divider);
            padding: 0.5rem;
            text-align: left;
        }
        .rtq-md-content th {
            font-weight: 600;
            color: var(--col-text-primary);
        }
        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-bottom: 1rem;
        }

        /* Markdown Content Resets */
        .rtq-md-content p {
            margin-bottom: 0.75rem;
            line-height: 1.6;
        }
        .rtq-md-content p:last-child {
            margin-bottom: 0;
        }
        .rtq-md-content ul {
            list-style-type: disc;
            padding-left: 1.5rem;
            margin-bottom: 0.75rem;
        }
        .rtq-md-content ol {
            list-style-type: decimal;
            padding-left: 1.5rem;
            margin-bottom: 0.75rem;
        }
        .rtq-md-content img, .rtq-md-content svg {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 1rem 0;
        }
        
        /* Utility for sticky nav */
        .sticky-nav {
            position: sticky;
            top: 2rem;
            max-height: calc(100vh - 4rem);
            overflow-y: auto;
        }

        /* Layout Primitives */
        .frame-shell {
            background-color: var(--col-frame-bg);
            min-height: 100vh;
        }
        
        .nav-item-active {
            font-weight: 700;
            color: var(--col-text-primary);
        }
        .nav-item-inactive {
            font-weight: 400;
            color: var(--col-text-secondary);
        }
        .nav-item-inactive:hover {
            color: var(--col-text-primary);
        }
    </style>
</head>
<body class="antialiased text-base selection:bg-blue-100 selection:text-blue-900">

    <!-- TOP CONTROLS REGION -->
    <div class="w-full border-b border-[var(--col-divider)] bg-[var(--col-frame-bg)] sticky top-0 z-40">
        <div class="max-w-6xl mx-auto px-4 md:px-8 h-16 flex items-center justify-between">
            <!-- Paper Selector -->
            <div class="flex items-center gap-3">
                <label for="paper-select" class="text-sm font-medium text-[var(--col-text-secondary)]">Paper:</label>
                <select id="paper-select" class="bg-transparent border border-[var(--col-divider-strong)] text-[var(--col-text-primary)] text-sm rounded px-2 py-1 focus:ring-2 focus:ring-[var(--col-accent)] outline-none cursor-pointer">
                    <option disabled selected>Loading papers...</option>
                </select>
            </div>

            <!-- Mobile "Jump to" Trigger -->
            <button id="mobile-jump-trigger" class="md:hidden flex items-center gap-2 text-sm font-medium text-[var(--col-accent)] px-3 py-1.5 rounded hover:bg-[var(--col-nav-hover)] transition-colors">
                <i data-lucide="menu" class="w-4 h-4"></i>
                <span>Jump to</span>
            </button>
        </div>
    </div>

    <!-- DOCUMENT FRAME SHELL -->
    <div class="frame-shell w-full">
        <div class="max-w-6xl mx-auto px-4 md:px-8 py-8 flex gap-12 relative">
            
            <!-- DESKTOP NAVIGATION RAIL (Left Column) -->
            <nav class="hidden md:block w-48 shrink-0 relative">
                <div class="sticky-nav no-scrollbar pr-4">
                    <div id="desktop-nav-list" class="flex flex-col gap-1">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </nav>

            <!-- PAPER DOCUMENT COLUMN (Right Column) -->
            <main class="flex-1 min-w-0 pb-32">
                <div id="paper-content" class="bg-[var(--col-paper-bg)]">
                    <!-- Populated by JS -->
                    <div class="py-12 text-center text-[var(--col-text-secondary)]">Loading content...</div>
                </div>
            </main>

        </div>
    </div>

    <!-- MOBILE NAVIGATION DRAWER -->
    <div id="mobile-drawer-backdrop" class="fixed inset-0 bg-black/50 z-50 hidden transition-opacity opacity-0" aria-hidden="true"></div>
    <div id="mobile-drawer" class="fixed inset-y-0 right-0 w-64 bg-[var(--col-frame-bg)] z-50 transform translate-x-full transition-transform duration-300 shadow-xl flex flex-col">
        <div class="p-4 border-b border-[var(--col-divider)] flex items-center justify-between">
            <h2 class="text-lg font-semibold text-[var(--col-text-primary)]">Jump to</h2>
            <button id="mobile-drawer-close" class="p-2 text-[var(--col-text-secondary)] hover:text-[var(--col-text-primary)]">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>
        <div class="flex-1 overflow-y-auto p-4 no-scrollbar">
            <div id="mobile-nav-list" class="flex flex-col gap-3">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- STAGE 0: CONSTANTS ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        
        // --- CONSTANTS & STATE ---
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json"; // Required by brief constants, unused in logic but defined.
        
        const state = {
            papers: [],
            currentPaperKey: null,
            expandedSolutionDetails: new Set(), // Set of question IDs
            isMobileDrawerOpen: false
        };

        // --- MARKDOWN CONFIGURATION (STAGE 6.0.7 / 6 Implementation Add-on) ---
        // html: true (SVG passthrough), breaks: false (KaTeX fix)
        const md = window.markdownit ? window.markdownit({
            html: true,
            linkify: true,
            breaks: false 
        }) : null;

        if (md) {
            // Disable inline escape to preserve TeX backslashes
            md.inline.ruler.disable(['escape']);
        }

        // --- DOM ELEMENTS ---
        const els = {
            paperSelect: document.getElementById('paper-select'),
            paperContent: document.getElementById('paper-content'),
            desktopNavList: document.getElementById('desktop-nav-list'),
            mobileNavList: document.getElementById('mobile-nav-list'),
            mobileJumpTrigger: document.getElementById('mobile-jump-trigger'),
            mobileDrawer: document.getElementById('mobile-drawer'),
            mobileDrawerBackdrop: document.getElementById('mobile-drawer-backdrop'),
            mobileDrawerClose: document.getElementById('mobile-drawer-close')
        };

        // --- INIT ---
        async function init() {
            try {
                // Determine fetch method based on env (assuming relative path works for local/hosted)
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Payload fetch failed");
                const payload = await response.json();
                
                if (!payload.papers || payload.papers.length === 0) {
                    throw new Error("No papers in payload");
                }

                state.papers = payload.papers;
                
                // Populate selector
                els.paperSelect.innerHTML = state.papers.map(p => 
                    `<option value="${p.key}">${p.label}</option>`
                ).join('');
                
                // Listeners
                els.paperSelect.addEventListener('change', (e) => loadPaper(e.target.value));
                setupMobileDrawer();

                // Load first paper
                loadPaper(state.papers[0].key);

            } catch (err) {
                console.error(err);
                renderError();
            }
        }

        function renderError() {
            els.paperContent.innerHTML = `
                <div class="flex flex-col items-center justify-center py-20 text-[var(--col-text-tertiary)]">
                    <i data-lucide="file-warning" class="w-12 h-12 mb-4 opacity-50"></i>
                    <p class="font-medium tracking-wide">PAPERS PAYLOAD MISSING</p>
                </div>
            `;
            els.paperSelect.disabled = true;
            els.paperSelect.innerHTML = `<option>Error loading</option>`;
        }

        // --- CORE LOGIC ---

        function loadPaper(paperKey) {
            const paper = state.papers.find(p => p.key === paperKey);
            if (!paper) return;

            state.currentPaperKey = paperKey;
            
            // Set defaults (Show working default state)
            state.expandedSolutionDetails.clear();
            const defaultExpanded = paper.defaults?.expandedAll !== false;
            
            // Helper to recurse and set default state
            function initDefaults(nodes) {
                if (!nodes) return;
                nodes.forEach(node => {
                    if (node.solutionBlock?.solutionDetails && defaultExpanded) {
                        state.expandedSolutionDetails.add(node.id);
                    }
                    if (node.children) initDefaults(node.children);
                });
            }
            
            if (paper.sections) {
                paper.sections.forEach(sec => initDefaults(sec.questions));
            } else if (paper.questions) {
                initDefaults(paper.questions);
            }

            renderPaper(paper);
            renderNavigation(paper);
            
            // Re-run icons and math
            lucide.createIcons();
            renderMathInElement(document.body, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false}
                ],
                throwOnError: false
            });
            
            // Reset scroll
            window.scrollTo(0, 0);
        }

        function renderPaper(paper) {
            let html = '';

            // Handle sectioned vs flat
            if (paper.sections) {
                paper.sections.forEach(section => {
                    // Stage 3/5.4.6: Section Header (if label exists)
                    if (section.label && section.label.trim().length > 0) {
                        html += `
                            <div class="mb-8 pt-4 border-t border-[var(--col-divider)] first:border-0 first:pt-0">
                                <h2 class="text-xl font-semibold text-[var(--col-text-primary)] mb-6">${section.label}</h2>
                            </div>
                        `;
                    }
                    html += `<div class="flex flex-col gap-12 mb-12">`; // Question list container
                    section.questions.forEach(q => {
                        html += renderQuestionNode(q, 0);
                    });
                    html += `</div>`;
                });
            } else if (paper.questions) {
                html += `<div class="flex flex-col gap-16">`; // Top-level gap (largest)
                paper.questions.forEach(q => {
                    html += renderQuestionNode(q, 0);
                });
                html += `</div>`;
            } else {
                html = `<p class="p-8 text-[var(--col-text-secondary)]">No questions found.</p>`;
            }

            els.paperContent.innerHTML = html;
        }

        // Recursive Question Renderer
        function renderQuestionNode(node, depth) {
            const isTopLevel = depth === 0;
            const hasSolutionBlock = !!node.solutionBlock;
            const hasAnswer = hasSolutionBlock && !!node.solutionBlock.answer;
            const hasSolutionDetails = hasSolutionBlock && !!node.solutionBlock.solutionDetails;
            const isExpanded = state.expandedSolutionDetails.has(node.id);

            // Spacing logic (Stage 5.1): Depth-based separation handled by parent containers, 
            // but internal child spacing needs care.
            
            // Wrapper ID for navigation
            const wrapperId = `q-${node.id.replace(/[^a-zA-Z0-9]/g, '-')}`;

            // Indentation for children (Stage 3.E) - pure spacing, responsive
            const indentClass = depth > 0 ? 'pl-4 md:pl-8 border-l border-transparent' : '';
            
            // Question Body
            const qIdentifier = `<span class="font-bold text-[var(--col-text-secondary)] mr-2 select-none text-lg">${node.id}</span>`;
            const qPrompt = renderMd(node.question);

            // Solution Block Logic
            let solutionBlockHtml = '';
            
            if (hasSolutionBlock) {
                // Answer
                let answerHtml = '';
                if (hasAnswer) {
                    answerHtml = `
                        <div class="mt-6 flex flex-col items-start gap-1">
                            <span class="text-xs font-bold uppercase tracking-wider text-[var(--col-text-tertiary)]">Answer</span>
                            <div class="text-[var(--col-text-primary)] font-medium">
                                ${renderMd(node.solutionBlock.answer)}
                            </div>
                        </div>
                    `;
                }

                // Solution Details Control & Content
                let detailsHtml = '';
                if (hasSolutionDetails) {
                    const btnLabel = isExpanded ? "Hide working" : "Show working";
                    const btnIcon = isExpanded ? "chevron-up" : "chevron-down";
                    
                    // Toggle Button
                    const toggleBtn = `
                        <button onclick="toggleWorking('${node.id}')" 
                            class="group mt-4 flex items-center gap-1.5 text-sm font-medium text-[var(--col-accent)] hover:text-[var(--col-text-primary)] transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-[var(--col-accent)] rounded px-1 -ml-1">
                            <span>${btnLabel}</span>
                            <i data-lucide="${btnIcon}" class="w-4 h-4 transition-transform group-hover:translate-y-0.5"></i>
                        </button>
                    `;

                    // Expanded Content (Stage 3 & 5.9)
                    let expandedContent = '';
                    if (isExpanded) {
                        const sd = node.solutionBlock.solutionDetails;
                        
                        // Keep in mind
                        if (sd.keepInMind) {
                            expandedContent += `
                                <div class="mb-6 text-sm text-[var(--col-text-secondary)]">
                                    <div class="flex items-center gap-2 mb-2 font-bold text-[var(--col-text-primary)]">
                                        <i data-lucide="lightbulb" class="w-4 h-4"></i>
                                        <span>Keep in mind</span>
                                    </div>
                                    <div class="rtq-md-content">${renderMd(sd.keepInMind)}</div>
                                </div>
                            `;
                        }

                        // Formulas used
                        if (sd.formulasUsed) {
                            expandedContent += `
                                <div class="mb-6 text-sm">
                                    <div class="font-bold text-[var(--col-text-primary)] mb-2">Formulas used</div>
                                    <div class="rtq-md-content text-[var(--col-text-secondary)]">${renderMd(sd.formulasUsed)}</div>
                                </div>
                            `;
                        }

                        // Working (Primary)
                        if (sd.working) {
                            expandedContent += `
                                <div class="mb-6">
                                    <div class="font-bold text-[var(--col-text-primary)] text-sm mb-3">Working</div>
                                    <div class="rtq-md-content text-[var(--col-text-primary)] text-base">${renderMd(sd.working)}</div>
                                </div>
                            `;
                        }

                        // Alternative working (Array)
                        if (sd.alternativeWorking && Array.isArray(sd.alternativeWorking)) {
                            sd.alternativeWorking.forEach((alt, idx) => {
                                // Separator (Stage 5.8.7): Label + stronger separation
                                expandedContent += `
                                    <div class="mt-8 pt-6 border-t border-[var(--col-divider)]">
                                        <div class="font-bold text-[var(--col-text-primary)] text-sm mb-3">Alternative working</div>
                                        <div class="rtq-md-content text-[var(--col-text-primary)] text-base">${renderMd(alt)}</div>
                                    </div>
                                `;
                            });
                        }

                        // Wrapper for the wash/surface (Stage 5.3.3 / Mode 2 tinted wash)
                        expandedContent = `
                            <div class="mt-3 p-4 md:p-6 rounded-sm bg-[var(--col-wash-bg)] border-l-2 border-[var(--col-divider-strong)] animate-in fade-in slide-in-from-top-1 duration-200">
                                ${expandedContent}
                            </div>
                        `;
                    }

                    detailsHtml = toggleBtn + expandedContent;
                }

                // Separator Question -> Solution (Stage 5.1.3: spacing required)
                // If we have content, wrap it.
                if (answerHtml || detailsHtml) {
                    solutionBlockHtml = `
                        <div class="mt-4">
                            ${answerHtml}
                            ${detailsHtml}
                        </div>
                    `;
                }
            }

            // Children
            let childrenHtml = '';
            if (node.children && node.children.length > 0) {
                childrenHtml = `<div class="mt-6 flex flex-col gap-8">`;
                node.children.forEach(child => {
                    childrenHtml += renderQuestionNode(child, depth + 1);
                });
                childrenHtml += `</div>`;
            }

            // Assembly
            // Top-level nodes get more vertical padding handled by parent gap, but we ensure the node itself is a block.
            return `
                <div id="${wrapperId}" class="group/node ${indentClass} scroll-mt-24">
                    <!-- Question Body -->
                    <div class="text-[var(--col-text-primary)] text-lg leading-relaxed">
                        ${qIdentifier}
                        <div class="inline rtq-md-content">${qPrompt}</div>
                    </div>
                    
                    <!-- Solution Block -->
                    ${solutionBlockHtml}

                    <!-- Children -->
                    ${childrenHtml}
                </div>
            `;
        }

        // --- NAVIGATION LOGIC ---

        function renderNavigation(paper) {
            // Flatten the structure for the nav list
            // Stage 5.4.5: Flat list, hierarchy via type scale/weight, sections as separators
            
            const navItems = [];
            
            function extractItems(nodes, depth) {
                if (!nodes) return;
                nodes.forEach(node => {
                    navItems.push({ 
                        id: node.id, 
                        label: node.id, 
                        depth: depth,
                        targetId: `q-${node.id.replace(/[^a-zA-Z0-9]/g, '-')}`
                    });
                    if (node.children) extractItems(node.children, depth + 1);
                });
            }

            let navHtml = '';

            if (paper.sections) {
                paper.sections.forEach((sec, idx) => {
                    // Section Label (Non-clickable, Stage 5.4.6)
                    if (sec.label && sec.label.trim()) {
                        const mt = idx > 0 ? 'mt-6' : 'mt-2';
                        navHtml += `
                            <div class="${mt} mb-2 text-xs font-bold text-[var(--col-text-tertiary)] uppercase tracking-widest px-2 select-none">
                                ${sec.label}
                            </div>
                        `;
                    }
                    // Process section items
                    const sectionItems = [];
                    // Temp array to capture flat list for this section
                    const tempItems = [];
                    extractItems(sec.questions, 0); 
                    // Note: extractItems pushes to global navItems if we passed it, but here we want local string build.
                    // Let's refactor slightly to just iterate.
                    
                    const flatSectionNodes = [];
                    const traverse = (nodes, d) => {
                        nodes.forEach(n => {
                            flatSectionNodes.push({id: n.id, depth: d});
                            if (n.children) traverse(n.children, d + 1);
                        });
                    };
                    traverse(sec.questions, 0);

                    flatSectionNodes.forEach(item => {
                        navHtml += renderNavItem(item);
                    });
                });
            } else if (paper.questions) {
                const flatNodes = [];
                const traverse = (nodes, d) => {
                    nodes.forEach(n => {
                        flatNodes.push({id: n.id, depth: d});
                        if (n.children) traverse(n.children, d + 1);
                    });
                };
                traverse(paper.questions, 0);
                
                flatNodes.forEach(item => {
                    navHtml += renderNavItem(item);
                });
            }

            els.desktopNavList.innerHTML = navHtml;
            els.mobileNavList.innerHTML = navHtml;

            // Setup IntersectionObserver for active state
            setupScrollSpy();
        }

        function renderNavItem(item) {
            // Hierarchy via type scale (Stage 5.4.5)
            // Depth 0: Normal size. Depth > 0: Smaller, lighter.
            // Flat alignment (px-2).
            const isTop = item.depth === 0;
            const textSize = isTop ? 'text-sm' : 'text-xs';
            const textColor = isTop ? 'nav-item-inactive' : 'text-[var(--col-text-tertiary)] hover:text-[var(--col-text-secondary)]';
            
            const targetId = `q-${item.id.replace(/[^a-zA-Z0-9]/g, '-')}`;

            return `
                <a href="#${targetId}" 
                   class="block px-3 py-1.5 rounded transition-colors ${textSize} ${textColor} hover:bg-[var(--col-nav-hover)] truncate data-[active=true]:font-bold data-[active=true]:text-[var(--col-accent)] data-[active=true]:bg-[var(--col-nav-hover)]"
                   data-nav-target="${targetId}"
                   onclick="handleNavClick(event, '${targetId}')">
                   ${item.id}
                </a>
            `;
        }

        // --- INTERACTIONS ---

        window.toggleWorking = (questionId) => {
            if (state.expandedSolutionDetails.has(questionId)) {
                state.expandedSolutionDetails.delete(questionId);
            } else {
                state.expandedSolutionDetails.add(questionId);
            }
            
            // Re-render specific node would be ideal, but for prototype simpler to re-render paper 
            // OR find the specific node in DOM.
            // Given "re-render paper" preserves scroll in this simple setup (browser handles it mostly), 
            // but to be smooth (Stage 5.5.3), we should try to keep DOM stable.
            // For this stress-test harness, full re-render is acceptable IF fast enough.
            // Optimization: Just re-render the specific question node logic?
            // Let's do full re-render + scroll restoration if needed, but actually browser keeps scroll pos on simple HTML replace usually.
            // BETTER: Find the paper data, re-render just that node HTML and swap it?
            // Implementation: Full re-render. It's a prototype.
            
            // SAVE SCROLL
            const scrollY = window.scrollY;
            renderPaper(state.papers.find(p => p.key === state.currentPaperKey));
            
            // Re-init math/icons
            lucide.createIcons();
            renderMathInElement(document.body, {delimiters: [{left: '$$', right: '$$', display: true},{left: '$', right: '$', display: false}], throwOnError: false});
            
            // RESTORE SCROLL (Browser might have shifted due to height change, but we want anchor stability? 
            // Actually spec says "Scroll position stability: expanding must not intentionally reposition beyond natural shift".
            // So letting the browser handle the flow reflow is actually correct behavior. 
            // We just need to ensure we don't jump to top.)
            window.scrollTo(0, scrollY);
        };

        window.handleNavClick = (e, targetId) => {
            e.preventDefault();
            const el = document.getElementById(targetId);
            if (el) {
                el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                // If mobile, close drawer
                if (state.isMobileDrawerOpen) toggleMobileDrawer(false);
            }
        };

        function setupMobileDrawer() {
            els.mobileJumpTrigger.addEventListener('click', () => toggleMobileDrawer(true));
            els.mobileDrawerClose.addEventListener('click', () => toggleMobileDrawer(false));
            els.mobileDrawerBackdrop.addEventListener('click', () => toggleMobileDrawer(false));
        }

        function toggleMobileDrawer(isOpen) {
            state.isMobileDrawerOpen = isOpen;
            if (isOpen) {
                els.mobileDrawerBackdrop.classList.remove('hidden', 'opacity-0');
                els.mobileDrawer.classList.remove('translate-x-full');
            } else {
                els.mobileDrawerBackdrop.classList.add('opacity-0');
                els.mobileDrawer.classList.add('translate-x-full');
                setTimeout(() => {
                    if (!state.isMobileDrawerOpen) els.mobileDrawerBackdrop.classList.add('hidden');
                }, 300);
            }
        }

        // --- UTILS ---

        function renderMd(text) {
            if (!md || !text) return text || '';
            // Markdown-it renders to HTML.
            // Tables need a wrapper for overflow (Stage 5.8.5)
            let html = md.render(text);
            // Simple string replace to wrap tables if markdown-it doesn't (it doesn't by default).
            // Regex to wrap <table>...</table> in <div class="table-wrapper">
            html = html.replace(/(<table[\s\S]*?<\/table>)/g, '<div class="table-wrapper">$1</div>');
            return html;
        }

        // Scroll Spy for Nav
        function setupScrollSpy() {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        // Activate nav item
                        const id = entry.target.id;
                        document.querySelectorAll('[data-nav-target]').forEach(link => {
                            if (link.dataset.navTarget === id) {
                                link.setAttribute('data-active', 'true');
                                link.classList.add('font-bold', 'text-[var(--col-accent)]', 'bg-[var(--col-nav-hover)]');
                                link.classList.remove('nav-item-inactive');
                            } else {
                                link.removeAttribute('data-active');
                                link.classList.remove('font-bold', 'text-[var(--col-accent)]', 'bg-[var(--col-nav-hover)]');
                                link.classList.add('nav-item-inactive');
                            }
                        });
                    }
                });
            }, { rootMargin: '-10% 0px -80% 0px' }); // Trigger near top

            document.querySelectorAll('[id^="q-"]').forEach(el => observer.observe(el));
        }

        // Start
        init();

    </script>
</body>
</html>
