<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"ABC","indexWithinVariant":"293","totalWithinVariant":"320","hueFamily":"blue","intensityMode":"accent_only","timestamp":"2026-01-07T23:07:42.862Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;ABC&quot;,&quot;indexWithinVariant&quot;:&quot;293&quot;,&quot;totalWithinVariant&quot;:&quot;320&quot;,&quot;hueFamily&quot;:&quot;blue&quot;,&quot;intensityMode&quot;:&quot;accent_only&quot;,&quot;timestamp&quot;:&quot;2026-01-07T23:07:42.862Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>
    
    <!-- External Libraries (CDN) - No Integrity as per Stage 6 rules -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <style>
        /* =========================================
           STAGE 6 ADD-ON: COLORLAB C (ACCENT ONLY)
           + COLORLAB B (FORCE HUE: BLUE)
           + OKLCH & LIGHT MODE ONLY
           ========================================= */
        :root {
            /* Palette Definition - Mode: accent_only, Hue: Blue (approx 265) */
            --hue-base: 265;
            
            /* Surfaces (C <= 0.015) */
            --surf-page: oklch(0.99 0.002 var(--hue-base));
            --surf-frame: oklch(0.99 0.002 var(--hue-base));
            --surf-paper: oklch(0.99 0.002 var(--hue-base));
            --surf-wash-solution: oklch(0.985 0.005 var(--hue-base)); /* Minimal wash for expanded area */
            --surf-nav-overlay: oklch(0.99 0.002 var(--hue-base));

            /* Text (C <= 0.010) */
            --txt-primary: oklch(0.18 0.008 var(--hue-base));
            --txt-secondary: oklch(0.45 0.010 var(--hue-base));
            --txt-tertiary: oklch(0.60 0.010 var(--hue-base));

            /* Accent (C in [0.08 .. 0.14]) */
            --accent-primary: oklch(0.55 0.13 var(--hue-base));
            --accent-hover: oklch(0.50 0.13 var(--hue-base));
            --focus-ring: oklch(0.55 0.13 var(--hue-base));

            /* Separators */
            --border-hairline: oklch(0.92 0.005 var(--hue-base));
            
            /* Spacing Constants (Stage 3/5 Rhythm) */
            --sp-unit: 1rem;
            --sp-q-gap: 3.5rem;    /* Top level question gap */
            --sp-internal: 1rem;   /* Internal question spacing */
            --sp-tight: 0.5rem;
            
            /* Font */
            --font-sans: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        /* =========================================
           RESET & BASE STYLES
           ========================================= */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-sans);
            background-color: var(--surf-page);
            color: var(--txt-primary);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            overflow-y: scroll; /* Force scrollbar stability */
        }

        /* Focus States (Stage 5.5.2) */
        :focus-visible {
            outline: 2px solid var(--focus-ring);
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* Markdown Content Reset */
        .markdown-body p { margin-bottom: 0.75em; }
        .markdown-body p:last-child { margin-bottom: 0; }
        .markdown-body ul, .markdown-body ol { margin-left: 1.25em; margin-bottom: 0.75em; }
        .markdown-body table { border-collapse: collapse; width: 100%; margin-bottom: 1em; font-size: 0.95em; }
        .markdown-body th, .markdown-body td { border: 1px solid var(--border-hairline); padding: 0.5em; text-align: left; }
        .markdown-body th { font-weight: 600; background: transparent; }
        
        /* KaTeX Containment (Stage 3 & 6.0.8) */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding: 0.5em 0;
            /* Scrollbar hiding for neatness while keeping function */
            scrollbar-width: thin; 
        }

        /* =========================================
           LAYOUT STRUCTURE (Stage 3)
           ========================================= */
        .app-shell {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            max-width: 1280px;
            margin: 0 auto;
        }

        /* Top Controls */
        .top-controls {
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: var(--surf-page);
            position: sticky;
            top: 0;
            z-index: 50;
            border-bottom: 1px solid transparent; /* Optical anchor */
        }

        .paper-select {
            font-family: inherit;
            font-size: 0.95rem;
            padding: 0.4rem 0.8rem;
            border: 1px solid var(--border-hairline);
            border-radius: 4px;
            background: transparent;
            color: var(--txt-primary);
            cursor: pointer;
        }

        /* Document Frame Shell */
        .document-frame {
            display: flex;
            flex: 1;
            position: relative;
        }

        /* Navigation Rail (Desktop) */
        .nav-rail {
            width: 240px;
            flex-shrink: 0;
            display: none; /* Hidden on mobile */
            padding: 1rem 1rem 1rem 1.5rem;
            position: sticky;
            top: 60px; /* Offset for top controls */
            height: calc(100vh - 60px);
            overflow-y: auto;
            border-right: 1px solid var(--border-hairline);
            
            /* Scrollbar hiding logic (Add-on) */
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .nav-rail::-webkit-scrollbar { display: none; }

        /* Mobile Nav Drawer */
        .mobile-jump-trigger {
            display: block; /* Visible mobile */
            background: none;
            border: none;
            color: var(--accent-primary);
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
        }
        .nav-drawer-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.2);
            z-index: 100;
            display: none;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .nav-drawer {
            position: fixed;
            top: 0; right: 0; bottom: 0;
            width: 280px;
            background: var(--surf-nav-overlay);
            z-index: 101;
            transform: translateX(100%);
            transition: transform 0.25s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex;
            flex-direction: column;
            box-shadow: -4px 0 12px rgba(0,0,0,0.05);
        }
        .nav-drawer.open { transform: translateX(0); }
        .nav-drawer-overlay.open { display: block; opacity: 1; }

        .drawer-header {
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-hairline);
        }
        .drawer-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            line-height: 1;
            color: var(--txt-secondary);
            cursor: pointer;
        }
        .drawer-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem 1.5rem;
        }

        /* Navigation List Styles (Shared) */
        .nav-list {
            list-style: none;
        }
        .nav-section-label {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--txt-tertiary);
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }
        .nav-item {
            display: block;
            text-decoration: none;
            color: var(--txt-secondary);
            font-size: 0.9rem;
            padding: 0.25rem 0;
            transition: color 0.15s ease;
            cursor: pointer;
            border-left: 2px solid transparent;
            padding-left: 0.75rem;
            margin-left: -0.75rem; /* Optical alignment */
        }
        .nav-item:hover {
            color: var(--txt-primary);
            background-color: rgba(0,0,0,0.02); /* Minimal interaction feedback */
        }
        .nav-item.active {
            color: var(--txt-primary);
            font-weight: 600;
            border-left-color: var(--accent-primary); /* Accent allowed for Nav State */
        }
        /* Hierarchy via type scale (Stage 5.4.5) */
        .nav-item[data-depth="0"] { font-size: 0.95rem; }
        .nav-item[data-depth="1"] { font-size: 0.9rem; }
        .nav-item[data-depth="2"] { font-size: 0.85rem; }

        /* Paper Content Region */
        .paper-column {
            flex: 1;
            min-width: 0; /* Flexbox text overflow fix */
            padding: 2rem 1.5rem 8rem 1.5rem;
        }
        .paper-surface {
            max-width: 720px;
            margin: 0 auto; /* Centered in column, but column is sibling to nav */
        }

        /* Desktop specific layout adjustments */
        @media (min-width: 1024px) {
            .nav-rail { display: block; }
            .mobile-jump-trigger { display: none; }
            .paper-column { padding: 2rem 4rem 10rem 4rem; }
        }

        /* =========================================
           CONTENT TYPOGRAPHY & SPACING
           ========================================= */
        .section-header-block {
            margin-top: var(--sp-q-gap);
            margin-bottom: 2rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-hairline);
        }
        .section-header-text {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--txt-primary);
        }

        .question-node {
            margin-bottom: var(--sp-q-gap);
            scroll-margin-top: 80px; /* For anchor scrolling */
        }

        /* Question Body */
        .question-body {
            margin-bottom: var(--sp-internal);
        }
        .q-identifier {
            font-weight: 600;
            color: var(--txt-secondary);
            margin-right: 0.5rem;
            float: left; /* Inline with first line */
        }
        .q-prompt {
            color: var(--txt-primary);
            font-size: 1.05rem;
        }

        /* Children Indentation (Stage 3) */
        .children-container {
            margin-top: 1.5rem;
            padding-left: 1.5rem; /* Indentation for sub-questions */
            /* Adaptive indentation could be added via media queries if needed */
        }

        /* Solution Block */
        .solution-block {
            /* Separator Question -> Solution */
            margin-top: var(--sp-internal);
        }

        /* Answer */
        .answer-region {
            margin-bottom: var(--sp-internal);
            color: var(--txt-primary);
        }
        .label-answer {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--txt-secondary);
            display: block;
            margin-bottom: 0.25rem;
        }

        /* Solution Details Disclosure */
        .disclosure-control {
            background: none;
            border: none;
            color: var(--accent-primary);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            padding: 0;
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            margin-bottom: var(--sp-internal);
        }
        .disclosure-control:hover {
            color: var(--accent-hover);
            text-decoration: underline;
        }
        .disclosure-icon {
            transition: transform 0.2s ease;
            width: 1em; height: 1em;
            fill: currentColor;
        }
        .disclosure-control[aria-expanded="true"] .disclosure-icon {
            transform: rotate(180deg);
        }

        /* Expanded Solution Details Region */
        .solution-details-content {
            display: none;
            /* Permitted demarcation: subtle wash (Stage 5.3.3) */
            background-color: var(--surf-wash-solution);
            padding: 1.25rem;
            border-radius: 4px; /* Soft rounding, not card-like */
            margin-top: 0.5rem;
            /* Boundary clarity via rhythm */
        }
        .solution-details-content.expanded {
            display: block;
            animation: fadeIn 0.2s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-4px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Subsections (Keep in mind, Formulas, Working) */
        .sd-subsection {
            margin-bottom: 1.5rem;
        }
        .sd-subsection:last-child {
            margin-bottom: 0;
        }
        .sd-label {
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--txt-secondary);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }
        .sd-body {
            font-size: 0.95rem;
            color: var(--txt-primary);
        }
        /* Keep in mind specifics */
        .sd-keep-in-mind .sd-label { color: var(--txt-secondary); } 
        /* Formulas specifics */
        .sd-formulas .sd-body { font-family: inherit; } 

        /* Working Internal Separation */
        .working-phase-separator {
            height: 0.75rem; /* Visually separates phases of working */
        }

        /* Alternative Working Separation (Stage 5.8.7) */
        .alt-working-separator {
            border-top: 1px solid var(--border-hairline);
            margin: 1.5rem 0;
            display: block;
        }

        /* Error Message */
        .error-message {
            color: var(--txt-primary);
            font-weight: 600;
            text-align: center;
            margin-top: 4rem;
            font-size: 1.25rem;
        }

    </style>
</head>
<body>

    <div id="root" class="app-shell">
        <!-- Render target -->
    </div>

    <script>
        // =========================================
        // STAGE 0: CONSTANTS (Canonical)
        // =========================================
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // =========================================
        // STATE MANAGEMENT
        // =========================================
        const state = {
            papers: [],
            currentPaperId: null,
            payloadLoaded: false,
            expandedNodes: new Set(), // Set of question IDs where solution is expanded
            activeNavId: null
        };

        // =========================================
        // MARKDOWN CONFIGURATION (Stage 6.1)
        // =========================================
        // Configure markdown-it immediately
        let md = null;
        if (window.markdownit) {
            md = window.markdownit({
                html: true,      // Allow inline SVG/HTML
                linkify: true,
                breaks: false    // CRITICAL: prevents <br> inside math blocks
            });
            // Disable inline escape rule to preserve TeX backslashes
            md.inline.ruler.disable(['escape']);
        }

        // =========================================
        // MAIN EXECUTION
        // =========================================
        
        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                
                if (!data.papers || !Array.isArray(data.papers)) {
                    throw new Error('Invalid payload structure');
                }

                state.papers = data.papers;
                state.payloadLoaded = true;

                // Set initial paper
                if (state.papers.length > 0) {
                    selectPaper(state.papers[0].key);
                } else {
                    renderError("No papers found in payload.");
                }

            } catch (error) {
                console.error("Payload loading failed:", error);
                renderError("PAPERS PAYLOAD MISSING");
            }
        }

        function selectPaper(paperKey) {
            const paper = state.papers.find(p => p.key === paperKey);
            if (!paper) return;

            state.currentPaperId = paperKey;
            
            // Initialize defaults (expandedAll)
            state.expandedNodes.clear();
            const defaultExpanded = paper.defaults?.expandedAll !== false; // Default to true unless false
            
            // We need to traverse content to set defaults if we wanted strictly per-node tracking,
            // but for this prototype, we'll check defaults during render or just assume "not in set" 
            // implies default state.
            // Simplified: We will use state.expandedNodes to track EXCEPTIONS or EXPLICIT states.
            // Actually, let's just populate the set if default is true?
            // Better: 'expandedNodes' tracks currently expanded. 
            // If default is true, we should conceptually have all.
            // Implementation: We will use a helper `isExpanded(nodeId, paperDefault)` during render.
            // And toggling adds/removes from Set.
            
            // Wait: If default is TRUE, initially everything is open. Clicking hide adds to "hiddenSet"?
            // Let's stick to a simpler model: `expandedNodes` contains IDs of OPEN nodes.
            // If default is TRUE, we populate it with all IDs that have solutions.
            // If default is FALSE, we start empty.
            
            const allNodeIdsWithSolutions = [];
            const collectIds = (nodes) => {
                nodes.forEach(node => {
                    if (node.solutionBlock?.solutionDetails) {
                        allNodeIdsWithSolutions.push(node.id);
                    }
                    if (node.children) collectIds(node.children);
                });
            };

            const rootNodes = paper.questions || paper.sections?.flatMap(s => s.questions) || [];
            collectIds(rootNodes);

            if (defaultExpanded) {
                allNodeIdsWithSolutions.forEach(id => state.expandedNodes.add(id));
            }

            renderApp();
            
            // Setup intersection observer for nav
            setupIntersectionObserver();
        }

        function toggleSolution(nodeId) {
            if (state.expandedNodes.has(nodeId)) {
                state.expandedNodes.delete(nodeId);
            } else {
                state.expandedNodes.add(nodeId);
            }
            // Re-render only the button and content area to avoid full layout jump/math re-render
            // But full re-render is safer for prototype simplicity to ensure math renders correctly in new blocks.
            // We will do a full paper re-render for simplicity, scroll position is preserved by browser usually 
            // but might jump. Better to do DOM manipulation.
            // For this output, full re-render is acceptable if fast.
            // Let's try targeted DOM update if possible.
            
            const contentEl = document.getElementById(`sd-content-${escapeId(nodeId)}`);
            const btnTextEl = document.getElementById(`sd-btn-text-${escapeId(nodeId)}`);
            const btnIconEl = document.getElementById(`sd-btn-${escapeId(nodeId)}`);
            
            if (contentEl && btnTextEl) {
                const isExpanded = state.expandedNodes.has(nodeId);
                if (isExpanded) {
                    contentEl.classList.add('expanded');
                    btnTextEl.textContent = "Hide working";
                    btnIconEl.setAttribute('aria-expanded', 'true');
                    // Trigger KaTeX render on revealed content if not already rendered? 
                    // Auto-render runs on page load, but hidden content might be missed depending on config?
                    // Actually, auto-render processes the whole body. Hidden elements usually get processed.
                } else {
                    contentEl.classList.remove('expanded');
                    btnTextEl.textContent = "Show working";
                    btnIconEl.setAttribute('aria-expanded', 'false');
                }
            }
        }

        // =========================================
        // RENDERING
        // =========================================

        function renderError(msg) {
            document.getElementById('root').innerHTML = `
                <div class="top-controls">
                     <div style="font-weight:600">RTQ Viewer</div>
                </div>
                <div class="error-message">${msg}</div>
            `;
        }

        function renderApp() {
            const root = document.getElementById('root');
            const paper = state.papers.find(p => p.key === state.currentPaperId);
            
            if (!paper) return;

            // Structure: Top Controls + Document Frame
            root.innerHTML = `
                <div class="top-controls">
                    ${renderPaperSelector()}
                    <button class="mobile-jump-trigger" onclick="openDrawer()">Jump to question</button>
                </div>
                
                <div class="document-frame">
                    <!-- Desktop Nav Rail -->
                    <nav class="nav-rail">
                        ${renderNavList(paper)}
                    </nav>

                    <!-- Mobile Drawer -->
                    <div class="nav-drawer-overlay" id="drawer-overlay" onclick="closeDrawer()"></div>
                    <div class="nav-drawer" id="drawer">
                        <div class="drawer-header">
                            <span style="font-weight:600">Jump to</span>
                            <button class="drawer-close" onclick="closeDrawer()">&times;</button>
                        </div>
                        <div class="drawer-content">
                             ${renderNavList(paper)}
                        </div>
                    </div>

                    <!-- Paper Content -->
                    <main class="paper-column">
                        <div class="paper-surface">
                            ${renderPaperBody(paper)}
                        </div>
                    </main>
                </div>
            `;

            // Run KaTeX
            if (window.renderMathInElement) {
                renderMathInElement(document.body, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false}
                    ],
                    throwOnError: false
                });
            }
        }

        function renderPaperSelector() {
            return `
                <select class="paper-select" onchange="selectPaper(this.value)">
                    ${state.papers.map(p => `
                        <option value="${p.key}" ${p.key === state.currentPaperId ? 'selected' : ''}>
                            ${p.label}
                        </option>
                    `).join('')}
                </select>
            `;
        }

        function renderNavList(paper) {
            // Flatten logic
            let html = '<ul class="nav-list">';
            
            const renderItem = (node, depth) => {
                const isActive = state.activeNavId === node.id;
                html += `
                    <li>
                        <a onclick="scrollToQuestion('${node.id}'); closeDrawer()" 
                           class="nav-item ${isActive ? 'active' : ''}"
                           data-depth="${Math.min(depth, 2)}">
                           ${node.id}
                        </a>
                    </li>
                `;
                if (node.children) {
                    node.children.forEach(c => renderItem(c, depth + 1));
                }
            };

            if (paper.sections) {
                paper.sections.forEach(section => {
                    if (section.label && section.label.trim() !== "") {
                        html += `<li class="nav-section-label">${section.label}</li>`;
                    }
                    if (section.questions) {
                        section.questions.forEach(q => renderItem(q, 0));
                    }
                });
            } else if (paper.questions) {
                paper.questions.forEach(q => renderItem(q, 0));
            }

            html += '</ul>';
            return html;
        }

        function renderPaperBody(paper) {
            if (paper.sections) {
                return paper.sections.map(section => `
                    <section class="section-block">
                        ${(section.label && section.label.trim() !== "") 
                            ? `<div class="section-header-block"><div class="section-header-text">Section ${section.label}</div></div>` 
                            : ''}
                        <div class="question-list">
                            ${section.questions.map(q => renderQuestionNode(q, 0)).join('')}
                        </div>
                    </section>
                `).join('');
            } else if (paper.questions) {
                return `<div class="question-list">${paper.questions.map(q => renderQuestionNode(q, 0)).join('')}</div>`;
            }
            return '';
        }

        function renderQuestionNode(node, depth) {
            const safeId = escapeId(node.id);
            const markdownQuestion = md ? md.render(node.question || '') : (node.question || '');
            
            // Solution Block Logic
            let solutionBlockHtml = '';
            if (node.solutionBlock) {
                // Answer
                let answerHtml = '';
                if (node.solutionBlock.answer) {
                    const mdAnswer = md ? md.render(node.solutionBlock.answer) : node.solutionBlock.answer;
                    answerHtml = `
                        <div class="answer-region">
                            <span class="label-answer">Answer</span>
                            <div class="markdown-body">${mdAnswer}</div>
                        </div>
                    `;
                }

                // Solution Details
                let detailsHtml = '';
                if (node.solutionBlock.solutionDetails) {
                    const isExpanded = state.expandedNodes.has(node.id);
                    const details = node.solutionBlock.solutionDetails;
                    
                    // Render subsections
                    const keepInMind = details.keepInMind ? `
                        <div class="sd-subsection sd-keep-in-mind">
                            <div class="sd-label">Keep in mind</div>
                            <div class="sd-body markdown-body">${md ? md.render(details.keepInMind) : details.keepInMind}</div>
                        </div>
                    ` : '';

                    const formulas = details.formulasUsed ? `
                        <div class="sd-subsection sd-formulas">
                            <div class="sd-label">Formulas used</div>
                            <div class="sd-body markdown-body">${md ? md.render(details.formulasUsed) : details.formulasUsed}</div>
                        </div>
                    ` : '';

                    const working = details.working ? `
                        <div class="sd-subsection sd-working">
                            <div class="sd-label">Working</div>
                            <div class="sd-body markdown-body">${md ? md.render(details.working) : details.working}</div>
                        </div>
                    ` : '';

                    const alternatives = details.alternativeWorking ? details.alternativeWorking.map((alt, i) => `
                        <div class="sd-subsection sd-alt-working">
                            <div class="alt-working-separator"></div>
                            <div class="sd-label">Alternative working</div>
                            <div class="sd-body markdown-body">${md ? md.render(alt) : alt}</div>
                        </div>
                    `).join('') : '';

                    detailsHtml = `
                        <button class="disclosure-control" 
                                id="sd-btn-${safeId}"
                                onclick="toggleSolution('${node.id}')" 
                                aria-expanded="${isExpanded}">
                            <span id="sd-btn-text-${safeId}">${isExpanded ? 'Hide working' : 'Show working'}</span>
                            <svg class="disclosure-icon" viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>
                        </button>
                        <div class="solution-details-content ${isExpanded ? 'expanded' : ''}" id="sd-content-${safeId}">
                            ${keepInMind}
                            ${formulas}
                            ${working}
                            ${alternatives}
                        </div>
                    `;
                }

                if (answerHtml || detailsHtml) {
                    solutionBlockHtml = `
                        <div class="solution-block">
                            ${answerHtml}
                            ${detailsHtml}
                        </div>
                    `;
                }
            }

            // Children Logic
            let childrenHtml = '';
            if (node.children && node.children.length > 0) {
                childrenHtml = `
                    <div class="children-container">
                        ${node.children.map(c => renderQuestionNode(c, depth + 1)).join('')}
                    </div>
                `;
            }

            return `
                <div class="question-node" id="q-${safeId}">
                    <div class="question-body">
                        <div class="q-identifier">${node.id}</div>
                        <div class="q-prompt markdown-body">${markdownQuestion}</div>
                    </div>
                    ${solutionBlockHtml}
                    ${childrenHtml}
                </div>
            `;
        }

        // =========================================
        // UTILS
        // =========================================
        
        function escapeId(id) {
            // Create valid CSS selector safe ID
            return id.replace(/[^a-zA-Z0-9-_]/g, '_');
        }

        function scrollToQuestion(id) {
            const el = document.getElementById(`q-${escapeId(id)}`);
            if (el) {
                // Scroll with offset for sticky header
                const y = el.getBoundingClientRect().top + window.scrollY - 80;
                window.scrollTo({top: y, behavior: 'smooth'});
                
                // Update nav state manually for instant feedback
                state.activeNavId = id;
                renderApp(); // Re-render to update nav highlight (inefficient but safe for prototype)
            }
        }

        function openDrawer() {
            document.getElementById('drawer').classList.add('open');
            document.getElementById('drawer-overlay').classList.add('open');
        }

        function closeDrawer() {
            document.getElementById('drawer').classList.remove('open');
            document.getElementById('drawer-overlay').classList.remove('open');
        }

        function setupIntersectionObserver() {
            const observer = new IntersectionObserver((entries) => {
                // Find visible question closest to top
                // Simple heuristic: find all intersecting, pick first
                const visible = entries.filter(e => e.isIntersecting);
                if (visible.length > 0) {
                    // Just take the first one for simplicity in this prototype
                    const id = visible[0].target.id.replace('q-', '').replace(/_/g, (m) => {
                        // Reverse escaping is hard if lossy. 
                        // Instead, we store real ID on dataset
                        return m; 
                    }); 
                    // Better approach: store real ID in data-attribute
                }
            }, { rootMargin: '-60px 0px -80% 0px' });

            // We actually need to map DOM IDs back to real IDs.
            // Let's modify render to include data-id attribute.
            // Re-implementing quick observer logic for prototype "Active State"
            // Since prototype re-renders fully on interactions, this might be jumpy.
            // Leaving active state manual on click for stability in this harness.
        }

        // Run Init
        init();

    </script>
</body>
</html>
