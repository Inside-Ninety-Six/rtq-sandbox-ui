<!DOCTYPE html>
<html lang="en" class="antialiased text-stone-900 bg-[#fdfcfb]">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AB","indexWithinVariant":"101","totalWithinVariant":"200","hueFamily":"amber","intensityMode":"","timestamp":"2026-01-07T04:58:20.690Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AB&quot;,&quot;indexWithinVariant&quot;:&quot;101&quot;,&quot;totalWithinVariant&quot;:&quot;200&quot;,&quot;hueFamily&quot;:&quot;amber&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-07T04:58:20.690Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RTQ Maths Paper Solution Viewer</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    colors: {
                        // ColorLab B: Forced Amber Hue
                        accent: {
                            50: '#fffbeb',
                            100: '#fef3c7',
                            200: '#fde68a',
                            300: '#fcd34d',
                            400: '#fbbf24',
                            500: '#f59e0b',
                            600: '#d97706',
                            700: '#b45309',
                            800: '#92400e',
                            900: '#78350f',
                        }
                    }
                }
            }
        }
    </script>

    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Markdown-it -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/13.0.1/markdown-it.min.js"></script>

    <!-- KaTeX -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js"></script>

    <!-- Styles -->
    <style>
        /* Base document setup */
        body {
            /* Warm neutral base from Stage 5.3.1 */
            background-color: #fdfcfb;
            color: #1c1917; /* stone-900 */
        }

        /* Focus styles - Stage 5.5.2 & ColorLab Accent */
        *:focus-visible {
            outline: 2px solid #f59e0b; /* accent-500 */
            outline-offset: 2px;
        }

        /* Scrollbar hiding for Nav - Stage 6.0.9 */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* KaTeX Containment Invariant - Stage 6.0.8 */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            scrollbar-width: thin;
            padding-top: 0.5em;
            padding-bottom: 0.5em;
        }
        
        /* Inline KaTeX background rule - Stage 5.8.4 */
        .katex {
            background-color: transparent !important;
        }

        /* Markdown Content Styling (Prose-like) */
        .rtq-prose p {
            margin-bottom: 0.75em;
            line-height: 1.6;
        }
        .rtq-prose p:last-child {
            margin-bottom: 0;
        }
        
        /* Tables - Stage 5.8.5 - Minimal, structural */
        .rtq-prose table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1em;
            margin-bottom: 1em;
            font-size: 0.95em;
        }
        .rtq-prose th, .rtq-prose td {
            border: 1px solid #e7e5e4; /* stone-200 */
            padding: 0.5em 0.75em;
            text-align: left;
            vertical-align: top;
        }
        .rtq-prose th {
            font-weight: 600;
            color: #44403c; /* stone-700 */
        }
        
        /* Lists */
        .rtq-prose ul {
            list-style-type: disc;
            padding-left: 1.5em;
            margin-bottom: 0.75em;
        }
        .rtq-prose ol {
            list-style-type: decimal;
            padding-left: 1.5em;
            margin-bottom: 0.75em;
        }
        .rtq-prose li {
            margin-bottom: 0.25em;
        }

        /* Drawer Backdrop */
        .drawer-backdrop {
            background-color: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(2px);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- STAGE 0: CONSTANTS ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";
        
        // --- STAGE 6 Add-on: Markdown Configuration ---
        const md = window.markdownit ? window.markdownit({
            html: true,
            linkify: true,
            breaks: false, // Critical: prevent <br> in math
        }) : null;

        if (md) {
            md.inline.ruler.disable(['escape']);
        }

        // --- Helper Components ---

        const IconMenu = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>
        );
        const IconClose = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
        );
        const IconChevronDown = ({ className }) => (
            <svg className={className} xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m6 9 6 6 6-6"/></svg>
        );
        const IconChevronUp = ({ className }) => (
            <svg className={className} xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m18 15-6-6-6 6"/></svg>
        );
        const IconIdea = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-stone-400 shrink-0"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/></svg>
        );

        // Markdown Renderer Component
        const MarkdownContent = ({ content, className = "" }) => {
            const containerRef = React.useRef(null);

            React.useEffect(() => {
                if (containerRef.current) {
                    renderMathInElement(containerRef.current, {
                        delimiters: [
                            {left: '$$', right: '$$', display: true},
                            {left: '$', right: '$', display: false}
                        ],
                        throwOnError: false,
                        trust: true
                    });
                }
            }, [content]);

            const html = md ? md.render(content || "") : content;

            return (
                <div 
                    ref={containerRef}
                    className={`rtq-prose ${className}`}
                    dangerouslySetInnerHTML={{ __html: html }}
                />
            );
        };

        // --- Core Application Components ---

        const NavItem = ({ id, isActive, onClick, depth = 0 }) => {
            // Stage 5.4.5: Flat list, hierarchy via type scale/quietness only.
            const sizeClass = depth === 0 ? "text-[15px]" : depth === 1 ? "text-sm" : "text-xs";
            const colorClass = isActive 
                ? "text-accent-700 font-bold" 
                : "text-stone-600 hover:text-stone-900"; 

            return (
                <button
                    onClick={onClick}
                    className={`w-full text-left py-1.5 px-0 leading-snug transition-colors ${sizeClass} ${colorClass} flex items-center group`}
                    aria-label={`Jump to question ${id}`}
                >
                    {isActive && (
                        <span className="w-1.5 h-1.5 rounded-full bg-accent-600 mr-2 shrink-0" aria-hidden="true" />
                    )}
                    <span className={!isActive ? "ml-3.5" : ""}>{id}</span>
                </button>
            );
        };

        const NavList = ({ items, currentId, onSelect, activePaper }) => {
            const renderList = [];

            const traverse = (nodes, depth) => {
                nodes.forEach(node => {
                    renderList.push({ ...node, depth });
                    if (node.children) traverse(node.children, depth + 1);
                });
            };
            
            if (activePaper.sections && activePaper.sections.length > 0) {
                activePaper.sections.forEach(section => {
                    if (section.label && section.label.trim().length > 0) {
                        renderList.push({ type: 'section', label: section.label });
                    }
                    if (section.questions) traverse(section.questions, 0);
                });
            } else if (activePaper.questions) {
                traverse(activePaper.questions, 0);
            }

            return (
                <div className="flex flex-col pb-12">
                    {renderList.map((item, idx) => {
                        if (item.type === 'section') {
                            return (
                                <div key={`sec-${idx}`} className="mt-6 first:mt-2 mb-2">
                                    <span className="text-xs font-semibold text-stone-400 uppercase tracking-wider block border-b border-stone-200 pb-1">
                                        {item.label}
                                    </span>
                                </div>
                            );
                        }
                        return (
                            <NavItem 
                                key={item.id}
                                id={item.id}
                                depth={item.depth}
                                isActive={currentId === item.id}
                                onClick={() => onSelect(item.id)}
                            />
                        );
                    })}
                </div>
            );
        };

        const SolutionDetails = ({ details, expanded }) => {
            if (!expanded) return null;

            return (
                <div className="mt-3 text-stone-700 animate-in fade-in slide-in-from-top-1 duration-200 ease-out origin-top">
                    {/* Keep in mind */}
                    {details.keepInMind && (
                        <div className="mb-5">
                            <div className="flex items-center gap-2 mb-2 text-stone-900 font-semibold text-sm">
                                <IconIdea />
                                <span>Keep in mind</span>
                            </div>
                            <MarkdownContent content={details.keepInMind} className="text-sm text-stone-600 pl-6" />
                        </div>
                    )}

                    {/* Formulas used */}
                    {details.formulasUsed && (
                        <div className="mb-5 pl-6 border-l-2 border-stone-100">
                             <div className="text-xs font-bold text-stone-500 uppercase tracking-wide mb-2">Formulas used</div>
                             <MarkdownContent content={details.formulasUsed} className="text-sm text-stone-600" />
                        </div>
                    )}

                    {/* Working (Primary) */}
                    {details.working && (
                        <div className="mb-6">
                            <div className="text-xs font-bold text-stone-500 uppercase tracking-wide mb-2">Working</div>
                            <div className="bg-stone-50/50 rounded-sm">
                                <MarkdownContent content={details.working} className="text-[15px] leading-relaxed" />
                            </div>
                        </div>
                    )}

                    {/* Alternative Working */}
                    {details.alternativeWorking && details.alternativeWorking.map((alt, idx) => (
                        <div key={idx} className="mt-6 pt-6 border-t border-stone-100">
                            <div className="text-xs font-bold text-stone-500 uppercase tracking-wide mb-2">Alternative working</div>
                            <MarkdownContent content={alt} className="text-[15px] leading-relaxed" />
                        </div>
                    ))}
                </div>
            );
        };

        const QuestionNode = ({ node, depth = 0, expansionMap, onToggle, defaultExpanded }) => {
            const hasSolutionBlock = !!node.solutionBlock;
            const hasDetails = hasSolutionBlock && !!node.solutionBlock.solutionDetails;
            
            const isExpanded = expansionMap[node.id] !== undefined 
                ? expansionMap[node.id] 
                : defaultExpanded;

            return (
                <div 
                    id={`q-${node.id}`} 
                    className={`
                        relative
                        ${depth === 0 ? "pt-10 pb-2" : "pt-3 pb-1"}
                    `}
                >
                    <div className="flex gap-3 md:gap-5">
                         {/* Identifier Column */}
                        <div className="shrink-0 w-10 md:w-14 pt-1 text-right md:text-left">
                            <span className={`
                                block font-medium text-stone-500 font-sans
                                ${depth === 0 ? "text-lg" : "text-sm"}
                            `}>
                                {node.id}
                            </span>
                        </div>
                        
                        {/* Content Column */}
                        <div className="flex-1 min-w-0 max-w-3xl">
                             {/* Question */}
                             <div className={`
                                mb-3 font-medium text-stone-900 
                                ${depth === 0 ? "text-[1.0625rem] leading-7" : "text-[0.95rem] leading-6"}
                            `}>
                                <MarkdownContent content={node.question} />
                            </div>

                            {/* Solution Block */}
                            {hasSolutionBlock && (
                                <div className="mt-3">
                                    {/* Answer */}
                                    {node.solutionBlock.answer && (
                                        <div className="mb-2.5 flex flex-wrap gap-x-2 items-baseline">
                                            <span className="text-xs font-bold text-stone-500 uppercase tracking-wider select-none">Answer</span>
                                            <div className="text-stone-900 font-medium">
                                                <MarkdownContent content={node.solutionBlock.answer} className="inline-block" />
                                            </div>
                                        </div>
                                    )}

                                    {/* Toggle */}
                                    {hasDetails && (
                                        <div className="mt-2">
                                            <button 
                                                onClick={() => onToggle(node.id)}
                                                className="
                                                    inline-flex items-center gap-1.5 text-sm font-semibold
                                                    text-accent-700 hover:text-accent-800
                                                    transition-colors duration-200 select-none
                                                "
                                                aria-expanded={isExpanded}
                                            >
                                                {isExpanded ? "Hide working" : "Show working"}
                                                {isExpanded ? <IconChevronUp className="w-4 h-4" /> : <IconChevronDown className="w-4 h-4" />}
                                            </button>

                                            <SolutionDetails details={node.solutionBlock.solutionDetails} expanded={isExpanded} />
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Children */}
                    {node.children && node.children.length > 0 && (
                        <div className="mt-2 ml-10 md:ml-14 pl-0">
                            {node.children.map(child => (
                                <QuestionNode 
                                    key={child.id}
                                    node={child}
                                    depth={depth + 1}
                                    expansionMap={expansionMap}
                                    onToggle={onToggle}
                                    defaultExpanded={defaultExpanded}
                                />
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        // --- Main App ---

        const App = () => {
            const [payload, setPayload] = React.useState(null);
            const [error, setError] = React.useState(false);
            const [activePaperKey, setActivePaperKey] = React.useState(null);
            const [expansionMap, setExpansionMap] = React.useState({});
            const [mobileNavOpen, setMobileNavOpen] = React.useState(false);
            const [activeQuestionId, setActiveQuestionId] = React.useState(null);

            React.useEffect(() => {
                fetch(RTQ_PAPERS_PAYLOAD_PATH)
                    .then(res => {
                        if (!res.ok) throw new Error("Load failed");
                        return res.json();
                    })
                    .then(data => {
                        setPayload(data);
                        if (data.papers && data.papers.length > 0) {
                            setActivePaperKey(data.papers[0].key);
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        setError(true);
                    });
            }, []);

            const activePaper = React.useMemo(() => {
                if (!payload) return null;
                return payload.papers.find(p => p.key === activePaperKey);
            }, [payload, activePaperKey]);

            const defaultExpanded = React.useMemo(() => {
                return activePaper?.defaults?.expandedAll !== false;
            }, [activePaper]);

            const handleToggle = (id) => {
                setExpansionMap(prev => {
                    const current = prev[id] !== undefined ? prev[id] : defaultExpanded;
                    return { ...prev, [id]: !current };
                });
            };

            const handlePaperSwitch = (e) => {
                const newKey = e.target.value;
                setActivePaperKey(newKey);
                setExpansionMap({});
                window.scrollTo(0, 0);
            };

            const scrollToId = (id) => {
                setMobileNavOpen(false);
                const el = document.getElementById(`q-${id}`);
                if (el) {
                    const offset = 80;
                    const top = el.getBoundingClientRect().top + window.pageYOffset - offset;
                    window.scrollTo({ top, behavior: 'smooth' });
                    setActiveQuestionId(id);
                }
            };

            // Intersection Observer for Scroll Spy
            React.useEffect(() => {
                if (!activePaper) return;
                
                const observer = new IntersectionObserver((entries) => {
                    const visible = entries.find(e => e.isIntersecting);
                    if (visible) {
                        const id = visible.target.id.replace('q-', '');
                        setActiveQuestionId(id);
                    }
                }, { rootMargin: '-10% 0px -80% 0px' });

                const collectIds = (nodes) => {
                    nodes.forEach(n => {
                        const el = document.getElementById(`q-${n.id}`);
                        if (el) observer.observe(el);
                        if (n.children) collectIds(n.children);
                    });
                };
                
                if (activePaper.questions) collectIds(activePaper.questions);
                if (activePaper.sections) activePaper.sections.forEach(s => s.questions && collectIds(s.questions));

                return () => observer.disconnect();
            }, [activePaper, expansionMap]);

            if (error) {
                return (
                    <div className="flex items-center justify-center min-h-screen text-stone-500 font-medium">
                        PAPERS PAYLOAD MISSING
                    </div>
                );
            }

            if (!payload || !activePaper) return <div className="h-screen bg-[#fdfcfb]"></div>;

            return (
                <div className="min-h-screen flex flex-col">
                    {/* Top Controls */}
                    <header className="sticky top-0 z-40 bg-[#fdfcfb]/95 backdrop-blur-sm border-b border-stone-200">
                        <div className="max-w-6xl mx-auto px-4 h-14 flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <label htmlFor="paper-select" className="text-sm font-medium text-stone-500">Paper:</label>
                                <div className="relative">
                                    <select 
                                        id="paper-select"
                                        value={activePaperKey}
                                        onChange={handlePaperSwitch}
                                        className="appearance-none bg-white border border-stone-300 hover:border-accent-400 text-stone-900 text-sm rounded-md py-1.5 pl-3 pr-8 focus:ring-2 focus:ring-accent-500 focus:border-accent-500 transition-colors cursor-pointer shadow-sm"
                                    >
                                        {payload.papers.map(p => (
                                            <option key={p.key} value={p.key}>{p.label}</option>
                                        ))}
                                    </select>
                                    <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-stone-500">
                                        <svg className="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                                    </div>
                                </div>
                            </div>

                            <div className="md:hidden">
                                <button 
                                    onClick={() => setMobileNavOpen(true)}
                                    className="flex items-center gap-2 text-sm font-medium text-accent-700 hover:text-accent-800"
                                >
                                    <span>Jump to</span>
                                    <IconMenu />
                                </button>
                            </div>
                        </div>
                    </header>

                    {/* DocumentFrameShell */}
                    <div className="flex-1 max-w-6xl mx-auto w-full flex">
                        
                        {/* Desktop Navigation Rail */}
                        <aside className="hidden md:block w-48 lg:w-56 shrink-0 border-r border-transparent py-8 pr-6 sticky top-14 h-[calc(100vh-3.5rem)] overflow-y-auto no-scrollbar hover:overflow-y-auto">
                            <NavList 
                                activePaper={activePaper} 
                                currentId={activeQuestionId} 
                                onSelect={scrollToId} 
                            />
                        </aside>

                        {/* Paper Content Column */}
                        <main className="flex-1 min-w-0 py-8 px-4 md:px-12 pb-32">
                             {activePaper.sections ? (
                                 activePaper.sections.map((section, idx) => (
                                     <div key={idx}>
                                         {section.label && section.label.trim() && (
                                             <div className="mb-8 mt-4 first:mt-0 border-b border-stone-200 pb-2">
                                                 <span className="text-xl font-bold text-stone-900">{section.label}</span>
                                             </div>
                                         )}
                                         {section.questions.map(node => (
                                             <QuestionNode 
                                                key={node.id} 
                                                node={node} 
                                                expansionMap={expansionMap}
                                                onToggle={handleToggle}
                                                defaultExpanded={defaultExpanded}
                                             />
                                         ))}
                                         <div className="h-12"></div>
                                     </div>
                                 ))
                             ) : (
                                 activePaper.questions.map(node => (
                                     <QuestionNode 
                                        key={node.id} 
                                        node={node} 
                                        expansionMap={expansionMap}
                                        onToggle={handleToggle}
                                        defaultExpanded={defaultExpanded}
                                     />
                                 ))
                             )}

                             <div className="mt-16 text-center">
                                 <div className="w-16 h-px bg-stone-300 mx-auto"></div>
                             </div>
                        </main>
                    </div>

                    {/* Mobile Navigation Drawer */}
                    {mobileNavOpen && (
                        <div className="fixed inset-0 z-50 flex justify-end md:hidden">
                            <div 
                                className="absolute inset-0 drawer-backdrop"
                                onClick={() => setMobileNavOpen(false)}
                            ></div>
                            <div className="relative w-64 bg-white h-full shadow-xl flex flex-col">
                                <div className="flex items-center justify-between p-4 border-b border-stone-200">
                                    <h2 className="text-lg font-bold text-stone-900">Jump to</h2>
                                    <button 
                                        onClick={() => setMobileNavOpen(false)}
                                        className="text-stone-500 hover:text-stone-900"
                                    >
                                        <IconClose />
                                    </button>
                                </div>
                                <div className="flex-1 overflow-y-auto p-4">
                                     <NavList 
                                        activePaper={activePaper} 
                                        currentId={activeQuestionId} 
                                        onSelect={scrollToId} 
                                    />
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
