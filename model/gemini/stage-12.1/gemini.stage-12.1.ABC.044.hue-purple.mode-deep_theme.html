<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"ABC","indexWithinVariant":"44","totalWithinVariant":"320","hueFamily":"purple","intensityMode":"deep_theme","timestamp":"2026-01-07T11:24:35.674Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;ABC&quot;,&quot;indexWithinVariant&quot;:&quot;44&quot;,&quot;totalWithinVariant&quot;:&quot;320&quot;,&quot;hueFamily&quot;:&quot;purple&quot;,&quot;intensityMode&quot;:&quot;deep_theme&quot;,&quot;timestamp&quot;:&quot;2026-01-07T11:24:35.674Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer (Stage 6 Baseline)</title>

    <!-- Tailwind CSS (via CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- KaTeX CSS (No SRI) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <!-- Markdown-it (No SRI) -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>
    
    <!-- KaTeX JS (No SRI) -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <style>
        /* 
         * COLORLAB CONFIGURATION 
         * Mode: Deep Theme (Light Only)
         * Hue: Purple (Forced)
         */
        :root {
            /* Palette - Deep Theme Purple (H=310) */
            /* Page: L ~0.95, C ~0.10 */
            --col-page-bg: oklch(0.95 0.10 310);
            /* Frame: L ~0.93, C ~0.12 */
            --col-frame-bg: oklch(0.93 0.12 310);
            /* Paper: L ~0.98, C ~0.08 */
            --col-paper-bg: oklch(0.98 0.08 310);
            
            /* Text - High Legibility, mostly neutral with slight tint */
            --col-text-primary: oklch(0.20 0.015 310);
            --col-text-secondary: oklch(0.40 0.02 310);
            --col-text-tertiary: oklch(0.55 0.02 310);

            /* Accents - Restrained, non-semantic */
            /* Link/Focus/Nav Marker: L ~0.55, C ~0.20 */
            --col-accent: oklch(0.55 0.20 310);
            --col-accent-hover: oklch(0.45 0.22 310);
            --col-focus-ring: oklch(0.55 0.20 310 / 0.4);

            /* Separators */
            --col-hairline: oklch(0.85 0.02 310);
            
            /* Surfaces & Washes */
            /* Solution Details Wash: L ~0.96, C ~0.06 */
            --col-wash-solution: oklch(0.96 0.06 310); 
            --col-surface-section: oklch(0.94 0.05 310);

            /* Spacing Units */
            --sp-layout-gutter: 1.5rem;
            --sp-block-gap: 2.5rem; /* Top-level question gap */
            --sp-internal-gap: 1rem;
        }

        /* Base Reset & Typography */
        body {
            background-color: var(--col-page-bg);
            color: var(--col-text-primary);
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            overflow-y: scroll; /* Force vertical scrollbar to avoid layout shift */
        }

        /* KaTeX Overrides */
        .katex { font-size: 1.1em; }
        .katex-display {
            margin: 1em 0;
            overflow-x: auto;
            overflow-y: hidden;
            padding-bottom: 0.25rem; /* scrollbar buffer */
            -webkit-overflow-scrolling: touch;
        }
        /* Inline math: No background */
        .katex-html { background-color: transparent !important; }

        /* Navigation Scrollbar Hiding */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Utility Classes for Deep Theme */
        .bg-page { background-color: var(--col-page-bg); }
        .bg-frame { background-color: var(--col-frame-bg); }
        .bg-paper { background-color: var(--col-paper-bg); }
        .bg-wash { background-color: var(--col-wash-solution); }
        
        .text-pri { color: var(--col-text-primary); }
        .text-sec { color: var(--col-text-secondary); }
        .text-ter { color: var(--col-text-tertiary); }
        .text-acc { color: var(--col-accent); }

        .border-hairline { border-color: var(--col-hairline); }

        /* Focus States */
        :focus-visible {
            outline: 2px solid var(--col-accent);
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* Layout Structure */
        .shell-container {
            max-width: 1280px;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Desktop Grid */
        @media (min-width: 1024px) {
            .desktop-grid {
                display: grid;
                grid-template-columns: 240px 1fr; /* Nav Rail | Paper */
                gap: 0; 
                flex: 1;
            }
            .nav-rail {
                position: sticky;
                top: 0;
                height: 100vh;
                overflow-y: auto;
                padding: 2rem 1rem;
                /* Shared surface context with paper on desktop */
                background-color: var(--col-frame-bg); 
            }
            .paper-column {
                padding: 2rem 3rem;
                background-color: var(--col-frame-bg); /* Shared base */
            }
            .paper-surface {
                background-color: var(--col-paper-bg);
                min-height: 100%;
                padding: 3rem 4rem;
                box-shadow: 0 1px 3px rgba(0,0,0,0.05); /* Subtle lift */
            }
        }

        /* Mobile Layout */
        @media (max-width: 1023px) {
            .desktop-grid { display: block; }
            .nav-rail { display: none; } /* Drawer used instead */
            .paper-column { padding: 1rem; }
            .paper-surface { 
                padding: 1.5rem; 
                background-color: var(--col-paper-bg);
            }
        }

        /* Content Markdown Styling */
        .md-content p { margin-bottom: 0.75em; line-height: 1.6; }
        .md-content p:last-child { margin-bottom: 0; }
        .md-content ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 0.75em; }
        .md-content ol { list-style-type: decimal; padding-left: 1.5em; margin-bottom: 0.75em; }
        .md-content table { 
            width: 100%; 
            border-collapse: collapse; 
            margin: 1em 0; 
            font-size: 0.95em;
        }
        .md-content th, .md-content td { 
            border: 1px solid var(--col-hairline); 
            padding: 0.5em 0.75em; 
            text-align: left; 
        }
        .md-content th { font-weight: 600; color: var(--col-text-primary); }
        
        /* Drawer Transition */
        .drawer-overlay {
            background-color: rgba(0,0,0,0.3);
            backdrop-filter: blur(2px);
            transition: opacity 0.2s ease-out;
        }
        .drawer-panel {
            background-color: var(--col-paper-bg);
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
    </style>
</head>
<body>

    <!-- STAGE 0 CONSTANTS & RUNTIME -->
    <script>
        // CANONICAL CONSTANTS
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";
        
        // COLORLAB CONSTANTS
        const RTQ_COLORLAB_INTENSITY_MODE = "deep_theme";
        const RTQ_COLORLAB_FORCE_HUE_FAMILY = "purple";

        // Global State
        let state = {
            papers: [],
            activePaperKey: null,
            expandedMap: {}, // key: questionId, value: boolean
            navOpen: false
        };

        // Markdown Renderer Setup
        const md = window.markdownit ? window.markdownit({
            html: true,
            linkify: true,
            breaks: false
        }) : null;

        if (md) {
            md.inline.ruler.disable(['escape']);
        }

        // App Initialization
        document.addEventListener('DOMContentLoaded', init);

        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Payload not found");
                const payload = await response.json();
                
                state.papers = payload.papers || [];
                
                if (state.papers.length > 0) {
                    // Default to first paper
                    selectPaper(state.papers[0].key);
                } else {
                    renderError("No papers found in payload.");
                }
            } catch (e) {
                console.error(e);
                renderError("PAPERS PAYLOAD MISSING");
            }
        }

        function renderError(msg) {
            const root = document.getElementById('app-root');
            root.innerHTML = `
                <div class="flex items-center justify-center min-h-screen bg-page text-pri font-bold">
                    ${msg}
                </div>
            `;
        }

        function selectPaper(key) {
            const paper = state.papers.find(p => p.key === key);
            if (!paper) return;

            state.activePaperKey = key;
            
            // Set expanded defaults
            const defaultExpanded = paper.defaults?.expandedAll !== false;
            state.expandedMap = {};
            
            const traverse = (nodes) => {
                if (!nodes) return;
                nodes.forEach(node => {
                    if (node.solutionBlock?.solutionDetails) {
                        state.expandedMap[node.id] = defaultExpanded;
                    }
                    if (node.children) traverse(node.children);
                });
            };

            if (paper.sections) {
                paper.sections.forEach(s => traverse(s.questions));
            } else if (paper.questions) {
                traverse(paper.questions);
            }

            render();
        }

        function toggleWorking(id) {
            state.expandedMap[id] = !state.expandedMap[id];
            renderContent(); // Re-render content column only to preserve scroll
        }

        function toggleNav() {
            state.navOpen = !state.navOpen;
            renderNavDrawer();
        }

        function jumpTo(id) {
            state.navOpen = false;
            renderNavDrawer();
            const el = document.getElementById(`q-${id}`);
            if (el) {
                el.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        /* --- RENDERING --- */

        function render() {
            const root = document.getElementById('app-root');
            const paper = state.papers.find(p => p.key === state.activePaperKey);
            
            // Frame Shell
            root.innerHTML = `
                <div class="shell-container bg-frame">
                    <!-- Top Controls (Mobile) -->
                    <div class="lg:hidden flex items-center justify-between p-4 border-b border-hairline bg-page sticky top-0 z-20">
                        <select id="paper-select-mob" class="bg-transparent text-pri font-medium text-sm focus:outline-none p-2 rounded">
                            ${state.papers.map(p => `<option value="${p.key}" ${p.key === paper.key ? 'selected' : ''}>${p.label}</option>`).join('')}
                        </select>
                        <button onclick="toggleNav()" class="text-sm font-bold text-acc px-3 py-1 rounded hover:bg-black/5">
                            Jump to
                        </button>
                    </div>

                    <div class="desktop-grid">
                        <!-- Left Nav Rail (Desktop) -->
                        <aside class="nav-rail no-scrollbar border-r border-hairline hidden lg:block">
                            <div class="mb-8">
                                <label class="block text-xs uppercase tracking-wide text-ter font-bold mb-2">Paper</label>
                                <select id="paper-select-dt" class="w-full bg-page border border-hairline rounded p-2 text-sm text-pri focus:border-accent focus:ring-1 focus:ring-accent outline-none">
                                    ${state.papers.map(p => `<option value="${p.key}" ${p.key === paper.key ? 'selected' : ''}>${p.label}</option>`).join('')}
                                </select>
                            </div>
                            <nav class="space-y-1">
                                ${renderNavList(paper)}
                            </nav>
                        </aside>

                        <!-- Paper Content Column -->
                        <main class="paper-column">
                            <div class="paper-surface shadow-sm max-w-3xl mx-auto rounded-sm min-h-[80vh]">
                                <div id="paper-content-mount"></div>
                            </div>
                        </main>
                    </div>
                </div>
                
                <!-- Mobile Drawer Container -->
                <div id="drawer-mount"></div>
            `;

            // Attach Listeners
            const selMob = document.getElementById('paper-select-mob');
            if(selMob) selMob.onchange = (e) => selectPaper(e.target.value);

            const selDt = document.getElementById('paper-select-dt');
            if(selDt) selDt.onchange = (e) => selectPaper(e.target.value);

            renderContent();
            renderNavDrawer();
        }

        function renderNavList(paper) {
            let html = '';
            
            const renderItems = (questions) => {
                return questions.map(q => {
                    // Calculate visual hierarchy via opacity/size class, not indentation
                    // We assume top level is "depth 0". Since payload structure is recursive,
                    // we'll flatten it for nav generation or just recurse.
                    // Actually, simpler to just list IDs.
                    // The brief says: Flat list, identifiers only.
                    
                    const itemHtml = (node, depth) => {
                        let cls = "block w-full text-left py-1 px-2 rounded text-sm ";
                        if (depth === 0) cls += "font-medium text-pri ";
                        else cls += "text-sec text-xs "; // Quieter for children
                        
                        // Active indication (dummy logic based on scroll would go here, omitting for simplicity)
                        
                        let out = `<button onclick="jumpTo('${node.id}')" class="${cls} hover:text-acc hover:bg-black/5 transition-colors duration-150">${node.id}</button>`;
                        
                        if (node.children) {
                            out += node.children.map(c => itemHtml(c, depth + 1)).join('');
                        }
                        return out;
                    };

                    return itemHtml(q, 0);
                }).join('');
            };

            if (paper.sections) {
                paper.sections.forEach((sec, idx) => {
                    const hasLabel = sec.label && sec.label.trim().length > 0;
                    if (hasLabel) {
                        html += `
                            <div class="mt-4 mb-2 first:mt-0">
                                <span class="block px-2 text-xs font-bold text-ter uppercase tracking-wider select-none">${sec.label}</span>
                            </div>
                        `;
                    }
                    html += renderItems(sec.questions);
                    // Separator between sections if label exists or just spacing
                    if (idx < paper.sections.length - 1) {
                         html += `<div class="h-4"></div>`;
                    }
                });
            } else if (paper.questions) {
                html += renderItems(paper.questions);
            }
            return html;
        }

        function renderNavDrawer() {
            const mount = document.getElementById('drawer-mount');
            if (!state.navOpen) {
                mount.innerHTML = '';
                document.body.style.overflow = '';
                return;
            }

            document.body.style.overflow = 'hidden';
            const paper = state.papers.find(p => p.key === state.activePaperKey);

            mount.innerHTML = `
                <div class="fixed inset-0 z-50 flex justify-end">
                    <div class="drawer-overlay absolute inset-0" onclick="toggleNav()"></div>
                    <div class="drawer-panel relative w-64 h-full shadow-2xl overflow-y-auto no-scrollbar flex flex-col p-4 transform transition-transform">
                        <div class="flex items-center justify-between mb-6 pb-4 border-b border-hairline">
                            <h2 class="text-sm font-bold text-pri uppercase tracking-wide">Jump to</h2>
                            <button onclick="toggleNav()" class="text-ter hover:text-pri">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </button>
                        </div>
                        <nav class="space-y-1">
                            ${renderNavList(paper)}
                        </nav>
                    </div>
                </div>
            `;
        }

        function renderContent() {
            const mount = document.getElementById('paper-content-mount');
            if (!mount) return;

            const paper = state.papers.find(p => p.key === state.activePaperKey);
            let html = '';

            const renderQuestionNode = (node, depth) => {
                const solutionBlock = node.solutionBlock;
                const hasDetails = solutionBlock?.solutionDetails;
                const isExpanded = state.expandedMap[node.id];
                
                // Content Generation
                const qBody = md.render(node.question || "");
                
                let answerHtml = "";
                if (solutionBlock?.answer) {
                    answerHtml = `
                        <div class="mt-4 mb-2">
                            <div class="text-xs font-bold text-ter uppercase mb-1">Answer</div>
                            <div class="text-pri md-content">${md.render(solutionBlock.answer)}</div>
                        </div>
                    `;
                }

                let detailsHtml = "";
                if (hasDetails) {
                    const btnText = isExpanded ? "Hide working" : "Show working";
                    const chevron = isExpanded 
                        ? `<svg class="w-3 h-3 ml-1 transform rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>`
                        : `<svg class="w-3 h-3 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>`;

                    // Disclosure Control
                    detailsHtml += `
                        <div class="mt-4 flex items-start">
                            <button onclick="toggleWorking('${node.id}')" class="text-sm font-medium text-acc hover:text-pri flex items-center transition-colors focus:outline-none focus-visible:ring-2 rounded px-1 -ml-1">
                                ${btnText} ${chevron}
                            </button>
                        </div>
                    `;

                    if (isExpanded) {
                        const sd = solutionBlock.solutionDetails;
                        let innerHtml = '';

                        // Keep in mind
                        if (sd.keepInMind) {
                            innerHtml += `
                                <div class="mb-6">
                                    <div class="flex items-center text-xs font-bold text-ter uppercase mb-2">
                                        <svg class="w-3 h-3 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                        Keep in mind
                                    </div>
                                    <div class="text-sec text-sm md-content">${md.render(sd.keepInMind)}</div>
                                </div>
                            `;
                        }

                        // Formulas used
                        if (sd.formulasUsed) {
                            innerHtml += `
                                <div class="mb-6">
                                    <div class="text-xs font-bold text-ter uppercase mb-2">Formulas used</div>
                                    <div class="text-sec text-sm md-content">${md.render(sd.formulasUsed)}</div>
                                </div>
                            `;
                        }

                        // Working
                        if (sd.working) {
                            innerHtml += `
                                <div class="mb-6">
                                    <div class="text-xs font-bold text-ter uppercase mb-2">Working</div>
                                    <div class="text-pri md-content text-base">${md.render(sd.working)}</div>
                                </div>
                            `;
                        }

                        // Alternative working
                        if (sd.alternativeWorking && Array.isArray(sd.alternativeWorking)) {
                            sd.alternativeWorking.forEach((alt, idx) => {
                                innerHtml += `
                                    <div class="mt-8 pt-4 border-t border-hairline/50">
                                        <div class="text-xs font-bold text-ter uppercase mb-2">Alternative working ${sd.alternativeWorking.length > 1 ? idx+1 : ''}</div>
                                        <div class="text-pri md-content text-base">${md.render(alt)}</div>
                                    </div>
                                `;
                            });
                        }

                        detailsHtml += `
                            <div class="mt-3 bg-wash p-4 rounded-sm border-l-2 border-hairline animate-reveal">
                                ${innerHtml}
                            </div>
                        `;
                    }
                }

                // Render Node
                // Spacing logic: Top level gets large gap. Children get spacing.
                const topLevelClass = depth === 0 ? "mb-16 pb-8 border-b border-hairline last:border-0 last:mb-0" : "mt-8 pl-0 lg:pl-0"; // Flat visually, but structurally nested
                const indentClass = depth > 0 ? "ml-4 lg:ml-8" : ""; // Indent children slightly for reading logic

                let htmlOut = `
                    <div id="q-${node.id}" class="${topLevelClass} ${indentClass} group scroll-mt-24">
                        <!-- Question Body -->
                        <div class="flex gap-3">
                            <div class="flex-none pt-0.5">
                                <span class="text-sm font-bold text-sec select-none">${node.id}</span>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="text-lg text-pri font-medium leading-relaxed md-content">
                                    ${qBody}
                                </div>
                                
                                <!-- Solution Block -->
                                ${(answerHtml || detailsHtml) ? `
                                    <div class="mt-2">
                                        ${answerHtml}
                                        ${detailsHtml}
                                    </div>
                                ` : ''}
                            </div>
                        </div>

                        <!-- Children -->
                        ${node.children ? `
                            <div class="mt-4">
                                ${node.children.map(c => renderQuestionNode(c, depth + 1)).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
                return htmlOut;
            };

            // Main Layout Loop
            if (paper.sections) {
                paper.sections.forEach((sec, idx) => {
                    if (sec.label) {
                        html += `
                            <div class="mb-8 pt-4">
                                <h2 class="text-xl font-bold text-pri border-b-2 border-hairline pb-2 mb-8">${sec.label}</h2>
                                ${sec.questions.map(q => renderQuestionNode(q, 0)).join('')}
                            </div>
                        `;
                    } else {
                         html += sec.questions.map(q => renderQuestionNode(q, 0)).join('');
                    }
                });
            } else if (paper.questions) {
                html += paper.questions.map(q => renderQuestionNode(q, 0)).join('');
            }

            mount.innerHTML = html;

            // Trigger KaTeX Render
            if (window.renderMathInElement) {
                renderMathInElement(mount, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false}
                    ],
                    throwOnError: false
                });
            }
        }

    </script>
    <style>
        @keyframes reveal {
            from { opacity: 0; transform: translateY(-4px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-reveal { animation: reveal 0.2s ease-out forwards; }
    </style>

    <div id="app-root">
        <!-- Initial Loading State -->
        <div class="flex items-center justify-center min-h-screen bg-page text-pri animate-pulse">
            Loading Paper...
        </div>
    </div>

</body>
</html>
