<!DOCTYPE html>
<html lang="en" class="light">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AB","indexWithinVariant":"172","totalWithinVariant":"200","hueFamily":"red","intensityMode":"","timestamp":"2026-01-07T08:05:30.137Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AB&quot;,&quot;indexWithinVariant&quot;:&quot;172&quot;,&quot;totalWithinVariant&quot;:&quot;200&quot;,&quot;hueFamily&quot;:&quot;red&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-07T08:05:30.137Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>

    <!-- 
      STAGE 6 ADD-ON: ColorLab B (Forced Hue Family: Red)
      STAGE 6 ADD-ON: Real KaTeX Rendering (SRI disabled)
      STAGE 6 ADD-ON: Markdown-it (SRI disabled)
    -->

    <!-- Tailwind CSS (configured for ColorLab B: Red + Warm Neutrals) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // ColorLab B: Force "Red" hue family for accents
                        primary: {
                            50: '#fef2f2',
                            100: '#fee2e2',
                            200: '#fecaca',
                            300: '#fca5a5',
                            400: '#f87171',
                            500: '#ef4444',
                            600: '#dc2626',
                            700: '#b91c1c', 
                            800: '#991b1b',
                            900: '#7f1d1d',
                            950: '#450a0a',
                        },
                        // Stage 5.3.1: Soft-warm neutral base (Paper-like) -> Stone
                        gray: {
                            50: '#fafaf9',
                            100: '#f5f5f4',
                            200: '#e7e5e4',
                            300: '#d6d3d1',
                            400: '#a8a29e',
                            500: '#78716c',
                            600: '#57534e',
                            700: '#44403c',
                            800: '#292524',
                            900: '#1c1917',
                            950: '#0c0a09',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'ui-sans-serif', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <!-- Fonts: Inter for modern, readable sans-serif -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- Markdown-it (No SRI) -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <!-- KaTeX (No SRI) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* Scrollbar Hiding for Nav */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* KaTeX Containment Invariant */
        .katex-display {
            max-width: 100%;
            overflow-x: auto;
            overflow-y: hidden;
            margin: 1em 0;
            /* Scrollbar styling for math */
            scrollbar-width: thin;
            scrollbar-color: #d6d3d1 transparent;
        }
        
        /* Inline KaTeX Background Rule */
        .katex { background-color: transparent !important; }

        /* Document Body */
        body { 
            font-family: 'Inter', sans-serif; 
            -webkit-font-smoothing: antialiased;
        }

        /* Markdown Prose Styling */
        .markdown-content p { margin-bottom: 0.75em; line-height: 1.6; }
        .markdown-content p:last-child { margin-bottom: 0; }
        
        /* Lists */
        .markdown-content ul { list-style-type: disc; padding-left: 1.25em; margin-bottom: 0.75em; }
        .markdown-content ol { list-style-type: decimal; padding-left: 1.25em; margin-bottom: 0.75em; }
        .markdown-content li { margin-bottom: 0.25em; }

        /* Tables (Minimal, Structural) */
        .markdown-content table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1em;
            font-size: 0.95em;
        }
        .markdown-content th, .markdown-content td {
            border: 1px solid #e7e5e4; /* gray-200 */
            padding: 0.5rem;
            text-align: left;
            vertical-align: top;
        }
        .markdown-content th {
            font-weight: 600;
            color: #1c1917; /* gray-900 */
            background-color: #f5f5f4; /* gray-100 */
        }

        /* Focus Ring Customization (Red Palette) */
        *:focus-visible {
            outline: 2px solid #ef4444; /* primary-500 */
            outline-offset: 2px;
        }

        /* Smooth scrolling for anchor jumps */
        html { scroll-behavior: smooth; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 h-screen w-full flex flex-col overflow-hidden">

    <!-- Top Controls (Mobile Header / Desktop integrated shell alignment) -->
    <div id="top-controls" class="flex-none bg-gray-50 border-b border-gray-200/50 z-20">
        <div class="max-w-[1400px] mx-auto px-4 md:px-8 h-14 flex items-center justify-between">
            <!-- Paper Selector Area -->
            <div class="flex items-center gap-3">
                <label for="paper-select" class="text-xs font-semibold text-gray-500 uppercase tracking-wide hidden sm:block">Paper</label>
                <div class="relative">
                    <select id="paper-select" class="appearance-none bg-white border border-gray-300 hover:border-gray-400 text-gray-900 text-sm rounded py-1.5 pl-3 pr-8 focus:ring-1 focus:ring-primary-500 focus:border-primary-500 transition-colors cursor-pointer min-w-[200px]">
                        <option>Loading papers...</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
                        <i class="ph ph-caret-down text-xs"></i>
                    </div>
                </div>
            </div>

            <!-- Mobile "Jump to" Trigger -->
            <button id="mobile-menu-trigger" class="md:hidden flex items-center gap-2 text-sm font-medium text-primary-700 hover:text-primary-800 px-2 py-1 rounded hover:bg-primary-50 transition-colors">
                <span>Jump to</span>
                <i class="ph ph-list text-lg"></i>
            </button>
        </div>
    </div>

    <!-- DocumentFrameShell -->
    <div class="flex-1 flex overflow-hidden max-w-[1400px] mx-auto w-full relative">
        
        <!-- Desktop Navigation Rail -->
        <nav id="desktop-nav" class="hidden md:flex flex-col w-64 flex-none h-full overflow-y-auto no-scrollbar py-8 pl-8 pr-4 border-r border-transparent">
            <!-- Nav content injected here -->
            <div id="desktop-nav-list" class="space-y-1"></div>
        </nav>

        <!-- Paper Content Column -->
        <main id="paper-scroll-container" class="flex-1 overflow-y-auto overflow-x-hidden relative scroll-smooth">
            <div id="paper-content" class="max-w-3xl mx-auto py-8 px-4 md:px-12 pb-32 min-h-full">
                <!-- Questions injected here -->
                <div class="flex items-center justify-center h-64 text-gray-500 text-sm">Select a paper to begin.</div>
            </div>
        </main>

    </div>

    <!-- Mobile Navigation Drawer -->
    <div id="mobile-drawer-backdrop" class="fixed inset-0 bg-gray-900/20 backdrop-blur-sm z-40 hidden transition-opacity opacity-0" aria-hidden="true"></div>
    <div id="mobile-drawer" class="fixed inset-y-0 right-0 w-80 bg-white shadow-xl z-50 transform translate-x-full transition-transform duration-300 flex flex-col" aria-hidden="true">
        <div class="flex items-center justify-between p-4 border-b border-gray-100">
            <h2 class="text-sm font-semibold text-gray-900">Jump to question</h2>
            <button id="mobile-drawer-close" class="p-2 text-gray-500 hover:text-gray-900 rounded-full hover:bg-gray-50">
                <i class="ph ph-x text-lg"></i>
            </button>
        </div>
        <div id="mobile-nav-list" class="flex-1 overflow-y-auto p-4 space-y-1">
            <!-- Mobile nav items injected here -->
        </div>
    </div>

    <!-- Application Logic -->
    <script>
        // --- STAGE 0: CONSTANTS ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // --- STAGE 6: ADD-ONS CONFIGURATION ---
        
        // Markdown Renderer Configuration (Authoritative)
        // html: true (for SVG), breaks: false (critical for KaTeX)
        const md = window.markdownit ? window.markdownit({
            html: true,
            linkify: true,
            breaks: false
        }) : null;

        if (md) {
            // Disable inline escape to preserve TeX backslashes
            md.inline.ruler.disable(['escape']);
        }

        // --- STATE ---
        let state = {
            papers: [],
            currentPaper: null,
            activeQuestionId: null
        };

        // --- DOM ELEMENTS ---
        const els = {
            paperSelect: document.getElementById('paper-select'),
            paperContent: document.getElementById('paper-content'),
            desktopNavList: document.getElementById('desktop-nav-list'),
            mobileNavList: document.getElementById('mobile-nav-list'),
            mobileDrawer: document.getElementById('mobile-drawer'),
            mobileDrawerBackdrop: document.getElementById('mobile-drawer-backdrop'),
            mobileTrigger: document.getElementById('mobile-menu-trigger'),
            mobileClose: document.getElementById('mobile-drawer-close'),
            paperScrollContainer: document.getElementById('paper-scroll-container')
        };

        // --- INITIALIZATION ---
        async function init() {
            try {
                // Deterministic Payload Load
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Payload load failed");
                const payload = await response.json();
                
                state.papers = payload.papers || [];
                
                if (state.papers.length === 0) {
                    renderError("NO PAPERS FOUND IN PAYLOAD");
                    return;
                }

                renderPaperSelector();
                
                // Select first paper by default
                loadPaper(state.papers[0].key);

            } catch (error) {
                console.error(error);
                renderError("PAPERS PAYLOAD MISSING");
            }

            setupEventListeners();
        }

        // --- RENDERING CORE ---

        function renderError(msg) {
            els.paperContent.innerHTML = `
                <div class="flex items-center justify-center h-full pt-20">
                    <div class="text-primary-700 font-mono font-semibold bg-primary-50 px-4 py-2 rounded border border-primary-200">
                        ${msg}
                    </div>
                </div>
            `;
            els.paperSelect.innerHTML = '<option disabled>Error</option>';
        }

        function renderPaperSelector() {
            els.paperSelect.innerHTML = state.papers.map(p => 
                `<option value="${p.key}">${p.label}</option>`
            ).join('');
        }

        function loadPaper(paperKey) {
            const paper = state.papers.find(p => p.key === paperKey);
            if (!paper) return;

            state.currentPaper = paper;
            
            // 1. Render Navigation
            renderNavigation(paper);

            // 2. Render Content
            renderContent(paper);

            // 3. Reset Scroll
            els.paperScrollContainer.scrollTop = 0;
            updateActiveNavState();
        }

        // --- NAVIGATION RENDERING ---

        function renderNavigation(paper) {
            const itemsHtml = generateNavItemsHtml(paper);
            els.desktopNavList.innerHTML = itemsHtml;
            els.mobileNavList.innerHTML = itemsHtml;
        }

        function generateNavItemsHtml(paper) {
            let html = '';

            // Handle Sectioned Papers
            if (paper.sections && paper.sections.length > 0) {
                paper.sections.forEach((section, index) => {
                    // Render Section Label (Non-clickable) if exists
                    if (section.label && section.label.trim() !== '') {
                        const mt = index > 0 ? 'mt-6' : ''; // Spacing between sections
                        html += `
                            <div class="${mt} mb-2 px-2 text-xs font-semibold text-gray-400 uppercase tracking-wider select-none">
                                ${section.label}
                            </div>
                        `;
                    }
                    // Render Questions in Section
                    html += section.questions.map(q => renderNavItemRecursive(q)).join('');
                });
            } 
            // Handle Flat Papers
            else if (paper.questions && paper.questions.length > 0) {
                html += paper.questions.map(q => renderNavItemRecursive(q)).join('');
            }

            return html;
        }

        function renderNavItemRecursive(question) {
            let html = buildNavItem(question);
            if (question.children && question.children.length > 0) {
                html += question.children.map(child => renderNavItemRecursive(child)).join('');
            }
            return html;
        }

        function buildNavItem(question) {
            // Determine hierarchy visual cue (Subtle Type Scale)
            // We use ID length or pattern as a heuristic for depth if needed, 
            // but strict hierarchy logic says no indentation. 
            // We'll apply simpler styling for sub-questions based on context if we were tracking depth.
            // Since this is a recursive flat render string builder, we rely on the visual "flat list" rule.
            // Top level items could be slightly bolder.
            
            // Simple approach: Use consistent styling, active state adds weight.
            return `
                <a href="#q-${question.id}" 
                   class="nav-item group flex items-center px-2 py-1.5 text-sm text-gray-600 hover:text-gray-900 rounded-md transition-colors duration-200 outline-none focus-visible:ring-2 focus-visible:ring-primary-500"
                   data-target="q-${question.id}"
                   onclick="handleNavClick(event, 'q-${question.id}')">
                    <span class="nav-label truncate">${question.id}</span>
                </a>
            `;
        }

        // --- CONTENT RENDERING ---

        function renderContent(paper) {
            let html = '';

            if (paper.sections) {
                paper.sections.forEach(section => {
                    if (section.label && section.label.trim() !== '') {
                        html += `
                            <div class="mb-8 pt-4 border-b border-gray-200">
                                <h2 class="text-xl font-bold text-gray-900 pb-2">${section.label}</h2>
                            </div>
                        `;
                    }
                    html += `<div class="space-y-16">`; // Section group spacing
                    html += section.questions.map(q => renderQuestionNode(q, paper.defaults)).join('');
                    html += `</div>`;
                    html += `<div class="h-16"></div>`; // Spacing between sections
                });
            } else {
                html += `<div class="space-y-16">`; // Top level spacing (largest unit)
                html += paper.questions.map(q => renderQuestionNode(q, paper.defaults)).join('');
                html += `</div>`;
            }

            els.paperContent.innerHTML = html;

            // Trigger KaTeX Rendering on the newly injected content
            renderMathInElement(els.paperContent, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false},
                    {left: '\\(', right: '\\)', display: false},
                    {left: '\\[', right: '\\]', display: true}
                ],
                throwOnError: false,
                output: 'html' // Use HTML output for speed/accessibility
            });
        }

        function renderQuestionNode(question, defaults, depth = 0) {
            const hasSolutionBlock = !!question.solutionBlock;
            const hasAnswer = hasSolutionBlock && !!question.solutionBlock.answer;
            const hasDetails = hasSolutionBlock && !!question.solutionBlock.solutionDetails;
            
            // Default expanded state
            const isExpanded = defaults?.expandedAll !== false; 
            const detailsId = `details-${question.id.replace(/[^a-zA-Z0-9]/g, '-')}`;

            // Markdown processing
            const qHtml = md ? md.render(question.question || '') : question.question;

            // Child Indentation logic (Spacing only)
            const indentClass = depth > 0 ? 'pl-4 md:pl-8 border-l-2 border-transparent hover:border-gray-100 transition-colors' : '';
            const topMargin = depth > 0 ? 'mt-8' : ''; // Sub-questions closer than top-level

            let html = `
                <div id="q-${question.id}" class="question-node scroll-mt-24 ${indentClass} ${topMargin} relative group">
                    <!-- Question Body -->
                    <div class="mb-4">
                        <div class="flex items-baseline gap-3 mb-2">
                            <span class="text-sm font-semibold text-gray-500 select-none bg-gray-100 px-1.5 py-0.5 rounded">${question.id}</span>
                        </div>
                        <div class="markdown-content text-lg text-gray-900 font-medium leading-relaxed">
                            ${qHtml}
                        </div>
                    </div>
            `;

            // Solution Block
            if (hasSolutionBlock) {
                // Separator (Question -> Solution Block)
                // Using spacing as primary separator.
                html += `<div class="mt-6 space-y-4">`;

                // Answer
                if (hasAnswer) {
                    const aHtml = md ? md.render(question.solutionBlock.answer || '') : question.solutionBlock.answer;
                    // Label: "Answer" - using Accent Color (Primary) for label as permitted by ColorLab B override
                    html += `
                        <div class="answer-block">
                            <div class="text-xs font-bold text-primary-700 uppercase tracking-wider mb-1">Answer</div>
                            <div class="markdown-content text-gray-900">
                                ${aHtml}
                            </div>
                        </div>
                    `;
                }

                // Solution Details
                if (hasDetails) {
                    // Disclosure Control
                    // Text-first, accent color for interactivity
                    const btnText = isExpanded ? "Hide working" : "Show working";
                    const btnIconClass = isExpanded ? "ph-caret-up" : "ph-caret-down";
                    const displayStyle = isExpanded ? "block" : "hidden";

                    html += `
                        <div class="solution-details-wrapper">
                            <button onclick="toggleDetails('${detailsId}', this)" 
                                class="flex items-center gap-2 text-sm font-medium text-primary-600 hover:text-primary-700 transition-colors focus:outline-none focus-visible:underline decoration-primary-300 underline-offset-4">
                                <span class="btn-label">${btnText}</span>
                                <i class="ph ${btnIconClass}"></i>
                            </button>

                            <div id="${detailsId}" class="${displayStyle} mt-4 relative">
                                <!-- Optional Side Seam/Wash for Demarcation under density -->
                                <div class="absolute left-0 top-0 bottom-0 w-0.5 bg-primary-100/50 rounded-full hidden"></div>
                                
                                <div class="pl-0 space-y-6">
                                    ${renderSolutionDetailsInternals(question.solutionBlock.solutionDetails)}
                                </div>
                            </div>
                        </div>
                    `;
                }
                html += `</div>`; // End Solution Block wrapper
            }

            // Recursive Children
            if (question.children && question.children.length > 0) {
                html += `
                    <div class="children-container">
                        ${question.children.map(child => renderQuestionNode(child, defaults, depth + 1)).join('')}
                    </div>
                `;
            }

            html += `</div>`; // End Question Node
            return html;
        }

        function renderSolutionDetailsInternals(details) {
            let html = '';

            // 1. Keep in mind
            if (details.keepInMind) {
                const kimHtml = md ? md.render(details.keepInMind) : details.keepInMind;
                html += `
                    <div class="bg-blue-50/0"> <!-- Zero bg, structure only -->
                        <div class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 flex items-center gap-1.5">
                            <i class="ph-bold ph-lightbulb text-primary-400"></i>
                            Keep in mind
                        </div>
                        <div class="markdown-content text-sm text-gray-700">
                            ${kimHtml}
                        </div>
                    </div>
                `;
            }

            // 2. Formulas used
            if (details.formulasUsed) {
                const formulasHtml = md ? md.render(details.formulasUsed) : details.formulasUsed;
                html += `
                    <div>
                        <div class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">Formulas used</div>
                        <div class="markdown-content text-sm text-gray-600 font-mono text-xs">
                            ${formulasHtml}
                        </div>
                    </div>
                `;
            }

            // 3. Working (Primary)
            if (details.working) {
                const workHtml = md ? md.render(details.working) : details.working;
                // Subtle separation from previous elements
                const mt = (details.keepInMind || details.formulasUsed) ? 'pt-2 border-t border-gray-100' : '';
                html += `
                    <div class="${mt}">
                        <div class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">Working</div>
                        <div class="markdown-content text-gray-800 text-base">
                            ${workHtml}
                        </div>
                    </div>
                `;
            }

            // 4. Alternative Working (Array)
            if (details.alternativeWorking && details.alternativeWorking.length > 0) {
                details.alternativeWorking.forEach(alt => {
                    const altHtml = md ? md.render(alt) : alt;
                    html += `
                        <div class="pt-4 mt-2 border-t border-dashed border-gray-200">
                            <div class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Alternative working</div>
                            <div class="markdown-content text-gray-700 text-base">
                                ${altHtml}
                            </div>
                        </div>
                    `;
                });
            }

            return html;
        }

        // --- INTERACTIONS ---

        // Handle Paper Switch
        els.paperSelect.addEventListener('change', (e) => {
            loadPaper(e.target.value);
        });

        // Toggle Details
        window.toggleDetails = function(id, btn) {
            const el = document.getElementById(id);
            const isHidden = el.classList.contains('hidden');
            const label = btn.querySelector('.btn-label');
            const icon = btn.querySelector('i');

            if (isHidden) {
                el.classList.remove('hidden');
                label.textContent = "Hide working";
                icon.classList.remove('ph-caret-down');
                icon.classList.add('ph-caret-up');
            } else {
                el.classList.add('hidden');
                label.textContent = "Show working";
                icon.classList.remove('ph-caret-up');
                icon.classList.add('ph-caret-down');
            }
        };

        // Navigation Scroll Handling
        window.handleNavClick = function(e, targetId) {
            e.preventDefault();
            const target = document.getElementById(targetId);
            if (target) {
                // Mobile: Close drawer first
                if (!els.mobileDrawer.classList.contains('translate-x-full')) {
                    toggleMobileDrawer(false);
                    // Slight delay to allow drawer close to start
                    setTimeout(() => {
                        target.scrollIntoView({ block: 'start', behavior: 'smooth' });
                    }, 300);
                } else {
                    target.scrollIntoView({ block: 'start', behavior: 'smooth' });
                }
                
                // Set active state manually immediately for feedback
                setActiveNavItem(targetId);
            }
        };

        // Scroll Spy for Active Nav State
        let scrollTimeout;
        els.paperScrollContainer.addEventListener('scroll', () => {
            if (scrollTimeout) return;
            scrollTimeout = setTimeout(() => {
                updateActiveNavState();
                scrollTimeout = null;
            }, 100);
        });

        function updateActiveNavState() {
            // Find visible question
            const questions = document.querySelectorAll('.question-node');
            let activeId = null;
            
            // Simple intersection check: first element near top 1/3 of viewport
            for (let q of questions) {
                const rect = q.getBoundingClientRect();
                if (rect.top >= 0 && rect.top < window.innerHeight / 2) {
                    activeId = q.id;
                    break;
                }
            }
            // Fallback if scrolled past
            if (!activeId && questions.length > 0) {
                 // Check if at bottom
                 if (els.paperScrollContainer.scrollTop + els.paperScrollContainer.clientHeight >= els.paperScrollContainer.scrollHeight - 50) {
                     activeId = questions[questions.length - 1].id;
                 }
            }

            if (activeId) setActiveNavItem(activeId);
        }

        function setActiveNavItem(id) {
            // Clear current
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('text-primary-700', 'font-semibold', 'bg-primary-50');
                el.classList.add('text-gray-600');
                // Remove marker
                const marker = el.querySelector('.nav-marker');
                if (marker) marker.remove();
            });

            // Set new
            const activeLinks = document.querySelectorAll(`a[data-target="${id}"]`);
            activeLinks.forEach(link => {
                link.classList.remove('text-gray-600');
                link.classList.add('text-primary-700', 'font-semibold', 'bg-primary-50');
                // Add Marker (ColorLab B / Stage 6 override: Active indication uses weight + subtle marker)
                // Marker is purely visual, can be a left border or dot.
                // We'll use a pseudo-element logic via innerHTML injection for simplicity in this proto
                if (!link.querySelector('.nav-marker')) {
                    const marker = document.createElement('div');
                    marker.className = 'nav-marker absolute left-0 top-1/2 -translate-y-1/2 w-1 h-4 bg-primary-500 rounded-r-full';
                    link.style.position = 'relative'; // Ensure relative positioning
                    link.appendChild(marker);
                }
            });

            // Auto-scroll nav rail to keep active item in view
            if (activeLinks.length > 0 && window.innerWidth >= 768) {
                activeLinks[0].scrollIntoView({ block: 'nearest', behavior: 'smooth' });
            }
        }

        // Mobile Drawer Logic
        function toggleMobileDrawer(show) {
            if (show) {
                els.mobileDrawer.classList.remove('translate-x-full');
                els.mobileDrawerBackdrop.classList.remove('hidden');
                // small delay for opacity transition
                requestAnimationFrame(() => els.mobileDrawerBackdrop.classList.remove('opacity-0'));
            } else {
                els.mobileDrawer.classList.add('translate-x-full');
                els.mobileDrawerBackdrop.classList.add('opacity-0');
                setTimeout(() => els.mobileDrawerBackdrop.classList.add('hidden'), 300);
            }
        }

        els.mobileTrigger.addEventListener('click', () => toggleMobileDrawer(true));
        els.mobileClose.addEventListener('click', () => toggleMobileDrawer(false));
        els.mobileDrawerBackdrop.addEventListener('click', () => toggleMobileDrawer(false));

        // Start
        init();

    </script>
</body>
</html>
