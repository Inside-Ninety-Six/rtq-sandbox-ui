<!DOCTYPE html>
<html lang="en" class="light">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AB","indexWithinVariant":"197","totalWithinVariant":"200","hueFamily":"amber","intensityMode":"","timestamp":"2026-01-07T09:11:57.662Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AB&quot;,&quot;indexWithinVariant&quot;:&quot;197&quot;,&quot;totalWithinVariant&quot;:&quot;200&quot;,&quot;hueFamily&quot;:&quot;amber&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-07T09:11:57.662Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class', // Forced light mode per instructions
            theme: {
                extend: {
                    colors: {
                        // Base Warm Neutral (Stone)
                        stone: {
                            50: '#fafaf9',
                            100: '#f5f5f4',
                            200: '#e7e5e4',
                            300: '#d6d3d1',
                            400: '#a8a29e',
                            500: '#78716c',
                            600: '#57534e',
                            700: '#44403c',
                            800: '#292524',
                            900: '#1c1917',
                        },
                        // Accent Hue: Amber (Mandated by ColorLab B / Prompt)
                        accent: {
                            50: '#fffbeb',
                            100: '#fef3c7',
                            200: '#fde68a',
                            300: '#fcd34d',
                            400: '#fbbf24',
                            500: '#f59e0b',
                            600: '#d97706',
                            700: '#b45309',
                            800: '#92400e',
                            900: '#78350f',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'ui-sans-serif', 'system-ui', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Markdown-it -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <!-- KaTeX -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <style>
        /* Base Reset & Typography */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fafaf9; /* stone-50 */
            color: #1c1917; /* stone-900 */
            -webkit-font-smoothing: antialiased;
        }

        /* Scrollbar Hiding for Nav */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* KaTeX Overflow Protection (Critical) */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding-bottom: 4px; /* Space for scrollbar if needed */
            margin-top: 1em;
            margin-bottom: 1em;
            /* Stage 3/5: Block math underlay permitted but keep quiet. 
               ColorLab B: Amber permitted, but sticking to neutral for math background per semantics. */
        }

        /* Inline KaTeX: No background allowed */
        .katex {
            font-size: 1.1em;
        }

        /* Markdown Content Styling */
        .markdown-content p {
            margin-bottom: 0.75em;
            line-height: 1.6;
        }
        .markdown-content ul {
            list-style-type: disc;
            padding-left: 1.5em;
            margin-bottom: 0.75em;
        }
        .markdown-content ol {
            list-style-type: decimal;
            padding-left: 1.5em;
            margin-bottom: 0.75em;
        }
        .markdown-content table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1em;
            font-size: 0.95em;
        }
        .markdown-content th, .markdown-content td {
            border: 1px solid #e7e5e4; /* stone-200 */
            padding: 0.5rem;
            text-align: left;
        }
        .markdown-content th {
            font-weight: 600;
            background-color: transparent;
        }
        .markdown-content img, .markdown-content svg {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 1rem 0;
        }

        /* Focus Styles (Stage 5.5.2) */
        :focus-visible {
            outline: 2px solid #d97706; /* accent-600 */
            outline-offset: 2px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // ====================================================================
        // STAGE 0: CONSTANTS (AUTHORITATIVE)
        // ====================================================================
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // ====================================================================
        // UTILITIES & CONFIG
        // ====================================================================
        
        // Markdown-it Instance (Stage 6 Config: html:true, breaks:false, escape disabled)
        const md = window.markdownit ? window.markdownit({
            html: true,
            linkify: true,
            breaks: false 
        }) : null;

        if (md) {
            md.inline.ruler.disable(['escape']);
        }

        // Helper to flatten questions for navigation
        const flattenQuestions = (items, sectionLabel = null) => {
            let flat = [];
            items.forEach(item => {
                flat.push({ 
                    id: item.id, 
                    type: 'question', 
                    section: sectionLabel,
                    depth: 0 // Simplification: we only need ID for flat list nav
                });
                if (item.children) {
                    flat = [...flat, ...flattenQuestions(item.children, sectionLabel)];
                }
            });
            return flat;
        };

        const getNavigationItems = (paper) => {
            if (!paper) return [];
            if (paper.questions) {
                return flattenQuestions(paper.questions);
            }
            if (paper.sections) {
                let navItems = [];
                paper.sections.forEach(section => {
                    if (section.label && section.label.trim() !== '') {
                        navItems.push({ id: `sec-${section.label}`, label: section.label, type: 'section' });
                    }
                    navItems = [...navItems, ...flattenQuestions(section.questions, section.label)];
                });
                return navItems;
            }
            return [];
        };

        const getQuestionsList = (paper) => {
            if (!paper) return [];
            if (paper.questions) return paper.questions;
            if (paper.sections) {
                // Return section markers + questions interleaved if needed for rendering logic,
                // but for the recursive renderer we usually iterate sections. 
                // However, the brief implies sections act as separators in a continuous list.
                // We'll normalize to a structure that renders sections as headers if present.
                return paper.sections; // Handling this in PaperView
            }
            return [];
        }

        // ====================================================================
        // COMPONENTS
        // ====================================================================

        // --- Markdown Renderer Component ---
        const Markdown = ({ content, className }) => {
            const containerRef = React.useRef(null);

            React.useEffect(() => {
                if (containerRef.current && window.renderMathInElement) {
                    window.renderMathInElement(containerRef.current, {
                        delimiters: [
                            {left: '$$', right: '$$', display: true},
                            {left: '$', right: '$', display: false},
                            {left: '\\(', right: '\\)', display: false},
                            {left: '\\[', right: '\\]', display: true}
                        ],
                        throwOnError: false,
                        trust: true // Trust HTML for diagrams/SVG
                    });
                }
            }, [content]);

            if (!md) return <div className={className}>{content}</div>;

            const html = md.render(content || '');

            return (
                <div 
                    ref={containerRef}
                    className={`markdown-content ${className || ''}`}
                    dangerouslySetInnerHTML={{ __html: html }} 
                />
            );
        };

        // --- Solution Details Subsections ---
        const KeepInMind = ({ content }) => (
            <div className="mb-4">
                <div className="flex items-center gap-2 mb-1">
                    <i data-lucide="lightbulb" className="w-4 h-4 text-stone-500"></i>
                    <span className="text-sm font-bold text-stone-700">Keep in mind</span>
                </div>
                <Markdown content={content} className="text-sm text-stone-600" />
            </div>
        );

        const FormulasUsed = ({ content }) => (
            <div className="mb-4">
                <div className="mb-1">
                    <span className="text-sm font-bold text-stone-700">Formulas used</span>
                </div>
                <Markdown content={content} className="text-sm text-stone-600" />
            </div>
        );

        const WorkingBlock = ({ content, label = "Working" }) => (
            <div className="mb-6 last:mb-0">
                <div className="mb-2">
                    <span className="text-sm font-bold text-stone-700">{label}</span>
                </div>
                <Markdown content={content} className="text-base text-stone-700" />
            </div>
        );

        // --- Solution Block ---
        const SolutionBlock = ({ data, defaultExpanded }) => {
            // If defaultExpanded is strictly boolean in props, use it. Defaults to true if solutionDetails exists.
            const [isExpanded, setIsExpanded] = React.useState(defaultExpanded);

            const hasAnswer = !!data.answer;
            const hasDetails = !!data.solutionDetails;

            // Effect to sync Lucide icons when expanded changes
            React.useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [isExpanded]);

            if (!hasAnswer && !hasDetails) return null;

            return (
                <div className="mt-4 border-t-0 border-stone-100">
                    {/* Answer Section */}
                    {hasAnswer && (
                        <div className="mb-3">
                            <span className="text-sm font-bold text-stone-500 block mb-1">Answer</span>
                            <div className="text-lg font-medium text-stone-800">
                                <Markdown content={data.answer} />
                            </div>
                        </div>
                    )}

                    {/* Disclosure Control */}
                    {hasDetails && (
                        <div>
                            <button 
                                onClick={() => setIsExpanded(!isExpanded)}
                                className="flex items-center gap-1 text-sm font-medium text-accent-700 hover:text-accent-800 transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-accent-600 rounded px-1 -ml-1 py-1"
                                aria-expanded={isExpanded}
                            >
                                <span>{isExpanded ? 'Hide working' : 'Show working'}</span>
                                <i data-lucide={isExpanded ? "chevron-up" : "chevron-down"} className="w-4 h-4"></i>
                            </button>

                            {/* Expanded Details Region */}
                            {isExpanded && (
                                <div className="mt-3 pt-3 pl-0 animate-in fade-in slide-in-from-top-1 duration-200">
                                    {/* Optional subtle wash could go here, but strictly sticking to Stage 5 spacing/hierarchy preference first */}
                                    
                                    {data.solutionDetails.keepInMind && (
                                        <KeepInMind content={data.solutionDetails.keepInMind} />
                                    )}
                                    
                                    {data.solutionDetails.formulasUsed && (
                                        <div className="my-4 border-t border-stone-100 pt-3">
                                            <FormulasUsed content={data.solutionDetails.formulasUsed} />
                                        </div>
                                    )}

                                    {data.solutionDetails.working && (
                                         <div className="my-4 border-t border-stone-100 pt-3">
                                            <WorkingBlock content={data.solutionDetails.working} />
                                         </div>
                                    )}

                                    {data.solutionDetails.alternativeWorking && data.solutionDetails.alternativeWorking.map((alt, idx) => (
                                        <div key={idx} className="my-4 border-t border-stone-200 pt-4">
                                            <WorkingBlock content={alt} label="Alternative working" />
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        // --- Question Node ---
        const QuestionNode = ({ node, depth = 0, paperDefaults }) => {
            // Determine default expanded state
            // Logic: if paper.defaults.expandedAll is false, collapse. Else default expand.
            const defaultExpanded = paperDefaults?.expandedAll !== false;

            return (
                <div id={node.id} className={`group scroll-mt-24 ${depth > 0 ? 'mt-4' : 'mt-12 first:mt-0'}`}>
                    <div className="relative">
                        {/* Question Body */}
                        <div className="flex gap-4">
                            <div className="shrink-0 w-8 md:w-10">
                                <span className="text-base font-semibold text-stone-500 block sticky top-24">{node.id}</span>
                            </div>
                            <div className="grow min-w-0">
                                <div className="text-lg text-stone-900 font-medium">
                                    <Markdown content={node.question} />
                                </div>

                                {/* Solution Block (Optional) */}
                                {node.solutionBlock && (
                                    <SolutionBlock data={node.solutionBlock} defaultExpanded={defaultExpanded} />
                                )}
                            </div>
                        </div>

                        {/* Children */}
                        {node.children && node.children.length > 0 && (
                            <div className={`mt-4 pl-0 md:pl-10`}>
                                {node.children.map((child) => (
                                    <QuestionNode key={child.id} node={child} depth={depth + 1} paperDefaults={paperDefaults} />
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- Navigation ---
        const Navigation = ({ items, currentId, onSelect, mobile = false }) => {
            return (
                <nav className="flex flex-col py-4 w-full" aria-label="Question navigation">
                    {items.map((item, idx) => {
                        if (item.type === 'section') {
                            return (
                                <div key={`sec-${idx}`} className="px-4 py-2 mt-4 first:mt-0 mb-1">
                                    <span className="text-xs font-bold text-stone-400 uppercase tracking-wider block">
                                        Section {item.label}
                                    </span>
                                </div>
                            );
                        }
                        
                        // Question Item
                        const isActive = currentId === item.id;
                        return (
                            <a 
                                key={item.id}
                                href={`#${item.id}`}
                                onClick={(e) => {
                                    e.preventDefault();
                                    onSelect(item.id);
                                }}
                                className={`
                                    block px-4 py-1.5 text-sm transition-colors border-l-2
                                    ${isActive 
                                        ? 'border-accent-600 text-stone-900 font-bold bg-stone-100/50' 
                                        : 'border-transparent text-stone-500 hover:text-stone-800 hover:bg-stone-100/30'}
                                `}
                            >
                                {item.id}
                            </a>
                        );
                    })}
                </nav>
            );
        };

        // --- Main App Shell ---
        const App = () => {
            const [papers, setPapers] = React.useState([]);
            const [selectedPaperId, setSelectedPaperId] = React.useState(null);
            const [isLoading, setIsLoading] = React.useState(true);
            const [error, setError] = React.useState(false);
            const [mobileNavOpen, setMobileNavOpen] = React.useState(false);
            const [activeQuestionId, setActiveQuestionId] = React.useState(null);

            // 1. Fetch Payload
            React.useEffect(() => {
                fetch(RTQ_PAPERS_PAYLOAD_PATH)
                    .then(res => {
                        if (!res.ok) throw new Error("Failed to load");
                        return res.json();
                    })
                    .then(data => {
                        if (data && data.papers && data.papers.length > 0) {
                            setPapers(data.papers);
                            setSelectedPaperId(data.papers[0].key);
                        } else {
                            setError(true);
                        }
                        setIsLoading(false);
                    })
                    .catch(err => {
                        console.error(err);
                        setError(true);
                        setIsLoading(false);
                    });
            }, []);

            // 2. Initialize Icons
            React.useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            });

            // 3. Scroll Handling for Active ID
            React.useEffect(() => {
                if (!selectedPaperId) return;

                const handleScroll = () => {
                    // Simple logic to find top-most visible question
                    // In a real app, IntersectionObserver is better, but this suffices for prototype
                    const questions = document.querySelectorAll('[id]');
                    let current = null;
                    for (let q of questions) {
                        const rect = q.getBoundingClientRect();
                        if (rect.top >= 0 && rect.top < window.innerHeight / 2) {
                            current = q.id;
                            break;
                        }
                    }
                    if (current && current !== 'root') {
                        // Avoid setting non-question IDs
                        setActiveQuestionId(current);
                    }
                };
                window.addEventListener('scroll', handleScroll);
                return () => window.removeEventListener('scroll', handleScroll);
            }, [selectedPaperId]);

            const currentPaper = papers.find(p => p.key === selectedPaperId);
            const navItems = currentPaper ? getNavigationItems(currentPaper) : [];
            const isSectioned = currentPaper && !!currentPaper.sections;

            const handlePaperChange = (e) => {
                setSelectedPaperId(e.target.value);
                window.scrollTo(0,0);
            };

            const handleJump = (id) => {
                const el = document.getElementById(id);
                if (el) {
                    el.scrollIntoView({ behavior: 'smooth' });
                    setMobileNavOpen(false);
                    setActiveQuestionId(id);
                }
            };

            // Error State
            if (error) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-stone-50 text-stone-900 font-medium">
                        PAPERS PAYLOAD MISSING
                    </div>
                );
            }

            // Loading State
            if (isLoading) {
                return <div className="min-h-screen bg-stone-50"></div>;
            }

            return (
                <div className="min-h-screen bg-stone-50 text-stone-900 font-sans">
                    
                    {/* Top Controls (Aligned to shell) */}
                    <header className="sticky top-0 z-40 w-full bg-stone-50/95 backdrop-blur border-b border-stone-200">
                        <div className="max-w-6xl mx-auto px-4 h-14 flex items-center justify-between">
                            <div className="flex items-center gap-4">
                                <span className="text-sm font-semibold text-stone-400 uppercase tracking-wider hidden md:block">Paper</span>
                                <div className="relative">
                                    <select 
                                        value={selectedPaperId} 
                                        onChange={handlePaperChange}
                                        className="appearance-none bg-white border border-stone-300 hover:border-accent-400 text-stone-900 text-sm font-medium rounded py-1.5 pl-3 pr-8 focus:outline-none focus:ring-2 focus:ring-accent-500 transition-shadow cursor-pointer"
                                    >
                                        {papers.map(p => (
                                            <option key={p.key} value={p.key}>{p.label}</option>
                                        ))}
                                    </select>
                                    <i data-lucide="chevron-down" className="absolute right-2 top-2 w-4 h-4 text-stone-400 pointer-events-none"></i>
                                </div>
                            </div>

                            {/* Mobile Jump To */}
                            <div className="md:hidden">
                                <button 
                                    onClick={() => setMobileNavOpen(true)}
                                    className="flex items-center gap-2 text-sm font-medium text-stone-700 bg-white border border-stone-300 rounded px-3 py-1.5"
                                >
                                    <span>Jump to</span>
                                    <i data-lucide="list" className="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                    </header>

                    {/* DocumentFrameShell */}
                    <div className="max-w-6xl mx-auto px-4 flex items-start gap-8 py-8">
                        
                        {/* Desktop Nav Rail (Sticky) */}
                        <aside className="hidden md:block w-48 shrink-0 sticky top-20 max-h-[calc(100vh-6rem)] overflow-y-auto scrollbar-hide">
                            <Navigation 
                                items={navItems} 
                                currentId={activeQuestionId} 
                                onSelect={handleJump} 
                            />
                        </aside>

                        {/* Paper Content Column */}
                        <main className="grow min-w-0 pb-32">
                            {currentPaper && (
                                <div className="bg-white rounded-none md:rounded-lg md:shadow-sm border-x-0 md:border md:border-stone-200 p-0 md:p-12 min-h-[500px]">
                                    
                                    {/* Sectioned Paper Rendering */}
                                    {isSectioned ? (
                                        currentPaper.sections.map((section, idx) => (
                                            <div key={idx} className="mb-16 last:mb-0">
                                                {/* Section Header (Divider-like) */}
                                                {section.label && section.label.trim() !== '' && (
                                                    <div className="flex items-center gap-4 mb-8">
                                                        <span className="text-2xl font-bold text-stone-300 select-none">{section.label}</span>
                                                        <div className="h-px bg-stone-100 grow"></div>
                                                    </div>
                                                )}
                                                
                                                {/* Questions List */}
                                                <div className="space-y-12">
                                                    {section.questions.map(q => (
                                                        <QuestionNode key={q.id} node={q} paperDefaults={currentPaper.defaults} />
                                                    ))}
                                                </div>
                                            </div>
                                        ))
                                    ) : (
                                        /* Flat Paper Rendering */
                                        <div className="space-y-12">
                                            {currentPaper.questions.map(q => (
                                                <QuestionNode key={q.id} node={q} paperDefaults={currentPaper.defaults} />
                                            ))}
                                        </div>
                                    )}
                                </div>
                            )}
                        </main>
                    </div>

                    {/* Mobile Navigation Drawer */}
                    {mobileNavOpen && (
                        <div className="fixed inset-0 z-50 md:hidden flex justify-end" role="dialog" aria-modal="true">
                            {/* Backdrop */}
                            <div 
                                className="absolute inset-0 bg-stone-900/20 backdrop-blur-sm"
                                onClick={() => setMobileNavOpen(false)}
                            ></div>
                            
                            {/* Drawer */}
                            <div className="relative bg-white w-64 h-full shadow-xl flex flex-col animate-in slide-in-from-right duration-200">
                                <div className="p-4 border-b border-stone-100 flex items-center justify-between">
                                    <span className="font-semibold text-stone-900">Jump to</span>
                                    <button onClick={() => setMobileNavOpen(false)} className="p-1 text-stone-500">
                                        <i data-lucide="x" className="w-5 h-5"></i>
                                    </button>
                                </div>
                                <div className="flex-1 overflow-y-auto">
                                    <Navigation 
                                        items={navItems} 
                                        currentId={activeQuestionId} 
                                        onSelect={handleJump}
                                        mobile={true}
                                    />
                                </div>
                            </div>
                        </div>
                    )}

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
