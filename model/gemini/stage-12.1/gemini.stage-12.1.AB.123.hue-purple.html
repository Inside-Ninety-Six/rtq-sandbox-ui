<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AB","indexWithinVariant":"123","totalWithinVariant":"200","hueFamily":"purple","intensityMode":"","timestamp":"2026-01-07T05:54:45.946Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AB&quot;,&quot;indexWithinVariant&quot;:&quot;123&quot;,&quot;totalWithinVariant&quot;:&quot;200&quot;,&quot;hueFamily&quot;:&quot;purple&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-07T05:54:45.946Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ â€“ Maths Paper Solution Viewer (Stage 6)</title>

    <!-- Tailwind CSS (Prototyping) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- KaTeX CSS (No Integrity) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <!-- Icons: Phosphor (No Integrity) -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Markdown-it (No Integrity) -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <!-- KaTeX JS (No Integrity) -->
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- ColorLab B Configuration: Purple Theme -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        // Forced Hue Family: Purple
                        accent: {
                            50: '#faf5ff',
                            100: '#f3e8ff',
                            200: '#e9d5ff',
                            300: '#d8b4fe',
                            400: '#c084fc',
                            500: '#a855f7',
                            600: '#9333ea', // Primary interactive
                            700: '#7e22ce',
                            800: '#6b21a8',
                            900: '#581c87',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Base Reset & Typography */
        body {
            @apply bg-white text-gray-900 antialiased;
        }

        /* Focus Management - Accessibility */
        *:focus-visible {
            @apply outline-none ring-2 ring-accent-600 ring-offset-2;
        }

        /* KaTeX Overflow Handling (Containment Invariant) */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            padding-bottom: 4px; /* Space for scrollbar */
            max-width: 100%;
        }
        
        /* Inline Math Transparency */
        .katex {
            background-color: transparent !important;
        }

        /* Hide scrollbar for Nav but allow scroll */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Markdown Content Styling */
        .markdown-body p {
            margin-bottom: 0.75rem;
        }
        .markdown-body p:last-child {
            margin-bottom: 0;
        }
        .markdown-body ul {
            list-style-type: disc;
            padding-left: 1.25em;
            margin-bottom: 0.75rem;
        }
        .markdown-body ol {
            list-style-type: decimal;
            padding-left: 1.25em;
            margin-bottom: 0.75rem;
        }
        .markdown-body table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
            font-size: 0.95em;
        }
        .markdown-body th, .markdown-body td {
            border: 1px solid #e5e7eb; /* gray-200 */
            padding: 0.5rem;
            text-align: left;
        }
        .markdown-body th {
            font-weight: 600;
            background-color: transparent;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Top Controls Region -->
    <header class="w-full border-b border-gray-200 bg-white z-20 relative">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            
            <!-- Paper Selector -->
            <div class="flex items-center gap-3">
                <label for="paper-select" class="text-sm font-medium text-gray-500">Paper</label>
                <select id="paper-select" class="form-select block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-accent-600 focus:border-accent-600 sm:text-sm rounded-md bg-gray-50 hover:bg-gray-100 transition-colors cursor-pointer">
                    <option disabled selected>Loading papers...</option>
                </select>
            </div>

            <!-- Mobile "Jump to" Trigger -->
            <button id="mobile-menu-trigger" class="lg:hidden p-2 -mr-2 text-gray-600 hover:text-accent-700 hover:bg-accent-50 rounded-md transition-colors" aria-label="Jump to question">
                <span class="flex items-center gap-2 text-sm font-medium">
                    Jump to <i class="ph ph-list text-lg"></i>
                </span>
            </button>
        </div>
    </header>

    <!-- DocumentFrameShell -->
    <div class="flex-1 max-w-7xl mx-auto w-full px-4 sm:px-6 lg:px-8 flex relative">

        <!-- Desktop Navigation Rail (Sticky) -->
        <nav class="hidden lg:block w-64 flex-shrink-0 border-r border-transparent py-8 sticky top-0 h-[calc(100vh-4rem)] overflow-y-auto no-scrollbar pr-4">
            <div id="desktop-nav-content" class="space-y-1">
                <!-- Nav items generated here -->
            </div>
        </nav>

        <!-- Paper Content Column -->
        <main id="paper-region" class="flex-1 min-w-0 py-8 lg:pl-12 pb-24">
            <!-- Content generated here -->
            <div id="loading-indicator" class="text-gray-400 text-sm">Initializing...</div>
        </main>

    </div>

    <!-- Mobile Navigation Drawer -->
    <div id="mobile-drawer" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true">
        <!-- Backdrop -->
        <div id="mobile-drawer-backdrop" class="fixed inset-0 bg-gray-900/20 backdrop-blur-sm transition-opacity opacity-0"></div>
        
        <!-- Drawer Panel -->
        <div id="mobile-drawer-panel" class="fixed inset-y-0 right-0 w-full max-w-xs bg-white shadow-xl transform translate-x-full transition-transform duration-300 flex flex-col">
            <div class="flex items-center justify-between px-4 py-4 border-b border-gray-100">
                <h2 class="text-lg font-semibold text-gray-900">Jump to</h2>
                <button id="mobile-drawer-close" class="p-2 text-gray-500 hover:text-gray-700 rounded-md">
                    <i class="ph ph-x text-xl"></i>
                </button>
            </div>
            <div id="mobile-nav-content" class="flex-1 overflow-y-auto p-4 space-y-1">
                <!-- Mobile nav items -->
            </div>
        </div>
    </div>

    <script>
        // --- STAGE 0: CONSTANTS ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // --- STATE ---
        let appState = {
            papers: [],
            activePaperKey: null,
            expandedWorkings: {}, // Map<questionId, boolean>
            currentPaperData: null
        };

        // --- MARKDOWN INIT (Stage 6 Config) ---
        // html: true, linkify: true, breaks: false (CRITICAL)
        const md = window.markdownit ? window.markdownit({
            html: true,
            linkify: true,
            breaks: false 
        }) : null;

        if (md) {
            // Disable escape rule to preserve TeX backslashes
            md.inline.ruler.disable(['escape']);
        }

        // --- DOM ELEMENTS ---
        const els = {
            paperSelect: document.getElementById('paper-select'),
            desktopNav: document.getElementById('desktop-nav-content'),
            mobileNav: document.getElementById('mobile-nav-content'),
            paperRegion: document.getElementById('paper-region'),
            mobileTrigger: document.getElementById('mobile-menu-trigger'),
            mobileDrawer: document.getElementById('mobile-drawer'),
            mobileBackdrop: document.getElementById('mobile-drawer-backdrop'),
            mobilePanel: document.getElementById('mobile-drawer-panel'),
            mobileClose: document.getElementById('mobile-drawer-close')
        };

        // --- INITIALIZATION ---
        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Fetch failed");
                const data = await response.json();
                
                if (!data.papers || !Array.isArray(data.papers)) throw new Error("Invalid schema");
                
                appState.papers = data.papers;
                renderPaperSelector();
                
                // Select first paper by default
                if (appState.papers.length > 0) {
                    loadPaper(appState.papers[0].key);
                }
            } catch (err) {
                console.error(err);
                els.paperRegion.innerHTML = `
                    <div class="p-8 border-2 border-dashed border-gray-300 rounded text-center">
                        <p class="text-xl font-semibold text-gray-700">PAPERS PAYLOAD MISSING</p>
                        <p class="text-sm text-gray-500 mt-2">Could not load from ${RTQ_PAPERS_PAYLOAD_PATH}</p>
                    </div>
                `;
            }
        }

        // --- RENDERING: SELECTOR ---
        function renderPaperSelector() {
            els.paperSelect.innerHTML = appState.papers.map(p => 
                `<option value="${p.key}">${p.label}</option>`
            ).join('');
            
            els.paperSelect.addEventListener('change', (e) => {
                loadPaper(e.target.value);
            });
        }

        // --- LOAD PAPER LOGIC ---
        function loadPaper(key) {
            appState.activePaperKey = key;
            appState.currentPaperData = appState.papers.find(p => p.key === key);
            
            // Set defaults
            const defaults = appState.currentPaperData.defaults || {};
            const expandAll = defaults.expandedAll !== false; // Default to true if undefined
            
            // Reset expanded state
            appState.expandedWorkings = {}; 
            // We initialize state lazily or strictly based on node IDs. 
            // For simplicity, we assume "default" applies unless toggled.
            // But we need to track IDs for toggling.
            
            renderPaperContent();
            renderNavigation();
            
            // Post-render: Math
            renderMath();
            
            // Scroll to top
            window.scrollTo(0, 0);
        }

        // --- RENDERING: NAVIGATION ---
        function renderNavigation() {
            const paper = appState.currentPaperData;
            let html = '';

            const renderItem = (q, depth = 0) => {
                const paddingClass = depth > 0 ? 'text-gray-500 font-normal scale-95 origin-left' : 'text-gray-700 font-medium';
                // Active state simulated via simple logic (closest to viewport) - simplified for prototype to just link anchors
                // ColorLab B: Active uses Purple text + border.
                return `
                    <a href="#q-${q.id}" class="group flex items-center py-1.5 px-2 text-sm rounded-md transition-colors hover:bg-gray-50 hover:text-accent-700 focus:outline-none focus:ring-2 focus:ring-accent-600 block border-l-2 border-transparent hover:border-accent-300">
                        <span class="${paddingClass} group-hover:text-accent-700">${q.id}</span>
                    </a>
                `;
            };

            const processNodes = (nodes) => {
                let out = '';
                nodes.forEach(node => {
                    out += renderItem(node, 0); // Flat list visually, hierarchy via type scale cue only
                    if (node.children && node.children.length > 0) {
                        const traverseChildren = (children, depth) => {
                            children.forEach(child => {
                                // Visually flat, but conceptually nested. 
                                // Stage 5.4.5: "Hierarchy via type scale/quietness... same left edge"
                                out += `
                                    <a href="#q-${child.id}" class="group flex items-center py-1 px-2 text-sm rounded-md transition-colors hover:bg-gray-50 hover:text-accent-700 focus:outline-none focus:ring-2 focus:ring-accent-600 block border-l-2 border-transparent hover:border-accent-300">
                                        <span class="text-gray-500 text-xs font-normal group-hover:text-accent-700">${child.id}</span>
                                    </a>
                                `;
                                if (child.children) traverseChildren(child.children, depth + 1);
                            });
                        };
                        traverseChildren(node.children, 1);
                    }
                });
                return out;
            };

            if (paper.sections) {
                paper.sections.forEach(section => {
                    if (section.label && section.label.trim() !== "") {
                        html += `
                            <div class="mt-6 mb-2 px-2">
                                <span class="text-xs font-bold text-gray-400 uppercase tracking-wider">${section.label}</span>
                            </div>
                        `;
                    }
                    html += processNodes(section.questions);
                });
            } else if (paper.questions) {
                html += processNodes(paper.questions);
            }

            els.desktopNav.innerHTML = html;
            els.mobileNav.innerHTML = html; // Re-use html for mobile drawer
            
            // Add click listeners for smooth scroll / drawer close
            document.querySelectorAll('nav a, #mobile-nav-content a').forEach(link => {
                link.addEventListener('click', (e) => {
                    // Mobile close
                    closeMobileDrawer();
                });
            });
        }

        // --- RENDERING: PAPER CONTENT ---
        function renderPaperContent() {
            const paper = appState.currentPaperData;
            let html = `<div class="space-y-16">`; // Top level spacing

            const renderQuestionNode = (node, depth = 0) => {
                const hasSolutionBlock = !!node.solutionBlock;
                const hasAnswer = hasSolutionBlock && !!node.solutionBlock.answer;
                const hasDetails = hasSolutionBlock && !!node.solutionBlock.solutionDetails;
                
                // Determine expanded state
                const defaultExpanded = paper.defaults?.expandedAll !== false;
                const isExpanded = appState.expandedWorkings[node.id] !== undefined 
                    ? appState.expandedWorkings[node.id] 
                    : defaultExpanded;

                // Indentation for children
                const indentClass = depth > 0 ? 'ml-0 pl-0 sm:pl-4 border-l-0 sm:border-l border-transparent' : '';
                
                let nodeHtml = `
                    <div id="q-${node.id}" class="group relative ${indentClass} scroll-mt-24">
                        <!-- Question Body -->
                        <div class="mb-4">
                            <div class="flex items-baseline gap-3">
                                <span class="text-gray-400 font-medium text-sm select-none flex-shrink-0 min-w-[1.5rem]">${node.id}</span>
                                <div class="markdown-body text-gray-900 text-base leading-relaxed max-w-none flex-1">
                                    ${parseMarkdown(node.question)}
                                </div>
                            </div>
                        </div>
                `;

                if (hasSolutionBlock) {
                    nodeHtml += `<div class="ml-[calc(1.5rem+0.75rem)] space-y-4">`; // Indent to align with question text
                    
                    // Answer
                    if (hasAnswer) {
                        nodeHtml += `
                            <div class="relative">
                                <span class="block text-xs font-bold text-gray-400 uppercase tracking-wide mb-1">Answer</span>
                                <div class="markdown-body text-gray-900 font-medium">
                                    ${parseMarkdown(node.solutionBlock.answer)}
                                </div>
                            </div>
                        `;
                    }

                    // Solution Details Control & Region
                    if (hasDetails) {
                        const toggleId = `toggle-${node.id}`;
                        const contentId = `details-${node.id}`;
                        const btnText = isExpanded ? "Hide working" : "Show working";
                        const iconRot = isExpanded ? "rotate-180" : "";
                        
                        nodeHtml += `
                            <div class="pt-2">
                                <button onclick="toggleWorking('${node.id}')" 
                                    class="inline-flex items-center gap-1.5 text-sm font-medium text-accent-600 hover:text-accent-700 transition-colors focus:outline-none focus:underline"
                                    aria-expanded="${isExpanded}" aria-controls="${contentId}">
                                    <span>${btnText}</span>
                                    <i class="ph ph-caret-down ${iconRot} transition-transform duration-200"></i>
                                </button>
                                
                                <div id="${contentId}" class="${isExpanded ? 'block' : 'hidden'} mt-4 animate-fade-in">
                                    <div class="relative pl-4 border-l border-gray-100 bg-gray-50/50 rounded-r-sm py-4 pr-4">
                                        <!-- Keep in mind -->
                                        ${node.solutionBlock.solutionDetails.keepInMind ? `
                                            <div class="mb-6">
                                                <div class="flex items-center gap-2 mb-2 text-accent-700/80">
                                                    <i class="ph ph-lightbulb text-sm"></i>
                                                    <span class="text-xs font-bold uppercase tracking-wide">Keep in mind</span>
                                                </div>
                                                <div class="markdown-body text-sm text-gray-700">
                                                    ${parseMarkdown(node.solutionBlock.solutionDetails.keepInMind)}
                                                </div>
                                            </div>
                                        ` : ''}

                                        <!-- Formulas used -->
                                        ${node.solutionBlock.solutionDetails.formulasUsed ? `
                                            <div class="mb-6">
                                                <span class="block text-xs font-bold text-gray-400 uppercase tracking-wide mb-2">Formulas used</span>
                                                <div class="markdown-body text-sm text-gray-600">
                                                    ${parseMarkdown(node.solutionBlock.solutionDetails.formulasUsed)}
                                                </div>
                                            </div>
                                        ` : ''}

                                        <!-- Working (Primary) -->
                                        ${node.solutionBlock.solutionDetails.working ? `
                                            <div class="mb-6 last:mb-0">
                                                <span class="block text-xs font-bold text-gray-400 uppercase tracking-wide mb-2">Working</span>
                                                <div class="markdown-body text-gray-800">
                                                    ${parseMarkdown(node.solutionBlock.solutionDetails.working)}
                                                </div>
                                            </div>
                                        ` : ''}

                                        <!-- Alternative Workings -->
                                        ${node.solutionBlock.solutionDetails.alternativeWorking && Array.isArray(node.solutionBlock.solutionDetails.alternativeWorking) ? 
                                            node.solutionBlock.solutionDetails.alternativeWorking.map((alt, idx) => `
                                                <div class="mt-8 pt-6 border-t border-gray-200/50">
                                                    <span class="block text-xs font-bold text-gray-400 uppercase tracking-wide mb-2">Alternative working ${idx + 1}</span>
                                                    <div class="markdown-body text-gray-800">
                                                        ${parseMarkdown(alt)}
                                                    </div>
                                                </div>
                                            `).join('') 
                                        : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    nodeHtml += `</div>`; // End solution block wrapper
                }

                // Children recursion
                if (node.children && node.children.length > 0) {
                    nodeHtml += `<div class="mt-6 space-y-6">`;
                    node.children.forEach(child => {
                        nodeHtml += renderQuestionNode(child, depth + 1);
                    });
                    nodeHtml += `</div>`;
                }

                nodeHtml += `</div>`; // End question node
                return nodeHtml;
            };

            // Main Iteration
            if (paper.sections) {
                paper.sections.forEach(section => {
                    html += `<section>`;
                    if (section.label && section.label.trim() !== "") {
                        html += `
                            <div class="flex items-center gap-4 mb-8 mt-12 pb-2 border-b border-gray-100">
                                <span class="text-sm font-bold text-gray-900 bg-gray-100 px-2 py-1 rounded">${section.label}</span>
                            </div>
                        `;
                    }
                    section.questions.forEach(q => {
                        html += renderQuestionNode(q);
                        html += `<div class="h-16"></div>`; // Top level separation
                    });
                    html += `</section>`;
                });
            } else if (paper.questions) {
                paper.questions.forEach(q => {
                    html += renderQuestionNode(q);
                    html += `<div class="h-16"></div>`; // Top level separation
                });
            }

            html += `</div>`;
            els.paperRegion.innerHTML = html;
        }

        // --- HELPERS ---
        function parseMarkdown(text) {
            if (!text || !md) return text || '';
            return md.render(text);
        }

        function renderMath() {
            // KaTeX Auto-render
            if (window.renderMathInElement) {
                renderMathInElement(document.body, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false}
                    ],
                    throwOnError: false
                });
            }
        }

        // --- ACTIONS ---
        window.toggleWorking = function(id) {
            // Check current state in model or infer from current default
            const paper = appState.currentPaperData;
            const defaultExpanded = paper.defaults?.expandedAll !== false;
            const currentState = appState.expandedWorkings[id] !== undefined 
                ? appState.expandedWorkings[id] 
                : defaultExpanded;

            // Toggle
            appState.expandedWorkings[id] = !currentState;
            
            // Re-render (inefficient but safe for prototype reliability to prevent DOM drift)
            // Ideally we just toggle class, but we have text labels to change etc.
            // Let's do a smart re-render or just DOM manipulation. 
            // For stability: DOM manipulation for the specific node.
            
            const contentEl = document.getElementById(`details-${id}`);
            const btnEl = document.querySelector(`button[onclick="toggleWorking('${id}')"]`);
            
            if (contentEl && btnEl) {
                const isNowExpanded = !currentState;
                
                // Toggle visibility
                if (isNowExpanded) {
                    contentEl.classList.remove('hidden');
                    contentEl.classList.add('block');
                } else {
                    contentEl.classList.add('hidden');
                    contentEl.classList.remove('block');
                }
                
                // Update button
                const label = isNowExpanded ? "Hide working" : "Show working";
                const rotation = isNowExpanded ? "rotate-180" : "";
                btnEl.innerHTML = `<span>${label}</span> <i class="ph ph-caret-down ${rotation} transition-transform duration-200"></i>`;
                btnEl.setAttribute('aria-expanded', isNowExpanded);
            }
        };

        // --- MOBILE DRAWER ---
        function openMobileDrawer() {
            els.mobileDrawer.classList.remove('hidden');
            // Trigger reflow
            void els.mobileDrawer.offsetWidth;
            els.mobileBackdrop.classList.remove('opacity-0');
            els.mobilePanel.classList.remove('translate-x-full');
            document.body.style.overflow = 'hidden';
        }

        function closeMobileDrawer() {
            els.mobileBackdrop.classList.add('opacity-0');
            els.mobilePanel.classList.add('translate-x-full');
            setTimeout(() => {
                els.mobileDrawer.classList.add('hidden');
                document.body.style.overflow = '';
            }, 300);
        }

        els.mobileTrigger.addEventListener('click', openMobileDrawer);
        els.mobileClose.addEventListener('click', closeMobileDrawer);
        els.mobileBackdrop.addEventListener('click', closeMobileDrawer);

        // --- BOOTSTRAP ---
        init();

    </script>
</body>
</html>
