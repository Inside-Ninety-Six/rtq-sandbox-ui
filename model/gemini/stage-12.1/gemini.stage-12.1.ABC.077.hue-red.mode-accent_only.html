<!DOCTYPE html>
<html lang="en" class="antialiased">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"ABC","indexWithinVariant":"77","totalWithinVariant":"320","hueFamily":"red","intensityMode":"accent_only","timestamp":"2026-01-07T12:57:54.314Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;ABC&quot;,&quot;indexWithinVariant&quot;:&quot;77&quot;,&quot;totalWithinVariant&quot;:&quot;320&quot;,&quot;hueFamily&quot;:&quot;red&quot;,&quot;intensityMode&quot;:&quot;accent_only&quot;,&quot;timestamp&quot;:&quot;2026-01-07T12:57:54.314Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Viewer</title>
    <!-- Tailwind CSS (via CDN for prototyping) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Defined by ColorLab B (Red Hue Family) + ColorLab C (Accent Only Intensity)
                        // Base Hue: 25 (Warm Red)
                        // Intensity Mode: accent_only (High L, Very Low C for surfaces)
                        
                        page: 'oklch(0.98 0.002 25)',  // C <= 0.015
                        frame: 'oklch(0.96 0.005 25)', // Frame Base
                        paper: 'oklch(0.99 0.00 25)',  // Paper Surface
                        wash: 'oklch(0.97 0.005 25)',  // Solution Details Wash (Subtle)
                        
                        txt: {
                            primary: 'oklch(0.15 0.005 25)',   // C <= 0.010
                            secondary: 'oklch(0.45 0.008 25)', // C <= 0.012 (secondary text allowance)
                            tertiary: 'oklch(0.60 0.01 25)',
                        },
                        
                        accent: {
                            DEFAULT: 'oklch(0.60 0.14 25)', // C in [0.08 .. 0.14] - Muted Red/Terracotta
                            hover: 'oklch(0.55 0.14 25)',
                            focus: 'oklch(0.60 0.14 25)',
                        },
                        
                        divider: 'oklch(0.90 0.005 25)', // Neutral hairline
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    
    <!-- KaTeX (CDN - No Integrity) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Markdown-it (CDN - No Integrity) -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <!-- Alpine.js (CDN - No Integrity) -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>

    <style>
        /* CSS Reset & Typography Base */
        body {
            background-color: theme('colors.page');
            color: theme('colors.txt.primary');
        }

        /* Nav Scrollbar Hiding (Stage 6 Add-on) */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* KaTeX Containment Invariant (Stage 6 Locked) */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 4px; /* Space for potential scrollbar */
            margin: 0.5em 0;
        }
        /* Inline math - transparent bg override */
        .katex {
            background-color: transparent !important;
        }
        /* Tables in Markdown */
        .md-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 1em 0;
            font-size: 0.95em;
        }
        .md-content th, .md-content td {
            border: 1px solid theme('colors.divider');
            padding: 0.5em 0.75em;
            text-align: left;
        }
        .md-content th {
            font-weight: 600;
            color: theme('colors.txt.primary');
        }
        /* Markdown Content Reset */
        .md-content p {
            margin-bottom: 0.75em;
            line-height: 1.6;
        }
        .md-content p:last-child {
            margin-bottom: 0;
        }
        .md-content ul {
            list-style-type: disc;
            padding-left: 1.5em;
            margin-bottom: 0.75em;
        }
        .md-content ol {
            list-style-type: decimal;
            padding-left: 1.5em;
            margin-bottom: 0.75em;
        }
        
        /* Sticky Nav Helper */
        .sticky-nav {
            position: sticky;
            top: 0;
            max-height: 100vh;
        }
    </style>
</head>
<body x-data="app()">

    <!-- CANONICAL CONSTANTS (Runtime Definition) -->
    <script>
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";
        
        // Stage 6 ColorLab B: Force Red
        const RTQ_COLORLAB_FORCE_HUE_FAMILY = "red";
        // Stage 6 ColorLab C: Accent Only
        const RTQ_COLORLAB_INTENSITY_MODE = "accent_only";
    </script>

    <!-- DocumentFrameShell: Top Controls Region (Aligned to shell) -->
    <div class="w-full border-b border-divider bg-frame z-20 relative">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-14 flex items-center justify-between">
            
            <!-- Paper Selector -->
            <div class="flex items-center gap-3">
                <label for="paper-select" class="text-sm font-medium text-txt-secondary">Paper</label>
                <select id="paper-select" 
                        x-model="activePaperKey" 
                        @change="loadPaper(activePaperKey)"
                        class="bg-paper border border-divider rounded px-2 py-1 text-sm text-txt-primary focus:outline-none focus:ring-1 focus:ring-accent focus:border-accent">
                    <template x-for="paper in papers" :key="paper.key">
                        <option :value="paper.key" x-text="paper.label"></option>
                    </template>
                </select>
            </div>

            <!-- Mobile Jump To Trigger (Drawer Opener) -->
            <button @click="drawerOpen = true" class="md:hidden text-accent font-medium text-sm hover:text-accent-hover transition-colors">
                Jump to
            </button>
        </div>
    </div>

    <!-- DocumentFrameShell: Main Layout -->
    <div class="max-w-7xl mx-auto w-full flex flex-col md:flex-row min-h-[calc(100vh-3.5rem)] bg-frame">
        
        <!-- Navigation Column (Desktop: Sticky Rail) -->
        <nav class="hidden md:block w-64 flex-shrink-0 border-r border-divider bg-frame sticky-nav overflow-y-auto no-scrollbar py-6 pl-4 pr-4">
            <template x-if="activePaperData">
                <ul class="space-y-1">
                    <template x-for="(item, index) in navItems" :key="index">
                        <li>
                            <!-- Section Label (Non-clickable separator) -->
                            <template x-if="item.type === 'section'">
                                <div class="mt-6 mb-2 text-xs font-semibold text-txt-tertiary uppercase tracking-wider pl-3" x-text="item.label"></div>
                            </template>
                            
                            <!-- Question Item (Question Identifier Only) -->
                            <template x-if="item.type === 'question'">
                                <a :href="'#q-' + item.id" 
                                   @click.prevent="scrollToQuestion(item.id)"
                                   class="block py-1 text-sm transition-colors duration-200 border-l-2 pl-3"
                                   :class="currentNavId === item.id ? 'border-accent text-txt-primary font-bold' : 'border-transparent text-txt-secondary hover:text-txt-primary hover:border-divider'">
                                    <span x-text="item.displayId"></span>
                                </a>
                            </template>
                        </li>
                    </template>
                </ul>
            </template>
        </nav>

        <!-- Paper Content Column (Primary) -->
        <main class="flex-1 bg-paper min-h-screen">
            <div class="max-w-3xl mx-auto py-8 px-4 sm:px-8 md:px-12">
                
                <!-- Loading State -->
                <div x-show="isLoading" class="py-12 text-center text-txt-secondary">Loading paper...</div>
                
                <!-- Failure Mode -->
                <div x-show="error" class="py-12 text-center text-red-600 font-medium tracking-wide">PAPERS PAYLOAD MISSING</div>

                <!-- Paper Document -->
                <div x-show="!isLoading && !error && activePaperData">
                    
                    <!-- Question List -->
                    <div class="space-y-12"> <!-- Largest spacing unit between top-level questions -->
                        <template x-for="node in flattenedNodes" :key="node.uniqueKey">
                            
                            <!-- Section Header Block -->
                            <div x-show="node.isSectionHeader" class="pt-8 pb-4 border-b border-divider mb-8">
                                <h2 class="text-xl font-bold text-txt-primary" x-text="node.sectionLabel"></h2>
                            </div>

                            <!-- Question Node -->
                            <template x-if="!node.isSectionHeader">
                                <div :id="'q-' + node.id" class="group scroll-mt-24">
                                    
                                    <!-- Indentation based on depth (no visual indentation in nav, but indentation in paper body permitted) -->
                                    <div :class="'pl-' + (node.depth * 4) + (node.depth > 0 ? ' mt-6' : '')"> 
                                        
                                        <!-- Question Body -->
                                        <div class="mb-4">
                                            <div class="flex items-baseline gap-3">
                                                <!-- Question Identifier -->
                                                <span class="flex-shrink-0 font-medium text-txt-secondary select-none" x-text="node.id"></span>
                                                <!-- Question Prompt -->
                                                <div class="flex-1 text-lg text-txt-primary md-content question-prompt" x-html="renderMarkdown(node.question)"></div>
                                            </div>
                                        </div>

                                        <!-- Solution Block (Optional) -->
                                        <template x-if="node.hasSolutionBlock">
                                            <div class="mt-4">
                                                
                                                <!-- Answer (Optional - Visible by default if present) -->
                                                <template x-if="node.answer">
                                                    <div class="mb-3 pl-0 sm:pl-0">
                                                        <span class="block text-xs font-bold text-txt-tertiary uppercase mb-1">Answer</span>
                                                        <div class="text-base text-txt-primary font-medium md-content" x-html="renderMarkdown(node.answer)"></div>
                                                    </div>
                                                </template>

                                                <!-- Solution Details (Optional - Collapsible) -->
                                                <template x-if="node.solutionDetails">
                                                    <div x-data="{ expanded: node.defaultExpanded }" class="mt-3">
                                                        
                                                        <!-- Disclosure Control -->
                                                        <button @click="expanded = !expanded" 
                                                                class="flex items-center gap-2 text-sm font-medium text-accent hover:text-accent-hover focus:outline-none focus:ring-1 focus:ring-accent rounded px-1 -ml-1 py-1 mb-2 transition-colors">
                                                            <span x-text="expanded ? 'Hide working' : 'Show working'"></span>
                                                            <!-- Optional Chevron -->
                                                            <svg class="w-4 h-4 transition-transform duration-200" :class="expanded ? 'rotate-180' : ''" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                                            </svg>
                                                        </button>

                                                        <!-- Expanded Region -->
                                                        <div x-show="expanded" x-collapse class="relative overflow-hidden">
                                                            <!-- Optional Wash Surface (Stage 3 permitted) -->
                                                            <div class="bg-wash rounded-sm p-4 border-l border-divider/50">
                                                                
                                                                <!-- Keep in Mind -->
                                                                <template x-if="node.solutionDetails.keepInMind">
                                                                    <div class="mb-5">
                                                                        <div class="text-xs font-bold text-txt-secondary mb-1 flex items-center gap-1">
                                                                            <span>Keep in mind</span>
                                                                        </div>
                                                                        <div class="text-sm text-txt-secondary md-content" x-html="renderMarkdown(node.solutionDetails.keepInMind)"></div>
                                                                    </div>
                                                                </template>

                                                                <!-- Formulas Used -->
                                                                <template x-if="node.solutionDetails.formulasUsed">
                                                                    <div class="mb-5">
                                                                        <div class="text-xs font-bold text-txt-secondary mb-1">Formulas used</div>
                                                                        <div class="text-sm text-txt-secondary md-content font-mono text-xs" x-html="renderMarkdown(node.solutionDetails.formulasUsed)"></div>
                                                                    </div>
                                                                </template>

                                                                <!-- Working (Primary) -->
                                                                <template x-if="node.solutionDetails.working">
                                                                    <div class="mb-4">
                                                                        <div class="text-xs font-bold text-txt-secondary mb-2">Working</div>
                                                                        <div class="text-base text-txt-secondary leading-relaxed md-content" x-html="renderMarkdown(node.solutionDetails.working)"></div>
                                                                    </div>
                                                                </template>

                                                                <!-- Alternative Working (Loop) -->
                                                                <template x-if="node.solutionDetails.alternativeWorking && node.solutionDetails.alternativeWorking.length">
                                                                    <div class="pt-4 mt-4 border-t border-divider">
                                                                         <template x-for="(alt, idx) in node.solutionDetails.alternativeWorking" :key="idx">
                                                                            <div class="mb-4">
                                                                                <div class="text-xs font-bold text-txt-secondary mb-2">Alternative working</div>
                                                                                <div class="text-base text-txt-secondary leading-relaxed md-content" x-html="renderMarkdown(alt)"></div>
                                                                            </div>
                                                                         </template>
                                                                    </div>
                                                                </template>

                                                            </div>
                                                        </div>
                                                    </div>
                                                </template>

                                            </div>
                                        </template>

                                    </div>
                                </div>
                            </template>
                        </template>
                    </div>
                    
                    <!-- Bottom Spacing for scroll comfort -->
                    <div class="h-32"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Mobile Navigation Drawer -->
    <div x-show="drawerOpen" class="fixed inset-0 z-50 md:hidden" role="dialog" aria-modal="true" style="display: none;">
        <!-- Backdrop -->
        <div x-show="drawerOpen" 
             x-transition:enter="transition-opacity ease-linear duration-300"
             x-transition:enter-start="opacity-0"
             x-transition:enter-end="opacity-100"
             x-transition:leave="transition-opacity ease-linear duration-300"
             x-transition:leave-start="opacity-100"
             x-transition:leave-end="opacity-0"
             class="fixed inset-0 bg-black/40 backdrop-blur-sm" 
             @click="drawerOpen = false"></div>

        <!-- Drawer Content -->
        <div x-show="drawerOpen" 
             x-transition:enter="transition ease-in-out duration-300 transform"
             x-transition:enter-start="translate-x-full"
             x-transition:enter-end="translate-x-0"
             x-transition:leave="transition ease-in-out duration-300 transform"
             x-transition:leave-start="translate-x-0"
             x-transition:leave-end="translate-x-full"
             class="relative ml-auto w-full max-w-xs h-full bg-frame shadow-xl flex flex-col">
            
            <div class="flex items-center justify-between px-4 py-3 border-b border-divider">
                <h2 class="text-lg font-medium text-txt-primary">Jump to</h2>
                <button @click="drawerOpen = false" class="text-txt-secondary hover:text-txt-primary p-2">
                    <span class="sr-only">Close</span>
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <div class="flex-1 overflow-y-auto px-4 py-4">
                 <ul class="space-y-1">
                    <template x-for="(item, index) in navItems" :key="index">
                        <li>
                            <template x-if="item.type === 'section'">
                                <div class="mt-4 mb-2 text-xs font-bold text-txt-tertiary uppercase tracking-wider pl-2" x-text="item.label"></div>
                            </template>
                            <template x-if="item.type === 'question'">
                                <button @click="scrollToQuestion(item.id); drawerOpen = false"
                                   class="block w-full text-left py-2 px-2 rounded text-base transition-colors"
                                   :class="currentNavId === item.id ? 'text-accent font-bold' : 'text-txt-secondary hover:bg-divider/30 hover:text-txt-primary'">
                                    <span x-text="item.displayId"></span>
                                </button>
                            </template>
                        </li>
                    </template>
                </ul>
            </div>
        </div>
    </div>

    <!-- Application Logic -->
    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('app', () => ({
                papers: [],
                activePaperKey: null,
                activePaperData: null,
                navItems: [],
                flattenedNodes: [], 
                isLoading: true,
                error: false,
                drawerOpen: false,
                currentNavId: null,

                init() {
                    // Load Payload Deterministically
                    fetch(RTQ_PAPERS_PAYLOAD_PATH)
                        .then(res => {
                            if (!res.ok) throw new Error('Network response was not ok');
                            return res.json();
                        })
                        .then(data => {
                            if (!data || !data.papers) throw new Error('Invalid payload');
                            this.papers = data.papers;
                            // Default to first paper if available
                            if (this.papers.length > 0) {
                                this.loadPaper(this.papers[0].key);
                            } else {
                                this.isLoading = false;
                            }
                        })
                        .catch(err => {
                            console.error(err);
                            this.error = true;
                            this.isLoading = false;
                        });

                    // Scroll Spy for Nav
                    window.addEventListener('scroll', () => {
                        this.updateActiveNav();
                    }, { passive: true });
                },

                loadPaper(key) {
                    this.activePaperKey = key;
                    const paper = this.papers.find(p => p.key === key);
                    if (!paper) return;

                    this.activePaperData = paper;
                    const expandedAll = paper.defaults && paper.defaults.expandedAll !== undefined ? paper.defaults.expandedAll : true;

                    // Rebuild Nav and Flatten Nodes
                    this.navItems = [];
                    this.flattenedNodes = [];

                    if (paper.sections) {
                        paper.sections.forEach(section => {
                            // Nav Section (Add only if label exists)
                            if (section.label && section.label.trim() !== '') {
                                this.navItems.push({ type: 'section', label: section.label });
                                // Add to flattenedNodes for visual header rendering
                                this.flattenedNodes.push({ 
                                    isSectionHeader: true, 
                                    sectionLabel: section.label, 
                                    uniqueKey: 'sec-' + section.label 
                                });
                            }
                            // Process Questions in Section
                            this.processQuestions(section.questions, 0, expandedAll);
                        });
                    } else if (paper.questions) {
                        this.processQuestions(paper.questions, 0, expandedAll);
                    }

                    this.isLoading = false;
                    
                    // Reset scroll
                    window.scrollTo(0, 0);

                    // Trigger KaTeX render
                    this.$nextTick(() => {
                        this.renderMathInDoc();
                    });
                },

                processQuestions(questions, depth, defaultExpanded) {
                    if (!questions) return;
                    questions.forEach(q => {
                        // Add to Nav
                        this.navItems.push({ 
                            type: 'question', 
                            id: q.id, 
                            displayId: q.id 
                        });

                        const hasSolutionBlock = !!q.solutionBlock;
                        const hasSolutionDetails = hasSolutionBlock && !!q.solutionBlock.solutionDetails;
                        
                        // Flatten for rendering
                        this.flattenedNodes.push({
                            ...q,
                            depth: depth,
                            uniqueKey: q.id + '-' + Math.random().toString(36).substr(2, 9),
                            hasSolutionBlock: hasSolutionBlock,
                            hasSolutionDetails: hasSolutionDetails,
                            answer: hasSolutionBlock ? q.solutionBlock.answer : null,
                            solutionDetails: hasSolutionDetails ? q.solutionBlock.solutionDetails : null,
                            defaultExpanded: defaultExpanded,
                            isSectionHeader: false
                        });

                        // Recursion (Flattened)
                        if (q.children && q.children.length > 0) {
                            this.processQuestions(q.children, depth + 1, defaultExpanded);
                        }
                    });
                },

                scrollToQuestion(id) {
                    const el = document.getElementById('q-' + id);
                    if (el) {
                        const top = el.getBoundingClientRect().top + window.pageYOffset - 80; 
                        window.scrollTo({ top: top, behavior: 'smooth' });
                    }
                },

                updateActiveNav() {
                    let current = null;
                    // Simple logic: find last element passed top threshold
                    for (let node of this.flattenedNodes) {
                        if (node.isSectionHeader) continue;
                        const el = document.getElementById('q-' + node.id);
                        if (el) {
                            const rect = el.getBoundingClientRect();
                            if (rect.top < 150) { 
                                current = node.id;
                            }
                        }
                    }
                    if (current) this.currentNavId = current;
                },

                // Markdown Configuration (Stage 6 Config)
                renderMarkdown(text) {
                    if (!text) return '';
                    if (!window.markdownit) return text;
                    
                    const md = window.markdownit({
                        html: true, // Inline SVG passthrough
                        linkify: true,
                        breaks: false, // MUST be false to prevent KaTeX breakage
                    });
                    
                    // Disable escape rule to preserve TeX backslashes
                    md.inline.ruler.disable(['escape']);
                    
                    return md.render(text);
                },

                // KaTeX Auto-Render
                renderMathInDoc() {
                    if (window.renderMathInElement) {
                        renderMathInElement(document.body, {
                            delimiters: [
                                {left: '$$', right: '$$', display: true},
                                {left: '$', right: '$', display: false},
                                {left: '\\(', right: '\\)', display: false},
                                {left: '\\[', right: '\\]', display: true}
                            ],
                            throwOnError: false,
                        });
                    }
                }
            }));
        });
    </script>
</body>
</html>
