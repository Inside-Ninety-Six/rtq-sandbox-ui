<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AB","indexWithinVariant":"143","totalWithinVariant":"200","hueFamily":"teal","intensityMode":"","timestamp":"2026-01-07T06:47:21.754Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AB&quot;,&quot;indexWithinVariant&quot;:&quot;143&quot;,&quot;totalWithinVariant&quot;:&quot;200&quot;,&quot;hueFamily&quot;:&quot;teal&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-07T06:47:21.754Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Viewer</title>
    
    <!-- KaTeX CSS (SRI disabled per instructions) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    
    <!-- Scripts (SRI disabled per instructions) -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@13.0.1/dist/markdown-it.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <style>
        /* =========================================
           STAGE 0-6: CSS VARIABLES & RESET
           ColorLab B: Force Hue = Teal
           Light Mode Only
           ========================================= */
        :root {
            /* Palette: Teal-based (Tailwind-ish values) */
            --c-base-white: #ffffff;
            --c-base-bg: #fcfdfe; /* Very slight teal tint */
            
            --c-neutral-50: #f0fdfa;
            --c-neutral-100: #ccfbf1;
            --c-neutral-200: #99f6e4;
            --c-neutral-300: #5eead4;
            --c-neutral-400: #2dd4bf;
            --c-neutral-500: #14b8a6;
            --c-neutral-600: #0d9488;
            --c-neutral-700: #0f766e;
            --c-neutral-800: #115e59;
            --c-neutral-900: #134e4a;
            --c-neutral-950: #042f2e;

            /* Grayscale for text balancing */
            --c-slate-50: #f8fafc;
            --c-slate-100: #f1f5f9;
            --c-slate-200: #e2e8f0;
            --c-slate-300: #cbd5e1;
            --c-slate-400: #94a3b8;
            --c-slate-500: #64748b;
            --c-slate-600: #475569;
            --c-slate-700: #334155;
            --c-slate-800: #1e293b;
            --c-slate-900: #0f172a;

            /* Semantic Mappings */
            --bg-body: var(--c-base-bg);
            --bg-paper: var(--c-base-white);
            --bg-surface-secondary: var(--c-neutral-50);
            
            --text-primary: var(--c-slate-900);
            --text-secondary: var(--c-slate-700);
            --text-tertiary: var(--c-slate-500);
            --text-accent: var(--c-neutral-700);
            
            --border-hairline: var(--c-slate-200);
            --border-focus: var(--c-neutral-500);

            --accent-interaction: var(--c-neutral-600);
            
            /* Spacing Scale */
            --sp-xs: 0.25rem;
            --sp-sm: 0.5rem;
            --sp-md: 1rem;
            --sp-lg: 1.5rem;
            --sp-xl: 2.5rem;
            --sp-xxl: 4rem;

            /* Typography */
            --font-stack: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --lh-tight: 1.3;
            --lh-base: 1.6;
            --lh-loose: 1.8;
        }

        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: var(--font-stack);
            background-color: var(--bg-body);
            color: var(--text-primary);
            line-height: var(--lh-base);
            -webkit-font-smoothing: antialiased;
            overflow-y: scroll; /* Force scrollbar to avoid layout shift */
        }

        /* Focus States (Stage 5.5.2) */
        :focus-visible {
            outline: 2px solid var(--border-focus);
            outline-offset: 2px;
        }

        /* =========================================
           LAYOUT SHELL (Stage 3)
           ========================================= */
        .app-shell {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .top-controls {
            position: sticky;
            top: 0;
            z-index: 50;
            background-color: var(--bg-body); /* Matches shell base */
            border-bottom: 1px solid var(--border-hairline);
            padding: var(--sp-md) var(--sp-lg);
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 64px;
        }

        .document-frame {
            display: flex;
            flex: 1;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            position: relative;
        }

        /* Desktop Nav Rail */
        .nav-column {
            display: none; /* Mobile default */
            width: 240px;
            flex-shrink: 0;
            padding-top: var(--sp-xl);
            padding-bottom: var(--sp-xl);
            padding-right: var(--sp-lg);
            
            /* Sticky Logic */
            position: sticky;
            top: 64px; /* Below header */
            height: calc(100vh - 64px);
            overflow-y: auto;
            
            /* Scrollbar Hiding (Stage 6 Add-on) */
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE/Edge */
        }
        .nav-column::-webkit-scrollbar {
            display: none;
        }

        /* Paper Content Column */
        .paper-column {
            flex: 1;
            min-width: 0; /* Flexbox overflow fix */
            padding-top: var(--sp-xl);
            padding-bottom: var(--sp-xxl);
            padding-left: var(--sp-lg);
            padding-right: var(--sp-lg);
        }

        @media (min-width: 768px) {
            .nav-column {
                display: block;
            }
            .mobile-trigger {
                display: none;
            }
            .paper-column {
                border-left: 1px solid transparent; /* Keeps spacing consistent */
            }
        }

        /* =========================================
           NAVIGATION (Stage 3 & 5)
           ========================================= */
        .nav-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .nav-section-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-tertiary);
            font-weight: 600;
            margin-top: var(--sp-md);
            margin-bottom: var(--sp-sm);
            padding-left: var(--sp-sm);
        }

        .nav-item {
            display: block;
            padding: var(--sp-xs) var(--sp-sm);
            text-decoration: none;
            color: var(--text-secondary);
            font-size: 0.9rem;
            border-radius: 4px;
            cursor: pointer;
            transition: color 0.1s ease, font-weight 0.1s ease;
        }

        .nav-item:hover {
            color: var(--accent-interaction);
            background-color: var(--c-neutral-100); /* Very subtle hover */
        }

        .nav-item.active {
            font-weight: 700;
            color: var(--c-neutral-800);
            /* Stage 6: Weight-only primary, allowed accent marker */
            border-left: 3px solid var(--accent-interaction);
            padding-left: calc(var(--sp-sm) - 3px);
            background-color: transparent;
        }

        /* Hierarchy via type scale only (flat left edge) */
        .nav-item[data-depth="0"] { font-size: 1rem; }
        .nav-item[data-depth="1"] { font-size: 0.9rem; }
        .nav-item[data-depth="2"] { font-size: 0.85rem; color: var(--text-tertiary); }

        /* =========================================
           PAPER CONTENT (Stage 3, 4, 5)
           ========================================= */
        .paper-section-header {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border-hairline);
            padding-bottom: var(--sp-sm);
            margin-top: var(--sp-xl);
            margin-bottom: var(--sp-lg);
        }

        .question-node {
            margin-bottom: var(--sp-xl); /* Top level spacing */
            position: relative;
        }

        .question-node.child {
            margin-top: var(--sp-md);
            margin-bottom: var(--sp-md);
            padding-left: var(--sp-md); /* Indentation for children */
            border-left: 1px solid var(--border-hairline); /* Optional guide */
        }

        /* Question Body */
        .q-body {
            display: flex;
            gap: var(--sp-sm);
            color: var(--text-primary);
            font-size: 1.1rem;
        }

        .q-id {
            font-weight: 600;
            flex-shrink: 0;
            color: var(--text-secondary);
            min-width: 2ch;
        }

        .q-prompt {
            flex: 1;
            /* Markdown content styling */
        }
        .q-prompt p { margin-top: 0; }

        /* Solution Block */
        .solution-block {
            margin-top: var(--sp-md);
            padding-left: calc(var(--sp-sm) + 2ch); /* Align with text start */
        }

        /* Answer */
        .answer-region {
            margin-bottom: var(--sp-sm);
        }
        .answer-label {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--text-secondary);
            margin-bottom: var(--sp-xs);
            display: block;
        }
        .answer-content {
            font-size: 1rem;
            color: var(--text-primary);
        }

        /* Disclosure Control */
        .disclosure-btn {
            background: none;
            border: none;
            padding: var(--sp-xs) 0;
            font-family: inherit;
            font-size: 0.9rem;
            color: var(--accent-interaction);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: var(--sp-xs);
            font-weight: 500;
        }
        .disclosure-btn:hover {
            text-decoration: underline;
        }
        .chevron {
            transition: transform 0.2s ease;
            width: 1em;
            height: 1em;
            fill: currentColor;
        }
        .disclosure-btn[aria-expanded="true"] .chevron {
            transform: rotate(180deg);
        }

        /* Solution Details Region */
        .solution-details {
            display: none;
            margin-top: var(--sp-md);
            padding-top: var(--sp-md);
            border-top: 1px solid var(--border-hairline); /* Boundary Clarity */
            color: var(--text-secondary); /* Subordinate */
        }
        .solution-details[data-visible="true"] {
            display: block;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-4px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Subsections */
        .sd-subsection {
            margin-bottom: var(--sp-lg);
        }
        .sd-label {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 700;
            color: var(--text-tertiary);
            margin-bottom: var(--sp-sm);
            display: flex;
            align-items: center;
            gap: var(--sp-xs);
        }
        .sd-body {
            font-size: 0.95rem;
            line-height: var(--lh-loose);
        }

        /* Keep in Mind Styling */
        .sd-subsection.keep-in-mind .sd-label {
            color: var(--text-accent);
        }
        
        /* Working / Alt Working Separation */
        .sd-subsection + .sd-subsection {
            border-top: 1px dashed var(--border-hairline);
            padding-top: var(--sp-md);
        }

        /* =========================================
           MOBILE DRAWER (Add-on)
           ========================================= */
        .drawer-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 99;
            display: none;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .drawer-overlay.open {
            display: block;
            opacity: 1;
        }
        .drawer {
            position: fixed;
            top: 0; bottom: 0; left: 0;
            width: 80%;
            max-width: 320px;
            background: var(--bg-body);
            z-index: 100;
            transform: translateX(-100%);
            transition: transform 0.2s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 12px rgba(0,0,0,0.1);
        }
        .drawer.open {
            transform: translateX(0);
        }
        .drawer-header {
            padding: var(--sp-md);
            border-bottom: 1px solid var(--border-hairline);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .drawer-title { font-weight: 700; }
        .drawer-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-secondary); }
        .drawer-content {
            overflow-y: auto;
            padding: var(--sp-md);
            flex: 1;
        }

        /* =========================================
           MARKDOWN & KATEX TWEAKS
           ========================================= */
        /* Table minimalism */
        table {
            border-collapse: collapse;
            width: 100%;
            margin: var(--sp-md) 0;
            font-size: 0.9rem;
        }
        th, td {
            border: 1px solid var(--border-hairline);
            padding: var(--sp-sm);
            text-align: left;
        }
        th { font-weight: 600; background: var(--c-neutral-50); }

        /* Markdown lists */
        .md-content ul, .md-content ol { margin-top: 0; padding-left: 1.2em; }
        .md-content p { margin-bottom: 0.75em; }
        .md-content p:last-child { margin-bottom: 0; }

        /* KaTeX Overrides (Stage 3/6 Locked) */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            padding: 0.5em 0;
            margin: 0.5em 0;
            max-width: 100%;
            /* Optional underlay for block math only */
            background: var(--bg-surface-secondary); 
            border-radius: 4px;
            padding: 0.5em;
        }
        /* Inline has no background */
        .katex { font-size: 1.1em; } /* Tweaked for readability */

        /* Utility */
        .hidden { display: none !important; }
        .paper-selector {
            padding: var(--sp-sm);
            border: 1px solid var(--border-hairline);
            border-radius: 4px;
            font-family: inherit;
            color: var(--text-primary);
            background: var(--bg-paper);
        }
        
        .jump-btn {
            background: var(--c-neutral-100);
            border: 1px solid var(--c-neutral-200);
            color: var(--text-accent);
            padding: var(--sp-xs) var(--sp-md);
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
        }
        
        /* Error State */
        .error-message {
            padding: var(--sp-xl);
            text-align: center;
            color: var(--text-tertiary);
            font-weight: 700;
            letter-spacing: 0.1em;
        }

    </style>
</head>
<body>

<div id="app" class="app-shell">
    <header class="top-controls">
        <select id="paperSelector" class="paper-selector" aria-label="Select Paper"></select>
        <button id="mobileJumpTrigger" class="jump-btn mobile-trigger" aria-label="Jump to question">Jump to...</button>
    </header>

    <div class="document-frame">
        <!-- Desktop Nav -->
        <nav class="nav-column" aria-label="Document Navigation">
            <div id="desktopNavContent"></div>
        </nav>

        <!-- Paper Content -->
        <main class="paper-column">
            <article id="paperContent" role="article"></article>
        </main>
    </div>

    <!-- Mobile Drawer -->
    <div id="drawerOverlay" class="drawer-overlay"></div>
    <div id="drawer" class="drawer" aria-hidden="true">
        <div class="drawer-header">
            <span class="drawer-title">Jump to</span>
            <button id="drawerClose" class="drawer-close" aria-label="Close navigation">&times;</button>
        </div>
        <div class="drawer-content" id="mobileNavContent">
            <!-- Cloned Nav Content -->
        </div>
    </div>
</div>

<script>
/**
 * STAGE 0 CONSTANTS - AUTHORITATIVE
 */
const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

/**
 * APPLICATION STATE
 */
const state = {
    papers: [],
    currentPaper: null,
    expandedNodes: new Set(), // Tracks expanded question IDs (for persistence per session if needed, mostly logic handling)
    activeObserver: null
};

/**
 * INITIALIZATION
 */
async function init() {
    // 1. Markdown Setup (Stage 6 Add-on)
    setupMarkdown();

    // 2. Fetch Payload
    try {
        const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
        if (!response.ok) throw new Error("Network response was not ok");
        const payload = await response.json();
        
        if (!payload || !payload.papers) throw new Error("Invalid payload");
        state.papers = payload.papers;

        initUI();
    } catch (error) {
        console.error("Payload Load Error:", error);
        renderError();
    }
}

function renderError() {
    const main = document.getElementById("paperContent");
    main.innerHTML = `<div class="error-message">PAPERS PAYLOAD MISSING</div>`;
    // Clean up controls
    document.getElementById("paperSelector").innerHTML = "<option disabled>Error</option>";
}

/**
 * MARKDOWN CONFIG
 */
let md = null;
function setupMarkdown() {
    if (window.markdownit) {
        md = window.markdownit({
            html: true, // Inline SVG passthrough
            linkify: true,
            breaks: false // Critical: prevent <br> in math
        });
        // Disable escape rule to preserve TeX backslashes
        md.inline.ruler.disable(['escape']);
    }
}

/**
 * UI LOGIC
 */
function initUI() {
    const selector = document.getElementById("paperSelector");
    
    // Populate Selector
    state.papers.forEach((paper, index) => {
        const opt = document.createElement("option");
        opt.value = index; // Use index as efficient key
        opt.textContent = paper.label || paper.key;
        selector.appendChild(opt);
    });

    selector.addEventListener("change", (e) => {
        loadPaper(state.papers[e.target.value]);
    });

    // Mobile Drawer Logic
    const drawerTrigger = document.getElementById("mobileJumpTrigger");
    const drawerClose = document.getElementById("drawerClose");
    const overlay = document.getElementById("drawerOverlay");
    const drawer = document.getElementById("drawer");

    function toggleDrawer(open) {
        if (open) {
            overlay.classList.add("open");
            drawer.classList.add("open");
            drawer.setAttribute("aria-hidden", "false");
        } else {
            overlay.classList.remove("open");
            drawer.classList.remove("open");
            drawer.setAttribute("aria-hidden", "true");
        }
    }

    drawerTrigger.addEventListener("click", () => toggleDrawer(true));
    drawerClose.addEventListener("click", () => toggleDrawer(false));
    overlay.addEventListener("click", () => toggleDrawer(false));
    
    // Nav Click Handling (Delegation)
    document.body.addEventListener("click", (e) => {
        if (e.target.classList.contains("nav-item")) {
            e.preventDefault();
            const targetId = e.target.getAttribute("href").substring(1);
            const targetEl = document.getElementById(targetId);
            if (targetEl) {
                // Smooth scroll
                const offset = 80; // Header height + buffer
                const elementPosition = targetEl.getBoundingClientRect().top + window.scrollY;
                window.scrollTo({
                    top: elementPosition - offset,
                    behavior: "smooth"
                });
                
                // Close mobile drawer if open
                if (window.innerWidth < 768) toggleDrawer(false);
            }
        }
        
        // Disclosure Control
        const btn = e.target.closest(".disclosure-btn");
        if (btn) {
            const regionId = btn.getAttribute("aria-controls");
            const region = document.getElementById(regionId);
            const isExpanded = btn.getAttribute("aria-expanded") === "true";
            
            if (region) {
                // Toggle state
                if (isExpanded) {
                    btn.setAttribute("aria-expanded", "false");
                    btn.querySelector("span").textContent = "Show working";
                    region.setAttribute("data-visible", "false");
                } else {
                    btn.setAttribute("aria-expanded", "true");
                    btn.querySelector("span").textContent = "Hide working";
                    region.setAttribute("data-visible", "true");
                }
            }
        }
    });

    // Load first paper
    if (state.papers.length > 0) {
        loadPaper(state.papers[0]);
    }
}

function loadPaper(paper) {
    state.currentPaper = paper;
    
    // Clear previous
    const contentContainer = document.getElementById("paperContent");
    const navContainerDesktop = document.getElementById("desktopNavContent");
    const navContainerMobile = document.getElementById("mobileNavContent");
    
    contentContainer.innerHTML = "";
    navContainerDesktop.innerHTML = "";
    
    // Default expanded state
    const defaultExpanded = paper.defaults?.expandedAll !== false;

    // Build Content & Nav Arrays
    let navHTML = '<ul class="nav-list">';
    
    // Handle Sections vs Flat
    if (paper.sections) {
        paper.sections.forEach(section => {
            // Render Section Header in Content
            if (section.label) {
                const secHeader = document.createElement("div");
                secHeader.className = "paper-section-header";
                secHeader.textContent = `Section ${section.label}`;
                contentContainer.appendChild(secHeader);

                // Nav Section Label
                navHTML += `<li class="nav-section-label">Section ${section.label}</li>`;
            }
            
            // Render Questions
            if (section.questions) {
                section.questions.forEach(q => {
                    contentContainer.appendChild(renderQuestionNode(q, 0, defaultExpanded));
                    navHTML += renderNavTree(q, 0);
                });
            }
        });
    } else if (paper.questions) {
        paper.questions.forEach(q => {
            contentContainer.appendChild(renderQuestionNode(q, 0, defaultExpanded));
            navHTML += renderNavTree(q, 0);
        });
    }
    
    navHTML += '</ul>';
    
    // Inject Nav
    navContainerDesktop.innerHTML = navHTML;
    navContainerMobile.innerHTML = navHTML; // Clone for mobile

    // Render Math
    renderMathInElement(contentContainer, {
        delimiters: [
            {left: '$$', right: '$$', display: true},
            {left: '$', right: '$', display: false},
            {left: '\\(', right: '\\)', display: false},
            {left: '\\[', right: '\\]', display: true}
        ],
        throwOnError: false
    });

    // Setup Intersection Observer for Active Nav State
    setupObserver();
}

/**
 * CONTENT RENDERING
 */
function renderMarkdown(text) {
    if (!text) return "";
    return md ? md.render(text) : text; // Fallback to plain text if MD fail
}

function renderQuestionNode(node, depth, defaultExpanded) {
    const wrapper = document.createElement("div");
    wrapper.className = `question-node ${depth > 0 ? 'child' : ''}`;
    // Create an anchor ID for navigation
    // Note: IDs in payload might not be unique across papers, but within one paper usually are. 
    // We sanitize ID for HTML attribute safety.
    const safeId = "q-" + node.id.replace(/[^a-zA-Z0-9-]/g, "_");
    wrapper.id = safeId;
    wrapper.setAttribute("data-qid", node.id);

    // 1. Question Body
    const qBody = document.createElement("div");
    qBody.className = "q-body";
    qBody.innerHTML = `
        <div class="q-id">${node.id}</div>
        <div class="q-prompt md-content">${renderMarkdown(node.question)}</div>
    `;
    wrapper.appendChild(qBody);

    // 2. Solution Block (Optional)
    if (node.solutionBlock) {
        const sb = node.solutionBlock;
        const blockDiv = document.createElement("div");
        blockDiv.className = "solution-block";

        // A. Answer (Optional, Visible Default)
        if (sb.answer) {
            const ansDiv = document.createElement("div");
            ansDiv.className = "answer-region";
            ansDiv.innerHTML = `
                <span class="answer-label">Answer</span>
                <div class="answer-content md-content">${renderMarkdown(sb.answer)}</div>
            `;
            blockDiv.appendChild(ansDiv);
        }

        // B. Solution Details (Optional)
        if (sb.solutionDetails) {
            const sd = sb.solutionDetails;
            const regionId = safeId + "-sd";
            
            // Disclosure Control
            const toggle = document.createElement("button");
            toggle.className = "disclosure-btn";
            toggle.setAttribute("aria-controls", regionId);
            toggle.setAttribute("aria-expanded", defaultExpanded ? "true" : "false");
            toggle.innerHTML = `
                <span>${defaultExpanded ? "Hide working" : "Show working"}</span>
                <svg class="chevron" viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>
            `;
            blockDiv.appendChild(toggle);

            // Details Region
            const detailsDiv = document.createElement("div");
            detailsDiv.id = regionId;
            detailsDiv.className = "solution-details";
            detailsDiv.setAttribute("data-visible", defaultExpanded ? "true" : "false");

            // Build Subsections
            let detailsHTML = "";

            // Keep in mind
            if (sd.keepInMind) {
                detailsHTML += `
                    <div class="sd-subsection keep-in-mind">
                        <div class="sd-label">Keep in mind</div>
                        <div class="sd-body md-content">${renderMarkdown(sd.keepInMind)}</div>
                    </div>
                `;
            }

            // Formulas Used
            if (sd.formulasUsed) {
                detailsHTML += `
                    <div class="sd-subsection">
                        <div class="sd-label">Formulas used</div>
                        <div class="sd-body md-content">${renderMarkdown(sd.formulasUsed)}</div>
                    </div>
                `;
            }

            // Working
            if (sd.working) {
                detailsHTML += `
                    <div class="sd-subsection">
                        <div class="sd-label">Working</div>
                        <div class="sd-body md-content">${renderMarkdown(sd.working)}</div>
                    </div>
                `;
            }

            // Alternative Working (Array)
            if (sd.alternativeWorking && Array.isArray(sd.alternativeWorking)) {
                sd.alternativeWorking.forEach((alt, idx) => {
                    detailsHTML += `
                        <div class="sd-subsection">
                            <div class="sd-label">Alternative working ${sd.alternativeWorking.length > 1 ? idx+1 : ''}</div>
                            <div class="sd-body md-content">${renderMarkdown(alt)}</div>
                        </div>
                    `;
                });
            }

            detailsDiv.innerHTML = detailsHTML;
            blockDiv.appendChild(detailsDiv);
        }

        wrapper.appendChild(blockDiv);
    }

    // 3. Children (Recursive)
    if (node.children && node.children.length > 0) {
        const childrenContainer = document.createElement("div");
        childrenContainer.className = "children-container";
        node.children.forEach(child => {
            childrenContainer.appendChild(renderQuestionNode(child, depth + 1, defaultExpanded));
        });
        wrapper.appendChild(childrenContainer);
    }

    return wrapper;
}

/**
 * NAVIGATION RENDERING
 */
function renderNavTree(node, depth) {
    const safeId = "q-" + node.id.replace(/[^a-zA-Z0-9-]/g, "_");
    let html = `
        <li>
            <a href="#${safeId}" class="nav-item" data-target="${safeId}" data-depth="${Math.min(depth, 2)}">
                ${node.id}
            </a>
        </li>
    `;
    
    if (node.children && node.children.length > 0) {
        node.children.forEach(child => {
            html += renderNavTree(child, depth + 1);
        });
    }
    return html;
}

/**
 * INTERSECTION OBSERVER
 */
function setupObserver() {
    if (state.activeObserver) state.activeObserver.disconnect();

    const options = {
        root: null,
        rootMargin: '-10% 0px -80% 0px', // Trigger near top
        threshold: 0
    };

    state.activeObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const id = entry.target.id;
                // Update Nav
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                const activeLinks = document.querySelectorAll(`.nav-item[data-target="${id}"]`);
                activeLinks.forEach(l => l.classList.add('active'));
                
                // Scroll nav into view if needed
                if (activeLinks.length > 0 && window.innerWidth >= 768) {
                    const navContainer = document.querySelector('.nav-column');
                    // Simple logic to keep active item in view
                    const itemTop = activeLinks[0].offsetTop;
                    const navHeight = navContainer.clientHeight;
                    const scrollPos = navContainer.scrollTop;
                    if (itemTop < scrollPos || itemTop > scrollPos + navHeight) {
                        navContainer.scrollTop = itemTop - (navHeight / 2);
                    }
                }
            }
        });
    }, options);

    const questions = document.querySelectorAll('.question-node');
    questions.forEach(q => state.activeObserver.observe(q));
}

// Start
init();

</script>
</body>
</html>
