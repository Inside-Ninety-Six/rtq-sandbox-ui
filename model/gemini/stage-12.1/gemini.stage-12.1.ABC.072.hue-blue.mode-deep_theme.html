<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"ABC","indexWithinVariant":"72","totalWithinVariant":"320","hueFamily":"blue","intensityMode":"deep_theme","timestamp":"2026-01-07T12:43:32.125Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;ABC&quot;,&quot;indexWithinVariant&quot;:&quot;72&quot;,&quot;totalWithinVariant&quot;:&quot;320&quot;,&quot;hueFamily&quot;:&quot;blue&quot;,&quot;intensityMode&quot;:&quot;deep_theme&quot;,&quot;timestamp&quot;:&quot;2026-01-07T12:43:32.125Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer (Prototype)</title>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- KaTeX CSS (No SRI per Stage 6.0.7b) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <!-- Tailwind CSS (Prototype Build) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- KaTeX JS (No SRI per Stage 6.0.7b) -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Markdown-it -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <!-- Configuration & Styles -->
    <style>
        /* 
           COLORLAB C: DEEP THEME (LIGHT MODE ONLY) + COLORLAB B: BLUE (HUE 265)
           Mode: deep_theme
           Hue: 265 (Blue)
        */
        :root {
            /* Page Background: L[0.92..0.98], C[0.08..0.16] */
            --c-page-bg: oklch(0.95 0.10 265);
            
            /* Frame Background: L[0.90..0.96], C[0.08..0.16] */
            --c-frame-bg: oklch(0.93 0.12 265);
            
            /* Paper Surface: L[0.94..0.99], C[0.06..0.14] */
            --c-paper-bg: oklch(0.98 0.07 265);
            
            /* Wash Surface (Solution Details): C[0.05..0.10] */
            --c-wash: oklch(0.96 0.08 265);
            
            /* Text Primary: L[0.15..0.25], C<=0.015 */
            --c-text-primary: oklch(0.20 0.015 265);
            
            /* Text Secondary: L[0.25..0.40], C<=0.020 */
            --c-text-secondary: oklch(0.35 0.02 265);
            
            /* Accent: L[0.45..0.65], C[0.16..0.26] */
            --c-accent: oklch(0.55 0.22 265);
            
            /* Hairline: C<=0.02 */
            --c-hairline: oklch(0.85 0.02 265);
            
            /* Focus Ring */
            --c-focus: var(--c-accent);

            /* Font Family */
            --font-sans: 'Inter', sans-serif;
        }

        body {
            background-color: var(--c-page-bg);
            color: var(--c-text-primary);
            font-family: var(--font-sans);
            margin: 0;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        /* Utility classes mapping to vars */
        .bg-frame { background-color: var(--c-frame-bg); }
        .bg-paper { background-color: var(--c-paper-bg); }
        .bg-wash { background-color: var(--c-wash); }
        .text-primary { color: var(--c-text-primary); }
        .text-secondary { color: var(--c-text-secondary); }
        .text-accent { color: var(--c-accent); }
        .border-hairline { border-color: var(--c-hairline); }
        
        /* Focus styles */
        .focus-visible-ring:focus-visible {
            outline: 2px solid var(--c-focus);
            outline-offset: 2px;
        }

        /* Scrollbar Hiding (Stage 6 Add-on) */
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* KaTeX Containment Invariant (Stage 6.0.8) */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding-bottom: 0.5rem; /* Space for scrollbar if needed */
        }
        
        /* Markdown Content Styling */
        .md-content p { margin-bottom: 1rem; }
        .md-content p:last-child { margin-bottom: 0; }
        /* Tables per Stage 5.8.5 */
        .md-content table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
            font-size: 0.95em;
        }
        .md-content th, .md-content td {
            border: 1px solid var(--c-hairline);
            padding: 0.5rem;
            text-align: left;
        }
        .md-content th { font-weight: 600; }
        
        /* Ensure diagrams (SVG) render appropriately */
        .md-content svg {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 1rem 0;
        }

        /* Animation for expansion */
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        
        /* Solution Details Wash */
        .solution-details-region {
            /* Applied via class conditionally */
        }

        /* Sticky Nav */
        .sticky-nav {
            position: sticky;
            top: 1rem;
            height: calc(100vh - 2rem);
            overflow-y: auto;
        }

        /* Interactive Elements */
        button, summary, a { cursor: pointer; }
    </style>
</head>
<body>
    <div id="app" class="min-h-screen flex flex-col items-center py-4 px-4 sm:px-6 md:py-8">
        <!-- App content injected here -->
    </div>

<script>
    // ===== STAGE 0: CONSTANTS =====
    const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
    const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

    // ===== ADD-ONS: COLORLAB C VARIABLES =====
    const RTQ_COLORLAB_INTENSITY_MODE = "deep_theme"; 

    // ===== MARKDOWN SETUP (Stage 6 Baseline) =====
    // html: true (SVG passthrough), breaks: false (KaTeX safety), escape disabled (TeX safety)
    const md = window.markdownit ? window.markdownit({
        html: true,
        linkify: true,
        breaks: false
    }) : null;

    if (md) {
        md.inline.ruler.disable(['escape']);
    }

    // ===== APP STATE =====
    const state = {
        papers: [],
        currentPaperId: null,
        loading: true,
        error: false,
        expandedDetails: {}, // Map<questionId, boolean>
        mobileNavOpen: false
    };

    // ===== DATA FETCHING =====
    async function init() {
        try {
            const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
            if (!response.ok) throw new Error("Payload missing");
            const data = await response.json();
            
            if (data.papers && data.papers.length > 0) {
                state.papers = data.papers;
                selectPaper(state.papers[0].key);
            } else {
                throw new Error("No papers in payload");
            }
        } catch (e) {
            console.error(e);
            state.error = true;
            state.loading = false;
            render();
        }
    }

    function selectPaper(paperKey) {
        const paper = state.papers.find(p => p.key === paperKey);
        if (!paper) return;
        
        state.currentPaperId = paperKey;
        state.loading = false;
        
        // Reset expansion state based on defaults
        const defaultExpanded = paper.defaults?.expandedAll !== false;
        state.expandedDetails = {}; 
        
        // Helper to init expansion state recursively
        function initExpanded(nodes) {
            if (!nodes) return;
            nodes.forEach(node => {
                if (node.solutionBlock?.solutionDetails) {
                    state.expandedDetails[node.id] = defaultExpanded;
                }
                if (node.children) initExpanded(node.children);
                // Handle sectioned structure
                if (node.questions) initExpanded(node.questions);
            });
        }

        if (paper.sections) {
            paper.sections.forEach(s => initExpanded(s.questions));
        } else if (paper.questions) {
            initExpanded(paper.questions);
        }

        render();
        // Trigger KaTeX render after DOM update
        requestAnimationFrame(() => {
            renderMathInElement(document.body, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false}
                ],
                throwOnError: false
            });
        });
    }

    function toggleDetails(questionId) {
        state.expandedDetails[questionId] = !state.expandedDetails[questionId];
        render(); // Re-render to update UI state
        // Re-run KaTeX on the specific area would be optimized, but full re-render + global KaTeX is robust for prototype
        requestAnimationFrame(() => {
            renderMathInElement(document.body, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false}
                ],
                throwOnError: false
            });
        });
    }

    function toggleMobileNav() {
        state.mobileNavOpen = !state.mobileNavOpen;
        render();
    }

    function jumpToQuestion(id) {
        state.mobileNavOpen = false;
        render(); // Close drawer first
        setTimeout(() => {
            const el = document.getElementById(`q-${id}`);
            if (el) {
                el.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }, 50);
    }

    // ===== RENDERING COMPONENTS =====

    function renderPaperSelector() {
        if (!state.papers.length) return '';
        
        const options = state.papers.map(p => 
            `<option value="${p.key}" ${p.key === state.currentPaperId ? 'selected' : ''}>${p.label}</option>`
        ).join('');

        return `
            <div class="mb-4 flex items-center justify-between w-full max-w-5xl mx-auto px-4 sm:px-0">
                <div class="relative">
                    <select 
                        onchange="selectPaper(this.value)"
                        class="appearance-none bg-paper border border-hairline text-primary py-2 pl-3 pr-8 rounded text-sm focus-visible-ring font-medium shadow-sm"
                    >
                        ${options}
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-secondary">
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                    </div>
                </div>
                <button 
                    class="md:hidden text-sm font-medium text-accent focus-visible-ring px-2 py-1"
                    onclick="toggleMobileNav()"
                >
                    Jump to
                </button>
            </div>
        `;
    }

    function renderNavList(currentPaper, isMobile = false) {
        let html = '';
        
        const renderItem = (id) => `
            <button 
                onclick="jumpToQuestion('${id}')" 
                class="block w-full text-left py-1 px-2 text-sm rounded hover:bg-black/5 focus-visible-ring ${isMobile ? 'py-3 text-base border-b border-hairline' : ''}"
            >
                <span class="text-secondary font-medium hover:text-primary transition-colors">
                    ${id}
                </span>
            </button>
        `;

        // Generate flat list structure
        const processNodes = (nodes) => {
            nodes.forEach(node => {
                html += renderItem(node.id);
                if (node.children) processNodes(node.children);
            });
        };

        if (currentPaper.sections) {
            currentPaper.sections.forEach((section, idx) => {
                // Section label (only if non-empty)
                if (section.label && section.label.trim().length > 0) {
                    html += `
                        <div class="mt-4 mb-2 first:mt-0 px-2 text-xs font-bold text-secondary uppercase tracking-wider select-none">
                            ${section.label}
                        </div>
                    `;
                }
                processNodes(section.questions);
                // Spacer between sections
                if (idx < currentPaper.sections.length - 1) {
                    html += `<div class="h-2"></div>`;
                }
            });
        } else if (currentPaper.questions) {
            processNodes(currentPaper.questions);
        }

        return html;
    }

    function renderMobileDrawer(currentPaper) {
        if (!state.mobileNavOpen) return '';
        return `
            <div class="fixed inset-0 z-50 flex justify-end" role="dialog" aria-modal="true">
                <!-- Backdrop -->
                <div class="absolute inset-0 bg-black/20 backdrop-blur-sm transition-opacity" onclick="toggleMobileNav()"></div>
                
                <!-- Drawer -->
                <div class="relative w-64 h-full bg-paper shadow-xl flex flex-col transition-transform animate-in slide-in-from-right">
                    <div class="flex items-center justify-between p-4 border-b border-hairline">
                        <h2 class="text-sm font-bold text-primary">Jump to</h2>
                        <button onclick="toggleMobileNav()" class="text-secondary hover:text-primary p-1 focus-visible-ring">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                        </button>
                    </div>
                    <div class="flex-1 overflow-y-auto p-2">
                        ${renderNavList(currentPaper, true)}
                    </div>
                </div>
            </div>
        `;
    }

    function renderSolutionDetails(node) {
        if (!node.solutionBlock || !node.solutionBlock.solutionDetails) return '';

        const isExpanded = state.expandedDetails[node.id];
        const details = node.solutionBlock.solutionDetails;
        const btnText = isExpanded ? "Hide working" : "Show working";
        
        // Disclosure Control
        const toggleControl = `
            <button 
                onclick="toggleDetails('${node.id}')"
                class="inline-flex items-center text-sm font-medium text-accent hover:text-primary transition-colors focus-visible-ring mt-3 mb-2"
                aria-expanded="${isExpanded}"
            >
                <span>${btnText}</span>
                <svg class="ml-1 w-4 h-4 transform transition-transform ${isExpanded ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
            </button>
        `;

        if (!isExpanded) return toggleControl;

        // Expanded Content
        let contentHtml = '';

        // 1. Keep in mind
        if (details.keepInMind) {
            contentHtml += `
                <div class="mb-4">
                    <div class="text-xs font-bold text-secondary uppercase tracking-wide mb-1">Keep in mind</div>
                    <div class="md-content text-sm text-secondary leading-relaxed">
                        ${md.render(details.keepInMind)}
                    </div>
                </div>
                <div class="h-px w-full bg-hairline mb-4"></div>
            `;
        }

        // 2. Formulas used
        if (details.formulasUsed) {
            contentHtml += `
                <div class="mb-4">
                    <div class="text-xs font-bold text-secondary uppercase tracking-wide mb-1">Formulas used</div>
                    <div class="md-content text-sm text-secondary leading-relaxed">
                        ${md.render(details.formulasUsed)}
                    </div>
                </div>
                <div class="h-px w-full bg-hairline mb-4"></div>
            `;
        }

        // 3. Working (Primary)
        if (details.working) {
            contentHtml += `
                <div class="mb-4">
                    <div class="text-xs font-bold text-secondary uppercase tracking-wide mb-1">Working</div>
                    <div class="md-content text-base text-secondary leading-relaxed">
                        ${md.render(details.working)}
                    </div>
                </div>
            `;
        }

        // 4. Alternative working
        if (details.alternativeWorking && Array.isArray(details.alternativeWorking)) {
            details.alternativeWorking.forEach(alt => {
                 contentHtml += `
                    <div class="h-px w-full bg-hairline mb-4"></div>
                    <div class="mb-4">
                        <div class="text-xs font-bold text-secondary uppercase tracking-wide mb-1">Alternative working</div>
                        <div class="md-content text-base text-secondary leading-relaxed">
                            ${md.render(alt)}
                        </div>
                    </div>
                `;
            });
        }

        return `
            ${toggleControl}
            <div class="bg-wash rounded-sm p-4 mt-2 border border-hairline/50">
                ${contentHtml}
            </div>
        `;
    }

    function renderQuestionNode(node, depth = 0) {
        // Render Question Body
        const questionBody = `
            <div class="flex items-baseline gap-3 mb-3">
                <span class="text-sm font-semibold text-secondary min-w-[2rem]">${node.id}</span>
                <div class="md-content text-lg text-primary flex-1">
                    ${md.render(node.question)}
                </div>
            </div>
        `;

        // Render Answer (if present)
        let answerBlock = '';
        if (node.solutionBlock && node.solutionBlock.answer) {
            answerBlock = `
                <div class="ml-[2rem] mb-2 pl-3 border-l-2 border-hairline">
                    <div class="text-xs font-bold text-secondary uppercase tracking-wide mb-1">Answer</div>
                    <div class="md-content text-base text-primary font-medium">
                        ${md.render(node.solutionBlock.answer)}
                    </div>
                </div>
            `;
        }

        // Render Solution Details (Toggle + Content)
        const solutionDetailsBlock = node.solutionBlock?.solutionDetails 
            ? `<div class="ml-[2rem] pl-3">${renderSolutionDetails(node)}</div>` 
            : '';

        // Recursively render children
        let childrenHtml = '';
        if (node.children && node.children.length > 0) {
            childrenHtml = `
                <div class="mt-6 ml-4 md:ml-8 border-l border-hairline/50 pl-4 md:pl-6">
                    ${node.children.map(child => renderQuestionNode(child, depth + 1)).join('')}
                </div>
            `;
        }

        // Question Node Container
        // Top-level spacing vs nested spacing logic handled by margin classes
        const spacingClass = depth === 0 ? 'mb-12 border-b border-hairline pb-8 last:border-0' : 'mb-8';

        return `
            <div id="q-${node.id}" class="${spacingClass} relative">
                ${questionBody}
                ${answerBlock}
                ${solutionDetailsBlock}
                ${childrenHtml}
            </div>
        `;
    }

    function renderPaperContent(currentPaper) {
        if (!currentPaper) return '';
        let html = '<div class="bg-paper shadow-sm rounded-lg border border-hairline p-6 md:p-12 min-h-[500px]">';

        const processNodes = (nodes) => nodes.map(n => renderQuestionNode(n)).join('');

        if (currentPaper.sections) {
            currentPaper.sections.forEach(section => {
                if (section.label && section.label.trim().length > 0) {
                    html += `
                        <div class="mb-8 mt-12 first:mt-0">
                            <h2 class="text-xl font-bold text-primary border-b border-hairline pb-2 mb-8">${section.label}</h2>
                            ${processNodes(section.questions)}
                        </div>
                    `;
                } else {
                    html += processNodes(section.questions);
                }
            });
        } else if (currentPaper.questions) {
            html += processNodes(currentPaper.questions);
        }

        html += '</div>';
        return html;
    }

    function render() {
        const app = document.getElementById('app');
        
        if (state.error) {
            app.innerHTML = `
                <div class="flex items-center justify-center min-h-[50vh] text-secondary font-medium">
                    PAPERS PAYLOAD MISSING
                </div>
            `;
            return;
        }

        if (state.loading) {
            app.innerHTML = `
                <div class="flex items-center justify-center min-h-[50vh] text-secondary">
                    Loading paper...
                </div>
            `;
            return;
        }

        const currentPaper = state.papers.find(p => p.key === state.currentPaperId);
        if (!currentPaper) return;

        // DocumentFrameShell (Desktop: Two Columns. Mobile: Stacked)
        // Backgrounds handled by body/shell variables.
        
        app.innerHTML = `
            ${renderPaperSelector()}
            ${renderMobileDrawer(currentPaper)}

            <div class="w-full max-w-5xl mx-auto md:grid md:grid-cols-[240px_1fr] md:gap-8 bg-frame rounded-xl p-0 md:p-4 md:items-start">
                
                <!-- Desktop Navigation Rail (Sticky) -->
                <aside class="hidden md:block sticky-nav pr-4 no-scrollbar">
                    <nav class="space-y-1">
                        ${renderNavList(currentPaper)}
                    </nav>
                </aside>

                <!-- Paper Content Area -->
                <main class="min-w-0">
                    ${renderPaperContent(currentPaper)}
                </main>
            </div>
        `;
    }

    // ===== INIT =====
    init();

</script>
</body>
</html>
