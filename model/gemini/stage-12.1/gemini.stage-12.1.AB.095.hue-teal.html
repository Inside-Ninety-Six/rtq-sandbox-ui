<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AB","indexWithinVariant":"95","totalWithinVariant":"200","hueFamily":"teal","intensityMode":"","timestamp":"2026-01-07T01:00:07.805Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AB&quot;,&quot;indexWithinVariant&quot;:&quot;95&quot;,&quot;totalWithinVariant&quot;:&quot;200&quot;,&quot;hueFamily&quot;:&quot;teal&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-07T01:00:07.805Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>

    <!-- 
        STAGE 6 ADD-ON: Real KaTeX Rendering + Markdown Support 
        SRI Disabled per Stage 6.0.7b
    -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <style>
        /* 
           STAGE 0 & 5: VISUAL FOUNDATION 
           Soft-warm neutral base. Grayscale/Paper-like. 
        */
        :root {
            /* Palette: Stone / Warm Neutral */
            --bg-app: #FAFAF9; /* warm-gray-50 */
            --bg-paper: #FFFFFF;
            --bg-surface-subtle: #F5F5F4; /* warm-gray-100 */
            
            --fg-primary: #1C1917; /* warm-gray-900 - Question Text */
            --fg-secondary: #44403C; /* warm-gray-700 - Answer */
            --fg-tertiary: #57534E; /* warm-gray-600 - Metadata/Nav */
            --fg-quaternary: #78716C; /* warm-gray-500 - Borders/Dividers */

            --border-hairline: #E7E5E4; /* warm-gray-200 */
            
            --accent-interaction: #0F172A; /* Slate-900 (High contrast neutral accent) */
            --focus-ring: #0EA5E9; /* Sky-500 (Accessibility focus) */

            /* Spacing */
            --space-xs: 0.25rem;
            --space-sm: 0.5rem;
            --space-md: 1rem;
            --space-lg: 1.5rem;
            --space-xl: 2.5rem;
            --space-xxl: 4rem;

            /* Typography */
            --font-base: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --font-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
        }

        * {
            box-sizing: border-box;
        }

        html, body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-app);
            color: var(--fg-primary);
            font-family: var(--font-base);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            height: 100%;
        }

        /* UTILITIES */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .font-bold { font-weight: 600; }
        .text-sm { font-size: 0.875rem; }
        .text-xs { font-size: 0.75rem; }
        
        /* LAYOUT SHELL (Stage 3) */
        .shell {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* TOP CONTROLS */
        .top-controls {
            padding: var(--space-md);
            border-bottom: 1px solid var(--border-hairline);
            background: var(--bg-app);
            position: sticky;
            top: 0;
            z-index: 20;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 60px;
        }

        select.paper-selector {
            font-family: var(--font-base);
            font-size: 0.875rem;
            padding: var(--space-xs) var(--space-sm);
            border: 1px solid var(--border-hairline);
            border-radius: 4px;
            background: var(--bg-paper);
            color: var(--fg-primary);
        }

        .mobile-jump-trigger {
            display: none; /* Desktop default */
            background: none;
            border: 1px solid var(--border-hairline);
            padding: var(--space-xs) var(--space-sm);
            border-radius: 4px;
            font-size: 0.875rem;
            color: var(--fg-secondary);
            cursor: pointer;
        }

        /* MAIN CONTENT AREA */
        .content-frame {
            display: flex;
            flex: 1;
            overflow: hidden; /* Prevent body scroll */
        }

        /* NAVIGATION RAIL (Desktop) */
        .nav-rail {
            width: 240px;
            padding: var(--space-lg) var(--space-md);
            border-right: 1px solid transparent; /* Stage 3: Quiet boundary */
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            /* Scrollbar hiding */
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .nav-rail::-webkit-scrollbar { display: none; }

        .nav-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .nav-section-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--fg-quaternary);
            margin-top: var(--space-md);
            margin-bottom: var(--space-sm);
            font-weight: 600;
            pointer-events: none;
        }

        .nav-item {
            display: block;
            padding: var(--space-xs) 0;
            color: var(--fg-tertiary);
            text-decoration: none;
            font-size: 0.875rem;
            border-left: 2px solid transparent;
            padding-left: var(--space-sm);
            margin-left: -2px; /* Pull border to edge */
            transition: color 0.1s, border-color 0.1s;
        }

        .nav-item:hover {
            color: var(--fg-primary);
        }

        .nav-item.active {
            color: var(--fg-primary);
            font-weight: 600;
            border-left-color: var(--fg-primary); /* Weight-only/subtle marker per Stage 6 */
        }

        /* Sub-question hierarchy via type scale (Stage 5.4.5) */
        .nav-item[data-depth="0"] { font-size: 0.9rem; }
        .nav-item[data-depth="1"] { font-size: 0.85rem; }
        .nav-item[data-depth="2"] { font-size: 0.8rem; }

        /* PAPER REGION */
        .paper-region {
            flex: 1;
            overflow-y: auto; /* Single continuous scroll */
            padding: var(--space-xl) var(--space-xl) var(--space-xxl);
            scroll-behavior: smooth;
        }

        .paper-container {
            max-width: 720px; /* Readable line length */
            margin: 0 auto;
        }

        /* SECTION HEADERS IN PAPER */
        .paper-section-header {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--fg-primary);
            border-bottom: 1px solid var(--border-hairline);
            padding-bottom: var(--space-sm);
            margin-top: var(--space-xl);
            margin-bottom: var(--space-lg);
        }

        /* QUESTION NODE */
        .question-node {
            margin-bottom: var(--space-xxl); /* Top level spacing */
            position: relative;
        }

        /* Nesting Spacing */
        .question-node .children-container {
            margin-top: var(--space-md);
            padding-left: var(--space-md); /* Indentation for children */
            border-left: 1px solid transparent; /* Structure placeholder */
        }
        
        /* Sub-question separation */
        .question-node .question-node {
            margin-bottom: var(--space-lg); /* Tighter than top level */
        }

        /* CONTENT ELEMENTS */
        .q-identifier {
            font-weight: 600;
            color: var(--fg-secondary);
            margin-right: var(--space-xs);
            float: left; /* Run-in with prompt */
        }

        .q-prompt {
            color: var(--fg-primary);
            /* KaTeX integration */
            display: inline;
        }

        .q-body {
            margin-bottom: var(--space-md);
        }

        /* SOLUTION BLOCK */
        .solution-block {
            margin-top: var(--space-md);
            padding-left: 0; 
        }

        /* ANSWER */
        .answer-region {
            margin-bottom: var(--space-md);
        }
        .answer-label {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--fg-tertiary);
            display: block;
            margin-bottom: var(--space-xs);
        }
        .answer-content {
            font-size: 1rem;
            color: var(--fg-secondary);
        }

        /* SOLUTION DETAILS TOGGLE */
        .sd-toggle {
            background: none;
            border: none;
            padding: 0;
            font-family: var(--font-base);
            font-size: 0.875rem;
            color: var(--fg-tertiary); /* Subordinate to Answer */
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }
        .sd-toggle:hover {
            color: var(--accent-interaction);
            text-decoration: underline;
        }
        .sd-toggle:focus-visible {
            outline: 2px solid var(--focus-ring);
            outline-offset: 2px;
            border-radius: 2px;
        }
        .chevron {
            transition: transform 0.2s ease;
        }
        .sd-toggle[aria-expanded="true"] .chevron {
            transform: rotate(180deg);
        }

        /* SOLUTION DETAILS CONTENT */
        .sd-content {
            display: none; /* Hidden by default */
            margin-top: var(--space-md);
            padding-top: var(--space-md);
            border-top: 1px solid var(--border-hairline); /* Quiet boundary */
        }
        .sd-content.expanded {
            display: block;
            animation: reveal 0.2s ease-out;
        }

        @keyframes reveal {
            from { opacity: 0; transform: translateY(-4px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* SD SUBSECTIONS */
        .sd-subsection {
            margin-bottom: var(--space-lg);
        }
        .sd-label {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--fg-tertiary);
            margin-bottom: var(--space-xs);
            display: block;
        }

        .keep-in-mind .sd-label { color: var(--fg-secondary); } /* Slightly higher prom */

        .sd-body {
            font-size: 0.95rem;
            color: var(--fg-secondary);
        }
        
        .sd-body ul {
            padding-left: var(--space-lg);
            margin: var(--space-sm) 0;
        }

        /* WORKING Internal Grammar */
        .working-phase {
            margin-bottom: var(--space-md);
        }

        /* Alternative Working */
        .alt-working-divider {
            height: 1px;
            background: var(--border-hairline);
            margin: var(--space-lg) 0;
        }

        /* MATHS / KATEX */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            padding: var(--space-sm) 0;
            margin: var(--space-sm) 0;
        }
        /* Block math underlay permitted by Stage 3/5 */
        .katex-display > .katex {
            background: var(--bg-surface-subtle);
            padding: var(--space-xs) var(--space-sm);
            border-radius: 4px;
            display: inline-block;
            min-width: 100%;
            box-sizing: border-box;
        }
        /* Inline math - transparent */
        .katex { font-size: 1.1em; }

        /* MARKDOWN TABLES */
        table {
            border-collapse: collapse;
            width: 100%;
            margin: var(--space-md) 0;
            font-size: 0.9rem;
        }
        th, td {
            border: 1px solid var(--border-hairline);
            padding: var(--space-sm);
            text-align: left;
        }
        th { font-weight: 600; background: var(--bg-surface-subtle); }

        /* MOBILE DRAWER */
        .drawer-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.2);
            z-index: 40;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }
        .drawer {
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            width: 280px;
            background: var(--bg-app);
            z-index: 50;
            transform: translateX(-100%);
            transition: transform 0.25s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 8px rgba(0,0,0,0.05);
        }
        .drawer-header {
            padding: var(--space-md);
            border-bottom: 1px solid var(--border-hairline);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .drawer-content {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-md);
        }

        /* Drawer Active State */
        body.drawer-open .drawer-backdrop { opacity: 1; pointer-events: auto; }
        body.drawer-open .drawer { transform: translateX(0); }

        /* MESSAGE OVERLAY (For Errors/Loading) */
        .status-message {
            padding: var(--space-xl);
            text-align: center;
            color: var(--fg-secondary);
            font-weight: 500;
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .nav-rail { display: none; }
            .mobile-jump-trigger { display: block; }
            .paper-region { padding: var(--space-md); }
            .question-node { margin-bottom: var(--space-xl); }
        }

    </style>
</head>
<body>

<div id="app" class="shell">
    <!-- Rendered via JS -->
</div>

<!-- TEMPLATES -->
<!-- Using JS to construct DOM, but structure is predefined -->

<script>
/**
 * STAGE 0: CONSTANTS
 */
const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

/**
 * MARKDOWN SETUP (Stage 6 Add-on)
 */
const md = window.markdownit ? window.markdownit({
    html: true, // allow inline SVG
    linkify: true,
    breaks: false, // MUST stay false per Stage 6
}) : null;

if (md) {
    // Preserve TeX backslashes
    md.inline.ruler.disable(['escape']);
}

/**
 * STATE
 */
let state = {
    papers: [],
    activePaper: null,
    expanded: new Set(), // Set of question IDs
    loading: true,
    error: null
};

/**
 * INITIALIZATION
 */
async function init() {
    try {
        const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
        if (!response.ok) throw new Error('Fetch failed');
        const payload = await response.json();
        
        state.papers = payload.papers || [];
        
        if (state.papers.length > 0) {
            loadPaper(state.papers[0].key);
        } else {
            state.loading = false;
            render();
        }
    } catch (e) {
        state.error = "PAPERS PAYLOAD MISSING"; // Deterministic Failure Mode
        state.loading = false;
        render();
    }
}

/**
 * LOGIC
 */
function loadPaper(key) {
    const paper = state.papers.find(p => p.key === key);
    if (!paper) return;

    state.activePaper = paper;
    state.expanded.clear();
    
    // Handle Defaults
    const defaultExpanded = paper.defaults?.expandedAll !== false; // Default true unless false
    
    // Recursively set expanded state based on existence of solutionDetails
    function traverse(nodes) {
        nodes.forEach(node => {
            if (node.solutionBlock?.solutionDetails) {
                if (defaultExpanded) {
                    state.expanded.add(node.id);
                }
            }
            if (node.children) traverse(node.children);
        });
    }

    if (paper.questions) traverse(paper.questions);
    if (paper.sections) {
        paper.sections.forEach(sec => traverse(sec.questions));
    }

    state.loading = false;
    render();
}

function toggleDetails(qId) {
    if (state.expanded.has(qId)) {
        state.expanded.delete(qId);
    } else {
        state.expanded.add(qId);
    }
    // Update DOM only for the specific node to preserve scroll
    const content = document.getElementById(`sd-content-${qId}`);
    const btnText = document.getElementById(`sd-btn-text-${qId}`);
    const btnChevron = document.getElementById(`sd-chevron-${qId}`);
    const toggleBtn = document.getElementById(`sd-toggle-${qId}`);
    
    if (content && toggleBtn) {
        const isExpanded = state.expanded.has(qId);
        if (isExpanded) {
            content.classList.add('expanded');
            btnText.textContent = "Hide working";
            toggleBtn.setAttribute('aria-expanded', 'true');
        } else {
            content.classList.remove('expanded');
            btnText.textContent = "Show working";
            toggleBtn.setAttribute('aria-expanded', 'false');
        }
    }
}

function jumpTo(qId) {
    const el = document.getElementById(`q-${qId}`);
    if (el) {
        el.scrollIntoView({ behavior: 'smooth', block: 'start' });
        closeDrawer();
    }
}

function toggleDrawer() {
    document.body.classList.toggle('drawer-open');
}

function closeDrawer() {
    document.body.classList.remove('drawer-open');
}

/**
 * RENDERING
 */
function render() {
    const app = document.getElementById('app');
    app.innerHTML = '';

    if (state.error) {
        app.innerHTML = `<div class="status-message">${state.error}</div>`;
        return;
    }

    if (state.loading) {
        app.innerHTML = `<div class="status-message">Loading...</div>`;
        return;
    }

    // SHELL STRUCTURE
    const topControls = renderTopControls();
    const frame = document.createElement('div');
    frame.className = 'content-frame';

    const navRail = renderNavRail();
    const paperRegion = renderPaperRegion();
    
    // Mobile Drawer
    const drawer = renderDrawer();

    frame.appendChild(navRail);
    frame.appendChild(paperRegion);
    
    app.appendChild(topControls);
    app.appendChild(frame);
    document.body.appendChild(drawer); // Append to body for fixed positioning

    // KaTeX Auto-Render
    if (window.renderMathInElement) {
        window.renderMathInElement(document.body, {
            delimiters: [
                {left: "$$", right: "$$", display: true},
                {left: "$", right: "$", display: false}
            ],
            throwOnError: false
        });
    }
    
    // Intersection Observer for Nav
    setupObserver();
}

function renderTopControls() {
    const div = document.createElement('div');
    div.className = 'top-controls';

    // Paper Selector
    const select = document.createElement('select');
    select.className = 'paper-selector';
    state.papers.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.key;
        opt.textContent = p.label || p.key;
        opt.selected = p.key === state.activePaper.key;
        select.appendChild(opt);
    });
    select.addEventListener('change', (e) => loadPaper(e.target.value));

    // Mobile Jump Trigger
    const jumpBtn = document.createElement('button');
    jumpBtn.className = 'mobile-jump-trigger';
    jumpBtn.textContent = 'Jump to';
    jumpBtn.onclick = toggleDrawer;

    div.appendChild(select);
    div.appendChild(jumpBtn);
    return div;
}

function renderNavRail() {
    const aside = document.createElement('aside');
    aside.className = 'nav-rail';
    aside.appendChild(renderNavList());
    return aside;
}

function renderDrawer() {
    // Remove existing if re-rendering
    const existing = document.querySelector('.drawer-wrapper');
    if (existing) existing.remove();

    const wrapper = document.createElement('div');
    wrapper.className = 'drawer-wrapper';

    const backdrop = document.createElement('div');
    backdrop.className = 'drawer-backdrop';
    backdrop.onclick = closeDrawer;

    const drawer = document.createElement('div');
    drawer.className = 'drawer';
    
    const header = document.createElement('div');
    header.className = 'drawer-header';
    header.innerHTML = '<span class="font-bold">Jump to</span>';
    const closeBtn = document.createElement('button');
    closeBtn.textContent = 'âœ•';
    closeBtn.style.background = 'none';
    closeBtn.style.border = 'none';
    closeBtn.style.fontSize = '1.2rem';
    closeBtn.style.cursor = 'pointer';
    closeBtn.onclick = closeDrawer;
    header.appendChild(closeBtn);

    const content = document.createElement('div');
    content.className = 'drawer-content';
    content.appendChild(renderNavList());

    drawer.appendChild(header);
    drawer.appendChild(content);
    wrapper.appendChild(backdrop);
    wrapper.appendChild(drawer);

    return wrapper;
}

function renderNavList() {
    const nav = document.createElement('nav');
    nav.className = 'nav-list';

    const paper = state.activePaper;

    if (paper.sections) {
        paper.sections.forEach(sec => {
            if (sec.label && sec.label.trim() !== '') {
                const label = document.createElement('div');
                label.className = 'nav-section-label';
                label.textContent = sec.label;
                nav.appendChild(label);
            }
            sec.questions.forEach(q => appendNavItems(nav, q, 0));
        });
    } else if (paper.questions) {
        paper.questions.forEach(q => appendNavItems(nav, q, 0));
    }

    return nav;
}

function appendNavItems(container, node, depth) {
    const a = document.createElement('a');
    a.href = `#q-${node.id}`;
    a.className = 'nav-item';
    a.dataset.depth = depth;
    a.dataset.target = `q-${node.id}`;
    a.textContent = node.id;
    a.onclick = (e) => {
        e.preventDefault();
        jumpTo(node.id);
    };
    container.appendChild(a);

    if (node.children) {
        node.children.forEach(child => appendNavItems(container, child, depth + 1));
    }
}

function renderPaperRegion() {
    const main = document.createElement('main');
    main.className = 'paper-region';
    
    const container = document.createElement('div');
    container.className = 'paper-container';

    const paper = state.activePaper;

    if (paper.sections) {
        paper.sections.forEach(sec => {
            if (sec.label && sec.label.trim() !== '') {
                const header = document.createElement('div');
                header.className = 'paper-section-header';
                header.textContent = sec.label;
                container.appendChild(header);
            }
            sec.questions.forEach(q => container.appendChild(renderQuestionNode(q)));
        });
    } else if (paper.questions) {
        paper.questions.forEach(q => container.appendChild(renderQuestionNode(q)));
    }

    main.appendChild(container);
    return main;
}

function renderQuestionNode(node) {
    const wrapper = document.createElement('div');
    wrapper.className = 'question-node';
    wrapper.id = `q-${node.id}`; // Anchor for nav

    // 1. Question Body
    const qBody = document.createElement('div');
    qBody.className = 'q-body';
    
    const idSpan = document.createElement('span');
    idSpan.className = 'q-identifier';
    idSpan.textContent = node.id; // Just ID, no dot/prefix

    const promptSpan = document.createElement('div');
    promptSpan.className = 'q-prompt';
    promptSpan.innerHTML = md ? md.render(node.question) : node.question;

    qBody.appendChild(idSpan);
    qBody.appendChild(promptSpan);
    wrapper.appendChild(qBody);

    // 2. Solution Block (Optional)
    if (node.solutionBlock) {
        const sb = document.createElement('div');
        sb.className = 'solution-block';

        // Answer (Optional)
        if (node.solutionBlock.answer) {
            const ansRegion = document.createElement('div');
            ansRegion.className = 'answer-region';
            
            const ansLabel = document.createElement('span');
            ansLabel.className = 'answer-label';
            ansLabel.textContent = 'Answer';
            
            const ansContent = document.createElement('div');
            ansContent.className = 'answer-content';
            ansContent.innerHTML = md ? md.render(node.solutionBlock.answer) : node.solutionBlock.answer;

            ansRegion.appendChild(ansLabel);
            ansRegion.appendChild(ansContent);
            sb.appendChild(ansRegion);
        }

        // Solution Details (Optional)
        if (node.solutionBlock.solutionDetails) {
            const sd = node.solutionBlock.solutionDetails;
            const isExpanded = state.expanded.has(node.id);

            // Toggle Control
            const toggle = document.createElement('button');
            toggle.id = `sd-toggle-${node.id}`;
            toggle.className = 'sd-toggle';
            toggle.setAttribute('aria-expanded', isExpanded);
            toggle.onclick = () => toggleDetails(node.id);

            const btnText = document.createElement('span');
            btnText.id = `sd-btn-text-${node.id}`;
            btnText.textContent = isExpanded ? 'Hide working' : 'Show working';
            
            const chevron = document.createElement('span');
            chevron.id = `sd-chevron-${node.id}`;
            chevron.className = 'chevron';
            chevron.innerHTML = `<svg width="10" height="6" viewBox="0 0 10 6" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M1 1L5 5L9 1"/></svg>`;

            toggle.appendChild(btnText);
            toggle.appendChild(chevron);
            sb.appendChild(toggle);

            // Expandable Content
            const content = document.createElement('div');
            content.id = `sd-content-${node.id}`;
            content.className = `sd-content ${isExpanded ? 'expanded' : ''}`;

            // Keep in mind
            if (sd.keepInMind) {
                const sub = document.createElement('div');
                sub.className = 'sd-subsection keep-in-mind';
                sub.innerHTML = `<span class="sd-label">Keep in mind</span><div class="sd-body">${md ? md.render(sd.keepInMind) : sd.keepInMind}</div>`;
                content.appendChild(sub);
            }

            // Formulas used
            if (sd.formulasUsed) {
                const sub = document.createElement('div');
                sub.className = 'sd-subsection';
                sub.innerHTML = `<span class="sd-label">Formulas used</span><div class="sd-body">${md ? md.render(sd.formulasUsed) : sd.formulasUsed}</div>`;
                content.appendChild(sub);
            }

            // Working
            if (sd.working) {
                const sub = document.createElement('div');
                sub.className = 'sd-subsection';
                sub.innerHTML = `<span class="sd-label">Working</span><div class="sd-body">${md ? md.render(sd.working) : sd.working}</div>`;
                content.appendChild(sub);
            }

            // Alternative Working (Array)
            if (sd.alternativeWorking && Array.isArray(sd.alternativeWorking)) {
                sd.alternativeWorking.forEach((alt, idx) => {
                    const sub = document.createElement('div');
                    sub.className = 'sd-subsection';
                    // Visual separator if following Working
                    if (idx === 0 && sd.working) {
                        const div = document.createElement('div');
                        div.className = 'alt-working-divider';
                        content.appendChild(div);
                    } else if (idx > 0) {
                        const div = document.createElement('div');
                        div.className = 'alt-working-divider';
                        content.appendChild(div);
                    }
                    sub.innerHTML = `<span class="sd-label">Alternative working</span><div class="sd-body">${md ? md.render(alt) : alt}</div>`;
                    content.appendChild(sub);
                });
            }

            sb.appendChild(content);
        }

        wrapper.appendChild(sb);
    }

    // 3. Children
    if (node.children && node.children.length > 0) {
        const childContainer = document.createElement('div');
        childContainer.className = 'children-container';
        node.children.forEach(child => {
            childContainer.appendChild(renderQuestionNode(child));
        });
        wrapper.appendChild(childContainer);
    }

    return wrapper;
}

function setupObserver() {
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                // Remove active from all
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                // Add to current
                const id = entry.target.id;
                document.querySelectorAll(`.nav-item[data-target="${id}"]`).forEach(el => el.classList.add('active'));
            }
        });
    }, { root: document.querySelector('.paper-region'), threshold: 0.1, rootMargin: "-40% 0px -60% 0px" });

    document.querySelectorAll('.question-node').forEach(node => observer.observe(node));
}

// Start
window.addEventListener('DOMContentLoaded', init);

</script>
</body>
</html>
