<!DOCTYPE html>
<html lang="en">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AB","indexWithinVariant":"13","totalWithinVariant":"200","hueFamily":"amber","intensityMode":"","timestamp":"2026-01-06T20:08:53.296Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AB&quot;,&quot;indexWithinVariant&quot;:&quot;13&quot;,&quot;totalWithinVariant&quot;:&quot;200&quot;,&quot;hueFamily&quot;:&quot;amber&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-06T20:08:53.296Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>

    <!-- Fonts: Inter for modern, calm, paper-like readability -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Tailwind CSS (via CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // STAGE 6 ADD-ON: COLORLAB B - FORCED HUE FAMILY (AMBER)
        // Configuration for Amber palette in Light Mode only.
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        // Base Neutrals (Warm/Stone per Stage 5 guidance + Amber warmth)
                        gray: {
                            50: '#fafaf9',
                            100: '#f5f5f4',
                            200: '#e7e5e4',
                            300: '#d6d3d1',
                            400: '#a8a29e',
                            500: '#78716c',
                            600: '#57534e',
                            700: '#44403c',
                            800: '#292524',
                            900: '#1c1917',
                        },
                        // Forced Hue: Amber
                        brand: {
                            50: '#fffbeb',
                            100: '#fef3c7',
                            200: '#fde68a',
                            300: '#fcd34d',
                            400: '#fbbf24',
                            500: '#f59e0b',
                            600: '#d97706',
                            700: '#b45309',
                            800: '#92400e',
                            900: '#78350f',
                        }
                    }
                }
            }
        }
    </script>

    <!-- KaTeX CSS (No Integrity/SRI per Stage 6 instructions) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <!-- KaTeX JS + AutoRender -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Markdown-it -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <style>
        /* CONSTANTS & UTILITIES */
        
        /* KaTeX Containment Invariant (Locked) */
        /* Never allow page-level horizontal scroll. Horizontal scroll only within math blocks. */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            /* Subtle padding for scrollbar clearance */
            padding-bottom: 0.25rem;
            /* Scrollbar styling for math */
            scrollbar-width: thin;
            scrollbar-color: #d6d3d1 transparent;
        }
        
        /* Hide scrollbars for Navigation (Scrollable Nav Add-on) */
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* Focus Visibility (Stage 5.5.2) */
        *:focus-visible {
            outline: 2px solid #f59e0b; /* Amber-500 */
            outline-offset: 2px;
        }

        /* Typography Optimisation */
        body {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Markdown Content Styling */
        /* Lists */
        .md-content ul {
            list-style-type: disc;
            padding-left: 1.25em;
            margin-bottom: 0.5em;
        }
        .md-content ol {
            list-style-type: decimal;
            padding-left: 1.25em;
            margin-bottom: 0.5em;
        }
        .md-content p {
            margin-bottom: 0.75em;
            line-height: 1.6;
        }
        .md-content p:last-child {
            margin-bottom: 0;
        }
        
        /* Table Minimal Styling */
        .md-content table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.95em;
        }
        .md-content th, .md-content td {
            border: 1px solid #e7e5e4; /* Gray-200 */
            padding: 0.5rem;
            text-align: left;
        }
        .md-content th {
            font-weight: 600;
            color: #44403c; /* Gray-700 */
        }

        /* Transition Continuity (Stage 5.5.3) */
        .smooth-transition {
            transition-property: all;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 200ms;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 selection:bg-brand-100 selection:text-brand-900">

    <!-- DocumentFrameShell (Desktop: Centered, max-width) -->
    <div id="app-shell" class="min-h-screen flex flex-col items-center">
        
        <!-- Top Controls Region -->
        <!-- Aligned to shell width -->
        <header class="w-full max-w-6xl px-4 py-4 md:py-6 flex justify-between items-center z-20">
            <!-- Paper Selector -->
            <div class="relative group">
                <label for="paper-selector" class="sr-only">Select Paper</label>
                <select id="paper-selector" 
                    class="appearance-none bg-white border border-gray-300 text-gray-700 py-2 pl-3 pr-8 rounded-md shadow-sm text-sm font-medium hover:border-brand-400 focus:border-brand-500 focus:ring-1 focus:ring-brand-500 cursor-pointer smooth-transition">
                    <option disabled selected>Loading papers...</option>
                </select>
                <!-- Custom Chevron -->
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </div>
            </div>

            <!-- Mobile: Jump To Trigger -->
            <button id="mobile-jump-trigger" class="md:hidden text-sm font-medium text-brand-700 hover:text-brand-800 flex items-center gap-1 px-2 py-1 rounded hover:bg-brand-50 smooth-transition">
                <span>Jump to</span>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
            </button>
        </header>

        <!-- Main Content Area: Two Columns on Desktop -->
        <div class="w-full max-w-6xl flex-grow flex flex-row items-start relative">
            
            <!-- Navigation Rail (Desktop) -->
            <!-- Sticky, Scrollable independently if needed, Hidden scrollbars -->
            <nav id="desktop-nav" class="hidden md:block w-48 lg:w-64 flex-shrink-0 sticky top-4 max-h-[calc(100vh-2rem)] overflow-y-auto no-scrollbar pr-6 pb-12">
                <div id="nav-content" class="flex flex-col gap-1">
                    <!-- Generated via JS -->
                </div>
            </nav>

            <!-- Paper Document Column -->
            <main id="paper-region" class="flex-grow w-full px-4 pb-20 md:pl-8 md:pr-0">
                <!-- Paper Surface -->
                <div id="paper-content" class="bg-white rounded-none md:rounded-lg shadow-sm md:shadow ring-1 ring-gray-200 min-h-[50vh] p-6 md:p-10 lg:p-12">
                    <!-- Content Generated via JS -->
                    <div class="text-gray-400 italic text-center py-20">Initializing...</div>
                </div>
            </main>

        </div>
    </div>

    <!-- Mobile Navigation Drawer -->
    <div id="mobile-drawer-backdrop" class="fixed inset-0 bg-gray-900/20 backdrop-blur-sm z-40 hidden transition-opacity opacity-0" aria-hidden="true"></div>
    <div id="mobile-drawer" class="fixed inset-y-0 right-0 w-64 bg-white shadow-xl transform translate-x-full transition-transform duration-300 z-50 flex flex-col" aria-hidden="true">
        <div class="p-4 border-b border-gray-100 flex justify-between items-center">
            <h2 class="text-lg font-semibold text-gray-900">Jump to</h2>
            <button id="mobile-drawer-close" class="text-gray-500 hover:text-brand-600 p-2 rounded-md hover:bg-brand-50">
                <span class="sr-only">Close navigation</span>
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <div id="mobile-nav-content" class="flex-1 overflow-y-auto p-4 space-y-1">
            <!-- Replicated Nav Content -->
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // =================================================================
        // STAGE 0: CONSTANTS (AUTHORITATIVE)
        // =================================================================
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";
        const RTQ_COLORLAB_FORCE_HUE_FAMILY = "amber";

        // =================================================================
        // MARKDOWN-IT CONFIGURATION (STAGE 6 BASELINE)
        // =================================================================
        const md = window.markdownit ? window.markdownit({
            html: true, // Allow inline SVG
            linkify: true,
            breaks: false, // CRITICAL: Prevent <br> injection in math blocks
        }) : null;

        if (md) {
            // Disable inline escape to preserve TeX backslashes
            md.inline.ruler.disable(['escape']);
        }

        // =================================================================
        // APPLICATION STATE
        // =================================================================
        const state = {
            papers: [],
            currentPaper: null,
            expandedStates: {}, // key: questionId, value: boolean
            navSections: [] // For navigation structure
        };

        // DOM Elements
        const elSelector = document.getElementById('paper-selector');
        const elPaperContent = document.getElementById('paper-content');
        const elDesktopNav = document.getElementById('nav-content');
        const elMobileNav = document.getElementById('mobile-nav-content');
        const elMobileTrigger = document.getElementById('mobile-jump-trigger');
        const elMobileDrawer = document.getElementById('mobile-drawer');
        const elMobileBackdrop = document.getElementById('mobile-drawer-backdrop');
        const elMobileClose = document.getElementById('mobile-drawer-close');

        // =================================================================
        // INITIALIZATION
        // =================================================================
        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                
                if (!data.papers || !Array.isArray(data.papers)) {
                    throw new Error('Invalid payload format');
                }

                state.papers = data.papers;
                populateSelector();
                
                // Load first paper by default
                if (state.papers.length > 0) {
                    loadPaper(state.papers[0].key);
                }
            } catch (err) {
                console.error("Payload Load Error:", err);
                renderError();
            }
        }

        function renderError() {
            elPaperContent.innerHTML = `
                <div class="flex flex-col items-center justify-center py-20 text-center">
                    <div class="text-gray-400 font-bold tracking-widest mb-2">ERROR</div>
                    <div class="text-xl font-bold text-gray-800">PAPERS PAYLOAD MISSING</div>
                    <p class="text-gray-500 mt-2 text-sm max-w-md">
                        Unable to load content from ${RTQ_PAPERS_PAYLOAD_PATH}. 
                        Please ensure the file exists and is accessible.
                    </p>
                </div>
            `;
            elSelector.innerHTML = '<option disabled>Payload Missing</option>';
        }

        function populateSelector() {
            elSelector.innerHTML = '';
            state.papers.forEach(paper => {
                const opt = document.createElement('option');
                opt.value = paper.key;
                opt.textContent = paper.label || paper.key;
                elSelector.appendChild(opt);
            });
            elSelector.addEventListener('change', (e) => loadPaper(e.target.value));
        }

        function loadPaper(paperKey) {
            const paper = state.papers.find(p => p.key === paperKey);
            if (!paper) return;

            state.currentPaper = paper;
            // Respect paper defaults for expansion
            const defaultExpanded = paper.defaults?.expandedAll !== false; // Default true unless explicitly false
            
            // Reset local state
            state.expandedStates = {}; 
            // We don't pre-fill state; we treat "undefined" as "use default" in render logic
            
            // Build Nav Structure (Flattened list of items with sections if present)
            state.navSections = buildNavStructure(paper);

            // Render
            renderPaperContent(paper, defaultExpanded);
            renderNavigation(state.navSections);

            // Math Rendering
            renderMath();
            
            // Scroll to top
            window.scrollTo(0, 0);
        }

        // =================================================================
        // CONTENT RENDERING
        // =================================================================
        function buildNavStructure(paper) {
            // Normalizes structure into: [{ type: 'section', label: 'A' }, { type: 'item', id: '1', elementId: 'q-1' } ...]
            const structure = [];
            
            const processQuestions = (qs) => {
                qs.forEach(q => {
                    structure.push({ 
                        type: 'item', 
                        id: q.id, 
                        elementId: `q-${q.id}`
                    });
                    if (q.children) processQuestions(q.children);
                });
            };

            if (paper.sections) {
                paper.sections.forEach(section => {
                    if (section.label && section.label.trim().length > 0) {
                        structure.push({ type: 'section', label: section.label });
                    }
                    if (section.questions) processQuestions(section.questions);
                });
            } else if (paper.questions) {
                processQuestions(paper.questions);
            }

            return structure;
        }

        function renderPaperContent(paper, defaultExpanded) {
            let html = '';
            
            // If sectioned
            if (paper.sections) {
                paper.sections.forEach(section => {
                    html += `<section class="mb-12">`;
                    if (section.label && section.label.trim().length > 0) {
                        html += `
                            <div class="border-b border-gray-200 pb-2 mb-8">
                                <span class="text-xl font-bold text-gray-900">${escapeHtml(section.label)}</span>
                            </div>
                        `;
                    }
                    html += `<div class="space-y-12">`; // Question List
                    section.questions.forEach(q => {
                        html += renderQuestionNode(q, defaultExpanded);
                    });
                    html += `</div>`;
                    html += `</section>`;
                });
            } else if (paper.questions) {
                html += `<div class="space-y-12">`;
                paper.questions.forEach(q => {
                    html += renderQuestionNode(q, defaultExpanded);
                });
                html += `</div>`;
            } else {
                html = `<div class="p-8 text-center text-gray-500">No questions found in payload.</div>`;
            }

            elPaperContent.innerHTML = html;
            attachToggleListeners();
        }

        function renderQuestionNode(node, defaultExpanded, depth = 0) {
            // Depth affects separation in recursive calls, though visual spacing is mainly CSS.
            // Stage 5.1: Top-level separation is largest.
            // ID for navigation anchoring
            const elementId = `q-${node.id}`;
            const hasSolutionBlock = !!node.solutionBlock;
            const hasAnswer = hasSolutionBlock && !!node.solutionBlock.answer;
            const hasSolutionDetails = hasSolutionBlock && !!node.solutionBlock.solutionDetails;
            
            const isExpanded = state.expandedStates[node.id] !== undefined ? state.expandedStates[node.id] : defaultExpanded;

            // Render Markdown content
            const questionHtml = md ? md.render(node.question || '') : node.question;

            let html = `
            <div id="${elementId}" class="question-node group scroll-mt-24">
                <!-- Question Body -->
                <div class="mb-4">
                    <div class="flex items-baseline gap-3">
                        <span class="text-gray-500 font-medium text-sm select-none flex-shrink-0">${node.id}</span>
                        <div class="text-gray-900 text-lg leading-relaxed md-content flex-grow font-medium">
                            ${questionHtml}
                        </div>
                    </div>
                </div>`;

            if (hasSolutionBlock) {
                html += `<div class="pl-0 md:pl-8 lg:pl-10 space-y-4">`; // Indent for supporting material hierarchy

                // Answer
                if (hasAnswer) {
                    const answerHtml = md ? md.render(node.solutionBlock.answer || '') : node.solutionBlock.answer;
                    html += `
                    <div class="relative">
                        <div class="flex items-baseline gap-3">
                            <span class="text-gray-700 font-bold text-sm uppercase tracking-wide flex-shrink-0 pt-1">Answer</span>
                            <div class="text-gray-900 md-content">
                                ${answerHtml}
                            </div>
                        </div>
                    </div>`;
                }

                // Solution Details Toggle & Region
                if (hasSolutionDetails) {
                    const btnLabel = isExpanded ? "Hide working" : "Show working";
                    const iconRot = isExpanded ? "rotate-180" : "rotate-0";
                    
                    html += `
                    <div class="solution-region pt-1">
                        <!-- Toggle -->
                        <button 
                            type="button"
                            data-qid="${node.id}"
                            class="toggle-btn flex items-center gap-1.5 text-brand-700 hover:text-brand-800 font-medium text-sm transition-colors focus:outline-none rounded py-1 pr-2 -ml-1 pl-1"
                            aria-expanded="${isExpanded}"
                        >
                            <span>${btnLabel}</span>
                            <svg class="w-4 h-4 transform transition-transform duration-200 ${iconRot}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>

                        <!-- Expandable Content -->
                        <div class="${isExpanded ? 'block' : 'hidden'} mt-4 space-y-6 animate-fade-in">
                            ${renderSolutionDetails(node.solutionBlock.solutionDetails)}
                        </div>
                    </div>`;
                }
                
                html += `</div>`; // End Solution Block Wrapper
            }

            // Children
            if (node.children && node.children.length > 0) {
                // Weaker separation for children
                html += `<div class="mt-6 pl-4 md:pl-8 border-l border-transparent space-y-8">`;
                node.children.forEach(child => {
                    html += renderQuestionNode(child, defaultExpanded, depth + 1);
                });
                html += `</div>`;
            }

            html += `</div>`; // End Question Node
            return html;
        }

        function renderSolutionDetails(details) {
            if (!details) return '';
            let html = '';

            // 1. Keep in mind
            if (details.keepInMind) {
                html += `
                <div class="text-sm">
                    <h4 class="font-bold text-gray-800 mb-1 flex items-center gap-2">
                        <!-- Optional Icon -->
                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Keep in mind
                    </h4>
                    <div class="text-gray-700 md-content pl-6">
                        ${md ? md.render(details.keepInMind) : details.keepInMind}
                    </div>
                </div>`;
            }

            // 2. Formulas used
            if (details.formulasUsed) {
                html += `
                <div class="text-sm">
                    <h4 class="font-bold text-gray-800 mb-1">Formulas used</h4>
                    <div class="text-gray-600 md-content">
                        ${md ? md.render(details.formulasUsed) : details.formulasUsed}
                    </div>
                </div>`;
            }

            // 3. Working (Primary)
            if (details.working) {
                html += `
                <div>
                    <h4 class="font-bold text-gray-800 text-sm mb-2">Working</h4>
                    <div class="text-gray-800 md-content space-y-4">
                        ${md ? md.render(details.working) : details.working}
                    </div>
                </div>`;
            }

            // 4. Alternative working (Array)
            if (details.alternativeWorking && Array.isArray(details.alternativeWorking)) {
                details.alternativeWorking.forEach((alt, idx) => {
                    html += `
                    <div class="pt-4 border-t border-gray-100">
                        <h4 class="font-bold text-gray-800 text-sm mb-2">Alternative working</h4>
                        <div class="text-gray-800 md-content space-y-4">
                            ${md ? md.render(alt) : alt}
                        </div>
                    </div>`;
                });
            } else if (details.alternativeWorking && typeof details.alternativeWorking === 'string') {
                // Fallback for string schema
                 html += `
                    <div class="pt-4 border-t border-gray-100">
                        <h4 class="font-bold text-gray-800 text-sm mb-2">Alternative working</h4>
                        <div class="text-gray-800 md-content space-y-4">
                            ${md ? md.render(details.alternativeWorking) : details.alternativeWorking}
                        </div>
                    </div>`;
            }

            return html;
        }

        // =================================================================
        // NAVIGATION RENDERING
        // =================================================================
        function renderNavigation(structure) {
            const generateNavHtml = () => {
                let html = '';
                structure.forEach(item => {
                    if (item.type === 'section') {
                        html += `
                            <div class="pt-4 pb-2 text-xs font-bold text-gray-400 uppercase tracking-wider select-none">
                                ${escapeHtml(item.label)}
                            </div>
                        `;
                    } else {
                        // Hierarchy via type scale is handled by rendering. 
                        // Flat list: all aligned left.
                        // We assume nesting depth isn't strictly visualizing indentation in Nav per Stage 5.4.5
                        html += `
                            <a href="#${item.elementId}" 
                               class="nav-item block py-1.5 px-2 -ml-2 text-sm text-gray-500 hover:text-brand-700 hover:bg-gray-50 rounded smooth-transition border-l-2 border-transparent"
                               onclick="handleNavClick(event, '${item.elementId}')"
                            >
                                ${item.id}
                            </a>
                        `;
                    }
                });
                return html;
            }

            const html = generateNavHtml();
            elDesktopNav.innerHTML = html;
            elMobileNav.innerHTML = html;
            
            // Re-apply active state observer
            setupIntersectionObserver();
        }

        function handleNavClick(e, targetId) {
            e.preventDefault();
            const el = document.getElementById(targetId);
            if (el) {
                el.scrollIntoView({ behavior: 'smooth' });
                // If mobile, close drawer
                if (!elMobileDrawer.classList.contains('translate-x-full')) {
                    toggleMobileDrawer(false);
                }
            }
        }

        // =================================================================
        // INTERACTION LOGIC
        // =================================================================
        function attachToggleListeners() {
            document.querySelectorAll('.toggle-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const qid = btn.dataset.qid;
                    const isNowExpanded = btn.getAttribute('aria-expanded') === 'true';
                    const newState = !isNowExpanded;
                    
                    // Update State
                    state.expandedStates[qid] = newState;

                    // Update UI (Direct DOM manipulation for speed/simplicity)
                    btn.setAttribute('aria-expanded', newState);
                    const label = btn.querySelector('span');
                    const icon = btn.querySelector('svg');
                    const region = btn.nextElementSibling;

                    label.textContent = newState ? "Hide working" : "Show working";
                    if (newState) {
                        icon.classList.add('rotate-180');
                        region.classList.remove('hidden');
                        region.classList.add('block');
                        // Render Math if not already done (for dynamically revealed content if needed, 
                        // though we render all at load, KaTeX works on hidden elements usually)
                    } else {
                        icon.classList.remove('rotate-180');
                        region.classList.add('hidden');
                        region.classList.remove('block');
                    }
                });
            });
        }

        // Mobile Drawer Logic
        function toggleMobileDrawer(show) {
            if (show) {
                elMobileBackdrop.classList.remove('hidden');
                // Force reflow
                void elMobileBackdrop.offsetWidth;
                elMobileBackdrop.classList.remove('opacity-0');
                
                elMobileDrawer.classList.remove('translate-x-full');
                document.body.style.overflow = 'hidden'; // Lock body scroll
            } else {
                elMobileBackdrop.classList.add('opacity-0');
                elMobileDrawer.classList.add('translate-x-full');
                document.body.style.overflow = '';
                
                setTimeout(() => {
                    elMobileBackdrop.classList.add('hidden');
                }, 300);
            }
        }

        elMobileTrigger.addEventListener('click', () => toggleMobileDrawer(true));
        elMobileClose.addEventListener('click', () => toggleMobileDrawer(false));
        elMobileBackdrop.addEventListener('click', () => toggleMobileDrawer(false));

        // =================================================================
        // MATH RENDERING & UTILS
        // =================================================================
        function renderMath() {
            if (window.renderMathInElement) {
                renderMathInElement(document.body, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false}
                    ],
                    throwOnError: false
                });
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Active State Observer
        let observer;
        function setupIntersectionObserver() {
            if (observer) observer.disconnect();
            
            const options = {
                root: null,
                rootMargin: '-20% 0px -70% 0px', // Active zone in middle-top
                threshold: 0
            };

            observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const id = entry.target.id;
                        updateActiveNav(id);
                    }
                });
            }, options);

            document.querySelectorAll('.question-node').forEach(node => {
                observer.observe(node);
            });
        }

        function updateActiveNav(targetId) {
            // Remove active classes
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('text-brand-700', 'font-bold', 'border-brand-500', 'bg-brand-50');
                el.classList.add('text-gray-500', 'border-transparent');
            });
            
            // Add active classes
            // targetId is "q-18a", href is "#q-18a"
            const activeLinks = document.querySelectorAll(`a[href="#${targetId}"]`);
            activeLinks.forEach(link => {
                link.classList.remove('text-gray-500', 'border-transparent');
                link.classList.add('text-brand-900', 'font-bold', 'border-brand-500', 'bg-brand-50');
            });
        }

        // Run Init
        init();

    </script>
</body>
</html>
