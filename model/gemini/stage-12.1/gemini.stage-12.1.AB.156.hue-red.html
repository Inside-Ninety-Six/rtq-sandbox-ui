<!DOCTYPE html>
<html lang="en" class="antialiased">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AB","indexWithinVariant":"156","totalWithinVariant":"200","hueFamily":"red","intensityMode":"","timestamp":"2026-01-07T07:21:28.857Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AB&quot;,&quot;indexWithinVariant&quot;:&quot;156&quot;,&quot;totalWithinVariant&quot;:&quot;200&quot;,&quot;hueFamily&quot;:&quot;red&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-07T07:21:28.857Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ â€“ Maths Paper Solution Viewer</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- KaTeX CSS (No Integrity) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <!-- KaTeX JS (No Integrity) -->
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Markdown-it (No Integrity) -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <script>
        // Tailwind Configuration for ColorLab B (Red Hue Family) + Light Mode Only
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Neutrals: Stone (Warm/Paper-like)
                        neutral: {
                            50: '#fafaf9',
                            100: '#f5f5f4',
                            200: '#e7e5e4',
                            300: '#d6d3d1',
                            400: '#a8a29e',
                            500: '#78716c',
                            600: '#57534e',
                            700: '#44403c',
                            800: '#292524',
                            900: '#1c1917',
                        },
                        // Accent/Hue: Red (Forced per ColorLab B)
                        accent: {
                            50: '#fef2f2',
                            100: '#fee2e2',
                            200: '#fecaca',
                            300: '#fca5a5',
                            400: '#f87171',
                            500: '#ef4444',
                            600: '#dc2626', // Primary interactive
                            700: '#b91c1c',
                            800: '#991b1b',
                            900: '#7f1d1d',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'ui-sans-serif', 'system-ui', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        /* Base Reset & Invariants */
        body {
            background-color: #fafaf9; /* neutral-50 */
            color: #1c1917; /* neutral-900 */
            overflow-x: hidden; /* Prevent page-level horizontal scroll */
        }

        /* Focus Styles (Stage 5.5.2) - Restrained, Red-accented */
        :focus-visible {
            outline: 2px solid #dc2626; /* accent-600 */
            outline-offset: 2px;
        }

        /* KaTeX Overflow Handling (Stage 3/6 Locked) */
        .katex-display {
            overflow-x: auto !important;
            overflow-y: hidden;
            max-width: 100%;
            padding-bottom: 0.25rem;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Nav Scrollbar Hiding (Stage 6 Add-on) */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Layout Utilities */
        .layout-shell {
            max-width: 1280px;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        @media (min-width: 1024px) {
            .layout-shell {
                flex-direction: row;
            }
            .nav-rail {
                position: sticky;
                top: 0;
                height: 100vh;
                overflow-y: auto;
            }
        }

        /* Typography & Markdown Reset */
        .prose p { margin-bottom: 0.75em; }
        .prose p:last-child { margin-bottom: 0; }
        .prose ul { list-style-type: disc; padding-left: 1.25em; margin-bottom: 0.75em; }
        .prose ol { list-style-type: decimal; padding-left: 1.25em; margin-bottom: 0.75em; }
        .prose table { width: 100%; border-collapse: collapse; margin-bottom: 0.75em; font-size: 0.9em; }
        .prose th, .prose td { border: 1px solid #e7e5e4; padding: 0.5em; text-align: left; vertical-align: top; } /* neutral-200 */
        .prose th { font-weight: 600; background-color: #fafaf9; } /* neutral-50 */

        /* Inline SVG passthrough sizing */
        svg { max-width: 100%; height: auto; }

        /* ColorLab B Red Accent Classes */
        .text-accent { color: #dc2626; }
        .bg-accent { background-color: #dc2626; }
        .border-accent { border-color: #dc2626; }
        
        /* Smooth transitions (Stage 5.5.3) */
        .transition-height {
            transition-property: max-height, opacity;
            transition-duration: 300ms;
            transition-timing-function: ease-in-out;
        }
    </style>
</head>
<body>

    <!-- Stage 0: Constants Definition -->
    <script>
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";
        const RTQ_COLORLAB_FORCE_HUE_FAMILY = "red";
    </script>

    <!-- App Root -->
    <div id="app" class="bg-neutral-50 min-h-screen font-sans text-neutral-900">
        
        <!-- Mobile Header (Visible < lg) -->
        <div class="lg:hidden sticky top-0 z-40 bg-white border-b border-neutral-200 px-4 py-3 flex items-center justify-between">
            <div id="mobile-paper-selector-mount" class="flex-grow mr-4"></div>
            <button id="mobile-jump-to-btn" class="text-sm font-medium text-accent-600 hover:text-accent-800 focus:outline-none">
                Jump to
            </button>
        </div>

        <!-- DocumentFrameShell -->
        <div class="layout-shell px-4 sm:px-6 lg:px-8">
            
            <!-- Desktop Navigation Rail (Left Column) -->
            <nav class="hidden lg:block w-64 flex-shrink-0 nav-rail py-8 pr-8 no-scrollbar border-r border-transparent">
                <div class="mb-8" id="desktop-paper-selector-mount">
                    <!-- Paper Selector Mount -->
                </div>
                <div id="desktop-nav-list" class="space-y-1">
                    <!-- Nav Items Generated Here -->
                </div>
            </nav>

            <!-- Paper Content (Right Column) -->
            <main class="flex-1 min-w-0 py-8 lg:pl-12">
                <div id="paper-content-region" class="max-w-3xl mx-auto pb-32">
                    <!-- Content Generated Here -->
                    <div id="loading-state" class="text-neutral-500 text-sm animate-pulse">Loading paper...</div>
                </div>
            </main>

        </div>

        <!-- Mobile Navigation Drawer -->
        <div id="mobile-drawer" class="fixed inset-0 z-50 hidden" aria-hidden="true">
            <!-- Backdrop -->
            <div id="drawer-backdrop" class="absolute inset-0 bg-neutral-900/20 backdrop-blur-sm transition-opacity opacity-0"></div>
            
            <!-- Drawer Content -->
            <div id="drawer-panel" class="absolute right-0 top-0 bottom-0 w-80 bg-white shadow-xl transform translate-x-full transition-transform duration-300 flex flex-col">
                <div class="p-4 border-b border-neutral-200 flex items-center justify-between bg-neutral-50">
                    <h2 class="text-sm font-semibold text-neutral-900">Jump to</h2>
                    <button id="drawer-close-btn" class="text-neutral-500 hover:text-neutral-900 p-1">
                        <span class="sr-only">Close</span>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <div class="flex-1 overflow-y-auto p-4 no-scrollbar" id="mobile-nav-list">
                    <!-- Mobile Nav Items Generated Here -->
                </div>
            </div>
        </div>

    </div>

    <!-- Application Logic -->
    <script>
        // --- State Management ---
        const state = {
            papers: [],
            currentPaperId: null,
            paperData: null,
            expandedWorkings: new Set(), // Set of question IDs with expanded workings
            mobileDrawerOpen: false
        };

        // --- Markdown Setup (Stage 6 Add-on: Strict Config) ---
        const md = window.markdownit ? window.markdownit({
            html: true,       // Enable inline HTML (SVG)
            linkify: true,
            breaks: false     // MUST be false to preserve TeX
        }) : null;

        if (md) {
            md.inline.ruler.disable(['escape']); // Disable escape to preserve TeX backslashes
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            await init();
        });

        async function init() {
            try {
                // Fetch Payload from Canonical Path
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Network response was not ok");
                
                const payload = await response.json();
                
                if (!payload || !payload.papers || !Array.isArray(payload.papers)) {
                    throw new Error("Invalid payload structure");
                }

                state.papers = payload.papers;
                
                // Mount Controls
                renderPaperSelectors();
                setupMobileInteractions();

                // Select first paper by default
                if (state.papers.length > 0) {
                    selectPaper(state.papers[0].key);
                }

            } catch (error) {
                console.error("Payload Error:", error);
                renderFailureMode();
            }
        }

        // --- Core Rendering Logic ---

        function renderFailureMode() {
            const container = document.getElementById('paper-content-region');
            container.innerHTML = `
                <div class="rounded-none border border-red-200 bg-red-50 p-6 text-center">
                    <h2 class="text-lg font-bold text-red-700 mb-2">PAPERS PAYLOAD MISSING</h2>
                    <p class="text-red-600 text-sm">Unable to load content from ${RTQ_PAPERS_PAYLOAD_PATH}</p>
                </div>
            `;
            // Hide loading state
            const loading = document.getElementById('loading-state');
            if (loading) loading.remove();
        }

        function selectPaper(paperKey) {
            const paper = state.papers.find(p => p.key === paperKey);
            if (!paper) return;

            state.currentPaperId = paperKey;
            state.paperData = paper;
            state.expandedWorkings.clear(); // Reset expansions

            // Handle Paper Defaults
            const defaultExpanded = paper.defaults?.expandedAll !== false; 
            // Note: Logic allows checking individual defaults if they existed, but brief focuses on expandedAll.
            // We will handle default expansion dynamically during render, but if we needed to track state explicitly:
            // For this prototype, we'll infer "default expanded" unless explicitly toggled OFF by user, 
            // or if we prefer explicit state, we populate state.expandedWorkings now.
            // Strategy: We will treat state.expandedWorkings as a set of *toggled* states if we wanted complex logic,
            // BUT simpler is: state.expandedWorkings tracks *currently visible*.
            // Let's populate it initially based on default.
            
            // Helper to recursively find IDs of questions with solutions
            function collectSolutionIds(nodes) {
                nodes.forEach(node => {
                    if (node.solutionBlock?.solutionDetails) {
                        if (defaultExpanded) state.expandedWorkings.add(node.id);
                    }
                    if (node.children) collectSolutionIds(node.children);
                });
            }
            
            const nodes = paper.questions || (paper.sections ? paper.sections.flatMap(s => s.questions) : []);
            collectSolutionIds(nodes);

            // Update Selectors UI
            document.querySelectorAll('.paper-select').forEach(select => {
                select.value = paperKey;
            });

            // Render content
            renderPaperContent();
            renderNavigation();
            
            // Scroll to top
            window.scrollTo(0, 0);
        }

        function renderPaperSelectors() {
            const options = state.papers.map(p => `<option value="${p.key}">${p.label}</option>`).join('');
            
            const selectorHTML = `
                <label for="paper-select" class="sr-only">Select Paper</label>
                <select class="paper-select block w-full pl-3 pr-10 py-2 text-base border-neutral-300 focus:outline-none focus:ring-accent-600 focus:border-accent-600 sm:text-sm rounded-md bg-white text-neutral-900 shadow-sm transition-colors cursor-pointer hover:border-neutral-400">
                    ${options}
                </select>
            `;

            document.getElementById('desktop-paper-selector-mount').innerHTML = selectorHTML;
            document.getElementById('mobile-paper-selector-mount').innerHTML = selectorHTML;

            // Bind events
            document.querySelectorAll('.paper-select').forEach(el => {
                el.addEventListener('change', (e) => selectPaper(e.target.value));
            });
        }

        function renderPaperContent() {
            const container = document.getElementById('paper-content-region');
            container.innerHTML = ''; // Clear

            const paper = state.paperData;
            
            if (paper.sections) {
                paper.sections.forEach(section => {
                    // Render Section Header if label exists
                    if (section.label && section.label.trim().length > 0) {
                        const sectionHeader = document.createElement('div');
                        sectionHeader.className = "mb-8 pb-2 border-b border-neutral-200"; // Stage 3 Sep
                        sectionHeader.innerHTML = `<h2 class="text-xl font-bold text-neutral-900">${section.label}</h2>`;
                        container.appendChild(sectionHeader);
                    }
                    
                    // Render Questions
                    section.questions.forEach((q, idx) => {
                        const isLast = idx === section.questions.length - 1;
                        container.appendChild(renderQuestionNode(q, 0, null, isLast));
                    });
                });
            } else if (paper.questions) {
                // Flat paper
                paper.questions.forEach((q, idx) => {
                    const isLast = idx === paper.questions.length - 1;
                    container.appendChild(renderQuestionNode(q, 0, null, isLast));
                });
            }

            // Trigger KaTeX Auto-render
            if (window.renderMathInElement) {
                renderMathInElement(container, {
                    delimiters: [
                        {left: "$$", right: "$$", display: true},
                        {left: "$", right: "$", display: false}
                    ],
                    throwOnError: false
                });
            }
        }

        // Recursive Question Renderer
        function renderQuestionNode(node, depth, parentId, isLastInList) {
            const wrapper = document.createElement('div');
            
            // Layout Tree: Question Node Region
            // Stage 3: Top-level separation is largest. Children tighter.
            const isTopLevel = depth === 0;
            const topLevelSpacing = isTopLevel ? "mb-16" : "mb-6"; 
            wrapper.className = `question-node relative group ${isLastInList ? '' : topLevelSpacing}`;
            wrapper.id = `q-${node.id}`; // Anchor for navigation

            // --- Question Body ---
            const questionBody = document.createElement('div');
            questionBody.className = "mb-4";

            // Identifier
            const identClass = isTopLevel ? "text-neutral-500 font-semibold mb-1 block" : "text-neutral-500 font-medium mb-1 block text-sm";
            // Question Prompt
            // Hierarchy: Question Text > Answer > Solution
            const promptClass = "prose text-neutral-900 leading-relaxed max-w-none"; 
            
            const renderedPrompt = md ? md.render(node.question) : node.question;
            
            questionBody.innerHTML = `
                <span class="${identClass}">${node.id}</span>
                <div class="${promptClass}">${renderedPrompt}</div>
            `;
            wrapper.appendChild(questionBody);

            // --- Solution Block (Optional) ---
            if (node.solutionBlock) {
                const solutionBlock = document.createElement('div');
                solutionBlock.className = "pl-0"; // Indentation handled by rhythm, not margin-left for block

                // 1. Answer (Optional)
                if (node.solutionBlock.answer) {
                    const answerDiv = document.createElement('div');
                    answerDiv.className = "mt-4 mb-4 p-0"; 
                    const renderedAnswer = md ? md.render(node.solutionBlock.answer) : node.solutionBlock.answer;
                    
                    answerDiv.innerHTML = `
                        <div class="text-xs font-bold uppercase tracking-wider text-neutral-500 mb-1">Answer</div>
                        <div class="prose text-neutral-800 font-medium">${renderedAnswer}</div>
                    `;
                    solutionBlock.appendChild(answerDiv);
                }

                // 2. Solution Details (Optional)
                if (node.solutionBlock.solutionDetails) {
                    const details = node.solutionBlock.solutionDetails;
                    const isExpanded = state.expandedWorkings.has(node.id);
                    
                    // Disclosure Control
                    const toggleBtn = document.createElement('button');
                    // Stage 5.7: Text-first, optional icon. Subordinate to Answer. Interactive.
                    // Accent permitted for disclosure control text.
                    toggleBtn.className = "text-sm font-medium text-accent-600 hover:text-accent-800 focus:outline-none flex items-center mt-3 mb-2 transition-colors";
                    toggleBtn.setAttribute('aria-expanded', isExpanded);
                    toggleBtn.onclick = () => toggleWorking(node.id);
                    
                    const btnText = isExpanded ? "Hide working" : "Show working";
                    const chevronTransform = isExpanded ? "rotate-180" : "";
                    
                    toggleBtn.innerHTML = `
                        <span>${btnText}</span>
                        <svg class="w-4 h-4 ml-1 transform transition-transform duration-200 ${chevronTransform}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    `;
                    solutionBlock.appendChild(toggleBtn);

                    // Expandable Region
                    const region = document.createElement('div');
                    region.id = `working-${node.id}`;
                    region.className = isExpanded ? "block" : "hidden";
                    
                    // Stage 3/5: Optional subtle wash/surface for expanded region permitted.
                    // Let's use a very subtle left border or background to demarcate without framing.
                    // Stage 5.3.3: "Surface differentiation... must be quiet".
                    // Let's use a standard margin top and maybe a subtle left border to guide the eye in "Red" theme.
                    const regionInner = document.createElement('div');
                    regionInner.className = "mt-3 pt-2 border-l-2 border-neutral-200 pl-4"; // Minimal demarcation

                    // A. Keep in mind
                    if (details.keepInMind) {
                        const kim = document.createElement('div');
                        kim.className = "mb-6 text-sm text-neutral-600 bg-neutral-100/50 p-3 rounded-none border-l-2 border-accent-300"; // Stage 5.9.2: More prominent than Formulas.
                        // Wait, Stage 5.9.2 prohibits background fills generally, but allows surface differentiation if quiet.
                        // Override allows accent for affordance, but neutral surfaces.
                        // Let's stick to Typography only to be safe per Stage 5.9.1 "No rounded borders, heavy outlines...". 
                        // "No per-subsection background fills".
                        // REVERT: No background fill. Use spacing + label.
                        kim.className = "mb-6";
                        const renderedKim = md ? md.render(details.keepInMind) : details.keepInMind;
                        kim.innerHTML = `
                            <div class="font-bold text-neutral-700 text-xs uppercase tracking-wide mb-2 flex items-center">
                                <svg class="w-4 h-4 mr-1 text-neutral-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                Keep in mind
                            </div>
                            <div class="prose prose-sm text-neutral-600">${renderedKim}</div>
                        `;
                        regionInner.appendChild(kim);
                    }

                    // B. Formulas Used
                    if (details.formulasUsed) {
                        const form = document.createElement('div');
                        form.className = "mb-6";
                        const renderedForm = md ? md.render(details.formulasUsed) : details.formulasUsed;
                        form.innerHTML = `
                            <div class="font-bold text-neutral-500 text-xs uppercase tracking-wide mb-2">Formulas used</div>
                            <div class="prose prose-sm text-neutral-600">${renderedForm}</div>
                        `;
                        regionInner.appendChild(form);
                    }

                    // C. Working (Primary)
                    if (details.working) {
                        const work = document.createElement('div');
                        work.className = "mb-6";
                        const renderedWork = md ? md.render(details.working) : details.working;
                        work.innerHTML = `
                            <div class="font-bold text-neutral-500 text-xs uppercase tracking-wide mb-2">Working</div>
                            <div class="prose text-neutral-800">${renderedWork}</div>
                        `;
                        regionInner.appendChild(work);
                    }

                    // D. Alternative Working
                    if (details.alternativeWorking && Array.isArray(details.alternativeWorking)) {
                        details.alternativeWorking.forEach((alt, i) => {
                            const altBlock = document.createElement('div');
                            altBlock.className = "mt-8 pt-4 border-t border-neutral-200"; // Separation
                            const renderedAlt = md ? md.render(alt) : alt;
                            altBlock.innerHTML = `
                                <div class="font-bold text-neutral-500 text-xs uppercase tracking-wide mb-2">Alternative working</div>
                                <div class="prose text-neutral-800">${renderedAlt}</div>
                            `;
                            regionInner.appendChild(altBlock);
                        });
                    }

                    region.appendChild(regionInner);
                    solutionBlock.appendChild(region);
                }

                wrapper.appendChild(solutionBlock);
            }

            // --- Children ---
            if (node.children && node.children.length > 0) {
                const childrenContainer = document.createElement('div');
                // Stage 3: Indentation (spacing only).
                childrenContainer.className = "mt-6 pl-4 lg:pl-8 border-l border-neutral-100"; 
                
                node.children.forEach((child, cIdx) => {
                    const isLastChild = cIdx === node.children.length - 1;
                    childrenContainer.appendChild(renderQuestionNode(child, depth + 1, node.id, isLastChild));
                });
                wrapper.appendChild(childrenContainer);
            }

            return wrapper;
        }

        function toggleWorking(id) {
            if (state.expandedWorkings.has(id)) {
                state.expandedWorkings.delete(id);
            } else {
                state.expandedWorkings.add(id);
            }
            
            // Re-render ONLY the specific node's solution block would be ideal for performance,
            // but for a prototype, full re-render is safe OR DOM manipulation.
            // Let's do DOM manipulation to preserve scroll position perfectly.
            
            const btn = document.querySelector(`#q-${id} button[aria-expanded]`);
            const region = document.getElementById(`working-${id}`);
            
            if (btn && region) {
                const isExpanded = state.expandedWorkings.has(id);
                btn.setAttribute('aria-expanded', isExpanded);
                
                // Update text/icon
                const textSpan = btn.querySelector('span');
                const iconSvg = btn.querySelector('svg');
                if (textSpan) textSpan.textContent = isExpanded ? "Hide working" : "Show working";
                if (iconSvg) {
                    if (isExpanded) iconSvg.classList.add('rotate-180');
                    else iconSvg.classList.remove('rotate-180');
                }

                // Toggle visibility
                if (isExpanded) {
                    region.classList.remove('hidden');
                    region.classList.add('block');
                } else {
                    region.classList.remove('block');
                    region.classList.add('hidden');
                }
            }
        }

        // --- Navigation Rendering ---

        function renderNavigation() {
            const paper = state.paperData;
            let html = '';

            const renderItem = (id, label, depth) => {
                // Stage 5.4.5: Hierarchy via type scale only, flat list.
                // ColorLab B: Active state can use Red accent.
                // Stage 6.0.2: Active state weight-only primarily, but ColorLab allows accent marker.
                
                // For nav scrolling, we use native anchor behavior + smooth scroll JS.
                const textSize = depth === 0 ? 'text-sm' : 'text-xs';
                const textColor = depth === 0 ? 'text-neutral-600' : 'text-neutral-500';
                
                // Since we don't track "active" scroll spy in this MVP (unless added), 
                // we'll just render the links. 
                // Stage 5.4.3: Active state "one or two restrained cues".
                // We'll stick to a simple hover/focus state for now, as scroll-spy is complex logic.
                // Clicking jumps.
                
                return `
                    <a href="#q-${id}" 
                       class="group flex items-center py-1.5 ${textSize} ${textColor} hover:text-neutral-900 border-l-2 border-transparent hover:border-neutral-300 transition-colors"
                       onclick="handleNavClick(event, 'q-${id}')">
                       <span class="pl-3 group-hover:translate-x-0.5 transition-transform duration-200">${id}</span>
                    </a>
                `;
            };

            const traverse = (nodes, depth) => {
                nodes.forEach(node => {
                    html += renderItem(node.id, node.id, depth);
                    if (node.children) traverse(node.children, depth + 1);
                });
            };

            if (paper.sections) {
                paper.sections.forEach(section => {
                    // Stage 5.4.6: Section Label non-clickable, signpost.
                    if (section.label && section.label.trim().length > 0) {
                        html += `
                            <div class="mt-4 mb-2 pl-3 text-xs font-bold text-neutral-400 uppercase tracking-wider select-none">
                                ${section.label}
                            </div>
                        `;
                    }
                    traverse(section.questions, 0);
                });
            } else if (paper.questions) {
                traverse(paper.questions, 0);
            }

            document.getElementById('desktop-nav-list').innerHTML = html;
            document.getElementById('mobile-nav-list').innerHTML = html;
        }

        function handleNavClick(e, targetId) {
            e.preventDefault();
            const target = document.getElementById(targetId);
            if (target) {
                // Smooth scroll
                const headerOffset = 60; // Top controls height approx
                const elementPosition = target.getBoundingClientRect().top;
                const offsetPosition = elementPosition + window.pageYOffset - headerOffset;

                window.scrollTo({
                    top: offsetPosition,
                    behavior: "smooth"
                });

                // Update URL hash without jumping
                history.pushState(null, null, '#' + targetId);

                // Close mobile drawer if open
                if (state.mobileDrawerOpen) closeMobileDrawer();
            }
        }

        // --- Mobile Interactions ---

        function setupMobileInteractions() {
            const jumpBtn = document.getElementById('mobile-jump-to-btn');
            const closeBtn = document.getElementById('drawer-close-btn');
            const backdrop = document.getElementById('drawer-backdrop');

            jumpBtn.addEventListener('click', openMobileDrawer);
            closeBtn.addEventListener('click', closeMobileDrawer);
            backdrop.addEventListener('click', closeMobileDrawer);
        }

        function openMobileDrawer() {
            state.mobileDrawerOpen = true;
            const drawer = document.getElementById('mobile-drawer');
            const backdrop = document.getElementById('drawer-backdrop');
            const panel = document.getElementById('drawer-panel');

            drawer.classList.remove('hidden');
            // Trigger reflow
            void drawer.offsetWidth; 
            
            backdrop.classList.remove('opacity-0');
            panel.classList.remove('translate-x-full');
            
            document.body.style.overflow = 'hidden'; // Lock body scroll
        }

        function closeMobileDrawer() {
            state.mobileDrawerOpen = false;
            const drawer = document.getElementById('mobile-drawer');
            const backdrop = document.getElementById('drawer-backdrop');
            const panel = document.getElementById('drawer-panel');

            backdrop.classList.add('opacity-0');
            panel.classList.add('translate-x-full');

            setTimeout(() => {
                drawer.classList.add('hidden');
                document.body.style.overflow = ''; // Unlock body scroll
            }, 300);
        }

    </script>
</body>
</html>
