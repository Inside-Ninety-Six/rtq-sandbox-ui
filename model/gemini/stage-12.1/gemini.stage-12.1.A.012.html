<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"A","indexWithinVariant":"12","totalWithinVariant":"25","hueFamily":"","intensityMode":"","timestamp":"2026-01-06T17:55:26.590Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;A&quot;,&quot;indexWithinVariant&quot;:&quot;12&quot;,&quot;totalWithinVariant&quot;:&quot;25&quot;,&quot;hueFamily&quot;:&quot;&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-06T17:55:26.590Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        // ColorLab A: Cool, academic palette (Light Mode Only)
                        paper: {
                            base: '#f8fafc',    // Slate-50
                            surface: '#ffffff', // White
                            text: '#0f172a',    // Slate-900
                            muted: '#475569',   // Slate-600
                            subtle: '#94a3b8',  // Slate-400
                            border: '#e2e8f0',  // Slate-200
                            divider: '#f1f5f9', // Slate-100
                        },
                        accent: {
                            DEFAULT: '#2563eb', // Blue-600 (Interactive)
                            hover: '#1d4ed8',   // Blue-700
                            subtle: '#eff6ff',  // Blue-50
                            focus: '#bfdbfe',   // Blue-200 (Ring)
                        }
                    }
                }
            }
        }
    </script>

    <!-- KaTeX CSS (No Integrity/SRI per instructions) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <!-- KaTeX JS (No Integrity/SRI per instructions) -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Markdown-it (No Integrity/SRI per instructions) -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <style>
        /* Document Setup */
        html, body {
            height: 100%;
            background-color: #f8fafc; /* Match paper.base */
        }

        /* Scrollbar Hiding for Nav */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* KaTeX Containment Invariant */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            -webkit-overflow-scrolling: touch;
            padding-top: 0.2em;
            padding-bottom: 0.2em;
        }
        
        /* Inline KaTeX background invariant */
        .katex {
            background-color: transparent !important;
        }

        /* Focus Styles (ColorLab A custom) */
        :focus-visible {
            outline: 2px solid #2563eb;
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* Markdown Content Styles - Minimal/Clean */
        .markdown-body p {
            margin-bottom: 0.75em;
            line-height: 1.6;
        }
        .markdown-body p:last-child {
            margin-bottom: 0;
        }
        .markdown-body ul {
            list-style-type: disc;
            padding-left: 1.25em;
            margin-bottom: 0.75em;
        }
        .markdown-body ol {
            list-style-type: decimal;
            padding-left: 1.25em;
            margin-bottom: 0.75em;
        }
        /* Tables - Minimal Structural */
        .markdown-body table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 0.75em;
            font-size: 0.95em;
        }
        .markdown-body th, .markdown-body td {
            border: 1px solid #e2e8f0;
            padding: 0.5em 0.75em;
            text-align: left;
        }
        .markdown-body th {
            font-weight: 600;
            background-color: transparent;
        }
        
        /* Mobile Table Overflow Wrapper */
        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Smooth Fade Transitions */
        .fade-enter {
            opacity: 0;
            transform: translateY(-5px);
        }
        .fade-enter-active {
            opacity: 1;
            transform: translateY(0);
            transition: opacity 200ms ease-out, transform 200ms ease-out;
        }
    </style>
</head>
<body class="text-paper-text bg-paper-base">

    <!-- App Root -->
    <div id="app" class="min-h-screen flex flex-col">
        <!-- Initial Loading State -->
        <div class="flex items-center justify-center h-screen text-paper-muted">
            Loading Paper Content...
        </div>
    </div>

    <!-- Application Script -->
    <script>
        // ============================================================================
        // STAGE 0: CONSTANTS (AUTHORITATIVE)
        // ============================================================================
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // ============================================================================
        // STATE & CONFIG
        // ============================================================================
        
        const STATE = {
            papers: [],
            currentPaperId: null,
            currentPaperData: null,
            expandedStates: {}, // Map<questionId, boolean>
            isLoading: true,
            error: null,
            mobileNavOpen: false
        };

        // Markdown-it Instance (Authoritative Config)
        const md = window.markdownit ? window.markdownit({
            html: true,      // Allow inline SVG/HTML from payload
            linkify: true,
            breaks: false    // CRITICAL: false to prevent breaking math delimiters
        }) : null;

        if (md) {
            // Disable escape rule to preserve TeX backslashes
            md.inline.ruler.disable(['escape']);
        }

        // ============================================================================
        // DATA FETCHING & PROCESSING
        // ============================================================================

        async function init() {
            try {
                // Deterministic fetch from canonical constant
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Network response was not ok");
                
                const payload = await response.json();
                
                if (!payload || !payload.papers || !Array.isArray(payload.papers)) {
                    throw new Error("Invalid payload structure");
                }

                STATE.papers = payload.papers;
                
                // Default to first paper if available
                if (STATE.papers.length > 0) {
                    loadPaper(STATE.papers[0].key);
                } else {
                    STATE.isLoading = false;
                    renderApp();
                }

            } catch (err) {
                console.error("Failed to load papers payload:", err);
                STATE.error = "PAPERS PAYLOAD MISSING"; // Deterministic failure message
                STATE.isLoading = false;
                renderApp();
            }
        }

        function loadPaper(paperKey) {
            const paper = STATE.papers.find(p => p.key === paperKey);
            if (!paper) return;

            STATE.currentPaperId = paperKey;
            STATE.currentPaperData = paper;
            STATE.mobileNavOpen = false;
            
            // Initialize Expansion States
            // Default: expanded unless paper.defaults.expandedAll === false
            const defaultExpanded = paper.defaults?.expandedAll !== false;
            STATE.expandedStates = {};
            
            const traverse = (nodes) => {
                if (!nodes) return;
                nodes.forEach(node => {
                    // Only nodes with solutionDetails have a toggle
                    if (node.solutionBlock?.solutionDetails) {
                        STATE.expandedStates[node.id] = defaultExpanded;
                    }
                    if (node.children) traverse(node.children);
                });
            };

            if (paper.questions) traverse(paper.questions);
            if (paper.sections) {
                paper.sections.forEach(sec => traverse(sec.questions));
            }

            STATE.isLoading = false;
            renderApp();
            
            // Post-render: Scroll to top and Typeset Math
            window.scrollTo({ top: 0, behavior: 'instant' });
            requestAnimationFrame(() => {
                renderMathInElement(document.getElementById('paper-content'));
                setupIntersectionObserver();
            });
        }

        // ============================================================================
        // RENDERING (VIRTUAL DOM-LITE)
        // ============================================================================

        function renderApp() {
            const app = document.getElementById('app');
            
            if (STATE.error) {
                app.innerHTML = `
                    <div class="flex items-center justify-center min-h-screen">
                        <div class="text-xl font-semibold text-red-600 tracking-wide">
                            ${STATE.error}
                        </div>
                    </div>
                `;
                return;
            }

            if (STATE.isLoading) {
                app.innerHTML = `<div class="flex items-center justify-center h-screen text-paper-muted">Loading...</div>`;
                return;
            }

            // Shell Layout: Sticky Nav + Content
            // Stage 3 & 4 Layout Alignment
            app.innerHTML = `
                <!-- Mobile Nav Drawer -->
                ${renderMobileDrawer()}

                <!-- DocumentFrameShell -->
                <div class="max-w-7xl mx-auto w-full min-h-screen flex flex-col md:flex-row relative bg-paper-base">
                    
                    <!-- Mobile Header (Top Controls) -->
                    <div class="md:hidden sticky top-0 z-40 bg-paper-base/95 backdrop-blur border-b border-paper-border px-4 py-3 flex items-center justify-between">
                        ${renderPaperSelector('mobile')}
                        <button onclick="toggleMobileNav()" class="text-sm font-medium text-accent hover:text-accent-hover px-3 py-1.5 rounded hover:bg-accent-subtle transition-colors">
                            Jump to
                        </button>
                    </div>

                    <!-- Desktop Navigation Rail (Left Column) -->
                    <aside class="hidden md:block w-64 flex-shrink-0 relative">
                        <div class="sticky top-0 h-screen flex flex-col pt-8 pb-8 pl-4 pr-6 overflow-y-auto no-scrollbar">
                            <div class="mb-8">
                                ${renderPaperSelector('desktop')}
                            </div>
                            <nav class="flex-1" aria-label="Paper navigation">
                                ${renderNavigationList()}
                            </nav>
                        </div>
                    </aside>

                    <!-- Paper Document Column (Right Column) -->
                    <main id="paper-content" class="flex-1 min-w-0 pt-4 md:pt-8 px-4 md:px-8 pb-32">
                        ${renderPaperBody()}
                    </main>

                </div>
            `;
        }

        // --- Navigation Rendering ---

        function renderNavigationList() {
            const paper = STATE.currentPaperData;
            if (!paper) return '';

            let html = '<ul class="flex flex-col gap-1">';

            // Helper to render items
            const renderItem = (q, isSub = false) => {
                // Hierarchy via type scale/quietness, flat alignment (Stage 5.4.5)
                const baseClasses = "block text-left w-full truncate py-1 px-2 rounded-md transition-colors duration-200 outline-none focus-visible:ring-2 focus-visible:ring-accent";
                const typeScale = isSub ? "text-xs text-paper-muted font-normal" : "text-sm text-paper-muted font-medium";
                // ID for scrolling
                const targetId = `q-${q.id}`;
                
                return `
                    <li>
                        <a href="#${targetId}" 
                           id="nav-${q.id}"
                           class="${baseClasses} ${typeScale} hover:text-accent hover:bg-paper-divider data-[active=true]:text-accent data-[active=true]:font-bold data-[active=true]:bg-accent-subtle"
                           onclick="handleNavClick(event, '${targetId}')">
                            ${q.id}
                        </a>
                    </li>
                `;
            };

            const traverseNodes = (nodes, isSub = false) => {
                let output = '';
                nodes.forEach(node => {
                    output += renderItem(node, isSub);
                    if (node.children && node.children.length > 0) {
                        output += traverseNodes(node.children, true); // true = indicate deeper hierarchy via scale
                    }
                });
                return output;
            };

            if (paper.sections) {
                paper.sections.forEach((section, idx) => {
                    // Render Section Label (if non-empty)
                    if (section.label && section.label.trim().length > 0) {
                        // Spacing separator
                        const mt = idx > 0 ? 'mt-6' : 'mt-0';
                        html += `
                            <li class="${mt} mb-2 px-2 text-xs font-semibold text-paper-subtle uppercase tracking-wider select-none">
                                ${section.label}
                            </li>
                        `;
                    }
                    html += traverseNodes(section.questions);
                });
            } else if (paper.questions) {
                html += traverseNodes(paper.questions);
            }

            html += '</ul>';
            return html;
        }

        function renderMobileDrawer() {
            // Stage 6.0.6: Option A - Drawer
            const hiddenClass = STATE.mobileNavOpen ? '' : 'hidden';
            return `
                <div id="mobile-drawer-overlay" class="fixed inset-0 z-50 bg-slate-900/50 backdrop-blur-sm transition-opacity ${hiddenClass}" onclick="toggleMobileNav()"></div>
                <div id="mobile-drawer" class="fixed inset-y-0 right-0 z-50 w-64 bg-paper-base shadow-xl transform transition-transform duration-300 ${STATE.mobileNavOpen ? 'translate-x-0' : 'translate-x-full'} flex flex-col">
                    <div class="flex items-center justify-between p-4 border-b border-paper-border">
                        <span class="font-semibold text-paper-text">Jump to</span>
                        <button onclick="toggleMobileNav()" class="p-2 text-paper-muted hover:text-paper-text" aria-label="Close navigation">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>
                    <div class="flex-1 overflow-y-auto p-4">
                        ${renderNavigationList()}
                    </div>
                </div>
            `;
        }

        function renderPaperSelector(contextId) {
            return `
                <div class="relative inline-block w-full max-w-xs">
                    <select 
                        onchange="loadPaper(this.value)"
                        class="block w-full pl-3 pr-10 py-2 text-sm bg-transparent border border-paper-border hover:border-paper-muted rounded-md focus:outline-none focus:ring-2 focus:ring-accent focus:border-accent transition-colors cursor-pointer text-paper-text font-medium"
                        aria-label="Select paper"
                    >
                        ${STATE.papers.map(p => `
                            <option value="${p.key}" ${p.key === STATE.currentPaperId ? 'selected' : ''}>
                                ${p.label}
                            </option>
                        `).join('')}
                    </select>
                </div>
            `;
        }

        // --- Content Rendering ---

        function renderPaperBody() {
            const paper = STATE.currentPaperData;
            if (!paper) return '';

            let html = '';

            if (paper.sections) {
                paper.sections.forEach(section => {
                    // Section Header (Stage 3 semantics: structural divider)
                    if (section.label && section.label.trim().length > 0) {
                        html += `
                            <div class="mb-8 mt-12 pb-2 border-b border-paper-border">
                                <h2 class="text-lg font-bold text-paper-text">${section.label}</h2>
                            </div>
                        `;
                    }
                    html += `<div class="space-y-16">`; // Top-level inter-question spacing
                    section.questions.forEach(q => {
                        html += renderQuestionNode(q, 0);
                    });
                    html += `</div>`;
                });
            } else if (paper.questions) {
                html += `<div class="space-y-16">`;
                paper.questions.forEach(q => {
                    html += renderQuestionNode(q, 0);
                });
                html += `</div>`;
            }

            return html;
        }

        function renderQuestionNode(node, depth) {
            // Canonical Structure: Question Body -> Solution Block -> Children
            // IDs
            const domId = `q-${node.id}`;
            const indentClass = depth > 0 ? 'ml-4 md:ml-8 mt-8 border-l-2 border-paper-divider pl-4 md:pl-6' : ''; // Sub-question visual subordination (indent + line)

            // 1. Question Body
            const questionHtml = `
                <div class="flex flex-col gap-2">
                    <div class="flex flex-row items-baseline gap-3 md:gap-4">
                        <span class="flex-shrink-0 text-sm md:text-base font-semibold text-paper-muted select-none min-w-[1.5em]">${node.id}</span>
                        <div class="flex-1 text-base md:text-lg text-paper-text font-medium leading-relaxed markdown-body">
                            ${processMarkdown(node.question)}
                        </div>
                    </div>
                </div>
            `;

            // 2. Solution Block (Optional)
            let solutionBlockHtml = '';
            if (node.solutionBlock) {
                solutionBlockHtml = renderSolutionBlock(node);
            }

            // 3. Children Container
            let childrenHtml = '';
            if (node.children && node.children.length > 0) {
                childrenHtml = `<div class="flex flex-col">`;
                node.children.forEach(child => {
                    childrenHtml += renderQuestionNode(child, depth + 1);
                });
                childrenHtml += `</div>`;
            }

            // Wrapper
            return `
                <article id="${domId}" class="scroll-mt-24 md:scroll-mt-8 group ${indentClass}">
                    ${questionHtml}
                    ${solutionBlockHtml}
                    ${childrenHtml}
                </article>
            `;
        }

        function renderSolutionBlock(node) {
            const sb = node.solutionBlock;
            const hasAnswer = !!sb.answer;
            const hasDetails = !!sb.solutionDetails;
            
            if (!hasAnswer && !hasDetails) return '';

            let html = `<div class="ml-8 md:ml-12 mt-4 flex flex-col gap-4">`;

            // A) Answer (Visible by default)
            if (hasAnswer) {
                html += `
                    <div class="flex flex-col sm:flex-row sm:items-baseline gap-1 sm:gap-3">
                        <span class="text-sm font-bold text-paper-muted uppercase tracking-wide">Answer</span>
                        <div class="text-base text-paper-text font-medium markdown-body">
                            ${processMarkdown(sb.answer)}
                        </div>
                    </div>
                `;
            }

            // B) Solution Details (Expandable)
            if (hasDetails) {
                const isExpanded = STATE.expandedStates[node.id];
                const toggleLabel = isExpanded ? "Hide working" : "Show working";
                // Text-first control with optional icon (Stage 5.7)
                const iconRotation = isExpanded ? "rotate-180" : "rotate-0";
                
                html += `
                    <div class="flex flex-col items-start gap-2">
                        <!-- Disclosure Control -->
                        <button 
                            onclick="toggleSolution('${node.id}')"
                            class="group/btn inline-flex items-center gap-2 text-sm font-medium text-accent hover:text-accent-hover transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-accent rounded px-1 -ml-1 py-1"
                            aria-expanded="${isExpanded}"
                            aria-controls="sd-${node.id}"
                        >
                            <span>${toggleLabel}</span>
                            <svg class="w-4 h-4 transition-transform duration-200 ${iconRotation}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </button>

                        <!-- Expanded Region -->
                        ${isExpanded ? renderSolutionDetailsContent(sb.solutionDetails, node.id) : ''}
                    </div>
                `;
            }

            html += `</div>`;
            return html;
        }

        function renderSolutionDetailsContent(details, nodeId) {
            // Stage 5.9 + 6.0 Rules
            // Order: Keep in mind -> Formulas used -> Working -> Alternative working
            // Subordination: Quiet, readable, not faded.

            const renderSection = (label, content, extraClasses = "") => {
                if (!content) return '';
                // Check if content is array (Alternative Working)
                if (Array.isArray(content)) {
                    return content.map(item => renderSection(label, item, extraClasses)).join('');
                }
                
                return `
                    <div class="flex flex-col gap-1 mb-6 last:mb-0 ${extraClasses}">
                        ${label ? `<h4 class="text-xs font-bold text-paper-subtle uppercase tracking-wider mb-1">${label}</h4>` : ''}
                        <div class="text-sm md:text-base text-paper-muted leading-relaxed markdown-body">
                            ${processMarkdown(content)}
                        </div>
                    </div>
                `;
            };

            // Keep in mind: slightly more prominent body
            const keepInMind = renderSection("Keep in mind", details.keepInMind, "bg-accent-subtle/30 -mx-4 px-4 py-3 rounded-md border border-accent-subtle/50"); // Permitted surface cue under Stage 5/ColorLab

            const formulas = renderSection("Formulas used", details.formulasUsed, "mt-2");

            // Working: Primary
            const working = renderSection("Working", details.working);

            // Alt Working
            const altWorking = details.alternativeWorking ? renderSection("Alternative working", details.alternativeWorking, "pt-4 border-t border-paper-divider mt-4") : '';

            return `
                <div id="sd-${nodeId}" class="w-full mt-2 fade-enter-active">
                    <div class="pl-2 border-l-2 border-accent/20"> <!-- Quiet demarcation line -->
                        <div class="pl-4 py-1">
                            ${keepInMind}
                            ${formulas}
                            ${working}
                            ${altWorking}
                        </div>
                    </div>
                </div>
            `;
        }


        // ============================================================================
        // UTILITIES & INTERACTION
        // ============================================================================

        function processMarkdown(content) {
            if (!content) return '';
            if (!md) return content; // Fallback
            // markdown-it configured with html:true passes SVG through
            return md.render(content);
        }

        function toggleSolution(nodeId) {
            STATE.expandedStates[nodeId] = !STATE.expandedStates[nodeId];
            // Re-render ONLY the specific solution block would be ideal, 
            // but for this prototype, we'll re-render the whole list to keep it simple and robust.
            // In a real app (React/Vue), this would be fine-grained. 
            // To prevent scroll jumping, we save scroll pos? 
            // Actually, re-rendering the whole tree in vanilla JS might detach focus and scroll.
            // Let's implement a targeted update strategy for the button and container.
            
            const btn = document.querySelector(`button[onclick="toggleSolution('${nodeId}')"]`);
            const container = btn.parentElement; // The div wrapping btn and details
            
            // Re-generate inner HTML of this container
            // We need to find the node data first
            const findNode = (nodes) => {
                for (let n of nodes) {
                    if (n.id === nodeId) return n;
                    if (n.children) {
                        const found = findNode(n.children);
                        if (found) return found;
                    }
                }
                return null;
            };

            let node = null;
            if (STATE.currentPaperData.sections) {
                for (let sec of STATE.currentPaperData.sections) {
                    node = findNode(sec.questions);
                    if (node) break;
                }
            } else {
                node = findNode(STATE.currentPaperData.questions);
            }

            if (!node) return;

            const isExpanded = STATE.expandedStates[nodeId];
            const toggleLabel = isExpanded ? "Hide working" : "Show working";
            const iconRotation = isExpanded ? "rotate-180" : "rotate-0";

            btn.setAttribute('aria-expanded', isExpanded);
            btn.innerHTML = `
                <span>${toggleLabel}</span>
                <svg class="w-4 h-4 transition-transform duration-200 ${iconRotation}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            `;

            // Handle the details pane
            const existingDetails = document.getElementById(`sd-${nodeId}`);
            if (isExpanded) {
                if (!existingDetails) {
                    const detailsHTML = renderSolutionDetailsContent(node.solutionBlock.solutionDetails, nodeId);
                    btn.insertAdjacentHTML('afterend', detailsHTML);
                    // Render math in the new content
                    renderMathInElement(document.getElementById(`sd-${nodeId}`));
                }
            } else {
                if (existingDetails) {
                    existingDetails.remove();
                }
            }
        }

        function toggleMobileNav() {
            STATE.mobileNavOpen = !STATE.mobileNavOpen;
            const drawer = document.getElementById('mobile-drawer');
            const overlay = document.getElementById('mobile-drawer-overlay');
            
            if (STATE.mobileNavOpen) {
                overlay.classList.remove('hidden');
                // slight delay to allow display:block to apply before opacity transition
                requestAnimationFrame(() => {
                    drawer.classList.remove('translate-x-full');
                    drawer.classList.add('translate-x-0');
                });
            } else {
                drawer.classList.remove('translate-x-0');
                drawer.classList.add('translate-x-full');
                setTimeout(() => {
                    overlay.classList.add('hidden');
                }, 300);
            }
        }

        function handleNavClick(e, targetId) {
            e.preventDefault();
            // Close mobile nav if open
            if (STATE.mobileNavOpen) toggleMobileNav();

            // Smooth scroll
            const target = document.getElementById(targetId.replace('#',''));
            if (target) {
                // Offset for header/padding
                const offset = window.innerWidth < 768 ? 80 : 32; 
                const elementPosition = target.getBoundingClientRect().top;
                const offsetPosition = elementPosition + window.pageYOffset - offset;
                
                window.scrollTo({
                    top: offsetPosition,
                    behavior: "smooth"
                });
                
                // Set active immediately for responsiveness
                updateActiveNav(targetId.replace('q-', ''));
            }
        }

        // --- Intersection Observer for Active Nav State ---
        function setupIntersectionObserver() {
            const options = {
                root: null,
                rootMargin: '-10% 0px -80% 0px', // Active when element is near top
                threshold: 0
            };

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const id = entry.target.id.replace('q-', '');
                        updateActiveNav(id);
                    }
                });
            }, options);

            document.querySelectorAll('article[id^="q-"]').forEach(section => {
                observer.observe(section);
            });
        }

        function updateActiveNav(activeId) {
            document.querySelectorAll('nav a').forEach(link => {
                if (link.id === `nav-${activeId}`) {
                    link.setAttribute('data-active', 'true');
                    // Scroll nav into view if needed
                    link.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                } else {
                    link.setAttribute('data-active', 'false');
                }
            });
        }

        // ============================================================================
        // BOOTSTRAP
        // ============================================================================
        window.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
