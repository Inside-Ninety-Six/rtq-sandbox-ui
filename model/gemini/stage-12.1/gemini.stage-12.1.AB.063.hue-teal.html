<!DOCTYPE html>
<html lang="en" class="antialiased text-slate-900 bg-slate-50">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AB","indexWithinVariant":"63","totalWithinVariant":"200","hueFamily":"teal","intensityMode":"","timestamp":"2026-01-06T23:04:07.571Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AB&quot;,&quot;indexWithinVariant&quot;:&quot;63&quot;,&quot;totalWithinVariant&quot;:&quot;200&quot;,&quot;hueFamily&quot;:&quot;teal&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-06T23:04:07.571Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Solution Viewer</title>
    
    <!-- Tailwind CSS (via CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // ColorLab B: Forced Hue "Teal"
                        accent: {
                            50: '#f0fdfa',
                            100: '#ccfbf1',
                            200: '#99f6e4',
                            300: '#5eead4',
                            400: '#2dd4bf',
                            500: '#14b8a6', // Primary focus/ring
                            600: '#0d9488', // Active text
                            700: '#0f766e',
                            800: '#115e59',
                            900: '#134e4a',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <!-- KaTeX CSS & JS (No SRI, via CDN) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Markdown-it (No SRI, via CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <style>
        /* Inter Font Import */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        /* Utility: Hide Scrollbar but keep functionality */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* KaTeX Containment Invariant */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 2px; /* Prevent clipping of descenders during scroll */
        }
        
        /* Inline KaTeX Background Rule: Transparent */
        .katex {
            background-color: transparent !important;
        }

        /* Base styles for Markdown content to look like paper */
        .markdown-body p {
            margin-bottom: 0.75em;
            line-height: 1.6;
        }
        .markdown-body p:last-child {
            margin-bottom: 0;
        }
        .markdown-body table {
            border-collapse: collapse;
            width: 100%;
            margin: 1em 0;
            font-size: 0.95em;
        }
        .markdown-body th, .markdown-body td {
            border: 1px solid #e2e8f0; /* slate-200 */
            padding: 0.5em;
            text-align: left;
        }
        .markdown-body th {
            font-weight: 600;
            background-color: transparent;
        }
        .markdown-body ul {
            list-style-type: disc;
            padding-left: 1.5em;
            margin-bottom: 0.75em;
        }
        .markdown-body ol {
            list-style-type: decimal;
            padding-left: 1.5em;
            margin-bottom: 0.75em;
        }
        
        /* Focus Visibility */
        :focus-visible {
            outline: 2px solid #14b8a6; /* accent-500 */
            outline-offset: 2px;
        }

        /* Smooth Scroll behavior */
        html {
            scroll-behavior: smooth;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Top Controls Region -->
    <header class="sticky top-0 z-40 bg-slate-50 border-b border-slate-200/60 backdrop-blur-sm bg-opacity-90">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-14 flex items-center justify-between">
            <!-- Paper Selector -->
            <div class="flex items-center gap-3">
                <label for="paper-selector" class="text-sm font-medium text-slate-500 sr-only">Select Paper</label>
                <select id="paper-selector" class="bg-white border border-slate-300 text-slate-700 text-sm rounded-md focus:ring-accent-500 focus:border-accent-500 block p-2 min-w-[200px] shadow-sm">
                    <option value="" disabled selected>Loading papers...</option>
                </select>
            </div>

            <!-- Mobile Jump To Trigger -->
            <button id="mobile-jump-trigger" class="lg:hidden text-sm font-medium text-accent-700 hover:text-accent-800 flex items-center gap-1 px-2 py-1 rounded">
                Jump to
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
        </div>
    </header>

    <!-- DocumentFrameShell -->
    <div id="main-shell" class="flex-1 max-w-7xl mx-auto w-full flex items-start justify-center relative">
        
        <!-- Desktop Navigation Rail (Sticky) -->
        <nav id="desktop-nav" class="hidden lg:block w-48 sticky top-14 max-h-[calc(100vh-3.5rem)] overflow-y-auto no-scrollbar py-8 pr-6 border-r border-transparent">
            <!-- Nav content injected via JS -->
        </nav>

        <!-- Paper Document Column -->
        <main id="paper-content" class="flex-1 w-full max-w-3xl min-h-screen py-8 px-4 sm:px-6 lg:px-8 bg-white shadow-sm border-x border-slate-100/50 mx-auto">
            <!-- Paper content injected via JS -->
            <div id="loading-indicator" class="text-center text-slate-400 py-12">Loading payload...</div>
        </main>

    </div>

    <!-- Mobile Navigation Drawer -->
    <div id="mobile-drawer-backdrop" class="fixed inset-0 bg-slate-900/20 backdrop-blur-sm z-50 hidden opacity-0 transition-opacity duration-200" aria-hidden="true"></div>
    <div id="mobile-drawer" class="fixed inset-y-0 right-0 w-64 bg-white shadow-xl z-50 transform translate-x-full transition-transform duration-200 flex flex-col" aria-modal="true" role="dialog">
        <div class="p-4 border-b border-slate-100 flex justify-between items-center">
            <h2 class="text-lg font-semibold text-slate-800">Jump to</h2>
            <button id="mobile-drawer-close" class="text-slate-500 hover:text-slate-700 p-1">
                <span class="sr-only">Close navigation</span>
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <div id="mobile-nav-list" class="flex-1 overflow-y-auto p-4">
            <!-- Mobile nav content injected via JS -->
        </div>
    </div>

    <!-- Application Logic -->
    <script>
        // --- STAGE 0: CONSTANTS (AUTHORITATIVE) ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // --- STATE & UTILS ---
        const state = {
            papers: [],
            currentPaper: null,
            expandedWorkings: new Set(), // Set of Question Node IDs
            activeQuestionId: null
        };

        // --- MARKDOWN SETUP (Authoritative Config) ---
        const md = window.markdownit ? window.markdownit({
            html: true, // Allow inline SVG
            linkify: true,
            breaks: false // Critical: prevent <br> in math blocks
        }) : null;

        if (md) {
            // Disable escape rule to preserve TeX backslashes
            md.inline.ruler.disable(['escape']);
        }

        // --- DOM ELEMENTS ---
        const els = {
            selector: document.getElementById('paper-selector'),
            content: document.getElementById('paper-content'),
            desktopNav: document.getElementById('desktop-nav'),
            mobileNavList: document.getElementById('mobile-nav-list'),
            mobileJumpTrigger: document.getElementById('mobile-jump-trigger'),
            mobileDrawer: document.getElementById('mobile-drawer'),
            mobileDrawerBackdrop: document.getElementById('mobile-drawer-backdrop'),
            mobileDrawerClose: document.getElementById('mobile-drawer-close'),
            loading: document.getElementById('loading-indicator')
        };

        // --- INITIALIZATION ---
        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error('Fetch failed');
                const payload = await response.json();
                
                if (!payload.papers || !Array.isArray(payload.papers)) throw new Error('Invalid schema');

                state.papers = payload.papers;
                renderSelector();
                
                // Load first paper by default
                if (state.papers.length > 0) {
                    loadPaper(state.papers[0].key);
                }
            } catch (err) {
                console.error(err);
                els.content.innerHTML = `<div class="text-center text-red-600 font-medium py-12">PAPERS PAYLOAD MISSING</div>`;
                els.selector.innerHTML = `<option>Error loading payload</option>`;
                els.selector.disabled = true;
            }
        }

        function renderSelector() {
            els.selector.innerHTML = state.papers.map(p => 
                `<option value="${p.key}">${p.label}</option>`
            ).join('');
            els.selector.disabled = false;
        }

        function loadPaper(paperKey) {
            const paper = state.papers.find(p => p.key === paperKey);
            if (!paper) return;

            state.currentPaper = paper;
            // Handle defaults
            const expandedAll = paper.defaults?.expandedAll !== false; // Default true unless false
            state.expandedWorkings.clear();
            
            // Collect all IDs that have solutions for default expansion state
            const collectSolutionIds = (nodes) => {
                nodes.forEach(node => {
                    if (node.solutionBlock?.solutionDetails && expandedAll) {
                        state.expandedWorkings.add(node.id);
                    }
                    if (node.children) collectSolutionIds(node.children);
                });
            };

            if (paper.sections) {
                paper.sections.forEach(s => collectSolutionIds(s.questions));
            } else if (paper.questions) {
                collectSolutionIds(paper.questions);
            }

            renderContent();
            renderNav();
            
            // Re-render KaTeX
            renderMathInElement(els.content, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false}
                ],
                throwOnError: false
            });
        }

        // --- RENDERING CORE ---

        function renderNav() {
            const paper = state.currentPaper;
            let html = '<ul class="space-y-1">';

            const renderItem = (q) => {
                // Typographic scale cue for hierarchy (Nav Hierarchy via Type Scale Only)
                // Nested children logic handled by flattening or inline check?
                // The brief says "Navigation is visually flat... no nested visual indentation".
                // But specifically mentions "hierarchy expressed via typographic scale/quietness".
                // Since we iterate recursively to find items, we should apply a class based on depth if we knew it, 
                // but ID-based navigation usually implies a flat lookup. 
                // We will render a flat list of items.
                
                // For simplicity and strict flat list requirement, we render items with same left align.
                // We'll use a data attribute for scrolling.
                return `
                    <li>
                        <a href="#q-${q.id}" 
                           class="block text-sm py-1 border-l-2 border-transparent pl-3 text-slate-500 hover:text-slate-800 hover:border-slate-300 transition-colors duration-150 truncate nav-item"
                           data-target="q-${q.id}">
                           ${q.id}
                        </a>
                    </li>
                `;
            };

            const processNodes = (nodes) => {
                return nodes.map(node => {
                    let out = renderItem(node);
                    if (node.children) out += processNodes(node.children);
                    return out;
                }).join('');
            };

            if (paper.sections) {
                paper.sections.forEach(section => {
                    if (section.label && section.label.trim().length > 0) {
                        html += `
                            <li class="pt-4 pb-1 pl-3 text-xs font-semibold text-slate-400 uppercase tracking-wider select-none">
                                ${section.label}
                            </li>
                        `;
                    } else if (paper.sections.length > 1) {
                         // Spacing separator if section label is empty but multiple sections exist
                         html += `<li class="h-4"></li>`;
                    }
                    html += processNodes(section.questions);
                });
            } else {
                html += processNodes(paper.questions);
            }

            html += '</ul>';

            els.desktopNav.innerHTML = html;
            els.mobileNavList.innerHTML = html; // Re-use html for mobile drawer

            setupNavInteractions();
        }

        function renderContent() {
            const paper = state.currentPaper;
            let html = '';

            const renderQuestionNode = (node, depth = 0) => {
                const isExpanded = state.expandedWorkings.has(node.id);
                const hasAnswer = !!node.solutionBlock?.answer;
                const hasDetails = !!node.solutionBlock?.solutionDetails;
                const showBlock = hasAnswer || hasDetails;

                // Indentation logic for children (Stage 3E): Spacing/Adaptation
                // We use padding-left that scales down on mobile
                const paddingClass = depth > 0 ? `pl-4 sm:pl-8 border-l border-slate-100` : '';
                const marginClass = depth === 0 ? 'mb-16' : 'mb-8 mt-6'; // Top level separation largest

                let nodeHtml = `
                <div id="q-${node.id}" class="question-node scroll-mt-20 ${marginClass} ${paddingClass}">
                    <!-- Question Body -->
                    <div class="mb-4">
                        <div class="flex items-baseline gap-3">
                            <span class="flex-none text-slate-500 font-semibold text-sm select-none">${node.id}</span>
                            <div class="flex-1 text-slate-900 text-lg leading-relaxed markdown-body">
                                ${mdRender(node.question)}
                            </div>
                        </div>
                    </div>
                `;

                // Solution Block
                if (showBlock) {
                    nodeHtml += `<div class="solution-block ml-0 sm:ml-8 mt-4 space-y-4">`; // Indent block slightly on larger screens to align with text

                    // Answer
                    if (hasAnswer) {
                        nodeHtml += `
                            <div class="answer-region">
                                <span class="text-xs font-bold text-slate-500 uppercase tracking-wide block mb-1">Answer</span>
                                <div class="text-slate-800 font-medium markdown-body">
                                    ${mdRender(node.solutionBlock.answer)}
                                </div>
                            </div>
                        `;
                    }

                    // Solution Details Control & Region
                    if (hasDetails) {
                        const details = node.solutionBlock.solutionDetails;
                        
                        // Separator if Answer exists (Stage 5.1/3F)
                        const sep = hasAnswer ? '<div class="h-px bg-slate-100 my-3 w-16"></div>' : '';

                        nodeHtml += `
                            ${sep}
                            <div class="solution-details-wrapper">
                                <button 
                                    class="toggle-working group flex items-center gap-2 text-sm font-medium text-accent-600 hover:text-accent-700 transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-accent-500 rounded px-1 -ml-1 py-1"
                                    data-id="${node.id}"
                                    aria-expanded="${isExpanded}"
                                >
                                    <span>${isExpanded ? 'Hide working' : 'Show working'}</span>
                                    <svg class="w-4 h-4 transition-transform duration-200 ${isExpanded ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>

                                <div class="solution-details-region mt-3 ${isExpanded ? 'block' : 'hidden'}">
                                    <!-- Keep in mind -->
                                    ${details.keepInMind ? `
                                        <div class="mb-4 text-slate-600 text-sm">
                                            <div class="font-bold text-slate-500 text-xs uppercase mb-1 flex items-center gap-1">
                                                Keep in mind
                                            </div>
                                            <div class="markdown-body">${mdRender(details.keepInMind)}</div>
                                        </div>
                                    ` : ''}

                                    <!-- Formulas Used -->
                                    ${details.formulasUsed ? `
                                        <div class="mb-4 text-slate-600 text-sm">
                                            <div class="font-bold text-slate-500 text-xs uppercase mb-1">Formulas used</div>
                                            <div class="markdown-body">${mdRender(details.formulasUsed)}</div>
                                        </div>
                                    ` : ''}

                                    <!-- Working -->
                                    ${details.working ? `
                                        <div class="mb-6">
                                            <div class="font-bold text-slate-500 text-xs uppercase mb-2">Working</div>
                                            <div class="text-slate-700 markdown-body space-y-3">
                                                ${mdRender(details.working)}
                                            </div>
                                        </div>
                                    ` : ''}

                                    <!-- Alternative Working -->
                                    ${details.alternativeWorking && Array.isArray(details.alternativeWorking) ? details.alternativeWorking.map((alt, idx) => `
                                        <div class="mt-6 pt-4 border-t border-slate-100">
                                            <div class="font-bold text-slate-500 text-xs uppercase mb-2">Alternative working${details.alternativeWorking.length > 1 ? ' ' + (idx + 1) : ''}</div>
                                            <div class="text-slate-700 markdown-body space-y-3">
                                                ${mdRender(alt)}
                                            </div>
                                        </div>
                                    `).join('') : ''}
                                </div>
                            </div>
                        `;
                    }

                    nodeHtml += `</div>`; // End Solution Block
                }

                // Children (Recursive)
                if (node.children && node.children.length > 0) {
                    nodeHtml += `<div class="children-container mt-4">`;
                    node.children.forEach(child => {
                        nodeHtml += renderQuestionNode(child, depth + 1);
                    });
                    nodeHtml += `</div>`;
                }

                nodeHtml += `</div>`; // End Question Node
                return nodeHtml;
            };

            // Build HTML
            if (paper.sections) {
                paper.sections.forEach(section => {
                    if (section.label && section.label.trim().length > 0) {
                        html += `
                            <div class="section-header mb-8 mt-12 pb-2 border-b border-slate-200">
                                <h2 class="text-xl font-bold text-slate-800">${section.label}</h2>
                            </div>
                        `;
                    }
                    section.questions.forEach(q => {
                        html += renderQuestionNode(q, 0);
                    });
                });
            } else {
                paper.questions.forEach(q => {
                    html += renderQuestionNode(q, 0);
                });
            }

            els.content.innerHTML = html;
            setupInteractionHandlers();
        }

        // --- HELPERS ---

        function mdRender(text) {
            if (!text || !md) return text || '';
            // Markdown rendering
            return md.render(text);
        }

        function setupInteractionHandlers() {
            // Expand/Collapse Toggles
            els.content.querySelectorAll('.toggle-working').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = btn.dataset.id;
                    const region = btn.nextElementSibling; // The solution-details-region
                    const icon = btn.querySelector('svg');
                    const label = btn.querySelector('span');
                    
                    if (state.expandedWorkings.has(id)) {
                        state.expandedWorkings.delete(id);
                        region.classList.add('hidden');
                        icon.classList.remove('rotate-180');
                        label.textContent = 'Show working';
                        btn.setAttribute('aria-expanded', 'false');
                    } else {
                        state.expandedWorkings.add(id);
                        region.classList.remove('hidden');
                        icon.classList.add('rotate-180');
                        label.textContent = 'Hide working';
                        btn.setAttribute('aria-expanded', 'true');
                    }
                });
            });
        }

        function setupNavInteractions() {
            const handleNavClick = (e) => {
                e.preventDefault();
                const targetId = e.currentTarget.dataset.target; // q-ID
                const targetEl = document.getElementById(targetId);
                
                if (targetEl) {
                    // Update Active State
                    document.querySelectorAll('.nav-item').forEach(el => {
                        el.classList.remove('font-bold', 'text-accent-700', 'border-accent-500');
                        el.classList.add('text-slate-500', 'border-transparent');
                    });
                    e.currentTarget.classList.remove('text-slate-500', 'border-transparent');
                    e.currentTarget.classList.add('font-bold', 'text-accent-700', 'border-accent-500');

                    // Close mobile drawer if open
                    closeDrawer();

                    // Scroll
                    const headerOffset = 80; // height of sticky header + padding
                    const elementPosition = targetEl.getBoundingClientRect().top;
                    const offsetPosition = elementPosition + window.pageYOffset - headerOffset;

                    window.scrollTo({
                        top: offsetPosition,
                        behavior: "smooth"
                    });
                }
            };

            document.querySelectorAll('.nav-item').forEach(link => {
                link.addEventListener('click', handleNavClick);
            });
        }

        // --- MOBILE DRAWER LOGIC ---
        
        function openDrawer() {
            els.mobileDrawer.classList.remove('translate-x-full');
            els.mobileDrawerBackdrop.classList.remove('hidden');
            // small timeout to allow display:block to apply before opacity transition
            setTimeout(() => els.mobileDrawerBackdrop.classList.remove('opacity-0'), 10);
            document.body.style.overflow = 'hidden';
        }

        function closeDrawer() {
            els.mobileDrawer.classList.add('translate-x-full');
            els.mobileDrawerBackdrop.classList.add('opacity-0');
            setTimeout(() => els.mobileDrawerBackdrop.classList.add('hidden'), 200);
            document.body.style.overflow = '';
        }

        els.mobileJumpTrigger.addEventListener('click', openDrawer);
        els.mobileDrawerClose.addEventListener('click', closeDrawer);
        els.mobileDrawerBackdrop.addEventListener('click', closeDrawer);

        // --- GLOBAL EVENT LISTENERS ---
        
        els.selector.addEventListener('change', (e) => {
            loadPaper(e.target.value);
            window.scrollTo({top: 0});
        });

        // Intersection Observer for Active Nav State (ScrollSpy)
        const observerOptions = {
            root: null,
            rootMargin: '-10% 0px -80% 0px', // Active when element is near top
            threshold: 0
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const id = entry.target.id;
                    // Update Nav
                    document.querySelectorAll('.nav-item').forEach(el => {
                        if (el.dataset.target === id) {
                            el.classList.remove('text-slate-500', 'border-transparent');
                            el.classList.add('font-bold', 'text-accent-700', 'border-accent-500');
                            // Ensure visible in nav rail
                            el.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                        } else {
                            el.classList.remove('font-bold', 'text-accent-700', 'border-accent-500');
                            el.classList.add('text-slate-500', 'border-transparent');
                        }
                    });
                }
            });
        }, observerOptions);

        // Re-attach observer when content changes
        const originalRenderContent = renderContent;
        renderContent = function() {
            originalRenderContent();
            // Disconnect old
            observer.disconnect();
            // Observe new question nodes
            document.querySelectorAll('.question-node').forEach(node => observer.observe(node));
        };

        // --- BOOTSTRAP ---
        init();

    </script>
</body>
</html>
