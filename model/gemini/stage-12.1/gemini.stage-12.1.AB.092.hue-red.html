<!DOCTYPE html>
<html lang="en" class="antialiased bg-stone-50">
<head>
  <!-- RTQ_RUN {"generator":"rtq-prototype-batch","model":"gemini-3-pro-preview","prefix":"gemini.stage-12.1","variant":"AB","indexWithinVariant":"92","totalWithinVariant":"200","hueFamily":"red","intensityMode":"","timestamp":"2026-01-07T00:52:12.631Z"} -->
  <meta name="rtq-run" content='{&quot;generator&quot;:&quot;rtq-prototype-batch&quot;,&quot;model&quot;:&quot;gemini-3-pro-preview&quot;,&quot;prefix&quot;:&quot;gemini.stage-12.1&quot;,&quot;variant&quot;:&quot;AB&quot;,&quot;indexWithinVariant&quot;:&quot;92&quot;,&quot;totalWithinVariant&quot;:&quot;200&quot;,&quot;hueFamily&quot;:&quot;red&quot;,&quot;intensityMode&quot;:&quot;&quot;,&quot;timestamp&quot;:&quot;2026-01-07T00:52:12.631Z&quot;}'>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ â€“ Maths Paper Solution Viewer</title>

    <!-- 1. Libraries (No SRI/Integrity as per Stage 6 instructions) -->
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Tailwind Configuration for ColorLab B (Red Hue Family) -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // ColorLab B: Forced Hue = RED
                        // Using Stone for neutrals to maintain "paper-like" warmth (ColorLab A/Base)
                        // Using Red for accents
                        primary: {
                            50: '#fef2f2',
                            100: '#fee2e2',
                            200: '#fecaca',
                            300: '#fca5a5',
                            400: '#f87171',
                            500: '#ef4444',
                            600: '#dc2626', // Main accent
                            700: '#b91c1c', // Darker text/hover
                            800: '#991b1b',
                            900: '#7f1d1d',
                        },
                        neutral: {
                            50: '#fafaf9', // stone-50
                            100: '#f5f5f4', // stone-100
                            200: '#e7e5e4',
                            300: '#d6d3d1',
                            400: '#a8a29e',
                            500: '#78716c',
                            600: '#57534e',
                            700: '#44403c',
                            800: '#292524',
                            900: '#1c1917',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <!-- Markdown-it -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <!-- KaTeX -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <style>
        /* 
         * STAGE 6 BASELINE: KaTeX Containment & Layout CSS
         */

        /* Base settings */
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            color: #1c1917; /* neutral-900 */
        }

        /* Nav scrollbar hiding (Stage 6 Add-on) */
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* KaTeX Block Containment Invariant */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 4px; /* Space for scrollbar if needed */
            margin-top: 0.5em;
            margin-bottom: 0.5em;
        }
        
        /* KaTeX Underlay Rule: Block only, never inline */
        .katex-display > .katex {
            /* Optional subtle wash for display math if desired, strictly blocked for inline */
            /* Using strictly transparent per current "paper" directives unless specifically washed */
            background-color: transparent; 
        }

        /* Prevent page-level scroll */
        img, svg, video, canvas, audio, iframe, embed, object {
            max-width: 100%;
            height: auto;
        }

        /* Table styling within Markdown */
        .prose-content table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0.75rem;
            margin-bottom: 0.75rem;
            font-size: 0.95em;
        }
        .prose-content th, .prose-content td {
            border: 1px solid #e7e5e4; /* neutral-200 */
            padding: 0.5rem;
            text-align: left;
            vertical-align: top;
        }
        .prose-content th {
            font-weight: 600;
            background-color: transparent;
        }

        /* Markdown List Styles */
        .prose-content ul {
            list-style-type: disc;
            padding-left: 1.5em;
            margin-top: 0.5em;
            margin-bottom: 0.5em;
        }
        .prose-content ol {
            list-style-type: decimal;
            padding-left: 1.5em;
            margin-top: 0.5em;
            margin-bottom: 0.5em;
        }
        .prose-content p {
            margin-bottom: 0.75em;
        }
        .prose-content p:last-child {
            margin-bottom: 0;
        }

        /* Utility for focusing */
        .focus-visible-ring:focus-visible {
            outline: none;
            box-shadow: 0 0 0 2px #dc2626; /* primary-600 */
            border-radius: 2px;
        }

        /* Drawer transition helpers */
        [x-cloak] { display: none !important; }
    </style>
</head>
<body x-data="paperApp()" x-init="initApp()" class="min-h-screen flex flex-col text-neutral-900 selection:bg-primary-100 selection:text-primary-900">

    <!-- 
      STAGE 3 CONSTANTS 
      Must appear exactly once as literal strings.
    -->
    <script>
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // ColorLab B Override: Forced Hue Family Parameter
        const RTQ_COLORLAB_FORCE_HUE_FAMILY = "red";
    </script>

    <!-- TOP CONTROLS REGION -->
    <!-- Aligned to shell gutters/frame -->
    <header class="w-full bg-neutral-50 border-b border-neutral-200 sticky top-0 z-30">
        <div class="max-w-6xl mx-auto px-4 md:px-8 h-14 flex items-center justify-between">
            
            <!-- Paper Selector -->
            <div class="flex items-center gap-3">
                <label for="paper-select" class="text-sm font-medium text-neutral-500 sr-only">Select Paper</label>
                <select 
                    id="paper-select" 
                    x-model="currentPaperKey" 
                    @change="loadPaper(currentPaperKey)"
                    class="bg-white border border-neutral-300 text-neutral-900 text-sm rounded focus:ring-primary-600 focus:border-primary-600 block w-full p-1.5 focus-visible-ring"
                    :disabled="loading || error"
                >
                    <template x-for="paper in papers" :key="paper.key">
                        <option :value="paper.key" x-text="paper.label"></option>
                    </template>
                    <template x-if="loading && papers.length === 0">
                        <option>Loading...</option>
                    </template>
                </select>
            </div>

            <!-- Mobile "Jump to" Trigger -->
            <button 
                @click="drawerOpen = true"
                class="md:hidden text-sm font-medium text-primary-700 hover:text-primary-800 flex items-center gap-1 focus-visible-ring px-2 py-1 rounded"
                aria-label="Open navigation"
            >
                <span>Jump to</span>
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
            </button>

        </div>
    </header>

    <!-- DOCUMENT FRAME SHELL -->
    <div class="flex-1 w-full max-w-6xl mx-auto px-4 md:px-8 py-8 md:flex md:gap-12 relative">
        
        <!-- DESKTOP NAVIGATION RAIL (Left Column) -->
        <!-- Sticky, scrollable if tall, no visible scrollbars -->
        <nav class="hidden md:block w-48 flex-shrink-0 relative">
            <div class="sticky top-20 max-h-[calc(100vh-6rem)] overflow-y-auto no-scrollbar pb-8">
                <template x-if="currentPaper">
                    <ul class="space-y-4">
                        <!-- Iterating Sections or Questions -->
                        <template x-if="currentPaperStructure.type === 'sectioned'">
                            <template x-for="section in currentPaperStructure.items" :key="section.id">
                                <li class="space-y-2">
                                    <!-- Section Label -->
                                    <div x-show="section.label" class="text-xs font-semibold text-neutral-400 uppercase tracking-wider select-none" x-text="section.label"></div>
                                    <!-- Questions in Section -->
                                    <ul class="space-y-1">
                                        <template x-for="q in section.questions" :key="q.id">
                                            <li>
                                                <a 
                                                    :href="'#' + q.id" 
                                                    class="block text-sm py-0.5 border-l-2 pl-3 transition-colors duration-200 focus-visible-ring rounded-r"
                                                    :class="activeQuestionId === q.id 
                                                        ? 'border-primary-600 text-primary-800 font-bold' 
                                                        : 'border-transparent text-neutral-500 hover:text-neutral-900 hover:border-neutral-300'"
                                                    x-text="q.id"
                                                    @click="activeQuestionId = q.id"
                                                ></a>
                                            </li>
                                        </template>
                                    </ul>
                                </li>
                            </template>
                        </template>

                        <!-- Flat List -->
                        <template x-if="currentPaperStructure.type === 'flat'">
                            <ul class="space-y-1">
                                <template x-for="q in currentPaperStructure.items" :key="q.id">
                                    <li>
                                        <a 
                                            :href="'#' + q.id" 
                                            class="block text-sm py-0.5 border-l-2 pl-3 transition-colors duration-200 focus-visible-ring rounded-r"
                                            :class="activeQuestionId === q.id 
                                                ? 'border-primary-600 text-primary-800 font-bold' 
                                                : 'border-transparent text-neutral-500 hover:text-neutral-900 hover:border-neutral-300'"
                                            x-text="q.id"
                                            @click="activeQuestionId = q.id"
                                        ></a>
                                    </li>
                                </template>
                            </ul>
                        </template>
                    </ul>
                </template>
            </div>
        </nav>

        <!-- PAPER CONTENT COLUMN (Right Column, Primary) -->
        <main class="flex-1 w-full min-w-0 pb-32">
            
            <!-- Error State -->
            <div x-show="error" x-cloak class="p-8 border border-red-200 bg-red-50 rounded text-red-800 font-mono text-center">
                PAPERS PAYLOAD MISSING
            </div>

            <!-- Loading State -->
            <div x-show="loading && !error" class="py-12 text-center text-neutral-400 italic">
                Loading paper...
            </div>

            <!-- Paper Container -->
            <div x-show="!loading && !error" id="paper-content-root" class="space-y-12">
                <!-- Content injected via JS render to handle Recursion + Markdown + KaTeX -->
            </div>

        </main>
    </div>

    <!-- MOBILE NAVIGATION DRAWER -->
    <div 
        x-show="drawerOpen" 
        x-cloak
        class="fixed inset-0 z-50 flex justify-end md:hidden"
        role="dialog" 
        aria-modal="true"
    >
        <!-- Backdrop -->
        <div 
            x-show="drawerOpen"
            x-transition:enter="transition opacity-300 ease-out"
            x-transition:enter-start="opacity-0"
            x-transition:enter-end="opacity-100"
            x-transition:leave="transition opacity-200 ease-in"
            x-transition:leave-start="opacity-100"
            x-transition:leave-end="opacity-0"
            class="fixed inset-0 bg-neutral-900/50 backdrop-blur-sm"
            @click="drawerOpen = false"
        ></div>

        <!-- Drawer Panel -->
        <div 
            x-show="drawerOpen"
            x-transition:enter="transition transform duration-300 ease-out"
            x-transition:enter-start="translate-x-full"
            x-transition:enter-end="translate-x-0"
            x-transition:leave="transition transform duration-200 ease-in"
            x-transition:leave-start="translate-x-0"
            x-transition:leave-end="translate-x-full"
            class="relative w-64 bg-white h-full shadow-xl overflow-y-auto no-scrollbar flex flex-col"
        >
            <div class="p-4 border-b border-neutral-100 flex items-center justify-between sticky top-0 bg-white z-10">
                <h2 class="text-sm font-bold text-neutral-900">Jump to</h2>
                <button @click="drawerOpen = false" class="text-neutral-400 hover:text-neutral-900 focus-visible-ring p-1 rounded">
                    <span class="sr-only">Close</span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>

            <div class="p-4">
                <template x-if="currentPaper">
                    <ul class="space-y-6">
                        <!-- Logic duplicates desktop structure but for drawer -->
                         <template x-if="currentPaperStructure.type === 'sectioned'">
                            <template x-for="section in currentPaperStructure.items" :key="section.id">
                                <li class="space-y-2">
                                    <div x-show="section.label" class="text-xs font-semibold text-neutral-400 uppercase tracking-wider" x-text="section.label"></div>
                                    <ul class="space-y-1">
                                        <template x-for="q in section.questions" :key="q.id">
                                            <li>
                                                <a 
                                                    :href="'#' + q.id" 
                                                    class="block text-base py-2 px-3 rounded transition-colors"
                                                    :class="activeQuestionId === q.id 
                                                        ? 'bg-primary-50 text-primary-700 font-semibold' 
                                                        : 'text-neutral-600 hover:bg-neutral-50 hover:text-neutral-900'"
                                                    x-text="q.id"
                                                    @click="activeQuestionId = q.id; drawerOpen = false"
                                                ></a>
                                            </li>
                                        </template>
                                    </ul>
                                </li>
                            </template>
                        </template>

                        <template x-if="currentPaperStructure.type === 'flat'">
                            <ul class="space-y-1">
                                <template x-for="q in currentPaperStructure.items" :key="q.id">
                                    <li>
                                        <a 
                                            :href="'#' + q.id" 
                                            class="block text-base py-2 px-3 rounded transition-colors"
                                            :class="activeQuestionId === q.id 
                                                ? 'bg-primary-50 text-primary-700 font-semibold' 
                                                : 'text-neutral-600 hover:bg-neutral-50 hover:text-neutral-900'"
                                            x-text="q.id"
                                            @click="activeQuestionId = q.id; drawerOpen = false"
                                        ></a>
                                    </li>
                                </template>
                            </ul>
                        </template>
                    </ul>
                </template>
            </div>
        </div>
    </div>

    <!-- MAIN APP LOGIC -->
    <script>
        // --- Markdown renderer setup (Authoritative Config) ---
        // Configured for Stage 6: HTML enabled, No breaks, Escape disabled
        const md = window.markdownit 
            ? window.markdownit({
                html: true,     // Allow inline SVG / HTML passthrough
                linkify: true,
                breaks: false   // CRITICAL: Prevent <br> in math blocks
            }) 
            : null;
        
        if (md) {
            // Disable escape rule to preserve TeX backslashes
            md.inline.ruler.disable(['escape']);
        }

        function paperApp() {
            return {
                loading: true,
                error: false,
                papers: [],
                currentPaperKey: null,
                currentPaper: null,
                currentPaperStructure: { type: 'flat', items: [] }, // For nav generation
                activeQuestionId: null,
                drawerOpen: false,

                async initApp() {
                    try {
                        const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                        if (!response.ok) throw new Error('Payload fetch failed');
                        
                        const payload = await response.json();
                        this.papers = payload.papers || [];

                        if (this.papers.length > 0) {
                            this.currentPaperKey = this.papers[0].key;
                            this.loadPaper(this.currentPaperKey);
                        } else {
                            this.loading = false; // No papers to load
                        }
                    } catch (e) {
                        console.error(e);
                        this.error = true;
                        this.loading = false;
                    }
                },

                loadPaper(key) {
                    this.loading = true;
                    // Simulate slight tick to ensure UI clears
                    setTimeout(() => {
                        const paper = this.papers.find(p => p.key === key);
                        if (paper) {
                            this.currentPaper = paper;
                            this.renderPaperContent(paper);
                            this.buildNavStructure(paper);
                            this.activeQuestionId = this.getParamFromStructure(this.currentPaperStructure, 0)?.id;
                        }
                        this.loading = false;
                        
                        // Scroll to top
                        window.scrollTo(0,0);
                    }, 50);
                },

                buildNavStructure(paper) {
                    // Extract a flat-ish structure for the nav renderer to consume
                    if (paper.sections) {
                        this.currentPaperStructure = {
                            type: 'sectioned',
                            items: paper.sections.map((s, idx) => ({
                                id: 'sec-' + idx,
                                label: s.label && s.label.trim() !== '' ? s.label : null,
                                questions: s.questions.map(q => ({ id: q.id })) // Only top-level IDs needed for nav? Brief says "All question identifiers". 
                                // Actually, brief says "Navigation must expose the full set of question identifiers".
                                // We need to traverse children too.
                            }))
                        };
                        // Enhance questions with recursive flattening if needed, 
                        // but usually 11+ papers nav is top level or simple depth. 
                        // Let's flatten recursively for nav items.
                        this.currentPaperStructure.items.forEach(sec => {
                            const originalQs = paper.sections.find(s => (s.label || '') === (sec.label || ''))?.questions || []; // Match by label ref is risky, better logic needed. 
                            // Re-map safely:
                            const sourceSec = paper.sections[this.currentPaperStructure.items.indexOf(sec)];
                            sec.questions = this.flattenQuestions(sourceSec.questions);
                        });

                    } else if (paper.questions) {
                        this.currentPaperStructure = {
                            type: 'flat',
                            items: this.flattenQuestions(paper.questions)
                        };
                    }
                },

                flattenQuestions(questions) {
                    let flat = [];
                    questions.forEach(q => {
                        flat.push({ id: q.id });
                        if (q.children && q.children.length > 0) {
                            flat = flat.concat(this.flattenQuestions(q.children));
                        }
                    });
                    return flat;
                },

                getParamFromStructure(struct, idx) {
                    // Helper to get first ID
                    if (struct.type === 'flat' && struct.items.length > 0) return struct.items[0];
                    if (struct.type === 'sectioned' && struct.items.length > 0 && struct.items[0].questions.length > 0) return struct.items[0].questions[0];
                    return null;
                },

                renderPaperContent(paper) {
                    const container = document.getElementById('paper-content-root');
                    if (!container) return;

                    let html = '';
                    const expandAll = paper.defaults?.expandedAll !== false; // Default true unless false

                    if (paper.sections) {
                        paper.sections.forEach(section => {
                            const showHeader = section.label && section.label.trim().length > 0;
                            
                            html += `<section class="mb-16">`; // Section container
                            
                            if (showHeader) {
                                html += `
                                    <div class="mb-8 pb-2 border-b border-neutral-200">
                                        <h2 class="text-lg font-bold text-neutral-900">${section.label}</h2>
                                    </div>
                                `;
                            } else {
                                // Implicit divider if multiple sections but no label, or just spacing
                                html += `<div class="h-8"></div>`;
                            }

                            html += `<div class="space-y-12">`; // Question list spacing
                            section.questions.forEach(q => {
                                html += this.renderQuestionNode(q, 0, expandAll);
                            });
                            html += `</div>`;
                            html += `</section>`;
                        });
                    } else if (paper.questions) {
                        html += `<div class="space-y-12">`;
                        paper.questions.forEach(q => {
                            html += this.renderQuestionNode(q, 0, expandAll);
                        });
                        html += `</div>`;
                    }

                    container.innerHTML = html;

                    // Initialize interactions (Alpine handles x-data in injected HTML automatically? 
                    // No, usually needs x-init or manual directive. 
                    // Alpine v3 automatically observes DOM? 
                    // Actually, modifying innerHTML doesn't auto-initialize Alpine components inside unless wrapped.
                    // We will do interactions via native Alpine binding by re-scanning or keeping it simple.)
                    
                    // Simple hack: We structure the injected HTML as valid Alpine components.
                    // But we must tell Alpine to initialize the new DOM tree.
                    // Actually, simpler: Use <template x-for> for the main list if possible, OR
                    // stick to standard JS generation. 
                    // Since the brief requires strict content generation from payload (recursive), JS string gen is best.
                    // To activate Alpine in new HTML:
                    // Alpine.initTree(container); // This is internal API?
                    // Safe public API in V3: none direct for innerHTML replacement without a plugin.
                    // Fallback: We'll construct the Show/Hide logic using vanilla onclick handlers embedded in the string.
                    // It's robust and simple.

                    this.$nextTick(() => {
                        this.renderMath(container);
                    });
                },

                renderQuestionNode(q, depth, defaultExpanded) {
                    const isTopLevel = depth === 0;
                    
                    // Content parsing
                    const questionHtml = md ? md.render(q.question || '') : q.question;
                    
                    // Solution Block Analysis
                    const hasSb = !!q.solutionBlock;
                    const answer = hasSb ? q.solutionBlock.answer : null;
                    const details = hasSb ? q.solutionBlock.solutionDetails : null;
                    const hasAnswer = answer && answer.trim().length > 0;
                    const hasDetails = !!details;

                    // IDs
                    const uId = 'q-' + q.id.replace(/[^a-zA-Z0-9]/g, '-');
                    const toggleId = 'toggle-' + uId;
                    const contentId = 'details-' + uId;

                    // Interaction state logic (vanilla JS attributes)
                    const isExpanded = defaultExpanded; 
                    const displayStyle = isExpanded ? 'block' : 'none';
                    const labelText = isExpanded ? 'Hide working' : 'Show working';
                    
                    // Hierarchy Styles
                    // Top level: more spacing (handled by parent space-y-12). 
                    // Children: Indented, tighter spacing.
                    const indentClass = depth > 0 ? 'ml-0 md:ml-6 mt-6 border-l-2 border-transparent pl-0' : ''; 
                    // Note: Design brief prefers indentation via spacing, explicitly "no borders". 
                    // Indentation via margin-left is safest.
                    // Brief: "Vertical spacing is tighter within a question... Sub-questions... indentation may adapt".
                    
                    let html = `
                        <div id="${q.id}" class="question-node group relative ${indentClass} scroll-mt-24">
                            
                            <!-- Question Body -->
                            <div class="flex gap-3">
                                <div class="flex-shrink-0 w-8 md:w-10 pt-0.5">
                                    <span class="text-neutral-500 font-medium text-sm md:text-base select-none">${q.id}</span>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="prose-content text-neutral-900 text-base md:text-lg leading-relaxed">
                                        ${questionHtml}
                                    </div>
                                </div>
                            </div>
                    `;

                    // Solution Block
                    if (hasSb) {
                        html += `<div class="ml-8 md:ml-10 mt-3 space-y-3">`; // Indent to match text start

                        // Answer
                        if (hasAnswer) {
                            const answerRendered = md ? md.render(answer) : answer;
                            html += `
                                <div class="relative">
                                    <div class="text-xs font-bold text-neutral-500 uppercase tracking-wide mb-1">Answer</div>
                                    <div class="prose-content text-neutral-900 font-medium">
                                        ${answerRendered}
                                    </div>
                                </div>
                            `;
                        }

                        // Details (Toggle + Content)
                        if (hasDetails) {
                            html += `
                                <div class="pt-1">
                                    <!-- Toggle Control -->
                                    <button 
                                        type="button"
                                        class="inline-flex items-center gap-1 text-sm font-medium text-primary-700 hover:text-primary-800 transition-colors focus-visible-ring rounded py-1 pr-2 select-none"
                                        onclick="toggleWorking('${contentId}', this)"
                                        aria-expanded="${isExpanded}"
                                        aria-controls="${contentId}"
                                    >
                                        <span class="label-text">${labelText}</span>
                                        <svg class="chevron transition-transform duration-200 ${isExpanded ? 'rotate-180' : ''}" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                                    </button>

                                    <!-- Expandable Region -->
                                    <div id="${contentId}" class="mt-4 space-y-6 pl-0 md:pl-0 border-l-2 border-neutral-100/0" style="display: ${displayStyle}">
                                        
                                        ${this.renderSolutionSubsections(details)}

                                    </div>
                                </div>
                            `;
                        }

                        html += `</div>`; // End Solution Block Wrapper
                    }

                    // Recursive Children
                    if (q.children && q.children.length > 0) {
                        html += `<div class="children-container mt-4">`;
                        q.children.forEach(child => {
                            html += this.renderQuestionNode(child, depth + 1, defaultExpanded);
                        });
                        html += `</div>`;
                    }

                    html += `</div>`; // End Node
                    return html;
                },

                renderSolutionSubsections(details) {
                    let html = '';

                    // 1. Keep in mind
                    if (details.keepInMind) {
                        html += `
                            <div class="solution-subsection">
                                <div class="text-sm font-bold text-neutral-500 mb-2 flex items-center gap-2">
                                    <!-- Icon allowed by brief -->
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                                    Keep in mind
                                </div>
                                <div class="prose-content text-sm text-neutral-700">
                                    ${md ? md.render(details.keepInMind) : details.keepInMind}
                                </div>
                            </div>
                        `;
                    }

                    // 2. Formulas Used
                    if (details.formulasUsed) {
                         html += `
                            <div class="solution-subsection">
                                <div class="text-sm font-bold text-neutral-500 mb-2">Formulas used</div>
                                <div class="prose-content text-sm text-neutral-700">
                                    ${md ? md.render(details.formulasUsed) : details.formulasUsed}
                                </div>
                            </div>
                        `;
                    }

                    // 3. Working
                    if (details.working) {
                        // Render mixed content logic handled by markdown-it + CSS hierarchy rules
                        html += `
                            <div class="solution-subsection">
                                <div class="text-sm font-bold text-neutral-500 mb-2">Working</div>
                                <div class="prose-content text-neutral-800">
                                    ${md ? md.render(details.working) : details.working}
                                </div>
                            </div>
                        `;
                    }

                    // 4. Alternative Working
                    if (details.alternativeWorking && Array.isArray(details.alternativeWorking)) {
                        details.alternativeWorking.forEach((alt, idx) => {
                             html += `
                                <div class="solution-subsection pt-4 border-t border-neutral-100">
                                    <div class="text-sm font-bold text-neutral-500 mb-2">Alternative working</div>
                                    <div class="prose-content text-neutral-800">
                                        ${md ? md.render(alt) : alt}
                                    </div>
                                </div>
                            `;
                        });
                    }

                    return html;
                },

                renderMath(container) {
                    if (window.renderMathInElement) {
                        renderMathInElement(container, {
                            delimiters: [
                                {left: '$$', right: '$$', display: true},
                                {left: '$', right: '$', display: false}
                            ],
                            throwOnError: false,
                            trust: true // Needed for potential HTML in macros if used, though unlikely here
                        });
                    }
                }
            }
        }

        // Global function for Vanilla JS toggle handling (since we inject HTML string)
        window.toggleWorking = function(targetId, btn) {
            const el = document.getElementById(targetId);
            if (!el) return;
            
            const isHidden = el.style.display === 'none';
            const labelSpan = btn.querySelector('.label-text');
            const chevron = btn.querySelector('.chevron');
            
            if (isHidden) {
                // Expand
                el.style.display = 'block';
                btn.setAttribute('aria-expanded', 'true');
                if (labelSpan) labelSpan.textContent = 'Hide working';
                if (chevron) chevron.classList.add('rotate-180');
                
                // Motion continuity: Minimal fade/slide could go here, but simple toggle mandated for calm feel
            } else {
                // Collapse
                el.style.display = 'none';
                btn.setAttribute('aria-expanded', 'false');
                if (labelSpan) labelSpan.textContent = 'Show working';
                if (chevron) chevron.classList.remove('rotate-180');
            }
        };
    </script>
</body>
</html>
