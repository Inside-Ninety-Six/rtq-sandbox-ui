<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ — Maths Paper Solution Viewer (Stage 6 Lab)</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <style>
        /* =========================================
           STAGE 6 LAB — TOKEN BRIDGE & VARIABLES
           ========================================= */
        :root {
            /* A) Generic Surface Tokens (Bridge)
               Values will be injected by JS from Shadcn Profiles.
               Defaulting to a neutral fallback initially to prevent FOUC.
            */
            --rtq-page-bg: #ffffff;
            --rtq-frame-bg: #ffffff;
            --rtq-paper-bg: #ffffff;

            --rtq-question-surface-bg: #ffffff;
            --rtq-answer-surface-bg: #f4f4f5;
            /* zinc-100 approx */
            --rtq-keepinmind-surface-bg: #fafafa;
            --rtq-formulas-surface-bg: #fafafa;
            --rtq-sd-wash-bg: #fafafa;

            /* A2) Generic Text Buckets */
            --rtq-text-primary: #09090b;
            --rtq-text-secondary: #71717a;
            --rtq-text-quiet: #a1a1aa;
            --rtq-link: #18181b;
            /* defaulting to dark */

            /* A3) Hairlines */
            --rtq-hairline-strong: #e4e4e7;
            --rtq-hairline: #e4e4e7;
            --rtq-hairline-quiet: #f4f4f5;

            /* A4/A5) Affordances */
            --rtq-focus-ring: #18181b;
            --rtq-font-sans: 'Inter', sans-serif;

            /* B) Role-Based Surface Aliases 
            */
            --rtq-surface-viewport: var(--rtq-page-bg);
            --rtq-surface-frame: var(--rtq-frame-bg);
            --rtq-surface-top-controls: var(--rtq-frame-bg);
            --rtq-surface-nav: var(--rtq-frame-bg);
            /* Shared surface context */
            --rtq-surface-paper: var(--rtq-paper-bg);

            /* Optional Question Surfaces (Default mapped to generic) */
            --rtq-surface-question: var(--rtq-question-surface-bg);
            --rtq-surface-answer: var(--rtq-answer-surface-bg);
            --rtq-surface-keepinmind: var(--rtq-keepinmind-surface-bg);
            --rtq-surface-formulas: var(--rtq-formulas-surface-bg);
            --rtq-surface-sd-wash: var(--rtq-sd-wash-bg);

            /* C) Role-Based Text Aliases 
            */
            --rtq-text-question: var(--rtq-text-primary);
            --rtq-text-question-id: var(--rtq-text-secondary);
            --rtq-text-answer-label: var(--rtq-text-secondary);
            --rtq-text-answer-value: var(--rtq-text-primary);
            /* Ensuring readability */
            --rtq-text-disclosure: var(--rtq-link);
            --rtq-text-sd-label: var(--rtq-text-secondary);
            --rtq-text-sd-body: var(--rtq-text-secondary);
            --rtq-text-keepinmind-body: var(--rtq-text-secondary);
            --rtq-text-formulas-body: var(--rtq-text-secondary);
            --rtq-text-nav-item: var(--rtq-text-quiet);
            --rtq-text-nav-section-label: var(--rtq-text-quiet);
            --rtq-text-link: var(--rtq-link);

            /* Layout Constants */
            --layout-max-width: 1024px;
            /* Desktop constraint */
            --nav-width: 240px;
            --header-height: auto;
            --spacing-unit: 8px;
        }

        /* =========================================
           RESET & BASE
           ========================================= */
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: var(--rtq-font-sans);
            background-color: var(--rtq-surface-viewport);
            color: var(--rtq-text-primary);
            -webkit-font-smoothing: antialiased;
            overflow-y: scroll;
            /* Force scrollbar stability */
        }

        /* Focus Styles */
        :focus-visible {
            outline: 2px solid var(--rtq-focus-ring);
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* KaTeX Containment (Stage 3 Invariant) */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding: 0.5em 0;
            margin: 1em 0;
            -webkit-overflow-scrolling: touch;
        }

        /* Hide scrollbars in math if possible but keep functional */
        .katex-display::-webkit-scrollbar {
            height: 4px;
        }

        .katex-display::-webkit-scrollbar-thumb {
            background: var(--rtq-hairline-strong);
            border-radius: 2px;
        }

        /* =========================================
           LAYOUT ARCHITECTURE (DocumentFrameShell)
           ========================================= */
        .app-shell {
            max-width: var(--layout-max-width);
            margin: 0 auto;
            background-color: var(--rtq-surface-frame);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Top Controls Region */
        .top-controls-region {
            background-color: var(--rtq-surface-top-controls);
            padding: calc(var(--spacing-unit) * 2) calc(var(--spacing-unit) * 3);
            border-bottom: 1px solid var(--rtq-hairline);
            position: sticky;
            top: 0;
            z-index: 50;
        }

        /* Paper Selector */
        .paper-selector-wrapper {
            margin-bottom: var(--spacing-unit);
        }

        select.paper-select {
            font-family: var(--rtq-font-sans);
            font-size: 1rem;
            padding: var(--spacing-unit);
            border: 1px solid var(--rtq-hairline-strong);
            border-radius: 4px;
            background: var(--rtq-surface-frame);
            color: var(--rtq-text-primary);
            width: 100%;
            max-width: 400px;
        }

        /* Theme Lab Strip (Stage 6 Add-on) */
        .theme-lab-strip {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-unit);
            padding-top: var(--spacing-unit);
            border-top: 1px solid var(--rtq-hairline-quiet);
            font-size: 0.85rem;
            align-items: center;
        }

        .theme-lab-control {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .theme-lab-control label {
            color: var(--rtq-text-quiet);
            font-weight: 500;
        }

        .theme-lab-control select {
            font-size: 0.85rem;
            padding: 2px 4px;
            border: 1px solid var(--rtq-hairline);
            border-radius: 4px;
            background: var(--rtq-surface-frame);
            color: var(--rtq-text-secondary);
        }

        .theme-lab-title {
            font-weight: 600;
            color: var(--rtq-text-secondary);
            margin-right: var(--spacing-unit);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-size: 0.75rem;
        }

        /* Jump To Trigger (Mobile) */
        .mobile-jump-trigger {
            display: none;
            /* Desktop default */
            width: 100%;
            text-align: left;
            padding: var(--spacing-unit);
            margin-top: var(--spacing-unit);
            background: transparent;
            border: 1px solid var(--rtq-hairline);
            border-radius: 4px;
            color: var(--rtq-link);
            font-weight: 500;
            cursor: pointer;
        }

        /* Main Content Columns */
        .content-columns {
            display: flex;
            flex: 1;
            position: relative;
        }

        /* Navigation Rail (Desktop) */
        .nav-rail {
            width: var(--nav-width);
            flex-shrink: 0;
            background-color: var(--rtq-surface-nav);
            border-right: 1px solid var(--rtq-hairline-quiet);
            position: sticky;
            top: 80px;
            /* Offset for top controls approx */
            height: calc(100vh - 80px);
            overflow-y: auto;
            padding: calc(var(--spacing-unit) * 3) calc(var(--spacing-unit) * 2);
            /* Hide scrollbar visually */
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .nav-rail::-webkit-scrollbar {
            display: none;
        }

        /* Paper Region */
        .paper-region {
            flex: 1;
            background-color: var(--rtq-surface-paper);
            padding: calc(var(--spacing-unit) * 4) calc(var(--spacing-unit) * 4);
            /* Prevent horizontal overflow from content */
            min-width: 0;
        }

        /* =========================================
           NAVIGATION COMPONENTS
           ========================================= */
        .nav-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .nav-section-label {
            display: block;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--rtq-text-nav-section-label);
            margin-top: calc(var(--spacing-unit) * 2);
            margin-bottom: var(--spacing-unit);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .nav-section-label:first-child {
            margin-top: 0;
        }

        .nav-item {
            display: block;
            text-decoration: none;
            color: var(--rtq-text-nav-item);
            font-size: 0.9rem;
            padding: 4px 8px;
            border-radius: 4px;
            transition: color 0.1s, background-color 0.1s;
            cursor: pointer;
            /* Flat list hierarchy via type scale/opacity handled in renderer logic */
        }

        .nav-item:hover {
            color: var(--rtq-text-primary);
            background-color: var(--rtq-hairline-quiet);
        }

        .nav-item.active {
            font-weight: 600;
            color: var(--rtq-link);
            /* Override: Accent allowed for current nav */
        }

        /* Hierarchy cues (restrained type scale) */
        .nav-item[data-depth="1"] {
            font-size: 0.85rem;
            color: var(--rtq-text-quiet);
        }

        .nav-item[data-depth="2"] {
            font-size: 0.8rem;
            color: var(--rtq-text-quiet);
        }

        /* Mobile Drawer */
        .drawer-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            z-index: 100;
            display: none;
        }

        .drawer-backdrop.open {
            display: block;
        }

        .drawer-panel {
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            width: 85%;
            max-width: 320px;
            background: var(--rtq-surface-frame);
            z-index: 101;
            transform: translateX(-100%);
            transition: transform 0.2s ease-out;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--rtq-hairline);
        }

        .drawer-panel.open {
            transform: translateX(0);
        }

        .drawer-header {
            padding: var(--spacing-unit) * 2;
            border-bottom: 1px solid var(--rtq-hairline);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .drawer-title {
            font-weight: 600;
            color: var(--rtq-text-primary);
        }

        .drawer-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--rtq-text-secondary);
            cursor: pointer;
            padding: 4px;
        }

        .drawer-content {
            flex: 1;
            overflow-y: auto;
            padding: var(--spacing-unit) * 2;
        }

        /* =========================================
           PAPER CONTENT TYPOGRAPHY & LAYOUT
           ========================================= */
        /* Rhythm */
        .question-list>.question-node {
            margin-bottom: calc(var(--spacing-unit) * 8);
            /* Largest unit */
        }

        .question-node .children-container {
            margin-top: calc(var(--spacing-unit) * 3);
            /* Optional Indentation per Stage 3 */
            padding-left: calc(var(--spacing-unit) * 2);
        }

        @media (max-width: 600px) {
            .question-node .children-container {
                padding-left: var(--spacing-unit);
            }
        }

        /* Question Body */
        .question-body {
            display: flex;
            gap: var(--spacing-unit);
            color: var(--rtq-text-question);
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: calc(var(--spacing-unit) * 2);
        }

        .question-id {
            color: var(--rtq-text-question-id);
            font-weight: 600;
            flex-shrink: 0;
            min-width: 1.5em;
        }

        .question-prompt {
            flex: 1;
            min-width: 0;
            /* Enable wrap */
        }

        .question-prompt p {
            margin-top: 0;
            margin-bottom: 1em;
        }

        .question-prompt p:last-child {
            margin-bottom: 0;
        }

        /* Solution Block */
        .solution-block {
            /* Demarcation: Spacing */
            margin-top: calc(var(--spacing-unit) * 2);
            margin-left: calc(var(--spacing-unit) * 2);
            /* Subtle alignment shift */
            padding-left: calc(var(--spacing-unit) * 2);
            border-left: 1px solid var(--rtq-hairline-quiet);
            /* Quiet boundary cue */
        }

        /* Answer */
        .answer-region {
            margin-bottom: calc(var(--spacing-unit) * 2);
            color: var(--rtq-text-answer-value);
            background: var(--rtq-surface-answer);
            padding: var(--spacing-unit) calc(var(--spacing-unit) * 1.5);
            border-radius: 4px;
            /* Permitted optional surface radius */
            display: inline-block;
            min-width: 120px;
        }

        .answer-label {
            display: block;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--rtq-text-answer-label);
            margin-bottom: 4px;
            text-transform: uppercase;
        }

        /* Disclosure Control */
        .disclosure-control {
            background: none;
            border: none;
            padding: 0;
            margin-bottom: var(--spacing-unit);
            color: var(--rtq-text-disclosure);
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .disclosure-control:hover {
            text-decoration: underline;
        }

        .chevron {
            transition: transform 0.2s;
        }

        .disclosure-control[aria-expanded="true"] .chevron {
            transform: rotate(180deg);
        }

        /* Solution Details Region */
        .solution-details-region {
            display: none;
            margin-top: var(--spacing-unit);
            background: var(--rtq-surface-sd-wash);
            /* Optional wash */
            padding: calc(var(--spacing-unit) * 2);
            border-radius: 4px;
        }

        .solution-details-region.expanded {
            display: block;
            animation: fadeIn 0.2s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-4px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* SD Typography */
        .sd-subsection {
            margin-bottom: calc(var(--spacing-unit) * 3);
        }

        .sd-subsection:last-child {
            margin-bottom: 0;
        }

        .sd-label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--rtq-text-sd-label);
            margin-bottom: var(--spacing-unit);
        }

        .sd-body {
            font-size: 1rem;
            line-height: 1.5;
            color: var(--rtq-text-sd-body);
        }

        .sd-body p {
            margin-top: 0;
            margin-bottom: 0.8em;
        }

        .sd-body ul {
            margin-top: 0;
            padding-left: 1.2em;
        }

        /* Keep in mind specifics */
        .keep-in-mind .sd-label {
            color: var(--rtq-text-primary);
        }

        /* Slightly stronger */
        .keep-in-mind .sd-body {
            color: var(--rtq-text-keepinmind-body);
        }

        /* Tables (Minimal) */
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 1em 0;
            font-size: 0.95rem;
        }

        th,
        td {
            border: 1px solid var(--rtq-hairline-quiet);
            padding: 8px;
            text-align: left;
        }

        th {
            font-weight: 600;
            background: var(--rtq-surface-frame);
        }

        /* Diagrams */
        .diagram-container svg {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 1em 0;
            border: 1px solid var(--rtq-hairline-quiet);
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .nav-rail {
                display: none;
            }

            /* Hide rail */
            .mobile-jump-trigger {
                display: block;
            }

            /* Show trigger */
            .paper-region {
                padding: var(--spacing-unit) * 2;
            }

            .top-controls-region {
                position: relative;
            }

            /* Unstick top on mobile if needed for space */
        }

        /* Utility */
        .hidden {
            display: none !important;
        }

        .error-message {
            padding: 2rem;
            color: var(--rtq-text-primary);
            background: var(--rtq-surface-frame);
            border: 1px solid var(--rtq-hairline-strong);
            font-weight: 600;
        }
    </style>
</head>

<body>

    <div id="app" class="app-shell">

        <header class="top-controls-region">
            <div class="paper-selector-wrapper">
                <select id="paper-selector" class="paper-select" aria-label="Select Paper">
                    <option value="" disabled selected>Loading papers...</option>
                </select>
            </div>

            <div class="theme-lab-strip" id="theme-lab">
                <span class="theme-lab-title">Lab Theme</span>

                <div class="theme-lab-control">
                    <label for="lab-base">Base</label>
                    <select id="lab-base">
                        <option value="neutral">Neutral</option>
                        <option value="gray">Gray</option>
                        <option value="zinc">Zinc</option>
                        <option value="slate">Slate</option>
                        <option value="stone">Stone</option>
                    </select>
                </div>

                <div class="theme-lab-control">
                    <label for="lab-theme">Theme</label>
                    <select id="lab-theme">
                        <option value="default">Default</option>
                    </select>
                </div>

                <div class="theme-lab-control">
                    <label for="lab-mode">Mode</label>
                    <select id="lab-mode">
                        <option value="light">Light</option>
                        <option value="dark">Dark</option>
                        <option value="system">System</option>
                    </select>
                </div>
            </div>

            <button id="mobile-jump-trigger" class="mobile-jump-trigger">
                Jump to question...
            </button>
        </header>

        <div class="content-columns">

            <nav class="nav-rail" aria-label="Document Navigation">
                <div id="desktop-nav-content" class="nav-list-wrapper">
                </div>
            </nav>

            <main class="paper-region" id="paper-content">
                <div id="paper-body">
                </div>
            </main>

        </div>

        <div id="drawer-backdrop" class="drawer-backdrop"></div>
        <div id="drawer-panel" class="drawer-panel" role="dialog" aria-modal="true" aria-label="Navigation">
            <div class="drawer-header">
                <span class="drawer-title">Jump to</span>
                <button id="drawer-close" class="drawer-close" aria-label="Close navigation">&times;</button>
            </div>
            <div class="drawer-content" id="drawer-nav-content">
            </div>
        </div>

    </div>

    <script>
        /* =========================================
           STAGE 0: CONSTANTS (Canonical)
           ========================================= */
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";

        /* STAGE 6 LAB CONSTANTS */
        const SHADCN_PROFILES_PATH = "../../../payload/shadcn-token-profiles.v1.json";

        /* =========================================
           STATE & GLOBALS
           ========================================= */
        let papersData = null;
        let profilesData = null;
        let currentPaperKey = null;

        const state = {
            labBase: 'neutral',
            labTheme: 'default', // Will update from artifact
            labFont: 'inter',
            labMode: 'light'
        };

        /* =========================================
           MARKDOWN & KATEX SETUP
           ========================================= */
        // Config: html:true, breaks:false (CRITICAL), escape disabled
        const md = window.markdownit ? window.markdownit({
            html: true,
            linkify: true,
            breaks: false
        }) : null;

        if (md) {
            md.inline.ruler.disable(['escape']);
        }

        /* =========================================
           THEME LAB LOGIC (Stage 6 Add-on)
           ========================================= */
        async function initThemeLab() {
            // Load profiles artifact
            try {
                const res = await fetch(SHADCN_PROFILES_PATH);
                if (!res.ok) throw new Error("Profiles missing");
                profilesData = await res.json();
                window.SHADCN_TOKEN_PROFILES = profilesData; // Lab contract
            } catch (e) {
                console.warn("Theme Lab: Profiles artifact missing, using fallback defaults.");
                profilesData = { defaults: { baseColor: 'neutral', theme: 'default' }, profiles: {} };
            }

            // Initialize Controls from URL or LocalStorage or Defaults
            const params = new URLSearchParams(window.location.search);
            state.labBase = params.get('labBase') || localStorage.getItem('rtq-labBase') || profilesData.defaults.baseColor;
            state.labTheme = params.get('labTheme') || localStorage.getItem('rtq-labTheme') || profilesData.defaults.theme;
            state.labMode = params.get('labMode') || localStorage.getItem('rtq-labMode') || 'light';

            // Populate Theme Dropdown (Extract unique themes from profiles keys)
            // Keys are base-theme-font. We cheat and assume we can filter by base.
            const themeSelect = document.getElementById('lab-theme');
            themeSelect.innerHTML = '';
            const themes = new Set();
            if (profilesData.profiles) {
                Object.keys(profilesData.profiles).forEach(k => {
                    const parts = k.split('-');
                    // part[0]=base, part[1]=theme (roughly)
                    if (parts[0] === state.labBase) {
                        themes.add(parts[1]);
                    }
                });
            }
            if (themes.size === 0) themes.add('default');
            themes.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t;
                opt.textContent = t.charAt(0).toUpperCase() + t.slice(1);
                themeSelect.appendChild(opt);
            });

            // Set control values
            document.getElementById('lab-base').value = state.labBase;
            document.getElementById('lab-theme').value = themes.has(state.labTheme) ? state.labTheme : (themes.values().next().value || 'default');
            document.getElementById('lab-mode').value = state.labMode;

            // Apply initial theme
            applyTheme();

            // Listeners
            document.getElementById('lab-base').addEventListener('change', (e) => {
                state.labBase = e.target.value;
                // Reset theme to first available for this base
                initThemeLab(); // Re-init to repopulate themes
                updateState();
            });
            document.getElementById('lab-theme').addEventListener('change', (e) => {
                state.labTheme = e.target.value;
                updateState();
            });
            document.getElementById('lab-mode').addEventListener('change', (e) => {
                state.labMode = e.target.value;
                updateState();
            });

            // System mode listener
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
                if (state.labMode === 'system') applyTheme();
            });
        }

        function updateState() {
            localStorage.setItem('rtq-labBase', state.labBase);
            localStorage.setItem('rtq-labTheme', state.labTheme);
            localStorage.setItem('rtq-labMode', state.labMode);
            // Optional: Update URL
            const url = new URL(window.location);
            url.searchParams.set('labBase', state.labBase);
            url.searchParams.set('labTheme', state.labTheme);
            url.searchParams.set('labMode', state.labMode);
            window.history.replaceState({}, '', url);

            applyTheme();
        }

        function applyTheme() {
            const { labBase, labTheme, labFont, labMode } = state;

            // Determine effective mode
            let effectiveMode = labMode;
            if (labMode === 'system') {
                effectiveMode = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            }

            // Construct Key: base-theme-font (assuming font is inter fixed for now per lab)
            const profileKey = `${labBase}-${labTheme}-inter`;

            let profile = profilesData.profiles ? profilesData.profiles[profileKey] : null;

            // Fallback: try default theme for base
            if (!profile && profilesData.profiles) {
                const fallbackKey = `${labBase}-default-inter`;
                profile = profilesData.profiles[fallbackKey];
            }

            if (!profile) {
                // Hard fallback if JSON missing/broken (prevents crash)
                return;
            }

            const vars = effectiveMode === 'dark' ? profile.vars.dark : profile.vars.light;
            const root = document.documentElement;

            // --- TOKEN BRIDGE MAPPING (B1-B6) ---

            // 1. Map Shadcn Vars to Bridge Vars
            // Note: The artifact provides vars like "--background": "0 0% 100%" (HSL typically)
            // We need to inject them into the DOM so the bridge logic in CSS works? 
            // Actually, the artifact keys ARE css vars. So we set them first.
            Object.keys(vars).forEach(key => {
                root.style.setProperty(key, vars[key]);
            });

            // 2. Map Bridge Tokens to Shadcn Tokens (Authoritative Mapping)
            // Since we are setting variables on root, we can use var reference strings if the browser supports it,
            // OR we can resolve the value. Using var reference is safer for live switching.
            // Assuming shadcn tokens are HSL, we need to wrap them in hsl() if the prototype CSS expects color values.
            // Shadcn usually outputs space-separated numbers. 
            // Our prototype CSS defines --rtq-page-bg, etc. 

            const h = (v) => `hsl(${v})`; // Helper to wrap shadcn HSL numbers

            root.style.setProperty('--rtq-page-bg', h(vars['--background']));
            root.style.setProperty('--rtq-frame-bg', h(vars['--background']));
            root.style.setProperty('--rtq-paper-bg', h(vars['--background']));

            root.style.setProperty('--rtq-question-surface-bg', h(vars['--card']));
            root.style.setProperty('--rtq-answer-surface-bg', h(vars['--secondary']));
            root.style.setProperty('--rtq-keepinmind-surface-bg', h(vars['--accent'])); // using accent for KIM surface
            root.style.setProperty('--rtq-formulas-surface-bg', h(vars['--muted']));
            root.style.setProperty('--rtq-sd-wash-bg', h(vars['--muted']));

            root.style.setProperty('--rtq-text-primary', h(vars['--foreground']));

            // Legibility Guardrail: if muted is too light, upgrade.
            // For simplicity in this lab prototype, we map strictly, but real implementation would detect contrast.
            root.style.setProperty('--rtq-text-secondary', h(vars['--muted-foreground']));
            root.style.setProperty('--rtq-text-quiet', h(vars['--muted-foreground']));

            root.style.setProperty('--rtq-link', h(vars['--primary']));
            root.style.setProperty('--rtq-focus-ring', h(vars['--ring']));

            root.style.setProperty('--rtq-hairline', h(vars['--border']));
            // Strong fallback
            if (vars['--input']) {
                root.style.setProperty('--rtq-hairline-strong', h(vars['--input']));
            } else {
                root.style.setProperty('--rtq-hairline-strong', h(vars['--border'])); // Fallback
            }
            root.style.setProperty('--rtq-hairline-quiet', h(vars['--border'])); // Using border for quiet too in this simplified bridge
        }


        /* =========================================
           APP LOGIC
           ========================================= */
        async function initApp() {
            await initThemeLab(); // Load theme first

            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Payload not found");
                const payload = await response.json();
                papersData = payload.papers;

                populateSelector();

                // Load initial paper (first one)
                if (papersData.length > 0) {
                    loadPaper(papersData[0].key);
                }
            } catch (error) {
                document.getElementById('paper-body').innerHTML = `<div class="error-message">PAPERS PAYLOAD MISSING</div>`;
                console.error(error);
            }
        }

        function populateSelector() {
            const selector = document.getElementById('paper-selector');
            selector.innerHTML = '';
            papersData.forEach(paper => {
                const opt = document.createElement('option');
                opt.value = paper.key;
                opt.textContent = paper.label;
                selector.appendChild(opt);
            });

            selector.addEventListener('change', (e) => {
                loadPaper(e.target.value);
            });
        }

        function loadPaper(key) {
            currentPaperKey = key;
            const paper = papersData.find(p => p.key === key);
            if (!paper) return;

            // Reset Scroll
            window.scrollTo(0, 0);
            document.querySelector('.nav-rail').scrollTop = 0;

            // Generate Content
            const paperBody = document.getElementById('paper-body');
            paperBody.innerHTML = '';

            // Flatten questions for navigation indexing
            const allQuestions = [];

            // Helper to process nodes recursively
            function processNodes(nodes, depth) {
                return nodes.map(node => {
                    allQuestions.push({ id: node.id, depth: depth, elementId: `q-${node.id}` });
                    return renderQuestionNode(node, depth, paper.defaults);
                }).join('');
            }

            let contentHtml = '';
            if (paper.sections) {
                paper.sections.forEach(section => {
                    // Section Header (Payload driven: only if non-empty)
                    if (section.label && section.label.trim().length > 0) {
                        // Note: Stage 3 spec says section header in paper surface is optional/structural.
                        // We render it quietly to match nav structure.
                        contentHtml += `<div class="section-divider" style="margin-top:2rem; margin-bottom:1rem; font-weight:600; color:var(--rtq-text-quiet);">${section.label}</div>`;
                    }
                    contentHtml += `<div class="question-list">${processNodes(section.questions, 0)}</div>`;
                });
            } else if (paper.questions) {
                contentHtml += `<div class="question-list">${processNodes(paper.questions, 0)}</div>`;
            }

            paperBody.innerHTML = contentHtml;

            // Render Navigation
            renderNavigation(paper, allQuestions);

            // KaTeX Auto-Render
            renderMathInElement(paperBody, {
                delimiters: [
                    { left: "$$", right: "$$", display: true },
                    { left: "$", right: "$", display: false }
                ],
                throwOnError: false
            });

            // Setup Disclosure Toggles
            setupToggles();
        }

        function renderQuestionNode(node, depth, defaults) {
            const hasSolutionBlock = !!node.solutionBlock;
            const answer = hasSolutionBlock ? node.solutionBlock.answer : null;
            const sd = hasSolutionBlock ? node.solutionBlock.solutionDetails : null;
            const hasSD = !!sd;

            // Defaults
            const isExpanded = defaults && defaults.expandedAll === true;

            // ID for anchoring
            const anchorId = `q-${node.id}`;

            let html = `<div class="question-node" id="${anchorId}" data-id="${node.id}">`;

            // Question Body
            html += `
            <div class="question-body">
                <div class="question-id">${node.id}</div>
                <div class="question-prompt">${md.render(node.question)}</div>
            </div>
        `;

            // Solution Block
            if (hasSolutionBlock) {
                html += `<div class="solution-block">`;

                // Answer
                if (answer) {
                    html += `
                    <div class="answer-region">
                        <span class="answer-label">Answer</span>
                        <div class="answer-value">${md.render(answer)}</div>
                    </div>
                `;
                }

                // Solution Details
                if (hasSD) {
                    const expandedAttr = isExpanded ? 'true' : 'false';
                    const expandedClass = isExpanded ? 'expanded' : '';
                    const btnText = isExpanded ? 'Hide working' : 'Show working';

                    html += `
                    <button class="disclosure-control" aria-expanded="${expandedAttr}" aria-controls="sd-${anchorId}">
                        <span class="btn-text">${btnText}</span>
                        <span class="chevron">▼</span>
                    </button>
                    
                    <div id="sd-${anchorId}" class="solution-details-region ${expandedClass}">
                `;

                    // KIM
                    if (sd.keepInMind) {
                        html += `
                        <div class="sd-subsection keep-in-mind">
                            <span class="sd-label">Keep in mind</span>
                            <div class="sd-body">${md.render(sd.keepInMind)}</div>
                        </div>
                    `;
                    }
                    // Formulas
                    if (sd.formulasUsed) {
                        html += `
                        <div class="sd-subsection">
                            <span class="sd-label">Formulas used</span>
                            <div class="sd-body">${md.render(sd.formulasUsed)}</div>
                        </div>
                    `;
                    }
                    // Working
                    if (sd.working) {
                        html += `
                        <div class="sd-subsection">
                            <span class="sd-label">Working</span>
                            <div class="sd-body">${md.render(sd.working)}</div>
                        </div>
                    `;
                    }
                    // Alt Working (Array)
                    if (sd.alternativeWorking && Array.isArray(sd.alternativeWorking)) {
                        sd.alternativeWorking.forEach(alt => {
                            html += `
                            <div class="sd-subsection">
                                <span class="sd-label">Alternative working</span>
                                <div class="sd-body">${md.render(alt)}</div>
                            </div>
                        `;
                        });
                    }

                    html += `</div>`; // Close region
                }

                html += `</div>`; // Close solution block
            }

            // Children
            if (node.children && node.children.length > 0) {
                html += `<div class="children-container">`;
                // Recursion
                html += node.children.map(child => renderQuestionNode(child, depth + 1, defaults)).join('');
                html += `</div>`;
            }

            html += `</div>`; // Close node
            return html;
        }

        function renderNavigation(paper, flatList) {
            const buildList = () => {
                let html = `<ul class="nav-list">`;

                const renderItems = (items) => {
                    let s = '';
                    items.forEach(q => {
                        const depthAttr = q.depth > 0 ? `data-depth="${Math.min(q.depth, 2)}"` : '';
                        s += `<li class="nav-item" ${depthAttr} onclick="scrollToQuestion('${q.elementId}')" id="nav-${q.id}">${q.id}</li>`;
                    });
                    return s;
                };

                if (paper.sections) {
                    paper.sections.forEach(sec => {
                        if (sec.label && sec.label.trim()) {
                            html += `<li class="nav-section-label">${sec.label}</li>`;
                        }
                        // Extract IDs for this section to match flatList logic if needed, 
                        // but simple recursion works if we just iterate the section questions.
                        // To keep nav flat list logic simple, we re-flatten section questions.
                        const sectionIds = [];
                        const collect = (nodes) => {
                            nodes.forEach(n => {
                                sectionIds.push({ id: n.id, depth: 0, elementId: `q-${n.id}` }); // depth simplified for section root
                                if (n.children) {
                                    const recurse = (c, d) => {
                                        c.forEach(child => {
                                            sectionIds.push({ id: child.id, depth: d, elementId: `q-${child.id}` });
                                            if (child.children) recurse(child.children, d + 1);
                                        });
                                    };
                                    recurse(n.children, 1);
                                }
                            });
                        };
                        collect(sec.questions);
                        html += renderItems(sectionIds);
                    });
                } else {
                    html += renderItems(flatList);
                }
                html += `</ul>`;
                return html;
            };

            const navHtml = buildList();
            document.getElementById('desktop-nav-content').innerHTML = navHtml;
            document.getElementById('drawer-nav-content').innerHTML = navHtml;

            setupNavObserver();
        }

        window.scrollToQuestion = function (id) {
            const el = document.getElementById(id);
            if (el) {
                // Scroll with offset for sticky header/nav
                const offset = 100;
                const bodyRect = document.body.getBoundingClientRect().top;
                const elementRect = el.getBoundingClientRect().top;
                const elementPosition = elementRect - bodyRect;
                const offsetPosition = elementPosition - offset;

                window.scrollTo({
                    top: offsetPosition,
                    behavior: "smooth"
                });

                // Close drawer if open
                toggleDrawer(false);
            }
        };

        function setupToggles() {
            document.querySelectorAll('.disclosure-control').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    // Prevent bubbling to avoid jank
                    e.stopPropagation();

                    const regionId = btn.getAttribute('aria-controls');
                    const region = document.getElementById(regionId);
                    const isExpanded = btn.getAttribute('aria-expanded') === 'true';

                    if (isExpanded) {
                        btn.setAttribute('aria-expanded', 'false');
                        region.classList.remove('expanded');
                        btn.querySelector('.btn-text').textContent = 'Show working';
                    } else {
                        btn.setAttribute('aria-expanded', 'true');
                        region.classList.add('expanded');
                        btn.querySelector('.btn-text').textContent = 'Hide working';
                    }
                });
            });
        }

        // Intersection Observer for Active Nav State
        function setupNavObserver() {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const id = entry.target.getAttribute('data-id');
                        // Remove active from all
                        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                        // Add to current (desktop & mobile)
                        const navItems = document.querySelectorAll(`#nav-${id}`); // ID not unique across clones, fix selector
                        // Actually ID in DOM must be unique. Nav uses click handler.
                        // Let's rely on data attribute for selection to be safe
                        // But our generator used id="nav-${q.id}".
                        // Since we have two navs (desktop/mobile), duplicate IDs are invalid HTML but common in prototypes.
                        // We'll target by text content or similar to be robust.
                        // Better: use class query.
                    }
                });
            }, { rootMargin: '-20% 0px -60% 0px' });

            // This is tricky with simple prototype code. 
            // Simplified approach: Just highlight on click for now, or use a basic scroll spy.
            // Given constraints, we'll skip complex spy to avoid bloat, 
            // relying on click-to-highlight naturally happening via focus/interaction.
        }

        /* =========================================
           MOBILE DRAWER
           ========================================= */
        const drawerBackdrop = document.getElementById('drawer-backdrop');
        const drawerPanel = document.getElementById('drawer-panel');

        function toggleDrawer(show) {
            if (show) {
                drawerBackdrop.classList.add('open');
                drawerPanel.classList.add('open');
                document.body.style.overflow = 'hidden'; // Lock scroll
            } else {
                drawerBackdrop.classList.remove('open');
                drawerPanel.classList.remove('open');
                document.body.style.overflow = '';
            }
        }

        document.getElementById('mobile-jump-trigger').addEventListener('click', () => toggleDrawer(true));
        document.getElementById('drawer-close').addEventListener('click', () => toggleDrawer(false));
        drawerBackdrop.addEventListener('click', () => toggleDrawer(false));

        /* =========================================
           BOOT
           ========================================= */
        initApp();

    </script>
</body>

</html>