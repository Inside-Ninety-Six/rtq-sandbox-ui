<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ - Maths Paper Solution Viewer (Fixed V3)</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"
        integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV" crossorigin="anonymous">

    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"
        integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8"
        crossorigin="anonymous"></script>

    <style>
        /* * CORE RESET & VARIABLES */
        :root {
            --bg-body: #fdfdfd;
            --bg-paper: #ffffff;
            --text-main: #111111;
            --text-muted: #555555;
            --text-faint: #999999;
            --border-light: #e0e0e0;
            --font-main: "Times New Roman", Times, serif;
            --font-ui: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --spacing-unit: 8px;
            --max-width: 960px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: var(--font-main);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        /* * LAYOUT ARCHITECTURE */
        .app-frame {
            max-width: var(--max-width);
            margin: 0 auto;
            padding: 0 var(--spacing-unit);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* TOP CONTROLS */
        .top-controls {
            padding: 24px 0;
            border-bottom: 1px solid var(--border-light);
            margin-bottom: 32px;
            font-family: var(--font-ui);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg-body);
            z-index: 10;
        }

        .paper-selector {
            padding: 8px;
            font-size: 14px;
            border: 1px solid var(--text-faint);
            background: #fff;
            min-width: 200px;
        }

        .mobile-menu-toggle {
            display: none;
            padding: 8px 12px;
            border: 1px solid var(--text-main);
            background: transparent;
            cursor: pointer;
        }

        /* MAIN CONTENT COLUMNS */
        .layout-columns {
            display: flex;
            flex-direction: row;
            gap: 48px;
            flex: 1;
            padding-bottom: 100px;
            position: relative;
        }

        /* * NAVIGATION RAIL */
        .nav-column {
            width: 160px;
            flex-shrink: 0;
            position: sticky;
            top: 24px;
            max-height: calc(100vh - 48px);
            overflow-y: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .nav-column::-webkit-scrollbar {
            display: none;
        }

        .nav-list {
            list-style: none;
            padding: 0;
            margin: 0;
            font-family: var(--font-ui);
            font-size: 13px;
            color: var(--text-muted);
        }

        .nav-item {
            margin-bottom: 4px;
        }

        .nav-link {
            display: block;
            padding: 4px 8px;
            text-decoration: none;
            color: inherit;
            border-radius: 4px;
            transition: color 0.2s;
        }

        .nav-link:hover {
            color: var(--text-main);
            background: #f0f0f0;
        }

        .nav-section-label {
            margin-top: 16px;
            margin-bottom: 8px;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.05em;
            color: var(--text-main);
            padding-left: 8px;
        }

        /* PAPER CONTENT COLUMN */
        .paper-column {
            flex: 1;
            min-width: 0;
        }

        /* * QUESTION STRUCTURE */
        .q-block {
            margin-bottom: 64px;
            position: relative;
        }

        .q-block.depth-1 {
            margin-left: 0;
        }

        .q-block.depth-2 {
            margin-left: 32px;
            margin-bottom: 40px;
        }

        .q-block.depth-3 {
            margin-left: 64px;
            margin-bottom: 32px;
        }

        .q-prompt {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 24px;
            display: flex;
            gap: 12px;
        }

        .q-number {
            font-weight: 700;
            min-width: 24px;
        }

        /* Diagrams */
        .diagram-container {
            margin: 24px 0;
            padding: 16px;
            background: #fafafa;
            display: flex;
            justify-content: center;
        }

        .diagram-svg {
            max-width: 100%;
            height: auto;
            stroke: #333;
            fill: none;
            stroke-width: 2;
        }

        /* Answers */
        .q-answer-section {
            font-family: var(--font-ui);
            font-weight: 600;
            padding-left: 36px;
            margin-bottom: 16px;
            color: var(--text-main);
            display: flex;
            align-items: baseline;
            gap: 12px;
        }

        .answer-label {
            text-transform: uppercase;
            font-size: 11px;
            color: var(--text-muted);
            letter-spacing: 0.05em;
        }

        /* Workings Controls */
        .working-toggle-btn {
            background: none;
            border: none;
            padding: 0;
            margin-left: 36px;
            font-family: var(--font-ui);
            font-size: 13px;
            color: var(--text-muted);
            text-decoration: underline;
            cursor: pointer;
            margin-bottom: 12px;
            display: inline-block;
        }

        .working-toggle-btn:hover {
            color: var(--text-main);
        }

        /* Workings Container */
        .q-working {
            padding-left: 36px;
            color: var(--text-muted);
            font-size: 16px;
            overflow: hidden;
        }

        .q-working.collapsed {
            display: none;
        }

        /* * KaTeX OVERRIDES */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            padding: 0.5em 0;
            margin: 1em 0;
            -webkit-overflow-scrolling: touch;
            max-width: 100%;
        }

        .katex-display::-webkit-scrollbar {
            height: 6px;
        }

        .katex-display::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 3px;
        }

        /* ERROR STATE */
        .error-banner {
            background: #ffebee;
            color: #c62828;
            padding: 16px;
            border: 1px solid #ef9a9a;
            margin-bottom: 24px;
            display: none;
            font-family: var(--font-ui);
        }

        /* * RESPONSIVE MOBILE */
        @media (max-width: 768px) {
            .layout-columns {
                flex-direction: column;
                gap: 0;
            }

            .nav-column {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                bottom: 0;
                width: 280px;
                background: white;
                z-index: 100;
                padding: 24px;
                border-right: 1px solid var(--border-light);
                box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            }

            .nav-column.active {
                display: block;
            }

            .mobile-menu-toggle {
                display: block;
            }

            .q-block {
                margin-bottom: 48px;
            }

            .q-block.depth-2 {
                margin-left: 16px;
            }

            .q-block.depth-3 {
                margin-left: 32px;
            }

            .q-prompt {
                font-size: 16px;
            }

            .q-working,
            .q-answer-section,
            .working-toggle-btn {
                padding-left: 0;
            }

            .q-prompt {
                flex-direction: column;
                gap: 8px;
            }
        }
    </style>
</head>

<body>

    <div class="app-frame">
        <header class="top-controls">
            <div style="display: flex; align-items: center; gap: 12px;">
                <button class="mobile-menu-toggle" id="menuToggle" aria-label="Toggle Navigation">☰ Qs</button>
                <span style="font-weight: 600; font-size: 14px;">RTQ Viewer</span>
                <span id="loading-indicator"
                    style="font-size: 12px; color: var(--text-faint); margin-left: 12px;">Loading...</span>
            </div>

            <select id="paperSelector" class="paper-selector">
                <option value="short">Short Paper (6 Qs)</option>
                <option value="standard">Standard Paper (35 Qs)</option>
                <option value="diagrams">Diagram Heavy (20 Qs)</option>
                <option value="sectioned">Sectioned Paper (Original)</option>
                <option value="expanded">Stress Test: Workings Expanded</option>
            </select>
        </header>

        <div id="errorBanner" class="error-banner"></div>

        <div class="layout-columns">
            <nav class="nav-column" id="navRail">
            </nav>

            <main class="paper-column" id="paperContent">
            </main>
        </div>
    </div>

    <div id="mobileBackdrop"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.3); z-index:99;"
        onclick="toggleMobileNav()"></div>

    <script>
        (function () {

            // SVG Templates
            const SVGS = {
                geometry: `<svg viewBox="0 0 200 150" class="diagram-svg"><path d="M20,130 L100,20 L180,130 Z" stroke="currentColor" fill="none"/><circle cx="100" cy="90" r="30" stroke="currentColor" stroke-dasharray="4"/><text x="90" y="80" font-size="12" fill="#333">x°</text></svg>`,
                bar: `<svg viewBox="0 0 200 100" class="diagram-svg"><rect x="20" y="20" width="40" height="60" fill="#e0e0e0"/><rect x="80" y="40" width="40" height="40" fill="#bbb"/><rect x="140" y="10" width="40" height="70" fill="#999"/><line x1="20" y1="80" x2="180" y2="80" stroke="#333"/></svg>`,
                grid: `<svg viewBox="0 0 150 150" class="diagram-svg"><defs><pattern id="grid" width="15" height="15" patternUnits="userSpaceOnUse"><path d="M 15 0 L 0 0 0 15" fill="none" stroke="#ddd" stroke-width="1"/></pattern></defs><rect width="100%" height="100%" fill="url(#grid)" /><line x1="10" y1="140" x2="140" y2="10" stroke="#333" stroke-width="2"/><circle cx="75" cy="75" r="4" fill="#333"/></svg>`,
                table: `<svg viewBox="0 0 200 100" class="diagram-svg"><rect x="10" y="10" width="180" height="80" fill="none" stroke="#333"/><line x1="10" y1="40" x2="190" y2="40" stroke="#333"/><line x1="70" y1="10" x2="70" y2="90" stroke="#333"/><text x="20" y="30" font-size="12">Item</text><text x="80" y="30" font-size="12">Cost</text><text x="20" y="70" font-size="12">Apple</text><text x="80" y="70" font-size="12">50p</text></svg>`
            };

            // Math Content Generator
            function getWorkingContent(lengthMode, questionId) {
                let latex = "";
                const steps = [
                    String.raw`Let\ x\ be\ the\ unknown\ quantity.`,
                    String.raw`We\ know\ that\ 3x + 15 = 4(x - 5)`,
                    String.raw`Expand\ the\ brackets:\ 3x + 15 = 4x - 20`,
                    String.raw`Rearrange\ terms:\ 15 + 20 = 4x - 3x`,
                    String.raw`x = 35`
                ];

                if (lengthMode === 'short') {
                    latex += steps.map(s => `$$ ${s} $$`).join('\n');
                } else if (lengthMode === 'long') {
                    latex += `$$ \\text{Let us define the sequence } S_n \\text{ such that...} $$\n`;
                    for (let i = 1; i <= 8; i++) {
                        latex += `$$ \\begin{aligned} S_${i} &= \\frac{${i}^2 + 3}{2} \\\\ &= \\frac{${i * i + 3}}{2} \\end{aligned} $$\n`;
                    }
                    latex += `$$ \\sum_{i=1}^{n} i^2 = \\frac{n(n+1)(2n+1)}{6} $$\n`;
                } else if (lengthMode === 'extreme') {
                    latex += `$$ \\text{Beginning complex derivation for Question ${questionId}...} $$\n`;
                    for (let i = 1; i <= 50; i++) {
                        latex += `$$ \\Delta_{${i}} = \\int_{0}^{\\infty} e^{-x} x^{${i}} dx = ${i}! $$\n`;
                    }
                }
                return latex;
            }

            // Dataset Generator
            function generateData(type) {
                const questions = [];

                // --- FIX IS HERE: FORCE STRING CONVERSION ---
                const createQ = (label, depth, hasDiagram, mathLen, expanded = false, section = null) => {
                    const labelStr = String(label); // Ensure label is a string
                    return {
                        id: `q-${labelStr.replace(/\./g, '-')}`, // safe replace
                        label: labelStr,
                        depth: depth,
                        hasDiagram: hasDiagram,
                        mathLen: mathLen,
                        expanded: expanded,
                        section: section,
                        prompt: `Calculate the value required for this component given the constraints.`,
                        answer: `x = ${(Math.random() * 100).toFixed(2)}`
                    };
                };

                if (type === 'short') {
                    for (let i = 1; i <= 4; i++) questions.push(createQ(i, 1, false, 'short'));
                    questions.push(createQ('5a', 2, true, 'short'));
                    questions.push(createQ('5b', 2, false, 'short'));
                    questions.push(createQ('6', 1, false, 'short'));
                }
                else if (type === 'standard' || type === 'expanded') {
                    const isExp = type === 'expanded';
                    for (let i = 1; i <= 25; i++) questions.push(createQ(i, 1, i % 10 === 0, 'short', isExp));
                    for (let i = 26; i <= 35; i++) questions.push(createQ(i, 1, false, 'long', isExp));
                    questions.push(createQ('30a', 2, false, 'short', isExp));
                    questions.push(createQ('30b', 2, false, 'long', isExp));
                    questions.push(createQ('30b(i)', 3, false, 'short', isExp));
                    questions.push(createQ('30b(ii)', 3, false, 'extreme', isExp));
                }
                else if (type === 'diagrams') {
                    for (let i = 1; i <= 20; i++) questions.push(createQ(i, 1, i <= 8, 'short'));
                }
                else if (type === 'sectioned') {
                    for (let i = 1; i <= 35; i++) questions.push(createQ(i, 1, false, 'short', false, i === 1 ? 'Section A' : null));
                    for (let i = 1; i <= 8; i++) questions.push(createQ(`B${i}`, 1, true, 'short', false, i === 1 ? 'Section B' : null));
                    for (let i = 1; i <= 6; i++) questions.push(createQ(`C${i}`, 1, false, 'extreme', false, i === 1 ? 'Section C' : null));
                }
                return questions;
            }

            // Safe KaTeX Renderer
            function safeRender(tex, element, options) {
                if (typeof katex !== 'undefined') {
                    try {
                        katex.render(tex, element, options);
                    } catch (err) {
                        console.error("KaTeX Error:", err);
                        element.textContent = tex;
                        element.style.fontFamily = "monospace";
                    }
                } else {
                    element.textContent = tex;
                    element.style.color = "#555";
                    element.style.fontStyle = "italic";
                }
            }

            // Main Render Function
            function renderPaper(datasetType) {
                try {
                    const paperContent = document.getElementById('paperContent');
                    const navRail = document.getElementById('navRail');

                    // Clear
                    paperContent.innerHTML = '';
                    navRail.innerHTML = '<ul class="nav-list"></ul>';
                    const navList = navRail.querySelector('ul');

                    const data = generateData(datasetType);
                    const diagKeys = Object.keys(SVGS);

                    data.forEach((q, index) => {
                        // 1. Navigation
                        if (q.section) {
                            const secHeader = document.createElement('div');
                            secHeader.className = 'nav-section-label';
                            secHeader.textContent = q.section;
                            navList.appendChild(secHeader);
                        }
                        const navItem = document.createElement('li');
                        navItem.className = 'nav-item';
                        const navLink = document.createElement('a');
                        navLink.className = 'nav-link';
                        navLink.href = `#${q.id}`;
                        navLink.textContent = q.label;
                        navLink.onclick = (e) => {
                            e.preventDefault();
                            document.getElementById(q.id).scrollIntoView({ behavior: 'smooth', block: 'start' });
                            if (window.innerWidth < 768) toggleMobileNav();
                        };
                        navItem.appendChild(navLink);
                        navList.appendChild(navItem);

                        // 2. Content Block
                        const qBlock = document.createElement('div');
                        qBlock.className = `q-block depth-${q.depth}`;
                        qBlock.id = q.id;

                        // Prompt
                        const promptDiv = document.createElement('div');
                        promptDiv.className = 'q-prompt';
                        promptDiv.innerHTML = `<span class="q-number">${q.label}</span><span>${q.prompt}</span>`;
                        qBlock.appendChild(promptDiv);

                        // Diagram
                        if (q.hasDiagram) {
                            const dDiv = document.createElement('div');
                            dDiv.className = 'diagram-container';
                            dDiv.innerHTML = SVGS[diagKeys[index % diagKeys.length]];
                            qBlock.appendChild(dDiv);
                        }

                        // Answer
                        const ansDiv = document.createElement('div');
                        ansDiv.className = 'q-answer-section';
                        const ansLabel = document.createElement('span');
                        ansLabel.className = 'answer-label';
                        ansLabel.textContent = 'Answer';
                        const ansValue = document.createElement('span');
                        safeRender(q.answer, ansValue, { throwOnError: false });

                        ansDiv.appendChild(ansLabel);
                        ansDiv.appendChild(ansValue);
                        qBlock.appendChild(ansDiv);

                        // Toggle
                        const toggleBtn = document.createElement('button');
                        toggleBtn.className = 'working-toggle-btn';
                        toggleBtn.textContent = q.expanded ? 'Hide working' : 'Show working';
                        toggleBtn.onclick = () => {
                            const wDiv = qBlock.querySelector('.q-working');
                            wDiv.classList.toggle('collapsed');
                            toggleBtn.textContent = wDiv.classList.contains('collapsed') ? 'Show working' : 'Hide working';
                        };
                        qBlock.appendChild(toggleBtn);

                        // Working
                        const workDiv = document.createElement('div');
                        workDiv.className = `q-working ${q.expanded ? '' : 'collapsed'}`;

                        const rawLatex = getWorkingContent(q.mathLen, q.id);
                        // Simple parser
                        const parts = rawLatex.split('$$');
                        parts.forEach((part, i) => {
                            if (part.trim() === '') return;
                            const p = document.createElement('div');
                            if (i % 2 !== 0) { // Math block
                                safeRender(part, p, { displayMode: true, throwOnError: false });
                            } else {
                                p.textContent = part;
                            }
                            workDiv.appendChild(p);
                        });

                        qBlock.appendChild(workDiv);
                        paperContent.appendChild(qBlock);
                    });

                    document.getElementById('loading-indicator').style.display = 'none';

                } catch (error) {
                    console.error(error);
                    document.getElementById('errorBanner').style.display = 'block';
                    document.getElementById('errorBanner').textContent = 'Error rendering paper: ' + error.message;
                }
            }

            // Global Event Handlers
            window.toggleMobileNav = function () {
                const navRail = document.getElementById('navRail');
                const mobileBackdrop = document.getElementById('mobileBackdrop');
                const isOpen = navRail.classList.contains('active');
                if (isOpen) {
                    navRail.classList.remove('active');
                    mobileBackdrop.style.display = 'none';
                } else {
                    navRail.classList.add('active');
                    mobileBackdrop.style.display = 'block';
                }
            };

            // Initialize when DOM is ready
            window.addEventListener('load', () => {
                const selector = document.getElementById('paperSelector');
                if (selector) {
                    selector.addEventListener('change', (e) => {
                        renderPaper(e.target.value);
                        window.scrollTo(0, 0);
                    });
                    // Initial Render
                    renderPaper('short');
                }
            });

        })();
    </script>

</body>

</html>