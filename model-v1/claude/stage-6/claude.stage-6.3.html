<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RTQ â€“ Maths Paper Solution Viewer</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
<style>
*, *::before, *::after {
  box-sizing: border-box;
}

:root {
  --warmth-base: hsl(30, 8%, 96%);
  --warmth-paper: hsl(30, 10%, 99%);
  --warmth-solution: hsl(30, 8%, 97%);
  
  --text-question: hsl(30, 5%, 15%);
  --text-answer: hsl(30, 4%, 30%);
  --text-solution: hsl(30, 3%, 40%);
  --text-nav: hsl(30, 3%, 50%);
  
  --line-subtle: hsl(30, 5%, 85%);
  --line-quieter: hsl(30, 4%, 90%);
  
  --accent: hsl(210, 60%, 45%);
  
  --space-question-gap: 4rem;
  --space-answer-gap: 1.25rem;
  --space-solution-gap: 0.75rem;
  --space-subsection-gap: 1rem;
  --space-working-internal: 0.5rem;
}

body {
  margin: 0;
  padding: 0;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
  font-size: 16px;
  line-height: 1.6;
  color: var(--text-question);
  background: var(--warmth-base);
  -webkit-font-smoothing: antialiased;
}

.page-shell {
  max-width: 1200px;
  margin: 0 auto;
  padding: 2rem 1.5rem;
}

.top-controls {
  margin-bottom: 2rem;
  padding-bottom: 1rem;
  border-bottom: 1px solid var(--line-subtle);
}

.paper-selector-label {
  font-size: 0.875rem;
  color: var(--text-solution);
  margin-bottom: 0.5rem;
  display: block;
}

.paper-selector {
  padding: 0.5rem 0.75rem;
  font-size: 1rem;
  border: 1px solid var(--line-subtle);
  border-radius: 4px;
  background: var(--warmth-paper);
  color: var(--text-question);
  font-family: inherit;
  cursor: pointer;
}

.paper-selector:focus {
  outline: 2px solid var(--accent);
  outline-offset: 2px;
}

.content-frame {
  display: flex;
  gap: 3rem;
  align-items: flex-start;
  background: var(--warmth-paper);
  padding: 2rem;
  min-height: 60vh;
}

.navigation-rail {
  position: sticky;
  top: 2rem;
  flex-shrink: 0;
  width: 140px;
  max-height: calc(100vh - 4rem);
  overflow-y: auto;
  scrollbar-width: none;
  -ms-overflow-style: none;
}

.navigation-rail::-webkit-scrollbar {
  display: none;
}

.nav-list {
  list-style: none;
  padding: 0;
  margin: 0;
}

.nav-item {
  margin-bottom: 0.25rem;
}

.nav-link {
  display: block;
  padding: 0.375rem 0.5rem;
  font-size: 0.875rem;
  color: var(--text-nav);
  text-decoration: none;
  cursor: pointer;
  transition: color 0.15s ease;
}

.nav-link:hover {
  color: var(--text-solution);
}

.nav-link:focus {
  outline: 2px solid var(--accent);
  outline-offset: 2px;
  border-radius: 2px;
}

.nav-link.active {
  font-weight: 600;
  color: var(--text-answer);
}

.nav-section-label {
  font-size: 0.875rem;
  color: var(--text-solution);
  font-weight: 600;
  margin: 1rem 0 0.5rem 0;
  padding-left: 0.5rem;
}

.paper-content {
  flex: 1;
  min-width: 0;
}

.paper-title {
  font-size: 1.125rem;
  font-weight: 600;
  color: var(--text-question);
  margin: 0 0 2rem 0;
}

.question-block {
  margin-bottom: var(--space-question-gap);
}

.question-block.nested-1 {
  margin-left: 1.5rem;
  margin-bottom: calc(var(--space-question-gap) * 0.7);
}

.question-block.nested-2 {
  margin-left: 3rem;
  margin-bottom: calc(var(--space-question-gap) * 0.5);
}

.question-block.nested-3 {
  margin-left: 4.5rem;
  margin-bottom: calc(var(--space-question-gap) * 0.4);
}

.question-header {
  font-size: 1.125rem;
  line-height: 1.7;
  color: var(--text-question);
  margin-bottom: var(--space-answer-gap);
}

.question-id {
  font-weight: 600;
  margin-right: 0.5rem;
}

.question-prompt {
  display: inline;
}

.question-prompt p:first-child {
  display: inline;
}

.question-prompt p {
  margin: 0.75rem 0;
}

.answer-block {
  margin-bottom: var(--space-solution-gap);
  color: var(--text-answer);
  font-size: 1rem;
  line-height: 1.6;
}

.answer-label {
  font-weight: 600;
  margin-right: 0.5rem;
}

.answer-value {
  display: inline;
}

.answer-value p:first-child {
  display: inline;
}

.answer-value p {
  margin: 0.5rem 0;
}

.solution-toggle {
  background: none;
  border: none;
  padding: 0.375rem 0.5rem 0.375rem 0;
  font-size: 0.9375rem;
  color: var(--accent);
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 0.375rem;
  font-family: inherit;
  transition: color 0.15s ease;
}

.solution-toggle:hover {
  color: hsl(210, 60%, 35%);
}

.solution-toggle:focus {
  outline: 2px solid var(--accent);
  outline-offset: 2px;
  border-radius: 2px;
}

.chevron {
  display: inline-block;
  width: 0.5rem;
  height: 0.5rem;
  border-right: 2px solid currentColor;
  border-bottom: 2px solid currentColor;
  transform: rotate(45deg);
  transition: transform 0.2s ease;
}

.solution-toggle[aria-expanded="true"] .chevron {
  transform: rotate(-135deg);
}

.solution-details {
  margin-top: var(--space-solution-gap);
  padding: 1.25rem 1.5rem;
  background: var(--warmth-solution);
  border-top: 1px solid var(--line-subtle);
  color: var(--text-solution);
  font-size: 0.9375rem;
  line-height: 1.65;
}

.solution-details[hidden] {
  display: none;
}

.keep-in-mind {
  margin-bottom: var(--space-subsection-gap);
  color: var(--text-answer);
}

.keep-in-mind-label {
  font-weight: 600;
  display: block;
  margin-bottom: 0.5rem;
}

.keep-in-mind-body ul {
  margin: 0;
  padding-left: 1.5rem;
}

.keep-in-mind-body li {
  margin-bottom: 0.375rem;
}

.formulas-used {
  margin-bottom: var(--space-subsection-gap);
  padding-bottom: var(--space-subsection-gap);
  border-bottom: 1px solid var(--line-quieter);
}

.formulas-used-label {
  font-weight: 600;
  display: block;
  margin-bottom: 0.5rem;
}

.formulas-used-body p {
  margin: 0.375rem 0;
}

.working-block {
  margin-bottom: var(--space-subsection-gap);
}

.working-label {
  font-weight: 600;
  display: block;
  margin-bottom: 0.75rem;
}

.working-body p {
  margin: var(--space-working-internal) 0;
}

.working-body .katex-display {
  margin: 0.75rem 0;
  padding: 0.5rem 0.75rem;
  background: hsl(30, 6%, 95%);
  overflow-x: auto;
  scrollbar-width: thin;
}

.working-body .katex-display::-webkit-scrollbar {
  height: 6px;
}

.working-body .katex-display::-webkit-scrollbar-thumb {
  background: var(--line-subtle);
  border-radius: 3px;
}

.working-body table {
  border-collapse: collapse;
  margin: 0.75rem 0;
  width: 100%;
  max-width: 100%;
}

.working-body th,
.working-body td {
  border: 1px solid var(--line-quieter);
  padding: 0.5rem 0.75rem;
  text-align: left;
}

.working-body th {
  font-weight: 600;
}

.alternative-working {
  margin-top: var(--space-subsection-gap);
  padding-top: var(--space-subsection-gap);
  border-top: 1px solid var(--line-quieter);
}

.alternative-label {
  font-weight: 600;
  display: block;
  margin-bottom: 0.75rem;
}

.alternative-body p {
  margin: var(--space-working-internal) 0;
}

.alternative-body .katex-display {
  margin: 0.75rem 0;
  padding: 0.5rem 0.75rem;
  background: hsl(30, 6%, 95%);
  overflow-x: auto;
  scrollbar-width: thin;
}

.payload-error {
  padding: 3rem 2rem;
  text-align: center;
  color: var(--text-solution);
  font-size: 1.125rem;
}

.mobile-nav-toggle {
  display: none;
}

@media (max-width: 768px) {
  .page-shell {
    padding: 1rem;
  }
  
  .content-frame {
    flex-direction: column;
    padding: 1.5rem 1rem;
    gap: 0;
  }
  
  .navigation-rail {
    position: fixed;
    top: 0;
    left: 0;
    width: 280px;
    height: 100vh;
    background: var(--warmth-paper);
    border-right: 1px solid var(--line-subtle);
    padding: 1.5rem;
    transform: translateX(-100%);
    transition: transform 0.3s ease;
    z-index: 1000;
    max-height: 100vh;
  }
  
  .navigation-rail.open {
    transform: translateX(0);
  }
  
  .mobile-nav-toggle {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    background: none;
    border: none;
    padding: 0.5rem 0.75rem;
    font-size: 0.9375rem;
    color: var(--accent);
    cursor: pointer;
    margin-bottom: 1rem;
    font-family: inherit;
  }
  
  .mobile-nav-toggle:focus {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
    border-radius: 2px;
  }
  
  .nav-backdrop {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: hsla(0, 0%, 0%, 0.3);
    z-index: 999;
  }
  
  .nav-backdrop.visible {
    display: block;
  }
  
  .question-block.nested-1 {
    margin-left: 1rem;
  }
  
  .question-block.nested-2 {
    margin-left: 2rem;
  }
  
  .question-block.nested-3 {
    margin-left: 3rem;
  }
}

@media (prefers-reduced-motion: reduce) {
  *, *::before, *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
}
</style>
</head>
<body>

<div class="page-shell">
  <div class="top-controls">
    <label class="paper-selector-label">Select paper:</label>
    <select class="paper-selector" id="paperSelector">
      <option value="">Loading...</option>
    </select>
  </div>
  
  <div class="content-frame">
    <nav class="navigation-rail" id="navigation" aria-label="Question navigation">
      <ul class="nav-list" id="navList"></ul>
    </nav>
    
    <main class="paper-content">
      <button class="mobile-nav-toggle" id="mobileNavToggle" aria-label="Open navigation">
        <span class="chevron" style="transform: rotate(-45deg);"></span>
        <span>Jump to</span>
      </button>
      
      <div id="paperContainer"></div>
    </main>
  </div>
</div>

<div class="nav-backdrop" id="navBackdrop"></div>

<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

<script>
const RTQ_PAPERS_PAYLOAD_PATH = "../../payload/rtq.papers.payload.json";

const md = window.markdownit ? window.markdownit({
  html: true,
  linkify: true,
  breaks: false
}) : null;

if (md) {
  md.inline.ruler.disable(['escape']);
}

let payload = null;
let currentPaper = null;

function renderMarkdown(content) {
  if (!md || !content) return '';
  return md.render(content);
}

function renderKaTeX(element) {
  if (!window.renderMathInElement) return;
  try {
    renderMathInElement(element, {
      delimiters: [
        {left: '$$', right: '$$', display: true},
        {left: '$', right: '$', display: false}
      ],
      throwOnError: false
    });
  } catch (e) {
    console.error('KaTeX rendering error:', e);
  }
}

function buildNavigation(paper) {
  const navList = document.getElementById('navList');
  navList.innerHTML = '';
  
  if (paper.sections) {
    paper.sections.forEach(section => {
      const sectionLabel = document.createElement('div');
      sectionLabel.className = 'nav-section-label';
      sectionLabel.textContent = section.label;
      navList.appendChild(sectionLabel);
      
      section.questions.forEach(q => addNavItem(navList, q, 0));
    });
  } else if (paper.questions) {
    paper.questions.forEach(q => addNavItem(navList, q, 0));
  }
}

function addNavItem(parent, question, depth) {
  const li = document.createElement('li');
  li.className = 'nav-item';
  
  const link = document.createElement('a');
  link.className = 'nav-link';
  link.href = `#q-${question.id}`;
  link.textContent = question.id;
  link.style.paddingLeft = `${0.5 + depth * 0.75}rem`;
  link.dataset.questionId = question.id;
  
  link.addEventListener('click', (e) => {
    e.preventDefault();
    const target = document.getElementById(`q-${question.id}`);
    if (target) {
      target.scrollIntoView({ behavior: 'smooth', block: 'start' });
      updateActiveNav(question.id);
    }
  });
  
  li.appendChild(link);
  parent.appendChild(li);
  
  if (question.children && question.children.length > 0) {
    question.children.forEach(child => addNavItem(parent, child, depth + 1));
  }
}

function updateActiveNav(questionId) {
  document.querySelectorAll('.nav-link').forEach(link => {
    link.classList.remove('active');
    if (link.dataset.questionId === questionId) {
      link.classList.add('active');
    }
  });
}

function renderQuestion(question, depth = 0) {
  const block = document.createElement('div');
  block.className = `question-block${depth > 0 ? ` nested-${Math.min(depth, 3)}` : ''}`;
  block.id = `q-${question.id}`;
  
  const header = document.createElement('div');
  header.className = 'question-header';
  
  const idSpan = document.createElement('span');
  idSpan.className = 'question-id';
  idSpan.textContent = question.id;
  
  const promptSpan = document.createElement('span');
  promptSpan.className = 'question-prompt';
  promptSpan.innerHTML = renderMarkdown(question.question);
  
  header.appendChild(idSpan);
  header.appendChild(promptSpan);
  block.appendChild(header);
  
  if (question.answer) {
    const answerBlock = document.createElement('div');
    answerBlock.className = 'answer-block';
    
    const answerLabel = document.createElement('span');
    answerLabel.className = 'answer-label';
    answerLabel.textContent = 'Answer';
    
    const answerValue = document.createElement('span');
    answerValue.className = 'answer-value';
    answerValue.innerHTML = renderMarkdown(question.answer);
    
    answerBlock.appendChild(answerLabel);
    answerBlock.appendChild(answerValue);
    block.appendChild(answerBlock);
  }
  
  if (question.solutionDetails) {
    const toggle = document.createElement('button');
    toggle.className = 'solution-toggle';
    toggle.setAttribute('aria-expanded', 'false');
    
    const toggleText = document.createElement('span');
    toggleText.textContent = 'Show working';
    
    const chevron = document.createElement('span');
    chevron.className = 'chevron';
    
    toggle.appendChild(toggleText);
    toggle.appendChild(chevron);
    
    const details = document.createElement('div');
    details.className = 'solution-details';
    details.setAttribute('hidden', '');
    
    const sd = question.solutionDetails;
    
    if (sd.keepInMind) {
      const kim = document.createElement('div');
      kim.className = 'keep-in-mind';
      
      const label = document.createElement('div');
      label.className = 'keep-in-mind-label';
      label.textContent = 'Keep in mind';
      
      const body = document.createElement('div');
      body.className = 'keep-in-mind-body';
      body.innerHTML = renderMarkdown(sd.keepInMind);
      
      kim.appendChild(label);
      kim.appendChild(body);
      details.appendChild(kim);
    }
    
    if (sd.formulasUsed) {
      const formulas = document.createElement('div');
      formulas.className = 'formulas-used';
      
      const label = document.createElement('div');
      label.className = 'formulas-used-label';
      label.textContent = 'Formulas used';
      
      const body = document.createElement('div');
      body.className = 'formulas-used-body';
      body.innerHTML = renderMarkdown(sd.formulasUsed);
      
      formulas.appendChild(label);
      formulas.appendChild(body);
      details.appendChild(formulas);
    }
    
    if (sd.working) {
      const working = document.createElement('div');
      working.className = 'working-block';
      
      const label = document.createElement('div');
      label.className = 'working-label';
      label.textContent = 'Working';
      
      const body = document.createElement('div');
      body.className = 'working-body';
      body.innerHTML = renderMarkdown(sd.working);
      
      working.appendChild(label);
      working.appendChild(body);
      details.appendChild(working);
    }
    
    if (sd.alternativeWorking) {
      const alt = document.createElement('div');
      alt.className = 'alternative-working';
      
      const label = document.createElement('div');
      label.className = 'alternative-label';
      label.textContent = 'Alternative working';
      
      const body = document.createElement('div');
      body.className = 'alternative-body';
      body.innerHTML = renderMarkdown(sd.alternativeWorking);
      
      alt.appendChild(label);
      alt.appendChild(body);
      details.appendChild(alt);
    }
    
    toggle.addEventListener('click', () => {
      const isExpanded = toggle.getAttribute('aria-expanded') === 'true';
      toggle.setAttribute('aria-expanded', !isExpanded);
      toggleText.textContent = isExpanded ? 'Show working' : 'Hide working';
      
      if (isExpanded) {
        details.setAttribute('hidden', '');
      } else {
        details.removeAttribute('hidden');
      }
    });
    
    block.appendChild(toggle);
    block.appendChild(details);
    
    if (currentPaper?.defaults?.expandedAll) {
      toggle.click();
    }
  }
  
  renderKaTeX(block);
  
  if (question.children && question.children.length > 0) {
    question.children.forEach(child => {
      block.appendChild(renderQuestion(child, depth + 1));
    });
  }
  
  return block;
}

function renderPaper(paper) {
  currentPaper = paper;
  const container = document.getElementById('paperContainer');
  container.innerHTML = '';
  
  if (paper.sections) {
    paper.sections.forEach(section => {
      section.questions.forEach(q => {
        container.appendChild(renderQuestion(q, 0));
      });
    });
  } else if (paper.questions) {
    paper.questions.forEach(q => {
      container.appendChild(renderQuestion(q, 0));
    });
  }
  
  buildNavigation(paper);
}

function loadPayload() {
  fetch(RTQ_PAPERS_PAYLOAD_PATH)
    .then(response => {
      if (!response.ok) throw new Error('Payload not found');
      return response.json();
    })
    .then(data => {
      payload = data;
      
      const selector = document.getElementById('paperSelector');
      selector.innerHTML = '';
      
      payload.papers.forEach((paper, index) => {
        const option = document.createElement('option');
        option.value = paper.key;
        option.textContent = paper.label;
        selector.appendChild(option);
      });
      
      if (payload.papers.length > 0) {
        selector.value = payload.papers[0].key;
        renderPaper(payload.papers[0]);
      }
      
      selector.addEventListener('change', (e) => {
        const paper = payload.papers.find(p => p.key === e.target.value);
        if (paper) renderPaper(paper);
      });
    })
    .catch(error => {
      console.error('Failed to load payload:', error);
      document.getElementById('paperContainer').innerHTML = 
        '<div class="payload-error">PAPERS PAYLOAD MISSING</div>';
    });
}

const mobileToggle = document.getElementById('mobileNavToggle');
const nav = document.getElementById('navigation');
const backdrop = document.getElementById('navBackdrop');

mobileToggle.addEventListener('click', () => {
  nav.classList.add('open');
  backdrop.classList.add('visible');
});

backdrop.addEventListener('click', () => {
  nav.classList.remove('open');
  backdrop.classList.remove('visible');
});

document.addEventListener('DOMContentLoaded', loadPayload);
</script>

</body>
</html>