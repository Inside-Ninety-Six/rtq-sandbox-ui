<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Paper Viewer</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <style>
        /* =========================================
           STAGE 4/5: DESIGN SYSTEM & VARIABLES
           ========================================= */
        :root {
            /* Palette - Warm Neutral Base (Stage 5.3) */
            --c-bg-app: #FDFBF9;
            /* Soft-warm paper base */
            --c-bg-surface: #FDFBF9;
            --c-text-primary: #171717;
            /* High contrast but not pure black */
            --c-text-secondary: #454545;
            /* Subordinate but legible (Anti-fade guardrail) */
            --c-text-tertiary: #666666;
            /* Navigation/Labels */

            /* Accent (Stage 5 Override - Scoped: Links, Focus, Nav Marker) */
            --c-accent: #2563EB;

            /* Spacing (Stage 3 Rhythms) */
            --sp-xs: 0.25rem;
            --sp-sm: 0.5rem;
            --sp-md: 1rem;
            --sp-lg: 1.5rem;
            --sp-xl: 2.5rem;
            --sp-xxl: 4rem;
            /* Top level separation */

            /* Typography (Stage 4.8) */
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --font-size-base: 16px;
            --line-height-base: 1.5;
            --line-height-tight: 1.4;

            /* Dimensions */
            --nav-width: 240px;
            --shell-max-width: 1024px;
            --header-height: 60px;
        }

        /* Reset & Base */
        *,
        *::before,
        *::after {
            box-sizing: border-box;
            /* border: solid 1px gray; */
        }

        body {
            margin: 0;
            padding: 0;
            font-family: var(--font-family);
            background-color: var(--c-bg-app);
            color: var(--c-text-primary);
            line-height: var(--line-height-base);
            font-size: var(--font-size-base);
            -webkit-font-smoothing: antialiased;
        }

        /* Focus Styles (Stage 5.5.2) */
        :focus-visible {
            outline: 2px solid var(--c-accent);
            outline-offset: 2px;
        }

        /* =========================================
           STAGE 3: LAYOUT ARCHITECTURE
           ========================================= */

        /* App Wrapper */
        .app-shell {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Top Controls (Aligned to shell) */
        .top-controls {
            position: sticky;
            top: 0;
            z-index: 20;
            background-color: var(--c-bg-app);
            /* Matches paper surface */
            padding: var(--sp-md) var(--sp-lg);
            border-bottom: 1px solid transparent;
            /* Placeholder for optional divider */
        }

        .top-controls-inner {
            max-width: var(--shell-max-width);
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        /* DocumentFrameShell */
        .document-frame {
            display: flex;
            flex: 1;
            max-width: var(--shell-max-width);
            margin: 0 auto;
            width: 100%;
            padding: 0 var(--sp-lg);
            /* Inner gutters */
            position: relative;
        }

        /* Navigation Rail (Desktop) */
        .nav-rail {
            width: var(--nav-width);
            flex-shrink: 0;
            position: sticky;
            top: var(--header-height);
            /* Below header */
            height: calc(100vh - var(--header-height));
            overflow-y: auto;
            padding-right: var(--sp-md);
            padding-top: var(--sp-lg);
            display: none;
            /* Mobile default */
            /* Scrollbar hiding (Add-on) */
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .nav-rail::-webkit-scrollbar {
            display: none;
        }

        /* Paper Content Region */
        .paper-content {
            flex: 1;
            min-width: 0;
            /* Prevent flex overflow */
            padding-top: var(--sp-lg);
            padding-bottom: var(--sp-xxl);
        }

        /* Desktop Layout Enable */
        @media (min-width: 768px) {
            .nav-rail {
                display: block;
            }

            .paper-content {
                padding-left: var(--sp-xxl);
            }

            .mobile-trigger {
                display: none;
            }
        }

        /* Mobile Drawer (Stage 3/6) */
        .mobile-drawer-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 50;
            display: none;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .mobile-drawer-overlay.open {
            display: block;
            opacity: 1;
        }

        .mobile-drawer {
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            width: 85%;
            max-width: 320px;
            background: var(--c-bg-surface);
            z-index: 51;
            transform: translateX(-100%);
            transition: transform 0.2s ease;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 12px rgba(0, 0, 0, 0.1);
        }

        .mobile-drawer.open {
            transform: translateX(0);
        }

        .drawer-header {
            padding: var(--sp-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .drawer-content {
            flex: 1;
            overflow-y: auto;
            padding: var(--sp-md);
        }

        /* =========================================
           NAVIGATION COMPONENTS
           ========================================= */
        .nav-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .nav-section-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--c-text-tertiary);
            margin-top: var(--sp-lg);
            margin-bottom: var(--sp-sm);
            font-weight: 600;
            pointer-events: none;
            /* Non-clickable */
        }

        .nav-item {
            display: block;
            padding: var(--sp-xs) 0;
            color: var(--c-text-tertiary);
            text-decoration: none;
            cursor: pointer;
            transition: color 0.1s ease;
            font-size: 0.9rem;
            /* Flat list visual - hierarchy via scale logic handled in render */
        }

        .nav-item:hover {
            color: var(--c-text-primary);
            text-decoration: underline;
            text-decoration-color: var(--c-accent);
            /* Minimal hover feedback */
            text-decoration-thickness: 1px;
            text-underline-offset: 3px;
        }

        .nav-item.active {
            font-weight: 700;
            color: var(--c-text-primary);
            /* Optional accent marker allowed by Override */
            border-left: 2px solid var(--c-accent);
            padding-left: var(--sp-sm);
            margin-left: calc(-1 * var(--sp-sm) - 2px);
        }

        /* =========================================
           PAPER CONTENT STYLING
           ========================================= */

        /* Question Node */
        .question-node {
            margin-bottom: var(--sp-xxl);
            /* Top-level separation */
            scroll-margin-top: 100px;
            border: solid 1px gray;
        }

        .question-node .question-node {
            margin-bottom: var(--sp-lg);
            /* Nested separation */

        }

        /* Indentation for sub-questions (Visual only) */
        .children-container {
            margin-top: var(--sp-md);
            margin-left: 0;
            /* Base */
        }

        @media (min-width: 480px) {
            .children-container {
                margin-left: var(--sp-lg);
            }
        }

        /* Question Body */
        .question-body {
            display: flex;
            gap: var(--sp-sm);
            align-items: baseline;
            color: var(--c-text-primary);
            margin-bottom: var(--sp-md);
        }

        .q-id {
            font-weight: 700;
            flex-shrink: 0;
            color: var(--c-text-primary);
        }

        .q-text {
            flex: 1;
            /* Comfortable reading */
        }

        /* Solution Block */
        .solution-block {
            margin-top: var(--sp-md);
            padding-left: 0;
            /* Flat on mobile */
        }

        @media (min-width: 480px) {
            .solution-block {
                padding-left: var(--sp-lg);
            }

            /* Indent slightly relative to question */
        }

        /* Answer */
        .answer-region {
            margin-bottom: var(--sp-md);
        }

        .answer-label {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--c-text-tertiary);
            margin-bottom: var(--sp-xs);
            display: block;
        }

        .answer-content {
            font-weight: 500;
            color: var(--c-text-primary);
        }

        /* Disclosure Control */
        .disclosure-control {
            background: none;
            border: none;
            padding: 0;
            margin: 0;
            margin-bottom: var(--sp-md);
            font-size: 0.9rem;
            color: var(--c-accent);
            /* Allowed by Override */
            cursor: pointer;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .disclosure-control:hover {
            text-decoration: underline;
        }

        .disclosure-icon {
            transition: transform 0.2s ease;
        }

        .disclosure-control[aria-expanded="true"] .disclosure-icon {
            transform: rotate(180deg);
        }

        /* Solution Details Region */
        .solution-details {
            display: none;
            /* Collapsed */
            color: var(--c-text-secondary);
            font-size: 0.95rem;
            /* Hierarchy via size */
            line-height: var(--line-height-tight);
        }

        .solution-details.expanded {
            display: block;
            animation: reveal 0.2s ease-out;
        }

        @keyframes reveal {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Internal Subsections (Keep in mind, Formulas, Working) */
        .sd-subsection {
            margin-bottom: var(--sp-lg);
        }

        .sd-label {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--c-text-tertiary);
            margin-bottom: var(--sp-xs);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Keep in mind specific */
        .kim-block ul {
            padding-left: 1.2em;
            margin: 0;
        }

        /* Formulas used specific */
        .formulas-block {
            margin-bottom: var(--sp-lg);
        }

        /* Alternative Working Separation */
        .alt-working-separator {
            height: 1px;
            background-color: rgba(0, 0, 0, 0.08);
            /* Quiet hairline */
            margin: var(--sp-lg) 0;
            border: none;
        }

        /* =========================================
           MARKDOWN & MATH CONTENT STYLES
           ========================================= */

        /* Paragraphs */
        .md-content p {
            margin-top: 0;
            margin-bottom: 0.75em;
        }

        .md-content p:last-child {
            margin-bottom: 0;
        }

        /* Tables (Quiet) */
        .md-content table {
            width: 100%;
            border-collapse: collapse;
            margin: var(--sp-md) 0;
            font-size: 0.9em;
        }

        .md-content th,
        .md-content td {
            border: 1px solid rgba(0, 0, 0, 0.1);
            padding: var(--sp-sm);
            text-align: left;
        }

        .md-content th {
            font-weight: 600;
            background: rgba(0, 0, 0, 0.02);
            /* Very subtle */
        }

        /* Mobile table scroll wrapper handled in renderer logic or CSS if possible */
        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* KaTeX Overrides (Containment Invariant) */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            padding: 0.5em 0;
            margin: 0.5em 0;
            max-width: 100%;
            /* Minimal underlay allowed by Stage 3/5 logic if strictly block level, 
               but adhering to "transparent" default for now to be safe/calm */
        }

        /* Inline math no background */
        .katex {
            font-size: 1.1em;
        }

        /* Adjust sizing slightly */

        /* Images / SVG Passthrough */
        .md-content svg,
        .md-content img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: var(--sp-md) 0;
        }

        /* Controls UI */
        select.paper-selector {
            font-family: inherit;
            padding: var(--sp-xs) var(--sp-sm);
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 0.9rem;
            color: var(--c-text-primary);
        }

        .jump-btn {
            background: none;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: var(--sp-xs) var(--sp-sm);
            font-size: 0.9rem;
            color: var(--c-text-primary);
        }

        /* Error Message */
        .error-msg {
            color: var(--c-text-tertiary);
            font-weight: 700;
            text-align: center;
            margin-top: var(--sp-xxl);
            font-size: 1.2rem;
        }
    </style>
</head>

<body>

    <div class="app-shell" id="app">
        <header class="top-controls">
            <div class="top-controls-inner">
                <button class="jump-btn mobile-trigger" id="drawerTrigger">Jump to...</button>

                <select id="paperSelector" class="paper-selector" aria-label="Select Paper">
                    <option value="" disabled selected>Loading papers...</option>
                </select>
            </div>
        </header>

        <div class="document-frame">
            <nav class="nav-rail" id="desktopNav" aria-label="Question Navigation">
                <ul class="nav-list" id="desktopNavList"></ul>
            </nav>

            <main class="paper-content" id="paperContainer">
            </main>
        </div>

        <div class="mobile-drawer-overlay" id="drawerOverlay"></div>
        <aside class="mobile-drawer" id="mobileDrawer">
            <div class="drawer-header">
                <strong>Jump to</strong>
                <button class="jump-btn" id="drawerClose">Close</button>
            </div>
            <div class="drawer-content">
                <ul class="nav-list" id="mobileNavList"></ul>
            </div>
        </aside>
    </div>

    <script>
        // =========================================
        // STAGE 0: CONSTANTS (Canonical Path)
        // =========================================
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";

        // =========================================
        // STAGE 6: MARKDOWN RENDERER CONFIG
        // =========================================
        // "html: true" enables SVG passthrough
        // "breaks: false" prevents <br> in math blocks
        const md = window.markdownit
            ? window.markdownit({
                html: true,
                linkify: true,
                breaks: false,
            })
            : null;

        if (md) {
            // Preserve TeX backslashes: do not let markdown-it escape them before KaTeX runs
            md.inline.ruler.disable(["escape"]);
        }

        // =========================================
        // APP STATE & LOGIC
        // =========================================
        const state = {
            papers: [],
            currentPaper: null,
        };

        // DOM Elements
        const paperSelector = document.getElementById('paperSelector');
        const paperContainer = document.getElementById('paperContainer');
        const desktopNavList = document.getElementById('desktopNavList');
        const mobileNavList = document.getElementById('mobileNavList');
        const drawerTrigger = document.getElementById('drawerTrigger');
        const drawerClose = document.getElementById('drawerClose');
        const mobileDrawer = document.getElementById('mobileDrawer');
        const drawerOverlay = document.getElementById('drawerOverlay');

        // Init
        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Payload missing");
                const payload = await response.json();

                state.papers = payload.papers || [];

                if (state.papers.length === 0) {
                    renderError();
                    return;
                }

                populateSelector();
                loadPaper(state.papers[0].key);

            } catch (e) {
                console.error(e);
                renderError();
            }
        }

        function renderError() {
            paperContainer.innerHTML = '<div class="error-msg">PAPERS PAYLOAD MISSING</div>';
            paperSelector.innerHTML = '<option disabled>Error</option>';
        }

        function populateSelector() {
            paperSelector.innerHTML = '';
            state.papers.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.key;
                opt.textContent = p.label;
                paperSelector.appendChild(opt);
            });

            paperSelector.addEventListener('change', (e) => {
                loadPaper(e.target.value);
            });
        }

        function loadPaper(key) {
            const paper = state.papers.find(p => p.key === key);
            if (!paper) return;

            state.currentPaper = paper;

            // Clear Content
            paperContainer.innerHTML = '';
            desktopNavList.innerHTML = '';
            mobileNavList.innerHTML = '';

            // Determine defaults
            const expandAll = paper.defaults && paper.defaults.expandedAll === true;

            // Render Logic
            if (paper.sections) {
                // Sectioned Paper
                paper.sections.forEach(section => {
                    // Render Nav Section Label (if exists)
                    if (section.label && section.label.trim().length > 0) {
                        renderNavSectionLabel(section.label);
                    }
                    // Render Content Section Header (Optional/Stage 3 says simple list usually)
                    // But we render questions sequentially
                    renderQuestionList(section.questions, expandAll);
                });
            } else if (paper.questions) {
                // Flat Paper
                renderQuestionList(paper.questions, expandAll);
            }

            // Post-Render: KaTeX Auto-Render
            renderMathInElement(document.body, {
                delimiters: [
                    { left: '$$', right: '$$', display: true },
                    { left: '$', right: '$', display: false },
                    { left: '\\(', right: '\\)', display: false },
                    { left: '\\[', right: '\\]', display: true }
                ],
                throwOnError: false
            });

            // Reset Scroll
            window.scrollTo(0, 0);
        }

        // =========================================
        // RENDER FUNCTIONS
        // =========================================

        function renderNavSectionLabel(label) {
            // Desktop
            const liD = document.createElement('li');
            liD.className = 'nav-section-label';
            liD.textContent = label;
            desktopNavList.appendChild(liD);

            // Mobile
            const liM = liD.cloneNode(true);
            mobileNavList.appendChild(liM);
        }

        function renderQuestionList(questions, defaultExpanded) {
            questions.forEach(q => {
                // Add to Nav
                addToNav(q.id, q.id); // Simple ID mapping for jump

                // Add to Content
                const node = createQuestionNode(q, defaultExpanded, 0); // depth 0
                paperContainer.appendChild(node);

                // Recursive children handled inside createQuestionNode to preserve structure
            });
        }

        function addToNav(displayId, linkId) {
            // Determine nesting visual based on ID length or just flat per spec
            // Spec says: Flat list, scale only for hierarchy. 
            // Since we don't have depth in the flat nav loop, we treat all as flat.
            // The "linkId" needs to be unique. We'll generate DOM IDs dynamically or use payload ID if safe.
            // We'll clean ID for anchor.
            const safeId = 'q-' + displayId.replace(/[^a-zA-Z0-9]/g, '-');

            const createItem = () => {
                const li = document.createElement('li');
                const a = document.createElement('a');
                a.className = 'nav-item';
                a.textContent = displayId;
                a.href = '#' + safeId; // Anchor link
                a.addEventListener('click', (e) => {
                    e.preventDefault();
                    const el = document.getElementById(safeId);
                    if (el) {
                        el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        // Simple active state logic could be added here or via intersection observer
                        setActiveNav(a.href);
                        closeDrawer();
                    }
                });
                li.appendChild(a);
                return li;
            };

            desktopNavList.appendChild(createItem());
            mobileNavList.appendChild(createItem());
        }

        function createQuestionNode(data, defaultExpanded, depth) {
            const safeId = 'q-' + data.id.replace(/[^a-zA-Z0-9]/g, '-');

            const node = document.createElement('div');
            node.className = 'question-node';
            node.id = safeId;

            // --- Question Body ---
            const body = document.createElement('div');
            body.className = 'question-body';

            const idEl = document.createElement('div');
            idEl.className = 'q-id';
            idEl.textContent = data.id;

            const textEl = document.createElement('div');
            textEl.className = 'q-text md-content';
            textEl.innerHTML = renderMarkdown(data.question);

            body.appendChild(idEl);
            body.appendChild(textEl);
            node.appendChild(body);

            // --- Solution Block (Optional) ---
            if (data.solutionBlock) {
                const sb = data.solutionBlock;
                const block = document.createElement('div');
                block.className = 'solution-block';

                // 1. Answer (Optional)
                if (sb.answer) {
                    const ansDiv = document.createElement('div');
                    ansDiv.className = 'answer-region';

                    const label = document.createElement('span');
                    label.className = 'answer-label';
                    label.textContent = 'Answer';

                    const content = document.createElement('div');
                    content.className = 'answer-content md-content';
                    content.innerHTML = renderMarkdown(sb.answer);

                    ansDiv.appendChild(label);
                    ansDiv.appendChild(content);
                    block.appendChild(ansDiv);
                }

                // 2. Solution Details (Optional)
                if (sb.solutionDetails) {
                    const sd = sb.solutionDetails;

                    // Toggle Control
                    const toggle = document.createElement('button');
                    toggle.className = 'disclosure-control';
                    toggle.setAttribute('aria-expanded', defaultExpanded);

                    const txtSpan = document.createElement('span');
                    txtSpan.textContent = defaultExpanded ? 'Hide working' : 'Show working';

                    // Icon (Chevron)
                    const icon = document.createElement('svg');
                    icon.setAttribute('width', '16');
                    icon.setAttribute('height', '16');
                    icon.setAttribute('viewBox', '0 0 24 24');
                    icon.setAttribute('fill', 'none');
                    icon.setAttribute('stroke', 'currentColor');
                    icon.setAttribute('stroke-width', '2');
                    icon.className = 'disclosure-icon';
                    icon.innerHTML = '<path d="M6 9l6 6 6-6" />';

                    toggle.appendChild(txtSpan);
                    toggle.appendChild(icon);

                    // Container
                    const detailsDiv = document.createElement('div');
                    detailsDiv.className = 'solution-details';
                    if (defaultExpanded) detailsDiv.classList.add('expanded');

                    // Toggle Event
                    toggle.onclick = () => {
                        const isExp = toggle.getAttribute('aria-expanded') === 'true';
                        toggle.setAttribute('aria-expanded', !isExp);
                        txtSpan.textContent = !isExp ? 'Hide working' : 'Show working';
                        detailsDiv.classList.toggle('expanded');
                    };

                    block.appendChild(toggle);

                    // Construct Details Content

                    // A. Keep in mind
                    if (sd.keepInMind) {
                        const kim = document.createElement('div');
                        kim.className = 'sd-subsection kim-block';
                        const lbl = document.createElement('div');
                        lbl.className = 'sd-label';
                        lbl.textContent = 'Keep in mind';
                        // Optional icon for KIM
                        const kimIcon = document.createElement('span');
                        kimIcon.innerHTML = 'ðŸ’¡'; // Minimal indicator
                        kimIcon.style.fontSize = '0.9em';
                        lbl.prepend(kimIcon);

                        const body = document.createElement('div');
                        body.className = 'md-content';
                        body.innerHTML = renderMarkdown(sd.keepInMind);

                        kim.appendChild(lbl);
                        kim.appendChild(body);
                        detailsDiv.appendChild(kim);
                    }

                    // B. Formulas Used
                    if (sd.formulasUsed) {
                        const form = document.createElement('div');
                        form.className = 'sd-subsection formulas-block';
                        const lbl = document.createElement('div');
                        lbl.className = 'sd-label';
                        lbl.textContent = 'Formulas used';

                        const body = document.createElement('div');
                        body.className = 'md-content';
                        body.innerHTML = renderMarkdown(sd.formulasUsed);

                        form.appendChild(lbl);
                        form.appendChild(body);
                        detailsDiv.appendChild(form);
                    }

                    // C. Working
                    if (sd.working) {
                        const wrk = document.createElement('div');
                        wrk.className = 'sd-subsection working-block';
                        const lbl = document.createElement('div');
                        lbl.className = 'sd-label';
                        lbl.textContent = 'Working';

                        const body = document.createElement('div');
                        body.className = 'md-content';
                        body.innerHTML = renderMarkdown(sd.working);

                        wrk.appendChild(lbl);
                        wrk.appendChild(body);
                        detailsDiv.appendChild(wrk);
                    }

                    // D. Alternative Working (Array)
                    if (sd.alternativeWorking && Array.isArray(sd.alternativeWorking)) {
                        sd.alternativeWorking.forEach(altContent => {
                            // Separator
                            const sep = document.createElement('hr');
                            sep.className = 'alt-working-separator';
                            detailsDiv.appendChild(sep);

                            const alt = document.createElement('div');
                            alt.className = 'sd-subsection alt-working-block';
                            const lbl = document.createElement('div');
                            lbl.className = 'sd-label';
                            lbl.textContent = 'Alternative working';

                            const body = document.createElement('div');
                            body.className = 'md-content';
                            body.innerHTML = renderMarkdown(altContent);

                            alt.appendChild(lbl);
                            alt.appendChild(body);
                            detailsDiv.appendChild(alt);
                        });
                    }

                    block.appendChild(detailsDiv);
                }

                node.appendChild(block);
            }

            // --- Recursion (Children) ---
            if (data.children && data.children.length > 0) {
                const container = document.createElement('div');
                container.className = 'children-container';

                data.children.forEach(child => {
                    // Also add child to nav if you want flat list of all items
                    addToNav(child.id, child.id);
                    const childNode = createQuestionNode(child, defaultExpanded, depth + 1);
                    container.appendChild(childNode);
                });

                node.appendChild(container);
            }

            return node;
        }

        function renderMarkdown(text) {
            if (!text) return '';
            // Use md instance if available, else plain text fallback
            if (md) {
                try {
                    return md.render(text);
                } catch (e) {
                    return text; // Fallback
                }
            }
            return text;
        }

        // =========================================
        // UI HELPERS (Mobile Drawer, Nav State)
        // =========================================

        function toggleDrawer() {
            const isOpen = mobileDrawer.classList.contains('open');
            if (isOpen) {
                mobileDrawer.classList.remove('open');
                drawerOverlay.classList.remove('open');
            } else {
                mobileDrawer.classList.add('open');
                drawerOverlay.classList.add('open');
            }
        }
        function closeDrawer() {
            mobileDrawer.classList.remove('open');
            drawerOverlay.classList.remove('open');
        }

        drawerTrigger.addEventListener('click', toggleDrawer);
        drawerClose.addEventListener('click', closeDrawer);
        drawerOverlay.addEventListener('click', closeDrawer);

        function setActiveNav(href) {
            // Strip full URL to just hash
            const hash = href.substring(href.indexOf('#'));

            [desktopNavList, mobileNavList].forEach(list => {
                list.querySelectorAll('a').forEach(a => {
                    if (a.getAttribute('href') === hash) {
                        a.parentElement.classList.add('active'); // Style the LI usually, or the A
                        a.classList.add('active');
                    } else {
                        a.classList.remove('active');
                        a.parentElement.classList.remove('active');
                    }
                });
            });
        }

        // Simple Scroll Spy for Nav Active State
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const id = entry.target.id;
                    setActiveNav('#' + id);
                }
            });
        }, { rootMargin: '-10% 0px -80% 0px' }); // Trigger near top

        function observeNodes() {
            // call this after render
            const nodes = document.querySelectorAll('.question-node');
            nodes.forEach(n => observer.observe(n));
        }

        // Hook observer into render
        const originalRender = renderQuestionList;
        renderQuestionList = function (q, d) {
            originalRender(q, d);
            setTimeout(observeNodes, 100);
        };


        // START
        init();

    </script>
</body>

</html>