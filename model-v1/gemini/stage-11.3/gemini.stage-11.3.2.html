<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ â€“ Maths Paper Solution Viewer (Lab)</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <style>
        /* =========================================
           STAGE 6 TOKEN BRIDGE & VARIABLES
           ========================================= */
        :root {
            /* --- A) Generic Bridge Tokens (Defaults before JS mapping) --- */
            /* These provide a safe fallback if JS fails, mimicking a neutral theme */
            --rtq-page-bg: #fdfdfc;
            --rtq-frame-bg: #fdfdfc;
            --rtq-paper-bg: #ffffff;
            --rtq-section-header-surface-bg: #f5f5f4;

            --rtq-question-surface-bg: #ffffff;
            --rtq-answer-surface-bg: #f5f5f4;
            --rtq-keepinmind-surface-bg: #fafafa;
            --rtq-formulas-surface-bg: #fafafa;
            --rtq-sd-wash-bg: #fafafa;

            --rtq-text-primary: #0c0a09;
            --rtq-text-secondary: #57534e;
            --rtq-text-quiet: #78716c;
            --rtq-link: #44403c;
            /* Neutral link default */

            --rtq-hairline-strong: #d6d3d1;
            --rtq-hairline: #e7e5e4;
            --rtq-hairline-quiet: #f5f5f4;

            --rtq-focus-ring: #0c0a09;
            --rtq-font-sans: 'Inter', sans-serif;

            /* --- B) Role-Based Surface Aliases (MANDATORY BINDING) --- */
            --rtq-surface-viewport: var(--rtq-page-bg);
            --rtq-surface-frame: var(--rtq-frame-bg);
            --rtq-surface-top-controls: var(--rtq-frame-bg);
            --rtq-surface-nav: var(--rtq-frame-bg);
            --rtq-surface-paper: var(--rtq-paper-bg);
            --rtq-surface-section-header: var(--rtq-section-header-surface-bg);

            --rtq-surface-question: var(--rtq-question-surface-bg);
            --rtq-surface-answer: var(--rtq-answer-surface-bg);
            --rtq-surface-keepinmind: var(--rtq-keepinmind-surface-bg);
            --rtq-surface-formulas: var(--rtq-formulas-surface-bg);
            --rtq-surface-sd-wash: var(--rtq-sd-wash-bg);

            /* --- C) Role-Based Text Aliases (MANDATORY BINDING) --- */
            --rtq-text-question: var(--rtq-text-primary);
            --rtq-text-question-id: var(--rtq-text-secondary);
            --rtq-text-answer-label: var(--rtq-text-secondary);
            --rtq-text-answer-value: var(--rtq-text-secondary);
            --rtq-text-disclosure: var(--rtq-link);
            --rtq-text-sd-label: var(--rtq-text-secondary);
            --rtq-text-sd-body: var(--rtq-text-secondary);
            --rtq-text-keepinmind-body: var(--rtq-text-secondary);
            --rtq-text-formulas-body: var(--rtq-text-secondary);
            --rtq-text-nav-item: var(--rtq-text-quiet);
            --rtq-text-nav-section-label: var(--rtq-text-quiet);
            --rtq-text-link: var(--rtq-link);

            /* Layout Constants */
            --nav-width: 240px;
            --frame-max-width: 1024px;
            --spacing-unit: 1rem;

            /* Canonical Spacing Steps */
            --spc-tight: 0.5rem;
            --spc-base: 1rem;
            --spc-relaxed: 1.5rem;
            --spc-loose: 2.5rem;
            /* Top level question separation */
        }

        /* =========================================
           RESET & BASE
           ========================================= */
        *,
        *::before,
        *::after {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: var(--rtq-font-sans);
            background-color: var(--rtq-surface-viewport);
            color: var(--rtq-text-primary);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        button {
            font-family: inherit;
            border: none;
            background: none;
            cursor: pointer;
            padding: 0;
            color: inherit;
        }

        a {
            color: var(--rtq-text-link);
            text-decoration: none;
        }

        /* Focus Styles */
        :focus-visible {
            outline: 2px solid var(--rtq-focus-ring);
            outline-offset: 2px;
        }

        /* Scrollbar Hiding (Stage 6 Add-on) */
        .no-scrollbar {
            scrollbar-width: none;
            /* Firefox */
            -ms-overflow-style: none;
            /* IE/Edge */
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
            /* Chrome/Safari */
        }

        /* =========================================
           TOP CONTROLS & LAB UI
           ========================================= */

        /* Boundary Anchor: SEP__TOP_CONTROLS_TO_FRAME_VERTICAL */
        [data-rtq-boundary="SEP__TOP_CONTROLS_TO_FRAME_VERTICAL"] {
            display: flex;
            flex-direction: column;
            width: 100%;
        }

        /* SURF__TOP_CONTROLS */
        .rtq-SURF__TOP_CONTROLS {
            background-color: var(--rtq-surface-top-controls);
            width: 100%;
            border-bottom: 1px solid var(--rtq-hairline);
            /* DIV__TOP_CONTROLS_TO_FRAME_HAIRLINE */
        }

        .top-controls-inner {
            max-width: var(--frame-max-width);
            margin: 0 auto;
            padding: var(--spc-base) var(--spc-base);
            /* SPC__TOP_CONTROLS_TO_FRAME_SPACING */
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        /* Theme Lab Strip */
        #rtq-theme-lab {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px dashed var(--rtq-hairline-strong);
            font-size: 0.875rem;
            align-items: center;
        }

        .lab-control {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .lab-control label {
            font-size: 0.75rem;
            color: var(--rtq-text-quiet);
            font-weight: 500;
        }

        .lab-control select {
            padding: 0.25rem 0.5rem;
            border: 1px solid var(--rtq-hairline-strong);
            border-radius: 4px;
            background: var(--rtq-surface-viewport);
            color: var(--rtq-text-primary);
            font-family: inherit;
            font-size: 0.875rem;
        }

        /* Paper Selector */
        .paper-selector-wrapper {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        #paper-select {
            font-size: 1rem;
            padding: 0.5rem;
            border: 1px solid var(--rtq-hairline);
            border-radius: 4px;
            background: var(--rtq-surface-viewport);
            color: var(--rtq-text-primary);
            min-width: 200px;
        }

        /* Mobile Jump To Trigger */
        .mobile-jump-trigger {
            display: none;
            /* Desktop default */
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--rtq-text-link);
            align-items: center;
            gap: 0.5rem;
        }

        /* =========================================
           DOCUMENT FRAME SHELL
           ========================================= */

        /* SURF__FRAME_BASE */
        .rtq-SURF__FRAME_BASE {
            background-color: var(--rtq-surface-frame);
            min-height: 100vh;
            display: flex;
            justify-content: center;
        }

        /* Frame Inner + SPC__FRAME_INNER_GUTTERS */
        .frame-inner {
            width: 100%;
            max-width: var(--frame-max-width);
            display: flex;
            /* SPC__FRAME_INNER_GUTTERS applied as padding on desktop handled via media query or inherent flex gap logic */
            /* Actually instruction says padding */
            padding: 0 var(--spc-base);
        }

        /* Desktop: Two Sibling Columns */
        /* SEP__NAV_TO_PAPER_COLUMN_BOUNDARY */
        [data-rtq-boundary="SEP__NAV_TO_PAPER_COLUMN_BOUNDARY"] {
            display: flex;
            width: 100%;
            position: relative;
        }

        /* DIV__NAV_TO_PAPER_COLUMN_HAIRLINE (Vertical Divider) is complex in flex. 
           We can implement as a border on the nav or a pseudo element. */

        /* =========================================
           NAVIGATION (Desktop)
           ========================================= */

        .nav-column {
            width: var(--nav-width);
            flex-shrink: 0;
            display: none;
            /* Hidden on mobile */
            /* SPC__NAV_TO_PAPER_COLUMN_GAP_SPACING provided via margin/padding logic */
            padding-right: var(--spc-base);
            border-right: 1px solid var(--rtq-hairline-quiet);
            /* DIV__NAV_TO_PAPER_COLUMN_HAIRLINE */
        }

        /* CUE__NAV_STICKY_PERSISTENCE */
        .nav-sticky-wrapper {
            position: sticky;
            top: 1rem;
            max-height: calc(100vh - 2rem);
            overflow-y: auto;
            /* CUE__NAV_SCROLLBARS_HIDDEN handled by .no-scrollbar class */
        }

        .nav-list {
            display: flex;
            flex-direction: column;
            /* CUE__NAV_FLAT_LIST_NO_INDENTATION: no padding-left for nesting */
        }

        /* Nav Items */
        .nav-item {
            display: block;
            text-align: left;
            padding: 0.25rem 0;
            color: var(--rtq-text-nav-item);
            font-size: 0.875rem;
            /* CUE__NAV_HIERARCHY_VIA_TYPE_SCALE_ONLY implemented in JS rendering logic */
            transition: color 0.1s ease;
        }

        .nav-item:hover {
            color: var(--rtq-text-primary);
            text-decoration: underline;
            text-decoration-color: var(--rtq-hairline-strong);
            text-underline-offset: 2px;
        }

        .nav-item.active {
            color: var(--rtq-text-link);
            /* Accent permitted for nav active */
            font-weight: 600;
        }

        /* Section Labels in Nav */
        .nav-section-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--rtq-text-nav-section-label);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: var(--spc-relaxed);
            margin-bottom: var(--spc-tight);
            /* DIV__NAV_SECTION_LABEL_TO_ITEMS_HAIRLINE handled via border-bottom if needed, or simple spacing */
        }

        /* =========================================
           PAPER CONTENT
           ========================================= */

        .paper-column {
            flex: 1;
            min-width: 0;
            /* Prevent flex blowout */
            /* SPC__NAV_TO_PAPER_COLUMN_GAP_SPACING: padding-left */
            padding-left: var(--spc-relaxed);
            padding-bottom: 4rem;
        }

        /* SURF__PAPER */
        .rtq-SURF__PAPER {
            background-color: var(--rtq-surface-paper);
            /* Optional: border/radius if we want a distinct paper look, but Stage 5 says quiet */
        }

        /* Error/Empty State */
        .paper-message {
            padding: 2rem;
            text-align: center;
            color: var(--rtq-text-secondary);
            font-weight: 500;
        }

        /* =========================================
           QUESTION NODES & STRUCTURE
           ========================================= */

        /* SEP__TOP_LEVEL_QUESTION_BOUNDARY + SPC__TOP_LEVEL_INTER_QUESTION_SPACING */
        .question-node-top {
            margin-bottom: var(--spc-loose);
            position: relative;
        }

        /* DIV__TOP_LEVEL_HAIRLINE (Optional, allowed) - skipping for cleaner look unless density demands */

        /* SURF__QUESTION_NODE (Optional wrapper) */
        .rtq-SURF__QUESTION_NODE {
            background-color: var(--rtq-surface-question);
            /* Padding if surface is distinct */
        }

        /* Question Body */
        .question-body {
            margin-bottom: var(--spc-base);
            /* SPC__QUESTION_TO_SOLUTION_SPACING */
            color: var(--rtq-text-question);
        }

        .question-id {
            color: var(--rtq-text-question-id);
            font-weight: 600;
            margin-right: 0.5em;
        }

        .question-content {
            display: inline;
        }

        /* Sub-questions */
        /* SEP__PARENT_TO_CHILDREN_VERTICAL + SPC__PARENT_TO_CHILDREN_VERTICAL_SPACING */
        .children-container {
            margin-top: var(--spc-base);
            /* SPC__CHILD_INDENTATION */
            margin-left: 0;
            /* Flat visually on left edge, but often indented slightly. Brief says "indentation may adapt". */
            /* Let's apply a small responsive indent */
            padding-left: 1rem;
            border-left: 1px solid var(--rtq-hairline-quiet);
            /* DIV__PARENT_TO_CHILDREN_VERTICAL_DIVIDER */
        }

        .question-node-child {
            margin-bottom: var(--spc-relaxed);
        }

        /* =========================================
           SOLUTION BLOCK
           ========================================= */

        .solution-block {
            /* Wrapper for Answer + SD */
        }

        /* ANSWER */
        /* SURF__ANSWER */
        .rtq-SURF__ANSWER {
            background-color: var(--rtq-surface-answer);
            padding: 0.5rem 0.75rem;
            border-radius: 4px;
            /* Slight radius permitted for distinct surface */
            margin-bottom: var(--spc-base);
            /* SPC__ANSWER_TO_SOLUTION_DETAILS_SPACING */
            display: flex;
            gap: 0.5rem;
            align-items: baseline;
        }

        .answer-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--rtq-text-answer-label);
        }

        .answer-content {
            font-weight: 500;
            color: var(--rtq-text-answer-value);
        }

        /* SOLUTION DETAILS */

        .disclosure-control {
            font-size: 0.875rem;
            color: var(--rtq-text-disclosure);
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            margin-bottom: var(--spc-tight);
        }

        .disclosure-control:hover {
            text-decoration: underline;
        }

        /* SURF__SOLUTION_DETAILS_WASH */
        .rtq-SURF__SOLUTION_DETAILS_WASH {
            background-color: var(--rtq-surface-sd-wash);
            padding: 1rem;
            border-radius: 4px;
            margin-top: var(--spc-tight);
            display: none;
            /* Collapsed by default */
        }

        .rtq-SURF__SOLUTION_DETAILS_WASH.expanded {
            display: block;
            animation: fadeIn 0.2s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Subsections */
        .sd-subsection {
            margin-bottom: var(--spc-relaxed);
        }

        .sd-subsection:last-child {
            margin-bottom: 0;
        }

        .sd-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--rtq-text-sd-label);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: var(--spc-tight);
            display: block;
        }

        .sd-body {
            color: var(--rtq-text-sd-body);
            font-size: 0.9375rem;
            /* Slightly smaller than body */
        }

        /* Keep In Mind: SURF__SD_KEEP_IN_MIND */
        .rtq-SURF__SD_KEEP_IN_MIND {
            background-color: var(--rtq-surface-keepinmind);
            padding: 0.75rem;
            border-radius: 4px;
        }

        .rtq-SURF__SD_KEEP_IN_MIND .sd-body ul {
            margin: 0;
            padding-left: 1.25rem;
        }

        /* Formulas: SURF__SD_FORMULAS_USED */
        .rtq-SURF__SD_FORMULAS_USED {
            background-color: var(--rtq-surface-formulas);
            padding: 0.75rem;
            border-radius: 4px;
        }

        /* Working / Alt Working */
        .sd-working-block {
            /* No extra surface, just body text */
        }

        /* DIV__SD_WORKING_TO_ALTERNATIVE_DIVIDER */
        .alt-working-divider {
            height: 1px;
            background-color: var(--rtq-hairline);
            margin: var(--spc-relaxed) 0;
            border: none;
        }

        /* =========================================
           MOBILE DRAWER
           ========================================= */
        .mobile-drawer-scrim {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            z-index: 999;
            display: none;
            /* CUE__DRAWER_SCRIM */
        }

        .mobile-drawer {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            width: 85%;
            max-width: 320px;
            background: var(--rtq-surface-frame);
            /* Matches frame base */
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.2s ease-out;
            display: flex;
            flex-direction: column;
            box-shadow: -2px 0 8px rgba(0, 0, 0, 0.1);
            /* CUE__DRAWER_FOCUS_TRAP_AND_BACKGROUND_BLOCK logic in JS */
        }

        .mobile-drawer.open {
            transform: translateX(0);
        }

        .drawer-header {
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--rtq-hairline);
            /* DIV__DRAWER_HEADER_TO_LIST_HAIRLINE */
        }

        .drawer-title {
            font-weight: 600;
            font-size: 1rem;
        }

        .drawer-nav-region {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        /* =========================================
           MEDIA QUERIES
           ========================================= */
        @media (max-width: 768px) {
            .nav-column {
                display: none;
            }

            .paper-column {
                padding-left: 0;
            }

            .mobile-jump-trigger {
                display: flex;
            }
        }

        @media (min-width: 769px) {
            .nav-column {
                display: block;
            }
        }

        /* =========================================
           MARKDOWN / KATEX UTILS
           ========================================= */
        /* Table styles */
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 1rem 0;
            font-size: 0.875rem;
        }

        th,
        td {
            border: 1px solid var(--rtq-hairline-quiet);
            padding: 0.5rem;
            text-align: left;
        }

        th {
            font-weight: 600;
            background-color: var(--rtq-section-header-surface-bg);
        }

        /* Math block scroll */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            padding: 0.5rem 0;
            /* No background on math itself */
        }

        img,
        svg {
            max-width: 100%;
            height: auto;
        }

        /* Inline SVG diagram styles - forcing grayscale/currentcolor */
        svg {
            color: inherit;
            fill: currentColor;
        }
    </style>
</head>

<body>

    <div data-rtq-boundary="SEP__TOP_CONTROLS_TO_FRAME_VERTICAL">
        <div class="rtq-SURF__TOP_CONTROLS">
            <div class="top-controls-inner">

                <div id="rtq-theme-lab">
                    <div class="lab-control">
                        <label for="lab-base">Base</label>
                        <select id="lab-base">
                            <option value="neutral">Neutral</option>
                            <option value="gray">Gray</option>
                            <option value="zinc">Zinc</option>
                            <option value="stone">Stone</option>
                        </select>
                    </div>
                    <div class="lab-control">
                        <label for="lab-theme">Theme</label>
                        <select id="lab-theme">
                            <option value="default">Default</option>
                        </select>
                    </div>
                    <div class="lab-control">
                        <label for="lab-font">Font</label>
                        <select id="lab-font">
                            <option value="inter">Inter</option>
                        </select>
                    </div>
                    <div class="lab-control">
                        <label for="lab-mode">Mode</label>
                        <select id="lab-mode">
                            <option value="light">Light</option>
                            <option value="dark">Dark</option>
                            <option value="system">System</option>
                        </select>
                    </div>
                    <div style="margin-left: auto;">
                        <button id="lab-reset"
                            style="font-size: 0.75rem; text-decoration: underline; color: var(--rtq-text-secondary);">Reset</button>
                    </div>
                </div>

                <div class="paper-selector-wrapper">
                    <select id="paper-select" aria-label="Select paper">
                        <option>Loading...</option>
                    </select>

                    <button class="mobile-jump-trigger" id="jump-to-btn">
                        <span>Jump to</span>
                        <svg width="16" height="16" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path
                                d="M4.18179 6.18181C4.35753 6.00608 4.64245 6.00608 4.81819 6.18181L7.49999 8.86362L10.1818 6.18181C10.3575 6.00608 10.6424 6.00608 10.8182 6.18181C10.9939 6.35755 10.9939 6.64247 10.8182 6.81821L7.81819 9.81821C7.73379 9.9026 7.61934 9.95001 7.49999 9.95001C7.38064 9.95001 7.26618 9.9026 7.18179 9.81821L4.18179 6.81821C4.00605 6.64247 4.00605 6.35755 4.18179 6.18181Z"
                                fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                </div>

            </div>
        </div>
    </div>

    <div class="rtq-SURF__FRAME_BASE" data-rtq-trace="SURF__FRAME_BASE">
        <div class="frame-inner">

            <div data-rtq-boundary="SEP__NAV_TO_PAPER_COLUMN_BOUNDARY">

                <nav class="nav-column" aria-label="Document navigation">
                    <div class="nav-sticky-wrapper no-scrollbar" id="desktop-nav-container">
                    </div>
                </nav>

                <main class="paper-column rtq-SURF__PAPER" id="paper-content-region" data-rtq-trace="SURF__PAPER">
                    <div class="paper-message">Loading System...</div>
                </main>

            </div>
        </div>
    </div>

    <div class="mobile-drawer-scrim" id="drawer-scrim"></div>
    <div class="mobile-drawer" id="mobile-drawer" role="dialog" aria-modal="true" aria-label="Navigation">
        <div class="drawer-header">
            <span class="drawer-title">Jump to</span>
            <button id="drawer-close" aria-label="Close navigation">
                <svg width="20" height="20" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M11.7816 4.03157C12.0062 3.80702 12.0062 3.44295 11.7816 3.2184C11.5571 2.99385 11.193 2.99385 10.9685 3.2184L7.50005 6.68682L4.03164 3.2184C3.80708 2.99385 3.44301 2.99385 3.21846 3.2184C2.99391 3.44295 2.99391 3.80702 3.21846 4.03157L6.68688 7.50001L3.21846 10.9684C2.99391 11.193 2.99391 11.5571 3.21846 11.7816C3.44301 12.0062 3.80708 12.0062 4.03164 11.7816L7.50005 8.31322L10.9685 11.7816C11.193 12.0062 11.5571 12.0062 11.7816 11.7816C12.0062 11.5571 12.0062 11.193 11.7816 10.9684L8.31322 7.50001L11.7816 4.03157Z"
                        fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"></path>
                </svg>
            </button>
        </div>
        <div class="drawer-nav-region no-scrollbar" id="mobile-nav-container">
        </div>
    </div>

    <script>
        // --- STAGE 0: CONSTANTS ---
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.v2.json";
        const RTQ_SHADCN_TOKEN_PROFILES_PATH = "../../../payload/rtq.shadcn.token.profiles.v1.json";

        // --- GLOBAL STATE ---
        const state = {
            labBase: 'zinc',
            labTheme: 'neutral',
            labFont: 'inter',
            labMode: 'system',
            papers: [],
            activePaperKey: null,
            expandedWorkings: false // derived from paper defaults
        };

        // --- MARKDOWN SETUP ---
        const md = window.markdownit
            ? window.markdownit({
                html: true,
                linkify: true,
                breaks: false, // Authoritative: false
            })
            : null;

        if (md) {
            md.inline.ruler.disable(["escape"]);
        }

        // --- LAB: COLOR NORMALIZATION ---
        function normalizeColor(v) {
            if (!v) return "";
            const raw = String(v).trim();
            if (!raw) return "";
            if (raw.includes("(") || raw.startsWith("#") || raw.startsWith("var("))
                return raw;

            // Simple validation wrapper attempts
            const candidates = [`oklch(${raw})`, `hsl(${raw})`, raw];
            for (const c of candidates) {
                try {
                    if (window.CSS && CSS.supports && CSS.supports("color", c)) return c;
                } catch (e) { }
            }
            return raw;
        }

        // --- LAB: APPLY THEME ---
        function applyTheme() {
            if (!window.SHADCN_TOKEN_PROFILES) {
                console.error("Profiles not loaded");
                return;
            }

            const { profiles, defaults } = window.SHADCN_TOKEN_PROFILES;

            // Determine effective mode
            let effectiveMode = state.labMode;
            if (state.labMode === 'system') {
                effectiveMode = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            }

            // Construct Key
            const profileKey = `${state.labBase}-${state.labTheme}-${state.labFont}`;
            const profile = profiles[profileKey] || profiles[`${defaults.baseColor}-${defaults.theme}-${defaults.font}`];

            if (!profile) {
                console.error("Profile not found:", profileKey);
                return;
            }

            // Get vars
            const vars = profile.vars[effectiveMode];
            const root = document.documentElement;

            // 1. Map Shadcn Vars to CSS Properties (intermediate step, not usually needed if we map directly to RTQ)
            // But strict instructions say: Mapping step MUST write resolved values into RTQ tokens.

            // Helpers to safe-get a Shadcn var value from the profile JSON
            const getVar = (name) => {
                const val = vars[name];
                return normalizeColor(val);
            };

            // --- B) SHADCN -> RTQ MAPPING ---

            // B1) Base Surfaces
            root.style.setProperty('--rtq-page-bg', getVar('--background'));
            root.style.setProperty('--rtq-frame-bg', getVar('--background'));
            root.style.setProperty('--rtq-paper-bg', getVar('--card'));

            // B1b) Section
            root.style.setProperty('--rtq-section-header-surface-bg', getVar('--muted'));

            // B2) Optional Surfaces
            root.style.setProperty('--rtq-question-surface-bg', getVar('--card'));
            root.style.setProperty('--rtq-answer-surface-bg', getVar('--secondary'));
            root.style.setProperty('--rtq-keepinmind-surface-bg', getVar('--accent')); // Using accent surface
            root.style.setProperty('--rtq-formulas-surface-bg', getVar('--muted'));
            root.style.setProperty('--rtq-sd-wash-bg', getVar('--muted'));

            // B3) Text Buckets
            root.style.setProperty('--rtq-text-primary', getVar('--foreground'));

            // Safety guardrail for muted-foreground
            // Logic: we can't easily detect contrast in JS without library, 
            // but we can trust the instruction's permission to upgrade if needed.
            // For this implementation, we will map to muted-foreground as spec'd, 
            // but in a real "smart" bridge we'd check contrast.
            root.style.setProperty('--rtq-text-secondary', getVar('--muted-foreground'));
            root.style.setProperty('--rtq-text-quiet', getVar('--muted-foreground'));

            root.style.setProperty('--rtq-link', getVar('--primary'));

            // B4) Hairlines
            root.style.setProperty('--rtq-hairline', getVar('--border'));

            // Strong: prefer input, else derive
            const inputVar = vars['--input'];
            if (inputVar) {
                root.style.setProperty('--rtq-hairline-strong', normalizeColor(inputVar));
            } else {
                // Fallback derivation (simplified for Lab)
                root.style.setProperty('--rtq-hairline-strong', getVar('--border'));
            }

            // Quiet: Simplified for Lab
            root.style.setProperty('--rtq-hairline-quiet', getVar('--border'));

            // B5) Focus
            root.style.setProperty('--rtq-focus-ring', getVar('--ring'));

            // B6) Font
            // Assuming Inter is loaded, mapped to --rtq-font-sans
            if (state.labFont === 'inter') {
                root.style.setProperty('--rtq-font-sans', '"Inter", sans-serif');
            }

            // Update UI State for Selects
            document.getElementById('lab-base').value = state.labBase;
            document.getElementById('lab-theme').value = state.labTheme;
            document.getElementById('lab-font').value = state.labFont;
            document.getElementById('lab-mode').value = state.labMode;
        }

        // --- INIT LAB CONTROLS ---
        function initLabControls() {
            // Load params from URL
            const params = new URLSearchParams(window.location.search);
            const defaults = window.SHADCN_TOKEN_PROFILES.defaults;

            state.labBase = params.get('labBase') || localStorage.getItem('labBase') || defaults.baseColor;
            state.labTheme = params.get('labTheme') || localStorage.getItem('labTheme') || defaults.theme;
            state.labFont = params.get('labFont') || localStorage.getItem('labFont') || defaults.font;
            state.labMode = params.get('labMode') || localStorage.getItem('labMode') || defaults.mode;

            // Populate Theme Select (unique themes from profiles)
            const themes = new Set();
            Object.values(window.SHADCN_TOKEN_PROFILES.profiles).forEach(p => themes.add(p.meta.theme));
            const themeSelect = document.getElementById('lab-theme');
            themeSelect.innerHTML = '';
            themes.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t;
                opt.textContent = t.charAt(0).toUpperCase() + t.slice(1);
                themeSelect.appendChild(opt);
            });

            // Event Listeners
            const updateState = () => {
                state.labBase = document.getElementById('lab-base').value;
                state.labTheme = document.getElementById('lab-theme').value;
                state.labFont = document.getElementById('lab-font').value;
                state.labMode = document.getElementById('lab-mode').value;

                // Persistence
                localStorage.setItem('labBase', state.labBase);
                localStorage.setItem('labTheme', state.labTheme);
                localStorage.setItem('labFont', state.labFont);
                localStorage.setItem('labMode', state.labMode);

                const url = new URL(window.location);
                url.searchParams.set('labBase', state.labBase);
                url.searchParams.set('labTheme', state.labTheme);
                url.searchParams.set('labFont', state.labFont);
                url.searchParams.set('labMode', state.labMode);
                window.history.replaceState({}, '', url);

                applyTheme();
            };

            ['lab-base', 'lab-theme', 'lab-font', 'lab-mode'].forEach(id => {
                document.getElementById(id).addEventListener('change', updateState);
            });

            document.getElementById('lab-reset').addEventListener('click', () => {
                state.labBase = defaults.baseColor;
                state.labTheme = defaults.theme;
                state.labFont = defaults.font;
                state.labMode = defaults.mode;
                updateState();
            });

            // Initial Apply
            applyTheme();

            // Listen for System Mode changes
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
                if (state.labMode === 'system') applyTheme();
            });
        }


        // --- RENDERING LOGIC ---

        function renderPaper(paperKey) {
            const paper = state.papers.find(p => p.key === paperKey);
            if (!paper) return;

            state.activePaperKey = paperKey;
            state.expandedWorkings = paper.defaults?.expandedAll || false;

            // Render Content
            const contentContainer = document.getElementById('paper-content-region');
            contentContainer.innerHTML = ''; // Clear

            // Sections or Questions?
            let html = '';

            if (paper.sections) {
                paper.sections.forEach(section => {
                    // Section Header
                    if (section.label && section.label.trim() !== "") {
                        // SURF__SECTION_HEADER
                        html += `<div class="rtq-SURF__SECTION_HEADER" style="padding: 0.5rem; margin-bottom: 1rem; border-bottom: 1px solid var(--rtq-hairline); font-weight:600; font-size: 0.875rem;">${section.label}</div>`;
                    }
                    html += renderQuestionList(section.questions);
                    // Separator between sections logic handled by margin-bottom of list or header
                });
            } else if (paper.questions) {
                html += renderQuestionList(paper.questions);
            }

            contentContainer.innerHTML = html;

            // Render Nav
            renderNav(paper);

            // Re-run KaTeX
            renderMathInElement(contentContainer, {
                delimiters: [
                    { left: '$$', right: '$$', display: true },
                    { left: '$', right: '$', display: false }
                ],
                throwOnError: false
            });
        }

        function renderQuestionList(questions) {
            if (!questions || questions.length === 0) return '';
            return `<div class="question-list">
                ${questions.map(q => renderQuestionNode(q, 0)).join('')}
            </div>`;
        }

        function renderQuestionNode(node, depth) {
            const isTopLevel = depth === 0;
            const hasChildren = node.children && node.children.length > 0;

            // Classes for hierarchy
            const topClass = isTopLevel ? 'question-node-top' : 'question-node-child';

            // Render Body
            let bodyHtml = `<div class="question-body">
                <span class="question-id">${node.id}</span>
                <div class="question-content">${md ? md.renderInline(node.question) : node.question}</div>
            </div>`;

            // Solution Block
            let solutionHtml = '';
            if (node.solutionBlock) {
                const sb = node.solutionBlock;
                const hasAnswer = sb.answer && sb.answer.trim();
                const hasSD = sb.solutionDetails;

                let answerHtml = '';
                if (hasAnswer) {
                    answerHtml = `<div class="rtq-SURF__ANSWER">
                        <span class="answer-label">Answer</span>
                        <span class="answer-content">${md ? md.renderInline(sb.answer) : sb.answer}</span>
                    </div>`;
                }

                let sdHtml = '';
                if (hasSD) {
                    const isExpanded = state.expandedWorkings;
                    // Note: In a real app we might track per-question state, but for this prototype we assume default start state.
                    // We need unique IDs for toggle.
                    const uniqueId = `sd-${node.id.replace(/[^a-zA-Z0-9]/g, '-')}-${Math.random().toString(36).substr(2, 9)}`;

                    sdHtml = `
                        <button class="disclosure-control" onclick="toggleSD('${uniqueId}', this)" aria-expanded="false">
                            <span>Show working</span>
                            <svg width="12" height="12" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.13523 6.15803C3.3241 5.95657 3.64052 5.94637 3.84197 6.13523L7.5 9.56464L11.158 6.13523C11.3595 5.94637 11.6759 5.95657 11.8648 6.15803C12.0536 6.35949 12.0434 6.67591 11.842 6.86477L7.84197 10.6148C7.64964 10.7951 7.35036 10.7951 7.15803 10.6148L3.15803 6.86477C2.95657 6.67591 2.94637 6.35949 3.13523 6.15803Z" fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
                        </button>
                        <div id="${uniqueId}" class="rtq-SURF__SOLUTION_DETAILS_WASH">
                            ${renderSDContent(sb.solutionDetails)}
                        </div>
                    `;
                }

                solutionHtml = `<div class="solution-block">
                    ${answerHtml}
                    ${sdHtml}
                </div>`;
            }

            // Children
            let childrenHtml = '';
            if (hasChildren) {
                childrenHtml = `<div class="children-container">
                    ${node.children.map(c => renderQuestionNode(c, depth + 1)).join('')}
                </div>`;
            }

            // Wrapper (SURF__QUESTION_NODE)
            return `<div class="${topClass} rtq-SURF__QUESTION_NODE" id="q-${node.id}">
                ${bodyHtml}
                ${solutionHtml}
                ${childrenHtml}
            </div>`;
        }

        function renderSDContent(sd) {
            let html = '';

            // Keep in mind
            if (sd.keepInMind) {
                html += `<div class="sd-subsection rtq-SURF__SD_KEEP_IN_MIND">
                    <span class="sd-label">Keep in mind</span>
                    <div class="sd-body">${md ? md.render(sd.keepInMind) : sd.keepInMind}</div>
                </div>`;
            }

            // Formulas
            if (sd.formulasUsed) {
                html += `<div class="sd-subsection rtq-SURF__SD_FORMULAS_USED">
                    <span class="sd-label">Formulas used</span>
                    <div class="sd-body">${md ? md.render(sd.formulasUsed) : sd.formulasUsed}</div>
                </div>`;
            }

            // Working
            if (sd.working) {
                html += `<div class="sd-subsection sd-working-block">
                    <span class="sd-label">Working</span>
                    <div class="sd-body">${md ? md.render(sd.working) : sd.working}</div>
                </div>`;
            }

            // Alternative Working
            if (sd.alternativeWorking && Array.isArray(sd.alternativeWorking)) {
                sd.alternativeWorking.forEach(alt => {
                    html += `<hr class="alt-working-divider" />`;
                    html += `<div class="sd-subsection sd-working-block">
                        <span class="sd-label">Alternative working</span>
                        <div class="sd-body">${md ? md.render(alt) : alt}</div>
                    </div>`;
                });
            }

            return html;
        }

        // --- NAV RENDER ---
        function renderNav(paper) {
            const desktopContainer = document.getElementById('desktop-nav-container');
            const mobileContainer = document.getElementById('mobile-nav-container');

            let navHtml = '<div class="nav-list">';

            // Helper to recurse
            const traverse = (nodes, depth) => {
                let s = '';
                nodes.forEach(node => {
                    // Type scale via style, flat list via layout
                    const fontSize = Math.max(0.7, 0.875 - (depth * 0.05)) + 'rem';
                    const opacity = Math.max(0.6, 1 - (depth * 0.1));

                    s += `<a href="#q-${node.id}" class="nav-item" style="font-size: ${fontSize}; opacity: ${opacity};" onclick="handleNavClick(event, 'q-${node.id}')">${node.id}</a>`;

                    if (node.children) {
                        s += traverse(node.children, depth + 1);
                    }
                });
                return s;
            };

            if (paper.sections) {
                paper.sections.forEach((sec, idx) => {
                    if (sec.label) {
                        // Spacing between sections
                        const mt = idx > 0 ? 'margin-top: 1.5rem;' : '';
                        navHtml += `<div class="nav-section-label" style="${mt}">${sec.label}</div>`;
                    }
                    navHtml += traverse(sec.questions, 0);
                });
            } else if (paper.questions) {
                navHtml += traverse(paper.questions, 0);
            }

            navHtml += '</div>';

            desktopContainer.innerHTML = navHtml;
            mobileContainer.innerHTML = navHtml;
        }

        // --- INTERACTIONS ---

        window.toggleSD = function (id, btn) {
            const el = document.getElementById(id);
            const isExpanded = el.classList.contains('expanded');

            if (isExpanded) {
                el.classList.remove('expanded');
                btn.setAttribute('aria-expanded', 'false');
                btn.querySelector('span').textContent = 'Show working';
            } else {
                el.classList.add('expanded');
                btn.setAttribute('aria-expanded', 'true');
                btn.querySelector('span').textContent = 'Hide working';

                // Render math inside if newly shown? 
                // We render all math on page load, but if display:none prevents rendering in some browsers, 
                // we might need it. KaTeX generally works even if hidden, but re-render is safe.
            }
        };

        window.handleNavClick = function (e, targetId) {
            e.preventDefault();
            const target = document.getElementById(targetId);
            if (target) {
                target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                // Update active state in nav (simple implementation)
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                const navLinks = document.querySelectorAll(`a[href="#${targetId}"]`);
                navLinks.forEach(l => l.classList.add('active'));
            }
            // Close drawer if open
            closeDrawer();
        };

        // Mobile Drawer
        const drawer = document.getElementById('mobile-drawer');
        const scrim = document.getElementById('drawer-scrim');

        function openDrawer() {
            drawer.classList.add('open');
            scrim.style.display = 'block';
            document.body.style.overflow = 'hidden'; // Lock body scroll
            // Focus trap logic would go here
        }

        function closeDrawer() {
            drawer.classList.remove('open');
            scrim.style.display = 'none';
            document.body.style.overflow = '';
        }

        document.getElementById('jump-to-btn').addEventListener('click', openDrawer);
        document.getElementById('drawer-close').addEventListener('click', closeDrawer);
        scrim.addEventListener('click', closeDrawer);

        // --- INITIALIZATION ---

        async function init() {
            // 1. Load Profiles (Critical for Lab)
            try {
                const profilesResp = await fetch(RTQ_SHADCN_TOKEN_PROFILES_PATH);
                if (!profilesResp.ok) throw new Error("Profiles missing");
                window.SHADCN_TOKEN_PROFILES = await profilesResp.json();

                initLabControls();

            } catch (e) {
                document.getElementById('paper-content-region').innerHTML = '<div class="paper-message">SHADCN TOKEN PROFILES MISSING</div>';
                return; // STOP per instructions
            }

            // 2. Load Papers
            try {
                const papersResp = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!papersResp.ok) throw new Error("Papers missing");
                const payload = await papersResp.json();
                state.papers = payload.papers;

                if (!state.papers.length) throw new Error("No papers");

                // Populate Selector
                const selector = document.getElementById('paper-select');
                selector.innerHTML = state.papers.map(p => `<option value="${p.key}">${p.label}</option>`).join('');

                selector.addEventListener('change', (e) => {
                    renderPaper(e.target.value);
                });

                // Initial Render
                renderPaper(state.papers[0].key);

            } catch (e) {
                document.getElementById('paper-content-region').innerHTML = '<div class="paper-message">PAPERS PAYLOAD MISSING</div>';
            }
        }

        // Run
        init();

    </script>
</body>

</html>