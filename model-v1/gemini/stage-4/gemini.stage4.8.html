<!DOCTYPE html>
<html lang="en-GB">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ - Maths Paper Solution Viewer (Stage 4 Prototype)</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"
        integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV" crossorigin="anonymous">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <style>
        /* * STAGE 4 VISUAL SYSTEM & CSS RESET
         * Tone: Calm, Neutral, Paper-like, Non-judgmental.
         */

        :root {
            /* Semantic Colour Roles - Neutral/Grayscale Only */
            --c-bg-app: #F3F4F6;
            /* Page background (calm gray) */
            --c-bg-paper: #FFFFFF;
            /* Paper surface (white) */
            --c-bg-details: #F9FAFB;
            /* Solution details surface (subtle differentiation) */
            --c-bg-nav: #F3F4F6;
            /* Nav surface (matches app bg) */

            --c-text-primary: #111827;
            /* Question text (high contrast) */
            --c-text-secondary: #4B5563;
            /* Secondary text */
            --c-text-tertiary: #6B7280;
            /* Meta/Navigation text */
            --c-text-interactive: #374151;
            /* Buttons/Toggles */

            --c-border-subtle: #E5E7EB;
            --c-border-focus: #111827;
            /* Focus state (accessibility) */

            /* Spacing Scale */
            --space-xs: 0.25rem;
            --space-sm: 0.5rem;
            --space-md: 1rem;
            --space-lg: 1.5rem;
            --space-xl: 2.5rem;
            --space-xxl: 4rem;
            /* Between questions */

            /* Typography */
            --font-stack: 'Inter', system-ui, -apple-system, sans-serif;
        }

        *,
        *::before,
        *::after {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: var(--font-stack);
            background-color: var(--c-bg-app);
            color: var(--c-text-primary);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        /* * LAYOUT ARCHITECTURE 
         * Single centered frame, sticky nav rail, continuous scroll 
         */

        .app-header {
            position: sticky;
            top: 0;
            z-index: 100;
            background-color: var(--c-bg-app);
            border-bottom: 1px solid var(--c-border-subtle);
            padding: var(--space-md) 0;
            height: 70px;
            /* Fixed height for stability */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header-content {
            width: 100%;
            max-width: 1000px;
            /* Matches main content frame */
            padding: 0 var(--space-lg);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .paper-selector {
            font-family: var(--font-stack);
            font-size: 1rem;
            padding: var(--space-sm) var(--space-md);
            border: 1px solid #D1D5DB;
            border-radius: 4px;
            background-color: white;
            color: var(--c-text-primary);
            cursor: pointer;
        }

        .mobile-menu-btn {
            display: none;
            /* Desktop default */
            background: none;
            border: 1px solid #D1D5DB;
            border-radius: 4px;
            padding: var(--space-sm);
            cursor: pointer;
            font-size: 0.9rem;
        }

        .app-frame {
            display: flex;
            max-width: 1000px;
            margin: 0 auto;
            min-height: calc(100vh - 70px);
            position: relative;
        }

        /* NAVIGATION RAIL (Desktop) */
        .nav-column {
            width: 180px;
            flex-shrink: 0;
            padding-top: var(--space-xl);
            padding-right: var(--space-md);
            display: block;
            /* Desktop visible */
        }

        .nav-sticky-container {
            position: sticky;
            top: 90px;
            /* Header + spacing */
            max-height: calc(100vh - 100px);
            overflow-y: auto;
            /* Hide Scrollbars */
            scrollbar-width: none;
            /* Firefox */
            -ms-overflow-style: none;
            /* IE/Edge */
        }

        .nav-sticky-container::-webkit-scrollbar {
            display: none;
            /* Chrome/Safari */
        }

        .nav-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .nav-item {
            margin-bottom: var(--space-xs);
        }

        .nav-link {
            display: block;
            text-decoration: none;
            color: var(--c-text-tertiary);
            font-size: 0.875rem;
            padding: var(--space-xs) var(--space-sm);
            border-radius: 4px;
            transition: color 0.2s, background-color 0.2s;
        }

        .nav-link:hover {
            color: var(--c-text-primary);
            background-color: #E5E7EB;
        }

        .nav-link.active {
            font-weight: 600;
            color: var(--c-text-primary);
            background-color: #E5E7EB;
        }

        .nav-section-label {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--c-text-tertiary);
            margin-top: var(--space-md);
            margin-bottom: var(--space-sm);
            padding-left: var(--space-sm);
            letter-spacing: 0.05em;
        }

        /* PAPER CONTENT */
        .paper-column {
            flex-grow: 1;
            background-color: var(--c-bg-paper);
            padding: var(--space-xl) var(--space-xxl);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            /* Subtle lift */
            min-height: 100vh;
        }

        /* * QUESTION COMPONENT 
         * Hierarchy: Question > Answer > Details 
         */

        .question-block {
            margin-bottom: var(--space-xxl);
            /* Rhythm */
            scroll-margin-top: 100px;
            /* For anchor jumping offset */
        }

        .question-header {
            display: flex;
            align-items: baseline;
            gap: var(--space-md);
            margin-bottom: var(--space-md);
        }

        .q-id {
            font-weight: 600;
            color: var(--c-text-secondary);
            font-size: 1.125rem;
            flex-shrink: 0;
            width: 2.5rem;
            /* Alignment anchor */
        }

        .q-prompt {
            color: var(--c-text-primary);
            font-size: 1.125rem;
            font-weight: 400;
            flex-grow: 1;
        }

        /* Sub-question Handling (Indentation logic) */
        .question-block[data-depth="1"] {
            margin-left: 0;
        }

        .question-block[data-depth="2"] {
            margin-left: 2.5rem;
            margin-bottom: var(--space-lg);
        }

        /* e.g. (a) */
        .question-block[data-depth="3"] {
            margin-left: 5rem;
            margin-bottom: var(--space-lg);
        }

        /* e.g. (i) */

        .question-block[data-depth="2"] .q-id,
        .question-block[data-depth="3"] .q-id {
            font-size: 1rem;
            width: 2rem;
        }

        .question-block[data-depth="2"] .q-prompt,
        .question-block[data-depth="3"] .q-prompt {
            font-size: 1rem;
        }

        .diagram-container {
            margin: var(--space-md) 0;
            display: block;
            max-width: 100%;
        }

        .diagram-svg {
            display: block;
            max-width: 100%;
            height: auto;
            border: 1px solid var(--c-border-subtle);
            /* Placeholder frame */
            border-radius: 4px;
        }

        .answer-block {
            margin-left: 3.5rem;
            /* Aligns with prompt text, skipping ID */
            margin-bottom: var(--space-md);
        }

        /* Adjust indentation for sub-questions */
        .question-block[data-depth="2"] .answer-block {
            margin-left: 3rem;
        }

        .question-block[data-depth="3"] .answer-block {
            margin-left: 3rem;
        }

        .answer-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--c-text-secondary);
            margin-right: var(--space-sm);
        }

        .answer-value {
            font-size: 1.125rem;
            font-weight: 500;
            color: var(--c-text-primary);
        }

        /* DISCLOSURE CONTROL */
        .toggle-btn {
            background: none;
            border: none;
            padding: 0;
            font-family: var(--font-stack);
            font-size: 0.95rem;
            color: var(--c-text-interactive);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: var(--space-sm);
            margin-left: 3.5rem;
            /* Aligns with content */
            margin-bottom: var(--space-xs);
            text-decoration: underline;
            text-decoration-color: #D1D5DB;
            text-underline-offset: 4px;
        }

        .question-block[data-depth="2"] .toggle-btn,
        .question-block[data-depth="3"] .toggle-btn {
            margin-left: 3rem;
        }

        .toggle-btn:hover {
            color: var(--c-text-primary);
            text-decoration-color: var(--c-text-primary);
        }

        .toggle-btn:focus-visible {
            outline: 2px solid var(--c-border-focus);
            outline-offset: 2px;
            border-radius: 2px;
        }

        .chevron {
            width: 16px;
            height: 16px;
            transition: transform 0.2s ease;
            fill: currentColor;
        }

        .toggle-btn[aria-expanded="true"] .chevron {
            transform: rotate(180deg);
        }

        /* SOLUTION DETAILS */
        .solution-details {
            margin-left: 3.5rem;
            background-color: var(--c-bg-details);
            border-radius: 8px;
            overflow: hidden;
            display: none;
            /* Collapsed by default */
            margin-top: var(--space-sm);
        }

        .question-block[data-depth="2"] .solution-details,
        .question-block[data-depth="3"] .solution-details {
            margin-left: 3rem;
        }

        .solution-details.expanded {
            display: block;
            padding: var(--space-md) var(--space-lg);
            /* Animation of height is tricky with auto, using JS toggle for display currently */
        }

        .detail-section {
            margin-bottom: var(--space-lg);
        }

        .detail-section:last-child {
            margin-bottom: 0;
        }

        .detail-label {
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--c-text-secondary);
            margin-bottom: var(--space-xs);
            display: block;
        }

        .detail-content {
            font-size: 1rem;
            color: var(--c-text-secondary);
        }

        /* KaTeX Overrides for Layout Safety */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            padding-bottom: 4px;
            /* Scrollbar space */
            margin: 0.5em 0;
            text-align: left;
            /* Prefer left alignment for flow */
            padding-left: 0.5em;
            /* Small indent */
        }

        /* Ensure math doesn't break layout on mobile */
        .katex {
            font-size: 1.1em;
            white-space: nowrap;
        }

        .katex-display>.katex {
            white-space: normal;
        }

        /* * MOBILE RESPONSIVENESS 
         */
        @media (max-width: 768px) {
            .app-frame {
                display: block;
                /* Stack */
            }

            .nav-column {
                display: none;
                /* Hidden by default on mobile */
                position: fixed;
                top: 70px;
                left: 0;
                width: 100%;
                height: calc(100vh - 70px);
                background: var(--c-bg-app);
                z-index: 90;
                padding: var(--space-md);
                border-bottom: 1px solid var(--c-border-subtle);
            }

            .nav-column.is-open {
                display: block;
            }

            .nav-sticky-container {
                position: static;
                height: 100%;
            }

            .mobile-menu-btn {
                display: block;
            }

            .paper-column {
                padding: var(--space-lg) var(--space-md);
            }

            .q-id {
                width: 2rem;
                font-size: 1rem;
            }

            .q-prompt {
                font-size: 1rem;
            }

            /* Reset deep indentation on mobile to preserve width */
            .question-block[data-depth="2"] {
                margin-left: 1rem;
            }

            .question-block[data-depth="3"] {
                margin-left: 1rem;
            }

            .answer-block,
            .toggle-btn,
            .solution-details,
            .question-block[data-depth="2"] .answer-block,
            .question-block[data-depth="2"] .toggle-btn,
            .question-block[data-depth="2"] .solution-details,
            .question-block[data-depth="3"] .solution-details {
                margin-left: 2rem;
            }
        }
    </style>

    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"
        integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8"
        crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"
        integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05"
        crossorigin="anonymous"></script>
</head>

<body>

    <header class="app-header">
        <div class="header-content">
            <h1 style="font-size:1.1rem; font-weight:600; margin:0; color:var(--c-text-primary);">RTQ Viewer</h1>

            <select id="paperSelector" class="paper-selector" aria-label="Select Paper">
                <option value="short">Short Paper</option>
                <option value="standard">Standard Paper</option>
                <option value="standard-expanded">Standard (Expanded)</option>
                <option value="diagram">Diagram-Heavy Paper</option>
                <option value="sectioned">Sectioned Paper</option>
            </select>

            <button id="mobileMenuBtn" class="mobile-menu-btn" aria-label="Toggle Navigation">
                Menu
            </button>
        </div>
    </header>

    <div class="app-frame">
        <nav id="navColumn" class="nav-column" aria-label="Question Navigation">
            <div class="nav-sticky-container">
                <div id="navList" class="nav-list">
                </div>
            </div>
        </nav>

        <main id="paperContent" class="paper-column">
        </main>
    </div>

    <script>
        /**
         * RTQ PROTOTYPE LOGIC
         * Handles data generation, DOM rendering, and interaction state.
         */

        const STATE = {
            currentPaper: 'short',
            navOpen: false
        };

        // --- SVG FACTORY ---
        const SVG_FACTORY = {
            geometry: () => `<svg viewBox="0 0 200 150" class="diagram-svg" width="300" height="225" role="img" aria-label="Triangle diagram"><path d="M20,130 L180,130 L100,20 Z" fill="none" stroke="#374151" stroke-width="2"/><text x="95" y="15" font-family="sans-serif" font-size="12" fill="#374151">A</text><text x="10" y="145" font-family="sans-serif" font-size="12" fill="#374151">B</text><text x="190" y="145" font-family="sans-serif" font-size="12" fill="#374151">C</text><text x="100" y="145" font-family="sans-serif" font-size="12" fill="#374151">10cm</text></svg>`,
            bar: () => `<svg viewBox="0 0 300 100" class="diagram-svg" width="300" height="100" role="img" aria-label="Bar chart"><rect x="10" y="10" width="280" height="30" fill="#F3F4F6" stroke="#374151"/><rect x="10" y="10" width="140" height="30" fill="#D1D5DB" /><text x="15" y="30" font-family="sans-serif" font-size="12" fill="#111827">50%</text><rect x="10" y="50" width="280" height="30" fill="#F3F4F6" stroke="#374151"/><rect x="10" y="50" width="210" height="30" fill="#D1D5DB" /><text x="15" y="70" font-family="sans-serif" font-size="12" fill="#111827">75%</text></svg>`,
            grid: () => `<svg viewBox="0 0 200 200" class="diagram-svg" width="200" height="200" role="img" aria-label="Coordinate grid"><defs><pattern id="grid" width="20" height="20" patternUnits="userSpaceOnUse"><path d="M 20 0 L 0 0 0 20" fill="none" stroke="#E5E7EB" stroke-width="1"/></pattern></defs><rect width="200" height="200" fill="url(#grid)" /><path d="M 100 0 L 100 200 M 0 100 L 200 100" stroke="#9CA3AF" stroke-width="2"/><circle cx="140" cy="60" r="4" fill="#374151"/></svg>`,
            table: () => `<svg viewBox="0 0 300 80" class="diagram-svg" width="300" height="80" role="img" aria-label="Data table"><rect x="0" y="0" width="300" height="80" fill="none" stroke="#374151"/><line x1="0" y1="40" x2="300" y2="40" stroke="#374151"/><line x1="150" y1="0" x2="150" y2="80" stroke="#374151"/><text x="10" y="25" font-family="sans-serif" font-size="14" fill="#111827">Item</text><text x="160" y="25" font-family="sans-serif" font-size="14" fill="#111827">Cost</text><text x="10" y="65" font-family="sans-serif" font-size="14" fill="#111827">Apple</text><text x="160" y="65" font-family="sans-serif" font-size="14" fill="#111827">£0.50</text></svg>`
        };

        // --- CONTENT GENERATOR ---
        // Generates dummy questions based on parameters to avoid 5000 lines of JSON
        function generateQuestions(config) {
            const questions = [];
            let count = 0;

            // Helpers
            const getWorking = (isLong) => {
                if (isLong) {
                    let w = `We start by defining the variables. Let $x$ be the unknown quantity. \n\n$$ 2x^2 + 5x - 12 = 0 $$ \n\nWe can factorise this quadratic equation by splitting the middle term. We look for two numbers that multiply to give $2 \\times -12 = -24$ and add to give $5$. These numbers are $8$ and $-3$. \n\n$$ 2x^2 + 8x - 3x - 12 = 0 $$ \n\nGroup terms: \n\n$$ 2x(x + 4) - 3(x + 4) = 0 $$ \n\n$$ (2x - 3)(x + 4) = 0 $$ \n\nTherefore, either $2x - 3 = 0$ or $x + 4 = 0$. \n\nCase 1: $2x = 3 \\implies x = 1.5$ \n\nCase 2: $x = -4$ \n\nSince the question asks for a positive length, we discard $-4$.`;
                    // Duplicate to simulate very long content
                    for (let i = 0; i < 3; i++) w += `\n\nChecking validity: Substitute $x=1.5$ back into the original equation... $$ 2(1.5)^2 + 5(1.5) - 12 = 2(2.25) + 7.5 - 12 = 4.5 + 7.5 - 12 = 0 $$ \nThe solution is consistent.`;
                    return w;
                }
                return `Calculate the total: $$ 15 + 25 = 40 $$ \nDivide by 2: $$ 40 \\div 2 = 20 $$`;
            };

            const sections = config.sections || [{ label: null, count: config.count }];

            sections.forEach(section => {
                if (section.label) {
                    questions.push({ type: 'section', label: section.label });
                }

                for (let i = 1; i <= section.count; i++) {
                    count++;
                    const qNum = section.startNum ? (section.startNum + i - 1) : count;
                    const isLong = (config.longRanges && config.longRanges.includes(qNum)) || section.allLong;
                    const hasDiagram = (config.diagramIndices && config.diagramIndices.includes(qNum));
                    const isNested = (qNum === 18 || qNum === 30) && config.hasNesting;

                    if (isNested) {
                        // Complex nested structure
                        questions.push({
                            id: `${qNum}(a)(i)`,
                            text: "Calculate the area of the base.",
                            answer: "24 cm²",
                            depth: 3,
                            details: { working: getWorking(false) }
                        });
                        questions.push({
                            id: `${qNum}(a)(ii)`,
                            text: "Hence, find the volume.",
                            answer: "120 cm³",
                            depth: 3,
                            details: { working: getWorking(false) }
                        });
                        questions.push({
                            id: `${qNum}(b)`,
                            text: "Explain why the volume would double if the height doubles.",
                            answer: "Volume is proportional to height.",
                            depth: 2,
                            details: {
                                keepInMind: "Remember the formula $V = A \\times h$",
                                working: "If $h$ becomes $2h$, then $V_{new} = A \\times 2h = 2(A \\times h) = 2V$."
                            }
                        });
                    } else {
                        // Standard Question
                        const q = {
                            id: qNum.toString(),
                            text: hasDiagram ? "Look at the diagram below. Calculate angle $x$." : `Solve the following problem relating to question ${qNum}.`,
                            answer: hasDiagram ? "45°" : (qNum * 12).toString(),
                            depth: 1,
                            diagram: hasDiagram ? (['geometry', 'bar', 'grid', 'table'][qNum % 4]) : null,
                            details: {
                                working: getWorking(isLong),
                                formulas: (qNum % 5 === 0) ? "Area of circle = $\\pi r^2$" : null,
                                keepInMind: (qNum % 7 === 0) ? "Watch out for units." : null,
                                alternative: (qNum % 6 === 0) ? "You could also solve this using a ratio table." : null
                            },
                            expandedDefault: config.expandedDefault || false
                        };
                        questions.push(q);
                    }
                }
            });
            return questions;
        }

        // --- DATASETS ---
        const DATASETS = {
            'short': () => generateQuestions({ count: 6, hasNesting: true }),
            'standard': () => generateQuestions({ count: 35, longRanges: [26, 27, 28, 29, 30, 31, 32, 33, 34, 35], hasNesting: true }),
            'standard-expanded': () => generateQuestions({ count: 35, longRanges: [26, 27, 28, 29, 30, 31, 32, 33, 34, 35], hasNesting: true, expandedDefault: true }),
            'diagram': () => generateQuestions({ count: 20, diagramIndices: [2, 4, 6, 8, 10, 12, 14, 16] }),
            'sectioned': () => generateQuestions({
                sections: [
                    { label: 'Section A', count: 35 },
                    { label: 'Section B', count: 8, startNum: 36 },
                    { label: 'Section C', count: 6, startNum: 44, allLong: true }
                ]
            })
        };

        // --- RENDER LOGIC ---

        function renderPaper() {
            const container = document.getElementById('paperContent');
            const navContainer = document.getElementById('navList');
            const data = DATASETS[STATE.currentPaper]();

            container.innerHTML = '';
            navContainer.innerHTML = '';

            let html = '';
            let navHtml = '';

            data.forEach((item, index) => {
                if (item.type === 'section') {
                    // Section Header in Paper (Not explicitly requested by brief for paper body, but good for separation)
                    // Brief says "No artificial sectioning... beyond what already exists". 
                    // We will just put a spacing divider or label.
                    html += `<div style="padding: 2rem 0 1rem; border-bottom: 2px solid #E5E7EB; margin-bottom: 3rem; font-weight:600; color:#6B7280;">${item.label}</div>`;

                    // Nav Section Label
                    navHtml += `<li class="nav-section-label">${item.label}</li>`;
                    return;
                }

                // Nav Item
                navHtml += `<li class="nav-item"><a href="#q-${item.id}" class="nav-link">${item.id}</a></li>`;

                // Question Diagram
                const diagramHtml = item.diagram ? `<div class="diagram-container">${SVG_FACTORY[item.diagram]()}</div>` : '';

                // Details Construction
                const expandedAttr = item.expandedDefault ? 'aria-expanded="true"' : 'aria-expanded="false"';
                const detailsClass = item.expandedDefault ? 'solution-details expanded' : 'solution-details';
                const btnText = item.expandedDefault ? 'Hide working' : 'Show working';
                const chevronRot = item.expandedDefault ? 'transform: rotate(180deg);' : '';

                let detailsContent = '';
                if (item.details.keepInMind) detailsContent += `<div class="detail-section"><span class="detail-label">Keep in mind</span><div class="detail-content">${item.details.keepInMind}</div></div>`;
                if (item.details.formulas) detailsContent += `<div class="detail-section"><span class="detail-label">Formulas used</span><div class="detail-content">${item.details.formulas}</div></div>`;
                detailsContent += `<div class="detail-section"><span class="detail-label">Working</span><div class="detail-content">${item.details.working}</div></div>`;
                if (item.details.alternative) detailsContent += `<div class="detail-section"><span class="detail-label">Alternative working</span><div class="detail-content">${item.details.alternative}</div></div>`;

                html += `
                <div id="q-${item.id}" class="question-block" data-depth="${item.depth}">
                    <div class="question-header">
                        <div class="q-id">${item.id}</div>
                        <div class="q-prompt">
                            ${item.text}
                            ${diagramHtml}
                        </div>
                    </div>
                    
                    <div class="answer-block">
                        <span class="answer-label">Answer:</span>
                        <span class="answer-value">${item.answer}</span>
                    </div>

                    <button class="toggle-btn" ${expandedAttr} onclick="toggleDetails(this)">
                        <span class="btn-text">${btnText}</span>
                        <svg class="chevron" viewBox="0 0 24 24" style="${chevronRot}"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"></path></svg>
                    </button>

                    <div class="${detailsClass}">
                        ${detailsContent}
                    </div>
                </div>
                `;
            });

            container.innerHTML = html;
            navContainer.innerHTML = navHtml;

            // Trigger KaTeX Render
            renderMathInElement(container, {
                delimiters: [
                    { left: '$$', right: '$$', display: true },
                    { left: '$', right: '$', display: false }
                ],
                throwOnError: false
            });

            // Setup Intersection Observer for Nav Highlighting
            setupObserver();
        }

        // --- INTERACTIONS ---

        window.toggleDetails = function (btn) {
            const isExpanded = btn.getAttribute('aria-expanded') === 'true';
            const details = btn.nextElementSibling;
            const textSpan = btn.querySelector('.btn-text');
            const chevron = btn.querySelector('.chevron');

            if (isExpanded) {
                btn.setAttribute('aria-expanded', 'false');
                details.classList.remove('expanded');
                textSpan.textContent = 'Show working';
                chevron.style.transform = 'rotate(0deg)';
            } else {
                btn.setAttribute('aria-expanded', 'true');
                details.classList.add('expanded');
                textSpan.textContent = 'Hide working';
                chevron.style.transform = 'rotate(180deg)';
            }
        };

        // Paper Selector
        document.getElementById('paperSelector').addEventListener('change', (e) => {
            STATE.currentPaper = e.target.value;
            renderPaper();
            window.scrollTo(0, 0);
        });

        // Mobile Menu
        document.getElementById('mobileMenuBtn').addEventListener('click', () => {
            const nav = document.getElementById('navColumn');
            STATE.navOpen = !STATE.navOpen;
            if (STATE.navOpen) {
                nav.classList.add('is-open');
                document.getElementById('mobileMenuBtn').textContent = 'Close';
            } else {
                nav.classList.remove('is-open');
                document.getElementById('mobileMenuBtn').textContent = 'Menu';
            }
        });

        // Close mobile menu on link click
        document.getElementById('navList').addEventListener('click', (e) => {
            if (e.target.classList.contains('nav-link') && window.innerWidth <= 768) {
                STATE.navOpen = false;
                document.getElementById('navColumn').classList.remove('is-open');
                document.getElementById('mobileMenuBtn').textContent = 'Menu';
            }
        });

        // Intersection Observer for Active Nav State
        function setupObserver() {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const id = entry.target.id.replace('q-', '');
                        // Clear active
                        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                        // Set active
                        const activeLink = Array.from(document.querySelectorAll('.nav-link')).find(l => l.textContent === id);
                        if (activeLink) {
                            activeLink.classList.add('active');
                            // Optional: Scroll nav to view
                            activeLink.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                        }
                    }
                });
            }, { rootMargin: '-10% 0px -80% 0px' }); // Trigger near top

            document.querySelectorAll('.question-block').forEach(q => observer.observe(q));
        }

        // --- INIT ---
        renderPaper();

    </script>
</body>

</html>