<!DOCTYPE html>
<html lang="en-GB">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ – Maths Paper Solution Viewer</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"
        integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"
        integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8"
        crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"
        integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05"
        crossorigin="anonymous"></script>

    <style>
        /* =========================================
           STAGE 4/5: DESIGN SYSTEM TOKENS
           Soft-warm neutral base, restrained accent
           ========================================= */
        :root {
            /* Surfaces */
            --color-bg-page: #f7f7f5;
            --color-bg-content: #ffffff;
            --color-bg-solution: #fafaf9;
            --color-bg-math-block: #f4f4f2;
            /* Very subtle underlay for math blocks */

            /* Typography */
            --color-text-primary: #171717;
            /* Question text anchor */
            --color-text-secondary: #404040;
            /* Answer/Details */
            --color-text-tertiary: #525252;
            /* Nav/Meta */
            --color-text-quiet: #737373;

            /* Accent (Restrained Blue - Function Only) */
            --color-accent: #2563eb;
            --color-accent-hover: #1d4ed8;
            --color-focus-ring: rgba(37, 99, 235, 0.4);

            /* Borders & Dividers */
            --color-border-hairline: #e5e5e5;
            --color-border-subtle: #d4d4d4;

            /* Spacing Scale */
            --space-xs: 0.25rem;
            --space-sm: 0.5rem;
            --space-md: 1rem;
            --space-lg: 1.5rem;
            --space-xl: 2.5rem;
            /* Between questions */
            --space-xxl: 4rem;

            /* Typography Scale */
            --font-family: 'Inter', system-ui, -apple-system, sans-serif;
            --text-sm: 0.875rem;
            --text-base: 1rem;
            --text-lg: 1.125rem;
            --text-xl: 1.25rem;

            /* Layout */
            --layout-width: 1024px;
            --nav-width: 200px;
        }

        /* =========================================
           RESET & BASE
           ========================================= */
        *,
        *::before,
        *::after {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: var(--font-family);
            background-color: var(--color-bg-page);
            color: var(--color-text-primary);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        /* Focus Management - Stage 5.5.2 */
        :focus-visible {
            outline: 2px solid var(--color-accent);
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* =========================================
           LAYOUT SHELL
           Single centered frame containing Nav & Content
           ========================================= */
        .app-shell {
            max-width: var(--layout-width);
            margin: 0 auto;
            min-height: 100vh;
            background-color: var(--color-bg-page);
            /* Unified surface */
            position: relative;
            display: grid;
            grid-template-columns: var(--nav-width) 1fr;
            grid-template-rows: auto 1fr;
        }

        /* Top Bar (Paper Selector) */
        .top-bar {
            grid-column: 1 / -1;
            padding: var(--space-md) var(--space-lg);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: var(--color-bg-page);
            z-index: 10;
        }

        .paper-selector-label {
            font-size: var(--text-sm);
            color: var(--color-text-tertiary);
            margin-right: var(--space-sm);
        }

        .paper-selector {
            font-family: inherit;
            font-size: var(--text-sm);
            padding: var(--space-xs) var(--space-sm);
            border: 1px solid var(--color-border-subtle);
            border-radius: 4px;
            background-color: var(--color-bg-content);
            color: var(--color-text-primary);
            cursor: pointer;
        }

        /* Mobile Nav Toggle (Hidden on Desktop) */
        .mobile-nav-toggle {
            display: none;
            background: none;
            border: none;
            color: var(--color-text-secondary);
            font-size: var(--text-sm);
            cursor: pointer;
            padding: var(--space-sm);
        }

        /* =========================================
           NAVIGATION RAIL (Desktop Sticky)
           Stage 5.4 - Peripheral, Persistent, Quiet
           ========================================= */
        .nav-rail {
            grid-column: 1 / 2;
            padding: var(--space-lg) var(--space-sm) var(--space-lg) var(--space-lg);
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
            /* Scrollbar hiding technique */
            scrollbar-width: none;
            /* Firefox */
            -ms-overflow-style: none;
            /* IE 10+ */
        }

        .nav-rail::-webkit-scrollbar {
            display: none;
            /* Chrome/Safari */
        }

        .nav-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: var(--space-xs);
        }

        .nav-section-label {
            font-size: var(--text-sm);
            font-weight: 600;
            color: var(--color-text-tertiary);
            margin-top: var(--space-md);
            margin-bottom: var(--space-xs);
            padding-left: var(--space-sm);
        }

        .nav-item {
            display: block;
            padding: var(--space-xs) var(--space-sm);
            font-size: var(--text-sm);
            color: var(--color-text-tertiary);
            /* Quiet by default */
            text-decoration: none;
            border-radius: 4px;
            transition: color 0.15s ease, font-weight 0.15s ease;
            cursor: pointer;
        }

        .nav-item:hover {
            color: var(--color-text-primary);
            background-color: rgba(0, 0, 0, 0.03);
            /* Extremely subtle hover */
        }

        .nav-item.active {
            font-weight: 700;
            color: var(--color-accent);
            /* Restrained accent for current state */
        }

        /* =========================================
           PAPER CONTENT
           Continuous vertical scroll
           ========================================= */
        .paper-content {
            grid-column: 2 / 3;
            padding: var(--space-lg) var(--space-lg) var(--space-xxl) var(--space-lg);
            background-color: var(--color-bg-content);
            /* Content Surface */
            min-height: 80vh;
        }

        /* Question Block */
        .question-block {
            margin-bottom: var(--space-xl);
            /* Vertical rhythm: Largest spacing */
            scroll-margin-top: 2rem;
            /* Smooth scroll offset */
        }

        .question-header {
            display: flex;
            align-items: baseline;
            gap: var(--space-sm);
            margin-bottom: var(--space-sm);
        }

        .question-id {
            font-weight: 600;
            font-size: var(--text-base);
            color: var(--color-text-tertiary);
            min-width: 1.5rem;
            flex-shrink: 0;
        }

        .question-text {
            font-size: var(--text-lg);
            color: var(--color-text-primary);
            line-height: 1.6;
        }

        /* Sub-question nesting (Indentation only) */
        .question-block[data-indent="1"] {
            margin-left: var(--space-lg);
            margin-bottom: var(--space-lg);
        }

        .question-block[data-indent="2"] {
            margin-left: calc(var(--space-lg) * 2);
            margin-bottom: var(--space-md);
        }

        /* Diagrams */
        .diagram-container {
            margin: var(--space-md) 0;
            display: flex;
            justify-content: flex-start;
        }

        .diagram-svg {
            max-width: 100%;
            height: auto;
            border: 1px solid var(--color-border-subtle);
            /* Visual placeholder boundary */
            background: #fafafa;
        }

        /* Answer Section */
        .answer-section {
            margin-top: var(--space-sm);
            /* Tight to question */
            margin-bottom: var(--space-sm);
            padding-left: calc(1.5rem + var(--space-sm));
            /* Align with text */
        }

        .answer-label {
            font-size: var(--text-sm);
            font-weight: 700;
            color: var(--color-text-secondary);
            margin-right: var(--space-xs);
        }

        .answer-value {
            font-size: var(--text-base);
            font-weight: 500;
            color: var(--color-text-primary);
        }

        /* Solution Details Toggle */
        .toggle-btn {
            background: none;
            border: none;
            padding: 0;
            margin-left: calc(1.5rem + var(--space-sm));
            margin-top: var(--space-xs);
            font-family: inherit;
            font-size: var(--text-sm);
            color: var(--color-accent);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }

        .toggle-btn:hover {
            color: var(--color-accent-hover);
            text-decoration: underline;
        }

        .chevron {
            transition: transform 0.2s ease;
            width: 16px;
            height: 16px;
            fill: currentColor;
        }

        .toggle-btn[aria-expanded="true"] .chevron {
            transform: rotate(180deg);
        }

        /* Solution Details Region */
        .solution-details {
            margin-top: var(--space-sm);
            margin-left: calc(1.5rem + var(--space-sm));
            background-color: var(--color-bg-solution);
            /* Subtle differentiation */
            border-top: 1px solid var(--color-border-hairline);
            /* Option C Divider */
            padding: var(--space-md);
            display: none;
            /* Collapsed by default */
            font-size: var(--text-base);
            color: var(--color-text-secondary);
        }

        .solution-details[data-visible="true"] {
            display: block;
            animation: slideDown 0.2s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Sub-blocks inside Solution Details */
        .details-block {
            margin-bottom: var(--space-md);
        }

        .details-block:last-child {
            margin-bottom: 0;
        }

        .details-label {
            font-size: var(--text-sm);
            font-weight: 700;
            color: var(--color-text-tertiary);
            margin-bottom: var(--space-xs);
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }

        /* Keep in Mind (Guidance) */
        .keep-in-mind {
            /* Slightly higher contrast than working body */
            color: var(--color-text-secondary);
        }

        .keep-in-mind ul {
            margin: 0;
            padding-left: var(--space-lg);
            list-style-type: disc;
        }

        /* Formulas Used */
        .formulas-used ul {
            margin: 0;
            padding: 0;
            list-style: none;
        }

        .formulas-used li {
            margin-bottom: var(--space-xs);
            font-family: inherit;
        }

        /* Working / Alternative Working */
        .working-block {
            /* Mixed prose + math rhythm */
        }

        .working-prose {
            margin-bottom: var(--space-sm);
        }

        /* KaTeX Overrides & Constraints */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            padding: var(--space-xs) 0;
            margin: var(--space-sm) 0;
            /* Stage 3 Override: Subtle underlay for display math only */
            background-color: var(--color-bg-math-block);
            border-radius: 2px;
            /* Hide scrollbar visually but keep functional */
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .katex-display::-webkit-scrollbar {
            display: none;
        }

        /* Inline KaTeX: Transparent background invariant */
        .katex {
            background-color: transparent !important;
        }

        /* Tables inside workings */
        .working-table-wrapper {
            overflow-x: auto;
            margin: var(--space-sm) 0;
        }

        .working-table {
            width: 100%;
            border-collapse: collapse;
            font-size: var(--text-sm);
        }

        .working-table th,
        .working-table td {
            padding: var(--space-sm);
            border: 1px solid var(--color-border-subtle);
            /* Light gridlines */
            text-align: left;
        }

        .working-table th {
            font-weight: 600;
        }

        /* =========================================
           RESPONSIVE (Mobile/Tablet)
           ========================================= */
        @media (max-width: 768px) {
            .app-shell {
                display: block;
                /* Stack layout */
            }

            .nav-rail {
                /* Option A: Drawer */
                position: fixed;
                top: 0;
                left: 0;
                width: 80%;
                /* Drawer width */
                max-width: 300px;
                background-color: var(--color-bg-page);
                z-index: 100;
                box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .nav-rail.open {
                transform: translateX(0);
            }

            .nav-overlay {
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.4);
                z-index: 90;
                display: none;
            }

            .nav-overlay.open {
                display: block;
            }

            .mobile-nav-toggle {
                display: block;
                /* Show hamburger */
            }

            .paper-content {
                padding: var(--space-md);
            }

            .question-text {
                font-size: var(--text-base);
            }

            /* Indentation reduction for deep nesting on mobile */
            .question-block[data-indent="1"] {
                margin-left: var(--space-md);
            }

            .question-block[data-indent="2"] {
                margin-left: var(--space-lg);
            }
        }
    </style>
</head>

<body>

    <div class="app-shell">
        <div class="nav-overlay" id="navOverlay"></div>

        <header class="top-bar">
            <div style="display:flex; align-items:center;">
                <button class="mobile-nav-toggle" id="mobileNavToggle" aria-label="Menu">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 12h18M3 6h18M3 18h18" />
                    </svg>
                </button>
                <div style="margin-left: 8px;">
                    <span class="paper-selector-label">Paper:</span>
                    <select id="paperSelector" class="paper-selector" aria-label="Select Paper">
                        <option value="standard">Standard Paper</option>
                        <option value="short">Short Paper</option>
                        <option value="diagram">Diagram-heavy Paper</option>
                        <option value="sectioned">Sectioned Paper</option>
                        <option value="expanded">Standard (Workings Expanded)</option>
                    </select>
                </div>
            </div>
        </header>

        <nav class="nav-rail" id="navRail" aria-label="Question Navigation">
            <ul class="nav-list" id="navList">
            </ul>
        </nav>

        <main class="paper-content" id="paperContent">
        </main>
    </div>

    <script>
        // =========================================
        // DATA GENERATION & CONTENT
        // =========================================

        // Utility: SVG Generators (Grayscale Placeholders)
        const svgs = {
            bar: `<svg class="diagram-svg" width="300" height="100" viewBox="0 0 300 100" xmlns="http://www.w3.org/2000/svg">
                <rect x="10" y="10" width="280" height="80" fill="#f5f5f5" stroke="#ccc" />
                <rect x="10" y="30" width="140" height="40" fill="#e0e0e0" stroke="#999" />
                <text x="15" y="25" font-family="sans-serif" font-size="12" fill="#666">Total</text>
              </svg>`,
            geometry: `<svg class="diagram-svg" width="200" height="150" viewBox="0 0 200 150" xmlns="http://www.w3.org/2000/svg">
                     <path d="M20 130 L100 20 L180 130 Z" fill="none" stroke="#444" stroke-width="2"/>
                     <circle cx="100" cy="90" r="20" fill="#eee" stroke="#ccc"/>
                     <text x="90" y="95" font-family="sans-serif" font-size="12" fill="#444">x</text>
                   </svg>`,
            grid: `<svg class="diagram-svg" width="200" height="200" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                 <defs><pattern id="grid" width="20" height="20" patternUnits="userSpaceOnUse"><path d="M 20 0 L 0 0 0 20" fill="none" stroke="#e5e5e5" stroke-width="1"/></pattern></defs>
                 <rect width="100%" height="100%" fill="url(#grid)" />
                 <line x1="100" y1="0" x2="100" y2="200" stroke="#444" />
                 <line x1="0" y1="100" x2="200" y2="100" stroke="#444" />
               </svg>`,
            shape: `<svg class="diagram-svg" width="150" height="150" viewBox="0 0 150 150" xmlns="http://www.w3.org/2000/svg">
                  <rect x="25" y="25" width="50" height="50" fill="#ddd" stroke="#666"/>
                  <rect x="75" y="25" width="50" height="50" fill="none" stroke="#666"/>
                  <rect x="25" y="75" width="50" height="50" fill="none" stroke="#666"/>
                  <text x="45" y="55" font-family="sans-serif" font-size="14" fill="#333">A</text>
                </svg>`
        };

        // Data Factory
        function createQuestion(id, text, answer, details, options = {}) {
            return {
                id,
                text,
                answer,
                details: { // Map to Grammar
                    guidance: details.guidance || null,
                    formulas: details.formulas || null,
                    working: details.working || [], // Array of blocks (string for prose, '$$...$$' for block math)
                    alternative: details.alternative || null
                },
                hasDiagram: options.hasDiagram || false,
                diagramType: options.diagramType || 'bar',
                indent: options.indent || 0,
                section: options.section || null,
                longWorking: options.longWorking || false
            };
        }

        // Exemplar-inspired Content Generators
        const generateShortPaper = () => [
            createQuestion("1", "Fill in the missing numbers in the box: $55 + \\boxed{\\phantom{00}} = 82$", "27", {
                working: ["Let the missing number $= a$", "$$55 + a = 82$$", "$$a = 82 - 55$$", "$$a = 27$$"]
            }),
            createQuestion("2", "Add together $308, 86$ and $4444$.", "4838", {
                working: ["Set up the column addition:", "$$\\begin{array}{cccc} & 3 & 0 & 8 \\\\ & & 8 & 6 \\\\ + & 4 & 4 & 4 & 4 \\\\ \\hline & 4 & 8 & 3 & 8 \\end{array}$$"]
            }),
            createQuestion("3", "Subtract three hundred and three from six thousand and sixty.", "5757", {
                guidance: ["Translate words to numbers carefully."],
                working: ["$$6060 - 303 = 5757$$"]
            }),
            createQuestion("4", "Multiply $345$ by $67$.", "23115", {
                working: ["$$345 \\times 67 = 23115$$"]
            }),
            createQuestion("5", "Divide $3112$ by $8$.", "389", {
                working: ["$$3112 \\div 8 = 389$$"]
            }),
            createQuestion("6", "Angus and his six friends have collected $756$ stickers. They share them equally. How many does each get?", "108", {
                guidance: ["Don't forget to include Angus in the count of people!"],
                working: ["Total people $= 1 + 6 = 7$", "$$\\frac{756}{7} = 108$$"]
            })
        ];

        const generateLongWorkingLines = () => {
            let lines = ["Let us solve this step-by-step using first principles."];
            for (let i = 0; i < 50; i++) {
                lines.push(`$$x_{${i}} = \\frac{(${i}^2 + 3x)}{2y} \\times \\sqrt{${i + 1}}$$`);
                lines.push(`Rearranging terms for step ${i + 1}...`);
            }
            lines.push("Therefore, the final value converges to the answer.");
            return lines;
        };

        const generateStandardPaper = () => {
            let questions = [];
            // Mix of arithmetic
            questions.push(createQuestion("1", "Calculate $13 \\times (12 + 8) \\div 2$", "130", {
                guidance: ["Use BIDMAS."],
                working: ["$$= 13 \\times 20 \\div 2$$", "$$= 260 \\div 2$$", "$$= 130$$"]
            }));

            // Deep Nesting Example (Q18)
            questions.push(createQuestion("18", "Here is a sequence of numbers: 3, 7, 11, 15...", "", {}, {}));
            questions.push(createQuestion("18(a)(i)", "Write the next number.", "19", { working: ["$$15 + 4 = 19$$"] }, { indent: 1 }));
            questions.push(createQuestion("18(a)(ii)", "Find the 10th term.", "39", {
                formulas: ["$n^{th} \\text{ term} = dn + (a - d)$"],
                working: ["$d = 4, a = 3$", "$$4(10) + (3 - 4) = 40 - 1 = 39$$"]
            }, { indent: 1 }));
            questions.push(createQuestion("18(b)", "Is 99 in the sequence? Explain.", "Yes", {
                working: ["$$4n - 1 = 99$$", "$$4n = 100$$", "$$n = 25$$", "Since $n$ is a whole number, yes."]
            }, { indent: 1 }));

            // Fill gap to 26
            for (let i = 19; i < 26; i++) {
                questions.push(createQuestion(`${i}`, `Question placeholder text for number ${i}.`, `${i * 2}`, { working: [`Calculation for ${i}`] }));
            }

            // Long Algebra Q26-35
            for (let i = 26; i <= 35; i++) {
                questions.push(createQuestion(`${i}`, `Solve for $x$: $${i}x^2 + 5x - ${i * 10} = 0$`, "x=5", {
                    guidance: ["This requires factorization or the quadratic formula."],
                    formulas: ["$x = \\frac{-b \\pm \\sqrt{b^2 - 4ac}}{2a}$"],
                    working: i === 30 ? generateLongWorkingLines() : ["Apply formula...", "$$x = \\dots$$"], // Q30 is extremely long
                    alternative: ["Graphical method finding intercepts."]
                }, { longWorking: true }));
            }
            return questions;
        };

        const generateDiagramPaper = () => {
            let qs = [];
            for (let i = 1; i <= 20; i++) {
                const hasDiag = i % 3 === 0;
                qs.push(createQuestion(`${i}`, hasDiag ? "Find the area of the shape shown." : `Calculate ${i} + ${i}`, hasDiag ? "50 cm²" : `${2 * i}`, {
                    working: hasDiag ? ["Split into rectangles.", "$$A = 5 \\times 10 = 50$$"] : ["$$2 \\times i$$"]
                }, { hasDiagram: hasDiag, diagramType: i % 2 === 0 ? 'geometry' : 'bar' }));
            }
            return qs;
        };

        const generateSectionedPaper = () => {
            let qs = [];
            // Section A
            for (let i = 1; i <= 5; i++) qs.push(createQuestion(`${i}`, `Section A Question ${i}`, "10", { working: ["Simple step"] }, { section: "Section A" }));
            // Section B
            for (let i = 1; i <= 3; i++) qs.push(createQuestion(`B${i}`, `Section B Question ${i}`, "20", { working: ["Medium step"] }, { section: "Section B" }));
            // Section C (Long details)
            for (let i = 1; i <= 6; i++) qs.push(createQuestion(`C${i}`, `Complex Problem ${i}`, "100", {
                guidance: ["Read carefully."],
                formulas: ["$E=mc^2$"],
                working: generateLongWorkingLines(),
                alternative: ["Estimation method."]
            }, { section: "Section C" }));
            return qs;
        };

        // Dataset Registry
        const datasets = {
            short: generateShortPaper(),
            standard: generateStandardPaper(),
            expanded: generateStandardPaper(), // Flag handled in rendering
            diagram: generateDiagramPaper(),
            sectioned: generateSectionedPaper()
        };

        // =========================================
        // RENDERING LOGIC
        // =========================================

        const paperContentEl = document.getElementById('paperContent');
        const navListEl = document.getElementById('navList');
        const paperSelector = document.getElementById('paperSelector');
        const navRail = document.getElementById('navRail');
        const navOverlay = document.getElementById('navOverlay');

        let currentDatasetKey = 'standard';

        function renderPaper(datasetKey) {
            // Clear
            paperContentEl.innerHTML = '';
            navListEl.innerHTML = '';

            const data = datasets[datasetKey];
            const isExpandedMode = datasetKey === 'expanded';
            let lastSection = null;

            data.forEach((q, index) => {
                // Section Headers (Non-clickable separators)
                if (q.section && q.section !== lastSection) {
                    const secHeader = document.createElement('li');
                    secHeader.className = 'nav-section-label';
                    secHeader.textContent = q.section;
                    navListEl.appendChild(secHeader);

                    const pageHeader = document.createElement('h2');
                    pageHeader.textContent = q.section;
                    pageHeader.style.cssText = "font-size: var(--text-xl); margin-top: var(--space-xl); border-bottom: 1px solid var(--color-border-subtle); padding-bottom: var(--space-sm); color: var(--color-text-primary); font-weight: 600;";
                    paperContentEl.appendChild(pageHeader);

                    lastSection = q.section;
                }

                // --- 1. Navigation Item ---
                const navItem = document.createElement('li');
                const navLink = document.createElement('a');
                navLink.className = 'nav-item';
                navLink.textContent = q.id;
                navLink.href = `#q-${index}`;
                navLink.onclick = (e) => {
                    e.preventDefault();
                    document.getElementById(`q-${index}`).scrollIntoView({ behavior: 'smooth' });
                    updateActiveNav(navLink);
                    if (window.innerWidth <= 768) closeMobileNav();
                };
                navItem.appendChild(navLink);
                navListEl.appendChild(navItem);

                // --- 2. Question Block ---
                const qBlock = document.createElement('div');
                qBlock.className = 'question-block';
                qBlock.id = `q-${index}`;
                if (q.indent) qBlock.setAttribute('data-indent', q.indent);

                // Question Header (ID + Text)
                const qHeader = document.createElement('div');
                qHeader.className = 'question-header';
                qHeader.innerHTML = `
                <span class="question-id">${q.id}</span>
                <div class="question-text">${q.text}</div>
            `;
                qBlock.appendChild(qHeader);

                // Diagram (if present)
                if (q.hasDiagram) {
                    const diagContainer = document.createElement('div');
                    diagContainer.className = 'diagram-container';
                    diagContainer.innerHTML = svgs[q.diagramType] || svgs.bar;
                    qBlock.appendChild(diagContainer);
                }

                // Answer
                if (q.answer) {
                    const ansDiv = document.createElement('div');
                    ansDiv.className = 'answer-section';
                    ansDiv.innerHTML = `<span class="answer-label">Answer</span><span class="answer-value">${q.answer}</span>`;
                    qBlock.appendChild(ansDiv);
                }

                // Toggle Button
                const toggleId = `details-${index}`;
                const toggleBtn = document.createElement('button');
                toggleBtn.className = 'toggle-btn';
                toggleBtn.setAttribute('aria-expanded', isExpandedMode);
                toggleBtn.setAttribute('aria-controls', toggleId);
                toggleBtn.innerHTML = `
                <span class="btn-text">${isExpandedMode ? 'Hide working' : 'Show working'}</span>
                <svg class="chevron" viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"></path></svg>
            `;
                qBlock.appendChild(toggleBtn);

                // Solution Details Region
                const detailsDiv = document.createElement('div');
                detailsDiv.className = 'solution-details';
                detailsDiv.id = toggleId;
                if (isExpandedMode) detailsDiv.setAttribute('data-visible', 'true');

                // --- Construct Details Content ---

                // Keep in mind (Guidance)
                if (q.details.guidance) {
                    const kimBlock = document.createElement('div');
                    kimBlock.className = 'details-block keep-in-mind';
                    kimBlock.innerHTML = `
                    <div class="details-label">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                        Keep in mind
                    </div>
                    <ul>${q.details.guidance.map(g => `<li>${g}</li>`).join('')}</ul>
                `;
                    detailsDiv.appendChild(kimBlock);
                }

                // Formulas Used
                if (q.details.formulas) {
                    const formBlock = document.createElement('div');
                    formBlock.className = 'details-block formulas-used';
                    formBlock.innerHTML = `
                    <div class="details-label">Formulas used</div>
                    <ul>${q.details.formulas.map(f => `<li>${f}</li>`).join('')}</ul>
                `;
                    detailsDiv.appendChild(formBlock);
                }

                // Working (Primary)
                if (q.details.working && q.details.working.length > 0) {
                    const workBlock = document.createElement('div');
                    workBlock.className = 'details-block working-block';
                    workBlock.innerHTML = `<div class="details-label">Working</div>`;

                    q.details.working.forEach(line => {
                        const p = document.createElement('div');
                        p.className = 'working-prose';
                        p.innerHTML = line; // KaTeX auto-render will handle $$...$$
                        workBlock.appendChild(p);
                    });
                    detailsDiv.appendChild(workBlock);
                }

                // Alternative Working
                if (q.details.alternative) {
                    const altBlock = document.createElement('div');
                    altBlock.className = 'details-block working-block';
                    altBlock.innerHTML = `<div class="details-label">Alternative working</div>`;
                    q.details.alternative.forEach(line => {
                        const p = document.createElement('div');
                        p.className = 'working-prose';
                        p.innerHTML = line;
                        altBlock.appendChild(p);
                    });
                    detailsDiv.appendChild(altBlock);
                }

                qBlock.appendChild(detailsDiv);
                paperContentEl.appendChild(qBlock);

                // Toggle Interaction
                toggleBtn.onclick = () => {
                    const isExpanded = toggleBtn.getAttribute('aria-expanded') === 'true';
                    toggleBtn.setAttribute('aria-expanded', !isExpanded);
                    toggleBtn.querySelector('.btn-text').textContent = !isExpanded ? 'Hide working' : 'Show working';

                    if (!isExpanded) {
                        detailsDiv.style.display = 'block';
                        requestAnimationFrame(() => detailsDiv.setAttribute('data-visible', 'true'));
                    } else {
                        detailsDiv.removeAttribute('data-visible');
                        setTimeout(() => { if (toggleBtn.getAttribute('aria-expanded') === 'false') detailsDiv.style.display = 'none'; }, 200);
                    }
                };
            });

            // Apply KaTeX
            renderMathInElement(paperContentEl, {
                delimiters: [
                    { left: '$$', right: '$$', display: true },
                    { left: '$', right: '$', display: false }
                ],
                throwOnError: false
            });
        }

        // Navigation State
        function updateActiveNav(activeLink) {
            document.querySelectorAll('.nav-item').forEach(l => l.classList.remove('active'));
            activeLink.classList.add('active');
        }

        // Scroll Spy for Nav
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const id = entry.target.id;
                    const index = id.split('-')[1];
                    const navLinks = document.querySelectorAll('.nav-item');
                    if (navLinks[index]) updateActiveNav(navLinks[index]);
                }
            });
        }, { rootMargin: '-10% 0px -80% 0px' }); // Trigger near top

        function attachScrollSpy() {
            document.querySelectorAll('.question-block').forEach(block => observer.observe(block));
        }

        // Mobile Nav Logic
        const mobileNavToggle = document.getElementById('mobileNavToggle');

        function openMobileNav() {
            navRail.classList.add('open');
            navOverlay.classList.add('open');
        }

        function closeMobileNav() {
            navRail.classList.remove('open');
            navOverlay.classList.remove('open');
        }

        mobileNavToggle.onclick = openMobileNav;
        navOverlay.onclick = closeMobileNav;

        // Initialization
        paperSelector.onchange = (e) => {
            renderPaper(e.target.value);
            attachScrollSpy();
            window.scrollTo(0, 0);
        };

        // Initial Render
        renderPaper('standard');
        attachScrollSpy();

    </script>
</body>

</html>