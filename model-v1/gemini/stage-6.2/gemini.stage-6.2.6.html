<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Maths Paper Viewer</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <style>
        /* =========================================
           STAGE 0: CONSTANTS & VARIABLES
           ========================================= */
        :root {
            /* Palette: Warm Neutrals (Stage 5.3) */
            --c-bg-page: #fcfcfb;
            --c-bg-surface: #fcfcfb;
            /* Same as page for unified feel */
            --c-text-primary: #1a1a18;
            --c-text-secondary: #525250;
            --c-text-tertiary: #737370;

            /* Accent (Stage 5.3.2 Override + 6.0.10) - Emphasis only, no semantic meaning */
            --c-accent: #2563eb;

            /* Structural Colors */
            --c-divider: #e5e5e0;
            --c-math-underlay: #f4f4f2;
            /* Subtle display math underlay (Stage 3 Override) */
            --c-focus-ring: var(--c-accent);

            /* Typography (Stage 4.8) */
            --font-family: 'Inter', system-ui, -apple-system, sans-serif;
            --font-size-base: 16px;
            --line-height-base: 1.5;
            --line-height-heading: 1.3;

            /* Spacing (Stage 3 Rhythm) */
            --sp-xs: 0.25rem;
            --sp-sm: 0.5rem;
            --sp-md: 1rem;
            --sp-lg: 1.5rem;
            --sp-xl: 2.5rem;
            /* Between top-level questions */
            --sp-xxl: 4rem;

            /* Layout */
            --w-content-max: 1024px;
            /* Centered frame */
            --w-nav-rail: 200px;
            --w-drawer: 280px;
        }

        /* =========================================
           RESET & BASE
           ========================================= */
        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--c-bg-page);
            color: var(--c-text-primary);
            line-height: var(--line-height-base);
            font-size: var(--font-size-base);
            -webkit-font-smoothing: antialiased;
        }

        button {
            font-family: inherit;
            cursor: pointer;
            border: none;
            background: none;
        }

        a {
            color: var(--c-accent);
            text-decoration: none;
        }

        /* Focus States (Stage 5.5.2) */
        :focus-visible {
            outline: 2px solid var(--c-focus-ring);
            outline-offset: 2px;
        }

        /* =========================================
           LAYOUT SHELL (Stage 3 Canonical Wrapper)
           ========================================= */
        .app-shell {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .top-controls {
            padding: var(--sp-md);
            border-bottom: 1px solid var(--c-divider);
            background: var(--c-bg-page);
            z-index: 10;
        }

        .center-frame {
            max-width: var(--w-content-max);
            margin: 0 auto;
            width: 100%;
            display: flex;
            /* For aligning controls with content */
            flex-direction: column;
        }

        .paper-selector {
            padding: var(--sp-sm);
            font-size: 1rem;
            border: 1px solid var(--c-divider);
            border-radius: 4px;
            background: #fff;
            color: var(--c-text-primary);
        }

        /* Main Content Area: Grid for Desktop */
        .main-stage {
            flex: 1;
            display: grid;
            grid-template-columns: var(--w-nav-rail) 1fr;
            max-width: var(--w-content-max);
            margin: 0 auto;
            width: 100%;
            position: relative;
        }

        /* Navigation Column */
        .nav-col {
            padding-top: var(--sp-xl);
            padding-right: var(--sp-md);
        }

        /* Sticky Rail (Stage 6.0.9) */
        .nav-rail {
            position: sticky;
            top: var(--sp-xl);
            max-height: calc(100vh - var(--sp-xl) * 2);
            overflow-y: auto;
            /* Hide scrollbars visually */
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .nav-rail::-webkit-scrollbar {
            display: none;
        }

        /* Paper Content Column */
        .paper-content-col {
            padding-top: var(--sp-xl);
            padding-bottom: var(--sp-xxl);
            padding-left: var(--sp-lg);
            padding-right: var(--sp-lg);
            /* Gutter */
            min-width: 0;
            /* Prevent grid blowout */
        }

        /* =========================================
           NAVIGATION STYLING (Stage 6.1N Hardening)
           ========================================= */
        /* Base: reset to prevent markers/slots/transitions */
        [data-nav-id] {
            display: block;
            width: 100%;
            text-align: left;
            padding: var(--sp-xs) 0;
            color: var(--c-text-secondary);
            /* Default text color */
            background: transparent;
            border: 0;
            text-decoration: none;
            transition: none;
            /* avoid colour-transition drift */
            font-size: 0.9rem;
        }

        /* Prevent pseudo-element markers */
        [data-nav-id]::before,
        [data-nav-id]::after {
            content: none !important;
        }

        /* Hover: underline only (no colour / bg / border changes) */
        [data-nav-id]:hover {
            text-decoration: underline;
            color: var(--c-text-secondary);
            background: transparent;
            border: 0;
        }

        /* Focus: outline only (no bg / border changes) */
        [data-nav-id]:focus-visible {
            outline: 2px solid var(--c-accent);
            outline-offset: 2px;
            background: transparent;
            border: 0;
        }

        /* Active: weight-only (no colour / bg / border changes) */
        [data-nav-id][aria-current="true"] {
            font-weight: 700;
            color: var(--c-text-secondary);
            /* Remains secondary, weight carries signal */
            background: transparent;
            border: 0;
            text-decoration: none;
        }

        /* Section Separators in Nav */
        .nav-section-label {
            display: block;
            margin-top: var(--sp-md);
            margin-bottom: var(--sp-xs);
            font-weight: 600;
            color: var(--c-text-tertiary);
            font-size: 0.85rem;
            cursor: default;
        }

        .nav-section-label:first-child {
            margin-top: 0;
        }

        /* =========================================
           MOBILE NAVIGATION (Drawer - Stage 6.0.6 Option A)
           ========================================= */
        .mobile-header {
            display: none;
            /* Hidden on desktop */
            padding: var(--sp-md);
            border-bottom: 1px solid var(--c-divider);
            background: var(--c-bg-page);
            align-items: center;
            justify-content: space-between;
        }

        .drawer-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.3);
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }

        .drawer-backdrop.open {
            opacity: 1;
            pointer-events: auto;
        }

        /* Drawer panel must be left-anchored (never right-anchored) */
        .drawer-panel {
            position: fixed;
            top: 0;
            left: 0;
            /* Authoritative anchoring */
            right: auto;
            width: var(--w-drawer);
            height: 100vh;
            background: var(--c-bg-page);
            box-shadow: 2px 0 12px rgba(0, 0, 0, 0.1);
            transform: translateX(-100%);
            transition: transform 0.25s cubic-bezier(0.16, 1, 0.3, 1);
            z-index: 101;
            display: flex;
            flex-direction: column;
            padding: var(--sp-md);
        }

        .drawer-backdrop.open .drawer-panel {
            transform: translateX(0);
        }

        .drawer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--sp-lg);
        }

        .drawer-title {
            font-weight: 600;
            color: var(--c-text-secondary);
        }

        .drawer-close {
            font-size: 1.5rem;
            line-height: 1;
            padding: var(--sp-xs);
            color: var(--c-text-secondary);
        }

        .mobile-jump-btn {
            font-weight: 500;
            color: var(--c-accent);
            display: flex;
            align-items: center;
            gap: 0.5ch;
        }

        /* =========================================
           PAPER CONTENT TYPOGRAPHY & LAYOUT
           ========================================= */

        /* Question Container */
        .question-block {
            margin-bottom: var(--sp-xl);
            /* Rhythm */
        }

        /* Nested question spacing */
        .question-children {
            margin-top: var(--sp-lg);
            margin-left: var(--sp-lg);
            /* Indentation */
        }

        /* Question Header (ID + Prompt) */
        .question-header {
            margin-bottom: var(--sp-sm);
        }

        .q-id {
            font-weight: 700;
            margin-right: var(--sp-xs);
            color: var(--c-text-primary);
        }

        .q-prompt {
            display: inline;
            color: var(--c-text-primary);
        }

        .q-prompt p {
            display: inline;
            /* Keep markdown paragraphs inline with ID where possible */
        }

        .q-prompt p:not(:first-child) {
            display: block;
            margin-top: var(--sp-sm);
        }

        /* Answer Section (Stage 5.6.2) */
        .answer-block {
            margin-top: var(--sp-sm);
            margin-bottom: var(--sp-sm);
            color: var(--c-text-primary);
        }

        .answer-label {
            font-weight: 700;
            font-size: 0.9rem;
            color: var(--c-text-secondary);
            margin-right: var(--sp-xs);
        }

        /* Solution Details Toggle (Stage 5.7) */
        .solution-toggle {
            display: inline-flex;
            align-items: center;
            gap: 0.5ch;
            color: var(--c-accent);
            /* Permitted accent use */
            font-size: 0.95rem;
            font-weight: 500;
            margin-top: var(--sp-xs);
            padding: var(--sp-xs) 0;
        }

        .solution-toggle:hover {
            text-decoration: underline;
        }

        .toggle-icon {
            transition: transform 0.2s ease;
        }

        .solution-toggle[aria-expanded="true"] .toggle-icon {
            transform: rotate(180deg);
        }

        /* Solution Details Region (Stage 5.3.3 Option C) */
        .solution-details {
            display: none;
            /* Hidden by default */
            margin-top: var(--sp-md);
            padding-left: var(--sp-md);
            border-left: 1px solid var(--c-divider);
            /* Minimal hairline */
            /* No background fill by default, relies on spacing/divider */
        }

        .solution-details.visible {
            display: block;
            animation: slideDown 0.2s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Subsections: Keep in mind, Formulas used */
        .sd-subsection {
            margin-bottom: var(--sp-md);
        }

        .sd-label {
            font-weight: 700;
            font-size: 0.9rem;
            color: var(--c-text-secondary);
            margin-bottom: var(--sp-xs);
            display: block;
        }

        .sd-body {
            color: var(--c-text-secondary);
            font-size: 0.95rem;
        }

        /* Working / Alt Working (Stage 5.8) */
        .working-block {
            color: var(--c-text-secondary);
            font-size: 0.95rem;
        }

        /* Markdowns Elements inside Content */
        .markdown-content p {
            margin-bottom: var(--sp-sm);
        }

        .markdown-content ul,
        .markdown-content ol {
            margin-bottom: var(--sp-sm);
            padding-left: 1.5em;
        }

        .markdown-content table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: var(--sp-sm);
            border: 1px solid var(--c-divider);
            font-size: 0.9rem;
        }

        .markdown-content th,
        .markdown-content td {
            border: 1px solid var(--c-divider);
            padding: var(--sp-xs) var(--sp-sm);
            text-align: left;
        }

        .markdown-content th {
            font-weight: 600;
        }

        /* Inline SVG Support */
        .markdown-content svg {
            max-width: 100%;
            height: auto;
            display: block;
            margin: var(--sp-sm) 0;
        }

        /* =========================================
           MATH & KaTeX (Stage 3 + 6.0.8)
           ========================================= */

        /* Inline Math: No background */
        .katex {
            font-size: 1.1em;
        }

        /* Display Math Container Override (Stage 3 Override) */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            padding: var(--sp-sm) 0;
            margin: var(--sp-sm) 0;
            -webkit-overflow-scrolling: touch;

            /* The subtle underlay override for display math only */
            background-color: var(--c-math-underlay);
            border-radius: 2px;
        }

        /* Ensure math content doesn't force width */
        .katex-display>.katex {
            white-space: normal;
        }

        .katex-display>.katex>.katex-html {
            display: block;
            padding-left: var(--sp-xs);
            padding-right: var(--sp-xs);
        }

        /* =========================================
           MEDIA QUERIES
           ========================================= */
        @media (max-width: 768px) {
            .main-stage {
                display: block;
                /* Stack layout */
            }

            .nav-col {
                display: none;
                /* Hide desktop nav */
            }

            .mobile-header {
                display: flex;
                /* Show mobile header */
                position: sticky;
                top: 0;
                z-index: 20;
            }

            .paper-content-col {
                padding-left: var(--sp-md);
                padding-right: var(--sp-md);
            }

            .top-controls .center-frame {
                /* Hide paper selector on mobile? Not specified, assume visible in flow */
            }

            /* Adjust nesting indentation for mobile */
            .question-children {
                margin-left: var(--sp-md);
            }
        }
    </style>
</head>

<body>

    <div class="app-shell">

        <div class="top-controls">
            <div class="center-frame">
                <select id="paperSelector" class="paper-selector" aria-label="Select Paper">
                    <option value="" disabled selected>Loading papers...</option>
                </select>
            </div>
        </div>

        <div class="mobile-header">
            <div style="font-weight: 600;">Paper Viewer</div>
            <button class="mobile-jump-btn" id="mobileJumpTrigger" aria-label="Jump to question">
                <span>Jump to</span>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 6h16M4 12h16M4 18h16" />
                </svg>
            </button>
        </div>

        <div class="drawer-backdrop" id="drawerBackdrop">
            <div class="drawer-panel" id="drawerPanel" role="dialog" aria-modal="true" aria-label="Navigation">
                <div class="drawer-header">
                    <span class="drawer-title">Jump to</span>
                    <button class="drawer-close" id="drawerClose" aria-label="Close navigation">&times;</button>
                </div>
                <nav id="mobileNavList" style="flex: 1; overflow-y: auto;"></nav>
            </div>
        </div>

        <main class="main-stage">
            <nav class="nav-col">
                <div class="nav-rail" id="desktopNavList" role="navigation" aria-label="Paper Navigation">
                </div>
            </nav>

            <div class="paper-content-col" id="paperContent">
                <div style="text-align: center; color: var(--c-text-secondary); margin-top: 4rem;">
                    Select a paper to begin.
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/markdown-it@13.0.1/dist/markdown-it.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <script>
        // =========================================
        // STAGE 0: CONSTANTS (Runtime)
        // =========================================
        const RTQ_PAPERS_PAYLOAD_PATH = "../../../payload/rtq.papers.payload.json";

        // =========================================
        // MARKDOWN CONFIGURATION (Stage 6.1)
        // =========================================
        const md = window.markdownit
            ? window.markdownit({
                html: true, // allow inline SVG and other inline HTML in payload Markdown
                linkify: true,
                breaks: false, // MUST stay false: prevents <br> inside $...$ / $$...$$
            })
            : null;

        if (md) {
            // Preserve TeX backslashes: do not let markdown-it escape them before KaTeX runs
            md.inline.ruler.disable(["escape"]);
        }

        // =========================================
        // NAVIGATION HARDENING LOGIC (Stage 6.1N)
        // =========================================
        let __rtqNavObserver = null;
        let __rtqVisibleMap = new Map();

        function setCurrentNav(id) {
            // Clear current from all
            document
                .querySelectorAll('[data-nav-id][aria-current="true"]')
                .forEach((el) => el.removeAttribute("aria-current"));

            // Set current on both desktop and mobile items
            document
                .querySelectorAll(`[data-nav-id="${CSS.escape(id)}"]`)
                .forEach((el) => el.setAttribute("aria-current", "true"));
        }

        function bindNav(container) {
            if (!container) return;
            if (container.__rtqBound) return;
            container.__rtqBound = true;

            container.addEventListener("click", (e) => {
                const item = e.target.closest("[data-nav-id]");
                if (!item) return;
                e.preventDefault();

                const targetId = item.getAttribute("data-nav-id");
                const targetEl = document.getElementById(targetId);
                if (targetEl) {
                    targetEl.scrollIntoView({ behavior: "smooth", block: "start" });
                    // On mobile, close drawer
                    closeDrawer();
                }
            });
        }

        function enableScrollSpy(questionEls) {
            if (__rtqNavObserver) __rtqNavObserver.disconnect();
            __rtqVisibleMap.clear();

            __rtqNavObserver = new IntersectionObserver(
                (entries) => {
                    entries.forEach((en) => {
                        const id = en.target && en.target.id;
                        if (!id) return;
                        if (en.isIntersecting) {
                            __rtqVisibleMap.set(id, en.boundingClientRect.top);
                        } else {
                            __rtqVisibleMap.delete(id);
                        }
                    });

                    if (!__rtqVisibleMap.size) return;

                    // Choose question closest to top
                    let bestId = null;
                    let bestTop = Infinity;
                    for (const [id, top] of __rtqVisibleMap.entries()) {
                        if (top < bestTop) {
                            bestTop = top;
                            bestId = id;
                        }
                    }
                    if (bestId) setCurrentNav(bestId);
                },
                {
                    root: null,
                    threshold: [0.01, 0.1, 0.5], // Low threshold to catch long questions
                    rootMargin: "0px 0px -70% 0px",
                }
            );

            questionEls.forEach((el) => __rtqNavObserver.observe(el));

            // Initial set
            if (questionEls.length && questionEls[0].id) setCurrentNav(questionEls[0].id);
        }

        // =========================================
        // APP LOGIC
        // =========================================

        let papersData = [];
        let currentPaper = null;

        const dom = {
            selector: document.getElementById('paperSelector'),
            content: document.getElementById('paperContent'),
            desktopNav: document.getElementById('desktopNavList'),
            mobileNav: document.getElementById('mobileNavList'),
            mobileJumpTrig: document.getElementById('mobileJumpTrigger'),
            drawerBackdrop: document.getElementById('drawerBackdrop'),
            drawerClose: document.getElementById('drawerClose'),
            drawerPanel: document.getElementById('drawerPanel')
        };

        // --- Fetch Payload ---
        async function init() {
            try {
                const response = await fetch(RTQ_PAPERS_PAYLOAD_PATH);
                if (!response.ok) throw new Error("Payload missing");
                const data = await response.json();
                papersData = data.papers || [];
                renderSelector();
            } catch (err) {
                console.error(err);
                dom.content.innerHTML = '<div style="padding: 2rem; text-align: center; font-weight: 700;">PAPERS PAYLOAD MISSING</div>';
                dom.selector.disabled = true;
                dom.selector.innerHTML = '<option>Payload Error</option>';
            }
        }

        // --- Render Selector ---
        function renderSelector() {
            dom.selector.innerHTML = '<option value="" disabled selected>Select a paper...</option>';
            papersData.forEach(paper => {
                const opt = document.createElement('option');
                opt.value = paper.key;
                opt.textContent = paper.label || paper.key;
                dom.selector.appendChild(opt);
            });

            dom.selector.addEventListener('change', (e) => {
                const key = e.target.value;
                loadPaper(key);
            });
        }

        // --- Render Paper ---
        function loadPaper(key) {
            currentPaper = papersData.find(p => p.key === key);
            if (!currentPaper) return;

            // Clear previous
            dom.content.innerHTML = '';
            dom.desktopNav.innerHTML = '';
            dom.mobileNav.innerHTML = '';

            // Render Layout based on Flat vs Sectioned
            const allQuestionEls = [];

            if (currentPaper.sections) {
                currentPaper.sections.forEach(section => {
                    // Nav Section Header
                    const sectHeader = document.createElement('div');
                    sectHeader.className = 'nav-section-label';
                    sectHeader.textContent = section.label; // e.g., "A"
                    dom.desktopNav.appendChild(sectHeader.cloneNode(true));
                    dom.mobileNav.appendChild(sectHeader.cloneNode(true));

                    // Section in content? Not explicitly required by spec, just render questions linear
                    // Spec says "No artificial sectioning... beyond what already exists". 
                    // We render questions continuously.

                    section.questions.forEach(q => renderQuestionTree(q, dom.content, 0));
                });
            } else if (currentPaper.questions) {
                currentPaper.questions.forEach(q => renderQuestionTree(q, dom.content, 0));
            }

            // Bind Navigation
            bindNav(dom.desktopNav);
            bindNav(dom.mobileNav);

            // Populate Navigation based on rendered questions
            // We do a second pass over DOM to ensure ids match
            const questionNodes = Array.from(dom.content.querySelectorAll('.question-block'));
            questionNodes.forEach(node => {
                const id = node.id;
                // find id label from q-id child
                const idLabel = node.querySelector('.q-id').textContent.trim();

                const createNavItem = () => {
                    const btn = document.createElement('button');
                    btn.setAttribute('data-nav-id', id);
                    btn.textContent = idLabel; // Just identifier
                    return btn;
                };

                dom.desktopNav.appendChild(createNavItem());
                dom.mobileNav.appendChild(createNavItem());
                allQuestionEls.push(node);
            });

            // Init Scroll Spy
            enableScrollSpy(allQuestionEls);

            // Run KaTeX
            renderMathInElement(dom.content, {
                delimiters: [
                    { left: '$$', right: '$$', display: true },
                    { left: '$', right: '$', display: false }
                ],
                throwOnError: false
            });
        }

        // --- Recursive Question Renderer ---
        function renderQuestionTree(node, container, depth) {
            const wrapper = document.createElement('div');
            wrapper.className = depth === 0 ? 'question-block' : 'question-children';
            // Use node.id if top level, otherwise generate specific id? 
            // The payload usually puts ids on leaf nodes or top nodes.
            // We use node.id as the anchor.
            if (node.id) wrapper.id = `q-${node.id.replace(/[^a-zA-Z0-9]/g, '-')}`;

            // 1. Question Header
            const header = document.createElement('div');
            header.className = 'question-header';

            const idSpan = document.createElement('span');
            idSpan.className = 'q-id';
            idSpan.textContent = node.id || '';
            header.appendChild(idSpan);

            const promptDiv = document.createElement('div');
            promptDiv.className = 'q-prompt markdown-content';
            promptDiv.innerHTML = renderMarkdown(node.question || '');
            header.appendChild(promptDiv);

            wrapper.appendChild(header);

            // 2. Answer
            if (node.answer) {
                const answerBlock = document.createElement('div');
                answerBlock.className = 'answer-block';
                const ansLabel = document.createElement('span');
                ansLabel.className = 'answer-label';
                ansLabel.textContent = 'Answer';
                const ansVal = document.createElement('span');
                ansVal.className = 'markdown-content';
                ansVal.innerHTML = renderMarkdown(node.answer);
                answerBlock.appendChild(ansLabel);
                answerBlock.appendChild(ansVal);
                wrapper.appendChild(answerBlock);
            }

            // 3. Solution Details (if present)
            if (node.solutionDetails) {
                const detailsWrapper = document.createElement('div');

                // Toggle
                const toggleBtn = document.createElement('button');
                toggleBtn.className = 'solution-toggle';
                toggleBtn.setAttribute('aria-expanded', 'false');
                toggleBtn.innerHTML = `
                    <span class="toggle-text">Show working</span>
                    <svg class="toggle-icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                `;

                const contentDiv = document.createElement('div');
                contentDiv.className = 'solution-details';

                // Toggle Logic
                toggleBtn.onclick = () => {
                    const isExpanded = toggleBtn.getAttribute('aria-expanded') === 'true';
                    toggleBtn.setAttribute('aria-expanded', !isExpanded);
                    toggleBtn.querySelector('.toggle-text').textContent = !isExpanded ? 'Hide working' : 'Show working';
                    contentDiv.classList.toggle('visible', !isExpanded);
                };

                // Apply default (payload can override defaults if needed, but spec says details collapsed by default)
                if (currentPaper.defaults && currentPaper.defaults.expandedAll) {
                    toggleBtn.click(); // Trigger expand
                }

                // Render Subsections: Keep In Mind -> Formulas -> Working -> Alt
                const sd = node.solutionDetails;

                // Keep In Mind
                if (sd.keepInMind) {
                    const block = document.createElement('div');
                    block.className = 'sd-subsection';
                    block.innerHTML = `
                        <span class="sd-label">Keep in mind</span>
                        <div class="sd-body markdown-content">${renderMarkdown(sd.keepInMind)}</div>
                    `;
                    contentDiv.appendChild(block);
                }

                // Formulas Used
                if (sd.formulasUsed) {
                    const block = document.createElement('div');
                    block.className = 'sd-subsection';
                    block.innerHTML = `
                        <span class="sd-label">Formulas used</span>
                        <div class="sd-body markdown-content">${renderMarkdown(sd.formulasUsed)}</div>
                    `;
                    contentDiv.appendChild(block);
                }

                // Working
                if (sd.working) {
                    const block = document.createElement('div');
                    block.className = 'sd-subsection working-block';
                    block.innerHTML = `
                        <span class="sd-label">Working</span>
                        <div class="sd-body markdown-content">${renderMarkdown(sd.working)}</div>
                    `;
                    contentDiv.appendChild(block);
                }

                // Alternative Working
                if (sd.alternativeWorking) {
                    const block = document.createElement('div');
                    block.className = 'sd-subsection working-block';
                    block.innerHTML = `
                        <span class="sd-label">Alternative working</span>
                        <div class="sd-body markdown-content">${renderMarkdown(sd.alternativeWorking)}</div>
                    `;
                    contentDiv.appendChild(block);
                }

                detailsWrapper.appendChild(toggleBtn);
                detailsWrapper.appendChild(contentDiv);
                wrapper.appendChild(detailsWrapper);
            }

            // 4. Children (Recurse)
            if (node.children && node.children.length > 0) {
                node.children.forEach(child => renderQuestionTree(child, wrapper, depth + 1));
            }

            container.appendChild(wrapper);
        }

        // --- Helper: Markdown Render ---
        function renderMarkdown(text) {
            if (!text) return '';
            if (!md) return text; // Fallback
            return md.render(text);
        }

        // --- Mobile Drawer Logic ---
        function openDrawer() {
            dom.drawerBackdrop.classList.add('open');
            dom.drawerPanel.setAttribute('aria-hidden', 'false');
            // Trap focus roughly
            dom.drawerClose.focus();
        }

        function closeDrawer() {
            dom.drawerBackdrop.classList.remove('open');
            dom.drawerPanel.setAttribute('aria-hidden', 'true');
            dom.mobileJumpTrig.focus();
        }

        dom.mobileJumpTrig.addEventListener('click', openDrawer);
        dom.drawerClose.addEventListener('click', closeDrawer);
        dom.drawerBackdrop.addEventListener('click', (e) => {
            if (e.target === dom.drawerBackdrop) closeDrawer();
        });
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && dom.drawerBackdrop.classList.contains('open')) closeDrawer();
        });

        // --- Init ---
        init();

    </script>
</body>

</html>