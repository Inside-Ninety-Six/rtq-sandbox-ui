<!DOCTYPE html>
<html lang="en-GB">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ Prototype</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"
        integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV" crossorigin="anonymous">

    <style>
        /* =========================================
           STAGE 5.3: COLOUR & VISUAL TONE SYSTEM
           Soft-warm neutral base. No brand colours.
           ========================================= */
        :root {
            /* Base Neutrals (Warmth: Hue 30-40, Low Saturation) */
            --c-bg-page: #f9f8f6;
            /* Page background */
            --c-surface-main: #ffffff;
            /* Main content surface */
            --c-surface-details: #faf9f7;
            /* Subtle separation for solutions */
            --c-border: #e6e4e0;

            /* Typography */
            --c-text-primary: #2d2a26;
            /* Question text, primary anchor */
            --c-text-secondary: #5e5b56;
            /* Answers, labels */
            --c-text-tertiary: #8c8985;
            /* Meta, quiet nav */

            /* Interaction */
            --c-focus-ring: #2d2a26;
            /* Custom focus (high contrast) */
            --c-hover-bg: #f2f0ed;
            /* Subtle hover state */

            /* Spacing (Rhythm) */
            --sp-xs: 0.25rem;
            --sp-sm: 0.5rem;
            --sp-md: 1rem;
            --sp-lg: 1.5rem;
            --sp-xl: 3rem;
            /* Between top-level questions */
            --sp-xxl: 5rem;

            /* Layout */
            --w-max: 1024px;
            --nav-width: 200px;
        }

        /* Reset & Base */
        *,
        *::before,
        *::after {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--c-bg-page);
            color: var(--c-text-primary);
            line-height: 1.5;
            margin: 0;
            padding: 0;
            -webkit-font-smoothing: antialiased;
        }

        /* Focus States (Stage 5.5.2) */
        :focus-visible {
            outline: 2px solid var(--c-focus-ring);
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* =========================================
           PAGE SHELL & LAYOUT
           Centered content frame, Sibling Columns
           ========================================= */
        .app-shell {
            max-width: var(--w-max);
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: var(--c-bg-page);
            /* Unified surface for nav/content area */
        }

        /* Top Controls Area */
        .top-controls {
            padding: var(--sp-md) var(--sp-lg);
            border-bottom: 1px solid var(--c-border);
            background-color: var(--c-bg-page);
            display: flex;
            flex-wrap: wrap;
            gap: var(--sp-md);
            align-items: center;
            justify-content: space-between;
            position: relative;
            z-index: 100;
        }

        .controls-group {
            display: flex;
            gap: var(--sp-sm);
            align-items: center;
        }

        select,
        button.control-btn {
            font-family: inherit;
            font-size: 0.9rem;
            padding: var(--sp-sm) var(--sp-md);
            border: 1px solid var(--c-border);
            background: var(--c-surface-main);
            border-radius: 4px;
            color: var(--c-text-primary);
            cursor: pointer;
        }

        label {
            font-size: 0.85rem;
            color: var(--c-text-secondary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Main Layout: Navigation + Content */
        .main-layout {
            display: flex;
            flex: 1;
            position: relative;
        }

        /* =========================================
           NAVIGATION RAIL (Desktop)
           Stage 5.4: Visual Quietness
           ========================================= */
        .nav-rail {
            width: var(--nav-width);
            flex-shrink: 0;
            padding: var(--sp-lg) var(--sp-md) var(--sp-lg) 0;

            /* Add-on: Persistence */
            position: sticky;
            top: 0;
            max-height: 100vh;
            overflow-y: auto;

            /* Scrollbar hiding (Add-on) */
            scrollbar-width: none;
            /* Firefox */
            -ms-overflow-style: none;
            /* IE/Edge */
        }

        .nav-rail::-webkit-scrollbar {
            display: none;
        }

        .nav-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .nav-section-label {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--c-text-tertiary);
            padding: var(--sp-md) var(--sp-sm) var(--sp-xs);
            margin-top: var(--sp-sm);
        }

        .nav-item {
            display: block;
            padding: var(--sp-xs) var(--sp-sm);
            font-size: 0.9rem;
            color: var(--c-text-tertiary);
            text-decoration: none;
            border-radius: 4px;
            transition: color 0.1s ease, background-color 0.1s ease;
        }

        .nav-item:hover {
            color: var(--c-text-primary);
            background-color: var(--c-hover-bg);
            /* Stage 5.5.1 Hover Feedback */
        }

        .nav-item.active {
            color: var(--c-text-primary);
            font-weight: 600;
            /* Stage 5.4.3 Active State */
            background-color: transparent;
        }

        .nav-item.sub-item {
            padding-left: var(--sp-lg);
            font-size: 0.85rem;
        }

        /* =========================================
           PAPER CONTENT
           Stage 5.6: Hierarchy & Semantics
           ========================================= */
        .paper-content {
            flex: 1;
            padding: var(--sp-lg);
            max-width: 100%;
            background-color: var(--c-surface-main);
            /* Visual focus on content */
            min-height: 80vh;
            border-left: 1px solid transparent;
            /* Visual separation if needed, currently clean */
        }

        /* Typography Hierarchy (Stage 4.8) */
        h1,
        h2,
        h3 {
            font-weight: 600;
            color: var(--c-text-primary);
            margin: 0;
        }

        .question-block {
            margin-bottom: var(--sp-xl);
            /* Stage 5.2.1: Largest spacing unit */
            scroll-margin-top: 2rem;
            position: relative;
        }

        .question-block.sub-question {
            margin-bottom: var(--sp-lg);
            padding-left: var(--sp-md);
            /* Indentation for nesting */
            border-left: 2px solid transparent;
            /* Alignment aid */
        }

        .question-block.sub-sub-question {
            margin-bottom: var(--sp-md);
            padding-left: var(--sp-lg);
        }

        .q-header {
            display: flex;
            gap: var(--sp-sm);
            margin-bottom: var(--sp-md);
            align-items: baseline;
        }

        .q-id {
            font-weight: 600;
            font-size: 1rem;
            color: var(--c-text-secondary);
            /* Subordinate to prompt */
            min-width: 2rem;
        }

        .q-prompt {
            font-size: 1.125rem;
            color: var(--c-text-primary);
            line-height: 1.6;
            flex: 1;
        }

        .q-prompt p {
            margin: 0 0 var(--sp-sm) 0;
        }

        .q-prompt p:last-child {
            margin: 0;
        }

        /* Diagrams */
        .diagram-container {
            margin: var(--sp-md) 0;
            padding: var(--sp-md);
            background: #fdfdfd;
            border: 1px solid var(--c-border);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .diagram-svg {
            max-width: 100%;
            height: auto;
            fill: none;
            stroke: var(--c-text-primary);
            stroke-width: 2;
        }

        /* Answer Block (Stage 5.6.2) */
        .answer-block {
            margin-bottom: var(--sp-sm);
            padding-left: calc(2rem + var(--sp-sm));
            /* Align with text */
            display: flex;
            align-items: baseline;
            gap: var(--sp-sm);
        }

        .answer-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--c-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }

        .answer-value {
            font-size: 1.125rem;
            font-weight: 500;
            color: var(--c-text-primary);
        }

        /* Solution Details (Stage 5.6.3 & 5.7) */
        .solution-toggle-wrapper {
            padding-left: calc(2rem + var(--sp-sm));
            margin-top: var(--sp-sm);
        }

        .toggle-btn {
            background: none;
            border: none;
            padding: 0;
            font-family: inherit;
            font-size: 0.95rem;
            color: var(--c-text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: var(--sp-xs);
            transition: color 0.1s;
        }

        .toggle-btn:hover {
            color: var(--c-text-primary);
            text-decoration: underline;
        }

        .toggle-icon {
            width: 1em;
            height: 1em;
            transition: transform 0.2s ease;
            fill: currentColor;
        }

        .toggle-btn[aria-expanded="true"] .toggle-icon {
            transform: rotate(180deg);
        }

        /* The expandable container */
        .solution-details {
            margin-top: var(--sp-sm);
            margin-left: calc(2rem + var(--sp-sm));
            background-color: var(--c-surface-details);
            /* Stage 5.3.3 */
            border-radius: 4px;
            overflow: hidden;
            /* Animation for continuity (Stage 5.5.3) */
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            max-height: 0;
            opacity: 0;
            visibility: hidden;
        }

        .solution-details.open {
            max-height: none;
            /* JS will set specific height for smooth anim if refined, typically 'none' or '1000px' */
            opacity: 1;
            visibility: visible;
            padding: var(--sp-md) var(--sp-md) var(--sp-md) var(--sp-lg);
            /* Reset max-height via JS ideally, but for CSS proto: */
            max-height: 5000px;
            /* Safe upper bound for long workings */
        }

        .sol-section {
            margin-bottom: var(--sp-md);
        }

        .sol-section:last-child {
            margin-bottom: 0;
        }

        .sol-label {
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--c-text-tertiary);
            margin-bottom: var(--sp-xs);
            display: block;
        }

        .sol-content {
            font-size: 0.95rem;
            color: var(--c-text-primary);
            line-height: 1.6;
        }

        /* Math Handling (Locked: Overflow) */
        .math-block {
            display: block;
            overflow-x: auto;
            /* Horizontal scroll allowed only here */
            max-width: 100%;
            padding: var(--sp-xs) 0;
            scrollbar-width: thin;
        }

        .katex-placeholder {
            font-family: 'Times New Roman', serif;
            font-style: italic;
            background: #eee;
            padding: 0 4px;
            border-radius: 2px;
            color: #444;
        }

        .math-block .katex-placeholder {
            display: block;
            padding: var(--sp-sm);
            background: #f4f4f4;
            margin: var(--sp-xs) 0;
        }

        /* =========================================
           MOBILE / RESPONSIVE
           Stage 5.4: Mobile Ergonomics
           ========================================= */
        .mobile-nav-trigger {
            display: none;
        }

        .mobile-nav-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 200;
        }

        .mobile-nav-drawer {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            width: 80%;
            max-width: 300px;
            background: var(--c-bg-page);
            padding: var(--sp-lg);
            overflow-y: auto;
            transform: translateX(-100%);
            transition: transform 0.2s ease;
        }

        .mobile-nav-overlay.active {
            display: block;
        }

        .mobile-nav-overlay.active .mobile-nav-drawer {
            transform: translateX(0);
        }

        @media (max-width: 768px) {
            .app-shell {
                flex-direction: column;
            }

            .nav-rail {
                display: none;
            }

            /* Hide sidebar on mobile */

            .mobile-nav-trigger {
                display: block;
            }

            .paper-content {
                padding: var(--sp-md);
            }

            .answer-block,
            .solution-toggle-wrapper,
            .solution-details {
                padding-left: 0;
                margin-left: 0;
            }

            .q-id {
                min-width: 1.5rem;
            }
        }

        @media (prefers-reduced-motion: reduce) {

            .solution-details,
            .toggle-icon,
            .mobile-nav-drawer {
                transition: none;
            }
        }
    </style>

    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"
        integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8"
        crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"
        integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05"
        crossorigin="anonymous"></script>
</head>

<body>

    <div class="app-shell">

        <header class="top-controls">
            <div class="controls-group">
                <button class="control-btn mobile-nav-trigger" id="mobileNavBtn" aria-label="Open navigation">
                    â˜° Index
                </button>
                <label for="paperSelect">Paper:</label>
                <select id="paperSelect">
                    <option value="short">Short Paper</option>
                    <option value="standard">Standard Paper</option>
                    <option value="diagram">Diagram-heavy Paper</option>
                    <option value="sectioned">Sectioned Paper (A/B/C)</option>
                    <option value="expanded">Stress: Workings Expanded</option>
                </select>
            </div>
            <div class="controls-group">
                <label>
                    <input type="checkbox" id="realKatexToggle"> Real KaTeX Rendering
                </label>
            </div>
        </header>

        <div class="main-layout">
            <nav class="nav-rail" aria-label="Document navigation">
                <ul class="nav-list" id="desktopNavList">
                </ul>
            </nav>

            <main class="paper-content" id="paperContainer">
            </main>
        </div>

        <div class="mobile-nav-overlay" id="mobileNavOverlay">
            <nav class="mobile-nav-drawer" aria-label="Mobile document navigation">
                <h3>Question Index</h3>
                <ul class="nav-list" id="mobileNavList">
                </ul>
            </nav>
        </div>
    </div>

    <script>
        /**
         * RTQ Prototype Logic
         * Handles data generation, rendering, and interaction logic.
         */

        // --- State ---
        const state = {
            paperType: 'short',
            useRealKatex: false,
            expandedMode: false // For the "Workings Expanded" stress test
        };

        // --- Data Generators ---

        // SVG Generators for Diagrams
        const svgs = {
            geometry: `<svg class="diagram-svg" viewBox="0 0 200 150" width="200" height="150"><path d="M20,130 L180,130 L100,20 Z" stroke-width="2"/><circle cx="100" cy="90" r="20" stroke-width="1"/><text x="90" y="95" font-family="sans-serif" font-size="12" fill="#444">x</text></svg>`,
            bar: `<svg class="diagram-svg" viewBox="0 0 200 100" width="200" height="100"><rect x="20" y="20" width="50" height="60" fill="#eee" stroke="#444" stroke-width="2"/><rect x="80" y="40" width="50" height="40" fill="#ddd" stroke="#444" stroke-width="2"/><line x1="10" y1="80" x2="190" y2="80" stroke="#000" stroke-width="2"/></svg>`,
            grid: `<svg class="diagram-svg" viewBox="0 0 150 150" width="150" height="150"><defs><pattern id="grid" width="15" height="15" patternUnits="userSpaceOnUse"><path d="M 15 0 L 0 0 0 15" fill="none" stroke="#e0e0e0" stroke-width="1"/></pattern></defs><rect width="100%" height="100%" fill="url(#grid)" /><line x1="10" y1="75" x2="140" y2="75" stroke="#444" stroke-width="2"/><line x1="75" y1="10" x2="75" y2="140" stroke="#444" stroke-width="2"/><circle cx="90" cy="60" r="3" fill="#2d2a26"/></svg>`,
            table: `<svg class="diagram-svg" viewBox="0 0 200 80" width="200" height="80"><rect x="0" y="0" width="200" height="80" fill="none" stroke="#444" stroke-width="1"/><line x1="0" y1="40" x2="200" y2="40" stroke="#ccc"/><line x1="100" y1="0" x2="100" y2="80" stroke="#ccc"/><text x="20" y="25" font-size="12" fill="#444">Item A</text><text x="120" y="25" font-size="12" fill="#444">15</text><text x="20" y="65" font-size="12" fill="#444">Item B</text><text x="120" y="65" font-size="12" fill="#444">22</text></svg>`
        };

        function generateQuestion(id, type = 'short', options = {}) {
            const { depth = 0, section = null, longMath = false, diagramType = null, coverage = false } = options;

            let promptText = "Calculate the value of the expression.";
            let answerText = "42";
            let mathContent = "5 \\times 8 + 2";

            if (type === 'algebra') {
                promptText = "Solve for $x$ in the following equation.";
                mathContent = longMath
                    ? "\\begin{aligned} 5(2x + 3) &= 4(3x - 1) + 20 \\\\ 10x + 15 &= 12x - 4 + 20 \\\\ 10x + 15 &= 12x + 16 \\\\ 15 - 16 &= 12x - 10x \\\\ -1 &= 2x \\\\ x &= -0.5 \\end{aligned}"
                    : "3x + 5 = 20";
                answerText = "-0.5";
            } else if (type === 'word') {
                promptText = "A train leaves London at 14:00 and arrives in Paris at 17:15. The distance is 450 km. Calculate the average speed.";
                answerText = "138.5 km/h";
                mathContent = "\\text{Speed} = \\frac{\\text{Distance}}{\\text{Time}}";
            }

            const qBlock = {
                id: id,
                prompt: promptText,
                diagram: diagramType ? svgs[diagramType] : null,
                answer: answerText,
                solution: {
                    working: mathContent,
                    // Add varied coverage if requested
                    guidance: coverage ? "Use BIDMAS to apply the correct order of operations." : null,
                    formulas: coverage ? "\\text{Speed} = \\frac{D}{T}" : null,
                    altWorking: coverage ? "Alternative method using ratios..." : null,
                    keepInMind: coverage ? "Remember to convert units before calculating." : null
                },
                subQuestions: []
            };

            return qBlock;
        }

        function generatePaperData(type) {
            let questions = [];
            let sections = []; // { label: 'Section A', startId: '1' }

            if (type === 'short') {
                questions.push(generateQuestion('1', 'short'));
                questions.push(generateQuestion('2', 'algebra'));
                questions.push(generateQuestion('3', 'word', { diagramType: 'grid' }));
                // Multi-part
                const q4 = generateQuestion('4', 'word');
                q4.subQuestions.push(generateQuestion('4a', 'short', { depth: 1 }));
                q4.subQuestions.push(generateQuestion('4b', 'short', { depth: 1 }));
                questions.push(q4);
                questions.push(generateQuestion('5', 'short'));
            } else if (type === 'standard' || type === 'expanded') {
                for (let i = 1; i <= 35; i++) {
                    let qType = i > 25 ? 'algebra' : (i % 3 === 0 ? 'word' : 'short');
                    let opts = { longMath: i > 25 };

                    // Stress test: Deep nesting on Q18 and Q30
                    if (i === 18 || i === 30) {
                        const q = generateQuestion(`${i}`, qType, opts);
                        const qa = generateQuestion(`${i}(a)`, 'short', { depth: 1 });
                        qa.subQuestions.push(generateQuestion(`${i}(a)(i)`, 'short', { depth: 2 }));
                        qa.subQuestions.push(generateQuestion(`${i}(a)(ii)`, 'short', { depth: 2 }));
                        q.subQuestions.push(qa);
                        q.subQuestions.push(generateQuestion(`${i}(b)`, 'short', { depth: 1 }));
                        questions.push(q);
                    } else {
                        // Coverage stress test on a few
                        if (i === 10 || i === 20 || i === 35) opts.coverage = true;
                        questions.push(generateQuestion(`${i}`, qType, opts));
                    }
                }
            } else if (type === 'diagram') {
                const types = ['geometry', 'bar', 'grid', 'table'];
                for (let i = 1; i <= 20; i++) {
                    let opts = {};
                    if (i % 2 === 0) opts.diagramType = types[(i / 2) % 4];
                    questions.push(generateQuestion(`${i}`, 'short', opts));
                }
            } else if (type === 'sectioned') {
                sections.push({ label: 'Section A', index: 0 });
                for (let i = 1; i <= 15; i++) questions.push(generateQuestion(`${i}`, 'short'));

                sections.push({ label: 'Section B', index: questions.length });
                for (let i = 16; i <= 23; i++) questions.push(generateQuestion(`${i}`, 'word', { diagramType: 'geometry' }));

                sections.push({ label: 'Section C', index: questions.length });
                for (let i = 24; i <= 29; i++) questions.push(generateQuestion(`${i}`, 'algebra', { longMath: true, coverage: true }));
            }

            return { questions, sections };
        }

        // --- DOM Builders ---

        function createMathHTML(latex, isBlock = false) {
            if (!latex) return '';
            if (state.useRealKatex) {
                // Placeholder wrapper, rendered later
                return `<span class="katex-render-target" data-expr="${encodeURIComponent(latex)}" data-display="${isBlock}"></span>`;
            } else {
                // Placeholder visual
                const content = isBlock ? `$$ ${latex} $$` : `$ ${latex} $`;
                const cls = isBlock ? 'katex-placeholder block' : 'katex-placeholder';
                return `<span class="${cls}">${content}</span>`;
            }
        }

        function buildQuestionNode(q, level = 0) {
            const wrapper = document.createElement('div');
            // Semantic separation
            let wrapperClass = 'question-block';
            if (level === 1) wrapperClass += ' sub-question';
            if (level === 2) wrapperClass += ' sub-sub-question';
            wrapper.className = wrapperClass;
            wrapper.id = `q-${q.id}`;

            // 1. Question (Header + Prompt + Diagram)
            let html = `
            <div class="q-header">
                <span class="q-id">${q.id}</span>
                <div class="q-prompt">
                    <p>${q.prompt}</p>
                    ${q.diagram ? `<div class="diagram-container">${q.diagram}</div>` : ''}
                </div>
            </div>
        `;

            // 2. Answer
            html += `
            <div class="answer-block">
                <span class="answer-label">Answer</span>
                <span class="answer-value">${createMathHTML(q.answer)}</span>
            </div>
        `;

            // 3. Solution Details
            const isExpanded = state.paperType === 'expanded' ? 'open' : '';
            const ariaExpanded = state.paperType === 'expanded' ? 'true' : 'false';
            const toggleText = state.paperType === 'expanded' ? 'Hide working' : 'Show working';

            html += `
            <div class="solution-toggle-wrapper">
                <button class="toggle-btn" aria-expanded="${ariaExpanded}" aria-controls="sol-${q.id}">
                    <span class="toggle-text">${toggleText}</span>
                    <svg class="toggle-icon" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
                </button>
            </div>
            <div class="solution-details ${isExpanded}" id="sol-${q.id}">
        `;

            // Inner Solution Parts
            const s = q.solution;
            if (s.keepInMind) {
                html += `<div class="sol-section"><span class="sol-label">Things to keep in mind</span><div class="sol-content">${s.keepInMind}</div></div>`;
            }
            if (s.formulas) {
                html += `<div class="sol-section"><span class="sol-label">Formulas used</span><div class="math-block">${createMathHTML(s.formulas, true)}</div></div>`;
            }
            if (s.working) {
                // Mocking extreme length for 'longMath' scenarios handled in data gen, but ensure formatting
                html += `<div class="sol-section"><span class="sol-label">Working</span><div class="math-block sol-content">${createMathHTML(s.working, true)}</div></div>`;
            }
            if (s.altWorking) {
                html += `<div class="sol-section"><span class="sol-label">Alternative working</span><div class="math-block sol-content">${createMathHTML(s.altWorking, true)}</div></div>`;
            }

            html += `</div>`; // Close details

            wrapper.innerHTML = html;

            // Recursion for Sub-questions
            if (q.subQuestions && q.subQuestions.length > 0) {
                q.subQuestions.forEach(sq => {
                    wrapper.appendChild(buildQuestionNode(sq, level + 1));
                });
            }

            return wrapper;
        }

        // --- Main Render Function ---

        function render() {
            const container = document.getElementById('paperContainer');
            const deskNav = document.getElementById('desktopNavList');
            const mobNav = document.getElementById('mobileNavList');

            container.innerHTML = '';
            deskNav.innerHTML = '';
            mobNav.innerHTML = '';

            const data = generatePaperData(state.paperType);

            let flatQuestions = []; // For nav generation

            // Helper to flatten for nav
            function traverse(q) {
                flatQuestions.push(q);
                if (q.subQuestions) q.subQuestions.forEach(traverse);
            }

            // Render Loop
            data.questions.forEach((q, index) => {
                // Check section headers
                const section = data.sections.find(s => s.index === index);
                if (section) {
                    // Add Section divider in Nav
                    const label = `<li class="nav-section-label">${section.label}</li>`;
                    deskNav.insertAdjacentHTML('beforeend', label);
                    mobNav.insertAdjacentHTML('beforeend', label);

                    // Add Section Header in Paper
                    const secHeader = document.createElement('h2');
                    secHeader.textContent = section.label;
                    secHeader.style.margin = '2rem 0 1rem 0';
                    secHeader.style.fontSize = '1.2rem';
                    secHeader.style.color = 'var(--c-text-tertiary)';
                    secHeader.style.borderBottom = '1px solid var(--c-border)';
                    container.appendChild(secHeader);
                }

                container.appendChild(buildQuestionNode(q));
                traverse(q);
            });

            // Build Nav Links
            flatQuestions.forEach(q => {
                const isSub = q.id.includes('(');
                const indentClass = isSub ? 'sub-item' : '';
                const link = `<li class="nav-li"><a href="#q-${q.id}" class="nav-item ${indentClass}" data-target="q-${q.id}">${q.id}</a></li>`;
                deskNav.insertAdjacentHTML('beforeend', link);
                mobNav.insertAdjacentHTML('beforeend', link);
            });

            // Add Interaction Listeners
            addToggleListeners();
            addNavListeners();

            // KaTeX Render
            if (state.useRealKatex && window.renderMathInElement) {
                document.querySelectorAll('.katex-render-target').forEach(el => {
                    const tex = decodeURIComponent(el.getAttribute('data-expr'));
                    const display = el.getAttribute('data-display') === 'true';
                    try {
                        katex.render(tex, el, { displayMode: display, throwOnError: false });
                    } catch (e) {
                        el.textContent = tex;
                    }
                });
            }
        }

        // --- Interactions ---

        function addToggleListeners() {
            document.querySelectorAll('.toggle-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    // Find nearest details container
                    const details = btn.closest('.solution-toggle-wrapper').nextElementSibling;
                    const textSpan = btn.querySelector('.toggle-text');
                    const isExpanded = btn.getAttribute('aria-expanded') === 'true';

                    if (isExpanded) {
                        // Collapse
                        details.classList.remove('open');
                        btn.setAttribute('aria-expanded', 'false');
                        textSpan.textContent = 'Show working';
                    } else {
                        // Expand
                        details.classList.add('open');
                        btn.setAttribute('aria-expanded', 'true');
                        textSpan.textContent = 'Hide working';
                    }
                });
            });
        }

        function addNavListeners() {
            const handleNavClick = (e) => {
                e.preventDefault();
                const targetId = e.target.getAttribute('data-target');
                const targetEl = document.getElementById(targetId);
                if (targetEl) {
                    // Smooth scroll
                    targetEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    // Update active state manually
                    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                    e.target.classList.add('active');

                    // Close mobile nav if open
                    document.getElementById('mobileNavOverlay').classList.remove('active');
                }
            };

            document.querySelectorAll('.nav-item').forEach(link => {
                link.addEventListener('click', handleNavClick);
            });
        }

        // --- Init & Event Binding ---

        document.getElementById('paperSelect').addEventListener('change', (e) => {
            state.paperType = e.target.value;
            render();
        });

        document.getElementById('realKatexToggle').addEventListener('change', (e) => {
            state.useRealKatex = e.target.checked;
            render();
        });

        // Mobile Nav Toggle
        document.getElementById('mobileNavBtn').addEventListener('click', () => {
            document.getElementById('mobileNavOverlay').classList.add('active');
        });

        document.getElementById('mobileNavOverlay').addEventListener('click', (e) => {
            if (e.target === document.getElementById('mobileNavOverlay')) {
                document.getElementById('mobileNavOverlay').classList.remove('active');
            }
        });

        // Intersection Observer for Active Nav State (Bonus Polish)
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const id = entry.target.id;
                    document.querySelectorAll('.nav-item').forEach(n => {
                        n.classList.toggle('active', n.getAttribute('data-target') === id);
                    });
                }
            });
        }, { rootMargin: '-20% 0px -60% 0px' }); // Trigger when near top

        // Hook observer after render
        const originalRender = render;
        render = function () {
            originalRender();
            document.querySelectorAll('.question-block').forEach(el => observer.observe(el));
        };

        // Initial Render
        render();

    </script>
</body>

</html>