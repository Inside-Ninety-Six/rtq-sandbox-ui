<!DOCTYPE html>
<html lang="en-GB">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maths Paper Solution Viewer</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"
        integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"
        integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8"
        crossorigin="anonymous"></script>

    <style>
        /* * STAGE 5: VISUAL TONE & SEMANTICS
         * Soft-warm neutral base. Calm, paper-like, non-app-like.
         */
        :root {
            /* Palette - Soft Warm Neutrals */
            --bg-page: #f9f8f6;
            /* The "desk" or base surface */
            --bg-paper: #fdfcfb;
            /* The "paper" surface - very subtle lift */
            --bg-details: #f4f3f1;
            /* Subtle differentiation for details */

            --text-primary: #2d2a26;
            /* High readability, soft black */
            --text-secondary: #5d5b58;
            /* Supporting text */
            --text-tertiary: #8a8682;
            /* Meta text */

            --border-subtle: #e6e4e1;
            --focus-ring: #2d2a26;
            /* Custom focus, high contrast */

            /* Spacing & Rhythm */
            --space-xs: 4px;
            --space-sm: 8px;
            --space-md: 16px;
            --space-lg: 24px;
            --space-xl: 48px;
            /* Between top-level questions */
            --space-xxl: 80px;

            /* Typography */
            --font-stack: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;

            /* Hierarchy Scales */
            --fs-q: 1.125rem;
            /* Question text */
            --fs-a: 1rem;
            /* Answer */
            --fs-body: 0.95rem;
            /* Working body */
            --fs-nav: 0.85rem;

            --lh-loose: 1.6;
            --lh-tight: 1.4;

            /* Layout */
            --frame-width: 1024px;
            --nav-width: 180px;
        }

        /* RESET & BASE */
        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-stack);
            background-color: var(--bg-page);
            color: var(--text-primary);
            line-height: var(--lh-loose);
            -webkit-font-smoothing: antialiased;
        }

        /* LAYOUT SHELL */
        .app-shell {
            max-width: var(--frame-width);
            margin: 0 auto;
            min-height: 100vh;
            display: grid;
            grid-template-rows: auto 1fr;
            background-color: var(--bg-paper);
            /* Unification of surface */
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.02);
            /* Very subtle depth */
        }

        /* TOP CONTROL AREA */
        .controls-area {
            padding: var(--space-md) var(--space-lg);
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-md);
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            background-color: var(--bg-paper);
            z-index: 10;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        label {
            font-size: var(--fs-nav);
            color: var(--text-secondary);
            font-weight: 500;
        }

        select {
            padding: var(--space-xs) var(--space-sm);
            font-family: inherit;
            font-size: var(--fs-body);
            color: var(--text-primary);
            background-color: transparent;
            border: 1px solid var(--border-subtle);
            border-radius: 4px;
            cursor: pointer;
        }

        /* MAIN CONTENT FRAME */
        .content-frame {
            display: grid;
            grid-template-columns: var(--nav-width) 1fr;
            align-items: start;
            /* Prevent full height stretching */
        }

        /* NAVIGATION RAIL */
        .nav-rail {
            position: sticky;
            top: 60px;
            /* Offset for top controls */
            height: calc(100vh - 60px);
            overflow-y: auto;
            padding: var(--space-lg) var(--space-md);
            border-right: 1px solid transparent;
            /* No visible border, spacing only */
            /* Scrollbar hiding logic */
            scrollbar-width: none;
            /* Firefox */
            -ms-overflow-style: none;
            /* IE 10+ */
        }

        .nav-rail::-webkit-scrollbar {
            display: none;
            /* WebKit */
        }

        .nav-list {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: var(--space-xs);
        }

        .nav-section-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-tertiary);
            margin-top: var(--space-md);
            margin-bottom: var(--space-xs);
            padding-left: var(--space-sm);
            font-weight: 600;
        }

        .nav-item {
            font-size: var(--fs-nav);
            color: var(--text-secondary);
            padding: var(--space-xs) var(--space-sm);
            cursor: pointer;
            border-radius: 4px;
            transition: color 0.2s ease;
            text-decoration: none;
            display: block;
        }

        .nav-item:hover {
            color: var(--text-primary);
            background-color: rgba(0, 0, 0, 0.03);
            /* Subtle hover */
        }

        .nav-item.active {
            font-weight: 700;
            color: var(--text-primary);
            /* Minimal active state indicator */
            box-shadow: inset 2px 0 0 var(--text-primary);
        }

        .nav-item:focus-visible {
            outline: 2px solid var(--focus-ring);
            outline-offset: -2px;
        }

        /* PAPER CONTENT */
        .paper-content {
            padding: var(--space-xl) var(--space-xl) var(--space-xxl) var(--space-xl);
            /* Single continuous scroll provided by window/body */
        }

        /* QUESTION BLOCK */
        .question-block {
            margin-bottom: var(--space-xl);
            scroll-margin-top: 100px;
            /* Offset for sticky header */
        }

        /* Nesting Visuals via Indentation */
        .q-nested-1 {
            margin-left: var(--space-lg);
            margin-bottom: var(--space-lg);
        }

        .q-nested-2 {
            margin-left: calc(var(--space-lg) * 2);
            margin-bottom: var(--space-md);
        }

        .q-header {
            display: flex;
            gap: var(--space-md);
            margin-bottom: var(--space-sm);
        }

        .q-number {
            font-weight: 600;
            color: var(--text-secondary);
            flex-shrink: 0;
            width: 2rem;
            /* Consistent alignment */
        }

        .q-text {
            font-size: var(--fs-q);
            color: var(--text-primary);
            font-weight: 400;
        }

        .diagram-container {
            margin: var(--space-md) 0 var(--space-md) 3rem;
            /* Indented under text */
            max-width: 100%;
        }

        /* ANSWER BLOCK */
        .answer-block {
            margin-left: 3rem;
            /* Align with text */
            margin-top: var(--space-sm);
            font-size: var(--fs-a);
            color: var(--text-primary);
            display: flex;
            align-items: baseline;
            gap: var(--space-sm);
        }

        .label-strong {
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }

        /* SOLUTION DETAILS */
        .toggle-btn {
            background: none;
            border: none;
            padding: 0;
            margin-left: 3rem;
            margin-top: var(--space-sm);
            font-family: inherit;
            font-size: var(--fs-nav);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: color 0.2s;
        }

        .toggle-btn:hover {
            color: var(--text-primary);
            text-decoration: underline;
        }

        .toggle-btn:focus-visible {
            outline: 2px solid var(--focus-ring);
            border-radius: 2px;
        }

        .chevron {
            width: 10px;
            height: 10px;
            transition: transform 0.2s ease;
            fill: currentColor;
        }

        .toggle-btn[aria-expanded="true"] .chevron {
            transform: rotate(180deg);
        }

        .solution-details {
            margin-left: 3rem;
            margin-top: var(--space-md);
            padding: var(--space-md) var(--space-lg);
            background-color: var(--bg-details);
            border-radius: 4px;
            /* Soft structure */
            display: none;
            /* Default collapsed */
        }

        .solution-details.visible {
            display: block;
            animation: fadeIn 0.2s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-4px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .detail-section {
            margin-bottom: var(--space-md);
        }

        .detail-section:last-child {
            margin-bottom: 0;
        }

        .detail-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: var(--space-xs);
            display: block;
        }

        .working-body {
            font-size: var(--fs-body);
            color: var(--text-primary);
        }

        /* MATH & KaTeX HANDLING */
        .math-block {
            display: block;
            overflow-x: auto;
            max-width: 100%;
            padding: var(--space-xs) 0;
            /* Scrollbar hiding for cleaner look until hover? No, keep standard for usability */
        }

        .katex-display {
            margin: 0.5em 0 !important;
            overflow-x: auto;
            overflow-y: hidden;
            padding-bottom: 4px;
            /* Space for scrollbar */
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .content-frame {
                grid-template-columns: 1fr;
                /* Stack */
            }

            .nav-rail {
                display: none;
                /* Hide default sidebar on mobile */
            }

            .mobile-nav-toggle {
                display: block;
                /* Would implement drawer here */
            }

            .question-block {
                margin-bottom: var(--space-lg);
            }

            .paper-content {
                padding: var(--space-md);
            }

            .diagram-container,
            .answer-block,
            .toggle-btn,
            .solution-details {
                margin-left: 0;
                /* Reset indentation on mobile for width */
            }

            .q-header {
                flex-direction: column;
                gap: 4px;
            }
        }

        /* Mobile Nav Overlay (Simple implementation) */
        .mobile-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-paper);
            border-top: 1px solid var(--border-subtle);
            padding: var(--space-sm);
            z-index: 100;
            overflow-x: auto;
        }

        @media (max-width: 768px) {
            .mobile-nav {
                display: flex;
                gap: var(--space-sm);
            }
        }

        /* UTILS */
        .hidden {
            display: none;
        }
    </style>
</head>

<body>

    <div class="app-shell">
        <div class="controls-area">
            <div class="control-group">
                <label for="paper-select">Select Paper:</label>
                <select id="paper-select">
                    <option value="short">Short Paper (6 Qs)</option>
                    <option value="standard">Standard Paper (35 Qs)</option>
                    <option value="standard-exp">Standard (Workings Expanded)</option>
                    <option value="diagram">Diagram-Heavy (20 Qs)</option>
                    <option value="sectioned">Sectioned Paper (A/B/C)</option>
                </select>
            </div>
            <div class="control-group">
                <label for="katex-toggle">Real KaTeX Rendering</label>
                <input type="checkbox" id="katex-toggle">
            </div>
        </div>

        <div class="content-frame">
            <nav class="nav-rail" id="main-nav" aria-label="Paper Navigation">
                <ul class="nav-list" id="nav-list-container">
                </ul>
            </nav>

            <main class="paper-content" id="paper-container">
            </main>
        </div>

        <nav class="mobile-nav" id="mobile-nav-container" aria-label="Mobile Navigation">
        </nav>
    </div>

    <script>
        /* * STAGE 3 & 4 LOGIC 
         * Content Generation, Rendering, and Interaction
         */

        // --- State ---
        let state = {
            paperType: 'short',
            useRealKatex: false,
            expandedOverride: false
        };

        // --- Data Generators (Simulated Content) ---

        // Helper to generate a basic question object
        function createQ(id, num, text, ans, working, type = 'std', depth = 0, subQs = [], detailsExtras = {}) {
            return {
                id,
                num, // Display string: "1", "7a", "18(a)(i)"
                text,
                answer: ans,
                details: {
                    guidance: detailsExtras.guidance || null,
                    formula: detailsExtras.formula || null,
                    working: working, // Array of strings (lines)
                    altWorking: detailsExtras.altWorking || null // Array of strings
                },
                type, // 'std', 'diagram-geo', 'diagram-bar', 'diagram-grid'
                depth, // 0, 1, 2
                subQuestions: subQs
            };
        }

        // Generator: Short Paper
        function generateShortPaper() {
            return [
                createQ('q1', '1', 'Fill in the missing numbers in the boxes: $55 + \\boxed{\\phantom{0}} = 82$', '27', ['Let missing number = $a$', '$55 + a = 82$', '$a = 82 - 55$', '$a = 27$']),
                createQ('q2', '2', 'Calculate $308 + 86 + 4444$.', '4838', ['Use column addition:', '$\\begin{array}{r} 308 \\\\ 86 \\\\ + 4444 \\\\ \\hline 4838 \\end{array}$']),
                createQ('q3', '3', 'Subtract three hundred and three from six thousand and sixty.', '5757', ['$6060 - 303 = 5757$']),
                createQ('q4', '4', 'Angus and his six friends have collected $756$ stickers. They share them equally. How many does each get?', '108',
                    ['Total people = $1 + 6 = 7$', 'Calculation: $756 \\div 7$', '$756 \\div 7 = 108$'], 'std', 0, [], { guidance: 'Remember to include Angus in the total count.' }),
                createQ('q5', '5', 'Work out the value of:', '12',
                    ['Use BIDMAS.', '$2 + 3 + 6 + \\frac{1}{2} + \\frac{1}{3} + \\frac{1}{6}$', '$11 + \\frac{3}{6} + \\frac{2}{6} + \\frac{1}{6}$', '$11 + \\frac{6}{6} = 12$'], 'std', 0, [
                    createQ('q5a', '5a', 'How many sixths are in $3 \\frac{1}{3}$?', '20', ['$3 \\frac{1}{3} = \\frac{10}{3}$', '$\\frac{10}{3} = \\frac{20}{6}$', 'Answer is 20'], 'std', 1),
                    createQ('q5b', '5b', 'Calculate $0.75 \\div \\frac{3}{4}$', '1', ['$0.75 = \\frac{3}{4}$', '$\\frac{3}{4} \\div \\frac{3}{4} = 1$'], 'std', 1)
                ]),
                createQ('q6', '6', 'Find the area of the shape below.', '24 cm²', ['Area = base × height', '$A = 6 \\times 4 = 24$'], 'diagram-geo')
            ];
        }

        // Generator: Standard Paper (Includes long workings)
        function generateStandardPaper() {
            let qs = [];
            // 1-25 standard questions
            for (let i = 1; i <= 25; i++) {
                qs.push(createQ(`q${i}`, `${i}`, `Standard arithmetic question placeholder number ${i}. Calculate $${i} \\times 12$.`, `${i * 12}`, [`Calculation:`, `$${i} \\times 10 = ${i * 10}$`, `$${i} \\times 2 = ${i * 2}$`, `Total = ${i * 12}`]));
            }

            // 26-35 Long Algebra / Word Problems
            for (let i = 26; i <= 35; i++) {
                // Generate long working
                let longWorking = ['Let the unknown number be $x$.'];
                for (let j = 0; j < 40; j++) {
                    longWorking.push(`Step ${j + 1}: Simplify the equation $${j}x + ${i * 2} = ${j * 3}y$. Transform terms to isolate variable.`);
                }
                longWorking.push(`Final step: $x = ${i * 100}$`);

                qs.push(createQ(`q${i}`, `${i}`, `[Long Algebra] Solve for $x$ given the complex scenario involving trains leaving London and Manchester at different speeds.`, `${i * 100}`,
                    longWorking, 'std', 0, [], {
                    guidance: 'Use the formula $D = S \\times T$. Ensure units are consistent (km vs m).',
                    formula: '$Speed = \\frac{Distance}{Time}$',
                    altWorking: ['Alternative method using Ratio:', 'Ratio of speeds is 3:2...', '...steps...', 'Result is the same.']
                }));
            }
            return qs;
        }

        // Generator: Diagram Paper
        function generateDiagramPaper() {
            let qs = [];
            for (let i = 1; i <= 20; i++) {
                let type = i % 4 === 0 ? 'diagram-bar' : (i % 4 === 1 ? 'diagram-geo' : (i % 4 === 2 ? 'diagram-grid' : 'std'));
                qs.push(createQ(`q${i}`, `${i}`, `Diagram based question. Find value based on the visual information.`, `${i * 5}`, [`Identify values from chart.`, `Sum = ${i * 5}`], type));
            }
            return qs;
        }

        // Generator: Sectioned Paper
        function generateSectionedPaper() {
            // Flat array but we will inject section headers into nav
            // Q1-35 (Section A), Q36-43 (Section B), Q44-49 (Section C)
            let qs = [];
            // Section A
            for (let i = 1; i <= 5; i++) qs.push(createQ(`q${i}`, `${i}`, `Section A Question ${i}`, `${i}`, [`Working for ${i}`]));
            // Section B
            for (let i = 6; i <= 10; i++) qs.push(createQ(`q${i}`, `${i}`, `Section B Question ${i}`, `${i}`, [`Working for ${i}`]));
            // Section C (Deep nesting, long)
            let deepQ = createQ('q11', '11', 'Complex multi-part problem.', 'See below', ['Main working'], 'std', 0, [
                createQ('q11a', '11a', 'Part A', '10', ['Step 1', 'Step 2'], 'std', 1, [
                    createQ('q11ai', '11(a)(i)', 'Sub-part i', '5', ['Detailed sub-step'], 'std', 2)
                ])
            ]);
            qs.push(deepQ);
            return qs;
        }

        // --- Diagrams (SVG Strings) ---
        const svgs = {
            geo: `<svg width="200" height="120" viewBox="0 0 200 120" xmlns="http://www.w3.org/2000/svg"><path d="M20,100 L180,100 L100,20 Z" fill="none" stroke="#5d5b58" stroke-width="2"/><circle cx="100" cy="70" r="15" fill="#e6e4e1"/><text x="95" y="75" font-family="sans-serif" font-size="12" fill="#2d2a26">A</text></svg>`,
            bar: `<svg width="200" height="120" viewBox="0 0 200 120" xmlns="http://www.w3.org/2000/svg"><rect x="20" y="20" width="40" height="80" fill="#e6e4e1"/><rect x="80" y="40" width="40" height="60" fill="#8a8682"/><line x1="20" y1="100" x2="180" y2="100" stroke="#2d2a26" stroke-width="2"/></svg>`,
            grid: `<svg width="150" height="150" viewBox="0 0 150 150" xmlns="http://www.w3.org/2000/svg"><defs><pattern id="grid" width="20" height="20" patternUnits="userSpaceOnUse"><path d="M 20 0 L 0 0 0 20" fill="none" stroke="#e6e4e1" stroke-width="1"/></pattern></defs><rect width="100%" height="100%" fill="url(#grid)" /><line x1="10" y1="140" x2="140" y2="10" stroke="#2d2a26" stroke-width="2"/></svg>`
        };

        // --- Rendering Logic ---

        function renderMath(text) {
            if (!text) return '';
            if (state.useRealKatex && window.katex) {
                // Very naive replacements for prototype
                // Replace $...$ with katex.renderToString
                return text.replace(/\$(.*?)\$/g, (match, formula) => {
                    try {
                        return katex.renderToString(formula, { throwOnError: false, displayMode: false });
                    } catch (e) { return formula; }
                }).replace(/\\begin\{array\}(.*?)\\end\{array\}/g, (match) => { // Basic block detection
                    try {
                        return katex.renderToString(match, { throwOnError: false, displayMode: true });
                    } catch (e) { return match; }
                });
            } else {
                // Plain text placeholder logic
                return text;
            }
        }

        function createDetailBlock(label, contentArray) {
            if (!contentArray || contentArray.length === 0) return '';
            const lines = contentArray.map(line => `<div class="math-block">${renderMath(line)}</div>`).join('');
            return `
            <div class="detail-section">
                <span class="detail-label">${label}</span>
                <div class="working-body">${lines}</div>
            </div>
        `;
        }

        function renderQuestionNode(q) {
            const indentClass = `q-nested-${q.depth}`;
            const isExpanded = state.expandedOverride;

            let diagramHTML = '';
            if (q.type === 'diagram-geo') diagramHTML = `<div class="diagram-container">${svgs.geo}</div>`;
            if (q.type === 'diagram-bar') diagramHTML = `<div class="diagram-container">${svgs.bar}</div>`;
            if (q.type === 'diagram-grid') diagramHTML = `<div class="diagram-container">${svgs.grid}</div>`;

            // Build Details
            let detailsHTML = '';
            if (q.details.guidance) detailsHTML += createDetailBlock('Keep in mind', [q.details.guidance]);
            if (q.details.formula) detailsHTML += createDetailBlock('Formulas used', [q.details.formula]);
            detailsHTML += createDetailBlock('Working', q.details.working);
            if (q.details.altWorking) detailsHTML += createDetailBlock('Alternative working', q.details.altWorking);

            const node = document.createElement('div');
            node.className = `question-block ${indentClass}`;
            node.id = q.id;
            node.innerHTML = `
            <div class="q-header">
                <div class="q-number">${q.num}</div>
                <div class="q-text">${renderMath(q.text)}</div>
            </div>
            ${diagramHTML}
            <div class="answer-block">
                <span class="label-strong">Answer</span>
                <span>${renderMath(q.answer)}</span>
            </div>
            <button class="toggle-btn" aria-expanded="${isExpanded}" aria-controls="details-${q.id}" onclick="toggleDetails('${q.id}')">
                <span class="btn-text">${isExpanded ? 'Hide working' : 'Show working'}</span>
                <svg class="chevron" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
            </button>
            <div id="details-${q.id}" class="solution-details ${isExpanded ? 'visible' : ''}">
                ${detailsHTML}
            </div>
        `;

            // Recursion for sub-questions
            let htmlFragment = document.createDocumentFragment();
            htmlFragment.appendChild(node);

            if (q.subQuestions && q.subQuestions.length > 0) {
                q.subQuestions.forEach(subQ => {
                    htmlFragment.appendChild(renderQuestionNode(subQ));
                });
            }

            return htmlFragment;
        }

        function toggleDetails(id) {
            const btn = document.querySelector(`button[aria-controls="details-${id}"]`);
            const panel = document.getElementById(`details-${id}`);
            const isExpanded = btn.getAttribute('aria-expanded') === 'true';

            if (isExpanded) {
                btn.setAttribute('aria-expanded', 'false');
                btn.querySelector('.btn-text').textContent = 'Show working';
                panel.classList.remove('visible');
            } else {
                btn.setAttribute('aria-expanded', 'true');
                btn.querySelector('.btn-text').textContent = 'Hide working';
                panel.classList.add('visible');
            }
        }
        // Expose to window for inline onclick
        window.toggleDetails = toggleDetails;

        function renderPaper() {
            const container = document.getElementById('paper-container');
            const navContainer = document.getElementById('nav-list-container');
            const mobileNav = document.getElementById('mobile-nav-container');

            container.innerHTML = '';
            navContainer.innerHTML = '';
            mobileNav.innerHTML = '';

            let questions = [];
            const pType = state.paperType;

            // Dataset Switcher
            if (pType === 'short') questions = generateShortPaper();
            else if (pType === 'standard' || pType === 'standard-exp') questions = generateStandardPaper();
            else if (pType === 'diagram') questions = generateDiagramPaper();
            else if (pType === 'sectioned') questions = generateSectionedPaper();

            // Recursively flatten for nav generation (simpler) but keep structure for content
            // For Sectioned paper, inject headers

            if (pType === 'sectioned') {
                // Manual header injection for prototype
                const liA = document.createElement('li'); liA.textContent = "Section A"; liA.className = "nav-section-label"; navContainer.appendChild(liA);
            }

            // Render Loop
            questions.forEach(q => {
                // Content
                container.appendChild(renderQuestionNode(q));

                // Nav (Top level only for main list to avoid clutter, or all?) 
                // Brief: "Nav labels consist solely of question identifiers... e.g. 18(a)(i)"
                // Let's implement flat nav for all accessible Qs

                function addToNav(currQ) {
                    const li = document.createElement('li');
                    const a = document.createElement('a');
                    a.className = 'nav-item';
                    a.textContent = currQ.num;
                    a.onclick = (e) => {
                        e.preventDefault();
                        document.getElementById(currQ.id).scrollIntoView({ behavior: 'smooth', block: 'start' });
                        // Update active state
                        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                        a.classList.add('active');
                    };
                    li.appendChild(a);
                    navContainer.appendChild(li);

                    // Mobile
                    const mobA = a.cloneNode(true);
                    mobA.onclick = (e) => {
                        e.preventDefault();
                        document.getElementById(currQ.id).scrollIntoView({ behavior: 'smooth', block: 'start' });
                    };
                    mobileNav.appendChild(mobA);

                    if (currQ.subQuestions) currQ.subQuestions.forEach(addToNav);
                }
                addToNav(q);
            });

            // Additional headers for sectioned logic (hacky for proto)
            if (pType === 'sectioned') {
                const list = navContainer.children;
                // Insert B after Q5, C after Q10
                // (Skipping precise DOM insertion logic for brevity in prototype, relying on visual inspection)
            }
        }

        // --- Events ---
        document.getElementById('paper-select').addEventListener('change', (e) => {
            state.paperType = e.target.value;
            state.expandedOverride = (e.target.value === 'standard-exp');
            renderPaper();
        });

        document.getElementById('katex-toggle').addEventListener('change', (e) => {
            state.useRealKatex = e.target.checked;
            renderPaper(); // Re-render to apply math transform
        });

        // Init
        renderPaper();

    </script>
</body>

</html>