<!DOCTYPE html>
<html lang="en-GB">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTQ - Maths Paper Solution Viewer (Stress Test)</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"
        integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"
        integrity="sha384-XjKyFAMyFwwPWvyCxqJ11N7qjU5rJWxgl9YE6+YtJ+ZgeTDq25PfTef/gVQ01v+U"
        crossorigin="anonymous"></script>

    <style>
        /* =========================================
           STAGE 5: VISUAL TONE & VARIABLES
           "Soft-warm neutral base"
        ========================================= */
        :root {
            /* Palette: Soft-warm neutrals */
            --c-bg-page: #FAF9F8;
            /* Very light warm white */
            --c-bg-solution: #F0EFED;
            /* Subtle separation */

            --c-text-main: #2C2A29;
            /* Warm dark grey */
            --c-text-secondary: #585453;
            --c-text-tertiary: #85807E;

            --c-accent-hover: #1A1918;
            --c-focus-ring: #2C2A29;

            --font-stack: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";

            /* Spacing Rhythm (Stage 5.2) */
            --space-xs: 0.25rem;
            --space-s: 0.5rem;
            --space-m: 1rem;
            --space-l: 2rem;
            --space-xl: 4rem;
            /* Between top-level questions */

            --width-content: 1024px;
            --nav-width: 60px;
        }

        /* Reset & Base */
        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background-color: var(--c-bg-page);
            color: var(--c-text-main);
            font-family: var(--font-stack);
            font-size: 16px;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        button {
            font-family: inherit;
            border: none;
            background: none;
            cursor: pointer;
            color: inherit;
        }

        /* Accessibility Focus */
        :focus-visible {
            outline: 2px solid var(--c-focus-ring);
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* =========================================
           LAYOUT ARCHITECTURE (Canonical Wrapper)
        ========================================= */
        .app-shell {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Top Controls (Aligned with content frame) */
        .top-controls {
            width: 100%;
            max-width: var(--width-content);
            margin: 0 auto;
            padding: var(--space-m) var(--space-l);
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            margin-bottom: var(--space-l);
        }

        .controls-group {
            display: flex;
            gap: var(--space-m);
            align-items: center;
        }

        select {
            padding: var(--space-s);
            font-size: 0.9rem;
            border: 1px solid var(--c-text-tertiary);
            border-radius: 4px;
            background-color: #fff;
            color: var(--c-text-main);
        }

        /* Main Content Frame: Centered, 2 Columns */
        .content-frame {
            flex: 1;
            width: 100%;
            max-width: var(--width-content);
            margin: 0 auto;
            padding: 0 var(--space-l) var(--space-xl);
            display: grid;
            grid-template-columns: var(--nav-width) 1fr;
            /* Navigation | Paper */
            gap: var(--space-l);
            position: relative;
        }

        /* =========================================
           NAVIGATION (Sticky, Quiet)
        ========================================= */
        .nav-rail {
            position: sticky;
            top: 2rem;
            align-self: start;
            max-height: calc(100vh - 4rem);
            overflow-y: auto;

            /* Scrollbar hiding (Add-on) */
            scrollbar-width: none;
            /* Firefox */
            -ms-overflow-style: none;
            /* IE/Edge */
        }

        .nav-rail::-webkit-scrollbar {
            display: none;
            /* Chrome/Safari */
        }

        .nav-list {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 4px;
            /* Tight packing */
        }

        .nav-section-label {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--c-text-tertiary);
            margin-top: var(--space-m);
            margin-bottom: var(--space-xs);
            padding-left: 8px;
            /* Alignment */
        }

        .nav-item {
            display: block;
            font-size: 0.85rem;
            color: var(--c-text-tertiary);
            text-decoration: none;
            padding: 4px 8px;
            border-radius: 4px;
            transition: color 0.1s ease, font-weight 0.1s ease;
        }

        .nav-item:hover {
            color: var(--c-text-main);
            background-color: rgba(0, 0, 0, 0.03);
            /* Subtle hover */
        }

        .nav-item.is-active {
            color: var(--c-text-main);
            font-weight: 700;
        }

        /* Mobile Nav Toggle (Hidden on Desktop) */
        .mobile-nav-toggle {
            display: none;
        }

        /* =========================================
           PAPER CONTENT
        ========================================= */
        .paper-content {
            min-width: 0;
            /* Prevent grid blowout */
            padding-bottom: 20vh;
            /* Breathing room */
        }

        /* Question Block */
        .question-block {
            margin-bottom: var(--space-xl);
            /* Stage 5.2 Rhythm */
            scroll-margin-top: 4rem;
            /* For sticky header/nav clearance */
        }

        /* Nesting Levels */
        .question-block[data-indent="1"] {
            margin-left: 2rem;
            margin-bottom: var(--space-l);
        }

        .question-block[data-indent="2"] {
            margin-left: 4rem;
            margin-bottom: var(--space-m);
        }

        /* Typography Hierarchy (Stage 4.2) */
        .q-header {
            display: flex;
            gap: var(--space-s);
            align-items: baseline;
            margin-bottom: var(--space-m);
        }

        .q-id {
            font-weight: 700;
            font-size: 1.125rem;
            color: var(--c-text-main);
            flex-shrink: 0;
            min-width: 2ch;
        }

        .q-prompt {
            font-size: 1.125rem;
            color: var(--c-text-main);
            line-height: 1.6;
        }

        .q-prompt p {
            margin-bottom: 0.75em;
        }

        .q-prompt p:last-child {
            margin-bottom: 0;
        }

        /* Diagrams */
        .diagram-container {
            margin: var(--space-m) 0;
            max-width: 100%;
            display: flex;
            justify-content: flex-start;
        }

        .diagram-svg {
            max-width: 100%;
            height: auto;
            border: 1px solid #e0e0e0;
            /* Subtle bounding box */
        }

        /* Answer Section (Visible by default) */
        .answer-section {
            margin-top: var(--space-m);
            margin-bottom: var(--space-s);
            display: flex;
            align-items: baseline;
            gap: var(--space-m);
        }

        .label-answer {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--c-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .answer-value {
            font-size: 1.125rem;
            color: var(--c-text-main);
            font-weight: 500;
        }

        /* Solution Details (Collapsed by default) */
        .solution-details-wrapper {
            margin-top: var(--space-s);
        }

        .toggle-btn {
            display: inline-flex;
            align-items: center;
            gap: var(--space-xs);
            font-size: 0.95rem;
            color: var(--c-text-secondary);
            /* Text-first */
            padding: var(--space-xs) 0;
            border-bottom: 1px solid transparent;
            transition: color 0.2s ease, border-color 0.2s ease;
        }

        .toggle-btn:hover {
            color: var(--c-text-main);
            border-bottom-color: var(--c-text-main);
            /* Minimal feedback */
        }

        .toggle-icon {
            font-size: 0.8em;
            transition: transform 0.2s ease;
        }

        .toggle-btn[aria-expanded="true"] .toggle-icon {
            transform: rotate(180deg);
        }

        /* Expandable Region */
        .solution-content {
            display: grid;
            grid-template-rows: 0fr;
            transition: grid-template-rows 0.3s cubic-bezier(0.2, 0, 0.2, 1);
            overflow: hidden;
            background-color: var(--c-bg-solution);
            /* Subtle surface diff */
            border-radius: 4px;
            margin-top: var(--space-s);
        }

        .solution-inner {
            min-height: 0;
            padding: 0 var(--space-m);
            /* Horizontal padding */
            opacity: 0;
            transition: opacity 0.3s ease;
            visibility: hidden;
        }

        /* Expansion State */
        .toggle-btn[aria-expanded="true"]+.solution-content {
            grid-template-rows: 1fr;
        }

        .toggle-btn[aria-expanded="true"]+.solution-content .solution-inner {
            padding: var(--space-m);
            /* Vertical padding only when open */
            opacity: 1;
            visibility: visible;
        }

        /* Solution Components Structure */
        .sol-block {
            margin-bottom: var(--space-l);
        }

        .sol-block:last-child {
            margin-bottom: 0;
        }

        .sol-label {
            display: block;
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--c-text-tertiary);
            margin-bottom: var(--space-s);
            text-transform: uppercase;
        }

        .sol-body {
            font-size: 0.95rem;
            color: var(--c-text-secondary);
            line-height: 1.6;
        }

        /* Math Containment Invariant */
        .katex-display {
            overflow-x: auto !important;
            overflow-y: hidden;
            max-width: 100%;
            padding-bottom: 4px;
            /* Scrollbar space */
            margin: 1em 0;
            text-align: left !important;
            /* Force left align for flow */
        }

        /* Mobile scroll safety */
        .katex-display::-webkit-scrollbar {
            height: 4px;
        }

        .katex-display::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 2px;
        }

        /* Placeholder styling */
        .math-placeholder-block {
            font-family: monospace;
            background: rgba(0, 0, 0, 0.03);
            padding: var(--space-s);
            display: block;
            white-space: pre-wrap;
            color: #555;
            font-size: 0.85rem;
            margin: var(--space-s) 0;
            overflow-x: auto;
        }

        .math-placeholder-inline {
            font-family: monospace;
            background: rgba(0, 0, 0, 0.03);
            padding: 0 4px;
            color: #555;
            font-size: 0.85rem;
        }

        /* =========================================
           RESPONSIVE (Mobile/Tablet)
        ========================================= */
        @media (max-width: 768px) {
            .content-frame {
                display: block;
                /* Stacked */
                padding: 0 var(--space-m) var(--space-xl);
            }

            .nav-rail {
                display: none;
                /* Hidden by default on mobile */
            }

            /* Mobile Nav Overlay (Stage 5.4.1) */
            .mobile-nav-toggle {
                display: inline-flex;
                align-items: center;
                gap: 6px;
                font-size: 0.9rem;
                font-weight: 600;
                color: var(--c-text-main);
                padding: 8px 12px;
                background: #fff;
                border: 1px solid var(--c-text-tertiary);
                border-radius: 20px;
                margin-left: auto;
                /* Push to right */
            }

            .mobile-nav-drawer {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 1000;
                opacity: 0;
                pointer-events: none;
                transition: opacity 0.2s ease;
                display: flex;
                justify-content: flex-end;
            }

            .mobile-nav-drawer.is-open {
                opacity: 1;
                pointer-events: auto;
            }

            .mobile-nav-content {
                width: 80%;
                max-width: 300px;
                background: var(--c-bg-page);
                height: 100%;
                padding: var(--space-l);
                overflow-y: auto;
                transform: translateX(100%);
                transition: transform 0.2s cubic-bezier(0.2, 0, 0.2, 1);
            }

            .mobile-nav-drawer.is-open .mobile-nav-content {
                transform: translateX(0);
            }

            .top-controls {
                flex-wrap: wrap;
                gap: var(--space-m);
            }
        }
    </style>
</head>

<body>

    <div class="app-shell">

        <header class="top-controls">
            <div class="controls-group">
                <label for="paper-select" style="font-weight:600; font-size:0.9rem;">Paper:</label>
                <select id="paper-select">
                    <option value="short">Short Paper (6 Qs)</option>
                    <option value="standard">Standard Paper (35 Qs)</option>
                    <option value="diagram">Diagram Heavy (20 Qs)</option>
                    <option value="sectioned">Sectioned Paper (A/B/C)</option>
                    <option value="standard-expanded">Standard (Workings Expanded)</option>
                </select>
            </div>

            <div class="controls-group">
                <label style="font-size:0.9rem; display:flex; align-items:center; gap:8px;">
                    <input type="checkbox" id="katex-toggle">
                    Real KaTeX Rendering
                </label>
                <button class="mobile-nav-toggle" id="mobile-nav-trigger">
                    <span>Jump to Q</span>
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                </button>
            </div>
        </header>

        <div class="content-frame">

            <nav class="nav-rail" id="desktop-nav" aria-label="Paper Navigation">
                <ul class="nav-list" id="nav-list-container">
                </ul>
            </nav>

            <main class="paper-content" id="paper-container">
            </main>

        </div>
    </div>

    <div class="mobile-nav-drawer" id="mobile-drawer">
        <div class="mobile-nav-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                <h3 style="font-size:1.1rem; font-weight:700;">Jump to</h3>
                <button id="close-mobile-nav" style="padding:8px; font-size:1.5rem;">&times;</button>
            </div>
            <ul class="nav-list" id="mobile-nav-list-container">
            </ul>
        </div>
    </div>

    <script>
        // =========================================
        // DATASETS & GENERATORS
        // =========================================

        // Helper: Create a generic question
        function createQuestion(id, promptText, answerText, workingText, options = {}) {
            return {
                id: id,
                prompt: promptText,
                answer: answerText,
                working: workingText,
                altWorking: options.altWorking || null,
                keepInMind: options.keepInMind || null,
                formulas: options.formulas || null,
                section: options.section || null,
                diagramType: options.diagramType || null,
                subLevel: options.subLevel || 0,
                isLong: options.isLong || false,
                forceExpanded: options.forceExpanded || false
            };
        }

        // SVG Diagram Generators
        const svgs = {
            geometry: `<svg class="diagram-svg" width="200" height="150" viewBox="0 0 200 150"><path d="M20,130 L100,20 L180,130 Z" fill="none" stroke="#555" stroke-width="2"/><circle cx="100" cy="85" r="30" fill="none" stroke="#999" stroke-dasharray="4 2"/><text x="90" y="80" font-family="sans-serif" font-size="12" fill="#333">x</text><text x="95" y="145" font-family="sans-serif" font-size="12" fill="#333">10cm</text></svg>`,
            bar: `<svg class="diagram-svg" width="200" height="100" viewBox="0 0 200 100"><rect x="20" y="20" width="160" height="60" fill="none" stroke="#ccc"/><rect x="20" y="20" width="40" height="60" fill="#ddd"/><rect x="60" y="20" width="80" height="60" fill="#eee"/><line x1="60" y1="20" x2="60" y2="80" stroke="#555"/><line x1="140" y1="20" x2="140" y2="80" stroke="#555"/><text x="35" y="55" font-family="sans-serif" font-size="12" fill="#333">A</text><text x="95" y="55" font-family="sans-serif" font-size="12" fill="#333">B</text></svg>`,
            coord: `<svg class="diagram-svg" width="150" height="150" viewBox="0 0 150 150"><line x1="10" y1="140" x2="140" y2="140" stroke="#333"/><line x1="10" y1="10" x2="10" y2="140" stroke="#333"/><line x1="10" y1="140" x2="130" y2="20" stroke="#555" stroke-dasharray="4"/><circle cx="70" cy="80" r="3" fill="#333"/><text x="75" y="80" font-family="sans-serif" font-size="10">P(3,4)</text></svg>`,
            table: `<svg class="diagram-svg" width="240" height="80" viewBox="0 0 240 80"><rect x="0" y="0" width="240" height="80" fill="none" stroke="#ccc"/><line x1="0" y1="40" x2="240" y2="40" stroke="#ccc"/><line x1="80" y1="0" x2="80" y2="80" stroke="#ccc"/><line x1="160" y1="0" x2="160" y2="80" stroke="#ccc"/><text x="10" y="25" font-family="sans-serif" font-size="12">Item</text><text x="90" y="25" font-family="sans-serif" font-size="12">Cost</text><text x="170" y="25" font-family="sans-serif" font-size="12">Qty</text></svg>`
        };

        // Long Working Text (Stress Test)
        const longWorkingText = `$$ \\text{Let } x \\text{ be the number of apples.} $$ 
$$ \\text{Let } y \\text{ be the number of oranges.} $$
$$ 1) \\quad 3x + 2y = 15 $$
$$ 2) \\quad x - y = 5 \\implies x = y + 5 $$
$$ \\text{Substitute (2) into (1):} $$
$$ 3(y+5) + 2y = 15 $$
$$ 3y + 15 + 2y = 15 $$
$$ 5y = 0 \\implies y = 0 $$
$$ x = 0 + 5 = 5 $$
$$ \\text{Now verify with a second method to ensure robustness.} $$
$$ \\text{Method 2: Matrix inversion} $$
$$ \\begin{pmatrix} 3 & 2 \\\\ 1 & -1 \\end{pmatrix} \\begin{pmatrix} x \\\\ y \\end{pmatrix} = \\begin{pmatrix} 15 \\\\ 5 \\end{pmatrix} $$
$$ \\det = (3)(-1) - (2)(1) = -5 $$
$$ A^{-1} = \\frac{-1}{5} \\begin{pmatrix} -1 & -2 \\\\ -1 & 3 \\end{pmatrix} $$
$$ \\begin{pmatrix} x \\\\ y \\end{pmatrix} = \\frac{-1}{5} \\begin{pmatrix} -1 & -2 \\\\ -1 & 3 \\end{pmatrix} \\begin{pmatrix} 15 \\\\ 5 \\end{pmatrix} $$
$$ = \\frac{-1}{5} \\begin{pmatrix} -15 - 10 \\\\ -15 + 15 \\end{pmatrix} = \\frac{-1}{5} \\begin{pmatrix} -25 \\\\ 0 \\end{pmatrix} = \\begin{pmatrix} 5 \\\\ 0 \\end{pmatrix} $$
$$ \\text{Therefore, } x=5, y=0. $$`;

        // DATASETS
        const datasets = {
            short: [
                createQuestion("1", "Calculate $$ 12 + 4 \\times 3 $$", "24", "$$ 12 + 12 = 24 $$"),
                createQuestion("2", "Simplify $$ 3a + 2b - a + 4b $$", "$$ 2a + 6b $$", "$$ (3a - a) + (2b + 4b) = 2a + 6b $$"),
                createQuestion("3(a)", "Expand $$ 3(x+4) $$", "$$ 3x+12 $$", "$$ 3 \\times x + 3 \\times 4 = 3x + 12 $$", { subLevel: 1 }),
                createQuestion("3(b)", "Factorise $$ 3x+12 $$", "$$ 3(x+4) $$", "$$ \\text{HCF is 3. } 3(x+4) $$", { subLevel: 1 }),
                createQuestion("4", "Find the area of the triangle.", "50 cm²", "$$ \\text{Area} = \\frac{1}{2} \\times \\text{base} \\times \\text{height} = \\frac{1}{2} \\times 10 \\times 10 = 50 $$", { diagramType: "geometry" }),
                createQuestion("5", "Solve $$ 2x = 10 $$", "$$ x=5 $$", "$$ x = 10 \\div 2 = 5 $$")
            ],
            standard: [], // Generated below
            diagram: [],  // Generated below
            sectioned: [] // Generated below
        };

        // Populate Standard (35 Qs)
        for (let i = 1; i <= 35; i++) {
            let q = createQuestion(
                i.toString(),
                `Solve for x: $$ ${i}x + 5 = 20 $$`,
                `$$ x = ${(15 / i).toFixed(2)} $$`,
                `$$ ${i}x = 15 \\implies x = \\frac{15}{${i}} $$`
            );

            // Q26-35 Long
            if (i >= 26) {
                q.isLong = true;
                q.working = longWorkingText;
                q.keepInMind = "Remember to check your units at the end.";
            }

            // Sub-question nesting stress test at 30
            if (i === 30) {
                datasets.standard.push(createQuestion("30(a)(i)", "Find x", "5", "x=5", { subLevel: 2 }));
                datasets.standard.push(createQuestion("30(a)(ii)", "Find y", "2", "y=2", { subLevel: 2 }));
                datasets.standard.push(createQuestion("30(b)", "Find z", "10", "z=10", { subLevel: 1 }));
            } else {
                datasets.standard.push(q);
            }
        }

        // Populate Diagram Heavy (20 Qs)
        const dTypes = ['geometry', 'bar', 'coord', 'table'];
        for (let i = 1; i <= 20; i++) {
            let dType = (i % 3 === 0) ? dTypes[i % 4] : null;
            datasets.diagram.push(createQuestion(i.toString(), "Analyse the diagram data.", "See working", "Detailed analysis...", { diagramType: dType }));
        }

        // Populate Sectioned
        // Section A (1-5 for brevity in logic, but represents 35)
        for (let i = 1; i <= 5; i++) datasets.sectioned.push(createQuestion(i.toString(), "Sec A Question", "Ans", "Work", { section: "Section A" }));
        // Section B (6-8)
        for (let i = 6; i <= 8; i++) datasets.sectioned.push(createQuestion(i.toString(), "Sec B Question", "Ans", "Work", { section: "Section B" }));
        // Section C (9-10 Long)
        for (let i = 9; i <= 10; i++) datasets.sectioned.push(createQuestion(i.toString(), "Sec C Long", "Ans", longWorkingText, { section: "Section C", isLong: true, keepInMind: "Difficult topic", formulas: "Quadratic Formula", altWorking: "Trial and error method" }));

        // Standard Expanded (Clone standard)
        datasets["standard-expanded"] = datasets.standard.map(q => ({ ...q, forceExpanded: true }));

        // =========================================
        // RENDERING LOGIC
        // =========================================

        const domPaper = document.getElementById('paper-container');
        const domNav = document.getElementById('nav-list-container');
        const domMobileNav = document.getElementById('mobile-nav-list-container');
        const selector = document.getElementById('paper-select');
        const katexToggle = document.getElementById('katex-toggle');

        function renderMath(text, isDisplay = false) {
            const useKatex = katexToggle.checked && window.katex;
            // Simple regex for $$...$$ replacement
            // Note: This is a stress test prototype regex, not a production parser.
            return text.replace(/\$\$(.*?)\$\$/g, (match, mathContent) => {
                if (useKatex) {
                    try {
                        return katex.renderToString(mathContent, { displayMode: isDisplay || text.trim().startsWith('$$') && text.trim().endsWith('$$') });
                    } catch (e) {
                        return `<span style="color:red">Math Error</span>`;
                    }
                } else {
                    return isDisplay
                        ? `<div class="katex-display math-placeholder-block">[Block Math: ${mathContent}]</div>`
                        : `<span class="math-placeholder-inline">[Inline: ${mathContent}]</span>`;
                }
            });
        }

        function renderPaper(datasetKey) {
            const data = datasets[datasetKey];
            domPaper.innerHTML = '';
            domNav.innerHTML = '';
            domMobileNav.innerHTML = '';

            let currentSection = null;

            data.forEach((q, index) => {
                // Section Headers (Nav Only)
                if (q.section && q.section !== currentSection) {
                    currentSection = q.section;
                    const secHeader = document.createElement('li');
                    secHeader.className = 'nav-section-label';
                    secHeader.textContent = currentSection;
                    domNav.appendChild(secHeader.cloneNode(true));
                    domMobileNav.appendChild(secHeader.cloneNode(true));
                }

                // --- 1. Render Question Block ---
                const qBlock = document.createElement('div');
                qBlock.className = 'question-block';
                qBlock.id = `q-${q.id}`;
                qBlock.dataset.indent = q.subLevel;

                // Diagram
                let diagramHTML = '';
                if (q.diagramType && svgs[q.diagramType]) {
                    diagramHTML = `<div class="diagram-container">${svgs[q.diagramType]}</div>`;
                }

                // Solution Details Content
                // Order: Keep in mind -> Formulas -> Working -> Alt
                let detailsHTML = '';

                if (q.keepInMind) {
                    detailsHTML += `<div class="sol-block"><span class="sol-label">Keep in mind</span><div class="sol-body">${renderMath(q.keepInMind)}</div></div>`;
                }
                if (q.formulas) {
                    detailsHTML += `<div class="sol-block"><span class="sol-label">Formulas used</span><div class="sol-body">${renderMath(q.formulas)}</div></div>`;
                }

                // Primary Working
                detailsHTML += `<div class="sol-block"><span class="sol-label">Working</span><div class="sol-body">${renderMath(q.working, true)}</div></div>`;

                if (q.altWorking) {
                    detailsHTML += `<div class="sol-block"><span class="sol-label">Alternative working</span><div class="sol-body">${renderMath(q.altWorking, true)}</div></div>`;
                }

                const expandedAttr = q.forceExpanded ? 'true' : 'false';

                qBlock.innerHTML = `
                    <div class="q-header">
                        <span class="q-id">${q.id}</span>
                        <div class="q-prompt">
                            <div>${renderMath(q.prompt)}</div>
                            ${diagramHTML}
                        </div>
                    </div>
                    
                    <div class="answer-section">
                        <span class="label-answer">Answer</span>
                        <span class="answer-value">${renderMath(q.answer)}</span>
                    </div>

                    <div class="solution-details-wrapper">
                        <button class="toggle-btn" aria-expanded="${expandedAttr}" aria-controls="sol-${q.id}">
                            <span>${q.forceExpanded ? 'Hide working' : 'Show working'}</span>
                            <span class="toggle-icon">▼</span>
                        </button>
                        <div id="sol-${q.id}" class="solution-content">
                            <div class="solution-inner">
                                ${detailsHTML}
                            </div>
                        </div>
                    </div>
                `;

                domPaper.appendChild(qBlock);

                // --- 2. Render Nav Item ---
                const createNavItem = () => {
                    const li = document.createElement('li');
                    const a = document.createElement('a');
                    a.className = 'nav-item';
                    a.href = `#q-${q.id}`;
                    a.textContent = q.id;
                    a.onclick = (e) => {
                        e.preventDefault();
                        document.getElementById(`q-${q.id}`).scrollIntoView({ behavior: 'smooth' });
                        // Close mobile nav if open
                        document.getElementById('mobile-drawer').classList.remove('is-open');
                    };
                    li.appendChild(a);
                    return li;
                };

                domNav.appendChild(createNavItem());
                domMobileNav.appendChild(createNavItem());
            });

            // Re-bind toggles
            document.querySelectorAll('.toggle-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const isExpanded = btn.getAttribute('aria-expanded') === 'true';
                    btn.setAttribute('aria-expanded', !isExpanded);
                    btn.querySelector('span:first-child').textContent = !isExpanded ? 'Hide working' : 'Show working';
                });
            });
        }

        // =========================================
        // INITIALIZATION & EVENTS
        // =========================================

        function init() {
            renderPaper('short'); // Default

            // Paper Selector
            selector.addEventListener('change', (e) => {
                renderPaper(e.target.value);
            });

            // KaTeX Toggle
            katexToggle.addEventListener('change', () => {
                // Re-render current paper to apply math setting
                renderPaper(selector.value);
            });

            // Mobile Nav
            const drawer = document.getElementById('mobile-drawer');
            document.getElementById('mobile-nav-trigger').addEventListener('click', () => {
                drawer.classList.add('is-open');
            });
            document.getElementById('close-mobile-nav').addEventListener('click', () => {
                drawer.classList.remove('is-open');
            });

            // Scroll Spy for Nav Highlighting
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        // Remove active class from all
                        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('is-active'));
                        // Add to current
                        const id = entry.target.id.replace('q-', '');
                        const navItems = document.querySelectorAll(`.nav-item`);
                        navItems.forEach(item => {
                            if (item.textContent === id) item.classList.add('is-active');
                        });
                    }
                });
            }, { rootMargin: '-20% 0px -60% 0px' }); // Trigger when in top part of screen

            // Mutation Observer to attach IntersectionObserver to new elements
            const mo = new MutationObserver(() => {
                document.querySelectorAll('.question-block').forEach(el => observer.observe(el));
            });
            mo.observe(domPaper, { childList: true });
        }

        // Run
        init();

    </script>
</body>

</html>