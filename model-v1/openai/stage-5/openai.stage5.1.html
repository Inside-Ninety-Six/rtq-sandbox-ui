<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Paper Viewer</title>
    <style>
        :root {
            /* Soft-warm neutral base (subtle, desaturated; no brand colours) */
            --bg: #f5f1ea;
            --surface: #fbf8f2;
            --surface-2: #f2eee6;
            --ink: #1d1c1a;
            --muted: #5d5a55;
            --faint: #7a766f;
            --rule: #dfd8cd;
            --focus: #2b2824;
            /* neutral focus */
            --shadow: 0 1px 0 rgba(0, 0, 0, 0.04);
            --radius: 12px;
            --gutter: 20px;
            --frame-max: 1180px;

            --text-sm: 13px;
            --text-md: 15px;
            --text-lg: 17px;
            --text-xl: 19px;

            --lh: 1.5;
        }

        * {
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            margin: 0;
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
            line-height: var(--lh);
            color: var(--ink);
            background: var(--bg);
        }

        a {
            color: inherit;
            text-decoration: none;
        }

        button,
        select {
            font: inherit;
            color: inherit;
        }

        /* Top controls */
        .topbar {
            position: sticky;
            top: 0;
            z-index: 40;
            background: rgba(245, 241, 234, 0.92);
            backdrop-filter: blur(6px);
            border-bottom: 1px solid var(--rule);
        }

        .topbar-inner {
            max-width: var(--frame-max);
            margin: 0 auto;
            padding: 12px var(--gutter);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .brand {
            display: flex;
            flex-direction: column;
            gap: 2px;
            min-width: 160px;
        }

        .brand .title {
            font-size: var(--text-md);
            font-weight: 600;
            letter-spacing: 0.1px;
        }

        .brand .sub {
            font-size: var(--text-sm);
            color: var(--muted);
        }

        .controls {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .label {
            font-size: var(--text-sm);
            color: var(--muted);
        }

        .select {
            border: 1px solid var(--rule);
            background: var(--surface);
            border-radius: 10px;
            padding: 8px 10px;
            min-width: 240px;
            box-shadow: var(--shadow);
            outline: none;
        }

        .select:focus {
            outline: 2px solid var(--focus);
            outline-offset: 2px;
        }

        .navToggle {
            border: 1px solid var(--rule);
            background: var(--surface);
            border-radius: 10px;
            padding: 8px 10px;
            box-shadow: var(--shadow);
            cursor: pointer;
            white-space: nowrap;
        }

        .navToggle:hover {
            text-decoration: underline;
        }

        /* one minimal hover change */
        .navToggle:focus {
            outline: 2px solid var(--focus);
            outline-offset: 2px;
        }

        /* Centered frame containing nav + paper (canonical) */
        .frame {
            max-width: var(--frame-max);
            margin: 0 auto;
            padding: 14px var(--gutter) 48px;
            display: grid;
            grid-template-columns: 104px 1fr;
            gap: 22px;
            align-items: start;
        }

        /* Navigation rail (quiet, documentation-style) */
        aside.nav {
            position: sticky;
            top: 62px;
            /* below topbar */
            align-self: start;
        }

        .navCard {
            background: transparent;
            border: 0;
            border-radius: var(--radius);
        }

        .navHeader {
            font-size: var(--text-sm);
            color: var(--muted);
            margin: 0 0 8px 0;
        }

        .navScroll {
            max-height: calc(100vh - 98px);
            overflow: auto;
            padding: 2px 0;
            border-left: 1px solid transparent;
            /* keep layout stable */
        }

        /* Scrollbar hiding (cross-browser fallbacks) */
        .navScroll {
            scrollbar-width: none;
            /* Firefox */
            -ms-overflow-style: none;
            /* legacy */
        }

        .navScroll::-webkit-scrollbar {
            display: none;
        }

        /* WebKit/Blink */

        .navList {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .navItem a {
            display: block;
            padding: 6px 6px;
            border-radius: 10px;
            font-size: var(--text-sm);
            color: var(--muted);
            letter-spacing: 0.2px;
        }

        .navItem a:hover {
            text-decoration: underline;
        }

        /* one minimal hover change */
        .navItem a:focus {
            outline: 2px solid var(--focus);
            outline-offset: 2px;
        }

        .navSep {
            padding: 10px 6px 6px;
            font-size: var(--text-sm);
            color: var(--faint);
            letter-spacing: 0.18px;
            text-transform: none;
            user-select: none;
        }

        /* Paper column */
        main.paper {
            background: transparent;
        }

        .paperShell {
            background: var(--surface);
            border: 1px solid var(--rule);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 14px 14px 6px;
        }

        .paperMeta {
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            gap: 12px;
            padding: 2px 4px 10px;
            border-bottom: 1px solid var(--rule);
            margin-bottom: 10px;
        }

        .paperMeta .name {
            font-size: var(--text-lg);
            font-weight: 650;
            letter-spacing: 0.1px;
        }

        .paperMeta .hint {
            font-size: var(--text-sm);
            color: var(--muted);
        }

        /* Question blocks */
        .q {
            padding: 14px 10px 12px;
            border-bottom: 1px solid var(--rule);
        }

        .q:last-child {
            border-bottom: 0;
        }

        .qHead {
            display: grid;
            grid-template-columns: 44px 1fr;
            gap: 10px;
            align-items: start;
        }

        .qNum {
            font-size: var(--text-md);
            color: var(--muted);
            font-weight: 650;
            line-height: 1.2;
            padding-top: 1px;
        }

        .qPrompt {
            font-size: var(--text-xl);
            font-weight: 600;
            letter-spacing: 0.1px;
        }

        .qPrompt .math-inline {
            font-size: 0.98em;
            color: var(--muted);
            font-weight: 560;
            white-space: nowrap;
        }

        .qBody {
            margin-left: 54px;
            margin-top: 10px;
            display: grid;
            gap: 10px;
        }

        .answerRow {
            display: flex;
            gap: 8px;
            align-items: baseline;
            flex-wrap: wrap;
        }

        .answerLabel {
            font-size: var(--text-sm);
            color: var(--muted);
        }

        .answerValue {
            font-size: var(--text-lg);
            font-weight: 560;
            color: var(--ink);
        }

        /* Disclosure control: text-first; visually subordinate to Answer; not button-like */
        .disclose {
            justify-self: start;
            border: 0;
            background: transparent;
            padding: 0;
            margin: 2px 0 0;
            cursor: pointer;
            color: var(--muted);
            font-size: var(--text-sm);
        }

        .disclose .chev {
            display: inline-block;
            transform: translateY(1px);
            margin-right: 6px;
            color: var(--faint);
        }

        .disclose:hover {
            text-decoration: underline;
        }

        /* one minimal hover change */
        .disclose:focus {
            outline: 2px solid var(--focus);
            outline-offset: 3px;
            border-radius: 10px;
        }

        /* Solution details: subordinate, integrated, no panel framing */
        .details {
            margin-top: 8px;
            display: grid;
            gap: 10px;
            max-width: 72ch;
        }

        .detailBlock {
            display: grid;
            gap: 4px;
        }

        .detailLabel {
            font-size: var(--text-sm);
            color: var(--muted);
            font-weight: 650;
            letter-spacing: 0.12px;
        }

        .detailBody {
            font-size: var(--text-md);
            color: var(--ink);
        }

        .workLines {
            display: grid;
            gap: 2px;
            font-size: var(--text-md);
            color: var(--ink);
        }

        .workLine {
            color: var(--ink);
        }

        .workLine .math-inline {
            color: var(--muted);
            font-weight: 560;
        }

        .math-block {
            display: block;
            margin: 8px 0;
            padding: 10px 12px;
            border: 1px solid var(--rule);
            border-radius: 12px;
            background: var(--surface-2);
            color: var(--muted);
            font-size: var(--text-sm);
        }

        /* Diagrams: inline SVG placeholders (responsive) */
        .diagram {
            border: 1px solid var(--rule);
            border-radius: 12px;
            background: var(--surface-2);
            padding: 10px;
            max-width: 520px;
        }

        .diagram svg {
            width: 100%;
            height: auto;
            display: block;
        }

        .diagramCaption {
            margin-top: 6px;
            font-size: var(--text-sm);
            color: var(--muted);
        }

        /* Nesting: indentation only (no borders) */
        .nest-1 {
            margin-left: 18px;
        }

        .nest-2 {
            margin-left: 36px;
        }

        .nest-3 {
            margin-left: 54px;
        }

        .part {
            padding-top: 10px;
        }

        .part .qHead {
            grid-template-columns: 44px 1fr;
        }

        .part .qPrompt {
            font-size: var(--text-lg);
            font-weight: 600;
        }

        .part .qBody {
            margin-left: 54px;
        }

        /* Mobile / Tablet */
        @media (max-width: 920px) {
            .frame {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            aside.nav {
                display: none;
            }

            .brand {
                min-width: unset;
            }

            .select {
                min-width: 220px;
            }

            .navToggle {
                display: inline-flex;
            }
        }

        @media (min-width: 921px) {
            .navToggle {
                display: none;
            }
        }

        /* Drawer (minimal overlay) */
        .drawerOverlay {
            position: fixed;
            inset: 0;
            background: rgba(29, 28, 26, 0.18);
            z-index: 60;
            display: none;
        }

        .drawer {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: min(320px, 88vw);
            background: var(--surface);
            border-right: 1px solid var(--rule);
            box-shadow: 12px 0 24px rgba(0, 0, 0, 0.10);
            padding: 12px 12px 10px;
            display: none;
            z-index: 70;
        }

        .drawerTop {
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            gap: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--rule);
            margin-bottom: 10px;
        }

        .drawerTitle {
            font-size: var(--text-md);
            font-weight: 650;
        }

        .drawerClose {
            border: 0;
            background: transparent;
            color: var(--muted);
            cursor: pointer;
            padding: 4px 6px;
            border-radius: 10px;
        }

        .drawerClose:hover {
            text-decoration: underline;
        }

        .drawerClose:focus {
            outline: 2px solid var(--focus);
            outline-offset: 2px;
        }

        .drawer .navScroll {
            max-height: calc(100vh - 86px);
            padding: 0;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
    </style>
</head>

<body>

    <header class="topbar" role="banner">
        <div class="topbar-inner">
            <div class="brand" aria-label="Application header">
                <div class="title">Paper Viewer</div>
                <div class="sub">Single continuous scroll · Answers visible · Workings inline</div>
            </div>

            <div class="controls">
                <button id="navToggle" class="navToggle" type="button" aria-haspopup="dialog" aria-controls="drawer"
                    aria-expanded="false">
                    Navigation
                </button>

                <span class="label">Paper</span>
                <select id="paperSelect" class="select" aria-label="Paper selector">
                    <!-- populated by JS -->
                </select>
            </div>
        </div>
    </header>

    <div class="frame" role="main">
        <aside class="nav" aria-label="Question navigation">
            <div class="navCard">
                <div class="navHeader">Questions</div>
                <div class="navScroll" tabindex="0" aria-label="Question list (scrollable)">
                    <ul id="navList" class="navList"></ul>
                </div>
            </div>
        </aside>

        <main class="paper" aria-label="Paper content">
            <div class="paperShell">
                <div class="paperMeta">
                    <div class="name" id="paperName">—</div>
                    <div class="hint" id="paperHint">—</div>
                </div>
                <div id="paperContent"></div>
            </div>
        </main>
    </div>

    <!-- Mobile drawer -->
    <div id="drawerOverlay" class="drawerOverlay" tabindex="-1" aria-hidden="true"></div>
    <div id="drawer" class="drawer" role="dialog" aria-modal="true" aria-label="Navigation drawer" aria-hidden="true">
        <div class="drawerTop">
            <div class="drawerTitle">Questions</div>
            <button id="drawerClose" class="drawerClose" type="button">Close</button>
        </div>
        <div class="navScroll" tabindex="0" aria-label="Question list (scrollable)">
            <ul id="drawerNavList" class="navList"></ul>
        </div>
    </div>

    <script>
        // ---------- Inline SVG diagram placeholders (reused types) ----------
        function svgGeometry() {
            return `
        <div class="diagram">
          <svg viewBox="0 0 420 240" xmlns="http://www.w3.org/2000/svg" aria-label="Geometry diagram placeholder" role="img">
            <rect x="10" y="10" width="400" height="220" rx="14" fill="none" stroke="rgba(0,0,0,0.18)" stroke-width="2"/>
            <circle cx="300" cy="120" r="46" fill="none" stroke="rgba(0,0,0,0.22)" stroke-width="3"/>
            <path d="M90 175 L160 60 L230 175 Z" fill="none" stroke="rgba(0,0,0,0.26)" stroke-width="3"/>
            <text x="150" y="52" font-size="14" fill="rgba(0,0,0,0.50)">A</text>
            <text x="80" y="192" font-size="14" fill="rgba(0,0,0,0.50)">B</text>
            <text x="232" y="192" font-size="14" fill="rgba(0,0,0,0.50)">C</text>
            <text x="292" y="124" font-size="14" fill="rgba(0,0,0,0.50)">r</text>
          </svg>
          <div class="diagramCaption">[SVG placeholder: triangle / circle with labels]</div>
        </div>`;
        }

        function svgRatioBars() {
            return `
        <div class="diagram">
          <svg viewBox="0 0 420 240" xmlns="http://www.w3.org/2000/svg" aria-label="Ratio bars diagram placeholder" role="img">
            <rect x="10" y="10" width="400" height="220" rx="14" fill="none" stroke="rgba(0,0,0,0.18)" stroke-width="2"/>
            <rect x="40" y="70" width="320" height="34" rx="10" fill="rgba(0,0,0,0.06)" stroke="rgba(0,0,0,0.20)"/>
            <rect x="40" y="70" width="180" height="34" rx="10" fill="rgba(0,0,0,0.10)"/>
            <rect x="40" y="132" width="320" height="34" rx="10" fill="rgba(0,0,0,0.06)" stroke="rgba(0,0,0,0.20)"/>
            <rect x="40" y="132" width="240" height="34" rx="10" fill="rgba(0,0,0,0.10)"/>
            <text x="40" y="62" font-size="13" fill="rgba(0,0,0,0.55)">Bar A</text>
            <text x="40" y="124" font-size="13" fill="rgba(0,0,0,0.55)">Bar B</text>
          </svg>
          <div class="diagramCaption">[SVG placeholder: bar / ratio bars]</div>
        </div>`;
        }

        function svgCoordinateGrid() {
            return `
        <div class="diagram">
          <svg viewBox="0 0 420 240" xmlns="http://www.w3.org/2000/svg" aria-label="Coordinate grid diagram placeholder" role="img">
            <rect x="10" y="10" width="400" height="220" rx="14" fill="none" stroke="rgba(0,0,0,0.18)" stroke-width="2"/>
            <g stroke="rgba(0,0,0,0.10)" stroke-width="1">
              ${Array.from({ length: 9 }, (_, i) => `<line x1="${60 + i * 34}" y1="30" x2="${60 + i * 34}" y2="210"/>`).join("")}
              ${Array.from({ length: 7 }, (_, i) => `<line x1="40" y1="${48 + i * 26}" x2="380" y2="${48 + i * 26}"/>`).join("")}
            </g>
            <g stroke="rgba(0,0,0,0.28)" stroke-width="2">
              <line x1="40" y1="120" x2="380" y2="120"/>
              <line x1="210" y1="30" x2="210" y2="210"/>
            </g>
            <path d="M80 170 L150 140 L220 120 L310 78" fill="none" stroke="rgba(0,0,0,0.30)" stroke-width="3"/>
            <circle cx="150" cy="140" r="4" fill="rgba(0,0,0,0.45)"/>
            <circle cx="220" cy="120" r="4" fill="rgba(0,0,0,0.45)"/>
            <circle cx="310" cy="78" r="4" fill="rgba(0,0,0,0.45)"/>
          </svg>
          <div class="diagramCaption">[SVG placeholder: coordinate grid with points/line]</div>
        </div>`;
        }

        function svgArrayGrid() {
            return `
        <div class="diagram">
          <svg viewBox="0 0 420 240" xmlns="http://www.w3.org/2000/svg" aria-label="Array/table diagram placeholder" role="img">
            <rect x="10" y="10" width="400" height="220" rx="14" fill="none" stroke="rgba(0,0,0,0.18)" stroke-width="2"/>
            <g stroke="rgba(0,0,0,0.20)" stroke-width="2" fill="none">
              <rect x="80" y="55" width="260" height="130" rx="10"/>
              ${Array.from({ length: 4 }, (_, i) => `<line x1="${80 + i * 65}" y1="55" x2="${80 + i * 65}" y2="185"/>`).join("")}
              ${Array.from({ length: 3 }, (_, i) => `<line x1="80" y1="${55 + i * 43}" x2="340" y2="${55 + i * 43}"/>`).join("")}
            </g>
            <text x="92" y="82" font-size="13" fill="rgba(0,0,0,0.50)">a</text>
            <text x="157" y="82" font-size="13" fill="rgba(0,0,0,0.50)">b</text>
            <text x="222" y="82" font-size="13" fill="rgba(0,0,0,0.50)">c</text>
            <text x="287" y="82" font-size="13" fill="rgba(0,0,0,0.50)">d</text>
          </svg>
          <div class="diagramCaption">[SVG placeholder: table-like grid / array]</div>
        </div>`;
        }

        function diagramByType(type) {
            if (type === "geometry") return svgGeometry();
            if (type === "ratio") return svgRatioBars();
            if (type === "grid") return svgCoordinateGrid();
            if (type === "array") return svgArrayGrid();
            return "";
        }

        // ---------- Paper datasets ----------
        function mathInline(txt) { return `<span class="math-inline">[KaTeX inline: ${escapeHtml(txt)}]</span>`; }
        function mathBlock(txt) { return `<span class="math-block">[KaTeX block: ${escapeHtml(txt)}]</span>`; }

        function makeWorkLines(lines) {
            return lines.map(l => `<div class="workLine">${l}</div>`).join("");
        }

        function longWorkLines(count, seed) {
            // 50–60 lines stress test (selected questions)
            const out = [];
            for (let i = 1; i <= count; i++) {
                const step = (i < 10 ? "0" + i : "" + i);
                out.push(`${step}. ${mathInline(seed + " \\rightarrow " + seed + " + " + i)}   (simplify)`);
            }
            return out;
        }

        function q(id, label, promptHtml, answerHtml, details) {
            return { id, label, promptHtml, answerHtml, details: details || {}, parts: [] };
        }

        function part(id, label, promptHtml, answerHtml, details, depth) {
            return { id, label, promptHtml, answerHtml, details: details || {}, parts: [], depth: depth || 1, isPart: true };
        }

        // Build Short paper (6 questions, one multi-part)
        const shortPaper = {
            key: "short",
            name: "Short paper",
            hint: "6 questions · includes one multi-part question",
            workingsExpandedByDefault: false,
            sections: [
                {
                    label: null, questions: (function () {
                        const qs = [];
                        qs.push(q("q1", "1", `Calculate 48 ÷ 6.`, `8`, {
                            working: [
                                `48 ÷ 6 = 8`
                            ]
                        }));
                        qs.push(q("q2", "2", `Find 15% of 80.`, `12`, {
                            formulas: `Percent means “out of 100”.`,
                            working: [
                                `15% of 80 = ${mathInline("0.15 \\times 80")} = 12`
                            ]
                        }));
                        qs.push(q("q3", "3", `Write 0.375 as a fraction in simplest form.`, `${mathInline("\\frac{3}{8}")}`, {
                            keepInMind: `Convert decimals to fractions by using place value.`,
                            working: [
                                `0.375 = ${mathInline("\\frac{375}{1000}")}`,
                                `= ${mathInline("\\frac{3}{8}")} (divide top and bottom by 125)`
                            ]
                        }));
                        const q4 = q("q4", "4", `A box has 3 red counters and 5 blue counters. What is the ratio red:blue?`, `3:5`, {
                            working: [
                                `Red = 3, Blue = 5`,
                                `Ratio red:blue = 3:5`
                            ]
                        });
                        q4.details.diagram = "ratio";
                        qs.push(q4);

                        // Multi-part
                        const q5 = q("q5", "5", `A rectangle has perimeter 36 cm. One side is 10 cm. Find the other side length.`, `8 cm`, {
                            working: [
                                `Perimeter = 2(L + W)`,
                                `${mathInline("36 = 2(10 + W)")}`,
                                `${mathInline("18 = 10 + W")}`,
                                `${mathInline("W = 8")}`
                            ]
                        });
                        q5.parts.push(part("q5a", "5a", `(a) Write an equation for the perimeter using ${mathInline("W")}.`, `${mathInline("36 = 2(10 + W)")}`, {
                            working: [
                                `Use perimeter formula: ${mathInline("P = 2(L+W)")}`,
                                `Substitute ${mathInline("P=36, L=10")} to get ${mathInline("36=2(10+W)")} `
                            ]
                        }, 1));
                        q5.parts.push(part("q5b", "5b", `(b) Solve the equation to find ${mathInline("W")}.`, `${mathInline("W=8")}`, {
                            working: [
                                `${mathInline("36 = 2(10 + W)")}`,
                                `${mathInline("18 = 10 + W")}`,
                                `${mathInline("W = 8")}`
                            ]
                        }, 1));
                        qs.push(q5);

                        qs.push(q("q6", "6", `Evaluate ${mathInline("7^2 - 3^2")}.`, `40`, {
                            keepInMind: `Square means “multiply a number by itself”.`,
                            working: [
                                `${mathInline("7^2 = 49")}`,
                                `${mathInline("3^2 = 9")}`,
                                `${mathInline("49 - 9 = 40")}`
                            ]
                        }));
                        return qs;
                    })()
                }
            ]
        };

        // Build Standard paper (35 questions; Q26–Q35 long algebra; deep nesting; coverage stress test)
        const standardPaper = (function () {
            const qs = [];
            // Q1–Q10 short arithmetic
            for (let i = 1; i <= 10; i++) {
                const a = i * 7;
                const b = i + 8;
                qs.push(q(`q${i}`, String(i), `Calculate ${a} + ${b}.`, String(a + b), {
                    working: [
                        `${a} + ${b} = ${a + b}`
                    ]
                }));
            }

            // Q11–Q17 fractions/decimals
            qs.push(q("q11", "11", `Simplify ${mathInline("\\frac{18}{24}")}.`, `${mathInline("\\frac{3}{4}")}`, {
                working: [
                    `${mathInline("\\frac{18}{24} = \\frac{3}{4}")} (divide by 6)`
                ]
            }));
            qs.push(q("q12", "12", `Convert ${mathInline("\\frac{5}{8}")} to a decimal.`, `0.625`, {
                working: [
                    `${mathInline("5 \\div 8 = 0.625")}`
                ]
            }));
            qs.push(q("q13", "13", `A train travels 72 km in 3 hours. Find the average speed.`, `24 km/h`, {
                keepInMind: `Speed = distance ÷ time.`,
                working: [
                    `Speed = 72 ÷ 3 = 24 km/h`
                ]
            }));
            qs.push(q("q14", "14", `Find the value of ${mathInline("3x")} when ${mathInline("x=7")}.`, `21`, {
                working: [
                    `${mathInline("3x = 3\\times 7 = 21")}`
                ]
            }));
            qs.push(q("q15", "15", `A bag contains 4 green and 6 yellow marbles. What fraction are green?`, `${mathInline("\\frac{2}{5}")}`, {
                working: [
                    `Total marbles = 10`,
                    `Fraction green = ${mathInline("\\frac{4}{10} = \\frac{2}{5}")}`
                ]
            }));
            qs.push(q("q16", "16", `Round 19.684 to 1 decimal place.`, `19.7`, {
                working: [
                    `Look at the 2nd decimal digit (8), round up: 19.7`
                ]
            }));
            qs.push(q("q17", "17", `Solve ${mathInline("x + 9 = 17")}.`, `${mathInline("x=8")}`, {
                working: [
                    `${mathInline("x = 17 - 9 = 8")}`
                ]
            }));

            // Q18 deep nesting
            const q18 = q("q18", "18", `A recipe uses flour and sugar in the ratio 5:2. You have 250 g of flour. How much sugar is needed?`, `100 g`, {
                keepInMind: `In a ratio, scale both parts by the same factor.`,
                working: [
                    `Flour 5 parts = 250 g → 1 part = 50 g`,
                    `Sugar 2 parts = 2 × 50 g = 100 g`
                ]
            });
            q18.parts.push(part("q18a", "18a", `(a) Find the mass for 1 part.`, `50 g`, {
                working: [
                    `5 parts = 250 g`,
                    `1 part = 250 ÷ 5 = 50 g`
                ]
            }, 1));
            q18.parts.push(part("q18a_i", "18a(i)", `(i) Write the scaling calculation.`, `${mathInline("250 \\div 5 = 50")}`, {
                formulas: `Part value = total ÷ number of parts.`,
                working: [
                    `${mathInline("250 \\div 5 = 50")}`
                ]
            }, 2));
            q18.parts.push(part("q18a_ii", "18a(ii)", `(ii) Explain what “1 part” represents here.`, `50 g of flour per part`, {
                working: [
                    `It is the mass represented by each unit in the ratio.`
                ]
            }, 2));
            q18.parts.push(part("q18b", "18b", `(b) Calculate the sugar needed.`, `100 g`, {
                working: [
                    `Sugar is 2 parts`,
                    `2 × 50 g = 100 g`
                ],
                altWorking: [
                    `Scale factor: 250 g corresponds to 5 → multiply ratio by 50`,
                    `Sugar: 2 × 50 = 100 g`
                ]
            }, 1));
            qs.push(q18);

            // Q19–Q25 mixed
            qs.push(q("q19", "19", `A square has side 6 cm. Find its area.`, `36 cm²`, {
                formulas: `Area of a square = side × side.`,
                working: [
                    `${mathInline("6 \\times 6 = 36")}`
                ]
            }));
            const q20 = q("q20", "20", `On the coordinate grid, identify the point where ${mathInline("x=2")} and ${mathInline("y=3")}.`, `(2, 3)`, {
                working: [
                    `Move 2 along the x-axis and 3 up the y-axis → (2, 3)`
                ]
            });
            q20.details.diagram = "grid";
            qs.push(q20);

            qs.push(q("q21", "21", `Find ${mathInline("\\frac{3}{5}")} of 45.`, `27`, {
                working: [
                    `${mathInline("\\frac{3}{5} \\times 45 = 3 \\times 9 = 27")}`
                ],
                altWorking: [
                    `Find 1/5 of 45 = 9, then multiply by 3: 9 × 3 = 27`
                ]
            }));
            qs.push(q("q22", "22", `Solve ${mathInline("2x - 5 = 11")}.`, `${mathInline("x=8")}`, {
                working: [
                    `${mathInline("2x = 16")}`,
                    `${mathInline("x = 8")}`
                ]
            }));
            const q23 = q("q23", "23", `The diagram shows a triangle with labelled vertices. State the name of vertex at the top.`, `A`, {
                working: [
                    `The top vertex is labelled A.`
                ]
            });
            q23.details.diagram = "geometry";
            qs.push(q23);

            qs.push(q("q24", "24", `Write 2.4 as a mixed number.`, `${mathInline("2\\frac{2}{5}")}`, {
                working: [
                    `2.4 = 2 + 0.4`,
                    `${mathInline("0.4 = \\frac{4}{10} = \\frac{2}{5}")}`,
                    `So ${mathInline("2\\frac{2}{5}")}`
                ]
            }));
            qs.push(q("q25", "25", `A table shows values of ${mathInline("n")} and ${mathInline("2n+1")}. Find the value when ${mathInline("n=6")}.`, `13`, {
                working: [
                    `${mathInline("2n+1 = 2\\times 6 + 1 = 13")}`
                ],
                altWorking: [
                    `Double 6 gives 12, then add 1 gives 13.`
                ]
            }));

            // Q26–Q35 long algebra questions (collapsed by default)
            for (let i = 26; i <= 35; i++) {
                const id = `q${i}`;
                const label = String(i);
                const prompt = `Solve for ${mathInline("x")} : ${mathInline(`${i - 20}x + 7 = ${i + 10}`)}.`;
                const xVal = Math.round(((i + 10) - 7) / (i - 20));
                const details = {
                    formulas: `Isolate ${mathInline("x")} by reversing operations.`,
                    working: [
                        `${mathInline(`${i - 20}x + 7 = ${i + 10}`)}`,
                        `${mathInline(`${i - 20}x = ${(i + 10) - 7}`)}`,
                        `${mathInline(`x = \\frac{${(i + 10) - 7}}{${i - 20}}`)}`,
                        `${mathInline(`x = ${xVal}`)}`
                    ]
                };

                // Extremely long workings on selected long-working questions
                if (i === 30 || i === 33) {
                    details.working = [
                        `${mathInline(`${i - 20}x + 7 = ${i + 10}`)}`,
                        `${mathInline(`${i - 20}x = ${(i + 10) - 7}`)}`,
                        `${mathInline(`x = \\frac{${(i + 10) - 7}}{${i - 20}}`)}`,
                        mathBlock(`x = \\frac{${(i + 10) - 7}}{${i - 20}}`)
                    ].concat(longWorkLines(56, `x = \\frac{${(i + 10) - 7}}{${i - 20}}`));
                    details.altWorking = [
                        `Check by substitution:`,
                        `${mathInline(`${i - 20}(${xVal}) + 7 = ${(i - 20) * xVal + 7}`)}`,
                        `${mathInline(`${(i - 20) * xVal + 7} = ${i + 10}`)}`
                    ];
                } else if (i === 28 || i === 35) {
                    details.altWorking = [
                        `Alternative: move 7 first, then divide.`,
                        `${mathInline(`${i - 20}x = ${i + 10} - 7`)}`,
                        `${mathInline(`x = \\frac{${i + 10}-7}{${i - 20}}`)}`,
                    ];
                }

                // Coverage stress test: add "Keep in mind" to at least 3 (we already have some)
                if (i === 26 || i === 29 || i === 34) {
                    details.keepInMind = `Keep operations small and line-by-line to avoid mistakes.`;
                }

                qs.push(q(id, label, prompt, `${mathInline(`x=${xVal}`)}`, details));
            }

            // Ensure at least one array/table diagram appears in Standard
            const q36 = q("q36", "36", `(Bonus) Use the grid to organise values for ${mathInline("a, b, c, d")}. Identify the value in column c.`, `c`, {
                working: [
                    `Look at the labelled column “c”.`
                ]
            });
            q36.details.diagram = "array";
            // Note: Standard paper is defined as 35 in brief; keep bonus out of Standard list.
            // We won't add q36 to Standard to respect 35 questions.

            return {
                key: "standard",
                name: "Standard paper",
                hint: "35 questions · Q26–Q35 long algebra (workings collapsed by default)",
                workingsExpandedByDefault: false,
                sections: [{ label: null, questions: qs }]
            };
        })();

        // Standard (Workings Expanded) dataset (stress-test)
        const standardExpandedPaper = {
            ...standardPaper,
            key: "standard_expanded",
            name: "Standard (Workings Expanded)",
            hint: "Same as Standard · all workings expanded by default (stress-test only)",
            workingsExpandedByDefault: true
        };

        // Diagram-heavy paper (20 questions, 8 with diagrams)
        const diagramPaper = (function () {
            const qs = [];
            const diagSlots = new Set([2, 4, 6, 9, 11, 14, 16, 19]); // 8 questions
            const diagTypes = ["geometry", "ratio", "grid", "array"];
            for (let i = 1; i <= 20; i++) {
                const id = `dq${i}`;
                const label = String(i);
                const prompt = (i % 3 === 0)
                    ? `Calculate ${mathInline(`${i + 2}^2 - ${i - 1}^2`)}.`
                    : `Find the value of ${mathInline(`${i}x`)} when ${mathInline("x=5")}.`;
                const answer = (i % 3 === 0) ? String((i + 2) * (i + 2) - (i - 1) * (i - 1)) : String(i * 5);

                const details = {
                    working: (i % 3 === 0)
                        ? [
                            `${mathInline(`${i + 2}^2 = ${(i + 2) * (i + 2)}`)}`,
                            `${mathInline(`${i - 1}^2 = ${(i - 1) * (i - 1)}`)}`,
                            `${mathInline(`${(i + 2) * (i + 2)} - ${(i - 1) * (i - 1)} = ${(i + 2) * (i + 2) - (i - 1) * (i - 1)}`)}`
                        ]
                        : [
                            `${mathInline(`${i}x = ${i}\\times 5 = ${i * 5}`)}`
                        ]
                };

                if (diagSlots.has(i)) {
                    details.diagram = diagTypes[(i * 7) % diagTypes.length];
                    if (i === 6 || i === 14) details.formulas = `Use the diagram labels directly (no extra interpretation).`;
                    if (i === 11 || i === 19) details.keepInMind = `Keep the diagram inside the question block on small screens.`;
                }
                if (i === 9 || i === 16) details.altWorking = [
                    `Alternative: rewrite then substitute.`,
                    `${mathInline(`${i}x = x + x + \\dots`)} (repeated ${i} times)`
                ];

                qs.push(q(id, label, prompt, answer, details));
            }
            return {
                key: "diagram",
                name: "Diagram-heavy paper",
                hint: "20 questions · 8 questions include SVG diagrams",
                workingsExpandedByDefault: false,
                sections: [{ label: null, questions: qs }]
            };
        })();

        // Sectioned paper (A/B/C with separators; long solutions in C)
        const sectionedPaper = (function () {
            function makeSectionQuestions(prefix, count, startNum, opts) {
                const qs = [];
                for (let i = 0; i < count; i++) {
                    const n = startNum + i;
                    const id = `${prefix}${n}`;
                    const label = String(n);
                    const isLong = opts && opts.long && (i % 2 === 0);
                    const prompt = isLong
                        ? `A word problem leads to the equation ${mathInline(`${(n % 9) + 2}x + ${(n % 7) + 3} = ${(n % 11) + 30}`)}. Solve for ${mathInline("x")}.`
                        : `Compute ${n} × ${(n % 8) + 3}.`;
                    const ans = isLong
                        ? `${mathInline("x = \\dots")}`
                        : String(n * ((n % 8) + 3));

                    const details = {};
                    // Mix in frequent Solution Details variants (coverage stress test across paper)
                    if (isLong) {
                        details.keepInMind = `Show each rearrangement on its own line.`;
                        details.formulas = `Rearrange to isolate ${mathInline("x")}.`;
                        details.working = [
                            `${mathInline(`${(n % 9) + 2}x + ${(n % 7) + 3} = ${(n % 11) + 30}`)}`,
                            `${mathInline(`${(n % 9) + 2}x = ${(n % 11) + 30} - ${(n % 7) + 3}`)}`,
                            `${mathInline(`x = \\frac{${(n % 11) + 30}-${(n % 7) + 3}}{${(n % 9) + 2}}`)}`,
                            mathBlock(`x = \\frac{${(n % 11) + 30}-${(n % 7) + 3}}{${(n % 9) + 2}}`)
                        ];
                        if (n % 3 === 0) {
                            details.altWorking = [
                                `Alternative: check by substitution.`,
                                `${mathInline("LHS = RHS")}`
                            ];
                        }
                    } else {
                        details.working = [
                            `${n} × ${((n % 8) + 3)} = ${n * ((n % 8) + 3)}`
                        ];
                        if (n % 10 === 0) details.keepInMind = `Use partitioning or doubling if needed.`;
                    }

                    qs.push(q(id, label, prompt, ans, details));
                }
                return qs;
            }

            const sectionA = makeSectionQuestions("sa", 35, 1, { long: false });
            const sectionB = makeSectionQuestions("sb", 8, 1, { long: true });
            const sectionC = makeSectionQuestions("sc", 6, 1, { long: true });

            // Deep nesting inside Section C (one question with subparts)
            const nestBase = q("scN1", "1", `Section C multi-part: simplify and solve using ${mathInline("x")}.`, `${mathInline("x=\\dots")}`, {
                keepInMind: `Treat each part as a continuation of the same question.`,
                working: [
                    `Workings are revealed together under the single toggle.`
                ]
            });
            nestBase.parts.push(part("scN1a", "1a", `(a) Simplify ${mathInline("\\frac{12}{18}")}.`, `${mathInline("\\frac{2}{3}")}`, {
                working: [
                    `${mathInline("\\frac{12}{18} = \\frac{2}{3}")} (divide by 6)`
                ]
            }, 1));
            nestBase.parts.push(part("scN1a_i", "1a(i)", `(i) Identify the common factor used.`, `6`, {
                working: [`Common factor is 6.`]
            }, 2));
            nestBase.parts.push(part("scN1b", "1b", `(b) Solve ${mathInline("3x + 2 = 14")}.`, `${mathInline("x=4")}`, {
                formulas: `Isolate ${mathInline("x")}.`,
                working: [
                    `${mathInline("3x = 12")}`,
                    `${mathInline("x = 4")}`
                ],
                altWorking: [
                    `Check: ${mathInline("3(4)+2=14")}`
                ]
            }, 1));
            // Replace first item in C with nested question
            sectionC[0] = nestBase;

            return {
                key: "sectioned",
                name: "Sectioned paper",
                hint: "Section A/B/C · section labels appear as non-clickable separators",
                workingsExpandedByDefault: false,
                sections: [
                    { label: "Section A", questions: sectionA },
                    { label: "Section B", questions: sectionB },
                    { label: "Section C", questions: sectionC }
                ]
            };
        })();

        const papers = [
            shortPaper,
            standardPaper,
            diagramPaper,
            sectionedPaper,
            standardExpandedPaper
        ];

        // ---------- Rendering ----------
        const $ = (sel) => document.querySelector(sel);

        const paperSelect = $("#paperSelect");
        const navList = $("#navList");
        const drawerNavList = $("#drawerNavList");
        const paperName = $("#paperName");
        const paperHint = $("#paperHint");
        const paperContent = $("#paperContent");

        const navToggle = $("#navToggle");
        const drawer = $("#drawer");
        const drawerOverlay = $("#drawerOverlay");
        const drawerClose = $("#drawerClose");

        function escapeHtml(s) {
            return String(s)
                .replaceAll("&", "&amp;")
                .replaceAll("<", "&lt;")
                .replaceAll(">", "&gt;")
                .replaceAll('"', "&quot;")
                .replaceAll("'", "&#039;");
        }

        function flattenNavItems(sections) {
            const items = [];
            for (const sec of sections) {
                if (sec.label) {
                    items.push({ type: "sep", label: sec.label });
                }
                for (const qu of sec.questions) {
                    items.push({ type: "q", label: qu.label, href: `#${qu.id}` });
                    if (qu.parts && qu.parts.length) {
                        for (const p of qu.parts) {
                            items.push({ type: "q", label: p.label, href: `#${p.id}` });
                        }
                    }
                }
            }
            return items;
        }

        function renderNav(sections) {
            const items = flattenNavItems(sections);

            function buildList(targetUl) {
                targetUl.innerHTML = "";
                for (const it of items) {
                    if (it.type === "sep") {
                        const li = document.createElement("li");
                        li.className = "navSep";
                        li.textContent = it.label;
                        targetUl.appendChild(li);
                        continue;
                    }
                    const li = document.createElement("li");
                    li.className = "navItem";
                    const a = document.createElement("a");
                    a.href = it.href;
                    a.textContent = it.label;
                    a.addEventListener("click", () => closeDrawer());
                    li.appendChild(a);
                    targetUl.appendChild(li);
                }
            }

            buildList(navList);
            buildList(drawerNavList);
        }

        function renderDetails(details, defaultExpanded) {
            const blocks = [];

            if (details.keepInMind) {
                blocks.push(`
          <div class="detailBlock">
            <div class="detailLabel">Keep in mind</div>
            <div class="detailBody">${escapeHtml(details.keepInMind)}</div>
          </div>
        `);
            }

            if (details.formulas) {
                blocks.push(`
          <div class="detailBlock">
            <div class="detailLabel">Formulas used</div>
            <div class="detailBody">${escapeHtml(details.formulas)}</div>
          </div>
        `);
            }

            if (details.diagram) {
                blocks.push(`
          <div class="detailBlock">
            <div class="detailLabel">Diagram</div>
            <div class="detailBody">${diagramByType(details.diagram)}</div>
          </div>
        `);
            }

            if (details.working && details.working.length) {
                blocks.push(`
          <div class="detailBlock">
            <div class="detailLabel">Working</div>
            <div class="detailBody">
              <div class="workLines">
                ${makeWorkLines(details.working.map(escapeHtml).map(unescapeHtmlMath))}
              </div>
            </div>
          </div>
        `);
            }

            // Alternative working must never appear without primary working
            if (details.altWorking && details.altWorking.length && details.working && details.working.length) {
                blocks.push(`
          <div class="detailBlock">
            <div class="detailLabel">Alternative working</div>
            <div class="detailBody">
              <div class="workLines">
                ${makeWorkLines(details.altWorking.map(escapeHtml).map(unescapeHtmlMath))}
              </div>
            </div>
          </div>
        `);
            }

            const hasAny = blocks.length > 0;

            // disclosure control always visible (collapsed or expanded)
            const initialExpanded = !!defaultExpanded;

            const detailsId = `details-${details._ownerId}`;

            return `
        <button class="disclose" type="button" data-details="${detailsId}" aria-expanded="${initialExpanded ? "true" : "false"}">
          <span class="chev" aria-hidden="true">${initialExpanded ? "▾" : "▸"}</span>
          <span class="discloseText">${initialExpanded ? "Hide working" : "Show working"}</span>
        </button>
        ${hasAny ? `
          <div id="${detailsId}" class="details" ${initialExpanded ? "" : "hidden"}>
            ${blocks.join("")}
          </div>
        ` : `
          <div id="${detailsId}" class="details" hidden>
            <div class="detailBlock">
              <div class="detailLabel">Working</div>
              <div class="detailBody">No additional details provided.</div>
            </div>
          </div>
        `}
      `;
        }

        // We generate math placeholders as HTML fragments earlier; this helper restores them after escaping.
        // We ONLY unescape patterns we generate (safe and deterministic).
        function unescapeHtmlMath(escapedLine) {
            return escapedLine
                .replaceAll("&lt;span class=&quot;math-inline&quot;&gt;", "<span class=\"math-inline\">")
                .replaceAll("&lt;/span&gt;", "</span>")
                .replaceAll("&lt;span class=&quot;math-block&quot;&gt;", "<span class=\"math-block\">")
                .replaceAll("&amp;", "&"); // allow \rightarrow etc to show as typed
        }

        function renderQuestionNode(node, defaultExpanded, depth) {
            const isPart = !!node.isPart;
            const nestClass = depth ? `nest-${Math.min(depth, 3)}` : "";
            const wrapClass = isPart ? `q part ${nestClass}` : `q ${nestClass}`;

            // attach owner id for details toggle
            const details = node.details || {};
            details._ownerId = node.id;

            const partsHtml = (node.parts && node.parts.length)
                ? node.parts.map(p => renderQuestionNode(p, defaultExpanded, (p.depth || (depth ? depth + 1 : 1)))).join("")
                : "";

            return `
        <section class="${wrapClass}" id="${node.id}">
          <div class="qHead">
            <div class="qNum">${escapeHtml(node.label)}</div>
            <div class="qPrompt">${node.promptHtml}</div>
          </div>

          <div class="qBody">
            <div class="answerRow">
              <div class="answerLabel">Answer</div>
              <div class="answerValue">${node.answerHtml}</div>
            </div>

            ${renderDetails(details, defaultExpanded)}

            ${partsHtml}
          </div>
        </section>
      `;
        }

        function renderPaper(paperKey) {
            const paper = papers.find(p => p.key === paperKey) || papers[0];

            paperName.textContent = paper.name;
            paperHint.textContent = paper.hint;

            renderNav(paper.sections);

            // render content in single continuous flow (no nested scroll regions)
            const html = [];
            for (const sec of paper.sections) {
                // Section labels are in nav only; keep content as continuous questions without extra UI sections.
                for (const qu of sec.questions) {
                    html.push(renderQuestionNode(qu, paper.workingsExpandedByDefault, 0));
                }
            }
            paperContent.innerHTML = html.join("");

            // wire disclosure controls
            paperContent.querySelectorAll(".disclose").forEach(btn => {
                btn.addEventListener("click", () => {
                    const id = btn.getAttribute("data-details");
                    const panel = document.getElementById(id);
                    const expanded = btn.getAttribute("aria-expanded") === "true";
                    const next = !expanded;

                    btn.setAttribute("aria-expanded", next ? "true" : "false");
                    const chev = btn.querySelector(".chev");
                    const txt = btn.querySelector(".discloseText");
                    if (chev) chev.textContent = next ? "▾" : "▸";
                    if (txt) txt.textContent = next ? "Hide working" : "Show working";

                    if (panel) {
                        if (next) panel.removeAttribute("hidden");
                        else panel.setAttribute("hidden", "hidden");
                    }
                });
            });
        }

        // ---------- Drawer ----------
        function openDrawer() {
            drawer.style.display = "block";
            drawerOverlay.style.display = "block";
            drawer.setAttribute("aria-hidden", "false");
            drawerOverlay.setAttribute("aria-hidden", "false");
            navToggle.setAttribute("aria-expanded", "true");

            // focus first interactive item
            const firstLink = drawer.querySelector("a");
            (firstLink || drawerClose).focus();
        }
        function closeDrawer() {
            drawer.style.display = "none";
            drawerOverlay.style.display = "none";
            drawer.setAttribute("aria-hidden", "true");
            drawerOverlay.setAttribute("aria-hidden", "true");
            navToggle.setAttribute("aria-expanded", "false");
        }

        navToggle.addEventListener("click", () => {
            const open = drawer.style.display === "block";
            if (open) closeDrawer();
            else openDrawer();
        });
        drawerOverlay.addEventListener("click", closeDrawer);
        drawerClose.addEventListener("click", closeDrawer);
        document.addEventListener("keydown", (e) => {
            if (e.key === "Escape" && drawer.style.display === "block") {
                closeDrawer();
                navToggle.focus();
            }
        });

        // ---------- Init ----------
        function init() {
            paperSelect.innerHTML = papers.map(p => `<option value="${p.key}">${escapeHtml(p.name)}</option>`).join("");
            paperSelect.value = "standard";

            paperSelect.addEventListener("change", () => {
                // Switching papers rebuilds navigation and uses dataset defaults (no cross-paper state)
                renderPaper(paperSelect.value);
            });

            renderPaper(paperSelect.value);
        }

        init();
    </script>
</body>

</html>