<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>RTQ – Maths Paper Solution Viewer (Stress Test Harness)</title>

    <!-- KaTeX (CDN) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css"
        integrity="sha384-nB0miv6/jRmo5nX3b0cWZrLJH2wGm0x0H2wH5qvU3pHfQ0wJ7gV4r0p6m6pG2m1b" crossorigin="anonymous">

    <style>
        :root {
            --bg: #ffffff;
            --ink: #111111;
            --muted: #5a5a5a;
            --quiet: #7a7a7a;
            --hairline: rgba(0, 0, 0, 0.10);
            --frame-max: 1160px;
            --gutter: 16px;
            --header-h: 64px;

            --fs-0: 12px;
            --fs-1: 14px;
            --fs-2: 16px;
            --fs-3: 18px;

            --lh-quiet: 1.35;
            --lh-body: 1.55;
            --lh-strong: 1.65;

            --q-gap: 28px;
            --qa-gap: 10px;
            --aw-gap: 14px;

            --indent-1: 18px;
            --indent-2: 34px;
            --indent-3: 50px;

            --touch: 44px;
            --radius: 10px;
            /* used only for overlay, not content containers */
            --shadow: 0 12px 36px rgba(0, 0, 0, 0.15);
        }

        * {
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
        }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--ink);
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
            font-size: var(--fs-2);
            line-height: var(--lh-body);
            overflow-x: hidden;
            /* never allow page-level horizontal scrolling */
        }

        /* Header / Top controls (stable location) */
        header {
            position: sticky;
            top: 0;
            z-index: 20;
            background: var(--bg);
            border-bottom: 1px solid var(--hairline);
        }

        .frame {
            max-width: var(--frame-max);
            margin: 0 auto;
            padding: 0 var(--gutter);
        }

        .topbar {
            height: var(--header-h);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .brand {
            font-size: var(--fs-1);
            color: var(--muted);
            white-space: nowrap;
        }

        .controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: auto;
            flex-wrap: wrap;
        }

        label {
            font-size: var(--fs-1);
            color: var(--muted);
        }

        select {
            height: 38px;
            font-size: var(--fs-2);
            padding: 6px 10px;
            border: 1px solid var(--hairline);
            background: #fff;
            color: var(--ink);
            border-radius: 8px;
            outline: none;
            min-width: 240px;
        }

        select:focus {
            outline: 2px solid rgba(0, 0, 0, 0.25);
            outline-offset: 2px;
        }

        .jumpBtn {
            height: 38px;
            padding: 0 12px;
            border: 1px solid var(--hairline);
            background: #fff;
            border-radius: 8px;
            color: var(--ink);
            font-size: var(--fs-2);
            cursor: pointer;
        }

        .jumpBtn:focus {
            outline: 2px solid rgba(0, 0, 0, 0.25);
            outline-offset: 2px;
        }

        /* Main layout frame (nav + content sibling columns) */
        .layout {
            display: grid;
            grid-template-columns: 168px 1fr;
            gap: 24px;
            padding: 20px 0 60px;
            align-items: start;
        }

        /* Navigation rail */
        nav {
            position: sticky;
            top: calc(var(--header-h) + 14px);
            align-self: start;
        }

        .navWrap {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .navTitle {
            font-size: var(--fs-0);
            letter-spacing: 0.06em;
            text-transform: uppercase;
            color: var(--quiet);
        }

        .navList {
            max-height: calc(100vh - var(--header-h) - 54px);
            overflow-y: auto;
            padding: 4px 0;
            border-left: 1px solid var(--hairline);
            /* subtle rail marker; not a panel/card */
            padding-left: 10px;

            /* hide scrollbar but keep scroll functional */
            scrollbar-width: none;
            /* Firefox */
            -ms-overflow-style: none;
            /* legacy */
        }

        .navList::-webkit-scrollbar {
            display: none;
        }

        /* WebKit/Blink */

        .navList:focus {
            outline: 2px solid rgba(0, 0, 0, 0.18);
            outline-offset: 2px;
            border-radius: 8px;
        }

        .navItem,
        .navSection {
            display: block;
            font-size: var(--fs-1);
            color: var(--muted);
            text-decoration: none;
            padding: 8px 8px;
            border-radius: 8px;
            line-height: 1.2;
        }

        .navItem:hover {
            background: rgba(0, 0, 0, 0.04);
            color: var(--ink);
        }

        .navItem[aria-current="true"] {
            font-weight: 700;
            color: var(--ink);
            background: rgba(0, 0, 0, 0.06);
        }

        .navSection {
            padding-top: 14px;
            padding-bottom: 6px;
            font-weight: 700;
            color: var(--quiet);
            cursor: default;
            user-select: none;
        }

        /* Content column */
        main {
            min-width: 0;
            /* allow KaTeX blocks to overflow within their own containers */
        }

        .paperMeta {
            font-size: var(--fs-1);
            color: var(--muted);
            margin: 0 0 18px;
        }

        /* Question blocks (separation via spacing, not boxes) */
        .q {
            margin: 0 0 var(--q-gap);
        }

        .q:last-child {
            margin-bottom: 0;
        }

        .qInner {
            display: grid;
            grid-template-columns: 52px 1fr;
            gap: 14px;
            align-items: start;
        }

        .qid {
            font-size: var(--fs-2);
            color: var(--muted);
            line-height: var(--lh-strong);
            text-align: right;
            padding-top: 2px;
            user-select: none;
        }

        .qPrompt {
            font-size: var(--fs-3);
            line-height: var(--lh-strong);
            color: var(--ink);
        }

        .qBody {
            margin-top: 8px;
            color: var(--ink);
            font-size: var(--fs-2);
            line-height: var(--lh-body);
        }

        .answerRow {
            display: flex;
            gap: 10px;
            align-items: baseline;
            margin-top: var(--qa-gap);
        }

        .answerLabel {
            font-weight: 700;
            font-size: var(--fs-1);
            color: var(--muted);
            flex: 0 0 auto;
        }

        .answerValue {
            font-size: var(--fs-2);
            color: var(--ink);
        }

        .disclosureRow {
            margin-top: var(--aw-gap);
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .toggle {
            min-height: var(--touch);
            padding: 8px 12px;
            border: 1px solid var(--hairline);
            background: #fff;
            color: var(--ink);
            font-size: var(--fs-2);
            border-radius: 10px;
            cursor: pointer;
            text-align: left;
        }

        .toggle:hover {
            background: rgba(0, 0, 0, 0.03);
        }

        .toggle:focus {
            outline: 2px solid rgba(0, 0, 0, 0.25);
            outline-offset: 2px;
        }

        .preview {
            font-size: var(--fs-1);
            color: var(--quiet);
            max-width: 60ch;
            line-height: var(--lh-quiet);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .details {
            margin-top: 10px;
            padding-left: 0;
            /* details align under question text naturally */
        }

        .details[hidden] {
            display: none !important;
        }

        .detailsBlock {
            margin-top: 12px;
        }

        .detailsLabel {
            font-weight: 700;
            font-size: var(--fs-1);
            color: var(--muted);
            margin-bottom: 6px;
        }

        .detailsText {
            font-size: var(--fs-2);
            color: var(--ink);
            line-height: var(--lh-body);
        }

        .detailsText.quiet {
            color: var(--muted);
        }

        /* Math overflow safety net */
        .mathInline {
            white-space: nowrap;
        }

        .mathBlock {
            overflow-x: auto;
            overflow-y: hidden;
            padding: 6px 0;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .mathBlock::-webkit-scrollbar {
            display: none;
        }

        .mathBlock:focus {
            outline: 2px solid rgba(0, 0, 0, 0.18);
            outline-offset: 2px;
            border-radius: 8px;
        }

        /* Diagram placeholders (inline SVG, responsive) */
        .diagram {
            margin-top: 10px;
            max-width: 520px;
        }

        .diagram svg {
            width: 100%;
            height: auto;
            display: block;
        }

        .diagramCaption {
            margin-top: 6px;
            font-size: var(--fs-1);
            color: var(--quiet);
            line-height: var(--lh-quiet);
        }

        /* Nesting indentation (no borders) */
        .depth-0 .qInner {}

        .depth-1 {
            margin-left: var(--indent-1);
        }

        .depth-2 {
            margin-left: var(--indent-2);
        }

        .depth-3 {
            margin-left: var(--indent-3);
        }

        /* Mobile / Tablet */
        @media (max-width: 920px) {
            :root {
                --frame-max: 980px;
            }

            .layout {
                grid-template-columns: 1fr;
                gap: 14px;
            }

            nav {
                display: none;
            }

            /* replaced by drawer */
            select {
                min-width: 220px;
            }

            .jumpBtn {
                display: inline-flex;
            }

            .qInner {
                grid-template-columns: 40px 1fr;
                gap: 12px;
            }

            .qid {
                font-size: var(--fs-2);
            }

            .qPrompt {
                font-size: 17px;
            }
        }

        @media (min-width: 921px) {
            .jumpBtn {
                display: none;
            }

            /* desktop uses persistent rail */
        }

        @media (max-width: 520px) {
            :root {
                --gutter: 14px;
            }

            select {
                min-width: 180px;
            }

            .qInner {
                grid-template-columns: 34px 1fr;
                gap: 10px;
            }

            .depth-1 {
                margin-left: 12px;
            }

            .depth-2 {
                margin-left: 22px;
            }

            .depth-3 {
                margin-left: 32px;
            }

            .toggle {
                width: 100%;
            }
        }

        /* Drawer / Overlay nav (mobile/tablet) */
        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.30);
            z-index: 40;
            display: none;
        }

        .overlay[aria-hidden="false"] {
            display: block;
        }

        .drawer {
            position: fixed;
            top: 0;
            right: 0;
            height: 100%;
            width: min(360px, 92vw);
            background: #fff;
            box-shadow: var(--shadow);
            z-index: 41;
            display: none;
            padding: 14px 14px 18px;
        }

        .drawer[aria-hidden="false"] {
            display: block;
        }

        .drawerHead {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 6px 0 10px;
            border-bottom: 1px solid var(--hairline);
            margin-bottom: 10px;
        }

        .drawerTitle {
            font-size: var(--fs-2);
            font-weight: 700;
            color: var(--ink);
        }

        .drawerClose {
            height: 38px;
            padding: 0 12px;
            border: 1px solid var(--hairline);
            background: #fff;
            border-radius: 8px;
            cursor: pointer;
            font-size: var(--fs-2);
        }

        .drawerClose:focus {
            outline: 2px solid rgba(0, 0, 0, 0.25);
            outline-offset: 2px;
        }

        .drawerNav {
            height: calc(100vh - 80px);
            overflow-y: auto;
            padding-right: 2px;

            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .drawerNav::-webkit-scrollbar {
            display: none;
        }

        .drawerNav:focus {
            outline: 2px solid rgba(0, 0, 0, 0.18);
            outline-offset: 2px;
            border-radius: 8px;
        }

        /* Reduce any accidental motion */
        * {
            scroll-behavior: auto !important;
            transition: none !important;
        }
    </style>
</head>

<body>
    <header>
        <div class="frame">
            <div class="topbar">
                <div class="brand" aria-hidden="true">RTQ – Paper Viewer</div>

                <div class="controls">
                    <label for="paperSelect">Paper</label>
                    <select id="paperSelect">
                        <option value="short">Short paper</option>
                        <option value="standard">Standard paper</option>
                        <option value="standardExpanded">Standard (Workings Expanded)</option>
                        <option value="diagram">Diagram-heavy paper</option>
                        <option value="sectioned">Sectioned paper</option>
                    </select>

                    <button id="jumpBtn" class="jumpBtn" type="button" aria-haspopup="dialog" aria-controls="drawer"
                        aria-expanded="false">
                        Jump to
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="frame">
        <div class="layout">
            <!-- Desktop navigation rail -->
            <nav aria-label="Question navigation">
                <div class="navWrap">
                    <div class="navTitle">Jump</div>
                    <div id="navList" class="navList" tabindex="0" aria-label="Question list"></div>
                </div>
            </nav>

            <!-- Paper content -->
            <main id="paper" aria-label="Paper content">
                <!-- injected -->
            </main>
        </div>
    </div>

    <!-- Mobile/Tablet navigation drawer -->
    <div id="overlay" class="overlay" aria-hidden="true"></div>

    <aside id="drawer" class="drawer" role="dialog" aria-modal="true" aria-hidden="true" aria-label="Jump to question">
        <div class="drawerHead">
            <div class="drawerTitle">Jump to</div>
            <button id="drawerClose" class="drawerClose" type="button">Close</button>
        </div>
        <div id="drawerNav" class="drawerNav" tabindex="0" aria-label="Question list"></div>
    </aside>

    <!-- KaTeX -->
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"
        integrity="sha384-9xVg9YxQfS5gD3rYFZl2V+KQbTtqUeA8c3V0VtH7b2zPq5bE2mVb7a9r2b1zqW1o"
        crossorigin="anonymous"></script>

    <script>
        // --------------------------
        // Utilities
        // --------------------------
        function el(tag, attrs = {}, children = []) {
            const node = document.createElement(tag);
            for (const [k, v] of Object.entries(attrs)) {
                if (k === "class") node.className = v;
                else if (k === "html") node.innerHTML = v;
                else if (k.startsWith("on") && typeof v === "function") node.addEventListener(k.slice(2), v);
                else if (v === true) node.setAttribute(k, "");
                else if (v === false || v == null) { }
                else node.setAttribute(k, String(v));
            }
            for (const child of children) {
                if (child == null) continue;
                node.appendChild(typeof child === "string" ? document.createTextNode(child) : child);
            }
            return node;
        }

        function safeId(label) {
            // turn "18(a)(i)" -> "q-18-a-i"
            return "q-" + label
                .replace(/\s+/g, "")
                .replace(/[()]/g, "-")
                .replace(/-+/g, "-")
                .replace(/[^a-zA-Z0-9\-]/g, "-")
                .replace(/-$/, "")
                .toLowerCase();
        }

        function setCurrentNav(targetId) {
            const all = document.querySelectorAll('[data-nav-id]');
            for (const a of all) a.setAttribute('aria-current', 'false');
            const active = document.querySelectorAll('[data-nav-id="' + targetId + '"]');
            for (const a of active) a.setAttribute('aria-current', 'true');
        }

        function renderMathIn(root) {
            // Render elements that declare data-math.
            // If KaTeX isn't available, the fallback text remains visible.
            if (!window.katex || !window.katex.render) return;

            const nodes = root.querySelectorAll('[data-math]');
            for (const n of nodes) {
                const expr = n.getAttribute('data-math') || "";
                const display = n.getAttribute('data-display') === "true";
                try {
                    window.katex.render(expr, n, { displayMode: display, throwOnError: false, strict: "ignore" });
                    n.removeAttribute('data-math'); // prevent double-render
                } catch (e) {
                    // Graceful fallback: keep existing text content
                }
            }
        }

        function makeMathInline(expr) {
            return el('span', { class: 'mathInline', 'data-math': expr }, [expr]);
        }
        function makeMathBlock(expr) {
            // focusable so keyboard users can scroll horizontally when needed
            return el('div', { class: 'mathBlock', tabindex: "0", 'data-math': expr, 'data-display': "true" }, [expr]);
        }

        // --------------------------
        // Diagram SVGs (reused types)
        // --------------------------
        function svgWrap(inner) {
            return `
        <svg viewBox="0 0 240 160" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
          <rect x="1" y="1" width="238" height="158" fill="none" stroke="rgba(0,0,0,0.18)" />
          ${inner}
        </svg>
      `;
        }

        function diagramGeometry() {
            const inner = `
        <circle cx="160" cy="78" r="38" fill="none" stroke="rgba(0,0,0,0.35)" stroke-width="2"/>
        <polygon points="40,130 110,30 180,130" fill="none" stroke="rgba(0,0,0,0.35)" stroke-width="2"/>
        <text x="105" y="25" font-size="12" fill="rgba(0,0,0,0.55)">A</text>
        <text x="30" y="142" font-size="12" fill="rgba(0,0,0,0.55)">B</text>
        <text x="184" y="142" font-size="12" fill="rgba(0,0,0,0.55)">C</text>
        <text x="150" y="80" font-size="12" fill="rgba(0,0,0,0.55)">r</text>
      `;
            return svgWrap(inner);
        }

        function diagramBars() {
            const inner = `
        <rect x="26" y="50" width="170" height="22" fill="none" stroke="rgba(0,0,0,0.35)" stroke-width="2"/>
        <line x1="86" y1="50" x2="86" y2="72" stroke="rgba(0,0,0,0.35)" stroke-width="2"/>
        <line x1="146" y1="50" x2="146" y2="72" stroke="rgba(0,0,0,0.35)" stroke-width="2"/>
        <text x="44" y="92" font-size="12" fill="rgba(0,0,0,0.55)">2 parts</text>
        <text x="104" y="92" font-size="12" fill="rgba(0,0,0,0.55)">2 parts</text>
        <text x="162" y="92" font-size="12" fill="rgba(0,0,0,0.55)">2 parts</text>
      `;
            return svgWrap(inner);
        }

        function diagramGridLine() {
            const inner = `
        <g stroke="rgba(0,0,0,0.18)" stroke-width="1">
          ${Array.from({ length: 9 }).map((_, i) => `<line x1="${30 + i * 20}" y1="20" x2="${30 + i * 20}" y2="140"/>`).join("")}
          ${Array.from({ length: 7 }).map((_, i) => `<line x1="30" y1="${20 + i * 20}" x2="210" y2="${20 + i * 20}"/>`).join("")}
        </g>
        <g stroke="rgba(0,0,0,0.45)" stroke-width="2">
          <line x1="30" y1="120" x2="210" y2="60"/>
        </g>
        <circle cx="70" cy="106" r="4" fill="rgba(0,0,0,0.55)"/>
        <circle cx="170" cy="74" r="4" fill="rgba(0,0,0,0.55)"/>
        <text x="60" y="102" font-size="12" fill="rgba(0,0,0,0.55)">(2,1)</text>
        <text x="156" y="70" font-size="12" fill="rgba(0,0,0,0.55)">(7,4)</text>
      `;
            return svgWrap(inner);
        }

        function diagramTable() {
            const inner = `
        <g fill="none" stroke="rgba(0,0,0,0.35)" stroke-width="2">
          <rect x="44" y="32" width="152" height="96"/>
          <line x1="44" y1="64" x2="196" y2="64"/>
          <line x1="44" y1="96" x2="196" y2="96"/>
          <line x1="95" y1="32" x2="95" y2="128"/>
          <line x1="146" y1="32" x2="146" y2="128"/>
        </g>
        <g font-size="12" fill="rgba(0,0,0,0.55)">
          <text x="58" y="54">A</text>
          <text x="110" y="54">B</text>
          <text x="160" y="54">C</text>
          <text x="60" y="86">1</text>
          <text x="110" y="86">4</text>
          <text x="160" y="86">?</text>
          <text x="60" y="118">2</text>
          <text x="110" y="118">8</text>
          <text x="160" y="118">?</text>
        </g>
      `;
            return svgWrap(inner);
        }

        const DIAGRAMS = {
            geometry: diagramGeometry,
            bars: diagramBars,
            grid: diagramGridLine,
            table: diagramTable
        };

        function makeDiagram(kind, caption) {
            const svg = DIAGRAMS[kind] ? DIAGRAMS[kind]() : DIAGRAMS.geometry();
            return el('div', { class: 'diagram' }, [
                el('div', { html: svg }),
                caption ? el('div', { class: 'diagramCaption' }, [caption]) : null
            ]);
        }

        // --------------------------
        // Data generators
        // --------------------------
        function longWorkingLines(seed) {
            // 50–60 lines of maths (display lines) for stress testing.
            // Keep answers short; workings long.
            const lines = [];
            for (let i = 1; i <= 60; i++) {
                const a = (seed % 7) + 2;
                const b = (seed % 5) + 3;
                const t = i + seed;
                lines.push(String.raw`\text{Step ${i}:}\quad ${a}x + ${b} = ${t}\;\Rightarrow\; x = \frac{${t}-${b}}{${a}}`);
            }
            // Add a couple of wider expressions to force overflow in block containers (especially mobile)
            lines.splice(8, 0, String.raw`\frac{(x^2 + 2x + 1)(x^2 - 2x + 1)(x^4 + 1)(x^8 + 1)}{x^{16} - 1} = \frac{x^8 + 1}{x^8 - 1}`);
            lines.splice(33, 0, String.raw`\left(\frac{123456789}{99999}\right)^2 + \left(\frac{987654321}{11111}\right)^2 = \frac{15241578750190521}{9999800001} + \frac{975461057789971041}{123454321}`);
            return lines;
        }

        function makeDetails(opts) {
            // opts: { keepInMind?, formulas?, workingLines[], altLines[] }
            const blocks = [];

            if (opts.keepInMind) {
                blocks.push({
                    label: "Keep in mind",
                    kind: "text",
                    text: opts.keepInMind
                });
            }
            if (opts.formulas) {
                blocks.push({
                    label: "Formulas used",
                    kind: "text",
                    text: opts.formulas
                });
            }

            blocks.push({
                label: "Working",
                kind: "mathLines",
                lines: opts.workingLines || []
            });

            if (opts.altLines && opts.altLines.length) {
                blocks.push({
                    label: "Alternative working",
                    kind: "mathLines",
                    lines: opts.altLines
                });
            }

            return blocks;
        }

        // Build a question unit: Question → Answer → Solution Details (toggle controls entire details)
        function makeQuestion(q) {
            const qId = safeId(q.label);

            const qWrap = el('section', { class: `q depth-${q.depth || 0}`, id: qId, 'data-qid': qId }, []);
            const qInner = el('div', { class: 'qInner' }, []);

            const qid = el('div', { class: 'qid' }, [q.label]);
            const right = el('div', {}, []);

            const prompt = el('div', { class: 'qPrompt' }, []);
            // promptSegments: array of strings or {inlineMath} or {blockMath}
            if (q.promptSegments) {
                for (const seg of q.promptSegments) {
                    if (typeof seg === "string") {
                        prompt.appendChild(document.createTextNode(seg));
                    } else if (seg && seg.inlineMath) {
                        prompt.appendChild(makeMathInline(seg.inlineMath));
                    } else if (seg && seg.blockMath) {
                        prompt.appendChild(el('div', { style: 'margin-top: 8px;' }, [makeMathBlock(seg.blockMath)]));
                    }
                }
            } else {
                prompt.textContent = q.prompt || "";
            }

            const body = el('div', { class: 'qBody' }, []);
            if (q.bodySegments) {
                for (const seg of q.bodySegments) {
                    if (typeof seg === "string") {
                        body.appendChild(document.createTextNode(seg));
                    } else if (seg && seg.inlineMath) {
                        body.appendChild(makeMathInline(seg.inlineMath));
                    } else if (seg && seg.blockMath) {
                        body.appendChild(makeMathBlock(seg.blockMath));
                    }
                }
            } else if (q.bodyText) {
                body.textContent = q.bodyText;
            }

            if (q.diagram) {
                body.appendChild(makeDiagram(q.diagram.kind, q.diagram.caption));
            }

            // Answer
            const answerRow = el('div', { class: 'answerRow' }, [
                el('div', { class: 'answerLabel' }, ["Answer"]),
                el('div', { class: 'answerValue' }, [])
            ]);
            if (q.answerSegments) {
                for (const seg of q.answerSegments) {
                    if (typeof seg === "string") answerRow.lastChild.appendChild(document.createTextNode(seg));
                    else if (seg && seg.inlineMath) answerRow.lastChild.appendChild(makeMathInline(seg.inlineMath));
                    else if (seg && seg.blockMath) answerRow.lastChild.appendChild(makeMathBlock(seg.blockMath));
                }
            } else {
                answerRow.lastChild.textContent = q.answerText || "";
            }

            // Toggle + preview (preview shown when collapsed; details shown when expanded)
            const disclosureRow = el('div', { class: 'disclosureRow' }, []);
            const btn = el('button', {
                class: 'toggle',
                type: 'button',
                'aria-expanded': q.expandedByDefault ? 'true' : 'false',
                'aria-controls': `${qId}-details`
            }, [q.expandedByDefault ? 'Hide working' : 'Show working']);

            const preview = el('div', { class: 'preview', id: `${qId}-preview`, 'aria-hidden': 'true' }, [
                q.previewText || "Working preview: " // calm, minimal; does not imply missing content
            ]);

            // Details region (hidden by default unless dataset requires expanded)
            const details = el('div', { class: 'details', id: `${qId}-details` }, []);
            if (!q.expandedByDefault) details.hidden = true;

            const detailBlocks = q.detailsBlocks || [];
            for (const b of detailBlocks) {
                const block = el('div', { class: 'detailsBlock' }, [
                    el('div', { class: 'detailsLabel' }, [b.label])
                ]);

                if (b.kind === "text") {
                    block.appendChild(el('div', { class: 'detailsText quiet' }, [b.text]));
                } else if (b.kind === "mathLines") {
                    const wrap = el('div', { class: 'detailsText' }, []);
                    // Render each line as a KaTeX display block (overflow handled per block)
                    for (const line of b.lines) {
                        wrap.appendChild(makeMathBlock(line));
                    }
                    block.appendChild(wrap);
                }
                details.appendChild(block);
            }

            // Update preview visibility based on state (preview visible only when collapsed)
            function syncPreview() {
                const expanded = btn.getAttribute('aria-expanded') === 'true';
                preview.style.display = expanded ? 'none' : 'block';
            }
            syncPreview();

            btn.addEventListener('click', () => {
                const expanded = btn.getAttribute('aria-expanded') === 'true';
                const next = !expanded;
                btn.setAttribute('aria-expanded', next ? 'true' : 'false');
                btn.textContent = next ? 'Hide working' : 'Show working';
                details.hidden = !next;
                syncPreview();
                // no auto scrolling; no focus moves; natural layout shift only
                // Render math in newly revealed details (if KaTeX loaded)
                if (next) renderMathIn(details);
            });

            // Compose
            disclosureRow.appendChild(btn);
            disclosureRow.appendChild(preview);

            right.appendChild(prompt);
            if (q.bodyText || q.bodySegments || q.diagram) right.appendChild(body);
            right.appendChild(answerRow);
            right.appendChild(disclosureRow);
            right.appendChild(details);

            qInner.appendChild(qid);
            qInner.appendChild(right);

            qWrap.appendChild(qInner);
            return qWrap;
        }

        function datasetShort() {
            return {
                key: "short",
                title: "Short paper",
                meta: "6 questions • Mix of short arithmetic and one multi-part question",
                nav: { sectioned: false },
                questions: [
                    {
                        label: "1",
                        depth: 0,
                        promptSegments: ["Calculate ", { inlineMath: "48 \\div 6" }, "."],
                        answerSegments: [{ inlineMath: "8" }],
                        previewText: "Working preview: divide to simplify.",
                        detailsBlocks: makeDetails({
                            workingLines: [
                                String.raw`48 \div 6 = 8`
                            ]
                        })
                    },
                    {
                        label: "2",
                        depth: 0,
                        promptSegments: ["Work out ", { inlineMath: "3\\frac{1}{4} + 2\\frac{2}{4}" }, "."],
                        answerSegments: [{ inlineMath: "6" }],
                        previewText: "Working preview: add whole and fractional parts.",
                        detailsBlocks: makeDetails({
                            keepInMind: "Convert mixed numbers to improper fractions if that feels clearer.",
                            workingLines: [
                                String.raw`3\frac{1}{4} + 2\frac{2}{4} = (3+2) + \left(\frac{1}{4} + \frac{2}{4}\right)`,
                                String.raw`= 5 + \frac{3}{4} = 5\frac{3}{4}`,
                                String.raw`\text{Or}\quad \frac{13}{4} + \frac{10}{4} = \frac{23}{4} = 5\frac{3}{4}`
                            ],
                            altLines: [
                                String.raw`3.25 + 2.5 = 5.75`
                            ]
                        })
                    },
                    {
                        label: "3",
                        depth: 0,
                        promptSegments: ["A bag has 12 red marbles and 8 blue marbles. What fraction are blue?"],
                        answerSegments: [{ inlineMath: "\\frac{2}{5}" }],
                        previewText: "Working preview: total marbles then simplify.",
                        detailsBlocks: makeDetails({
                            formulas: "Fraction = part ÷ whole.",
                            workingLines: [
                                String.raw`\text{Total} = 12 + 8 = 20`,
                                String.raw`\text{Blue fraction} = \frac{8}{20} = \frac{2}{5}`
                            ]
                        })
                    },
                    {
                        label: "4",
                        depth: 0,
                        promptSegments: ["A rectangle has perimeter 36 cm."],
                        answerSegments: ["See parts (a)–(c) below."],
                        previewText: "Working preview: use perimeter relationship.",
                        detailsBlocks: makeDetails({
                            workingLines: [
                                String.raw`P = 2(L + W)`
                            ]
                        })
                    },
                    {
                        label: "4a",
                        depth: 1,
                        promptSegments: ["If the length is 11 cm, find the width."],
                        answerSegments: [{ inlineMath: "7\\text{ cm}" }],
                        previewText: "Working preview: substitute into ", // minimal, calm
                        detailsBlocks: makeDetails({
                            formulas: "Perimeter of rectangle: P = 2(L + W).",
                            workingLines: [
                                String.raw`36 = 2(11 + W)`,
                                String.raw`18 = 11 + W`,
                                String.raw`W = 7`
                            ]
                        })
                    },
                    {
                        label: "4b",
                        depth: 1,
                        promptSegments: ["If the width is 5 cm, find the length."],
                        answerSegments: [{ inlineMath: "13\\text{ cm}" }],
                        previewText: "Working preview: rearrange for L.",
                        detailsBlocks: makeDetails({
                            workingLines: [
                                String.raw`36 = 2(L + 5)`,
                                String.raw`18 = L + 5`,
                                String.raw`L = 13`
                            ]
                        })
                    },
                    {
                        label: "4c",
                        depth: 1,
                        promptSegments: ["If the length equals the width, find the length."],
                        answerSegments: [{ inlineMath: "9\\text{ cm}" }],
                        previewText: "Working preview: set L = W.",
                        detailsBlocks: makeDetails({
                            keepInMind: "If the sides are equal, treat it like a square.",
                            workingLines: [
                                String.raw`36 = 2(L + L) = 4L`,
                                String.raw`L = 9`
                            ]
                        })
                    },
                    {
                        label: "5",
                        depth: 0,
                        promptSegments: ["Simplify ", { inlineMath: "6x - 2x + 3" }, "."],
                        answerSegments: [{ inlineMath: "4x + 3" }],
                        previewText: "Working preview: collect like terms.",
                        detailsBlocks: makeDetails({
                            workingLines: [
                                String.raw`6x - 2x + 3 = (6-2)x + 3 = 4x + 3`
                            ]
                        })
                    },
                    {
                        label: "6",
                        depth: 0,
                        promptSegments: ["A number is multiplied by 4 then increased by 3 to give 31. Find the number."],
                        answerSegments: [{ inlineMath: "7" }],
                        previewText: "Working preview: undo the steps in reverse.",
                        detailsBlocks: makeDetails({
                            workingLines: [
                                String.raw`4x + 3 = 31`,
                                String.raw`4x = 28`,
                                String.raw`x = 7`
                            ]
                        })
                    }
                ]
            };
        }

        function datasetStandard(expandedDefault) {
            const qs = [];
            for (let i = 1; i <= 35; i++) {
                const isLong = i >= 26;
                const label = String(i);

                // deep nesting additions
                if (i === 18) {
                    qs.push({
                        label: "18(a)(i)",
                        depth: 1,
                        promptSegments: ["Solve ", { inlineMath: "2x + 5 = 19" }, " for ", { inlineMath: "x" }, "."],
                        answerSegments: [{ inlineMath: "7" }],
                        expandedByDefault: !!expandedDefault,
                        previewText: "Working preview: subtract then divide.",
                        detailsBlocks: makeDetails({
                            formulas: "To solve a linear equation, isolate the variable.",
                            workingLines: [
                                String.raw`2x + 5 = 19`,
                                String.raw`2x = 14`,
                                String.raw`x = 7`
                            ]
                        })
                    });
                    qs.push({
                        label: "18(a)(ii)",
                        depth: 1,
                        promptSegments: ["Check your solution by substitution."],
                        answerSegments: ["It matches."],
                        expandedByDefault: !!expandedDefault,
                        previewText: "Working preview: substitute ", // calm
                        detailsBlocks: makeDetails({
                            workingLines: [
                                String.raw`\text{Substitute }x=7:\quad 2(7)+5 = 14+5 = 19`
                            ]
                        })
                    });
                    qs.push({
                        label: "18(b)",
                        depth: 1,
                        promptSegments: ["Solve ", { inlineMath: "3(x-2)=12" }, "."],
                        answerSegments: [{ inlineMath: "6" }],
                        expandedByDefault: !!expandedDefault,
                        previewText: "Working preview: divide then add.",
                        detailsBlocks: makeDetails({
                            keepInMind: "Expand OR divide both sides first — either method is fine.",
                            workingLines: [
                                String.raw`3(x-2)=12`,
                                String.raw`x-2=4`,
                                String.raw`x=6`
                            ],
                            altLines: [
                                String.raw`3x-6=12`,
                                String.raw`3x=18`,
                                String.raw`x=6`
                            ]
                        })
                    });
                    continue; // skip adding a plain "18"
                }

                if (i === 30) {
                    qs.push({
                        label: "30(a)(i)",
                        depth: 1,
                        promptSegments: ["Expand ", { inlineMath: "(x+3)^2" }, "."],
                        answerSegments: [{ inlineMath: "x^2 + 6x + 9" }],
                        expandedByDefault: !!expandedDefault,
                        previewText: "Working preview: use square of a binomial.",
                        detailsBlocks: makeDetails({
                            formulas: " (a+b)^2 = a^2 + 2ab + b^2.",
                            workingLines: [
                                String.raw`(x+3)^2 = x^2 + 2(x)(3) + 3^2`,
                                String.raw`= x^2 + 6x + 9`
                            ]
                        })
                    });
                    qs.push({
                        label: "30(a)(ii)",
                        depth: 1,
                        promptSegments: ["Factorise ", { inlineMath: "x^2 + 6x + 9" }, "."],
                        answerSegments: [{ inlineMath: "(x+3)^2" }],
                        expandedByDefault: !!expandedDefault,
                        previewText: "Working preview: perfect square trinomial.",
                        detailsBlocks: makeDetails({
                            keepInMind: "Look for a square number at the end and a middle term that is double a product.",
                            workingLines: [
                                String.raw`x^2 + 6x + 9 = x^2 + 2(x)(3) + 3^2`,
                                String.raw`= (x+3)^2`
                            ]
                        })
                    });
                    qs.push({
                        label: "30(b)",
                        depth: 1,
                        promptSegments: ["Solve ", { inlineMath: "x^2 + 6x + 9 = 0" }, "."],
                        answerSegments: [{ inlineMath: "x=-3" }],
                        expandedByDefault: !!expandedDefault,
                        previewText: "Working preview: factor then solve.",
                        detailsBlocks: makeDetails({
                            workingLines: [
                                String.raw`x^2 + 6x + 9 = (x+3)^2`,
                                String.raw`(x+3)^2 = 0`,
                                String.raw`x+3 = 0`,
                                String.raw`x = -3`
                            ]
                        })
                    });
                    continue;
                }

                if (!isLong) {
                    qs.push({
                        label,
                        depth: 0,
                        promptSegments: [
                            "Work out ",
                            { inlineMath: `${(i % 9) + 1} \\times ${((i * 2) % 11) + 2}` },
                            "."
                        ],
                        answerSegments: [{ inlineMath: String(((i % 9) + 1) * (((i * 2) % 11) + 2)) }],
                        expandedByDefault: !!expandedDefault,
                        previewText: "Working preview: multiply directly.",
                        detailsBlocks: makeDetails({
                            workingLines: [
                                String.raw`${(i % 9) + 1} \times ${((i * 2) % 11) + 2} = ${((i % 9) + 1) * (((i * 2) % 11) + 2)}`
                            ]
                        })
                    });
                } else {
                    // Long algebra questions (Q26–Q35) + long workings + frequent variants
                    const seed = i * 3;
                    const includeKeep = (i % 3 === 2) || (i === 28) || (i === 35);
                    const includeFormulas = (i % 3 === 0) || (i === 27) || (i === 35);
                    const includeAlt = (i % 4 === 0) || (i === 29) || (i === 35);

                    const working = longWorkingLines(seed);
                    const alt = includeAlt ? [
                        String.raw`\text{Alternative approach: complete the square}`,
                        String.raw`ax^2 + bx + c = a\left(x^2 + \frac{b}{a}x\right) + c`,
                        String.raw`= a\left(x + \frac{b}{2a}\right)^2 + \left(c - \frac{b^2}{4a}\right)`
                    ] : [];

                    qs.push({
                        label,
                        depth: 0,
                        promptSegments: [
                            "Solve and simplify the expression below. Show your working.",
                            { blockMath: String.raw`\frac{(x+${(i % 5) + 2})(x-${(i % 4) + 1})}{x^2 - ${(i % 7) + 2}x - ${(i % 6) + 3}}` },
                            "State any restrictions on ",
                            { inlineMath: "x" },
                            "."
                        ],
                        answerSegments: [
                            { inlineMath: String.raw`x \ne ${(i % 7) + 2},\; x \ne -${(i % 6) + 3}` }
                        ],
                        expandedByDefault: !!expandedDefault,
                        previewText: "Working preview: simplify and keep track of restrictions.",
                        detailsBlocks: makeDetails({
                            keepInMind: includeKeep ? "Cancel factors only after noting restrictions from denominators." : null,
                            formulas: includeFormulas ? "Factorisation, cancellation, and solving linear steps carefully." : null,
                            workingLines: working,
                            altLines: alt
                        })
                    });
                }
            }

            return {
                key: expandedDefault ? "standardExpanded" : "standard",
                title: expandedDefault ? "Standard (Workings Expanded)" : "Standard paper",
                meta: expandedDefault
                    ? "35 questions • Workings start expanded (dataset variant only)"
                    : "35 questions • Q26–Q35 are long algebra (workings collapsed by default)",
                nav: { sectioned: false },
                questions: qs
            };
        }

        function datasetDiagramHeavy() {
            const qs = [];
            const diagramQuestions = new Set([2, 4, 6, 8, 10, 12, 15, 18]); // 8 questions with diagrams
            const kinds = ["geometry", "bars", "grid", "table"];

            for (let i = 1; i <= 20; i++) {
                const withDiagram = diagramQuestions.has(i);
                const kind = kinds[(i - 1) % kinds.length];

                qs.push({
                    label: String(i),
                    depth: 0,
                    promptSegments: withDiagram
                        ? ["Use the diagram to answer the question."]
                        : ["Work out ", { inlineMath: `${(i % 7) + 10} - ${((i * 3) % 6) + 2}` }, "."],
                    bodyText: withDiagram
                        ? "Read the labels carefully and use the given measurements."
                        : null,
                    diagram: withDiagram ? {
                        kind,
                        caption: "Diagram placeholder (grayscale, responsive)."
                    } : null,
                    answerSegments: withDiagram
                        ? [{ inlineMath: String.raw`\text{Answer depends on diagram labels}` }]
                        : [{ inlineMath: String(((i % 7) + 10) - (((i * 3) % 6) + 2)) }],
                    previewText: withDiagram ? "Working preview: translate diagram info into a calculation." : "Working preview: subtract.",
                    detailsBlocks: makeDetails({
                        keepInMind: withDiagram && (i % 4 === 0) ? "Keep units consistent. Mark known values before calculating." : null,
                        formulas: withDiagram && (i % 5 === 0) ? "Use perimeter/area/ratio as needed from the diagram." : null,
                        workingLines: withDiagram
                            ? [
                                String.raw`\text{Extract the labelled values from the diagram.}`,
                                String.raw`\text{Set up the relationship (ratio / geometry / grid) clearly.}`,
                                String.raw`\text{Compute the required value step by step.}`
                            ]
                            : [
                                String.raw`${(i % 7) + 10} - ${((i * 3) % 6) + 2} = ${((i % 7) + 10) - (((i * 3) % 6) + 2)}`
                            ],
                        altLines: withDiagram && (i === 12) ? [
                            String.raw`\text{Alternative working: use a different but equivalent ratio representation.}`
                        ] : []
                    })
                });
            }

            return {
                key: "diagram",
                title: "Diagram-heavy paper",
                meta: "20 questions • 8 questions contain diagrams (inline SVG placeholders)",
                nav: { sectioned: false },
                questions: qs
            };
        }

        function datasetSectioned() {
            const qs = [];
            // Section A: 35 small/medium
            for (let i = 1; i <= 35; i++) {
                qs.push({
                    label: String(i),
                    depth: 0,
                    promptSegments: ["Work out ", { inlineMath: `${(i % 8) + 2} \\times ${((i * 4) % 9) + 2}` }, "."],
                    answerSegments: [{ inlineMath: String(((i % 8) + 2) * (((i * 4) % 9) + 2)) }],
                    previewText: "Working preview: multiply.",
                    detailsBlocks: makeDetails({
                        workingLines: [String.raw`${(i % 8) + 2} \times ${((i * 4) % 9) + 2} = ${((i % 8) + 2) * (((i * 4) % 9) + 2)}`]
                    })
                });
            }
            // Section B: 8 medium
            for (let i = 36; i <= 43; i++) {
                qs.push({
                    label: String(i),
                    depth: 0,
                    promptSegments: [
                        "Simplify ",
                        { inlineMath: `${(i % 5) + 2}x + ${(i % 7) + 1} - ${((i * 2) % 4) + 1}x` },
                        "."
                    ],
                    answerSegments: [{ inlineMath: `${((i % 5) + 2) - (((i * 2) % 4) + 1)}x + ${(i % 7) + 1}` }],
                    previewText: "Working preview: collect like terms.",
                    detailsBlocks: makeDetails({
                        formulas: (i % 2 === 0) ? "Combine coefficients of the same variable." : null,
                        workingLines: [
                            String.raw`${(i % 5) + 2}x - ${((i * 2) % 4) + 1}x + ${(i % 7) + 1} = ${((i % 5) + 2) - (((i * 2) % 4) + 1)}x + ${(i % 7) + 1}`
                        ]
                    })
                });
            }
            // Section C: 6 very long (collapsed by default)
            for (let i = 44; i <= 49; i++) {
                const seed = i * 5;
                qs.push({
                    label: String(i),
                    depth: 0,
                    promptSegments: [
                        "A long algebraic derivation. Show your working clearly.",
                        { blockMath: String.raw`\frac{(x^2 - ${(i % 7) + 2}x + ${(i % 5) + 1})}{(x - ${(i % 7) + 2})}` }
                    ],
                    answerSegments: [{ inlineMath: String.raw`x - ${(i % 7) + 2} + \frac{${(i % 5) + 1}}{x - ${(i % 7) + 2}}` }],
                    previewText: "Working preview: long derivation (collapsed by default).",
                    detailsBlocks: makeDetails({
                        keepInMind: (i === 46) ? "Long workings can be taken one step at a time. Keep expressions aligned." : null,
                        formulas: (i === 47) ? "Polynomial division (or splitting numerator) can simplify rational expressions." : null,
                        workingLines: longWorkingLines(seed),
                        altLines: (i === 49) ? [
                            String.raw`\text{Alternative working: use substitution }u = x - ${(i % 7) + 2}`,
                            String.raw`\text{Rewrite in terms of }u\text{ to simplify the structure.}`
                        ] : []
                    })
                });
            }

            return {
                key: "sectioned",
                title: "Sectioned paper",
                meta: "Section A: 35 • Section B: 8 • Section C: 6 (very long workings, collapsed by default)",
                nav: {
                    sectioned: true,
                    sections: [
                        { label: "A", from: 1, to: 35 },
                        { label: "B", from: 36, to: 43 },
                        { label: "C", from: 44, to: 49 }
                    ]
                },
                questions: qs
            };
        }

        const DATASETS = {
            short: datasetShort,
            standard: () => datasetStandard(false),
            standardExpanded: () => datasetStandard(true),
            diagram: datasetDiagramHeavy,
            sectioned: datasetSectioned
        };

        // --------------------------
        // Navigation building
        // --------------------------
        function buildNavigation(dataset) {
            const navList = document.getElementById('navList');
            const drawerNav = document.getElementById('drawerNav');
            navList.innerHTML = "";
            drawerNav.innerHTML = "";

            function addItem(container, label, id) {
                const a = el('a', {
                    class: 'navItem',
                    href: `#${id}`,
                    'data-nav-id': id,
                    'aria-current': 'false'
                }, [label]);

                // Do not change expanded/collapsed states on navigation
                // (default anchor navigation; no smooth scroll; no cross-question effects)
                a.addEventListener('click', () => {
                    // Close drawer on mobile after selection
                    if (!isDesktop()) closeDrawer();
                });

                container.appendChild(a);
            }

            function addSectionLabel(container, label) {
                container.appendChild(el('div', { class: 'navSection' }, [label]));
            }

            const items = dataset.questions.map(q => ({ label: q.label, id: safeId(q.label) }));

            if (dataset.nav && dataset.nav.sectioned && dataset.nav.sections) {
                for (const s of dataset.nav.sections) {
                    addSectionLabel(navList, s.label);
                    addSectionLabel(drawerNav, s.label);
                    for (const it of items) {
                        const n = parseInt(it.label, 10);
                        if (!Number.isNaN(n) && n >= s.from && n <= s.to) {
                            addItem(navList, it.label, it.id);
                            addItem(drawerNav, it.label, it.id);
                        }
                    }
                }
            } else {
                for (const it of items) {
                    addItem(navList, it.label, it.id);
                    addItem(drawerNav, it.label, it.id);
                }
            }

            // Provide keyboard scrolling support when nav list is focused
            function addNavKeyScroll(container) {
                container.addEventListener('keydown', (e) => {
                    const key = e.key;
                    const step = 48;
                    if (key === "ArrowDown") { container.scrollTop += step; e.preventDefault(); }
                    if (key === "ArrowUp") { container.scrollTop -= step; e.preventDefault(); }
                    if (key === "PageDown") { container.scrollTop += container.clientHeight * 0.8; e.preventDefault(); }
                    if (key === "PageUp") { container.scrollTop -= container.clientHeight * 0.8; e.preventDefault(); }
                    if (key === "Home") { container.scrollTop = 0; e.preventDefault(); }
                    if (key === "End") { container.scrollTop = container.scrollHeight; e.preventDefault(); }
                });
            }
            addNavKeyScroll(navList);
            addNavKeyScroll(drawerNav);
        }

        // --------------------------
        // Paper building
        // --------------------------
        function buildPaper(dataset) {
            const paper = document.getElementById('paper');
            paper.innerHTML = "";

            paper.appendChild(el('p', { class: 'paperMeta' }, [dataset.meta]));

            // Render questions into a single linear document
            for (const q of dataset.questions) {
                // Apply dataset-level default: answers visible always; workings collapsed unless expandedByDefault set
                if (q.expandedByDefault == null) q.expandedByDefault = false;
                paper.appendChild(makeQuestion(q));
            }

            // Render math after injecting
            renderMathIn(paper);

            // Rebuild navigation to match current paper
            buildNavigation(dataset);

            // Observe scrolling to highlight current question in navigation (quiet, subtle)
            setupScrollSpy(dataset);
        }

        // --------------------------
        // Scroll spy (subtle current position)
        // --------------------------
        let spyObserver = null;
        function setupScrollSpy(dataset) {
            if (spyObserver) spyObserver.disconnect();

            const opts = {
                root: null,
                rootMargin: `-${Math.round(window.innerHeight * 0.15)}px 0px -${Math.round(window.innerHeight * 0.75)}px 0px`,
                threshold: 0.01
            };

            spyObserver = new IntersectionObserver((entries) => {
                // Find the first visible entry (in reading order)
                const visible = entries.filter(e => e.isIntersecting)
                    .sort((a, b) => a.boundingClientRect.top - b.boundingClientRect.top)[0];
                if (!visible) return;
                const id = visible.target.getAttribute('data-qid');
                if (id) setCurrentNav(id);
            }, opts);

            const qs = document.querySelectorAll('[data-qid]');
            for (const q of qs) spyObserver.observe(q);
        }

        // --------------------------
        // Drawer behavior (mobile/tablet)
        // --------------------------
        const overlay = document.getElementById('overlay');
        const drawer = document.getElementById('drawer');
        const jumpBtn = document.getElementById('jumpBtn');
        const drawerClose = document.getElementById('drawerClose');

        let lastFocus = null;

        function isDesktop() {
            return window.matchMedia('(min-width: 921px)').matches;
        }

        function openDrawer() {
            lastFocus = document.activeElement;
            overlay.setAttribute('aria-hidden', 'false');
            drawer.setAttribute('aria-hidden', 'false');
            jumpBtn.setAttribute('aria-expanded', 'true');

            // Focus first focusable element in drawer
            drawerClose.focus();

            // Prevent background scroll while drawer is open
            document.body.style.overflow = 'hidden';
        }

        function closeDrawer() {
            overlay.setAttribute('aria-hidden', 'true');
            drawer.setAttribute('aria-hidden', 'true');
            jumpBtn.setAttribute('aria-expanded', 'false');

            document.body.style.overflow = '';

            if (lastFocus && typeof lastFocus.focus === "function") lastFocus.focus();
        }

        function trapFocus(e) {
            if (drawer.getAttribute('aria-hidden') === 'true') return;
            if (e.key !== 'Tab') return;

            const focusables = drawer.querySelectorAll('button, [href], [tabindex]:not([tabindex="-1"])');
            const list = Array.from(focusables).filter(n => !n.hasAttribute('disabled') && n.offsetParent !== null);
            if (!list.length) return;

            const first = list[0];
            const last = list[list.length - 1];

            if (e.shiftKey && document.activeElement === first) {
                last.focus();
                e.preventDefault();
            } else if (!e.shiftKey && document.activeElement === last) {
                first.focus();
                e.preventDefault();
            }
        }

        jumpBtn.addEventListener('click', () => {
            if (drawer.getAttribute('aria-hidden') === 'true') openDrawer();
            else closeDrawer();
        });
        drawerClose.addEventListener('click', closeDrawer);
        overlay.addEventListener('click', closeDrawer);

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && drawer.getAttribute('aria-hidden') === 'false') {
                closeDrawer();
            }
            trapFocus(e);
        });

        // --------------------------
        // Dataset switching
        // --------------------------
        const paperSelect = document.getElementById('paperSelect');

        function loadDataset(key) {
            const builder = DATASETS[key] || DATASETS.short;
            const dataset = builder();

            // Ensure dataset-level defaults respected:
            // - Answers visible (always)
            // - Solution details collapsed by default (except standardExpanded dataset variant)
            // - Switching papers resets to dataset defaults only (no cross-paper persistence)
            buildPaper(dataset);
        }

        paperSelect.addEventListener('change', () => {
            loadDataset(paperSelect.value);
        });

        // Close drawer when moving to desktop
        window.addEventListener('resize', () => {
            if (isDesktop() && drawer.getAttribute('aria-hidden') === 'false') closeDrawer();
            // Keep scroll spy margins sensible
            // (rebuild observer only if needed)
        });

        // Initial load
        loadDataset(paperSelect.value);

        // Render math if KaTeX loads after DOM (defer script)
        window.addEventListener('load', () => {
            renderMathIn(document);
        });
    </script>
</body>

</html>