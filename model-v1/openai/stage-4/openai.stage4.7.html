<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>RTQ – Maths Paper Solution Viewer (Stress Test Harness)</title>

    <!-- KaTeX (CDN) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>

    <style>
        :root {
            /* Surfaces (Stage 4: grayscale layered) */
            --page-bg: #f1f1f1;
            --content-surface: #ffffff;
            --nav-surface: #f6f6f6;
            --solution-surface: #fafafa;

            --ink: #111;
            --ink-quiet: #3a3a3a;
            --ink-muted: #666;
            --hairline: rgba(0, 0, 0, 0.10);

            --frame-max: 1120px;
            --gutter: 18px;
            --topbar-h: 64px;

            /* Rhythm */
            --q-gap-0: 28px;
            /* between top-level questions (largest) */
            --q-gap-1: 18px;
            --q-gap-2: 12px;

            --inside-gap: 10px;
            /* within Question → Answer → Working */
            --label-gap: 6px;

            /* Indentation */
            --indent-0: 0px;
            --indent-1: 18px;
            --indent-2: 34px;

            /* Touch */
            --tap-min: 44px;
            --radius: 10px;
        }

        * {
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
        }

        body {
            margin: 0;
            background: var(--page-bg);
            color: var(--ink);
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
            line-height: 1.4;
            overflow-x: hidden;
            /* main document must never scroll horizontally */
        }

        /* Top control area aligned to the same centered frame */
        header {
            position: sticky;
            top: 0;
            z-index: 20;
            background: var(--page-bg);
            border-bottom: 1px solid var(--hairline);
        }

        .topbar {
            max-width: var(--frame-max);
            margin: 0 auto;
            padding: 10px var(--gutter);
            min-height: var(--topbar-h);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .topbar .group {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .topbar label {
            font-size: 14px;
            color: var(--ink-quiet);
            white-space: nowrap;
        }

        select {
            appearance: none;
            -webkit-appearance: none;
            border: 1px solid var(--hairline);
            background: var(--content-surface);
            color: var(--ink);
            padding: 10px 12px;
            border-radius: 10px;
            font-size: 14px;
            line-height: 1.2;
            min-height: var(--tap-min);
        }

        select:focus-visible,
        button:focus-visible,
        a:focus-visible {
            outline: 2px solid rgba(0, 0, 0, 0.55);
            outline-offset: 2px;
            border-radius: 10px;
        }

        .jumpBtn {
            border: 1px solid var(--hairline);
            background: var(--content-surface);
            color: var(--ink);
            padding: 10px 12px;
            border-radius: 10px;
            font-size: 14px;
            min-height: var(--tap-min);
            cursor: pointer;
            user-select: none;
        }

        .jumpBtn:hover {
            background: #fbfbfb;
        }

        .jumpBtn:active {
            transform: translateY(1px);
        }

        /* Centered content frame containing nav + paper */
        .frame {
            max-width: var(--frame-max);
            margin: 0 auto;
            padding: 14px var(--gutter) 80px;
            /* extra bottom for mobile jump affordance */
            display: grid;
            grid-template-columns: 160px 1fr;
            gap: 18px;
            align-items: start;
        }

        nav {
            background: var(--nav-surface);
            border-radius: var(--radius);
            padding: 10px 8px;
            position: sticky;
            /* persistent nav rail */
            top: calc(var(--topbar-h) + 14px);
            max-height: calc(100vh - var(--topbar-h) - 28px);
            overflow: hidden;
            /* scrollbar only on list if needed */
        }

        .navTitle {
            font-size: 12px;
            color: var(--ink-muted);
            padding: 6px 8px 8px;
            letter-spacing: 0.02em;
            text-transform: none;
        }

        .navList {
            overflow-y: auto;
            /* allowed separate scroll if exceeds viewport */
            max-height: calc(100vh - var(--topbar-h) - 70px);
            padding: 0 2px 6px;
            margin: 0;
            list-style: none;

            /* Hide scrollbar visually (cross-browser) */
            scrollbar-width: none;
            /* Firefox */
            -ms-overflow-style: none;
            /* legacy */
        }

        .navList::-webkit-scrollbar {
            display: none;
        }

        /* WebKit/Blink */

        .navSep {
            font-size: 12px;
            color: var(--ink-muted);
            padding: 10px 8px 6px;
            user-select: none;
        }

        .navItem {
            margin: 0;
            padding: 0;
        }

        .navLink {
            display: block;
            text-decoration: none;
            color: var(--ink-muted);
            font-size: 14px;
            padding: 8px 10px;
            border-radius: 10px;
            min-height: 36px;
        }

        .navLink:hover {
            background: rgba(0, 0, 0, 0.03);
            color: var(--ink);
        }

        .navLink[aria-current="true"] {
            background: rgba(0, 0, 0, 0.06);
            color: var(--ink);
            font-weight: 600;
            /* allowed for current nav item */
        }

        main {
            background: var(--content-surface);
            border-radius: var(--radius);
            padding: 18px 18px 24px;
            box-shadow: 0 1px 0 rgba(0, 0, 0, 0.06);
            overflow: visible;
            /* single document scroll remains body */
        }

        .paperMeta {
            margin: 0 0 14px;
            color: var(--ink-muted);
            font-size: 13px;
        }

        /* Section headers in paper content (structural dividers, not containers) */
        .sectionHeader {
            margin: 22px 0 10px;
            padding: 0;
            font-size: 14px;
            color: var(--ink-quiet);
            font-weight: 600;
            letter-spacing: 0.02em;
        }

        /* Question blocks */
        .q {
            scroll-margin-top: calc(var(--topbar-h) + 18px);
        }

        .q.depth0 {
            margin-top: var(--q-gap-0);
        }

        .q.depth1 {
            margin-top: var(--q-gap-1);
        }

        .q.depth2 {
            margin-top: var(--q-gap-2);
        }

        .qInner {
            padding-left: var(--indent-0);
        }

        .q.depth1 .qInner {
            padding-left: var(--indent-1);
        }

        .q.depth2 .qInner {
            padding-left: var(--indent-2);
        }

        .qHeader {
            display: flex;
            align-items: baseline;
            gap: 10px;
            margin-bottom: var(--inside-gap);
        }

        .qid {
            font-size: 14px;
            color: var(--ink-quiet);
            flex: none;
            min-width: 58px;
        }

        .qprompt {
            font-size: 16px;
            line-height: 1.55;
            color: var(--ink);
            flex: 1;
            min-width: 0;
        }

        .qprompt p {
            margin: 0 0 10px;
        }

        .qprompt p:last-child {
            margin-bottom: 0;
        }

        /* Diagrams */
        .diagram {
            margin: 10px 0 2px;
            max-width: 100%;
            border-radius: 10px;
            background: #fcfcfc;
            border: 1px solid rgba(0, 0, 0, 0.06);
            padding: 10px;
        }

        .diagram svg {
            width: 100%;
            height: auto;
            display: block;
        }

        /* Answer (visible by default) */
        .answer {
            margin: 0 0 6px;
            display: flex;
            gap: 10px;
            align-items: baseline;
        }

        .answerLabel {
            font-size: 13px;
            color: var(--ink-quiet);
            font-weight: 600;
            /* allowed for labels */
            min-width: 58px;
        }

        .answerValue {
            font-size: 15px;
            color: var(--ink);
            line-height: 1.5;
        }

        .answerValue p {
            margin: 0 0 8px;
        }

        .answerValue p:last-child {
            margin-bottom: 0;
        }

        /* Disclosure control (text-first) */
        .disclosureRow {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 6px 0 8px;
        }

        .toggleBtn {
            border: 1px solid var(--hairline);
            background: transparent;
            color: var(--ink);
            padding: 10px 12px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            min-height: var(--tap-min);
            user-select: none;
        }

        .toggleBtn:hover {
            background: rgba(0, 0, 0, 0.02);
        }

        .toggleBtn:active {
            transform: translateY(1px);
        }

        .toggleHint {
            font-size: 13px;
            color: var(--ink-muted);
        }

        /* Collapsed preview (max 1–2 lines) */
        .preview {
            font-size: 13px;
            color: var(--ink-muted);
            margin: 0 0 6px;
            padding-left: 58px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Solution Details surface */
        .solution {
            margin-top: 8px;
            background: var(--solution-surface);
            border-radius: 12px;
            padding: 12px 12px 12px;
        }

        .solutionBlock {
            margin-top: 12px;
        }

        .solutionBlock:first-child {
            margin-top: 0;
        }

        .sLabel {
            font-size: 13px;
            font-weight: 600;
            color: var(--ink-quiet);
            margin: 0 0 var(--label-gap);
        }

        .sBody {
            font-size: 14px;
            color: var(--ink);
            line-height: 1.45;
        }

        .sBody p {
            margin: 0 0 10px;
        }

        .sBody p:last-child {
            margin-bottom: 0;
        }

        /* Workings: continuous lines, not boxed/tiled */
        .lines {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .line {
            font-size: 14px;
            color: var(--ink);
            line-height: 1.45;
            word-break: break-word;
        }

        /* Math rendering + overflow rules */
        .math-inline {
            display: inline-block;
            vertical-align: baseline;
            max-width: 100%;
        }

        .math-block {
            display: block;
            max-width: 100%;
            overflow-x: auto;
            /* horizontal scrolling only here */
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior-x: contain;
            padding: 6px 0;
        }

        /* Ensure KaTeX doesn't force body horizontal scroll */
        .katex-display {
            margin: 0;
            /* keep stable rhythm */
        }

        /* Mobile / tablet adaptations */
        @media (max-width: 860px) {
            .frame {
                grid-template-columns: 1fr;
                gap: 14px;
            }

            nav {
                display: none;
                /* replaced by overlay nav */
            }

            main {
                padding: 16px 14px 22px;
            }

            .qid,
            .answerLabel {
                min-width: 46px;
            }

            :root {
                --indent-1: 14px;
                --indent-2: 26px;
            }
        }

        /* Always-accessible mobile Jump to (minimal) */
        .fabJump {
            position: fixed;
            right: 14px;
            bottom: 14px;
            z-index: 30;
            display: none;
        }

        @media (max-width: 860px) {
            .fabJump {
                display: block;
            }
        }

        /* Overlay / drawer navigation for mobile */
        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.35);
            z-index: 40;
            display: none;
        }

        .overlay.open {
            display: block;
        }

        .drawer {
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            width: min(360px, 88vw);
            background: var(--nav-surface);
            z-index: 50;
            transform: translateX(-102%);
            transition: transform 180ms ease;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--hairline);
        }

        .drawer.open {
            transform: translateX(0);
        }

        .drawerHeader {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 12px 10px;
            border-bottom: 1px solid var(--hairline);
            min-height: var(--topbar-h);
            background: var(--nav-surface);
        }

        .drawerHeader .title {
            font-size: 14px;
            color: var(--ink-quiet);
            font-weight: 600;
        }

        .closeBtn {
            border: 1px solid var(--hairline);
            background: var(--content-surface);
            color: var(--ink);
            padding: 10px 12px;
            border-radius: 10px;
            min-height: var(--tap-min);
            cursor: pointer;
        }

        .drawerBody {
            padding: 6px 8px 16px;
            overflow-y: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .drawerBody::-webkit-scrollbar {
            display: none;
        }

        .drawerNavList {
            list-style: none;
            margin: 0;
            padding: 0 2px 12px;
        }

        .drawerNavLink {
            display: block;
            text-decoration: none;
            color: var(--ink-muted);
            font-size: 15px;
            padding: 12px 10px;
            border-radius: 12px;
            min-height: var(--tap-min);
        }

        .drawerNavLink:hover {
            background: rgba(0, 0, 0, 0.03);
            color: var(--ink);
        }

        .drawerNavLink[aria-current="true"] {
            background: rgba(0, 0, 0, 0.06);
            color: var(--ink);
            font-weight: 600;
        }

        .drawerSep {
            font-size: 12px;
            color: var(--ink-muted);
            padding: 12px 10px 8px;
            user-select: none;
        }

        /* Prevent background interaction when drawer open */
        body.nav-open .frame,
        body.nav-open header {
            pointer-events: none;
            user-select: none;
        }

        body.nav-open .drawer,
        body.nav-open .overlay {
            pointer-events: auto;
            user-select: auto;
        }

        /* Quiet small print */
        .quiet {
            color: var(--ink-muted);
            font-size: 13px;
        }
    </style>
</head>

<body>
    <header>
        <div class="topbar" id="topbar">
            <div class="group">
                <label for="paperSelect">Paper</label>
                <select id="paperSelect" aria-label="Paper selector">
                    <option value="short">Short paper</option>
                    <option value="standard">Standard paper</option>
                    <option value="standardExpanded">Standard (Workings Expanded)</option>
                    <option value="diagramHeavy">Diagram-heavy paper</option>
                    <option value="sectioned">Sectioned paper</option>
                </select>
            </div>

            <div class="group" style="margin-left:auto;">
                <button class="jumpBtn" id="openNavBtn" type="button">Jump to</button>
            </div>
        </div>
    </header>

    <div class="frame" id="appFrame">
        <nav aria-label="Question navigation">
            <div class="navTitle" id="navTitle">Jump to</div>
            <ul class="navList" id="navList" tabindex="0"></ul>
        </nav>

        <main id="paper" aria-label="Maths paper content">
            <p class="paperMeta" id="paperMeta"></p>
            <div id="paperContent"></div>
        </main>
    </div>

    <!-- Mobile always-accessible Jump to -->
    <div class="fabJump">
        <button class="jumpBtn" id="fabOpenNavBtn" type="button">Jump to</button>
    </div>

    <!-- Mobile drawer + overlay -->
    <div class="overlay" id="overlay" aria-hidden="true"></div>
    <div class="drawer" id="drawer" role="dialog" aria-modal="true" aria-label="Question navigation">
        <div class="drawerHeader">
            <div class="title">Jump to</div>
            <button class="closeBtn" id="closeNavBtn" type="button">Close</button>
        </div>
        <div class="drawerBody">
            <ul class="drawerNavList" id="drawerNavList"></ul>
        </div>
    </div>

    <script>
        (function () {
            const $ = (sel, root = document) => root.querySelector(sel);
            const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));

            const paperSelect = $("#paperSelect");
            const navList = $("#navList");
            const drawerNavList = $("#drawerNavList");
            const paperMeta = $("#paperMeta");
            const paperContent = $("#paperContent");

            const overlay = $("#overlay");
            const drawer = $("#drawer");
            const openNavBtn = $("#openNavBtn");
            const fabOpenNavBtn = $("#fabOpenNavBtn");
            const closeNavBtn = $("#closeNavBtn");

            // ---------- Helpers ----------
            function escapeHtml(str) {
                return String(str)
                    .replaceAll("&", "&amp;")
                    .replaceAll("<", "&lt;")
                    .replaceAll(">", "&gt;")
                    .replaceAll('"', "&quot;")
                    .replaceAll("'", "&#039;");
            }
            function escapeAttr(str) {
                return escapeHtml(str).replaceAll("\n", "&#10;");
            }
            function mi(tex) {
                return `<span class="math math-inline" data-display="false" data-tex="${escapeAttr(tex)}">${escapeHtml(tex)}</span>`;
            }
            function mb(tex) {
                return `<div class="math math-block" data-display="true" data-tex="${escapeAttr(tex)}">${escapeHtml(tex)}</div>`;
            }

            // Inline SVG diagram placeholders (reused types)
            function svgGeometry() {
                return `
          <svg viewBox="0 0 360 170" role="img" aria-label="Geometry diagram">
            <rect x="1" y="1" width="358" height="168" fill="none" stroke="#444" stroke-width="1"/>
            <circle cx="260" cy="78" r="38" fill="none" stroke="#444" stroke-width="1.2"/>
            <path d="M50 140 L150 30 L210 140 Z" fill="none" stroke="#222" stroke-width="1.6"/>
            <text x="145" y="24" font-size="12" fill="#222">A</text>
            <text x="42" y="152" font-size="12" fill="#222">B</text>
            <text x="210" y="152" font-size="12" fill="#222">C</text>
            <text x="250" y="34" font-size="12" fill="#222">Circle</text>
            <text x="242" y="126" font-size="12" fill="#222">r</text>
            <line x1="260" y1="78" x2="292" y2="78" stroke="#222" stroke-width="1.2"/>
            <text x="298" y="82" font-size="12" fill="#222">r</text>
            <text x="86" y="98" font-size="12" fill="#222">x</text>
          </svg>
        `;
            }
            function svgBars() {
                return `
          <svg viewBox="0 0 360 170" role="img" aria-label="Ratio bars">
            <rect x="1" y="1" width="358" height="168" fill="none" stroke="#444" stroke-width="1"/>
            <text x="16" y="26" font-size="12" fill="#222">A : B</text>
            <rect x="16" y="44" width="210" height="26" fill="none" stroke="#222" stroke-width="1.4"/>
            <line x1="86" y1="44" x2="86" y2="70" stroke="#222" stroke-width="1"/>
            <line x1="156" y1="44" x2="156" y2="70" stroke="#222" stroke-width="1"/>
            <text x="18" y="66" font-size="12" fill="#222">A</text>

            <rect x="16" y="92" width="280" height="26" fill="none" stroke="#222" stroke-width="1.4"/>
            <line x1="86" y1="92" x2="86" y2="118" stroke="#222" stroke-width="1"/>
            <line x1="156" y1="92" x2="156" y2="118" stroke="#222" stroke-width="1"/>
            <line x1="226" y1="92" x2="226" y2="118" stroke="#222" stroke-width="1"/>
            <text x="18" y="114" font-size="12" fill="#222">B</text>

            <text x="248" y="60" font-size="12" fill="#222">3 parts</text>
            <text x="304" y="108" font-size="12" fill="#222">4 parts</text>
          </svg>
        `;
            }
            function svgCoord() {
                return `
          <svg viewBox="0 0 360 170" role="img" aria-label="Coordinate grid">
            <rect x="1" y="1" width="358" height="168" fill="none" stroke="#444" stroke-width="1"/>
            <g stroke="#cfcfcf" stroke-width="1">
              ${Array.from({ length: 11 }).map((_, i) => `<line x1="${40 + i * 28}" y1="20" x2="${40 + i * 28}" y2="150"/>`).join("")}
              ${Array.from({ length: 6 }).map((_, i) => `<line x1="40" y1="${20 + i * 26}" x2="320" y2="${20 + i * 26}"/>`).join("")}
            </g>
            <g stroke="#222" stroke-width="1.4">
              <line x1="40" y1="150" x2="320" y2="150"/>
              <line x1="40" y1="150" x2="40" y2="20"/>
            </g>
            <path d="M60 130 L140 92 L240 70 L300 52" fill="none" stroke="#222" stroke-width="1.8"/>
            <circle cx="140" cy="92" r="3" fill="#222"/>
            <circle cx="240" cy="70" r="3" fill="#222"/>
            <text x="326" y="154" font-size="12" fill="#222">x</text>
            <text x="34" y="16" font-size="12" fill="#222">y</text>
          </svg>
        `;
            }
            function svgGrid() {
                return `
          <svg viewBox="0 0 360 170" role="img" aria-label="Table grid">
            <rect x="1" y="1" width="358" height="168" fill="none" stroke="#444" stroke-width="1"/>
            <g stroke="#222" stroke-width="1.2" fill="none">
              <rect x="40" y="28" width="280" height="114"/>
              ${Array.from({ length: 4 }).map((_, i) => `<line x1="${40 + (i + 1) * 56}" y1="28" x2="${40 + (i + 1) * 56}" y2="142"/>`).join("")}
              ${Array.from({ length: 3 }).map((_, i) => `<line x1="40" y1="${28 + (i + 1) * 38}" x2="320" y2="${28 + (i + 1) * 38}"/>`).join("")}
            </g>
            <text x="48" y="52" font-size="12" fill="#222">x</text>
            <text x="48" y="90" font-size="12" fill="#222">y</text>
            <text x="48" y="128" font-size="12" fill="#222">z</text>
            <text x="110" y="52" font-size="12" fill="#222">1</text>
            <text x="166" y="52" font-size="12" fill="#222">2</text>
            <text x="222" y="52" font-size="12" fill="#222">3</text>
            <text x="278" y="52" font-size="12" fill="#222">4</text>
          </svg>
        `;
            }
            const diagramTypes = {
                geometry: svgGeometry,
                bars: svgBars,
                coord: svgCoord,
                grid: svgGrid
            };

            function diagramBlock(type) {
                const fn = diagramTypes[type] || diagramTypes.geometry;
                return `<div class="diagram">${fn()}</div>`;
            }

            function makeWorkingLines(count, seedTex) {
                // 50–60 lines, calm density, include occasional display blocks
                const lines = [];
                for (let i = 1; i <= count; i++) {
                    if (i % 9 === 0) {
                        const tex = String(seedTex)
                            .replaceAll("{i}", String(i))
                            .replaceAll("{k}", String(Math.floor(i / 3) + 2));
                        lines.push({ type: "mathBlock", tex });
                    } else if (i % 4 === 0) {
                        lines.push({ type: "text", html: `Simplify: ${mi("\\\\frac{" + (i + 2) + "}{" + (i - 1) + "}")} then substitute into ${mi("x")} and continue.` });
                    } else {
                        const a = (i % 7) + 2;
                        const b = (i % 5) + 3;
                        lines.push({ type: "text", html: `${mi("x_" + i)} = ${mi(String(a))}${mi("x_" + (i - 1))} + ${mi(String(b))}.` });
                    }
                }
                return lines;
            }

            function renderMath() {
                // Replace placeholders with KaTeX, fallback to plain text if KaTeX fails to load
                const nodes = $$(".math", paperContent);
                if (!window.katex || typeof window.katex.render !== "function") {
                    return; // graceful fallback: keep TeX as plain text
                }
                for (const el of nodes) {
                    const tex = el.getAttribute("data-tex") || el.textContent || "";
                    const displayMode = el.getAttribute("data-display") === "true";
                    try {
                        window.katex.render(tex, el, {
                            displayMode,
                            throwOnError: false,
                            strict: "warn",
                            output: "html"
                        });
                    } catch (e) {
                        // keep fallback text
                    }
                }
            }

            function normalizeId(id) {
                return id.replaceAll(/[^\w]+/g, "-").replaceAll(/-+/g, "-").replace(/^-|-$/g, "").toLowerCase();
            }

            function makeQIdAnchor(id) { return `q-${normalizeId(id)}`; }

            // ---------- Data ----------
            // Question object shape:
            // { id, depth, promptHtml, answerHtml, previewHtml, details: { keepInMindHtml?, formulasHtml?, workingLines?, altWorkings?[] } , expandedByDefault? }
            function buildShortPaper() {
                return {
                    key: "short",
                    title: "Short paper",
                    meta: "6 questions. Mix of short arithmetic and one multi-part question.",
                    sections: null,
                    questions: [
                        {
                            id: "1",
                            depth: 0,
                            promptHtml: `<p>Work out ${mi("7\\times 8")}.</p>`,
                            answerHtml: `<p>${mi("56")}</p>`,
                            previewHtml: `Preview: ${mi("7\\times 8=56")}`,
                            details: {
                                workingLines: [
                                    { type: "text", html: `${mi("7\\times 8")} = ${mi("7\\times (10-2)")} = ${mi("70-14")} = ${mi("56")}.` }
                                ]
                            }
                        },
                        {
                            id: "2",
                            depth: 0,
                            promptHtml: `<p>${mi("3.5")} litres of juice are shared equally into ${mi("7")} bottles. How much is in each bottle?</p>`,
                            answerHtml: `<p>${mi("0.5")} litres</p>`,
                            previewHtml: `Preview: ${mi("3.5\\div 7=0.5")}`,
                            details: {
                                keepInMindHtml: `<p>Check the units at the end.</p>`,
                                workingLines: [
                                    { type: "text", html: `Divide: ${mi("3.5\\div 7")}.` },
                                    { type: "text", html: `${mi("3.5")} is ${mi("\\frac{35}{10}")}, so ${mi("\\frac{35}{10}\\div 7=\\frac{35}{10\\cdot 7}=\\frac{35}{70}=\\frac12")} = ${mi("0.5")}.` }
                                ]
                            }
                        },
                        {
                            id: "3",
                            depth: 0,
                            promptHtml: `<p>A rectangle has length ${mi("12")} cm and width ${mi("5")} cm. Find the area.</p>`,
                            answerHtml: `<p>${mi("60")} cm${mi("^2")}</p>`,
                            previewHtml: `Preview: ${mi("12\\times 5=60")}`,
                            details: {
                                formulasHtml: `<p>Area of rectangle = ${mi("\\text{length}\\times \\text{width}")}.</p>`,
                                workingLines: [
                                    { type: "text", html: `${mi("12\\times 5=60")}.` },
                                    { type: "text", html: `So the area is ${mi("60")} cm${mi("^2")}.` }
                                ]
                            }
                        },
                        {
                            id: "4",
                            depth: 0,
                            promptHtml: `<p>Solve for ${mi("x")}: ${mi("x+9=23")}.</p>`,
                            answerHtml: `<p>${mi("x=14")}</p>`,
                            previewHtml: `Preview: ${mi("23-9=14")}`,
                            details: {
                                workingLines: [
                                    { type: "text", html: `Subtract ${mi("9")} from both sides: ${mi("x=23-9=14")}.` }
                                ]
                            }
                        },
                        {
                            id: "5",
                            depth: 0,
                            promptHtml: `<p>A bag has ${mi("18")} sweets. ${mi("\\frac{2}{3}")} are red. How many are red?</p>`,
                            answerHtml: `<p>${mi("12")}</p>`,
                            previewHtml: `Preview: ${mi("\\frac{2}{3}\\times 18")}`,
                            details: {
                                workingLines: [
                                    { type: "text", html: `Find one third: ${mi("18\\div 3=6")}.` },
                                    { type: "text", html: `Then two thirds: ${mi("2\\times 6=12")}.` }
                                ],
                                altWorkings: [
                                    {
                                        label: "Alternative working",
                                        lines: [
                                            { type: "text", html: `${mi("\\frac{2}{3}\\times 18 = 2\\times (18\\div 3)=2\\times 6=12")}.` }
                                        ]
                                    }
                                ]
                            }
                        },
                        // Multi-part with deep nesting style (still short paper)
                        {
                            id: "6",
                            depth: 0,
                            promptHtml: `<p>A shop sells pencils.</p>
                <p>(a) One pencil costs ${mi("35")}p. How much do ${mi("4")} pencils cost?</p>`,
                            answerHtml: `<p>(a) ${mi("140")}p</p>`,
                            previewHtml: `Preview: ${mi("35\\times 4")}`,
                            details: {
                                workingLines: [
                                    { type: "text", html: `Multiply: ${mi("35\\times 4")} = ${mi("140")}.` }
                                ]
                            }
                        },
                        {
                            id: "6b",
                            depth: 1,
                            promptHtml: `<p>(b) The shop offers a deal: ${mi("5")} pencils for ${mi("\\pounds 1.50")}. Is this cheaper than buying ${mi("5")} pencils at ${mi("35")}p each?</p>`,
                            answerHtml: `<p>(b) Yes, the deal is cheaper.</p>`,
                            previewHtml: `Preview: compare ${mi("5\\times 35\\text{p}")} with ${mi("150\\text{p}")}`,
                            details: {
                                keepInMindHtml: `<p>Convert to the same units before comparing.</p>`,
                                workingLines: [
                                    { type: "text", html: `Cost without deal: ${mi("5\\times 35\\text{p} = 175\\text{p}")}.` },
                                    { type: "text", html: `Deal price: ${mi("\\pounds 1.50 = 150\\text{p}")}.` },
                                    { type: "text", html: `${mi("150\\text{p} < 175\\text{p}")}, so the deal is cheaper.` }
                                ]
                            }
                        }
                    ],
                    defaultExpand: false
                };
            }

            function buildStandardPaper(expandedVariant = false) {
                const questions = [];
                // Q1–Q25 smaller/medium, include some diagrams and solution variants coverage
                for (let i = 1; i <= 25; i++) {
                    const id = String(i);
                    let prompt = `<p>Calculate ${mi(String(i + 3))} + ${mi(String(i))}.</p>`;
                    let ans = `<p>${mi(String((i + 3) + i))}</p>`;
                    let preview = `Preview: ${mi(String(i + 3) + "+" + i + "=" + ((i + 3) + i))}`;
                    let details = {
                        workingLines: [{ type: "text", html: `${mi(String(i + 3) + "+" + i)} = ${mi(String((i + 3) + i))}.` }]
                    };

                    // Add some variety and required Solution Details variants
                    if (i === 4) {
                        prompt = `<p>A triangle has base ${mi("10")} cm and height ${mi("6")} cm. Find its area.</p>${diagramBlock("geometry")}`;
                        ans = `<p>${mi("30")} cm${mi("^2")}</p>`;
                        preview = `Preview: ${mi("\\frac12\\times 10\\times 6")}`;
                        details = {
                            formulasHtml: `<p>Area of triangle = ${mi("\\frac12\\times \\text{base}\\times \\text{height}")}.</p>`,
                            workingLines: [
                                { type: "text", html: `${mi("\\frac12\\times 10\\times 6 = 30")} cm${mi("^2")}.` }
                            ]
                        };
                    }
                    if (i === 7) {
                        prompt = `<p>The ratio of apples to pears is ${mi("3:4")}. There are ${mi("28")} pears. How many apples?</p>${diagramBlock("bars")}`;
                        ans = `<p>${mi("21")}</p>`;
                        preview = `Preview: ${mi("28\\div 4\\times 3")}`;
                        details = {
                            keepInMindHtml: `<p>In a ratio, the numbers show how many equal parts.</p>`,
                            workingLines: [
                                { type: "text", html: `Pears are ${mi("4")} parts, so one part is ${mi("28\\div 4=7")}.` },
                                { type: "text", html: `Apples are ${mi("3")} parts, so apples = ${mi("3\\times 7=21")}.` }
                            ]
                        };
                    }
                    if (i === 11) {
                        prompt = `<p>On a coordinate grid, a point is at ${mi("(2,3)")}. Another point is at ${mi("(6,3)")}. What is the distance between them?</p>${diagramBlock("coord")}`;
                        ans = `<p>${mi("4")}</p>`;
                        preview = `Preview: same y-value, use x difference`;
                        details = {
                            keepInMindHtml: `<p>If the ${mi("y")} values match, the distance is horizontal.</p>`,
                            workingLines: [
                                { type: "text", html: `Distance = ${mi("6-2=4")}.` }
                            ]
                        };
                    }
                    if (i === 14) {
                        prompt = `<p>Complete the table. Then find ${mi("y")} when ${mi("x=4")}.</p>${diagramBlock("grid")}`;
                        ans = `<p>${mi("y=9")}</p>`;
                        preview = `Preview: use the pattern`;
                        details = {
                            formulasHtml: `<p>Rule: ${mi("y=2x+1")}.</p>`,
                            workingLines: [
                                { type: "text", html: `Substitute ${mi("x=4")}: ${mi("y=2\\cdot 4+1=9")}.` }
                            ],
                            altWorkings: [
                                {
                                    label: "Alternative working", lines: [
                                        { type: "text", html: `From the table pattern, ${mi("y")} increases by ${mi("2")} each step, so at ${mi("x=4")}, ${mi("y=9")}.` }
                                    ]
                                }
                            ]
                        };
                    }
                    if (i === 18) {
                        // Parent prompt for nested question (can be short)
                        prompt = `<p>Answer the following.</p>`;
                        ans = `<p>(See parts)</p>`;
                        preview = `Preview: parts (a)(i), (a)(ii), (b)`;
                        details = {
                            keepInMindHtml: `<p>Show each step clearly when simplifying expressions.</p>`,
                            workingLines: [
                                { type: "text", html: `This question has sub-parts: ${mi("18(a)(i)")}, ${mi("18(a)(ii)")}, ${mi("18(b)")}.` }
                            ]
                        };
                    }

                    questions.push({
                        id, depth: 0, promptHtml: prompt, answerHtml: ans,
                        previewHtml: preview, details,
                        expandedByDefault: expandedVariant
                    });

                    // Deep nesting for Q18
                    if (i === 18) {
                        questions.push({
                            id: "18(a)(i)",
                            depth: 1,
                            promptHtml: `<p>Simplify: ${mi("3x+5x")}.</p>`,
                            answerHtml: `<p>${mi("8x")}</p>`,
                            previewHtml: `Preview: add like terms`,
                            details: {
                                workingLines: [
                                    { type: "text", html: `Like terms: ${mi("3x+5x=(3+5)x=8x")}.` }
                                ]
                            },
                            expandedByDefault: expandedVariant
                        });
                        questions.push({
                            id: "18(a)(ii)",
                            depth: 1,
                            promptHtml: `<p>Simplify: ${mi("2(a+4)-3a")}.</p>`,
                            answerHtml: `<p>${mi("8-a")}</p>`,
                            previewHtml: `Preview: expand brackets`,
                            details: {
                                formulasHtml: `<p>Distribute: ${mi("2(a+4)=2a+8")}.</p>`,
                                workingLines: [
                                    { type: "text", html: `${mi("2(a+4)-3a = (2a+8)-3a = 8-a")}.` }
                                ]
                            },
                            expandedByDefault: expandedVariant
                        });
                        questions.push({
                            id: "18(b)",
                            depth: 1,
                            promptHtml: `<p>Solve: ${mi("2x-7=9")}.</p>`,
                            answerHtml: `<p>${mi("x=8")}</p>`,
                            previewHtml: `Preview: isolate ${mi("x")}`,
                            details: {
                                keepInMindHtml: `<p>Do the same operation to both sides.</p>`,
                                workingLines: [
                                    { type: "text", html: `Add ${mi("7")}: ${mi("2x=16")}.` },
                                    { type: "text", html: `Divide by ${mi("2")}: ${mi("x=8")}.` }
                                ],
                                altWorkings: [
                                    {
                                        label: "Alternative working", lines: [
                                            { type: "text", html: `Check: ${mi("2\\cdot 8-7=16-7=9")}.` }
                                        ]
                                    }
                                ]
                            },
                            expandedByDefault: expandedVariant
                        });
                    }
                }

                // Q26–Q35 long algebra, Solution Details collapsed by default (except expanded variant)
                for (let i = 26; i <= 35; i++) {
                    const id = String(i);
                    const longPrompt = `<p>Algebra question.</p>
            <p>Simplify and solve: ${mi("\\frac{3x-5}{2} + \\frac{x+7}{4} = 9")}.</p>`;
                    const ans = `<p>${mi("x=\\frac{37}{7}")} (one valid form)</p>`;
                    const preview = `Preview: common denominator, then solve`;

                    const workingLines = [
                        { type: "text", html: `Start with a common denominator of ${mi("4")}.` },
                        { type: "mathBlock", tex: `\\frac{3x-5}{2} + \\frac{x+7}{4} = 9` },
                        { type: "mathBlock", tex: `\\frac{2(3x-5)}{4} + \\frac{x+7}{4} = 9` },
                        { type: "mathBlock", tex: `\\frac{6x-10+x+7}{4}=9` },
                        { type: "mathBlock", tex: `\\frac{7x-3}{4}=9` },
                        { type: "mathBlock", tex: `7x-3=36` },
                        { type: "mathBlock", tex: `7x=39` },
                        { type: "mathBlock", tex: `x=\\frac{39}{7}` },
                        { type: "text", html: `Depending on the original question version, equivalent answers such as ${mi("\\frac{39}{7}")} may be acceptable.` }
                    ];

                    // Make some of these extremely long (50–60 lines) in Working only
                    let working = workingLines;
                    let keep = null;
                    let formulas = null;
                    let alt = null;

                    if (i === 30) {
                        // Deep nesting inside Q30: create parent + sub-parts
                        questions.push({
                            id: "30",
                            depth: 0,
                            promptHtml: `<p>Long algebra with sub-parts.</p>`,
                            answerHtml: `<p>(See parts)</p>`,
                            previewHtml: `Preview: ${mi("30(a)(i)")}, ${mi("30(a)(ii)")}, ${mi("30(b)")}`,
                            details: {
                                formulasHtml: `<p>Useful: ${mi("\\text{expand brackets}")}, ${mi("\\text{collect like terms}")}, ${mi("\\text{common denominators}")}.</p>`,
                                workingLines: [
                                    { type: "text", html: `This question has deep nesting parts.` }
                                ]
                            },
                            expandedByDefault: expandedVariant
                        });

                        questions.push({
                            id: "30(a)(i)",
                            depth: 1,
                            promptHtml: `<p>Expand: ${mi("(x+3)(x-5)")}.</p>`,
                            answerHtml: `<p>${mi("x^2-2x-15")}</p>`,
                            previewHtml: `Preview: FOIL`,
                            details: {
                                workingLines: [
                                    { type: "mathBlock", tex: `(x+3)(x-5)=x^2-5x+3x-15` },
                                    { type: "mathBlock", tex: `=x^2-2x-15` }
                                ]
                            },
                            expandedByDefault: expandedVariant
                        });

                        questions.push({
                            id: "30(a)(ii)",
                            depth: 1,
                            promptHtml: `<p>Factorise: ${mi("x^2-2x-15")}.</p>`,
                            answerHtml: `<p>${mi("(x+3)(x-5)")}</p>`,
                            previewHtml: `Preview: find two numbers`,
                            details: {
                                keepInMindHtml: `<p>Look for two numbers that multiply to ${mi("-15")} and add to ${mi("-2")}.</p>`,
                                workingLines: [
                                    { type: "text", html: `Numbers are ${mi("3")} and ${mi("-5")}.` },
                                    { type: "mathBlock", tex: `x^2-2x-15=(x+3)(x-5)` }
                                ],
                                altWorkings: [
                                    {
                                        label: "Alternative working", lines: [
                                            { type: "text", html: `Check by expanding: ${mi("(x+3)(x-5)=x^2-2x-15")}.` }
                                        ]
                                    }
                                ]
                            },
                            expandedByDefault: expandedVariant
                        });

                        const longLines = makeWorkingLines(56, "\\frac{7x-3}{4}=9\\Rightarrow 7x-3=36\\Rightarrow x=\\frac{39}{7}");
                        questions.push({
                            id: "30(b)",
                            depth: 1,
                            promptHtml: `<p>Solve: ${mi("\\frac{7x-3}{4}=9")}.</p>`,
                            answerHtml: `<p>${mi("x=\\frac{39}{7}")}</p>`,
                            previewHtml: `Preview: multiply by ${mi("4")}, then solve`,
                            details: {
                                keepInMindHtml: `<p>Multiply both sides before collecting terms to avoid fractions.</p>`,
                                formulasHtml: `<p>Inverse operations: ${mi("\\times 4")}, then ${mi("+3")}, then ${mi("\\div 7")}.</p>`,
                                workingLines: longLines,
                                altWorkings: [
                                    {
                                        label: "Alternative working", lines: [
                                            { type: "mathBlock", tex: `\\frac{7x-3}{4}=9\\Rightarrow 7x-3=36\\Rightarrow 7x=39\\Rightarrow x=\\frac{39}{7}` },
                                            { type: "text", html: `Check by substitution if needed.` }
                                        ]
                                    }
                                ]
                            },
                            expandedByDefault: expandedVariant
                        });

                        // Skip adding the generic Q30 below; continue loop
                        continue;
                    }

                    if (i === 26) {
                        keep = `<p>Take your time with fractions. Keep equations tidy line by line.</p>`;
                    }
                    if (i === 27) {
                        formulas = `<p>Common denominator: ${mi("\\text{lcm}(2,4)=4")}.</p>`;
                    }
                    if (i === 28) {
                        alt = [
                            {
                                label: "Alternative working", lines: [
                                    { type: "text", html: `Convert to decimals: ${mi("\\frac{3x-5}{2}=1.5x-2.5")} and ${mi("\\frac{x+7}{4}=0.25x+1.75")}, then solve.` },
                                    { type: "mathBlock", tex: `(1.5x-2.5)+(0.25x+1.75)=9` },
                                    { type: "mathBlock", tex: `1.75x-0.75=9\\Rightarrow 1.75x=9.75\\Rightarrow x=\\frac{39}{7}` }
                                ]
                            }
                        ];
                    }
                    if (i === 33) {
                        // Extremely long working
                        working = makeWorkingLines(60, "\\frac{6x-10+x+7}{4}=9\\Rightarrow x=\\frac{39}{7}");
                        keep = `<p>Long workings can feel big. Focus on one step per line.</p>`;
                        formulas = `<p>Use ${mi("\\text{common denominators}")} and ${mi("\\text{collect like terms}")}.</p>`;
                    }
                    if (i === 35) {
                        // Multiple valid final answers
                        working = [
                            { type: "text", html: `Solve and present in an equivalent form.` },
                            { type: "mathBlock", tex: `\\frac{7x-3}{4}=9` },
                            { type: "mathBlock", tex: `7x-3=36\\Rightarrow 7x=39\\Rightarrow x=\\frac{39}{7}` },
                            { type: "text", html: `Also acceptable: ${mi("x\\approx 5.5714")} (to 4 d.p.).` }
                        ];
                        alt = [
                            {
                                label: "Alternative working", lines: [
                                    { type: "text", html: `Write ${mi("39/7")} as a mixed number: ${mi("5\\frac{4}{7}")}.` }
                                ]
                            }
                        ];
                    }

                    questions.push({
                        id,
                        depth: 0,
                        promptHtml: longPrompt,
                        answerHtml: ans,
                        previewHtml: preview,
                        details: {
                            keepInMindHtml: keep,
                            formulasHtml: formulas,
                            workingLines: working,
                            altWorkings: alt
                        },
                        expandedByDefault: expandedVariant
                    });
                }

                return {
                    key: expandedVariant ? "standardExpanded" : "standard",
                    title: expandedVariant ? "Standard (Workings Expanded)" : "Standard paper",
                    meta: expandedVariant
                        ? "35 questions. Same as Standard, but all workings start expanded (dataset variant only)."
                        : "35 questions. Q26–Q35 include long algebra (Solution Details collapsed by default).",
                    sections: null,
                    questions,
                    defaultExpand: expandedVariant
                };
            }

            function buildDiagramHeavyPaper() {
                const questions = [];
                const diagramAt = new Set([2, 4, 6, 8, 11, 13, 16, 19]); // 8 questions with diagrams
                const diagramCycle = ["geometry", "bars", "coord", "grid"];

                for (let i = 1; i <= 20; i++) {
                    const id = String(i);
                    const d = diagramAt.has(i);
                    const diagType = diagramCycle[(i - 1) % diagramCycle.length];

                    let prompt = `<p>Question ${mi(String(i))}: Work with numbers and shapes.</p>`;
                    if (d) {
                        prompt += `<p>Use the diagram below.</p>${diagramBlock(diagType)}`;
                    } else {
                        prompt += `<p>Compute ${mi(String(i) + "\\times " + String((i % 7) + 3))}.</p>`;
                    }

                    const ansVal = d ? mi(String((i % 9) + 5)) : mi(String(i * ((i % 7) + 3)));
                    const ans = `<p>${ansVal}</p>`;

                    const details = {
                        keepInMindHtml: d ? `<p>Read labels carefully before calculating.</p>` : null,
                        formulasHtml: d && (diagType === "geometry") ? `<p>Use relevant area/perimeter formulas as needed.</p>` : null,
                        workingLines: d
                            ? [
                                { type: "text", html: `Identify the key information from the diagram.` },
                                { type: "text", html: `Write a short equation, then solve.` },
                                { type: "mathBlock", tex: `\\text{Example: } a+b=c` },
                                { type: "text", html: `Substitute values and calculate.` }
                            ]
                            : [
                                { type: "text", html: `${mi(String(i))}\\times ${mi(String((i % 7) + 3))} = ${ansVal}.` }
                            ],
                        altWorkings: d && (i % 2 === 0)
                            ? [{
                                label: "Alternative working", lines: [
                                    { type: "text", html: `Use a different method (e.g. break into parts) to reach the same answer.` },
                                    { type: "mathBlock", tex: `(m+n)k = mk+nk` }
                                ]
                            }]
                            : null
                    };

                    questions.push({
                        id, depth: 0,
                        promptHtml: prompt,
                        answerHtml: ans,
                        previewHtml: d ? `Preview: set up from the diagram` : `Preview: multiply`,
                        details,
                        expandedByDefault: false
                    });
                }

                return {
                    key: "diagramHeavy",
                    title: "Diagram-heavy paper",
                    meta: "20 questions. 8 questions include diagrams (inline SVG placeholders).",
                    sections: null,
                    questions,
                    defaultExpand: false
                };
            }

            function buildSectionedPaper() {
                const sections = [
                    { label: "A", count: 35, kind: "smallMedium" },
                    { label: "B", count: 8, kind: "medium" },
                    { label: "C", count: 6, kind: "veryLong" }
                ];

                const questions = [];
                let qNum = 1;

                function pushSectionHeader(label) {
                    questions.push({ _sectionHeader: true, label });
                }

                // Section A: 35 small/medium
                pushSectionHeader("A");
                for (let i = 0; i < 35; i++) {
                    const id = String(qNum++);
                    const base = 10 + (i % 9);
                    const prompt = `<p>Section A: Calculate ${mi(String(base))} - ${mi(String(i % 7))}.</p>`;
                    const ans = `<p>${mi(String(base - (i % 7)))}</p>`;
                    const details = {
                        workingLines: [{ type: "text", html: `${mi(String(base - (i % 7)))}.` }]
                    };

                    // Sprinkle solution variants coverage (Keep in mind / Formulas / Alternative)
                    if (i === 2) {
                        details.keepInMindHtml = `<p>Check for borrowing when subtracting.</p>`;
                    }
                    if (i === 6) {
                        details.formulasHtml = `<p>Order of operations: brackets first, then multiplication/division, then addition/subtraction.</p>`;
                    }
                    if (i === 9) {
                        details.altWorkings = [{
                            label: "Alternative working", lines: [
                                { type: "text", html: `Use a number line jump method to subtract.` }
                            ]
                        }];
                    }
                    if (i === 12) {
                        details.keepInMindHtml = `<p>Keep fractions in simplest form.</p>`;
                        details.formulasHtml = `<p>Simplify: divide top and bottom by the same number.</p>`;
                        details.altWorkings = [{
                            label: "Alternative working", lines: [
                                { type: "mathBlock", tex: `\\frac{12}{18}=\\frac{2}{3}` },
                                { type: "text", html: `Divide by ${mi("6")} on top and bottom.` }
                            ]
                        }];
                    }

                    questions.push({
                        id, depth: 0,
                        promptHtml: prompt,
                        answerHtml: ans,
                        previewHtml: `Preview: subtract`,
                        details,
                        expandedByDefault: false
                    });

                    // Include one deep nesting set in Section A too
                    if (id === "18") {
                        questions.push({
                            id: "18(a)(i)",
                            depth: 1,
                            promptHtml: `<p>Write ${mi("0.25")} as a fraction in simplest form.</p>`,
                            answerHtml: `<p>${mi("\\frac{1}{4}")}</p>`,
                            previewHtml: `Preview: decimals to fractions`,
                            details: {
                                keepInMindHtml: `<p>${mi("0.25")} means 25 hundredths.</p>`,
                                workingLines: [
                                    { type: "mathBlock", tex: `0.25=\\frac{25}{100}=\\frac{1}{4}` }
                                ]
                            },
                            expandedByDefault: false
                        });
                        questions.push({
                            id: "18(a)(ii)",
                            depth: 1,
                            promptHtml: `<p>Find ${mi("\\frac{1}{4}")} of ${mi("36")}.</p>`,
                            answerHtml: `<p>${mi("9")}</p>`,
                            previewHtml: `Preview: divide by 4`,
                            details: {
                                workingLines: [
                                    { type: "text", html: `${mi("36\\div 4=9")}.` }
                                ]
                            },
                            expandedByDefault: false
                        });
                        questions.push({
                            id: "18(b)",
                            depth: 1,
                            promptHtml: `<p>Explain why ${mi("\\frac{2}{8}")} equals ${mi("\\frac{1}{4}")}.</p>`,
                            answerHtml: `<p>They are equivalent fractions.</p>`,
                            previewHtml: `Preview: simplify`,
                            details: {
                                formulasHtml: `<p>Divide numerator and denominator by the same number.</p>`,
                                workingLines: [
                                    { type: "mathBlock", tex: `\\frac{2}{8}=\\frac{2\\div 2}{8\\div 2}=\\frac{1}{4}` }
                                ],
                                altWorkings: [{
                                    label: "Alternative working", lines: [
                                        { type: "text", html: `Both fractions represent the same part of a whole when you split the whole into equal parts.` }
                                    ]
                                }]
                            },
                            expandedByDefault: false
                        });
                    }
                }

                // Section B: 8 medium
                pushSectionHeader("B");
                for (let i = 0; i < 8; i++) {
                    const id = String(qNum++);
                    const prompt = `<p>Section B: A train travels ${mi(String(60 + i * 15))} km in ${mi(String(2 + i))} hours. Find the speed in km/h.</p>`;
                    const speed = (60 + i * 15) / (2 + i);
                    const ans = `<p>${mi(String(speed))} km/h</p>`;
                    const details = {
                        keepInMindHtml: `<p>Speed = distance ÷ time.</p>`,
                        formulasHtml: `<p>${mi("v=\\frac{d}{t}")}.</p>`,
                        workingLines: [
                            { type: "mathBlock", tex: `v=\\frac{${60 + i * 15}}{${2 + i}}=${speed}` }
                        ]
                    };
                    questions.push({
                        id, depth: 0,
                        promptHtml: prompt,
                        answerHtml: ans,
                        previewHtml: `Preview: divide distance by time`,
                        details,
                        expandedByDefault: false
                    });
                }

                // Section C: 6 very long Solution Details (collapsed by default)
                pushSectionHeader("C");
                for (let i = 0; i < 6; i++) {
                    const id = String(qNum++);
                    const prompt = `<p>Section C: Long working problem.</p>
            <p>Solve and show full working: ${mi("\\frac{5x-2}{3} - \\frac{2x+1}{6} = 4")}.</p>`;
                    const ans = `<p>${mi("x=\\frac{29}{4}")} (one valid form)</p>`;
                    const lines = makeWorkingLines(58, "\\frac{5x-2}{3} - \\frac{2x+1}{6} = 4\\Rightarrow x=\\frac{29}{4}");

                    const details = {
                        keepInMindHtml: `<p>Keep your fractions aligned. A single mistake can change everything.</p>`,
                        formulasHtml: `<p>Use a common denominator of ${mi("6")}.</p>`,
                        workingLines: [
                            { type: "text", html: `Start from the equation.` },
                            { type: "mathBlock", tex: `\\frac{5x-2}{3} - \\frac{2x+1}{6} = 4` },
                            { type: "mathBlock", tex: `\\frac{2(5x-2)}{6} - \\frac{2x+1}{6} = 4` },
                            { type: "mathBlock", tex: `\\frac{10x-4-(2x+1)}{6}=4` },
                            { type: "mathBlock", tex: `\\frac{8x-5}{6}=4` },
                            { type: "mathBlock", tex: `8x-5=24` },
                            { type: "mathBlock", tex: `8x=29` },
                            { type: "mathBlock", tex: `x=\\frac{29}{8}` },
                            ...lines
                        ],
                        altWorkings: [
                            {
                                label: "Alternative working", lines: [
                                    { type: "text", html: `You can also multiply the entire equation by ${mi("6")} first to remove fractions.` },
                                    { type: "mathBlock", tex: `6\\left(\\frac{5x-2}{3}\\right)-6\\left(\\frac{2x+1}{6}\\right)=6\\cdot 4` },
                                    { type: "mathBlock", tex: `2(5x-2)-(2x+1)=24` }
                                ]
                            }
                        ]
                    };

                    questions.push({
                        id, depth: 0,
                        promptHtml: prompt,
                        answerHtml: ans,
                        previewHtml: `Preview: clear fractions, then solve`,
                        details,
                        expandedByDefault: false
                    });
                }

                return {
                    key: "sectioned",
                    title: "Sectioned paper",
                    meta: "Sections A/B/C. Section C has very long Solution Details (collapsed by default).",
                    sections,
                    questions,
                    defaultExpand: false
                };
            }

            const datasets = {
                short: buildShortPaper,
                standard: () => buildStandardPaper(false),
                standardExpanded: () => buildStandardPaper(true),
                diagramHeavy: buildDiagramHeavyPaper,
                sectioned: buildSectionedPaper
            };

            // ---------- Rendering ----------
            let currentDataset = null;
            let io = null;

            function clearIntersectionObserver() {
                if (io) {
                    io.disconnect();
                    io = null;
                }
            }

            function buildNav(items) {
                navList.innerHTML = "";
                drawerNavList.innerHTML = "";

                for (const item of items) {
                    if (item.type === "sep") {
                        const liSep = document.createElement("li");
                        liSep.className = "navSep";
                        liSep.textContent = item.label;
                        navList.appendChild(liSep);

                        const dSep = document.createElement("li");
                        dSep.className = "drawerSep";
                        dSep.textContent = item.label;
                        drawerNavList.appendChild(dSep);
                        continue;
                    }

                    const li = document.createElement("li");
                    li.className = "navItem";
                    const a = document.createElement("a");
                    a.className = "navLink";
                    a.href = "#" + item.anchor;
                    a.textContent = item.label; // question identifiers only
                    a.setAttribute("data-anchor", item.anchor);
                    a.addEventListener("click", (e) => {
                        // Navigation must be non-destructive: do not change expand/collapse states.
                        // Default anchor jump only.
                        closeDrawer();
                    });
                    li.appendChild(a);
                    navList.appendChild(li);

                    const dli = document.createElement("li");
                    const da = document.createElement("a");
                    da.className = "drawerNavLink";
                    da.href = "#" + item.anchor;
                    da.textContent = item.label;
                    da.setAttribute("data-anchor", item.anchor);
                    da.addEventListener("click", () => closeDrawer());
                    dli.appendChild(da);
                    drawerNavList.appendChild(dli);
                }
            }

            function renderWorkingLines(lines) {
                const wrap = document.createElement("div");
                wrap.className = "lines";
                for (const ln of (lines || [])) {
                    const div = document.createElement("div");
                    div.className = "line";
                    if (ln.type === "mathBlock") {
                        div.innerHTML = mb(ln.tex);
                    } else {
                        div.innerHTML = ln.html;
                    }
                    wrap.appendChild(div);
                }
                return wrap;
            }

            function renderQuestion(q) {
                const container = document.createElement("section");
                const anchor = makeQIdAnchor(q.id);
                container.className = "q " + (q.depth === 2 ? "depth2" : q.depth === 1 ? "depth1" : "depth0");
                container.id = anchor;
                container.setAttribute("data-qid", q.id);

                const inner = document.createElement("div");
                inner.className = "qInner";

                const header = document.createElement("div");
                header.className = "qHeader";

                const qid = document.createElement("div");
                qid.className = "qid";
                qid.textContent = q.id;

                const prompt = document.createElement("div");
                prompt.className = "qprompt";
                prompt.innerHTML = q.promptHtml || "";

                header.appendChild(qid);
                header.appendChild(prompt);

                // Answer
                const answer = document.createElement("div");
                answer.className = "answer";
                const aLabel = document.createElement("div");
                aLabel.className = "answerLabel";
                aLabel.textContent = "Answer";
                const aValue = document.createElement("div");
                aValue.className = "answerValue";
                aValue.innerHTML = q.answerHtml || "";
                answer.appendChild(aLabel);
                answer.appendChild(aValue);

                // Disclosure + preview + solution
                const disclosureRow = document.createElement("div");
                disclosureRow.className = "disclosureRow";

                const btn = document.createElement("button");
                btn.type = "button";
                btn.className = "toggleBtn";
                btn.setAttribute("aria-expanded", "false");
                btn.setAttribute("aria-controls", anchor + "-solution");
                btn.textContent = "Show working";

                const hint = document.createElement("div");
                hint.className = "toggleHint";
                hint.textContent = "Solution details";

                disclosureRow.appendChild(btn);
                disclosureRow.appendChild(hint);

                const preview = document.createElement("div");
                preview.className = "preview";
                preview.innerHTML = q.previewHtml || "Preview: working shown here when expanded.";

                const solution = document.createElement("div");
                solution.className = "solution";
                solution.id = anchor + "-solution";
                solution.hidden = true;

                // Solution blocks in fixed order
                const blocks = [];
                if (q.details && q.details.keepInMindHtml) {
                    blocks.push({
                        label: "Keep in mind",
                        bodyHtml: q.details.keepInMindHtml
                    });
                }
                if (q.details && q.details.formulasHtml) {
                    blocks.push({
                        label: "Formulas used",
                        bodyHtml: q.details.formulasHtml
                    });
                }

                // Working (primary)
                blocks.push({
                    label: "Working",
                    bodyLines: (q.details && q.details.workingLines) ? q.details.workingLines : [{ type: "text", html: "(Working content)" }]
                });

                // Alternative working (0+)
                if (q.details && Array.isArray(q.details.altWorkings)) {
                    for (const alt of q.details.altWorkings) {
                        blocks.push({
                            label: "Alternative working",
                            bodyLines: alt.lines || []
                        });
                    }
                }

                for (const b of blocks) {
                    const block = document.createElement("div");
                    block.className = "solutionBlock";

                    const lbl = document.createElement("div");
                    lbl.className = "sLabel";
                    lbl.textContent = b.label;

                    const body = document.createElement("div");
                    body.className = "sBody";

                    if (b.bodyHtml) {
                        body.innerHTML = b.bodyHtml;
                    } else if (b.bodyLines) {
                        body.appendChild(renderWorkingLines(b.bodyLines));
                    }

                    block.appendChild(lbl);
                    block.appendChild(body);
                    solution.appendChild(block);
                }

                // Expand/collapse (inline only; no cross-question effects; no forced scrolling)
                const expandedByDefault = !!q.expandedByDefault;
                function setExpanded(next) {
                    btn.setAttribute("aria-expanded", String(next));
                    btn.textContent = next ? "Hide working" : "Show working";
                    solution.hidden = !next;
                    preview.style.display = next ? "none" : "block";
                }
                btn.addEventListener("click", () => {
                    const now = btn.getAttribute("aria-expanded") === "true";
                    setExpanded(!now);
                });

                // Apply default expanded state per dataset
                setExpanded(expandedByDefault);

                inner.appendChild(header);
                inner.appendChild(answer);
                inner.appendChild(disclosureRow);
                inner.appendChild(preview);
                inner.appendChild(solution);
                container.appendChild(inner);

                return { node: container, anchor };
            }

            function renderPaper(datasetKey) {
                clearIntersectionObserver();

                // Build dataset fresh on each switch to ensure defaults are applied (no state carry-over)
                currentDataset = datasets[datasetKey]();

                paperMeta.textContent = currentDataset.meta;

                // Build content & nav model
                paperContent.innerHTML = "";

                const navItems = [];
                for (const item of currentDataset.questions) {
                    if (item && item._sectionHeader) {
                        // Paper section header
                        const sh = document.createElement("div");
                        sh.className = "sectionHeader";
                        sh.textContent = item.label;
                        paperContent.appendChild(sh);

                        // Nav separator (non-clickable plain text)
                        navItems.push({ type: "sep", label: item.label });
                        continue;
                    }

                    const { node, anchor } = renderQuestion(item);
                    paperContent.appendChild(node);

                    navItems.push({ type: "q", label: item.id, anchor });
                }

                buildNav(navItems);

                // Render KaTeX
                renderMath();

                // Active nav highlight based on scroll position
                setupActiveNavObserver();

                // Ensure "Jump to" button on desktop is present but doesn't imply task/progress
                // (kept minimal by design)
            }

            function setupActiveNavObserver() {
                const anchors = $$(".q", paperContent);
                if (!anchors.length) return;

                const linkByAnchor = new Map();
                for (const a of $$(".navLink", navList)) {
                    linkByAnchor.set(a.getAttribute("data-anchor"), a);
                }
                const drawerLinkByAnchor = new Map();
                for (const a of $$(".drawerNavLink", drawerNavList)) {
                    drawerLinkByAnchor.set(a.getAttribute("data-anchor"), a);
                }

                function clearCurrent() {
                    for (const a of linkByAnchor.values()) a.setAttribute("aria-current", "false");
                    for (const a of drawerLinkByAnchor.values()) a.setAttribute("aria-current", "false");
                }

                clearCurrent();

                io = new IntersectionObserver((entries) => {
                    // Choose the entry closest to top that is intersecting
                    const visible = entries.filter(e => e.isIntersecting);
                    if (!visible.length) return;

                    visible.sort((a, b) => Math.abs(a.boundingClientRect.top) - Math.abs(b.boundingClientRect.top));
                    const top = visible[0];
                    const id = top.target.id;

                    clearCurrent();
                    const navA = linkByAnchor.get(id);
                    const drawerA = drawerLinkByAnchor.get(id);
                    if (navA) navA.setAttribute("aria-current", "true");
                    if (drawerA) drawerA.setAttribute("aria-current", "true");
                }, {
                    root: null,
                    threshold: [0.15, 0.25, 0.35],
                    rootMargin: "-20% 0px -70% 0px"
                });

                for (const el of anchors) io.observe(el);
            }

            // ---------- Mobile drawer behavior (no background interaction when open) ----------
            let lastFocused = null;

            function openDrawer() {
                lastFocused = document.activeElement;
                document.body.classList.add("nav-open");
                overlay.classList.add("open");
                overlay.setAttribute("aria-hidden", "false");
                drawer.classList.add("open");

                // Try to prevent background keyboard focus
                $("#appFrame").setAttribute("aria-hidden", "true");
                $("#topbar").setAttribute("aria-hidden", "true");

                // Focus first link if possible
                const first = drawerNavList.querySelector("a");
                (first || closeNavBtn).focus({ preventScroll: true });
            }

            function closeDrawer() {
                drawer.classList.remove("open");
                overlay.classList.remove("open");
                overlay.setAttribute("aria-hidden", "true");
                document.body.classList.remove("nav-open");

                $("#appFrame").removeAttribute("aria-hidden");
                $("#topbar").removeAttribute("aria-hidden");

                if (lastFocused && typeof lastFocused.focus === "function") {
                    lastFocused.focus({ preventScroll: true });
                }
            }

            function isMobileLayout() {
                return window.matchMedia("(max-width: 860px)").matches;
            }

            function openNav() {
                if (isMobileLayout()) {
                    openDrawer();
                } else {
                    // Desktop: focus navigation list (sticky rail)
                    navList.focus({ preventScroll: true });
                }
            }

            openNavBtn.addEventListener("click", openNav);
            fabOpenNavBtn.addEventListener("click", openNav);
            closeNavBtn.addEventListener("click", closeDrawer);
            overlay.addEventListener("click", closeDrawer);

            document.addEventListener("keydown", (e) => {
                if (e.key === "Escape" && drawer.classList.contains("open")) {
                    e.preventDefault();
                    closeDrawer();
                }
                // Basic focus trap inside drawer while open
                if (drawer.classList.contains("open") && e.key === "Tab") {
                    const focusables = $$("button, a[href], select, [tabindex]:not([tabindex='-1'])", drawer)
                        .filter(el => !el.hasAttribute("disabled") && el.offsetParent !== null);
                    if (!focusables.length) return;

                    const first = focusables[0];
                    const last = focusables[focusables.length - 1];
                    if (e.shiftKey && document.activeElement === first) {
                        e.preventDefault(); last.focus();
                    } else if (!e.shiftKey && document.activeElement === last) {
                        e.preventDefault(); first.focus();
                    }
                }
            });

            // ---------- Paper switching ----------
            paperSelect.addEventListener("change", () => {
                renderPaper(paperSelect.value);
            });

            // Initial render
            renderPaper(paperSelect.value);

            // If KaTeX loads after initial paint (defer), re-render once it becomes available
            // without hiding content if it fails.
            let katexRetry = 0;
            const katexWatch = setInterval(() => {
                if (window.katex && typeof window.katex.render === "function") {
                    renderMath();
                    clearInterval(katexWatch);
                } else {
                    katexRetry++;
                    if (katexRetry > 30) clearInterval(katexWatch);
                }
            }, 150);

        })();
    </script>
</body>

</html>