<!-- index.html -->
<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RTQ – Maths Paper Solution Viewer (Grayscale Stress Test)</title>

  <!-- KaTeX (CDN) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css">

  <style>
    :root {
      --bg: #fff;
      --fg: #111;
      --muted: #666;
      --hair: #ddd;

      --frame-max: 1100px;
      --gutter: 16px;

      --nav-w: 160px;

      --space-xxl: 40px;
      /* between top-level questions (largest) */
      --space-xl: 28px;
      --space-lg: 18px;
      --space-md: 12px;
      --space-sm: 8px;
      --space-xs: 6px;
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      height: 100%;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--fg);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      line-height: 1.35;
      overflow-x: hidden;
      /* prevent page-level horizontal scroll */
    }

    a {
      color: inherit;
      text-decoration: none;
    }

    button,
    select {
      font: inherit;
    }

    /* Top controls */
    header {
      border-bottom: 1px solid var(--hair);
      background: var(--bg);
    }

    .topbar {
      max-width: var(--frame-max);
      margin: 0 auto;
      padding: 12px var(--gutter);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .topbar .title {
      font-size: 14px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .topbar .controls {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    label {
      font-size: 13px;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    select {
      border: 1px solid var(--hair);
      background: #fff;
      color: var(--fg);
      padding: 6px 8px;
      border-radius: 6px;
      min-width: 240px;
    }

    /* Centered frame: nav + content columns */
    .frame {
      max-width: var(--frame-max);
      margin: 0 auto;
      padding: 0 var(--gutter);
      display: grid;
      grid-template-columns: var(--nav-w) 1fr;
      gap: 22px;
      align-items: start;
    }

    nav {
      padding: 18px 0 40px 0;
      position: sticky;
      top: 0;
      /* sticky inside page */
      align-self: start;
    }

    .nav-inner {
      padding-right: 10px;
      border-right: 1px solid var(--hair);
    }

    .nav-title {
      font-size: 12px;
      color: var(--muted);
      margin: 0 0 10px 0;
      letter-spacing: .02em;
    }

    /* Scrollable navigation without visible scrollbars (only when needed) */
    .nav-list {
      max-height: calc(100vh - 90px);
      overflow: auto;
      padding: 0;
      margin: 0;
      list-style: none;

      scrollbar-width: none;
      /* Firefox */
      -ms-overflow-style: none;
      /* IE/Edge legacy */
    }

    .nav-list::-webkit-scrollbar {
      display: none;
    }

    /* WebKit/Blink */

    .nav-sep {
      font-size: 12px;
      color: var(--muted);
      padding: 8px 0 6px 0;
    }

    .nav-item {
      display: block;
      width: 100%;
      text-align: left;
      border: 0;
      background: transparent;
      padding: 6px 0;
      color: var(--muted);
      font-size: 13px;
      border-radius: 6px;
      cursor: pointer;
    }

    .nav-item:hover {
      color: var(--fg);
    }

    .nav-item[aria-current="true"] {
      color: var(--fg);
      text-decoration: underline;
      text-underline-offset: 3px;
    }

    main {
      padding: 22px 0 70px 0;
      min-width: 0;
    }

    /* Section headings inside paper (not containers) */
    .section-header {
      margin: 26px 0 10px 0;
      font-size: 13px;
      color: var(--muted);
      letter-spacing: .04em;
      text-transform: uppercase;
    }

    /* Question units: whitespace-driven grouping (no cards) */
    .q {
      margin: 0;
      padding: 0;
    }

    .q.top {
      margin-top: var(--space-xxl);
      padding-top: 0;
    }

    .q:first-child.top {
      margin-top: 0;
    }

    /* Nesting via indentation only */
    .q.depth-0 {
      padding-left: 0;
    }

    .q.depth-1 {
      padding-left: 14px;
    }

    .q.depth-2 {
      padding-left: 28px;
    }

    .q.depth-3 {
      padding-left: 42px;
    }

    .q-head {
      display: flex;
      gap: 10px;
      align-items: flex-start;
    }

    .qid {
      flex: 0 0 auto;
      min-width: 52px;
      font-size: 14px;
      color: var(--fg);
    }

    .q-prompt {
      flex: 1 1 auto;
      min-width: 0;
      font-size: 15px;
    }

    .q-prompt p {
      margin: 0 0 var(--space-sm) 0;
    }

    .answer {
      margin-top: var(--space-sm);
      display: flex;
      gap: 10px;
      align-items: baseline;
    }

    .answer .label {
      font-size: 13px;
      color: var(--muted);
      min-width: 52px;
    }

    .answer .val {
      font-size: 14px;
      color: var(--fg);
      min-width: 0;
    }

    /* Solution Details: single inline toggle */
    details.sd {
      margin-top: var(--space-sm);
      padding-left: 62px;
      /* aligns with prompt text column */
    }

    details.sd>summary {
      list-style: none;
      cursor: pointer;
      display: inline;
      color: var(--muted);
      font-size: 13px;
      outline: none;
    }

    details.sd>summary::-webkit-details-marker {
      display: none;
    }

    details.sd>summary:focus {
      outline: 2px solid #999;
      outline-offset: 2px;
      border-radius: 6px;
    }

    .sd-preview {
      margin-top: var(--space-xs);
      color: var(--muted);
      font-size: 13px;
      max-width: 70ch;
    }

    details.sd[open] .sd-preview {
      display: none;
    }

    .sd-body {
      margin-top: var(--space-md);
      color: var(--fg);
      font-size: 14px;
    }

    .sd-block {
      margin-top: var(--space-md);
    }

    .sd-block h4 {
      margin: 0 0 var(--space-xs) 0;
      font-size: 13px;
      color: var(--muted);
      font-weight: 600;
    }

    .sd-block p {
      margin: 0 0 var(--space-sm) 0;
      color: var(--fg);
    }

    /* Diagrams: inline SVG placeholders inside question block */
    .diagram {
      margin: var(--space-sm) 0 var(--space-sm) 0;
      max-width: 520px;
    }

    svg {
      width: 100%;
      height: auto;
      display: block;
    }

    .svg-stroke {
      stroke: #111;
      stroke-width: 2;
      fill: none;
    }

    .svg-lite {
      stroke: #777;
      stroke-width: 1.5;
      fill: none;
    }

    .svg-fill {
      fill: #eee;
      stroke: #111;
      stroke-width: 1.5;
    }

    .svg-text {
      fill: #111;
      font-size: 12px;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }

    /* KaTeX overflow rules */
    .math-inline {
      white-space: nowrap;
    }

    .math-block,
    .math-line {
      overflow-x: auto;
      /* only math can scroll horizontally if needed */
      overflow-y: hidden;
      max-width: 100%;
      padding: 4px 0;
    }

    .math-block {
      margin: 8px 0;
    }

    .math-line {
      margin: 2px 0;
    }

    /* Mobile nav control */
    .jump-btn {
      display: none;
      position: fixed;
      right: 12px;
      bottom: 12px;
      z-index: 50;
      border: 1px solid var(--hair);
      background: #fff;
      color: var(--fg);
      border-radius: 999px;
      padding: 10px 14px;
      font-size: 13px;
      cursor: pointer;
      box-shadow: 0 2px 10px rgba(0, 0, 0, .08);
    }

    .jump-btn:focus {
      outline: 2px solid #999;
      outline-offset: 3px;
    }

    /* Dialog (mobile drawer/overlay navigation) */
    dialog {
      border: 1px solid var(--hair);
      border-radius: 10px;
      padding: 0;
      width: min(520px, calc(100vw - 24px));
      max-height: min(82vh, 640px);
    }

    dialog::backdrop {
      background: rgba(0, 0, 0, .25);
    }

    .dlg-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 12px 12px;
      border-bottom: 1px solid var(--hair);
    }

    .dlg-head .dlg-title {
      font-size: 13px;
      color: var(--muted);
    }

    .dlg-close {
      border: 1px solid var(--hair);
      background: #fff;
      border-radius: 8px;
      padding: 6px 10px;
      font-size: 13px;
      cursor: pointer;
    }

    .dlg-body {
      padding: 10px 12px 12px 12px;
      overflow: auto;

      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .dlg-body::-webkit-scrollbar {
      display: none;
    }

    .dlg-body .nav-item {
      padding: 10px 0;
      font-size: 14px;
    }

    /* Responsive: collapse desktop nav column into mobile overlay */
    @media (max-width: 860px) {
      .frame {
        grid-template-columns: 1fr;
      }

      nav {
        display: none;
        /* hide rail */
      }

      main {
        padding-top: 18px;
      }

      .jump-btn {
        display: block;
      }

      details.sd {
        padding-left: 0;
      }

      .answer .label,
      .qid {
        min-width: 48px;
      }

      .q.depth-1 {
        padding-left: 10px;
      }

      .q.depth-2 {
        padding-left: 20px;
      }

      .q.depth-3 {
        padding-left: 30px;
      }
    }

    /* Reduce indentation to preserve reading width on very small screens */
    @media (max-width: 420px) {
      .q.depth-1 {
        padding-left: 8px;
      }

      .q.depth-2 {
        padding-left: 14px;
      }

      .q.depth-3 {
        padding-left: 20px;
      }

      select {
        min-width: 200px;
      }
    }
  </style>
</head>

<body>
  <header>
    <div class="topbar">
      <div class="title">RTQ – Maths Paper Solution Viewer (prototype)</div>
      <div class="controls">
        <label>
          Paper Selector
          <select id="paperSelector" aria-label="Paper Selector"></select>
        </label>
      </div>
    </div>
  </header>

  <button class="jump-btn" id="jumpBtn" type="button" aria-haspopup="dialog" aria-controls="navDialog">Jump to</button>

  <dialog id="navDialog" aria-label="Paper navigation">
    <div class="dlg-head">
      <div class="dlg-title">Jump to</div>
      <button class="dlg-close" id="navCloseBtn" type="button">Close</button>
    </div>
    <div class="dlg-body" id="navDialogBody"></div>
  </dialog>

  <div class="frame" id="frame">
    <nav aria-label="Question navigation">
      <div class="nav-inner">
        <div class="nav-title">Questions</div>
        <ul class="nav-list" id="navList"></ul>
      </div>
    </nav>

    <main id="paper" aria-label="Paper content"></main>
  </div>

  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js"></script>

  <script>
    // ---------- Utilities ----------
    const $ = (sel, root = document) => root.querySelector(sel);

    function slugifyQid(qid) {
      return String(qid)
        .trim()
        .toLowerCase()
        .replace(/\s+/g, '-')
        .replace(/[^\w\-]+/g, '-')
        .replace(/\-+/g, '-')
        .replace(/^\-|\-$/g, '');
    }

    function el(tag, attrs = {}, children = []) {
      const node = document.createElement(tag);
      for (const [k, v] of Object.entries(attrs)) {
        if (k === "class") node.className = v;
        else if (k === "html") node.innerHTML = v;
        else if (k.startsWith("data-")) node.setAttribute(k, v);
        else if (k === "text") node.textContent = v;
        else if (k === "aria-current") node.setAttribute("aria-current", v);
        else node.setAttribute(k, v);
      }
      for (const c of children) {
        if (c == null) continue;
        node.appendChild(typeof c === "string" ? document.createTextNode(c) : c);
      }
      return node;
    }

    function mkInlineMath(math) {
      return `<span class="math-inline" data-math="${escapeAttr(math)}">${escapeHtml(math)}</span>`;
    }
    function mkBlockMath(math) {
      return `<div class="math-block" data-math="${escapeAttr(math)}" data-display="true">${escapeHtml(math)}</div>`;
    }
    function mkMathLine(math) {
      return `<div class="math-line" data-math="${escapeAttr(math)}" data-display="true">${escapeHtml(math)}</div>`;
    }
    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }
    function escapeAttr(s) {
      return escapeHtml(s).replaceAll("\n", "&#10;");
    }

    function setSummaryText(detailsEl) {
      const sum = detailsEl.querySelector("summary");
      if (!sum) return;
      sum.textContent = detailsEl.open ? "Hide working" : "Show working";
    }

    // ---------- Diagram library (4 reusable types) ----------
    function svgGeometry() {
      return `
        <svg viewBox="0 0 260 170" role="img" aria-label="Geometry diagram">
          <circle cx="190" cy="55" r="26" class="svg-lite"></circle>
          <path d="M40 140 L120 30 L220 140 Z" class="svg-stroke"></path>
          <text x="115" y="22" class="svg-text">A</text>
          <text x="30" y="154" class="svg-text">B</text>
          <text x="223" y="154" class="svg-text">C</text>
          <text x="176" y="58" class="svg-text">O</text>
          <path d="M120 30 L190 55" class="svg-lite"></path>
          <text x="135" y="60" class="svg-text">x</text>
        </svg>
      `;
    }
    function svgRatioBars() {
      return `
        <svg viewBox="0 0 320 140" role="img" aria-label="Ratio bars diagram">
          <rect x="20" y="30" width="280" height="30" class="svg-fill"></rect>
          <line x1="110" y1="30" x2="110" y2="60" class="svg-stroke"></line>
          <line x1="200" y1="30" x2="200" y2="60" class="svg-stroke"></line>
          <text x="55" y="52" class="svg-text">A</text>
          <text x="145" y="52" class="svg-text">A</text>
          <text x="235" y="52" class="svg-text">B</text>

          <rect x="20" y="85" width="210" height="30" class="svg-fill"></rect>
          <line x1="90" y1="85" x2="90" y2="115" class="svg-stroke"></line>
          <line x1="160" y1="85" x2="160" y2="115" class="svg-stroke"></line>
          <text x="50" y="107" class="svg-text">?</text>
          <text x="120" y="107" class="svg-text">?</text>
          <text x="190" y="107" class="svg-text">?</text>
        </svg>
      `;
    }
    function svgCoordinateGrid() {
      return `
        <svg viewBox="0 0 320 200" role="img" aria-label="Coordinate grid diagram">
          <rect x="30" y="20" width="260" height="160" class="svg-lite"></rect>
          <line x1="30" y1="100" x2="290" y2="100" class="svg-stroke"></line>
          <line x1="160" y1="20" x2="160" y2="180" class="svg-stroke"></line>
          <path d="M60 150 L120 120 L200 80 L260 50" class="svg-stroke"></path>
          <circle cx="120" cy="120" r="4" fill="#111"></circle>
          <circle cx="200" cy="80" r="4" fill="#111"></circle>
          <text x="292" y="104" class="svg-text">x</text>
          <text x="156" y="16" class="svg-text">y</text>
        </svg>
      `;
    }
    function svgTableGrid() {
      return `
        <svg viewBox="0 0 300 190" role="img" aria-label="Table diagram">
          <rect x="30" y="30" width="240" height="130" class="svg-lite"></rect>
          <line x1="30" y1="70" x2="270" y2="70" class="svg-lite"></line>
          <line x1="30" y1="110" x2="270" y2="110" class="svg-lite"></line>
          <line x1="110" y1="30" x2="110" y2="160" class="svg-lite"></line>
          <line x1="190" y1="30" x2="190" y2="160" class="svg-lite"></line>

          <text x="52" y="58" class="svg-text">A</text>
          <text x="132" y="58" class="svg-text">B</text>
          <text x="212" y="58" class="svg-text">C</text>

          <text x="52" y="98" class="svg-text">1</text>
          <text x="132" y="98" class="svg-text">2</text>
          <text x="212" y="98" class="svg-text">3</text>

          <text x="52" y="138" class="svg-text">4</text>
          <text x="132" y="138" class="svg-text">5</text>
          <text x="212" y="138" class="svg-text">6</text>
        </svg>
      `;
    }

    const DIAGRAMS = {
      geometry: svgGeometry,
      ratio: svgRatioBars,
      grid: svgCoordinateGrid,
      table: svgTableGrid
    };

    // ---------- Paper dataset generation ----------
    function buildShortPaper() {
      return {
        key: "short",
        label: "Short paper",
        sections: null,
        items: [
          q("1", 0,
            prompt([
              p(`Calculate ${mkInlineMath("48 \\div 6")}.`)
            ]),
            ans(mkInlineMath("8")),
            sd({
              preview: `Divide 48 by 6.`,
              keepInMind: [`Check by multiplication: ${mkInlineMath("8\\times 6=48")}.`],
              formulas: [],
              working: [
                `${mkMathLine("48 \\div 6 = 8")}`
              ],
              alternatives: []
            })
          ),
          q("2", 0,
            prompt([
              p(`Work out ${mkInlineMath("7\\times 9")}.`)
            ]),
            ans(mkInlineMath("63")),
            sd({
              preview: `Use a quick multiplication fact.`,
              keepInMind: [],
              formulas: [],
              working: [`${mkMathLine("7\\times 9=63")}`],
              alternatives: []
            })
          ),
          q("3", 0,
            prompt([
              p(`A shop sells pens for 35p each. How much do 4 pens cost?`)
            ]),
            ans(`140p (${mkInlineMath("\\pounds 1.40")})`),
            sd({
              preview: `Multiply the price by 4.`,
              keepInMind: [],
              formulas: [],
              working: [
                `${mkMathLine("35\\text{p}\\times 4 = 140\\text{p}")}`,
                `${mkMathLine("140\\text{p} = \\pounds 1.40")}`
              ],
              alternatives: []
            })
          ),
          // One multi-part question
          q("4", 0,
            prompt([
              p(`A rectangle has length ${mkInlineMath("12\\text{ cm}")} and width ${mkInlineMath("5\\text{ cm}")}.`)
            ]),
            ans(`See parts`),
            sd({
              preview: `Use rectangle formulas.`,
              keepInMind: [],
              formulas: [
                `${mkInlineMath("A=lw")}`,
                `${mkInlineMath("P=2(l+w)")}`
              ],
              working: [],
              alternatives: []
            })
          ),
          q("4a", 1,
            prompt([p(`Find the area.`)]),
            ans(`${mkInlineMath("60\\text{ cm}^2")}`),
            sd({
              preview: `Area = length × width.`,
              keepInMind: [],
              formulas: [`${mkInlineMath("A=lw")}`],
              working: [
                `${mkMathLine("A = 12\\times 5 = 60\\text{ cm}^2")}`
              ],
              alternatives: []
            })
          ),
          q("4b", 1,
            prompt([p(`Find the perimeter.`)]),
            ans(`${mkInlineMath("34\\text{ cm}")}`),
            sd({
              preview: `Perimeter adds all sides.`,
              keepInMind: [],
              formulas: [`${mkInlineMath("P=2(l+w)")}`],
              working: [
                `${mkMathLine("P=2(12+5)=2\\times 17=34\\text{ cm}")}`
              ],
              alternatives: []
            })
          )
        ]
      };
    }

    function buildStandardPaper({ expanded = false } = {}) {
      const items = [];
      // Basic short items 1–25
      for (let n = 1; n <= 25; n++) {
        if (n === 18) {
          items.push(
            q("18", 0,
              prompt([p(`A number ${mkInlineMath("x")} is increased by 7 and the result is 20.`)]),
              ans(mkInlineMath("x=13")),
              sd({
                preview: `Form an equation and solve.`,
                keepInMind: [`“Increased by 7” means ${mkInlineMath("+7")}.`],
                formulas: [],
                working: [
                  `${mkMathLine("x+7=20")}`,
                  `${mkMathLine("x=20-7")}`,
                  `${mkMathLine("x=13")}`
                ],
                alternatives: [
                  {
                    label: "Alternative working",
                    lines: [
                      `${mkMathLine("20-7=13")}`,
                      `${mkMathLine("\\therefore\\ x=13")}`
                    ]
                  }
                ]
              })
            ),
            q("18(a)", 1,
              prompt([p(`Write the equation you would use.`)]),
              ans(mkInlineMath("x+7=20")),
              sd({
                preview: `Translate the sentence into algebra.`,
                keepInMind: [],
                formulas: [],
                working: [`${mkMathLine("x+7=20")}`],
                alternatives: []
              })
            ),
            q("18(a)(i)", 2,
              prompt([p(`Solve the equation.`)]),
              ans(mkInlineMath("x=13")),
              sd({
                preview: `Subtract 7 from both sides.`,
                keepInMind: [],
                formulas: [],
                working: [
                  `${mkMathLine("x+7=20")}`,
                  `${mkMathLine("x=20-7=13")}`
                ],
                alternatives: []
              })
            ),
            q("18(a)(ii)", 2,
              prompt([p(`Check your solution by substitution.`)]),
              ans(`True`),
              sd({
                preview: `Substitute back into the equation.`,
                keepInMind: [],
                formulas: [],
                working: [
                  `${mkMathLine("13+7=20")}`,
                  `${mkMathLine("20=20\\ \\checkmark")}`
                ],
                alternatives: []
              })
            ),
            q("18(b)", 1,
              prompt([p(`If the number is doubled first, then increased by 7 to make 20, find the number.`)]),
              ans(mkInlineMath("x=6.5")),
              sd({
                preview: `Set up the new equation.`,
                keepInMind: [],
                formulas: [],
                working: [
                  `${mkMathLine("2x+7=20")}`,
                  `${mkMathLine("2x=13")}`,
                  `${mkMathLine("x=6.5")}`
                ],
                alternatives: []
              })
            )
          );
          continue;
        }

        const isDiagram = (n === 7); // small diagram cameo (still fine)
        const diagHtml = isDiagram ? `<div class="diagram">${DIAGRAMS.geometry()}</div>` : "";

        items.push(
          q(String(n), 0,
            prompt([
              p(`${n === 7 ? "Use the diagram." : "Work out"} ${mkInlineMath(`${n}+${(n % 9) + 3}`)}.`),
              diagHtml ? { __raw: diagHtml } : null
            ]),
            ans(mkInlineMath(String(n + ((n % 9) + 3)))),
            sd({
              preview: `Add the numbers.`,
              keepInMind: [],
              formulas: [],
              working: [`${mkMathLine(`${n}+${(n % 9) + 3}=${n + ((n % 9) + 3)}`)}`],
              alternatives: []
            }),
            { expanded }
          )
        );
      }

      // Q26–Q35: long algebra (multiple block math placeholders)
      for (let n = 26; n <= 35; n++) {
        const qid = String(n);
        const basePrompt = [
          p(`Solve the equation and give your final answer.`),
          { __raw: mkBlockMath(`${n === 26 ? "3x+5=20" : n === 27 ? "2(4x-1)=18" : n === 28 ? "\\frac{x}{3}+7=15" : n === 29 ? "5x-2=3x+10" : n === 30 ? "x^2-9=0" : n === 31 ? "(x-2)(x+5)=0" : n === 32 ? "3x^2=48" : n === 33 ? "x_{k+1}=2x_k+3\\ \\text{with}\\ x_0=1" : n === 34 ? "\\frac{2x-1}{5}=3" : "4x+3=2x+17"}`) }
        ];

        // Add deep nesting for Q30
        if (n === 30) {
          items.push(
            q("30", 0,
              prompt(basePrompt),
              ans(mkInlineMath("x=3\\ \\text{or}\\ x=-3")),
              sd(longAlgebraSD({ n, expanded, veryLong: false, includeAll: true }))
            ),
            q("30(a)", 1,
              prompt([p(`Factorise ${mkInlineMath("x^2-9")}.`)]),
              ans(mkInlineMath("(x-3)(x+3)")),
              sd({
                preview: `Difference of squares.`,
                keepInMind: [],
                formulas: [mkInlineMath("a^2-b^2=(a-b)(a+b)")],
                working: [
                  `${mkMathLine("x^2-9 = x^2-3^2")}`,
                  `${mkMathLine("= (x-3)(x+3)")}`
                ],
                alternatives: []
              }, { expanded })
            ),
            q("30(a)(i)", 2,
              prompt([p(`Solve ${mkInlineMath("(x-3)(x+3)=0")}.`)]),
              ans(mkInlineMath("x=3\\ \\text{or}\\ x=-3")),
              sd({
                preview: `Zero-product rule.`,
                keepInMind: [],
                formulas: [],
                working: [
                  `${mkMathLine("x-3=0\\ \\Rightarrow\\ x=3")}`,
                  `${mkMathLine("x+3=0\\ \\Rightarrow\\ x=-3")}`
                ],
                alternatives: []
              }, { expanded })
            ),
            q("30(a)(ii)", 2,
              prompt([p(`Check both solutions in ${mkInlineMath("x^2-9=0")}.`)]),
              ans(`Both check out`),
              sd({
                preview: `Substitute each value.`,
                keepInMind: [],
                formulas: [],
                working: [
                  `${mkMathLine("3^2-9=9-9=0")}`,
                  `${mkMathLine("(-3)^2-9=9-9=0")}`
                ],
                alternatives: []
              }, { expanded })
            ),
            q("30(b)", 1,
              prompt([p(`Now solve ${mkInlineMath("x^2-9=12")}.`)]),
              ans(mkInlineMath("x=\\pm\\sqrt{21}")),
              sd({
                preview: `Rearrange then square root.`,
                keepInMind: [`Remember ${mkInlineMath("\\sqrt{21}")} is not an integer.`],
                formulas: [],
                working: [
                  `${mkMathLine("x^2=21")}`,
                  `${mkMathLine("x=\\pm\\sqrt{21}")}`
                ],
                alternatives: []
              }, { expanded })
            )
          );
          continue;
        }

        // Extremely long workings stress test for selected questions (e.g., Q33)
        const veryLong = (n === 33);

        items.push(
          q(qid, 0,
            prompt(basePrompt),
            ans(standardLongAnswer(n)),
            sd(longAlgebraSD({ n, expanded, veryLong }))
          )
        );
      }

      return {
        key: expanded ? "standard_expanded" : "standard",
        label: expanded ? "Standard (Workings Expanded)" : "Standard paper",
        sections: null,
        items
      };
    }

    function standardLongAnswer(n) {
      switch (n) {
        case 26: return mkInlineMath("x=5");
        case 27: return mkInlineMath("x=\\frac{5}{2}");
        case 28: return mkInlineMath("x=24");
        case 29: return mkInlineMath("x=6");
        case 31: return mkInlineMath("x=2\\ \\text{or}\\ x=-5");
        case 32: return mkInlineMath("x=\\pm 4");
        case 33: return mkInlineMath("x_k = 4\\cdot 2^k - 3");
        case 34: return mkInlineMath("x=8");
        case 35: return mkInlineMath("x=7");
        default: return mkInlineMath("x=3\\ \\text{or}\\ x=-3");
      }
    }

    function longAlgebraSD({ n, expanded = false, veryLong = false, includeAll = false }) {
      // Ensure coverage: keep in mind + formulas + alternative working appears at least once (use includeAll on Q30).
      const keepInMind = [];
      const formulas = [];
      const alternatives = [];

      if (includeAll) {
        keepInMind.push(`When you take square roots, remember the ${mkInlineMath("\\pm")} sign if appropriate.`);
        formulas.push(`${mkInlineMath("a^2-b^2=(a-b)(a+b)")}`);
        alternatives.push({
          label: "Alternative working",
          lines: [
            `${mkMathLine("x^2-9=0\\ \\Rightarrow\\ x^2=9")}`,
            `${mkMathLine("x=\\pm 3")}`
          ]
        });
      } else {
        // Spread variants across long set for the stress test
        if (n % 3 === 2) keepInMind.push(`Keep your steps aligned to avoid sign errors.`);
        if (n % 4 === 0) formulas.push(`${mkInlineMath("ax+b=c\\ \\Rightarrow\\ x=\\frac{c-b}{a}")}`);
        if (n % 5 === 0) alternatives.push({
          label: "Alternative working",
          lines: [
            `${mkMathLine("\\text{Rearrange first, then simplify.}")}`,
            `${mkMathLine("\\text{Finish with the final value of }x.")}`
          ]
        });
      }

      const workingLines = [];
      // Multiple KaTeX block placeholders inside Solution Details for long questions
      workingLines.push(mkBlockMath(`\\textbf{Start:}\\quad ${n === 26 ? "3x+5=20" : n === 27 ? "2(4x-1)=18" : n === 28 ? "\\frac{x}{3}+7=15" : n === 29 ? "5x-2=3x+10" : n === 31 ? "(x-2)(x+5)=0" : n === 32 ? "3x^2=48" : n === 33 ? "x_{k+1}=2x_k+3" : n === 34 ? "\\frac{2x-1}{5}=3" : "4x+3=2x+17"}`));

      if (n === 26) {
        workingLines.push(mkMathLine("3x+5=20"));
        workingLines.push(mkMathLine("3x=15"));
        workingLines.push(mkMathLine("x=5"));
      } else if (n === 27) {
        workingLines.push(mkMathLine("2(4x-1)=18"));
        workingLines.push(mkMathLine("4x-1=9"));
        workingLines.push(mkMathLine("4x=10"));
        workingLines.push(mkMathLine("x=\\frac{5}{2}"));
      } else if (n === 28) {
        workingLines.push(mkMathLine("\\frac{x}{3}+7=15"));
        workingLines.push(mkMathLine("\\frac{x}{3}=8"));
        workingLines.push(mkMathLine("x=24"));
      } else if (n === 29) {
        workingLines.push(mkMathLine("5x-2=3x+10"));
        workingLines.push(mkMathLine("2x=12"));
        workingLines.push(mkMathLine("x=6"));
      } else if (n === 31) {
        workingLines.push(mkMathLine("(x-2)(x+5)=0"));
        workingLines.push(mkMathLine("x-2=0\\Rightarrow x=2"));
        workingLines.push(mkMathLine("x+5=0\\Rightarrow x=-5"));
      } else if (n === 32) {
        workingLines.push(mkMathLine("3x^2=48"));
        workingLines.push(mkMathLine("x^2=16"));
        workingLines.push(mkMathLine("x=\\pm 4"));
      } else if (n === 33) {
        workingLines.push(mkMathLine("x_{k+1}=2x_k+3,\\quad x_0=1"));
        workingLines.push(mkMathLine("x_1=2\\cdot 1+3=5"));
        workingLines.push(mkMathLine("x_2=2\\cdot 5+3=13"));
        workingLines.push(mkMathLine("x_3=2\\cdot 13+3=29"));
        workingLines.push(mkBlockMath("\\text{Recognise a pattern and form a closed form.}"));
        workingLines.push(mkMathLine("x_k = A\\cdot 2^k - 3"));

        if (veryLong) {
          // 50–60 lines stress test (Working only)
          for (let i = 1; i <= 56; i++) {
            workingLines.push(mkMathLine(`x_{${i}} = 2x_{${i - 1}} + 3`));
          }
          workingLines.push(mkBlockMath("x_k=4\\cdot 2^k-3"));
        } else {
          workingLines.push(mkMathLine("x_0=1\\Rightarrow 1=A\\cdot 1-3\\Rightarrow A=4"));
          workingLines.push(mkMathLine("x_k=4\\cdot 2^k-3"));
        }
      } else if (n === 34) {
        workingLines.push(mkMathLine("\\frac{2x-1}{5}=3"));
        workingLines.push(mkMathLine("2x-1=15"));
        workingLines.push(mkMathLine("2x=16"));
        workingLines.push(mkMathLine("x=8"));
      } else { // 35
        workingLines.push(mkMathLine("4x+3=2x+17"));
        workingLines.push(mkMathLine("2x=14"));
        workingLines.push(mkMathLine("x=7"));
      }

      // Add a couple more blocks to ensure multiple block placeholders for the long set
      workingLines.push(mkBlockMath("\\text{Final answer:}\\quad x=\\dots"));

      return {
        preview: `Work step-by-step; keep each line clear.`,
        keepInMind,
        formulas,
        working: workingLines,
        alternatives
      };
    }

    function buildDiagramHeavyPaper() {
      const items = [];
      const diagMap = {
        2: "geometry",
        3: "ratio",
        5: "grid",
        7: "table",
        9: "geometry",
        12: "ratio",
        15: "grid",
        18: "table"
      };

      for (let n = 1; n <= 20; n++) {
        const hasDiag = !!diagMap[n];
        const diagType = diagMap[n];
        const diagHtml = hasDiag ? `<div class="diagram">${DIAGRAMS[diagType]()}</div>` : "";

        items.push(
          q(String(n), 0,
            prompt([
              p(`${hasDiag ? "Use the diagram to answer." : "Answer the question."}`),
              diagHtml ? { __raw: diagHtml } : null,
              p(`Calculate ${mkInlineMath(`${n * 3}+${n}`)}.`)
            ]),
            ans(mkInlineMath(String(n * 4))),
            sd({
              preview: `Combine the numbers shown.`,
              keepInMind: (n % 6 === 0) ? [`Keep units consistent if you add measurements.`] : [],
              formulas: (n % 7 === 0) ? [mkInlineMath("\\text{Total} = \\text{sum of parts}")] : [],
              working: [
                `${mkMathLine(`${n * 3}+${n}=${n * 4}`)}`
              ],
              alternatives: (n % 8 === 0) ? [{
                label: "Alternative working",
                lines: [
                  `${mkMathLine(`${n}\\times 4=${n * 4}`)}`
                ]
              }] : []
            })
          )
        );
      }

      return {
        key: "diagram",
        label: "Diagram-heavy paper",
        sections: null,
        items
      };
    }

    function buildSectionedPaper() {
      const items = [];

      // Section A: 35 small/medium
      items.push(sectionMarker("A"));
      for (let n = 1; n <= 35; n++) {
        const keep = (n === 4 || n === 11 || n === 19) ? [`Estimate first to catch mistakes.`] : [];
        const forms = (n === 6 || n === 14 || n === 22) ? [mkInlineMath("\\text{mean} = \\frac{\\text{sum}}{\\text{count}}")] : [];
        const alt = (n === 9 || n === 17 || n === 25) ? [{
          label: "Alternative working",
          lines: [
            `${mkMathLine("\\text{Use an equivalent method to check.}")}`,
            `${mkMathLine("\\text{Finish with the same final answer.}")}`
          ]
        }] : [];

        items.push(
          q(String(n), 0,
            prompt([
              p(`Section A question.`),
              p(`Work out ${mkInlineMath(`${n}+${(n % 10) + 12}`)}.`)
            ]),
            ans(mkInlineMath(String(n + ((n % 10) + 12)))),
            sd({
              preview: `Add carefully.`,
              keepInMind: keep,
              formulas: forms,
              working: [`${mkMathLine(`${n}+${(n % 10) + 12}=${n + ((n % 10) + 12)}`)}`],
              alternatives: alt
            })
          )
        );
      }

      // Section B: 8 medium
      items.push(sectionMarker("B"));
      for (let i = 1; i <= 8; i++) {
        const qid = `B${i}`;
        items.push(
          q(qid, 0,
            prompt([
              p(`Section B question.`),
              p(`Solve ${mkInlineMath(`${i + 2}x+${i}= ${i * 6 + 10}`)}.`),
              { __raw: mkBlockMath(`${i + 2}x+${i}= ${i * 6 + 10}`) }
            ]),
            ans(mkInlineMath(`x=${Math.floor((i * 6 + 10 - i) / (i + 2))}`)),
            sd({
              preview: `Rearrange and divide.`,
              keepInMind: (i === 2) ? [`Keep track of subtraction before dividing.`] : [],
              formulas: (i === 5) ? [mkInlineMath("ax+b=c\\Rightarrow x=\\frac{c-b}{a}")] : [],
              working: [
                mkMathLine(`${i + 2}x+${i}=${i * 6 + 10}`),
                mkMathLine(`${i + 2}x=${i * 6 + 10 - i}`),
                mkMathLine(`x=\\frac{${i * 6 + 10 - i}}{${i + 2}}`)
              ],
              alternatives: (i === 7) ? [{
                label: "Alternative working",
                lines: [
                  mkMathLine("\\text{Check by substituting into the original equation.}")
                ]
              }] : []
            })
          )
        );
      }

      // Section C: 6 very long Solution Details (collapsed by default)
      items.push(sectionMarker("C"));
      for (let i = 1; i <= 6; i++) {
        const qid = `C${i}`;
        const working = [];
        working.push(mkBlockMath(`\\text{Section C algebraic derivation (part ${i})}`));
        working.push(mkMathLine(`2x+${i}=\\frac{3}{2}(x+${i + 1})`));
        working.push(mkMathLine(`4x+2${i}=3x+3(${i + 1})`));
        working.push(mkMathLine(`x=3(${i + 1})-2${i}`));
        working.push(mkBlockMath(`\\text{Now simplify and state the final result.}`));

        // Add a lot of lines to stress long derivations
        for (let k = 1; k <= 52; k++) {
          working.push(mkMathLine(`\\text{Line }${k}:\\quad x = ${k}+${i}`));
        }
        working.push(mkBlockMath(`\\text{Final answer:}\\quad x=\\dots`));

        // Ensure at least one includes Keep in mind + Formulas used + Alternative working together (use C3)
        const includeAll = (i === 3);

        items.push(
          q(qid, 0,
            prompt([
              p(`Section C question.`),
              p(`Show all working.`),
              { __raw: mkBlockMath(`2x+${i}=\\frac{3}{2}(x+${i + 1})`) }
            ]),
            ans(mkInlineMath(`x=${3 * (i + 1) - 2 * i}`)),
            sd({
              preview: `This one is long — reveal when ready.`,
              keepInMind: includeAll ? [
                `Keep equations aligned, and simplify one step at a time.`,
                `Check your final value by substitution.`
              ] : (i === 1 || i === 5 || i === 6) ? [`Write each new line directly beneath the last.`] : [],
              formulas: includeAll ? [
                mkInlineMath("\\frac{a}{b}=c\\Rightarrow a=bc"),
                mkInlineMath("ax+b=cx+d\\Rightarrow (a-c)x=d-b")
              ] : (i === 2 || i === 4 || i === 6) ? [mkInlineMath("ax+b=cx+d\\Rightarrow (a-c)x=d-b")] : [],
              working,
              alternatives: includeAll ? [{
                label: "Alternative working",
                lines: [
                  mkMathLine("\\text{Multiply both sides by 2 first to clear the fraction.}"),
                  mkMathLine(`4x+2${i}=3x+3(${i + 1})`)
                ]
              }] : []
            })
          )
        );
      }

      return {
        key: "sectioned",
        label: "Sectioned paper (A/B/C)",
        sections: ["A", "B", "C"],
        items
      };
    }

    function sectionMarker(letter) {
      return { type: "section", letter };
    }

    // ---------- Content helpers ----------
    function p(html) { return { __raw: `<p>${html}</p>` }; }
    function prompt(parts) {
      // parts may be p(...) objects or raw diagram blocks
      const html = parts
        .filter(Boolean)
        .map(part => part.__raw ? part.__raw : String(part))
        .join("");
      return html;
    }
    function ans(html) { return html; }

    function q(qid, depth, promptHtml, answerHtml, solutionDetails, opts = {}) {
      return {
        type: "question",
        qid,
        depth,
        promptHtml,
        answerHtml,
        solutionDetails,
        expanded: !!opts.expanded
      };
    }

    function sd({ preview = "", keepInMind = [], formulas = [], working = [], alternatives = [] }, opts = {}) {
      return {
        preview,
        keepInMind,
        formulas,
        working,
        alternatives,
        expanded: !!opts.expanded
      };
    }

    // ---------- Rendering ----------
    const DATASETS = [
      buildShortPaper(),
      buildStandardPaper({ expanded: false }),
      buildDiagramHeavyPaper(),
      buildSectionedPaper(),
      buildStandardPaper({ expanded: true }) // add-on dataset
    ];

    const state = {
      datasetKey: DATASETS[0].key,
      observer: null,
      activeQid: null
    };

    function renderSelector() {
      const sel = $("#paperSelector");
      sel.innerHTML = "";
      for (const ds of DATASETS) {
        sel.appendChild(el("option", { value: ds.key, text: ds.label }));
      }
      sel.value = state.datasetKey;
      sel.addEventListener("change", () => {
        state.datasetKey = sel.value;
        renderAll();
      });
    }

    function renderAll() {
      const ds = DATASETS.find(d => d.key === state.datasetKey) || DATASETS[0];

      renderNav(ds);
      renderPaper(ds);

      // After content exists, render KaTeX
      renderKatexSafely();

      // Ensure details summary text matches state
      document.querySelectorAll("details.sd").forEach(d => setSummaryText(d));

      // Set up scrollspy
      setupScrollSpy();
    }

    function renderNav(ds) {
      const navList = $("#navList");
      navList.innerHTML = "";

      const dlgBody = $("#navDialogBody");
      dlgBody.innerHTML = "";

      const fragRail = document.createDocumentFragment();
      const fragDlg = document.createDocumentFragment();

      const addSep = (letter) => {
        fragRail.appendChild(el("li", {}, [el("div", { class: "nav-sep", text: letter })]));
        fragDlg.appendChild(el("div", { class: "nav-sep", text: letter }));
      };

      for (const item of ds.items) {
        if (item.type === "section") {
          addSep(item.letter);
          continue;
        }
        const targetId = "q-" + slugifyQid(item.qid);

        const railBtn = el("button", {
          class: "nav-item",
          type: "button",
          "data-target": targetId,
          text: item.qid
        });
        railBtn.addEventListener("click", () => jumpTo(targetId));

        const railLi = el("li", {}, [railBtn]);
        fragRail.appendChild(railLi);

        const dlgBtn = el("button", {
          class: "nav-item",
          type: "button",
          "data-target": targetId,
          text: item.qid
        });
        dlgBtn.addEventListener("click", () => {
          jumpTo(targetId);
          closeNavDialog();
        });
        fragDlg.appendChild(dlgBtn);
      }

      navList.appendChild(fragRail);
      dlgBody.appendChild(fragDlg);
    }

    function renderPaper(ds) {
      const paper = $("#paper");
      paper.innerHTML = "";

      const frag = document.createDocumentFragment();

      for (const item of ds.items) {
        if (item.type === "section") {
          frag.appendChild(el("div", { class: "section-header", text: `Section ${item.letter}` }));
          continue;
        }

        const id = "q-" + slugifyQid(item.qid);
        const isTop = item.depth === 0;
        const qWrap = el("section", {
          class: `q ${isTop ? "top" : ""} depth-${Math.min(item.depth, 3)}`,
          id,
          "data-qid": item.qid
        });

        const head = el("div", { class: "q-head" }, [
          el("div", { class: "qid", text: item.qid }),
          el("div", { class: "q-prompt", html: item.promptHtml })
        ]);

        const answer = el("div", { class: "answer" }, [
          el("div", { class: "label", text: "Answer" }),
          el("div", { class: "val", html: item.answerHtml })
        ]);

        const details = renderSolutionDetails(item.solutionDetails, item.expanded || item.solutionDetails.expanded);

        qWrap.appendChild(head);
        qWrap.appendChild(answer);
        qWrap.appendChild(details);

        frag.appendChild(qWrap);
      }

      paper.appendChild(frag);
    }

    function renderSolutionDetails(sdObj, expandedOverride = false) {
      const details = el("details", { class: "sd" });
      if (expandedOverride) details.open = true;

      const summary = el("summary", { text: expandedOverride ? "Hide working" : "Show working" });
      details.appendChild(summary);

      const preview = el("div", { class: "sd-preview", text: sdObj.preview || "" });
      details.appendChild(preview);

      const body = el("div", { class: "sd-body" });

      if (sdObj.keepInMind && sdObj.keepInMind.length) {
        const blk = el("div", { class: "sd-block" }, [
          el("h4", { text: "Keep in mind" }),
          ...sdObj.keepInMind.map(t => el("p", { html: t }))
        ]);
        body.appendChild(blk);
      }

      if (sdObj.formulas && sdObj.formulas.length) {
        const blk = el("div", { class: "sd-block" }, [
          el("h4", { text: "Formulas used" }),
          el("p", { html: sdObj.formulas.join(" &nbsp;&nbsp; ") })
        ]);
        body.appendChild(blk);
      }

      if (sdObj.working && sdObj.working.length) {
        const blk = el("div", { class: "sd-block" }, [
          el("h4", { text: "Working" }),
          el("div", { html: sdObj.working.join("") })
        ]);
        body.appendChild(blk);
      }

      if (sdObj.alternatives && sdObj.alternatives.length) {
        for (const alt of sdObj.alternatives) {
          const blk = el("div", { class: "sd-block" }, [
            el("h4", { text: alt.label || "Alternative working" }),
            el("div", { html: (alt.lines || []).join("") })
          ]);
          body.appendChild(blk);
        }
      }

      details.appendChild(body);

      details.addEventListener("toggle", () => {
        setSummaryText(details);
      });

      return details;
    }

    function jumpTo(targetId) {
      const elTarget = document.getElementById(targetId);
      if (!elTarget) return;
      // No smooth scrolling (avoid motion effects)
      elTarget.scrollIntoView({ block: "start" });
    }

    // ---------- KaTeX rendering (with graceful fallback) ----------
    function renderKatexSafely() {
      const hasKatex = typeof window.katex !== "undefined" && window.katex && typeof window.katex.render === "function";
      if (!hasKatex) return; // fallback: plain text already visible

      // Inline + block + line
      const nodes = document.querySelectorAll("[data-math]");
      nodes.forEach(node => {
        const math = node.getAttribute("data-math") || "";
        const display = node.getAttribute("data-display") === "true";
        try {
          // Avoid double-render if already rendered
          if (node.getAttribute("data-rendered") === "true") return;
          window.katex.render(math, node, {
            displayMode: display,
            throwOnError: false
          });
          node.setAttribute("data-rendered", "true");
        } catch (e) {
          // Keep fallback text
        }
      });
    }

    // ---------- Scrollspy (quiet, non-progress) ----------
    function setupScrollSpy() {
      if (state.observer) state.observer.disconnect();

      // Clear current state
      document.querySelectorAll(".nav-item[aria-current='true']").forEach(b => b.setAttribute("aria-current", "false"));

      const questions = Array.from(document.querySelectorAll("section.q[data-qid]"));
      if (!questions.length) return;

      const obs = new IntersectionObserver((entries) => {
        // Choose the entry closest to the top that is intersecting
        const visible = entries
          .filter(e => e.isIntersecting)
          .sort((a, b) => a.boundingClientRect.top - b.boundingClientRect.top);

        if (!visible.length) return;

        const qid = visible[0].target.getAttribute("data-qid");
        if (!qid || qid === state.activeQid) return;

        state.activeQid = qid;
        updateNavCurrent(qid);
      }, {
        root: null,
        threshold: [0.05, 0.15, 0.25],
        rootMargin: "-10% 0px -80% 0px"
      });

      questions.forEach(q => obs.observe(q));
      state.observer = obs;

      // Initialize current based on first question near top
      const first = questions[0].getAttribute("data-qid");
      if (first) updateNavCurrent(first);
    }

    function updateNavCurrent(qid) {
      const buttons = document.querySelectorAll(".nav-item");
      buttons.forEach(b => {
        const targetId = b.getAttribute("data-target");
        if (!targetId) return;
        const target = document.getElementById(targetId);
        const tQid = target ? target.getAttribute("data-qid") : null;
        b.setAttribute("aria-current", String(tQid === qid));
      });
    }

    // ---------- Mobile nav dialog ----------
    function openNavDialog() {
      const dlg = $("#navDialog");
      if (!dlg.open) dlg.showModal();
    }
    function closeNavDialog() {
      const dlg = $("#navDialog");
      if (dlg.open) dlg.close();
    }

    $("#jumpBtn").addEventListener("click", openNavDialog);
    $("#navCloseBtn").addEventListener("click", closeNavDialog);
    $("#navDialog").addEventListener("click", (e) => {
      // click outside content closes
      const dlg = e.currentTarget;
      const rect = dlg.getBoundingClientRect();
      const inDialog = (
        e.clientX >= rect.left && e.clientX <= rect.right &&
        e.clientY >= rect.top && e.clientY <= rect.bottom
      );
      // If user clicks the backdrop area (outside), close
      if (!inDialog) closeNavDialog();
    });

    // ---------- Boot ----------
    renderSelector();
    renderAll();
  </script>
</body>

</html>