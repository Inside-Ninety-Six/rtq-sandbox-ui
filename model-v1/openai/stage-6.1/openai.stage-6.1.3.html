<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RTQ – Maths Paper Solution Viewer (Prototype)</title>

  <!-- KaTeX (CDN) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" />
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"></script>

  <!-- Markdown-it (CDN) -->
  <script defer src="https://cdn.jsdelivr.net/npm/markdown-it@14.1.0/dist/markdown-it.min.js"></script>

  <style>
    :root {
      --page-bg: #f6f3ee;
      --frame-bg: #fbf9f5;
      --text: #1c1c1c;
      --muted: #3c3c3c;
      --quiet: #5f5f5f;
      --hairline: rgba(0, 0, 0, 0.10);

      --accent: #2f4a73;

      --space-q: 28px;
      --space-sub: 18px;
      --space-sub2: 12px;
      --space-in: 10px;
      --space-sol: 14px;
      --space-line: 8px;

      --content-max: 1060px;
      --nav-w: 120px;
      --gutter: 18px;

      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      height: 100%;
    }

    body {
      margin: 0;
      background: var(--page-bg);
      color: var(--text);
      font-family: var(--font);
      line-height: 1.55;
      overflow-x: hidden;
    }

    :focus-visible {
      outline: 2px solid color-mix(in oklab, var(--accent), transparent 35%);
      outline-offset: 2px;
    }

    header {
      position: sticky;
      top: 0;
      z-index: 10;
      background: color-mix(in oklab, var(--page-bg), white 25%);
      border-bottom: 1px solid var(--hairline);
    }

    .topbar {
      max-width: var(--content-max);
      margin: 0 auto;
      padding: 12px var(--gutter);
      display: flex;
      align-items: center;
      gap: 12px;
      justify-content: space-between;
    }

    .topbar .left {
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 0;
    }

    .label {
      font-size: 13px;
      color: var(--quiet);
      white-space: nowrap;
    }

    select {
      font: inherit;
      font-size: 14px;
      color: var(--text);
      background: transparent;
      border: 1px solid var(--hairline);
      border-radius: 10px;
      padding: 8px 10px;
      min-width: 220px;
    }

    select:focus-visible {
      border-color: color-mix(in oklab, var(--accent), transparent 60%);
    }

    .jumpBtn {
      font: inherit;
      font-size: 14px;
      color: var(--accent);
      background: transparent;
      border: 1px solid var(--hairline);
      border-radius: 999px;
      padding: 8px 12px;
      cursor: pointer;
      white-space: nowrap;
      text-decoration: none;
    }

    .jumpBtn:hover {
      text-decoration: underline;
    }

    .frame {
      max-width: var(--content-max);
      margin: 0 auto;
      padding: 18px var(--gutter) 48px var(--gutter);
      background: var(--frame-bg);
    }

    .cols {
      display: grid;
      grid-template-columns: var(--nav-w) 1fr;
      gap: 22px;
      align-items: start;
    }

    nav {
      position: sticky;
      top: 66px;
      align-self: start;
    }

    .navShell {
      padding: 6px 0;
    }

    .navList {
      max-height: calc(100vh - 90px);
      overflow-y: auto;
      padding-right: 6px;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .navList::-webkit-scrollbar {
      display: none;
    }

    .navSection {
      font-size: 12px;
      color: var(--quiet);
      letter-spacing: 0.02em;
      margin: 14px 0 6px 0;
      user-select: none;
    }

    .navItem {
      width: 100%;
      text-align: left;
      font: inherit;
      font-size: 13px;
      color: color-mix(in oklab, var(--quiet), var(--text) 10%);
      background: transparent;
      border: 0;
      padding: 6px 0;
      cursor: pointer;
      line-height: 1.2;
      display: flex;
      align-items: baseline;
      gap: 8px;
    }

    .navItem:hover {
      text-decoration: underline;
    }

    .navItem .marker {
      width: 10px;
      flex: 0 0 10px;
      height: 1px;
      background: transparent;
      margin-top: 0.55em;
    }

    .navItem[aria-current="true"] {
      color: var(--text);
      font-weight: 600;
    }

    .navItem[aria-current="true"] .marker {
      background: color-mix(in oklab, var(--accent), transparent 20%);
    }

    main {
      min-width: 0;
    }

    .paperTitle {
      margin: 0 0 18px 0;
      font-size: 16px;
      color: var(--quiet);
      font-weight: 600;
    }

    .qNode {
      margin-top: var(--space-q);
    }

    .qNode:first-child {
      margin-top: 0;
    }

    .qWrap {
      padding-left: 0;
    }

    .qWrap[data-depth="1"] {
      padding-left: 14px;
      margin-top: var(--space-sub);
    }

    .qWrap[data-depth="2"] {
      padding-left: 22px;
      margin-top: var(--space-sub2);
    }

    .qWrap[data-depth="3"] {
      padding-left: 28px;
      margin-top: var(--space-sub2);
    }

    .qWrap[data-depth="4"] {
      padding-left: 32px;
      margin-top: var(--space-sub2);
    }

    .qWrap[data-depth="5"] {
      padding-left: 36px;
      margin-top: var(--space-sub2);
    }

    .qPrompt {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 10px;
      align-items: start;
    }

    .qId {
      font-size: 14px;
      color: color-mix(in oklab, var(--text), transparent 30%);
      font-weight: 600;
      line-height: 1.5;
      white-space: nowrap;
    }

    .qText {
      font-size: 16px;
      color: var(--text);
      line-height: 1.65;
      min-width: 0;
    }

    .answerBlock {
      margin-top: var(--space-in);
      display: grid;
      grid-template-columns: 74px 1fr;
      gap: 10px;
      align-items: start;
    }

    .aLabel {
      font-size: 13px;
      color: var(--quiet);
      font-weight: 600;
      line-height: 1.7;
    }

    .aValue {
      font-size: 15px;
      color: color-mix(in oklab, var(--text), transparent 10%);
      line-height: 1.6;
      min-width: 0;
    }

    .toggleRow {
      margin-top: 8px;
    }

    .toggleBtn {
      font: inherit;
      font-size: 14px;
      color: var(--accent);
      background: transparent;
      border: 0;
      padding: 4px 0;
      cursor: pointer;
      text-decoration: none;
    }

    .toggleBtn:hover {
      text-decoration: underline;
    }

    .toggleBtn .chev {
      display: inline-block;
      width: 1em;
      text-align: center;
      color: color-mix(in oklab, var(--accent), transparent 15%);
    }

    .solution {
      margin-top: 10px;
      padding-top: 10px;
      padding-left: 10px;
      border-left: 1px solid var(--hairline);
      background: color-mix(in oklab, var(--frame-bg), var(--page-bg) 40%);
    }

    .solution[hidden] {
      display: none;
    }

    .solSection {
      margin-top: var(--space-sol);
    }

    .solSection:first-child {
      margin-top: 0;
    }

    .solHeader {
      font-size: 13px;
      font-weight: 600;
      color: var(--quiet);
      margin: 0 0 6px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .keepIcon {
      width: 14px;
      height: 14px;
      display: inline-block;
      border: 1px solid var(--hairline);
      border-radius: 999px;
      flex: 0 0 14px;
    }

    .solBody {
      font-size: 14px;
      color: color-mix(in oklab, var(--text), transparent 22%);
      line-height: 1.55;
      min-width: 0;
    }

    .solSection.keep .solBody {
      color: color-mix(in oklab, var(--text), transparent 14%);
    }

    .solSection.formulas .solBody {
      color: color-mix(in oklab, var(--text), transparent 26%);
    }

    .solSection.working .solBody,
    .solSection.altworking .solBody {
      color: color-mix(in oklab, var(--text), transparent 28%);
      line-height: 1.5;
    }

    .md p {
      margin: 0 0 var(--space-line) 0;
    }

    .md p:last-child {
      margin-bottom: 0;
    }

    .md ul,
    .md ol {
      margin: 0 0 var(--space-line) 18px;
      padding: 0;
    }

    .md li {
      margin: 4px 0;
    }

    .md hr {
      border: 0;
      border-top: 1px solid var(--hairline);
      margin: 12px 0;
    }

    .tableWrap {
      overflow-x: auto;
      max-width: 100%;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .tableWrap::-webkit-scrollbar {
      display: none;
    }

    table {
      border-collapse: collapse;
      width: max-content;
      min-width: 100%;
      font-size: 13px;
      color: color-mix(in oklab, var(--text), transparent 22%);
    }

    th,
    td {
      border: 1px solid var(--hairline);
      padding: 6px 8px;
      vertical-align: top;
    }

    th {
      font-weight: 600;
      background: transparent;
      color: color-mix(in oklab, var(--text), transparent 18%);
    }

    pre,
    code {
      font-family: var(--mono);
      font-size: 12.5px;
    }

    pre {
      margin: 0 0 var(--space-line) 0;
      overflow-x: auto;
      max-width: 100%;
      background: transparent;
      border: 0;
      padding: 0;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    pre::-webkit-scrollbar {
      display: none;
    }

    svg {
      max-width: 100%;
      height: auto;
      display: block;
    }

    .katex-display {
      max-width: 100%;
      overflow-x: auto;
      overflow-y: hidden;
      padding: 6px 8px;
      margin: 8px 0;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .katex-display::-webkit-scrollbar {
      display: none;
    }

    .katex {
      background: transparent !important;
    }

    .solSection.working .katex-display,
    .solSection.altworking .katex-display {
      background: rgba(0, 0, 0, 0.035);
      border: 0;
      border-radius: 0;
      box-shadow: none;
    }

    .solSection.keep .katex-display,
    .solSection.formulas .katex-display {
      background: transparent;
      padding-left: 0;
      padding-right: 0;
    }

    .missing {
      margin-top: 28px;
      font-size: 14px;
      color: var(--text);
      letter-spacing: 0.01em;
    }

    .drawerBackdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.25);
      display: none;
      z-index: 50;
    }

    .drawer {
      position: fixed;
      inset: 0 0 0 auto;
      width: min(360px, 92vw);
      background: var(--frame-bg);
      transform: translateX(100%);
      transition: transform 160ms ease;
      z-index: 60;
      display: flex;
      flex-direction: column;
      border-left: 1px solid var(--hairline);
    }

    @media (prefers-reduced-motion: reduce) {
      .drawer {
        transition: none;
      }
    }

    .drawerHeader {
      padding: 14px 14px 10px 14px;
      border-bottom: 1px solid var(--hairline);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .drawerTitle {
      margin: 0;
      font-size: 14px;
      color: var(--quiet);
      font-weight: 600;
    }

    .closeBtn {
      font: inherit;
      font-size: 14px;
      color: var(--accent);
      background: transparent;
      border: 1px solid var(--hairline);
      border-radius: 999px;
      padding: 6px 10px;
      cursor: pointer;
    }

    .closeBtn:hover {
      text-decoration: underline;
    }

    .drawerBody {
      padding: 10px 14px 18px 14px;
      overflow-y: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .drawerBody::-webkit-scrollbar {
      display: none;
    }

    @media (max-width: 860px) {
      :root {
        --nav-w: 0px;
      }

      .cols {
        grid-template-columns: 1fr;
      }

      nav {
        display: none;
      }

      .paperTitle {
        margin-bottom: 14px;
      }

      select {
        min-width: 0;
        width: 100%;
      }

      .topbar {
        gap: 10px;
      }

      .topbar .left {
        flex: 1;
        min-width: 0;
      }

      .topbar .right {
        flex: 0 0 auto;
      }
    }

    button {
      -webkit-tap-highlight-color: rgba(0, 0, 0, 0.08);
    }
  </style>
</head>

<body>
  <header>
    <div class="topbar" aria-label="Top controls">
      <div class="left">
        <div class="label" id="paperLabel">Paper</div>
        <select id="paperSelect" aria-labelledby="paperLabel">
          <option value="">Loading…</option>
        </select>
      </div>
      <div class="right">
        <button class="jumpBtn" id="openDrawerBtn" type="button" aria-haspopup="dialog" aria-controls="navDrawer">
          Jump to
        </button>
      </div>
    </div>
  </header>

  <div class="frame" id="appFrame">
    <div class="cols">
      <nav aria-label="Document navigation">
        <div class="navShell">
          <div class="navList" id="navList"></div>
        </div>
      </nav>

      <main id="paperMain" aria-label="Paper content">
        <h2 class="paperTitle" id="paperTitle" hidden></h2>
        <div id="paperContent"></div>
      </main>
    </div>
  </div>

  <div class="drawerBackdrop" id="drawerBackdrop"></div>
  <section class="drawer" id="navDrawer" role="dialog" aria-modal="true" aria-label="Jump to question" hidden>
    <div class="drawerHeader">
      <h3 class="drawerTitle">Jump to</h3>
      <button class="closeBtn" id="closeDrawerBtn" type="button">Close</button>
    </div>
    <div class="drawerBody" id="drawerNav"></div>
  </section>

  <script>
    // Single runtime definition (literal string must appear only here)
    const RTQ_PAPERS_PAYLOAD_PATH = "../../payload/rtq.papers.payload.json";

    (function () {
      const els = {
        select: document.getElementById('paperSelect'),
        title: document.getElementById('paperTitle'),
        navList: document.getElementById('navList'),
        drawerNav: document.getElementById('drawerNav'),
        content: document.getElementById('paperContent'),
        appFrame: document.getElementById('appFrame'),
        openDrawerBtn: document.getElementById('openDrawerBtn'),
        closeDrawerBtn: document.getElementById('closeDrawerBtn'),
        drawer: document.getElementById('navDrawer'),
        backdrop: document.getElementById('drawerBackdrop'),
      };

      let payload = null;
      let activePaperIndex = 0;

      function prefersReducedMotion() {
        return window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      }

      function clearNode(node) {
        while (node.firstChild) node.removeChild(node.firstChild);
      }

      function el(tag, attrs = {}, children = []) {
        const node = document.createElement(tag);
        for (const [k, v] of Object.entries(attrs)) {
          if (k === 'class') node.className = v;
          else if (k === 'text') node.textContent = v;
          else if (k.startsWith('aria-')) node.setAttribute(k, v);
          else if (k === 'html') node.innerHTML = v;
          else if (k === 'dataset') { for (const [dk, dv] of Object.entries(v)) node.dataset[dk] = String(dv); }
          else if (k === 'hidden') node.hidden = !!v;
          else node.setAttribute(k, v);
        }
        for (const c of children) {
          if (c == null) continue;
          node.appendChild(typeof c === 'string' ? document.createTextNode(c) : c);
        }
        return node;
      }

      // Markdown-it renderer with required rules; fallback preserves authored text without invention.
      function createMarkdownRenderer() {
        if (!window.markdownit) {
          return null;
        }
        const md = window.markdownit({
          html: true,
          linkify: true,
          breaks: false
        });
        if (md && md.inline && md.inline.ruler) {
          md.inline.ruler.disable(['escape']); // TeX backslash preservation
        }

        const defaultTableOpen = md.renderer.rules.table_open || function (tokens, idx, options, env, self) {
          return self.renderToken(tokens, idx, options);
        };
        const defaultTableClose = md.renderer.rules.table_close || function (tokens, idx, options, env, self) {
          return self.renderToken(tokens, idx, options);
        };
        md.renderer.rules.table_open = function (tokens, idx, options, env, self) {
          return '<div class="tableWrap">' + defaultTableOpen(tokens, idx, options, env, self);
        };
        md.renderer.rules.table_close = function (tokens, idx, options, env, self) {
          return defaultTableClose(tokens, idx, options, env, self) + '</div>';
        };

        return md;
      }

      function renderMarkdown(mdInstance, mdText) {
        if (!mdText || typeof mdText !== 'string') return '';
        if (mdInstance) {
          return mdInstance.render(mdText);
        }
        // Deterministic fallback (no synthesis): preserve whitespace and line breaks exactly.
        const esc = mdText
          .replaceAll('&', '&amp;')
          .replaceAll('<', '&lt;')
          .replaceAll('>', '&gt;');
        return '<pre class="md" style="white-space:pre-wrap; margin:0;">' + esc + '</pre>';
      }

      function runKatexAutoRender(container) {
        if (!container) return;
        if (!window.renderMathInElement || !window.katex) return;
        try {
          window.renderMathInElement(container, {
            delimiters: [
              { left: "$$", right: "$$", display: true },
              { left: "$", right: "$", display: false }
            ],
            throwOnError: false
          });
        } catch (_e) {
          // fall back silently (plain text remains visible)
        }
      }

      function getPaperList() {
        return payload && Array.isArray(payload.papers) ? payload.papers : [];
      }

      function paperDefaultsExpandedAll(paper) {
        const d = paper && paper.defaults;
        return !!(d && d.expandedAll === true);
      }

      function setInertForBackground(isOpen) {
        if (isOpen) {
          els.appFrame.setAttribute('inert', '');
          els.appFrame.setAttribute('aria-hidden', 'true');
          document.body.style.overflow = 'hidden';
        } else {
          els.appFrame.removeAttribute('inert');
          els.appFrame.removeAttribute('aria-hidden');
          document.body.style.overflow = '';
        }
      }

      function openDrawer() {
        els.backdrop.style.display = 'block';
        els.drawer.hidden = false;
        requestAnimationFrame(() => { els.drawer.style.transform = 'translateX(0)'; });
        setInertForBackground(true);
        els.openDrawerBtn.setAttribute('aria-expanded', 'true');
      }

      function closeDrawer() {
        els.drawer.style.transform = 'translateX(100%)';
        els.backdrop.style.display = 'none';
        setInertForBackground(false);
        els.openDrawerBtn.setAttribute('aria-expanded', 'false');
        setTimeout(() => { els.drawer.hidden = true; }, prefersReducedMotion() ? 0 : 170);
      }

      function buildSelector() {
        const papers = getPaperList();
        clearNode(els.select);

        if (!papers.length) {
          els.select.appendChild(el('option', { value: '', text: 'No papers' }));
          return;
        }
        papers.forEach((p, idx) => {
          const opt = el('option', {
            value: String(idx),
            text: (p && p.label) ? p.label : (p && p.key ? p.key : `Paper ${idx + 1}`)
          });
          els.select.appendChild(opt);
        });
        els.select.value = String(activePaperIndex);
      }

      function collectNavItemsFromQuestionNodes(nodes, out, sectionLabel) {
        if (!Array.isArray(nodes)) return;
        for (const q of nodes) {
          if (!q || typeof q !== 'object') continue;
          if (typeof q.id === 'string') {
            out.push({ type: 'item', id: q.id, section: sectionLabel || null });
          }
          if (Array.isArray(q.children) && q.children.length) {
            collectNavItemsFromQuestionNodes(q.children, out, sectionLabel);
          }
        }
      }

      function buildNavModel(paper) {
        const model = [];
        if (!paper || typeof paper !== 'object') return model;

        if (Array.isArray(paper.sections)) {
          for (const s of paper.sections) {
            const label = (s && typeof s.label === 'string') ? s.label : '';
            model.push({ type: 'section', label });
            const items = [];
            collectNavItemsFromQuestionNodes(s && s.questions, items, label);
            for (const it of items) model.push(it);
          }
        } else if (Array.isArray(paper.questions)) {
          collectNavItemsFromQuestionNodes(paper.questions, model, null);
        }
        return model;
      }

      function renderNavInto(container, navModel, onJump) {
        clearNode(container);
        for (const entry of navModel) {
          if (entry.type === 'section') {
            container.appendChild(el('div', { class: 'navSection', text: entry.label || '' }));
            continue;
          }
          if (entry.type === 'item') {
            const btn = el('button', {
              type: 'button',
              class: 'navItem',
              'data-target': entry.id,
              'aria-current': 'false'
            }, [
              el('span', { class: 'marker', 'aria-hidden': 'true' }),
              el('span', { text: entry.id })
            ]);
            btn.addEventListener('click', () => onJump(entry.id));
            container.appendChild(btn);
          }
        }
      }

      function setActiveNav(targetId) {
        document.querySelectorAll('.navItem').forEach(btn => {
          const isCurrent = btn.getAttribute('data-target') === targetId;
          btn.setAttribute('aria-current', isCurrent ? 'true' : 'false');
        });
      }

      function smoothScrollTo(elm) {
        if (!elm) return;
        const behavior = prefersReducedMotion() ? 'auto' : 'smooth';
        elm.scrollIntoView({ behavior, block: 'start', inline: 'nearest' });
      }

      function jumpToQuestionId(id) {
        const target = document.querySelector(`[data-q-anchor="${CSS.escape(id)}"]`);
        if (target) {
          smoothScrollTo(target);
          setActiveNav(id);
        }
        if (window.matchMedia('(max-width: 860px)').matches) {
          closeDrawer();
        }
      }

      function makeMdBlock(mdInstance, mdText) {
        const node = el('div', { class: 'md' });
        node.innerHTML = renderMarkdown(mdInstance, mdText);
        return node;
      }

      function hasSolutionDetails(q) {
        return q && typeof q === 'object' && q.solutionDetails && typeof q.solutionDetails === 'object';
      }

      function hasAnySolutionField(sd) {
        if (!sd || typeof sd !== 'object') return false;
        const keys = ['keepInMind', 'formulasUsed', 'working', 'alternativeWorking'];
        return keys.some(k => typeof sd[k] === 'string' && sd[k].length > 0);
      }

      function renderSolutionDetails(mdInstance, q, expandedByDefault) {
        const sd = q.solutionDetails;
        if (!sd || typeof sd !== 'object') return { toggle: null, region: null };

        const toggleBtn = el('button', {
          type: 'button',
          class: 'toggleBtn',
          'aria-expanded': expandedByDefault ? 'true' : 'false'
        }, [
          el('span', { class: 'chev', 'aria-hidden': 'true', text: expandedByDefault ? '▾' : '▸' }),
          el('span', { text: expandedByDefault ? 'Hide working' : 'Show working' })
        ]);

        const region = el('div', { class: 'solution', hidden: !expandedByDefault });

        if (typeof sd.keepInMind === 'string') {
          region.appendChild(el('section', { class: 'solSection keep' }, [
            el('div', { class: 'solHeader' }, [
              el('span', { class: 'keepIcon', 'aria-hidden': 'true' }),
              el('span', { text: 'Keep in mind' })
            ]),
            el('div', { class: 'solBody' }, [makeMdBlock(mdInstance, sd.keepInMind)])
          ]));
        }

        if (typeof sd.formulasUsed === 'string') {
          region.appendChild(el('section', { class: 'solSection formulas' }, [
            el('div', { class: 'solHeader', text: 'Formulas used' }),
            el('div', { class: 'solBody' }, [makeMdBlock(mdInstance, sd.formulasUsed)])
          ]));
        }

        if (typeof sd.working === 'string') {
          region.appendChild(el('section', { class: 'solSection working' }, [
            el('div', { class: 'solHeader', text: 'Working' }),
            el('div', { class: 'solBody' }, [makeMdBlock(mdInstance, sd.working)])
          ]));
        }

        if (typeof sd.alternativeWorking === 'string') {
          region.appendChild(el('section', { class: 'solSection altworking' }, [
            el('div', { class: 'solHeader', text: 'Alternative working' }),
            el('div', { class: 'solBody' }, [makeMdBlock(mdInstance, sd.alternativeWorking)])
          ]));
        }

        if (!hasAnySolutionField(sd)) {
          region.appendChild(el('div', { class: 'solSection' }, [
            el('div', { class: 'solBody' }, [])
          ]));
        }

        toggleBtn.addEventListener('click', () => {
          const isOpen = !region.hidden;
          region.hidden = isOpen;
          toggleBtn.setAttribute('aria-expanded', isOpen ? 'false' : 'true');
          toggleBtn.querySelector('.chev').textContent = isOpen ? '▸' : '▾';
          toggleBtn.querySelector('span:last-child').textContent = isOpen ? 'Show working' : 'Hide working';
          if (!isOpen) {
            runKatexAutoRender(region);
          }
        });

        return { toggle: toggleBtn, region };
      }

      function renderQuestionNode(mdInstance, q, depth, expandedAll) {
        const wrap = el('div', { class: 'qWrap', dataset: { depth: depth } });
        if (typeof q.id === 'string') {
          wrap.setAttribute('data-q-anchor', q.id);
        }

        const prompt = el('div', { class: 'qPrompt' }, [
          el('div', { class: 'qId', text: (typeof q.id === 'string') ? q.id : '' }),
          el('div', { class: 'qText' }, [
            makeMdBlock(mdInstance, (typeof q.question === 'string') ? q.question : '')
          ])
        ]);

        const answerBlock = el('div', { class: 'answerBlock' }, [
          el('div', { class: 'aLabel', text: 'Answer' }),
          el('div', { class: 'aValue' }, [
            makeMdBlock(mdInstance, (typeof q.answer === 'string') ? q.answer : '')
          ])
        ]);

        wrap.appendChild(prompt);
        wrap.appendChild(answerBlock);

        if (hasSolutionDetails(q)) {
          const { toggle, region } = renderSolutionDetails(mdInstance, q, expandedAll === true);
          if (toggle) {
            wrap.appendChild(el('div', { class: 'toggleRow' }, [toggle]));
          }
          if (region) {
            wrap.appendChild(region);
            if (expandedAll === true) {
              runKatexAutoRender(region);
            }
          }
        }

        runKatexAutoRender(prompt);
        runKatexAutoRender(answerBlock);

        if (Array.isArray(q.children) && q.children.length) {
          for (const child of q.children) {
            wrap.appendChild(renderQuestionNode(mdInstance, child, Math.min(depth + 1, 5), expandedAll));
          }
        }

        return wrap;
      }

      function renderPaper(mdInstance, paper) {
        clearNode(els.content);
        clearNode(els.navList);
        clearNode(els.drawerNav);

        if (!paper) {
          els.title.hidden = true;
          return;
        }

        const titleText = (typeof paper.label === 'string' && paper.label.trim()) ? paper.label.trim() : '';
        if (titleText) {
          els.title.textContent = titleText;
          els.title.hidden = false;
        } else {
          els.title.hidden = true;
        }

        const navModel = buildNavModel(paper);
        const onJump = (id) => jumpToQuestionId(id);

        renderNavInto(els.navList, navModel, onJump);
        renderNavInto(els.drawerNav, navModel, onJump);

        const expandedAll = paperDefaultsExpandedAll(paper);

        if (Array.isArray(paper.sections)) {
          for (const s of paper.sections) {
            const label = (s && typeof s.label === 'string') ? s.label : '';
            els.content.appendChild(el('div', { class: 'qNode', style: 'margin-top:0;' }, [
              el('div', {
                style: `
                  margin: 10px 0 6px 0;
                  font-size: 13px;
                  color: var(--quiet);
                  font-weight: 600;
                  letter-spacing: 0.02em;
                `
              }, [document.createTextNode(label)])
            ]));

            if (Array.isArray(s.questions)) {
              s.questions.forEach(q => {
                els.content.appendChild(el('section', { class: 'qNode' }, [
                  renderQuestionNode(mdInstance, q, 0, expandedAll)
                ]));
              });
            }
          }
        } else if (Array.isArray(paper.questions)) {
          paper.questions.forEach(q => {
            els.content.appendChild(el('section', { class: 'qNode' }, [
              renderQuestionNode(mdInstance, q, 0, expandedAll)
            ]));
          });
        }

        const first = navModel.find(x => x.type === 'item');
        if (first && first.id) {
          setActiveNav(first.id);
        }
      }

      function renderMissing() {
        clearNode(els.navList);
        clearNode(els.drawerNav);
        clearNode(els.content);
        els.title.hidden = true;
        els.content.appendChild(el('div', { class: 'missing', text: 'PAPERS PAYLOAD MISSING' }));
      }

      function handlePaperChange(mdInstance) {
        const idx = Number(els.select.value);
        if (!Number.isFinite(idx)) return;
        activePaperIndex = Math.max(0, Math.min(idx, getPaperList().length - 1));
        renderPaper(mdInstance, getPaperList()[activePaperIndex]);
      }

      function observeActiveQuestion() {
        const anchors = Array.from(document.querySelectorAll('[data-q-anchor]'));
        if (!anchors.length) return;

        let ticking = false;
        const onScroll = () => {
          if (ticking) return;
          ticking = true;
          requestAnimationFrame(() => {
            ticking = false;
            const topY = 80;
            let currentId = null;
            for (const a of anchors) {
              const r = a.getBoundingClientRect();
              if (r.top <= topY) currentId = a.getAttribute('data-q-anchor');
              else break;
            }
            if (currentId) setActiveNav(currentId);
          });
        };
        window.addEventListener('scroll', onScroll, { passive: true });
        onScroll();
      }

      async function loadPayload(mdInstance) {
        try {
          const res = await fetch(RTQ_PAPERS_PAYLOAD_PATH, { cache: 'no-store' });
          if (!res.ok) throw new Error('fetch failed');
          payload = await res.json();

          const papers = getPaperList();
          activePaperIndex = 0;

          buildSelector();
          renderPaper(mdInstance, papers[activePaperIndex]);

          observeActiveQuestion();
        } catch (_e) {
          renderMissing();
        }
      }

      function wireDrawer() {
        els.openDrawerBtn.addEventListener('click', () => {
          if (window.matchMedia('(max-width: 860px)').matches) {
            openDrawer();
          } else {
            const nav = document.querySelector('nav');
            if (nav) smoothScrollTo(nav);
          }
        });
        els.closeDrawerBtn.addEventListener('click', closeDrawer);
        els.backdrop.addEventListener('click', closeDrawer);
        window.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && !els.drawer.hidden) {
            closeDrawer();
          }
        });
      }

      function init() {
        const mdInstance = createMarkdownRenderer();

        wireDrawer();

        els.select.addEventListener('change', () => {
          handlePaperChange(mdInstance);
          observeActiveQuestion();
        });

        loadPayload(mdInstance);
      }

      // Ensure deferred CDN scripts are available before init runs.
      window.addEventListener('load', init);
    })();
  </script>
</body>

</html>